# AWS - Redshift Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Amazon Redshift

Redshift je potpuno upravljana usluga koja moÅ¾e da se skalira na viÅ¡e od petabajta, koja se koristi kao **data warehouse za reÅ¡enja velikih podataka**. KoristeÄ‡i Redshift klastere, moÅ¾ete da izvrÅ¡avate analitiku nad vaÅ¡im skupovima podataka koristeÄ‡i brze, SQL-bazirane alate za upit i aplikacije poslovne inteligencije kako biste stekli bolje razumevanje vizije za vaÅ¡e poslovanje.

**Redshift nudi enkripciju u mirovanju koristeÄ‡i hijerarhiju od Äetiri nivoa kljuÄeva enkripcije koristeÄ‡i KMS ili CloudHSM za upravljanje najviÅ¡im nivoom kljuÄeva**. **Kada je enkripcija omoguÄ‡ena za vaÅ¡ klaster, ne moÅ¾e se onemoguÄ‡iti i obrnuto**. Kada imate neenkripted klaster, ne moÅ¾e se enkriptovati.

Enkripcija za vaÅ¡ klaster moÅ¾e se dogoditi samo tokom njegove kreacije, a kada je enkriptovan, podaci, metapodaci i sve snimke su takoÄ‘e enkriptovani. Nivoi kljuÄeva enkripcije su sledeÄ‡i, **prvi nivo je glavni kljuÄ, drugi nivo je kljuÄ enkripcije klastera, CEK, treÄ‡i nivo, kljuÄ enkripcije baze podataka, DEK, i konaÄno Äetvrti nivo, kljuÄevi enkripcije podataka**.

### KMS

Tokom kreacije vaÅ¡eg klastera, moÅ¾ete ili odabrati **podrazumevani KMS kljuÄ** za Redshift ili odabrati svoj **vlastiti CMK**, Å¡to vam daje veÄ‡u fleksibilnost u kontroli kljuÄa, posebno iz auditable perspektive.

Podrazumevani KMS kljuÄ za Redshift automatski se kreira od strane Redshift-a prvi put kada se opcija kljuÄa odabere i koristi, i potpuno ga upravlja AWS.

Ovaj KMS kljuÄ se zatim enkriptuje sa CMK glavnim kljuÄem, prvi nivo. Ovaj enkriptovani KMS kljuÄ podataka se zatim koristi kao kljuÄ enkripcije klastera, CEK, drugi nivo. Ovaj CEK se zatim Å¡alje od strane KMS-a Redshift-u gde se Äuva odvojeno od klastera. Redshift zatim Å¡alje ovaj enkriptovani CEK klasteru preko sigurnog kanala gde se Äuva u memoriji.

Redshift zatim traÅ¾i od KMS-a da dekriptuje CEK, drugi nivo. Ovaj dekriptovani CEK se zatim takoÄ‘e Äuva u memoriji. Redshift zatim kreira nasumiÄni kljuÄ enkripcije baze podataka, DEK, treÄ‡i nivo, i uÄitava ga u memoriju klastera. Dekriptovani CEK u memoriji zatim enkriptuje DEK, koji se takoÄ‘e Äuva u memoriji.

Ovaj enkriptovani DEK se zatim Å¡alje preko sigurnog kanala i Äuva se u Redshift-u odvojeno od klastera. I CEK i DEK su sada pohranjeni u memoriji klastera i u enkriptovanom i u dekriptovanom obliku. Dekriptovani DEK se zatim koristi za enkripciju kljuÄeva podataka, Äetvrti nivo, koji se nasumiÄno generiÅ¡u od strane Redshift-a za svaki blok podataka u bazi podataka.

MoÅ¾ete koristiti AWS Trusted Advisor za praÄ‡enje konfiguracije vaÅ¡ih Amazon S3 kanti i osigurati da je logovanje kanti omoguÄ‡eno, Å¡to moÅ¾e biti korisno za izvoÄ‘enje bezbednosnih revizija i praÄ‡enje obrazaca koriÅ¡Ä‡enja u S3.

### CloudHSM

<details>

<summary>Using Redshift with CloudHSM</summary>

Kada radite sa CloudHSM za izvoÄ‘enje vaÅ¡e enkripcije, prvo morate postaviti poverljivu vezu izmeÄ‘u vaÅ¡eg HSM klijenta i Redshift-a koristeÄ‡i klijentske i serverske sertifikate.

Ova veza je potrebna za obezbeÄ‘ivanje sigurnih komunikacija, omoguÄ‡avajuÄ‡i slanje kljuÄeva enkripcije izmeÄ‘u vaÅ¡eg HSM klijenta i vaÅ¡ih Redshift klastera. KoristeÄ‡i nasumiÄno generisani privatni i javni kljuÄ, Redshift kreira javni klijentski sertifikat, koji je enkriptovan i pohranjen od strane Redshift-a. Ovaj sertifikat mora biti preuzet i registrovan na vaÅ¡em HSM klijentu, i dodeljen ispravnoj HSM particiji.

Zatim morate konfigurisati Redshift sa sledeÄ‡im detaljima vaÅ¡eg HSM klijenta: HSM IP adresa, naziv HSM particije, lozinka HSM particije, i javni HSM serverski sertifikat, koji je enkriptovan od strane CloudHSM koristeÄ‡i interni glavni kljuÄ. Kada su ovi podaci dostavljeni, Redshift Ä‡e potvrditi i verifikovati da moÅ¾e da se poveÅ¾e i pristupi razvoju particije.

Ako vaÅ¡a interna bezbednosna pravila ili kontrole upravljanja nalaÅ¾u da morate primeniti rotaciju kljuÄeva, onda je to moguÄ‡e sa Redshift-om koji vam omoguÄ‡ava da rotirate kljuÄeve enkripcije za enkriptovane klastere, meÄ‘utim, morate biti svesni da Ä‡e tokom procesa rotacije kljuÄeva klaster biti nedostupan na vrlo kratko vreme, pa je najbolje rotirati kljuÄeve samo kada je to potrebno, ili ako smatrate da su moÅ¾da kompromitovani.

Tokom rotacije, Redshift Ä‡e rotirati CEK za vaÅ¡ klaster i za sve rezervne kopije tog klastera. RotiraÄ‡e DEK za klaster, ali nije moguÄ‡e rotirati DEK za snimke pohranjene u S3 koje su enkriptovane koristeÄ‡i DEK. StaviÄ‡e klaster u stanje 'rotacije kljuÄeva' dok se proces ne zavrÅ¡i kada Ä‡e status ponovo biti 'dostupan'.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistencija

SledeÄ‡e akcije omoguÄ‡avaju dodeljivanje pristupa drugim AWS nalozima klasteru:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
