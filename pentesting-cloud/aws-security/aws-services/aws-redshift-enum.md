# AWS - Redshift Enum

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da bizi **Twitter**'da takip edin ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</details>
{% endhint %}

## Amazon Redshift

Redshift, **bÃ¼yÃ¼k veri Ã§Ã¶zÃ¼mleri iÃ§in bir veri ambarÄ±** olarak kullanÄ±lan, tamamen yÃ¶netilen ve petabayt boyutuna kadar Ã¶lÃ§eklenebilen bir hizmettir. Redshift kÃ¼melerini kullanarak, veri kÃ¼melerinize karÅŸÄ± hÄ±zlÄ±, SQL tabanlÄ± sorgu araÃ§larÄ± ve iÅŸ zekasÄ± uygulamalarÄ± kullanarak analizler yapabilir ve iÅŸiniz iÃ§in daha bÃ¼yÃ¼k bir vizyon anlayÄ±ÅŸÄ± elde edebilirsiniz.

**Redshift, KMS veya CloudHSM kullanarak ÅŸifreleme anahtarlarÄ±nÄ±n dÃ¶rt katmanlÄ± bir hiyerarÅŸisini kullanarak dinlenme sÄ±rasÄ±nda ÅŸifreleme sunar**. **KÃ¼meniz iÃ§in ÅŸifreleme etkinleÅŸtirildiÄŸinde, devre dÄ±ÅŸÄ± bÄ±rakÄ±lamaz ve tersi de geÃ§erlidir**. Åifresiz bir kÃ¼meye sahipseniz, ÅŸifrelenemez.

KÃ¼meniz iÃ§in ÅŸifreleme yalnÄ±zca oluÅŸturulmasÄ± sÄ±rasÄ±nda gerÃ§ekleÅŸebilir ve bir kez ÅŸifrelendiÄŸinde, veri, meta veri ve herhangi bir anlÄ±k gÃ¶rÃ¼ntÃ¼ de ÅŸifrelenir. Åifreleme anahtarlarÄ±nÄ±n katmanlama seviyesi ÅŸu ÅŸekildedir: **birinci katman ana anahtar, ikinci katman kÃ¼me ÅŸifreleme anahtarÄ±, CEK, Ã¼Ã§Ã¼ncÃ¼ katman veritabanÄ± ÅŸifreleme anahtarÄ±, DEK ve son olarak dÃ¶rdÃ¼ncÃ¼ katman veri ÅŸifreleme anahtarlarÄ±**.

### KMS

KÃ¼menizi oluÅŸtururken, Redshift iÃ§in **varsayÄ±lan KMS anahtarÄ±nÄ±** seÃ§ebilir veya **kendi CMK'nÄ±zÄ±** seÃ§ebilirsiniz, bu da anahtarÄ±n kontrolÃ¼ Ã¼zerinde daha fazla esneklik saÄŸlar, Ã¶zellikle denetlenebilir bir perspektiften.

Redshift iÃ§in varsayÄ±lan KMS anahtarÄ±, anahtar seÃ§eneÄŸi ilk kez seÃ§ildiÄŸinde ve kullanÄ±ldÄ±ÄŸÄ±nda Redshift tarafÄ±ndan otomatik olarak oluÅŸturulur ve tamamen AWS tarafÄ±ndan yÃ¶netilir.

Bu KMS anahtarÄ± daha sonra CMK ana anahtarÄ±, birinci katman ile ÅŸifrelenir. Bu ÅŸifrelenmiÅŸ KMS veri anahtarÄ± daha sonra kÃ¼me ÅŸifreleme anahtarÄ±, CEK, ikinci katman olarak kullanÄ±lÄ±r. Bu CEK daha sonra KMS tarafÄ±ndan Redshift'e gÃ¶nderilir ve kÃ¼meden ayrÄ± olarak saklanÄ±r. Redshift daha sonra bu ÅŸifrelenmiÅŸ CEK'i gÃ¼venli bir kanal Ã¼zerinden kÃ¼meye gÃ¶nderir ve bellekte saklanÄ±r.

Redshift daha sonra KMS'den CEK'i, ikinci katman, ÅŸifre Ã§Ã¶zmesini ister. Bu ÅŸifre Ã§Ã¶zÃ¼lmÃ¼ÅŸ CEK de bellekte saklanÄ±r. Redshift daha sonra rastgele bir veritabanÄ± ÅŸifreleme anahtarÄ±, DEK, Ã¼Ã§Ã¼ncÃ¼ katman oluÅŸturur ve bunu kÃ¼menin belleÄŸine yÃ¼kler. Bellekteki ÅŸifre Ã§Ã¶zÃ¼lmÃ¼ÅŸ CEK, DEK'i ÅŸifreler ve bu da bellekte saklanÄ±r.

Bu ÅŸifrelenmiÅŸ DEK daha sonra gÃ¼venli bir kanal Ã¼zerinden gÃ¶nderilir ve Redshift'te kÃ¼meden ayrÄ± olarak saklanÄ±r. Hem CEK hem de DEK artÄ±k hem ÅŸifrelenmiÅŸ hem de ÅŸifre Ã§Ã¶zÃ¼lmÃ¼ÅŸ formda kÃ¼menin belleÄŸinde saklanÄ±r. Åifre Ã§Ã¶zÃ¼lmÃ¼ÅŸ DEK daha sonra veritabanÄ±ndaki her veri bloÄŸu iÃ§in Redshift tarafÄ±ndan rastgele oluÅŸturulan veri anahtarlarÄ±nÄ±, dÃ¶rdÃ¼ncÃ¼ katman, ÅŸifrelemek iÃ§in kullanÄ±lÄ±r.

Amazon S3 kovalarÄ±nÄ±zÄ±n yapÄ±landÄ±rmasÄ±nÄ± izlemek ve kova gÃ¼nlÃ¼ÄŸÃ¼nÃ¼n etkinleÅŸtirildiÄŸinden emin olmak iÃ§in AWS Trusted Advisor'Ä± kullanabilirsiniz, bu da gÃ¼venlik denetimleri gerÃ§ekleÅŸtirmek ve S3'teki kullanÄ±m modellerini izlemek iÃ§in yararlÄ± olabilir.

### CloudHSM

<details>

<summary>Redshift'i CloudHSM ile Kullanma</summary>

Åifrelemenizi gerÃ§ekleÅŸtirmek iÃ§in CloudHSM ile Ã§alÄ±ÅŸÄ±rken, Ã¶ncelikle HSM istemciniz ve Redshift arasÄ±nda istemci ve sunucu sertifikalarÄ± kullanarak gÃ¼venilir bir baÄŸlantÄ± kurmanÄ±z gerekir.

Bu baÄŸlantÄ±, ÅŸifreleme anahtarlarÄ±nÄ±n HSM istemciniz ve Redshift kÃ¼meleriniz arasÄ±nda gÃ¶nderilmesine izin vererek gÃ¼venli iletiÅŸim saÄŸlamak iÃ§in gereklidir. Rastgele oluÅŸturulan Ã¶zel ve genel anahtar Ã§ifti kullanarak, Redshift bir genel istemci sertifikasÄ± oluÅŸturur, bu sertifika ÅŸifrelenir ve Redshift tarafÄ±ndan saklanÄ±r. Bu sertifika indirilip HSM istemcinize kaydedilmeli ve doÄŸru HSM bÃ¶lÃ¼mÃ¼ne atanmalÄ±dÄ±r.

Daha sonra Redshift'i HSM istemcinizin ÅŸu ayrÄ±ntÄ±larÄ±yla yapÄ±landÄ±rmanÄ±z gerekir: HSM IP adresi, HSM bÃ¶lÃ¼m adÄ±, HSM bÃ¶lÃ¼m ÅŸifresi ve CloudHSM tarafÄ±ndan dahili bir ana anahtar kullanÄ±larak ÅŸifrelenen genel HSM sunucu sertifikasÄ±. Bu bilgiler saÄŸlandÄ±ktan sonra, Redshift baÄŸlantÄ± kurabileceÄŸini ve geliÅŸtirme bÃ¶lÃ¼mÃ¼ne eriÅŸebileceÄŸini doÄŸrular.

Ä°Ã§ gÃ¼venlik politikalarÄ±nÄ±z veya yÃ¶netim kontrolleriniz anahtar dÃ¶ndÃ¼rme uygulamanÄ±z gerektiÄŸini belirtiyorsa, Redshift ile ÅŸifrelenmiÅŸ kÃ¼meler iÃ§in ÅŸifreleme anahtarlarÄ±nÄ± dÃ¶ndÃ¼rmenizi saÄŸlayarak bu mÃ¼mkÃ¼ndÃ¼r, ancak anahtar dÃ¶ndÃ¼rme iÅŸlemi sÄ±rasÄ±nda kÃ¼menin Ã§ok kÄ±sa bir sÃ¼re iÃ§in kullanÄ±lamaz hale geleceÄŸini bilmeniz gerekir, bu nedenle anahtarlarÄ± yalnÄ±zca gerektiÄŸinde veya tehlikeye girdiÄŸini dÃ¼ÅŸÃ¼ndÃ¼ÄŸÃ¼nÃ¼zde dÃ¶ndÃ¼rmek en iyisidir.

DÃ¶ndÃ¼rme sÄ±rasÄ±nda, Redshift kÃ¼meniz ve bu kÃ¼menin yedekleri iÃ§in CEK'i dÃ¶ndÃ¼recektir. KÃ¼me iÃ§in bir DEK dÃ¶ndÃ¼recektir, ancak S3'te DEK kullanÄ±larak ÅŸifrelenmiÅŸ anlÄ±k gÃ¶rÃ¼ntÃ¼ler iÃ§in bir DEK dÃ¶ndÃ¼rmek mÃ¼mkÃ¼n deÄŸildir. KÃ¼me, iÅŸlem tamamlanana kadar 'anahtarlarÄ± dÃ¶ndÃ¼rÃ¼yor' durumuna geÃ§ecek ve durum 'kullanÄ±labilir' olarak geri dÃ¶necektir.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistence

AÅŸaÄŸÄ±daki eylemler, diÄŸer AWS hesaplarÄ±na kÃ¼meye eriÅŸim izni vermeyi saÄŸlar:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **Twitter'da** bizi takip edin ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</details>
{% endhint %}
