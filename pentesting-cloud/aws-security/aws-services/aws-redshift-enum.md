# AWS - Redshift Enum

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Amazon Redshift

Redshift je potpuno upravljana usluga koja moÅ¾e skalirati do preko petabajta veliÄine, koja se koristi kao **data warehouse za big data reÅ¡enja**. KoriÅ¡Ä‡enjem Redshift klastera, moÅ¾ete pokretati analitiku nad vaÅ¡im datasetovima koristeÄ‡i brze, SQL-bazirane alate za upite i aplikacije za poslovnu inteligenciju kako biste dobili veÄ‡e razumevanje vizije za vaÅ¡ biznis.

**Redshift nudi enkripciju u mirovanju koristeÄ‡i Äetvorostepenu hijerarhiju enkripcijskih kljuÄeva koristeÄ‡i ili KMS ili CloudHSM za upravljanje najviÅ¡im nivoom kljuÄeva**. **Kada je enkripcija omoguÄ‡ena za vaÅ¡ klaster, ne moÅ¾e se onemoguÄ‡iti i obrnuto**. Kada imate neenkriptovani klaster, ne moÅ¾e se enkriptovati.

Enkripcija za vaÅ¡ klaster moÅ¾e se desiti samo tokom njegovog kreiranja, i jednom kada je enkriptovan, podaci, metapodaci i bilo koji snimci su takoÄ‘e enkriptovani. Nivoi hijerarhije enkripcijskih kljuÄeva su sledeÄ‡i, **prvi nivo je master kljuÄ, drugi nivo je klaster enkripcijski kljuÄ, CEK, treÄ‡i nivo, enkripcijski kljuÄ baze podataka, DEK, i konaÄno Äetvrti nivo, sami enkripcijski kljuÄevi podataka**.

### KMS

Tokom kreiranja vaÅ¡eg klastera, moÅ¾ete odabrati **podrazumevani KMS kljuÄ** za Redshift ili odabrati vaÅ¡ **vlastiti CMK**, Å¡to vam daje veÄ‡u fleksibilnost u kontroli kljuÄa, posebno iz perspektive revizije.

Podrazumevani KMS kljuÄ za Redshift automatski kreira Redshift prvi put kada se opcija kljuÄa odabere i koristi, i njime u potpunosti upravlja AWS.

Ovaj KMS kljuÄ je zatim enkriptovan sa CMK master kljuÄem, prvi nivo. Ovaj enkriptovani KMS podatkovni kljuÄ se zatim koristi kao klaster enkripcijski kljuÄ, CEK, drugi nivo. Ovaj CEK zatim Å¡alje KMS-u Redshift gde se Äuva odvojeno od klastera. Redshift zatim Å¡alje ovaj enkriptovani CEK klasteru preko sigurnog kanala gde se Äuva u memoriji.

Redshift zatim zahteva od KMS-a da dekriptuje CEK, drugi nivo. Ovaj dekriptovani CEK se zatim takoÄ‘e Äuva u memoriji. Redshift zatim kreira nasumiÄni enkripcijski kljuÄ baze podataka, DEK, treÄ‡i nivo, i uÄitava ga u memoriju klastera. Dekriptovani CEK u memoriji zatim enkriptuje DEK, koji se takoÄ‘e Äuva u memoriji.

Ovaj enkriptovani DEK se zatim Å¡alje preko sigurnog kanala i Äuva u Redshift-u odvojeno od klastera. I CEK i DEK su sada Äuvani u memoriji klastera i u enkriptovanom i u dekriptovanom obliku. Dekriptovani DEK se zatim koristi za enkripciju kljuÄeva podataka, Äetvrti nivo, koji su nasumiÄno generisani od strane Redshift-a za svaki blok podataka u bazi podataka.

MoÅ¾ete koristiti AWS Trusted Advisor za praÄ‡enje konfiguracije vaÅ¡ih Amazon S3 bucket-a i osigurati da je logovanje bucket-a omoguÄ‡eno, Å¡to moÅ¾e biti korisno za izvoÄ‘enje sigurnosnih revizija i praÄ‡enje obrazaca koriÅ¡Ä‡enja u S3.

### CloudHSM

<details>

<summary>KoriÅ¡Ä‡enje Redshift-a sa CloudHSM</summary>

Kada radite sa CloudHSM za izvoÄ‘enje enkripcije, prvo morate postaviti poverljivu vezu izmeÄ‘u vaÅ¡eg HSM klijenta i Redshift-a koristeÄ‡i klijentske i serverske sertifikate.

Ova veza je potrebna za obezbeÄ‘ivanje sigurnih komunikacija, omoguÄ‡avajuÄ‡i slanje enkripcijskih kljuÄeva izmeÄ‘u vaÅ¡eg HSM klijenta i vaÅ¡ih Redshift klastera. KoriÅ¡Ä‡enjem nasumiÄno generisanog privatnog i javnog para kljuÄeva, Redshift kreira javni klijentski sertifikat, koji je enkriptovan i Äuvan od strane Redshift-a. Ovo mora biti preuzeto i registrovano na vaÅ¡ HSM klijent, i dodeljeno odgovarajuÄ‡oj HSM particiji.

Zatim morate konfigurisati Redshift sa sledeÄ‡im detaljima vaÅ¡eg HSM klijenta: HSM IP adresa, naziv HSM particije, lozinka HSM particije, i javni HSM serverski sertifikat, koji je enkriptovan od strane CloudHSM koristeÄ‡i interni master kljuÄ. Kada su ovi podaci obezbeÄ‘eni, Redshift Ä‡e potvrditi i verifikovati da moÅ¾e da se poveÅ¾e i pristupi razvojnoj particiji.

Ako vaÅ¡a interna sigurnosna pravila ili kontrola upravljanja nalaÅ¾u da morate primeniti rotaciju kljuÄeva, to je moguÄ‡e sa Redshift-om omoguÄ‡avajuÄ‡i vam da rotirate enkripcijske kljuÄeve za enkriptovane klastere, meÄ‘utim, morate biti svesni da Ä‡e tokom procesa rotacije kljuÄeva klaster biti nedostupan na vrlo kratko vreme, pa je najbolje rotirati kljuÄeve samo kada je to potrebno, ili ako smatrate da su moÅ¾da kompromitovani.

Tokom rotacije, Redshift Ä‡e rotirati CEK za vaÅ¡ klaster i za bilo koje bekape tog klastera. RotiraÄ‡e DEK za klaster, ali nije moguÄ‡e rotirati DEK za snimke Äuvane u S3 koji su enkriptovani koristeÄ‡i DEK. Klaster Ä‡e biti u stanju 'rotacije kljuÄeva' dok se proces ne zavrÅ¡i kada Ä‡e status biti vraÄ‡en na 'dostupan'.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistence

SledeÄ‡e akcije omoguÄ‡avaju dodeljivanje pristupa drugim AWS nalozima na klaster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
