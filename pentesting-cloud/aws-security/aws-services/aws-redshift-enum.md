# AWS - Redshift Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** π’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** π¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Amazon Redshift

Redshiftλ” **λΉ… λ°μ΄ν„° μ†”λ£¨μ…μ„ μ„ν• λ°μ΄ν„° μ›¨μ–΄ν•μ°μ¤**λ΅ μ‚¬μ©λλ” μ™„μ „ κ΄€λ¦¬ν• μ„λΉ„μ¤λ΅, ν¬κΈ°λ¥Ό ννƒ€λ°”μ΄νΈ μ΄μƒμΌλ΅ ν™•μ¥ν•  μ μμµλ‹λ‹¤. Redshift ν΄λ¬μ¤ν„°λ¥Ό μ‚¬μ©ν•λ©΄ λΉ λ¥Έ SQL κΈ°λ° μΏΌλ¦¬ λ„κµ¬μ™€ λΉ„μ¦λ‹μ¤ μΈν…”λ¦¬μ „μ¤ μ• ν”λ¦¬μΌ€μ΄μ…μ„ ν†µν•΄ λ°μ΄ν„° μ„ΈνΈμ— λ€ν• λ¶„μ„μ„ μ‹¤ν–‰ν•μ—¬ λΉ„μ¦λ‹μ¤ λΉ„μ „μ„ λ” μ μ΄ν•΄ν•  μ μμµλ‹λ‹¤.

**Redshiftλ” KMS λλ” CloudHSMμ„ μ‚¬μ©ν•μ—¬ μµμƒμ„ ν‚¤λ¥Ό κ΄€λ¦¬ν•λ” 4λ‹¨κ³„ μ•”νΈν™” ν‚¤ κ³„μΈµμ„ μ‚¬μ©ν•μ—¬ μ •μ§€ μƒνƒμ—μ„ μ•”νΈν™”λ¥Ό μ κ³µν•©λ‹λ‹¤**. **ν΄λ¬μ¤ν„°μ— λ€ν•΄ μ•”νΈν™”κ°€ ν™μ„±ν™”λλ©΄ λΉ„ν™μ„±ν™”ν•  μ μ—†μΌλ©° κ·Έ λ°λ€λ„ λ§μ°¬κ°€μ§€μ…λ‹λ‹¤**. μ•”νΈν™”λμ§€ μ•μ€ ν΄λ¬μ¤ν„°λ” μ•”νΈν™”ν•  μ μ—†μµλ‹λ‹¤.

ν΄λ¬μ¤ν„°μ μ•”νΈν™”λ” μƒμ„± μ¤‘μ—λ§ λ°μƒν•  μ μμΌλ©°, μ•”νΈν™”λ ν›„μ—λ” λ°μ΄ν„°, λ©”νƒ€λ°μ΄ν„° λ° λ¨λ“  μ¤λƒ…μƒ·λ„ μ•”νΈν™”λ©λ‹λ‹¤. μ•”νΈν™” ν‚¤μ κ³„μΈµ μμ¤€μ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤. **1λ‹¨κ³„λ” λ§μ¤ν„° ν‚¤, 2λ‹¨κ³„λ” ν΄λ¬μ¤ν„° μ•”νΈν™” ν‚¤(CEK), 3λ‹¨κ³„λ” λ°μ΄ν„°λ² μ΄μ¤ μ•”νΈν™” ν‚¤(DEK), λ§μ§€λ§‰μΌλ΅ 4λ‹¨κ³„λ” λ°μ΄ν„° μ•”νΈν™” ν‚¤ μμ²΄μ…λ‹λ‹¤**.

### KMS

ν΄λ¬μ¤ν„°λ¥Ό μƒμ„±ν•λ” λ™μ• Redshiftμ **κΈ°λ³Έ KMS ν‚¤**λ¥Ό μ„ νƒν•κ±°λ‚ **μμ‹ μ CMK**λ¥Ό μ„ νƒν•  μ μμΌλ©°, μ΄λ” ν‚¤μ μ μ–΄μ— λ€ν•΄ λ” λ§μ€ μ μ—°μ„±μ„ μ κ³µν•©λ‹λ‹¤. νΉν κ°μ‚¬ κ°€λ¥μ„± μΈ΅λ©΄μ—μ„ κ·Έλ ‡μµλ‹λ‹¤.

Redshiftμ κΈ°λ³Έ KMS ν‚¤λ” ν‚¤ μµμ…μ΄ μ²μ μ„ νƒλκ³  μ‚¬μ©λ  λ• Redshiftμ— μν•΄ μλ™μΌλ΅ μƒμ„±λλ©°, AWSμ— μν•΄ μ™„μ „ν κ΄€λ¦¬λ©λ‹λ‹¤.

μ΄ KMS ν‚¤λ” CMK λ§μ¤ν„° ν‚¤(1λ‹¨κ³„)λ΅ μ•”νΈν™”λ©λ‹λ‹¤. μ΄ μ•”νΈν™”λ KMS λ°μ΄ν„° ν‚¤λ” ν΄λ¬μ¤ν„° μ•”νΈν™” ν‚¤(CEK, 2λ‹¨κ³„)λ΅ μ‚¬μ©λ©λ‹λ‹¤. μ΄ CEKλ” KMSμ— μν•΄ Redshiftλ΅ μ „μ†΅λμ–΄ ν΄λ¬μ¤ν„°μ™€λ” λ³„λ„λ΅ μ €μ¥λ©λ‹λ‹¤. Redshiftλ” μ΄ μ•”νΈν™”λ CEKλ¥Ό μ•μ „ν• μ±„λ„μ„ ν†µν•΄ ν΄λ¬μ¤ν„°μ— μ „μ†΅ν•μ—¬ λ©”λ¨λ¦¬μ— μ €μ¥ν•©λ‹λ‹¤.

Redshiftλ” KMSμ— CEK(2λ‹¨κ³„)μ μ•”νΈ ν•΄μ λ¥Ό μ”μ²­ν•©λ‹λ‹¤. μ΄ λ³µνΈν™”λ CEKλ” λ©”λ¨λ¦¬μ— μ €μ¥λ©λ‹λ‹¤. Redshiftλ” λ¬΄μ‘μ„ λ°μ΄ν„°λ² μ΄μ¤ μ•”νΈν™” ν‚¤(DEK, 3λ‹¨κ³„)λ¥Ό μƒμ„±ν•κ³  μ΄λ¥Ό ν΄λ¬μ¤ν„°μ λ©”λ¨λ¦¬μ— λ΅λ“ν•©λ‹λ‹¤. λ©”λ¨λ¦¬μ λ³µνΈν™”λ CEKλ” DEKλ¥Ό μ•”νΈν™”ν•λ©°, DEKλ„ λ©”λ¨λ¦¬μ— μ €μ¥λ©λ‹λ‹¤.

μ΄ μ•”νΈν™”λ DEKλ” μ•μ „ν• μ±„λ„μ„ ν†µν•΄ μ „μ†΅λμ–΄ Redshiftμ— ν΄λ¬μ¤ν„°μ™€λ” λ³„λ„λ΅ μ €μ¥λ©λ‹λ‹¤. CEKμ™€ DEKλ” μ΄μ  ν΄λ¬μ¤ν„°μ λ©”λ¨λ¦¬μ— μ•”νΈν™”λ ν•νƒμ™€ λ³µνΈν™”λ ν•νƒλ΅ λ¨λ‘ μ €μ¥λ©λ‹λ‹¤. λ³µνΈν™”λ DEKλ” λ°μ΄ν„°λ² μ΄μ¤μ κ° λ°μ΄ν„° λΈ”λ΅μ— λ€ν•΄ Redshiftκ°€ λ¬΄μ‘μ„λ΅ μƒμ„±ν• λ°μ΄ν„° ν‚¤(4λ‹¨κ³„)λ¥Ό μ•”νΈν™”ν•λ” λ° μ‚¬μ©λ©λ‹λ‹¤.

AWS Trusted Advisorλ¥Ό μ‚¬μ©ν•μ—¬ Amazon S3 λ²„ν‚·μ κµ¬μ„±μ„ λ¨λ‹ν„°λ§ν•κ³  λ²„ν‚· λ΅κΉ…μ΄ ν™μ„±ν™”λμ–΄ μλ”μ§€ ν™•μΈν•  μ μμΌλ©°, μ΄λ” λ³΄μ• κ°μ‚¬ μν–‰ λ° S3μ—μ„ μ‚¬μ© ν¨ν„΄ μ¶”μ μ— μ μ©ν•  μ μμµλ‹λ‹¤.

### CloudHSM

<details>

<summary>Using Redshift with CloudHSM</summary>

CloudHSMμ„ μ‚¬μ©ν•μ—¬ μ•”νΈν™”λ¥Ό μν–‰ν•  λ•, λ¨Όμ € HSM ν΄λΌμ΄μ–ΈνΈμ™€ Redshift κ°„μ μ‹ λΆ°ν•  μ μλ” μ—°κ²°μ„ μ„¤μ •ν•΄μ•Ό ν•λ©°, μ΄λ• ν΄λΌμ΄μ–ΈνΈ λ° μ„λ²„ μΈμ¦μ„λ¥Ό μ‚¬μ©ν•΄μ•Ό ν•©λ‹λ‹¤.

μ΄ μ—°κ²°μ€ μ•μ „ν• ν†µμ‹ μ„ μ κ³µν•λ” λ° ν•„μ”ν•λ©°, μ•”νΈν™” ν‚¤κ°€ HSM ν΄λΌμ΄μ–ΈνΈμ™€ Redshift ν΄λ¬μ¤ν„° κ°„μ— μ „μ†΅λ  μ μλ„λ΅ ν•©λ‹λ‹¤. λ¬΄μ‘μ„λ΅ μƒμ„±λ κ°μΈ ν‚¤μ™€ κ³µκ° ν‚¤ μμ„ μ‚¬μ©ν•μ—¬ Redshiftλ” κ³µκ° ν΄λΌμ΄μ–ΈνΈ μΈμ¦μ„λ¥Ό μƒμ„±ν•λ©°, μ΄λ” μ•”νΈν™”λμ–΄ Redshiftμ— μ €μ¥λ©λ‹λ‹¤. μ΄ μΈμ¦μ„λ” λ‹¤μ΄λ΅λ“ν•μ—¬ HSM ν΄λΌμ΄μ–ΈνΈμ— λ“±λ΅ν•κ³  μ¬λ°”λ¥Έ HSM νν‹°μ…μ— ν• λ‹Ήν•΄μ•Ό ν•©λ‹λ‹¤.

κ·Έλ° λ‹¤μ HSM ν΄λΌμ΄μ–ΈνΈμ λ‹¤μ μ„Έλ¶€μ •λ³΄λ΅ Redshiftλ¥Ό κµ¬μ„±ν•΄μ•Ό ν•©λ‹λ‹¤: HSM IP μ£Όμ†, HSM νν‹°μ… μ΄λ¦„, HSM νν‹°μ… λΉ„λ°€λ²νΈ, CloudHSMμ— μν•΄ λ‚΄λ¶€ λ§μ¤ν„° ν‚¤λ΅ μ•”νΈν™”λ κ³µκ° HSM μ„λ²„ μΈμ¦μ„. μ΄ μ •λ³΄κ°€ μ κ³µλλ©΄ Redshiftλ” κ°λ° νν‹°μ…μ— μ—°κ²°ν•κ³  μ ‘κ·Όν•  μ μλ”μ§€ ν™•μΈν•©λ‹λ‹¤.

λ‚΄λ¶€ λ³΄μ• μ •μ±…μ΄λ‚ κ±°λ²„λ„μ¤ μ μ–΄κ°€ ν‚¤ νμ „μ„ μ μ©ν•΄μ•Ό ν•λ‹¤κ³  κ·μ •ν•λ” κ²½μ°, Redshiftλ” μ•”νΈν™”λ ν΄λ¬μ¤ν„°μ— λ€ν•΄ μ•”νΈν™” ν‚¤λ¥Ό νμ „ν•  μ μλ„λ΅ ν•μ—¬ μ΄λ¥Ό κ°€λ¥ν•κ² ν•©λ‹λ‹¤. κ·Έλ¬λ‚ ν‚¤ νμ „ κ³Όμ •μ—μ„ ν΄λ¬μ¤ν„°κ°€ λ§¤μ° μ§§μ€ μ‹κ°„ λ™μ• μ‚¬μ©ν•  μ μ—†κ² λλ―€λ΅, ν•„μ”ν•  λ•λ§ ν‚¤λ¥Ό νμ „ν•λ” κ²ƒμ΄ κ°€μ¥ μΆ‹μµλ‹λ‹¤. λλ” ν‚¤κ°€ μ†μƒλμ—μ„ κ°€λ¥μ„±μ΄ μλ‹¤κ³  λλ‚„ κ²½μ°μ—λ§ νμ „ν•΄μ•Ό ν•©λ‹λ‹¤.

νμ „ μ¤‘μ— Redshiftλ” ν΄λ¬μ¤ν„° λ° ν•΄λ‹Ή ν΄λ¬μ¤ν„°μ λ¨λ“  λ°±μ—…μ— λ€ν•΄ CEKλ¥Ό νμ „ν•©λ‹λ‹¤. ν΄λ¬μ¤ν„°μ— λ€ν• DEKλ” νμ „ν•μ§€λ§, DEKλ¥Ό μ‚¬μ©ν•μ—¬ μ•”νΈν™”λ S3μ— μ €μ¥λ μ¤λƒ…μƒ·μ— λ€ν• DEKλ¥Ό νμ „ν•λ” κ²ƒμ€ λ¶κ°€λ¥ν•©λ‹λ‹¤. μ΄ κ³Όμ •μ΄ μ™„λ£λ  λ•κΉμ§€ ν΄λ¬μ¤ν„°λ” 'ν‚¤ νμ „ μ¤‘' μƒνƒλ΅ μ μ§€λλ©°, κ·Έ ν›„ μƒνƒλ” 'μ‚¬μ© κ°€λ¥'μΌλ΅ λμ•„κ°‘λ‹λ‹¤.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistence

λ‹¤μ μ‘μ—…μ„ ν†µν•΄ ν΄λ¬μ¤ν„°μ— λ‹¤λ¥Έ AWS κ³„μ •μ— λ€ν• μ•΅μ„Έμ¤λ¥Ό λ¶€μ—¬ν•  μ μμµλ‹λ‹¤:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
AWS ν•΄ν‚Ή λ°°μ°κΈ° λ° μ—°μµν•κΈ°:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP ν•΄ν‚Ή λ°°μ°κΈ° λ° μ—°μµν•κΈ°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks μ§€μ›ν•κΈ°</summary>

* [**κµ¬λ… κ³„ν**](https://github.com/sponsors/carlospolop) ν™•μΈν•κΈ°!
* **π’¬ [**Discord κ·Έλ£Ή**](https://discord.gg/hRep4RUj7f) λλ” [**ν…”λ κ·Έλ¨ κ·Έλ£Ή**](https://t.me/peass)μ— μ°Έμ—¬ν•κ±°λ‚ **Twitter** π¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**λ¥Ό ν”λ΅μ°ν•μ„Έμ”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) λ° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) κΉƒν—λΈ λ¦¬ν¬μ§€ν† λ¦¬μ— PRμ„ μ μ¶ν•μ—¬ ν•΄ν‚Ή νμ„ κ³µμ ν•μ„Έμ”.**

</details>
{% endhint %}
