# AWS - Redshift Enum

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Amazon Redshift

Redshift √© um servi√ßo totalmente gerenciado que pode escalar para mais de um petabyte em tamanho, utilizado como um **data warehouse para solu√ß√µes de big data**. Usando clusters Redshift, voc√™ pode executar an√°lises em seus conjuntos de dados usando ferramentas de consulta r√°pidas baseadas em SQL e aplica√ß√µes de intelig√™ncia de neg√≥cios para obter uma maior compreens√£o da vis√£o para o seu neg√≥cio.

**Redshift oferece criptografia em repouso usando uma hierarquia de quatro camadas de chaves de criptografia usando KMS ou CloudHSM para gerenciar o n√≠vel superior de chaves**. **Quando a criptografia √© ativada para seu cluster, n√£o pode ser desativada e vice-versa**. Quando voc√™ tem um cluster n√£o criptografado, ele n√£o pode ser criptografado.

A criptografia para seu cluster s√≥ pode ocorrer durante sua cria√ß√£o, e uma vez criptografado, os dados, metadados e quaisquer instant√¢neas tamb√©m s√£o criptografados. Os n√≠veis de hierarquia das chaves de criptografia s√£o os seguintes: **a camada um √© a chave mestre, a camada dois √© a chave de criptografia do cluster, a CEK, a camada tr√™s, a chave de criptografia do banco de dados, a DEK, e finalmente a camada quatro, as chaves de criptografia de dados em si**.

### KMS

Durante a cria√ß√£o do seu cluster, voc√™ pode selecionar a **chave KMS padr√£o** para Redshift ou selecionar sua **pr√≥pria CMK**, o que lhe d√° mais flexibilidade sobre o controle da chave, especificamente de uma perspectiva audit√°vel.

A chave KMS padr√£o para Redshift √© criada automaticamente pelo Redshift na primeira vez que a op√ß√£o de chave √© selecionada e utilizada, e √© totalmente gerenciada pela AWS.

Essa chave KMS √© ent√£o criptografada com a chave mestre CMK, camada um. Essa chave de dados KMS criptografada √© ent√£o usada como a chave de criptografia do cluster, a CEK, camada dois. Essa CEK √© ent√£o enviada pelo KMS para o Redshift, onde √© armazenada separadamente do cluster. O Redshift ent√£o envia essa CEK criptografada para o cluster por meio de um canal seguro, onde √© armazenada na mem√≥ria.

O Redshift ent√£o solicita ao KMS para descriptografar a CEK, camada dois. Essa CEK descriptografada √© ent√£o tamb√©m armazenada na mem√≥ria. O Redshift ent√£o cria uma chave de criptografia de banco de dados aleat√≥ria, a DEK, camada tr√™s, e a carrega na mem√≥ria do cluster. A CEK descriptografada na mem√≥ria ent√£o criptografa a DEK, que tamb√©m √© armazenada na mem√≥ria.

Essa DEK criptografada √© ent√£o enviada por um canal seguro e armazenada no Redshift separadamente do cluster. Tanto a CEK quanto a DEK agora est√£o armazenadas na mem√≥ria do cluster, tanto em forma criptografada quanto descriptografada. A DEK descriptografada √© ent√£o usada para criptografar chaves de dados, camada quatro, que s√£o geradas aleatoriamente pelo Redshift para cada bloco de dados no banco de dados.

Voc√™ pode usar o AWS Trusted Advisor para monitorar a configura√ß√£o dos seus buckets do Amazon S3 e garantir que o registro de bucket esteja ativado, o que pode ser √∫til para realizar auditorias de seguran√ßa e rastrear padr√µes de uso no S3.

### CloudHSM

<details>

<summary>Usando Redshift com CloudHSM</summary>

Ao trabalhar com CloudHSM para realizar sua criptografia, primeiramente voc√™ deve configurar uma conex√£o confi√°vel entre seu cliente HSM e o Redshift, utilizando certificados de cliente e servidor.

Essa conex√£o √© necess√°ria para fornecer comunica√ß√µes seguras, permitindo que chaves de criptografia sejam enviadas entre seu cliente HSM e seus clusters Redshift. Usando um par de chaves privada e p√∫blica gerado aleatoriamente, o Redshift cria um certificado de cliente p√∫blico, que √© criptografado e armazenado pelo Redshift. Este deve ser baixado e registrado no seu cliente HSM, e atribu√≠do √† parti√ß√£o HSM correta.

Voc√™ deve ent√£o configurar o Redshift com os seguintes detalhes do seu cliente HSM: o endere√ßo IP do HSM, o nome da parti√ß√£o HSM, a senha da parti√ß√£o HSM e o certificado p√∫blico do servidor HSM, que √© criptografado pelo CloudHSM usando uma chave mestre interna. Uma vez que essas informa√ß√µes tenham sido fornecidas, o Redshift confirmar√° e verificar√° se pode conectar e acessar a parti√ß√£o de desenvolvimento.

Se suas pol√≠ticas de seguran√ßa internas ou controles de governan√ßa ditarem que voc√™ deve aplicar rota√ß√£o de chaves, ent√£o isso √© poss√≠vel com o Redshift, permitindo que voc√™ gire chaves de criptografia para clusters criptografados, no entanto, voc√™ deve estar ciente de que durante o processo de rota√ß√£o de chaves, isso tornar√° um cluster indispon√≠vel por um curto per√≠odo de tempo, e portanto √© melhor girar chaves apenas quando necess√°rio, ou se voc√™ sentir que elas podem ter sido comprometidas.

Durante a rota√ß√£o, o Redshift ir√° girar a CEK para seu cluster e para quaisquer backups desse cluster. Ele ir√° girar uma DEK para o cluster, mas n√£o √© poss√≠vel girar uma DEK para as instant√¢neas armazenadas no S3 que foram criptografadas usando a DEK. Ele colocar√° o cluster em um estado de 'girando chaves' at√© que o processo seja conclu√≠do, quando o status retornar√° a 'dispon√≠vel'.

</details>

### Enumera√ß√£o
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persist√™ncia

As seguintes a√ß√µes permitem conceder acesso a outras contas AWS ao cluster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
