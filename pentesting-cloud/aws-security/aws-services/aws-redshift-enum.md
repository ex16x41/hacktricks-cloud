# AWS - Redshift Enum

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Amazon Redshift

Redshift est un service enti√®rement g√©r√© qui peut √©voluer jusqu'√† plus d'un p√©taoctet, utilis√© comme un **entrep√¥t de donn√©es pour des solutions de big data**. En utilisant des clusters Redshift, vous pouvez ex√©cuter des analyses sur vos ensembles de donn√©es √† l'aide d'outils de requ√™te bas√©s sur SQL et d'applications d'intelligence d'affaires pour mieux comprendre la vision de votre entreprise.

**Redshift offre un chiffrement au repos utilisant une hi√©rarchie de cl√©s de chiffrement √† quatre niveaux utilisant soit KMS soit CloudHSM pour g√©rer le niveau sup√©rieur des cl√©s**. **Lorsque le chiffrement est activ√© pour votre cluster, il ne peut pas √™tre d√©sactiv√© et vice versa**. Lorsque vous avez un cluster non chiffr√©, il ne peut pas √™tre chiffr√©.

Le chiffrement pour votre cluster ne peut se faire qu'au moment de sa cr√©ation, et une fois chiffr√©, les donn√©es, les m√©tadonn√©es et tous les instantan√©s sont √©galement chiffr√©s. Les niveaux de hi√©rarchie des cl√©s de chiffrement sont les suivants : **le niveau un est la cl√© ma√Ætre, le niveau deux est la cl√© de chiffrement du cluster, la CEK, le niveau trois, la cl√© de chiffrement de la base de donn√©es, la DEK, et enfin le niveau quatre, les cl√©s de chiffrement des donn√©es elles-m√™mes**.

### KMS

Lors de la cr√©ation de votre cluster, vous pouvez soit s√©lectionner la **cl√© KMS par d√©faut** pour Redshift, soit s√©lectionner votre **propre CMK**, ce qui vous donne plus de flexibilit√© sur le contr√¥le de la cl√©, sp√©cifiquement d'un point de vue auditable.

La cl√© KMS par d√©faut pour Redshift est automatiquement cr√©√©e par Redshift la premi√®re fois que l'option de cl√© est s√©lectionn√©e et utilis√©e, et elle est enti√®rement g√©r√©e par AWS.

Cette cl√© KMS est ensuite chiffr√©e avec la cl√© ma√Ætre CMK, niveau un. Cette cl√© de donn√©es KMS chiffr√©e est ensuite utilis√©e comme cl√© de chiffrement du cluster, la CEK, niveau deux. Cette CEK est ensuite envoy√©e par KMS √† Redshift o√π elle est stock√©e s√©par√©ment du cluster. Redshift envoie ensuite cette CEK chiffr√©e au cluster via un canal s√©curis√© o√π elle est stock√©e en m√©moire.

Redshift demande ensuite √† KMS de d√©chiffrer la CEK, niveau deux. Cette CEK d√©chiffr√©e est ensuite √©galement stock√©e en m√©moire. Redshift cr√©e ensuite une cl√© de chiffrement de base de donn√©es al√©atoire, la DEK, niveau trois, et la charge dans la m√©moire du cluster. La CEK d√©chiffr√©e en m√©moire chiffre ensuite la DEK, qui est √©galement stock√©e en m√©moire.

Cette DEK chiffr√©e est ensuite envoy√©e via un canal s√©curis√© et stock√©e dans Redshift s√©par√©ment du cluster. La CEK et la DEK sont maintenant stock√©es en m√©moire du cluster √† la fois sous forme chiffr√©e et d√©chiffr√©e. La DEK d√©chiffr√©e est ensuite utilis√©e pour chiffrer les cl√©s de donn√©es, niveau quatre, qui sont g√©n√©r√©es al√©atoirement par Redshift pour chaque bloc de donn√©es dans la base de donn√©es.

Vous pouvez utiliser AWS Trusted Advisor pour surveiller la configuration de vos buckets Amazon S3 et vous assurer que la journalisation des buckets est activ√©e, ce qui peut √™tre utile pour effectuer des audits de s√©curit√© et suivre les mod√®les d'utilisation dans S3.

### CloudHSM

<details>

<summary>Utiliser Redshift avec CloudHSM</summary>

Lorsque vous travaillez avec CloudHSM pour effectuer votre chiffrement, vous devez d'abord √©tablir une connexion de confiance entre votre client HSM et Redshift tout en utilisant des certificats client et serveur.

Cette connexion est n√©cessaire pour fournir des communications s√©curis√©es, permettant aux cl√©s de chiffrement d'√™tre envoy√©es entre votre client HSM et vos clusters Redshift. En utilisant une paire de cl√©s priv√©es et publiques g√©n√©r√©es al√©atoirement, Redshift cr√©e un certificat client public, qui est chiffr√© et stock√© par Redshift. Cela doit √™tre t√©l√©charg√© et enregistr√© sur votre client HSM, et attribu√© √† la bonne partition HSM.

Vous devez ensuite configurer Redshift avec les d√©tails suivants de votre client HSM : l'adresse IP HSM, le nom de la partition HSM, le mot de passe de la partition HSM, et le certificat de serveur HSM public, qui est chiffr√© par CloudHSM √† l'aide d'une cl√© ma√Ætre interne. Une fois ces informations fournies, Redshift confirmera et v√©rifiera qu'il peut se connecter et acc√©der √† la partition de d√©veloppement.

Si vos politiques de s√©curit√© internes ou vos contr√¥les de gouvernance dictent que vous devez appliquer une rotation des cl√©s, cela est possible avec Redshift, vous permettant de faire pivoter les cl√©s de chiffrement pour les clusters chiffr√©s. Cependant, vous devez √™tre conscient que pendant le processus de rotation des cl√©s, cela rendra un cluster indisponible pendant une tr√®s courte p√©riode, il est donc pr√©f√©rable de ne faire pivoter les cl√©s que lorsque vous en avez besoin, ou si vous pensez qu'elles ont pu √™tre compromises.

Pendant la rotation, Redshift fera pivoter la CEK pour votre cluster et pour toutes les sauvegardes de ce cluster. Il fera pivoter une DEK pour le cluster, mais il n'est pas possible de faire pivoter une DEK pour les instantan√©s stock√©s dans S3 qui ont √©t√© chiffr√©s √† l'aide de la DEK. Il mettra le cluster dans un √©tat de 'rotation des cl√©s' jusqu'√† ce que le processus soit termin√©, moment o√π le statut reviendra √† 'disponible'.

</details>

### √ânum√©ration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistance

Les actions suivantes permettent d'accorder l'acc√®s √† d'autres comptes AWS au cluster :

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supportez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
