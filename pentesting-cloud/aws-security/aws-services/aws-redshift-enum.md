# AWS - Redshift Enum

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Amazon Redshift

Redshift æ˜¯ä¸€ç§å®Œå…¨æ‰˜ç®¡çš„æœåŠ¡ï¼Œå¯ä»¥æ‰©å±•åˆ°è¶…è¿‡ä¸€ä¸ª PB çš„å¤§å°ï¼Œç”¨ä½œ **å¤§æ•°æ®è§£å†³æ–¹æ¡ˆçš„æ•°æ®ä»“åº“**ã€‚ä½¿ç”¨ Redshift é›†ç¾¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¿«é€Ÿçš„åŸºäº SQL çš„æŸ¥è¯¢å·¥å…·å’Œå•†ä¸šæ™ºèƒ½åº”ç”¨ç¨‹åºå¯¹æ•°æ®é›†è¿›è¡Œåˆ†æï¼Œä»¥æ›´å¥½åœ°ç†è§£æ‚¨ä¸šåŠ¡çš„æ„¿æ™¯ã€‚

**Redshift æä¾›é™æ€åŠ å¯†ï¼Œä½¿ç”¨å››å±‚åŠ å¯†å¯†é’¥å±‚æ¬¡ç»“æ„ï¼Œä½¿ç”¨ KMS æˆ– CloudHSM ç®¡ç†é¡¶å±‚å¯†é’¥**ã€‚**å½“ä¸ºæ‚¨çš„é›†ç¾¤å¯ç”¨åŠ å¯†æ—¶ï¼Œæ— æ³•ç¦ç”¨ï¼Œåä¹‹äº¦ç„¶**ã€‚å½“æ‚¨æ‹¥æœ‰æœªåŠ å¯†çš„é›†ç¾¤æ—¶ï¼Œæ— æ³•è¿›è¡ŒåŠ å¯†ã€‚

é›†ç¾¤çš„åŠ å¯†åªèƒ½åœ¨åˆ›å»ºæ—¶è¿›è¡Œï¼Œä¸€æ—¦åŠ å¯†ï¼Œæ•°æ®ã€å…ƒæ•°æ®å’Œä»»ä½•å¿«ç…§ä¹Ÿä¼šè¢«åŠ å¯†ã€‚åŠ å¯†å¯†é’¥çš„å±‚æ¬¡çº§åˆ«å¦‚ä¸‹ï¼Œ**ç¬¬ä¸€å±‚æ˜¯ä¸»å¯†é’¥ï¼Œç¬¬äºŒå±‚æ˜¯é›†ç¾¤åŠ å¯†å¯†é’¥ï¼ŒCEKï¼Œç¬¬ä¸‰å±‚æ˜¯æ•°æ®åº“åŠ å¯†å¯†é’¥ï¼ŒDEKï¼Œæœ€åç¬¬å››å±‚æ˜¯æ•°æ®åŠ å¯†å¯†é’¥æœ¬èº«**ã€‚

### KMS

åœ¨åˆ›å»ºé›†ç¾¤æ—¶ï¼Œæ‚¨å¯ä»¥é€‰æ‹© Redshift çš„ **é»˜è®¤ KMS å¯†é’¥** æˆ–é€‰æ‹©æ‚¨ **è‡ªå·±çš„ CMK**ï¼Œè¿™ä½¿æ‚¨åœ¨å¯†é’¥æ§åˆ¶æ–¹é¢å…·æœ‰æ›´å¤§çš„çµæ´»æ€§ï¼Œç‰¹åˆ«æ˜¯ä»å¯å®¡è®¡çš„è§’åº¦æ¥çœ‹ã€‚

Redshift çš„é»˜è®¤ KMS å¯†é’¥æ˜¯åœ¨ç¬¬ä¸€æ¬¡é€‰æ‹©å’Œä½¿ç”¨å¯†é’¥é€‰é¡¹æ—¶è‡ªåŠ¨åˆ›å»ºçš„ï¼Œå¹¶ä¸”ç”± AWS å®Œå…¨ç®¡ç†ã€‚

æ­¤ KMS å¯†é’¥éšåä½¿ç”¨ CMK ä¸»å¯†é’¥ï¼ˆç¬¬ä¸€å±‚ï¼‰è¿›è¡ŒåŠ å¯†ã€‚æ­¤åŠ å¯†çš„ KMS æ•°æ®å¯†é’¥éšåç”¨ä½œé›†ç¾¤åŠ å¯†å¯†é’¥ï¼ŒCEKï¼Œç¬¬äºŒå±‚ã€‚æ­¤ CEK ç„¶åç”± KMS å‘é€åˆ° Redshiftï¼Œåœ¨é‚£é‡Œå®ƒä¸é›†ç¾¤åˆ†å¼€å­˜å‚¨ã€‚Redshift ç„¶åé€šè¿‡å®‰å…¨é€šé“å°†æ­¤åŠ å¯†çš„ CEK å‘é€åˆ°é›†ç¾¤ï¼Œåœ¨å†…å­˜ä¸­å­˜å‚¨ã€‚

Redshift ç„¶åè¯·æ±‚ KMS è§£å¯† CEKï¼Œç¬¬äºŒå±‚ã€‚æ­¤è§£å¯†çš„ CEK ä¹Ÿå­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚Redshift ç„¶ååˆ›å»ºä¸€ä¸ªéšæœºçš„æ•°æ®åº“åŠ å¯†å¯†é’¥ï¼ŒDEKï¼Œç¬¬ä¸‰å±‚ï¼Œå¹¶å°†å…¶åŠ è½½åˆ°é›†ç¾¤çš„å†…å­˜ä¸­ã€‚å†…å­˜ä¸­çš„è§£å¯† CEK ç„¶ååŠ å¯† DEKï¼Œè¯¥ DEK ä¹Ÿå­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚

æ­¤åŠ å¯†çš„ DEK ç„¶åé€šè¿‡å®‰å…¨é€šé“å‘é€å¹¶å•ç‹¬å­˜å‚¨åœ¨ Redshift ä¸­ã€‚CEK å’Œ DEK ç°åœ¨éƒ½ä»¥åŠ å¯†å’Œè§£å¯†çš„å½¢å¼å­˜å‚¨åœ¨é›†ç¾¤çš„å†…å­˜ä¸­ã€‚è§£å¯†çš„ DEK ç„¶åç”¨äºåŠ å¯†æ•°æ®å¯†é’¥ï¼Œç¬¬å››å±‚ï¼Œè¿™äº›å¯†é’¥æ˜¯ Redshift ä¸ºæ•°æ®åº“ä¸­çš„æ¯ä¸ªæ•°æ®å—éšæœºç”Ÿæˆçš„ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ AWS Trusted Advisor ç›‘æ§ Amazon S3 å­˜å‚¨æ¡¶çš„é…ç½®ï¼Œå¹¶ç¡®ä¿å¯ç”¨å­˜å‚¨æ¡¶æ—¥å¿—è®°å½•ï¼Œè¿™å¯¹äºæ‰§è¡Œå®‰å…¨å®¡è®¡å’Œè·Ÿè¸ª S3 ä¸­çš„ä½¿ç”¨æ¨¡å¼éå¸¸æœ‰ç”¨ã€‚

### CloudHSM

<details>

<summary>ä½¿ç”¨ CloudHSM çš„ Redshift</summary>

åœ¨ä½¿ç”¨ CloudHSM æ‰§è¡ŒåŠ å¯†æ—¶ï¼Œé¦–å…ˆå¿…é¡»åœ¨ HSM å®¢æˆ·ç«¯å’Œ Redshift ä¹‹é—´å»ºç«‹å—ä¿¡ä»»çš„è¿æ¥ï¼ŒåŒæ—¶ä½¿ç”¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¯ä¹¦ã€‚

æ­¤è¿æ¥æ˜¯æä¾›å®‰å…¨é€šä¿¡æ‰€å¿…éœ€çš„ï¼Œå…è®¸åŠ å¯†å¯†é’¥åœ¨ HSM å®¢æˆ·ç«¯å’Œ Redshift é›†ç¾¤ä¹‹é—´å‘é€ã€‚ä½¿ç”¨éšæœºç”Ÿæˆçš„ç§é’¥å’Œå…¬é’¥å¯¹ï¼ŒRedshift åˆ›å»ºä¸€ä¸ªå…¬æœ‰å®¢æˆ·ç«¯è¯ä¹¦ï¼Œè¯¥è¯ä¹¦ç”± Redshift åŠ å¯†å¹¶å­˜å‚¨ã€‚å¿…é¡»ä¸‹è½½å¹¶æ³¨å†Œåˆ°æ‚¨çš„ HSM å®¢æˆ·ç«¯ï¼Œå¹¶åˆ†é…ç»™æ­£ç¡®çš„ HSM åˆ†åŒºã€‚

ç„¶åï¼Œæ‚¨å¿…é¡»ä½¿ç”¨ä»¥ä¸‹ HSM å®¢æˆ·ç«¯çš„è¯¦ç»†ä¿¡æ¯é…ç½® Redshiftï¼šHSM IP åœ°å€ã€HSM åˆ†åŒºåç§°ã€HSM åˆ†åŒºå¯†ç å’Œå…¬å…± HSM æœåŠ¡å™¨è¯ä¹¦ï¼Œè¯¥è¯ä¹¦ç”± CloudHSM ä½¿ç”¨å†…éƒ¨ä¸»å¯†é’¥åŠ å¯†ã€‚ä¸€æ—¦æä¾›äº†è¿™äº›ä¿¡æ¯ï¼ŒRedshift å°†ç¡®è®¤å¹¶éªŒè¯å®ƒå¯ä»¥è¿æ¥å¹¶è®¿é—®å¼€å‘åˆ†åŒºã€‚

å¦‚æœæ‚¨çš„å†…éƒ¨å®‰å…¨æ”¿ç­–æˆ–æ²»ç†æ§åˆ¶è§„å®šæ‚¨å¿…é¡»åº”ç”¨å¯†é’¥è½®æ¢ï¼Œé‚£ä¹ˆè¿™åœ¨ Redshift ä¸­æ˜¯å¯èƒ½çš„ï¼Œä½¿æ‚¨èƒ½å¤Ÿä¸ºåŠ å¯†é›†ç¾¤è½®æ¢åŠ å¯†å¯†é’¥ï¼Œä½†æ‚¨éœ€è¦æ³¨æ„ï¼Œåœ¨å¯†é’¥è½®æ¢è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šä½¿é›†ç¾¤åœ¨éå¸¸çŸ­çš„æ—¶é—´å†…ä¸å¯ç”¨ï¼Œå› æ­¤æœ€å¥½ä»…åœ¨éœ€è¦æ—¶æˆ–å¦‚æœæ‚¨è§‰å¾—å¯†é’¥å¯èƒ½å·²è¢«æ³„éœ²æ—¶è¿›è¡Œè½®æ¢ã€‚

åœ¨è½®æ¢æœŸé—´ï¼ŒRedshift å°†ä¸ºæ‚¨çš„é›†ç¾¤åŠå…¶ä»»ä½•å¤‡ä»½è½®æ¢ CEKã€‚å®ƒå°†ä¸ºé›†ç¾¤è½®æ¢ DEKï¼Œä½†æ— æ³•ä¸ºä½¿ç”¨ DEK åŠ å¯†çš„å­˜å‚¨åœ¨ S3 ä¸­çš„å¿«ç…§è½®æ¢ DEKã€‚å®ƒå°†ä½¿é›†ç¾¤å¤„äºâ€œè½®æ¢å¯†é’¥â€çš„çŠ¶æ€ï¼Œç›´åˆ°è¿‡ç¨‹å®Œæˆï¼ŒçŠ¶æ€å°†è¿”å›ä¸ºâ€œå¯ç”¨â€ã€‚

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## æŒä¹…æ€§

ä»¥ä¸‹æ“ä½œå…è®¸å°†å…¶ä»– AWS è´¦æˆ·çš„è®¿é—®æƒé™æˆäºˆé›†ç¾¤ï¼š

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
