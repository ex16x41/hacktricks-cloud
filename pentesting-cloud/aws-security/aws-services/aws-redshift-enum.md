# AWS - Redshift Enum

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Amazon Redshift

Redshift ist ein vollst√§ndig verwalteter Dienst, der auf √ºber ein Petabyte skalieren kann und als **Data Warehouse f√ºr Big Data-L√∂sungen** verwendet wird. Mit Redshift-Clustern k√∂nnen Sie Analysen Ihrer Datens√§tze mit schnellen, SQL-basierten Abfragewerkzeugen und Business-Intelligence-Anwendungen durchf√ºhren, um ein besseres Verst√§ndnis und eine Vision f√ºr Ihr Unternehmen zu gewinnen.

**Redshift bietet Verschl√ºsselung im Ruhezustand mit einer vierstufigen Hierarchie von Verschl√ºsselungsschl√ºsseln, wobei entweder KMS oder CloudHSM zur Verwaltung der obersten Schl√ºsselschicht verwendet werden**. **Wenn die Verschl√ºsselung f√ºr Ihren Cluster aktiviert ist, kann sie nicht deaktiviert werden und umgekehrt**. Wenn Sie einen unverschl√ºsselten Cluster haben, kann dieser nicht verschl√ºsselt werden.

Die Verschl√ºsselung f√ºr Ihren Cluster kann nur w√§hrend seiner Erstellung erfolgen, und sobald er verschl√ºsselt ist, werden auch die Daten, Metadaten und alle Snapshots verschl√ºsselt. Die Verschl√ºsselungsschl√ºssel sind wie folgt gestaffelt: **Stufe eins ist der Master-Schl√ºssel, Stufe zwei ist der Cluster-Verschl√ºsselungsschl√ºssel, der CEK, Stufe drei, der Datenbank-Verschl√ºsselungsschl√ºssel, der DEK, und schlie√ülich Stufe vier, die eigentlichen Datenverschl√ºsselungsschl√ºssel**.

### KMS

W√§hrend der Erstellung Ihres Clusters k√∂nnen Sie entweder den **Standard-KMS-Schl√ºssel** f√ºr Redshift ausw√§hlen oder Ihren **eigenen CMK** ausw√§hlen, was Ihnen mehr Flexibilit√§t bei der Kontrolle des Schl√ºssels bietet, insbesondere aus pr√ºfbarer Sicht.

Der Standard-KMS-Schl√ºssel f√ºr Redshift wird automatisch von Redshift erstellt, wenn die Schl√ºsseloption zum ersten Mal ausgew√§hlt und verwendet wird, und wird vollst√§ndig von AWS verwaltet.

Dieser KMS-Schl√ºssel wird dann mit dem CMK-Master-Schl√ºssel, Stufe eins, verschl√ºsselt. Dieser verschl√ºsselte KMS-Datenschl√ºssel wird dann als Cluster-Verschl√ºsselungsschl√ºssel, der CEK, Stufe zwei, verwendet. Dieser CEK wird dann von KMS an Redshift gesendet, wo er getrennt vom Cluster gespeichert wird. Redshift sendet diesen verschl√ºsselten CEK √ºber einen sicheren Kanal an den Cluster, wo er im Speicher gespeichert wird.

Redshift fordert dann KMS auf, den CEK, Stufe zwei, zu entschl√ºsseln. Dieser entschl√ºsselte CEK wird dann ebenfalls im Speicher gespeichert. Redshift erstellt dann einen zuf√§lligen Datenbank-Verschl√ºsselungsschl√ºssel, den DEK, Stufe drei, und l√§dt diesen in den Speicher des Clusters. Der entschl√ºsselte CEK im Speicher verschl√ºsselt dann den DEK, der ebenfalls im Speicher gespeichert wird.

Dieser verschl√ºsselte DEK wird dann √ºber einen sicheren Kanal gesendet und getrennt vom Cluster in Redshift gespeichert. Sowohl der CEK als auch der DEK werden nun im Speicher des Clusters sowohl in verschl√ºsselter als auch in entschl√ºsselter Form gespeichert. Der entschl√ºsselte DEK wird dann verwendet, um Datenverschl√ºsselungsschl√ºssel, Stufe vier, zu verschl√ºsseln, die von Redshift f√ºr jeden Datenblock in der Datenbank zuf√§llig generiert werden.

Sie k√∂nnen AWS Trusted Advisor verwenden, um die Konfiguration Ihrer Amazon S3-Buckets zu √ºberwachen und sicherzustellen, dass das Bucket-Logging aktiviert ist, was n√ºtzlich sein kann, um Sicherheitspr√ºfungen durchzuf√ºhren und Nutzungsmuster in S3 zu verfolgen.

### CloudHSM

<details>

<summary>Verwendung von Redshift mit CloudHSM</summary>

Wenn Sie mit CloudHSM arbeiten, um Ihre Verschl√ºsselung durchzuf√ºhren, m√ºssen Sie zun√§chst eine vertrauensw√ºrdige Verbindung zwischen Ihrem HSM-Client und Redshift einrichten, w√§hrend Sie Client- und Serverzertifikate verwenden.

Diese Verbindung ist erforderlich, um sichere Kommunikation bereitzustellen, sodass Verschl√ºsselungsschl√ºssel zwischen Ihrem HSM-Client und Ihren Redshift-Clustern gesendet werden k√∂nnen. Mit einem zuf√§llig generierten privaten und √∂ffentlichen Schl√ºsselpaar erstellt Redshift ein √∂ffentliches Client-Zertifikat, das von Redshift verschl√ºsselt und gespeichert wird. Dieses muss heruntergeladen und bei Ihrem HSM-Client registriert und der richtigen HSM-Partition zugewiesen werden.

Sie m√ºssen Redshift dann mit den folgenden Details Ihres HSM-Clients konfigurieren: die HSM-IP-Adresse, den HSM-Partitionsnamen, das HSM-Partitionspasswort und das √∂ffentliche HSM-Serverzertifikat, das von CloudHSM mit einem internen Master-Schl√ºssel verschl√ºsselt wird. Sobald diese Informationen bereitgestellt wurden, wird Redshift best√§tigen und √ºberpr√ºfen, dass es sich verbinden und auf die Entwicklungspartition zugreifen kann.

Wenn Ihre internen Sicherheitsrichtlinien oder Governance-Kontrollen vorschreiben, dass Sie eine Schl√ºsselrotation anwenden m√ºssen, ist dies mit Redshift m√∂glich, sodass Sie Verschl√ºsselungsschl√ºssel f√ºr verschl√ºsselte Cluster rotieren k√∂nnen. Sie m√ºssen jedoch beachten, dass w√§hrend des Schl√ºsselrotationsprozesses ein Cluster f√ºr eine sehr kurze Zeit nicht verf√ºgbar ist. Daher ist es am besten, Schl√ºssel nur dann zu rotieren, wenn es notwendig ist oder wenn Sie glauben, dass sie kompromittiert wurden.

W√§hrend der Rotation wird Redshift den CEK f√ºr Ihren Cluster und f√ºr alle Backups dieses Clusters rotieren. Es wird einen DEK f√ºr den Cluster rotieren, aber es ist nicht m√∂glich, einen DEK f√ºr die in S3 gespeicherten Snapshots zu rotieren, die mit dem DEK verschl√ºsselt wurden. Es wird den Cluster in einen Zustand des 'Schl√ºsselrotierens' versetzen, bis der Prozess abgeschlossen ist, wenn der Status wieder auf 'verf√ºgbar' zur√ºckkehrt.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistenz

Die folgenden Aktionen erm√∂glichen es, anderen AWS-Konten Zugriff auf den Cluster zu gew√§hren:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* Schau dir die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop) an!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
