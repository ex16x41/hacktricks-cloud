# AWS - Redshift Enum

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Amazon Redshift

Redshift, **bÃ¼yÃ¼k veri Ã§Ã¶zÃ¼mleri iÃ§in bir veri ambarÄ±** olarak kullanÄ±lan, bir petabaytÄ±n Ã¼zerinde Ã¶lÃ§eklenebilen tamamen yÃ¶netilen bir hizmettir. Redshift kÃ¼melerini kullanarak, veri setleriniz Ã¼zerinde hÄ±zlÄ±, SQL tabanlÄ± sorgu araÃ§larÄ± ve iÅŸ zekasÄ± uygulamalarÄ± kullanarak analizler yapabilir ve iÅŸinizin vizyonunu daha iyi anlamak iÃ§in veri toplayabilirsiniz.

**Redshift, KMS veya CloudHSM kullanarak anahtarlarÄ±n en Ã¼st katmanÄ±nÄ± yÃ¶netmek iÃ§in dÃ¶rt katmanlÄ± bir ÅŸifreleme anahtarÄ± hiyerarÅŸisi kullanarak dinlenme sÄ±rasÄ±nda ÅŸifreleme sunar**. **KÃ¼meniz iÃ§in ÅŸifreleme etkinleÅŸtirildiÄŸinde, devre dÄ±ÅŸÄ± bÄ±rakÄ±lamaz ve tersine**. ÅifrelenmemiÅŸ bir kÃ¼meniz olduÄŸunda, ÅŸifrelenemez.

KÃ¼meniz iÃ§in ÅŸifreleme yalnÄ±zca oluÅŸturulmasÄ± sÄ±rasÄ±nda gerÃ§ekleÅŸebilir ve bir kez ÅŸifrelendiÄŸinde, veri, meta veri ve herhangi bir anlÄ±k gÃ¶rÃ¼ntÃ¼ de ÅŸifrelenir. Åifreleme anahtarlarÄ±nÄ±n katmanlama seviyesi ÅŸu ÅŸekildedir: **birinci katman anahtar, ikinci katman kÃ¼me ÅŸifreleme anahtarÄ±, CEK, Ã¼Ã§Ã¼ncÃ¼ katman veritabanÄ± ÅŸifreleme anahtarÄ±, DEK ve son olarak dÃ¶rdÃ¼ncÃ¼ katman, veri ÅŸifreleme anahtarlarÄ±dÄ±r**.

### KMS

KÃ¼menizi oluÅŸtururken, Redshift iÃ§in **varsayÄ±lan KMS anahtarÄ±nÄ±** seÃ§ebilir veya **kendi CMK'nizi** seÃ§ebilirsiniz; bu, anahtarÄ±n kontrolÃ¼ Ã¼zerinde daha fazla esneklik saÄŸlar, Ã¶zellikle denetlenebilir bir perspektiften.

Redshift iÃ§in varsayÄ±lan KMS anahtarÄ±, anahtar seÃ§eneÄŸi ilk kez seÃ§ildiÄŸinde ve kullanÄ±ldÄ±ÄŸÄ±nda Redshift tarafÄ±ndan otomatik olarak oluÅŸturulur ve AWS tarafÄ±ndan tamamen yÃ¶netilir.

Bu KMS anahtarÄ± daha sonra CMK anahtarÄ±nÄ±n, birinci katman, ile ÅŸifrelenir. Bu ÅŸifrelenmiÅŸ KMS veri anahtarÄ± daha sonra kÃ¼me ÅŸifreleme anahtarÄ±, CEK, ikinci katman olarak kullanÄ±lÄ±r. Bu CEK daha sonra KMS tarafÄ±ndan Redshift'e gÃ¶nderilir ve burada kÃ¼meden ayrÄ± olarak saklanÄ±r. Redshift daha sonra bu ÅŸifrelenmiÅŸ CEK'yi gÃ¼venli bir kanal Ã¼zerinden kÃ¼meye gÃ¶nderir ve burada bellekte saklanÄ±r.

Redshift daha sonra KMS'ten CEK'yi, ikinci katman, ÅŸifre Ã§Ã¶zmesini ister. Bu ÅŸifrelenmiÅŸ CEK daha sonra bellekte de saklanÄ±r. Redshift daha sonra rastgele bir veritabanÄ± ÅŸifreleme anahtarÄ±, DEK, Ã¼Ã§Ã¼ncÃ¼ katman oluÅŸturur ve bunu kÃ¼menin belleÄŸine yÃ¼kler. Bellekteki ÅŸifrelenmemiÅŸ CEK, DEK'yi ÅŸifreler ve bu da bellekte saklanÄ±r.

Bu ÅŸifrelenmiÅŸ DEK daha sonra gÃ¼venli bir kanal Ã¼zerinden gÃ¶nderilir ve Redshift'te kÃ¼meden ayrÄ± olarak saklanÄ±r. Hem CEK hem de DEK artÄ±k kÃ¼menin belleÄŸinde hem ÅŸifrelenmiÅŸ hem de ÅŸifrelenmemiÅŸ formda saklanmaktadÄ±r. ÅifrelenmemiÅŸ DEK daha sonra veritabanÄ±ndaki her veri bloÄŸu iÃ§in Redshift tarafÄ±ndan rastgele Ã¼retilen veri anahtarlarÄ±nÄ± ÅŸifrelemek iÃ§in kullanÄ±lÄ±r.

Amazon S3 kovalarÄ±nÄ±zÄ±n yapÄ±landÄ±rmasÄ±nÄ± izlemek ve kova gÃ¼nlÃ¼ÄŸÃ¼nÃ¼n etkinleÅŸtirildiÄŸinden emin olmak iÃ§in AWS Trusted Advisor'Ä± kullanabilirsiniz; bu, gÃ¼venlik denetimleri gerÃ§ekleÅŸtirmek ve S3'teki kullanÄ±m desenlerini izlemek iÃ§in yararlÄ± olabilir.

### CloudHSM

<details>

<summary>CloudHSM ile Redshift KullanÄ±mÄ±</summary>

CloudHSM ile ÅŸifreleme gerÃ§ekleÅŸtirmek iÃ§in Ã§alÄ±ÅŸÄ±rken, Ã¶ncelikle HSM istemciniz ile Redshift arasÄ±nda gÃ¼venilir bir baÄŸlantÄ± kurmalÄ±sÄ±nÄ±z ve bu sÄ±rada istemci ve sunucu sertifikalarÄ±nÄ± kullanmalÄ±sÄ±nÄ±z.

Bu baÄŸlantÄ±, HSM istemciniz ile Redshift kÃ¼meleriniz arasÄ±nda ÅŸifreleme anahtarlarÄ±nÄ±n gÃ¶nderilmesine olanak tanÄ±yan gÃ¼venli iletiÅŸim saÄŸlamak iÃ§in gereklidir. Rastgele Ã¼retilen bir Ã¶zel ve genel anahtar Ã§ifti kullanarak, Redshift bir genel istemci sertifikasÄ± oluÅŸturur; bu sertifika ÅŸifrelenir ve Redshift tarafÄ±ndan saklanÄ±r. Bu, indirilip HSM istemcinize kaydedilmeli ve doÄŸru HSM bÃ¶lÃ¼mÃ¼ne atanmalÄ±dÄ±r.

Daha sonra Redshift'i HSM istemcinizin aÅŸaÄŸÄ±daki bilgileri ile yapÄ±landÄ±rmalÄ±sÄ±nÄ±z: HSM IP adresi, HSM bÃ¶lÃ¼m adÄ±, HSM bÃ¶lÃ¼m ÅŸifresi ve CloudHSM tarafÄ±ndan iÃ§ anahtar kullanÄ±larak ÅŸifrelenmiÅŸ genel HSM sunucu sertifikasÄ±. Bu bilgiler saÄŸlandÄ±ÄŸÄ±nda, Redshift baÄŸlantÄ± kurabileceÄŸini ve geliÅŸtirme bÃ¶lÃ¼mÃ¼ne eriÅŸebileceÄŸini onaylayacak ve doÄŸrulayacaktÄ±r.

EÄŸer iÃ§ gÃ¼venlik politikalarÄ±nÄ±z veya yÃ¶netiÅŸim kontrolleriniz anahtar dÃ¶ngÃ¼sÃ¼ uygulamanÄ±z gerektiÄŸini belirtiyorsa, bu Redshift ile mÃ¼mkÃ¼ndÃ¼r ve ÅŸifrelenmiÅŸ kÃ¼meler iÃ§in ÅŸifreleme anahtarlarÄ±nÄ± dÃ¶ndÃ¼rmenizi saÄŸlar; ancak, anahtar dÃ¶ngÃ¼sÃ¼ sÃ¼recinde, kÃ¼menin Ã§ok kÄ±sa bir sÃ¼reliÄŸine kullanÄ±lamaz hale geleceÄŸini bilmelisiniz, bu nedenle anahtarlarÄ± yalnÄ±zca gerektiÄŸinde veya tehlikeye girmiÅŸ olabileceÄŸini dÃ¼ÅŸÃ¼ndÃ¼ÄŸÃ¼nÃ¼zde dÃ¶ndÃ¼rmek en iyisidir.

DÃ¶ngÃ¼ sÄ±rasÄ±nda, Redshift kÃ¼meniz iÃ§in CEK'yi ve o kÃ¼menin yedekleri iÃ§in CEK'yi dÃ¶ndÃ¼recektir. KÃ¼me iÃ§in bir DEK dÃ¶ndÃ¼recektir, ancak DEK kullanÄ±larak ÅŸifrelenmiÅŸ S3'te saklanan anlÄ±k gÃ¶rÃ¼ntÃ¼ler iÃ§in bir DEK dÃ¶ndÃ¼rmek mÃ¼mkÃ¼n deÄŸildir. SÃ¼reÃ§ tamamlanana kadar kÃ¼me 'anahtar dÃ¶ndÃ¼rme' durumuna alÄ±nacak ve durum 'kullanÄ±labilir' olarak geri dÃ¶necektir.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## SÃ¼reklilik

AÅŸaÄŸÄ±daki eylemler, kÃ¼meye diÄŸer AWS hesaplarÄ±na eriÅŸim vermeyi saÄŸlar:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
