# AWS - Redshift Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Amazon Redshift

Redshift es un servicio completamente gestionado que puede escalar hasta m√°s de un petabyte en tama√±o, que se utiliza como un **almac√©n de datos para soluciones de big data**. Usando cl√∫steres de Redshift, puedes ejecutar an√°lisis sobre tus conjuntos de datos utilizando herramientas de consulta r√°pidas basadas en SQL y aplicaciones de inteligencia empresarial para obtener una mayor comprensi√≥n de la visi√≥n de tu negocio.

**Redshift ofrece cifrado en reposo utilizando una jerarqu√≠a de cuatro niveles de claves de cifrado utilizando KMS o CloudHSM para gestionar el nivel superior de claves**. **Cuando el cifrado est√° habilitado para tu cl√∫ster, no se puede desactivar y viceversa**. Cuando tienes un cl√∫ster sin cifrar, no se puede cifrar.

El cifrado para tu cl√∫ster solo puede ocurrir durante su creaci√≥n, y una vez cifrado, los datos, metadatos y cualquier instant√°nea tambi√©n est√°n cifrados. Los niveles de jerarqu√≠a de las claves de cifrado son los siguientes: **el nivel uno es la clave maestra, el nivel dos es la clave de cifrado del cl√∫ster, la CEK, el nivel tres, la clave de cifrado de la base de datos, la DEK, y finalmente el nivel cuatro, las claves de cifrado de datos en s√≠**.

### KMS

Durante la creaci√≥n de tu cl√∫ster, puedes seleccionar la **clave KMS predeterminada** para Redshift o seleccionar tu **propia CMK**, lo que te da m√°s flexibilidad sobre el control de la clave, espec√≠ficamente desde una perspectiva auditable.

La clave KMS predeterminada para Redshift es creada autom√°ticamente por Redshift la primera vez que se selecciona y utiliza la opci√≥n de clave, y es completamente gestionada por AWS.

Esta clave KMS se cifra luego con la clave maestra CMK, nivel uno. Esta clave de datos KMS cifrada se utiliza como la clave de cifrado del cl√∫ster, la CEK, nivel dos. Esta CEK se env√≠a a Redshift donde se almacena por separado del cl√∫ster. Redshift luego env√≠a esta CEK cifrada al cl√∫ster a trav√©s de un canal seguro donde se almacena en memoria.

Redshift luego solicita a KMS que descifre la CEK, nivel dos. Esta CEK descifrada tambi√©n se almacena en memoria. Redshift luego crea una clave de cifrado de base de datos aleatoria, la DEK, nivel tres, y la carga en la memoria del cl√∫ster. La CEK descifrada en memoria luego cifra la DEK, que tambi√©n se almacena en memoria.

Esta DEK cifrada se env√≠a a trav√©s de un canal seguro y se almacena en Redshift por separado del cl√∫ster. Tanto la CEK como la DEK ahora se almacenan en la memoria del cl√∫ster tanto en forma cifrada como descifrada. La DEK descifrada se utiliza luego para cifrar las claves de datos, nivel cuatro, que son generadas aleatoriamente por Redshift para cada bloque de datos en la base de datos.

Puedes usar AWS Trusted Advisor para monitorear la configuraci√≥n de tus buckets de Amazon S3 y asegurarte de que el registro de buckets est√© habilitado, lo que puede ser √∫til para realizar auditor√≠as de seguridad y rastrear patrones de uso en S3.

### CloudHSM

<details>

<summary>Using Redshift with CloudHSM</summary>

Al trabajar con CloudHSM para realizar tu cifrado, primero debes establecer una conexi√≥n de confianza entre tu cliente HSM y Redshift mientras usas certificados de cliente y servidor.

Esta conexi√≥n es necesaria para proporcionar comunicaciones seguras, permitiendo que las claves de cifrado se env√≠en entre tu cliente HSM y tus cl√∫steres de Redshift. Usando un par de claves privadas y p√∫blicas generadas aleatoriamente, Redshift crea un certificado de cliente p√∫blico, que es cifrado y almacenado por Redshift. Este debe ser descargado y registrado en tu cliente HSM, y asignado a la partici√≥n HSM correcta.

Luego debes configurar Redshift con los siguientes detalles de tu cliente HSM: la direcci√≥n IP del HSM, el nombre de la partici√≥n HSM, la contrase√±a de la partici√≥n HSM y el certificado del servidor HSM p√∫blico, que es cifrado por CloudHSM usando una clave maestra interna. Una vez que se ha proporcionado esta informaci√≥n, Redshift confirmar√° y verificar√° que puede conectarse y acceder a la partici√≥n de desarrollo.

Si tus pol√≠ticas de seguridad internas o controles de gobernanza dictan que debes aplicar rotaci√≥n de claves, entonces esto es posible con Redshift, permiti√©ndote rotar claves de cifrado para cl√∫steres cifrados, sin embargo, debes ser consciente de que durante el proceso de rotaci√≥n de claves, har√° que un cl√∫ster no est√© disponible por un per√≠odo de tiempo muy corto, por lo que es mejor rotar claves solo cuando sea necesario, o si sientes que pueden haber sido comprometidas.

Durante la rotaci√≥n, Redshift rotar√° la CEK para tu cl√∫ster y para cualquier respaldo de ese cl√∫ster. Rotar√° una DEK para el cl√∫ster, pero no es posible rotar una DEK para las instant√°neas almacenadas en S3 que han sido cifradas usando la DEK. Pondr√° al cl√∫ster en un estado de 'rotaci√≥n de claves' hasta que el proceso se complete, momento en el cual el estado volver√° a 'disponible'.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistencia

Las siguientes acciones permiten otorgar acceso a otras cuentas de AWS al cl√∫ster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
