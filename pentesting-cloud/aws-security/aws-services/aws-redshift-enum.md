# AWS - Redshift Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Amazon Redshift

Redshift to w peni zarzdzana usuga, kt贸ra mo偶e skalowa si do ponad petabajta, u偶ywana jako **hurtownia danych dla rozwiza big data**. Korzystajc z klastr贸w Redshift, mo偶esz przeprowadza analizy na swoich zbiorach danych za pomoc szybkich narzdzi zapyta opartych na SQL i aplikacji business intelligence, aby uzyska lepsze zrozumienie wizji dla swojego biznesu.

**Redshift oferuje szyfrowanie danych w spoczynku za pomoc czteropoziomowej hierarchii kluczy szyfrowania, u偶ywajc KMS lub CloudHSM do zarzdzania najwy偶szym poziomem kluczy**. **Gdy szyfrowanie jest wczone dla twojego klastra, nie mo偶na go wyczy i odwrotnie**. Gdy masz nieszyfrowany klaster, nie mo偶na go zaszyfrowa.

Szyfrowanie dla twojego klastra mo偶e nastpi tylko podczas jego tworzenia, a po zaszyfrowaniu dane, metadane i wszelkie migawki s r贸wnie偶 szyfrowane. Poziomy hierarchii kluczy szyfrowania s nastpujce: **poziom pierwszy to klucz g贸wny, poziom drugi to klucz szyfrowania klastra, CEK, poziom trzeci to klucz szyfrowania bazy danych, DEK, a wreszcie poziom czwarty to same klucze szyfrowania danych**.

### KMS

Podczas tworzenia klastra mo偶esz wybra **domylny klucz KMS** dla Redshift lub wybra **wasny CMK**, co daje wiksz elastyczno w kontroli nad kluczem, zwaszcza z perspektywy audytowalnej.

Domylny klucz KMS dla Redshift jest automatycznie tworzony przez Redshift przy pierwszym wyborze i u偶yciu opcji klucza i jest w peni zarzdzany przez AWS.

Ten klucz KMS jest nastpnie szyfrowany za pomoc klucza g贸wnego CMK, poziom pierwszy. Ten zaszyfrowany klucz danych KMS jest nastpnie u偶ywany jako klucz szyfrowania klastra, CEK, poziom drugi. Ten CEK jest nastpnie wysyany przez KMS do Redshift, gdzie jest przechowywany oddzielnie od klastra. Redshift nastpnie wysya ten zaszyfrowany CEK do klastra przez bezpieczny kana, gdzie jest przechowywany w pamici.

Redshift nastpnie prosi KMS o odszyfrowanie CEK, poziom drugi. Ten odszyfrowany CEK jest nastpnie r贸wnie偶 przechowywany w pamici. Redshift nastpnie tworzy losowy klucz szyfrowania bazy danych, DEK, poziom trzeci, i aduje go do pamici klastra. Odszyfrowany CEK w pamici nastpnie szyfruje DEK, kt贸ry jest r贸wnie偶 przechowywany w pamici.

Ten zaszyfrowany DEK jest nastpnie wysyany przez bezpieczny kana i przechowywany w Redshift oddzielnie od klastra. Zar贸wno CEK, jak i DEK s teraz przechowywane w pamici klastra zar贸wno w formie zaszyfrowanej, jak i odszyfrowanej. Odszyfrowany DEK jest nastpnie u偶ywany do szyfrowania kluczy danych, poziom czwarty, kt贸re s losowo generowane przez Redshift dla ka偶dego bloku danych w bazie danych.

Mo偶esz u偶y AWS Trusted Advisor do monitorowania konfiguracji swoich wiader Amazon S3 i upewnienia si, 偶e logowanie wiader jest wczone, co mo偶e by przydatne do przeprowadzania audyt贸w bezpieczestwa i ledzenia wzorc贸w u偶ytkowania w S3.

### CloudHSM

<details>

<summary>Using Redshift with CloudHSM</summary>

Podczas pracy z CloudHSM w celu przeprowadzenia szyfrowania, najpierw musisz ustanowi zaufane poczenie midzy klientem HSM a Redshift, u偶ywajc certyfikat贸w klienta i serwera.

To poczenie jest wymagane do zapewnienia bezpiecznej komunikacji, umo偶liwiajc przesyanie kluczy szyfrowania midzy klientem HSM a klastrami Redshift. U偶ywajc losowo wygenerowanej pary kluczy prywatnych i publicznych, Redshift tworzy publiczny certyfikat klienta, kt贸ry jest szyfrowany i przechowywany przez Redshift. Musi on zosta pobrany i zarejestrowany w kliencie HSM oraz przypisany do odpowiedniej partycji HSM.

Nastpnie musisz skonfigurowa Redshift z nastpujcymi danymi swojego klienta HSM: adres IP HSM, nazwa partycji HSM, haso partycji HSM oraz publiczny certyfikat serwera HSM, kt贸ry jest szyfrowany przez CloudHSM za pomoc wewntrznego klucza g贸wnego. Po dostarczeniu tych informacji, Redshift potwierdzi i zweryfikuje, 偶e mo偶e poczy si i uzyska dostp do partycji rozwojowej.

Jeli twoje wewntrzne polityki bezpieczestwa lub kontrole zarzdzania wymagaj zastosowania rotacji kluczy, jest to mo偶liwe z Redshift, umo偶liwiajc rotacj kluczy szyfrowania dla zaszyfrowanych klastr贸w, jednak musisz by wiadomy, 偶e podczas procesu rotacji kluczy klaster bdzie niedostpny przez bardzo kr贸tki czas, wic najlepiej jest rotowa klucze tylko wtedy, gdy jest to konieczne lub jeli uwa偶asz, 偶e mogy zosta skompromitowane.

Podczas rotacji, Redshift bdzie rotowa CEK dla twojego klastra i dla wszelkich kopii zapasowych tego klastra. Bdzie rotowa DEK dla klastra, ale nie jest mo偶liwe rotowanie DEK dla migawek przechowywanych w S3, kt贸re zostay zaszyfrowane za pomoc DEK. Klaster zostanie w stanie 'rotating keys' do momentu zakoczenia procesu, po czym status powr贸ci do 'available'.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistence

Nastpujce akcje pozwalaj na przyznanie dostpu do innych kont AWS do klastra:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Ucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
