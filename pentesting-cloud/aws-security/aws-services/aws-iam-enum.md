# AWS - IAM, Identity Center & SSO Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## IAM

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ **–æ–ø–∏—Å IAM** –≤:

{% content-ref url="../aws-basic-information/" %}
[aws-basic-information](../aws-basic-information/)
{% endcontent-ref %}

### Enumeration

–û—Å–Ω–æ–≤–Ω—ñ –¥–æ–∑–≤–æ–ª–∏, —è–∫—ñ –ø–æ—Ç—Ä—ñ–±–Ω—ñ:

* `iam:ListPolicies`, `iam:GetPolicy` —Ç–∞ `iam:GetPolicyVersion`
* `iam:ListRoles`
* `iam:ListUsers`
* `iam:ListGroups`
* `iam:ListGroupsForUser`
* `iam:ListAttachedUserPolicies`
* `iam:ListAttachedRolePolicies`
* `iam:ListAttachedGroupPolicies`
* `iam:ListUserPolicies` —Ç–∞ `iam:GetUserPolicy`
* `iam:ListGroupPolicies` —Ç–∞ `iam:GetGroupPolicy`
* `iam:ListRolePolicies` —Ç–∞ `iam:GetRolePolicy`
```bash
# All IAMs
## Retrieves  information about all IAM users, groups, roles, and policies
## in your Amazon Web Services account, including their relationships  to
## one another. Use this operation to obtain a snapshot of the configura-
## tion of IAM permissions (users, groups, roles, and  policies)  in  your
## account.
aws iam get-account-authorization-details

# List users
aws iam get-user #Get current user information
aws iam list-users
aws iam list-ssh-public-keys #User keys for CodeCommit
aws iam get-ssh-public-key --user-name <username> --ssh-public-key-id <id> --encoding SSH #Get public key with metadata
aws iam list-service-specific-credentials #Get special permissions of the IAM user over specific services
aws iam get-user --user-name <username> #Get metadata of user, included permissions boundaries
aws iam list-access-keys #List created access keys
## inline policies
aws iam list-user-policies --user-name <username> #Get inline policies of the user
aws iam get-user-policy --user-name <username> --policy-name <policyname> #Get inline policy details
## attached policies
aws iam list-attached-user-policies --user-name <username> #Get policies of user, it doesn't get inline policies

# List groups
aws iam list-groups #Get groups
aws iam list-groups-for-user --user-name <username> #Get groups of a user
aws iam get-group --group-name <name> #Get group name info
## inline policies
aws iam list-group-policies --group-name <username> #Get inline policies of the group
aws iam get-group-policy --group-name <username> --policy-name <policyname> #Get an inline policy info
## attached policies
aws iam list-attached-group-policies --group-name <name> #Get policies of group, it doesn't get inline policies

# List roles
aws iam list-roles #Get roles
aws iam get-role --role-name <role-name> #Get role
## inline policies
aws iam list-role-policies --role-name <name> #Get inline policies of a role
aws iam get-role-policy --role-name <name> --policy-name <name> #Get inline policy details
## attached policies
aws iam list-attached-role-policies --role-name <role-name> #Get policies of role, it doesn't get inline policies

# List policies
aws iam list-policies [--only-attached] [--scope Local]
aws iam list-policies-granting-service-access --arn <identity> --service-namespaces <svc> # Get list of policies that give access to the user to the service
## Get policy content
aws iam get-policy --policy-arn <policy_arn>
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn:aws:iam::975426262029:policy/list_apigateways> --version-id <VERSION_X>

# Enumerate providers
aws iam list-saml-providers
aws iam get-saml-provider --saml-provider-arn <ARN>
aws iam list-open-id-connect-providers
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>

# Password Policy
aws iam get-account-password-policy

# MFA
aws iam list-mfa-devices
aws iam list-virtual-mfa-devices
```
### Permissions Brute Force

–Ø–∫—â–æ –≤–∞—Å —Ü—ñ–∫–∞–≤–ª—è—Ç—å –≤–∞—à—ñ –≤–ª–∞—Å–Ω—ñ –¥–æ–∑–≤–æ–ª–∏, –∞–ª–µ —É –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–ª—è –∑–∞–ø–∏—Ç—É IAM, –≤–∏ –∑–∞–≤–∂–¥–∏ –º–æ–∂–µ—Ç–µ —ó—Ö –±—Ä—É—Ç—Ñ–æ—Ä—Å–∏—Ç–∏.

#### bf-aws-permissions

–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç [**bf-aws-permissions**](https://github.com/carlospolop/bf-aws-permissions) - —Ü–µ –ø—Ä–æ—Å—Ç–æ bash-—Å–∫—Ä–∏–ø—Ç, —è–∫–∏–π –±—É–¥–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –≤—Å—ñ **`list*`, `describe*`, `get*`** –¥—ñ—ó, —è–∫—ñ –≤—ñ–Ω –º–æ–∂–µ –∑–Ω–∞–π—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–æ–ø–æ–º–æ–≥–∏ `aws` cli, —ñ **–ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ —É—Å–ø—ñ—à–Ω—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è**.

{% code overflow="wrap" %}
```bash
# Bruteforce permissions
bash bf-aws-permissions.sh -p default > /tmp/bf-permissions-verbose.txt
```
{% endcode %}

#### bf-aws-perms-simulate

–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç [**bf-aws-perms-simulate**](https://github.com/carlospolop/bf-aws-perms-simulate) –º–æ–∂–µ –∑–Ω–∞–π—Ç–∏ –≤–∞—à—ñ –ø–æ—Ç–æ—á–Ω—ñ –¥–æ–∑–≤–æ–ª–∏ (–∞–±–æ –¥–æ–∑–≤–æ–ª–∏ —ñ–Ω—à–∏—Ö —Å—É–±'—î–∫—Ç—ñ–≤), —è–∫—â–æ —É –≤–∞—Å —î –¥–æ–∑–≤—ñ–ª **`iam:SimulatePrincipalPolicy`**
```bash
# Ask for permissions
python3 aws_permissions_checker.py --profile <AWS_PROFILE> [--arn <USER_ARN>]
```
#### Perms2ManagedPolicies

–Ø–∫—â–æ –≤–∏ –∑–Ω–∞–π—à–ª–∏ **–¥–µ—è–∫—ñ –¥–æ–∑–≤–æ–ª–∏, —è–∫—ñ –º–∞—î –≤–∞—à –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á**, —ñ –≤–≤–∞–∂–∞—î—Ç–µ, —â–æ –≤–æ–Ω–∏ –Ω–∞–¥–∞—é—Ç—å—Å—è **–∫–µ—Ä–æ–≤–∞–Ω–æ—é —Ä–æ–ª–ª—é AWS** (–∞ –Ω–µ –∫–∞—Å—Ç–æ–º–Ω–æ—é). –í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç [**aws-Perms2ManagedRoles**](https://github.com/carlospolop/aws-Perms2ManagedPolicies), —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—Å—ñ **–∫–µ—Ä–æ–≤–∞–Ω—ñ —Ä–æ–ª—ñ AWS, —è–∫—ñ –Ω–∞–¥–∞—é—Ç—å –¥–æ–∑–≤–æ–ª–∏, —è–∫—ñ –≤–∏ –≤–∏—è–≤–∏–ª–∏, —â–æ –º–∞—î—Ç–µ**.

{% code overflow="wrap" %}
```bash
# Run example with my profile
python3 aws-Perms2ManagedPolicies.py --profile myadmin --permissions-file example-permissions.txt
```
{% endcode %}

{% hint style="warning" %}
–ú–æ–∂–ª–∏–≤–æ "–∑–Ω–∞—Ç–∏", —á–∏ –Ω–∞–¥–∞–Ω—ñ –≤–∞–º –¥–æ–∑–≤–æ–ª–∏ —á–µ—Ä–µ–∑ –∫–µ—Ä–æ–≤–∞–Ω—É —Ä–æ–ª—å AWS, —è–∫—â–æ –≤–∏ –±–∞—á–∏—Ç–µ, —â–æ **—É –≤–∞—Å —î –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ —Å–µ—Ä–≤—ñ—Å–∏, —è–∫—ñ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è**, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥.
{% endhint %}

#### Cloudtrail2IAM

[**CloudTrail2IAM**](https://github.com/carlospolop/Cloudtrail2IAM) - —Ü–µ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞ Python, —è–∫–∏–π –∞–Ω–∞–ª—ñ–∑—É—î **–∂—É—Ä–Ω–∞–ª–∏ AWS CloudTrail –¥–ª—è –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è —Ç–∞ —É–∑–∞–≥–∞–ª—å–Ω–µ–Ω–Ω—è –¥—ñ–π**, –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö —É—Å—ñ–º–∞ –∞–±–æ –ª–∏—à–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º —á–∏ —Ä–æ–ª–ª—é. –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç **—Ä–æ–∑–±–∏—Ä–∞—î –∫–æ–∂–µ–Ω –∂—É—Ä–Ω–∞–ª cloudtrail –∑ –≤–∫–∞–∑–∞–Ω–æ–≥–æ –±–∞–∫–µ—Ç—É**.

{% code overflow="wrap" %}
```bash
git clone https://github.com/carlospolop/Cloudtrail2IAM
cd Cloudtrail2IAM
pip install -r requirements.txt
python3 cloudtrail2IAM.py --prefix PREFIX --bucket_name BUCKET_NAME --profile PROFILE [--filter-name FILTER_NAME] [--threads THREADS]
```
{% endcode %}

{% hint style="warning" %}
–Ø–∫—â–æ –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ .tfstate (—Ñ–∞–π–ª–∏ —Å—Ç–∞–Ω—É Terraform) –∞–±–æ —Ñ–∞–π–ª–∏ CloudFormation (—Ü–µ –∑–∞–∑–≤–∏—á–∞–π —Ñ–∞–π–ª–∏ yaml, —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω—ñ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –±–∞–∫–µ—Ç—É –∑ –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º cf-templates), –≤–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ —ó—Ö –ø—Ä–æ—á–∏—Ç–∞—Ç–∏, —â–æ–± –∑–Ω–∞–π—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é aws —ñ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —è–∫—ñ –¥–æ–∑–≤–æ–ª–∏ –±—É–ª–∏ –Ω–∞–¥–∞–Ω—ñ –∫–æ–º—É.
{% endhint %}

#### enumerate-iam

–©–æ–± –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç [**https://github.com/andresriancho/enumerate-iam**](https://github.com/andresriancho/enumerate-iam), —Å–ø–æ—á–∞—Ç–∫—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—ñ API AWS –∫—ñ–Ω—Ü–µ–≤—ñ —Ç–æ—á–∫–∏, –∑ —è–∫–∏—Ö —Å–∫—Ä–∏–ø—Ç **`generate_bruteforce_tests.py`** –æ—Ç—Ä–∏–º–∞—î –≤—Å—ñ **"list\_", "describe\_", —ñ "get\_" –∫—ñ–Ω—Ü–µ–≤—ñ —Ç–æ—á–∫–∏.** –Ü, –Ω–∞—Ä–µ—à—Ç—ñ, –≤—ñ–Ω —Å–ø—Ä–æ–±—É—î **–¥–æ—Å—Ç—É–ø–∏—Ç–∏—Å—è –¥–æ –Ω–∏—Ö** –∑ –Ω–∞–¥–∞–Ω–∏–º–∏ –æ–±–ª—ñ–∫–æ–≤–∏–º–∏ –¥–∞–Ω–∏–º–∏ —ñ **–≤–∫–∞–∑–∞—Ç–∏, —á–∏ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ**.

(–ù–∞ –º–æ—î–º—É –¥–æ—Å–≤—ñ–¥—ñ **—ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∑–∞–≤–∏—Å–∞—î –≤ –¥–µ—è–∫–∏–π –º–æ–º–µ–Ω—Ç**, [**–ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ —Ü–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è**](https://github.com/andresriancho/enumerate-iam/pull/15/commits/77ad5b41216e3b5f1511d0c385da8cd5984c2d3c), —â–æ–± —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —Ü–µ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏).

{% hint style="warning" %}
–ù–∞ –º–æ—î–º—É –¥–æ—Å–≤—ñ–¥—ñ —Ü–µ–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å—Ö–æ–∂–∏–π –Ω–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π, –∞–ª–µ –ø—Ä–∞—Ü—é—î –≥—ñ—Ä—à–µ —ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –º–µ–Ω—à–µ –¥–æ–∑–≤–æ–ª—ñ–≤.
{% endhint %}

{% code overflow="wrap" %}
```bash
# Install tool
git clone git@github.com:andresriancho/enumerate-iam.git
cd enumerate-iam/
pip install -r requirements.txt

# Download API endpoints
cd enumerate_iam/
git clone https://github.com/aws/aws-sdk-js.git
python3 generate_bruteforce_tests.py
rm -rf aws-sdk-js
cd ..

# Enumerate permissions
python3 enumerate-iam.py --access-key ACCESS_KEY --secret-key SECRET_KEY [--session-token SESSION_TOKEN] [--region REGION]
```
{% endcode %}

#### weirdAAL

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç [**weirdAAL**](https://github.com/carnal0wnage/weirdAAL/wiki). –¶–µ–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å **–¥–µ–∫—ñ–ª—å–∫–∞ –∑–∞–≥–∞–ª—å–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π –Ω–∞ –¥–µ–∫—ñ–ª—å–∫–æ—Ö –∑–∞–≥–∞–ª—å–Ω–∏—Ö —Å–µ—Ä–≤—ñ—Å–∞—Ö** (–ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å –¥–µ—è–∫—ñ –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞–Ω–Ω—è, –∞ —Ç–∞–∫–æ–∂ –¥–µ—è–∫—ñ –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤). –ê–ª–µ –≤—ñ–Ω –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å –ª–∏—à–µ –∑–∞–∫–æ–¥–æ–≤–∞–Ω—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (—î–¥–∏–Ω–∏–π —Å–ø–æ—Å—ñ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –±—ñ–ª—å—à–µ - —Ü–µ –Ω–∞–ø–∏—Å–∞—Ç–∏ –±—ñ–ª—å—à–µ —Ç–µ—Å—Ç—ñ–≤).
```bash
# Install
git clone https://github.com/carnal0wnage/weirdAAL.git
cd weirdAAL
python3 -m venv weirdAAL
source weirdAAL/bin/activate
pip3 install -r requirements.txt

# Create a .env file with aws credentials such as
[default]
aws_access_key_id = <insert key id>
aws_secret_access_key = <insert secret key>

# Setup DB
python3 create_dbs.py

# Invoke it
python3 weirdAAL.py -m ec2_describe_instances -t ec2test # Just some ec2 tests
python3 weirdAAL.py -m recon_all -t MyTarget # Check all permissions
# You will see output such as:
# [+] elbv2 Actions allowed are [+]
# ['DescribeLoadBalancers', 'DescribeAccountLimits', 'DescribeTargetGroups']
```
#### –£—Å–∫–ª–∞–¥–Ω–µ–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –¥–ª—è BF –¥–æ–∑–≤–æ–ª—ñ–≤

{% tabs %}
{% tab title="CloudSploit" %}
{% code overflow="wrap" %}
```bash
# Export env variables
./index.js --console=text --config ./config.js --json /tmp/out-cloudsploit.json

# Filter results removing unknown
jq 'map(select(.status | contains("UNKNOWN") | not))' /tmp/out-cloudsploit.json | jq 'map(select(.resource | contains("N/A") | not))' > /tmp/out-cloudsploit-filt.json

# Get services by regions
jq 'group_by(.region) | map({(.[0].region): ([map((.resource | split(":"))[2]) | unique])})' ~/Desktop/pentests/cere/greybox/core-dev-dev-cloudsploit-filtered.json
```
{% endcode %}
{% endtab %}

{% tab title="SteamPipe" %}
```bash
# https://github.com/turbot/steampipe-mod-aws-insights
steampipe check all --export=json

# https://github.com/turbot/steampipe-mod-aws-perimeter
# In this case you cannot output to JSON, so heck it in the dashboard
steampipe dashboard
```
{% endtab %}
{% endtabs %}

#### \<YourTool>

–ñ–æ–¥–µ–Ω –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –Ω–µ –∑–¥–∞—Ç–Ω–∏–π –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—Å—ñ –¥–æ–∑–≤–æ–ª–∏, —Ç–æ–º—É —è–∫—â–æ –≤–∏ –∑–Ω–∞—î—Ç–µ –∫—Ä–∞—â–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–∞–¥—ñ—à–ª—ñ—Ç—å PR!

### –ù–µ–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø

{% content-ref url="../aws-unauthenticated-enum-access/aws-iam-and-sts-unauthenticated-enum.md" %}
[aws-iam-and-sts-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-iam-and-sts-unauthenticated-enum.md)
{% endcontent-ref %}

### –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤

–ù–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —è–∫ **–∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ IAM –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤**:

{% content-ref url="../aws-privilege-escalation/aws-iam-privesc.md" %}
[aws-iam-privesc.md](../aws-privilege-escalation/aws-iam-privesc.md)
{% endcontent-ref %}

### IAM –ü—ñ—Å–ª—è –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó

{% content-ref url="../aws-post-exploitation/aws-iam-post-exploitation.md" %}
[aws-iam-post-exploitation.md](../aws-post-exploitation/aws-iam-post-exploitation.md)
{% endcontent-ref %}

### IAM –ü–æ—Å—Ç—ñ–π–Ω—ñ—Å—Ç—å

{% content-ref url="../aws-persistence/aws-iam-persistence.md" %}
[aws-iam-persistence.md](../aws-persistence/aws-iam-persistence.md)
{% endcontent-ref %}

## IAM –¶–µ–Ω—Ç—Ä —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ **–æ–ø–∏—Å IAM –¶–µ–Ω—Ç—Ä—É —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ** –≤:

{% content-ref url="../aws-basic-information/" %}
[aws-basic-information](../aws-basic-information/)
{% endcontent-ref %}

### –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —á–µ—Ä–µ–∑ SSO –∑ CLI
```bash
# Connect with sso via CLI aws configure sso
aws configure sso

[profile profile_name]
sso_start_url = https://subdomain.awsapps.com/start/
sso_account_id = <account_numbre>
sso_role_name = AdministratorAccess
sso_region = us-east-1
```
### Enumeration

–û—Å–Ω–æ–≤–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –¶–µ–Ω—Ç—Ä—É —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ:

* –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —Ç–∞ –≥—Ä—É–ø–∏
* –ù–∞–±–æ—Ä–∏ –¥–æ–∑–≤–æ–ª—ñ–≤: –ú–∞—é—Ç—å –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏
* –û–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ AWS

–ü–æ—Ç—ñ–º —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –≤—ñ–¥–Ω–æ—Å–∏–Ω–∏, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ/–≥—Ä—É–ø–∏ –º–∞–ª–∏ –ù–∞–±–æ—Ä–∏ –¥–æ–∑–≤–æ–ª—ñ–≤ –Ω–∞–¥ –û–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–æ–º AWS.

{% hint style="info" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ —î 3 —Å–ø–æ—Å–æ–±–∏ –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è –ø–æ–ª—ñ—Ç–∏–∫ –¥–æ –ù–∞–±–æ—Ä—É –¥–æ–∑–≤–æ–ª—ñ–≤. –ü—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è –∫–µ—Ä–æ–≤–∞–Ω–∏—Ö –ø–æ–ª—ñ—Ç–∏–∫ AWS, –ø–æ–ª—ñ—Ç–∏–∫, –∫–µ—Ä–æ–≤–∞–Ω–∏—Ö –∑–∞–º–æ–≤–Ω–∏–∫–æ–º (—Ü—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤ —É—Å—ñ—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å–∞—Ö, –Ω–∞ —è–∫—ñ –≤–ø–ª–∏–≤–∞—é—Ç—å –ù–∞–±–æ—Ä–∏ –¥–æ–∑–≤–æ–ª—ñ–≤), —Ç–∞ –≤–±—É–¥–æ–≤–∞–Ω–∏—Ö –ø–æ–ª—ñ—Ç–∏–∫ (–≤–∏–∑–Ω–∞—á–µ–Ω–∏—Ö —Ç–∞–º).
{% endhint %}
```bash
# Check if IAM Identity Center is used
aws sso-admin list-instances

# Get Permissions sets. These are the policies that can be assigned
aws sso-admin list-permission-sets --instance-arn <instance-arn>
aws sso-admin describe-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>

## Get managed policies of a permission set
aws sso-admin list-managed-policies-in-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get inline policies of a permission set
aws sso-admin get-inline-policy-for-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get customer managed policies of a permission set
aws sso-admin list-customer-managed-policy-references-in-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get boundaries of a permission set
aws sso-admin get-permissions-boundary-for-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>

## List accounts a permission set is affecting
aws sso-admin list-accounts-for-provisioned-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## List principals given a permission set in an account
aws sso-admin list-account-assignments --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --account-id <account_id>

# Get permissions sets affecting an account
aws sso-admin list-permission-sets-provisioned-to-account --instance-arn <instance-arn> --account-id <account_id>

# List users & groups from the identity store
aws identitystore list-users --identity-store-id <store-id>
aws identitystore list-groups --identity-store-id <store-id>
## Get members of groups
aws identitystore list-group-memberships --identity-store-id <store-id> --group-id <group-id>
## Get memberships or a user or a group
aws identitystore list-group-memberships-for-member --identity-store-id <store-id> --member-id <member-id>
```
### Local Enumeration

–ú–æ–∂–ª–∏–≤–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–∞–ø–∫–∏ `$HOME/.aws` —Ñ–∞–π–ª config –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—ñ–≤, —è–∫—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ —á–µ—Ä–µ–∑ SSO, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥:
```ini
[default]
region = us-west-2
output = json

[profile my-sso-profile]
sso_start_url = https://my-sso-portal.awsapps.com/start
sso_region = us-west-2
sso_account_id = 123456789012
sso_role_name = MySSORole
region = us-west-2
output = json

[profile dependent-profile]
role_arn = arn:aws:iam::<acc-id>:role/ReadOnlyRole
source_profile = Hacktricks-Admin
```
–¶—é –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∑ –∫–æ–º–∞–Ω–¥–∞–º–∏:
```bash
# Login in ms-sso-profile
aws sso login --profile my-sso-profile
# Use dependent-profile
aws s3 ls --profile dependent-profile
```
–ö–æ–ª–∏ **–ø—Ä–æ—Ñ—ñ–ª—å –∑ SSO –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è** –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –¥–µ—è–∫–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó, –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ **–∫–µ—à—É—é—Ç—å—Å—è** —É —Ñ–∞–π–ª—ñ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–∞–ø–∫–∏ **`$HOME/.aws/sso/cache`**. –¢–æ–º—É —ó—Ö –º–æ–∂–Ω–∞ **—á–∏—Ç–∞—Ç–∏ —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∑–≤—ñ–¥—Ç–∏**.

–ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, **–¥–æ–¥–∞—Ç–∫–æ–≤—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ** –º–æ–∂—É—Ç—å –∑–±–µ—Ä—ñ–≥–∞—Ç–∏—Å—è –≤ –ø–∞–ø—Ü—ñ **`$HOME/.aws/cli/cache`**. –¶—è –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è –∫–µ—à—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, –∫–æ–ª–∏ –≤–∏ **–ø—Ä–∞—Ü—é—î—Ç–µ –∑ –ø—Ä–æ—Ñ—ñ–ª—è–º–∏ AWS CLI**, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ IAM –∞–±–æ **–ø—Ä–∏–ø—É—Å–∫–∞—é—Ç—å** —Ä–æ–ª—ñ —á–µ—Ä–µ–∑ IAM (–±–µ–∑ SSO). –ü—Ä–∏–∫–ª–∞–¥ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó:
```ini
[profile crossaccountrole]
role_arn = arn:aws:iam::234567890123:role/SomeRole
source_profile = default
mfa_serial = arn:aws:iam::123456789012:mfa/saanvi
external_id = 123456
```
### –ù–µ–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø

{% content-ref url="../aws-unauthenticated-enum-access/aws-identity-center-and-sso-unauthenticated-enum.md" %}
[aws-identity-center-and-sso-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-identity-center-and-sso-unauthenticated-enum.md)
{% endcontent-ref %}

### –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤

{% content-ref url="../aws-privilege-escalation/aws-sso-and-identitystore-privesc.md" %}
[aws-sso-and-identitystore-privesc.md](../aws-privilege-escalation/aws-sso-and-identitystore-privesc.md)
{% endcontent-ref %}

### –ü—ñ—Å–ª—è –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó

{% content-ref url="../aws-post-exploitation/aws-sso-and-identitystore-post-exploitation.md" %}
[aws-sso-and-identitystore-post-exploitation.md](../aws-post-exploitation/aws-sso-and-identitystore-post-exploitation.md)
{% endcontent-ref %}

### –ü–æ—Å—Ç—ñ–π–Ω—ñ—Å—Ç—å

#### –°—Ç–≤–æ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –ø—Ä–∏–∑–Ω–∞—á—Ç–µ –π–æ–º—É –¥–æ–∑–≤–æ–ª–∏

{% code overflow="wrap" %}
```bash
# Create user identitystore:CreateUser
aws identitystore create-user --identity-store-id <store-id> --user-name privesc --display-name privesc --emails Value=sdkabflvwsljyclpma@tmmbt.net,Type=Work,Primary=True --name Formatted=privesc,FamilyName=privesc,GivenName=privesc
## After creating it try to login in the console using the selected username, you will receive an email with the code and then you will be able to select a password
```
{% endcode %}

* –°—Ç–≤–æ—Ä—ñ—Ç—å –≥—Ä—É–ø—É, –ø—Ä–∏–∑–Ω–∞—á—Ç–µ —ó–π –¥–æ–∑–≤–æ–ª–∏ —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
* –ù–∞–¥–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–æ–∑–≤–æ–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –∞–±–æ –≥—Ä—É–ø—ñ
* –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ª–∏—à–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ –∑ –û–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–º–æ–∂—É—Ç—å –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø —ñ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ IAM Identity Center.

–û–¥–Ω–∞–∫, –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –î–µ–ª–µ–≥–æ–≤–∞–Ω–æ–≥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –º–æ–∂–Ω–∞ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ —ñ–Ω—à–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∫–µ—Ä—É–≤–∞—Ç–∏ –Ω–∏–º. –í–æ–Ω–∏ –Ω–µ –º–∞—Ç–∏–º—É—Ç—å —Ç–æ—á–Ω–æ —Ç–∞–∫–∏—Ö –∂–µ –¥–æ–∑–≤–æ–ª—ñ–≤, –∞–ª–µ –∑–º–æ–∂—É—Ç—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ [**—É–ø—Ä–∞–≤–ª—ñ–Ω—Å—å–∫—ñ –¥—ñ—ó**](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html).

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
