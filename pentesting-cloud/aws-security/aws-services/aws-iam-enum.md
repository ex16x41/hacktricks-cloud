# AWS - IAM, Identity Center & SSO Enum

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## IAM

Mo偶esz znale藕 **opis IAM** w:

{% content-ref url="../aws-basic-information/" %}
[aws-basic-information](../aws-basic-information/)
{% endcontent-ref %}

### Enumeracja

G贸wne wymagane uprawnienia:

* `iam:ListPolicies`, `iam:GetPolicy` i `iam:GetPolicyVersion`
* `iam:ListRoles`
* `iam:ListUsers`
* `iam:ListGroups`
* `iam:ListGroupsForUser`
* `iam:ListAttachedUserPolicies`
* `iam:ListAttachedRolePolicies`
* `iam:ListAttachedGroupPolicies`
* `iam:ListUserPolicies` i `iam:GetUserPolicy`
* `iam:ListGroupPolicies` i `iam:GetGroupPolicy`
* `iam:ListRolePolicies` i `iam:GetRolePolicy`
```bash
# All IAMs
## Retrieves  information about all IAM users, groups, roles, and policies
## in your Amazon Web Services account, including their relationships  to
## one another. Use this operation to obtain a snapshot of the configura-
## tion of IAM permissions (users, groups, roles, and  policies)  in  your
## account.
aws iam get-account-authorization-details

# List users
aws iam get-user #Get current user information
aws iam list-users
aws iam list-ssh-public-keys #User keys for CodeCommit
aws iam get-ssh-public-key --user-name <username> --ssh-public-key-id <id> --encoding SSH #Get public key with metadata
aws iam list-service-specific-credentials #Get special permissions of the IAM user over specific services
aws iam get-user --user-name <username> #Get metadata of user, included permissions boundaries
aws iam list-access-keys #List created access keys
## inline policies
aws iam list-user-policies --user-name <username> #Get inline policies of the user
aws iam get-user-policy --user-name <username> --policy-name <policyname> #Get inline policy details
## attached policies
aws iam list-attached-user-policies --user-name <username> #Get policies of user, it doesn't get inline policies

# List groups
aws iam list-groups #Get groups
aws iam list-groups-for-user --user-name <username> #Get groups of a user
aws iam get-group --group-name <name> #Get group name info
## inline policies
aws iam list-group-policies --group-name <username> #Get inline policies of the group
aws iam get-group-policy --group-name <username> --policy-name <policyname> #Get an inline policy info
## attached policies
aws iam list-attached-group-policies --group-name <name> #Get policies of group, it doesn't get inline policies

# List roles
aws iam list-roles #Get roles
aws iam get-role --role-name <role-name> #Get role
## inline policies
aws iam list-role-policies --role-name <name> #Get inline policies of a role
aws iam get-role-policy --role-name <name> --policy-name <name> #Get inline policy details
## attached policies
aws iam list-attached-role-policies --role-name <role-name> #Get policies of role, it doesn't get inline policies

# List policies
aws iam list-policies [--only-attached] [--scope Local]
aws iam list-policies-granting-service-access --arn <identity> --service-namespaces <svc> # Get list of policies that give access to the user to the service
## Get policy content
aws iam get-policy --policy-arn <policy_arn>
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn:aws:iam::975426262029:policy/list_apigateways> --version-id <VERSION_X>

# Enumerate providers
aws iam list-saml-providers
aws iam get-saml-provider --saml-provider-arn <ARN>
aws iam list-open-id-connect-providers
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>

# Password Policy
aws iam get-account-password-policy

# MFA
aws iam list-mfa-devices
aws iam list-virtual-mfa-devices
```
### Bruteforce uprawnie

Jeli jeste zainteresowany swoimi uprawnieniami, ale nie masz dostpu do zapyta IAM, zawsze mo偶esz je brutalnie wymusi.

#### bf-aws-permissions

Narzdzie [**bf-aws-permissions**](https://github.com/carlospolop/bf-aws-permissions) to po prostu skrypt bash, kt贸ry uruchomi wszystkie akcje **`list*`, `describe*`, `get*`**, kt贸re mo偶e znale藕, korzystajc z komunikat贸w pomocy `aws` cli i **zwr贸ci udane wykonania**.

{% code overflow="wrap" %}
```bash
# Bruteforce permissions
bash bf-aws-permissions.sh -p default > /tmp/bf-permissions-verbose.txt
```
{% endcode %}

#### bf-aws-perms-simulate

Narzdzie [**bf-aws-perms-simulate**](https://github.com/carlospolop/bf-aws-perms-simulate) mo偶e znale藕 twoje obecne uprawnienia (lub uprawnienia innych podmiot贸w), jeli masz uprawnienie **`iam:SimulatePrincipalPolicy`**
```bash
# Ask for permissions
python3 aws_permissions_checker.py --profile <AWS_PROFILE> [--arn <USER_ARN>]
```
#### Perms2ManagedPolicies

Jeli znalaze **jakie uprawnienia, kt贸re ma tw贸j u偶ytkownik**, i mylisz, 偶e s one przyznawane przez **zarzdzan rol AWS** (a nie przez niestandardow). Mo偶esz u偶y narzdzia [**aws-Perms2ManagedRoles**](https://github.com/carlospolop/aws-Perms2ManagedPolicies), aby sprawdzi wszystkie **zarzdzane role AWS, kt贸re przyznaj uprawnienia, kt贸re odkrye, 偶e posiadasz**.

{% code overflow="wrap" %}
```bash
# Run example with my profile
python3 aws-Perms2ManagedPolicies.py --profile myadmin --permissions-file example-permissions.txt
```
{% endcode %}

{% hint style="warning" %}
Mo偶liwe jest "wiedzie", czy uprawnienia, kt贸re posiadasz, s przyznawane przez zarzdzan rol AWS, jeli zauwa偶ysz, 偶e **masz uprawnienia do usug, kt贸re nie s u偶ywane** na przykad.
{% endhint %}

#### Cloudtrail2IAM

[**CloudTrail2IAM**](https://github.com/carlospolop/Cloudtrail2IAM) to narzdzie w Pythonie, kt贸re analizuje **logi AWS CloudTrail, aby wydoby i podsumowa dziaania** wykonane przez wszystkich lub tylko przez konkretnego u偶ytkownika lub rol. Narzdzie **przeanalizuje ka偶dy log cloudtrail z wskazanego koszyka**.

{% code overflow="wrap" %}
```bash
git clone https://github.com/carlospolop/Cloudtrail2IAM
cd Cloudtrail2IAM
pip install -r requirements.txt
python3 cloudtrail2IAM.py --prefix PREFIX --bucket_name BUCKET_NAME --profile PROFILE [--filter-name FILTER_NAME] [--threads THREADS]
```
{% endcode %}

{% hint style="warning" %}
Jeli znajdziesz pliki .tfstate (pliki stanu Terraform) lub pliki CloudFormation (zwykle s to pliki yaml znajdujce si w wiadrze z prefiksem cf-templates), mo偶esz je r贸wnie偶 przeczyta, aby znale藕 konfiguracj aws i dowiedzie si, kt贸re uprawnienia zostay przypisane do kogo.
{% endhint %}

#### enumerate-iam

Aby u偶y narzdzia [**https://github.com/andresriancho/enumerate-iam**](https://github.com/andresriancho/enumerate-iam), najpierw musisz pobra wszystkie punkty kocowe API AWS, z kt贸rych skrypt **`generate_bruteforce_tests.py`** pobierze wszystkie **punkty kocowe "list\_", "describe\_" i "get\_"**. A na koniec spr贸buje **uzyska do nich dostp** za pomoc podanych powiadcze i **wska偶e, czy to zadziaao**.

(Z mojego dowiadczenia **narzdzie zawiesza si w pewnym momencie**, [**sprawd藕 to rozwizanie**](https://github.com/andresriancho/enumerate-iam/pull/15/commits/77ad5b41216e3b5f1511d0c385da8cd5984c2d3c), aby spr贸bowa to naprawi).

{% hint style="warning" %}
Z mojego dowiadczenia to narzdzie jest jak poprzednie, ale dziaa gorzej i sprawdza mniej uprawnie.
{% endhint %}

{% code overflow="wrap" %}
```bash
# Install tool
git clone git@github.com:andresriancho/enumerate-iam.git
cd enumerate-iam/
pip install -r requirements.txt

# Download API endpoints
cd enumerate_iam/
git clone https://github.com/aws/aws-sdk-js.git
python3 generate_bruteforce_tests.py
rm -rf aws-sdk-js
cd ..

# Enumerate permissions
python3 enumerate-iam.py --access-key ACCESS_KEY --secret-key SECRET_KEY [--session-token SESSION_TOKEN] [--region REGION]
```
{% endcode %}

#### weirdAAL

Mo偶esz r贸wnie偶 u偶y narzdzia [**weirdAAL**](https://github.com/carnal0wnage/weirdAAL/wiki). To narzdzie sprawdzi **kilka powszechnych operacji na kilku powszechnych usugach** (sprawdzi niekt贸re uprawnienia do enumeracji oraz niekt贸re uprawnienia do podwy偶szenia uprawnie). Ale sprawdzi tylko zakodowane kontrole (jedynym sposobem na sprawdzenie wikszej liczby rzeczy jest zakodowanie wikszej liczby test贸w).
```bash
# Install
git clone https://github.com/carnal0wnage/weirdAAL.git
cd weirdAAL
python3 -m venv weirdAAL
source weirdAAL/bin/activate
pip3 install -r requirements.txt

# Create a .env file with aws credentials such as
[default]
aws_access_key_id = <insert key id>
aws_secret_access_key = <insert secret key>

# Setup DB
python3 create_dbs.py

# Invoke it
python3 weirdAAL.py -m ec2_describe_instances -t ec2test # Just some ec2 tests
python3 weirdAAL.py -m recon_all -t MyTarget # Check all permissions
# You will see output such as:
# [+] elbv2 Actions allowed are [+]
# ['DescribeLoadBalancers', 'DescribeAccountLimits', 'DescribeTargetGroups']
```
#### Narzdzia do wzmacniania uprawnie BF

{% tabs %}
{% tab title="CloudSploit" %}
{% code overflow="wrap" %}
```bash
# Export env variables
./index.js --console=text --config ./config.js --json /tmp/out-cloudsploit.json

# Filter results removing unknown
jq 'map(select(.status | contains("UNKNOWN") | not))' /tmp/out-cloudsploit.json | jq 'map(select(.resource | contains("N/A") | not))' > /tmp/out-cloudsploit-filt.json

# Get services by regions
jq 'group_by(.region) | map({(.[0].region): ([map((.resource | split(":"))[2]) | unique])})' ~/Desktop/pentests/cere/greybox/core-dev-dev-cloudsploit-filtered.json
```
{% endcode %}
{% endtab %}

{% tab title="SteamPipe" %}
```bash
# https://github.com/turbot/steampipe-mod-aws-insights
steampipe check all --export=json

# https://github.com/turbot/steampipe-mod-aws-perimeter
# In this case you cannot output to JSON, so heck it in the dashboard
steampipe dashboard
```
{% endtab %}
{% endtabs %}

#### \<YourTool>

呕adne z poprzednich narzdzi nie jest w stanie sprawdzi prawie wszystkich uprawnie, wic jeli znasz lepsze narzdzie, wylij PR!

### Nieautoryzowany dostp

{% content-ref url="../aws-unauthenticated-enum-access/aws-iam-and-sts-unauthenticated-enum.md" %}
[aws-iam-and-sts-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-iam-and-sts-unauthenticated-enum.md)
{% endcontent-ref %}

### Eskalacja uprawnie

Na nastpnej stronie mo偶esz sprawdzi, jak **wykorzysta uprawnienia IAM do eskalacji uprawnie**:

{% content-ref url="../aws-privilege-escalation/aws-iam-privesc.md" %}
[aws-iam-privesc.md](../aws-privilege-escalation/aws-iam-privesc.md)
{% endcontent-ref %}

### IAM Po eksploatacji

{% content-ref url="../aws-post-exploitation/aws-iam-post-exploitation.md" %}
[aws-iam-post-exploitation.md](../aws-post-exploitation/aws-iam-post-exploitation.md)
{% endcontent-ref %}

### IAM Utrzymywanie

{% content-ref url="../aws-persistence/aws-iam-persistence.md" %}
[aws-iam-persistence.md](../aws-persistence/aws-iam-persistence.md)
{% endcontent-ref %}

## Centrum to偶samoci IAM

Mo偶esz znale藕 **opis Centrum to偶samoci IAM** w:

{% content-ref url="../aws-basic-information/" %}
[aws-basic-information](../aws-basic-information/)
{% endcontent-ref %}

### Poczenie przez SSO z CLI
```bash
# Connect with sso via CLI aws configure sso
aws configure sso

[profile profile_name]
sso_start_url = https://subdomain.awsapps.com/start/
sso_account_id = <account_numbre>
sso_role_name = AdministratorAccess
sso_region = us-east-1
```
### Enumeracja

G贸wne elementy Identity Center to:

* U偶ytkownicy i grupy
* Zestawy uprawnie: Maj przypisane polityki
* Konta AWS

Nastpnie tworzone s relacje, aby u偶ytkownicy/grupy miay Zestawy uprawnie w ramach Konta AWS.

{% hint style="info" %}
Zauwa偶, 偶e istniej 3 sposoby przypisania polityk do Zestawu uprawnie. Przypisanie polityk zarzdzanych przez AWS, polityk zarzdzanych przez klienta (te polityki musz by tworzone we wszystkich kontach, na kt贸re wpywa Zestaw uprawnie) oraz polityk inline (zdefiniowanych tam).
{% endhint %}
```bash
# Check if IAM Identity Center is used
aws sso-admin list-instances

# Get Permissions sets. These are the policies that can be assigned
aws sso-admin list-permission-sets --instance-arn <instance-arn>
aws sso-admin describe-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>

## Get managed policies of a permission set
aws sso-admin list-managed-policies-in-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get inline policies of a permission set
aws sso-admin get-inline-policy-for-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get customer managed policies of a permission set
aws sso-admin list-customer-managed-policy-references-in-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get boundaries of a permission set
aws sso-admin get-permissions-boundary-for-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>

## List accounts a permission set is affecting
aws sso-admin list-accounts-for-provisioned-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## List principals given a permission set in an account
aws sso-admin list-account-assignments --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --account-id <account_id>

# Get permissions sets affecting an account
aws sso-admin list-permission-sets-provisioned-to-account --instance-arn <instance-arn> --account-id <account_id>

# List users & groups from the identity store
aws identitystore list-users --identity-store-id <store-id>
aws identitystore list-groups --identity-store-id <store-id>
## Get members of groups
aws identitystore list-group-memberships --identity-store-id <store-id> --group-id <group-id>
## Get memberships or a user or a group
aws identitystore list-group-memberships-for-member --identity-store-id <store-id> --member-id <member-id>
```
### Local Enumeration

Mo偶liwe jest utworzenie wewntrz folderu `$HOME/.aws` pliku config, aby skonfigurowa profile, kt贸re s dostpne za pomoc SSO, na przykad:
```ini
[default]
region = us-west-2
output = json

[profile my-sso-profile]
sso_start_url = https://my-sso-portal.awsapps.com/start
sso_region = us-west-2
sso_account_id = 123456789012
sso_role_name = MySSORole
region = us-west-2
output = json

[profile dependent-profile]
role_arn = arn:aws:iam::<acc-id>:role/ReadOnlyRole
source_profile = Hacktricks-Admin
```
Ta konfiguracja mo偶e by u偶ywana z poleceniami:
```bash
# Login in ms-sso-profile
aws sso login --profile my-sso-profile
# Use dependent-profile
aws s3 ls --profile dependent-profile
```
Kiedy **profil z SSO jest u偶ywany** do uzyskania dostpu do informacji, dane uwierzytelniajce s **buforowane** w pliku wewntrz folderu **`$HOME/.aws/sso/cache`**. Dlatego mog by **odczytywane i u偶ywane stamtd**.

Ponadto, **wicej danych uwierzytelniajcych** mo偶e by przechowywanych w folderze **`$HOME/.aws/cli/cache`**. Ten katalog buforu jest g贸wnie u偶ywany, gdy **pracujesz z profilami AWS CLI**, kt贸re u偶ywaj danych uwierzytelniajcych u偶ytkownika IAM lub **przyjmuj** role przez IAM (bez SSO). Przykad konfiguracji:
```ini
[profile crossaccountrole]
role_arn = arn:aws:iam::234567890123:role/SomeRole
source_profile = default
mfa_serial = arn:aws:iam::123456789012:mfa/saanvi
external_id = 123456
```
### Nieautoryzowany dostp

{% content-ref url="../aws-unauthenticated-enum-access/aws-identity-center-and-sso-unauthenticated-enum.md" %}
[aws-identity-center-and-sso-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-identity-center-and-sso-unauthenticated-enum.md)
{% endcontent-ref %}

### Eskalacja uprawnie

{% content-ref url="../aws-privilege-escalation/aws-sso-and-identitystore-privesc.md" %}
[aws-sso-and-identitystore-privesc.md](../aws-privilege-escalation/aws-sso-and-identitystore-privesc.md)
{% endcontent-ref %}

### Po wykorzystaniu

{% content-ref url="../aws-post-exploitation/aws-sso-and-identitystore-post-exploitation.md" %}
[aws-sso-and-identitystore-post-exploitation.md](../aws-post-exploitation/aws-sso-and-identitystore-post-exploitation.md)
{% endcontent-ref %}

### Utrzymywanie dostpu

#### Utw贸rz u偶ytkownika i przypisz mu uprawnienia

{% code overflow="wrap" %}
```bash
# Create user identitystore:CreateUser
aws identitystore create-user --identity-store-id <store-id> --user-name privesc --display-name privesc --emails Value=sdkabflvwsljyclpma@tmmbt.net,Type=Work,Primary=True --name Formatted=privesc,FamilyName=privesc,GivenName=privesc
## After creating it try to login in the console using the selected username, you will receive an email with the code and then you will be able to select a password
```
{% endcode %}

* Utw贸rz grup, przypisz jej uprawnienia i ustaw na niej kontrolowanego u偶ytkownika
* Daj dodatkowe uprawnienia kontrolowanemu u偶ytkownikowi lub grupie
*   Domylnie tylko u偶ytkownicy z uprawnieniami z Konta Zarzdzajcego bd mogli uzyska dostp i kontrolowa IAM Identity Center.

Jednak mo偶liwe jest, aby za pomoc Delegowanego Administratora zezwoli u偶ytkownikom z innego konta na zarzdzanie nim. Nie bd mieli dokadnie tych samych uprawnie, ale bd mogli wykonywa [**dziaania zarzdzajce**](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html).

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
