# AWS - Redshift Enum

{% hint style="success" %}
Ucz si i praktykuj Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i praktykuj Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Amazon Redshift

Redshift to w peni zarzdzana usuga, kt贸ra mo偶e skalowa si do ponad petabajta, kt贸ra jest u偶ywana jako **magazyn danych dla rozwiza big data**. Korzystajc z klastr贸w Redshift, mo偶esz przeprowadza analizy na swoich zbiorach danych za pomoc szybkich narzdzi zapyta opartych na SQL i aplikacji do inteligencji biznesowej, aby zdoby wiksze zrozumienie wizji dla swojego biznesu.

**Redshift oferuje szyfrowanie w spoczynku za pomoc czterostopniowej hierarchii kluczy szyfrowania za pomoc KMS lub CloudHSM do zarzdzania najwy偶szym poziomem kluczy**. **Gdy szyfrowanie jest wczone dla klastra, nie mo偶na go wyczy, i odwrotnie**. Gdy masz niezaszyfrowany klaster, nie mo偶na go zaszyfrowa.

Szyfrowanie klastra mo偶e nastpi tylko podczas jego tworzenia, a po zaszyfrowaniu dane, metadane i wszelkie migawki s r贸wnie偶 szyfrowane. Poziomy hierarchii kluczy szyfrowania s nastpujce, **poziom jeden to klucz g贸wny, poziom dwa to klucz szyfrowania klastra, CEK, poziom trzy to klucz szyfrowania bazy danych, DEK, a na kocu poziom cztery to same klucze szyfrowania danych**.

### KMS

Podczas tworzenia klastra mo偶esz wybra albo **domylny klucz KMS** dla Redshift, albo wybra **wasny CMK**, co daje wiksz elastyczno w kontroli klucza, szczeg贸lnie z perspektywy audytowej.

Domylny klucz KMS dla Redshift jest automatycznie tworzony przez Redshift za pierwszym razem, gdy opcja klucza jest wybierana i u偶ywana, i jest w peni zarzdzany przez AWS.

Ten klucz KMS jest nastpnie szyfrowany kluczem g贸wnym CMK, poziom jeden. Ten zaszyfrowany klucz danych KMS jest nastpnie u偶ywany jako klucz szyfrowania klastra, CEK, poziom dwa. Ten CEK jest nastpnie wysyany przez KMS do Redshift, gdzie jest przechowywany oddzielnie od klastra. Redshift nastpnie wysya ten zaszyfrowany CEK do klastra przez bezpieczny kana, gdzie jest przechowywany w pamici.

Redshift nastpnie prosi KMS o odszyfrowanie CEK, poziom dwa. Ten odszyfrowany CEK jest r贸wnie偶 przechowywany w pamici. Redshift nastpnie tworzy losowy klucz szyfrowania bazy danych, DEK, poziom trzy, i wczytuje go do pamici klastra. Odszyfrowany CEK w pamici szyfruje DEK, kt贸ry r贸wnie偶 jest przechowywany w pamici.

Ten zaszyfrowany DEK jest nastpnie wysyany przez bezpieczny kana i przechowywany w Redshift oddzielnie od klastra. Zar贸wno CEK, jak i DEK s teraz przechowywane w pamici klastra zar贸wno w formie zaszyfrowanej, jak i odszyfrowanej. Odszyfrowany DEK jest nastpnie u偶ywany do szyfrowania kluczy danych, poziom cztery, kt贸re s losowo generowane przez Redshift dla ka偶dego bloku danych w bazie danych.

Mo偶esz u偶y AWS Trusted Advisor do monitorowania konfiguracji swoich kubek贸w Amazon S3 i upewnienia si, 偶e logowanie kubeka jest wczone, co mo偶e by przydatne do przeprowadzania audyt贸w bezpieczestwa i ledzenia wzorc贸w u偶ytkowania w S3.

### CloudHSM

<details>

<summary>Korzystanie z Redshift z CloudHSM</summary>

Pracujc z CloudHSM w celu przeprowadzenia szyfrowania, najpierw musisz ustanowi zaufane poczenie midzy klientem HSM a Redshift, korzystajc z certyfikat贸w klienta i serwera.

To poczenie jest wymagane do zapewnienia bezpiecznej komunikacji, umo偶liwiajc przesyanie kluczy szyfrowania midzy klientem HSM a klastrami Redshift. Korzystajc z losowo generowanej pary kluczy prywatnego i publicznego, Redshift tworzy publiczny certyfikat klienta, kt贸ry jest szyfrowany i przechowywany przez Redshift. Nale偶y go pobra i zarejestrowa w kliencie HSM oraz przypisa do odpowiedniej partycji HSM.

Nastpnie nale偶y skonfigurowa Redshift z nastpujcymi szczeg贸ami klienta HSM: adres IP HSM, nazw partycji HSM, haso partycji HSM oraz publiczny certyfikat serwera HSM, kt贸ry jest szyfrowany przez CloudHSM za pomoc wewntrznego klucza g贸wnego. Po dostarczeniu tych informacji Redshift potwierdzi i zweryfikuje, 偶e mo偶e nawiza poczenie i uzyska dostp do partycji deweloperskiej.

Jeli twoje wewntrzne polityki bezpieczestwa lub kontrole zarzdzania wymagaj, aby zastosowa rotacj kluczy, to jest to mo偶liwe z Redshift, umo偶liwiajc ci rotacj kluczy szyfrowania dla zaszyfrowanych klastr贸w, jednak musisz by wiadomy, 偶e podczas procesu rotacji klucza, klaster stanie si niedostpny przez bardzo kr贸tki okres czasu, dlatego najlepiej rotowa klucze tylko wtedy, gdy jest to konieczne, lub jeli uwa偶asz, 偶e mogy zosta skompromitowane.

Podczas rotacji Redshift bdzie rotowa CEK dla twojego klastra i dla wszelkich kopii zapasowych tego klastra. Zostanie obr贸cony DEK dla klastra, ale nie jest mo偶liwe obr贸cenie DEK dla migawek przechowywanych w S3, kt贸re zostay zaszyfrowane za pomoc DEK. Klastra zostanie umieszczony w stanie "rotating keys" do momentu zakoczenia procesu, kiedy status powr贸ci do "available".

</details>

### Wyliczanie
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Eskalacja uprawnie

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Utrzymanie dostpu

Nastpujce dziaania pozwalaj na udzielenie dostpu do innego konta AWS do klastra:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
