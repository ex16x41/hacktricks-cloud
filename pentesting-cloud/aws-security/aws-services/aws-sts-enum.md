# AWS - STS Enum

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

## STS

**AWS Security Token Service (STS)** esasen **geçici, sınırlı ayrıcalıklara sahip kimlik bilgileri** vermek için tasarlanmıştır. Bu kimlik bilgileri, **AWS Identity and Access Management (IAM)** kullanıcıları veya kimliği doğrulanmış kullanıcılar (federated users) için talep edilebilir.

STS'nin amacı **kimlik taklidi için kimlik bilgileri vermek** olduğundan, bu hizmet **ayrıcalıkları artırmak ve sürekliliği sağlamak** için son derece değerlidir, ancak geniş bir seçenek yelpazesine sahip olmayabilir.

### Rolü Üstlenme Taklidi

AWS STS tarafından sağlanan [AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRole.html) eylemi, bir ilkenin başka bir ilke için kimlik bilgilerini edinmesine izin verdiği için kritik öneme sahiptir; bu, esasen onları taklit etmektir. Çağrıldığında, belirtilen ARN ile ilişkili bir erişim anahtar kimliği, bir gizli anahtar ve bir oturum belirteci ile yanıt verir.

Penetrasyon Testi yapanlar veya Kırmızı Takım üyeleri için bu teknik, ayrıcalık artırma için önemlidir (detaylar [**burada**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole) açıklanmıştır). Ancak, bu tekniğin oldukça belirgin olduğunu ve bir saldırganı hazırlıksız yakalayamayabileceğini belirtmek gerekir.

#### Rolü Üstlenme Mantığı

Aynı hesapta bir rolü üstlenmek için, **üstlenilecek rolun belirli bir rol ARN'sine izin vermesi** durumunda:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
Rol **`priv-role`** bu durumda, **o rolü üstlenmek için özel olarak izin verilmesine gerek yoktur** (bu izin yeterlidir).

Ancak, bir rolun bir hesabın onu üstlenmesine izin vermesi durumunda, şöyle:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
Rolü üstlenmeye çalışan, o rol üzerinde **belirli bir `sts:AssumeRole` iznine** ihtiyaç duyacaktır **onu üstlenmek için**.

Eğer **farklı bir hesap** üzerinden bir **rol** üstlenmeye çalışırsanız, **üstlenilen rol buna izin vermelidir** (rolün **ARN**'sini veya **harici hesabı** belirterek) ve **diğerini üstlenmeye çalışan rolün** **onu üstlenmek için izinlere sahip olması GEREKİR** (bu durumda, üstlenilen rol bir ARN belirtiyor olsa bile bu isteğe bağlı değildir).

### Enumeration
```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```
### Privesc

Aşağıdaki sayfada **STS izinlerini kötüye kullanarak ayrıcalıkları artırma** yöntemini kontrol edebilirsiniz:

{% content-ref url="../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-sts-post-exploitation.md" %}
[aws-sts-post-exploitation.md](../aws-post-exploitation/aws-sts-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-sts-persistence.md" %}
[aws-sts-persistence.md](../aws-persistence/aws-sts-persistence.md)
{% endcontent-ref %}

## References

* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
