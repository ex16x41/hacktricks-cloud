# AWS - STS Enum

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## STS

**AWS å®‰å…¨ä»¤ç‰ŒæœåŠ¡ (STS)** ä¸»è¦ç”¨äºå‘æ”¾ **ä¸´æ—¶ã€æœ‰é™æƒé™çš„å‡­è¯**ã€‚è¿™äº›å‡­è¯å¯ä»¥ä¸º **AWS èº«ä»½ä¸è®¿é—®ç®¡ç† (IAM)** ç”¨æˆ·æˆ–ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ï¼ˆè”åˆç”¨æˆ·ï¼‰è¯·æ±‚ã€‚

é‰´äº STS çš„ç›®çš„æ˜¯ **å‘æ”¾èº«ä»½å†’å……çš„å‡­è¯**ï¼Œè¯¥æœåŠ¡å¯¹äº **æå‡æƒé™å’Œç»´æŒæŒä¹…æ€§** æä¸ºé‡è¦ï¼Œå°½ç®¡å®ƒå¯èƒ½æ²¡æœ‰å¹¿æ³›çš„é€‰é¡¹ã€‚

### å‡è®¾è§’è‰²å†’å……

AWS STS æä¾›çš„ [AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRole.html) æ“ä½œè‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒå…è®¸ä¸€ä¸ªä¸»ä½“è·å–å¦ä¸€ä¸ªä¸»ä½“çš„å‡­è¯ï¼Œå®è´¨ä¸Šæ˜¯å†’å……ä»–ä»¬ã€‚è°ƒç”¨æ—¶ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªè®¿é—®å¯†é’¥ IDã€ä¸€ä¸ªç§˜å¯†å¯†é’¥å’Œä¸€ä¸ªä¸æŒ‡å®š ARN å¯¹åº”çš„ä¼šè¯ä»¤ç‰Œã€‚

å¯¹äºæ¸—é€æµ‹è¯•è€…æˆ–çº¢é˜Ÿæˆå‘˜æ¥è¯´ï¼Œè¿™ç§æŠ€æœ¯å¯¹äºæƒé™æå‡è‡³å…³é‡è¦ï¼ˆå¦‚ [**è¿™é‡Œ**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole) æ‰€è¿°ï¼‰ã€‚ç„¶è€Œï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æŠ€æœ¯ç›¸å½“æ˜¾çœ¼ï¼Œå¯èƒ½ä¸ä¼šè®©æ”»å‡»è€…æ„Ÿåˆ°æ„å¤–ã€‚

#### å‡è®¾è§’è‰²é€»è¾‘

ä¸ºäº†åœ¨åŒä¸€è´¦æˆ·ä¸­å‡è®¾è§’è‰²ï¼Œå¦‚æœ **è¦å‡è®¾çš„è§’è‰²ç‰¹åˆ«å…è®¸ä¸€ä¸ªè§’è‰² ARN**ï¼Œå¦‚ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
è§’è‰² **`priv-role`** åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**ä¸éœ€è¦ç‰¹åˆ«å…è®¸** å‡è®¾è¯¥è§’è‰²ï¼ˆåªè¦æœ‰è¯¥å…è®¸å°±è¶³å¤Ÿäº†ï¼‰ã€‚

ç„¶è€Œï¼Œå¦‚æœä¸€ä¸ªè§’è‰²å…è®¸ä¸€ä¸ªè´¦æˆ·å‡è®¾å®ƒï¼Œå°±åƒåœ¨ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
è¯¥è§’è‰²å°è¯•å‡è®¾å®ƒå°†éœ€è¦å¯¹è¯¥è§’è‰²çš„ **ç‰¹å®š `sts:AssumeRole` æƒé™** **ä»¥å‡è®¾å®ƒ**ã€‚

å¦‚æœæ‚¨å°è¯•ä» **ä¸åŒè´¦æˆ·** **å‡è®¾ä¸€ä¸ªè§’è‰²**ï¼Œåˆ™ **è¢«å‡è®¾çš„è§’è‰²å¿…é¡»å…è®¸å®ƒ**ï¼ˆæŒ‡æ˜è§’è‰²çš„ **ARN** æˆ– **å¤–éƒ¨è´¦æˆ·**ï¼‰ï¼Œå¹¶ä¸” **å°è¯•å‡è®¾** å¦ä¸€ä¸ªè§’è‰²çš„ **è§’è‰²å¿…é¡»** **å…·æœ‰å‡è®¾å®ƒçš„æƒé™**ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿è¢«å‡è®¾çš„è§’è‰²æŒ‡å®šäº† ARNï¼Œè¿™ä¹Ÿä¸æ˜¯å¯é€‰çš„ï¼‰ã€‚

### Enumeration
```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```
### Privesc

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨ STS æƒé™ä»¥æå‡ç‰¹æƒ**ï¼š

{% content-ref url="../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-sts-post-exploitation.md" %}
[aws-sts-post-exploitation.md](../aws-post-exploitation/aws-sts-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-sts-persistence.md" %}
[aws-sts-persistence.md](../aws-persistence/aws-sts-persistence.md)
{% endcontent-ref %}

## References

* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
