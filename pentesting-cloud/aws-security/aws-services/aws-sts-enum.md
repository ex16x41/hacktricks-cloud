# AWS - STS Enum

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## STS

**AWS Security Token Service (STS)** ä¸»è¦ç”¨äºé¢å‘ **ä¸´æ—¶ã€æœ‰é™æƒé™çš„å‡­è¯**ã€‚è¿™äº›å‡­è¯å¯ä»¥ä¸º **AWS Identity and Access Management (IAM)** ç”¨æˆ·æˆ–å·²è®¤è¯ç”¨æˆ·ï¼ˆè”åˆç”¨æˆ·ï¼‰è¯·æ±‚ã€‚

é‰´äº STS çš„ç›®çš„æ˜¯ **é¢å‘èº«ä»½å†’å……çš„å‡­è¯**ï¼Œè¯¥æœåŠ¡å¯¹äº **æå‡æƒé™å’Œä¿æŒæŒä¹…æ€§** éå¸¸æœ‰ä»·å€¼ï¼Œå°½ç®¡å®ƒå¯èƒ½æ²¡æœ‰å¹¿æ³›çš„é€‰é¡¹ã€‚

### Assume Role Impersonation

AWS STS æä¾›çš„ [AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRole.html) æ“ä½œè‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒå…è®¸ä¸€ä¸ªä¸»ä½“è·å–å¦ä¸€ä¸ªä¸»ä½“çš„å‡­è¯ï¼Œå®è´¨ä¸Šæ˜¯å†’å……ä»–ä»¬ã€‚è°ƒç”¨åï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªè®¿é—®å¯†é’¥ IDã€ä¸€ä¸ªç§˜å¯†å¯†é’¥å’Œä¸€ä¸ªä¸æŒ‡å®š ARN å¯¹åº”çš„ä¼šè¯ä»¤ç‰Œã€‚

å¯¹äºæ¸—é€æµ‹è¯•äººå‘˜æˆ–çº¢é˜Ÿæˆå‘˜æ¥è¯´ï¼Œè¿™ç§æŠ€æœ¯å¯¹äºæƒé™æå‡éå¸¸æœ‰ç”¨ï¼ˆå¦‚[**è¿™é‡Œ**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole)æ‰€è¿°ï¼‰ã€‚ç„¶è€Œï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æŠ€æœ¯ç›¸å½“æ˜¾çœ¼ï¼Œå¯èƒ½ä¸ä¼šè®©æ”»å‡»è€…æªæ‰‹ä¸åŠã€‚

#### Assume Role Logic

å¦‚æœ **è¦å‡è®¾çš„è§’è‰²ç‰¹å®šå…è®¸ä¸€ä¸ªè§’è‰² ARN**ï¼Œåˆ™åœ¨åŒä¸€è´¦æˆ·ä¸­å‡è®¾è§’è‰²çš„é€»è¾‘å¦‚ä¸‹ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
è§’è‰² **`priv-role`** åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**ä¸éœ€è¦ç‰¹åˆ«å…è®¸** æ‰èƒ½æ‰¿æ‹…è¯¥è§’è‰²ï¼ˆæœ‰è¿™ä¸ªå…è®¸å°±è¶³å¤Ÿäº†ï¼‰ã€‚

ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªè§’è‰²å…è®¸ä¸€ä¸ªè´¦æˆ·æ‰¿æ‹…å®ƒï¼Œæ¯”å¦‚ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
å°è¯•æ‰¿æ‹…è¯¥è§’è‰²çš„è§’è‰²éœ€è¦å¯¹è¯¥è§’è‰²å…·æœ‰**ç‰¹å®šçš„ `sts:AssumeRole` æƒé™**æ‰èƒ½**æ‰¿æ‹…å®ƒ**ã€‚

å¦‚æœä½ å°è¯•ä»**ä¸åŒè´¦æˆ·**ä¸­æ‰¿æ‹…ä¸€ä¸ª**è§’è‰²**ï¼Œåˆ™**è¢«æ‰¿æ‹…çš„è§’è‰²å¿…é¡»å…è®¸**ï¼ˆæŒ‡ç¤ºè§’è‰²**ARN**æˆ–**å¤–éƒ¨è´¦æˆ·**ï¼‰ï¼Œå¹¶ä¸”**å°è¯•æ‰¿æ‹…çš„è§’è‰²**å¿…é¡»**å…·æœ‰æ‰¿æ‹…å®ƒçš„æƒé™**ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿è¢«æ‰¿æ‹…çš„è§’è‰²æŒ‡å®šäº†ä¸€ä¸ª ARNï¼Œè¿™ä¹Ÿä¸æ˜¯å¯é€‰çš„ï¼‰ã€‚

### Enumeration
```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```
### ææƒ

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨ STS æƒé™æ¥æå‡æƒé™**ï¼š

{% content-ref url="../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### åæ¸—é€

{% content-ref url="../aws-post-exploitation/aws-sts-post-exploitation.md" %}
[aws-sts-post-exploitation.md](../aws-post-exploitation/aws-sts-post-exploitation.md)
{% endcontent-ref %}

### æŒä¹…åŒ–

{% content-ref url="../aws-persistence/aws-sts-persistence.md" %}
[aws-sts-persistence.md](../aws-persistence/aws-sts-persistence.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
