# AWS - STS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## STS

**Η Υπηρεσία Ασφαλείας Διακριτικών AWS (STS)** έχει σχεδιαστεί κυρίως για να εκδίδει **προσωρινά, περιορισμένα διαπιστευτήρια**. Αυτά τα διαπιστευτήρια μπορούν να ζητηθούν για χρήστες **AWS Identity and Access Management (IAM)** ή για αυθεντικοποιημένους χρήστες (ομοσπονδικούς χρήστες).

Δεδομένου ότι ο σκοπός του STS είναι να **εκδίδει διαπιστευτήρια για μίμηση ταυτότητας**, η υπηρεσία είναι εξαιρετικά πολύτιμη για **αναβάθμιση δικαιωμάτων και διατήρηση επιμονής**, αν και μπορεί να μην έχει μια ευρεία γκάμα επιλογών.

### Μίμηση Ρόλου

Η ενέργεια [AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRole.html) που παρέχεται από το AWS STS είναι κρίσιμη καθώς επιτρέπει σε έναν κύριο να αποκτήσει διαπιστευτήρια για έναν άλλο κύριο, ουσιαστικά μιμούμενος αυτόν. Κατά την κλήση, απαντά με ένα αναγνωριστικό κλειδιού πρόσβασης, ένα μυστικό κλειδί και ένα διακριτικό συνεδρίας που αντιστοιχεί στο καθορισμένο ARN.

Για τους Δοκιμαστές Διείσδυσης ή τα μέλη της Κόκκινης Ομάδας, αυτή η τεχνική είναι καθοριστική για την αναβάθμιση δικαιωμάτων (όπως αναλύεται [**εδώ**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole)). Ωστόσο, αξίζει να σημειωθεί ότι αυτή η τεχνική είναι αρκετά προφανής και μπορεί να μην αιφνιδιάσει έναν επιτιθέμενο.

#### Λογική Μίμησης Ρόλου

Για να μιμηθείτε έναν ρόλο στον ίδιο λογαριασμό εάν ο **ρόλος που πρέπει να μιμηθεί επιτρέπει συγκεκριμένα έναν ρόλο ARN** όπως στο:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
Ο ρόλος **`priv-role`** σε αυτή την περίπτωση, **δεν χρειάζεται να επιτρέπεται συγκεκριμένα** να αναλάβει αυτόν τον ρόλο (με αυτή την άδεια είναι αρκετό).

Ωστόσο, αν ένας ρόλος επιτρέπει σε έναν λογαριασμό να τον αναλάβει, όπως στο:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
Ο ρόλος που προσπαθεί να αναληφθεί θα χρειαστεί μια **συγκεκριμένη άδεια `sts:AssumeRole`** για αυτόν τον ρόλο **για να τον αναλάβει**.

Αν προσπαθήσετε να αναλάβετε έναν **ρόλο** **από διαφορετικό λογαριασμό**, ο **αναληφθείς ρόλος πρέπει να το επιτρέπει** (υποδεικνύοντας τον ρόλο **ARN** ή τον **εξωτερικό λογαριασμό**), και ο **ρόλος που προσπαθεί να αναλάβει** τον άλλο **ΠΡΕΠΕΙ** να έχει **άδειες για να τον αναλάβει** (σε αυτή την περίπτωση αυτό δεν είναι προαιρετικό ακόμα και αν ο αναληφθείς ρόλος καθορίζει έναν ARN).

### Enumeration
```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```
### Privesc

Στην παρακάτω σελίδα μπορείτε να ελέγξετε πώς να **καταχραστείτε τις άδειες STS για να κλιμακώσετε τα προνόμια**:

{% content-ref url="../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-sts-post-exploitation.md" %}
[aws-sts-post-exploitation.md](../aws-post-exploitation/aws-sts-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-sts-persistence.md" %}
[aws-sts-persistence.md](../aws-persistence/aws-sts-persistence.md)
{% endcontent-ref %}

## References

* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
