# AWS - STS Enum

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichen.

</details>
{% endhint %}

## STS

**AWS Security Token Service (STS)** ist haupts√§chlich daf√ºr konzipiert, **tempor√§re, privilegierte Anmeldeinformationen** auszustellen. Diese Anmeldeinformationen k√∂nnen f√ºr **AWS Identity and Access Management (IAM)**-Benutzer oder f√ºr authentifizierte Benutzer (federierte Benutzer) angefordert werden.

Da der Zweck von STS darin besteht, **Anmeldeinformationen f√ºr Identit√§ts√ºbernahme auszustellen**, ist der Dienst √§u√üerst wertvoll f√ºr **Privilegieneskalation und Aufrechterhaltung der Persistenz**, auch wenn er m√∂glicherweise nicht √ºber eine breite Palette von Optionen verf√ºgt.

### Assume Role Impersonation

Die Aktion [AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRole.html), die von AWS STS bereitgestellt wird, ist entscheidend, da sie einem Principal erlaubt, Anmeldeinformationen f√ºr einen anderen Principal zu erwerben, indem er ihn im Wesentlichen impersoniert. Bei der Ausf√ºhrung antwortet sie mit einer Zugangs-ID, einem geheimen Schl√ºssel und einem Sitzungstoken, die dem angegebenen ARN entsprechen.

F√ºr Penetration Tester oder Red Team-Mitglieder ist diese Technik entscheidend f√ºr die Privilegieneskalation (wie [**hier**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole) erl√§utert). Es ist jedoch erw√§hnenswert, dass diese Technik recht auff√§llig ist und einen Angreifer m√∂glicherweise nicht unvorbereitet trifft.

#### Assume Role Logic

Um eine Rolle im selben Konto zu √ºbernehmen, wenn die **zu √ºbernehmende Rolle speziell eine Rollen-ARN zul√§sst**, wie in:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
Die Rolle **`priv-role`** muss in diesem Fall **nicht speziell erlaubt sein**, um diese Rolle zu √ºbernehmen (mit dieser Erlaubnis ist es ausreichend).

Wenn eine Rolle jedoch einem Konto erlaubt, sie zu √ºbernehmen, wie in:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
Die Rolle, die versucht, sie zu √ºbernehmen, ben√∂tigt eine **spezifische `sts:AssumeRole`-Berechtigung** f√ºr diese Rolle, **um sie zu √ºbernehmen**.

Wenn Sie versuchen, eine **Rolle** **aus einem anderen Konto** zu √ºbernehmen, **muss die √ºbernommene Rolle dies erlauben** (indem die Rolle **ARN** oder das **externe Konto** angegeben wird), und die **Rolle, die versucht, die andere zu √ºbernehmen**, **MUSS** Berechtigungen haben, um sie zu √ºbernehmen (in diesem Fall ist dies nicht optional, selbst wenn die √ºbernommene Rolle eine ARN angibt).

### Enumeration
```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```
### Privesc

In der folgenden Seite kannst du √ºberpr√ºfen, wie man **STS-Berechtigungen missbraucht, um Privilegien zu eskalieren**:

{% content-ref url="../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-sts-post-exploitation.md" %}
[aws-sts-post-exploitation.md](../aws-post-exploitation/aws-sts-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-sts-persistence.md" %}
[aws-sts-persistence.md](../aws-persistence/aws-sts-persistence.md)
{% endcontent-ref %}

## References

* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
