# AWS - Step Functions Enum

{% hint style="success" %}
Nau캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Step Functions

AWS Step Functions je usluga za radne tokove koja vam omogu캖ava koordinaciju i orkestraciju vi코e AWS usluga u serverless radne tokove. Kori코캖enjem AWS Step Functions, mo쬰te dizajnirati i pokretati radne tokove koji povezuju razli캜ite AWS usluge kao 코to su AWS Lambda, Amazon S3, Amazon DynamoDB i mnoge druge, u nizu koraka. Ova orkestraciona usluga pru쬬 vizuelni interfejs za radne tokove i nudi **state machine** mogu캖nosti, omogu캖avaju캖i vam da defini코ete svaki korak radnog toka na deklarativan na캜in koriste캖i JSON-bazirani **Amazon States Language** (ASL).

AWS Step Functions pojednostavljuje proces izgradnje otpornih i skalabilnih aplikacija upravljanjem osnovnom infrastrukturom, automatskim rukovanjem ponovnim poku코ajima, gre코kama i paralelnom obradom. Posebno je korisna za kreiranje slo쬰nih radnih tokova koji uklju캜uju vi코e koraka i ta캜aka odluke, jer lako mo쬰 upravljati tokom podataka i stanjem izvr코enja izme캠u usluga. Glavni slu캜ajevi upotrebe ove usluge su slede캖i:

- **Obrada podataka**: Obrada fajlova, video i slika; ekstrakcija, transformacija i u캜itavanje (ETL) poslova; i Batch obrada i radna optere캖enja visokih performansi (HPC).
- **Ma코insko u캜enje**: Otkrivanje prevara, prilago캠avanje, preporuke i oboga캖ivanje podataka.
- **Orkestracija mikroservisa**: Sinhroni ili real-time radni tokovi i orkestracija kontejnera.
- **IT i sigurnosna automatizacija**: Auto-remedijacija, implementacija i odgovor; i ljudsko odobrenje i eskalacija.

## Klju캜ni koncepti

### Standardni vs. Express Workflows

AWS Step Functions nudi dve vrste **state machine workflows**: Standard i Express.

- **Standard Workflow**: Ova podrazumevana vrsta radnog toka je dizajnirana za dugotrajne, trajne i revizorske procese. Podr쬬va **ta캜no-jednom izvr코enje**, osiguravaju캖i da se zadaci izvr코avaju samo jednom osim ako nisu specificirani ponovni poku코aji. Idealna je za radne tokove kojima je potrebna detaljna istorija izvr코enja i mo쬰 trajati do jedne godine.
- **Express Workflow**: Ova vrsta je idealna za zadatke visokog obima i kratkog trajanja, koji traju do pet minuta. Podr쬬vaju **najmanje-jednom izvr코enje**, pogodno za idempotentne zadatke kao 코to je obrada podataka. Ovi radni tokovi su optimizovani za tro코kove i performanse, napla캖uju캖i se na osnovu izvr코enja, trajanja i kori코캖enja memorije.

### States

States su osnovne jedinice state machines. Defini코u pojedina캜ne korake unutar radnog toka, i mogu obavljati razne funkcije u zavisnosti od tipa:

- **Task:** Izvr코ava posao, 캜esto koriste캖i AWS uslugu kao 코to je Lambda.
- **Choice:** Donosi odluke na osnovu ulaza.
- **Fail/Succeed:** Zavr코ava izvr코enje sa gre코kom ili uspehom.
- **Pass:** Prosle캠uje ulaz na izlaz ili ubacuje podatke.
- **Wait:** Odla쬰 izvr코enje na odre캠eno vreme.
- **Parallel:** Pokre캖e paralelne grane.
- **Map:** Dinami캜ki iterira korake preko stavki.

### Task

**Task** state predstavlja jednu jedinicu rada koju izvr코ava state machine. Zadaci mogu pozivati razli캜ite resurse, uklju캜uju캖i aktivnosti, Lambda funkcije, AWS usluge ili tre캖e strane API-je.

- **Activities**: Prilago캠eni radnici koje vi upravljate, pogodni za dugotrajne procese.
- Resource: **`arn:aws:states:region:account:activity:name`**.
- **Lambda Functions**: Izvr코ava AWS Lambda funkcije.
- Resource: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS Services**: Direktno se integri코e sa drugim AWS uslugama, kao 코to su DynamoDB ili S3.
- Resource: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP Task**: Poziva API-je tre캖ih strana.
- Resource field: **`arn:aws:states:::http:invoke`**. Zatim, treba da obezbedite detalje konfiguracije API endpoint-a, kao 코to su API URL, metoda i detalji autentifikacije.

Slede캖i primer prikazuje definiciju Task state-a koja poziva Lambda funkciju pod nazivom HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

**Choice** stanje dodaje uslovnu logiku u workflow, omogu캖avaju캖i odluke zasnovane na ulaznim podacima. Evaluira specificirane uslove i prelazi u odgovaraju캖e stanje na osnovu rezultata.

- **Pore캠enje**: Svako pravilo izbora uklju캜uje operator pore캠enja (npr. **`NumericEquals`**, **`StringEquals`**) koji poredi ulaznu varijablu sa specificiranom vredno코캖u ili drugom varijablom.
- **Next Field**: Choice stanja ne podr쬬vaju **`End`** polje, umesto toga defini코u **`Next`** stanje u koje prelaze ako je pore캠enje ta캜no.

Primer **Choice** stanja:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fail/Succeed

**`Fail`** stanje zaustavlja izvr코avanje state machine-a i ozna캜ava ga kao neuspeh. Koristi se za specificiranje imena gre코ke i uzroka, pru쬬ju캖i detalje o neuspehu. Ovo stanje je terminalno, 코to zna캜i da zavr코ava tok izvr코avanja.

**`Succeed`** stanje zaustavlja izvr코avanje uspe코no. Obi캜no se koristi za zavr코avanje workflow-a kada se uspe코no zavr코i. Ovo stanje ne zahteva **`Next`** polje.

{% tabs %}

{% tab title="Fail example" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Succeed example" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Pass

**Pass** stanje prosle캠uje svoj ulaz svom izlazu bilo bez obavljanja bilo kakvog posla ili transformi코u캖i JSON stanje ulaza koriste캖i filtere, a zatim prosle캠uje transformisane podatke slede캖em stanju. Korisno je za testiranje i konstruisanje ma코ina stanja, omogu캖avaju캖i vam da ubacite stati캜ke podatke ili ih transformi코ete.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wait

**Wait** stanje odla쬰 izvr코enje ma코ine stanja za odre캠eno trajanje. Postoje tri glavna na캜ina za pode코avanje vremena 캜ekanja:

- **X Sekundi**: Fiksni broj sekundi za 캜ekanje.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Apsolutna Vremenska Oznaka**: Ta캜no vreme do kojeg se 캜eka.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Dinami캜ko 캛ekanje**: Na osnovu ulaza koriste캖i **`SecondsPath`** ili **`TimestampPath`**.

```json
jsonCopiar c칩digo
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Parallel

**Parallel** stanje omogu캖ava izvr코avanje vi코e grana zadataka istovremeno unutar va코eg workflow-a. Svaka grana radi nezavisno i obra캠uje svoj sopstveni niz stanja. Izvr코enje 캜eka dok sve grane ne zavr코e pre nego 코to pre캠e na slede캖e stanje. Njegova klju캜na polja su:

- **Branches**: Niz koji defini코e paralelne putanje izvr코enja. Svaka grana je zasebna ma코ina stanja.
- **ResultPath**: Defini코e gde (u ulazu) da se postavi kombinovani izlaz grana.
- **Retry and Catch**: Konfiguracije za rukovanje gre코kama za paralelno stanje.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

**Map** stanje omogu캖ava izvr코avanje skupa koraka za svaki element u dataset-u. Koristi se za paralelnu obradu podataka. U zavisnosti od na캜ina na koji 쬰lite da obradite stavke dataset-a, Step Functions pru쬬 slede캖e re쬴me:

- **Inline Mode**: Izvr코ava podskup stanja za svaki JSON niz element. Pogodan za zadatke malog obima sa manje od 40 paralelnih iteracija, pri 캜emu se svaka od njih izvr코ava u kontekstu workflow-a koji sadr쬴 **`Map`** stanje.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Distributed Mode**: Dizajniran za paralelnu obradu velikog obima sa visokom konkurentno코캖u. Podr쬬va obradu velikih dataset-ova, kao 코to su oni skladi코teni u Amazon S3, omogu캖avaju캖i visoku konkurentnost do 10,000 paralelnih child workflow izvr코enja, pri 캜emu se ova child izvr코enja pokre캖u kao zasebna child izvr코enja.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Versions and aliases

Step Functions tako캠e omogu캖ava upravljanje workflow deployment-ima kroz **versions** i **aliases** state ma코ina. Verzija predstavlja snapshot state ma코ine koji mo쬰 biti izvr코en. Alias-i slu쬰 kao pokaziva캜i na do dve verzije state ma코ine.

- **Versions**: Ove nepromenljive snapshot-e state ma코ine kreiraju se iz najnovije revizije te state ma코ine. Svaka verzija je identifikovana jedinstvenim ARN-om koji kombinuje ARN state ma코ine sa brojem verzije, odvojenim dvota캜kom (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Verzije ne mogu biti ure캠ivane, ali mo쬰te a쬿rirati state ma코inu i objaviti novu verziju, ili koristiti 쬰ljenu verziju state ma코ine.
- **Aliases**: Ovi pokaziva캜i mogu referencirati do dve verzije iste state ma코ine. Vi코e alias-a mo쬰 biti kreirano za jednu state ma코inu, svaki identifikovan jedinstvenim ARN-om konstruisanim kombinovanjem ARN-a state ma코ine sa imenom alias-a, odvojenim dvota캜kom (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Alias-i omogu캖avaju usmeravanje saobra캖aja izme캠u jedne od dve verzije state ma코ine. Alternativno, alias mo쬰 pokazivati na jednu specifi캜nu verziju state ma코ine, ali ne i na druge alias-e. Mogu se a쬿rirati da preusmere na drugu verziju state ma코ine po potrebi, olak코avaju캖i kontrolisane deployment-e i upravljanje workflow-om.

Za detaljnije informacije o **ASL**, pogledajte: [**Amazon States Language**](https://states-language.net/spec.html).



## IAM Roles for State machines

AWS Step Functions koristi AWS Identity and Access Management (IAM) role za kontrolu pristupa resursima i akcijama unutar state ma코ina. Evo klju캜nih aspekata vezanih za sigurnost i IAM role u AWS Step Functions:

- **Execution Role**: Svaka state ma코ina u AWS Step Functions je povezana sa IAM execution rolom. Ova rola defini코e koje akcije state ma코ina mo쬰 izvr코avati u va코e ime. Kada state ma코ina prelazi izme캠u stanja koja interaguju sa AWS servisima (kao 코to je pozivanje Lambda funkcija, pristupanje DynamoDB, itd.), ona preuzima ovu execution rolu da bi izvr코ila te akcije.
- **Permissions**: IAM execution rola mora biti konfigurisana sa dozvolama koje omogu캖avaju potrebne akcije na drugim AWS servisima. Na primer, ako va코a state ma코ina treba da pozove AWS Lambda funkcije, IAM rola mora imati **`lambda:InvokeFunction`** dozvole. Sli캜no, ako treba da pi코e u DynamoDB, odgovaraju캖e dozvole (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, itd.) moraju biti dodeljene.
- **Least Privilege**: Preporu캜uje se da se prati princip najmanjih privilegija prilikom konfigurisanja IAM rola za Step Functions. To zna캜i dodeljivanje samo onih dozvola koje su neophodne za specifi캜ne akcije state ma코ine, i ni코ta vi코e. IAM politike treba da budu ograni캜ene na specifi캜ne resurse i akcije, smanjuju캖i rizik od neplaniranog pristupa.

## Enumeration

ReadOnlyAccess policy je dovoljna za sve slede캖e enumeration akcije.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Na slede캖oj stranici mo쬰te proveriti kako **zloupotrebiti Step Functions dozvole za eskalaciju privilegija**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# References

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
Nau캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove podno코enjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
