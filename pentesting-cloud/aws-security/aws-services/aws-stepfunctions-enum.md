# AWS - Step Functions Enum

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Step Functions

AWS Step Functions ist ein Workflow-Dienst, der es Ihnen erm√∂glicht, mehrere AWS-Dienste in serverlosen Workflows zu koordinieren und zu orchestrieren. Mit AWS Step Functions k√∂nnen Sie Workflows entwerfen und ausf√ºhren, die verschiedene AWS-Dienste wie AWS Lambda, Amazon S3, Amazon DynamoDB und viele mehr in einer Abfolge von Schritten verbinden. Dieser Orchestrierungsdienst bietet eine visuelle Workflow-Oberfl√§che und bietet **Zustandsmaschinen**-Funktionen, mit denen Sie jeden Schritt des Workflows deklarativ mit der JSON-basierten **Amazon States Language** (ASL) definieren k√∂nnen.

## Schl√ºsselkonzepte

### Standard- vs. Express-Workflows

AWS Step Functions bietet zwei Arten von **Zustandsmaschinen-Workflows**: Standard und Express.

* **Standard-Workflow**: Dieser Standard-Workflow-Typ ist f√ºr langlaufende, langlebige und pr√ºfbare Prozesse konzipiert. Er unterst√ºtzt **exactly-once execution**, was sicherstellt, dass Aufgaben nur einmal ausgef√ºhrt werden, es sei denn, Wiederholungen sind angegeben. Er ist ideal f√ºr Workflows, die eine detaillierte Ausf√ºhrungshistorie ben√∂tigen, und kann bis zu einem Jahr laufen.
* **Express-Workflow**: Dieser Typ ist ideal f√ºr hochvolumige, kurzzeitige Aufgaben, die bis zu f√ºnf Minuten laufen. Sie unterst√ºtzen **at-least-once execution**, geeignet f√ºr idempotente Aufgaben wie Datenverarbeitung. Diese Workflows sind auf Kosten und Leistung optimiert und berechnen Geb√ºhren basierend auf Ausf√ºhrungen, Dauer und Speicherverbrauch.

### Zust√§nde

Zust√§nde sind die wesentlichen Einheiten von Zustandsmaschinen. Sie definieren die einzelnen Schritte innerhalb eines Workflows und k√∂nnen je nach Typ eine Vielzahl von Funktionen ausf√ºhren:

* **Aufgabe:** F√ºhrt einen Job aus, oft unter Verwendung eines AWS-Dienstes wie Lambda.
* **Wahl:** Trifft Entscheidungen basierend auf Eingaben.
* **Fehler/Erfolg:** Beendet die Ausf√ºhrung mit einem Fehler oder Erfolg.
* **Pass:** Gibt Eingaben an Ausgaben weiter oder injiziert Daten.
* **Warten:** Verz√∂gert die Ausf√ºhrung f√ºr eine festgelegte Zeit.
* **Parallel:** Initiert parallele Zweige.
* **Karte:** Iteriert dynamisch √ºber Schritte √ºber Elemente.

### Aufgabe

Ein **Aufgaben**-Zustand stellt eine einzelne Arbeitseinheit dar, die von einer Zustandsmaschine ausgef√ºhrt wird. Aufgaben k√∂nnen verschiedene Ressourcen aufrufen, einschlie√ülich Aktivit√§ten, Lambda-Funktionen, AWS-Dienste oder Drittanbieter-APIs.

* **Aktivit√§ten**: Benutzerdefinierte Arbeiter, die Sie verwalten, geeignet f√ºr langlaufende Prozesse.
* Ressource: **`arn:aws:states:region:account:activity:name`**.
* **Lambda-Funktionen**: F√ºhrt AWS Lambda-Funktionen aus.
* Ressource: **`arn:aws:lambda:region:account:function:function-name`**.
* **AWS-Dienste**: Integriert sich direkt mit anderen AWS-Diensten, wie DynamoDB oder S3.
* Ressource: **`arn:partition:states:region:account:servicename:APIname`**.
* **HTTP-Aufgabe**: Ruft Drittanbieter-APIs auf.
* Ressourcenfeld: **`arn:aws:states:::http:invoke`**. Dann sollten Sie die Konfigurationsdetails des API-Endpunkts bereitstellen, wie die API-URL, Methode und Authentifizierungsdetails.

Das folgende Beispiel zeigt eine Aufgaben-Zustandsdefinition, die eine Lambda-Funktion namens HelloWorld aufruft:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

Ein **Choice**-Zustand f√ºgt einer Arbeitsablaufbedingung Logik hinzu, die Entscheidungen basierend auf Eingabedaten erm√∂glicht. Er bewertet die angegebenen Bedingungen und wechselt basierend auf den Ergebnissen zum entsprechenden Zustand.

* **Comparison**: Jede Wahlregel enth√§lt einen Vergleichsoperator (z. B. **`NumericEquals`**, **`StringEquals`**), der eine Eingabevariable mit einem angegebenen Wert oder einer anderen Variablen vergleicht.
* **Next Field**: Choice-Zust√§nde unterst√ºtzen nicht das **`End`**-Feld, stattdessen definieren sie den **`Next`**-Zustand, zu dem gewechselt wird, wenn der Vergleich wahr ist.

Beispiel f√ºr den **Choice**-Zustand:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fail/Succeed

Ein **`Fail`**-Zustand stoppt die Ausf√ºhrung einer Zustandsmaschine und markiert sie als Fehler. Er wird verwendet, um einen Fehlernamen und eine Ursache anzugeben, die Details √ºber den Fehler bereitstellen. Dieser Zustand ist terminal, was bedeutet, dass er den Ausf√ºhrungsfluss beendet.

Ein **`Succeed`**-Zustand stoppt die Ausf√ºhrung erfolgreich. Er wird typischerweise verwendet, um den Workflow zu beenden, wenn er erfolgreich abgeschlossen ist. Dieser Zustand ben√∂tigt kein **`Next`**-Feld.

{% tabs %}
{% tab title="Fail example" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Erfolgsbeispiel" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
{% endtab %}
{% endtabs %}

### Pass

Ein **Pass**-Zustand √ºbertr√§gt seine Eingabe an seine Ausgabe, entweder ohne Arbeit zu verrichten oder indem er die JSON-Zustandeingabe mithilfe von Filtern transformiert und dann die transformierten Daten an den n√§chsten Zustand √ºbergibt. Es ist n√ºtzlich zum Testen und Konstruieren von Zustandsmaschinen, da es Ihnen erm√∂glicht, statische Daten einzuf√ºgen oder sie zu transformieren.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wait

Ein **Wait**-Zustand verz√∂gert die Ausf√ºhrung der Zustandsmaschine f√ºr eine bestimmte Dauer. Es gibt drei Hauptmethoden, um die Wartezeit zu konfigurieren:

*   **X Sekunden**: Eine feste Anzahl von Sekunden zu warten.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```
*   **Absolute Zeitstempel**: Eine genaue Zeit, bis zu der gewartet werden soll.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```
*   **Dynamisches Warten**: Basierend auf Eingaben mit **`SecondsPath`** oder **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```

### Parallel

Ein **Parallel**-Zustand erm√∂glicht es Ihnen, mehrere Aufgaben√§ste gleichzeitig innerhalb Ihres Workflows auszuf√ºhren. Jeder Ast l√§uft unabh√§ngig und verarbeitet seine eigene Sequenz von Zust√§nden. Die Ausf√ºhrung wartet, bis alle √Ñste abgeschlossen sind, bevor sie zum n√§chsten Zustand √ºbergeht. Die wichtigsten Felder sind:

* **Branches**: Ein Array, das die parallelen Ausf√ºhrungspfade definiert. Jeder Ast ist eine separate Zustandsmaschine.
* **ResultPath**: Definiert, wo (in der Eingabe) die kombinierte Ausgabe der √Ñste platziert werden soll.
* **Retry und Catch**: Fehlerbehandlungs-Konfigurationen f√ºr den parallelen Zustand.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

Ein **Map**-Zustand erm√∂glicht die Ausf√ºhrung einer Reihe von Schritten f√ºr jedes Element in einem Datensatz. Es wird f√ºr die parallele Verarbeitung von Daten verwendet. Je nachdem, wie Sie die Elemente des Datensatzes verarbeiten m√∂chten, bietet Step Functions die folgenden Modi an:

*   **Inline-Modus**: F√ºhrt eine Teilmenge von Zust√§nden f√ºr jedes JSON-Array-Element aus. Geeignet f√ºr Aufgaben im kleinen Ma√üstab mit weniger als 40 parallelen Iterationen, die jeweils im Kontext des Workflows ausgef√ºhrt werden, der den **`Map`**-Zustand enth√§lt.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```
*   **Verteilter Modus**: Entwickelt f√ºr die parallele Verarbeitung im gro√üen Ma√üstab mit hoher Parallelit√§t. Unterst√ºtzt die Verarbeitung gro√üer Datens√§tze, wie sie in Amazon S3 gespeichert sind, und erm√∂glicht eine hohe Parallelit√§t von bis zu 10.000 parallelen Kind-Workflow-Ausf√ºhrungen, die als separate Kind-Ausf√ºhrung ausgef√ºhrt werden.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```

### Versionen und Aliase

Step Functions erm√∂glicht es Ihnen auch, Workflow-Bereitstellungen durch **Versionen** und **Aliase** von Zustandsmaschinen zu verwalten. Eine Version stellt einen Snapshot einer Zustandsmaschine dar, der ausgef√ºhrt werden kann. Aliase dienen als Zeiger auf bis zu zwei Versionen einer Zustandsmaschine.

* **Versionen**: Diese unver√§nderlichen Snapshots einer Zustandsmaschine werden aus der aktuellsten Revision dieser Zustandsmaschine erstellt. Jede Version wird durch eine eindeutige ARN identifiziert, die die ARN der Zustandsmaschine mit der Versionsnummer kombiniert, getrennt durch einen Doppelpunkt (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Versionen k√∂nnen nicht bearbeitet werden, aber Sie k√∂nnen die Zustandsmaschine aktualisieren und eine neue Version ver√∂ffentlichen oder die gew√ºnschte Version der Zustandsmaschine verwenden.
* **Aliase**: Diese Zeiger k√∂nnen auf bis zu zwei Versionen derselben Zustandsmaschine verweisen. Mehrere Aliase k√∂nnen f√ºr eine einzelne Zustandsmaschine erstellt werden, die jeweils durch eine eindeutige ARN identifiziert werden, die die ARN der Zustandsmaschine mit dem Aliasnamen kombiniert, getrennt durch einen Doppelpunkt (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Aliase erm√∂glichen das Routing des Datenverkehrs zwischen einer der beiden Versionen einer Zustandsmaschine. Alternativ kann ein Alias auf eine bestimmte Version der Zustandsmaschine verweisen, jedoch nicht auf andere Aliase. Sie k√∂nnen aktualisiert werden, um auf eine andere Version der Zustandsmaschine umzuleiten, wenn dies erforderlich ist, was kontrollierte Bereitstellungen und Workflow-Management erleichtert.

F√ºr detailliertere Informationen √ºber **ASL** siehe: [**Amazon States Language**](https://states-language.net/spec.html).

## IAM-Rollen f√ºr Zustandsmaschinen

AWS Step Functions nutzt AWS Identity and Access Management (IAM)-Rollen, um den Zugriff auf Ressourcen und Aktionen innerhalb von Zustandsmaschinen zu steuern. Hier sind die wichtigsten Aspekte in Bezug auf Sicherheit und IAM-Rollen in AWS Step Functions:

* **Ausf√ºhrungsrolle**: Jede Zustandsmaschine in AWS Step Functions ist mit einer IAM-Ausf√ºhrungsrolle verkn√ºpft. Diese Rolle definiert, welche Aktionen die Zustandsmaschine in Ihrem Namen ausf√ºhren kann. Wenn eine Zustandsmaschine zwischen Zust√§nden wechselt, die mit AWS-Diensten interagieren (wie das Aufrufen von Lambda-Funktionen, den Zugriff auf DynamoDB usw.), √ºbernimmt sie diese Ausf√ºhrungsrolle, um diese Aktionen durchzuf√ºhren.
* **Berechtigungen**: Die IAM-Ausf√ºhrungsrolle muss mit Berechtigungen konfiguriert werden, die die erforderlichen Aktionen auf anderen AWS-Diensten zulassen. Wenn Ihre Zustandsmaschine beispielsweise AWS Lambda-Funktionen aufrufen muss, muss die IAM-Rolle √ºber die Berechtigung **`lambda:InvokeFunction`** verf√ºgen. Ebenso m√ºssen, wenn sie in DynamoDB schreiben muss, die entsprechenden Berechtigungen (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`** usw.) gew√§hrt werden.

## Enumeration

Die ReadOnlyAccess-Richtlinie reicht f√ºr alle folgenden Enumerationsaktionen aus.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List versions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve information about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution (output included)
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified step Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

In der folgenden Seite k√∂nnen Sie √ºberpr√ºfen, wie Sie **Step Functions-Berechtigungen missbrauchen, um Privilegien zu eskalieren**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation.md" %}
[aws-stepfunctions-post-exploitation.md](../aws-post-exploitation/aws-stepfunctions-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-step-functions-persistence.md" %}
[aws-step-functions-persistence.md](../aws-persistence/aws-step-functions-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
