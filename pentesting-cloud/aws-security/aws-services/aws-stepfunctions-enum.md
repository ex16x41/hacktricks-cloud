# AWS - Enumeracija koraka

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Koraci

AWS Step Functions je servis za radne tokove koji vam omogu캖ava da koordinirate i orkestrirate vi코e AWS servisa u serverless radne tokove. Kori코캖enjem AWS Step Functions-a, mo쬰te dizajnirati i pokretati radne tokove koji povezuju razli캜ite AWS servise poput AWS Lambda, Amazon S3, Amazon DynamoDB i mnoge druge, u nizu koraka. Ovaj servis za orkestraciju pru쬬 vizuelni interfejs radnog toka i nudi mogu캖nosti **state machine**-a, omogu캖avaju캖i vam da defini코ete svaki korak radnog toka na deklarativan na캜in kori코캖enjem JSON baziranog **Amazon States Language** (ASL).

AWS Step Functions pojednostavljuje proces izgradnje otpornih i skalabilnih aplikacija upravljaju캖i osnovnom infrastrukturom, rukovanjem ponovnim poku코ajima, gre코kama i paralelnom obradom automatski. Posebno je koristan za kreiranje slo쬰nih radnih tokova koji uklju캜uju vi코e koraka i ta캜aka odlu캜ivanja, jer mo쬰 lako upravljati protokom podataka i stanjem izvr코enja preko servisa. Glavni slu캜ajevi upotrebe koji se mogu izvr코iti ovim servisom su slede캖i:

- **Obrada podataka**: Obrada fajlova, video i slika; ekstrakcija, transformacija i u캜itavanje (ETL) poslova; i obrada u serijama i radni tereti visokih performansi (HPC).
- **Ma코insko u캜enje**: Detekcija prevare, prilago캠avanje, preporuke i oboga캖ivanje podataka.
- **Orkestracija mikroservisa**: Sinkroni ili realno-vremenski radni tokovi i orkestracija kontejnera.
- **IT i automatizacija bezbednosti**: Auto-popravka, implementacija i odgovor; i ljudska odobrenja i eskalacija.

## Klju캜ni koncepti

### Standardni vs. Ekspres radni tokovi

AWS Step Functions nudi dva tipa **state machine radnih tokova**: Standardne i Ekspres.

- **Standardni radni tok**: Ovaj podrazumevani tip radnog toka je dizajniran za dugotrajne, trajne i proverljive procese. Podr쬬va **ta캜no jednom izvr코enje**, obezbe캠uju캖i da zadaci budu izvr코eni samo jednom osim ako nisu navedeni ponovni poku코aji. Idealno je za radne tokove koji zahtevaju detaljnu istoriju izvr코enja i mogu se izvr코avati do jedne godine.
- **Ekspres radni tok**: Ovaj tip je idealan za zadatke visokog obima i kratkog trajanja, koji se izvr코avaju do pet minuta. Podr쬬vaju **barem jednom izvr코enje**, pogodni za idempotentne zadatke poput obrade podataka. Ovi radni tokovi su optimizovani za tro코kove i performanse, napla캖uju캖i se na osnovu izvr코enja, trajanja i kori코캖enja memorije.

### Stanja

Stanja su osnovne jedinice state machine-ova. Defini코u pojedina캜ne korake unutar radnog toka, mogu캖i su da obavljaju razli캜ite funkcije u zavisnosti od njihovog tipa:

- **Zadatak:** Izvr코ava posao, 캜esto koriste캖i AWS servis poput Lambda.
- **Izbor:** Donosi odluke na osnovu ulaza.
- **Neuspeh/Uspelo:** Zavr코ava izvr코enje sa neuspehom ili uspehom.
- **Pro캠i:** Prosle캠uje ulaz na izlaz ili ubacuje podatke.
- **캛ekanje:** Odla쬰 izvr코enje za odre캠eno vreme.
- **Paralelno:** Pokre캖e paralelne grane.
- **Mapiranje:** Dinami캜ki iterira korake preko stavki.

### Zadatak

Stanje **Zadatak** predstavlja jedinicu posla izvr코enu od strane state machine-a. Zadaci mogu pozivati razli캜ite resurse, uklju캜uju캖i aktivnosti, Lambda funkcije, AWS servise ili API-je tre캖ih strana.

- **Aktivnosti**: Prilago캠eni radnici koje upravljate, pogodni za dugotrajne procese.
- Resurs: **`arn:aws:states:region:account:activity:name`**.
- **Lambda funkcije**: Izvr코ava AWS Lambda funkcije.
- Resurs: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS Servisi**: Integrira se direktno sa drugim AWS servisima, poput DynamoDB ili S3.
- Resurs: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP Zadatak**: Poziva API-je tre캖ih strana.
- Polje resursa: **`arn:aws:states:::http:invoke`**. Zatim, treba obezbediti detalje konfiguracije API endpointa, kao 코to su URL API-ja, metoda i detalji za autentifikaciju.

Slede캖i primer prikazuje definiciju stanja Zadatak koji poziva Lambda funkciju nazvanu HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Izbor

Stanje **Izbor** dodaje uslovnu logiku u radni tok, omogu캖avaju캖i odluke zasnovane na ulaznim podacima. Vrednuje navedene uslove i prelazi na odgovaraju캖e stanje na osnovu rezultata.

- **Pore캠enje**: Svako pravilo izbora uklju캜uje operator pore캠enja (npr. **`NumericEquals`**, **`StringEquals`**) koji upore캠uje ulaznu promenljivu sa navedenom vredno코캖u ili drugom promenljivom.
- **Slede캖e polje**: Stanja izbora ne podr쬬vaju polje **`End`**, umesto toga, defini코u stanje **`Next`** na koje 캖e pre캖i ako je pore캠enje ta캜no.

Primer stanja **Izbor**:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Neuspeh/Uspes팳no

Stanje **`Fail`** zaustavlja izvr코avanje ma코ine stanja i ozna캜ava ga kao neuspeh. Koristi se za specificiranje imena gre코ke i uzroka, pru쬬ju캖i detalje o neuspehu. Ovo stanje je terminalno, 코to zna캜i da zavr코ava tok izvr코avanja.

Stanje **`Succeed`** zaustavlja izvr코avanje uspe코no. Obi캜no se koristi za zavr코etak radnog toka kada se uspe코no zavr코i. Ovo stanje ne zahteva polje **`Next`**.

{% tabs %}

{% tab title="Primer neuspeha" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Primer uspeha" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Pro캠i

**Pro캠i** stanje prosle캠uje svoj ulaz na izlaz ili bez obavljanja bilo kakvog posla ili transformacije JSON stanja ulaza koriste캖i filtere, a zatim prosle캠uje transformisane podatke slede캖em stanju. Korisno je za testiranje i konstruisanje ma코ina stanja, omogu캖avaju캖i vam da ubacite stati캜ne podatke ili ih transformi코ete.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### 캛ekaj

**캛ekaj** stanje odla쬰 izvr코enje ma코ine stanja na odre캠eno vreme. Postoje tri osnovna na캜ina za konfigurisanje vremena 캜ekanja:

- **X Sekundi**: Fiksni broj sekundi 캜ekanja.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "SledeceStanje"
}
```

- **Apsolutna Oznaka Vremena**: Ta캜no vreme 캜ekanja.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "SledeceStanje"
}
```

- **Dinami캜ko 캛ekanje**: Bazirano na ulazu kori코캖enjem **`SecondsPath`** ili **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.datumisteka",
"Next": "SledeceStanje"
}
```


### Paralelno

**Paralelno** stanje vam omogu캖ava da izvr코ite vi코e grana zadataka istovremeno unutar va코eg radnog toka. Svaka grana se izvr코ava nezavisno i obra캠uje svoj sopstveni niz stanja. Izvr코enje 캜eka dok sve grane ne zavr코e pre nego 코to pre캠e na slede캖e stanje. Klju캜na polja su:

- **Grane**: Niz koji defini코e paralelne izvr코ne putanje. Svaka grana je zasebna ma코ina stanja.
- **ResultPath**: Defini코e gde (u ulazu) postaviti kombinovani izlaz grana.
- **Retry i Catch**: Konfiguracije za rukovanje gre코kama za paralelno stanje.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

**Map** stan omogu캖ava izvr코avanje skupa koraka za svaku stavku u skupu podataka. Koristi se za paralelno procesiranje podataka. Zavisno od toga kako 쬰lite da obradite stavke skupa podataka, Step Functions pru쬬 slede캖e re쬴me:

- **Inline Mode**: Izvr코ava podskup stanja za svaku stavku JSON niza. Pogodno za male zadatke sa manje od 40 paralelnih iteracija, izvr코avaju캖i svaku od njih u kontekstu radnog toka koji sadr쬴 **`Map`** stanje.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Distributed Mode**: Namijenjen za paralelno procesiranje velikih razmera sa visokom konkurancijom. Podr쬬va obradu velikih skupova podataka, poput onih sme코tenih u Amazon S3, omogu캖avaju캖i visoku konkuranciju do 10.000 paralelnih izvr코avanja podradnih radnih tokova, izvr코avaju캖i ove podradne kao zasebno izvr코avanje.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Verzije i aliasi

Step Functions tako캠e omogu캖avaju upravljanje implementacijama radnih tokova putem **verzija** i **aliasa** stanja ma코ina. Verzija predstavlja snimak stanja ma코ine koji se mo쬰 izvr코iti. Alias slu쬴 kao pokaziva캜 na do dve verzije stanja ma코ine.

- **Verzije**: Ovi nepromenljivi snimci stanja ma코ine kreiraju se iz najnovije revizije te stanja ma코ine. Svaka verzija identifikovana je jedinstvenim ARN-om koji kombinuje ARN stanja ma코ine sa brojem verzije, razdvojenih dvota캜kom (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Verzije se ne mogu ure캠ivati, ali mo쬰te a쬿rirati stanje ma코ine i objaviti novu verziju, ili koristiti 쬰ljenu verziju stanja ma코ine.
- **Alias**: Ovi pokaziva캜i mogu referencirati do dve verzije iste stanja ma코ine. Mo쬰 se kreirati vi코e aliasa za jednu stanje ma코ine, svaki identifikovan jedinstvenim ARN-om konstruisanim kombinovanjem ARN stanja ma코ine sa imenom aliasa, razdvojenih dvota캜kom (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Alias omogu캖ava usmeravanje saobra캖aja izme캠u jedne od dve verzije stanja ma코ine. Alternativno, alias mo쬰 pokazivati na odre캠enu verziju stanja ma코ine, ali ne i na druge aliase. Mogu se a쬿rirati da preusmere na drugu verziju stanja ma코ine po potrebi, olak코avaju캖i kontrolisane implementacije i upravljanje radnim tokovima.

Za detaljnije informacije o **ASL**, proverite: [**Amazon States Language**](https://states-language.net/spec.html).



## IAM Uloge za Stanje ma코ina

AWS Step Functions koristi AWS Identity and Access Management (IAM) uloge za kontrolu pristupa resursima i akcijama unutar stanja ma코ina. Evo klju캜nih aspekata vezanih za bezbednost i IAM uloge u AWS Step Functions:

- **Izvr코na uloga**: Svaka stanje ma코ine u AWS Step Functions je povezana sa IAM izvr코nom ulogom. Ova uloga defini코e koje akcije stanje ma코ine mo쬰 izvr코iti u va코e ime. Kada stanje ma코ine prelazi izme캠u stanja koja interaguju sa AWS uslugama (poput pozivanja Lambda funkcija, pristupanja DynamoDB-u, itd.), preuzima ovu izvr코nu ulogu da sprovede te akcije.
- **Dozvole**: IAM izvr코na uloga mora biti konfigurisana sa dozvolama koje omogu캖avaju neophodne akcije na drugim AWS uslugama. Na primer, ako va코a stanje ma코ina treba da pozove AWS Lambda funkcije, IAM uloga mora imati dozvole **`lambda:InvokeFunction`**. Sli캜no tome, ako treba da pi코e u DynamoDB, odgovaraju캖e dozvole (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, itd.) moraju biti dodeljene.
- **Najmanje privilegije**: Preporu캜uje se da pratite princip najmanjih privilegija prilikom konfigurisanja IAM uloga za Step Functions. To zna캜i dodeljivanje samo dozvola neophodnih za stanje ma코ine da izvr코i svoje specifi캜ne akcije, i ni코ta vi코e. IAM politike treba da budu ograni캜ene na specifi캜ne resurse i akcije, smanjuju캖i rizik ne쬰ljenog pristupa.

## Enumeracija

ReadOnlyAccess politika je dovoljna za sve navedene akcije enumeracije.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Povi코enje privilegija

Na slede캖oj stranici mo쬰te proveriti kako **zloupotrebiti dozvole Step Functions-a za povi코enje privilegija**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post eksploatacija

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Reference

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
