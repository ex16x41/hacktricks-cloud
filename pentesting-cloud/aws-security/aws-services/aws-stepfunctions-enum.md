# AWS - Step Functions Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Step Functions

AWS Step Functions est un service de flux de travail qui vous permet de coordonner et d'orchestrer plusieurs services AWS en flux de travail sans serveur. En utilisant AWS Step Functions, vous pouvez concevoir et ex√©cuter des flux de travail qui connectent divers services AWS tels qu'AWS Lambda, Amazon S3, Amazon DynamoDB, et bien d'autres, dans une s√©quence d'√©tapes. Ce service d'orchestration fournit une interface de flux de travail visuelle et offre des capacit√©s de **machine d'√©tat**, vous permettant de d√©finir chaque √©tape du flux de travail de mani√®re d√©clarative en utilisant le **Amazon States Language** (ASL) bas√© sur JSON.

## Key concepts

### Standard vs. Express Workflows

AWS Step Functions propose deux types de **flux de travail de machine d'√©tat** : Standard et Express.

* **Standard Workflow** : Ce type de flux de travail par d√©faut est con√ßu pour des processus longs, durables et audit√©s. Il prend en charge l'**ex√©cution exactement une fois**, garantissant que les t√¢ches s'ex√©cutent une seule fois, sauf si des r√©essais sont sp√©cifi√©s. Il est id√©al pour les flux de travail n√©cessitant un historique d'ex√©cution d√©taill√© et peut fonctionner pendant jusqu'√† un an.
* **Express Workflow** : Ce type est id√©al pour des t√¢ches de volume √©lev√© et de courte dur√©e, fonctionnant jusqu'√† cinq minutes. Ils prennent en charge l'**ex√©cution au moins une fois**, adapt√©e aux t√¢ches idempotentes comme le traitement de donn√©es. Ces flux de travail sont optimis√©s pour le co√ªt et la performance, facturant en fonction des ex√©cutions, de la dur√©e et de l'utilisation de la m√©moire.

### States

Les √©tats sont les unit√©s essentielles des machines d'√©tat. Ils d√©finissent les √©tapes individuelles au sein d'un flux de travail, pouvant effectuer une vari√©t√© de fonctions selon leur type :

* **Task :** Ex√©cute un travail, souvent en utilisant un service AWS comme Lambda.
* **Choice :** Prend des d√©cisions bas√©es sur l'entr√©e.
* **Fail/Succeed :** Met fin √† l'ex√©cution avec un √©chec ou un succ√®s.
* **Pass :** Transmet l'entr√©e √† la sortie ou injecte des donn√©es.
* **Wait :** Retarde l'ex√©cution pendant un temps d√©fini.
* **Parallel :** Initie des branches parall√®les.
* **Map :** It√®re dynamiquement les √©tapes sur des √©l√©ments.

### Task

Un √©tat de **Task** repr√©sente une unit√© de travail unique ex√©cut√©e par une machine d'√©tat. Les t√¢ches peuvent invoquer diverses ressources, y compris des activit√©s, des fonctions Lambda, des services AWS ou des API tierces.

* **Activities** : Travailleurs personnalis√©s que vous g√©rez, adapt√©s aux processus longs.
* Resource : **`arn:aws:states:region:account:activity:name`**.
* **Lambda Functions** : Ex√©cute des fonctions AWS Lambda.
* Resource : **`arn:aws:lambda:region:account:function:function-name`**.
* **AWS Services** : S'int√®gre directement avec d'autres services AWS, comme DynamoDB ou S3.
* Resource : **`arn:partition:states:region:account:servicename:APIname`**.
* **HTTP Task** : Appelle des API tierces.
* Resource field : **`arn:aws:states:::http:invoke`**. Ensuite, vous devez fournir les d√©tails de configuration de l'endpoint API, tels que l'URL de l'API, la m√©thode et les d√©tails d'authentification.

L'exemple suivant montre une d√©finition d'√©tat de Task qui invoque une fonction Lambda appel√©e HelloWorld :
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

Un **Choice** √©tat ajoute une logique conditionnelle √† un flux de travail, permettant des d√©cisions bas√©es sur les donn√©es d'entr√©e. Il √©value les conditions sp√©cifi√©es et transitionne vers l'√©tat correspondant en fonction des r√©sultats.

* **Comparison**: Chaque r√®gle de choix inclut un op√©rateur de comparaison (par exemple, **`NumericEquals`**, **`StringEquals`**) qui compare une variable d'entr√©e √† une valeur sp√©cifi√©e ou √† une autre variable.
* **Next Field**: Les √©tats de choix ne prennent pas en charge le champ **`End`**, au lieu de cela, ils d√©finissent l'√©tat **`Next`** vers lequel transitionner si la comparaison est vraie.

Exemple d'√©tat **Choice** :
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### √âchouer/R√©ussir

Un √©tat **`Fail`** arr√™te l'ex√©cution d'une machine d'√©tat et la marque comme un √©chec. Il est utilis√© pour sp√©cifier un nom d'erreur et une cause, fournissant des d√©tails sur l'√©chec. Cet √©tat est terminal, ce qui signifie qu'il met fin au flux d'ex√©cution.

Un √©tat **`Succeed`** arr√™te l'ex√©cution avec succ√®s. Il est g√©n√©ralement utilis√© pour terminer le flux de travail lorsqu'il se termine avec succ√®s. Cet √©tat ne n√©cessite pas de champ **`Next`**.

{% tabs %}
{% tab title="Exemple d'√©chec" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Exemple de r√©ussite" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
{% endtab %}
{% endtabs %}

### Pass

Un √©tat **Pass** transmet son entr√©e √† sa sortie soit sans effectuer de travail, soit en transformant l'entr√©e d'√©tat JSON √† l'aide de filtres, puis en passant les donn√©es transform√©es √† l'√©tat suivant. Il est utile pour tester et construire des machines d'√©tat, vous permettant d'injecter des donn√©es statiques ou de les transformer.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wait

Un **Wait** state retarde l'ex√©cution de la machine d'√©tat pour une dur√©e sp√©cifi√©e. Il existe trois m√©thodes principales pour configurer le temps d'attente :

*   **X Secondes** : Un nombre fixe de secondes √† attendre.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```
*   **Horodatage Absolu** : Un moment exact jusqu'auquel attendre.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```
*   **Attente Dynamique** : Bas√©e sur l'entr√©e utilisant **`SecondsPath`** ou **`TimestampPath`**.

```json
jsonCopiar c√≥digo
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```

### Parallel

Un **Parallel** state vous permet d'ex√©cuter plusieurs branches de t√¢ches simultan√©ment dans votre flux de travail. Chaque branche s'ex√©cute ind√©pendamment et traite sa propre s√©quence d'√©tats. L'ex√©cution attend que toutes les branches soient termin√©es avant de passer √† l'√©tat suivant. Ses champs cl√©s sont :

* **Branches** : Un tableau d√©finissant les chemins d'ex√©cution parall√®les. Chaque branche est une machine d'√©tat distincte.
* **ResultPath** : D√©finit o√π (dans l'entr√©e) placer la sortie combin√©e des branches.
* **Retry et Catch** : Configurations de gestion des erreurs pour l'√©tat parall√®le.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

Un **Map** √©tat permet l'ex√©cution d'un ensemble d'√©tapes pour chaque √©l√©ment d'un ensemble de donn√©es. Il est utilis√© pour le traitement parall√®le des donn√©es. Selon la mani√®re dont vous souhaitez traiter les √©l√©ments de l'ensemble de donn√©es, Step Functions propose les modes suivants :

*   **Inline Mode** : Ex√©cute un sous-ensemble d'√©tats pour chaque √©l√©ment du tableau JSON. Convient pour des t√¢ches √† petite √©chelle avec moins de 40 it√©rations parall√®les, ex√©cutant chacune d'elles dans le contexte du flux de travail contenant l'√©tat **`Map`**.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```
*   **Distributed Mode** : Con√ßu pour le traitement parall√®le √† grande √©chelle avec une haute concurrence. Prend en charge le traitement de grands ensembles de donn√©es, tels que ceux stock√©s dans Amazon S3, permettant une haute concurrence allant jusqu'√† 10 000 ex√©cutions de flux de travail enfants parall√®les, ex√©cutant ces enfants comme une ex√©cution enfant distincte.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```

### Versions and aliases

Step Functions vous permet √©galement de g√©rer les d√©ploiements de flux de travail via des **versions** et des **alias** de machines d'√©tat. Une version repr√©sente un instantan√© d'une machine d'√©tat qui peut √™tre ex√©cut√©. Les alias servent de pointeurs vers jusqu'√† deux versions d'une machine d'√©tat.

* **Versions** : Ces instantan√©s immuables d'une machine d'√©tat sont cr√©√©s √† partir de la r√©vision la plus r√©cente de cette machine d'√©tat. Chaque version est identifi√©e par un ARN unique qui combine l'ARN de la machine d'√©tat avec le num√©ro de version, s√©par√©s par un deux-points (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Les versions ne peuvent pas √™tre modifi√©es, mais vous pouvez mettre √† jour la machine d'√©tat et publier une nouvelle version, ou utiliser la version de machine d'√©tat souhait√©e.
* **Aliases** : Ces pointeurs peuvent r√©f√©rencer jusqu'√† deux versions de la m√™me machine d'√©tat. Plusieurs alias peuvent √™tre cr√©√©s pour une seule machine d'√©tat, chacun identifi√© par un ARN unique construit en combinant l'ARN de la machine d'√©tat avec le nom de l'alias, s√©par√©s par un deux-points (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Les alias permettent de router le trafic entre l'une des deux versions d'une machine d'√©tat. Alternativement, un alias peut pointer vers une version sp√©cifique de la machine d'√©tat, mais pas vers d'autres alias. Ils peuvent √™tre mis √† jour pour rediriger vers une version diff√©rente de la machine d'√©tat si n√©cessaire, facilitant les d√©ploiements contr√¥l√©s et la gestion des flux de travail.

Pour des informations plus d√©taill√©es sur **ASL**, consultez : [**Amazon States Language**](https://states-language.net/spec.html).

## IAM Roles for State machines

AWS Step Functions utilise les r√¥les AWS Identity and Access Management (IAM) pour contr√¥ler l'acc√®s aux ressources et aux actions au sein des machines d'√©tat. Voici les aspects cl√©s li√©s √† la s√©curit√© et aux r√¥les IAM dans AWS Step Functions :

* **Execution Role** : Chaque machine d'√©tat dans AWS Step Functions est associ√©e √† un r√¥le d'ex√©cution IAM. Ce r√¥le d√©finit quelles actions la machine d'√©tat peut effectuer en votre nom. Lorsqu'une machine d'√©tat passe d'√©tats qui interagissent avec les services AWS (comme invoquer des fonctions Lambda, acc√©der √† DynamoDB, etc.), elle assume ce r√¥le d'ex√©cution pour r√©aliser ces actions.
* **Permissions** : Le r√¥le d'ex√©cution IAM doit √™tre configur√© avec des permissions qui permettent les actions n√©cessaires sur d'autres services AWS. Par exemple, si votre machine d'√©tat doit invoquer des fonctions AWS Lambda, le r√¥le IAM doit avoir des permissions **`lambda:InvokeFunction`**. De m√™me, si elle doit √©crire dans DynamoDB, des permissions appropri√©es (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, etc.) doivent √™tre accord√©es.

## Enumeration

La politique ReadOnlyAccess est suffisante pour toutes les actions d'√©num√©ration suivantes.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List versions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve information about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution (output included)
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified step Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Dans la page suivante, vous pouvez v√©rifier comment **abuser des permissions des Step Functions pour escalader les privil√®ges** :

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation.md" %}
[aws-stepfunctions-post-exploitation.md](../aws-post-exploitation/aws-stepfunctions-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-step-functions-persistence.md" %}
[aws-step-functions-persistence.md](../aws-persistence/aws-step-functions-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* V√©rifiez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
