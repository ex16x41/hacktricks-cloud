# AWS - Step Functions Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Step Functions

AWS Step Functionsã¯ã€è¤‡æ•°ã®AWSã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«èª¿æ•´ãŠã‚ˆã³ç·¨æˆã™ã‚‹ãŸã‚ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚AWS Step Functionsã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€AWS Lambdaã€Amazon S3ã€Amazon DynamoDBãªã©ã®ã•ã¾ã–ã¾ãªAWSã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¥ç¶šã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è¨­è¨ˆãŠã‚ˆã³å®Ÿè¡Œã§ãã¾ã™ã€‚ã“ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€è¦–è¦šçš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã€**ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³**æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€JSONãƒ™ãƒ¼ã‚¹ã®**Amazon States Language**ï¼ˆASLï¼‰ã‚’ä½¿ç”¨ã—ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å„ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®£è¨€çš„ã«å®šç¾©ã§ãã¾ã™ã€‚

## Key concepts

### Standard vs. Express Workflows

AWS Step Functionsã¯ã€2ç¨®é¡ã®**ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**ã‚’æä¾›ã—ã¾ã™ï¼šStandardã¨Expressã€‚

* **Standard Workflow**: ã“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¿ã‚¤ãƒ—ã¯ã€é•·æ™‚é–“å®Ÿè¡Œã•ã‚Œã‚‹ã€è€ä¹…æ€§ãŒã‚ã‚Šã€ç›£æŸ»å¯èƒ½ãªãƒ—ãƒ­ã‚»ã‚¹å‘ã‘ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚**æ­£ç¢ºã«1å›ã®å®Ÿè¡Œ**ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€ãƒªãƒˆãƒ©ã‚¤ãŒæŒ‡å®šã•ã‚Œãªã„é™ã‚Šã€ã‚¿ã‚¹ã‚¯ã¯1å›ã ã‘å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚è©³ç´°ãªå®Ÿè¡Œå±¥æ­´ãŒå¿…è¦ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«æœ€é©ã§ã€æœ€å¤§1å¹´é–“å®Ÿè¡Œã§ãã¾ã™ã€‚
* **Express Workflow**: ã“ã®ã‚¿ã‚¤ãƒ—ã¯ã€é«˜ãƒœãƒªãƒ¥ãƒ¼ãƒ ã§çŸ­æœŸé–“ã®ã‚¿ã‚¹ã‚¯ã«æœ€é©ã§ã€æœ€å¤§5åˆ†é–“å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚**å°‘ãªãã¨ã‚‚1å›ã®å®Ÿè¡Œ**ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®ã‚ˆã†ãªå†ªç­‰æ€§ã®ã‚ã‚‹ã‚¿ã‚¹ã‚¯ã«é©ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€ã‚³ã‚¹ãƒˆã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–ãŒè¡Œã‚ã‚Œã¦ãŠã‚Šã€å®Ÿè¡Œã€æœŸé–“ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã«åŸºã¥ã„ã¦èª²é‡‘ã•ã‚Œã¾ã™ã€‚

### States

ã‚¹ãƒ†ãƒ¼ãƒˆã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®åŸºæœ¬å˜ä½ã§ã™ã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã®å€‹ã€…ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®šç¾©ã—ã€ãã®ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã•ã¾ã–ã¾ãªæ©Ÿèƒ½ã‚’å®Ÿè¡Œã§ãã¾ã™ï¼š

* **Task:** ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã—ã€é€šå¸¸ã¯Lambdaã®ã‚ˆã†ãªAWSã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
* **Choice:** å…¥åŠ›ã«åŸºã¥ã„ã¦æ±ºå®šã‚’ä¸‹ã—ã¾ã™ã€‚
* **Fail/Succeed:** å®Ÿè¡Œã‚’å¤±æ•—ã¾ãŸã¯æˆåŠŸã§çµ‚äº†ã—ã¾ã™ã€‚
* **Pass:** å…¥åŠ›ã‚’å‡ºåŠ›ã«æ¸¡ã™ã‹ã€ãƒ‡ãƒ¼ã‚¿ã‚’æ³¨å…¥ã—ã¾ã™ã€‚
* **Wait:** è¨­å®šã•ã‚ŒãŸæ™‚é–“ã ã‘å®Ÿè¡Œã‚’é…å»¶ã•ã›ã¾ã™ã€‚
* **Parallel:** ä¸¦åˆ—ãƒ–ãƒ©ãƒ³ãƒã‚’é–‹å§‹ã—ã¾ã™ã€‚
* **Map:** ã‚¢ã‚¤ãƒ†ãƒ ã«å¯¾ã—ã¦ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‹•çš„ã«åå¾©ã—ã¾ã™ã€‚

### Task

**Task**ã‚¹ãƒ†ãƒ¼ãƒˆã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹å˜ä¸€ã®ä½œæ¥­å˜ä½ã‚’è¡¨ã—ã¾ã™ã€‚ã‚¿ã‚¹ã‚¯ã¯ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã€Lambdaé–¢æ•°ã€AWSã‚µãƒ¼ãƒ“ã‚¹ã€ã¾ãŸã¯ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£APIãªã©ã€ã•ã¾ã–ã¾ãªãƒªã‚½ãƒ¼ã‚¹ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

* **Activities**: ã‚ãªãŸãŒç®¡ç†ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ã‚«ãƒ¼ã§ã€é•·æ™‚é–“å®Ÿè¡Œã•ã‚Œã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã«é©ã—ã¦ã„ã¾ã™ã€‚
* ãƒªã‚½ãƒ¼ã‚¹: **`arn:aws:states:region:account:activity:name`**ã€‚
* **Lambda Functions**: AWS Lambdaé–¢æ•°ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
* ãƒªã‚½ãƒ¼ã‚¹: **`arn:aws:lambda:region:account:function:function-name`**ã€‚
* **AWS Services**: DynamoDBã‚„S3ãªã©ã€ä»–ã®AWSã‚µãƒ¼ãƒ“ã‚¹ã¨ç›´æ¥çµ±åˆã—ã¾ã™ã€‚
* ãƒªã‚½ãƒ¼ã‚¹: **`arn:partition:states:region:account:servicename:APIname`**ã€‚
* **HTTP Task**: ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£APIã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
* ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: **`arn:aws:states:::http:invoke`**ã€‚æ¬¡ã«ã€APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ§‹æˆè©³ç´°ï¼ˆAPI URLã€ãƒ¡ã‚½ãƒƒãƒ‰ã€èªè¨¼è©³ç´°ãªã©ï¼‰ã‚’æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã¯ã€HelloWorldã¨ã„ã†Lambdaé–¢æ•°ã‚’å‘¼ã³å‡ºã™Taskã‚¹ãƒ†ãƒ¼ãƒˆã®å®šç¾©ã‚’ç¤ºã—ã¦ã„ã¾ã™ï¼š
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

**Choice** ã‚¹ãƒ†ãƒ¼ãƒˆã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«æ¡ä»¶ä»˜ããƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã—ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦æ±ºå®šã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚æŒ‡å®šã•ã‚ŒãŸæ¡ä»¶ã‚’è©•ä¾¡ã—ã€çµæœã«åŸºã¥ã„ã¦å¯¾å¿œã™ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆã«é·ç§»ã—ã¾ã™ã€‚

* **Comparison**: å„é¸æŠãƒ«ãƒ¼ãƒ«ã«ã¯ã€å…¥åŠ›å¤‰æ•°ã‚’æŒ‡å®šã•ã‚ŒãŸå€¤ã¾ãŸã¯åˆ¥ã®å¤‰æ•°ã¨æ¯”è¼ƒã™ã‚‹æ¯”è¼ƒæ¼”ç®—å­ï¼ˆä¾‹ï¼š**`NumericEquals`**ã€**`StringEquals`**ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
* **Next Field**: Choice ã‚¹ãƒ†ãƒ¼ãƒˆã¯ **`End`** ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«ã€æ¯”è¼ƒãŒçœŸã§ã‚ã‚‹å ´åˆã«é·ç§»ã™ã‚‹ **`Next`** ã‚¹ãƒ†ãƒ¼ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚

Example of **Choice** state:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### å¤±æ•—/æˆåŠŸ

**`Fail`** ã‚¹ãƒ†ãƒ¼ãƒˆã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®å®Ÿè¡Œã‚’åœæ­¢ã—ã€ãã‚Œã‚’å¤±æ•—ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚¨ãƒ©ãƒ¼åã¨åŸå› ã‚’æŒ‡å®šã—ã€å¤±æ•—ã«é–¢ã™ã‚‹è©³ç´°ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¹ãƒ†ãƒ¼ãƒˆã¯çµ‚ç«¯ã§ã‚ã‚Šã€å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã‚’çµ‚äº†ã—ã¾ã™ã€‚

**`Succeed`** ã‚¹ãƒ†ãƒ¼ãƒˆã¯ã€å®Ÿè¡Œã‚’æˆåŠŸè£ã«åœæ­¢ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæˆåŠŸè£ã«å®Œäº†ã—ãŸã¨ãã«çµ‚äº†ã™ã‚‹ãŸã‚ã«é€šå¸¸ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¹ãƒ†ãƒ¼ãƒˆã¯ **`Next`** ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¿…è¦ã¨ã—ã¾ã›ã‚“ã€‚

{% tabs %}
{% tab title="å¤±æ•—ã®ä¾‹" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="æˆåŠŸä¾‹" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
{% endtab %}
{% endtabs %}

### Pass

**Pass**ã‚¹ãƒ†ãƒ¼ãƒˆã¯ã€ä½œæ¥­ã‚’è¡Œã†ã“ã¨ãªãã€ã¾ãŸã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦JSONã‚¹ãƒ†ãƒ¼ãƒˆå…¥åŠ›ã‚’å¤‰æ›ã—ã€ãã®å¤‰æ›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’æ¬¡ã®ã‚¹ãƒ†ãƒ¼ãƒˆã«æ¸¡ã™ã“ã¨ã«ã‚ˆã£ã¦ã€å…¥åŠ›ã‚’å‡ºåŠ›ã«æ¸¡ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€é™çš„ãƒ‡ãƒ¼ã‚¿ã‚’æ³¨å…¥ã—ãŸã‚Šå¤‰æ›ã—ãŸã‚Šã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®ãƒ†ã‚¹ãƒˆã‚„æ§‹ç¯‰ã«å½¹ç«‹ã¡ã¾ã™ã€‚
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wait

**Wait**ã‚¹ãƒ†ãƒ¼ãƒˆã¯ã€æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®å®Ÿè¡Œã‚’é…å»¶ã•ã›ã¾ã™ã€‚å¾…æ©Ÿæ™‚é–“ã‚’è¨­å®šã™ã‚‹ãŸã‚ã®ä¸»ãªæ–¹æ³•ã¯3ã¤ã‚ã‚Šã¾ã™ï¼š

*   **Xç§’**: å¾…æ©Ÿã™ã‚‹å›ºå®šã®ç§’æ•°ã€‚

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```
*   **çµ¶å¯¾ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: å¾…æ©Ÿã™ã‚‹æ­£ç¢ºãªæ™‚é–“ã€‚

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```
*   **å‹•çš„å¾…æ©Ÿ**: **`SecondsPath`**ã¾ãŸã¯**`TimestampPath`**ã‚’ä½¿ç”¨ã—ã¦å…¥åŠ›ã«åŸºã¥ãã€‚

```json
jsonCopiar cÃ³digo
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```

### Parallel

**Parallel**ã‚¹ãƒ†ãƒ¼ãƒˆã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã§è¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ã®ãƒ–ãƒ©ãƒ³ãƒã‚’åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚å„ãƒ–ãƒ©ãƒ³ãƒã¯ç‹¬ç«‹ã—ã¦å®Ÿè¡Œã•ã‚Œã€ãã‚Œãã‚Œã®ã‚¹ãƒ†ãƒ¼ãƒˆã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’å‡¦ç†ã—ã¾ã™ã€‚å®Ÿè¡Œã¯ã€ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿã—ã€ãã®å¾Œæ¬¡ã®ã‚¹ãƒ†ãƒ¼ãƒˆã«é€²ã¿ã¾ã™ã€‚ä¸»ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

* **Branches**: ä¸¦åˆ—å®Ÿè¡Œãƒ‘ã‚¹ã‚’å®šç¾©ã™ã‚‹é…åˆ—ã€‚å„ãƒ–ãƒ©ãƒ³ãƒã¯åˆ¥ã€…ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã§ã™ã€‚
* **ResultPath**: ãƒ–ãƒ©ãƒ³ãƒã®çµåˆå‡ºåŠ›ã‚’ã©ã“ã«ï¼ˆå…¥åŠ›å†…ã§ï¼‰é…ç½®ã™ã‚‹ã‹ã‚’å®šç¾©ã—ã¾ã™ã€‚
* **Retry and Catch**: ä¸¦åˆ—ã‚¹ãƒ†ãƒ¼ãƒˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­å®šã€‚
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### ãƒãƒƒãƒ—

**Map** ã‚¹ãƒ†ãƒ¼ãƒˆã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå†…ã®å„ã‚¢ã‚¤ãƒ†ãƒ ã«å¯¾ã—ã¦ä¸€é€£ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã®ä¸¦åˆ—å‡¦ç†ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã©ã®ã‚ˆã†ã«å‡¦ç†ã—ãŸã„ã‹ã«å¿œã˜ã¦ã€Step Functions ã¯ä»¥ä¸‹ã®ãƒ¢ãƒ¼ãƒ‰ã‚’æä¾›ã—ã¾ã™ã€‚

*   **ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰**: å„ JSON é…åˆ—ã‚¢ã‚¤ãƒ†ãƒ ã«å¯¾ã—ã¦ã‚¹ãƒ†ãƒ¼ãƒˆã®ã‚µãƒ–ã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚40 æœªæº€ã®ä¸¦åˆ—åå¾©ã‚’æŒã¤å°è¦æ¨¡ãªã‚¿ã‚¹ã‚¯ã«é©ã—ã¦ãŠã‚Šã€**`Map`** ã‚¹ãƒ†ãƒ¼ãƒˆã‚’å«ã‚€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã§ãã‚Œãã‚Œã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```
*   **åˆ†æ•£ãƒ¢ãƒ¼ãƒ‰**: é«˜ã„åŒæ™‚å®Ÿè¡Œæ€§ã‚’æŒã¤å¤§è¦æ¨¡ãªä¸¦åˆ—å‡¦ç†ã®ãŸã‚ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚Amazon S3 ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªå¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®å‡¦ç†ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€æœ€å¤§ 10,000 ã®ä¸¦åˆ—å­ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’å®Ÿè¡Œã—ã€ã“ã‚Œã‚‰ã®å­ã‚’åˆ¥ã®å­å®Ÿè¡Œã¨ã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¨ã‚¤ãƒªã‚¢ã‚¹

Step Functions ã¯ã€**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã¨**ã‚¨ã‚¤ãƒªã‚¢ã‚¹**ã‚’é€šã˜ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’ç®¡ç†ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€å®Ÿè¡Œå¯èƒ½ãªã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’è¡¨ã—ã¾ã™ã€‚ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®æœ€å¤§ 2 ã¤ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚

* **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ã“ã‚Œã‚‰ã®ä¸å¤‰ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¯ã€ãã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®æœ€æ–°ã®æ”¹è¨‚ã‹ã‚‰ä½œæˆã•ã‚Œã¾ã™ã€‚å„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ ARN ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’ã‚³ãƒ­ãƒ³ã§åŒºåˆ‡ã£ã¦çµ„ã¿åˆã‚ã›ãŸä¸€æ„ã® ARN ã«ã‚ˆã£ã¦è­˜åˆ¥ã•ã‚Œã¾ã™ (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**)ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ç·¨é›†ã§ãã¾ã›ã‚“ãŒã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’æ›´æ–°ã—ã¦æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¬é–‹ã™ã‚‹ã‹ã€å¸Œæœ›ã™ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚
* **ã‚¨ã‚¤ãƒªã‚¢ã‚¹**: ã“ã‚Œã‚‰ã®ãƒã‚¤ãƒ³ã‚¿ã¯ã€åŒã˜ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®æœ€å¤§ 2 ã¤ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å‚ç…§ã§ãã¾ã™ã€‚å˜ä¸€ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã«å¯¾ã—ã¦è¤‡æ•°ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½œæˆã§ãã€ãã‚Œãã‚Œã¯ã‚¨ã‚¤ãƒªã‚¢ã‚¹åã¨ã‚³ãƒ­ãƒ³ã§åŒºåˆ‡ã‚‰ã‚ŒãŸã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ ARN ã‚’çµ„ã¿åˆã‚ã›ãŸä¸€æ„ã® ARN ã«ã‚ˆã£ã¦è­˜åˆ¥ã•ã‚Œã¾ã™ (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**)ã€‚ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã® 2 ã¤ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã„ãšã‚Œã‹ã®é–“ã§ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã‚ã‚‹ã„ã¯ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡ã™ã“ã¨ãŒã§ãã¾ã™ãŒã€ä»–ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã«ã¯æŒ‡ã—ã¾ã›ã‚“ã€‚å¿…è¦ã«å¿œã˜ã¦ã€ç•°ãªã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚ˆã†ã«æ›´æ–°ã§ãã€åˆ¶å¾¡ã•ã‚ŒãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç®¡ç†ã‚’ä¿ƒé€²ã—ã¾ã™ã€‚

**ASL** ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã«ã¤ã„ã¦ã¯ã€æ¬¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„: [**Amazon States Language**](https://states-language.net/spec.html)ã€‚

## ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®ãŸã‚ã® IAM ãƒ­ãƒ¼ãƒ«

AWS Step Functions ã¯ã€AWS Identity and Access Management (IAM) ãƒ­ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å†…ã®ãƒªã‚½ãƒ¼ã‚¹ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚AWS Step Functions ã«ãŠã‘ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ IAM ãƒ­ãƒ¼ãƒ«ã«é–¢é€£ã™ã‚‹ä¸»ãªå´é¢ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

* **å®Ÿè¡Œãƒ­ãƒ¼ãƒ«**: AWS Step Functions ã®å„ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã¯ã€IAM å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ãƒ­ãƒ¼ãƒ«ã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ãŒã‚ãªãŸã®ä»£ã‚ã‚Šã«å®Ÿè¡Œã§ãã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã—ã¾ã™ã€‚ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ãŒ AWS ã‚µãƒ¼ãƒ“ã‚¹ã¨ç›¸äº’ä½œç”¨ã™ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆé–“ã‚’é·ç§»ã™ã‚‹éš›ï¼ˆLambda é–¢æ•°ã®å‘¼ã³å‡ºã—ã€DynamoDB ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãªã©ï¼‰ã€ã“ã®å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã‚’å¼•ãå—ã‘ã¦ãã‚Œã‚‰ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
* **æ¨©é™**: IAM å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã¯ã€ä»–ã® AWS ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾ã™ã‚‹å¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨±å¯ã™ã‚‹æ¨©é™ã§æ§‹æˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ãŒ AWS Lambda é–¢æ•°ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹å ´åˆã€IAM ãƒ­ãƒ¼ãƒ«ã«ã¯ **`lambda:InvokeFunction`** æ¨©é™ãŒå¿…è¦ã§ã™ã€‚åŒæ§˜ã«ã€DynamoDB ã«æ›¸ãè¾¼ã‚€å¿…è¦ãŒã‚ã‚‹å ´åˆã€é©åˆ‡ãªæ¨©é™ (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`** ãªã©) ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## åˆ—æŒ™

ReadOnlyAccess ãƒãƒªã‚·ãƒ¼ã¯ã€ä»¥ä¸‹ã®ã™ã¹ã¦ã®åˆ—æŒ™ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ååˆ†ã§ã™ã€‚
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List versions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve information about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution (output included)
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified step Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€**Step Functionsã®æ¨©é™ã‚’æ‚ªç”¨ã—ã¦ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹æ–¹æ³•**ã‚’ç¢ºèªã§ãã¾ã™ï¼š

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation.md" %}
[aws-stepfunctions-post-exploitation.md](../aws-post-exploitation/aws-stepfunctions-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-step-functions-persistence.md" %}
[aws-step-functions-persistence.md](../aws-persistence/aws-step-functions-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
