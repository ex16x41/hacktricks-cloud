# AWS - Step Functions Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Step Functions

AWS Step Functions je servis za radne tokove koji vam omogu캖ava da koordinirate i orkestrirate vi코e AWS servisa u serverless radne tokove. Kori코캖enjem AWS Step Functions, mo쬰te dizajnirati i pokretati radne tokove koji povezuju razli캜ite AWS servise kao 코to su AWS Lambda, Amazon S3, Amazon DynamoDB i mnoge druge, u nizu koraka. Ova orkestracija pru쬬 vizuelni interfejs radnog toka i nudi **state machine** mogu캖nosti, omogu캖avaju캖i vam da defini코ete svaki korak radnog toka na deklarativan na캜in koriste캖i JSON-bazirani **Amazon States Language** (ASL).

## Key concepts

### Standard vs. Express Workflows

AWS Step Functions nudi dva tipa **state machine workflows**: Standard i Express.

* **Standard Workflow**: Ova podrazumevana vrsta radnog toka je dizajnirana za dugotrajne, trajne i auditable procese. Podr쬬va **exactly-once execution**, osiguravaju캖i da se zadaci izvr코avaju samo jednom osim ako nisu navedeni ponovni poku코aji. Idealna je za radne tokove kojima je potrebna detaljna istorija izvr코enja i mo쬰 trajati do jedne godine.
* **Express Workflow**: Ova vrsta je idealna za zadatke visokog obima i kratkog trajanja, koji traju do pet minuta. Podr쬬vaju **at-least-once execution**, pogodna za idempotentne zadatke kao 코to je obrada podataka. Ovi radni tokovi su optimizovani za tro코kove i performanse, napla캖uju캖i na osnovu izvr코enja, trajanja i kori코캖enja memorije.

### States

States su osnovne jedinice state ma코ina. Defini코u pojedina캜ne korake unutar radnog toka, mogu캖i su da izvr코avaju razne funkcije u zavisnosti od tipa:

* **Task:** Izvr코ava posao, 캜esto koriste캖i AWS servis kao 코to je Lambda.
* **Choice:** Donosi odluke na osnovu ulaza.
* **Fail/Succeed:** Zavr코ava izvr코enje neuspehom ili uspehom.
* **Pass:** Prosle캠uje ulaz na izlaz ili ubacuje podatke.
* **Wait:** Odla쬰 izvr코enje na odre캠eno vreme.
* **Parallel:** Pokre캖e paralelne grane.
* **Map:** Dinami캜ki iterira korake preko stavki.

### Task

**Task** state predstavlja jednu jedinicu posla koju izvr코ava state ma코ina. Zadaci mogu pozivati razli캜ite resurse, uklju캜uju캖i aktivnosti, Lambda funkcije, AWS servise ili API-je tre캖ih strana.

* **Activities**: Prilago캠eni radnici koje upravljate, pogodni za dugotrajne procese.
* Resource: **`arn:aws:states:region:account:activity:name`**.
* **Lambda Functions**: Izvr코ava AWS Lambda funkcije.
* Resource: **`arn:aws:lambda:region:account:function:function-name`**.
* **AWS Services**: Integrira se direktno sa drugim AWS servisima, kao 코to su DynamoDB ili S3.
* Resource: **`arn:partition:states:region:account:servicename:APIname`**.
* **HTTP Task**: Poziva API-je tre캖ih strana.
* Resource field: **`arn:aws:states:::http:invoke`**. Zatim, trebate pru쬴ti detalje konfiguracije API endpoint-a, kao 코to su API URL, metoda i detalji autentifikacije.

Slede캖i primer prikazuje definiciju Task state koja poziva Lambda funkciju pod nazivom HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

**Choice** stanje dodaje uslovnu logiku u radni tok, omogu캖avaju캖i odluke na osnovu ulaznih podataka. Evaluira navedene uslove i prelazi u odgovaraju캖e stanje na osnovu rezultata.

* **Pore캠enje**: Svako pravilo izbora uklju캜uje operator pore캠enja (npr., **`NumericEquals`**, **`StringEquals`**) koji upore캠uje ulaznu promenljivu sa navedenom vredno코캖u ili drugom promenljivom.
* **Next Field**: Choice stanja ne podr쬬vaju **`End`** polje, umesto toga defini코u **`Next`** stanje u koje prelaze ako je pore캠enje ta캜no.

Primer **Choice** stanja:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fail/Succeed

A **`Fail`** stanje zaustavlja izvr코enje ma코ine stanja i ozna캜ava je kao neuspeh. Koristi se za specificiranje imena gre코ke i uzroka, pru쬬ju캖i detalje o neuspehu. Ovo stanje je terminalno, 코to zna캜i da zavr코ava tok izvr코enja.

A **`Succeed`** stanje uspe코no zaustavlja izvr코enje. Obi캜no se koristi za zavr코avanje radnog toka kada se uspe코no zavr코i. Ovo stanje ne zahteva **`Next`** polje.

{% tabs %}
{% tab title="Fail example" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Primer uspeha" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
{% endtab %}
{% endtabs %}

### Pass

**Pass** stanje prenosi svoj ulaz na svoj izlaz ili bez obavljanja bilo kakvog posla ili transformi코u캖i JSON ulaz stanja koriste캖i filtre, a zatim prenosi transformisane podatke na slede캖e stanje. Korisno je za testiranje i konstruisanje stanja ma코ina, omogu캖avaju캖i vam da umetnete stati캜ke podatke ili ih transformi코ete.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wait

A **Wait** stanje odla쬰 izvr코enje ma코ine stanja na odre캠eni vremenski period. Postoje tri osnovne metode za pode코avanje vremena 캜ekanja:

*   **X Sekundi**: Fiksan broj sekundi za 캜ekanje.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```
*   **Apsolutni Vremenski Pe캜at**: Ta캜no vreme do kada treba 캜ekati.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```
*   **Dinami캜ko 캛ekanje**: Na osnovu ulaza koriste캖i **`SecondsPath`** ili **`TimestampPath`**.

```json
jsonCopiar c칩digo
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```

### Parallel

A **Parallel** stanje omogu캖ava vam da izvr코avate vi코e grana zadataka istovremeno unutar va코eg radnog toka. Svaka grana se izvr코ava nezavisno i obra캠uje svoju vlastitu sekvencu stanja. Izvr코enje 캜eka dok sve grane ne zavr코e pre nego 코to pre캠e na slede캖e stanje. Njegova klju캜na polja su:

* **Grane**: Niz koji defini코e paralelne putanje izvr코enja. Svaka grana je posebna ma코ina stanja.
* **ResultPath**: Defini코e gde (u ulazu) da se postavi kombinovani izlaz grana.
* **Retry i Catch**: Konfiguracije za obradu gre코aka za paralelno stanje.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

**Map** stanje omogu캖ava izvr코avanje skupa koraka za svaku stavku u skupu podataka. Koristi se za paralelno procesiranje podataka. U zavisnosti od toga kako 쬰lite da obradite stavke skupa podataka, Step Functions pru쬬 slede캖e re쬴me:

*   **Inline Mode**: Izvr코ava podskup stanja za svaku stavku JSON niza. Pogodno za male zadatke sa manje od 40 paralelnih iteracija, izvr코avaju캖i svaku od njih u kontekstu radnog toka koji sadr쬴 **`Map`** stanje.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```
*   **Distributed Mode**: Dizajniran za paralelno procesiranje velikih razmera sa visokom konkurencijom. Podr쬬va obradu velikih skupova podataka, kao 코to su oni pohranjeni u Amazon S3, omogu캖avaju캖i visoku konkurenciju do 10,000 paralelnih izvr코avanja radnog toka, izvr코avaju캖i ove decu kao odvojeno izvr코avanje.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```

### Versions and aliases

Step Functions tako캠e omogu캖ava upravljanje implementacijama radnog toka kroz **versions** i **aliases** ma코ine stanja. Verzija predstavlja snimak ma코ine stanja koji mo쬰 biti izvr코en. Alias slu쬴 kao pokaziva캜 na do dve verzije ma코ine stanja.

* **Versions**: Ovi nepromenljivi snimci ma코ine stanja kreiraju se iz najnovije revizije te ma코ine stanja. Svaka verzija se identifikuje jedinstvenim ARN-om koji kombinuje ARN ma코ine stanja sa brojem verzije, odvojenim dvota캜kom (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Verzije se ne mogu ure캠ivati, ali mo쬰te a쬿rirati ma코inu stanja i objaviti novu verziju, ili koristiti 쬰ljenu verziju ma코ine stanja.
* **Aliases**: Ovi pokaziva캜i mogu referencirati do dve verzije iste ma코ine stanja. Vi코e aliasa mo쬰 biti kreirano za jednu ma코inu stanja, svaki identifikovan jedinstvenim ARN-om konstruisanim kombinovanjem ARN ma코ine stanja sa imenom aliasa, odvojenim dvota캜kom (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Aliasi omogu캖avaju usmeravanje saobra캖aja izme캠u jedne od dve verzije ma코ine stanja. Alternativno, alias mo쬰 ukazivati na jednu specifi캜nu verziju ma코ine stanja, ali ne na druge alias-e. Mogu se a쬿rirati da preusmere na drugu verziju ma코ine stanja po potrebi, olak코avaju캖i kontrolisane implementacije i upravljanje radnim tokom.

Za detaljnije informacije o **ASL**, proverite: [**Amazon States Language**](https://states-language.net/spec.html).

## IAM Roles for State machines

AWS Step Functions koristi AWS Identity and Access Management (IAM) uloge za kontrolu pristupa resursima i akcijama unutar ma코ina stanja. Evo klju캜nih aspekata vezanih za bezbednost i IAM uloge u AWS Step Functions:

* **Execution Role**: Svaka ma코ina stanja u AWS Step Functions je povezana sa IAM ulogom za izvr코enje. Ova uloga defini코e koje akcije ma코ina stanja mo쬰 izvr코iti u va코e ime. Kada ma코ina stanja prelazi izme캠u stanja koja komuniciraju sa AWS uslugama (kao 코to je pozivanje Lambda funkcija, pristup DynamoDB, itd.), preuzima ovu ulogu za izvr코enje da bi izvr코ila te akcije.
* **Permissions**: IAM uloga za izvr코enje mora biti konfigurisana sa dozvolama koje omogu캖avaju neophodne akcije na drugim AWS uslugama. Na primer, ako va코a ma코ina stanja treba da pozove AWS Lambda funkcije, IAM uloga mora imati **`lambda:InvokeFunction`** dozvole. Sli캜no, ako treba da pi코e u DynamoDB, odgovaraju캖e dozvole (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, itd.) moraju biti dodeljene.

## Enumeration

ReadOnlyAccess politika je dovoljna za sve slede캖e akcije enumeracije.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List versions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve information about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution (output included)
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified step Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Na slede캖oj stranici mo쬰te proveriti kako da **zloupotrebite Step Functions dozvole za eskalaciju privilegija**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation.md" %}
[aws-stepfunctions-post-exploitation.md](../aws-post-exploitation/aws-stepfunctions-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-step-functions-persistence.md" %}
[aws-step-functions-persistence.md](../aws-persistence/aws-step-functions-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
