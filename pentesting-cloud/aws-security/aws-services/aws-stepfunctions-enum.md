# AWS - Enumeraci칩n de Step Functions

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Step Functions

AWS Step Functions es un servicio de flujo de trabajo que te permite coordinar y orquestar m칰ltiples servicios de AWS en flujos de trabajo sin servidor. Al utilizar AWS Step Functions, puedes dise침ar y ejecutar flujos de trabajo que conectan varios servicios de AWS como AWS Lambda, Amazon S3, Amazon DynamoDB y muchos m치s, en una secuencia de pasos. Este servicio de orquestaci칩n proporciona una interfaz visual de flujo de trabajo y ofrece capacidades de **m치quina de estados**, lo que te permite definir cada paso del flujo de trabajo de manera declarativa utilizando el **Lenguaje de Estados de Amazon** (ASL) basado en JSON.

AWS Step Functions simplifica el proceso de construir aplicaciones resilientes y escalables al gestionar la infraestructura subyacente, manejar reintentos, errores y procesamiento paralelo autom치ticamente. Es particularmente 칰til para crear flujos de trabajo complejos que involucran m칰ltiples pasos y puntos de decisi칩n, ya que puede gestionar f치cilmente el flujo de datos y el estado de ejecuci칩n entre servicios. Los principales casos de uso que se pueden realizar con este servicio son los siguientes:

- **Procesamiento de datos**: Procesamiento de archivos, videos e im치genes; extracci칩n, transformaci칩n y carga (ETL) de trabajos; y procesamiento por lotes y cargas de trabajo de computaci칩n de alto rendimiento (HPC).
- **Aprendizaje autom치tico**: Detecci칩n de fraudes, personalizaci칩n, recomendaci칩n y enriquecimiento de datos.
- **Orquestaci칩n de microservicios**: Flujos de trabajo s칤ncronos o en tiempo real y orquestaci칩n de contenedores.
- **Automatizaci칩n de TI y seguridad**: Auto-remediaci칩n, implementaci칩n y respuesta; y aprobaci칩n y escalada humana.

## Conceptos clave

### Flujos de trabajo est치ndar vs. Express

AWS Step Functions ofrece dos tipos de **flujos de trabajo de m치quina de estados**: Est치ndar y Express.

- **Flujo de trabajo est치ndar**: Este tipo de flujo de trabajo predeterminado est치 dise침ado para procesos duraderos, auditables y de larga duraci칩n. Admite **ejecuci칩n exactamente una vez**, asegurando que las tareas se ejecuten solo una vez a menos que se especifiquen reintentos. Es ideal para flujos de trabajo que necesitan un historial de ejecuci칩n detallado y puede ejecutarse hasta por un a침o.
- **Flujo de trabajo Express**: Este tipo es ideal para tareas de alta volumen y corta duraci칩n, que se ejecutan hasta cinco minutos. Admiten **ejecuci칩n al menos una vez**, adecuadas para tareas idempotentes como el procesamiento de datos. Estos flujos de trabajo est치n optimizados para costos y rendimiento, cobrando en funci칩n de las ejecuciones, la duraci칩n y el uso de memoria.

### Estados

Los estados son las unidades esenciales de las m치quinas de estados. Definen los pasos individuales dentro de un flujo de trabajo, pudiendo realizar una variedad de funciones seg칰n su tipo:

- **Tarea:** Ejecuta un trabajo, a menudo utilizando un servicio de AWS como Lambda.
- **Elecci칩n:** Toma decisiones basadas en la entrada.
- **Fallo/칄xito:** Finaliza la ejecuci칩n con un fallo o 칠xito.
- **Pasar:** Pasa la entrada a la salida o inyecta datos.
- **Esperar:** Retrasa la ejecuci칩n durante un tiempo establecido.
- **Paralelo:** Inicia ramas paralelas.
- **Mapa:** Itera din치micamente pasos sobre elementos.

### Tarea

Un estado de **Tarea** representa una unidad de trabajo 칰nica ejecutada por una m치quina de estados. Las tareas pueden invocar varios recursos, incluidas actividades, funciones Lambda, servicios de AWS o APIs de terceros.

- **Actividades**: Trabajadores personalizados que gestionas, adecuados para procesos de larga duraci칩n.
- Recurso: **`arn:aws:states:regi칩n:cuenta:actividad:nombre`**.
- **Funciones Lambda**: Ejecuta funciones Lambda de AWS.
- Recurso: **`arn:aws:lambda:regi칩n:cuenta:funci칩n:nombre-funci칩n`**.
- **Servicios de AWS**: Se integra directamente con otros servicios de AWS, como DynamoDB o S3.
- Recurso: **`arn:partici칩n:states:regi칩n:cuenta:nombreservicio:nombreAPI`**.
- **Tarea HTTP**: Llama a APIs de terceros.
- Campo de recurso: **`arn:aws:states:::http:invoke`**. Luego, debes proporcionar los detalles de configuraci칩n del punto final de la API, como la URL de la API, el m칠todo y los detalles de autenticaci칩n.

El siguiente ejemplo muestra la definici칩n de un estado de Tarea que invoca una funci칩n Lambda llamada HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Elecci칩n

Un estado de **Elecci칩n** agrega l칩gica condicional a un flujo de trabajo, permitiendo tomar decisiones basadas en datos de entrada. Eval칰a las condiciones especificadas y transiciona al estado correspondiente basado en los resultados.

- **Comparaci칩n**: Cada regla de elecci칩n incluye un operador de comparaci칩n (por ejemplo, **`NumericEquals`**, **`StringEquals`**) que compara una variable de entrada con un valor especificado u otra variable.
- **Campo Siguiente**: Los estados de elecci칩n no admiten el campo **`End`**, en su lugar, definen el estado **`Next`** al que se transicionar치 si la comparaci칩n es verdadera.

Ejemplo de estado de **Elecci칩n**:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fallar/칄xito

Un estado de **`Fallar`** detiene la ejecuci칩n de una m치quina de estados y la marca como fallida. Se utiliza para especificar un nombre de error y una causa, proporcionando detalles sobre el fallo. Este estado es terminal, lo que significa que termina el flujo de ejecuci칩n.

Un estado de **`칄xito`** detiene la ejecuci칩n exitosamente. Se utiliza t칤picamente para terminar el flujo de trabajo cuando se completa con 칠xito. Este estado no requiere un campo **`Siguiente`**.

{% tabs %}

{% tab title="Ejemplo de Fallar" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Ejemplo de 칠xito" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Paso

Un estado de **Paso** pasa su entrada a su salida ya sea sin realizar ning칰n trabajo o transformando la entrada de estado JSON usando filtros, y luego pasando los datos transformados al siguiente estado. Es 칰til para probar y construir m치quinas de estado, lo que le permite inyectar datos est치ticos o transformarlos.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Espera

Un estado de **Espera** retrasa la ejecuci칩n de la m치quina de estados por una duraci칩n especificada. Hay tres m칠todos principales para configurar el tiempo de espera:

- **X Segundos**: Un n칰mero fijo de segundos para esperar.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Marca de tiempo Absoluta**: Un momento exacto para esperar hasta.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Espera Din치mica**: Basada en la entrada utilizando **`SecondsPath`** o **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Paralelo

Un estado **Paralelo** te permite ejecutar m칰ltiples ramas de tareas de forma concurrente dentro de tu flujo de trabajo. Cada rama se ejecuta de forma independiente y procesa su propia secuencia de estados. La ejecuci칩n espera hasta que todas las ramas se completen antes de proceder al siguiente estado. Sus campos clave son:

- **Ramas**: Un array que define los caminos de ejecuci칩n paralela. Cada rama es una m치quina de estados separada.
- **ResultPath**: Define d칩nde (en la entrada) colocar la salida combinada de las ramas.
- **Reintentar y Capturar**: Configuraciones de manejo de errores para el estado paralelo.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

Un estado **Map** permite la ejecuci칩n de un conjunto de pasos para cada elemento en un conjunto de datos. Se utiliza para el procesamiento paralelo de datos. Dependiendo de c칩mo desee procesar los elementos del conjunto de datos, Step Functions proporciona los siguientes modos:

- **Modo en l칤nea**: Ejecuta un subconjunto de estados para cada elemento de un array JSON. Adecuado para tareas a peque침a escala con menos de 40 iteraciones paralelas, ejecutando cada una de ellas en el contexto del flujo de trabajo que contiene el estado **`Map`**.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Modo distribuido**: Dise침ado para procesamiento paralelo a gran escala con alta concurrencia. Admite el procesamiento de conjuntos de datos grandes, como los almacenados en Amazon S3, permitiendo una alta concurrencia de hasta 10,000 ejecuciones de flujos de trabajo paralelos, ejecutando estos hijos como una ejecuci칩n de hijo separada.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Versiones y alias

Step Functions tambi칠n le permite gestionar despliegues de flujos de trabajo a trav칠s de **versiones** y **alias** de m치quinas de estados. Una versi칩n representa una instant치nea de una m치quina de estados que puede ser ejecutada. Los alias sirven como punteros a hasta dos versiones de una m치quina de estados.

- **Versiones**: Estas instant치neas inmutables de una m치quina de estados se crean a partir de la revisi칩n m치s reciente de esa m치quina de estados. Cada versi칩n se identifica con un ARN 칰nico que combina el ARN de la m치quina de estados con el n칰mero de versi칩n, separados por dos puntos (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Las versiones no se pueden editar, pero se puede actualizar la m치quina de estados y publicar una nueva versi칩n, o utilizar la versi칩n de la m치quina de estados deseada.
- **Alias**: Estos punteros pueden hacer referencia a hasta dos versiones de la misma m치quina de estados. Se pueden crear m칰ltiples alias para una sola m치quina de estados, cada uno identificado con un ARN 칰nico construido combinando el ARN de la m치quina de estados con el nombre del alias, separados por dos puntos (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Los alias permiten el enrutamiento de tr치fico entre una de las dos versiones de una m치quina de estados. Alternativamente, un alias puede apuntar a una versi칩n espec칤fica de la m치quina de estados, pero no a otros alias. Se pueden actualizar para redirigir a una versi칩n diferente de la m치quina de estados seg칰n sea necesario, facilitando despliegues controlados y gesti칩n de flujos de trabajo.

Para obtener informaci칩n m치s detallada sobre **ASL**, consulte:[**Amazon States Language**](https://states-language.net/spec.html).



## Roles de IAM para m치quinas de estados

AWS Step Functions utiliza roles de IAM (Identidad y Acceso de AWS) para controlar el acceso a recursos y acciones dentro de las m치quinas de estados. Aqu칤 se presentan los aspectos clave relacionados con la seguridad y los roles de IAM en AWS Step Functions:

- **Rol de ejecuci칩n**: Cada m치quina de estados en AWS Step Functions est치 asociada con un rol de ejecuci칩n de IAM. Este rol define qu칠 acciones puede realizar la m치quina de estados en su nombre. Cuando una m치quina de estados transita entre estados que interact칰an con servicios de AWS (como invocar funciones Lambda, acceder a DynamoDB, etc.), asume este rol de ejecuci칩n para llevar a cabo esas acciones.
- **Permisos**: El rol de ejecuci칩n de IAM debe estar configurado con permisos que permitan las acciones necesarias en otros servicios de AWS. Por ejemplo, si su m치quina de estados necesita invocar funciones Lambda de AWS, el rol de IAM debe tener permisos de **`lambda:InvokeFunction`**. De manera similar, si necesita escribir en DynamoDB, se deben otorgar los permisos adecuados (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, etc.).
- **Principio de privilegio m칤nimo**: Se recomienda seguir el principio de privilegio m칤nimo al configurar roles de IAM para Step Functions. Esto significa otorgar solo los permisos necesarios para que la m치quina de estados realice sus acciones espec칤ficas, y no m치s. Las pol칤ticas de IAM deben estar limitadas a recursos y acciones espec칤ficas, reduciendo el riesgo de acceso no deseado.

## Enumeraci칩n

La pol칤tica ReadOnlyAccess es suficiente para todas las siguientes acciones de enumeraci칩n.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Escalada de privilegios

En la siguiente p치gina, puedes verificar c칩mo **abusar de los permisos de Step Functions para escalar privilegios**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Explotaci칩n

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Referencias

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
