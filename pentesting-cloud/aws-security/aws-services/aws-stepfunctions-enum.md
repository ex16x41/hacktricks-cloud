# AWS - Step Funksies Enum

<details>

<summary><strong>Leer AWS hack vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou hacktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Step Funksies

AWS Step Funksies is 'n werkstroomdiens wat jou in staat stel om verskeie AWS-diens in naadlose werkstrome te ko√∂rdineer en orkestreer. Deur AWS Step Funksies te gebruik, kan jy werkstrome ontwerp en hardloop wat verskeie AWS-diens soos AWS Lambda, Amazon S3, Amazon DynamoDB, en nog baie meer, in 'n reeks stappe koppel. Hierdie orkestrasiediens bied 'n visuele werkstroomkoppelvlak en bied **staatmasjien**-vermo√´ns, wat jou in staat stel om elke stap van die werkstroom op 'n deklaratiewe wyse te definieer deur gebruik te maak van JSON-gebaseerde **Amazon States Language** (ASL).

AWS Step Funksies vereenvoudig die proses om veerkragtige en skaalbare aansoeke te bou deur die onderliggende infrastruktuur te bestuur, herhaalpogings, foute, en parallelle verwerking outomaties te hanteer. Dit is veral nuttig vir die skep van komplekse werkstrome wat verskeie stappe en besluitpunte behels, aangesien dit maklik die vloei van data en uitvoeringsstaat oor dienste kan bestuur. Die hoofgevalle wat deur hierdie diens uitgevoer moet word, is die volgende:

- **Dataverwerking**: L√™er-, video- en beeldverwerking; ekstraksie, transformasie en laai (ETL) van take; en lotverwerking en ho√´ prestasie-rekenaartake (HPC).
- **Masjienleer**: Bedrogopsporing, aanpassing, aanbeveling en dataverryking.
- **Mikrodienste-orkestrering**: Sinkroniese of werklike werkstrome en houerorkestrering.
- **IT- en sekuriteitsoutomatisering**: Outo-herstel, implementering en reaksie; en menslike goedkeuring en eskalasie.

## Sleutelkonsepte

### Standaard vs. Uitdruklike Werkstrome

AWS Step Funksies bied twee tipes **staatmasjien-werkstrome**: Standaard en Uitdruklik.

- **Standaard Werkstroom**: Hierdie verstekwerkstroomtipe is ontwerp vir langdurige, duursame, en ouditeerbare prosesse. Dit ondersteun **presies-een-uitvoering**, wat verseker dat take slegs een keer uitgevoer word tensy herhaalpogings gespesifiseer word. Dit is ideaal vir werkstrome wat 'n gedetailleerde uitvoeringsgeskiedenis benodig en kan vir tot een jaar hardloop.
- **Uitdruklike Werkstroom**: Hierdie tipe is ideaal vir ho√´-volume, kortduur take, wat tot vyf minute kan hardloop. Hulle ondersteun **ten minste een-uitvoering**, geskik vir idempotente take soos dataverwerking. Hierdie werkstrome is geoptimaliseer vir koste en prestasie, en reken op uitvoerings, duur, en geheugengebruik.

### State

State is die essensi√´le eenhede van staatmasjiene. Hulle definieer die individuele stappe binne 'n werkstroom, en kan 'n verskeidenheid funksies uitvoer, afhangende van hul tipe:

- **Taak:** Voer 'n taak uit, dikwels deur 'n AWS-diens soos Lambda te gebruik.
- **Keuse:** Neem besluite gebaseer op insette.
- **Misluk/Slaag:** Be√´indig die uitvoering met 'n mislukking of sukses.
- **Gaan verby:** Stuur inset na uitset of spuit data in.
- **Wag:** Vertraag die uitvoering vir 'n bepaalde tyd.
- **Parallel:** Inisieer parallelle takke.
- **Kaart:** Itereer dinamies stappe oor items.

### Taak

'n **Taak**-staat verteenwoordig 'n enkele eenheid van werk wat deur 'n staatmasjien uitgevoer word. Take kan verskeie bronne aanroep, insluitend aktiwiteite, Lambda-funksies, AWS-diens, of derdeparty-API's.

- **Aktiwiteite**: Aangepaste werkers wat jy bestuur, geskik vir langdurige prosesse.
- Bron: **`arn:aws:states:region:account:activity:name`**.
- **Lambda-funksies**: Voer AWS Lambda-funksies uit.
- Bron: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS-diens**: Integreer direk met ander AWS-diens, soos DynamoDB of S3.
- Bron: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP-taak**: Roep derdeparty-API's aan.
- Bronveld: **`arn:aws:states:::http:invoke`**. Dan moet jy die API-eindpuntkonfigurasiedetails verskaf, soos die API-URL, metode, en¬†verifikasiedetails.

Die volgende voorbeeld toon 'n Taakstaatdefinisie wat 'n Lambda-funksie genaamd HelloWorld aanroep:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Keuse

'n **Keuse**-toestand voeg voorwaardelike logika by 'n werkstroom, wat besluite moontlik maak op grond van insetdata. Dit evalueer die gespesifiseerde voorwaardes en skuif na die ooreenstemmende toestand gebaseer op die resultate.

- **Vergelyking**: Elke keuse-re√´l sluit 'n vergelykingsoperator in (bv. **`NumericEquals`**, **`StringEquals`**) wat 'n insetveranderlike vergelyk met 'n gespesifiseerde waarde of 'n ander veranderlike.
- **Volgende Veld**: Keuse-toestande ondersteun nie die **`End`**-veld nie, in plaas daarvan definieer hulle die **`Next`**-toestand om na oor te skuif as die vergelyking waar is.

Voorbeeld van 'n **Keuse**-toestand:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Faal/Slaag

'n **`Fail`** toestand stop die uitvoering van 'n staatmasjien en merk dit as 'n mislukking. Dit word gebruik om 'n foutnaam en 'n oorsaak te spesifiseer, wat besonderhede oor die mislukking verskaf. Hierdie toestand is terminaal, wat beteken dat dit die uitvoeringsvloei be√´indig.

'n **`Succeed`** toestand stop die uitvoering suksesvol. Dit word tipies gebruik om die werkstroom te be√´indig wanneer dit suksesvol voltooi is. Hierdie toestand vereis nie 'n **`Next`** veld nie.

{% tabs %}

{% tab title="Fail voorbeeld" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Voorbeeld van sukses" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Oorbrug

'n **Oorbrug**-toestand stuur sy inset na sy uitset sonder om enige werk te verrig of JSON-toestandsinvoer te transformeer deur filters te gebruik, en dan die getransformeerde data na die volgende toestand te stuur. Dit is nuttig vir toetsdoeleindes en die konstruksie van toestandmasjiene, wat jou in staat stel om statiese data in te spuit of dit te transformeer.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wag

'n **Wag**-toestand vertraag die uitvoering van die toestandmasjien vir 'n gespesifiseerde tydsduur. Daar is drie prim√™re metodes om die wagtyd te konfigureer:

- **X Sekondes**: 'n vasgestelde aantal sekondes om te wag.

```json
"WagToestand": {
"Tipe": "Wag",
"Sekondes": 10,
"Volgende": "VolgendeToestand"
}
```

- **Absolute Tydmerk**: 'n presiese tyd om te wag tot.

```json
"WagToestand": {
"Tipe": "Wag",
"Tydmerk": "2024-03-14T01:59:00Z",
"Volgende": "VolgendeToestand"
}
```

- **Dinamiese Wag**: Gebaseer op inset deur gebruik van **`SekondesPaaie`** of **`TydmerkPaaie`**.

```json
jsonCopiar c√≥digo
"WagToestand": {
"Tipe": "Wag",
"TydmerkPaaie": "$.vervaldatum",
"Volgende": "VolgendeToestand"
}
```


### Parallel

'n **Parallel**-toestand laat jou toe om meerdere takke van take gelyktydig binne jou werkstroom uit te voer. Elke tak loop onafhanklik en verwerk sy eie volgorde van toestande. Die uitvoering wag totdat alle takke voltooi is voordat dit na die volgende toestand voortgaan. Die sleutelvelde is:

- **Takke**: 'n reeks wat die parallelle uitvoeringspaaie definieer. Elke tak is 'n afsonderlike toestandmasjien.
- **ResultaatPaaie**: Definieer waar (in die inset) om die gekombineerde uitset van die takke te plaas.
- **Herhaal en Vang**: Foutafhandelingskonfigurasies vir die parallelle toestand.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Kaart

'n **Kaart**-toestand maak die uitvoering van 'n stel stappe moontlik vir elke item in 'n datastel. Dit word gebruik vir parallelle verwerking van data. Afhangende van hoe jy die items van die datastel wil verwerk, bied Step Functions die volgende modusse:

- **Inline Modus**: Voer 'n subset van toestande uit vir elke JSON-array-item. Geskik vir kleinskaalse take met minder as 40 parallelle iterasies, waar elkeen in die konteks van die werkstroom wat die **`Kaart`**-toestand bevat, uitgevoer word.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Verspreide Modus**: Ontwerp vir grootskaalse parallelle verwerking met ho√´ gelyktydigheid. Ondersteun die verwerking van groot datastelle, soos di√© wat gestoor word in Amazon S3, wat 'n ho√´ gelyktydigheid van tot 10,000 parallelle kindwerkstroom-uitvoerings moontlik maak, wat hierdie kind as 'n afsonderlike kinduitvoering uitvoer.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Weergawes en aliase

Step Functions laat jou ook toe om werkstroom-implementasies te bestuur deur **weergawes** en **aliase** van toestandmasjiene. 'n Weergawe verteenwoordig 'n oomblikopname van 'n toestandmasjien wat uitgevoer kan word. Aliase dien as aanwysers na tot twee weergawes van 'n toestandmasjien.

- **Weergawes**: Hierdie onveranderlike oomblikopnames van 'n toestandmasjien word geskep vanaf die mees onlangse hersiening van daardie toestandmasjien. Elke weergawe word ge√Ødentifiseer deur 'n unieke ARN wat die toestandmasjien ARN met die weergawenommer kombineer, geskei deur 'n kolon (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Weergawes kan nie gewysig word nie, maar jy kan die toestandmasjien opdateer en 'n nuwe weergawe publiseer, of die gewenste toestandmasjienweergawe gebruik.
- **Aliase**: Hierdie aanwysers kan na tot twee weergawes van dieselfde toestandmasjien verwys. Meervoudige aliase kan vir 'n enkele toestandmasjien geskep word, elkeen ge√Ødentifiseer deur 'n unieke ARN wat die toestandmasjien ARN met die aliassenaam kombineer, geskei deur 'n kolon (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Aliase maak die roeteverkeer tussen een van die twee weergawes van 'n toestandmasjien moontlik. Alternatiewelik kan 'n aliase na 'n spesifieke weergawe van die toestandmasjien wys, maar nie na ander aliase nie. Hulle kan opgedateer word om te verwys na 'n ander weergawe van die toestandmasjien soos benodig, wat beheerde implementasies en werkstroombestuur fasiliteer.

Vir meer gedetailleerde inligting oor **ASL**, kyk: [**Amazon States Language**](https://states-language.net/spec.html).



## IAM-rolle vir Toestandmasjiene

AWS Step Functions maak gebruik van AWS Identity and Access Management (IAM)-rolle om toegang tot hulpbronne en aksies binne toestandmasjiene te beheer. Hier is die sleutelaspekte wat verband hou met sekuriteit en IAM-rolle in AWS Step Functions:

- **Uitvoeringsrol**: Elke toestandmasjien in AWS Step Functions is geassosieer met 'n IAM-uitvoeringsrol. Hierdie rol definieer watter aksies die toestandmasjien namens jou kan uitvoer. Wanneer 'n toestandmasjien oorgaan tussen toestande wat met AWS-diens kommunikeer (soos die aanroeping van Lambda-funksies, toegang tot DynamoDB, ens.), neem dit hierdie uitvoeringsrol aan om daardie aksies uit te voer.
- **Toestemmings**: Die IAM-uitvoeringsrol moet gekonfigureer word met toestemmings wat die nodige aksies op ander AWS-diens toelaat. Byvoorbeeld, as jou toestandmasjien AWS Lambda-funksies moet aanroep, moet die IAM-rol oor **`lambda:InvokeFunction`**-toestemmings beskik. Op soortgelyke wyse, as dit na DynamoDB moet skryf, moet toepaslike toestemmings (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, ens.) verleen word.
- **Minste Bevoorregting**: Dit word aanbeveel om die beginsel van minste bevoorregting te volg wanneer jy IAM-rolle vir Step Functions konfigureer. Dit beteken dat slegs die nodige toestemmings vir die toestandmasjien se spesifieke aksies verleen moet word, en nie meer nie. IAM-beleide moet beperk word tot spesifieke hulpbronne en aksies, wat die risiko van onbedoelde toegang verminder.

## Enumerasie

ReadOnlyAccess-beleid is genoeg vir al die volgende enumerasie-aksies.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Op die volgende bladsy kan jy sien hoe om **Step Functions-toestemmings te misbruik om voorregte te eskaleer**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Verwysings

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
