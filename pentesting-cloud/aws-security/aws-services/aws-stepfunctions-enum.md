# AWS - Enumera√ß√£o de Fun√ß√µes de Passo

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Fun√ß√µes de Passo

AWS Step Functions √© um servi√ßo de fluxo de trabalho que permite coordenar e orquestrar v√°rios servi√ßos AWS em fluxos de trabalho sem servidor. Usando o AWS Step Functions, voc√™ pode projetar e executar fluxos de trabalho que conectam v√°rios servi√ßos AWS, como AWS Lambda, Amazon S3, Amazon DynamoDB e muitos mais, em uma sequ√™ncia de etapas. Este servi√ßo de orquestra√ß√£o fornece uma interface visual de fluxo de trabalho e oferece capacidades de **m√°quina de estado**, permitindo que voc√™ defina cada etapa do fluxo de trabalho de maneira declarativa usando a **Linguagem de Estados da Amazon** (ASL) baseada em JSON.

## Conceitos-chave

### Fluxos de Trabalho Padr√£o vs. Express

AWS Step Functions oferece dois tipos de **fluxos de trabalho de m√°quina de estado**: Padr√£o e Express.

* **Fluxo de Trabalho Padr√£o**: Este tipo de fluxo de trabalho padr√£o √© projetado para processos de longa dura√ß√£o, dur√°veis e audit√°veis. Ele suporta **execu√ß√£o exatamente uma vez**, garantindo que as tarefas sejam executadas apenas uma vez, a menos que as tentativas sejam especificadas. √â ideal para fluxos de trabalho que precisam de um hist√≥rico de execu√ß√£o detalhado e pode durar at√© um ano.
* **Fluxo de Trabalho Express**: Este tipo √© ideal para tarefas de alto volume e curta dura√ß√£o, com dura√ß√£o de at√© cinco minutos. Eles suportam **execu√ß√£o pelo menos uma vez**, adequado para tarefas idempotentes, como processamento de dados. Esses fluxos de trabalho s√£o otimizados para custo e desempenho, cobrando com base em execu√ß√µes, dura√ß√£o e uso de mem√≥ria.

### Estados

Os estados s√£o as unidades essenciais das m√°quinas de estado. Eles definem as etapas individuais dentro de um fluxo de trabalho, podendo realizar uma variedade de fun√ß√µes dependendo de seu tipo:

* **Tarefa:** Executa um trabalho, muitas vezes usando um servi√ßo AWS como Lambda.
* **Escolha:** Toma decis√µes com base na entrada.
* **Falha/Sucesso:** Termina a execu√ß√£o com uma falha ou sucesso.
* **Passar:** Passa a entrada para a sa√≠da ou injeta dados.
* **Esperar:** Atraso na execu√ß√£o por um tempo definido.
* **Paralelo:** Inicia ramifica√ß√µes paralelas.
* **Mapa:** Itera dinamicamente etapas sobre itens.

### Tarefa

Um estado de **Tarefa** representa uma √∫nica unidade de trabalho executada por uma m√°quina de estado. As tarefas podem invocar v√°rios recursos, incluindo atividades, fun√ß√µes Lambda, servi√ßos AWS ou APIs de terceiros.

* **Atividades**: Trabalhadores personalizados que voc√™ gerencia, adequados para processos de longa dura√ß√£o.
* Recurso: **`arn:aws:states:region:account:activity:name`**.
* **Fun√ß√µes Lambda**: Executa fun√ß√µes AWS Lambda.
* Recurso: **`arn:aws:lambda:region:account:function:function-name`**.
* **Servi√ßos AWS**: Integra-se diretamente com outros servi√ßos AWS, como DynamoDB ou S3.
* Recurso: **`arn:partition:states:region:account:servicename:APIname`**.
* **Tarefa HTTP**: Chama APIs de terceiros.
* Campo de recurso: **`arn:aws:states:::http:invoke`**. Em seguida, voc√™ deve fornecer os detalhes de configura√ß√£o do endpoint da API, como a URL da API, m√©todo e detalhes de autentica√ß√£o.

O seguinte exemplo mostra uma defini√ß√£o de estado de Tarefa que invoca uma fun√ß√£o Lambda chamada HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

Um **Choice** state adiciona l√≥gica condicional a um fluxo de trabalho, permitindo decis√µes com base em dados de entrada. Ele avalia as condi√ß√µes especificadas e transita para o estado correspondente com base nos resultados.

* **Compara√ß√£o**: Cada regra de escolha inclui um operador de compara√ß√£o (por exemplo, **`NumericEquals`**, **`StringEquals`**) que compara uma vari√°vel de entrada a um valor especificado ou outra vari√°vel.
* **Campo Next**: Os estados de escolha n√£o suportam o campo **`End`**, em vez disso, eles definem o estado **`Next`** para transitar se a compara√ß√£o for verdadeira.

Exemplo de **Choice** state:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Falha/Sucesso

Um **`Fail`** estado interrompe a execu√ß√£o de uma m√°quina de estados e a marca como uma falha. √â usado para especificar um nome de erro e uma causa, fornecendo detalhes sobre a falha. Este estado √© terminal, o que significa que encerra o fluxo de execu√ß√£o.

Um **`Succeed`** estado interrompe a execu√ß√£o com sucesso. √â tipicamente usado para encerrar o fluxo de trabalho quando ele √© conclu√≠do com sucesso. Este estado n√£o requer um campo **`Next`**.

{% tabs %}
{% tab title="Exemplo de Falha" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Exemplo de sucesso" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
{% endtab %}
{% endtabs %}

### Pass

Um estado **Pass** passa sua entrada para sua sa√≠da, seja sem realizar qualquer trabalho ou transformando a entrada do estado JSON usando filtros, e ent√£o passando os dados transformados para o pr√≥ximo estado. √â √∫til para testar e construir m√°quinas de estado, permitindo que voc√™ injete dados est√°ticos ou os transforme.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wait

Um **Wait** state atrasa a execu√ß√£o da m√°quina de estados por uma dura√ß√£o especificada. Existem tr√™s m√©todos principais para configurar o tempo de espera:

*   **X Segundos**: Um n√∫mero fixo de segundos para esperar.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```
*   **Timestamp Absoluto**: Um hor√°rio exato para esperar at√©.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```
*   **Espera Din√¢mica**: Baseada em entrada usando **`SecondsPath`** ou **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```

### Parallel

Um **Parallel** state permite que voc√™ execute m√∫ltiplos ramos de tarefas simultaneamente dentro do seu fluxo de trabalho. Cada ramo √© executado de forma independente e processa sua pr√≥pria sequ√™ncia de estados. A execu√ß√£o espera at√© que todos os ramos sejam conclu√≠dos antes de prosseguir para o pr√≥ximo estado. Seus campos principais s√£o:

* **Branches**: Um array definindo os caminhos de execu√ß√£o paralela. Cada ramo √© uma m√°quina de estados separada.
* **ResultPath**: Define onde (na entrada) colocar a sa√≠da combinada dos ramos.
* **Retry e Catch**: Configura√ß√µes de tratamento de erros para o estado paralelo.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Mapa

Um **Map** state permite a execu√ß√£o de um conjunto de etapas para cada item em um conjunto de dados. √â usado para processamento paralelo de dados. Dependendo de como voc√™ deseja processar os itens do conjunto de dados, o Step Functions fornece os seguintes modos:

*   **Modo Inline**: Executa um subconjunto de estados para cada item do array JSON. Adequado para tarefas em pequena escala com menos de 40 itera√ß√µes paralelas, executando cada uma delas no contexto do fluxo de trabalho que cont√©m o **`Map`** state.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```
*   **Modo Distribu√≠do**: Projetado para processamento paralelo em larga escala com alta concorr√™ncia. Suporta o processamento de grandes conjuntos de dados, como aqueles armazenados no Amazon S3, permitindo uma alta concorr√™ncia de at√© 10.000 execu√ß√µes de fluxo de trabalho filho paralelas, executando esses filhos como uma execu√ß√£o separada.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```

### Vers√µes e aliases

O Step Functions tamb√©m permite gerenciar implanta√ß√µes de fluxo de trabalho atrav√©s de **vers√µes** e **aliases** de m√°quinas de estado. Uma vers√£o representa uma captura instant√¢nea de uma m√°quina de estado que pode ser executada. Aliases servem como ponteiros para at√© duas vers√µes de uma m√°quina de estado.

* **Vers√µes**: Essas capturas instant√¢neas imut√°veis de uma m√°quina de estado s√£o criadas a partir da revis√£o mais recente dessa m√°quina de estado. Cada vers√£o √© identificada por um ARN exclusivo que combina o ARN da m√°quina de estado com o n√∫mero da vers√£o, separado por dois pontos (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Vers√µes n√£o podem ser editadas, mas voc√™ pode atualizar a m√°quina de estado e publicar uma nova vers√£o, ou usar a vers√£o desejada da m√°quina de estado.
* **Aliases**: Esses ponteiros podem referenciar at√© duas vers√µes da mesma m√°quina de estado. M√∫ltiplos aliases podem ser criados para uma √∫nica m√°quina de estado, cada um identificado por um ARN exclusivo constru√≠do combinando o ARN da m√°quina de estado com o nome do alias, separado por dois pontos (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Aliases permitem o roteamento de tr√°fego entre uma das duas vers√µes de uma m√°quina de estado. Alternativamente, um alias pode apontar para uma √∫nica vers√£o espec√≠fica da m√°quina de estado, mas n√£o para outros aliases. Eles podem ser atualizados para redirecionar para uma vers√£o diferente da m√°quina de estado conforme necess√°rio, facilitando implanta√ß√µes controladas e gerenciamento de fluxo de trabalho.

Para mais informa√ß√µes detalhadas sobre **ASL**, consulte: [**Amazon States Language**](https://states-language.net/spec.html).

## Fun√ß√µes IAM para M√°quinas de Estado

O AWS Step Functions utiliza fun√ß√µes do AWS Identity and Access Management (IAM) para controlar o acesso a recursos e a√ß√µes dentro das m√°quinas de estado. Aqui est√£o os principais aspectos relacionados √† seguran√ßa e fun√ß√µes IAM no AWS Step Functions:

* **Fun√ß√£o de Execu√ß√£o**: Cada m√°quina de estado no AWS Step Functions est√° associada a uma fun√ß√£o de execu√ß√£o IAM. Essa fun√ß√£o define quais a√ß√µes a m√°quina de estado pode realizar em seu nome. Quando uma m√°quina de estado transita entre estados que interagem com servi√ßos AWS (como invocar fun√ß√µes Lambda, acessar DynamoDB, etc.), ela assume essa fun√ß√£o de execu√ß√£o para realizar essas a√ß√µes.
* **Permiss√µes**: A fun√ß√£o de execu√ß√£o IAM deve ser configurada com permiss√µes que permitam as a√ß√µes necess√°rias em outros servi√ßos AWS. Por exemplo, se sua m√°quina de estado precisar invocar fun√ß√µes AWS Lambda, a fun√ß√£o IAM deve ter permiss√µes **`lambda:InvokeFunction`**. Da mesma forma, se precisar gravar no DynamoDB, permiss√µes apropriadas (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, etc.) devem ser concedidas.

## Enumera√ß√£o

A pol√≠tica ReadOnlyAccess √© suficiente para todas as seguintes a√ß√µes de enumera√ß√£o.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List versions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve information about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution (output included)
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified step Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes do Step Functions para escalar privil√©gios**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## P√≥s Explora√ß√£o

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation.md" %}
[aws-stepfunctions-post-exploitation.md](../aws-post-exploitation/aws-stepfunctions-post-exploitation.md)
{% endcontent-ref %}

## Persist√™ncia

{% content-ref url="../aws-persistence/aws-step-functions-persistence.md" %}
[aws-step-functions-persistence.md](../aws-persistence/aws-step-functions-persistence.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
