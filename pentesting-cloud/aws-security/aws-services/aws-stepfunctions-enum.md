# AWS - Enumeracja funkcji krok贸w

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>

## Funkcje krok贸w

AWS Step Functions to usuga przepywu pracy, kt贸ra umo偶liwia koordynacj i orkiestracj wielu usug AWS w bezserwerowych przepywach pracy. Korzystajc z AWS Step Functions, mo偶esz projektowa i uruchamia przepywy pracy czce r贸偶ne usugi AWS, takie jak AWS Lambda, Amazon S3, Amazon DynamoDB i wiele innych, w sekwencji krok贸w. Ta usuga orkiestracji zapewnia wizualny interfejs przepywu pracy i oferuje mo偶liwoci **maszyny stan贸w**, pozwalajc zdefiniowa ka偶dy krok przepywu pracy w deklaratywny spos贸b, korzystajc z opartego na JSONie **Amazon States Language** (ASL).

AWS Step Functions upraszcza proces budowania odpornych i skalowalnych aplikacji poprzez zarzdzanie infrastruktur, obsug ponownych pr贸b, bd贸w i przetwarzanie r贸wnolege automatycznie. Jest szczeg贸lnie przydatny do tworzenia zo偶onych przepyw贸w pracy obejmujcych wiele krok贸w i punkt贸w decyzyjnych, poniewa偶 atwo zarzdza przepywem danych i stanem wykonania midzy usugami. G贸wne przypadki u偶ycia do wykonania przez t usug to:

- **Przetwarzanie danych**: Przetwarzanie plik贸w, wideo i obraz贸w; ekstrakcja, transformacja i adowanie (ETL) zada; oraz przetwarzanie wsadowe i obci偶enia obliczeniowe o wysokiej wydajnoci (HPC).
- **Uczenie maszynowe**: Wykrywanie oszustw, dostosowywanie, rekomendacje i wzbogacanie danych.
- **Orkiestracja mikrousug**: Przepywy pracy synchroniczne lub czasu rzeczywistego i orkiestracja kontener贸w.
- **Automatyzacja IT i bezpieczestwa**: Autonaprawa, wdro偶enie i reakcja; oraz zatwierdzanie przez czowieka i eskalacja.

## Kluczowe koncepcje

### Przepywy standardowe kontra ekspresowe

AWS Step Functions oferuje dwa rodzaje **przepyw贸w maszyn stan贸w**: Standardowe i Ekspresowe.

- **Przepyw standardowy**: Ten domylny typ przepywu pracy jest przeznaczony do dugotrwaych, trwaych i audytowalnych proces贸w. Obsuguje **wykonywanie dokadnie raz**, zapewniajc, 偶e zadania s uruchamiane tylko raz, chyba 偶e okrelono ponowne pr贸by. Jest idealny do przepyw贸w pracy wymagajcych szczeg贸owej historii wykonania i mo偶e dziaa przez maksymalnie rok.
- **Przepyw ekspresowy**: Ten typ jest idealny do zada o du偶ej objtoci i kr贸tkim czasie trwania, dziaajcych do piciu minut. Obsuguj **wykonywanie co najmniej raz**, odpowiednie dla zada idempotentnych, takich jak przetwarzanie danych. Te przepywy pracy s zoptymalizowane pod ktem koszt贸w i wydajnoci, naliczajc opaty na podstawie wykonania, czasu trwania i u偶ycia pamici.

### Stany

Stany s podstawowymi jednostkami maszyn stan贸w. Definiuj one poszczeg贸lne kroki w ramach przepywu pracy, mogc wykonywa r贸偶norodne funkcje w zale偶noci od swojego typu:

- **Zadanie:** Wykonuje zadanie, czsto korzystajc z usugi AWS, takiej jak Lambda.
- **Wyb贸r:** Podejmuje decyzje na podstawie danych wejciowych.
- **Niepowodzenie/Sukces:** Koczy wykonanie z niepowodzeniem lub sukcesem.
- **Przekazanie:** Przekazuje dane wejciowe na dane wyjciowe lub wstrzykuje dane.
- **Oczekiwanie:** Opoznia wykonanie przez okrelony czas.
- **R贸wnolege:** Inicjuje r贸wnolege gazie.
- **Mapa:** Dynamicznie iteruje kroki nad elementami.

### Zadanie

Stan **Zadanie** reprezentuje pojedyncz jednostk pracy wykonywan przez maszyn stan贸w. Zadania mog wywoywa r贸偶ne zasoby, w tym dziaania, funkcje Lambda, usugi AWS lub interfejsy API stron trzecich.

- **Dziaania**: Niestandardowe pracowniki, kt贸rymi zarzdzasz, odpowiednie do proces贸w dugotrwaych.
- Zas贸b: **`arn:aws:states:region:account:activity:name`**.
- **Funkcje Lambda**: Wykonuje funkcje AWS Lambda.
- Zas贸b: **`arn:aws:lambda:region:account:function:function-name`**.
- **Usugi AWS**: Integracja bezporednia z innymi usugami AWS, takimi jak DynamoDB lub S3.
- Zas贸b: **`arn:partition:states:region:account:servicename:APIname`**.
- **Zadanie HTTP**: Wywouje interfejsy API stron trzecich.
- Pole zasobu: **`arn:aws:states:::http:invoke`**. Nastpnie nale偶y poda szczeg贸y konfiguracji punktu kocowego API, takie jak URL API, metoda i szczeg贸y uwierzytelniania.

Poni偶szy przykad pokazuje definicj stanu Zadania, kt贸re wywouje funkcj Lambda o nazwie HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Wyb贸r

Stan **Wyb贸r** dodaje logik warunkow do przepywu pracy, umo偶liwiajc podejmowanie decyzji na podstawie danych wejciowych. Ocenia okrelone warunki i przechodzi do odpowiadajcego stanu na podstawie wynik贸w.

- **Por贸wnanie**: Ka偶da regua wyboru zawiera operator por贸wnania (np. **`NumericEquals`**, **`StringEquals`**), kt贸ry por贸wnuje zmienn wejciow z okrelon wartoci lub inn zmienn.
- **Pole Nastpny**: Stany wyboru nie obsuguj pola **`End`**, zamiast tego definiuj stan **`Next`**, do kt贸rego maj przej, jeli por贸wnanie jest prawdziwe.

Przykad stanu **Wyb贸r**:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Niepowodzenie/Sukces

Stan **`Fail`** zatrzymuje wykonywanie maszyny stan贸w i oznacza j jako nieudan. Su偶y do okrelenia nazwy bdu i przyczyny, dostarczajc szczeg贸贸w dotyczcych niepowodzenia. Ten stan jest terminalny, co oznacza, 偶e koczy przepyw wykonania.

Stan **`Succeed`** zatrzymuje wykonanie pomylnie. Zazwyczaj jest u偶ywany do zakoczenia przepywu pracy, gdy zakoczy si pomylnie. Ten stan nie wymaga pola **`Next`**.

{% tabs %}

{% tab title="Przykad niepowodzenia" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Przykad sukcesu" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Przejcie

Stan **Pass** przekazuje swoje wejcie na wyjcie bez wykonywania 偶adnej pracy lub transformacji wejcia stanu JSON za pomoc filtr贸w, a nastpnie przekazuje przeksztacone dane do nastpnego stanu. Jest przydatny do testowania i konstruowania maszyn stanu, pozwalajc wstrzykn statyczne dane lub je przeksztaci.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Czekaj

Stan **Czekaj** op贸藕nia wykonanie maszyny stan贸w przez okrelony czas. Istniej trzy podstawowe metody konfiguracji czasu oczekiwania:

- **X Sekund**: Staa liczba sekund oczekiwania.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Dokadny znacznik czasu**: Dokadny czas oczekiwania.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Dynamiczne oczekiwanie**: Na podstawie danych wejciowych za pomoc **`SecondsPath`** lub **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### R贸wnolegy

Stan **R贸wnolegy** pozwala na jednoczesne wykonywanie wielu gazi zada w ramach twojego przepywu pracy. Ka偶da ga藕 dziaa niezale偶nie i przetwarza swoj wasn sekwencj stan贸w. Wykonanie czeka, a偶 wszystkie gazie zostan zakoczone, zanim przejdzie do nastpnego stanu. Jego kluczowe pola to:

- **Gazie**: Tablica definiujca r贸wnolege cie偶ki wykonania. Ka偶da ga藕 to osobna maszyna stan贸w.
- **ResultPath**: Okrela, gdzie (w danych wejciowych) umieci poczony wynik gazi.
- **Pon贸w i Zap**: Konfiguracje obsugi bd贸w dla stanu r贸wnolegego.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

Stan **Map** umo偶liwia wykonanie zestawu krok贸w dla ka偶dego elementu w zbiorze danych. Jest u偶ywany do r贸wnolegej obr贸bki danych. W zale偶noci od tego, jak chcesz przetwarza elementy zbioru danych, Step Functions udostpnia nastpujce tryby:

- **Tryb wbudowany**: Wykonuje podzbi贸r stan贸w dla ka偶dego elementu tablicy JSON. Nadaje si do zada maej skali z mniej ni偶 40 r贸wnolegymi iteracjami, uruchamiajc ka偶d z nich w kontekcie przepywu pracy zawierajcego stan**`Map`**.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Tryb rozproszony**: Przeznaczony do r贸wnolegej obr贸bki na du偶 skal z wysok wsp贸bie偶noci. Obsuguje przetwarzanie du偶ych zbior贸w danych, takich jak te przechowywane w Amazon S3, umo偶liwiajc wysok wsp贸bie偶no do 10 000 r贸wnolegych wykona podrzdnych przepyw贸w pracy, uruchamiajc te podrzdne jako osobne wykonania podrzdne.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Wersje i aliasy

Step Functions pozwala r贸wnie偶 zarzdza wdro偶eniami przepyw贸w pracy za pomoc **wersji** i **alias贸w** maszyn stanowych. Wersja reprezentuje migawk maszyny stanowej, kt贸ra mo偶e by wykonana. Aliasy su偶 jako wska藕niki do maksymalnie dw贸ch wersji maszyny stanowej.

- **Wersje**: Te niemutowalne migawki maszyny stanowej s tworzone na podstawie najnowszej rewizji tej maszyny stanowej. Ka偶da wersja jest identyfikowana za pomoc unikalnego ARN, kt贸ry czy ARN maszyny stanowej z numerem wersji, oddzielonych dwukropkiem (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Wersje nie mog by edytowane, ale mo偶na zaktualizowa maszyn stanow i opublikowa now wersj lub u偶y 偶danej wersji maszyny stanowej.
- **Aliasy**: Te wska藕niki mog odnosi si do maksymalnie dw贸ch wersji tej samej maszyny stanowej. Mo偶na utworzy wiele alias贸w dla pojedynczej maszyny stanowej, z kt贸rych ka偶dy jest identyfikowany za pomoc unikalnego ARN skonstruowanego poprzez poczenie ARN maszyny stanowej z nazw aliasu, oddzielonych dwukropkiem (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Aliasy umo偶liwiaj kierowanie ruchu midzy jedn z dw贸ch wersji maszyny stanowej. Alternatywnie, alias mo偶e wskazywa na konkretn wersj maszyny stanowej, ale nie na inne aliasy. Mog by zaktualizowane, aby przekierowa do innej wersji maszyny stanowej w razie potrzeby, uatwiajc kontrolowane wdro偶enia i zarzdzanie przepywami pracy.

Aby uzyska bardziej szczeg贸owe informacje na temat **ASL**, sprawd藕:[**Amazon States Language**](https://states-language.net/spec.html).



## Role IAM dla maszyn stanowych

AWS Step Functions wykorzystuje role IAM (Identity and Access Management) AWS do kontrolowania dostpu do zasob贸w i dziaa w obrbie maszyn stanowych. Oto kluczowe aspekty zwizane z bezpieczestwem i rolami IAM w AWS Step Functions:

- **Rola wykonawcza**: Ka偶da maszyna stanowa w AWS Step Functions jest powizana z rol wykonawcz IAM. Ta rola definiuje, jakie dziaania maszyna stanowa mo偶e wykonywa w Twoim imieniu. Gdy maszyna stanowa przechodzi midzy stanami, kt贸re oddziauj z usugami AWS (takimi jak wywoywanie funkcji Lambda, dostp do DynamoDB, itp.), przyjmuje t rol wykonawcz, aby wykona te dziaania.
- **Uprawnienia**: Rola wykonawcza IAM musi by skonfigurowana z uprawnieniami, kt贸re pozwalaj na niezbdne dziaania w innych usugach AWS. Na przykad, jeli Twoja maszyna stanowa musi wywoywa funkcje AWS Lambda, rola IAM musi mie uprawnienia **`lambda:InvokeFunction`**. Podobnie, jeli musi zapisywa w DynamoDB, odpowiednie uprawnienia (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, itp.) musz by udzielone.
- **Najmniejsze uprawnienia**: Zaleca si stosowanie zasady najmniejszych uprawnie podczas konfigurowania r贸l IAM dla Step Functions. Oznacza to przyznawanie tylko tych uprawnie, kt贸re s niezbdne do wykonania okrelonych dziaa przez maszyn stanow, i nie wicej. Polityki IAM powinny by ograniczone do konkretnych zasob贸w i dziaa, zmniejszajc ryzyko niezamierzonego dostpu.

## Wyliczanie

Polityka ReadOnlyAccess jest wystarczajca do wszystkich poni偶szych dziaa wyliczania.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Eskalacja uprawnie

Na nastpnej stronie mo偶esz sprawdzi, jak **nadu偶y uprawnienia Step Functions do eskalacji uprawnie**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Po eksploatacji

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Odnoniki

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Zdobd藕 wiedz na temat hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
