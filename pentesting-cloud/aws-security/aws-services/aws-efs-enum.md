# AWS - EFS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## EFS

### Informaci칩n B치sica

Amazon Elastic File System (EFS) se presenta como un **sistema de archivos de red completamente gestionado, escalable y el치stico** por AWS. El servicio facilita la creaci칩n y configuraci칩n de **sistemas de archivos** que pueden ser accedidos simult치neamente por m칰ltiples instancias de EC2 y otros servicios de AWS. Las caracter칤sticas clave de EFS incluyen su capacidad para escalar autom치ticamente sin intervenci칩n manual, proporcionar acceso de baja latencia, soportar cargas de trabajo de alto rendimiento, garantizar la durabilidad de los datos e integrarse sin problemas con varios mecanismos de seguridad de AWS.

Por **defecto**, la carpeta de EFS a montar ser치 **`/`** pero podr칤a tener un **nombre diferente**.

### Acceso a la Red

Un EFS se crea en una VPC y ser칤a **por defecto accesible en todas las subredes de la VPC**. Sin embargo, el EFS tendr치 un Grupo de Seguridad. Para **dar acceso a un EC2** (o cualquier otro servicio de AWS) para montar el EFS, es necesario **permitir en el grupo de seguridad de EFS una regla de entrada NFS** (puerto 2049) **desde el Grupo de Seguridad de EC2**.

Sin esto, **no podr치s contactar el servicio NFS**.

Para m치s informaci칩n sobre c칩mo hacer esto, consulta: [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### Enumeraci칩n
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20 # or /16 to be sure
```
{% hint style="danger" %}
Puede ser que el punto de montaje de EFS est칠 dentro de la misma VPC pero en una subred diferente. Si quieres asegurarte de encontrar todos los **puntos EFS, ser칤a mejor escanear la m치scara de red `/16`**.
{% endhint %}

### Montar EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### Acceso IAM

Por **defecto**, cualquier persona con **acceso a la red al EFS** podr치 montarlo, **leerlo y escribir en 칠l incluso como usuario root**. Sin embargo, las pol칤ticas del sistema de archivos podr칤an estar en vigor **solo permitiendo a los principales con permisos espec칤ficos** acceder a 칠l.\
Por ejemplo, esta pol칤tica del sistema de archivos **no permitir치 ni siquiera montar** el sistema de archivos si **no tienes el permiso IAM**:
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
O esto **prevendr치 el acceso an칩nimo**:

<figure><img src="../../../.gitbook/assets/image (278).png" alt=""><figcaption></figcaption></figure>

Tenga en cuenta que para montar sistemas de archivos protegidos por IAM DEBE usar el tipo "efs" en el comando de montaje:
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### Puntos de Acceso

**Los puntos de acceso** son **puntos de entrada** espec칤ficos de **aplicaci칩n** **a un sistema de archivos EFS** que facilitan la gesti칩n del acceso de la aplicaci칩n a conjuntos de datos compartidos.

Cuando creas un punto de acceso, puedes **especificar el propietario y los permisos POSIX** para los archivos y directorios creados a trav칠s del punto de acceso. Tambi칠n puedes **definir un directorio ra칤z personalizado** para el punto de acceso, ya sea especificando un directorio existente o creando uno nuevo con los permisos deseados. Esto te permite **controlar el acceso a tu sistema de archivos EFS de manera espec칤fica por aplicaci칩n o por usuario**, facilitando la gesti칩n y seguridad de tus datos de archivos compartidos.

**Puedes montar el sistema de archivos desde un punto de acceso con algo como:**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
Tenga en cuenta que incluso al intentar montar un punto de acceso, a칰n necesita poder **contactar el servicio NFS a trav칠s de la red**, y si el EFS tiene una **pol칤tica** de sistema de archivos, necesita **suficientes permisos de IAM** para montarlo.
{% endhint %}

Los puntos de acceso se pueden utilizar para los siguientes prop칩sitos:

* **Simplificar la gesti칩n de permisos**: Al definir un usuario y grupo POSIX para cada punto de acceso, puede gestionar f치cilmente los permisos de acceso para diferentes aplicaciones o usuarios sin modificar los permisos del sistema de archivos subyacente.
* **Hacer cumplir un directorio ra칤z**: Los puntos de acceso pueden restringir el acceso a un directorio espec칤fico dentro del sistema de archivos EFS, asegurando que cada aplicaci칩n o usuario opere dentro de su carpeta designada. Esto ayuda a prevenir la exposici칩n accidental de datos o modificaciones.
* **Acceso m치s f치cil al sistema de archivos**: Los puntos de acceso se pueden asociar con una funci칩n de AWS Lambda o una tarea de AWS Fargate, simplificando el acceso al sistema de archivos para aplicaciones sin servidor y en contenedores.

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post Explotaci칩n

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persistencia

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 춰Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
