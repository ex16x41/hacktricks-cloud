# AWS - EFS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## EFS

### åŸºæœ¬ä¿¡æ¯

Amazon Elastic File System (EFS) è¢« AWS è§†ä¸ºä¸€ä¸ª **å®Œå…¨æ‰˜ç®¡ã€å¯æ‰©å±•å’Œå¼¹æ€§çš„ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ**ã€‚è¯¥æœåŠ¡ä¾¿äºåˆ›å»ºå’Œé…ç½® **æ–‡ä»¶ç³»ç»Ÿ**ï¼Œå¤šä¸ª EC2 å®ä¾‹å’Œå…¶ä»– AWS æœåŠ¡å¯ä»¥åŒæ—¶è®¿é—®ã€‚EFS çš„ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬èƒ½å¤Ÿåœ¨æ— éœ€äººå·¥å¹²é¢„çš„æƒ…å†µä¸‹è‡ªåŠ¨æ‰©å±•ï¼Œæä¾›ä½å»¶è¿Ÿè®¿é—®ï¼Œæ”¯æŒé«˜ååé‡å·¥ä½œè´Ÿè½½ï¼Œä¿è¯æ•°æ®æŒä¹…æ€§ï¼Œå¹¶ä¸å„ç§ AWS å®‰å…¨æœºåˆ¶æ— ç¼é›†æˆã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒEFS æŒ‚è½½çš„æ–‡ä»¶å¤¹å°†æ˜¯ **`/`**ï¼Œä½†å®ƒå¯èƒ½æœ‰ **ä¸åŒçš„åç§°**ã€‚

### ç½‘ç»œè®¿é—®

EFS åˆ›å»ºåœ¨ VPC ä¸­ï¼Œ**é»˜è®¤æƒ…å†µä¸‹åœ¨æ‰€æœ‰ VPC å­ç½‘ä¸­å¯è®¿é—®**ã€‚ä½†æ˜¯ï¼ŒEFS å°†å…·æœ‰ä¸€ä¸ªå®‰å…¨ç»„ã€‚ä¸ºäº† **å…è®¸ EC2**ï¼ˆæˆ–ä»»ä½•å…¶ä»– AWS æœåŠ¡ï¼‰æŒ‚è½½ EFSï¼Œéœ€è¦ **åœ¨ EFS å®‰å…¨ç»„ä¸­å…è®¸æ¥è‡ª EC2 å®‰å…¨ç»„çš„å…¥ç«™ NFS**ï¼ˆ2049 ç«¯å£ï¼‰**è§„åˆ™**ã€‚

æ²¡æœ‰è¿™ä¸ªï¼Œæ‚¨ **å°†æ— æ³•è”ç³» NFS æœåŠ¡**ã€‚

æœ‰å…³å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š[https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### æšä¸¾
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20 # or /16 to be sure
```
{% hint style="danger" %}
EFSæŒ‚è½½ç‚¹å¯èƒ½åœ¨åŒä¸€ä¸ªVPCå†…ï¼Œä½†åœ¨ä¸åŒçš„å­ç½‘ä¸­ã€‚å¦‚æœä½ æƒ³ç¡®ä¿æ‰¾åˆ°æ‰€æœ‰**EFSç‚¹ï¼Œæœ€å¥½æ‰«æ`/16`å­ç½‘æ©ç **ã€‚
{% endhint %}

### æŒ‚è½½EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### IAM è®¿é—®

é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½•å…·æœ‰å¯¹ EFS çš„ç½‘ç»œè®¿é—®çš„äººéƒ½èƒ½å¤ŸæŒ‚è½½ã€è¯»å–å’Œå†™å…¥å®ƒï¼Œå³ä½¿æ˜¯æ ¹ç”¨æˆ·ã€‚ç„¶è€Œï¼Œæ–‡ä»¶ç³»ç»Ÿç­–ç•¥å¯èƒ½ä¼šé™åˆ¶ä»…å…è®¸å…·æœ‰ç‰¹å®šæƒé™çš„ä¸»ä½“è®¿é—®å®ƒã€‚\
ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ²¡æœ‰ IAM æƒé™ï¼Œè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿç­–ç•¥å°†**ä¸å…è®¸æŒ‚è½½**æ–‡ä»¶ç³»ç»Ÿï¼š
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
æˆ–è€…è¿™å°†**é˜²æ­¢åŒ¿åè®¿é—®**ï¼š

<figure><img src="../../../.gitbook/assets/image (278).png" alt=""><figcaption></figcaption></figure>

è¯·æ³¨æ„ï¼Œè¦æŒ‚è½½å— IAM ä¿æŠ¤çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ‚¨å¿…é¡»åœ¨æŒ‚è½½å‘½ä»¤ä¸­ä½¿ç”¨ç±»å‹ "efs"ï¼š
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### Access Points

**è®¿é—®ç‚¹**æ˜¯**ç‰¹å®šäºåº”ç”¨ç¨‹åº**çš„å…¥å£ç‚¹**è¿›å…¥EFSæ–‡ä»¶ç³»ç»Ÿ**ï¼Œä½¿ç®¡ç†åº”ç”¨ç¨‹åºå¯¹å…±äº«æ•°æ®é›†çš„è®¿é—®å˜å¾—æ›´å®¹æ˜“ã€‚

å½“æ‚¨åˆ›å»ºè®¿é—®ç‚¹æ—¶ï¼Œæ‚¨å¯ä»¥**æŒ‡å®šé€šè¿‡è®¿é—®ç‚¹åˆ›å»ºçš„æ–‡ä»¶å’Œç›®å½•çš„æ‰€æœ‰è€…å’ŒPOSIXæƒé™**ã€‚æ‚¨è¿˜å¯ä»¥**ä¸ºè®¿é—®ç‚¹å®šä¹‰è‡ªå®šä¹‰æ ¹ç›®å½•**ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šç°æœ‰ç›®å½•æˆ–åˆ›å»ºä¸€ä¸ªå…·æœ‰æ‰€éœ€æƒé™çš„æ–°ç›®å½•æ¥å®ç°ã€‚è¿™ä½¿æ‚¨èƒ½å¤Ÿ**æŒ‰åº”ç”¨ç¨‹åºæˆ–ç”¨æˆ·æ§åˆ¶å¯¹EFSæ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®**ï¼Œä»è€Œæ›´å®¹æ˜“ç®¡ç†å’Œä¿æŠ¤æ‚¨çš„å…±äº«æ–‡ä»¶æ•°æ®ã€‚

**æ‚¨å¯ä»¥é€šè¿‡è®¿é—®ç‚¹æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä¾‹å¦‚ï¼š**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œå³ä½¿å°è¯•æŒ‚è½½è®¿é—®ç‚¹ï¼Œæ‚¨ä»ç„¶éœ€è¦èƒ½å¤Ÿ**é€šè¿‡ç½‘ç»œè”ç³»NFSæœåŠ¡**ï¼Œå¦‚æœEFSæœ‰æ–‡ä»¶ç³»ç»Ÿ**ç­–ç•¥**ï¼Œæ‚¨éœ€è¦**è¶³å¤Ÿçš„IAMæƒé™**æ¥æŒ‚è½½å®ƒã€‚
{% endhint %}

è®¿é—®ç‚¹å¯ä»¥ç”¨äºä»¥ä¸‹ç›®çš„ï¼š

* **ç®€åŒ–æƒé™ç®¡ç†**ï¼šé€šè¿‡ä¸ºæ¯ä¸ªè®¿é—®ç‚¹å®šä¹‰ä¸€ä¸ªPOSIXç”¨æˆ·å’Œç»„ï¼Œæ‚¨å¯ä»¥è½»æ¾ç®¡ç†ä¸åŒåº”ç”¨ç¨‹åºæˆ–ç”¨æˆ·çš„è®¿é—®æƒé™ï¼Œè€Œæ— éœ€ä¿®æ”¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„æƒé™ã€‚
* **å¼ºåˆ¶æ ¹ç›®å½•**ï¼šè®¿é—®ç‚¹å¯ä»¥é™åˆ¶å¯¹EFSæ–‡ä»¶ç³»ç»Ÿä¸­ç‰¹å®šç›®å½•çš„è®¿é—®ï¼Œç¡®ä¿æ¯ä¸ªåº”ç”¨ç¨‹åºæˆ–ç”¨æˆ·åœ¨å…¶æŒ‡å®šçš„æ–‡ä»¶å¤¹å†…æ“ä½œã€‚è¿™æœ‰åŠ©äºé˜²æ­¢æ„å¤–çš„æ•°æ®æ³„éœ²æˆ–ä¿®æ”¹ã€‚
* **æ›´å®¹æ˜“çš„æ–‡ä»¶ç³»ç»Ÿè®¿é—®**ï¼šè®¿é—®ç‚¹å¯ä»¥ä¸AWS Lambdaå‡½æ•°æˆ–AWS Fargateä»»åŠ¡å…³è”ï¼Œä»è€Œç®€åŒ–æ— æœåŠ¡å™¨å’Œå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„æ–‡ä»¶ç³»ç»Ÿè®¿é—®ã€‚

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶(ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶(GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
