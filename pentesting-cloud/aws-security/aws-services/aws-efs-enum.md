# AWS - EFS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## EFS

### Basic Information

Amazon Elastic File System (EFS) est pr√©sent√© comme un **syst√®me de fichiers r√©seau enti√®rement g√©r√©, √©volutif et √©lastique** par AWS. Le service facilite la cr√©ation et la configuration de **syst√®mes de fichiers** qui peuvent √™tre accessibles simultan√©ment par plusieurs instances EC2 et d'autres services AWS. Les principales caract√©ristiques d'EFS incluent sa capacit√© √† √©voluer automatiquement sans intervention manuelle, √† fournir un acc√®s √† faible latence, √† prendre en charge des charges de travail √† haut d√©bit, √† garantir la durabilit√© des donn√©es et √† s'int√©grer parfaitement √† divers m√©canismes de s√©curit√© AWS.

Par **d√©faut**, le dossier EFS √† monter sera **`/`** mais il pourrait avoir un **nom diff√©rent**.

### Network Access

Un EFS est cr√©√© dans un VPC et serait **par d√©faut accessible dans tous les sous-r√©seaux VPC**. Cependant, l'EFS aura un groupe de s√©curit√©. Afin de **donner acc√®s √† un EC2** (ou tout autre service AWS) pour monter l'EFS, il est n√©cessaire de **permettre dans le groupe de s√©curit√© EFS une r√®gle NFS entrante** (port 2049) **en provenance du groupe de s√©curit√© EC2**.

Sans cela, vous **ne pourrez pas contacter le service NFS**.

Pour plus d'informations sur la fa√ßon de proc√©der, consultez : [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### Enumeration
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20 # or /16 to be sure
```
{% hint style="danger" %}
Il se peut que le point de montage EFS soit dans le m√™me VPC mais dans un sous-r√©seau diff√©rent. Si vous voulez √™tre s√ªr de trouver tous les **points EFS, il serait pr√©f√©rable de scanner le masque de r√©seau `/16`**.
{% endhint %}

### Monter EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### IAM Access

Par **d√©faut**, toute personne ayant **un acc√®s r√©seau √† l'EFS** pourra le monter, **le lire et y √©crire m√™me en tant qu'utilisateur root**. Cependant, des politiques de syst√®me de fichiers pourraient √™tre en place **n'autorisant que les principaux avec des autorisations sp√©cifiques** √† y acc√©der.\
Par exemple, cette politique de syst√®me de fichiers **ne permettra m√™me pas de monter** le syst√®me de fichiers si vous **n'avez pas la permission IAM** :
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
Ou cela **pr√©ventera l'acc√®s anonyme** :

<figure><img src="../../../.gitbook/assets/image (278).png" alt=""><figcaption></figcaption></figure>

Notez que pour monter des syst√®mes de fichiers prot√©g√©s par IAM, vous DEVEZ utiliser le type "efs" dans la commande de montage :
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### Points d'acc√®s

**Les points d'acc√®s** sont des points d'entr√©e **sp√©cifiques √† l'application** **dans un syst√®me de fichiers EFS** qui facilitent la gestion de l'acc√®s des applications aux ensembles de donn√©es partag√©s.

Lorsque vous cr√©ez un point d'acc√®s, vous pouvez **sp√©cifier le propri√©taire et les permissions POSIX** pour les fichiers et r√©pertoires cr√©√©s via le point d'acc√®s. Vous pouvez √©galement **d√©finir un r√©pertoire racine personnalis√©** pour le point d'acc√®s, soit en sp√©cifiant un r√©pertoire existant, soit en en cr√©ant un nouveau avec les permissions souhait√©es. Cela vous permet de **contr√¥ler l'acc√®s √† votre syst√®me de fichiers EFS sur une base par application ou par utilisateur**, facilitant ainsi la gestion et la s√©curisation de vos donn√©es de fichiers partag√©es.

**Vous pouvez monter le syst√®me de fichiers √† partir d'un point d'acc√®s avec quelque chose comme :**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
Notez que m√™me en essayant de monter un point d'acc√®s, vous devez toujours √™tre en mesure de **contacter le service NFS via le r√©seau**, et si l'EFS a une **politique** de syst√®me de fichiers, vous avez besoin de **suffisantes autorisations IAM** pour le monter.
{% endhint %}

Les points d'acc√®s peuvent √™tre utilis√©s pour les objectifs suivants :

* **Simplifier la gestion des autorisations** : En d√©finissant un utilisateur et un groupe POSIX pour chaque point d'acc√®s, vous pouvez facilement g√©rer les autorisations d'acc√®s pour diff√©rentes applications ou utilisateurs sans modifier les autorisations du syst√®me de fichiers sous-jacent.
* **Imposer un r√©pertoire racine** : Les points d'acc√®s peuvent restreindre l'acc√®s √† un r√©pertoire sp√©cifique au sein du syst√®me de fichiers EFS, garantissant que chaque application ou utilisateur op√®re dans son dossier d√©sign√©. Cela aide √† pr√©venir l'exposition ou la modification accidentelle des donn√©es.
* **Acc√®s au syst√®me de fichiers plus facile** : Les points d'acc√®s peuvent √™tre associ√©s √† une fonction AWS Lambda ou √† une t√¢che AWS Fargate, simplifiant l'acc√®s au syst√®me de fichiers pour les applications sans serveur et conteneuris√©es.

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
