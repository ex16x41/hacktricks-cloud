# AWS - EFS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## EFS

### Podstawowe informacje

Amazon Elastic File System (EFS) jest przedstawiany jako **w peni zarzdzany, skalowalny i elastyczny system plik贸w sieciowych** przez AWS. Usuga uatwia tworzenie i konfiguracj **system贸w plik贸w**, kt贸re mog by jednoczenie dostpne przez wiele instancji EC2 i inne usugi AWS. Kluczowe cechy EFS obejmuj jego zdolno do automatycznego skalowania bez interwencji rcznej, zapewnianie dostpu o niskim op贸藕nieniu, wsparcie dla obci偶e o wysokiej przepustowoci, gwarancj trwaoci danych oraz bezproblemow integracj z r贸偶nymi mechanizmami bezpieczestwa AWS.

Domylnie folder EFS do zamontowania bdzie **`/`**, ale mo偶e mie **inn nazw**.

### Dostp sieciowy

EFS jest tworzony w VPC i bdzie **domylnie dostpny we wszystkich podsieciach VPC**. Jednak EFS bdzie mia Grup Bezpieczestwa. Aby **da dostp do EC2** (lub jakiejkolwiek innej usugi AWS) do zamontowania EFS, nale偶y **zezwoli w grupie bezpieczestwa EFS na regu przychodzc NFS** (port 2049) **z Grupy Bezpieczestwa EC2**.

Bez tego **nie bdziesz w stanie skontaktowa si z usug NFS**.

Aby uzyska wicej informacji na ten temat, sprawd藕: [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### Enumeracja
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20 # or /16 to be sure
```
{% hint style="danger" %}
Mo偶e si zdarzy, 偶e punkt montowania EFS znajduje si w tej samej VPC, ale w innej podsieci. Jeli chcesz mie pewno, 偶e znajdziesz wszystkie **punkty EFS, lepiej zeskanowa mask sieciow `/16`**.
{% endhint %}

### Montowanie EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### IAM Access

Domylnie ka偶dy, kto ma dostp do sieci do EFS, bdzie m贸g zamontowa, odczyta i zapisa go nawet jako u偶ytkownik root. Jednak polityki systemu plik贸w mog by wprowadzone, **zezwalajc tylko na dostp dla podmiot贸w z okrelonymi uprawnieniami**.\
Na przykad, ta polityka systemu plik贸w **nie pozwoli nawet na zamontowanie** systemu plik贸w, jeli **nie masz uprawnienia IAM**:
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
Lub to **zapobiegnie dostpowi anonimowemu**:

<figure><img src="../../../.gitbook/assets/image (278).png" alt=""><figcaption></figcaption></figure>

Zauwa偶, 偶e aby zamontowa systemy plik贸w chronione przez IAM, MUSISZ u偶y typu "efs" w poleceniu montowania:
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### Access Points

**Punkty dostpu** to **specyficzne dla aplikacji** punkty wejcia **do systemu plik贸w EFS**, kt贸re uatwiaj zarzdzanie dostpem aplikacji do wsp贸lnych zbior贸w danych.

Kiedy tworzysz punkt dostpu, mo偶esz **okreli waciciela i uprawnienia POSIX** dla plik贸w i katalog贸w tworzonych przez punkt dostpu. Mo偶esz r贸wnie偶 **zdefiniowa niestandardowy katalog g贸wny** dla punktu dostpu, albo poprzez okrelenie istniejcego katalogu, albo poprzez utworzenie nowego z po偶danymi uprawnieniami. Umo偶liwia to **kontrolowanie dostpu do systemu plik贸w EFS na poziomie aplikacji lub u偶ytkownika**, co uatwia zarzdzanie i zabezpieczanie wsp贸lnych danych plikowych.

**Mo偶esz zamontowa system plik贸w z punktu dostpu za pomoc czego takiego jak:**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
Zauwa偶, 偶e nawet pr贸bujc zamontowa punkt dostpu, nadal musisz by w stanie **skontaktowa si z usug NFS przez sie**, a jeli EFS ma **polityk** systemu plik贸w, potrzebujesz **wystarczajcych uprawnie IAM**, aby go zamontowa.
{% endhint %}

Punkty dostpu mog by u偶ywane do nastpujcych cel贸w:

* **Uproszczenie zarzdzania uprawnieniami**: Definiujc u偶ytkownika i grup POSIX dla ka偶dego punktu dostpu, mo偶esz atwo zarzdza uprawnieniami dostpu dla r贸偶nych aplikacji lub u偶ytkownik贸w bez modyfikowania uprawnie systemu plik贸w.
* **Wymuszenie katalogu g贸wnego**: Punkty dostpu mog ogranicza dostp do konkretnego katalogu w systemie plik贸w EFS, zapewniajc, 偶e ka偶da aplikacja lub u偶ytkownik dziaa w swoim wyznaczonym folderze. Pomaga to zapobiega przypadkowemu ujawnieniu lub modyfikacji danych.
* **atwiejszy dostp do systemu plik贸w**: Punkty dostpu mog by powizane z funkcj AWS Lambda lub zadaniem AWS Fargate, co upraszcza dostp do systemu plik贸w dla aplikacji bezserwerowych i konteneryzowanych.

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
