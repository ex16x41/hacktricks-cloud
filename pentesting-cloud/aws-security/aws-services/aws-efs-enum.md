# AWS - EFS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## EFS

### Basic Information

O Amazon Elastic File System (EFS) √© apresentado como um **sistema de arquivos de rede totalmente gerenciado, escal√°vel e el√°stico** pela AWS. O servi√ßo facilita a cria√ß√£o e configura√ß√£o de **sistemas de arquivos** que podem ser acessados simultaneamente por v√°rias inst√¢ncias EC2 e outros servi√ßos da AWS. As principais caracter√≠sticas do EFS incluem sua capacidade de escalar automaticamente sem interven√ß√£o manual, provisionar acesso de baixa lat√™ncia, suportar cargas de trabalho de alto rendimento, garantir a durabilidade dos dados e integrar-se perfeitamente com v√°rios mecanismos de seguran√ßa da AWS.

Por **padr√£o**, a pasta do EFS a ser montada ser√° **`/`**, mas pode ter um **nome diferente**.

### Network Access

Um EFS √© criado em uma VPC e seria **por padr√£o acess√≠vel em todas as sub-redes da VPC**. No entanto, o EFS ter√° um Grupo de Seguran√ßa. Para **dar acesso a um EC2** (ou qualquer outro servi√ßo da AWS) para montar o EFS, √© necess√°rio **permitir no grupo de seguran√ßa do EFS uma regra de entrada NFS** (porta 2049) **do Grupo de Seguran√ßa do EC2**.

Sem isso, voc√™ **n√£o poder√° contatar o servi√ßo NFS**.

Para mais informa√ß√µes sobre como fazer isso, consulte: [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### Enumeration
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20 # or /16 to be sure
```
{% hint style="danger" %}
Pode ser que o ponto de montagem do EFS esteja dentro da mesma VPC, mas em uma sub-rede diferente. Se voc√™ quiser ter certeza de que encontrar√° todos os **pontos EFS, seria melhor escanear a m√°scara de rede `/16`**.
{% endhint %}

### Montar EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### Acesso IAM

Por **padr√£o**, qualquer pessoa com **acesso √† rede ao EFS** poder√° montar, **ler e escrever nele, mesmo como usu√°rio root**. No entanto, pol√≠ticas de Sistema de Arquivos podem estar em vigor **permitindo apenas que principais com permiss√µes espec√≠ficas** acessem.\
Por exemplo, esta pol√≠tica de Sistema de Arquivos **n√£o permitir√° nem mesmo montar** o sistema de arquivos se voc√™ **n√£o tiver a permiss√£o IAM**:
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
Ou isso **impedir√° o acesso an√¥nimo**:

<figure><img src="../../../.gitbook/assets/image (278).png" alt=""><figcaption></figcaption></figure>

Observe que para montar sistemas de arquivos protegidos por IAM, voc√™ DEVE usar o tipo "efs" no comando de montagem:
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### Access Points

**Os pontos de acesso** s√£o **pontos de entrada** espec√≠ficos de **aplica√ß√£o** **em um sistema de arquivos EFS** que facilitam o gerenciamento do acesso da aplica√ß√£o a conjuntos de dados compartilhados.

Quando voc√™ cria um ponto de acesso, pode **especificar o propriet√°rio e as permiss√µes POSIX** para os arquivos e diret√≥rios criados atrav√©s do ponto de acesso. Voc√™ tamb√©m pode **definir um diret√≥rio raiz personalizado** para o ponto de acesso, seja especificando um diret√≥rio existente ou criando um novo com as permiss√µes desejadas. Isso permite que voc√™ **controle o acesso ao seu sistema de arquivos EFS com base em cada aplica√ß√£o ou usu√°rio**, facilitando o gerenciamento e a seguran√ßa dos seus dados de arquivo compartilhados.

**Voc√™ pode montar o sistema de arquivos a partir de um ponto de acesso com algo como:**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
Observe que mesmo tentando montar um ponto de acesso, voc√™ ainda precisa ser capaz de **contatar o servi√ßo NFS via rede**, e se o EFS tiver uma **pol√≠tica** de sistema de arquivos, voc√™ precisa de **permiss√µes IAM suficientes** para mont√°-lo.
{% endhint %}

Os pontos de acesso podem ser usados para os seguintes prop√≥sitos:

* **Simplificar a gest√£o de permiss√µes**: Ao definir um usu√°rio e grupo POSIX para cada ponto de acesso, voc√™ pode gerenciar facilmente as permiss√µes de acesso para diferentes aplica√ß√µes ou usu√°rios sem modificar as permiss√µes do sistema de arquivos subjacente.
* **Impor um diret√≥rio raiz**: Os pontos de acesso podem restringir o acesso a um diret√≥rio espec√≠fico dentro do sistema de arquivos EFS, garantindo que cada aplica√ß√£o ou usu√°rio opere dentro de sua pasta designada. Isso ajuda a prevenir a exposi√ß√£o acidental de dados ou modifica√ß√£o.
* **Acesso mais f√°cil ao sistema de arquivos**: Os pontos de acesso podem ser associados a uma fun√ß√£o AWS Lambda ou a uma tarefa AWS Fargate, simplificando o acesso ao sistema de arquivos para aplica√ß√µes sem servidor e containerizadas.

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## P√≥s Explora√ß√£o

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persist√™ncia

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
