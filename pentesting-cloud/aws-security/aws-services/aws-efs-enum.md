# AWS - EFS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## EFS

### Grundlegende Informationen

Amazon Elastic File System (EFS) wird von AWS als **vollst√§ndig verwaltetes, skalierbares und elastisches Netzwerkdateisystem** pr√§sentiert. Der Dienst erleichtert die Erstellung und Konfiguration von **Dateisystemen**, die gleichzeitig von mehreren EC2-Instanzen und anderen AWS-Diensten zugegriffen werden k√∂nnen. Die Hauptmerkmale von EFS umfassen die F√§higkeit, automatisch ohne manuelles Eingreifen zu skalieren, einen latenzarmen Zugriff bereitzustellen, hochdurchsatzf√§hige Workloads zu unterst√ºtzen, die Datenhaltbarkeit zu garantieren und nahtlos mit verschiedenen AWS-Sicherheitsmechanismen zu integrieren.

Standardm√§√üig wird der EFS-Ordner, der gemountet werden soll, **`/`** sein, k√∂nnte jedoch einen **anderen Namen** haben.

### Netzwerkzugang

Ein EFS wird in einer VPC erstellt und w√§re **standardm√§√üig in allen VPC-Subnetzen zug√§nglich**. Der EFS wird jedoch eine Sicherheitsgruppe haben. Um **einem EC2** (oder einem anderen AWS-Dienst) den Zugriff auf das Mounten des EFS zu gew√§hren, ist es erforderlich, in der EFS-Sicherheitsgruppe eine eingehende NFS** (Port 2049) **Regel von der EC2-Sicherheitsgruppe zuzulassen**.

Ohne dies **werden Sie nicht in der Lage sein, den NFS-Dienst zu kontaktieren**.

F√ºr weitere Informationen dar√ºber, wie man dies macht, siehe: [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### Aufz√§hlung
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20 # or /16 to be sure
```
{% hint style="danger" %}
Es k√∂nnte sein, dass der EFS-Mount-Punkt im selben VPC, aber in einem anderen Subnetz ist. Wenn Sie sicherstellen m√∂chten, dass Sie alle **EFS-Punkte finden, w√§re es besser, die `/16`-Netzmaske zu scannen**.
{% endhint %}

### Mount EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### IAM-Zugriff

Standardm√§√üig kann jeder mit Netzwerkzugang zum EFS es **einbinden, lesen und schreiben, sogar als Root-Benutzer**. Es k√∂nnten jedoch Dateisystemrichtlinien vorhanden sein, die **nur bestimmten Benutzern mit spezifischen Berechtigungen** den Zugriff erlauben.\
Zum Beispiel wird diese Dateisystemrichtlinie **nicht einmal das Einbinden** des Dateisystems erlauben, wenn Sie **nicht die IAM-Berechtigung** haben:
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
Oder dies wird **anonymen Zugriff verhindern**:

<figure><img src="../../../.gitbook/assets/image (278).png" alt=""><figcaption></figcaption></figure>

Beachten Sie, dass Sie zum Einh√§ngen von Dateisystemen, die durch IAM gesch√ºtzt sind, den Typ "efs" im Einh√§ngebefehl verwenden M√úSSEN:
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### Access Points

**Zugangspunkte** sind **anwendungs**spezifische Einstiegspunkte **in ein EFS-Dateisystem**, die es einfacher machen, den Zugriff von Anwendungen auf gemeinsame Datens√§tze zu verwalten.

Wenn Sie einen Zugangspunkt erstellen, k√∂nnen Sie **den Eigent√ºmer und die POSIX-Berechtigungen** f√ºr die Dateien und Verzeichnisse, die √ºber den Zugangspunkt erstellt werden, **spezifizieren**. Sie k√∂nnen auch **ein benutzerdefiniertes Stammverzeichnis** f√ºr den Zugangspunkt definieren, entweder indem Sie ein vorhandenes Verzeichnis angeben oder ein neues mit den gew√ºnschten Berechtigungen erstellen. Dies erm√∂glicht es Ihnen, **den Zugriff auf Ihr EFS-Dateisystem pro Anwendung oder pro Benutzer zu steuern**, was die Verwaltung und Sicherung Ihrer gemeinsamen Dateidaten erleichtert.

**Sie k√∂nnen das Dateisystem von einem Zugangspunkt mit etwas wie:**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
Beachten Sie, dass Sie selbst beim Versuch, einen Zugriffspunkt zu mounten, in der Lage sein m√ºssen, den **NFS-Dienst √ºber das Netzwerk zu kontaktieren**, und wenn das EFS eine **Richtlinie** f√ºr das Dateisystem hat, ben√∂tigen Sie **ausreichende IAM-Berechtigungen**, um es zu mounten.
{% endhint %}

Zugriffspunkte k√∂nnen f√ºr die folgenden Zwecke verwendet werden:

* **Vereinfachung der Berechtigungsverwaltung**: Durch die Definition eines POSIX-Benutzers und einer Gruppe f√ºr jeden Zugriffspunkt k√∂nnen Sie die Zugriffsberechtigungen f√ºr verschiedene Anwendungen oder Benutzer einfach verwalten, ohne die Berechtigungen des zugrunde liegenden Dateisystems zu √§ndern.
* **Durchsetzung eines Wurzelverzeichnisses**: Zugriffspunkte k√∂nnen den Zugriff auf ein bestimmtes Verzeichnis innerhalb des EFS-Dateisystems einschr√§nken, sodass jede Anwendung oder jeder Benutzer innerhalb seines zugewiesenen Ordners arbeitet. Dies hilft, versehentliche Datenexposition oder -√§nderung zu verhindern.
* **Einfacherer Zugriff auf das Dateisystem**: Zugriffspunkte k√∂nnen mit einer AWS Lambda-Funktion oder einer AWS Fargate-Aufgabe verkn√ºpft werden, was den Zugriff auf das Dateisystem f√ºr serverlose und containerisierte Anwendungen vereinfacht.

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
