# AWS - ECR Enum

## AWS - ECR Enum

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを送信してください。**

</details>
{% endhint %}

### ECR

#### 基本情報

Amazon **Elastic Container Registry** (Amazon ECR)は、**管理されたコンテナイメージレジストリサービス**です。これは、顧客がよく知られたインターフェースを使用してコンテナイメージと対話できる環境を提供するように設計されています。具体的には、Docker CLIや任意のクライアントの使用がサポートされており、コンテナイメージのプッシュ、プル、管理などの活動が可能です。

ECRは、**レジストリ**と**リポジトリ**の2種類のオブジェクトで構成されています。

**レジストリ**

すべてのAWSアカウントには2つのレジストリがあります：**プライベート**と**パブリック**。

1. **プライベートレジストリ**：

* **デフォルトでプライベート**：Amazon ECRプライベートレジストリに保存されたコンテナイメージは、**あなたのAWSアカウント内の認可されたユーザー**または許可を与えられたユーザーのみが**アクセス可能**です。
* **プライベートリポジトリ**のURIは、`<account_id>.dkr.ecr.<region>.amazonaws.com/<repo-name>`の形式に従います。
* **アクセス制御**：**IAMポリシー**を使用してプライベートコンテナイメージへの**アクセスを制御**でき、ユーザーやロールに基づいて細かい権限を設定できます。
* **AWSサービスとの統合**：Amazon ECRプライベートレジストリは、EKS、ECSなどの他のAWSサービスと簡単に**統合**できます。
* **他のプライベートレジストリオプション**：
* タグの不変性列はそのステータスを示し、タグの不変性が有効になっている場合、**既存のタグ**を持つイメージの**プッシュ**を上書きすることを**防ぎます**。
* **暗号化タイプ**列はリポジトリの暗号化プロパティを示し、AES-256などのデフォルトの暗号化タイプや**KMS**が有効な暗号化を表示します。
* **プルスルーキャッシュ**列はそのステータスを示し、プルスルーキャッシュのステータスがアクティブであれば、**外部のパブリックリポジトリのリポジトリをプライベートリポジトリにキャッシュ**します。
* 特定の**IAMポリシー**を設定して異なる**権限**を付与できます。
* **スキャン設定**により、リポジトリ内に保存されたイメージの脆弱性をスキャンできます。

2. **パブリックレジストリ**：

* **パブリックアクセス**：ECRパブリックレジストリに保存されたコンテナイメージは、**認証なしでインターネット上の誰でもアクセス可能**です。
* **パブリックリポジトリ**のURIは`public.ecr.aws/<random>/<name>`のようになります。ただし、`<random>`部分は管理者によって覚えやすい別の文字列に変更できます。

**リポジトリ**

これらは**プライベートレジストリ**または**パブリック**のイメージです。

{% hint style="info" %}
リポジトリにイメージをアップロードするには、**ECRリポジトリがイメージと同じ名前である必要があります**。
{% endhint %}

#### レジストリとリポジトリのポリシー

**レジストリとリポジトリ**には、他のプリンシパル/アカウントに権限を付与するために使用できる**ポリシー**もあります。たとえば、次のリポジトリポリシーの画像では、組織全体の任意のユーザーがイメージにアクセスできることがわかります：

<figure><img src="../../../.gitbook/assets/image (280).png" alt=""><figcaption></figcaption></figure>

#### 列挙

{% code overflow="wrap" %}
```bash
# Get repos
aws ecr describe-repositories
aws ecr describe-registry

# Get image metadata
aws ecr list-images --repository-name <repo_name>
aws ecr describe-images --repository-name <repo_name>
aws ecr describe-image-replication-status --repository-name <repo_name> --image-id <image_id>
aws ecr describe-image-scan-findings --repository-name <repo_name> --image-id <image_id>
aws ecr describe-pull-through-cache-rules --repository-name <repo_name> --image-id <image_id>

# Get public repositories
aws ecr-public describe-repositories

# Get policies
aws ecr get-registry-policy
aws ecr get-repository-policy --repository-name <repo_name>
```
{% endcode %}

#### 認証されていない列挙

{% content-ref url="../aws-unauthenticated-enum-access/aws-ecr-unauthenticated-enum.md" %}
[aws-ecr-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-ecr-unauthenticated-enum.md)
{% endcontent-ref %}

#### 権限昇格

次のページでは、**ECRの権限を悪用して権限を昇格させる方法**を確認できます：

{% content-ref url="../aws-privilege-escalation/aws-ecr-privesc.md" %}
[aws-ecr-privesc.md](../aws-privilege-escalation/aws-ecr-privesc.md)
{% endcontent-ref %}

#### ポストエクスプロイト

{% content-ref url="../aws-post-exploitation/aws-ecr-post-exploitation.md" %}
[aws-ecr-post-exploitation.md](../aws-post-exploitation/aws-ecr-post-exploitation.md)
{% endcontent-ref %}

#### 永続性

{% content-ref url="../aws-persistence/aws-ecr-persistence.md" %}
[aws-ecr-persistence.md](../aws-persistence/aws-ecr-persistence.md)
{% endcontent-ref %}

## 参考文献

* [https://docs.aws.amazon.com/AmazonECR/latest/APIReference/Welcome.html](https://docs.aws.amazon.com/AmazonECR/latest/APIReference/Welcome.html)

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。**

</details>
{% endhint %}
