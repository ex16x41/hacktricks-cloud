# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## VPC & Networking

Aprenda o que √© uma VPC e sobre seus componentes em:

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 √© utilizado para iniciar **servidores virtuais**. Ele permite a configura√ß√£o de **seguran√ßa** e **rede** e a gest√£o de **armazenamento**. A flexibilidade do Amazon EC2 √© evidente em sua capacidade de escalar recursos tanto para cima quanto para baixo, adaptando-se efetivamente a mudan√ßas de requisitos ou aumentos de popularidade. Esse recurso diminui a necessidade de previs√µes precisas de tr√°fego.

Coisas interessantes para enumerar no EC2:

* M√°quinas Virtuais
* Chaves SSH
* Dados do Usu√°rio
* EC2s/AMIs/Snapshots existentes
* Rede
* Redes
* Subredes
* IPs P√∫blicos
* Portas abertas
* Conex√µes integradas com outras redes fora da AWS

### Perfis de Inst√¢ncia

Usar **fun√ß√µes** para conceder permiss√µes a aplicativos que rodam em **inst√¢ncias EC2** requer um pouco de configura√ß√£o extra. Um aplicativo rodando em uma inst√¢ncia EC2 √© abstra√≠do da AWS pelo sistema operacional virtualizado. Por causa dessa separa√ß√£o extra, voc√™ precisa de um passo adicional para atribuir uma fun√ß√£o AWS e suas permiss√µes associadas a uma inst√¢ncia EC2 e torn√°-las dispon√≠veis para seus aplicativos.

Esse passo extra √© a **cria√ß√£o de um** [_**perfil de inst√¢ncia**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html) anexado √† inst√¢ncia. O **perfil de inst√¢ncia cont√©m a fun√ß√£o e** pode fornecer as credenciais tempor√°rias da fun√ß√£o a um aplicativo que roda na inst√¢ncia. Essas credenciais tempor√°rias podem ent√£o ser usadas nas chamadas de API do aplicativo para acessar recursos e limitar o acesso apenas aos recursos que a fun√ß√£o especifica. Observe que **apenas uma fun√ß√£o pode ser atribu√≠da a uma inst√¢ncia EC2** de cada vez, e todos os aplicativos na inst√¢ncia compartilham a mesma fun√ß√£o e permiss√µes.

### Endpoint de Metadados

Os metadados do AWS EC2 s√£o informa√ß√µes sobre uma inst√¢ncia do Amazon Elastic Compute Cloud (EC2) que est√£o dispon√≠veis para a inst√¢ncia em tempo de execu√ß√£o. Esses metadados s√£o usados para fornecer informa√ß√µes sobre a inst√¢ncia, como seu ID de inst√¢ncia, a zona de disponibilidade em que est√° rodando, a fun√ß√£o IAM associada √† inst√¢ncia e o nome do host da inst√¢ncia.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumera√ß√£o
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Acesso N√£o Autenticado

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Privesc

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes do EC2 para escalar privil√©gios**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### P√≥s-Explora√ß√£o

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS** (Elastic Block Store) **snapshots** s√£o basicamente **backups** est√°ticos de volumes EBS da AWS. Em outras palavras, s√£o **c√≥pias** dos **discos** anexados a uma **inst√¢ncia EC2** em um ponto espec√≠fico no tempo. Os snapshots do EBS podem ser copiados entre regi√µes e contas, ou at√© mesmo baixados e executados localmente.

Os snapshots podem conter **informa√ß√µes sens√≠veis** como **c√≥digo-fonte ou chaves de API**, portanto, se voc√™ tiver a chance, √© recomend√°vel verific√°-los.

### Diferen√ßa AMI & EBS

Uma **AMI** √© usada para **iniciar uma inst√¢ncia EC2**, enquanto um **Snapshot** do EC2 √© usado para **fazer backup e recuperar dados armazenados em um volume EBS**. Embora um Snapshot do EC2 possa ser usado para criar uma nova AMI, n√£o √© a mesma coisa que uma AMI, e n√£o inclui informa√ß√µes sobre o sistema operacional, servidor de aplicativos ou outro software necess√°rio para executar um aplicativo.

### Privesc

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes do EBS para escalar privil√©gios**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** permite gerenciar remotamente grupos de inst√¢ncias EC2 para facilitar muito suas administra√ß√µes. Cada uma dessas inst√¢ncias precisa estar executando o **servi√ßo SSM Agent, pois o servi√ßo ser√° o respons√°vel por receber as a√ß√µes e execut√°-las** a partir da API da AWS.

O **SSM Agent** possibilita que o Systems Manager atualize, gerencie e configure esses recursos. O agente **processa solicita√ß√µes do servi√ßo Systems Manager na nuvem AWS**, e ent√£o as executa conforme especificado na solicita√ß√£o.

O **SSM Agent vem** [**pr√©-instalado em algumas AMIs**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) ou voc√™ precisa [**instal√°-lo manualmente**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) nas inst√¢ncias. Al√©m disso, a fun√ß√£o IAM usada dentro da inst√¢ncia precisa ter a pol√≠tica **AmazonEC2RoleforSSM** anexada para poder se comunicar.

### Enumera√ß√£o
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Voc√™ pode verificar em uma inst√¢ncia EC2 se o Systems Manager est√° em execu√ß√£o apenas executando:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes do SSM para escalar privil√©gios**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) √© um **servi√ßo de balanceamento de carga para implanta√ß√µes da Amazon Web Services** (AWS). O ELB automaticamente **distribui o tr√°fego de aplica√ß√£o de entrada** e escala recursos para atender √† demanda de tr√°fego.

### Enumera√ß√£o
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Modelos de Lan√ßamento e Grupos de Autoescalonamento

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## Nitro

AWS Nitro √© um conjunto de **tecnologias inovadoras** que formam a plataforma subjacente para inst√¢ncias AWS EC2. Introduzido pela Amazon para **aumentar a seguran√ßa, desempenho e confiabilidade**, Nitro aproveita **componentes de hardware personalizados e um hipervisor leve**. Ele abstrai grande parte da funcionalidade de virtualiza√ß√£o tradicional para hardware e software dedicados, **minimizando a superf√≠cie de ataque** e melhorando a efici√™ncia dos recursos. Ao descarregar fun√ß√µes de virtualiza√ß√£o, Nitro permite que as inst√¢ncias EC2 ofere√ßam **desempenho quase bare-metal**, tornando-se particularmente ben√©fico para aplica√ß√µes que consomem muitos recursos. Al√©m disso, o Nitro Security Chip garante especificamente a **seguran√ßa do hardware e firmware**, solidificando ainda mais sua arquitetura robusta.

Obtenha mais informa√ß√µes e como enumer√°-las em:

{% content-ref url="aws-nitro-enum.md" %}
[aws-nitro-enum.md](aws-nitro-enum.md)
{% endcontent-ref %}

## VPN

Uma VPN permite conectar sua **rede local (site-to-site VPN)** ou os **laptops dos trabalhadores (Client VPN)** com uma **AWS VPC** para que os servi√ßos possam ser acessados sem precisar exp√¥-los √† internet.

#### Componentes B√°sicos da VPN da AWS

1. **Customer Gateway**:
* Um Customer Gateway √© um recurso que voc√™ cria na AWS para representar seu lado de uma conex√£o VPN.
* √â essencialmente um dispositivo f√≠sico ou aplicativo de software do seu lado da conex√£o Site-to-Site VPN.
* Voc√™ fornece informa√ß√µes de roteamento e o endere√ßo IP p√∫blico do seu dispositivo de rede (como um roteador ou um firewall) para a AWS para criar um Customer Gateway.
* Ele serve como um ponto de refer√™ncia para configurar a conex√£o VPN e n√£o gera cobran√ßas adicionais.
2. **Virtual Private Gateway**:
* Um Virtual Private Gateway (VPG) √© o concentrador VPN do lado da Amazon da conex√£o Site-to-Site VPN.
* Ele est√° anexado √† sua VPC e serve como o alvo para sua conex√£o VPN.
* O VPG √© o ponto final do lado da AWS para a conex√£o VPN.
* Ele gerencia a comunica√ß√£o segura entre sua VPC e sua rede local.
3. **Site-to-Site VPN Connection**:
* Uma conex√£o Site-to-Site VPN conecta sua rede local a uma VPC atrav√©s de um t√∫nel VPN IPsec seguro.
* Esse tipo de conex√£o requer um Customer Gateway e um Virtual Private Gateway.
* √â usado para comunica√ß√£o segura, est√°vel e consistente entre seu data center ou rede e seu ambiente AWS.
* Normalmente usado para conex√µes regulares e de longo prazo e √© cobrado com base na quantidade de dados transferidos pela conex√£o.
4. **Client VPN Endpoint**:
* Um endpoint Client VPN √© um recurso que voc√™ cria na AWS para habilitar e gerenciar sess√µes de VPN de cliente.
* √â usado para permitir que dispositivos individuais (como laptops, smartphones, etc.) se conectem de forma segura aos recursos da AWS ou √† sua rede local.
* Ele difere da Site-to-Site VPN na medida em que √© projetado para clientes individuais, em vez de conectar redes inteiras.
* Com o Client VPN, cada dispositivo cliente usa um software cliente VPN para estabelecer uma conex√£o segura.

Voc√™ pode [**encontrar mais informa√ß√µes sobre os benef√≠cios e componentes das VPNs da AWS aqui**](aws-vpc-and-networking-basic-information.md#vpn).

### Enumera√ß√£o
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Enumera√ß√£o Local

**Credenciais Tempor√°rias Locais**

Quando o Cliente VPN da AWS √© usado para se conectar a uma VPN, o usu√°rio geralmente **faz login na AWS** para obter acesso √† VPN. Em seguida, algumas **credenciais da AWS s√£o criadas e armazenadas** localmente para estabelecer a conex√£o VPN. Essas credenciais s√£o **armazenadas em** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` e cont√™m uma **AccessKey**, uma **SecretKey** e um **Token**.

As credenciais pertencem ao usu√°rio `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: pesquisar mais sobre as permiss√µes dessas credenciais).

**Arquivos de configura√ß√£o opvn**

Se uma **conex√£o VPN foi estabelecida**, voc√™ deve procurar por arquivos de configura√ß√£o **`.opvn`** no sistema. Al√©m disso, um lugar onde voc√™ poderia encontrar as **configura√ß√µes** √© em **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **P√≥s Explora√ß√£o**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
