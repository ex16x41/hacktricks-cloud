# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

{% hint style="success" %}
Naucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

## VPC & Networking

Dowiedz si, czym jest VPC i jakie s jego komponenty:

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 jest wykorzystywany do uruchamiania **wirtualnych serwer贸w**. Umo偶liwia konfiguracj **bezpieczestwa** i **sieci** oraz zarzdzanie **przechowywaniem danych**. Elastyczno Amazon EC2 jest widoczna w jego zdolnoci do skalowania zasob贸w zar贸wno w g贸r, jak i w d贸, skutecznie dostosowujc si do zmieniajcych si wymaga lub wzrostu popularnoci. Ta funkcja zmniejsza konieczno dokadnego przewidywania ruchu.

Interesujce rzeczy do enumeracji w EC2:

* Wirtualne Maszyny
* Klucze SSH
* Dane u偶ytkownika
* Istniejce EC2/AMIs/Snapshots
* Sieci
* Sieci
* Podsieci
* Publiczne IP
* Otwarte porty
* Zintegrowane poczenia z innymi sieciami poza AWS

### Instance Profiles

U偶ywanie **r贸l** do przyznawania uprawnie aplikacjom uruchamianym na **instancjach EC2** wymaga dodatkowej konfiguracji. Aplikacja uruchomiona na instancji EC2 jest oddzielona od AWS przez zwirtualizowany system operacyjny. Z powodu tego dodatkowego oddzielenia, potrzebny jest dodatkowy krok, aby przypisa rol AWS i jej zwizane uprawnienia do instancji EC2 i udostpni je aplikacjom.

Ten dodatkowy krok to **utworzenie** [_**instance profile**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) przypisanego do instancji. **Instance profile zawiera rol i** mo偶e dostarczy tymczasowe powiadczenia roli aplikacji uruchomionej na instancji. Te tymczasowe powiadczenia mog by nastpnie u偶ywane w wywoaniach API aplikacji do uzyskiwania dostpu do zasob贸w i ograniczania dostpu tylko do tych zasob贸w, kt贸re okrela rola. Nale偶y zauwa偶y, 偶e **tylko jedna rola mo偶e by przypisana do instancji EC2** w danym czasie, a wszystkie aplikacje na instancji dziel t sam rol i uprawnienia.

### Metadata Endpoint

AWS EC2 metadata to informacje o instancji Amazon Elastic Compute Cloud (EC2), kt贸re s dostpne dla instancji w czasie jej dziaania. Te metadata s u偶ywane do dostarczania informacji o instancji, takich jak jej ID instancji, strefa dostpnoci, w kt贸rej dziaa, rola IAM przypisana do instancji oraz nazwa hosta instancji.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumeration
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Nieautoryzowany Dostp

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Privesc

Na poni偶szej stronie mo偶esz sprawdzi, jak **wykorzysta uprawnienia EC2 do eskalacji uprawnie**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Post-Exploitation

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS** (Elastic Block Store) **snapshots** to w zasadzie statyczne **kopie zapasowe** wolumin贸w AWS EBS. Innymi sowy, s to **kopie** **dysk贸w** podczonych do **EC2** Instance w okrelonym momencie. Migawki EBS mog by kopiowane midzy regionami i kontami, a nawet pobierane i uruchamiane lokalnie.

Migawki mog zawiera **wra偶liwe informacje**, takie jak **kod 藕r贸dowy lub klucze API**, dlatego, jeli masz tak mo偶liwo, zaleca si ich sprawdzenie.

### R贸偶nica AMI & EBS

**AMI** jest u偶ywany do **uruchamiania instancji EC2**, podczas gdy migawka EC2 jest u偶ywana do **tworzenia kopii zapasowych i odzyskiwania danych przechowywanych na woluminie EBS**. Chocia偶 migawka EC2 mo偶e by u偶ywana do tworzenia nowego AMI, nie jest to to samo co AMI i nie zawiera informacji o systemie operacyjnym, serwerze aplikacji ani innym oprogramowaniu wymaganym do uruchomienia aplikacji.

### Privesc

Na poni偶szej stronie mo偶esz sprawdzi, jak **wykorzysta uprawnienia EBS do eskalacji uprawnie**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** pozwala na zdalne zarzdzanie flotami instancji EC2, aby uatwi ich administracj. Ka偶da z tych instancji musi mie uruchomion **usug SSM Agent, poniewa偶 to ona bdzie odbiera i wykonywa dziaania** z API AWS.

**SSM Agent** umo偶liwia Systems Manager aktualizowanie, zarzdzanie i konfigurowanie tych zasob贸w. Agent **przetwarza 偶dania z usugi Systems Manager w chmurze AWS**, a nastpnie wykonuje je zgodnie z okrelon specyfikacj.

**SSM Agent jest**[ **wstpnie zainstalowany w niekt贸rych AMI**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) lub trzeba go [**rcznie zainstalowa**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) na instancjach. Ponadto, rola IAM u偶ywana wewntrz instancji musi mie przypisan polityk **AmazonEC2RoleforSSM**, aby m贸c si komunikowa.

### Enumeracja
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Mo偶esz sprawdzi w instancji EC2, czy Systems Manager dziaa, po prostu wykonujc:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Na poni偶szej stronie mo偶esz sprawdzi, jak **wykorzysta uprawnienia SSM do eskalacji uprawnie**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) to **usuga r贸wnowa偶enia obci偶enia dla wdro偶e Amazon Web Services** (AWS). ELB automatycznie **rozdziela przychodzcy ruch aplikacji** i skalowuje zasoby, aby sprosta wymaganiom ruchu.

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Launch Templates & Autoscaling Groups

### Enumeration

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## Nitro

AWS Nitro to zestaw **innowacyjnych technologii**, kt贸re tworz podstawow platform dla instancji AWS EC2. Wprowadzony przez Amazon w celu **zwikszenia bezpieczestwa, wydajnoci i niezawodnoci**, Nitro wykorzystuje niestandardowe **komponenty sprztowe i lekki hipernadzorc**. Abstrahuje wiele tradycyjnych funkcji wirtualizacji do dedykowanego sprztu i oprogramowania, **minimalizujc powierzchni ataku** i poprawiajc efektywno zasob贸w. Dziki przeniesieniu funkcji wirtualizacji, Nitro pozwala instancjom EC2 dostarcza **wydajno zbli偶on do wydajnoci sprztu fizycznego**, co jest szczeg贸lnie korzystne dla aplikacji wymagajcych du偶ych zasob贸w. Dodatkowo, Nitro Security Chip zapewnia **bezpieczestwo sprztu i oprogramowania ukadowego**, co dodatkowo wzmacnia jego solidn architektur.

Wicej informacji i jak to enumerowa znajdziesz tutaj:

{% content-ref url="aws-nitro-enum.md" %}
[aws-nitro-enum.md](aws-nitro-enum.md)
{% endcontent-ref %}

## VPN

VPN pozwala na poczenie **sieci lokalnej (site-to-site VPN)** lub **laptop贸w pracownik贸w (Client VPN)** z **AWS VPC**, dziki czemu usugi mog by dostpne bez koniecznoci ich wystawiania w internecie.

#### Podstawowe komponenty AWS VPN

1. **Customer Gateway**:
* Customer Gateway to zas贸b, kt贸ry tworzysz w AWS, aby reprezentowa swoj stron poczenia VPN.
* Jest to zasadniczo fizyczne urzdzenie lub aplikacja programowa po twojej stronie poczenia Site-to-Site VPN.
* Podajesz informacje o routingu i publiczny adres IP swojego urzdzenia sieciowego (takiego jak router lub zapora sieciowa) do AWS, aby utworzy Customer Gateway.
* Su偶y jako punkt odniesienia do konfiguracji poczenia VPN i nie generuje dodatkowych opat.
2. **Virtual Private Gateway**:
* Virtual Private Gateway (VPG) to koncentrator VPN po stronie Amazon w poczeniu Site-to-Site VPN.
* Jest podczony do twojego VPC i su偶y jako cel dla twojego poczenia VPN.
* VPG to punkt kocowy poczenia VPN po stronie AWS.
* Obsuguje bezpieczn komunikacj midzy twoim VPC a sieci lokaln.
3. **Site-to-Site VPN Connection**:
* Poczenie Site-to-Site VPN czy twoj sie lokaln z VPC przez bezpieczny tunel VPN IPsec.
* Ten typ poczenia wymaga Customer Gateway i Virtual Private Gateway.
* Jest u偶ywany do bezpiecznej, stabilnej i sp贸jnej komunikacji midzy twoim centrum danych lub sieci a rodowiskiem AWS.
* Zazwyczaj u偶ywany do regularnych, dugoterminowych pocze i jest rozliczany na podstawie iloci danych przesyanych przez poczenie.
4. **Client VPN Endpoint**:
* Client VPN endpoint to zas贸b, kt贸ry tworzysz w AWS, aby umo偶liwi i zarzdza sesjami VPN klient贸w.
* Jest u偶ywany do umo偶liwienia indywidualnym urzdzeniom (takim jak laptopy, smartfony itp.) bezpiecznego czenia si z zasobami AWS lub twoj sieci lokaln.
* R贸偶ni si od Site-to-Site VPN tym, 偶e jest przeznaczony dla indywidualnych klient贸w, a nie do czenia caych sieci.
* W przypadku Client VPN ka偶de urzdzenie klienckie u偶ywa oprogramowania klienta VPN do nawizania bezpiecznego poczenia.

Mo偶esz [**znale藕 wicej informacji o zaletach i komponentach AWS VPN tutaj**](aws-vpc-and-networking-basic-information.md#vpn).

### Enumeration
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Lokalna Enumeracja

**Lokalne Tymczasowe Powiadczenia**

Kiedy AWS VPN Client jest u偶ywany do poczenia z VPN, u偶ytkownik zazwyczaj **loguje si do AWS**, aby uzyska dostp do VPN. Nastpnie, **AWS powiadczenia s tworzone i przechowywane** lokalnie, aby ustanowi poczenie VPN. Te powiadczenia s **przechowywane w** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` i zawieraj **AccessKey**, **SecretKey** oraz **Token**.

Powiadczenia nale偶 do u偶ytkownika `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: zbada wicej na temat uprawnie tych powiadcze).

**opvn pliki konfiguracyjne**

Jeli **poczenie VPN zostao ustanowione**, powiniene szuka **plik贸w konfiguracyjnych `.opvn`** w systemie. Ponadto, jednym z miejsc, gdzie mo偶na znale藕 **konfiguracje**, jest **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**.

#### **Post Exploitacja**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## Referencje

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

{% hint style="success" %}
Ucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
