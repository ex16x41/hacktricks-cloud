# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## VPC & Networking

Aprende qu茅 es una VPC y sobre sus componentes en:

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 se utiliza para iniciar **servidores virtuales**. Permite la configuraci贸n de **seguridad** y **redes** y la gesti贸n de **almacenamiento**. La flexibilidad de Amazon EC2 es evidente en su capacidad para escalar recursos tanto hacia arriba como hacia abajo, adapt谩ndose efectivamente a cambios en los requisitos o aumentos de popularidad. Esta caracter铆stica disminuye la necesidad de predicciones precisas de tr谩fico.

Cosas interesantes para enumerar en EC2:

* M谩quinas Virtuales
* Claves SSH
* Datos de Usuario
* EC2s/AMIs/Snapshots existentes
* Redes
* Subredes
* IPs P煤blicas
* Puertos abiertos
* Conexiones integradas con otras redes fuera de AWS

### Instance Profiles

Usar **roles** para otorgar permisos a aplicaciones que se ejecutan en **instancias EC2** requiere un poco de configuraci贸n adicional. Una aplicaci贸n que se ejecuta en una instancia EC2 est谩 abstra铆da de AWS por el sistema operativo virtualizado. Debido a esta separaci贸n adicional, necesitas un paso adicional para asignar un rol de AWS y sus permisos asociados a una instancia EC2 y hacerlos disponibles para sus aplicaciones.

Este paso adicional es la **creaci贸n de un** [_**instance profile**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) adjunto a la instancia. El **instance profile contiene el rol y** puede proporcionar las credenciales temporales del rol a una aplicaci贸n que se ejecuta en la instancia. Esas credenciales temporales pueden luego ser usadas en las llamadas API de la aplicaci贸n para acceder a recursos y limitar el acceso solo a aquellos recursos que el rol especifica. Ten en cuenta que **solo un rol puede ser asignado a una instancia EC2** a la vez, y todas las aplicaciones en la instancia comparten el mismo rol y permisos.

### Metadata Endpoint

Los metadatos de AWS EC2 son informaci贸n sobre una instancia de Amazon Elastic Compute Cloud (EC2) que est谩 disponible para la instancia en tiempo de ejecuci贸n. Estos metadatos se utilizan para proporcionar informaci贸n sobre la instancia, como su ID de instancia, la zona de disponibilidad en la que se est谩 ejecutando, el rol IAM asociado con la instancia y el nombre de host de la instancia.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumeration
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Acceso No Autenticado

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Privesc

En la siguiente p谩gina puedes ver c贸mo **abusar de los permisos de EC2 para escalar privilegios**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Post-Explotaci贸n

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Las **instant谩neas** de Amazon **EBS** (Elastic Block Store) son b谩sicamente **copias de seguridad** est谩ticas de los vol煤menes de AWS EBS. En otras palabras, son **copias** de los **discos** adjuntos a una **Instancia EC2** en un momento espec铆fico. Las instant谩neas de EBS pueden copiarse entre regiones y cuentas, o incluso descargarse y ejecutarse localmente.

Las instant谩neas pueden contener **informaci贸n sensible** como **c贸digo fuente o claves API**, por lo tanto, si tienes la oportunidad, se recomienda revisarlas.

### Diferencia AMI & EBS

Una **AMI** se utiliza para **lanzar una instancia EC2**, mientras que una **instant谩nea de EC2** se utiliza para **respaldar y recuperar datos almacenados en un volumen EBS**. Aunque una instant谩nea de EC2 puede usarse para crear una nueva AMI, no es lo mismo que una AMI, y no incluye informaci贸n sobre el sistema operativo, el servidor de aplicaciones u otro software necesario para ejecutar una aplicaci贸n.

### Privesc

En la siguiente p谩gina puedes ver c贸mo **abusar de los permisos de EBS para escalar privilegios**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** permite gestionar remotamente flotas de instancias EC2 para facilitar su administraci贸n. Cada una de estas instancias necesita ejecutar el **servicio SSM Agent, ya que este ser谩 el encargado de recibir las acciones y ejecutarlas** desde la API de AWS.

**SSM Agent** hace posible que Systems Manager actualice, gestione y configure estos recursos. El agente **procesa solicitudes del servicio Systems Manager en la nube de AWS**, y luego las ejecuta seg煤n lo especificado en la solicitud.

El **SSM Agent viene**[ **preinstalado en algunas AMIs**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) o necesitas [**instalarlos manualmente**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) en las instancias. Adem谩s, el Rol IAM utilizado dentro de la instancia necesita tener la pol铆tica **AmazonEC2RoleforSSM** adjunta para poder comunicarse.

### Enumeraci贸n
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Puedes verificar en una instancia de EC2 si Systems Manager est谩 ejecut谩ndose simplemente ejecutando:
```bash
ps aux | grep amazon-ssm
```
### Privesc

En la siguiente p谩gina puedes ver c贸mo **abusar de los permisos de SSM para escalar privilegios**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) es un **servicio de balanceo de carga para despliegues de Amazon Web Services** (AWS). ELB **distribuye autom谩ticamente el tr谩fico de aplicaciones entrante** y escala los recursos para satisfacer las demandas de tr谩fico.

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Launch Templates & Autoscaling Groups

### Enumeraci贸n

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## Nitro

AWS Nitro es un conjunto de **tecnolog铆as innovadoras** que forman la plataforma subyacente para las instancias de AWS EC2. Introducido por Amazon para **mejorar la seguridad, el rendimiento y la fiabilidad**, Nitro aprovecha componentes de **hardware personalizados y un hipervisor ligero**. Abstrae gran parte de la funcionalidad de virtualizaci贸n tradicional a hardware y software dedicados, **minimizando la superficie de ataque** y mejorando la eficiencia de los recursos. Al descargar las funciones de virtualizaci贸n, Nitro permite que las instancias de EC2 ofrezcan un **rendimiento casi de metal desnudo**, lo que es particularmente beneficioso para aplicaciones que consumen muchos recursos. Adem谩s, el Nitro Security Chip asegura espec铆ficamente la **seguridad del hardware y firmware**, consolidando a煤n m谩s su arquitectura robusta.

Obt茅n m谩s informaci贸n y c贸mo enumerarlo desde:

{% content-ref url="aws-nitro-enum.md" %}
[aws-nitro-enum.md](aws-nitro-enum.md)
{% endcontent-ref %}

## VPN

Una VPN permite conectar tu **red local (site-to-site VPN)** o los **port谩tiles de los trabajadores (Client VPN)** con un **AWS VPC** para que los servicios puedan ser accedidos sin necesidad de exponerlos a internet.

#### Componentes B谩sicos de AWS VPN

1. **Customer Gateway**:
* Un Customer Gateway es un recurso que creas en AWS para representar tu lado de una conexi贸n VPN.
* Es esencialmente un dispositivo f铆sico o una aplicaci贸n de software en tu lado de la conexi贸n Site-to-Site VPN.
* Proporcionas informaci贸n de enrutamiento y la direcci贸n IP p煤blica de tu dispositivo de red (como un router o un firewall) a AWS para crear un Customer Gateway.
* Sirve como punto de referencia para configurar la conexi贸n VPN y no incurre en cargos adicionales.
2. **Virtual Private Gateway**:
* Un Virtual Private Gateway (VPG) es el concentrador VPN en el lado de Amazon de la conexi贸n Site-to-Site VPN.
* Est谩 adjunto a tu VPC y sirve como el objetivo para tu conexi贸n VPN.
* VPG es el punto final del lado de AWS para la conexi贸n VPN.
* Maneja la comunicaci贸n segura entre tu VPC y tu red local.
3. **Site-to-Site VPN Connection**:
* Una conexi贸n Site-to-Site VPN conecta tu red local a un VPC a trav茅s de un t煤nel VPN seguro IPsec.
* Este tipo de conexi贸n requiere un Customer Gateway y un Virtual Private Gateway.
* Se utiliza para una comunicaci贸n segura, estable y consistente entre tu centro de datos o red y tu entorno AWS.
* Normalmente se usa para conexiones regulares y a largo plazo y se factura seg煤n la cantidad de datos transferidos a trav茅s de la conexi贸n.
4. **Client VPN Endpoint**:
* Un Client VPN endpoint es un recurso que creas en AWS para habilitar y gestionar sesiones de VPN de clientes.
* Se utiliza para permitir que dispositivos individuales (como port谩tiles, smartphones, etc.) se conecten de manera segura a recursos de AWS o a tu red local.
* Se diferencia de Site-to-Site VPN en que est谩 dise帽ado para clientes individuales en lugar de conectar redes enteras.
* Con Client VPN, cada dispositivo cliente usa un software cliente VPN para establecer una conexi贸n segura.

Puedes [**encontrar m谩s informaci贸n sobre los beneficios y componentes de AWS VPNs aqu铆**](aws-vpc-and-networking-basic-information.md#vpn).

### Enumeraci贸n
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Enumeraci贸n Local

**Credenciales Temporales Locales**

Cuando se utiliza AWS VPN Client para conectarse a una VPN, el usuario generalmente **inicia sesi贸n en AWS** para obtener acceso a la VPN. Luego, se **crean y almacenan credenciales de AWS** localmente para establecer la conexi贸n VPN. Estas credenciales se **almacenan en** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` y contienen un **AccessKey**, un **SecretKey** y un **Token**.

Las credenciales pertenecen al usuario `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: investigar m谩s sobre los permisos de estas credenciales).

**archivos de configuraci贸n opvn**

Si se **estableci贸 una conexi贸n VPN**, deber铆as buscar archivos de configuraci贸n **`.opvn`** en el sistema. Adem谩s, un lugar donde podr铆as encontrar las **configuraciones** es en **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **Post Explotaci贸n**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## Referencias

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
