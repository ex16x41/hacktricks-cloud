# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## VPC & Networking

Erfahren Sie, was eine VPC ist und √ºber ihre Komponenten in:

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 wird verwendet, um **virtuelle Server** zu starten. Es erm√∂glicht die Konfiguration von **Sicherheit** und **Netzwerk** sowie die Verwaltung von **Speicher**. Die Flexibilit√§t von Amazon EC2 zeigt sich in seiner F√§higkeit, Ressourcen sowohl nach oben als auch nach unten zu skalieren, wodurch es sich effektiv an wechselnde Anforderungen oder Anstiege in der Beliebtheit anpassen kann. Diese Funktion verringert die Notwendigkeit f√ºr pr√§zise Verkehrsvorhersagen.

Interessante Dinge, die in EC2 aufgez√§hlt werden k√∂nnen:

* Virtuelle Maschinen
* SSH-Schl√ºssel
* Benutzerdaten
* Vorhandene EC2s/AMIs/Snapshots
* Netzwerk
* Netzwerke
* Subnetzwerke
* √ñffentliche IPs
* Offene Ports
* Integrierte Verbindungen zu anderen Netzwerken au√üerhalb von AWS

### Instanzprofile

Die Verwendung von **Rollen**, um Anwendungen, die auf **EC2-Instanzen** ausgef√ºhrt werden, Berechtigungen zu gew√§hren, erfordert eine zus√§tzliche Konfiguration. Eine Anwendung, die auf einer EC2-Instanz ausgef√ºhrt wird, ist durch das virtualisierte Betriebssystem von AWS abstrahiert. Aufgrund dieser zus√§tzlichen Trennung ben√∂tigen Sie einen zus√§tzlichen Schritt, um eine AWS-Rolle und die zugeh√∂rigen Berechtigungen einer EC2-Instanz zuzuweisen und sie ihren Anwendungen zur Verf√ºgung zu stellen.

Dieser zus√§tzliche Schritt ist die **Erstellung eines** [_**Instanzprofils**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html), das an die Instanz angeh√§ngt ist. Das **Instanzprofil enth√§lt die Rolle und** kann die tempor√§ren Anmeldeinformationen der Rolle einer Anwendung, die auf der Instanz ausgef√ºhrt wird, zur Verf√ºgung stellen. Diese tempor√§ren Anmeldeinformationen k√∂nnen dann in den API-Aufrufen der Anwendung verwendet werden, um auf Ressourcen zuzugreifen und den Zugriff nur auf die Ressourcen zu beschr√§nken, die die Rolle angibt. Beachten Sie, dass **nur eine Rolle gleichzeitig einer EC2-Instanz zugewiesen werden kann**, und alle Anwendungen auf der Instanz teilen sich dieselbe Rolle und Berechtigungen.

### Metadaten-Endpunkt

AWS EC2-Metadaten sind Informationen √ºber eine Amazon Elastic Compute Cloud (EC2)-Instanz, die der Instanz zur Laufzeit zur Verf√ºgung stehen. Diese Metadaten werden verwendet, um Informationen √ºber die Instanz bereitzustellen, wie z. B. ihre Instanz-ID, die Verf√ºgbarkeitszone, in der sie ausgef√ºhrt wird, die IAM-Rolle, die mit der Instanz verbunden ist, und den Hostnamen der Instanz.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Aufz√§hlung
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Unauthenticated Access

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Privesc

Auf der folgenden Seite k√∂nnen Sie √ºberpr√ºfen, wie Sie **EC2-Berechtigungen missbrauchen k√∂nnen, um Privilegien zu eskalieren**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Post-Exploitation

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS** (Elastic Block Store) **Snapshots** sind im Grunde statische **Backups** von AWS EBS-Volumes. Mit anderen Worten, sie sind **Kopien** der **Festplatten**, die zu einer **EC2**-Instanz zu einem bestimmten Zeitpunkt verbunden sind. EBS-Snapshots k√∂nnen √ºber Regionen und Konten hinweg kopiert oder sogar heruntergeladen und lokal ausgef√ºhrt werden.

Snapshots k√∂nnen **sensible Informationen** wie **Quellcode oder API-Schl√ºssel** enthalten, daher wird empfohlen, sie zu √ºberpr√ºfen, wenn Sie die M√∂glichkeit dazu haben.

### Unterschied AMI & EBS

Eine **AMI** wird verwendet, um eine **EC2-Instanz zu starten**, w√§hrend ein EC2 **Snapshot** verwendet wird, um **Daten, die auf einem EBS-Volume gespeichert sind, zu sichern und wiederherzustellen**. W√§hrend ein EC2-Snapshot verwendet werden kann, um eine neue AMI zu erstellen, ist es nicht dasselbe wie eine AMI, und es enth√§lt keine Informationen √ºber das Betriebssystem, den Anwendungsserver oder andere Software, die zum Ausf√ºhren einer Anwendung erforderlich sind.

### Privesc

Auf der folgenden Seite k√∂nnen Sie √ºberpr√ºfen, wie Sie **EBS-Berechtigungen missbrauchen k√∂nnen, um Privilegien zu eskalieren**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** erm√∂glicht die remote Verwaltung von EC2-Instanzen, um deren Verwaltung erheblich zu erleichtern. Jede dieser Instanzen muss den **SSM-Agent-Dienst ausf√ºhren, da dieser die Aktionen erh√§lt und sie** √ºber die AWS-API ausf√ºhrt.

Der **SSM-Agent** erm√∂glicht es dem Systems Manager, diese Ressourcen zu aktualisieren, zu verwalten und zu konfigurieren. Der Agent **verarbeitet Anfragen vom Systems Manager-Dienst in der AWS-Cloud** und f√ºhrt sie dann gem√§√ü den Vorgaben in der Anfrage aus.

Der **SSM-Agent kommt**[ **vorinstalliert in einigen AMIs**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) oder Sie m√ºssen ihn [**manuell installieren**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) auf den Instanzen. Au√üerdem muss die IAM-Rolle, die innerhalb der Instanz verwendet wird, die Richtlinie **AmazonEC2RoleforSSM** angeh√§ngt haben, um kommunizieren zu k√∂nnen.

### Enumeration
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Sie k√∂nnen in einer EC2-Instanz √ºberpr√ºfen, ob Systems Manager ausgef√ºhrt wird, indem Sie einfach Folgendes ausf√ºhren:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Auf der folgenden Seite k√∂nnen Sie √ºberpr√ºfen, wie Sie **SSM-Berechtigungen missbrauchen, um Privilegien zu eskalieren**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) ist ein **Lastverteilungsdienst f√ºr Amazon Web Services** (AWS) Bereitstellungen. ELB **verteilt automatisch den eingehenden Anwendungsverkehr** und skaliert Ressourcen, um den Verkehrsanforderungen gerecht zu werden.

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Launch-Vorlagen & Auto-Scaling-Gruppen

### Aufz√§hlung

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## Nitro

AWS Nitro ist eine Suite von **innovativen Technologien**, die die zugrunde liegende Plattform f√ºr AWS EC2-Instanzen bilden. Von Amazon eingef√ºhrt, um die **Sicherheit, Leistung und Zuverl√§ssigkeit** zu **verbessern**, nutzt Nitro ma√ügeschneiderte **Hardwarekomponenten und einen leichten Hypervisor**. Es abstrahiert einen Gro√üteil der traditionellen Virtualisierungsfunktionen auf dedizierte Hardware und Software, **minimiert die Angriffsfl√§che** und verbessert die Ressourceneffizienz. Durch das Auslagern von Virtualisierungsfunktionen erm√∂glicht Nitro EC2-Instanzen, **nahezu Bare-Metal-Leistung** zu liefern, was es besonders vorteilhaft f√ºr ressourcenintensive Anwendungen macht. Dar√ºber hinaus gew√§hrleistet der Nitro Security Chip speziell die **Sicherheit der Hardware und Firmware** und festigt damit seine robuste Architektur.

Erhalten Sie weitere Informationen und wie Sie es enumerieren k√∂nnen von:

{% content-ref url="aws-nitro-enum.md" %}
[aws-nitro-enum.md](aws-nitro-enum.md)
{% endcontent-ref %}

## VPN

Ein VPN erm√∂glicht die Verbindung Ihres **On-Premise-Netzwerks (Site-to-Site VPN)** oder der **Mitarbeiter-Laptops (Client VPN)** mit einer **AWS VPC**, sodass Dienste ohne Exposition gegen√ºber dem Internet genutzt werden k√∂nnen.

#### Grundlegende AWS VPN-Komponenten

1. **Customer Gateway**:
* Ein Customer Gateway ist eine Ressource, die Sie in AWS erstellen, um Ihre Seite einer VPN-Verbindung darzustellen.
* Es ist im Wesentlichen ein physisches Ger√§t oder eine Softwareanwendung auf Ihrer Seite der Site-to-Site VPN-Verbindung.
* Sie geben Routinginformationen und die √∂ffentliche IP-Adresse Ihres Netzwerkger√§ts (wie einen Router oder eine Firewall) an AWS weiter, um ein Customer Gateway zu erstellen.
* Es dient als Referenzpunkt f√ºr die Einrichtung der VPN-Verbindung und verursacht keine zus√§tzlichen Kosten.
2. **Virtual Private Gateway**:
* Ein Virtual Private Gateway (VPG) ist der VPN-Konzentrator auf der Amazon-Seite der Site-to-Site VPN-Verbindung.
* Es ist an Ihre VPC angeh√§ngt und dient als Ziel f√ºr Ihre VPN-Verbindung.
* VPG ist der AWS-Seitenendpunkt f√ºr die VPN-Verbindung.
* Es verwaltet die sichere Kommunikation zwischen Ihrer VPC und Ihrem On-Premises-Netzwerk.
3. **Site-to-Site VPN-Verbindung**:
* Eine Site-to-Site VPN-Verbindung verbindet Ihr On-Premises-Netzwerk mit einer VPC √ºber einen sicheren IPsec VPN-Tunnel.
* Diese Art von Verbindung erfordert ein Customer Gateway und ein Virtual Private Gateway.
* Es wird f√ºr sichere, stabile und konsistente Kommunikation zwischen Ihrem Rechenzentrum oder Netzwerk und Ihrer AWS-Umgebung verwendet.
* Typischerweise f√ºr regelm√§√üige, langfristige Verbindungen verwendet und basierend auf der Menge der √ºber die Verbindung √ºbertragenen Daten abgerechnet.
4. **Client VPN-Endpunkt**:
* Ein Client VPN-Endpunkt ist eine Ressource, die Sie in AWS erstellen, um Client-VPN-Sitzungen zu aktivieren und zu verwalten.
* Es wird verwendet, um einzelnen Ger√§ten (wie Laptops, Smartphones usw.) eine sichere Verbindung zu AWS-Ressourcen oder Ihrem On-Premises-Netzwerk zu erm√∂glichen.
* Es unterscheidet sich vom Site-to-Site VPN, da es f√ºr einzelne Clients und nicht f√ºr die Verbindung ganzer Netzwerke konzipiert ist.
* Mit Client VPN verwendet jedes Client-Ger√§t eine VPN-Client-Software, um eine sichere Verbindung herzustellen.

Sie k√∂nnen [**hier weitere Informationen zu den Vorteilen und Komponenten von AWS VPNs finden**](aws-vpc-and-networking-basic-information.md#vpn).

### Enumeration
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Lokale Enumeration

**Lokale tempor√§re Anmeldeinformationen**

Wenn der AWS VPN-Client verwendet wird, um eine VPN-Verbindung herzustellen, meldet sich der Benutzer normalerweise **bei AWS an**, um Zugriff auf das VPN zu erhalten. Dann werden einige **AWS-Anmeldeinformationen erstellt und lokal gespeichert**, um die VPN-Verbindung herzustellen. Diese Anmeldeinformationen werden **gespeichert in** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` und enthalten einen **AccessKey**, einen **SecretKey** und ein **Token**.

Die Anmeldeinformationen geh√∂ren zum Benutzer `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: mehr √ºber die Berechtigungen dieser Anmeldeinformationen recherchieren).

**opvn-Konfigurationsdateien**

Wenn eine **VPN-Verbindung hergestellt wurde**, sollten Sie nach **`.opvn`**-Konfigurationsdateien im System suchen. Dar√ºber hinaus ist ein Ort, an dem Sie die **Konfigurationen** finden k√∂nnten, in **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **Post-Exploitation**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## Referenzen

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
