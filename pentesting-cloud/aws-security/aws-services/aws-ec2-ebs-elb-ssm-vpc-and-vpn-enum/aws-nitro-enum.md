# AWS - Nitro Enum

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

AWS Nitro æ˜¯ä¸€å¥— **åˆ›æ–°æŠ€æœ¯**ï¼Œæ„æˆäº† AWS EC2 å®ä¾‹çš„åŸºç¡€å¹³å°ã€‚ç”±äºšé©¬é€Šæ¨å‡ºä»¥ **å¢å¼ºå®‰å…¨æ€§ã€æ€§èƒ½å’Œå¯é æ€§**ï¼ŒNitro åˆ©ç”¨å®šåˆ¶çš„ **ç¡¬ä»¶ç»„ä»¶å’Œè½»é‡çº§è™šæ‹Ÿæœºç›‘æ§ç¨‹åº**ã€‚å®ƒå°†ä¼ ç»Ÿè™šæ‹ŸåŒ–åŠŸèƒ½æŠ½è±¡åˆ°ä¸“ç”¨ç¡¬ä»¶å’Œè½¯ä»¶ä¸Šï¼Œ**æœ€å°åŒ–æ”»å‡»é¢**å¹¶æé«˜èµ„æºæ•ˆç‡ã€‚é€šè¿‡å¸è½½è™šæ‹ŸåŒ–åŠŸèƒ½ï¼ŒNitro ä½¿ EC2 å®ä¾‹èƒ½å¤Ÿæä¾› **æ¥è¿‘è£¸é‡‘å±çš„æ€§èƒ½**ï¼Œè¿™å¯¹èµ„æºå¯†é›†å‹åº”ç”¨ç‰¹åˆ«æœ‰åˆ©ã€‚æ­¤å¤–ï¼ŒNitro å®‰å…¨èŠ¯ç‰‡ä¸“é—¨ç¡®ä¿ **ç¡¬ä»¶å’Œå›ºä»¶çš„å®‰å…¨æ€§**ï¼Œè¿›ä¸€æ­¥å·©å›ºå…¶å¼ºå¤§çš„æ¶æ„ã€‚

### Nitro Enclaves

**AWS Nitro Enclaves** æä¾›ä¸€ä¸ªå®‰å…¨çš„ã€**éš”ç¦»çš„è®¡ç®—ç¯å¢ƒ**ï¼Œä¸“é—¨è®¾è®¡ç”¨äºå¤„ç†é«˜åº¦æ•æ„Ÿçš„æ•°æ®ã€‚åˆ©ç”¨ AWS Nitro ç³»ç»Ÿï¼Œè¿™äº›éš”ç¦»åŒºç¡®ä¿å¼ºå¤§çš„ **éš”ç¦»å’Œå®‰å…¨æ€§**ï¼Œéå¸¸é€‚åˆ **å¤„ç†æœºå¯†ä¿¡æ¯**ï¼Œå¦‚ä¸ªäººèº«ä»½ä¿¡æ¯æˆ–è´¢åŠ¡è®°å½•ã€‚å®ƒä»¬å…·æœ‰æç®€çš„ç¯å¢ƒï¼Œæ˜¾è‘—é™ä½æ•°æ®æš´éœ²çš„é£é™©ã€‚æ­¤å¤–ï¼ŒNitro Enclaves æ”¯æŒåŠ å¯†è¯æ˜ï¼Œå…è®¸ç”¨æˆ·éªŒè¯åªæœ‰æˆæƒä»£ç åœ¨è¿è¡Œï¼Œè¿™å¯¹ç»´æŠ¤ä¸¥æ ¼çš„åˆè§„æ€§å’Œæ•°æ®ä¿æŠ¤æ ‡å‡†è‡³å…³é‡è¦ã€‚

{% hint style="danger" %}
Nitro Enclave é•œåƒæ˜¯ **åœ¨ EC2 å®ä¾‹å†…éƒ¨è¿è¡Œ** çš„ï¼Œæ‚¨æ— æ³•ä» AWS ç½‘ç»œæ§åˆ¶å°æŸ¥çœ‹ EC2 å®ä¾‹æ˜¯å¦åœ¨è¿è¡Œ Nitro Enclave é•œåƒã€‚
{% endhint %}

## Nitro Enclave CLI å®‰è£…

æŒ‰ç…§ [**æ–‡æ¡£ä¸­çš„æ‰€æœ‰è¯´æ˜**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)ã€‚ç„¶è€Œï¼Œä»¥ä¸‹æ˜¯æœ€é‡è¦çš„å‡ ç‚¹ï¼š
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

æ‚¨å¯ä»¥åœ¨ Nitro Enclave ä¸­è¿è¡Œçš„é•œåƒåŸºäº docker é•œåƒï¼Œå› æ­¤æ‚¨å¯ä»¥ä» docker é•œåƒåˆ›å»º Nitro Enclave é•œåƒï¼Œä¾‹å¦‚ï¼š
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
å¦‚æ‚¨æ‰€è§ï¼ŒNitro Enclave é•œåƒä½¿ç”¨æ‰©å±•å **`eif`**ï¼ˆEnclave Image Fileï¼‰ã€‚

è¾“å‡ºå°†ç±»ä¼¼äºï¼š
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### è¿è¡Œæ˜ åƒ

æ ¹æ® [**æ–‡æ¡£**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)ï¼Œä¸ºäº†è¿è¡Œä¸€ä¸ª enclave æ˜ åƒï¼Œæ‚¨éœ€è¦åˆ†é… **è‡³å°‘æ˜¯ `eif` æ–‡ä»¶å¤§å°çš„ 4 å€çš„å†…å­˜**ã€‚å¯ä»¥åœ¨æ–‡ä»¶ä¸­é…ç½®é»˜è®¤èµ„æºä»¥åˆ†é…ç»™å®ƒã€‚
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
å§‹ç»ˆè®°ä½ï¼Œæ‚¨è¿˜éœ€è¦ä¸º**çˆ¶ EC2 å®ä¾‹ä¿ç•™ä¸€äº›èµ„æº**ï¼
{% endhint %}

åœ¨çŸ¥é“è¦åˆ†é…ç»™æ˜ åƒçš„èµ„æºå¹¶ä¸”ç”šè‡³ä¿®æ”¹äº†é…ç½®æ–‡ä»¶åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œä¸€ä¸ª enclave æ˜ åƒï¼š

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### æšä¸¾éš”ç¦»åŒº

å¦‚æœæ‚¨æ”»é™·äº†ä¸€ä¸ª EC2 ä¸»æœºï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·å–æ­£åœ¨è¿è¡Œçš„éš”ç¦»åŒºæ˜ åƒåˆ—è¡¨ï¼š
```bash
nitro-cli describe-enclaves
```
ä¸å¯èƒ½åœ¨è¿è¡Œçš„ enclave é•œåƒå†…è·å– shellï¼Œå› ä¸ºè¿™æ­£æ˜¯ enclave çš„ä¸»è¦ç›®çš„ã€‚ç„¶è€Œï¼Œå¦‚æœæ‚¨ä½¿ç”¨å‚æ•° **`--debug-mode`**ï¼Œåˆ™å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–å…¶ **stdout**ï¼š
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### ç»ˆæ­¢éš”ç¦»åŒº

å¦‚æœæ”»å‡»è€…é€šè¿‡é»˜è®¤æ–¹å¼æ”»é™·ä¸€ä¸ª EC2 å®ä¾‹ï¼Œä»–å°†æ— æ³•åœ¨å…¶ä¸­è·å¾— shellï¼Œä½†ä»–å°†èƒ½å¤Ÿé€šè¿‡ä»¥ä¸‹æ–¹å¼**ç»ˆæ­¢å®ƒä»¬**ï¼š
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

ä¸è¿è¡Œå›¾åƒçš„ **enclave** è¿›è¡Œé€šä¿¡çš„å”¯ä¸€æ–¹å¼æ˜¯ä½¿ç”¨ **vsocks**ã€‚

**è™šæ‹Ÿå¥—æ¥å­— (vsock)** æ˜¯ Linux ä¸­çš„ä¸€ç§å¥—æ¥å­—ç³»åˆ—ï¼Œä¸“é—¨è®¾è®¡ç”¨äºä¿ƒè¿›è™šæ‹Ÿæœº (**VMs**) ä¸å…¶ **hypervisors** ä¹‹é—´ï¼Œæˆ–è™šæ‹Ÿæœº **ä¹‹é—´** çš„ **é€šä¿¡**ã€‚Vsock ä½¿å¾—é«˜æ•ˆçš„ **åŒå‘é€šä¿¡** æˆä¸ºå¯èƒ½ï¼Œè€Œæ— éœ€ä¾èµ–ä¸»æœºçš„ç½‘ç»œå †æ ˆã€‚è¿™ä½¿å¾—è™šæ‹Ÿæœºå³ä½¿åœ¨æ²¡æœ‰ç½‘ç»œé…ç½®çš„æƒ…å†µä¸‹ä¹Ÿèƒ½è¿›è¡Œé€šä¿¡ï¼Œ**ä½¿ç”¨ 32 ä½ä¸Šä¸‹æ–‡ ID (CID) å’Œç«¯å£å·** æ¥è¯†åˆ«å’Œç®¡ç†è¿æ¥ã€‚vsock API æ”¯æŒæµå’Œæ•°æ®æŠ¥å¥—æ¥å­—ç±»å‹ï¼Œç±»ä¼¼äº TCP å’Œ UDPï¼Œä¸ºè™šæ‹Ÿç¯å¢ƒä¸­çš„ç”¨æˆ·çº§åº”ç”¨ç¨‹åºæä¾›äº†å¤šåŠŸèƒ½çš„å·¥å…·ã€‚

{% hint style="success" %}
å› æ­¤ï¼Œvsock åœ°å€çœ‹èµ·æ¥åƒè¿™æ ·ï¼š`<CID>:<Port>`
{% endhint %}

è¦æ‰¾åˆ°è¿è¡Œå›¾åƒçš„ **CIDs**ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¹¶è·å– **`EnclaveCID`**ï¼š

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œä»ä¸»æœºä¸Šæ— æ³•çŸ¥é“ CID æ˜¯å¦æš´éœ²ä»»ä½•ç«¯å£ï¼é™¤éä½¿ç”¨æŸäº› **vsock ç«¯å£æ‰«æå™¨ï¼Œå¦‚** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner)ã€‚
{% endhint %}

### Vsock æœåŠ¡å™¨/ç›‘å¬å™¨

è¿™é‡Œæœ‰å‡ ä¸ªç¤ºä¾‹ï¼š

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>ç®€å•çš„ Python ç›‘å¬å™¨</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock å®¢æˆ·ç«¯

ç¤ºä¾‹ï¼š

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>ç®€å•çš„ Python å®¢æˆ·ç«¯</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

å·¥å…· vsock-proxy å…è®¸ä½¿ç”¨å¦ä¸€ä¸ªåœ°å€ä»£ç† vsock ä»£ç†ï¼Œä¾‹å¦‚ï¼š
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
è¿™å°†æŠŠ **vsock ä¸­çš„æœ¬åœ°ç«¯å£ 8001** è½¬å‘åˆ° `ip-ranges.amazonaws.com:443`ï¼Œæ–‡ä»¶ **`your-vsock-proxy.yaml`** å¯èƒ½åŒ…å«ä»¥ä¸‹å†…å®¹ï¼Œä»¥å…è®¸è®¿é—® `ip-ranges.amazonaws.com:443`ï¼š
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹ EC2 ä¸»æœºä½¿ç”¨çš„ vsock åœ°å€ (**`<CID>:<Port>`**)ï¼ˆæ³¨æ„ `3:8001`ï¼Œ3 æ˜¯ CIDï¼Œ8001 æ˜¯ç«¯å£ï¼‰ï¼š 

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atestation & KMS

Nitro Enclaves SDK å…è®¸ä¸€ä¸ª enclave ä» Nitro **Hypervisor** è¯·æ±‚ä¸€ä¸ª **åŠ å¯†ç­¾åçš„è¯æ˜æ–‡ä»¶**ï¼Œè¯¥æ–‡ä»¶åŒ…å«ç‰¹å®šäºè¯¥ enclave çš„ **å”¯ä¸€æµ‹é‡å€¼**ã€‚è¿™äº›æµ‹é‡å€¼ï¼ŒåŒ…æ‹¬ **å“ˆå¸Œå’Œå¹³å°é…ç½®å¯„å­˜å™¨ (PCRs)**ï¼Œåœ¨è¯æ˜è¿‡ç¨‹ä¸­ç”¨äº **è¯æ˜ enclave çš„èº«ä»½** å’Œ **ä¸å¤–éƒ¨æœåŠ¡å»ºç«‹ä¿¡ä»»**ã€‚è¯æ˜æ–‡ä»¶é€šå¸¸åŒ…å«åƒ PCR0ã€PCR1 å’Œ PCR2 è¿™æ ·çš„å€¼ï¼Œè¿™äº›å€¼åœ¨æ„å»ºå’Œä¿å­˜ enclave EIF æ—¶ä½ å·²ç»é‡åˆ°è¿‡ã€‚

æ ¹æ® [**docs**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves)ï¼Œè¿™äº›æ˜¯ PCR å€¼ï¼š

<table><thead><tr><th width="97">PCR</th><th width="221">å“ˆå¸Œå€¼...</th><th>æè¿°</th></tr></thead><tbody><tr><td>PCR0</td><td>Enclave é•œåƒæ–‡ä»¶</td><td>é•œåƒæ–‡ä»¶å†…å®¹çš„è¿ç»­æµ‹é‡ï¼Œä¸åŒ…æ‹¬éƒ¨åˆ†æ•°æ®ã€‚</td></tr><tr><td>PCR1</td><td>Linux å†…æ ¸å’Œå¼•å¯¼</td><td>å†…æ ¸å’Œå¼•å¯¼ ramfs æ•°æ®çš„è¿ç»­æµ‹é‡ã€‚</td></tr><tr><td>PCR2</td><td>åº”ç”¨ç¨‹åº</td><td>ç”¨æˆ·åº”ç”¨ç¨‹åºçš„è¿ç»­ã€æŒ‰é¡ºåºæµ‹é‡ï¼Œä¸åŒ…æ‹¬å¼•å¯¼ ramfsã€‚</td></tr><tr><td>PCR3</td><td>åˆ†é…ç»™çˆ¶å®ä¾‹çš„ IAM è§’è‰²</td><td>åˆ†é…ç»™çˆ¶å®ä¾‹çš„ IAM è§’è‰²çš„è¿ç»­æµ‹é‡ã€‚ç¡®ä¿åªæœ‰åœ¨çˆ¶å®ä¾‹å…·æœ‰æ­£ç¡®çš„ IAM è§’è‰²æ—¶ï¼Œè¯æ˜è¿‡ç¨‹æ‰ä¼šæˆåŠŸã€‚</td></tr><tr><td>PCR4</td><td>çˆ¶å®ä¾‹çš„å®ä¾‹ ID</td><td>çˆ¶å®ä¾‹ ID çš„è¿ç»­æµ‹é‡ã€‚ç¡®ä¿åªæœ‰åœ¨çˆ¶å®ä¾‹å…·æœ‰ç‰¹å®šå®ä¾‹ ID æ—¶ï¼Œè¯æ˜è¿‡ç¨‹æ‰ä¼šæˆåŠŸã€‚</td></tr><tr><td>PCR8</td><td>Enclave é•œåƒæ–‡ä»¶ç­¾åè¯ä¹¦</td><td>ä¸º enclave é•œåƒæ–‡ä»¶æŒ‡å®šçš„ç­¾åè¯ä¹¦çš„æµ‹é‡ã€‚ç¡®ä¿åªæœ‰åœ¨ enclave ä»ç”±ç‰¹å®šè¯ä¹¦ç­¾åçš„ enclave é•œåƒæ–‡ä»¶å¼•å¯¼æ—¶ï¼Œè¯æ˜è¿‡ç¨‹æ‰ä¼šæˆåŠŸã€‚</td></tr></tbody></table>

ä½ å¯ä»¥å°† **åŠ å¯†è¯æ˜** é›†æˆåˆ°ä½ çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå¹¶åˆ©ç”¨ä¸ **AWS KMS** ç­‰æœåŠ¡çš„é¢„æ„å»ºé›†æˆã€‚AWS KMS å¯ä»¥ **éªŒè¯ enclave è¯æ˜**ï¼Œå¹¶åœ¨å…¶å¯†é’¥ç­–ç•¥ä¸­æä¾›åŸºäºè¯æ˜çš„æ¡ä»¶å¯†é’¥ (`kms:RecipientAttestation:ImageSha384` å’Œ `kms:RecipientAttestation:PCR`)ã€‚è¿™äº›ç­–ç•¥ç¡®ä¿ AWS KMS ä»…åœ¨ enclave çš„è¯æ˜æ–‡ä»¶æœ‰æ•ˆä¸”æ»¡è¶³ **æŒ‡å®šæ¡ä»¶** æ—¶ï¼Œæ‰å…è®¸ä½¿ç”¨ KMS å¯†é’¥è¿›è¡Œæ“ä½œã€‚

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œè°ƒè¯•æ¨¡å¼ä¸‹çš„ Enclaves (--debug) ç”Ÿæˆçš„è¯æ˜æ–‡ä»¶çš„ PCR ç”±é›¶ç»„æˆ (`000000000000000000000000000000000000000000000000`)ã€‚å› æ­¤ï¼Œæ£€æŸ¥è¿™äº›å€¼çš„ KMS ç­–ç•¥å°†å¤±è´¥ã€‚
{% endhint %}

### PCR Bypass

ä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œæ³¨æ„åˆ°æŸäº› PCR å…è®¸ä¿®æ”¹ enclave é•œåƒçš„æŸäº›éƒ¨åˆ†æˆ–å…¨éƒ¨ï¼Œå¹¶ä¸”ä»ç„¶æœ‰æ•ˆï¼ˆä¾‹å¦‚ï¼ŒPCR4 ä»…æ£€æŸ¥çˆ¶å®ä¾‹çš„ IDï¼Œå› æ­¤åœ¨è¯¥ EC2 ä¸­è¿è¡Œä»»ä½• enclave é•œåƒå°†æ»¡è¶³æ­¤æ½œåœ¨ PCR è¦æ±‚ï¼‰ã€‚

å› æ­¤ï¼Œæ”»å‡»è€…å¦‚æœæ”»é™· EC2 å®ä¾‹ï¼Œå¯èƒ½èƒ½å¤Ÿè¿è¡Œå…¶ä»– enclave é•œåƒä»¥ç»•è¿‡è¿™äº›ä¿æŠ¤ã€‚

å…³äºå¦‚ä½•ä¿®æ”¹/åˆ›å»ºæ–°é•œåƒä»¥ç»•è¿‡æ¯ä¸ªä¿æŠ¤ï¼ˆç‰¹åˆ«æ˜¯é‚£äº›ä¸é‚£ä¹ˆæ˜æ˜¾çš„ï¼‰çš„ç ”ç©¶ä»ç„¶å¾…å®Œæˆã€‚

## References

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* AWS Nitro æ•™ç¨‹çš„æ‰€æœ‰éƒ¨åˆ†ï¼š[https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
å­¦ä¹ å¹¶å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å¹¶å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
