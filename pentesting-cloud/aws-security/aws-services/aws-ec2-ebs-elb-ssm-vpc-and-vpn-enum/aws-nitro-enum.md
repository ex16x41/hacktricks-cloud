# AWS - Nitro Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

AWS Nitro to zestaw **innowacyjnych technologii**, kt贸re stanowi podstawow platform dla instancji AWS EC2. Wprowadzony przez Amazon w celu **zwikszenia bezpieczestwa, wydajnoci i niezawodnoci**, Nitro wykorzystuje niestandardowe **komponenty sprztowe i lekk warstw hypervisora**. Abstrakcyjnie przenosi wiele tradycyjnych funkcji wirtualizacji na dedykowany sprzt i oprogramowanie, **minimalizujc powierzchni ataku** i poprawiajc efektywno zasob贸w. Przez odci偶enie funkcji wirtualizacji, Nitro pozwala instancjom EC2 dostarcza **wydajno blisk wydajnoci sprztowej**, co jest szczeg贸lnie korzystne dla aplikacji wymagajcych du偶ych zasob贸w. Dodatkowo, Nitro Security Chip zapewnia **bezpieczestwo sprztu i oprogramowania ukadowego**, co dodatkowo wzmacnia jego solidn architektur.

### Nitro Enclaves

**AWS Nitro Enclaves** zapewniaj bezpieczne, **izolowane rodowisko obliczeniowe w instancjach Amazon EC2**, zaprojektowane specjalnie do przetwarzania wysoce wra偶liwych danych. Wykorzystujc system AWS Nitro, te enklawy zapewniaj solidn **izolacj i bezpieczestwo**, idealne do **obsugi poufnych informacji**, takich jak PII czy dane finansowe. Oferuj minimalistyczne rodowisko, znacznie redukujc ryzyko ujawnienia danych. Dodatkowo, Nitro Enclaves wspieraj kryptograficzn atestacj, umo偶liwiajc u偶ytkownikom weryfikacj, 偶e tylko autoryzowany kod jest uruchamiany, co jest kluczowe dla utrzymania cisej zgodnoci i standard贸w ochrony danych.

{% hint style="danger" %}
Obrazy Nitro Enclave s **uruchamiane z wntrza instancji EC2** i nie mo偶na zobaczy w konsoli internetowej AWS, czy instancje EC2 uruchamiaj obrazy w Nitro Enclave, czy nie.
{% endhint %}

## Nitro Enclave CLI installation

Follow the all instructions [**from the documentation**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). However, these are the most important ones:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

Obrazy, kt贸re mo偶esz uruchomi w Nitro Enclave, s oparte na obrazach docker, wic mo偶esz tworzy swoje obrazy Nitro Enclave z obraz贸w docker, takich jak:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Jak wida, obrazy Nitro Enclave u偶ywaj rozszerzenia **`eif`** (Enclave Image File).

Wynik bdzie wyglda podobnie do:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Uruchom obraz

Zgodnie z [**dokumentacj**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), aby uruchomi obraz enklawy, musisz przypisa mu pami o **co najmniej 4-krotnoci rozmiaru pliku `eif`**. Mo偶liwe jest skonfigurowanie domylnych zasob贸w, kt贸re mu przydzielisz w pliku.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Zawsze pamitaj, 偶e musisz **zarezerwowa pewne zasoby dla rodzica EC2**!
{% endhint %}

Po poznaniu zasob贸w, kt贸re nale偶y przydzieli obrazowi, a nawet po modyfikacji pliku konfiguracyjnego, mo偶liwe jest uruchomienie obrazu enklawy za pomoc:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enumeracja Enklaw

Jeli skompromitujesz hosta EC2, mo偶liwe jest uzyskanie listy dziaajcych obraz贸w enklaw za pomoc:
```bash
nitro-cli describe-enclaves
```
Nie jest **mo偶liwe uzyskanie powoki** wewntrz dziaajcego obrazu enclave, poniewa偶 to jest g贸wny cel enclave, jednak jeli u偶yjesz parametru **`--debug-mode`**, mo偶liwe jest uzyskanie **stdout** za pomoc:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminate Enclaves

Jeli atakujcy skompromituje instancj EC2, domylnie nie bdzie w stanie uzyska powoki wewntrz nich, ale bdzie m贸g je **zakoczy** za pomoc:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

Jedynym sposobem na komunikacj z **enklaw** uruchamiajc obraz jest u偶ycie **vsocks**.

**Virtual Socket (vsock)** to rodzina gniazd w systemie Linux, zaprojektowana specjalnie w celu uatwienia **komunikacji** midzy maszynami wirtualnymi (**VM**) a ich **hypervisorami**, lub midzy VM **sami**. Vsock umo偶liwia efektywn, **dwukierunkow komunikacj** bez polegania na stosie sieciowym hosta. Umo偶liwia to VM komunikacj nawet bez konfiguracji sieci, **u偶ywajc 32-bitowego identyfikatora kontekstu (CID) i numer贸w port贸w** do identyfikacji i zarzdzania poczeniami. API vsock obsuguje zar贸wno typy gniazd strumieniowych, jak i datagramowych, podobnie jak TCP i UDP, co zapewnia wszechstronne narzdzie dla aplikacji na poziomie u偶ytkownika w wirtualnych rodowiskach.

{% hint style="success" %}
Dlatego adres vsock wyglda tak: `<CID>:<Port>`
{% endhint %}

Aby znale藕 **CID** obraz贸w uruchamiajcych enklaw, mo偶esz po prostu wykona nastpujce polecenie i uzyska **`EnclaveCID`**:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Zauwa偶, 偶e z hosta nie ma sposobu, aby wiedzie, czy CID eksponuje jaki port! Chyba 偶e u偶ywasz jakiego **skanera port贸w vsock, takiego jak** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Vsock Server/Listener

Znajd藕 tutaj kilka przykad贸w:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Prosty nasuchiwacz w Pythonie</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Klient Vsock

Przykady:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Prosty klient Python</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

Narzdzie vsock-proxy pozwala na proxy vsock proxy z innym adresem, na przykad:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
To bdzie przekazywa **lokalny port 8001 w vsock** do `ip-ranges.amazonaws.com:443`, a plik **`your-vsock-proxy.yaml`** mo偶e mie t zawarto, umo偶liwiajc dostp do `ip-ranges.amazonaws.com:443`:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
Mo偶liwe jest zobaczenie adres贸w vsock (**`<CID>:<Port>`**) u偶ywanych przez hosta EC2 z (zauwa偶 `3:8001`, 3 to CID, a 8001 to port):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atestacja & KMS

SDK Nitro Enclaves pozwala na to, aby enclave za偶da **cyfrowo podpisanego dokumentu atestacyjnego** od Nitro **Hypervisora**, kt贸ry zawiera **unikalne pomiary** specyficzne dla tej enclave. Te pomiary, kt贸re obejmuj **hashe i rejestry konfiguracji platformy (PCR)**, s u偶ywane podczas procesu atestacji do **udowodnienia to偶samoci enclave** i **budowania zaufania z zewntrznymi usugami**. Dokument atestacyjny zazwyczaj zawiera wartoci takie jak PCR0, PCR1 i PCR2, kt贸re spotkae wczeniej podczas budowania i zapisywania pliku EIF enclave.

Z [**dokumentacji**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), oto wartoci PCR:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash of ...</th><th>Opis</th></tr></thead><tbody><tr><td>PCR0</td><td>Plik obrazu enclave</td><td>Ciagy pomiar zawartoci pliku obrazu, bez danych sekcji.</td></tr><tr><td>PCR1</td><td>Jdro Linux i bootstrap</td><td>Ciagy pomiar danych jdra i boot ramfs.</td></tr><tr><td>PCR2</td><td>Aplikacja</td><td>Ciagy, uporzdkowany pomiar aplikacji u偶ytkownika, bez boot ramfs.</td></tr><tr><td>PCR3</td><td>Rola IAM przypisana do instancji macierzystej</td><td>Ciagy pomiar roli IAM przypisanej do instancji macierzystej. Zapewnia, 偶e proces atestacji koczy si sukcesem tylko wtedy, gdy instancja macierzysta ma poprawn rol IAM.</td></tr><tr><td>PCR4</td><td>ID instancji macierzystej</td><td>Ciagy pomiar ID instancji macierzystej. Zapewnia, 偶e proces atestacji koczy si sukcesem tylko wtedy, gdy instancja macierzysta ma konkretne ID instancji.</td></tr><tr><td>PCR8</td><td>Certyfikat podpisu pliku obrazu enclave</td><td>Pomiar certyfikatu podpisu okrelonego dla pliku obrazu enclave. Zapewnia, 偶e proces atestacji koczy si sukcesem tylko wtedy, gdy enclave zosta uruchomiony z pliku obrazu enclave podpisanego przez konkretny certyfikat.</td></tr></tbody></table>

Mo偶esz zintegrowa **cyfrow atestacj** w swoich aplikacjach i wykorzysta gotowe integracje z usugami takimi jak **AWS KMS**. AWS KMS mo偶e **walidowa atestacje enclave** i oferuje klucze warunkowe oparte na atestacji (`kms:RecipientAttestation:ImageSha384` i `kms:RecipientAttestation:PCR`) w swoich politykach kluczy. Polityki te zapewniaj, 偶e AWS KMS zezwala na operacje z u偶yciem klucza KMS **tylko wtedy, gdy dokument atestacyjny enclave jest wa偶ny** i spenia **okrelone warunki**.

{% hint style="success" %}
Zauwa偶, 偶e Enclaves w trybie debug (--debug) generuj dokumenty atestacyjne z PCR, kt贸re skadaj si z zer (`000000000000000000000000000000000000000000000000`). Dlatego polityki KMS sprawdzajce te wartoci bd nieudane.
{% endhint %}

### Ominicie PCR

Z perspektywy atakujcego, zauwa偶, 偶e niekt贸re PCR pozwoliyby na modyfikacj niekt贸rych czci lub caego obrazu enclave i nadal byyby wa偶ne (na przykad PCR4 sprawdza tylko ID instancji macierzystej, wic uruchomienie dowolnego obrazu enclave w tej EC2 pozwoli na spenienie tego potencjalnego wymogu PCR).

Dlatego atakujcy, kt贸ry skompromituje instancj EC2, mo偶e by w stanie uruchomi inne obrazy enclave w celu ominicia tych zabezpiecze.

Badania nad tym, jak modyfikowa/tworzy nowe obrazy, aby obej ka偶d ochron (szczeg贸lnie te, kt贸re nie s oczywiste) s nadal w planach.

## Referencje

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Wszystkie czci samouczka Nitro od AWS: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
