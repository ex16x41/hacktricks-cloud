# AWS - Nitro Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

AWS Nitro je skup **inovativnih tehnologija** koje 캜ine osnovnu platformu za AWS EC2 instance. Uveden od strane Amazona da **pobolj코a bezbednost, performanse i pouzdanost**, Nitro koristi prilago캠ene **hardverske komponente i lagani hipervizor**. Apstrahuje ve캖inu tradicionalne funkcionalnosti virtualizacije na posve캖en hardver i softver, **minimiziraju캖i povr코inu napada** i pobolj코avaju캖i efikasnost resursa. Prebacivanjem funkcija virtualizacije, Nitro omogu캖ava EC2 instancama da pru쬰 **performanse blizu onih na fizi캜kom hardveru**, 코to je posebno korisno za aplikacije koje zahtevaju mnogo resursa. Pored toga, Nitro Security Chip posebno osigurava **bezbednost hardvera i firmvera**, dodatno u캜vr코캖uju캖i svoju robusnu arhitekturu.

### Nitro Enclaves

**AWS Nitro Enclaves** pru쬬 sigurno, **izolovano okru쬰nje za obradu unutar Amazon EC2 instanci**, posebno dizajnirano za obradu veoma osetljivih podataka. Koriste캖i AWS Nitro sistem, ova okru쬰nja osiguravaju robusnu **izolaciju i bezbednost**, idealno za **rukovanje poverljivim informacijama** kao 코to su PII ili finansijski podaci. Imaju minimalisti캜ko okru쬰nje, zna캜ajno smanjuju캖i rizik od izlaganja podataka. Pored toga, Nitro Enclaves podr쬬vaju kriptografsku attestaciju, omogu캖avaju캖i korisnicima da verifikuju da samo autorizovani kod radi, 코to je klju캜no za odr쬬vanje strogih standarda uskla캠enosti i za코tite podataka.

{% hint style="danger" %}
Nitro Enclave slike se **pokre캖u iznutra EC2 instanci** i ne mo쬰te videti iz AWS web konzole da li EC2 instance pokre캖u slike u Nitro Enclave ili ne.
{% endhint %}

## Nitro Enclave CLI installation

Follow the all instructions [**from the documentation**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). However, these are the most important ones:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

Slike koje mo쬰te pokrenuti u Nitro Enclave su zasnovane na docker slikama, tako da mo쬰te kreirati svoje Nitro Enclave slike iz docker slika kao 코to su:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Kao 코to mo쬰te videti, Nitro Enclave slike koriste ekstenziju **`eif`** (Enclave Image File).

Izlaz 캖e izgledati sli캜no:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Pokreni sliku

Prema [**dokumentaciji**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), da biste pokrenuli sliku enklave, potrebno je da joj dodelite memoriju **od najmanje 4 puta veli캜ine `eif` datoteke**. Mogu캖e je konfigurisati podrazumevane resurse koje joj dodelju u datoteci.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Uvek zapamtite da treba da **rezervi코ete neke resurse za roditeljsku EC2** instancu tako캠e!
{% endhint %}

Nakon 코to znate resurse koje treba dodeliti slici i 캜ak ste izmenili konfiguracioni fajl, mogu캖e je pokrenuti sliku enklave sa:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enumerate Enclaves

Ako kompromitujete EC2 host, mogu캖e je dobiti listu pokrenutih slika enklava sa:
```bash
nitro-cli describe-enclaves
```
Nije **mogu캖e dobiti shell** unutar pokrenutog enclave imid쬬 jer je to glavna svrha enclave, me캠utim, ako koristite parametar **`--debug-mode`**, mogu캖e je dobiti **stdout** sa:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminate Enclaves

Ako napada캜 kompromituje EC2 instancu, po defaultu ne캖e mo캖i da dobije shell unutar njih, ali 캖e mo캖i da **terminate them** sa:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

Jedini na캜in za komunikaciju sa **enklavom** koja pokre캖e sliku je kori코캖enje **vsocks**.

**Virtual Socket (vsock)** je porodica soketa u Linuxu posebno dizajnirana za olak코avanje **komunikacije** izme캠u virtuelnih ma코ina (**VMs**) i njihovih **hipervizora**, ili izme캠u VMs **same**. Vsock omogu캖ava efikasnu, **dvosmernu komunikaciju** bez oslanjanja na mre쬹i stek hosta. Ovo omogu캖ava VMs da komuniciraju 캜ak i bez mre쬹ih konfiguracija, **koriste캖i 32-bitni Context ID (CID) i brojeve portova** za identifikaciju i upravljanje vezama. Vsock API podr쬬va i stream i datagram tipove soketa, sli캜no TCP i UDP, pru쬬ju캖i svestran alat za aplikacije na korisni캜kom nivou u virtuelnim okru쬰njima.

{% hint style="success" %}
Stoga, vsock adresa izgleda ovako: `<CID>:<Port>`
{% endhint %}

Da biste prona코li **CIDs** slika koje pokre캖e enklava, mo쬰te jednostavno izvr코iti slede캖u komandu i dobiti **`EnclaveCID`**:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Napomena: sa hosta ne postoji na캜in da se sazna da li neki CID izla쬰 bilo koji port! Osim kori코캖enjem nekog **vsock port skenera kao** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Vsock Server/Listener

Ovde su neki primeri:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Jednostavni Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Klijent

Primeri:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Jednostavni Python Klijent</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

Alat vsock-proxy omogu캖ava proksiranje vsock proksija sa drugom adresom, na primer:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Ovo 캖e proslediti **lokalni port 8001 u vsock** na `ip-ranges.amazonaws.com:443`, a datoteka **`your-vsock-proxy.yaml`** mo쬰 imati ovaj sadr쬬j koji omogu캖ava pristup `ip-ranges.amazonaws.com:443`:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
Mogu캖e je videti vsock adrese (**`<CID>:<Port>`**) koje koristi EC2 host sa (napomena: `3:8001`, 3 je CID, a 8001 port):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atestacija & KMS

Nitro Enclaves SDK omogu캖ava enklavi da zatra쬴 **kriptografski potpisan dokument o atestaciji** od Nitro **Hypervisor-a**, koji uklju캜uje **jedinstvene merenja** specifi캜ne za tu enklavu. Ova merenja, koja uklju캜uju **hash-ove i registre konfiguracije platforme (PCRs)**, koriste se tokom procesa atestacije da **doka쬿 identitet enklave** i **izgrade poverenje sa spoljnim servisima**. Dokument o atestaciji obi캜no sadr쬴 vrednosti kao 코to su PCR0, PCR1 i PCR2, koje ste ve캖 sreli prilikom izrade i 캜uvanja EIF-a enklave.

Prema [**docs**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), ovo su PCR vrednosti:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash of ...</th><th>Opis</th></tr></thead><tbody><tr><td>PCR0</td><td>Fajl slike enklave</td><td>Kontinuirano merenje sadr쬬ja fajla slike, bez podataka o sekciji.</td></tr><tr><td>PCR1</td><td>Linux kernel i bootstrap</td><td>Kontinuirano merenje podataka o kernelu i boot ramfs-u.</td></tr><tr><td>PCR2</td><td>Aplikacija</td><td>Kontinuirano, redosledno merenje korisni캜kih aplikacija, bez boot ramfs-a.</td></tr><tr><td>PCR3</td><td>IAM uloga dodeljena roditeljskoj instanci</td><td>Kontinuirano merenje IAM uloge dodeljene roditeljskoj instanci. Osigurava da proces atestacije uspeva samo kada roditeljska instanca ima ispravnu IAM ulogu.</td></tr><tr><td>PCR4</td><td>ID instance roditeljske instance</td><td>Kontinuirano merenje ID-a roditeljske instance. Osigurava da proces atestacije uspeva samo kada roditeljska instanca ima specifi캜an ID instance.</td></tr><tr><td>PCR8</td><td>Potpisni sertifikat fajla slike enklave</td><td>Merenje potpisnog sertifikata specificiranog za fajl slike enklave. Osigurava da proces atestacije uspeva samo kada je enklava pokrenuta iz fajla slike enklave potpisanog specifi캜nim sertifikatom.</td></tr></tbody></table>

Mo쬰te integrisati **kriptografsku atestaciju** u svoje aplikacije i iskoristiti unapred izgra캠ene integracije sa servisima kao 코to je **AWS KMS**. AWS KMS mo쬰 **validirati atestacije enklava** i nudi klju캜eve zasnovane na atestaciji (`kms:RecipientAttestation:ImageSha384` i `kms:RecipientAttestation:PCR`) u svojim politikama klju캜eva. Ove politike osiguravaju da AWS KMS dozvoljava operacije koriste캖i KMS klju캜 **samo ako je dokument o atestaciji enklave validan** i ispunjava **specificirane uslove**.

{% hint style="success" %}
Napomena da Enklave u debug (--debug) re쬴mu generi코u dokumente o atestaciji sa PCR-ima koji se sastoje od nula (`000000000000000000000000000000000000000000000000`). Stoga, KMS politike koje proveravaju ove vrednosti 캖e propasti.
{% endhint %}

### PCR Bypass

Iz perspektive napada캜a, primetite da neki PCR-i omogu캖avaju modifikaciju nekih delova ili cele slike enklave i da 캖e i dalje biti validni (na primer, PCR4 samo proverava ID roditeljske instance, tako da pokretanje bilo koje slike enklave u toj EC2 캖e omogu캖iti ispunjavanje ovog potencijalnog PCR zahteva).

Stoga, napada캜 koji kompromituje EC2 instancu mo쬰 biti u mogu캖nosti da pokrene druge slike enklava kako bi zaobi코ao ove za코tite.

Istra쬴vanje o tome kako modifikovati/kreati nove slike za zaobila쬰nje svake za코tite (posebno onih koje nisu tako o캜igledne) je jo코 uvek TODO.

## Reference

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Sve delove Nitro tutorijala od AWS: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
