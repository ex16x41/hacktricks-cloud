# AWS - Nitro Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## ê¸°ë³¸ ì •ë³´

AWS NitroëŠ” AWS EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ê¸°ë³¸ í”Œë«í¼ì„ êµ¬ì„±í•˜ëŠ” **í˜ì‹ ì ì¸ ê¸°ìˆ ** ëª¨ìŒì…ë‹ˆë‹¤. Amazonì´ **ë³´ì•ˆ, ì„±ëŠ¥ ë° ì‹ ë¢°ì„±ì„ í–¥ìƒ**ì‹œí‚¤ê¸° ìœ„í•´ ë„ì…í•œ NitroëŠ” ë§ì¶¤í˜• **í•˜ë“œì›¨ì–´ êµ¬ì„± ìš”ì†Œì™€ ê²½ëŸ‰ í•˜ì´í¼ë°”ì´ì €**ë¥¼ í™œìš©í•©ë‹ˆë‹¤. ì „í†µì ì¸ ê°€ìƒí™” ê¸°ëŠ¥ì˜ ë§ì€ ë¶€ë¶„ì„ ì „ìš© í•˜ë“œì›¨ì–´ì™€ ì†Œí”„íŠ¸ì›¨ì–´ë¡œ ì¶”ìƒí™”í•˜ì—¬ **ê³µê²© í‘œë©´ì„ ìµœì†Œí™”**í•˜ê³  ìì› íš¨ìœ¨ì„±ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤. ê°€ìƒí™” ê¸°ëŠ¥ì„ ì˜¤í”„ë¡œë“œí•¨ìœ¼ë¡œì¨ NitroëŠ” EC2 ì¸ìŠ¤í„´ìŠ¤ê°€ **ê±°ì˜ ë² ì–´ ë©”íƒˆ ì„±ëŠ¥**ì„ ì œê³µí•  ìˆ˜ ìˆê²Œ í•˜ì—¬ ìì› ì§‘ì•½ì ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì— íŠ¹íˆ ìœ ë¦¬í•©ë‹ˆë‹¤. ë˜í•œ, Nitro ë³´ì•ˆ ì¹©ì€ **í•˜ë“œì›¨ì–´ ë° íŒì›¨ì–´ì˜ ë³´ì•ˆ**ì„ ë³´ì¥í•˜ì—¬ ê²¬ê³ í•œ ì•„í‚¤í…ì²˜ë¥¼ ë”ìš± ê°•í™”í•©ë‹ˆë‹¤.

### Nitro Enclaves

**AWS Nitro Enclaves**ëŠ” Amazon EC2 ì¸ìŠ¤í„´ìŠ¤ ë‚´ì—ì„œ **ê³ ë„ë¡œ ë¯¼ê°í•œ ë°ì´í„°ë¥¼ ì²˜ë¦¬**í•˜ê¸° ìœ„í•´ ì„¤ê³„ëœ ì•ˆì „í•˜ê³  **ê²©ë¦¬ëœ ì»´í“¨íŒ… í™˜ê²½**ì„ ì œê³µí•©ë‹ˆë‹¤. AWS Nitro ì‹œìŠ¤í…œì„ í™œìš©í•˜ì—¬ ì´ëŸ¬í•œ ì—”í´ë ˆì´ë¸ŒëŠ” ê°•ë ¥í•œ **ê²©ë¦¬ ë° ë³´ì•ˆ**ì„ ë³´ì¥í•˜ë©°, **PIIë‚˜ ê¸ˆìœµ ê¸°ë¡**ê³¼ ê°™ì€ ê¸°ë°€ ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë° ì´ìƒì ì…ë‹ˆë‹¤. ìµœì†Œí•œì˜ í™˜ê²½ì„ ì œê³µí•˜ì—¬ ë°ì´í„° ë…¸ì¶œ ìœ„í—˜ì„ í¬ê²Œ ì¤„ì…ë‹ˆë‹¤. ë˜í•œ, Nitro EnclavesëŠ” ì•”í˜¸í™” ì¸ì¦ì„ ì§€ì›í•˜ì—¬ ì‚¬ìš©ìê°€ ìŠ¹ì¸ëœ ì½”ë“œë§Œ ì‹¤í–‰ë˜ê³  ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆê²Œ í•˜ì—¬ ì—„ê²©í•œ ì¤€ìˆ˜ ë° ë°ì´í„° ë³´í˜¸ í‘œì¤€ì„ ìœ ì§€í•˜ëŠ” ë° í•„ìˆ˜ì ì…ë‹ˆë‹¤.

{% hint style="danger" %}
Nitro Enclave ì´ë¯¸ì§€ëŠ” **EC2 ì¸ìŠ¤í„´ìŠ¤ ë‚´ë¶€ì—ì„œ ì‹¤í–‰**ë˜ë©°, AWS ì›¹ ì½˜ì†”ì—ì„œëŠ” EC2 ì¸ìŠ¤í„´ìŠ¤ê°€ Nitro Enclaveì—ì„œ ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰ ì¤‘ì¸ì§€ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
{% endhint %}

## Nitro Enclave CLI ì„¤ì¹˜

ëª¨ë“  ì§€ì¹¨ì„ [**ë¬¸ì„œì—ì„œ**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave) ë”°ë¥´ì‹­ì‹œì˜¤. ê·¸ëŸ¬ë‚˜, ë‹¤ìŒì´ ê°€ì¥ ì¤‘ìš”í•œ ì§€ì¹¨ì…ë‹ˆë‹¤:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

Nitro Enclaveì—ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ì´ë¯¸ì§€ëŠ” docker ì´ë¯¸ì§€ ê¸°ë°˜ì´ë¯€ë¡œ ë‹¤ìŒê³¼ ê°™ì€ docker ì´ë¯¸ì§€ì—ì„œ Nitro Enclave ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Nitro Enclave ì´ë¯¸ì§€ê°€ **`eif`** (Enclave Image File) í™•ì¥ìë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì¶œë ¥ì€ ë‹¤ìŒê³¼ ìœ ì‚¬í•˜ê²Œ ë³´ì¼ ê²ƒì…ë‹ˆë‹¤:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Run an Image

[**ë¬¸ì„œ**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)ì— ë”°ë¥´ë©´, enclave ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ **`eif` íŒŒì¼ í¬ê¸°ì˜ ìµœì†Œ 4ë°°ì˜ ë©”ëª¨ë¦¬**ë¥¼ í• ë‹¹í•´ì•¼ í•©ë‹ˆë‹¤. íŒŒì¼ì—ì„œ ê¸°ë³¸ ë¦¬ì†ŒìŠ¤ë¥¼ êµ¬ì„±í•˜ì—¬ í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
í•­ìƒ **ë¶€ëª¨ EC2** ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìœ„í•´ ì¼ë¶€ ë¦¬ì†ŒìŠ¤ë¥¼ ì˜ˆì•½í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì„ ê¸°ì–µí•˜ì„¸ìš”!
{% endhint %}

ì´ë¯¸ì§€ì— ì œê³µí•  ë¦¬ì†ŒìŠ¤ë¥¼ ì•Œê³  êµ¬ì„± íŒŒì¼ì„ ìˆ˜ì •í•œ í›„ì—ë„ enclave ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enclaves ì—´ê±°

EC2 í˜¸ìŠ¤íŠ¸ë¥¼ ì†ìƒì‹œí‚¤ë©´ ë‹¤ìŒì„ í†µí•´ ì‹¤í–‰ ì¤‘ì¸ enclave ì´ë¯¸ì§€ ëª©ë¡ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
nitro-cli describe-enclaves
```
ì‹¤í–‰ ì¤‘ì¸ enclave ì´ë¯¸ì§€ ë‚´ë¶€ì— **shellì„ ì–»ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥**í•©ë‹ˆë‹¤. ì´ëŠ” enclaveì˜ ì£¼ìš” ëª©ì ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **`--debug-mode`** ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì´ **stdout**ì„ ì–»ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminate Enclaves

ê³µê²©ìê°€ ê¸°ë³¸ì ìœ¼ë¡œ EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì†ìƒì‹œí‚¤ë©´ ë‚´ë¶€ì— ì…¸ì„ ì–»ì„ ìˆ˜ëŠ” ì—†ì§€ë§Œ, ë‹¤ìŒê³¼ ê°™ì´ **ì¢…ë£Œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

**enclave** ì‹¤í–‰ ì´ë¯¸ì§€ë¥¼ í†µì‹ í•˜ëŠ” ìœ ì¼í•œ ë°©ë²•ì€ **vsocks**ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

**Virtual Socket (vsock)**ì€ ê°€ìƒ ë¨¸ì‹ (**VMs**)ê³¼ ê·¸ **í•˜ì´í¼ë°”ì´ì €** ë˜ëŠ” VMs ê°„ì˜ **í†µì‹ **ì„ ìš©ì´í•˜ê²Œ í•˜ê¸° ìœ„í•´ Linuxì—ì„œ íŠ¹ë³„íˆ ì„¤ê³„ëœ ì†Œì¼“ íŒ¨ë°€ë¦¬ì…ë‹ˆë‹¤. Vsockì€ í˜¸ìŠ¤íŠ¸ì˜ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤íƒì— ì˜ì¡´í•˜ì§€ ì•Šê³  íš¨ìœ¨ì ì´ê³  **ì–‘ë°©í–¥ í†µì‹ **ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ êµ¬ì„± ì—†ì´ë„ VMs ê°„ì˜ í†µì‹ ì´ ê°€ëŠ¥í•˜ë©°, **32ë¹„íŠ¸ Context ID (CID)ì™€ í¬íŠ¸ ë²ˆí˜¸**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì—°ê²°ì„ ì‹ë³„í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤. vsock APIëŠ” TCPì™€ UDPì™€ ìœ ì‚¬í•˜ê²Œ ìŠ¤íŠ¸ë¦¼ ë° ë°ì´í„°ê·¸ë¨ ì†Œì¼“ ìœ í˜•ì„ ëª¨ë‘ ì§€ì›í•˜ì—¬ ê°€ìƒ í™˜ê²½ì—ì„œ ì‚¬ìš©ì ìˆ˜ì¤€ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ìœ ì—°í•œ ë„êµ¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

{% hint style="success" %}
ë”°ë¼ì„œ vsock ì£¼ì†ŒëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë³´ì…ë‹ˆë‹¤: `<CID>:<Port>`
{% endhint %}

**enclave** ì‹¤í–‰ ì´ë¯¸ì§€ì˜ **CIDs**ë¥¼ ì°¾ìœ¼ë ¤ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ê³  **`EnclaveCID`**ë¥¼ í™•ì¸í•˜ë©´ ë©ë‹ˆë‹¤:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
í˜¸ìŠ¤íŠ¸ì—ì„œ CIDê°€ í¬íŠ¸ë¥¼ ë…¸ì¶œí•˜ê³  ìˆëŠ”ì§€ ì•Œ ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ì—†ìŠµë‹ˆë‹¤! **vsock í¬íŠ¸ ìŠ¤ìºë„ˆ** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner)ì™€ ê°™ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” í•œ.
{% endhint %}

### Vsock Server/Listener

ì—¬ê¸° ëª‡ ê°€ì§€ ì˜ˆì‹œê°€ ìˆìŠµë‹ˆë‹¤:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Simple Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Client

ì˜ˆì‹œ:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>ê°„ë‹¨í•œ Python Client</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

vsock-proxy ë„êµ¬ëŠ” ë‹¤ë¥¸ ì£¼ì†Œë¡œ vsock í”„ë¡ì‹œë¥¼ í”„ë¡ì‹œí•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
ì´ê²ƒì€ **vsockì˜ ë¡œì»¬ í¬íŠ¸ 8001**ì„ `ip-ranges.amazonaws.com:443`ë¡œ í¬ì›Œë”©í•˜ë©°, íŒŒì¼ **`your-vsock-proxy.yaml`**ì€ `ip-ranges.amazonaws.com:443`ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë‹¤ìŒê³¼ ê°™ì€ ë‚´ìš©ì„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
EC2 í˜¸ìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©ë˜ëŠ” vsock ì£¼ì†Œ(**`<CID>:<Port>`**)ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (`3:8001`ì— ì£¼ëª©í•˜ì‹­ì‹œì˜¤. 3ì€ CIDì´ê³  8001ì€ í¬íŠ¸ì…ë‹ˆë‹¤):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atestation & KMS

Nitro Enclaves SDKëŠ” enclaveê°€ Nitro **Hypervisor**ë¡œë¶€í„° **ì•”í˜¸í•™ì ìœ¼ë¡œ ì„œëª…ëœ attestation ë¬¸ì„œ**ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. ì´ ë¬¸ì„œì—ëŠ” í•´ë‹¹ enclaveì— ê³ ìœ í•œ **ì¸¡ì •ê°’**ì´ í¬í•¨ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì¸¡ì •ê°’ì€ **í•´ì‹œ ë° í”Œë«í¼ êµ¬ì„± ë ˆì§€ìŠ¤í„°(PCR)**ë¥¼ í¬í•¨í•˜ë©°, attestation ê³¼ì •ì—ì„œ **enclaveì˜ ì‹ ì›ì„ ì¦ëª…**í•˜ê³  **ì™¸ë¶€ ì„œë¹„ìŠ¤ì™€ì˜ ì‹ ë¢°ë¥¼ êµ¬ì¶•**í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. attestation ë¬¸ì„œì—ëŠ” ì¼ë°˜ì ìœ¼ë¡œ PCR0, PCR1, PCR2ì™€ ê°™ì€ ê°’ì´ í¬í•¨ë˜ë©°, ì´ëŠ” enclave EIFë¥¼ êµ¬ì¶•í•˜ê³  ì €ì¥í•  ë•Œ ì ‘í•˜ê²Œ ë˜ëŠ” ê°’ì…ë‹ˆë‹¤.

[**ë¬¸ì„œ**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves)ì— ë”°ë¥´ë©´, ë‹¤ìŒì€ PCR ê°’ì…ë‹ˆë‹¤:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash of ...</th><th>Description</th></tr></thead><tbody><tr><td>PCR0</td><td>Enclave image file</td><td>ì´ë¯¸ì§€ íŒŒì¼ì˜ ë‚´ìš©ì˜ ì—°ì†ì ì¸ ì¸¡ì •ê°’, ì„¹ì…˜ ë°ì´í„° ì œì™¸.</td></tr><tr><td>PCR1</td><td>Linux kernel and bootstrap</td><td>ì»¤ë„ ë° ë¶€íŠ¸ ramfs ë°ì´í„°ì˜ ì—°ì†ì ì¸ ì¸¡ì •ê°’.</td></tr><tr><td>PCR2</td><td>Application</td><td>ë¶€íŠ¸ ramfsë¥¼ ì œì™¸í•œ ì‚¬ìš©ì ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì—°ì†ì ì´ê³  ìˆœì°¨ì ì¸ ì¸¡ì •ê°’.</td></tr><tr><td>PCR3</td><td>IAM role assigned to the parent instance</td><td>ìƒìœ„ ì¸ìŠ¤í„´ìŠ¤ì— í• ë‹¹ëœ IAM ì—­í• ì˜ ì—°ì†ì ì¸ ì¸¡ì •ê°’. ìƒìœ„ ì¸ìŠ¤í„´ìŠ¤ì— ì˜¬ë°”ë¥¸ IAM ì—­í• ì´ í• ë‹¹ëœ ê²½ìš°ì—ë§Œ attestation ê³¼ì •ì´ ì„±ê³µí•˜ë„ë¡ ë³´ì¥.</td></tr><tr><td>PCR4</td><td>Instance ID of the parent instance</td><td>ìƒìœ„ ì¸ìŠ¤í„´ìŠ¤ì˜ IDì˜ ì—°ì†ì ì¸ ì¸¡ì •ê°’. ìƒìœ„ ì¸ìŠ¤í„´ìŠ¤ì— íŠ¹ì • ì¸ìŠ¤í„´ìŠ¤ IDê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ attestation ê³¼ì •ì´ ì„±ê³µí•˜ë„ë¡ ë³´ì¥.</td></tr><tr><td>PCR8</td><td>Enclave image file signing certificate</td><td>enclave ì´ë¯¸ì§€ íŒŒì¼ì— ì§€ì •ëœ ì„œëª… ì¸ì¦ì„œì˜ ì¸¡ì •ê°’. íŠ¹ì • ì¸ì¦ì„œë¡œ ì„œëª…ëœ enclave ì´ë¯¸ì§€ íŒŒì¼ì—ì„œ ë¶€íŒ…ëœ ê²½ìš°ì—ë§Œ attestation ê³¼ì •ì´ ì„±ê³µí•˜ë„ë¡ ë³´ì¥.</td></tr></tbody></table>

**ì•”í˜¸í•™ì  attestation**ì„ ì• í”Œë¦¬ì¼€ì´ì…˜ì— í†µí•©í•˜ê³  **AWS KMS**ì™€ ê°™ì€ ì„œë¹„ìŠ¤ì™€ì˜ ì‚¬ì „ êµ¬ì¶•ëœ í†µí•©ì„ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. AWS KMSëŠ” **enclave attestationì„ ê²€ì¦**í•  ìˆ˜ ìˆìœ¼ë©°, í‚¤ ì •ì±…ì—ì„œ attestation ê¸°ë°˜ ì¡°ê±´ í‚¤(`kms:RecipientAttestation:ImageSha384` ë° `kms:RecipientAttestation:PCR`)ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì •ì±…ì€ AWS KMSê°€ **enclaveì˜ attestation ë¬¸ì„œê°€ ìœ íš¨í•˜ê³ ** ì§€ì •ëœ ì¡°ê±´ì„ ì¶©ì¡±í•˜ëŠ” ê²½ìš°ì—ë§Œ KMS í‚¤ë¥¼ ì‚¬ìš©í•œ ì‘ì—…ì„ í—ˆìš©í•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

{% hint style="success" %}
ë””ë²„ê·¸ ëª¨ë“œ(--debug)ì—ì„œ EnclavesëŠ” PCRì´ ëª¨ë‘ 0ìœ¼ë¡œ êµ¬ì„±ëœ(`000000000000000000000000000000000000000000000000`) attestation ë¬¸ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ëŸ¬í•œ ê°’ì„ í™•ì¸í•˜ëŠ” KMS ì •ì±…ì€ ì‹¤íŒ¨í•  ê²ƒì…ë‹ˆë‹¤.
{% endhint %}

### PCR Bypass

ê³µê²©ìì˜ ê´€ì ì—ì„œ ë³´ë©´, ì¼ë¶€ PCRì€ enclave ì´ë¯¸ì§€ì˜ ì¼ë¶€ ë˜ëŠ” ì „ì²´ë¥¼ ìˆ˜ì •í•´ë„ ì—¬ì „íˆ ìœ íš¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì˜ˆ: PCR4ëŠ” ìƒìœ„ ì¸ìŠ¤í„´ìŠ¤ì˜ IDë§Œ í™•ì¸í•˜ë¯€ë¡œ í•´ë‹¹ EC2ì—ì„œ ì–´ë–¤ enclave ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰í•´ë„ ì´ PCR ìš”êµ¬ ì‚¬í•­ì„ ì¶©ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤).

ë”°ë¼ì„œ EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì†ìƒì‹œí‚¨ ê³µê²©ìëŠ” ì´ëŸ¬í•œ ë³´í˜¸ë¥¼ ìš°íšŒí•˜ê¸° ìœ„í•´ ë‹¤ë¥¸ enclave ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê° ë³´í˜¸ë¥¼ ìš°íšŒí•˜ê¸° ìœ„í•´ ì´ë¯¸ì§€ë¥¼ ìˆ˜ì •/ìƒì„±í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì—°êµ¬ëŠ” ì•„ì§ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.

## References

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* AWSì˜ Nitro íŠœí† ë¦¬ì–¼ ëª¨ë“  ë¶€ë¶„: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
AWS Hacking í•™ìŠµ ë° ì—°ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking í•™ìŠµ ë° ì—°ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* **PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
