# AWS - Nitro Enum

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne Informacije

AWS Nitro je skup **inovativnih tehnologija** koje Äine osnovnu platformu za AWS EC2 instance. Uveden od strane Amazona da **poboljÅ¡a sigurnost, performanse i pouzdanost**, Nitro koristi prilagoÄ‘ene **hardverske komponente i lagani hipervizor**. On apstrahuje veÄ‡inu tradicionalne virtualizacione funkcionalnosti na posveÄ‡en hardver i softver, **minimizirajuÄ‡i povrÅ¡inu napada** i poboljÅ¡avajuÄ‡i efikasnost resursa. Prebacivanjem funkcija virtualizacije, Nitro omoguÄ‡ava EC2 instancama da isporuÄe **skoro performanse kao na fiziÄkom hardveru**, Å¡to je posebno korisno za aplikacije koje zahtevaju mnogo resursa. Pored toga, Nitro Security Chip posebno osigurava **sigurnost hardvera i firmvera**, dodatno uÄvrÅ¡Ä‡ujuÄ‡i njegovu robusnu arhitekturu.

### Nitro Enklave

**AWS Nitro Enclaves** pruÅ¾a sigurno, **izolovano okruÅ¾enje za raÄunanje unutar Amazon EC2 instanci**, posebno dizajnirano za obradu visoko osetljivih podataka. KoristeÄ‡i AWS Nitro System, ove enklave osiguravaju robusnu **izolaciju i sigurnost**, idealne za **rukovanje poverljivim informacijama** kao Å¡to su PII ili finansijski zapisi. One imaju minimalistiÄko okruÅ¾enje, znaÄajno smanjujuÄ‡i rizik od izlaganja podataka. Pored toga, Nitro Enclaves podrÅ¾ava kriptografsku atestaciju, omoguÄ‡avajuÄ‡i korisnicima da verifikuju da samo autorizovani kod radi, Å¡to je kljuÄno za odrÅ¾avanje strogih standarda usklaÄ‘enosti i zaÅ¡tite podataka.

{% hint style="danger" %}
Nitro Enclave slike se **pokreÄ‡u iznutra EC2 instanci** i ne moÅ¾ete videti sa AWS web konzole da li EC2 instance pokreÄ‡u slike u Nitro Enclave ili ne.
{% endhint %}

## Nitro Enclave CLI instalacija

Pratite sve instrukcije [**iz dokumentacije**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). MeÄ‘utim, ovo su najvaÅ¾nije:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

Slike koje moÅ¾ete pokrenuti u Nitro Enclave bazirane su na docker slikama, tako da moÅ¾ete kreirati svoje Nitro Enclave slike iz docker slika kao:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Kao Å¡to moÅ¾ete videti, Nitro Enclave slike koriste ekstenziju **`eif`** (Enclave Image File).

Izlaz Ä‡e izgledati sliÄno:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Pokreni sliku

Prema [**dokumentaciji**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), da biste pokrenuli sliku enklave, potrebno je dodeliti joj memoriju od **najmanje 4 puta veÄ‡u od veliÄine `eif` fajla**. MoguÄ‡e je konfigurisati podrazumevane resurse koje Ä‡ete dodeliti u fajlu
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Uvek zapamtite da morate **rezervisati neke resurse za matiÄnu EC2** instancu takoÄ‘e!
{% endhint %}

Nakon Å¡to znate koje resurse da dodelite slici i Äak ste modifikovali konfiguracioni fajl, moguÄ‡e je pokrenuti sliku enklave sa:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enumerate Enclaves

Ako kompromitujete EC2 host, moguÄ‡e je dobiti listu pokrenutih enclave slika sa:
```bash
nitro-cli describe-enclaves
```
Nije **moguÄ‡e dobiti shell** unutar pokrenute enclave slike jer je to glavna svrha enclave, meÄ‘utim, ako koristite parametar **`--debug-mode`**, moguÄ‡e je dobiti **stdout** sa:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminate Enclaves

Ako napadaÄ kompromituje EC2 instancu, po defaultu neÄ‡e moÄ‡i da dobije shell unutar njih, ali Ä‡e moÄ‡i da ih **terminira** sa:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

Jedini naÄin za komunikaciju sa **enclave** koja pokreÄ‡e sliku je koriÅ¡Ä‡enje **vsocks**.

**Virtual Socket (vsock)** je socket porodica u Linux-u specijalno dizajnirana da olakÅ¡a **komunikaciju** izmeÄ‘u virtuelnih maÅ¡ina (**VMs**) i njihovih **hipervizora**, ili izmeÄ‘u samih VMs. Vsock omoguÄ‡ava efikasnu, **dvosmernu komunikaciju** bez oslanjanja na mreÅ¾ni stek hosta. Ovo omoguÄ‡ava VMs da komuniciraju Äak i bez mreÅ¾nih konfiguracija, **koristeÄ‡i 32-bitni Context ID (CID) i brojeve portova** za identifikaciju i upravljanje vezama. Vsock API podrÅ¾ava i stream i datagram tipove soketa, sliÄno TCP i UDP, pruÅ¾ajuÄ‡i svestran alat za aplikacije na korisniÄkom nivou u virtuelnim okruÅ¾enjima.

{% hint style="success" %}
Dakle, vsock adresa izgleda ovako: `<CID>:<Port>`
{% endhint %}

Da biste pronaÅ¡li **CIDs** slika koje pokreÄ‡u enclave, moÅ¾ete jednostavno izvrÅ¡iti sledeÄ‡u komandu i dobiti **`EnclaveCID`**:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Napomena da sa hosta ne postoji naÄin da se zna da li neki CID izlaÅ¾e bilo koji port! Osim ako se ne koristi neki **vsock port skener kao** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Vsock Server/Listener

Ovde moÅ¾ete pronaÄ‡i nekoliko primera:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Jednostavan Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
```markdown
</details>
```
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Client

Primeri:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Jednostavan Python Klijent</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
```markdown
</details>
```
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

Alat vsock-proxy omoguÄ‡ava proxy vsock proxy sa drugom adresom, na primer:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Ovo Ä‡e proslediti **lokalni port 8001 u vsock** na `ip-ranges.amazonaws.com:443` i fajl **`your-vsock-proxy.yaml`** moÅ¾e imati ovaj sadrÅ¾aj koji omoguÄ‡ava pristup `ip-ranges.amazonaws.com:443`:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
MoguÄ‡e je videti vsock adrese (**`<CID>:<Port>`**) koje koristi EC2 host sa (obratite paÅ¾nju na `3:8001`, 3 je CID a 8001 port):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atestacija & KMS

Nitro Enclaves SDK omoguÄ‡ava enklavi da zatraÅ¾i **kriptografski potpisan atestacioni dokument** od Nitro **Hypervisor-a**, koji ukljuÄuje **jedinstvene mere** specifiÄne za tu enklavu. Ove mere, koje ukljuÄuju **heÅ¡ove i registre konfiguracije platforme (PCRs)**, koriste se tokom procesa atestacije da **dokaÅ¾u identitet enklave** i **izgrade poverenje sa spoljnim servisima**. Atestacioni dokument obiÄno sadrÅ¾i vrednosti kao Å¡to su PCR0, PCR1 i PCR2, koje ste veÄ‡ sreli prilikom izgradnje i Äuvanja EIF-a enklave.

Iz [**dokumentacije**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), ovo su PCR vrednosti:

<table><thead><tr><th width="97">PCR</th><th width="221">HeÅ¡ od ...</th><th>Opis</th></tr></thead><tbody><tr><td>PCR0</td><td>Enklava image file</td><td>Kontinuirana mera sadrÅ¾aja image file-a, bez podataka o sekcijama.</td></tr><tr><td>PCR1</td><td>Linux kernel i bootstrap</td><td>Kontinuirana mera kernela i boot ramfs podataka.</td></tr><tr><td>PCR2</td><td>Aplikacija</td><td>Kontinuirana, redosledna mera korisniÄkih aplikacija, bez boot ramfs-a.</td></tr><tr><td>PCR3</td><td>IAM uloga dodeljena matiÄnoj instanci</td><td>Kontinuirana mera IAM uloge dodeljene matiÄnoj instanci. Osigurava da proces atestacije uspeva samo kada matiÄna instanca ima ispravnu IAM ulogu.</td></tr><tr><td>PCR4</td><td>ID matiÄne instance</td><td>Kontinuirana mera ID-a matiÄne instance. Osigurava da proces atestacije uspeva samo kada matiÄna instanca ima specifiÄan ID instance.</td></tr><tr><td>PCR8</td><td>Potpisni sertifikat image file-a enklave</td><td>Mera potpisnog sertifikata specificiranog za image file enklave. Osigurava da proces atestacije uspeva samo kada je enklava pokrenuta iz image file-a enklave potpisanog specifiÄnim sertifikatom.</td></tr></tbody></table>

MoÅ¾ete integrisati **kriptografsku atestaciju** u svoje aplikacije i koristiti unapred izgraÄ‘ene integracije sa servisima kao Å¡to je **AWS KMS**. AWS KMS moÅ¾e **validirati atestacije enklave** i nudi uslovne kljuÄeve zasnovane na atestaciji (`kms:RecipientAttestation:ImageSha384` i `kms:RecipientAttestation:PCR`) u svojim kljuÄnim politikama. Ove politike osiguravaju da AWS KMS dozvoljava operacije koriÅ¡Ä‡enjem KMS kljuÄa **samo ako je atestacioni dokument enklave validan** i ispunjava **specificirane uslove**.

{% hint style="success" %}
Napomena da Enklave u debug (--debug) reÅ¾imu generiÅ¡u atestacione dokumente sa PCR-ovima koji su sastavljeni od nula (`000000000000000000000000000000000000000000000000`). Stoga, KMS politike koje proveravaju ove vrednosti Ä‡e pasti.
{% endhint %}

### PCR ZaobilaÅ¾enje

Iz perspektive napadaÄa, primetite da neki PCR-ovi omoguÄ‡avaju modifikaciju nekih delova ili celog image-a enklave i da Ä‡e i dalje biti validni (na primer PCR4 samo proverava ID matiÄne instance, tako da pokretanje bilo kog image-a enklave u tom EC2 Ä‡e omoguÄ‡iti ispunjenje ovog potencijalnog PCR zahteva).

Stoga, napadaÄ koji kompromituje EC2 instancu moÅ¾e biti u moguÄ‡nosti da pokrene druge image-e enklave kako bi zaobiÅ¡ao ove zaÅ¡tite.

IstraÅ¾ivanje o tome kako modifikovati/kreirati nove image-e za zaobilaÅ¾enje svake zaÅ¡tite (posebno one koje nisu oÄigledne) je joÅ¡ uvek U TOKU.

## Reference

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Svi delovi Nitro tutorijala sa AWS-a: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove podnoÅ¡enjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
