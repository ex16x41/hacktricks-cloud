# AWS - Nitro Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

AWS Nitro est une suite de **technologies innovantes** qui forme la plateforme sous-jacente pour les instances AWS EC2. Introduit par Amazon pour **am√©liorer la s√©curit√©, la performance et la fiabilit√©**, Nitro s'appuie sur des **composants mat√©riels personnalis√©s et un hyperviseur l√©ger**. Il abstrait une grande partie de la fonctionnalit√© de virtualisation traditionnelle vers du mat√©riel et des logiciels d√©di√©s, **minimisant la surface d'attaque** et am√©liorant l'efficacit√© des ressources. En d√©chargeant les fonctions de virtualisation, Nitro permet aux instances EC2 de fournir une **performance proche du bare-metal**, ce qui est particuli√®rement b√©n√©fique pour les applications gourmandes en ressources. De plus, la puce de s√©curit√© Nitro garantit sp√©cifiquement la **s√©curit√© du mat√©riel et du firmware**, renfor√ßant ainsi son architecture robuste.

### Nitro Enclaves

**AWS Nitro Enclaves** fournit un environnement de calcul s√©curis√© et **isol√© au sein des instances Amazon EC2**, sp√©cifiquement con√ßu pour le traitement de donn√©es hautement sensibles. S'appuyant sur le syst√®me AWS Nitro, ces enclaves garantissent une **isolation et une s√©curit√© robustes**, id√©ales pour **traiter des informations confidentielles** telles que des donn√©es personnelles identifiables (PII) ou des dossiers financiers. Elles disposent d'un environnement minimaliste, r√©duisant consid√©rablement le risque d'exposition des donn√©es. De plus, les Nitro Enclaves prennent en charge l'attestation cryptographique, permettant aux utilisateurs de v√©rifier que seul le code autoris√© s'ex√©cute, ce qui est crucial pour maintenir des normes strictes de conformit√© et de protection des donn√©es.

{% hint style="danger" %}
Les images des Nitro Enclaves sont **ex√©cut√©es √† partir des instances EC2** et vous ne pouvez pas voir depuis la console web AWS si une instance EC2 ex√©cute des images dans Nitro Enclave ou non.
{% endhint %}

## Nitro Enclave CLI installation

Suivez toutes les instructions [**de la documentation**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). Cependant, voici les plus importantes :
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

Les images que vous pouvez ex√©cuter dans Nitro Enclave sont bas√©es sur des images docker, donc vous pouvez cr√©er vos images Nitro Enclave √† partir d'images docker comme :
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Comme vous pouvez le voir, les images Nitro Enclave utilisent l'extension **`eif`** (Fichier d'Image d'Enclave).

La sortie ressemblera √† :
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Ex√©cuter une image

Selon [**la documentation**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), pour ex√©cuter une image d'enclave, vous devez lui attribuer une m√©moire de **au moins 4 fois la taille du fichier `eif`**. Il est possible de configurer les ressources par d√©faut √† lui attribuer dans le fichier.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
N'oubliez jamais que vous devez √©galement **r√©server des ressources pour l'instance EC2 parente** !
{% endhint %}

Apr√®s avoir connu les ressources √† attribuer √† une image et m√™me avoir modifi√© le fichier de configuration, il est possible d'ex√©cuter une image d'enclave avec : 

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### √ânum√©rer les Enclaves

Si vous compromettez un h√¥te EC2, il est possible d'obtenir une liste des images d'enclave en cours d'ex√©cution avec :
```bash
nitro-cli describe-enclaves
```
Il **n'est pas possible d'obtenir un shell** √† l'int√©rieur d'une image d'enclave en cours d'ex√©cution car c'est le principal objectif de l'enclave, cependant, si vous utilisez le param√®tre **`--debug-mode`**, il est possible d'obtenir le **stdout** avec :
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminer les Enclaves

Si un attaquant compromet une instance EC2, par d√©faut, il ne pourra pas obtenir un shell √† l'int√©rieur, mais il pourra **les terminer** avec :
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

Le seul moyen de communiquer avec une **enclave** ex√©cutant une image est d'utiliser **vsocks**.

**Virtual Socket (vsock)** est une famille de sockets dans Linux sp√©cifiquement con√ßue pour faciliter la **communication** entre les machines virtuelles (**VMs**) et leurs **hyperviseurs**, ou entre les VMs **elles-m√™mes**. Vsock permet une **communication** efficace et **bidirectionnelle** sans d√©pendre de la pile r√©seau de l'h√¥te. Cela permet aux VMs de communiquer m√™me sans configurations r√©seau, **en utilisant un ID de contexte de 32 bits (CID) et des num√©ros de port** pour identifier et g√©rer les connexions. L'API vsock prend en charge √† la fois les types de sockets de flux et de datagrammes, similaires √† TCP et UDP, fournissant un outil polyvalent pour les applications de niveau utilisateur dans des environnements virtuels.

{% hint style="success" %}
Par cons√©quent, une adresse vsock ressemble √† ceci : `<CID>:<Port>`
{% endhint %}

Pour trouver les **CIDs** des images d'enclave en cours d'ex√©cution, vous pouvez simplement ex√©cuter la commande suivante et obtenir le **`EnclaveCID`** :

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Notez qu'√† partir de l'h√¥te, il n'y a aucun moyen de savoir si un CID expose un port ! √Ä moins d'utiliser un **scanneur de port vsock comme** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Vsock Server/Listener

Trouvez ici quelques exemples :

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Simple Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Client Vsock

Exemples :

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Client Python Simple</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

L'outil vsock-proxy permet de proxy un proxy vsock avec une autre adresse, par exemple :
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Cela redirigera le **port local 8001 dans vsock** vers `ip-ranges.amazonaws.com:443` et le fichier **`your-vsock-proxy.yaml`** pourrait avoir ce contenu permettant d'acc√©der √† `ip-ranges.amazonaws.com:443` :
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
Il est possible de voir les adresses vsock (**`<CID>:<Port>`**) utilis√©es par l'h√¥te EC2 avec (notez le `3:8001`, 3 est le CID et 8001 le port) :

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Attestation Nitro Enclave & KMS

Le SDK Nitro Enclaves permet √† une enclave de demander un **document d'attestation sign√© cryptographiquement** au **Hyperviseur** Nitro, qui inclut des **mesures uniques** sp√©cifiques √† cette enclave. Ces mesures, qui incluent des **hashs et des registres de configuration de plateforme (PCRs)**, sont utilis√©es lors du processus d'attestation pour **prouver l'identit√© de l'enclave** et **√©tablir la confiance avec des services externes**. Le document d'attestation contient g√©n√©ralement des valeurs comme PCR0, PCR1 et PCR2, que vous avez rencontr√©es auparavant lors de la cr√©ation et de l'enregistrement d'un EIF d'enclave.

D'apr√®s les [**docs**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), voici les valeurs PCR :

<table><thead><tr><th width="97">PCR</th><th width="221">Hash de ...</th><th>Description</th></tr></thead><tbody><tr><td>PCR0</td><td>Fichier image de l'enclave</td><td>Une mesure contigu√´ du contenu du fichier image, sans les donn√©es de section.</td></tr><tr><td>PCR1</td><td>Noyau Linux et bootstrap</td><td>Une mesure contigu√´ des donn√©es du noyau et du ramfs de d√©marrage.</td></tr><tr><td>PCR2</td><td>Application</td><td>Une mesure contigu√´ et ordonn√©e des applications utilisateur, sans le ramfs de d√©marrage.</td></tr><tr><td>PCR3</td><td>R√¥le IAM attribu√© √† l'instance parente</td><td>Une mesure contigu√´ du r√¥le IAM attribu√© √† l'instance parente. Assure que le processus d'attestation r√©ussit uniquement lorsque l'instance parente a le bon r√¥le IAM.</td></tr><tr><td>PCR4</td><td>ID de l'instance de l'instance parente</td><td>Une mesure contigu√´ de l'ID de l'instance parente. Assure que le processus d'attestation r√©ussit uniquement lorsque l'instance parente a un ID d'instance sp√©cifique.</td></tr><tr><td>PCR8</td><td>Certificat de signature du fichier image de l'enclave</td><td>Une mesure du certificat de signature sp√©cifi√© pour le fichier image de l'enclave. Assure que le processus d'attestation r√©ussit uniquement lorsque l'enclave a √©t√© d√©marr√©e √† partir d'un fichier image d'enclave sign√© par un certificat sp√©cifique.</td></tr></tbody></table>

Vous pouvez int√©grer l'**attestation cryptographique** dans vos applications et tirer parti des int√©grations pr√©construites avec des services comme **AWS KMS**. AWS KMS peut **valider les attestations d'enclave** et offre des cl√©s de condition bas√©es sur l'attestation (`kms:RecipientAttestation:ImageSha384` et `kms:RecipientAttestation:PCR`) dans ses politiques de cl√©s. Ces politiques garantissent qu'AWS KMS permet des op√©rations utilisant la cl√© KMS **uniquement si le document d'attestation de l'enclave est valide** et r√©pond aux **conditions sp√©cifi√©es**.

{% hint style="success" %}
Notez que les Enclaves en mode debug (--debug) g√©n√®rent des documents d'attestation avec des PCRs compos√©s de z√©ros (`000000000000000000000000000000000000000000000000`). Par cons√©quent, les politiques KMS v√©rifiant ces valeurs √©choueront.
{% endhint %}

### Contournement PCR

Du point de vue d'un attaquant, notez que certains PCRs permettraient de modifier certaines parties ou l'ensemble de l'image de l'enclave et seraient toujours valides (par exemple, PCR4 v√©rifie uniquement l'ID de l'instance parente, donc ex√©cuter n'importe quelle image d'enclave dans cet EC2 permettra de satisfaire cette exigence potentielle de PCR).

Par cons√©quent, un attaquant qui compromet l'instance EC2 pourrait √™tre en mesure d'ex√©cuter d'autres images d'enclave afin de contourner ces protections.

La recherche sur la fa√ßon de modifier/cr√©er de nouvelles images pour contourner chaque protection (en particulier celles qui ne sont pas si √©videntes) est encore √† faire.

## R√©f√©rences

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Toutes les parties du tutoriel Nitro d'AWS : [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
