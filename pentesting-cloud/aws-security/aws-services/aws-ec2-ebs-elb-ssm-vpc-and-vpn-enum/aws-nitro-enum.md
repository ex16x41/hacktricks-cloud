# AWS - Nitro Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

AWS Nitroã¯ã€AWS EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®åŸºç›¤ã¨ãªã‚‹**é©æ–°çš„ãªæŠ€è¡“**ã®ã‚¹ã‚¤ãƒ¼ãƒˆã§ã™ã€‚Amazonã«ã‚ˆã£ã¦å°å…¥ã•ã‚Œã€**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ãŠã‚ˆã³ä¿¡é ¼æ€§ã‚’å‘ä¸Š**ã•ã›ã‚‹ãŸã‚ã«ã€Nitroã¯ã‚«ã‚¹ã‚¿ãƒ **ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨è»½é‡ãƒã‚¤ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼**ã‚’æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚å¾“æ¥ã®ä»®æƒ³åŒ–æ©Ÿèƒ½ã®å¤šãã‚’å°‚ç”¨ã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã¨ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã«æŠ½è±¡åŒ–ã—ã€**æ”»æ’ƒé¢ã‚’æœ€å°åŒ–**ã—ã€ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚ä»®æƒ³åŒ–æ©Ÿèƒ½ã‚’ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã§ã€Nitroã¯EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒ**ã»ã¼ãƒ™ã‚¢ãƒ¡ã‚¿ãƒ«ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**ã‚’æä¾›ã§ãã‚‹ã‚ˆã†ã«ã—ã€ç‰¹ã«ãƒªã‚½ãƒ¼ã‚¹é›†ç´„å‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æœ‰ç›Šã§ã™ã€‚ã•ã‚‰ã«ã€Nitro Security Chipã¯**ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã¨ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**ã‚’ç¢ºä¿ã—ã€ãã®å …ç‰¢ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ã•ã‚‰ã«å¼·åŒ–ã—ã¾ã™ã€‚

### Nitro Enclaves

**AWS Nitro Enclaves**ã¯ã€Amazon EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã§**é«˜åº¦ã«æ©Ÿå¯†æ€§ã®é«˜ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸ**ã€å®‰å…¨ã§**éš”é›¢ã•ã‚ŒãŸã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆç’°å¢ƒ**ã‚’æä¾›ã—ã¾ã™ã€‚AWS Nitro Systemã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ã“ã‚Œã‚‰ã®ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ã¯å¼·åŠ›ãª**éš”é›¢ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**ã‚’ç¢ºä¿ã—ã€**PIIã‚„è²¡å‹™è¨˜éŒ²ãªã©ã®æ©Ÿå¯†æƒ…å ±**ã‚’æ‰±ã†ã®ã«ç†æƒ³çš„ã§ã™ã€‚ãƒŸãƒ‹ãƒãƒªã‚¹ãƒˆç’°å¢ƒã‚’ç‰¹å¾´ã¨ã—ã€ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã®ãƒªã‚¹ã‚¯ã‚’å¤§å¹…ã«ä½æ¸›ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€Nitro Enclavesã¯æš—å·åŒ–èªè¨¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨±å¯ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®ã¿ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ãŸã‚ã€å³æ ¼ãªã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã¨ãƒ‡ãƒ¼ã‚¿ä¿è­·åŸºæº–ã‚’ç¶­æŒã™ã‚‹ã®ã«é‡è¦ã§ã™ã€‚

{% hint style="danger" %}
Nitro Enclaveã‚¤ãƒ¡ãƒ¼ã‚¸ã¯**EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã‹ã‚‰å®Ÿè¡Œ**ã•ã‚Œã€AWSã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒNitro Enclaveã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
{% endhint %}

## Nitro Enclave CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

[**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)ã®ã™ã¹ã¦ã®æŒ‡ç¤ºã«å¾“ã£ã¦ãã ã•ã„ã€‚ãŸã ã—ã€ä»¥ä¸‹ãŒæœ€ã‚‚é‡è¦ãªã‚‚ã®ã§ã™:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

Nitro Enclaveã§å®Ÿè¡Œã§ãã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«åŸºã¥ã„ã¦ã„ã‚‹ãŸã‚ã€æ¬¡ã®ã‚ˆã†ãªdockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰Nitro Enclaveã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã§ãã¾ã™:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Nitro Enclaveã‚¤ãƒ¡ãƒ¼ã‚¸ã¯**`eif`**ï¼ˆEnclave Image Fileï¼‰æ‹¡å¼µå­ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

å‡ºåŠ›ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Run an Image

[**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)ã«ã‚ˆã‚‹ã¨ã€enclaveã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€**`eif`ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã®å°‘ãªãã¨ã‚‚4å€ã®ãƒ¡ãƒ¢ãƒª**ã‚’å‰²ã‚Šå½“ã¦ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã§è¨­å®šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
å¸¸ã«**è¦ªEC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãŸã‚ã«ã„ãã¤ã‹ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’äºˆç´„ã™ã‚‹**å¿…è¦ãŒã‚ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ï¼
{% endhint %}

ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ä¸ãˆã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’çŸ¥ã‚Šã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ãŸå¾Œã§ã‚‚ã€enclaveã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ï¼š

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enclavesã®åˆ—æŒ™

EC2ãƒ›ã‚¹ãƒˆã‚’ä¾µå®³ã—ãŸå ´åˆã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œä¸­ã®enclaveã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:
```bash
nitro-cli describe-enclaves
```
å®Ÿè¡Œä¸­ã®enclaveã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã§ã‚·ã‚§ãƒ«ã‚’å–å¾—ã™ã‚‹ã“ã¨ã¯**ã§ãã¾ã›ã‚“**ã€‚ã“ã‚Œã¯enclaveã®ä¸»ãªç›®çš„ã ã‹ã‚‰ã§ã™ã€‚ã—ã‹ã—ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**`--debug-mode`**ã‚’ä½¿ç”¨ã—ãŸå ´åˆã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§**stdout**ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminate Enclaves

æ”»æ’ƒè€…ãŒEC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä¾µå®³ã—ãŸå ´åˆã€å†…éƒ¨ã«ã‚·ã‚§ãƒ«ã‚’å–å¾—ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ãŒã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§**terminate**ã™ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

**enclave** å®Ÿè¡Œã‚¤ãƒ¡ãƒ¼ã‚¸ã¨é€šä¿¡ã™ã‚‹å”¯ä¸€ã®æ–¹æ³•ã¯ **vsocks** ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚

**Virtual Socket (vsock)** ã¯ã€ä»®æƒ³ãƒã‚·ãƒ³ (**VMs**) ã¨ãã® **ãƒã‚¤ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼**ã€ã¾ãŸã¯ VMs åŒå£«ã®é–“ã® **é€šä¿¡** ã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã«ç‰¹åˆ¥ã«è¨­è¨ˆã•ã‚ŒãŸ Linux ã®ã‚½ã‚±ãƒƒãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ã§ã™ã€‚Vsock ã¯ãƒ›ã‚¹ãƒˆã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã‚¹ã‚¿ãƒƒã‚¯ã«ä¾å­˜ã›ãšã«åŠ¹ç‡çš„ãª **åŒæ–¹å‘é€šä¿¡** ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šãŒãªãã¦ã‚‚ VMs ãŒé€šä¿¡ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€æ¥ç¶šã‚’è­˜åˆ¥ãŠã‚ˆã³ç®¡ç†ã™ã‚‹ãŸã‚ã« **32ãƒ“ãƒƒãƒˆã® Context ID (CID) ã¨ãƒãƒ¼ãƒˆç•ªå·** ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚Vsock API ã¯ã€TCP ã¨ UDP ã«ä¼¼ãŸã‚¹ãƒˆãƒªãƒ¼ãƒ ãŠã‚ˆã³ãƒ‡ãƒ¼ã‚¿ã‚°ãƒ©ãƒ ã‚½ã‚±ãƒƒãƒˆã‚¿ã‚¤ãƒ—ã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€ä»®æƒ³ç’°å¢ƒã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ™ãƒ«ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦å¤šç”¨é€”ã®ãƒ„ãƒ¼ãƒ«ã‚’æä¾›ã—ã¾ã™ã€‚

{% hint style="success" %}
ã—ãŸãŒã£ã¦ã€vsock ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™: `<CID>:<Port>`
{% endhint %}

å®Ÿè¡Œä¸­ã® **enclave** ã‚¤ãƒ¡ãƒ¼ã‚¸ã® **CIDs** ã‚’è¦‹ã¤ã‘ã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ **`EnclaveCID`** ã‚’å–å¾—ã—ã¾ã™:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
ãƒ›ã‚¹ãƒˆã‹ã‚‰ã¯ã€CID ãŒãƒãƒ¼ãƒˆã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’çŸ¥ã‚‹æ–¹æ³•ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ **vsock port scanner** ã®ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ãªã„é™ã‚Šã€[**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner) ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
{% endhint %}

### Vsock Server/Listener

ã„ãã¤ã‹ã®ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Simple Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Client

ä¾‹:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>ã‚·ãƒ³ãƒ—ãƒ«ãªPythonã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
```markdown
</details>
```
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

vsock-proxyãƒ„ãƒ¼ãƒ«ã¯ã€åˆ¥ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§vsockãƒ—ãƒ­ã‚­ã‚·ã‚’ãƒ—ãƒ­ã‚­ã‚·ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
ã“ã‚Œã¯**vsockã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒˆ8001**ã‚’`ip-ranges.amazonaws.com:443`ã«è»¢é€ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«**`your-vsock-proxy.yaml`**ã«ã¯`ip-ranges.amazonaws.com:443`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ä»¥ä¸‹ã®å†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
EC2ãƒ›ã‚¹ãƒˆã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹vsockã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ**`<CID>:<Port>`**ï¼‰ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ï¼ˆ`3:8001`ã«æ³¨ç›®ã€3ã¯CIDã€8001ã¯ãƒãƒ¼ãƒˆï¼‰ï¼š

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atestation & KMS

Nitro Enclaves SDKã¯ã€ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ãŒNitro **Hypervisor**ã‹ã‚‰**æš—å·ç½²åã•ã‚ŒãŸèªè¨¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**ã‚’è¦æ±‚ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ã€ãã®ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ã«ç‰¹æœ‰ã®**ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ¸¬å®šå€¤**ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®æ¸¬å®šå€¤ã«ã¯ã€**ãƒãƒƒã‚·ãƒ¥ã‚„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ§‹æˆãƒ¬ã‚¸ã‚¹ã‚¿ï¼ˆPCRï¼‰**ãŒå«ã¾ã‚Œã€èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ä¸­ã«**ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è¨¼æ˜**ã—ã€**å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®ä¿¡é ¼ã‚’æ§‹ç¯‰**ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚èªè¨¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯é€šå¸¸ã€PCR0ã€PCR1ã€PCR2ãªã©ã®å€¤ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–EIFã‚’æ§‹ç¯‰ãŠã‚ˆã³ä¿å­˜ã™ã‚‹éš›ã«ã“ã‚Œã‚‰ã®å€¤ã«é­é‡ã—ã¾ã™ã€‚

[**docs**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves)ã‹ã‚‰ã€ã“ã‚Œã‚‰ã¯PCRã®å€¤ã§ã™ï¼š

<table><thead><tr><th width="97">PCR</th><th width="221">ãƒãƒƒã‚·ãƒ¥ã®å¯¾è±¡</th><th>èª¬æ˜</th></tr></thead><tbody><tr><td>PCR0</td><td>ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«</td><td>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’é™¤ã„ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã®é€£ç¶šçš„ãªæ¸¬å®šã€‚</td></tr><tr><td>PCR1</td><td>Linuxã‚«ãƒ¼ãƒãƒ«ã¨ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—</td><td>ã‚«ãƒ¼ãƒãƒ«ã¨ãƒ–ãƒ¼ãƒˆramfsãƒ‡ãƒ¼ã‚¿ã®é€£ç¶šçš„ãªæ¸¬å®šã€‚</td></tr><tr><td>PCR2</td><td>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</td><td>ãƒ–ãƒ¼ãƒˆramfsã‚’é™¤ã„ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é€£ç¶šçš„ã‹ã¤é †åºé€šã‚Šã®æ¸¬å®šã€‚</td></tr><tr><td>PCR3</td><td>è¦ªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸIAMãƒ­ãƒ¼ãƒ«</td><td>è¦ªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸIAMãƒ­ãƒ¼ãƒ«ã®é€£ç¶šçš„ãªæ¸¬å®šã€‚è¦ªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒæ­£ã—ã„IAMãƒ­ãƒ¼ãƒ«ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã«ã®ã¿èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚</td></tr><tr><td>PCR4</td><td>è¦ªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ID</td><td>è¦ªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®IDã®é€£ç¶šçš„ãªæ¸¬å®šã€‚è¦ªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç‰¹å®šã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDã‚’æŒã£ã¦ã„ã‚‹å ´åˆã«ã®ã¿èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚</td></tr><tr><td>PCR8</td><td>ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ç½²åè¨¼æ˜æ›¸</td><td>ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã«æŒ‡å®šã•ã‚ŒãŸç½²åè¨¼æ˜æ›¸ã®æ¸¬å®šã€‚ç‰¹å®šã®è¨¼æ˜æ›¸ã§ç½²åã•ã‚ŒãŸã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ–ãƒ¼ãƒˆã•ã‚ŒãŸå ´åˆã«ã®ã¿èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚</td></tr></tbody></table>

**æš—å·èªè¨¼**ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«çµ±åˆã—ã€**AWS KMS**ãªã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®äº‹å‰æ§‹ç¯‰ã•ã‚ŒãŸçµ±åˆã‚’æ´»ç”¨ã§ãã¾ã™ã€‚AWS KMSã¯**ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–èªè¨¼ã‚’æ¤œè¨¼**ã—ã€ã‚­ãƒ¼ã®ãƒãƒªã‚·ãƒ¼ã«ãŠã„ã¦èªè¨¼ãƒ™ãƒ¼ã‚¹ã®æ¡ä»¶ã‚­ãƒ¼ï¼ˆ`kms:RecipientAttestation:ImageSha384`ãŠã‚ˆã³`kms:RecipientAttestation:PCR`ï¼‰ã‚’æä¾›ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒãƒªã‚·ãƒ¼ã¯ã€ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ã®èªè¨¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæœ‰åŠ¹ã§ã‚ã‚Šã€**æŒ‡å®šã•ã‚ŒãŸæ¡ä»¶ã‚’æº€ãŸã™å ´åˆã«ã®ã¿**ã€AWS KMSãŒKMSã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ãŸæ“ä½œã‚’è¨±å¯ã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

{% hint style="success" %}
ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆ--debugï¼‰ã®ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ã¯ã€PCRãŒã‚¼ãƒ­ï¼ˆ`000000000000000000000000000000000000000000000000`ï¼‰ã§æ§‹æˆã•ã‚ŒãŸèªè¨¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã—ãŸãŒã£ã¦ã€ã“ã‚Œã‚‰ã®å€¤ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹KMSãƒãƒªã‚·ãƒ¼ã¯å¤±æ•—ã—ã¾ã™ã€‚
{% endhint %}

### PCR Bypass

æ”»æ’ƒè€…ã®è¦–ç‚¹ã‹ã‚‰è¦‹ã‚‹ã¨ã€ã„ãã¤ã‹ã®PCRã¯ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¸€éƒ¨ã¾ãŸã¯å…¨ä½“ã‚’å¤‰æ›´ã—ã¦ã‚‚æœ‰åŠ¹ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼ˆä¾‹ãˆã°ã€PCR4ã¯è¦ªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®IDã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã€ãã®EC2ã§ä»»æ„ã®ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã“ã®PCRè¦ä»¶ã‚’æº€ãŸã™ã“ã¨ãŒã§ãã¾ã™ï¼‰ã€‚

ã—ãŸãŒã£ã¦ã€EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¾µå®³ã—ãŸæ”»æ’ƒè€…ã¯ã€ã“ã‚Œã‚‰ã®ä¿è­·ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ä»–ã®ã‚¨ãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ–ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

å„ä¿è­·ã‚’å›é¿ã™ã‚‹ãŸã‚ã®æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å¤‰æ›´/ä½œæˆæ–¹æ³•ã«é–¢ã™ã‚‹ç ”ç©¶ï¼ˆç‰¹ã«æ˜ã‚‰ã‹ã§ãªã„ã‚‚ã®ï¼‰ã¯ã¾ã TODOã§ã™ã€‚

## References

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* AWSã®Nitroãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ã™ã¹ã¦ã®éƒ¨åˆ†ï¼š[https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
AWS Hackingã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€** [**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
