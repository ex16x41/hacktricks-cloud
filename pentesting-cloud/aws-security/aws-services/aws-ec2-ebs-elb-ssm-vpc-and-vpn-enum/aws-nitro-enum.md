# AWS - Nitro Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

AWS Nitro ni seti ya **teknolojia bunifu** ambazo zinaunda jukwaa la msingi kwa ajili ya AWS EC2 instances. Ilianzishwa na Amazon ili **kuimarisha usalama, utendaji, na uaminifu**, Nitro inatumia **vipengele vya vifaa maalum na hypervisor nyepesi**. Inachambua sehemu kubwa ya kazi za kawaida za virtualization kwa vifaa na programu maalum, **ikiweka chini uso wa shambulio** na kuboresha ufanisi wa rasilimali. Kwa kuhamasisha kazi za virtualization, Nitro inaruhusu EC2 instances kutoa **utendaji wa karibu na vifaa halisi**, na kuifanya kuwa na manufaa hasa kwa programu zinazohitaji rasilimali nyingi. Zaidi ya hayo, Chip ya Usalama ya Nitro inahakikisha **usalama wa vifaa na firmware**, ikiongeza nguvu ya usanifu wake.

### Nitro Enclaves

**AWS Nitro Enclaves** inatoa mazingira salama, **ya kutengwa ya kompyuta ndani ya Amazon EC2 instances**, iliyoundwa mahsusi kwa ajili ya kushughulikia data nyeti sana. Kwa kutumia Mfumo wa AWS Nitro, maeneo haya yanahakikisha **kutengwa na usalama** thabiti, bora kwa **kushughulikia taarifa za siri** kama PII au rekodi za kifedha. Yana mazingira ya kimsingi, yanayopunguza hatari ya kufichuliwa kwa data. Zaidi ya hayo, Nitro Enclaves inasaidia uthibitisho wa kificho, ikiruhusu watumiaji kuthibitisha kuwa tu msimbo ulioidhinishwa unafanya kazi, muhimu kwa kudumisha utii mkali na viwango vya ulinzi wa data.

{% hint style="danger" %}
Picha za Nitro Enclave zina **endesha kutoka ndani ya EC2 instances** na huwezi kuona kutoka kwenye konsoli ya wavuti ya AWS ikiwa EC2 instances inafanya kazi picha katika Nitro Enclave au la.
{% endhint %}

## Nitro Enclave CLI installation

Fuata maelekezo yote [**kutoka kwenye nyaraka**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). Hata hivyo, haya ndiyo muhimu zaidi:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

Picha ambazo unaweza kuendesha katika Nitro Enclave zinategemea picha za docker, hivyo unaweza kuunda picha zako za Nitro Enclave kutoka kwa picha za docker kama:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Kama unavyoona, picha za Nitro Enclave zinatumia kiambatisho **`eif`** (Enclave Image File).

Matokeo yataonekana kama:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Run an Image

Kulingana na [**nyaraka**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), ili kuendesha picha ya enclave unahitaji kuipatia kumbukumbu ya **angalau mara 4 ya ukubwa wa faili la `eif`**. Inawezekana kuweka rasilimali za chaguo-msingi za kumpatia katika faili
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Kumbuka daima kwamba unahitaji **kuhifadhi rasilimali fulani kwa ajili ya mfano wa EC2** mzazi pia!
{% endhint %}

Baada ya kujua rasilimali za kutoa kwa picha na hata kuwa na marekebisho ya faili ya usanidi, inawezekana kuendesha picha ya enclave na:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Kuorodhesha Enclaves

Ikiwa unavunja EC2 mwenyeji, inawezekana kupata orodha ya picha za enclave zinazotembea kwa:
```bash
nitro-cli describe-enclaves
```
Ni **haiwezekani kupata shell** ndani ya picha ya enclave inayotembea kwa sababu hiyo ndiyo sababu kuu ya enclave, hata hivyo, ikiwa umetumia parameter **`--debug-mode`**, inawezekana kupata **stdout** yake kwa:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminate Enclaves

Ikiwa mshambuliaji atashambulia EC2 instance, kwa kawaida hatakuwa na uwezo wa kupata shell ndani yao, lakini atakuwa na uwezo wa **terminate them** na:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

Njia pekee ya kuwasiliana na **enclave** inayotumia picha ni kutumia **vsocks**.

**Virtual Socket (vsock)** ni familia ya soketi katika Linux iliyoundwa mahsusi kuwezesha **mawasiliano** kati ya mashine za virtual (**VMs**) na **hypervisors** zao, au kati ya VMs **wenyewe**. Vsock inaruhusu mawasiliano bora, **ya pande mbili** bila kutegemea muundo wa mtandao wa mwenyeji. Hii inafanya iwezekane kwa VMs kuwasiliana hata bila usanidi wa mtandao, **wakitumika 32-bit Context ID (CID) na nambari za bandari** kutambua na kudhibiti muunganisho. API ya vsock inasaidia aina zote za soketi za mtiririko na datagram, sawa na TCP na UDP, ikitoa chombo chenye uwezo kwa programu za kiwango cha mtumiaji katika mazingira ya virtual.

{% hint style="success" %}
Hivyo, anwani ya vsock inaonekana kama hii: `<CID>:<Port>`
{% endhint %}

Ili kupata **CIDs** za enclave inayotumia picha unaweza tu kutekeleza cmd ifuatayo na kupata **`EnclaveCID`**:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Kumbuka kwamba kutoka kwa mwenyeji hakuna njia ya kujua kama CID inafichua bandari yoyote! Isipokuwa kwa kutumia **vsock port scanner kama** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Vsock Server/Listener

Pata hapa mifano kadhaa:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Simple Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Client

Mifano:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Client Rahisi wa Python</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

Chombo vsock-proxy kinaruhusu kuproxy vsock proxy na anwani nyingine, kwa mfano:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Hii itapeleka **bandari ya ndani 8001 katika vsock** kwa `ip-ranges.amazonaws.com:443` na faili **`your-vsock-proxy.yaml`** inaweza kuwa na maudhui haya yanayoruhusu kufikia `ip-ranges.amazonaws.com:443`:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
Inawezekana kuona anwani za vsock (**`<CID>:<Port>`**) zinazotumiwa na mwenyeji wa EC2 kwa kutumia (zingatia `3:8001`, 3 ni CID na 8001 ni bandari):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atestation & KMS

Nitro Enclaves SDK inaruhusu enclave kuomba **nyaraka ya uthibitisho iliyosainiwa kwa cryptographically** kutoka kwa Nitro **Hypervisor**, ambayo inajumuisha **vipimo vya kipekee** vinavyohusiana na enclave hiyo. Vipimo hivi, ambavyo vinajumuisha **hashes na usajili wa usanidi wa jukwaa (PCRs)**, vinatumika wakati wa mchakato wa uthibitisho ili **kuonyesha utambulisho wa enclave** na **kujenga uaminifu na huduma za nje**. Nyaraka ya uthibitisho kwa kawaida ina thamani kama PCR0, PCR1, na PCR2, ambazo umekutana nazo hapo awali unapojenga na kuhifadhi EIF ya enclave.

Kutoka kwenye [**docs**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), hizi ndizo thamani za PCR:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash ya ...</th><th>Maelezo</th></tr></thead><tbody><tr><td>PCR0</td><td>Faili ya picha ya enclave</td><td>Vipimo vya mfuatano vya yaliyomo kwenye faili ya picha, bila data ya sehemu.</td></tr><tr><td>PCR1</td><td>Kernel ya Linux na bootstrap</td><td>Vipimo vya mfuatano vya kernel na data ya boot ramfs.</td></tr><tr><td>PCR2</td><td>Programu</td><td>Vipimo vya mfuatano, kwa mpangilio wa programu za mtumiaji, bila boot ramfs.</td></tr><tr><td>PCR3</td><td>Jukumu la IAM lililotolewa kwa mfano wa mzazi</td><td>Vipimo vya mfuatano vya jukumu la IAM lililotolewa kwa mfano wa mzazi. Inahakikisha kwamba mchakato wa uthibitisho unafanikiwa tu wakati mfano wa mzazi una jukumu sahihi la IAM.</td></tr><tr><td>PCR4</td><td>ID ya mfano wa mzazi</td><td>Vipimo vya mfuatano vya ID ya mfano wa mzazi. Inahakikisha kwamba mchakato wa uthibitisho unafanikiwa tu wakati mfano wa mzazi una ID maalum ya mfano.</td></tr><tr><td>PCR8</td><td>Cheti cha kusaini faili ya picha ya enclave</td><td>Vipimo vya cheti cha kusaini kilichotolewa kwa faili ya picha ya enclave. Inahakikisha kwamba mchakato wa uthibitisho unafanikiwa tu wakati enclave ilizinduliwa kutoka kwa faili ya picha ya enclave iliyosainiwa na cheti maalum.</td></tr></tbody></table>

Unaweza kuunganisha **uthibitisho wa cryptographic** katika programu zako na kutumia uhusiano wa awali na huduma kama **AWS KMS**. AWS KMS inaweza **kuhakiki uthibitisho wa enclave** na inatoa funguo za hali zinazotegemea uthibitisho (`kms:RecipientAttestation:ImageSha384` na `kms:RecipientAttestation:PCR`) katika sera zake za funguo. Sera hizi zinahakikisha kwamba AWS KMS inaruhusu operesheni zinazotumia funguo za KMS **tu ikiwa nyaraka ya uthibitisho ya enclave ni halali** na inakidhi **masharti yaliyotolewa**.

{% hint style="success" %}
Kumbuka kwamba Enclaves katika hali ya debug (--debug) zinaunda nyaraka za uthibitisho zenye PCRs ambazo zimeundwa kwa sifuri (`000000000000000000000000000000000000000000000000`). Kwa hivyo, sera za KMS zinazokagua thamani hizi zitaanguka.
{% endhint %}

### PCR Bypass

Kutoka kwa mtazamo wa washambuliaji, angalia kwamba baadhi ya PCRs zitaruhusu kubadilisha baadhi ya sehemu au picha nzima ya enclave na bado zitakuwa halali (kwa mfano PCR4 inachunguza tu ID ya mfano wa mzazi hivyo kuendesha picha yoyote ya enclave katika EC2 hiyo itaruhusu kutimiza mahitaji haya ya PCR).

Kwa hivyo, mshambuliaji ambaye anashambulia mfano wa EC2 anaweza kuwa na uwezo wa kuendesha picha nyingine za enclave ili kupita ulinzi huu.

Utafiti juu ya jinsi ya kubadilisha/kutengeneza picha mpya ili kupita kila ulinzi (hasa zile zisizo wazi sana) bado ni TODO.

## References

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Sehemu zote za tutorial ya Nitro kutoka AWS: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
