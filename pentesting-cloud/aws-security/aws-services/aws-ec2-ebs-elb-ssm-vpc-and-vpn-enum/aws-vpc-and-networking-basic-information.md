# AWS - VPC & Networking Basic Information

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## AWS Networking in a Nutshell

**VPC** zawiera **network CIDR** jak 10.0.0.0/16 (z **routing table** i **network ACL**).

Ta sie VPC jest podzielona na **subnetworks**, wic **subnetwork** jest bezporednio **powizana** z **VPC**, **routing table** i **network ACL**.

Nastpnie, **Network Interface**s przypisane do usug (jak instancje EC2) s **poczone** z **subnetworks** z **security group(s)**.

Dlatego **security group** ograniczy otwarte porty **network interfaces using it**, **niezale偶nie od subnetwork**. A **network ACL** bdzie **ogranicza** otwarte porty dla **caej sieci**.

Ponadto, aby **uzyska dostp do Internetu**, istniej pewne interesujce konfiguracje do sprawdzenia:

* **Subnetwork** mo偶e **automatycznie przypisywa publiczne adresy IPv4**
* **Instancja** utworzona w sieci, kt贸ra **automatycznie przypisuje adresy IPv4, mo偶e go otrzyma**
* **Internet gateway** musi by **przypisany** do **VPC**
* Mo偶na r贸wnie偶 u偶y **Egress-only internet gateways**
* Mo偶na r贸wnie偶 mie **NAT gateway** w **prywatnym subnecie**, aby **poczy si z zewntrznymi usugami** z tego prywatnego subnetu, ale **nie mo偶na ich osign z zewntrz**.
* NAT gateway mo偶e by **publiczny** (dostp do internetu) lub **prywatny** (dostp do innych VPC)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) umo偶liwia **uruchamianie zasob贸w AWS w wirtualnej sieci**, kt贸r zdefiniowae. Ta wirtualna sie bdzie miaa kilka subnet贸w, Internet Gateways do dostpu do Internetu, ACLs, Security groups, IPs...

### Subnets

Subnets pomagaj w egzekwowaniu wy偶szego poziomu bezpieczestwa. **Logiczne grupowanie podobnych zasob贸w** r贸wnie偶 pomaga w **atwoci zarzdzania** infrastruktur.

* Prawidowe CIDR s od maski sieci /16 do maski sieci /28.
* Subnet nie mo偶e by jednoczenie w r贸偶nych strefach dostpnoci.
* **AWS rezerwuje pierwsze trzy adresy IP hosta** ka偶dego subnetu **do** **wewntrznego u偶ytku AWS**: pierwszy adres hosta jest u偶ywany dla routera VPC. Drugi adres jest zarezerwowany dla AWS DNS, a trzeci adres jest zarezerwowany na przyszo.
* Subnety, kt贸re maj **bezporedni dostp do Internetu, nazywane s publicznymi, podczas gdy prywatne subnety nie maj.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Route Tables

Route tables okrelaj trasowanie ruchu dla subnetu w VPC. Okrelaj, kt贸ry ruch sieciowy jest przekazywany do internetu lub do poczenia VPN. Zazwyczaj znajdziesz dostp do:

* Lokalny VPC
* NAT
* Internet Gateways / Egress-only Internet gateways (potrzebne do zapewnienia VPC dostpu do Internetu).
* Aby uczyni subnet publicznym, musisz **utworzy** i **przypisa** **Internet gateway** do swojego VPC.
* VPC endpoints (do dostpu do S3 z prywatnych sieci)

Na poni偶szych obrazkach mo偶esz sprawdzi r贸偶nice midzy domyln sieci publiczn a prywatn:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Network Access Control Lists (ACLs)**: Network ACLs to reguy zapory, kt贸re kontroluj ruch sieciowy przychodzcy i wychodzcy do subnetu. Mog by u偶ywane do zezwalania lub blokowania ruchu do okrelonych adres贸w IP lub zakres贸w.

* Najczciej zezwala si/odmawia dostpu za pomoc security groups, ale jest to jedyny spos贸b na cakowite przerwanie ustanowionych reverse shells. Zmodyfikowana regua w security groups nie zatrzymuje ju偶 ustanowionych pocze.
* Jednak偶e, to dotyczy caej sieci podsieci, bd藕 ostro偶ny przy zakazywaniu rzeczy, poniewa偶 potrzebna funkcjonalno mo偶e zosta zak贸cona.

### Security Groups

Security groups to wirtualna **zapora**, kt贸ra kontroluje ruch sieciowy przychodzcy i wychodzcy **do instancji** w VPC. Relacja 1 SG do M instancji (zazwyczaj 1 do 1).\
Zazwyczaj u偶ywa si tego do otwierania niebezpiecznych port贸w w instancjach, takich jak port 22 na przykad:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP Addresses

_Elastic IP address_ to **statyczny adres IPv4** zaprojektowany do dynamicznego przetwarzania w chmurze. Elastic IP address jest przypisany do twojego konta AWS i jest tw贸j, dop贸ki go nie zwolnisz. Korzystajc z Elastic IP address, mo偶esz maskowa awari instancji lub oprogramowania, szybko przypisujc adres do innej instancji na swoim koncie.

### Connection between subnets

Domylnie wszystkie subnety maj **automatyczne przypisywanie publicznych adres贸w IP wyczone**, ale mo偶na je wczy.

**Lokalna trasa w tabeli tras umo偶liwia komunikacj midzy subnetami VPC.**

Jeli **czysz subnet z innym subnetem, nie mo偶esz uzyska dostpu do subnet贸w poczonych z innym subnetem**, musisz utworzy poczenie bezporednio z nimi. **To samo dotyczy internet gateways**. Nie mo偶esz przej przez poczenie subnetu, aby uzyska dostp do internetu, musisz przypisa internet gateway do swojego subnetu.

### VPC Peering

VPC peering pozwala na **poczenie dw贸ch lub wicej VPC razem**, u偶ywajc IPV4 lub IPV6, jakby byy czci tej samej sieci.

Gdy poczenie peer jest ustanowione, **zasoby w jednym VPC mog uzyska dostp do zasob贸w w drugim**. Poczenie midzy VPC jest realizowane przez istniejc infrastruktur sieciow AWS, wic jest wysoce dostpne bez wskich garde przepustowoci. Poniewa偶 **poczenia peer dziaaj jakby byy czci tej samej sieci**, istniej ograniczenia dotyczce zakres贸w blok贸w CIDR, kt贸re mog by u偶ywane.\
Jeli masz **nakadajce si lub duplikujce zakresy CIDR** dla swojego VPC, **nie bdziesz m贸g poczy VPC razem**.\
Ka偶dy AWS VPC bdzie **komunikowa si tylko ze swoim peer**. Na przykad, jeli masz poczenie peer midzy VPC 1 a VPC 2, oraz inne poczenie midzy VPC 2 a VPC 3, jak pokazano, wtedy VPC 1 i 2 mog komunikowa si bezporednio, podobnie jak VPC 2 i VPC 3, jednak VPC 1 i VPC 3 nie mog. **Nie mo偶esz routowa przez jedno VPC, aby dosta si do innego.**

### **VPC Flow Logs**

W twoim VPC mo偶esz potencjalnie mie setki lub nawet tysice zasob贸w, kt贸re komunikuj si midzy r贸偶nymi subnetami, zar贸wno publicznymi, jak i prywatnymi, a tak偶e midzy r贸偶nymi VPC przez poczenia VPC peering. **VPC Flow Logs pozwalaj na przechwytywanie informacji o ruchu IP, kt贸ry przepywa midzy interfejsami sieciowymi twoich zasob贸w w VPC**.

W przeciwiestwie do log贸w dostpu S3 i log贸w dostpu CloudFront, **dane log贸w generowane przez VPC Flow Logs nie s przechowywane w S3. Zamiast tego, dane log贸w s wysyane do CloudWatch logs**.

Ograniczenia:

* Jeli masz poczenie VPC peered, bdziesz m贸g zobaczy logi przepywu tylko dla VPC peered, kt贸re s w tym samym koncie.
* Jeli nadal uruchamiasz zasoby w rodowisku EC2-Classic, niestety nie mo偶esz uzyska informacji z ich interfejs贸w.
* Gdy VPC Flow Log zostanie utworzony, nie mo偶na go zmieni. Aby zmieni konfiguracj VPC Flow Log, musisz go usun i utworzy nowy.
* Nastpujcy ruch nie jest monitorowany i przechwytywany przez logi. Ruch DHCP w VPC, ruch z instancji przeznaczony dla serwera DNS Amazon.
* Ka偶dy ruch przeznaczony na adres IP domylnego routera VPC oraz ruch do i z nastpujcych adres贸w, 169.254.169.254, kt贸ry jest u偶ywany do zbierania metadanych instancji, oraz 169.254.169.123, kt贸ry jest u偶ywany do usugi synchronizacji czasu Amazon.
* Ruch zwizany z licencj aktywacyjn Amazon Windows z instancji Windows.
* Ruch midzy interfejsem load balancera sieciowego a interfejsem sieciowym punktu kocowego.

Dla ka偶dego interfejsu sieciowego, kt贸ry publikuje dane do grupy log贸w CloudWatch, bdzie u偶ywany inny strumie log贸w. W ka偶dym z tych strumieni bd dane zdarze log贸w przepywu, kt贸re pokazuj zawarto wpis贸w log贸w. Ka偶dy z tych **log贸w przechwytuje dane w oknie okoo 10 do 15 minut**.

## VPN

### Basic AWS VPN Components

1. **Customer Gateway**:
* Customer Gateway to zas贸b, kt贸ry tworzysz w AWS, aby reprezentowa swoj stron poczenia VPN.
* Jest to zasadniczo fizyczne urzdzenie lub aplikacja programowa po twojej stronie poczenia Site-to-Site VPN.
* Podajesz informacje o routingu i publiczny adres IP swojego urzdzenia sieciowego (takiego jak router lub zapora) do AWS, aby utworzy Customer Gateway.
* Su偶y jako punkt odniesienia do konfiguracji poczenia VPN i nie generuje dodatkowych opat.
2. **Virtual Private Gateway**:
* Virtual Private Gateway (VPG) to koncentrator VPN po stronie Amazon w poczeniu Site-to-Site VPN.
* Jest przypisany do twojego VPC i su偶y jako cel dla twojego poczenia VPN.
* VPG to punkt kocowy poczenia VPN po stronie AWS.
* Obsuguje bezpieczn komunikacj midzy twoim VPC a twoj sieci lokaln.
3. **Site-to-Site VPN Connection**:
* Poczenie Site-to-Site VPN czy twoj sie lokaln z VPC przez bezpieczny tunel VPN IPsec.
* Ten typ poczenia wymaga Customer Gateway i Virtual Private Gateway.
* Jest u偶ywany do bezpiecznej, stabilnej i sp贸jnej komunikacji midzy twoim centrum danych lub sieci a rodowiskiem AWS.
* Zazwyczaj u偶ywany do regularnych, dugoterminowych pocze i jest rozliczany na podstawie iloci danych przesyanych przez poczenie.
4. **Client VPN Endpoint**:
* Client VPN endpoint to zas贸b, kt贸ry tworzysz w AWS, aby umo偶liwi i zarzdza sesjami VPN klienta.
* Jest u偶ywany do umo偶liwienia indywidualnym urzdzeniom (takim jak laptopy, smartfony itp.) bezpiecznego czenia si z zasobami AWS lub twoj sieci lokaln.
* R贸偶ni si od Site-to-Site VPN tym, 偶e jest przeznaczony dla indywidualnych klient贸w, a nie do czenia caych sieci.
* Z Client VPN, ka偶de urzdzenie klienckie u偶ywa oprogramowania klienta VPN, aby nawiza bezpieczne poczenie.

### Site-to-Site VPN

**Pocz swoj sie lokaln z VPC.**

* **VPN connection**: Bezpieczne poczenie midzy twoim sprztem lokalnym a twoimi VPC.
* **VPN tunnel**: Zaszyfrowane poczenie, przez kt贸re dane mog przechodzi z sieci klienta do lub z AWS.

Ka偶de poczenie VPN zawiera dwa tunele VPN, kt贸re mo偶na jednoczenie u偶ywa dla wysokiej dostpnoci.
* **Customer gateway**: Zas贸b AWS, kt贸ry dostarcza informacji do AWS o twoim urzdzeniu bramy klienta.
* **Customer gateway device**: Fizyczne urzdzenie lub aplikacja programowa po twojej stronie poczenia Site-to-Site VPN.
* **Virtual private gateway**: Koncentrator VPN po stronie Amazon w poczeniu Site-to-Site VPN. U偶ywasz virtual private gateway lub transit gateway jako bramy po stronie Amazon w poczeniu Site-to-Site VPN.
* **Transit gateway**: Centrum tranzytowe, kt贸re mo偶e by u偶ywane do czenia twoich VPC i sieci lokalnych. U偶ywasz transit gateway lub virtual private gateway jako bramy po stronie Amazon w poczeniu Site-to-Site VPN.

#### Limitations

* Ruch IPv6 nie jest obsugiwany dla pocze VPN na virtual private gateway.
* Poczenie VPN AWS nie obsuguje Path MTU Discovery.

Ponadto, we藕 pod uwag nastpujce kwestie przy korzystaniu z Site-to-Site VPN.

* Podczas czenia swoich V
