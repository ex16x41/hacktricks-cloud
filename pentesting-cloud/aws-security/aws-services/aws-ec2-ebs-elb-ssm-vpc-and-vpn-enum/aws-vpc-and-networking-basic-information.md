# AWS - VPC & Networking Basic Information

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## AWS Networking u Kratkim Crtama

**VPC** sadrÅ¾i **network CIDR** kao Å¡to je 10.0.0.0/16 (sa svojom **routing tabelom** i **network ACL**).

Ova VPC mreÅ¾a je podeljena na **podmreÅ¾e**, tako da je **podmreÅ¾a** direktno **povezana** sa **VPC**, **routing** **tabelom** i **network ACL**.

Zatim, **Network Interface**-i povezani sa servisima (kao Å¡to su EC2 instance) su **povezani** sa **podmreÅ¾ama** sa **security group(s)**.

Dakle, **security group** Ä‡e ograniÄiti izloÅ¾ene portove mreÅ¾nih **interfejsa koji ga koriste**, **nezavisno od podmreÅ¾e**. A **network ACL** Ä‡e **ograniÄiti** izloÅ¾ene portove za **celu mreÅ¾u**.

Pored toga, da biste **pristupili Internetu**, postoje neke zanimljive konfiguracije koje treba proveriti:

* **PodmreÅ¾a** moÅ¾e **automatski dodeliti javne IPv4 adrese**
* **Instanca** kreirana u mreÅ¾i koja **automatski dodeljuje IPv4 adrese moÅ¾e dobiti jednu**
* **Internet gateway** mora biti **povezan** sa **VPC**
* TakoÄ‘e moÅ¾ete koristiti **Egress-only internet gateways**
* TakoÄ‘e moÅ¾ete imati **NAT gateway** u **privatnoj podmreÅ¾i** tako da je moguÄ‡e **povezati se sa spoljnim servisima** iz te privatne podmreÅ¾e, ali **nije moguÄ‡e doÄ‡i do njih spolja**.
* NAT gateway moÅ¾e biti **javni** (pristup internetu) ili **privatni** (pristup drugim VPC-ovima)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) omoguÄ‡ava vam da **pokrenete AWS resurse u virtuelnoj mreÅ¾i** koju ste definisali. Ova virtuelna mreÅ¾a Ä‡e imati nekoliko podmreÅ¾a, Internet Gateway-e za pristup Internetu, ACL-ove, Security grupe, IP adrese...

### PodmreÅ¾e

PodmreÅ¾e pomaÅ¾u u sprovoÄ‘enju viÅ¡eg nivoa sigurnosti. **LogiÄko grupisanje sliÄnih resursa** takoÄ‘e vam pomaÅ¾e da odrÅ¾avate **lakÅ¡e upravljanje** vaÅ¡om infrastrukturom.

* Validni CIDR su od /16 netmask do /28 netmask.
* PodmreÅ¾a ne moÅ¾e biti u razliÄitim zonama dostupnosti u isto vreme.
* **AWS rezerviÅ¡e prve tri IP adrese hosta** svake podmreÅ¾e **za** **internu AWS upotrebu**: prva adresa hosta se koristi za VPC ruter. Druga adresa je rezervisana za AWS DNS, a treÄ‡a adresa je rezervisana za buduÄ‡u upotrebu.
* Nazivaju se **javne podmreÅ¾e** one koje imaju **direktan pristup Internetu, dok privatne podmreÅ¾e nemaju.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Route Tables

Route tables odreÄ‘uju rutiranje saobraÄ‡aja za podmreÅ¾u unutar VPC-a. One odreÄ‘uju koji mreÅ¾ni saobraÄ‡aj se prosleÄ‘uje na internet ili na VPN vezu. ObiÄno Ä‡ete naÄ‡i pristup:

* Lokalni VPC
* NAT
* Internet Gateway-e / Egress-only Internet gateway-e (potrebni za davanje VPC-u pristupa Internetu).
* Da biste uÄinili podmreÅ¾u javnom, potrebno je **kreirati** i **povezati** **Internet gateway** sa vaÅ¡im VPC-om.
* VPC endpoints (za pristup S3 iz privatnih mreÅ¾a)

Na sledeÄ‡im slikama moÅ¾ete proveriti razlike u podrazumevanoj javnoj mreÅ¾i i privatnoj:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Network Access Control Lists (ACLs)**: Network ACLs su firewall pravila koja kontroliÅ¡u dolazni i odlazni mreÅ¾ni saobraÄ‡aj ka podmreÅ¾i. Mogu se koristiti za dozvolu ili zabranu saobraÄ‡aja ka specifiÄnim IP adresama ili opsezima.

* NajÄeÅ¡Ä‡e se koristi za dozvolu/zabranu pristupa koristeÄ‡i security groups, ali ovo je jedini naÄin da se potpuno prekinu uspostavljene reverse shells. Izmenjeno pravilo u security groups ne zaustavlja veÄ‡ uspostavljene veze.
* MeÄ‘utim, ovo se primenjuje na celu podmreÅ¾u, budite paÅ¾ljivi kada zabranjujete stvari jer potrebna funkcionalnost moÅ¾e biti poremeÄ‡ena.

### Security Groups

Security groups su virtuelni **firewall** koji kontroliÅ¡e dolazni i odlazni mreÅ¾ni **saobraÄ‡aj ka instancama** u VPC-u. Odnos 1 SG prema M instancama (obiÄno 1 prema 1).\
ObiÄno se koristi za otvaranje opasnih portova na instancama, kao Å¡to je port 22 na primer:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP Addresses

_Elastic IP address_ je **staticka IPv4 adresa** dizajnirana za dinamiÄko cloud raÄunarstvo. Elastic IP adresa je dodeljena vaÅ¡em AWS nalogu i vaÅ¡a je dok je ne oslobodite. KoriÅ¡Ä‡enjem Elastic IP adrese, moÅ¾ete maskirati kvar instance ili softvera brzim premapiranjem adrese na drugu instancu u vaÅ¡em nalogu.

### Povezivanje izmeÄ‘u podmreÅ¾a

Podrazumevano, sve podmreÅ¾e imaju **automatsko dodeljivanje javnih IP adresa iskljuÄeno**, ali se moÅ¾e ukljuÄiti.

**Lokalna ruta unutar route tabele omoguÄ‡ava komunikaciju izmeÄ‘u VPC podmreÅ¾a.**

Ako **povezujete podmreÅ¾u sa drugom podmreÅ¾om, ne moÅ¾ete pristupiti podmreÅ¾ama povezanim** sa drugom podmreÅ¾om, morate kreirati vezu sa njima direktno. **Ovo se takoÄ‘e odnosi na internet gateway-e.** Ne moÅ¾ete proÄ‡i kroz vezu podmreÅ¾e da biste pristupili internetu, morate dodeliti internet gateway vaÅ¡oj podmreÅ¾i.

### VPC Peering

VPC peering vam omoguÄ‡ava da **poveÅ¾ete dva ili viÅ¡e VPC-a zajedno**, koristeÄ‡i IPV4 ili IPV6, kao da su deo iste mreÅ¾e.

Kada se uspostavi peer konektivnost, **resursi u jednom VPC-u mogu pristupiti resursima u drugom**. Konektivnost izmeÄ‘u VPC-ova se implementira kroz postojeÄ‡u AWS mreÅ¾nu infrastrukturu, tako da je visoko dostupna bez uskih grla u propusnom opsegu. Kako **peered konekcije funkcioniÅ¡u kao da su deo iste mreÅ¾e**, postoje ograniÄenja kada je reÄ o opsezima CIDR blokova koji se mogu koristiti.\
Ako imate **preklapajuÄ‡e ili duplirane CIDR** opsege za vaÅ¡ VPC, tada **neÄ‡ete moÄ‡i da peer-ujete VPC-ove** zajedno.\
Svaki AWS VPC Ä‡e **komunicirati samo sa svojim peer-om**. Na primer, ako imate peering konekciju izmeÄ‘u VPC 1 i VPC 2, i drugu konekciju izmeÄ‘u VPC 2 i VPC 3 kao Å¡to je prikazano, tada VPC 1 i 2 mogu direktno komunicirati jedan sa drugim, kao i VPC 2 i VPC 3, meÄ‘utim, VPC 1 i VPC 3 ne mogu. **Ne moÅ¾ete rutirati kroz jedan VPC da biste doÅ¡li do drugog.**

### **VPC Flow Logs**

Unutar vaÅ¡eg VPC-a, potencijalno moÅ¾ete imati stotine ili Äak hiljade resursa koji svi komuniciraju izmeÄ‘u razliÄitih podmreÅ¾a, kako javnih tako i privatnih, kao i izmeÄ‘u razliÄitih VPC-ova kroz VPC peering konekcije. **VPC Flow Logs vam omoguÄ‡avaju da zabeleÅ¾ite IP saobraÄ‡aj koji prolazi izmeÄ‘u vaÅ¡ih mreÅ¾nih interfejsa resursa unutar vaÅ¡eg VPC-a**.

Za razliku od S3 access logs i CloudFront access logs, **log podaci generisani od strane VPC Flow Logs nisu skladiÅ¡teni u S3. Umesto toga, log podaci se Å¡alju u CloudWatch logs**.

OgraniÄenja:

* Ako imate VPC peered konekciju, moÄ‡i Ä‡ete da vidite flow logs samo za peered VPC-ove koji su unutar istog naloga.
* Ako joÅ¡ uvek koristite resurse unutar EC2-Classic okruÅ¾enja, naÅ¾alost ne moÅ¾ete dobiti informacije sa njihovih interfejsa.
* Kada se kreira VPC Flow Log, ne moÅ¾e se menjati. Da biste promenili konfiguraciju VPC Flow Log-a, morate ga obrisati i zatim kreirati novi.
* SledeÄ‡i saobraÄ‡aj nije nadgledan i zabeleÅ¾en u logovima. DHCP saobraÄ‡aj unutar VPC-a, saobraÄ‡aj sa instanci namenjen Amazon DNS serveru.
* Bilo koji saobraÄ‡aj namenjen IP adresi za VPC podrazumevani ruter i saobraÄ‡aj ka i od sledeÄ‡ih adresa, 169.254.169.254 koja se koristi za prikupljanje instance metadata, i 169.254.169.123 koja se koristi za Amazon Time Sync Service.
* SaobraÄ‡aj vezan za Amazon Windows aktivacionu licencu sa Windows instance.
* SaobraÄ‡aj izmeÄ‘u network load balancer interfejsa i endpoint network interfejsa.

Za svaki mreÅ¾ni interfejs koji objavljuje podatke u CloudWatch log grupu, koristiÄ‡e se razliÄit log stream. I unutar svakog od ovih stream-ova, biÄ‡e flow log event podaci koji prikazuju sadrÅ¾aj log unosa. Svaki od ovih **logova beleÅ¾i podatke tokom prozora od pribliÅ¾no 10 do 15 minuta**.

## VPN

### Osnovne AWS VPN Komponente

1. **Customer Gateway**:
* Customer Gateway je resurs koji kreirate u AWS-u da predstavlja vaÅ¡u stranu VPN konekcije.
* To je u suÅ¡tini fiziÄki ureÄ‘aj ili softverska aplikacija na vaÅ¡oj strani Site-to-Site VPN konekcije.
* PruÅ¾ate informacije o rutiranju i javnu IP adresu vaÅ¡eg mreÅ¾nog ureÄ‘aja (kao Å¡to je ruter ili firewall) AWS-u da biste kreirali Customer Gateway.
* SluÅ¾i kao referentna taÄka za postavljanje VPN konekcije i ne izaziva dodatne troÅ¡kove.
2. **Virtual Private Gateway**:
* Virtual Private Gateway (VPG) je VPN koncentrator na Amazon strani Site-to-Site VPN konekcije.
* Povezan je sa vaÅ¡im VPC-om i sluÅ¾i kao cilj za vaÅ¡u VPN konekciju.
* VPG je AWS strana krajnja taÄka za VPN konekciju.
* Rukuje sigurnom komunikacijom izmeÄ‘u vaÅ¡eg VPC-a i vaÅ¡e on-premises mreÅ¾e.
3. **Site-to-Site VPN Connection**:
* Site-to-Site VPN konekcija povezuje vaÅ¡u on-premises mreÅ¾u sa VPC-om kroz siguran, IPsec VPN tunel.
* Ova vrsta konekcije zahteva Customer Gateway i Virtual Private Gateway.
* Koristi se za sigurnu, stabilnu i konzistentnu komunikaciju izmeÄ‘u vaÅ¡eg data centra ili mreÅ¾e i vaÅ¡eg AWS okruÅ¾enja.
* ObiÄno se koristi za redovne, dugoroÄne konekcije i naplaÄ‡uje se na osnovu koliÄine podataka prenetih preko konekcije.
4. **Client VPN Endpoint**:
* Client VPN endpoint je resurs koji kreirate u AWS-u da omoguÄ‡ite i upravljate client VPN sesijama.
* Koristi se za omoguÄ‡avanje pojedinaÄnim ureÄ‘ajima (kao Å¡to su laptopovi, pametni telefoni, itd.) da se sigurno poveÅ¾u sa AWS resursima ili vaÅ¡om on-premises mreÅ¾om.
* Razlikuje se od Site-to-Site VPN po tome Å¡to je dizajniran za pojedinaÄne klijente, a ne za povezivanje celih mreÅ¾a.
* Sa Client VPN, svaki klijentski ureÄ‘aj koristi VPN klijentski softver da uspostavi sigurnu vezu.

### Site-to-Site VPN

**PoveÅ¾ite vaÅ¡u on-premises mreÅ¾u sa vaÅ¡im VPC-om.**

* **VPN konekcija**: Sigurna veza izmeÄ‘u vaÅ¡e on-premises opreme i vaÅ¡ih VPC-ova.
* **VPN tunel**: Enkriptovana veza kroz koju podaci mogu prolaziti iz mreÅ¾e korisnika ka ili od AWS-a.

Svaka VPN konekcija ukljuÄuje dva VPN tunela koja moÅ¾ete istovremeno koristiti za visoku dostupnost.
* **Customer gateway**: AWS resurs koji pruÅ¾a informacije AWS-u o vaÅ¡em customer gateway ureÄ‘aju.
* **Customer gateway ureÄ‘aj**: FiziÄki ureÄ‘aj ili softverska aplikacija na vaÅ¡oj strani Site-to-Site VPN konekcije.
* **Virtual private gateway**: VPN koncentrator na Amazon strani Site-to-Site VPN konekcije. Koristite virtual private gateway ili transit gateway kao gateway za Amazon stranu Site-to-Site VPN konekcije.
* **Transit gateway**: Transit hub koji se moÅ¾e koristiti za meÄ‘usobno povezivanje vaÅ¡ih VPC-ova i on-premises mreÅ¾a. Koristite transit gateway ili virtual private gateway kao gateway za Amazon stranu Site-to-Site VPN konekcije.

#### OgraniÄenja

* IPv6 saobraÄ‡aj nije podrÅ¾an za VPN konekcije na virtual private gateway-u.
* AWS VPN konekcija ne podrÅ¾ava
