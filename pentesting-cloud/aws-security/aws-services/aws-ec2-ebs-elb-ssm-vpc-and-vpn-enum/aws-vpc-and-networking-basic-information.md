# AWS - VPC & Networking Basic Information

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## AWS Networking in a Nutshell

Uma **VPC** cont√©m um **CIDR de rede** como 10.0.0.0/16 (com sua **tabela de roteamento** e **ACL de rede**).

Essa rede VPC √© dividida em **subredes**, ent√£o uma **subrede** est√° diretamente **relacionada** com a **VPC**, **tabela de roteamento** e **ACL de rede**.

Ent√£o, as **Interfaces de Rede** anexadas a servi√ßos (como inst√¢ncias EC2) est√£o **conectadas** √†s **subredes** com **grupo(s) de seguran√ßa**.

Portanto, um **grupo de seguran√ßa** limitar√° as portas expostas das **interfaces de rede que o utilizam**, **independentemente da subrede**. E uma **ACL de rede** **limitar√°** as portas expostas para a **rede inteira**.

Al√©m disso, para **acessar a Internet**, h√° algumas configura√ß√µes interessantes a serem verificadas:

* Uma **subrede** pode **atribuir automaticamente endere√ßos IPv4 p√∫blicos**
* Uma **inst√¢ncia** criada na rede que **atribui automaticamente endere√ßos IPv4 pode obter um**
* Um **gateway da Internet** precisa ser **anexado** √† **VPC**
* Voc√™ tamb√©m pode usar **gateways de internet apenas de sa√≠da**
* Voc√™ tamb√©m pode ter um **gateway NAT** em uma **subrede privada** para que seja poss√≠vel **conectar a servi√ßos externos** dessa subrede privada, mas **n√£o √© poss√≠vel alcan√ß√°-los do exterior**.
* O gateway NAT pode ser **p√∫blico** (acesso √† internet) ou **privado** (acesso a outras VPCs)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

A **Nuvem Privada Virtual** da Amazon (Amazon VPC) permite que voc√™ **inicie recursos da AWS em uma rede virtual** que voc√™ definiu. Essa rede virtual ter√° v√°rias subredes, Gateways de Internet para acessar a Internet, ACLs, Grupos de seguran√ßa, IPs...

### Subnets

As subredes ajudam a impor um maior n√≠vel de seguran√ßa. **Agrupamento l√≥gico de recursos semelhantes** tamb√©m ajuda voc√™ a manter uma **facilidade de gerenciamento** em sua infraestrutura.

* CIDR v√°lidos v√£o de uma m√°scara de rede /16 a uma m√°scara de rede /28.
* Uma subrede n√£o pode estar em diferentes zonas de disponibilidade ao mesmo tempo.
* **A AWS reserva os tr√™s primeiros endere√ßos IP de host** de cada subrede **para** **uso interno da AWS**: o primeiro endere√ßo de host usado √© para o roteador da VPC. O segundo endere√ßo √© reservado para o DNS da AWS e o terceiro endere√ßo √© reservado para uso futuro.
* Chamamos de **subredes p√∫blicas** aquelas que t√™m **acesso direto √† Internet, enquanto subredes privadas n√£o t√™m.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Route Tables

As tabelas de roteamento determinam o roteamento de tr√°fego para uma subrede dentro de uma VPC. Elas determinam qual tr√°fego de rede √© encaminhado para a internet ou para uma conex√£o VPN. Voc√™ geralmente encontrar√° acesso ao:

* VPC local
* NAT
* Gateways da Internet / gateways de internet apenas de sa√≠da (necess√°rios para dar acesso √† VPC √† Internet).
* Para tornar uma subrede p√∫blica, voc√™ precisa **criar** e **anexar** um **gateway da Internet** √† sua VPC.
* Pontos de extremidade da VPC (para acessar o S3 de redes privadas)

Nas imagens a seguir, voc√™ pode verificar as diferen√ßas entre uma rede p√∫blica padr√£o e uma privada:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Listas de Controle de Acesso √† Rede (ACLs)**: As ACLs de rede s√£o regras de firewall que controlam o tr√°fego de rede de entrada e sa√≠da para uma subrede. Elas podem ser usadas para permitir ou negar tr√°fego para endere√ßos IP ou intervalos espec√≠ficos.

* √â mais frequente permitir/neg√°-lo usando grupos de seguran√ßa, mas esta √© a √∫nica maneira de cortar completamente shells reversos estabelecidos. Uma regra modificada em um grupo de seguran√ßa n√£o interrompe conex√µes j√° estabelecidas.
* No entanto, isso se aplica a toda a subrede, tenha cuidado ao proibir coisas, pois funcionalidades necess√°rias podem ser perturbadas.

### Security Groups

Os grupos de seguran√ßa s√£o um **firewall** virtual que controla o tr√°fego de rede de entrada e sa√≠da para **inst√¢ncias** em uma VPC. Rela√ß√£o 1 SG para M inst√¢ncias (geralmente 1 para 1).\
Normalmente, isso √© usado para abrir portas perigosas em inst√¢ncias, como a porta 22, por exemplo:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP Addresses

Um _Endere√ßo IP El√°stico_ √© um **endere√ßo IPv4 est√°tico** projetado para computa√ß√£o em nuvem din√¢mica. Um Endere√ßo IP El√°stico √© alocado √† sua conta AWS e √© seu at√© que voc√™ o libere. Ao usar um Endere√ßo IP El√°stico, voc√™ pode mascarar a falha de uma inst√¢ncia ou software remapeando rapidamente o endere√ßo para outra inst√¢ncia em sua conta.

### Connection between subnets

Por padr√£o, todas as subredes t√™m a **atribui√ß√£o autom√°tica de endere√ßos IP p√∫blicos desativada**, mas isso pode ser ativado.

**Uma rota local dentro de uma tabela de roteamento permite a comunica√ß√£o entre subredes VPC.**

Se voc√™ est√° **conectando uma subrede com uma subrede diferente, n√£o pode acessar as subredes conectadas** com a outra subrede, voc√™ precisa criar uma conex√£o com elas diretamente. **Isso tamb√©m se aplica a gateways da internet**. Voc√™ n√£o pode passar por uma conex√£o de subrede para acessar a internet, voc√™ precisa atribuir o gateway da internet √† sua subrede.

### VPC Peering

O peering de VPC permite que voc√™ **conecte duas ou mais VPCs juntas**, usando IPV4 ou IPV6, como se fossem parte da mesma rede.

Uma vez que a conectividade de peering √© estabelecida, **recursos em uma VPC podem acessar recursos na outra**. A conectividade entre as VPCs √© implementada atrav√©s da infraestrutura de rede existente da AWS, e assim √© altamente dispon√≠vel sem gargalos de largura de banda. Como **as conex√µes de peering operam como se fossem parte da mesma rede**, h√° restri√ß√µes quando se trata de seus intervalos de bloco CIDR que podem ser usados.\
Se voc√™ tiver **intervalos CIDR sobrepostos ou duplicados** para sua VPC, ent√£o **voc√™ n√£o poder√° fazer peering das VPCs** juntas.\
Cada VPC da AWS **se comunicar√° apenas com seu par**. Como exemplo, se voc√™ tiver uma conex√£o de peering entre a VPC 1 e a VPC 2, e outra conex√£o entre a VPC 2 e a VPC 3, como mostrado, ent√£o a VPC 1 e a VPC 2 poderiam se comunicar diretamente, assim como a VPC 2 e a VPC 3, no entanto, a VPC 1 e a VPC 3 n√£o poderiam. **Voc√™ n√£o pode rotear atrav√©s de uma VPC para chegar a outra.**

### **VPC Flow Logs**

Dentro da sua VPC, voc√™ pode ter potencialmente centenas ou at√© milhares de recursos se comunicando entre diferentes subredes, tanto p√∫blicas quanto privadas, e tamb√©m entre diferentes VPCs atrav√©s de conex√µes de peering de VPC. **Os VPC Flow Logs permitem que voc√™ capture informa√ß√µes de tr√°fego IP que fluem entre as interfaces de rede de seus recursos dentro da sua VPC**.

Ao contr√°rio dos logs de acesso do S3 e dos logs de acesso do CloudFront, os **dados de log gerados pelos VPC Flow Logs n√£o s√£o armazenados no S3. Em vez disso, os dados de log capturados s√£o enviados para os logs do CloudWatch**.

Limita√ß√µes:

* Se voc√™ estiver executando uma conex√£o de peering de VPC, ent√£o voc√™ s√≥ poder√° ver logs de fluxo de VPCs pareadas que est√£o dentro da mesma conta.
* Se voc√™ ainda estiver executando recursos dentro do ambiente EC2-Classic, ent√£o, infelizmente, voc√™ n√£o poder√° recuperar informa√ß√µes de suas interfaces.
* Uma vez que um VPC Flow Log foi criado, ele n√£o pode ser alterado. Para alterar a configura√ß√£o do VPC Flow Log, voc√™ precisa exclu√≠-lo e, em seguida, recriar um novo.
* O tr√°fego a seguir n√£o √© monitorado e capturado pelos logs. Tr√°fego DHCP dentro da VPC, tr√°fego de inst√¢ncias destinado ao Servidor DNS da Amazon.
* Qualquer tr√°fego destinado ao endere√ßo IP do roteador padr√£o da VPC e tr√°fego de e para os seguintes endere√ßos, 169.254.169.254, que √© usado para coletar metadados da inst√¢ncia, e 169.254.169.123, que √© usado para o Servi√ßo de Sincroniza√ß√£o de Tempo da Amazon.
* Tr√°fego relacionado a uma licen√ßa de ativa√ß√£o do Windows da Amazon de uma inst√¢ncia Windows.
* Tr√°fego entre uma interface de balanceador de carga de rede e uma interface de rede de ponto de extremidade.

Para cada interface de rede que publica dados no grupo de logs do CloudWatch, ser√° usado um fluxo de log diferente. E dentro de cada um desses fluxos, haver√° os dados de eventos de log de fluxo que mostram o conte√∫do das entradas de log. Cada um desses **logs captura dados durante uma janela de aproximadamente 10 a 15 minutos**.

## VPN

### Basic AWS VPN Components

1. **Gateway do Cliente**:
* Um Gateway do Cliente √© um recurso que voc√™ cria na AWS para representar seu lado de uma conex√£o VPN.
* √â essencialmente um dispositivo f√≠sico ou aplicativo de software do seu lado da conex√£o VPN Site-a-Site.
* Voc√™ fornece informa√ß√µes de roteamento e o endere√ßo IP p√∫blico do seu dispositivo de rede (como um roteador ou um firewall) para a AWS para criar um Gateway do Cliente.
* Ele serve como um ponto de refer√™ncia para configurar a conex√£o VPN e n√£o gera cobran√ßas adicionais.
2. **Gateway Privado Virtual**:
* Um Gateway Privado Virtual (VPG) √© o concentrador VPN do lado da Amazon da conex√£o VPN Site-a-Site.
* Ele est√° anexado √† sua VPC e serve como o alvo para sua conex√£o VPN.
* O VPG √© o ponto de extremidade do lado da AWS para a conex√£o VPN.
* Ele gerencia a comunica√ß√£o segura entre sua VPC e sua rede local.
3. **Conex√£o VPN Site-a-Site**:
* Uma conex√£o VPN Site-a-Site conecta sua rede local a uma VPC atrav√©s de um t√∫nel VPN IPsec seguro.
* Esse tipo de conex√£o requer um Gateway do Cliente e um Gateway Privado Virtual.
* √â usado para comunica√ß√£o segura, est√°vel e consistente entre seu data center ou rede e seu ambiente AWS.
* Normalmente usado para conex√µes regulares e de longo prazo e √© cobrado com base na quantidade de dados transferidos pela conex√£o.
4. **Ponto de Extremidade VPN do Cliente**:
* Um ponto de extremidade VPN do Cliente √© um recurso que voc√™ cria na AWS para habilitar e gerenciar sess√µes VPN do cliente.
* √â usado para permitir que dispositivos individuais (como laptops, smartphones, etc.) se conectem de forma segura aos recursos da AWS ou √† sua rede local.
* Ele difere da VPN Site-a-Site na medida em que √© projetado para clientes individuais, em vez de conectar redes inteiras.
* Com a VPN do Cliente, cada dispositivo cliente usa um software cliente VPN para estabelecer uma conex√£o segura.

### Site-a-Site VPN

**Conecte sua rede local com sua VPC.**

* **Conex√£o VPN**: Uma conex√£o segura entre seu equipamento local e suas VPCs.
* **T√∫nel VPN**: Um link criptografado onde os dados podem passar da rede do cliente para ou da AWS.

Cada conex√£o VPN inclui dois t√∫neis VPN que voc√™ pode usar simultaneamente para alta disponibilidade.
* **Gateway do cliente**: Um recurso da AWS que fornece informa√ß√µes √† AWS sobre seu dispositivo de gateway do cliente.
* **Dispositivo de gateway do cliente**: Um dispositivo f√≠sico ou aplicativo de software do seu lado da conex√£o VPN Site-a-Site.
* **Gateway privado virtual**: O concentrador VPN do lado da Amazon da conex√£o VPN Site-a-Site. Voc√™ usa um gateway privado virtual ou um gateway de tr√¢nsito como o gateway do lado da Amazon da conex√£o VPN Site-a-Site.
* **Gateway de tr√¢nsito**: Um hub de tr√¢nsito que pode ser usado para interconectar suas VPCs e redes locais. Voc√™ usa um gateway de tr√¢nsito ou um gateway privado virtual como o gateway do lado da Amazon da conex√£o VPN Site-a-Site.

#### Limita√ß√µes

* O tr√°fego IPv6 n√£o √© suportado para conex√µes VPN em um gateway privado virtual.
* Uma conex√£o VPN da AWS n√£o suporta a Descoberta de MTU de Caminho.

Al√©m disso, leve o seguinte em considera√ß√£o ao usar a VPN Site-a-Site.

* Ao conectar suas VPCs a uma rede local comum, recomendamos que voc√™ use blocos CIDR n√£o sobrepostos para suas redes.

### Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Conecte-se do seu computador √† sua VPC**

#### Conceitos

* **Ponto de extremidade VPN do cliente:** O recurso que voc√™ cria e configura para habilitar e gerenciar sess√µes VPN do cliente. √â o recurso onde todas as sess√µes VPN do cliente s√£o encerradas.
* **Rede alvo:** Uma rede alvo √© a rede que voc√™ associa a um ponto de extremidade VPN do cliente. **Uma subrede de uma VPC √© uma rede alvo**. Associar uma subrede a um ponto de extremidade VPN do cliente permite que voc√™ estabele√ßa sess√µes VPN. Voc√™ pode associar v√°rias subredes a um ponto de extremidade VPN do cliente para alta disponibilidade. Todas as subredes devem ser da mesma VPC. Cada subrede deve pertencer a uma Zona de Disponibilidade diferente.
* **Rota**: Cada ponto de extremidade VPN do cliente tem uma tabela de rotas que descreve as rotas de rede de destino dispon√≠veis. Cada rota na tabela de rotas especifica o caminho para o tr√°fego para recursos ou redes espec√≠ficas.
* **Regras de autoriza√ß√£o:** Uma regra de autoriza√ß√£o **restringe os usu√°rios que podem acessar uma rede**. Para uma rede especificada, voc√™ configura o Active Directory ou o grupo do provedor de identidade (IdP) que tem permiss√£o de acesso. Apenas usu√°rios pertencentes a esse grupo podem acessar a rede especificada. **Por padr√£o, n√£o h√° regras de autoriza√ß√£o** e voc√™ deve configurar regras de autoriza√ß√£o para permitir que os usu√°rios acessem recursos e redes.
* **Cliente:** O usu√°rio final que se conecta ao ponto de extremidade VPN do cliente para estabelecer uma sess√£o VPN. Os usu√°rios finais precisam baixar um cliente OpenVPN e usar o arquivo de configura√ß√£o do ponto de extremidade VPN do cliente que voc√™ criou para estabelecer uma sess√£o VPN.
* **Intervalo CIDR do cliente:** Um intervalo de endere√ßos IP do qual atribuir endere√ßos IP de cliente. Cada conex√£o ao ponto de extremidade VPN do cliente recebe um endere√ßo IP exclusivo do intervalo CIDR do cliente. Voc√™ escolhe o intervalo CIDR do cliente, por exemplo, `10.2.0.0/16`.
* **Portas VPN do cliente:** O AWS Client VPN suporta as portas 443 e 1194 para TCP e UDP. O padr√£o √© a porta 443.
* **Interfaces de rede VPN do cliente:** Quando voc√™ associa uma subrede ao seu ponto de extremidade VPN do cliente, criamos interfaces de rede VPN do cliente nessa subrede. **O tr√°fego enviado para a VPC a partir do ponto de extremidade VPN do cliente √© enviado atrav√©s de uma interface de rede VPN do cliente**. A tradu√ß√£o de endere√ßo de rede de origem (SNAT) √© ent√£o aplicada, onde o endere√ßo IP de origem do intervalo CIDR do cliente √© traduzido para o endere√ßo IP da interface de rede VPN do cliente.
* **Registro de conex√µes:** Voc√™ pode habilitar o registro de conex√µes para seu ponto de extremidade VPN do cliente para registrar eventos de conex√£o. Voc√™ pode usar essas informa√ß√µes para realizar investiga√ß√µes, analisar como seu ponto de extremidade VPN do cliente est√° sendo usado ou depurar problemas de conex√£o.
* **Portal de autoatendimento:** Voc√™ pode habilitar um portal de autoatendimento para seu ponto de extremidade VPN do cliente. Os clientes podem fazer login no portal baseado na web usando suas credenciais e baixar a vers√£o mais recente do arquivo de configura√ß√£o do ponto de extremidade VPN do cliente, ou a vers√£o mais recente do cliente fornecido pela AWS.

#### Limita√ß√µes

* **Os intervalos CIDR do cliente n√£o podem se sobrepor ao CIDR local** da VPC na qual a subrede associada est√° localizada, ou a quaisquer rotas adicionadas manualmente √† tabela de rotas do ponto de extremidade VPN do cliente.
* Os intervalos CIDR do cliente devem ter um tamanho de bloco de pelo **menos /22** e **n√£o devem ser maiores que /12.**
* Uma **parte dos endere√ßos** no intervalo CIDR do cliente √© usada para **suportar o modelo de disponibilidade** do ponto de extremidade VPN do cliente e n√£o pode ser atribu√≠da a clientes. Portanto, recomendamos que voc√™ **atribua um bloco CIDR que contenha o dobro do n√∫mero de endere√ßos IP necess√°rios** para habilitar o n√∫mero m√°ximo de conex√µes simult√¢neas que voc√™ planeja suportar no ponto de extremidade VPN do cliente.
* O **intervalo CIDR do cliente n√£o pode ser alterado** ap√≥s a cria√ß√£o do ponto de extremidade VPN do cliente.
* As **subredes** associadas a um ponto de extremidade VPN do cliente **devem estar na mesma VPC**.
* Voc√™ **n√£o pode associar v√°rias subredes da mesma Zona de Disponibilidade a um ponto de extremidade VPN do cliente**.
* Um ponto de extremidade VPN do cliente **n√£o suporta associa√ß√µes de subrede em uma VPC de loca√ß√£o dedicada**.
* O Client VPN suporta **tr√°fego IPv4** apenas.
* O Client VPN **n√£o** √© compat√≠vel com os Padr√µes Federais de Processamento de Informa√ß√µes (**FIPS**).
* Se a autentica√ß√£o multifator (MFA) estiver desativada para seu Active Directory, uma senha de usu√°rio n√£o pode estar no seguinte formato.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* O portal de autoatendimento **n√£o est√° dispon√≠vel para clientes que se autenticam usando autentica√ß√£o m√∫tua**.

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
