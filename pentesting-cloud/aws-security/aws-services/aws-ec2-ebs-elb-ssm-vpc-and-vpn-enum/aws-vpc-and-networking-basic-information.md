# AWS - VPC & Networking Basic Information

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## AWS Networking in a Nutshell

Una **VPC** contiene un **CIDR de red** como 10.0.0.0/16 (con su **tabla de enrutamiento** y **ACL de red**).

Esta red VPC se divide en **subredes**, por lo que una **subred** est치 directamente **relacionada** con la **VPC**, **tabla de enrutamiento** y **ACL de red**.

Luego, las **Interfaces de Red** adjuntas a servicios (como instancias EC2) est치n **conectadas** a las **subredes** con **grupo(s) de seguridad**.

Por lo tanto, un **grupo de seguridad** limitar치 los puertos expuestos de las **interfaces de red que lo utilizan**, **independientemente de la subred**. Y una **ACL de red** **limitar치** los puertos expuestos a la **red completa**.

Adem치s, para **acceder a Internet**, hay algunas configuraciones interesantes a verificar:

* Una **subred** puede **asignar autom치ticamente direcciones IPv4 p칰blicas**
* Una **instancia** creada en la red que **asigna autom치ticamente direcciones IPv4 puede obtener una**
* Se necesita un **gateway de Internet** que est칠 **adjunto** a la **VPC**
* Tambi칠n podr칤as usar **gateways de internet solo de salida**
* Tambi칠n podr칤as tener un **gateway NAT** en una **subred privada** para que sea posible **conectarse a servicios externos** desde esa subred privada, pero **no es posible alcanzarlos desde el exterior**.
* El gateway NAT puede ser **p칰blico** (acceso a Internet) o **privado** (acceso a otras VPCs)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) te permite **lanzar recursos de AWS en una red virtual** que has definido. Esta red virtual tendr치 varias subredes, Gateways de Internet para acceder a Internet, ACLs, Grupos de seguridad, IPs...

### Subnets

Las subredes ayudan a imponer un mayor nivel de seguridad. **La agrupaci칩n l칩gica de recursos similares** tambi칠n te ayuda a mantener una **facilidad de gesti칩n** en toda tu infraestructura.

* Los CIDR v치lidos son desde una m치scara de red /16 hasta una m치scara de red /28.
* Una subred no puede estar en diferentes zonas de disponibilidad al mismo tiempo.
* **AWS reserva las primeras tres direcciones IP de host** de cada subred **para** **uso interno de AWS**: la primera direcci칩n de host utilizada es para el enrutador de la VPC. La segunda direcci칩n est치 reservada para AWS DNS y la tercera direcci칩n est치 reservada para uso futuro.
* Se llaman **subredes p칰blicas** a aquellas que tienen **acceso directo a Internet, mientras que las subredes privadas no.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Route Tables

Las tablas de enrutamiento determinan el enrutamiento del tr치fico para una subred dentro de una VPC. Determinan qu칠 tr치fico de red se reenv칤a a Internet o a una conexi칩n VPN. Normalmente encontrar치s acceso a:

* VPC local
* NAT
* Gateways de Internet / gateways de Internet solo de salida (necesarios para dar acceso a la VPC a Internet).
* Para hacer que una subred sea p칰blica, necesitas **crear** y **adjuntar** un **gateway de Internet** a tu VPC.
* Puntos finales de VPC (para acceder a S3 desde redes privadas)

En las siguientes im치genes puedes verificar las diferencias entre una red p칰blica por defecto y una privada:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Listas de Control de Acceso de Red (ACLs)**: Las ACL de red son reglas de firewall que controlan el tr치fico de red entrante y saliente a una subred. Pueden usarse para permitir o denegar tr치fico a direcciones IP o rangos espec칤ficos.

* Es m치s frecuente permitir/denegar acceso usando grupos de seguridad, pero esta es la 칰nica forma de cortar completamente shells reversos establecidos. Una regla modificada en un grupo de seguridad no detiene las conexiones ya establecidas.
* Sin embargo, esto se aplica a toda la subred, ten cuidado al prohibir cosas porque la funcionalidad necesaria podr칤a verse afectada.

### Security Groups

Los grupos de seguridad son un **firewall** virtual que controla el tr치fico de red **entrante y saliente a las instancias** en una VPC. Relaci칩n 1 SG a M instancias (generalmente 1 a 1).\
Normalmente se usa para abrir puertos peligrosos en instancias, como el puerto 22, por ejemplo:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP Addresses

Una _direcci칩n IP el치stica_ es una **direcci칩n IPv4 est치tica** dise침ada para la computaci칩n en la nube din치mica. Una direcci칩n IP el치stica se asigna a tu cuenta de AWS y es tuya hasta que la liberes. Al usar una direcci칩n IP el치stica, puedes enmascarar la falla de una instancia o software al reasignar r치pidamente la direcci칩n a otra instancia en tu cuenta.

### Connection between subnets

Por defecto, todas las subredes tienen la **asignaci칩n autom치tica de direcciones IP p칰blicas desactivada**, pero se puede activar.

**Una ruta local dentro de una tabla de enrutamiento permite la comunicaci칩n entre subredes de VPC.**

Si est치s **conectando una subred con otra subred diferente, no puedes acceder a las subredes conectadas** con la otra subred, necesitas crear conexi칩n con ellas directamente. **Esto tambi칠n se aplica a los gateways de internet**. No puedes pasar a trav칠s de una conexi칩n de subred para acceder a Internet, necesitas asignar el gateway de internet a tu subred.

### VPC Peering

El emparejamiento de VPC permite **conectar dos o m치s VPCs juntas**, usando IPV4 o IPV6, como si fueran parte de la misma red.

Una vez que se establece la conectividad de emparejamiento, **los recursos en una VPC pueden acceder a los recursos en la otra**. La conectividad entre las VPCs se implementa a trav칠s de la infraestructura de red existente de AWS, por lo que es altamente disponible sin cuellos de botella de ancho de banda. Como **las conexiones emparejadas operan como si fueran parte de la misma red**, hay restricciones en cuanto a los rangos de bloques CIDR que se pueden usar.\
Si tienes rangos CIDR **superpuestos o duplicados** para tu VPC, entonces **no podr치s emparejar las VPCs**.\
Cada VPC de AWS **solo se comunicar치 con su par**. Como ejemplo, si tienes una conexi칩n de emparejamiento entre VPC 1 y VPC 2, y otra conexi칩n entre VPC 2 y VPC 3 como se muestra, entonces VPC 1 y 2 podr칤an comunicarse entre s칤 directamente, al igual que VPC 2 y VPC 3, sin embargo, VPC 1 y VPC 3 no podr칤an. **No puedes enrutar a trav칠s de una VPC para llegar a otra.**

### **VPC Flow Logs**

Dentro de tu VPC, podr칤as tener potencialmente cientos o incluso miles de recursos comunic치ndose entre diferentes subredes tanto p칰blicas como privadas y tambi칠n entre diferentes VPCs a trav칠s de conexiones de emparejamiento de VPC. **Los registros de flujo de VPC te permiten capturar informaci칩n del tr치fico IP que fluye entre las interfaces de red de tus recursos dentro de tu VPC**.

A diferencia de los registros de acceso de S3 y los registros de acceso de CloudFront, los **datos de registro generados por los registros de flujo de VPC no se almacenan en S3. En su lugar, los datos de registro capturados se env칤an a los registros de CloudWatch**.

Limitaciones:

* Si est치s ejecutando una conexi칩n de emparejamiento de VPC, entonces solo podr치s ver los registros de flujo de las VPCs emparejadas que est치n dentro de la misma cuenta.
* Si a칰n est치s ejecutando recursos dentro del entorno EC2-Classic, entonces, desafortunadamente, no podr치s recuperar informaci칩n de sus interfaces.
* Una vez que se ha creado un registro de flujo de VPC, no se puede cambiar. Para alterar la configuraci칩n del registro de flujo de VPC, necesitas eliminarlo y luego recrear uno nuevo.
* El siguiente tr치fico no es monitoreado ni capturado por los registros. Tr치fico DHCP dentro de la VPC, tr치fico de instancias destinado al servidor DNS de Amazon.
* Cualquier tr치fico destinado a la direcci칩n IP del enrutador predeterminado de la VPC y tr치fico hacia y desde las siguientes direcciones, 169.254.169.254 que se utiliza para recopilar metadatos de instancias, y 169.254.169.123 que se utiliza para el Servicio de Sincronizaci칩n de Tiempo de Amazon.
* Tr치fico relacionado con una licencia de activaci칩n de Windows de una instancia de Windows.
* Tr치fico entre una interfaz de balanceador de carga de red y una interfaz de red de punto final.

Para cada interfaz de red que publica datos en el grupo de registros de CloudWatch, se utilizar치 un flujo de registro diferente. Y dentro de cada uno de estos flujos, habr치 datos de eventos de registro de flujo que muestran el contenido de las entradas de registro. Cada uno de estos **registros captura datos durante una ventana de aproximadamente 10 a 15 minutos**.

## VPN

### Basic AWS VPN Components

1. **Customer Gateway**:
* Un Customer Gateway es un recurso que creas en AWS para representar tu lado de una conexi칩n VPN.
* Es esencialmente un dispositivo f칤sico o una aplicaci칩n de software en tu lado de la conexi칩n VPN de sitio a sitio.
* Proporcionas informaci칩n de enrutamiento y la direcci칩n IP p칰blica de tu dispositivo de red (como un enrutador o un firewall) a AWS para crear un Customer Gateway.
* Sirve como un punto de referencia para configurar la conexi칩n VPN y no incurre en cargos adicionales.
2. **Virtual Private Gateway**:
* Un Virtual Private Gateway (VPG) es el concentrador VPN en el lado de Amazon de la conexi칩n VPN de sitio a sitio.
* Est치 adjunto a tu VPC y sirve como el objetivo para tu conexi칩n VPN.
* VPG es el punto final del lado de AWS para la conexi칩n VPN.
* Maneja la comunicaci칩n segura entre tu VPC y tu red local.
3. **Site-to-Site VPN Connection**:
* Una conexi칩n VPN de sitio a sitio conecta tu red local a una VPC a trav칠s de un t칰nel VPN IPsec seguro.
* Este tipo de conexi칩n requiere un Customer Gateway y un Virtual Private Gateway.
* Se utiliza para una comunicaci칩n segura, estable y consistente entre tu centro de datos o red y tu entorno de AWS.
* T칤picamente se usa para conexiones regulares y a largo plazo y se factura seg칰n la cantidad de datos transferidos a trav칠s de la conexi칩n.
4. **Client VPN Endpoint**:
* Un endpoint de Client VPN es un recurso que creas en AWS para habilitar y gestionar sesiones de VPN de cliente.
* Se utiliza para permitir que dispositivos individuales (como laptops, tel칠fonos inteligentes, etc.) se conecten de forma segura a recursos de AWS o a tu red local.
* Se diferencia de la VPN de sitio a sitio en que est치 dise침ado para clientes individuales en lugar de conectar redes enteras.
* Con Client VPN, cada dispositivo cliente utiliza un software de cliente VPN para establecer una conexi칩n segura.

### Site-to-Site VPN

**Conecta tu red local con tu VPC.**

* **Conexi칩n VPN**: Una conexi칩n segura entre tu equipo local y tus VPCs.
* **T칰nel VPN**: Un enlace cifrado donde los datos pueden pasar desde la red del cliente hacia o desde AWS.

Cada conexi칩n VPN incluye dos t칰neles VPN que puedes usar simult치neamente para alta disponibilidad.
* **Customer gateway**: Un recurso de AWS que proporciona informaci칩n a AWS sobre tu dispositivo de gateway de cliente.
* **Customer gateway device**: Un dispositivo f칤sico o una aplicaci칩n de software en tu lado de la conexi칩n VPN de sitio a sitio.
* **Virtual private gateway**: El concentrador VPN en el lado de Amazon de la conexi칩n VPN de sitio a sitio. Usas un gateway privado virtual o un gateway de tr치nsito como el gateway para el lado de Amazon de la conexi칩n VPN de sitio a sitio.
* **Transit gateway**: Un hub de tr치nsito que se puede usar para interconectar tus VPCs y redes locales. Usas un gateway de tr치nsito o un gateway privado virtual como el gateway para el lado de Amazon de la conexi칩n VPN de sitio a sitio.

#### Limitations

* El tr치fico IPv6 no es compatible con conexiones VPN en un gateway privado virtual.
* Una conexi칩n VPN de AWS no admite el descubrimiento de Path MTU.

Adem치s, ten en cuenta lo siguiente cuando uses VPN de sitio a sitio.

* Al conectar tus VPCs a una red local com칰n, recomendamos que uses bloques CIDR no superpuestos para tus redes.

### Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Con칠ctate desde tu m치quina a tu VPC**

#### Concepts

* **Client VPN endpoint:** El recurso que creas y configuras para habilitar y gestionar sesiones de VPN de cliente. Es el recurso donde se terminan todas las sesiones de VPN de cliente.
* **Target network:** Una red objetivo es la red que asocias con un endpoint de Client VPN. **Una subred de una VPC es una red objetivo**. Asociar una subred con un endpoint de Client VPN te permite establecer sesiones de VPN. Puedes asociar m칰ltiples subredes con un endpoint de Client VPN para alta disponibilidad. Todas las subredes deben ser de la misma VPC. Cada subred debe pertenecer a una zona de disponibilidad diferente.
* **Route**: Cada endpoint de Client VPN tiene una tabla de enrutamiento que describe las rutas de red de destino disponibles. Cada ruta en la tabla de enrutamiento especifica el camino para el tr치fico hacia recursos o redes espec칤ficas.
* **Authorization rules:** Una regla de autorizaci칩n **restringe a los usuarios que pueden acceder a una red**. Para una red especificada, configuras el grupo de Active Directory o proveedor de identidad (IdP) que tiene permitido el acceso. Solo los usuarios que pertenecen a este grupo pueden acceder a la red especificada. **Por defecto, no hay reglas de autorizaci칩n** y debes configurar reglas de autorizaci칩n para permitir que los usuarios accedan a recursos y redes.
* **Client:** El usuario final que se conecta al endpoint de Client VPN para establecer una sesi칩n de VPN. Los usuarios finales necesitan descargar un cliente OpenVPN y usar el archivo de configuraci칩n del Client VPN que creaste para establecer una sesi칩n de VPN.
* **Client CIDR range:** Un rango de direcciones IP del cual asignar direcciones IP de cliente. Cada conexi칩n al endpoint de Client VPN se le asigna una direcci칩n IP 칰nica del rango CIDR de cliente. T칰 eliges el rango CIDR de cliente, por ejemplo, `10.2.0.0/16`.
* **Client VPN ports:** AWS Client VPN admite los puertos 443 y 1194 tanto para TCP como para UDP. El predeterminado es el puerto 443.
* **Client VPN network interfaces:** Cuando asocias una subred con tu endpoint de Client VPN, creamos interfaces de red de Client VPN en esa subred. **El tr치fico que se env칤a a la VPC desde el endpoint de Client VPN se env칤a a trav칠s de una interfaz de red de Client VPN**. Luego se aplica la traducci칩n de direcci칩n de red de origen (SNAT), donde la direcci칩n IP de origen del rango CIDR de cliente se traduce a la direcci칩n IP de la interfaz de red de Client VPN.
* **Connection logging:** Puedes habilitar el registro de conexiones para tu endpoint de Client VPN para registrar eventos de conexi칩n. Puedes usar esta informaci칩n para realizar an치lisis forenses, analizar c칩mo se est치 utilizando tu endpoint de Client VPN o depurar problemas de conexi칩n.
* **Self-service portal:** Puedes habilitar un portal de autoservicio para tu endpoint de Client VPN. Los clientes pueden iniciar sesi칩n en el portal basado en la web usando sus credenciales y descargar la 칰ltima versi칩n del archivo de configuraci칩n del endpoint de Client VPN, o la 칰ltima versi칩n del cliente proporcionado por AWS.

#### Limitations

* **Los rangos CIDR de cliente no pueden superponerse con el CIDR local** de la VPC en la que se encuentra la subred asociada, o cualquier ruta a침adida manualmente a la tabla de enrutamiento del endpoint de Client VPN.
* Los rangos CIDR de cliente deben tener un tama침o de bloque de al **menos /22** y **no deben ser mayores que /12.**
* Una **parte de las direcciones** en el rango CIDR de cliente se utilizan para **soportar el modelo de disponibilidad** del endpoint de Client VPN, y no pueden ser asignadas a clientes. Por lo tanto, recomendamos que **asignes un bloque CIDR que contenga el doble de la cantidad de direcciones IP que se requieren** para habilitar el n칰mero m치ximo de conexiones concurrentes que planeas soportar en el endpoint de Client VPN.
* El **rango CIDR de cliente no puede ser cambiado** despu칠s de crear el endpoint de Client VPN.
* Las **subredes** asociadas con un endpoint de Client VPN **deben estar en la misma VPC**.
* No **puedes asociar m칰ltiples subredes de la misma zona de disponibilidad con un endpoint de Client VPN**.
* Un endpoint de Client VPN **no admite asociaciones de subredes en una VPC de tenencia dedicada**.
* Client VPN admite **tr치fico IPv4** 칰nicamente.
* Client VPN **no** es compatible con los est치ndares de procesamiento de informaci칩n federal (**FIPS**).
* Si la autenticaci칩n multifactor (MFA) est치 desactivada para tu Active Directory, una contrase침a de usuario no puede estar en el siguiente formato.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* El portal de autoservicio **no est치 disponible para clientes que se autentican usando autenticaci칩n mutua**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
