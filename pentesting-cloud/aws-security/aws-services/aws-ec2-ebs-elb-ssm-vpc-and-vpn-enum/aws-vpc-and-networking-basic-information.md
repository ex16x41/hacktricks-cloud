# AWS - VPC & Networking Basic Information

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** ğŸ’¬ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## AWS Networking in a Nutshell

'n **VPC** bevat 'n **netwerk CIDR** soos 10.0.0.0/16 (met sy **routeringstabel** en **netwerk ACL**).

Hierdie VPC-netwerk is verdeel in **subnetwerke**, so 'n **subnetwerk** is direk **verwant** aan die **VPC**, **routering** **tabel** en **netwerk ACL**.

Dan is **Netwerk Interfaces** wat aan dienste (soos EC2 instansies) geheg is, **verbonden** aan die **subnetwerke** met **veiligheidsgroep(e)**.

Daarom sal 'n **veiligheidsgroep** die blootgestelde poorte van die netwerk **interfaces wat dit gebruik**, **onafhanklik van die subnetwork** beperk. En 'n **netwerk ACL** sal die blootgestelde poorte vir die **hele netwerk** **beperk**.

Boonop, om **toegang tot die Internet** te verkry, is daar 'n paar interessante konfigurasies om na te gaan:

* 'n **subnetwerk** kan **outomaties openbare IPv4 adresse toewys**
* 'n **instansie** wat in die netwerk geskep is wat **outomaties IPv4 adresse toewys, kan een kry**
* 'n **Internet gateway** moet aan die **VPC** **geheg** wees
* Jy kan ook **Egress-only internet gateways** gebruik
* Jy kan ook 'n **NAT gateway** in 'n **private subnet** hÃª sodat dit moontlik is om **verbinding te maak met eksterne dienste** vanaf daardie private subnet, maar dit is **nie moontlik om hulle van buite te bereik** nie.
* Die NAT gateway kan **publiek** wees (toegang tot die internet) of **privaat** (toegang tot ander VPCs)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) stel jou in staat om **AWS hulpbronne in 'n virtuele netwerk** te **ontplooi** wat jy gedefinieer het. Hierdie virtuele netwerk sal verskeie subnetwerke, Internet Gateways om toegang tot die Internet te verkry, ACLs, Veiligheidsgroepe, IPs...

### Subnets

Subnets help om 'n groter vlak van sekuriteit af te dwing. **Logiese groepe van soortgelyke hulpbronne** help jou ook om 'n **gemak van bestuur** oor jou infrastruktuur te handhaaf.

* Geldige CIDR is van 'n /16 netmask tot 'n /28 netmask.
* 'n Subnet kan nie in verskillende beskikbaarheidsgebiede op dieselfde tyd wees nie.
* **AWS reserveer die eerste drie gasheer IP adresse** van elke subnet **vir** **interne AWS gebruik**: die eerste gasheer adres wat gebruik word, is vir die VPC-router. Die tweede adres is gereserveer vir AWS DNS en die derde adres is gereserveer vir toekomstige gebruik.
* Dit word **publieke subnetwerke** genoem vir diegene wat **direkte toegang tot die Internet het, terwyl private subnetwerke dit nie het nie.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Route Tables

Routeringstabelle bepaal die verkeer routering vir 'n subnet binne 'n VPC. Hulle bepaal watter netwerkverkeer na die internet of na 'n VPN-verbinding gestuur word. Jy sal gewoonlik toegang vind tot die:

* Plaaslike VPC
* NAT
* Internet Gateways / Egress-only Internet gateways (nodig om 'n VPC toegang tot die Internet te gee).
* Om 'n subnet publiek te maak, moet jy 'n **Internet gateway** **skep** en **heg** aan jou VPC.
* VPC eindpunte (om toegang tot S3 vanaf private netwerke te verkry)

In die volgende beelde kan jy die verskille in 'n standaard publieke netwerk en 'n private een nagaan:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Netwerk Toegang Beheer Lyste (ACLs)**: Netwerk ACLs is firewall reÃ«ls wat inkomende en uitgaande netwerkverkeer na 'n subnet beheer. Hulle kan gebruik word om verkeer na spesifieke IP adresse of reekse toe te laat of te weier.

* Dit is die mees algemene om toegang toe te laat/te weier met behulp van veiligheidsgroepe, maar dit is die enigste manier om gevestigde omgekeerde skulpies heeltemal te sny. 'n Gewysigde reÃ«l in 'n veiligheidsgroep stop nie reeds gevestigde verbindings nie.
* Dit geld egter vir die hele subnetwerk, wees versigtig wanneer jy goed verbied, want nodige funksionaliteit mag versteur word.

### Security Groups

Veiligheidsgroepe is 'n virtuele **firewall** wat inkomende en uitgaande netwerk **verkeer na instansies** in 'n VPC beheer. Verhouding 1 SG tot M instansies (gewoonlik 1 tot 1).\
Gewoonlik word dit gebruik om gevaarlike poorte in instansies te open, soos poort 22 byvoorbeeld:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP Addresses

'n _Elastic IP adres_ is 'n **statische IPv4 adres** wat ontwerp is vir dinamiese wolkrekenaars. 'n Elastic IP adres word aan jou AWS rekening toegeken, en is joune totdat jy dit vrystel. Deur 'n Elastic IP adres te gebruik, kan jy die mislukking van 'n instansie of sagteware maskeer deur die adres vinnig na 'n ander instansie in jou rekening te herverdeel.

### Connection between subnets

Standaard het alle subnetwerke die **outomatiese toewysing van openbare IP adresse afgeskakel**, maar dit kan aangeskakel word.

**'n Plaaslike roete binne 'n routeringstabel stel kommunikasie tussen VPC subnetwerke in staat.**

As jy 'n **subnet met 'n ander subnet verbind, kan jy nie toegang verkry tot die subnetwerke wat met die ander subnet verbind is nie, jy moet direk verbinding met hulle maak.** **Dit geld ook vir internet gateways**. Jy kan nie deur 'n subnet verbinding gaan om toegang tot die internet te verkry nie, jy moet die internet gateway aan jou subnet toewys.

### VPC Peering

VPC peering stel jou in staat om **twee of meer VPCs saam te verbind**, met behulp van IPV4 of IPV6, asof hulle deel van dieselfde netwerk is.

Sodra die peerverbinding gevestig is, kan **hulpbronne in een VPC toegang verkry tot hulpbronne in die ander**. Die verbinding tussen die VPCs word deur die bestaande AWS netwerk infrastruktuur geÃ¯mplementeer, en is dus hoogs beskikbaar sonder enige bandwydte knelpunte. Aangesien **gepeerde verbindings werk asof hulle deel van dieselfde netwerk is**, is daar beperkings wanneer dit kom by jou CIDR blokreekse wat gebruik kan word.\
As jy **oorlappende of duplikaat CIDR** reekse vir jou VPC het, dan **sal jy nie in staat wees om die VPCs** saam te peer nie.\
Elke AWS VPC sal **slegs met sy peer kommunikeer**. As 'n voorbeeld, as jy 'n peering verbinding tussen VPC 1 en VPC 2 het, en 'n ander verbinding tussen VPC 2 en VPC 3 soos getoon, dan kan VPC 1 en 2 direk met mekaar kommunikeer, soos VPC 2 en VPC 3, maar VPC 1 en VPC 3 kan nie. **Jy kan nie deur een VPC roete om by 'n ander te kom nie.**

### **VPC Flow Logs**

Binne jou VPC kan jy potensieel honderde of selfs duisende hulpbronne hÃª wat tussen verskillende subnetwerke kommunikeer, beide publiek en privaat, en ook tussen verskillende VPCs deur VPC peering verbindings. **VPC Flow Logs stel jou in staat om IP verkeer inligting te vang wat tussen jou netwerk interfaces van jou hulpbronne binne jou VPC vloei**.

In teenstelling met S3 toegang logs en CloudFront toegang logs, is die **logdata wat deur VPC Flow Logs gegenereer word, nie in S3 gestoor nie. In plaas daarvan word die logdata wat gevang word, na CloudWatch logs gestuur**.

Beperkings:

* As jy 'n VPC gepeerde verbinding uitvoer, sal jy slegs die vloei logs van gepeerde VPCs wat binne dieselfde rekening is, kan sien.
* As jy steeds hulpbronne binne die EC2-Classic omgewing uitvoer, kan jy ongelukkig nie inligting van hul interfaces verkry nie.
* Sodra 'n VPC Flow Log geskep is, kan dit nie verander word nie. Om die VPC Flow Log konfigurasie te verander, moet jy dit verwyder en dan 'n nuwe een herskep.
* Die volgende verkeer word nie gemonitor en deur die logs gevang nie. DHCP verkeer binne die VPC, verkeer van instansies wat bestem is vir die Amazon DNS Server.
* Enige verkeer wat bestem is vir die IP adres van die VPC standaard router en verkeer na en van die volgende adresse, 169.254.169.254 wat gebruik word om instansie metadata te versamel, en 169.254.169.123 wat gebruik word vir die Amazon Time Sync Service.
* Verkeer wat verband hou met 'n Amazon Windows aktivering lisensie van 'n Windows instansie
* Verkeer tussen 'n netwerk laaibalk interface en 'n eindpunt netwerk interface

Vir elke netwerk interface wat data na die CloudWatch loggroep publiseer, sal dit 'n ander log stroom gebruik. En binne elkeen van hierdie strome, sal daar die vloei log gebeurtenisdata wees wat die inhoud van die log inskrywings toon. Elke een van hierdie **logs vang data gedurende 'n venster van ongeveer 10 tot 15 minute**.

## VPN

### Basic AWS VPN Components

1. **KliÃ«nt Gateway**:
* 'n KliÃ«nt Gateway is 'n hulpbron wat jy in AWS skep om jou kant van 'n VPN-verbinding te verteenwoordig.
* Dit is essensieel 'n fisiese toestel of sagtewaretoepassing aan jou kant van die Site-to-Site VPN-verbinding.
* Jy verskaf routering inligting en die publieke IP adres van jou netwerk toestel (soos 'n router of 'n firewall) aan AWS om 'n KliÃ«nt Gateway te skep.
* Dit dien as 'n verwysingspunt vir die opstelling van die VPN-verbinding en bring geen addisionele koste mee nie.
2. **Virtuele Privaat Gateway**:
* 'n Virtuele Privaat Gateway (VPG) is die VPN konsentrasie aan die Amazon kant van die Site-to-Site VPN-verbinding.
* Dit is aan jou VPC geheg en dien as die teiken vir jou VPN-verbinding.
* VPG is die AWS kant eindpunt vir die VPN-verbinding.
* Dit hanteer die veilige kommunikasie tussen jou VPC en jou plaaslike netwerk.
3. **Site-to-Site VPN Verbinding**:
* 'n Site-to-Site VPN verbinding verbind jou plaaslike netwerk met 'n VPC deur 'n veilige, IPsec VPN tonnel.
* Hierdie tipe verbinding vereis 'n KliÃ«nt Gateway en 'n Virtuele Privaat Gateway.
* Dit word gebruik vir veilige, stabiele, en konsekwente kommunikasie tussen jou datacentrum of netwerk en jou AWS omgewing.
* Gewoonlik gebruik vir gereelde, langtermyn verbindings en word gefaktureer op grond van die hoeveelheid data wat oor die verbinding oorgedra word.
4. **KliÃ«nt VPN Eindpunt**:
* 'n KliÃ«nt VPN eindpunt is 'n hulpbron wat jy in AWS skep om kliÃ«nt VPN sessies te aktiveer en te bestuur.
* Dit word gebruik om individuele toestelle (soos skootrekenaars, slimfone, ens.) veilig met AWS hulpbronne of jou plaaslike netwerk te verbind.
* Dit verskil van Site-to-Site VPN in die sin dat dit ontwerp is vir individuele kliÃ«nte eerder as om hele netwerke te verbind.
* Met KliÃ«nt VPN gebruik elke kliÃ«nt toestel 'n VPN kliÃ«nt sagteware om 'n veilige verbinding te vestig.

### Site-to-Site VPN

**Verbind jou plaaslike netwerk met jou VPC.**

* **VPN verbinding**: 'n Veilige verbinding tussen jou plaaslike toerusting en jou VPCs.
*   **VPN tonnel**: 'n GeÃ«nkripteerde skakel waar data van die kliÃ«nt netwerk na of van AWS kan beweeg.

Elke VPN verbinding sluit twee VPN tonnels in wat jy gelyktydig kan gebruik vir hoÃ« beskikbaarheid.
* **KliÃ«nt gateway**: 'n AWS hulpbron wat inligting aan AWS verskaf oor jou kliÃ«nt gateway toestel.
* **KliÃ«nt gateway toestel**: 'n fisiese toestel of sagtewaretoepassing aan jou kant van die Site-to-Site VPN-verbinding.
* **Virtuele privaat gateway**: Die VPN konsentrasie aan die Amazon kant van die Site-to-Site VPN-verbinding. Jy gebruik 'n virtuele privaat gateway of 'n transit gateway as die gateway vir die Amazon kant van die Site-to-Site VPN-verbinding.
* **Transit gateway**: 'n transit hub wat gebruik kan word om jou VPCs en plaaslike netwerke te interkonnekteer. Jy gebruik 'n transit gateway of virtuele privaat gateway as die gateway vir die Amazon kant van die Site-to-Site VPN-verbinding.

#### Limitations

* IPv6 verkeer word nie ondersteun vir VPN verbindings op 'n virtuele privaat gateway nie.
* 'n AWS VPN verbinding ondersteun nie Path MTU Discovery nie.

Boonop, neem die volgende in ag wanneer jy Site-to-Site VPN gebruik.

* Wanneer jy jou VPCs aan 'n gemeenskaplike plaaslike netwerk verbind, beveel ons aan dat jy nie-oorlappende CIDR blokke vir jou netwerke gebruik.

### KliÃ«nt VPN <a href="#what-is-components" id="what-is-components"></a>

**Verbind vanaf jou masjien na jou VPC**

#### Concepts

* **KliÃ«nt VPN eindpunt:** Die hulpbron wat jy skep en konfigureer om kliÃ«nt VPN sessies te aktiveer en te bestuur. Dit is die hulpbron waar alle kliÃ«nt VPN sessies beÃ«indig word.
* **Teiken netwerk:** 'n Teiken netwerk is die netwerk wat jy met 'n KliÃ«nt VPN eindpunt assosieer. **'n Subnet van 'n VPC is 'n teiken netwerk**. Om 'n subnet met 'n KliÃ«nt VPN eindpunt te assosieer, stel jou in staat om VPN sessies te vestig. Jy kan verskeie subnets met 'n KliÃ«nt VPN eindpunt assosieer vir hoÃ« beskikbaarheid. Alle subnets moet van dieselfde VPC wees. Elke subnet moet aan 'n ander Beskikbaarheidsgebied behoort.
* **Roete**: Elke KliÃ«nt VPN eindpunt het 'n routeringstabel wat die beskikbare bestemming netwerk roetes beskryf. Elke roete in die routeringstabel spesifiseer die pad vir verkeer na spesifieke hulpbronne of netwerke.
* **OutorisasiereÃ«ls:** 'n autorisatiereÃ«l **beperk die gebruikers wat toegang tot 'n netwerk kan verkry**. Vir 'n spesifieke netwerk, konfigureer jy die Active Directory of identiteitsverskaffer (IdP) groep wat toegang verleen. Slegs gebruikers wat aan hierdie groep behoort, kan toegang tot die spesifieke netwerk verkry. **Standaard is daar geen autorisatiereÃ«ls nie** en jy moet autorisatiereÃ«ls konfigureer om gebruikers in staat te stel om toegang tot hulpbronne en netwerke te verkry.
* **KliÃ«nt:** Die eindgebruiker wat met die KliÃ«nt VPN eindpunt verbind om 'n VPN sessie te vestig. Eindgebruikers moet 'n OpenVPN kliÃ«nt aflaai en die KliÃ«nt VPN konfigurasie lÃªer wat jy geskep het, gebruik om 'n VPN sessie te vestig.
* **KliÃ«nt CIDR reeks:** 'n IP adres reeks waaruit kliÃ«nt IP adresse toegeken kan word. Elke verbinding met die KliÃ«nt VPN eindpunt word aan 'n unieke IP adres van die kliÃ«nt CIDR reeks toegeken. Jy kies die kliÃ«nt CIDR reeks, byvoorbeeld, `10.2.0.0/16`.
* **KliÃ«nt VPN poorte:** AWS KliÃ«nt VPN ondersteun poorte 443 en 1194 vir beide TCP en UDP. Die standaard is poort 443.
* **KliÃ«nt VPN netwerk interfaces:** Wanneer jy 'n subnet met jou KliÃ«nt VPN eindpunt assosieer, skep ons KliÃ«nt VPN netwerk interfaces in daardie subnet. **Verkeer wat na die VPC van die KliÃ«nt VPN eindpunt gestuur word, word deur 'n KliÃ«nt VPN netwerk interface gestuur**. Bron netwerk adres vertaling (SNAT) word dan toegepas, waar die bron IP adres van die kliÃ«nt CIDR reeks na die KliÃ«nt VPN netwerk interface IP adres vertaal word.
* **Verbindingslogging:** Jy kan verbindingslogging vir jou KliÃ«nt VPN eindpunt aktiveer om verbindingsgebeurtenisse te log. Jy kan hierdie inligting gebruik om forensiese ondersoeke te doen, analiseer hoe jou KliÃ«nt VPN eindpunt gebruik word, of verbindingsprobleme op te los.
* **Selfdiensportaal:** Jy kan 'n selfdiensportaal vir jou KliÃ«nt VPN eindpunt aktiveer. KliÃ«nte kan inlog op die web-gebaseerde portaal met hul geloofsbriewe en die nuutste weergawe van die KliÃ«nt VPN eindpunt konfigurasie lÃªer aflaai, of die nuutste weergawe van die AWS verskafde kliÃ«nt.

#### Limitations

* **KliÃ«nt CIDR reekse kan nie oorvleuel met die plaaslike CIDR** van die VPC waarin die geassosieerde subnet geleÃ« is nie, of enige roetes wat handmatig aan die KliÃ«nt VPN eindpunt se routeringstabel bygevoeg is.
* KliÃ«nt CIDR reekse moet 'n blokgrootte van ten **minste /22** hÃª en mag **nie groter as /12 wees nie.**
* 'n **gedeelte van die adresse** in die kliÃ«nt CIDR reeks word gebruik om die **beskikbaarheids** model van die KliÃ«nt VPN eindpunt te ondersteun, en kan nie aan kliÃ«nte toegeken word nie. Daarom beveel ons aan dat jy **'n CIDR blok toewys wat twee keer die aantal IP adresse bevat wat benodig word** om die maksimum aantal gelyktydige verbindings wat jy van plan is om te ondersteun, te aktiveer op die KliÃ«nt VPN eindpunt.
* Die **kliÃ«nt CIDR reeks kan nie verander word** nadat jy die KliÃ«nt VPN eindpunt geskep het nie.
* Die **subnets** wat met 'n KliÃ«nt VPN eindpunt geassosieer is, **moet in dieselfde VPC wees**.
* Jy **kan nie verskeie subnets van dieselfde Beskikbaarheidsgebied met 'n KliÃ«nt VPN eindpunt assosieer nie**.
* 'n KliÃ«nt VPN eindpunt **ondersteun nie subnet assosiasies in 'n toegewyde huur VPC nie**.
* KliÃ«nt VPN ondersteun **IPv4** verkeer slegs.
* KliÃ«nt VPN is **nie** Federale Inligting Verwerkingsstandaarde (**FIPS**) **konform nie**.
*   As multi-faktor verifikasie (MFA) gedeaktiveer is vir jou Active Directory, kan 'n gebruikerswagwoord nie in die volgende formaat wees nie.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* Die selfdiensportaal is **nie beskikbaar vir kliÃ«nte wat outentiseer met behulp van wederkerige outentisering nie**.

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** ğŸ’¬ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
