# AWS - API Gateway Enum

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## API Gateway

### Temel Bilgiler

AWS API Gateway, geliÅŸtiricilerin **bÃ¼yÃ¼k Ã¶lÃ§ekli API'ler oluÅŸturmasÄ±na, yayÄ±nlamasÄ±na ve denetlemesine** olanak tanÄ±yan Amazon Web Services (AWS) tarafÄ±ndan sunulan kapsamlÄ± bir hizmettir. Uygulamaya giriÅŸ noktasÄ± olarak iÅŸlev gÃ¶rÃ¼r ve geliÅŸtiricilerin bir dizi kural ve prosedÃ¼r belirlemesine izin verir. Bu Ã§erÃ§eve, dÄ±ÅŸ kullanÄ±cÄ±larÄ±n uygulama iÃ§indeki belirli verilere veya iÅŸlevlere eriÅŸimini yÃ¶netir.

API Gateway, **API'lerinize gelen isteklerin nasÄ±l iÅŸleneceÄŸini tanÄ±mlamanÄ±za** olanak tanÄ±r ve belirli yÃ¶ntemler (Ã¶rneÄŸin, GET, POST, PUT, DELETE) ve kaynaklarla Ã¶zel API uÃ§ noktalarÄ± oluÅŸturabilir. AyrÄ±ca, geliÅŸtiricilerin uygulamalarÄ±ndan API'lerinizi Ã§aÄŸÄ±rmasÄ±nÄ± kolaylaÅŸtÄ±rmak iÃ§in istemci SDK'larÄ± (YazÄ±lÄ±m GeliÅŸtirme Kitleri) oluÅŸturabilir.

### API Gateway TÃ¼rleri

* **HTTP API**: OIDC ve OAuth2 gibi yerleÅŸik Ã¶zellikler ve yerel CORS desteÄŸi ile dÃ¼ÅŸÃ¼k gecikmeli ve maliyet etkin REST API'leri oluÅŸturun. AÅŸaÄŸÄ±dakilerle Ã§alÄ±ÅŸÄ±r: Lambda, HTTP arka uÃ§larÄ±.
* **WebSocket API**: Sohbet uygulamalarÄ± veya panolar gibi gerÃ§ek zamanlÄ± kullanÄ±m senaryolarÄ± iÃ§in kalÄ±cÄ± baÄŸlantÄ±lar kullanarak bir WebSocket API'si oluÅŸturun. AÅŸaÄŸÄ±dakilerle Ã§alÄ±ÅŸÄ±r: Lambda, HTTP, AWS Hizmetleri.
* **REST API**: Ä°steÄŸi ve yanÄ±tÄ± tam kontrol ettiÄŸiniz ve API yÃ¶netim yeteneklerine sahip bir REST API geliÅŸtirin. AÅŸaÄŸÄ±dakilerle Ã§alÄ±ÅŸÄ±r: Lambda, HTTP, AWS Hizmetleri.
* **Ã–zel REST API**: Sadece bir VPC iÃ§inden eriÅŸilebilen bir REST API oluÅŸturun.

### API Gateway Ana BileÅŸenleri

1. **Kaynaklar**: API Gateway'de kaynaklar, **API'nizin yapÄ±sÄ±nÄ± oluÅŸturan bileÅŸenlerdir**. API'nizin **farklÄ± yollarÄ±nÄ± veya uÃ§ noktalarÄ±nÄ±** temsil eder ve API'nizin desteklediÄŸi Ã§eÅŸitli eylemlerle iliÅŸkilidir. Bir kaynak, her yolun (/, veya /users, veya /user/{id}) **iÃ§indeki her yÃ¶ntemdir** (Ã¶rneÄŸin, GET, POST, PUT, DELETE).
2. **AÅŸamalar**: API Gateway'deki aÅŸamalar, API'nizin **farklÄ± sÃ¼rÃ¼mlerini veya ortamlarÄ±nÄ±** temsil eder, Ã¶rneÄŸin geliÅŸtirme, test veya Ã¼retim. AÅŸamalarÄ±, API'nizin **birden fazla sÃ¼rÃ¼mÃ¼nÃ¼ aynÄ± anda yÃ¶netmek ve daÄŸÄ±tmak** iÃ§in kullanabilirsiniz, bu da yeni Ã¶zellikleri veya hata dÃ¼zeltmelerini Ã¼retim ortamÄ±nÄ± etkilemeden test etmenizi saÄŸlar. AÅŸamalar ayrÄ±ca, mevcut aÅŸamaya gÃ¶re API'nizin davranÄ±ÅŸÄ±nÄ± yapÄ±landÄ±rmak iÃ§in kullanÄ±labilecek anahtar-deÄŸer Ã§iftleri olan **aÅŸama deÄŸiÅŸkenlerini** de destekler. Ã–rneÄŸin, aÅŸama deÄŸiÅŸkenlerini kullanarak API isteklerini aÅŸamaya baÄŸlÄ± olarak farklÄ± Lambda iÅŸlevlerine veya diÄŸer arka uÃ§ hizmetlerine yÃ¶nlendirebilirsiniz.
* AÅŸama, API Gateway uÃ§ noktasÄ±nÄ±n URL'sinin baÅŸÄ±nda belirtilir.
3. **Yetkilendiriciler**: API Gateway'deki yetkilendiriciler, isteÄŸin devam etmesine izin vermeden Ã¶nce Ã§aÄŸrÄ±nÄ±n kimliÄŸini doÄŸrulayarak **API'nize eriÅŸimi kontrol etmekten** sorumludur. Kendi kimlik doÄŸrulama ve yetkilendirme mantÄ±ÄŸÄ±nÄ±zÄ± uygulamanÄ±za olanak tanÄ±yan Ã¶zel yetkilendiriciler olarak **AWS Lambda iÅŸlevlerini** kullanabilirsiniz. Bir istek geldiÄŸinde, API Gateway isteÄŸin yetkilendirme jetonunu Lambda yetkilendiricisine iletir, bu da jetonu iÅŸler ve Ã§aÄŸrÄ±nÄ±n hangi eylemleri gerÃ§ekleÅŸtirmesine izin verildiÄŸini belirleyen bir IAM politikasÄ± dÃ¶ner. API Gateway ayrÄ±ca, **AWS Kimlik ve EriÅŸim YÃ¶netimi (IAM)** ve **Amazon Cognito** gibi **yerleÅŸik yetkilendiricileri** de destekler.
4. **Kaynak PolitikasÄ±**: API Gateway'deki bir kaynak politikasÄ±, **API'nize eriÅŸim iÃ§in izinleri tanÄ±mlayan** bir JSON belgesidir. IAM politikasÄ±na benzer, ancak Ã¶zellikle API Gateway iÃ§in Ã¶zelleÅŸtirilmiÅŸtir. Bir kaynak politikasÄ±nÄ±, API'nize kimin eriÅŸebileceÄŸini, hangi yÃ¶ntemleri Ã§aÄŸÄ±rabileceklerini ve hangi IP adreslerinden veya VPC'lerden baÄŸlanabileceklerini kontrol etmek iÃ§in kullanabilirsiniz. **Kaynak politikalarÄ±, API'niz iÃ§in ince ayar eriÅŸim kontrolÃ¼ saÄŸlamak amacÄ±yla yetkilendiricilerle birleÅŸtirilebilir.**
* Kaynak politikasÄ± deÄŸiÅŸtirildikten sonra API'nin **tekrar daÄŸÄ±tÄ±lmasÄ± gerekir**.

### GÃ¼nlÃ¼kleme

VarsayÄ±lan olarak, **CloudWatch GÃ¼nlÃ¼kleri** **kapalÄ±dÄ±r**, **EriÅŸim GÃ¼nlÃ¼ÄŸÃ¼** **kapalÄ±dÄ±r** ve **X-Ray izleme** de **kapalÄ±dÄ±r**.

### SayÄ±m

{% hint style="success" %}
Her iki AWS apisinde kaynaklarÄ± saymak iÃ§in (**`apigateway`** ve **`apigatewayv2`**) ihtiyacÄ±nÄ±z olan tek izin ve verilebilecek tek okuma izni **`apigateway:GET`**'dir, bununla **her ÅŸeyi sayabilirsiniz.**
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %}
```bash
# Generic info
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-vpc-links

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
{% endtab %}
{% endtabs %}

## API Gateway uÃ§ noktalarÄ±na eriÅŸim iÃ§in FarklÄ± Yetkilendirmeler

### Kaynak PolitikasÄ±

API uÃ§ noktalarÄ±nÄ± kimin Ã§aÄŸÄ±rabileceÄŸini tanÄ±mlamak iÃ§in kaynak politikalarÄ± kullanmak mÃ¼mkÃ¼ndÃ¼r.\
AÅŸaÄŸÄ±daki Ã¶rnekte **belirtilen IP'nin** `/resource_policy` uÃ§ noktasÄ±nÄ± GET ile Ã§aÄŸÄ±rmasÄ±nÄ±n mÃ¼mkÃ¼n olmadÄ±ÄŸÄ± gÃ¶rÃ¼lmektedir.

<figure><img src="../../../.gitbook/assets/image (256).png" alt=""><figcaption></figcaption></figure>

### IAM Yetkilendirici

Bir yol (kaynak) iÃ§indeki bir metodun Ã§aÄŸrÄ±lmasÄ± iÃ§in IAM kimlik doÄŸrulamasÄ± gerektirecek ÅŸekilde ayarlanmasÄ± mÃ¼mkÃ¼ndÃ¼r.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Bu ayar yapÄ±ldÄ±ÄŸÄ±nda, herhangi bir yetkilendirme olmadan uÃ§ noktaya ulaÅŸmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ±zda `{"message":"Missing Authentication Token"}` hatasÄ±nÄ± alÄ±rsÄ±nÄ±z.

UygulamanÄ±n beklediÄŸi token'Ä± oluÅŸturmanÄ±n kolay bir yolu **curl** kullanmaktÄ±r.
```bash
$ curl -X <method> https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource> --user <AWS_ACCESS_KEY>:<AWS_SECRET_KEY> --aws-sigv4 "aws:amz:<region>:execute-api"
```
BaÅŸka bir yol, **Postman** iÃ§inde **`Authorization`** tÃ¼rÃ¼ **`AWS Signature`** kullanmaktÄ±r.

<figure><img src="../../../.gitbook/assets/image (168).png" alt=""><figcaption></figcaption></figure>

Kullanmak istediÄŸiniz hesabÄ±n accessKey ve SecretKey'lerini ayarlayÄ±n ve API uÃ§ noktasÄ±na karÅŸÄ± kimlik doÄŸrulamasÄ± yapabilirsiniz.

Her iki yÃ¶ntem de aÅŸaÄŸÄ±daki gibi bir **Authorization** **header** oluÅŸturacaktÄ±r:
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
Not edin ki diÄŸer durumlarda **Authorizer** **kÃ¶tÃ¼ kodlanmÄ±ÅŸ** olabilir ve **Authorization header** iÃ§ine **herhangi bir ÅŸey** gÃ¶ndermek **gizli iÃ§eriÄŸi gÃ¶rmeye** **izin verebilir**.

### Request Signing Using Python
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### Ã–zel Lambda Yetkilendirici

Verilen bir token'a dayalÄ± bir lambda kullanarak, kullanÄ±cÄ±nÄ±n **API uÃ§ noktasÄ±nÄ± Ã§aÄŸÄ±rma yetkisine sahip olup olmadÄ±ÄŸÄ±nÄ± belirten bir IAM politikasÄ±** **dÃ¶ndÃ¼rebilirsiniz**.\
Yetkilendiriciyi kullanacak her kaynak yÃ¶ntemini ayarlayabilirsiniz.

<details>

<summary>Lambda Yetkilendirici Kod Ã–rneÄŸi</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

Bunu ÅŸÃ¶yle Ã§aÄŸÄ±rabilirsiniz:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
Lambda koduna baÄŸlÄ± olarak, bu yetkilendirme zayÄ±f olabilir
{% endhint %}

EÄŸer bir **reddetme politikasÄ± oluÅŸturulup dÃ¶ndÃ¼rÃ¼lÃ¼rse**, API Gateway tarafÄ±ndan dÃ¶ndÃ¼rÃ¼len hata ÅŸudur: `{"Message":"User is not authorized to access this resource with an explicit deny"}`

Bu ÅŸekilde **bu yetkilendirmenin** mevcut olduÄŸunu **belirleyebilirsiniz**.

### Gerekli API AnahtarÄ±

API'ye eriÅŸmek iÃ§in **geÃ§erli bir API anahtarÄ±** gerektiren API uÃ§ noktalarÄ± ayarlamak mÃ¼mkÃ¼ndÃ¼r.

<figure><img src="../../../.gitbook/assets/image (88).png" alt=""><figcaption></figcaption></figure>

API Gateway portalÄ±nda API anahtarlarÄ± oluÅŸturmak ve bunlarÄ±n ne kadar kullanÄ±labileceÄŸini (saniye baÅŸÄ±na istek ve ayda istek aÃ§Ä±sÄ±ndan) ayarlamak mÃ¼mkÃ¼ndÃ¼r.

Bir API anahtarÄ±nÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in, onu bir **KullanÄ±m PlanÄ±**'na eklemeniz gerekir, bu kullanÄ±m planÄ± **API AÅŸamasÄ±na** eklenmeli ve iliÅŸkili API aÅŸamasÄ±nÄ±n **API anahtarÄ±nÄ±** gerektiren **uÃ§ noktaya** yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir **metot sÄ±nÄ±rlamasÄ±** olmasÄ± gerekir:

<figure><img src="../../../.gitbook/assets/image (198).png" alt=""><figcaption></figcaption></figure>

## Kimlik DoÄŸrulamasÄ± Olmayan EriÅŸim

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

## SÃ¼reklilik

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
