# AWS - API Gateway Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## API Gateway

### Basic Information

AWS API Gateway je sveobuhvatna usluga koju nudi Amazon Web Services (AWS) dizajnirana za programere da **kreiraju, objavljuju i nadgledaju API-je na velikoj skali**. FunkcioniÅ¡e kao ulazna taÄka za aplikaciju, omoguÄ‡avajuÄ‡i programerima da uspostave okvir pravila i procedura. Ovaj okvir reguliÅ¡e pristup spoljnim korisnicima odreÄ‘enim podacima ili funkcionalnostima unutar aplikacije.

API Gateway vam omoguÄ‡ava da definiÅ¡ete **kako se zahtevi za vaÅ¡e API-je treba obraditi**, i moÅ¾e kreirati prilagoÄ‘ene API krajnje taÄke sa specifiÄnim metodama (npr., GET, POST, PUT, DELETE) i resursima. TakoÄ‘e moÅ¾e generisati klijentske SDK-ove (Softverske razvojne komplete) kako bi olakÅ¡ao programerima pozivanje vaÅ¡ih API-ja iz njihovih aplikacija.

### API Gateways Types

* **HTTP API**: Kreirajte API-je sa niskom latencijom i troÅ¡kovno efikasne REST API-je sa ugraÄ‘enim funkcijama kao Å¡to su OIDC i OAuth2, i podrÅ¡kom za CORS. Radi sa sledeÄ‡im: Lambda, HTTP pozadinskim servisima.
* **WebSocket API**: Kreirajte WebSocket API koristeÄ‡i trajne veze za sluÄajeve koriÅ¡Ä‡enja u realnom vremenu kao Å¡to su chat aplikacije ili nadzorne table. Radi sa sledeÄ‡im: Lambda, HTTP, AWS uslugama.
* **REST API**: Razvijajte REST API gde dobijate potpunu kontrolu nad zahtevom i odgovorom zajedno sa moguÄ‡nostima upravljanja API-jem. Radi sa sledeÄ‡im: Lambda, HTTP, AWS uslugama.
* **REST API Private**: Kreirajte REST API koji je dostupan samo iz VPC-a.

### API Gateway Main Components

1. **Resources**: U API Gateway-u, resursi su komponente koje **Äine strukturu vaÅ¡eg API-ja**. Oni predstavljaju **razliÄite putanje ili krajnje taÄke** vaÅ¡eg API-ja i odgovaraju raznim akcijama koje vaÅ¡ API podrÅ¾ava. Resurs je svaka metoda (npr., GET, POST, PUT, DELETE) **unutar svake putanje** (/, ili /users, ili /user/{id}).
2. **Stages**: Faze u API Gateway-u predstavljaju **razliÄite verzije ili okruÅ¾enja** vaÅ¡eg API-ja, kao Å¡to su razvoj, testiranje ili produkcija. MoÅ¾ete koristiti faze za upravljanje i implementaciju **viÅ¡e verzija vaÅ¡eg API-ja istovremeno**, omoguÄ‡avajuÄ‡i vam da testirate nove funkcije ili ispravke greÅ¡aka bez uticaja na produkciono okruÅ¾enje. Faze takoÄ‘e **podrÅ¾avaju varijable faze**, koje su parovi kljuÄ-vrednost koji se mogu koristiti za konfiguraciju ponaÅ¡anja vaÅ¡eg API-ja na osnovu trenutne faze. Na primer, mogli biste koristiti varijable faze da usmerite API zahteve na razliÄite Lambda funkcije ili druge pozadinske servise u zavisnosti od faze.
* Faza se oznaÄava na poÄetku URL-a krajnje taÄke API Gateway-a.
3. **Authorizers**: Autorizatori u API Gateway-u su odgovorni za **kontrolu pristupa vaÅ¡em API-ju** verifikovanjem identiteta pozivaoca pre nego Å¡to dozvole da zahtev nastavi. MoÅ¾ete koristiti **AWS Lambda funkcije** kao prilagoÄ‘ene autorizatore, Å¡to vam omoguÄ‡ava da implementirate sopstvenu logiku autentifikacije i autorizacije. Kada zahtev stigne, API Gateway prosleÄ‘uje autorizacioni token zahteva Lambda autorizatoru, koji obraÄ‘uje token i vraÄ‡a IAM politiku koja odreÄ‘uje koje akcije pozivalac moÅ¾e da izvrÅ¡i. API Gateway takoÄ‘e podrÅ¾ava **ugraÄ‘ene autorizatore**, kao Å¡to su **AWS Identity and Access Management (IAM)** i **Amazon Cognito**.
4. **Resource Policy**: Politika resursa u API Gateway-u je JSON dokument koji **definiÅ¡e dozvole za pristup vaÅ¡em API-ju**. SliÄna je IAM politici, ali je posebno prilagoÄ‘ena za API Gateway. MoÅ¾ete koristiti politiku resursa da kontroliÅ¡ete ko moÅ¾e pristupiti vaÅ¡em API-ju, koje metode mogu pozvati i sa kojih IP adresa ili VPC-a se mogu povezati. **Politike resursa se mogu koristiti u kombinaciji sa autorizatorima** kako bi se obezbedila precizna kontrola pristupa za vaÅ¡ API.
* Da bi promena imala efekat, API treba da bude **ponovo implementiran nakon** Å¡to je politika resursa izmenjena.

### Logging

Podrazumevano, **CloudWatch Logs** su **iskljuÄeni**, **Access Logging** je **iskljuÄen**, a **X-Ray tracing** je takoÄ‘e **iskljuÄen**.

### Enumeration

{% hint style="success" %}
Napomena da su u oba AWS API-ja za enumeraciju resursa (**`apigateway`** i **`apigatewayv2`**) jedina dozvola koja vam je potrebna i jedina dozvola za Äitanje koja se moÅ¾e dodeliti **`apigateway:GET`**, sa tim moÅ¾ete **enumerisati sve.**
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %}
```bash
# Generic info
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-vpc-links

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
{% endtab %}
{% endtabs %}

## RazliÄite autorizacije za pristup API Gateway krajnjim taÄkama

### Politika resursa

MoguÄ‡e je koristiti politike resursa da definiÅ¡ete ko moÅ¾e da poziva API krajnje taÄke.\
U sledeÄ‡em primeru moÅ¾ete videti da **naznaÄena IP adresa ne moÅ¾e da pozove** krajnju taÄku `/resource_policy` putem GET.

<figure><img src="../../../.gitbook/assets/image (256).png" alt=""><figcaption></figcaption></figure>

### IAM autorizator

MoguÄ‡e je postaviti da metode unutar puta (resursa) zahtevaju IAM autentifikaciju za pozivanje.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Kada je ovo postavljeno, dobiÄ‡ete greÅ¡ku `{"message":"Missing Authentication Token"}` kada pokuÅ¡ate da doÄ‘ete do krajnje taÄke bez bilo kakve autorizacije.

Jedan jednostavan naÄin da generiÅ¡ete oÄekivani token od strane aplikacije je koriÅ¡Ä‡enje **curl**.
```bash
$ curl -X <method> https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource> --user <AWS_ACCESS_KEY>:<AWS_SECRET_KEY> --aws-sigv4 "aws:amz:<region>:execute-api"
```
Drugi naÄin je da se koristi **`Authorization`** tip **`AWS Signature`** unutar **Postman**.

<figure><img src="../../../.gitbook/assets/image (168).png" alt=""><figcaption></figcaption></figure>

Postavite accessKey i SecretKey naloga koji Å¾elite da koristite i moÅ¾ete se autentifikovati protiv API krajnje taÄke.

Obe metode Ä‡e generisati **Authorization** **header** kao Å¡to je:
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
Napomena da u drugim sluÄajevima **Authorizer** moÅ¾e biti **loÅ¡e kodiran** i jednostavno slanje **bilo Äega** unutar **Authorization header** Ä‡e **omoguÄ‡iti da se vidi skriveni sadrÅ¾aj**.

### Potpisivanje zahteva koristeÄ‡i Python
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### Custom Lambda Authorizer

MoguÄ‡e je koristiti lambda funkciju koja, na osnovu datog tokena, **vraÄ‡a IAM politiku** koja ukazuje da li je korisnik **ovlaÅ¡Ä‡en da pozove API krajnju taÄku**.\
MoÅ¾ete postaviti svaku metodu resursa koja Ä‡e koristiti autorizator.

<details>

<summary>Primer koda Lambda autorizatora</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

Pozovite ga sa neÄim poput:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
U zavisnosti od Lambda koda, ova autorizacija moÅ¾e biti ranjiva
{% endhint %}

Imajte na umu da ako je **generisana i vraÄ‡ena politika odbijanja**, greÅ¡ka koju vraÄ‡a API Gateway je: `{"Message":"User is not authorized to access this resource with an explicit deny"}`

Na ovaj naÄin moÅ¾ete **identifikovati ovu autorizaciju** koja je na snazi.

### Potreban API kljuÄ

MoguÄ‡e je postaviti API krajnje taÄke koje **zahtevaju vaÅ¾eÄ‡i API kljuÄ** za kontakt.

<figure><img src="../../../.gitbook/assets/image (88).png" alt=""><figcaption></figcaption></figure>

MoguÄ‡e je generisati API kljuÄeve u API Gateway portalu i Äak postaviti koliko Äesto mogu biti koriÅ¡Ä‡eni (u smislu zahteva po sekundi i u smislu zahteva po mesecu).

Da bi API kljuÄ radio, potrebno je dodati ga u **Plan koriÅ¡Ä‡enja**, ovaj plan koriÅ¡Ä‡enja mora biti dodat u **API fazu** i povezana API faza treba da ima konfigurisano **ograniÄenje metoda** za **krajnju taÄku** koja zahteva API kljuÄ:

<figure><img src="../../../.gitbook/assets/image (198).png" alt=""><figcaption></figcaption></figure>

## Neautorizovani pristup

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## Post Exploatacija

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

## Postojanost

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
