# AWS - API Gateway Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## API Gateway

### Basic Information

AWS API Gateway рдПрдХ рд╡реНрдпрд╛рдкрдХ рд╕реЗрд╡рд╛ рд╣реИ рдЬреЛ Amazon Web Services (AWS) рджреНрд╡рд╛рд░рд╛ рдкреЗрд╢ рдХреА рдЧрдИ рд╣реИ, рдЬреЛ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЛ **рдмрдбрд╝реЗ рдкреИрдорд╛рдиреЗ рдкрд░ APIs рдмрдирд╛рдиреЗ, рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд░рдиреЗ рдФрд░ рджреЗрдЦрд░реЗрдЦ рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХреА рдЧрдИ рд╣реИред рдпрд╣ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рд╡реЗрд╢ рдмрд┐рдВрджреБ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЛ рдирд┐рдпрдореЛрдВ рдФрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХрд╛ рдПрдХ рдврд╛рдВрдЪрд╛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред рдпрд╣ рдврд╛рдВрдЪрд╛ рдмрд╛рд╣рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рднреАрддрд░ рдХреБрдЫ рдбреЗрдЯрд╛ рдпрд╛ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛рдУрдВ рддрдХ рдкрд╣реБрдВрдЪ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред

API Gateway рдЖрдкрдХреЛ **рдпрд╣ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдХрд┐ рдЖрдкрдХреЗ APIs рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдХреИрд╕реЗ рд╕рдВрднрд╛рд▓рд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП**, рдФрд░ рдпрд╣ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╡рд┐рдзрд┐рдпреЛрдВ (рдЬреИрд╕реЗ, GET, POST, PUT, DELETE) рдФрд░ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЗ рд╕рд╛рде рдХрд╕реНрдЯрдо API рдПрдВрдбрдкреЙрдЗрдВрдЯ рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИред рдпрд╣ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реЗ рдЖрдкрдХреЗ APIs рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рдЖрд╕рд╛рди рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд▓рд╛рдЗрдВрдЯ SDKs (рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╡рд┐рдХрд╛рд╕ рдХрд┐рдЯ) рднреА рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддрд╛ рд╣реИред

### API Gateways Types

* **HTTP API**: OIDC рдФрд░ OAuth2 рдЬреИрд╕реА рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдХрдо-рд▓реЗрдЯреЗрдВрд╕реА рдФрд░ рд▓рд╛рдЧрдд-рдХреБрд╢рд▓ REST APIs рдмрдирд╛рдПрдВ, рдФрд░ рдореВрд▓ CORS рд╕рдорд░реНрдердиред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ: Lambda, HTTP рдмреИрдХрдПрдВрдбред
* **WebSocket API**: рдЪреИрдЯ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдпрд╛ рдбреИрд╢рдмреЛрд░реНрдб рдЬреИрд╕реЗ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдХреЗ рдЙрдкрдпреЛрдЧ рдХреЗ рдорд╛рдорд▓реЛрдВ рдХреЗ рд▓рд┐рдП рд╕реНрдерд╛рдпреА рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ WebSocket API рдмрдирд╛рдПрдВред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ: Lambda, HTTP, AWS рд╕реЗрд╡рд╛рдПрдБред
* **REST API**: рдПрдХ REST API рд╡рд┐рдХрд╕рд┐рдд рдХрд░реЗрдВ рдЬрд╣рд╛рдБ рдЖрдк рдЕрдиреБрд░реЛрдз рдФрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкрд░ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ рд╕рд╛рде рд╣реА API рдкреНрд░рдмрдВрдзрди рдХреНрд╖рдорддрд╛рдПрдБред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ: Lambda, HTTP, AWS рд╕реЗрд╡рд╛рдПрдБред
* **REST API Private**: рдПрдХ REST API рдмрдирд╛рдПрдВ рдЬреЛ рдХреЗрд╡рд▓ рдПрдХ VPC рдХреЗ рднреАрддрд░ рд╕реЗ рд╕реБрд▓рдн рд╣реЛред

### API Gateway Main Components

1. **Resources**: API Gateway рдореЗрдВ, рд╕рдВрд╕рд╛рдзрди рд╡реЗ рдШрдЯрдХ рд╣реИрдВ рдЬреЛ **рдЖрдкрдХреЗ API рдХреА рд╕рдВрд░рдЪрдирд╛ рдмрдирд╛рддреЗ рд╣реИрдВ**ред рд╡реЗ рдЖрдкрдХреЗ API рдХреЗ **рд╡рд┐рднрд┐рдиреНрди рдкрдереЛрдВ рдпрд╛ рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕** рдХрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЖрдкрдХреЗ API рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд рд╡рд┐рднрд┐рдиреНрди рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдЕрдиреБрд░реВрдк рд╣реЛрддреЗ рд╣реИрдВред рдПрдХ рд╕рдВрд╕рд╛рдзрди рдкреНрд░рддреНрдпреЗрдХ рд╡рд┐рдзрд┐ (рдЬреИрд╕реЗ, GET, POST, PUT, DELETE) рд╣реИ **рдкреНрд░рддреНрдпреЗрдХ рдкрде рдХреЗ рднреАрддрд░** (/, рдпрд╛ /users, рдпрд╛ /user/{id}).
2. **Stages**: API Gateway рдореЗрдВ рд╕реНрдЯреЗрдЬ рдЖрдкрдХреЗ API рдХреЗ **рд╡рд┐рднрд┐рдиреНрди рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдпрд╛ рд╡рд╛рддрд╛рд╡рд░рдгреЛрдВ** рдХрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рд╡рд┐рдХрд╛рд╕, рд╕реНрдЯреЗрдЬрд┐рдВрдЧ, рдпрд╛ рдЙрддреНрдкрд╛рджрдиред рдЖрдк рд╕реНрдЯреЗрдЬ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдПрдХ рд╕рд╛рде рдХрдИ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХрд╛ рдкреНрд░рдмрдВрдзрди рдФрд░ рддреИрдирд╛рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**, рдЬрд┐рд╕рд╕реЗ рдЖрдк рдирдП рдлреАрдЪрд░реНрд╕ рдпрд╛ рдмрдЧ рдлрд┐рдХреНрд╕ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдмрд┐рдирд╛ рдЙрддреНрдкрд╛рджрди рд╡рд╛рддрд╛рд╡рд░рдг рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд┐рдПред рд╕реНрдЯреЗрдЬ **рд╕реНрдЯреЗрдЬ рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕** рдХрд╛ рднреА рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВ, рдЬреЛ рдХреБрдВрдЬреА-рдореВрд▓реНрдп рдЬреЛрдбрд╝реЗ рд╣реЛрддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдкрдХреЗ API рдХреЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЛ рд╡рд░реНрддрдорд╛рди рд╕реНрдЯреЗрдЬ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк рд╕реНрдЯреЗрдЬ рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ API рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╡рд┐рднрд┐рдиреНрди Lambda рдХрд╛рд░реНрдпреЛрдВ рдпрд╛ рдЕрдиреНрдп рдмреИрдХрдПрдВрдб рд╕реЗрд╡рд╛рдУрдВ рдХреА рдУрд░ рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
* рд╕реНрдЯреЗрдЬ API Gateway рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХреЗ URL рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рд╕рдВрдХреЗрддрд┐рдд рд╣реЛрддрд╛ рд╣реИред
3. **Authorizers**: API Gateway рдореЗрдВ рдСрдерд░рд╛рдЗрдЬрд░реНрд╕ рдЖрдкрдХреЗ API рддрдХ **рдкрд╣реБрдБрдЪ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реЛрддреЗ рд╣реИрдВ, рдХреЙрд▓рд░ рдХреА рдкрд╣рдЪрд╛рди рдХреЛ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рдХреЗ рдЕрдиреБрд░реЛрдз рдХреЛ рдЖрдЧреЗ рдмрдврд╝рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╕реЗ рдкрд╣рд▓реЗред рдЖрдк **AWS Lambda рдХрд╛рд░реНрдпреЛрдВ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд╕реНрдЯрдо рдСрдерд░рд╛рдЗрдЬрд░реНрд╕ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдЖрдк рдЕрдкрдиреА рд╕реНрд╡рдпрдВ рдХреА рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдФрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рд▓реЙрдЬрд┐рдХ рд▓рд╛рдЧреВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЬрдм рдПрдХ рдЕрдиреБрд░реЛрдз рдЖрддрд╛ рд╣реИ, API Gateway рдЕрдиреБрд░реЛрдз рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЯреЛрдХрди рдХреЛ Lambda рдСрдерд░рд╛рдЗрдЬрд╝рд░ рдХреЛ рдкрд╛рд╕ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдЯреЛрдХрди рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдПрдХ IAM рдиреАрддрд┐ рд▓реМрдЯрд╛рддрд╛ рд╣реИ рдЬреЛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддреА рд╣реИ рдХрд┐ рдХреЙрд▓рд░ рдХреЛ рдХреМрди рд╕реА рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИред API Gateway **рдмрд┐рд▓реНрдЯ-рдЗрди рдСрдерд░рд╛рдЗрдЬрд░реНрд╕** рдХрд╛ рднреА рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, рдЬреИрд╕реЗ **AWS Identity and Access Management (IAM)** рдФрд░ **Amazon Cognito**ред
4. **Resource Policy**: API Gateway рдореЗрдВ рдПрдХ рд╕рдВрд╕рд╛рдзрди рдиреАрддрд┐ рдПрдХ JSON рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рд╣реИ рдЬреЛ **рдЖрдкрдХреЗ API рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ**ред рдпрд╣ рдПрдХ IAM рдиреАрддрд┐ рдХреЗ рд╕рдорд╛рди рд╣реИ рд▓реЗрдХрд┐рди рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ API Gateway рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рдХреА рдЧрдИ рд╣реИред рдЖрдк рдПрдХ рд╕рдВрд╕рд╛рдзрди рдиреАрддрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдпрд╣ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рдЖрдкрдХреЗ API рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИ, рд╡реЗ рдХреМрди рд╕реА рд╡рд┐рдзрд┐рдпрд╛рдБ рдХреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рд╡реЗ рдХрд┐рди IP рдкрддреЗ рдпрд╛ VPCs рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред **рд╕рдВрд╕рд╛рдзрди рдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдСрдерд░рд╛рдЗрдЬрд░реНрд╕ рдХреЗ рд╕рд╛рде рд╕рдВрдпреЛрдЬрди рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ** рддрд╛рдХрд┐ рдЖрдкрдХреЗ API рдХреЗ рд▓рд┐рдП рдмрд╛рд░реАрдХ рдкрд╣реБрдБрдЪ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред
* рдкреНрд░рднрд╛рд╡ рдореЗрдВ рд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП API рдХреЛ **рд╕рдВрд╕рд╛рдзрди рдиреАрддрд┐ рдореЗрдВ рд╕рдВрд╢реЛрдзрди рдХреЗ рдмрд╛рдж рдлрд┐рд░ рд╕реЗ рддреИрдирд╛рдд** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

### Logging

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, **CloudWatch Logs** **рдмрдВрдж** рд╣реИрдВ, **Access Logging** **рдмрдВрдж** рд╣реИ, рдФрд░ **X-Ray рдЯреНрд░реЗрд╕рд┐рдВрдЧ** рднреА **рдмрдВрдж** рд╣реИред

### Enumeration

{% hint style="success" %}
Note that in both AWS apis to enumerate resources (**`apigateway`** and **`apigatewayv2`**) the only permission you need and the only read permission grantable is **`apigateway:GET`**, with that you can **enumerate everything.**
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %}
```bash
# Generic info
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-vpc-links

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
{% endtab %}
{% endtabs %}

## API рдЧреЗрдЯрд╡реЗ рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рд╛рдзрд┐рдХрд░рдг

### рд╕рдВрд╕рд╛рдзрди рдиреАрддрд┐

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рд╕рдВрд╕рд╛рдзрди рдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдпрд╣ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдХрд┐ рдХреМрди API рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИред\
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ **рдирд┐рд░реНрджрд┐рд╖реНрдЯ IP рдХреЙрд▓ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛** рдПрдВрдбрдкреЙрдЗрдВрдЯ `/resource_policy` рдХреЛ GET рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗред

<figure><img src="../../../.gitbook/assets/image (256).png" alt=""><figcaption></figcaption></figure>

### IAM рдкреНрд░рд╛рдзрд┐рдХрд░реНрддрд╛

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдПрдХ рдкрде (рдПрдХ рд╕рдВрд╕рд╛рдзрди) рдХреЗ рдЕрдВрджрд░ рдПрдХ рд╡рд┐рдзрд┐ рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП IAM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛред

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

рдЬрдм рдпрд╣ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЖрдк рдПрдВрдбрдкреЙрдЗрдВрдЯ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╕рдордп рддреНрд░реБрдЯрд┐ `{"message":"Missing Authentication Token"}` рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВрдЧреЗ рдмрд┐рдирд╛ рдХрд┐рд╕реА рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЗред

рдРрдк рджреНрд╡рд╛рд░рд╛ рдЕрдкреЗрдХреНрд╖рд┐рдд рдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ **curl** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИред
```bash
$ curl -X <method> https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource> --user <AWS_ACCESS_KEY>:<AWS_SECRET_KEY> --aws-sigv4 "aws:amz:<region>:execute-api"
```
рдПрдХ рдФрд░ рддрд░реАрдХрд╛ рд╣реИ **Postman** рдХреЗ рдЕрдВрджрд░ **`Authorization`** рдкреНрд░рдХрд╛рд░ **`AWS Signature`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ред

<figure><img src="../../../.gitbook/assets/image (168).png" alt=""><figcaption></figcaption></figure>

рдЬрд┐рд╕ рдЦрд╛рддреЗ рдХрд╛ рдЖрдк рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рдЙрд╕рдХреЗ accessKey рдФрд░ SecretKey рд╕реЗрдЯ рдХрд░реЗрдВ рдФрд░ рдЖрдк API endpoint рдХреЗ рдЦрд┐рд▓рд╛рдл рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рджреЛрдиреЛрдВ рд╡рд┐рдзрд┐рдпрд╛рдБ рдПрдХ **Authorization** **header** рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВрдЧреА рдЬреИрд╕реЗ:
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЕрдиреНрдп рдорд╛рдорд▓реЛрдВ рдореЗрдВ **Authorizer** рдХреЛ **рдЦрд░рд╛рдм рдХреЛрдбрд┐рдд** рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **Authorization header** рдХреЗ рдЕрдВрджрд░ **рдХреБрдЫ рднреА** рднреЗрдЬрдиреЗ рд╕реЗ **рдЫрд┐рдкреА рд╣реБрдИ рд╕рд╛рдордЧреНрд░реА** рдХреЛ **рджреЗрдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐** рдорд┐рд▓реЗрдЧреАред

### Request Signing Using Python
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### Custom Lambda Authorizer

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдПрдХ рд▓реИрдореНрдмреНрдбрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдП рдЬреЛ рдПрдХ рджрд┐рдП рдЧрдП рдЯреЛрдХрди рдХреЗ рдЖрдзрд╛рд░ рдкрд░ **IAM рдиреАрддрд┐** рд▓реМрдЯрд╛рдПрдЧрд╛ рдЬреЛ рдпрд╣ рджрд░реНрд╢рд╛рддреА рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **API рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХреГрдд рд╣реИ**ред\
рдЖрдк рдкреНрд░рддреНрдпреЗрдХ рд╕рдВрд╕рд╛рдзрди рд╡рд┐рдзрд┐ рдХреЛ рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рд▓реЗрдЦрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧреАред

<details>

<summary>Lambda Authorizer Code Example</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

рдЗрд╕реЗ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рд╕реЗ рдХреЙрд▓ рдХрд░реЗрдВ:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
Lambda рдХреЛрдб рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рдпрд╣ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХрдордЬреЛрд░ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ
{% endhint %}

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ рдПрдХ **deny policy рдЙрддреНрдкрдиреНрди рдФрд░ рд▓реМрдЯрд╛рдИ рдЬрд╛рддреА рд╣реИ** рддреЛ API Gateway рджреНрд╡рд╛рд░рд╛ рд▓реМрдЯрд╛рдпрд╛ рдЧрдпрд╛ рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢ рд╣реИ: `{"Message":"User is not authorized to access this resource with an explicit deny"}`

рдЗрд╕ рддрд░рд╣ рдЖрдк **рдЗрд╕ рдкреНрд░рд╛рдзрд┐рдХрд░рдг** рдХреА рдкрд╣рдЪрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

### рдЖрд╡рд╢реНрдпрдХ API рдХреБрдВрдЬреА

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ API рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗрдЯ рдХрд░реЗрдВ рдЬреЛ **рдПрдХ рдорд╛рдиреНрдп API рдХреБрдВрдЬреА** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛред

<figure><img src="../../../.gitbook/assets/image (88).png" alt=""><figcaption></figcaption></figure>

API Gateway рдкреЛрд░реНрдЯрд▓ рдореЗрдВ API рдХреБрдВрдЬреА рдЙрддреНрдкрдиреНрди рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдпрд╣ рднреА рд╕реЗрдЯ рдХрд░рдирд╛ рдХрд┐ рдЗрд╕реЗ рдХрд┐рддрдиреА рдмрд╛рд░ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдкреНрд░рддрд┐ рд╕реЗрдХрдВрдб рдЕрдиреБрд░реЛрдзреЛрдВ рдФрд░ рдкреНрд░рддрд┐ рдорд╛рд╣ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ)ред

API рдХреБрдВрдЬреА рдХреЛ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдЗрд╕реЗ **Usage Plan** рдореЗрдВ рдЬреЛрдбрд╝рдирд╛ рд╣реЛрдЧрд╛, рдпрд╣ рдЙрдкрдпреЛрдЧ рдпреЛрдЬрдирд╛ **API Stage** рдореЗрдВ рдЬреЛрдбрд╝реА рдЬрд╛рдиреА рдЪрд╛рд╣рд┐рдП рдФрд░ рд╕рдВрдмрдВрдзрд┐рдд API рд╕реНрдЯреЗрдЬ рдХреЛ **endpoint** рдХреЗ рд▓рд┐рдП рдПрдХ **method throttling** рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬреЛ API рдХреБрдВрдЬреА рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХрд░рддрд╛ рд╣реИ:

<figure><img src="../../../.gitbook/assets/image (198).png" alt=""><figcaption></figcaption></figure>

## рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдВрдЪ

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## рдкреНрд░рд┐рд╡реЗрд╕реНрдХ

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## рдкреЛрд╕реНрдЯ рдПрдХреНрд╕рдкреНрд▓реЛрдЗрдЯреЗрд╢рди

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

## рд╕реНрдерд┐рд░рддрд╛

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* **рд╣рдорд╕реЗ рдЬреБрдбрд╝реЗрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
