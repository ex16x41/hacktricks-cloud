# AWS - KMS Enum

{% hint style="success" %}
Nau캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) je predstavljen kao upravljana usluga, pojednostavljuju캖i proces za korisnike da **kreiraju i upravljaju customer master keys** (CMKs). Ovi CMKs su integralni u enkripciji korisni캜kih podataka. Zna캜ajna karakteristika AWS KMS je da su CMKs prete쬹o **osigurani hardverskim sigurnosnim modulima** (HSMs), pobolj코avaju캖i za코titu enkripcijskih klju캜eva.

KMS koristi **simetri캜nu kriptografiju**. Ovo se koristi za **enkripciju informacija u mirovanju** (na primer, unutar S3). Ako vam je potrebno da **enkriptujete informacije u tranzitu** morate koristiti ne코to poput **TLS**.

KMS je **usluga specifi캜na za region**.

**Administratori u Amazonu nemaju pristup va코im klju캜evima**. Oni ne mogu povratiti va코e klju캜eve i ne poma쬿 vam sa enkripcijom va코ih klju캜eva. AWS samo upravlja operativnim sistemom i osnovnom aplikacijom, a na nama je da upravljamo na코im enkripcijskim klju캜evima i kako se ti klju캜evi koriste.

**Customer Master Keys** (CMK): Mogu enkriptovati podatke do 4KB veli캜ine. Obi캜no se koriste za kreiranje, enkripciju i dekripciju DEKs (Data Encryption Keys). Zatim se DEKs koriste za enkripciju podataka.

Customer master key (CMK) je logi캜ka reprezentacija master klju캜a u AWS KMS. Pored identifikatora master klju캜a i drugih metapodataka, uklju캜uju캖i datum kreiranja, opis i stanje klju캜a, **CMK sadr쬴 materijal klju캜a koji se koristi za enkripciju i dekripciju podataka**. Kada kreirate CMK, po defaultu, AWS KMS generi코e materijal klju캜a za taj CMK. Me캠utim, mo쬰te odabrati da kreirate CMK bez materijala klju캜a i zatim uvezete svoj materijal klju캜a u taj CMK.

Postoje 2 tipa master klju캜eva:

* **AWS managed CMKs: Koriste ih druge usluge za enkripciju podataka**. Koristi ih usluga koja ih je kreirala u regionu. Kreiraju se prvi put kada implementirate enkripciju u toj usluzi. Rotiraju se svakih 3 godine i nije mogu캖e promeniti ih.
* **Customer manager CMKs**: Fleksibilnost, rotacija, konfigurisani pristup i politika klju캜a. Omogu캖ava i onemogu캖ava klju캜eve.

**Envelope Encryption** u kontekstu Key Management Service (KMS): Dvostepeni hijerarhijski sistem za **enkripciju podataka sa data key i zatim enkripciju data key sa master key**.

### Key Policies

Ovo defini코e **ko mo쬰 koristiti i pristupiti klju캜u u KMS**.

Po **defaultu:**

*   Daje **AWS nalogu koji poseduje KMS klju캜 pun pristup** KMS klju캜u.

Za razliku od drugih AWS resursnih politika, AWS **KMS key policy automatski ne daje dozvolu nalogu ili bilo kojem od njegovih korisnika**. Da bi se dozvolila dozvola administratorima naloga, **politika klju캜a mora uklju캜ivati eksplicitnu izjavu** koja pru쬬 ovu dozvolu, kao ova.

* Bez dozvole za nalog(`"AWS": "arn:aws:iam::111122223333:root"`) IAM dozvole ne캖e raditi.
*   Omogu캖ava nalogu da koristi IAM politike za dozvolu pristupa KMS klju캜u, pored politike klju캜a.

**Bez ove dozvole, IAM politike koje dozvoljavaju pristup klju캜u su neefikasne**, iako su IAM politike koje zabranjuju pristup klju캜u i dalje efikasne.
* Smanjuje rizik da klju캜 postane neupotrebljiv daju캖i dozvolu za kontrolu pristupa administratorima naloga, uklju캜uju캖i root korisnika naloga, koji ne mo쬰 biti obrisan.

**Default policy** primer:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Ako je **nalog dozvoljen** (`"arn:aws:iam::111122223333:root"`) **principal** iz naloga **캖e i dalje trebati IAM dozvole** da koristi KMS klju캜. Me캠utim, ako je **ARN** uloge na primer **specifi캜no dozvoljen** u **Key Policy**, ta uloga **ne treba IAM dozvole**.
{% endhint %}

<details>

<summary>Detalji Politike</summary>

Svojstva politike:

* JSON baziran dokument
* Resource --> Pogo캠eni resursi (mo쬰 biti "\*")
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (dozvole)
* Effect --> Allow/Deny
* Principal --> pogo캠eni arn
* Conditions (opciono) --> Uslov za davanje dozvola

Grants:

* Dozvoljava delegiranje va코ih dozvola drugom AWS principalu unutar va코eg AWS naloga. Morate ih kreirati koriste캖i AWS KMS API-je. Mo쬰 se navesti CMK identifikator, principal kome se daje dozvola i potreban nivo operacije (Decrypt, Encrypt, GenerateDataKey...)
* Nakon kreiranja granta, izdaju se GrantToken i GrantID

**Pristup**:

* Preko **key policy** -- Ako ovo postoji, ima **prednost** nad IAM politikom
* Preko **IAM politike**
* Preko **grants**

</details>

### Key Administrators

Key administrator po defaultu:

* Ima pristup za upravljanje KMS-om, ali ne i za 코ifrovanje ili de코ifrovanje podataka
* Samo IAM korisnici i uloge mogu biti dodati na listu Key Administrators (ne grupe)
* Ako se koristi eksterni CMK, Key Administrators imaju dozvolu da uvezu klju캜ni materijal

### Rotacija CMKs

* 맚o du쬰 isti klju캜 ostaje na mestu, vi코e podataka se 코ifruje tim klju캜em, i ako taj klju캜 bude ugro쬰n, 코ira oblast podataka je u riziku. Pored toga, 코to je klju캜 du쬰 aktivan, ve캖a je verovatno캖a da 캖e biti ugro쬰n.
* **KMS rotira korisni캜ke klju캜eve svakih 365 dana** (ili mo쬰te ru캜no izvr코iti proces kad god 쬰lite) i **klju캜eve kojima upravlja AWS svakih 3 godine** i ovo vreme se ne mo쬰 promeniti.
* **Stariji klju캜evi se zadr쬬vaju** za de코ifrovanje podataka koji su 코ifrovani pre rotacije
* U slu캜aju proboja, rotacija klju캜a ne캖e ukloniti pretnju jer 캖e biti mogu캖e de코ifrovati sve podatke 코ifrovane ugro쬰nim klju캜em. Me캠utim, **novi podaci 캖e biti 코ifrovani novim klju캜em**.
* Ako je **CMK** u stanju **disabled** ili **pending** **deletion**, KMS **ne캖e izvr코iti rotaciju klju캜a** dok se CMK ne ponovo omogu캖i ili dok se brisanje ne otka쬰.

#### Ru캜na rotacija

* Potreban je **novi CMK**, zatim se kreira novi CMK-ID, tako da 캖ete morati **a쬿rirati** svaku **aplikaciju** da **referencira** novi CMK-ID.
* Da bi ovaj proces bio lak코i, mo쬰te **koristiti alias-e za referenciranje key-id** i zatim samo a쬿rirati klju캜 na koji alias referencira.
* Potrebno je **zadr쬬ti stare klju캜eve za de코ifrovanje starih fajlova** 코ifrovanih njima.

Mo쬰te uvesti klju캜eve iz va코e on-premises klju캜ne infrastrukture.

### Ostale relevantne informacije o KMS-u

KMS se napla캖uje po broju zahteva za 코ifrovanje/de코ifrovanje primljenih od svih servisa mese캜no.

KMS ima punu reviziju i uskla캠enost **integrisanu sa CloudTrail**; ovde mo쬰te revidirati sve promene izvr코ene na KMS-u.

Sa KMS politikom mo쬰te uraditi slede캖e:

* Ograni캜iti ko mo쬰 kreirati data keys i koji servisi imaju pristup da koriste te klju캜eve
* Ograni캜iti pristup sistemima samo za 코ifrovanje, samo za de코ifrovanje ili oba
* Definisati omogu캖avanje sistemima da pristupaju klju캜evima preko regiona (iako se ne preporu캜uje jer 캖e kvar u regionu koji hostuje KMS uticati na dostupnost sistema u drugim regionima).

Ne mo쬰te sinhronizovati ili premestiti/kopirati klju캜eve preko regiona; mo쬰te samo definisati pravila za omogu캖avanje pristupa preko regiona.

### Enumeration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Reference

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Nau캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
