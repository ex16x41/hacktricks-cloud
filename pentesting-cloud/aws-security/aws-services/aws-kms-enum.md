# AWS - KMS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS - Usluga upravljanja kljuÄevima

AWS Usluga upravljanja kljuÄevima (AWS KMS) se predstavlja kao upravljana usluga, pojednostavljujuÄ‡i proces za korisnike da **kreiraju i upravljaju glavnim kljuÄevima kupca** (CMK). Ovi CMK-ovi su kljuÄni za enkripciju korisniÄkih podataka. ZnaÄajna karakteristika AWS KMS-a je da su CMK-ovi preteÅ¾no **zaÅ¡tiÄ‡eni hardverskim bezbednosnim modulima** (HSM), Å¡to poboljÅ¡ava zaÅ¡titu enkripcijskih kljuÄeva.

KMS koristi **simetriÄnu kriptografiju**. Ovo se koristi za **enkripciju informacija u mirovanju** (na primer, unutar S3). Ako treba da **enkriptujeÅ¡ informacije u prenosu**, moraÅ¡ koristiti neÅ¡to poput **TLS**.

KMS je **usluga specifiÄna za region**.

**Administratori u Amazonu nemaju pristup tvojim kljuÄevima**. Ne mogu da povrate tvoje kljuÄeve i ne pomaÅ¾u ti u enkripciji tvojih kljuÄeva. AWS jednostavno upravlja operativnim sistemom i osnovnom aplikacijom, a na nama je da upravljamo naÅ¡im enkripcijskim kljuÄevima i upravljamo kako se ti kljuÄevi koriste.

**Glavni kljuÄevi kupca** (CMK): Mogu enkriptovati podatke do 4KB veliÄine. ObiÄno se koriste za kreiranje, enkripciju i dekripciju DEK-ova (KljuÄevi za enkripciju podataka). Zatim se DEK-ovi koriste za enkripciju podataka.

Glavni kljuÄ kupca (CMK) je logiÄka reprezentacija glavnog kljuÄa u AWS KMS-u. Pored identifikatora glavnog kljuÄa i drugih metapodataka, ukljuÄujuÄ‡i datum kreiranja, opis i stanje kljuÄa, **CMK sadrÅ¾i materijal kljuÄa koji se koristi za enkripciju i dekripciju podataka**. Kada kreiraÅ¡ CMK, po defaultu, AWS KMS generiÅ¡e materijal kljuÄa za taj CMK. MeÄ‘utim, moÅ¾eÅ¡ izabrati da kreiraÅ¡ CMK bez materijala kljuÄa i zatim uvezeÅ¡ svoj materijal kljuÄa u taj CMK.

Postoje 2 tipa glavnih kljuÄeva:

* **AWS upravljani CMK-ovi: Koriste ih druge usluge za enkripciju podataka**. Koristi ih usluga koja ih je kreirala u regionu. Kreiraju se prvi put kada implementiraÅ¡ enkripciju u toj usluzi. Rotiraju se svake 3 godine i nije moguÄ‡e promeniti ih.
* **CMK-ovi koje upravlja kupac**: Fleksibilnost, rotacija, konfigurisani pristup i politika kljuÄeva. OmoguÄ‡avaju i onemoguÄ‡avaju kljuÄeve.

**Enkripcija u omotu** u kontekstu Usluge upravljanja kljuÄevima (KMS): Dvostepeni hijerarhijski sistem za **enkripciju podataka sa kljuÄem podataka i zatim enkripciju kljuÄa podataka sa glavnim kljuÄem**.

### Politike kljuÄeva

Ove definiÅ¡u **ko moÅ¾e koristiti i pristupati kljuÄu u KMS-u**.

Po **defaultu:**

*   Daje **IAM-u** **AWS naloga koji poseduje KMS kljuÄ pristup** za upravljanje pristupom KMS kljuÄu putem IAM-a.

Za razliku od drugih politika resursa AWS-a, politika **KMS kljuÄa ne daje automatski dozvolu bilo kojem od principala naloga**. Da bi se dala dozvola administratorima naloga, **politika kljuÄa mora ukljuÄivati eksplicitnu izjavu** koja pruÅ¾a ovu dozvolu, poput ove.

* Bez omoguÄ‡avanja naloga(`"AWS": "arn:aws:iam::111122223333:root"`) IAM dozvole neÄ‡e raditi.
*   **OmoguÄ‡ava nalogu da koristi IAM politike** za omoguÄ‡avanje pristupa KMS kljuÄu, pored politike kljuÄa.

**Bez ove dozvole, IAM politike koje omoguÄ‡avaju pristup kljuÄu su neefikasne**, iako su IAM politike koje odbijaju pristup kljuÄu i dalje efikasne.
* **Smanjuje rizik da kljuÄ postane neuredan** dajuÄ‡i dozvolu za kontrolu pristupa administratorima naloga, ukljuÄujuÄ‡i korisnika root naloga, koji ne moÅ¾e biti obrisan.

**Primer default politike**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Ako je **nalog dozvoljen** (`"arn:aws:iam::111122223333:root"`), **principal** iz naloga **Ä‡e i dalje trebati IAM dozvole** da koristi KMS kljuÄ. MeÄ‘utim, ako je **ARN** uloge, na primer, **specifiÄno dozvoljen** u **Politici kljuÄeva**, ta uloga **ne treba IAM dozvole**.
{% endhint %}

<details>

<summary>Detalji politike</summary>

Osobine politike:

* Dokument zasnovan na JSON-u
* Resurs --> PogoÄ‘eni resursi (moÅ¾e biti "\*")
* Akcija --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (dozvole)
* Efekat --> Dozvoli/OnemoguÄ‡i
* Principal --> arn pogoÄ‘en
* Uslovi (opciono) --> Uslov za davanje dozvola

Grantovi:

* Dozvoljava delegiranje vaÅ¡ih dozvola drugom AWS principalu unutar vaÅ¡eg AWS naloga. Morate ih kreirati koristeÄ‡i AWS KMS API-je. MoÅ¾e se navesti identifikator CMK, principal koji dobija grant i potrebni nivo operacije (Decrypt, Encrypt, GenerateDataKey...)
* Nakon Å¡to je grant kreiran, izdaju se GrantToken i GrantID

**Pristup**:

* Putem **politike kljuÄeva** -- Ako ovo postoji, ovo ima **prioritet** nad IAM politikom
* Putem **IAM politike**
* Putem **grantova**

</details>

### Administratori kljuÄeva

Administrator kljuÄeva po defaultu:

* Ima pristup za upravljanje KMS-om, ali ne i za enkripciju ili dekripciju podataka
* Samo IAM korisnici i uloge mogu biti dodati na listu administratora kljuÄeva (ne grupe)
* Ako se koristi eksterni CMK, administratori kljuÄeva imaju dozvolu da uvezu materijal kljuÄa

### Rotacija CMK-ova

* Å to duÅ¾e ostane isti kljuÄ, to se viÅ¡e podataka enkriptuje tim kljuÄem, a ako taj kljuÄ bude kompromitovan, Å¡ira oblast podataka je u riziku. Pored toga, Å¡to je kljuÄ duÅ¾e aktivan, verovatnoÄ‡a da Ä‡e biti kompromitovan raste.
* **KMS rotira korisniÄke kljuÄeve svake 365 dana** (ili moÅ¾ete izvrÅ¡iti proces ruÄno kad god Å¾elite) i **kljuÄeve koje upravlja AWS svake 3 godine** i ovaj put se ne moÅ¾e promeniti.
* **Stariji kljuÄevi se Äuvaju** za dekripciju podataka koji su enkriptovani pre rotacije
* U sluÄaju kompromitacije, rotacija kljuÄa neÄ‡e ukloniti pretnju jer Ä‡e biti moguÄ‡e dekriptovati sve podatke enkriptovane kompromitovanim kljuÄem. MeÄ‘utim, **novi podaci Ä‡e biti enkriptovani novim kljuÄem**.
* Ako je **CMK** u stanju **onemoguÄ‡en** ili **na Äekanju** **brisanja**, KMS **neÄ‡e izvrÅ¡iti rotaciju kljuÄa** dok se CMK ponovo ne omoguÄ‡i ili brisanje ne otkaÅ¾e.

#### RuÄna rotacija

* **Novi CMK treba da bude kreiran**, zatim se kreira novi CMK-ID, tako da Ä‡ete morati da **aÅ¾urirate** svaku **aplikaciju** da **referencira** novi CMK-ID.
* Da biste olakÅ¡ali ovaj proces, moÅ¾ete **koristiti alias za referenciranje ID kljuÄa** i zatim samo aÅ¾urirati kljuÄ na koji alias se odnosi.
* Morate **Äuvati stare kljuÄeve za dekripciju starih fajlova** enkriptovanih tim kljuÄem.

MoÅ¾ete uvesti kljuÄeve iz vaÅ¡e lokalne infrastrukture kljuÄeva.

### Druge relevantne KMS informacije

KMS se naplaÄ‡uje po broju zahteva za enkripciju/dekripciju primljenih od svih usluga meseÄno.

KMS ima potpunu reviziju i usklaÄ‘enost **integraciju sa CloudTrail**; ovde moÅ¾ete revizirati sve promene izvrÅ¡ene na KMS-u.

Sa KMS politikom moÅ¾ete uraditi sledeÄ‡e:

* OgraniÄiti ko moÅ¾e kreirati kljuÄeve podataka i koje usluge imaju pristup koriÅ¡Ä‡enju ovih kljuÄeva
* OgraniÄiti pristup sistemima samo za enkripciju, samo za dekripciju ili oboje
* Definisati da omoguÄ‡ite sistemima pristup kljuÄevima Å¡irom regiona (iako se ne preporuÄuje jer bi kvar u regionu koji hostuje KMS uticao na dostupnost sistema u drugim regionima).

Ne moÅ¾ete sinhronizovati ili premestiti/kopirati kljuÄeve izmeÄ‘u regiona; moÅ¾ete samo definisati pravila za omoguÄ‡avanje pristupa izmeÄ‘u regiona.

### Enumeracija
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
