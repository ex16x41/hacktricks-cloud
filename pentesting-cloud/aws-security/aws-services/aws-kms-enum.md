# AWS - KMS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS - Usluga upravljanja klju캜evima

AWS Usluga upravljanja klju캜evima (AWS KMS) se predstavlja kao upravljana usluga, pojednostavljuju캖i proces za korisnike da **kreiraju i upravljaju glavnim klju캜evima kupca** (CMK). Ovi CMK-ovi su klju캜ni za enkripciju korisni캜kih podataka. Zna캜ajna karakteristika AWS KMS-a je da su CMK-ovi prete쬹o **za코ti캖eni hardverskim bezbednosnim modulima** (HSM), 코to pobolj코ava za코titu enkripcijskih klju캜eva.

KMS koristi **simetri캜nu kriptografiju**. Ovo se koristi za **enkripciju informacija u mirovanju** (na primer, unutar S3). Ako treba da **enkriptuje코 informacije u prenosu**, mora코 koristiti ne코to poput **TLS**.

KMS je **usluga specifi캜na za region**.

**Administratori u Amazonu nemaju pristup tvojim klju캜evima**. Ne mogu da povrate tvoje klju캜eve i ne poma쬿 ti u enkripciji tvojih klju캜eva. AWS jednostavno upravlja operativnim sistemom i osnovnom aplikacijom, a na nama je da upravljamo na코im enkripcijskim klju캜evima i upravljamo kako se ti klju캜evi koriste.

**Glavni klju캜evi kupca** (CMK): Mogu enkriptovati podatke do 4KB veli캜ine. Obi캜no se koriste za kreiranje, enkripciju i dekripciju DEK-ova (Klju캜evi za enkripciju podataka). Zatim se DEK-ovi koriste za enkripciju podataka.

Glavni klju캜 kupca (CMK) je logi캜ka reprezentacija glavnog klju캜a u AWS KMS-u. Pored identifikatora glavnog klju캜a i drugih metapodataka, uklju캜uju캖i datum kreiranja, opis i stanje klju캜a, **CMK sadr쬴 materijal klju캜a koji se koristi za enkripciju i dekripciju podataka**. Kada kreira코 CMK, po defaultu, AWS KMS generi코e materijal klju캜a za taj CMK. Me캠utim, mo쬰코 izabrati da kreira코 CMK bez materijala klju캜a i zatim uveze코 svoj materijal klju캜a u taj CMK.

Postoje 2 tipa glavnih klju캜eva:

* **AWS upravljani CMK-ovi: Koriste ih druge usluge za enkripciju podataka**. Koristi ih usluga koja ih je kreirala u regionu. Kreiraju se prvi put kada implementira코 enkripciju u toj usluzi. Rotiraju se svake 3 godine i nije mogu캖e promeniti ih.
* **CMK-ovi koje upravlja kupac**: Fleksibilnost, rotacija, konfigurisani pristup i politika klju캜eva. Omogu캖avaju i onemogu캖avaju klju캜eve.

**Envelop Enkripcija** u kontekstu Usluge upravljanja klju캜evima (KMS): Dvostepeni hijerarhijski sistem za **enkripciju podataka sa klju캜em podataka i zatim enkripciju klju캜a podataka sa glavnim klju캜em**.

### Politike klju캜eva

Ove defini코u **ko mo쬰 koristiti i pristupiti klju캜u u KMS-u**.

Po **defaultu:**

*   Daje **AWS nalogu koji poseduje KMS klju캜 pun pristup** KMS klju캜u.

Za razliku od drugih AWS politika resursa, AWS **politika KMS klju캜a ne daje automatski dozvolu nalogu ili bilo kojem od njegovih korisnika**. Da bi se dala dozvola administratorima naloga, **politika klju캜a mora uklju캜ivati eksplicitnu izjavu** koja pru쬬 ovu dozvolu, poput ove.

* Bez omogu캖avanja naloga(`"AWS": "arn:aws:iam::111122223333:root"`) IAM dozvole ne캖e raditi.
*   **Omogu캖ava nalogu da koristi IAM politike** za omogu캖avanje pristupa KMS klju캜u, pored politike klju캜a.

**Bez ove dozvole, IAM politike koje omogu캖avaju pristup klju캜u su neefikasne**, iako su IAM politike koje odbijaju pristup klju캜u i dalje efikasne.
* **Smanjuje rizik da klju캜 postane neuredan** daju캖i dozvolu za kontrolu pristupa administratorima naloga, uklju캜uju캖i korisnika root naloga, koji ne mo쬰 biti obrisan.

**Primer default politike**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Ako je **nalog dozvoljen** (`"arn:aws:iam::111122223333:root"`), **principal** iz naloga **캖e i dalje trebati IAM dozvole** da koristi KMS klju캜. Me캠utim, ako je **ARN** uloge, na primer, **specifi캜no dozvoljen** u **Politici klju캜eva**, ta uloga **ne treba IAM dozvole**.
{% endhint %}

<details>

<summary>Detalji politike</summary>

Osobine politike:

* Dokument zasnovan na JSON-u
* Resurs --> Pogo캠eni resursi (mo쬰 biti "\*")
* Akcija --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (dozvole)
* Efekat --> Dozvoli/Onemogu캖i
* Principal --> arn pogo캠en
* Uslovi (opciono) --> Uslov za davanje dozvola

Grantovi:

* Dozvoljava delegiranje va코ih dozvola drugom AWS principalu unutar va코eg AWS naloga. Morate ih kreirati koriste캖i AWS KMS API-je. Mo쬰 se navesti identifikator CMK, principal koji dobija grant i potrebni nivo operacije (Decrypt, Encrypt, GenerateDataKey...)
* Nakon 코to je grant kreiran, izdaju se GrantToken i GrantID

**Pristup**:

* Putem **politike klju캜eva** -- Ako ovo postoji, ovo ima **prioritet** nad IAM politikom
* Putem **IAM politike**
* Putem **grantova**

</details>

### Administratori klju캜eva

Administrator klju캜eva po defaultu:

* Ima pristup za upravljanje KMS-om, ali ne i za enkripciju ili dekripciju podataka
* Samo IAM korisnici i uloge mogu biti dodati na listu administratora klju캜eva (ne grupe)
* Ako se koristi eksterni CMK, administratori klju캜eva imaju dozvolu da uvezu materijal klju캜a

### Rotacija CMK-ova

* 맚o du쬰 ostane isti klju캜, to vi코e podataka se enkriptuje tim klju캜em, a ako taj klju캜 bude kompromitovan, 코ira oblast podataka je u riziku. Pored toga, 코to du쬰 klju캜 bude aktivan, verovatno캖a da 캖e biti kompromitovan raste.
* **KMS rotira korisni캜ke klju캜eve svake 365 dana** (ili mo쬰te izvr코iti proces ru캜no kad god 쬰lite) i **klju캜evi koje upravlja AWS svake 3 godine** i ovaj put se ne mo쬰 promeniti.
* **Stariji klju캜evi se 캜uvaju** za dekripciju podataka koji su enkriptovani pre rotacije
* U slu캜aju kompromitacije, rotacija klju캜a ne캖e ukloniti pretnju jer 캖e biti mogu캖e dekriptovati sve podatke enkriptovane kompromitovanim klju캜em. Me캠utim, **novi podaci 캖e biti enkriptovani novim klju캜em**.
* Ako je **CMK** u stanju **onemogu캖en** ili **na 캜ekanju** **brisanja**, KMS **ne캖e izvr코iti rotaciju klju캜a** dok se CMK ponovo ne omogu캖i ili brisanje ne otka쬰.

#### Ru캜na rotacija

* **Novi CMK treba da bude kreiran**, zatim se kreira novi CMK-ID, tako da 캖ete morati da **a쬿rirate** svaku **aplikaciju** da **referencira** novi CMK-ID.
* Da biste olak코ali ovaj proces, mo쬰te **koristiti alias za referenciranje ID-a klju캜a** i zatim samo a쬿rirati klju캜 na koji alias se odnosi.
* Morate **캜uvati stare klju캜eve za dekripciju starih fajlova** enkriptovanih tim klju캜em.

Mo쬰te uvesti klju캜eve iz va코e lokalne infrastrukture klju캜eva.

### Druge relevantne KMS informacije

KMS se napla캖uje po broju zahteva za enkripciju/dekripciju primljenih od svih usluga mese캜no.

KMS ima potpunu reviziju i uskla캠enost **integraciju sa CloudTrail**; ovde mo쬰te revizirati sve promene izvr코ene na KMS-u.

Sa KMS politikom mo쬰te u캜initi slede캖e:

* Ograni캜iti ko mo쬰 kreirati klju캜eve podataka i koje usluge imaju pristup kori코캖enju ovih klju캜eva
* Ograni캜iti pristup sistemima samo za enkripciju, samo za dekripciju ili oboje
* Definisati da omogu캖ite sistemima pristup klju캜evima 코irom regiona (iako se ne preporu캜uje jer 캖e kvar u regionu koji hostuje KMS uticati na dostupnost sistema u drugim regionima).

Ne mo쬰te sinhronizovati ili premestiti/kopirati klju캜eve izme캠u regiona; mo쬰te samo definisati pravila za omogu캖avanje pristupa izme캠u regiona.

### Enumeracija
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
