# AWS - KMS Enum

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Bize katÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n,** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek.

</details>
{% endhint %}

## KMS - Anahtar YÃ¶netim Servisi

AWS Anahtar YÃ¶netim Servisi (AWS KMS), kullanÄ±cÄ±larÄ±n **mÃ¼ÅŸteri anahtarlarÄ±nÄ± oluÅŸturmasÄ±nÄ± ve yÃ¶netmesini** kolaylaÅŸtÄ±ran bir yÃ¶netilen hizmet olarak sunulmaktadÄ±r. Bu mÃ¼ÅŸteri anahtarlarÄ±, kullanÄ±cÄ± verilerinin ÅŸifrelenmesinde kritik bir rol oynamaktadÄ±r. AWS KMS'in dikkat Ã§ekici bir Ã¶zelliÄŸi, mÃ¼ÅŸteri anahtarlarÄ±nÄ±n Ã§oÄŸunlukla **donanÄ±m gÃ¼venlik modÃ¼lleri** (HSM'ler) tarafÄ±ndan **gÃ¼vence altÄ±na alÄ±nmasÄ±dÄ±r**, bu da ÅŸifreleme anahtarlarÄ±nÄ±n korunmasÄ±nÄ± artÄ±rÄ±r.

KMS, **simetrik kriptografi** kullanÄ±r. Bu, **verileri dinlenme halinde ÅŸifrelemek iÃ§in** (Ã¶rneÄŸin, bir S3 iÃ§inde) kullanÄ±lÄ±r. EÄŸer **verileri iletim sÄ±rasÄ±nda ÅŸifrelemeniz** gerekiyorsa, **TLS** gibi bir ÅŸey kullanmalÄ±sÄ±nÄ±z.

KMS, **bÃ¶lgeye Ã¶zgÃ¼ bir hizmettir**.

**Amazon'daki yÃ¶neticiler anahtarlarÄ±nÄ±za eriÅŸemez**. AnahtarlarÄ±nÄ±zÄ± kurtaramazlar ve anahtarlarÄ±nÄ±zÄ±n ÅŸifrelenmesine yardÄ±mcÄ± olamazlar. AWS, yalnÄ±zca iÅŸletim sistemini ve altÄ±nda yatan uygulamayÄ± yÃ¶netir; anahtarlarÄ±mÄ±zÄ± yÃ¶netmek ve bu anahtarlarÄ±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± yÃ¶netmek bizim sorumluluÄŸumuzdur.

**MÃ¼ÅŸteri AnahtarlarÄ±** (CMK): Boyutu 4KB'ye kadar olan verileri ÅŸifreleyebilir. Genellikle DEK'leri (Veri Åifreleme AnahtarlarÄ±) oluÅŸturmak, ÅŸifrelemek ve ÅŸifre Ã§Ã¶zmek iÃ§in kullanÄ±lÄ±r. Daha sonra DEK'ler verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r.

Bir mÃ¼ÅŸteri anahtarÄ±nÄ±n (CMK) AWS KMS'deki anahtarÄ±n mantÄ±ksal bir temsili olduÄŸunu belirtmek gerekir. AnahtarÄ±n tanÄ±mlayÄ±cÄ±larÄ± ve diÄŸer meta verilerin yanÄ± sÄ±ra, **CMK, verileri ÅŸifrelemek ve ÅŸifre Ã§Ã¶zmek iÃ§in kullanÄ±lan anahtar materyalini iÃ§erir**. Bir CMK oluÅŸturduÄŸunuzda, varsayÄ±lan olarak AWS KMS, o CMK iÃ§in anahtar materyalini oluÅŸturur. Ancak, anahtar materyali olmadan bir CMK oluÅŸturmayÄ± seÃ§ebilir ve ardÄ±ndan kendi anahtar materyalinizi o CMK'ye iÃ§e aktarabilirsiniz.

Ä°ki tÃ¼r anahtar vardÄ±r:

* **AWS yÃ¶netilen CMK'ler: DiÄŸer hizmetler tarafÄ±ndan verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r**. BÃ¶lgedeki hizmet tarafÄ±ndan oluÅŸturulmuÅŸtur. Bu hizmette ÅŸifrelemeyi uyguladÄ±ÄŸÄ±nÄ±zda ilk kez oluÅŸturulurlar. Her 3 yÄ±lda bir dÃ¶ner ve deÄŸiÅŸtirilmesi mÃ¼mkÃ¼n deÄŸildir.
* **MÃ¼ÅŸteri yÃ¶netici CMK'ler**: Esneklik, dÃ¶ngÃ¼, yapÄ±landÄ±rÄ±labilir eriÅŸim ve anahtar politikasÄ±. AnahtarlarÄ± etkinleÅŸtirme ve devre dÄ±ÅŸÄ± bÄ±rakma.

**Zarf Åifrelemesi**, Anahtar YÃ¶netim Servisi (KMS) baÄŸlamÄ±nda: **verileri veri anahtarÄ± ile ÅŸifrelemek ve ardÄ±ndan veri anahtarÄ±nÄ± anahtar ile ÅŸifrelemek iÃ§in iki katmanlÄ± hiyerarÅŸi sistemi**.

### Anahtar PolitikalarÄ±

Bunlar, **KMS'de bir anahtarÄ± kimin kullanabileceÄŸini ve eriÅŸebileceÄŸini tanÄ±mlar**.

**VarsayÄ±lan olarak:**

*   KMS anahtarÄ±nÄ± yÃ¶neten **AWS hesabÄ±nÄ±n IAM'ine** eriÅŸim verir.

DiÄŸer AWS kaynak politikalarÄ±nÄ±n aksine, bir AWS **KMS anahtar politikasÄ±, hesabÄ±n herhangi bir ilkesine otomatik olarak izin vermez**. Hesap yÃ¶neticilerine izin vermek iÃ§in, **anahtar politikasÄ±nÄ±n bu izni saÄŸlayan aÃ§Ä±k bir ifadeyi iÃ§ermesi gerekir**, bu ÅŸekilde.

* Hesaba izin vermeden (`"AWS": "arn:aws:iam::111122223333:root"`) IAM izinleri Ã§alÄ±ÅŸmaz.
*   **Anahtar politikasÄ±na ek olarak, KMS anahtarÄ±na eriÅŸim saÄŸlamak iÃ§in IAM politikalarÄ±nÄ± kullanmasÄ±na izin verir**.

**Bu izin olmadan, anahtara eriÅŸimi saÄŸlayan IAM politikalarÄ± etkisizdir**, ancak anahtara eriÅŸimi reddeden IAM politikalarÄ± hala etkilidir.
* AnahtarÄ±n yÃ¶netilemez hale gelme riskini **hesap yÃ¶neticilerine, silinemez olan hesap kÃ¶k kullanÄ±cÄ±sÄ± da dahil olmak Ã¼zere, eriÅŸim kontrol izni vererek azaltÄ±r**.

**VarsayÄ±lan politika** Ã¶rneÄŸi:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
EÄŸer **hesaba izin verilmiÅŸse** (`"arn:aws:iam::111122223333:root"`), hesaptan bir **temsilcinin** KMS anahtarÄ±nÄ± kullanabilmesi iÃ§in **IAM izinlerine** ihtiyacÄ± olacaktÄ±r. Ancak, eÄŸer bir rolÃ¼n **ARN'si** Ã¶rneÄŸin **Anahtar PolitikasÄ±nda Ã¶zel olarak izin verilmiÅŸse**, o rol **IAM izinlerine ihtiyaÃ§ duymaz**.
{% endhint %}

<details>

<summary>Politika DetaylarÄ±</summary>

Bir politikanÄ±n Ã¶zellikleri:

* JSON tabanlÄ± belge
* Kaynak --> Etkilenen kaynaklar (yÄ±ldÄ±z "\*" olabilir)
* Eylem --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (izinler)
* Etki --> Ä°zin Ver / Reddet
* Temsilci --> etkilenen arn
* KoÅŸullar (isteÄŸe baÄŸlÄ±) --> Ä°zinleri vermek iÃ§in koÅŸul

Ä°zinler:

* AWS hesabÄ±nÄ±zdaki baÅŸka bir AWS temsilcisine izinlerinizi devretmenizi saÄŸlar. BunlarÄ± AWS KMS API'lerini kullanarak oluÅŸturmanÄ±z gerekir. CMK tanÄ±mlayÄ±cÄ±sÄ±, grantee temsilcisi ve gerekli iÅŸlem seviyesi (Decrypt, Encrypt, GenerateDataKey...) belirtilebilir.
* Ä°zin oluÅŸturulduktan sonra bir GrantToken ve GrantID verilir.

**EriÅŸim**:

* **anahtar politikasÄ±** aracÄ±lÄ±ÄŸÄ±yla -- EÄŸer bu mevcutsa, bu **IAM politikasÄ±ndan Ã¶nceliklidir**
* **IAM politikasÄ±** aracÄ±lÄ±ÄŸÄ±yla
* **izinler** aracÄ±lÄ±ÄŸÄ±yla

</details>

### Anahtar YÃ¶neticileri

VarsayÄ±lan olarak anahtar yÃ¶neticileri:

* KMS'i yÃ¶netme eriÅŸimine sahiptir ancak verileri ÅŸifreleme veya ÅŸifre Ã§Ã¶zme yetkisi yoktur.
* Sadece IAM kullanÄ±cÄ±larÄ± ve rolleri Anahtar YÃ¶neticileri listesine eklenebilir (gruplar deÄŸil).
* Harici bir CMK kullanÄ±lÄ±yorsa, Anahtar YÃ¶neticileri anahtar malzemesini iÃ§e aktarma iznine sahiptir.

### CMK'larÄ±n DÃ¶ngÃ¼sÃ¼

* AynÄ± anahtar yerinde ne kadar uzun sÃ¼re kalÄ±rsa, o anahtarla o kadar Ã§ok veri ÅŸifrelenir ve eÄŸer o anahtar ihlal edilirse, o zaman veri iÃ§in patlama alanÄ± o kadar geniÅŸler. AyrÄ±ca, anahtar aktif kaldÄ±kÃ§a, ihlal edilme olasÄ±lÄ±ÄŸÄ± artar.
* **KMS, mÃ¼ÅŸteri anahtarlarÄ±nÄ± her 365 gÃ¼nde bir dÃ¶ndÃ¼rÃ¼r** (veya istediÄŸiniz zaman sÃ¼reci manuel olarak gerÃ§ekleÅŸtirebilirsiniz) ve **AWS tarafÄ±ndan yÃ¶netilen anahtarlar her 3 yÄ±lda bir dÃ¶ndÃ¼rÃ¼lÃ¼r** ve bu sefer deÄŸiÅŸtirilemez.
* **Eski anahtarlar**, dÃ¶ngÃ¼den Ã¶nce ÅŸifrelenmiÅŸ verileri Ã§Ã¶zmek iÃ§in saklanÄ±r.
* Bir ihlal durumunda, anahtarÄ±n dÃ¶ndÃ¼rÃ¼lmesi tehdidi ortadan kaldÄ±rmaz Ã§Ã¼nkÃ¼ ihlal edilen anahtarla ÅŸifrelenmiÅŸ tÃ¼m veriler Ã§Ã¶zÃ¼lebilir. Ancak, **yeni veriler yeni anahtar ile ÅŸifrelenecektir**.
* EÄŸer **CMK** **devre dÄ±ÅŸÄ±** veya **silinme** **beklemede** ise, KMS **anahtar dÃ¶ndÃ¼rme iÅŸlemi yapmayacaktÄ±r** ta ki CMK yeniden etkinleÅŸtirilene veya silme iptal edilene kadar.

#### Manuel dÃ¶ndÃ¼rme

* **Yeni bir CMK oluÅŸturulmasÄ± gerekir**, ardÄ±ndan yeni bir CMK-ID oluÅŸturulur, bu nedenle **uygulamanÄ±zÄ±** yeni CMK-ID'yi **referans almak iÃ§in gÃ¼ncellemeniz** gerekecektir.
* Bu sÃ¼reci daha kolay hale getirmek iÃ§in **bir anahtar kimliÄŸine atÄ±fta bulunmak iÃ§in takma adlar kullanabilirsiniz** ve ardÄ±ndan sadece takma adÄ±n atÄ±fta bulunduÄŸu anahtarÄ± gÃ¼ncelleyebilirsiniz.
* Eski dosyalarÄ± ÅŸifrelemek iÃ§in **eski anahtarlarÄ± saklamanÄ±z** gerekir.

Kendi yerel anahtar altyapÄ±nÄ±zdan anahtarlarÄ± iÃ§e aktarabilirsiniz.

### DiÄŸer ilgili KMS bilgileri

KMS, tÃ¼m hizmetlerden alÄ±nan ÅŸifreleme/ÅŸifre Ã§Ã¶zme taleplerinin sayÄ±sÄ±na gÃ¶re fiyatlandÄ±rÄ±lÄ±r.

KMS, **CloudTrail** ile tam denetim ve uyum **entegrasyonuna** sahiptir; burada KMS Ã¼zerinde gerÃ§ekleÅŸtirilen tÃ¼m deÄŸiÅŸiklikleri denetleyebilirsiniz.

KMS politikasÄ± ile aÅŸaÄŸÄ±dakileri yapabilirsiniz:

* Veri anahtarlarÄ±nÄ± kimlerin oluÅŸturabileceÄŸini ve bu anahtarlara hangi hizmetlerin eriÅŸim iznine sahip olduÄŸunu sÄ±nÄ±rlamak
* Sistemlerin yalnÄ±zca ÅŸifreleme, yalnÄ±zca ÅŸifre Ã§Ã¶zme veya her ikisine eriÅŸimini sÄ±nÄ±rlamak
* Sistemlerin bÃ¶lgeler arasÄ±nda anahtarlara eriÅŸimini saÄŸlamak iÃ§in tanÄ±mlamak (ancak bu Ã¶nerilmez Ã§Ã¼nkÃ¼ KMS'i barÄ±ndÄ±ran bÃ¶lgede bir arÄ±za, diÄŸer bÃ¶lgelerdeki sistemlerin kullanÄ±labilirliÄŸini etkiler).

BÃ¶lgeler arasÄ±nda anahtarlarÄ± senkronize edemez veya taÅŸÄ±yamaz/kopyalayamazsÄ±nÄ±z; yalnÄ±zca bÃ¶lge arasÄ±nda eriÅŸimi saÄŸlamak iÃ§in kurallar tanÄ±mlayabilirsiniz.

### SayÄ±m
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
