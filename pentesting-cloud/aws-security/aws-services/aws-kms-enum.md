# AWS - KMS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS - Servicio de Gesti칩n de Claves

AWS Key Management Service (AWS KMS) se presenta como un servicio gestionado, simplificando el proceso para que los usuarios **crean y gestionen claves maestras de cliente** (CMKs). Estas CMKs son fundamentales en la encriptaci칩n de datos de usuario. Una caracter칤stica notable de AWS KMS es que las CMKs est치n predominantemente **aseguradas por m칩dulos de seguridad de hardware** (HSMs), mejorando la protecci칩n de las claves de encriptaci칩n.

KMS utiliza **criptograf칤a sim칠trica**. Esto se utiliza para **encriptar informaci칩n en reposo** (por ejemplo, dentro de un S3). Si necesitas **encriptar informaci칩n en tr치nsito**, debes usar algo como **TLS**.

KMS es un **servicio espec칤fico de regi칩n**.

**Los administradores de Amazon no tienen acceso a tus claves**. No pueden recuperar tus claves y no te ayudan con la encriptaci칩n de tus claves. AWS simplemente administra el sistema operativo y la aplicaci칩n subyacente; depende de nosotros administrar nuestras claves de encriptaci칩n y c칩mo se utilizan esas claves.

**Claves Maestras de Cliente** (CMK): Pueden encriptar datos de hasta 4KB de tama침o. Se utilizan t칤picamente para crear, encriptar y desencriptar las DEKs (Claves de Encriptaci칩n de Datos). Luego, las DEKs se utilizan para encriptar los datos.

Una clave maestra de cliente (CMK) es una representaci칩n l칩gica de una clave maestra en AWS KMS. Adem치s de los identificadores de la clave maestra y otros metadatos, incluyendo su fecha de creaci칩n, descripci칩n y estado de la clave, una **CMK contiene el material de clave que se utiliza para encriptar y desencriptar datos**. Cuando creas una CMK, por defecto, AWS KMS genera el material de clave para esa CMK. Sin embargo, puedes optar por crear una CMK sin material de clave y luego importar tu propio material de clave en esa CMK.

Hay 2 tipos de claves maestras:

* **CMKs gestionadas por AWS: Utilizadas por otros servicios para encriptar datos**. Se utilizan por el servicio que las cre칩 en una regi칩n. Se crean la primera vez que implementas la encriptaci칩n en ese servicio. Rotan cada 3 a침os y no es posible cambiarlas.
* **CMKs gestionadas por el cliente**: Flexibilidad, rotaci칩n, acceso configurable y pol칤tica de clave. Habilitar y deshabilitar claves.

**Encriptaci칩n de Sobre** en el contexto del Servicio de Gesti칩n de Claves (KMS): Sistema de jerarqu칤a de dos niveles para **encriptar datos con la clave de datos y luego encriptar la clave de datos con la clave maestra**.

### Pol칤ticas de Clave

Estas definen **qui칠n puede usar y acceder a una clave en KMS**.

Por **defecto:**

*   Da al **cuenta de AWS que posee la clave KMS acceso total** a la clave KMS.

A diferencia de otras pol칤ticas de recursos de AWS, una **pol칤tica de clave KMS no otorga autom치ticamente permiso a la cuenta o a cualquiera de sus usuarios**. Para otorgar permiso a los administradores de la cuenta, la **pol칤tica de clave debe incluir una declaraci칩n expl칤cita** que proporcione este permiso, como esta.

* Sin permitir la cuenta(`"AWS": "arn:aws:iam::111122223333:root"`) los permisos de IAM no funcionar치n.
*   **Permite que la cuenta use pol칤ticas de IAM** para permitir el acceso a la clave KMS, adem치s de la pol칤tica de clave.

**Sin este permiso, las pol칤ticas de IAM que permiten el acceso a la clave son ineficaces**, aunque las pol칤ticas de IAM que niegan el acceso a la clave siguen siendo efectivas.
* Permite **reducir el riesgo de que la clave se vuelva inmanejable** al dar permiso de control de acceso a los administradores de la cuenta, incluyendo al usuario ra칤z de la cuenta, que no puede ser eliminado.

**Ejemplo de pol칤tica predeterminada:**
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Si la **cuenta est치 permitida** (`"arn:aws:iam::111122223333:root"`), un **principal** de la cuenta **todav칤a necesitar치 permisos de IAM** para usar la clave KMS. Sin embargo, si el **ARN** de un rol, por ejemplo, est치 **espec칤ficamente permitido** en la **Pol칤tica de Clave**, ese rol **no necesita permisos de IAM**.
{% endhint %}

<details>

<summary>Detalles de la Pol칤tica</summary>

Propiedades de una pol칤tica:

* Documento basado en JSON
* Recurso --> Recursos afectados (puede ser "\*")
* Acci칩n --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permisos)
* Efecto --> Permitir/Denegar
* Principal --> arn afectado
* Condiciones (opcional) --> Condici칩n para otorgar los permisos

Concesiones:

* Permite delegar tus permisos a otro principal de AWS dentro de tu cuenta de AWS. Necesitas crearlos usando las APIs de AWS KMS. Se puede indicar el identificador de CMK, el principal beneficiario y el nivel requerido de operaci칩n (Decrypt, Encrypt, GenerateDataKey...)
* Despu칠s de que se crea la concesi칩n, se emiten un GrantToken y un GrantID

**Acceso**:

* A trav칠s de **pol칤tica de clave** -- Si esto existe, esto tiene **precedencia** sobre la pol칤tica de IAM
* A trav칠s de **pol칤tica de IAM**
* A trav칠s de **concesiones**

</details>

### Administradores de Clave

Administrador de clave por defecto:

* Tienen acceso para gestionar KMS pero no para cifrar o descifrar datos
* Solo se pueden agregar usuarios y roles de IAM a la lista de Administradores de Clave (no grupos)
* Si se utiliza un CMK externo, los Administradores de Clave tienen el permiso para importar material de clave

### Rotaci칩n de CMKs

* Cuanto m치s tiempo se deja la misma clave en su lugar, m치s datos se cifran con esa clave, y si esa clave es comprometida, entonces mayor ser치 el 치rea de impacto de los datos en riesgo. Adem치s de esto, cuanto m치s tiempo est칠 activa la clave, aumenta la probabilidad de que sea comprometida.
* **KMS rota las claves de cliente cada 365 d칤as** (o puedes realizar el proceso manualmente cuando quieras) y **las claves gestionadas por AWS cada 3 a침os** y este tiempo no se puede cambiar.
* **Las claves m치s antiguas se retienen** para descifrar datos que fueron cifrados antes de la rotaci칩n
* En un compromiso, rotar la clave no eliminar치 la amenaza, ya que ser치 posible descifrar todos los datos cifrados con la clave comprometida. Sin embargo, **los nuevos datos se cifrar치n con la nueva clave**.
* Si el **CMK** est치 en estado de **deshabilitado** o **pendiente de eliminaci칩n**, KMS **no realizar치 una rotaci칩n de clave** hasta que el CMK sea reactivado o se cancele la eliminaci칩n.

#### Rotaci칩n manual

* Se **necesita crear un nuevo CMK**, luego, se crea un nuevo CMK-ID, por lo que necesitar치s **actualizar** cualquier **aplicaci칩n** para **referenciar** el nuevo CMK-ID.
* Para facilitar este proceso, puedes **usar alias para referenciar un key-id** y luego solo actualizar la clave a la que se refiere el alias.
* Necesitas **mantener claves antiguas para descifrar archivos antiguos** cifrados con ellas.

Puedes importar claves desde tu infraestructura de claves local.

### Otra informaci칩n relevante de KMS

KMS se cobra por el n칰mero de solicitudes de cifrado/descifrado recibidas de todos los servicios por mes.

KMS tiene una completa auditor칤a e **integraci칩n de cumplimiento con CloudTrail**; aqu칤 es donde puedes auditar todos los cambios realizados en KMS.

Con la pol칤tica de KMS puedes hacer lo siguiente:

* Limitar qui칠n puede crear claves de datos y qu칠 servicios tienen acceso para usar estas claves
* Limitar el acceso de los sistemas a cifrar solo, descifrar solo o ambos
* Definir para habilitar a los sistemas a acceder a claves a trav칠s de regiones (aunque no se recomienda, ya que una falla en la regi칩n que aloja KMS afectar치 la disponibilidad de los sistemas en otras regiones).

No puedes sincronizar o mover/copiar claves entre regiones; solo puedes definir reglas para permitir el acceso entre regiones.

### Enumeraci칩n
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
