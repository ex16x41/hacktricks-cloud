# AWS - KMS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** π’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** π¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS)λ” μ‚¬μ©μκ°€ **κ³ κ° λ§μ¤ν„° ν‚¤**(CMK)λ¥Ό **μƒμ„±ν•κ³  κ΄€λ¦¬**ν•λ” κ³Όμ •μ„ λ‹¨μν™”ν•λ” κ΄€λ¦¬ν• μ„λΉ„μ¤λ΅ μ κ³µλ©λ‹λ‹¤. μ΄ CMKλ” μ‚¬μ©μ λ°μ΄ν„° μ•”νΈν™”μ— ν•„μμ μ…λ‹λ‹¤. AWS KMSμ μ£Όλ©ν•  λ§ν• κΈ°λ¥μ€ CMKκ°€ μ£Όλ΅ **ν•λ“μ›¨μ–΄ λ³΄μ• λ¨λ“**(HSM)μ— μν•΄ λ³΄νΈλλ‹¤λ” μ μΌλ΅, μ•”νΈν™” ν‚¤μ λ³΄νΈλ¥Ό κ°•ν™”ν•©λ‹λ‹¤.

KMSλ” **λ€μΉ­ μ•”νΈν™”**λ¥Ό μ‚¬μ©ν•©λ‹λ‹¤. μ΄λ” **μ •μ§€λ μ •λ³΄**(μ: S3 λ‚΄λ¶€)λ¥Ό **μ•”νΈν™”**ν•λ” λ° μ‚¬μ©λ©λ‹λ‹¤. **μ „μ†΅ μ¤‘μΈ μ •λ³΄λ¥Ό μ•”νΈν™”**ν•λ ¤λ©΄ **TLS**μ™€ κ°™μ€ κ²ƒμ„ μ‚¬μ©ν•΄μ•Ό ν•©λ‹λ‹¤.

KMSλ” **μ§€μ—­λ³„ μ„λΉ„μ¤**μ…λ‹λ‹¤.

**Amazonμ κ΄€λ¦¬μλ“¤μ€ κ·€ν•μ ν‚¤μ— μ ‘κ·Όν•  μ μ—†μµλ‹λ‹¤**. κ·Έλ“¤μ€ κ·€ν•μ ν‚¤λ¥Ό λ³µκµ¬ν•  μ μ—†μΌλ©°, κ·€ν•μ ν‚¤ μ•”νΈν™”μ— λ„μ›€μ„ μ£Όμ§€ μ•μµλ‹λ‹¤. AWSλ” λ‹¨μν μ΄μ μ²΄μ μ™€ κΈ°λ³Έ μ• ν”λ¦¬μΌ€μ΄μ…μ„ κ΄€λ¦¬ν•λ©°, μ•”νΈν™” ν‚¤λ¥Ό κ΄€λ¦¬ν•κ³  ν•΄λ‹Ή ν‚¤κ°€ μ‚¬μ©λλ” λ°©μ‹μ„ κ΄€λ¦¬ν•λ” κ²ƒμ€ μ°λ¦¬μ—κ² λ‹¬λ ¤ μμµλ‹λ‹¤.

**κ³ κ° λ§μ¤ν„° ν‚¤**(CMK): μµλ€ 4KB ν¬κΈ°μ λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•  μ μμµλ‹λ‹¤. μΌλ°μ μΌλ΅ DEK(λ°μ΄ν„° μ•”νΈν™” ν‚¤)λ¥Ό μƒμ„±, μ•”νΈν™” λ° λ³µνΈν™”ν•λ” λ° μ‚¬μ©λ©λ‹λ‹¤. κ·Έλ° λ‹¤μ DEKλ” λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•λ” λ° μ‚¬μ©λ©λ‹λ‹¤.

κ³ κ° λ§μ¤ν„° ν‚¤(CMK)λ” AWS KMSμ—μ„ λ§μ¤ν„° ν‚¤μ λ…Όλ¦¬μ  ν‘ν„μ…λ‹λ‹¤. λ§μ¤ν„° ν‚¤μ μ‹λ³„μ λ° κΈ°νƒ€ λ©”νƒ€λ°μ΄ν„°(μƒμ„± λ‚ μ§, μ„¤λ… λ° ν‚¤ μƒνƒ ν¬ν•¨) μ™Έμ—λ„, **CMKλ” λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•κ³  λ³µνΈν™”ν•λ” λ° μ‚¬μ©λλ” ν‚¤ μλ£λ¥Ό ν¬ν•¨ν•©λ‹λ‹¤**. CMKλ¥Ό μƒμ„±ν•  λ• κΈ°λ³Έμ μΌλ΅ AWS KMSλ” ν•΄λ‹Ή CMKμ— λ€ν• ν‚¤ μλ£λ¥Ό μƒμ„±ν•©λ‹λ‹¤. κ·Έλ¬λ‚ ν‚¤ μλ£ μ—†μ΄ CMKλ¥Ό μƒμ„±ν• λ‹¤μ ν•΄λ‹Ή CMKμ— μμ‹ μ ν‚¤ μλ£λ¥Ό κ°€μ Έμ¬ μ μμµλ‹λ‹¤.

λ§μ¤ν„° ν‚¤μ—λ” λ‘ κ°€μ§€ μ ν•μ΄ μμµλ‹λ‹¤:

* **AWS κ΄€λ¦¬ CMK: λ‹¤λ¥Έ μ„λΉ„μ¤μ—μ„ λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•λ” λ° μ‚¬μ©**. ν•΄λ‹Ή μ§€μ—­μ—μ„ ν•΄λ‹Ή μ„λΉ„μ¤λ¥Ό μ²μ κµ¬ν„ν•  λ• μƒμ„±λ©λ‹λ‹¤. 3λ…„λ§λ‹¤ νμ „ν•λ©° λ³€κ²½ν•  μ μ—†μµλ‹λ‹¤.
* **κ³ κ° κ΄€λ¦¬ CMK**: μ μ—°μ„±, νμ „, κµ¬μ„± κ°€λ¥ν• μ ‘κ·Ό λ° ν‚¤ μ •μ±…. ν‚¤ ν™μ„±ν™” λ° λΉ„ν™μ„±ν™” κ°€λ¥.

Key Management Service(KMS)μ—μ„μ **λ΄‰ν¬ μ•”νΈν™”**: **λ°μ΄ν„° ν‚¤λ΅ λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν• λ‹¤μ λ§μ¤ν„° ν‚¤λ΅ λ°μ΄ν„° ν‚¤λ¥Ό μ•”νΈν™”ν•λ”** μ΄μ¤‘ κ³„μΈµ μ‹μ¤ν….

### Key Policies

μ΄λ” **KMSμ—μ„ ν‚¤λ¥Ό μ‚¬μ©ν•  μ μκ³  μ ‘κ·Όν•  μ μλ” μ‚¬λμ„ μ •μ**ν•©λ‹λ‹¤.

**κΈ°λ³Έμ μΌλ΅:**

*   **KMS ν‚¤λ¥Ό μ†μ ν• AWS κ³„μ •μ— KMS ν‚¤μ— λ€ν• μ „μ²΄ μ ‘κ·Ό κ¶ν•μ„ λ¶€μ—¬**ν•©λ‹λ‹¤.

λ‹¤λ¥Έ AWS λ¦¬μ†μ¤ μ •μ±…κ³Ό λ‹¬λ¦¬, AWS **KMS ν‚¤ μ •μ±…μ€ κ³„μ •μ΄λ‚ κ·Έ μ‚¬μ©μκ°€ μλ™μΌλ΅ κ¶ν•μ„ κ°€μ§€μ§€ μ•μµλ‹λ‹¤**. κ³„μ • κ΄€λ¦¬μμ—κ² κ¶ν•μ„ λ¶€μ—¬ν•λ ¤λ©΄, **ν‚¤ μ •μ±…μ— μ΄ κ¶ν•μ„ μ κ³µν•λ” λ…μ‹μ  λ¬Έμ¥μ΄ ν¬ν•¨λμ–΄μ•Ό ν•©λ‹λ‹¤**, λ‹¤μκ³Ό κ°™μ€ λ¬Έμ¥μ²λΌ.

* κ³„μ •(`"AWS": "arn:aws:iam::111122223333:root"`) IAM κ¶ν•μ΄ μ‘λ™ν•μ§€ μ•μµλ‹λ‹¤.
*   ν‚¤ μ •μ±… μ™Έμ—λ„ **κ³„μ •μ΄ IAM μ •μ±…μ„ μ‚¬μ©ν•μ—¬ KMS ν‚¤μ— μ ‘κ·Όν•  μ μλ„λ΅ ν—μ©**ν•©λ‹λ‹¤.

**μ΄ κ¶ν•μ΄ μ—†μΌλ©΄, ν‚¤μ— μ ‘κ·Όν•  μ μλ” IAM μ •μ±…μ€ ν¨κ³Όκ°€ μ—†μ§€λ§**, ν‚¤μ— μ ‘κ·Όμ„ κ±°λ¶€ν•λ” IAM μ •μ±…μ€ μ—¬μ „ν ν¨κ³Όμ μ…λ‹λ‹¤.
* κ³„μ • κ΄€λ¦¬μ, κ³„μ • λ£¨νΈ μ‚¬μ©μμ—κ² μ ‘κ·Ό μ μ–΄ κ¶ν•μ„ λ¶€μ—¬ν•μ—¬ **ν‚¤κ°€ κ΄€λ¦¬ λ¶κ°€λ¥ν•΄μ§ μ„ν—μ„ μ¤„μ…λ‹λ‹¤**, μ΄λ” μ‚­μ ν•  μ μ—†μµλ‹λ‹¤.

**κΈ°λ³Έ μ •μ±…** μ:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
**κ³„μ •μ΄ ν—μ©λ κ²½μ°** (`"arn:aws:iam::111122223333:root"`) κ³„μ •μ **principal**μ€ KMS ν‚¤λ¥Ό μ‚¬μ©ν•κΈ° μ„ν•΄ **IAM κ¶ν•μ΄ μ—¬μ „ν ν•„μ”**ν•©λ‹λ‹¤. κ·Έλ¬λ‚ μλ¥Ό λ“¤μ–΄ **μ—­ν• μ ARN**μ΄ **ν‚¤ μ •μ±…μ—μ„ λ…μ‹μ μΌλ΅ ν—μ©λ κ²½μ°**, κ·Έ μ—­ν• μ€ **IAM κ¶ν•μ΄ ν•„μ”ν•μ§€ μ•μµλ‹λ‹¤**.
{% endhint %}

<details>

<summary>Policy Details</summary>

μ •μ±…μ μ†μ„±:

* JSON κΈ°λ° λ¬Έμ„
* Resource --> μν–¥μ„ λ°›λ” λ¦¬μ†μ¤ (μ: "\*")
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (κ¶ν•)
* Effect --> Allow/Deny
* Principal --> μν–¥μ„ λ°›λ” arn
* Conditions (μ„ νƒ μ‚¬ν•­) --> κ¶ν•μ„ λ¶€μ—¬ν•λ” μ΅°κ±΄

Grants:

* AWS κ³„μ • λ‚΄μ λ‹¤λ¥Έ AWS principalμ—κ² κ¶ν•μ„ μ„μ„ν•  μ μμµλ‹λ‹¤. AWS KMS APIλ¥Ό μ‚¬μ©ν•μ—¬ μƒμ„±ν•΄μ•Ό ν•©λ‹λ‹¤. CMK μ‹λ³„μ, μνμ principal λ° ν•„μ”ν• μ‘μ—… μμ¤€(Decrypt, Encrypt, GenerateDataKey...)μ„ μ§€μ •ν•  μ μμµλ‹λ‹¤.
* Grantκ°€ μƒμ„±λ ν›„ GrantTokenκ³Ό GrantIDκ°€ λ°κΈ‰λ©λ‹λ‹¤.

**Access**:

* **key policy**λ¥Ό ν†µν•΄ -- μ΄ μ •μ±…μ΄ μ΅΄μ¬ν•λ©΄ **IAM μ •μ±…λ³΄λ‹¤ μ°μ„ **ν•©λ‹λ‹¤.
* **IAM μ •μ±…**μ„ ν†µν•΄
* **grants**λ¥Ό ν†µν•΄

</details>

### Key Administrators

κΈ°λ³Έ ν‚¤ κ΄€λ¦¬μ:

* KMSλ¥Ό κ΄€λ¦¬ν•  μ μμ§€λ§ λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•κ±°λ‚ λ³µνΈν™”ν•  μλ” μ—†μµλ‹λ‹¤.
* κ·Έλ£Ήμ΄ μ•„λ‹ IAM μ‚¬μ©μμ™€ μ—­ν• λ§ ν‚¤ κ΄€λ¦¬μ λ©λ΅μ— μ¶”κ°€ν•  μ μμµλ‹λ‹¤.
* μ™Έλ¶€ CMKλ¥Ό μ‚¬μ©ν•λ” κ²½μ°, ν‚¤ κ΄€λ¦¬μλ” ν‚¤ μλ£λ¥Ό κ°€μ Έμ¬ μ μλ” κ¶ν•μ„ κ°€μ§‘λ‹λ‹¤.

### CMKsμ νμ „

* λ™μΌν• ν‚¤κ°€ μ¤λ μ μ§€λ μλ΅ λ” λ§μ€ λ°μ΄ν„°κ°€ ν•΄λ‹Ή ν‚¤λ΅ μ•”νΈν™”λλ©°, ν•΄λ‹Ή ν‚¤κ°€ μ μ¶λλ©΄ λ” λ„“μ€ λ²”μ„μ λ°μ΄ν„°κ°€ μ„ν—μ— μ²ν•κ² λ©λ‹λ‹¤. λν•, ν‚¤κ°€ ν™μ„± μƒνƒλ΅ μ¤λ μμ„μλ΅ μ μ¶λ  ν™•λ¥ μ΄ λ†’μ•„μ§‘λ‹λ‹¤.
* **KMSλ” κ³ κ° ν‚¤λ¥Ό λ§¤ 365μΌλ§λ‹¤ νμ „**ν•λ©° (λλ” μ›ν•  λ• μλ™μΌλ΅ μν–‰ν•  μ μμµλ‹λ‹¤) **AWSκ°€ κ΄€λ¦¬ν•λ” ν‚¤λ” λ§¤ 3λ…„λ§λ‹¤** νμ „ν•λ©° μ΄ μ‹κ°„μ€ λ³€κ²½ν•  μ μ—†μµλ‹λ‹¤.
* **μ΄μ „ ν‚¤λ” μ μ§€**λμ–΄ νμ „ μ΄μ „μ— μ•”νΈν™”λ λ°μ΄ν„°λ¥Ό λ³µνΈν™”ν•  μ μμµλ‹λ‹¤.
* μ μ¶λ κ²½μ°, ν‚¤λ¥Ό νμ „ν•΄λ„ μ„ν‘μ΄ μ κ±°λμ§€ μ•μΌλ©°, μ μ¶λ ν‚¤λ΅ μ•”νΈν™”λ λ¨λ“  λ°μ΄ν„°λ¥Ό λ³µνΈν™”ν•  μ μμµλ‹λ‹¤. κ·Έλ¬λ‚ **μƒλ΅μ΄ λ°μ΄ν„°λ” μƒλ΅μ΄ ν‚¤λ΅ μ•”νΈν™”λ©λ‹λ‹¤**.
* **CMK**κ°€ **λΉ„ν™μ„±ν™”** λλ” **μ‚­μ  λ€κΈ° μ¤‘** μƒνƒμΈ κ²½μ°, KMSλ” CMKκ°€ λ‹¤μ‹ ν™μ„±ν™”λκ±°λ‚ μ‚­μ κ°€ μ·¨μ†λ  λ•κΉμ§€ **ν‚¤ νμ „μ„ μν–‰ν•μ§€ μ•μµλ‹λ‹¤**.

#### μλ™ νμ „

* **μƒλ΅μ΄ CMKλ¥Ό μƒμ„±ν•΄μ•Ό** ν•λ©°, μƒλ΅μ΄ CMK-IDκ°€ μƒμ„±λλ―€λ΅ **μ• ν”λ¦¬μΌ€μ΄μ…**μ„ **μƒλ΅μ΄ CMK-IDλ¥Ό μ°Έμ΅°ν•λ„λ΅ μ—…λ°μ΄νΈ**ν•΄μ•Ό ν•©λ‹λ‹¤.
* μ΄ κ³Όμ •μ„ μ‰½κ² ν•κΈ° μ„ν•΄ **ν‚¤-IDλ¥Ό μ°Έμ΅°ν•λ” λ³„μΉ­μ„ μ‚¬μ©**ν•κ³ , λ³„μΉ­μ΄ μ°Έμ΅°ν•λ” ν‚¤λ¥Ό μ—…λ°μ΄νΈν•  μ μμµλ‹λ‹¤.
* **μ΄μ „ νμΌμ„ λ³µνΈν™”ν•κΈ° μ„ν•΄ μ΄μ „ ν‚¤λ¥Ό μ μ§€**ν•΄μ•Ό ν•©λ‹λ‹¤.

μ¨ν”„λ λ―Έμ¤ ν‚¤ μΈν”„λΌμ—μ„ ν‚¤λ¥Ό κ°€μ Έμ¬ μ μμµλ‹λ‹¤.

### κΈ°νƒ€ κ΄€λ ¨ KMS μ •λ³΄

KMSλ” μ›”λ³„λ΅ λ¨λ“  μ„λΉ„μ¤μ—μ„ λ°›μ€ μ•”νΈν™”/λ³µνΈν™” μ”μ²­ μμ— λ”°λΌ κ°€κ²©μ΄ μ±…μ •λ©λ‹λ‹¤.

KMSλ” **CloudTrailκ³Όμ μ™„μ „ν• κ°μ‚¬ λ° μ¤€μ ν†µν•©**μ„ μ κ³µν•©λ‹λ‹¤. μ—¬κΈ°μ„ KMSμ—μ„ μν–‰λ λ¨λ“  λ³€κ²½ μ‚¬ν•­μ„ κ°μ‚¬ν•  μ μμµλ‹λ‹¤.

KMS μ •μ±…μ„ ν†µν•΄ λ‹¤μμ„ μν–‰ν•  μ μμµλ‹λ‹¤:

* λ°μ΄ν„° ν‚¤λ¥Ό μƒμ„±ν•  μ μλ” μ‚¬λκ³Ό μ΄λ¬ν• ν‚¤λ¥Ό μ‚¬μ©ν•  μ μλ” μ„λΉ„μ¤λ¥Ό μ ν•
* μ‹μ¤ν… μ ‘κ·Όμ„ μ•”νΈν™” μ „μ©, λ³µνΈν™” μ „μ© λλ” λ‘ λ‹¤λ΅ μ ν•
* μ‹μ¤ν…μ΄ μ§€μ—­ κ°„μ— ν‚¤μ— μ ‘κ·Όν•  μ μλ„λ΅ μ •μ (κ·Έλ¬λ‚ KMSλ¥Ό νΈμ¤ν…ν•λ” μ§€μ—­μ μ¥μ• κ°€ λ‹¤λ¥Έ μ§€μ—­μ μ‹μ¤ν… κ°€μ©μ„±μ— μν–¥μ„ λ―ΈμΉ  μ μμΌλ―€λ΅ κ¶μ¥λμ§€ μ•μ)

μ§€μ—­ κ°„μ— ν‚¤λ¥Ό λ™κΈ°ν™”ν•κ±°λ‚ μ΄λ™/λ³µμ‚¬ν•  μ μ—†μΌλ©°, μ§€μ—­ κ°„ μ ‘κ·Όμ„ ν—μ©ν•λ” κ·μΉ™λ§ μ •μν•  μ μμµλ‹λ‹¤.

### Enumeration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### κ¶ν• μƒμΉ

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### ν¬μ¤νΈ μµμ¤ν”λ΅μ‡

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### μ§€μ†μ„±

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## μ°Έκ³  μλ£

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
AWS ν•΄ν‚Ή ν•™μµ λ° μ—°μµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP ν•΄ν‚Ή ν•™μµ λ° μ—°μµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks μ§€μ›</summary>

* [**κµ¬λ… ν”λ**](https://github.com/sponsors/carlospolop) ν™•μΈ!
* **π’¬ [**Discord κ·Έλ£Ή**](https://discord.gg/hRep4RUj7f) λλ” [**telegram κ·Έλ£Ή**](https://t.me/peass)μ— κ°€μ…ν•κ±°λ‚ **Twitter** π¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**λ¥Ό ν”λ΅μ°ν•μ„Έμ”.**
* **PRμ„ μ μ¶ν•μ—¬ ν•΄ν‚Ή νΈλ¦­μ„ κ³µμ ν•μ„Έμ”:** [**HackTricks**](https://github.com/carlospolop/hacktricks) λ° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github μ €μ¥μ†.

</details>
{% endhint %}
