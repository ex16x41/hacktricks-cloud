# AWS - KMS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS - Servizio di Gestione delle Chiavi

Il Servizio di Gestione delle Chiavi di AWS (AWS KMS) √® presentato come un servizio gestito, semplificando il processo per gli utenti di **creare e gestire le chiavi master dei clienti** (CMK). Queste CMK sono fondamentali per la crittografia dei dati degli utenti. Una caratteristica notevole di AWS KMS √® che le CMK sono prevalentemente **protette da moduli di sicurezza hardware** (HSM), migliorando la protezione delle chiavi di crittografia.

KMS utilizza **crittografia simmetrica**. Questa viene utilizzata per **crittografare le informazioni a riposo** (ad esempio, all'interno di un S3). Se hai bisogno di **crittografare le informazioni in transito**, devi utilizzare qualcosa come **TLS**.

KMS √® un **servizio specifico per regione**.

**Gli amministratori di Amazon non hanno accesso alle tue chiavi**. Non possono recuperare le tue chiavi e non ti aiutano con la crittografia delle tue chiavi. AWS semplicemente amministra il sistema operativo e l'applicazione sottostante; spetta a noi amministrare le nostre chiavi di crittografia e gestire come vengono utilizzate.

**Chiavi Master dei Clienti** (CMK): Possono crittografare dati fino a 4KB di dimensione. Vengono tipicamente utilizzate per creare, crittografare e decrittografare le DEK (Data Encryption Keys). Poi le DEK vengono utilizzate per crittografare i dati.

Una chiave master dei clienti (CMK) √® una rappresentazione logica di una chiave master in AWS KMS. Oltre agli identificatori della chiave master e ad altri metadati, inclusi la data di creazione, la descrizione e lo stato della chiave, una **CMK contiene il materiale della chiave utilizzato per crittografare e decrittografare i dati**. Quando crei una CMK, per impostazione predefinita, AWS KMS genera il materiale della chiave per quella CMK. Tuttavia, puoi scegliere di creare una CMK senza materiale della chiave e poi importare il tuo materiale della chiave in quella CMK.

Ci sono 2 tipi di chiavi master:

* **CMK gestite da AWS: Utilizzate da altri servizi per crittografare i dati**. Viene utilizzata dal servizio che l'ha creata in una regione. Vengono create la prima volta che implementi la crittografia in quel servizio. Ruotano ogni 3 anni e non √® possibile modificarle.
* **CMK gestite dal cliente**: Flessibilit√†, rotazione, accesso configurabile e politica delle chiavi. Abilitano e disabilitano le chiavi.

**Crittografia a Involucro** nel contesto del Servizio di Gestione delle Chiavi (KMS): Sistema gerarchico a due livelli per **crittografare i dati con la chiave dei dati e poi crittografare la chiave dei dati con la chiave master**.

### Politiche delle Chiavi

Queste definiscono **chi pu√≤ utilizzare e accedere a una chiave in KMS**.

Per **impostazione predefinita:**

*   Fornisce all'**account AWS che possiede la chiave KMS accesso completo** alla chiave KMS.

A differenza di altre politiche delle risorse AWS, una **politica della chiave KMS di AWS non fornisce automaticamente permessi all'account o a uno dei suoi utenti**. Per fornire permessi agli amministratori dell'account, **la politica della chiave deve includere una dichiarazione esplicita** che fornisca questo permesso, come questa.

* Senza consentire all'account(`"AWS": "arn:aws:iam::111122223333:root"`) i permessi IAM non funzioneranno.
*   **Consente all'account di utilizzare le politiche IAM** per consentire l'accesso alla chiave KMS, oltre alla politica della chiave.

**Senza questo permesso, le politiche IAM che consentono l'accesso alla chiave sono inefficaci**, sebbene le politiche IAM che negano l'accesso alla chiave siano ancora efficaci.
* Riduce il rischio che la chiave diventi ingestibile **dando permessi di controllo accesso agli amministratori dell'account, incluso l'utente root dell'account, che non pu√≤ essere eliminato**.

**Esempio di politica predefinita**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Se l'**account √® autorizzato** (`"arn:aws:iam::111122223333:root"`), un **principale** dell'account **avr√† comunque bisogno di permessi IAM** per utilizzare la chiave KMS. Tuttavia, se l'**ARN** di un ruolo, ad esempio, √® **specificamente autorizzato** nella **Politica della Chiave**, quel ruolo **non ha bisogno di permessi IAM**.
{% endhint %}

<details>

<summary>Dettagli della Politica</summary>

Propriet√† di una politica:

* Documento basato su JSON
* Risorsa --> Risorse interessate (pu√≤ essere "\*")
* Azione --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permessi)
* Effetto --> Consenti/Nega
* Principale --> arn interessato
* Condizioni (opzionale) --> Condizione per concedere i permessi

Concessioni:

* Consente di delegare i propri permessi a un altro principale AWS all'interno del proprio account AWS. √à necessario crearli utilizzando le API AWS KMS. Pu√≤ essere indicato l'identificatore CMK, il principale beneficiario e il livello richiesto di operazione (Decrypt, Encrypt, GenerateDataKey...)
* Dopo che la concessione √® stata creata, vengono emessi un GrantToken e un GrantID

**Accesso**:

* Tramite **politica della chiave** -- Se esiste, questa ha **precedenza** sulla politica IAM
* Tramite **politica IAM**
* Tramite **concessioni**

</details>

### Amministratori delle Chiavi

Amministratore delle chiavi per impostazione predefinita:

* Ha accesso per gestire KMS ma non per crittografare o decrittografare dati
* Solo gli utenti e i ruoli IAM possono essere aggiunti all'elenco degli Amministratori delle Chiavi (non i gruppi)
* Se viene utilizzato un CMK esterno, gli Amministratori delle Chiavi hanno il permesso di importare materiale di chiave

### Rotazione dei CMK

* Pi√π a lungo la stessa chiave rimane in uso, pi√π dati vengono crittografati con quella chiave, e se quella chiave viene compromessa, allora pi√π ampia sar√† l'area di esplosione dei dati a rischio. Inoltre, pi√π a lungo la chiave √® attiva, maggiore √® la probabilit√† che venga compromessa.
* **KMS ruota le chiavi dei clienti ogni 365 giorni** (o puoi eseguire il processo manualmente quando vuoi) e **le chiavi gestite da AWS ogni 3 anni** e questo tempo non pu√≤ essere cambiato.
* **Le chiavi pi√π vecchie vengono mantenute** per decrittografare i dati che sono stati crittografati prima della rotazione
* In caso di compromissione, ruotare la chiave non rimuover√† la minaccia poich√© sar√† possibile decrittografare tutti i dati crittografati con la chiave compromessa. Tuttavia, i **nuovi dati saranno crittografati con la nuova chiave**.
* Se il **CMK** √® in stato di **disabilitato** o **in attesa di** **cancellazione**, KMS **non eseguir√† una rotazione della chiave** fino a quando il CMK non sar√† riattivato o la cancellazione non sar√† annullata.

#### Rotazione manuale

* √à necessario **creare un nuovo CMK**, quindi viene creato un nuovo CMK-ID, quindi dovrai **aggiornare** qualsiasi **applicazione** per **riferirsi** al nuovo CMK-ID.
* Per semplificare questo processo, puoi **utilizzare alias per riferirti a un key-id** e poi semplicemente aggiornare la chiave a cui si riferisce l'alias.
* Devi **mantenere le vecchie chiavi per decrittografare i vecchi file** crittografati con esse.

Puoi importare chiavi dalla tua infrastruttura di chiavi on-premises.

### Altre informazioni rilevanti su KMS

KMS √® tariffato in base al numero di richieste di crittografia/decrittografia ricevute da tutti i servizi al mese.

KMS ha piena integrazione di audit e conformit√† **con CloudTrail**; qui puoi auditare tutte le modifiche effettuate su KMS.

Con la politica KMS puoi fare quanto segue:

* Limitare chi pu√≤ creare chiavi dati e quali servizi hanno accesso a utilizzare queste chiavi
* Limitare l'accesso ai sistemi per crittografare solo, decrittografare solo o entrambi
* Definire per abilitare i sistemi ad accedere alle chiavi attraverso le regioni (anche se non √® raccomandato poich√© un guasto nella regione che ospita KMS influenzer√† la disponibilit√† dei sistemi in altre regioni).

Non puoi sincronizzare o spostare/copiare chiavi tra le regioni; puoi solo definire regole per consentire l'accesso tra le regioni.

### Enumerazione
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Riferimenti

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Impara e pratica Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Impara e pratica Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos su github.

</details>
{% endhint %}
