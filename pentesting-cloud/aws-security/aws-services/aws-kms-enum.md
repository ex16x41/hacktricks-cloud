# AWS - KMS Enum

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS), kullanÄ±cÄ±larÄ±n **mÃ¼ÅŸteri anahtarlarÄ±nÄ± (CMK) oluÅŸturma ve yÃ¶netme** sÃ¼recini basitleÅŸtiren yÃ¶netilen bir hizmet olarak sunulmaktadÄ±r. Bu CMK'lar, kullanÄ±cÄ± verilerinin ÅŸifrelenmesinde Ã¶nemli bir rol oynar. AWS KMS'nin dikkat Ã§eken bir Ã¶zelliÄŸi, CMK'larÄ±n bÃ¼yÃ¼k Ã¶lÃ§Ã¼de **donanÄ±m gÃ¼venlik modÃ¼lleri (HSM) tarafÄ±ndan gÃ¼vence altÄ±na alÄ±nmasÄ±dÄ±r**, bu da ÅŸifreleme anahtarlarÄ±nÄ±n korunmasÄ±nÄ± artÄ±rÄ±r.

KMS, **simetrik kriptografi** kullanÄ±r. Bu, **dinlenme halindeki bilgileri ÅŸifrelemek** iÃ§in kullanÄ±lÄ±r (Ã¶rneÄŸin, bir S3 iÃ§inde). **AktarÄ±m halindeki bilgileri ÅŸifrelemeniz gerekiyorsa** **TLS** gibi bir ÅŸey kullanmanÄ±z gerekir.

KMS, **bÃ¶lgeye Ã¶zgÃ¼ bir hizmettir**.

**Amazon'daki yÃ¶neticiler anahtarlarÄ±nÄ±za eriÅŸemez**. AnahtarlarÄ±nÄ±zÄ± kurtaramazlar ve anahtarlarÄ±nÄ±zÄ±n ÅŸifrelenmesine yardÄ±mcÄ± olmazlar. AWS sadece iÅŸletim sistemini ve temel uygulamayÄ± yÃ¶netir, ÅŸifreleme anahtarlarÄ±mÄ±zÄ± yÃ¶netmek ve bu anahtarlarÄ±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± yÃ¶netmek bize kalmÄ±ÅŸtÄ±r.

**MÃ¼ÅŸteri AnahtarlarÄ± (CMK)**: 4KB boyutuna kadar verileri ÅŸifreleyebilir. Genellikle DEK'leri (Veri Åifreleme AnahtarlarÄ±) oluÅŸturmak, ÅŸifrelemek ve ÅŸifresini Ã§Ã¶zmek iÃ§in kullanÄ±lÄ±rlar. Daha sonra DEK'ler veriyi ÅŸifrelemek iÃ§in kullanÄ±lÄ±r.

Bir mÃ¼ÅŸteri anahtarÄ± (CMK), AWS KMS'de bir anahtarÄ±n mantÄ±ksal bir temsilidir. AnahtarÄ±n tanÄ±mlayÄ±cÄ±larÄ± ve diÄŸer meta verilerinin yanÄ± sÄ±ra, oluÅŸturulma tarihi, aÃ§Ä±klamasÄ± ve anahtar durumu dahil olmak Ã¼zere, bir **CMK, verileri ÅŸifrelemek ve ÅŸifresini Ã§Ã¶zmek iÃ§in kullanÄ±lan anahtar materyalini iÃ§erir**. Bir CMK oluÅŸturduÄŸunuzda, varsayÄ±lan olarak, AWS KMS bu CMK iÃ§in anahtar materyalini oluÅŸturur. Ancak, anahtar materyali olmadan bir CMK oluÅŸturmayÄ± seÃ§ebilir ve ardÄ±ndan kendi anahtar materyalinizi bu CMK'ya aktarabilirsiniz.

2 tÃ¼r anahtar vardÄ±r:

* **AWS yÃ¶netilen CMK'lar: DiÄŸer hizmetler tarafÄ±ndan veri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r**. Bir bÃ¶lgede oluÅŸturulduÄŸu hizmet tarafÄ±ndan kullanÄ±lÄ±r. Bu hizmette ÅŸifrelemeyi ilk kez uyguladÄ±ÄŸÄ±nÄ±zda oluÅŸturulurlar. Her 3 yÄ±lda bir dÃ¶ner ve deÄŸiÅŸtirilmesi mÃ¼mkÃ¼n deÄŸildir.
* **MÃ¼ÅŸteri yÃ¶netici CMK'lar**: Esneklik, dÃ¶ndÃ¼rme, yapÄ±landÄ±rÄ±labilir eriÅŸim ve anahtar politikasÄ±. AnahtarlarÄ± etkinleÅŸtirme ve devre dÄ±ÅŸÄ± bÄ±rakma.

**Zarf Åifreleme** KMS baÄŸlamÄ±nda: **Veri anahtarÄ± ile veriyi ÅŸifrelemek ve ardÄ±ndan veri anahtarÄ±nÄ± anahtar ile ÅŸifrelemek** iÃ§in iki katmanlÄ± hiyerarÅŸi sistemi.

### Anahtar PolitikalarÄ±

Bu, **KMS'de bir anahtarÄ± kimlerin kullanabileceÄŸini ve eriÅŸebileceÄŸini** tanÄ±mlar.

**VarsayÄ±lan olarak:**

*   **KMS anahtarÄ±na tam eriÅŸim saÄŸlayan AWS hesabÄ±na** KMS anahtarÄ±na tam eriÅŸim saÄŸlar.

DiÄŸer AWS kaynak politikalarÄ±ndan farklÄ± olarak, bir AWS **KMS anahtar politikasÄ±, otomatik olarak hesaba veya herhangi bir kullanÄ±cÄ±sÄ±na izin vermez**. Hesap yÃ¶neticilerine izin vermek iÃ§in, **anahtar politikasÄ± bu izni saÄŸlayan aÃ§Ä±k bir ifade iÃ§ermelidir**, bu gibi.

* Hesaba izin vermeden (`"AWS": "arn:aws:iam::111122223333:root"`) IAM izinleri Ã§alÄ±ÅŸmaz.
*   Bu, **anahtar politikasÄ±na ek olarak IAM politikalarÄ±nÄ± kullanarak KMS anahtarÄ±na eriÅŸime izin verir**.

**Bu izin olmadan, anahtara eriÅŸime izin veren IAM politikalarÄ± etkisizdir**, ancak anahtara eriÅŸimi reddeden IAM politikalarÄ± hala etkilidir.
* Bu, **anahtarÄ±n yÃ¶netilemez hale gelme riskini azaltÄ±r** ve hesap kÃ¶k kullanÄ±cÄ±sÄ± da dahil olmak Ã¼zere hesap yÃ¶neticilerine eriÅŸim kontrol izni verir, bu kullanÄ±cÄ± silinemez.

**VarsayÄ±lan politika** Ã¶rneÄŸi:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
EÄŸer **hesaba izin verilmiÅŸse** (`"arn:aws:iam::111122223333:root"`) hesaptan bir **principal** KMS anahtarÄ±nÄ± kullanmak iÃ§in **IAM izinlerine ihtiyaÃ§ duyacaktÄ±r**. Ancak, Ã¶rneÄŸin bir rolÃ¼n **ARN'si** **Anahtar PolitikasÄ±nda** **Ã¶zellikle izin verilmiÅŸse**, o rol **IAM izinlerine ihtiyaÃ§ duymaz**.
{% endhint %}

<details>

<summary>Politika DetaylarÄ±</summary>

Bir politikanÄ±n Ã¶zellikleri:

* JSON tabanlÄ± belge
* Resource --> Etkilenen kaynaklar ( "\*" olabilir)
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (izinler)
* Effect --> Allow/Deny
* Principal --> etkilenen arn
* KoÅŸullar (isteÄŸe baÄŸlÄ±) --> Ä°zinleri vermek iÃ§in koÅŸul

Grants:

* Ä°zinlerinizi AWS hesabÄ±nÄ±zdaki baÅŸka bir AWS principal'Ä±na devretmenize izin verir. AWS KMS API'lerini kullanarak bunlarÄ± oluÅŸturmanÄ±z gerekir. CMK tanÄ±mlayÄ±cÄ±sÄ±, grantee principal ve gerekli operasyon seviyesi (Decrypt, Encrypt, GenerateDataKey...) belirtilebilir.
* Grant oluÅŸturulduktan sonra bir GrantToken ve GrantID verilir.

**EriÅŸim**:

* **anahtar politikasÄ±** aracÄ±lÄ±ÄŸÄ±yla -- Bu mevcutsa, IAM politikasÄ±na **Ã¶ncelik** tanÄ±r
* **IAM politikasÄ±** aracÄ±lÄ±ÄŸÄ±yla
* **grants** aracÄ±lÄ±ÄŸÄ±yla

</details>

### Anahtar YÃ¶neticileri

VarsayÄ±lan olarak anahtar yÃ¶neticisi:

* KMS'yi yÃ¶netme eriÅŸimine sahiptir ancak veri ÅŸifreleme veya ÅŸifre Ã§Ã¶zme yetkisine sahip deÄŸildir
* YalnÄ±zca IAM kullanÄ±cÄ±larÄ± ve roller Anahtar YÃ¶neticileri listesine eklenebilir (gruplar deÄŸil)
* Harici CMK kullanÄ±lÄ±yorsa, Anahtar YÃ¶neticileri anahtar materyalini iÃ§e aktarma iznine sahiptir

### CMK'larÄ±n DÃ¶ndÃ¼rÃ¼lmesi

* AynÄ± anahtar ne kadar uzun sÃ¼re yerinde kalÄ±rsa, o anahtarla daha fazla veri ÅŸifrelenir ve eÄŸer o anahtar ihlal edilirse, risk altÄ±ndaki veri alanÄ± o kadar geniÅŸ olur. Buna ek olarak, anahtar ne kadar uzun sÃ¼re aktif olursa, ihlal edilme olasÄ±lÄ±ÄŸÄ± da artar.
* **KMS mÃ¼ÅŸteri anahtarlarÄ±nÄ± her 365 gÃ¼nde bir dÃ¶ndÃ¼rÃ¼r** (veya istediÄŸiniz zaman manuel olarak bu iÅŸlemi gerÃ§ekleÅŸtirebilirsiniz) ve **AWS tarafÄ±ndan yÃ¶netilen anahtarlar her 3 yÄ±lda bir** dÃ¶ndÃ¼rÃ¼lÃ¼r ve bu sÃ¼re deÄŸiÅŸtirilemez.
* **Eski anahtarlar** dÃ¶ndÃ¼rme Ã¶ncesinde ÅŸifrelenmiÅŸ verileri Ã§Ã¶zmek iÃ§in saklanÄ±r.
* Bir ihlal durumunda, anahtarÄ±n dÃ¶ndÃ¼rÃ¼lmesi tehdidi ortadan kaldÄ±rmaz Ã§Ã¼nkÃ¼ ihlal edilen anahtarla ÅŸifrelenmiÅŸ tÃ¼m verileri Ã§Ã¶zmek mÃ¼mkÃ¼n olacaktÄ±r. Ancak, **yeni veriler yeni anahtarla ÅŸifrelenecektir**.
* EÄŸer **CMK** **devre dÄ±ÅŸÄ±** veya **silinmeyi bekliyor** durumundaysa, KMS **anahtar dÃ¶ndÃ¼rme iÅŸlemi gerÃ§ekleÅŸtirmez** CMK yeniden etkinleÅŸtirilene veya silme iptal edilene kadar.

#### Manuel dÃ¶ndÃ¼rme

* **Yeni bir CMK oluÅŸturulmasÄ± gerekir**, ardÄ±ndan yeni bir CMK-ID oluÅŸturulur, bu nedenle **herhangi bir uygulamayÄ±** yeni CMK-ID'yi **referans alacak ÅŸekilde gÃ¼ncellemeniz** gerekecektir.
* Bu iÅŸlemi kolaylaÅŸtÄ±rmak iÃ§in **bir anahtar-id'ye atÄ±fta bulunmak iÃ§in takma adlar kullanabilirsiniz** ve ardÄ±ndan takma adÄ±n atÄ±fta bulunduÄŸu anahtarÄ± gÃ¼ncelleyebilirsiniz.
* **Eski dosyalarÄ± ÅŸifrelemek iÃ§in eski anahtarlarÄ± saklamanÄ±z** gerekir.

AnahtarlarÄ± yerel anahtar altyapÄ±nÄ±zdan iÃ§e aktarabilirsiniz.

### DiÄŸer ilgili KMS bilgileri

KMS, ayda alÄ±nan ÅŸifreleme/ÅŸifre Ã§Ã¶zme isteklerinin sayÄ±sÄ±na gÃ¶re fiyatlandÄ±rÄ±lÄ±r.

KMS, **CloudTrail ile tam denetim ve uyum entegrasyonuna** sahiptir; burada KMS Ã¼zerinde gerÃ§ekleÅŸtirilen tÃ¼m deÄŸiÅŸiklikleri denetleyebilirsiniz.

KMS politikasÄ± ile ÅŸunlarÄ± yapabilirsiniz:

* Veri anahtarlarÄ±nÄ± kimlerin oluÅŸturabileceÄŸini ve bu anahtarlarÄ± kullanma eriÅŸimine sahip hizmetleri sÄ±nÄ±rlayÄ±n
* Sistemlerin yalnÄ±zca ÅŸifreleme, yalnÄ±zca ÅŸifre Ã§Ã¶zme veya her ikisine eriÅŸimini sÄ±nÄ±rlayÄ±n
* Sistemlerin anahtarlara bÃ¶lgeler arasÄ± eriÅŸimini etkinleÅŸtirmek iÃ§in tanÄ±mlayÄ±n (bÃ¶lgede KMS'yi barÄ±ndÄ±ran bir arÄ±zanÄ±n diÄŸer bÃ¶lgelerdeki sistemlerin kullanÄ±labilirliÄŸini etkileyeceÄŸi iÃ§in Ã¶nerilmez).

AnahtarlarÄ± bÃ¶lgeler arasÄ±nda senkronize edemez veya taÅŸÄ±yamaz/kopyalayamazsÄ±nÄ±z; yalnÄ±zca bÃ¶lgeler arasÄ± eriÅŸime izin veren kurallar tanÄ±mlayabilirsiniz.

### Enumeration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Discord grubuna** ğŸ’¬ [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</details>
{% endhint %}
