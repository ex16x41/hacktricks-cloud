# AWS - KMS Enum

{% hint style="success" %}
Ucz si i wicz hakowanie AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz hakowanie GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) jest przedstawiany jako zarzdzana usuga, upraszczajca proces **tworzenia i zarzdzania kluczami g贸wnymi klient贸w** (CMKs). Te CMKs s integralne w szyfrowaniu danych u偶ytkownik贸w. Zauwa偶aln cech AWS KMS jest to, 偶e CMKs s g贸wnie **zabezpieczane przez moduy bezpieczestwa sprztowego** (HSMs), co zwiksza ochron kluczy szyfrujcych.

KMS u偶ywa **kryptografii symetrycznej**. Jest ona u偶ywana do **szyfrowania informacji w spoczynku** (na przykad, wewntrz S3). Jeli potrzebujesz **szyfrowa informacje w tranzycie**, musisz u偶y czego takiego jak **TLS**.

KMS jest **usug specyficzn dla regionu**.

**Administratorzy w Amazon nie maj dostpu do twoich kluczy**. Nie mog odzyska twoich kluczy i nie pomagaj w ich szyfrowaniu. AWS po prostu zarzdza systemem operacyjnym i podstawow aplikacj, a my musimy zarzdza naszymi kluczami szyfrujcymi i tym, jak s one u偶ywane.

**Customer Master Keys** (CMK): Mog szyfrowa dane do 4KB. S zazwyczaj u偶ywane do tworzenia, szyfrowania i deszyfrowania DEKs (Data Encryption Keys). Nastpnie DEKs s u偶ywane do szyfrowania danych.

Klucz g贸wny klienta (CMK) jest logiczn reprezentacj klucza g贸wnego w AWS KMS. Opr贸cz identyfikator贸w klucza g贸wnego i innych metadanych, w tym daty utworzenia, opisu i stanu klucza, **CMK zawiera materia klucza u偶ywany do szyfrowania i deszyfrowania danych**. Kiedy tworzysz CMK, domylnie AWS KMS generuje materia klucza dla tego CMK. Mo偶esz jednak wybra utworzenie CMK bez materiau klucza, a nastpnie zaimportowa wasny materia klucza do tego CMK.

Istniej 2 typy kluczy g贸wnych:

* **AWS managed CMKs: U偶ywane przez inne usugi do szyfrowania danych**. Jest u偶ywany przez usug, kt贸ra go utworzya w danym regionie. S tworzone po raz pierwszy, gdy implementujesz szyfrowanie w tej usudze. Rotuje co 3 lata i nie mo偶na tego zmieni.
* **Customer manager CMKs**: Elastyczno, rotacja, konfigurowalny dostp i polityka klucza. Wczanie i wyczanie kluczy.

**Envelope Encryption** w kontekcie Key Management Service (KMS): Dwupoziomowy system hierarchii do **szyfrowania danych za pomoc klucza danych, a nastpnie szyfrowania klucza danych za pomoc klucza g贸wnego**.

### Key Policies

Te definiuj **kto mo偶e u偶ywa i uzyskiwa dostp do klucza w KMS**.

Domylnie:

* Daje **konto AWS, kt贸re posiada klucz KMS peny dostp** do klucza KMS.

W przeciwiestwie do innych polityk zasob贸w AWS, **polityka klucza KMS AWS nie daje automatycznie uprawnie do konta ani 偶adnego z jego u偶ytkownik贸w**. Aby da uprawnienia administratorom konta, **polityka klucza musi zawiera wyra藕ne owiadczenie** przyznajce to uprawnienie, jak to.

* Bez zezwolenia na konto (`"AWS": "arn:aws:iam::111122223333:root"`) uprawnienia IAM nie bd dziaa.
* Pozwala **konto na u偶ywanie polityk IAM** do zezwalania na dostp do klucza KMS, opr贸cz polityki klucza.

**Bez tego uprawnienia, polityki IAM, kt贸re zezwalaj na dostp do klucza, s nieskuteczne**, chocia偶 polityki IAM, kt贸re odmawiaj dostpu do klucza, s nadal skuteczne.
* Zmniejsza **ryzyko, 偶e klucz stanie si niezarzdzalny** poprzez przyznanie uprawnie do kontroli dostpu administratorom konta, w tym u偶ytkownikowi root konta, kt贸rego nie mo偶na usun.

Przykad **domylnej polityki**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Jeli **konto jest dozwolone** (`"arn:aws:iam::111122223333:root"`), **podmiot** z konta **nadal bdzie potrzebowa uprawnie IAM** do u偶ycia klucza KMS. Jednak偶e, jeli **ARN** roli na przykad jest **specjalnie dozwolony** w **Polityce Klucza**, ta rola **nie potrzebuje uprawnie IAM**.
{% endhint %}

<details>

<summary>Szczeg贸y Polityki</summary>

Waciwoci polityki:

* Dokument oparty na JSON
* Resource --> Dotknite zasoby (mo偶e by "\*")
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (uprawnienia)
* Effect --> Allow/Deny
* Principal --> dotknity arn
* Warunki (opcjonalne) --> Warunek nadania uprawnie

Grants:

* Pozwalaj delegowa swoje uprawnienia innemu podmiotowi AWS w ramach swojego konta AWS. Musisz je utworzy za pomoc API AWS KMS. Mo偶na wskaza identyfikator CMK, podmiot grantu i wymagany poziom operacji (Decrypt, Encrypt, GenerateDataKey...)
* Po utworzeniu grantu wydawane s GrantToken i GrantID

**Dostp**:

* Poprzez **polityk klucza** -- Jeli istnieje, ma **pierwszestwo** przed polityk IAM
* Poprzez **polityk IAM**
* Poprzez **grants**

</details>

### Administratorzy Kluczy

Administrator kluczy domylnie:

* Ma dostp do zarzdzania KMS, ale nie do szyfrowania ani deszyfrowania danych
* Tylko u偶ytkownicy IAM i role mog by dodawani do listy Administrator贸w Kluczy (nie grupy)
* Jeli u偶ywany jest zewntrzny CMK, Administratorzy Kluczy maj uprawnienia do importowania materiau klucza

### Rotacja CMK

* Im du偶ej ten sam klucz jest u偶ywany, tym wicej danych jest szyfrowanych tym kluczem, a jeli ten klucz zostanie naruszony, tym wikszy obszar danych jest zagro偶ony. Dodatkowo, im du偶ej klucz jest aktywny, tym wiksze prawdopodobiestwo jego naruszenia.
* **KMS rotuje klucze klient贸w co 365 dni** (lub mo偶esz przeprowadzi ten proces rcznie, kiedy chcesz) i **klucze zarzdzane przez AWS co 3 lata** i tego czasu nie mo偶na zmieni.
* **Starsze klucze s zachowywane** do deszyfrowania danych zaszyfrowanych przed rotacj
* W przypadku naruszenia, rotacja klucza nie usunie zagro偶enia, poniewa偶 bdzie mo偶liwe deszyfrowanie wszystkich danych zaszyfrowanych naruszonym kluczem. Jednak偶e, **nowe dane bd szyfrowane nowym kluczem**.
* Jeli **CMK** jest w stanie **wyczony** lub **oczekujcy na usunicie**, KMS **nie przeprowadzi rotacji klucza** dop贸ki CMK nie zostanie ponownie wczony lub usunicie nie zostanie anulowane.

#### Rczna rotacja

* Nale偶y **utworzy nowy CMK**, wtedy zostanie utworzony nowy CMK-ID, wic bdziesz musia **zaktualizowa** ka偶d **aplikacj**, aby **odnosia si** do nowego CMK-ID.
* Aby uatwi ten proces, mo偶esz **u偶ywa alias贸w do odniesienia si do key-id** i nastpnie po prostu zaktualizowa klucz, do kt贸rego odnosi si alias.
* Musisz **zachowa stare klucze do deszyfrowania starych plik贸w** zaszyfrowanych nimi.

Mo偶esz importowa klucze z infrastruktury kluczy on-premises.

### Inne istotne informacje o KMS

KMS jest wyceniany na podstawie liczby 偶da szyfrowania/deszyfrowania otrzymanych od wszystkich usug miesicznie.

KMS ma pen integracj audytu i zgodnoci z **CloudTrail**; tutaj mo偶esz audytowa wszystkie zmiany wykonane na KMS.

Za pomoc polityki KMS mo偶esz zrobi nastpujce:

* Ograniczy, kto mo偶e tworzy klucze danych i kt贸re usugi maj dostp do u偶ywania tych kluczy
* Ograniczy dostp system贸w do tylko szyfrowania, tylko deszyfrowania lub obu
* Zdefiniowa, aby umo偶liwi systemom dostp do kluczy w r贸偶nych regionach (chocia偶 nie jest to zalecane, poniewa偶 awaria w regionie hostujcym KMS wpynie na dostpno system贸w w innych regionach).

Nie mo偶esz synchronizowa ani przenosi/kopiowa kluczy midzy regionami; mo偶esz tylko zdefiniowa zasady umo偶liwiajce dostp midzy regionami.

### Enumeration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Referencje

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Ucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
