# AWS - KMS Enum

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) wird als verwalteter Dienst pr√§sentiert, der den Prozess f√ºr Benutzer vereinfacht, **Kundenmaster-Schl√ºssel** (CMKs) zu **erstellen und zu verwalten**. Diese CMKs sind integraler Bestandteil der Verschl√ºsselung von Benutzerdaten. Ein bemerkenswertes Merkmal von AWS KMS ist, dass CMKs √ºberwiegend **durch Hardware-Sicherheitsmodule** (HSMs) **gesichert** sind, was den Schutz der Verschl√ºsselungsschl√ºssel verbessert.

KMS verwendet **symmetrische Kryptographie**. Dies wird verwendet, um **Informationen im Ruhezustand zu verschl√ºsseln** (zum Beispiel in einem S3). Wenn du **Informationen w√§hrend der √úbertragung verschl√ºsseln** musst, musst du etwas wie **TLS** verwenden.

KMS ist ein **regionsspezifischer Dienst**.

**Administratoren bei Amazon haben keinen Zugriff auf deine Schl√ºssel**. Sie k√∂nnen deine Schl√ºssel nicht wiederherstellen und helfen dir nicht bei der Verschl√ºsselung deiner Schl√ºssel. AWS verwaltet einfach das Betriebssystem und die zugrunde liegende Anwendung; es liegt an uns, unsere Verschl√ºsselungsschl√ºssel zu verwalten und zu steuern, wie diese Schl√ºssel verwendet werden.

**Kundenmaster-Schl√ºssel** (CMK): K√∂nnen Daten mit einer Gr√∂√üe von bis zu 4 KB verschl√ºsseln. Sie werden typischerweise verwendet, um die DEKs (Data Encryption Keys) zu erstellen, zu verschl√ºsseln und zu entschl√ºsseln. Dann werden die DEKs verwendet, um die Daten zu verschl√ºsseln.

Ein Kundenmaster-Schl√ºssel (CMK) ist eine logische Darstellung eines Master-Schl√ºssels in AWS KMS. Neben den Identifikatoren des Master-Schl√ºssels und anderen Metadaten, einschlie√ülich seines Erstellungsdatums, seiner Beschreibung und seines Schl√ºsselsstatus, **enth√§lt ein CMK das Schl√ºsselmateriel, das zur Verschl√ºsselung und Entschl√ºsselung von Daten verwendet wird**. Wenn du ein CMK erstellst, generiert AWS KMS standardm√§√üig das Schl√ºsselmateriel f√ºr dieses CMK. Du kannst jedoch w√§hlen, ein CMK ohne Schl√ºsselmateriel zu erstellen und dann dein eigenes Schl√ºsselmateriel in dieses CMK zu importieren.

Es gibt 2 Arten von Master-Schl√ºsseln:

* **AWS verwaltete CMKs: Werden von anderen Diensten zur Verschl√ºsselung von Daten verwendet**. Es wird von dem Dienst verwendet, der es in einer Region erstellt hat. Sie werden beim ersten Mal erstellt, wenn du die Verschl√ºsselung in diesem Dienst implementierst. Wechselt alle 3 Jahre und es ist nicht m√∂glich, es zu √§ndern.
* **Kundenverwaltete CMKs**: Flexibilit√§t, Rotation, konfigurierbarer Zugriff und Schl√ºsselrichtlinie. Schl√ºssel aktivieren und deaktivieren.

**Envelope-Verschl√ºsselung** im Kontext des Key Management Service (KMS): Zweistufiges Hierarchiesystem zur **Verschl√ºsselung von Daten mit einem Datenschl√ºssel und dann zur Verschl√ºsselung des Datenschl√ºssels mit dem Master-Schl√ºssel**.

### Schl√ºsselrichtlinien

Diese definieren **wer einen Schl√ºssel in KMS verwenden und darauf zugreifen kann**.

**Standardm√§√üig:**

*   Es gibt dem **IAM des** **AWS-Kontos, das den KMS-Schl√ºssel besitzt, Zugriff**, um den Zugriff auf den KMS-Schl√ºssel √ºber IAM zu verwalten.

Im Gegensatz zu anderen AWS-Ressourcenrichtlinien gew√§hrt eine AWS **KMS-Schl√ºsselrichtlinie nicht automatisch Berechtigungen an die Prinzipale des Kontos**. Um den Kontoadministratoren Berechtigungen zu gew√§hren, **muss die Schl√ºsselrichtlinie eine explizite Aussage enthalten**, die diese Berechtigung bereitstellt, wie diese hier.

* Ohne die Erlaubnis des Kontos (`"AWS": "arn:aws:iam::111122223333:root"`) funktionieren IAM-Berechtigungen nicht.
*   Es **erlaubt dem Konto, IAM-Richtlinien zu verwenden**, um den Zugriff auf den KMS-Schl√ºssel zus√§tzlich zur Schl√ºsselrichtlinie zu erm√∂glichen.

**Ohne diese Berechtigung sind IAM-Richtlinien, die den Zugriff auf den Schl√ºssel erlauben, ineffektiv**, obwohl IAM-Richtlinien, die den Zugriff auf den Schl√ºssel verweigern, weiterhin wirksam sind.
* Es **verringert das Risiko, dass der Schl√ºssel unverwaltbar wird**, indem es den Kontoadministratoren, einschlie√ülich des Kontowurzelbenutzers, der nicht gel√∂scht werden kann, Berechtigungen f√ºr die Zugriffskontrolle gew√§hrt.

**Beispiel f√ºr eine Standardrichtlinie:**
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Wenn das **Konto erlaubt ist** (`"arn:aws:iam::111122223333:root"`), ben√∂tigt ein **Principal** aus dem Konto **trotzdem IAM-Berechtigungen**, um den KMS-Schl√ºssel zu verwenden. Wenn jedoch die **ARN** einer Rolle beispielsweise im **Schl√ºsselrichtlinie** **speziell erlaubt** ist, ben√∂tigt diese Rolle **keine IAM-Berechtigungen**.
{% endhint %}

<details>

<summary>Richtliniendetails</summary>

Eigenschaften einer Richtlinie:

* JSON-basiertes Dokument
* Ressource --> Betroffene Ressourcen (kann "\*")
* Aktion --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (Berechtigungen)
* Effekt --> Erlauben/Verweigern
* Principal --> betroffene arn
* Bedingungen (optional) --> Bedingung zur Erteilung der Berechtigungen

Grants:

* Erlaubt es, Ihre Berechtigungen an einen anderen AWS-Principal innerhalb Ihres AWS-Kontos zu delegieren. Sie m√ºssen sie mit den AWS KMS-APIs erstellen. Es kann der CMK-Identifikator, der berechtigte Principal und das erforderliche Niveau der Operation (Decrypt, Encrypt, GenerateDataKey...) angegeben werden.
* Nach der Erstellung des Grants werden ein GrantToken und eine GrantID ausgegeben.

**Zugriff**:

* √úber **Schl√ºsselrichtlinie** -- Wenn diese existiert, hat sie **Vorrang** vor der IAM-Richtlinie.
* √úber **IAM-Richtlinie**
* √úber **Grants**

</details>

### Schl√ºsseladministratoren

Schl√ºsseladministrator standardm√§√üig:

* Haben Zugriff zur Verwaltung von KMS, aber nicht zum Verschl√ºsseln oder Entschl√ºsseln von Daten.
* Nur IAM-Benutzer und -Rollen k√∂nnen zur Liste der Schl√ºsseladministratoren hinzugef√ºgt werden (keine Gruppen).
* Wenn eine externe CMK verwendet wird, haben Schl√ºsseladministratoren die Berechtigung, Schl√ºsselmaterial zu importieren.

### Rotation von CMKs

* Je l√§nger derselbe Schl√ºssel an Ort und Stelle bleibt, desto mehr Daten werden mit diesem Schl√ºssel verschl√ºsselt, und wenn dieser Schl√ºssel kompromittiert wird, desto gr√∂√üer ist der Gefahrenbereich der Daten. Dar√ºber hinaus steigt die Wahrscheinlichkeit, dass der Schl√ºssel kompromittiert wird, je l√§nger der Schl√ºssel aktiv ist.
* **KMS rotiert Kundenschl√ºssel alle 365 Tage** (oder Sie k√∂nnen den Prozess manuell durchf√ºhren, wann immer Sie m√∂chten) und **Schl√ºssel, die von AWS verwaltet werden, alle 3 Jahre**, und diese Zeit kann nicht ge√§ndert werden.
* **√Ñltere Schl√ºssel werden aufbewahrt**, um Daten zu entschl√ºsseln, die vor der Rotation verschl√ºsselt wurden.
* Bei einem Bruch wird die Rotation des Schl√ºssels die Bedrohung nicht beseitigen, da es m√∂glich sein wird, alle Daten zu entschl√ºsseln, die mit dem kompromittierten Schl√ºssel verschl√ºsselt wurden. Allerdings werden die **neuen Daten mit dem neuen Schl√ºssel verschl√ºsselt**.
* Wenn die **CMK** im Zustand **deaktiviert** oder **in der L√∂schung** **aussteht**, wird KMS **keine Schl√ºsselrotation durchf√ºhren**, bis die CMK wieder aktiviert oder die L√∂schung abgebrochen wird.

#### Manuelle Rotation

* Eine **neue CMK muss erstellt werden**, dann wird eine neue CMK-ID erstellt, sodass Sie **alle Anwendungen** **aktualisieren** m√ºssen, um die neue CMK-ID **zu referenzieren**.
* Um diesen Prozess zu erleichtern, k√∂nnen Sie **Aliase verwenden, um auf eine Schl√ºssel-ID zu verweisen** und dann einfach den Schl√ºssel aktualisieren, auf den der Alias verweist.
* Sie m√ºssen **alte Schl√ºssel aufbewahren, um alte Dateien** zu entschl√ºsseln, die damit verschl√ºsselt wurden.

Sie k√∂nnen Schl√ºssel aus Ihrer lokalen Schl√ºssel-Infrastruktur importieren.

### Weitere relevante KMS-Informationen

KMS wird pro Anzahl der von allen Diensten pro Monat empfangenen Verschl√ºsselungs-/Entschl√ºsselungsanfragen berechnet.

KMS hat eine vollst√§ndige Audit- und Compliance-**Integration mit CloudTrail**; hier k√∂nnen Sie alle √Ñnderungen, die an KMS vorgenommen wurden, √ºberpr√ºfen.

Mit der KMS-Richtlinie k√∂nnen Sie Folgendes tun:

* Einschr√§nken, wer Datenkeys erstellen kann und welche Dienste Zugriff auf diese Schl√ºssel haben.
* Den Zugriff von Systemen auf nur Verschl√ºsselung, nur Entschl√ºsselung oder beides einschr√§nken.
* Definieren, um Systemen den Zugriff auf Schl√ºssel √ºber Regionen hinweg zu erm√∂glichen (obwohl dies nicht empfohlen wird, da ein Ausfall in der Region, die KMS hostet, die Verf√ºgbarkeit von Systemen in anderen Regionen beeintr√§chtigen wird).

Sie k√∂nnen Schl√ºssel nicht √ºber Regionen hinweg synchronisieren oder verschieben/kopieren; Sie k√∂nnen nur Regeln definieren, um den Zugriff √ºber Regionen hinweg zu erm√∂glichen.

### Enumeration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
