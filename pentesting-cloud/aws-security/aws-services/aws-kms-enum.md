# AWS - KMS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS - Usuga Zarzdzania Kluczami

AWS Usuga Zarzdzania Kluczami (AWS KMS) jest przedstawiana jako zarzdzana usuga, upraszczajca proces dla u偶ytkownik贸w do **tworzenia i zarzdzania kluczami g贸wnymi klient贸w** (CMK). Te CMK s integralne w szyfrowaniu danych u偶ytkownik贸w. Zauwa偶aln cech AWS KMS jest to, 偶e CMK s g贸wnie **zabezpieczone przez moduy bezpieczestwa sprztowego** (HSM), co zwiksza ochron kluczy szyfrujcych.

KMS u偶ywa **szyfrowania symetrycznego**. Jest to u偶ywane do **szyfrowania informacji w spoczynku** (na przykad, wewntrz S3). Jeli potrzebujesz **szyfrowa informacje w tranzycie**, musisz u偶y czego takiego jak **TLS**.

KMS jest **usug specyficzn dla regionu**.

**Administratorzy w Amazonie nie maj dostpu do twoich kluczy**. Nie mog odzyska twoich kluczy i nie pomagaj w szyfrowaniu twoich kluczy. AWS po prostu zarzdza systemem operacyjnym i podstawow aplikacj, to od nas zale偶y zarzdzanie naszymi kluczami szyfrujcymi i zarzdzanie tym, jak te klucze s u偶ywane.

**Klucze G贸wne Klienta** (CMK): Mog szyfrowa dane o rozmiarze do 4KB. Zwykle s u偶ywane do tworzenia, szyfrowania i deszyfrowania DEK (Kluczy Szyfrowania Danych). Nastpnie DEK s u偶ywane do szyfrowania danych.

Klucz g贸wny klienta (CMK) jest logiczn reprezentacj klucza g贸wnego w AWS KMS. Opr贸cz identyfikator贸w klucza g贸wnego i innych metadanych, w tym daty utworzenia, opisu i stanu klucza, **CMK zawiera materia klucza, kt贸ry jest u偶ywany do szyfrowania i deszyfrowania danych**. Kiedy tworzysz CMK, domylnie AWS KMS generuje materia klucza dla tego CMK. Mo偶esz jednak zdecydowa si na utworzenie CMK bez materiau klucza, a nastpnie zaimportowa wasny materia klucza do tego CMK.

Istniej 2 typy kluczy g贸wnych:

* **CMK zarzdzane przez AWS: U偶ywane przez inne usugi do szyfrowania danych**. S u偶ywane przez usug, kt贸ra je utworzya w danym regionie. S tworzone po raz pierwszy, gdy wdra偶asz szyfrowanie w tej usudze. Rotuj co 3 lata i nie mo偶na ich zmieni.
* **CMK zarzdzane przez klienta**: Elastyczno, rotacja, konfigurowalny dostp i polityka klucza. Wczanie i wyczanie kluczy.

**Szyfrowanie w Kopercie** w kontekcie Usugi Zarzdzania Kluczami (KMS): System hierarchii dw贸ch poziom贸w do **szyfrowania danych za pomoc klucza danych, a nastpnie szyfrowania klucza danych za pomoc klucza g贸wnego**.

### Polityki Kluczy

Te definiuj **kto mo偶e u偶ywa i uzyskiwa dostp do klucza w KMS**.

**Domylnie:**

*   Daje **peny dostp do klucza KMS kontu AWS, kt贸re posiada klucz KMS**.

W przeciwiestwie do innych polityk zasob贸w AWS, polityka **klucza KMS AWS nie przyznaje automatycznie uprawnie kontu ani 偶adnemu z jego u偶ytkownik贸w**. Aby przyzna uprawnienia administratorom konta, **polityka klucza musi zawiera wyra藕ne owiadczenie** przyznajce te uprawnienia, takie jak to.

* Bez zezwolenia konta(`"AWS": "arn:aws:iam::111122223333:root"`) uprawnienia IAM nie bd dziaa.
*   **Pozwala kontu u偶ywa polityk IAM** do zezwolenia na dostp do klucza KMS, opr贸cz polityki klucza.

**Bez tego zezwolenia polityki IAM, kt贸re zezwalaj na dostp do klucza, s nieskuteczne**, chocia偶 polityki IAM, kt贸re odmawiaj dostpu do klucza, s nadal skuteczne.
* **Zmniejsza ryzyko, 偶e klucz stanie si niezarzdzalny** poprzez przyznanie uprawnie do kontroli dostpu administratorom konta, w tym u偶ytkownikowi g贸wnemu konta, kt贸rego nie mo偶na usun.

**Przykad domylnej polityki**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Jeli **konto jest dozwolone** (`"arn:aws:iam::111122223333:root"`), **podmiot** z konta **wci偶 potrzebuje uprawnie IAM** do u偶ycia klucza KMS. Jednak jeli **ARN** roli na przykad jest **specjalnie dozwolony** w **polityce klucza**, ta rola **nie potrzebuje uprawnie IAM**.
{% endhint %}

<details>

<summary>Szczeg贸y polityki</summary>

Waciwoci polityki:

* Dokument oparty na JSON
* Zas贸b --> Dotknite zasoby (mo偶e by "\*")
* Akcja --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (uprawnienia)
* Efekt --> Zezw贸l/Odm贸w
* Podmiot --> arn dotknity
* Warunki (opcjonalne) --> Warunek przyznajcy uprawnienia

Granty:

* Zezwala na delegowanie swoich uprawnie innemu podmiotowi AWS w ramach twojego konta AWS. Musisz je utworzy za pomoc interfejs贸w API AWS KMS. Mo偶na wskaza identyfikator CMK, podmiot przyznajcy i wymagany poziom operacji (Decrypt, Encrypt, GenerateDataKey...)
* Po utworzeniu grantu wydawany jest GrantToken i GrantID

**Dostp**:

* Poprzez **polityk klucza** -- Jeli to istnieje, ma **pierwszestwo** przed polityk IAM
* Poprzez **polityk IAM**
* Poprzez **granty**

</details>

### Administratorzy kluczy

Administratorzy kluczy domylnie:

* Maj dostp do zarzdzania KMS, ale nie do szyfrowania ani deszyfrowania danych
* Tylko u偶ytkownicy IAM i role mog by dodawani do listy administrator贸w kluczy (nie grupy)
* Jeli u偶ywany jest zewntrzny CMK, administratorzy kluczy maj uprawnienia do importowania materiau klucza

### Rotacja CMK

* Im du偶ej ten sam klucz pozostaje na miejscu, tym wicej danych jest szyfrowanych tym kluczem, a jeli ten klucz zostanie naruszony, tym szerszy obszar danych jest nara偶ony na ryzyko. Opr贸cz tego, im du偶ej klucz jest aktywny, tym wiksze prawdopodobiestwo, 偶e zostanie naruszony.
* **KMS rotuje klucze klient贸w co 365 dni** (lub mo偶esz przeprowadzi proces rcznie, kiedy chcesz) oraz **klucze zarzdzane przez AWS co 3 lata**, a tego czasu nie mo偶na zmieni.
* **Starsze klucze s zachowywane** do deszyfrowania danych, kt贸re zostay zaszyfrowane przed rotacj
* W przypadku naruszenia, rotacja klucza nie usunie zagro偶enia, poniewa偶 mo偶liwe bdzie deszyfrowanie wszystkich danych zaszyfrowanych skompromitowanym kluczem. Jednak **nowe dane bd szyfrowane nowym kluczem**.
* Jeli **CMK** jest w stanie **wyczonym** lub **oczekujcym** **usunicia**, KMS **nie przeprowadzi rotacji klucza**, dop贸ki CMK nie zostanie ponownie wczony lub usunicie nie zostanie anulowane.

#### Rczna rotacja

* **Nowy CMK musi by utworzony**, nastpnie tworzony jest nowy identyfikator CMK, wic bdziesz musia **zaktualizowa** ka偶d **aplikacj**, aby **odnosia si** do nowego identyfikatora CMK.
* Aby uatwi ten proces, mo偶esz **u偶ywa alias贸w do odniesienia si do identyfikatora klucza** i nastpnie po prostu zaktualizowa klucz, do kt贸rego odnosi si alias.
* Musisz **zachowa stare klucze do deszyfrowania starych plik贸w** zaszyfrowanych tym kluczem.

Mo偶esz importowa klucze z wasnej infrastruktury kluczy lokalnych.

### Inne istotne informacje KMS

KMS jest wyceniane na podstawie liczby 偶da szyfrowania/deszyfrowania otrzymanych od wszystkich usug miesicznie.

KMS ma pen integracj audytow i zgodnoci **z CloudTrail**; to tutaj mo偶esz audytowa wszystkie zmiany dokonane w KMS.

Dziki polityce KMS mo偶esz zrobi nastpujce rzeczy:

* Ograniczy, kto mo偶e tworzy klucze danych i kt贸re usugi maj dostp do u偶ywania tych kluczy
* Ograniczy dostp system贸w tylko do szyfrowania, tylko do deszyfrowania lub obu
* Zdefiniowa, aby umo偶liwi systemom dostp do kluczy w r贸偶nych regionach (chocia偶 nie jest to zalecane, poniewa偶 awaria w regionie hostujcym KMS wpynie na dostpno system贸w w innych regionach).

Nie mo偶esz synchronizowa ani przenosi/kopiowa kluczy midzy regionami; mo偶esz tylko zdefiniowa zasady, aby umo偶liwi dostp midzy regionami.

### Enumeracja
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
