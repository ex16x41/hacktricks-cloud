# AWS - CloudHSM Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## HSM - M칩dulo de Seguridad de Hardware

Cloud HSM es un **dispositivo de hardware** validado de nivel dos FIPS 140 para almacenamiento seguro de claves criptogr치ficas (ten en cuenta que CloudHSM es un dispositivo de hardware, no es un servicio virtualizado). Es un dispositivo SafeNetLuna 7000 con 5.3.13 preinstalado. Hay dos versiones de firmware y cu치l elijas realmente depende de tus necesidades exactas. Una es para cumplimiento de FIPS 140-2 y hab칤a una versi칩n m치s nueva que se puede usar.

La caracter칤stica inusual de CloudHSM es que es un dispositivo f칤sico, y por lo tanto **no se comparte con otros clientes**, o como com칰nmente se denomina, multi-tenant. Es un dispositivo de un solo inquilino dedicado exclusivamente a tus cargas de trabajo.

T칤picamente, un dispositivo est치 disponible en 15 minutos, asumiendo que hay capacidad, pero en algunas zonas podr칤a no haberla.

Dado que este es un dispositivo f칤sico dedicado a ti, **las claves se almacenan en el dispositivo**. Las claves deben ser **replicadas a otro dispositivo**, respaldadas en almacenamiento fuera de l칤nea, o exportadas a un dispositivo de reserva. **Este dispositivo no est치 respaldado** por S3 ni por ning칰n otro servicio en AWS como KMS.

En **CloudHSM**, tienes que **escalar el servicio t칰 mismo**. Debes aprovisionar suficientes dispositivos CloudHSM para manejar tus necesidades de cifrado basadas en los algoritmos de cifrado que has elegido implementar para tu soluci칩n.\
La escalabilidad del Servicio de Gesti칩n de Claves es realizada por AWS y se escala autom치ticamente seg칰n la demanda, as칤 que a medida que tu uso crece, tambi칠n podr칤a crecer el n칰mero de dispositivos CloudHSM que se requieren. Ten esto en cuenta a medida que escalas tu soluci칩n y si tu soluci칩n tiene escalado autom치tico, aseg칰rate de que tu escala m치xima est칠 contemplada con suficientes dispositivos CloudHSM para atender la soluci칩n.

Al igual que la escalabilidad, **el rendimiento depende de ti con CloudHSM**. El rendimiento var칤a seg칰n el algoritmo de cifrado utilizado y con qu칠 frecuencia necesitas acceder o recuperar las claves para cifrar los datos. El rendimiento del servicio de gesti칩n de claves es manejado por Amazon y se escala autom치ticamente seg칰n la demanda. El rendimiento de CloudHSM se logra a침adiendo m치s dispositivos y si necesitas m치s rendimiento, simplemente a침ades dispositivos o alteras el m칠todo de cifrado al algoritmo que es m치s r치pido.

Si tu soluci칩n es **multi-regi칩n**, deber칤as a침adir varios **dispositivos CloudHSM en la segunda regi칩n y resolver la conectividad entre regiones con una conexi칩n VPN privada** o alg칰n m칠todo para asegurar que el tr치fico est칠 siempre protegido entre el dispositivo en cada capa de la conexi칩n. Si tienes una soluci칩n multi-regi칩n, necesitas pensar en c칩mo **replicar claves y configurar dispositivos CloudHSM adicionales en las regiones donde operas**. Puedes r치pidamente entrar en un escenario donde tienes seis u ocho dispositivos distribuidos en m칰ltiples regiones, habilitando la redundancia total de tus claves de cifrado.

**CloudHSM** es un servicio de clase empresarial para almacenamiento seguro de claves y puede ser utilizado como un **ra칤z de confianza para una empresa**. Puede almacenar claves privadas en PKI y claves de autoridad de certificaci칩n en implementaciones X509. Adem치s de claves sim칠tricas utilizadas en algoritmos sim칠tricos como AES, **KMS almacena y protege f칤sicamente solo claves sim칠tricas (no puede actuar como una autoridad de certificaci칩n)**, as칤 que si necesitas almacenar claves de PKI y CA, uno, dos o tres CloudHSM podr칤an ser tu soluci칩n.

**CloudHSM es considerablemente m치s caro que el Servicio de Gesti칩n de Claves**. CloudHSM es un dispositivo de hardware, por lo que tienes costos fijos para aprovisionar el dispositivo CloudHSM, luego un costo por hora para operar el dispositivo. El costo se multiplica por la cantidad de dispositivos CloudHSM que se requieren para cumplir con tus requisitos espec칤ficos.\
Adem치s, se debe considerar la compra de software de terceros como las suites de software SafeNet ProtectV y el tiempo y esfuerzo de integraci칩n. El Servicio de Gesti칩n de Claves es basado en uso y depende del n칰mero de claves que tienes y de las operaciones de entrada y salida. Como la gesti칩n de claves proporciona integraci칩n sin problemas con muchos servicios de AWS, los costos de integraci칩n deber칤an ser significativamente m치s bajos. Los costos deben considerarse un factor secundario en las soluciones de cifrado. El cifrado se utiliza t칤picamente para seguridad y cumplimiento.

**Con CloudHSM solo t칰 tienes acceso a las claves** y sin entrar en demasiados detalles, con CloudHSM gestionas tus propias claves. **Con KMS, t칰 y Amazon co-gestionan tus claves**. AWS tiene muchas salvaguardias de pol칤ticas contra el abuso y **a칰n no puede acceder a tus claves en ninguna de las soluciones**. La principal distinci칩n es el cumplimiento en lo que respecta a la propiedad y gesti칩n de claves, y con CloudHSM, este es un dispositivo de hardware que t칰 gestionas y mantienes con acceso exclusivo para ti y solo para ti.

### Sugerencias de CloudHSM

1. Siempre despliega CloudHSM en una **configuraci칩n HA** con al menos dos dispositivos en **zonas de disponibilidad separadas**, y si es posible, despliega un tercero ya sea en las instalaciones o en otra regi칩n de AWS.
2. Ten cuidado al **inicializar** un **CloudHSM**. Esta acci칩n **destruir치 las claves**, as칤 que o bien ten otra copia de las claves o aseg칰rate absolutamente de que no las necesitas y nunca, jam치s necesitar치s estas claves para descifrar ning칰n dato.
3. CloudHSM solo **soporta ciertas versiones de firmware** y software. Antes de realizar cualquier actualizaci칩n, aseg칰rate de que el firmware y/o software sea compatible con AWS. Siempre puedes contactar al soporte de AWS para verificar si la gu칤a de actualizaci칩n no est치 clara.
4. La **configuraci칩n de red nunca debe ser cambiada.** Recuerda, est치 en un centro de datos de AWS y AWS est치 monitoreando el hardware base por ti. Esto significa que si el hardware falla, lo reemplazar치n por ti, pero solo si saben que fall칩.
5. El **reenv칤o de SysLog no debe ser eliminado o cambiado**. Siempre puedes **agregar** un reenv칤o de SysLog para dirigir los registros a tu propia herramienta de recopilaci칩n.
6. La configuraci칩n de **SNMP** tiene las mismas restricciones b치sicas que la red y la carpeta SysLog. Esto **no debe ser cambiado o eliminado**. Una configuraci칩n adicional de SNMP est치 bien, solo aseg칰rate de no cambiar la que ya est치 en el dispositivo.
7. Otra buena pr치ctica interesante de AWS es **no cambiar la configuraci칩n de NTP**. No est치 claro qu칠 suceder칤a si lo hicieras, as칤 que ten en cuenta que si no usas la misma configuraci칩n de NTP para el resto de tu soluci칩n, podr칤as tener dos fuentes de tiempo. Solo ten esto en mente y sabe que el CloudHSM debe permanecer con la fuente NTP existente.

El cargo inicial por el lanzamiento de CloudHSM es de $5,000 para asignar el dispositivo de hardware dedicado para tu uso, luego hay un cargo por hora asociado con la operaci칩n de CloudHSM que actualmente es de $1.88 por hora de operaci칩n, o aproximadamente $1,373 por mes.

La raz칩n m치s com칰n para usar CloudHSM son los est치ndares de cumplimiento que debes cumplir por razones regulatorias. **KMS no ofrece soporte de datos para claves asim칠tricas. CloudHSM te permite almacenar claves asim칠tricas de forma segura**.

La **clave p칰blica se instala en el dispositivo HSM durante el aprovisionamiento** para que puedas acceder a la instancia de CloudHSM a trav칠s de SSH.

### 쯈u칠 es un M칩dulo de Seguridad de Hardware?

Un m칩dulo de seguridad de hardware (HSM) es un dispositivo criptogr치fico dedicado que se utiliza para generar, almacenar y gestionar claves criptogr치ficas y proteger datos sensibles. Est치 dise침ado para proporcionar un alto nivel de seguridad al aislar f칤sica y electr칩nicamente las funciones criptogr치ficas del resto del sistema.

La forma en que funciona un HSM puede variar seg칰n el modelo y fabricante espec칤ficos, pero generalmente, los siguientes pasos ocurren:

1. **Generaci칩n de claves**: El HSM genera una clave criptogr치fica aleatoria utilizando un generador de n칰meros aleatorios seguro.
2. **Almacenamiento de claves**: La clave se **almacena de forma segura dentro del HSM, donde solo puede ser accedida por usuarios o procesos autorizados**.
3. **Gesti칩n de claves**: El HSM proporciona una gama de funciones de gesti칩n de claves, incluyendo rotaci칩n de claves, respaldo y revocaci칩n.
4. **Operaciones criptogr치ficas**: El HSM realiza una variedad de operaciones criptogr치ficas, incluyendo cifrado, descifrado, firma digital e intercambio de claves. Estas operaciones se **realizan dentro del entorno seguro del HSM**, lo que protege contra el acceso no autorizado y la manipulaci칩n.
5. **Registro de auditor칤a**: El HSM registra todas las operaciones criptogr치ficas y los intentos de acceso, que pueden ser utilizados para fines de auditor칤a de cumplimiento y seguridad.

Los HSM pueden ser utilizados para una amplia gama de aplicaciones, incluyendo transacciones en l칤nea seguras, certificados digitales, comunicaciones seguras y cifrado de datos. A menudo se utilizan en industrias que requieren un alto nivel de seguridad, como finanzas, salud y gobierno.

En general, el alto nivel de seguridad proporcionado por los HSM hace que **sea muy dif칤cil extraer claves en bruto de ellos, y intentar hacerlo a menudo se considera una violaci칩n de seguridad**. Sin embargo, puede haber **ciertos escenarios** donde una **clave en bruto podr칤a ser extra칤da** por personal autorizado para prop칩sitos espec칤ficos, como en el caso de un procedimiento de recuperaci칩n de claves.

### Enumeraci칩n
```
TODO
```
{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
