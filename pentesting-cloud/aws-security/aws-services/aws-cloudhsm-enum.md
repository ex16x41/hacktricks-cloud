# AWS - CloudHSM Enum

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## HSM - M√≥dulo de Seguran√ßa de Hardware

O Cloud HSM √© um **dispositivo de hardware** validado no n√≠vel dois do FIPS 140 para armazenamento seguro de chaves criptogr√°ficas (note que o CloudHSM √© um appliance de hardware, n√£o √© um servi√ßo virtualizado). √â um appliance SafeNetLuna 7000 com 5.3.13 pr√©-carregado. Existem duas vers√µes de firmware e a escolha de qual usar depende realmente das suas necessidades exatas. Uma √© para conformidade com o FIPS 140-2 e h√° uma vers√£o mais nova que pode ser utilizada.

A caracter√≠stica incomum do CloudHSM √© que √© um dispositivo f√≠sico, e, portanto, **n√£o √© compartilhado com outros clientes**, ou como √© comumente chamado, multi-tenant. √â um appliance dedicado de √∫nico inquilino exclusivamente dispon√≠vel para suas cargas de trabalho.

Normalmente, um dispositivo est√° dispon√≠vel em 15 minutos, assumindo que h√° capacidade, mas em algumas zonas isso pode n√£o ser o caso.

Como este √© um dispositivo f√≠sico dedicado a voc√™, **as chaves s√£o armazenadas no dispositivo**. As chaves precisam ser **replicadas para outro dispositivo**, feitas backup em armazenamento offline, ou exportadas para um appliance de espera. **Este dispositivo n√£o √© respaldado** pelo S3 ou qualquer outro servi√ßo da AWS como o KMS.

No **CloudHSM**, voc√™ tem que **escalar o servi√ßo voc√™ mesmo**. Voc√™ precisa provisionar dispositivos CloudHSM suficientes para atender √†s suas necessidades de criptografia com base nos algoritmos de criptografia que voc√™ escolheu implementar para sua solu√ß√£o.\
A escalabilidade do Key Management Service √© realizada pela AWS e escala automaticamente sob demanda, ent√£o, √† medida que seu uso cresce, o n√∫mero de appliances CloudHSM necess√°rios tamb√©m pode aumentar. Tenha isso em mente ao escalar sua solu√ß√£o e, se sua solu√ß√£o tiver auto-escalonamento, certifique-se de que sua escala m√°xima esteja contabilizada com dispositivos CloudHSM suficientes para atender √† solu√ß√£o.

Assim como a escalabilidade, **o desempenho depende de voc√™ com o CloudHSM**. O desempenho varia com base no algoritmo de criptografia utilizado e na frequ√™ncia com que voc√™ precisa acessar ou recuperar as chaves para criptografar os dados. O desempenho do servi√ßo de gerenciamento de chaves √© tratado pela Amazon e escala automaticamente conforme a demanda exige. O desempenho do CloudHSM √© alcan√ßado adicionando mais appliances e, se voc√™ precisar de mais desempenho, voc√™ adiciona dispositivos ou altera o m√©todo de criptografia para um algoritmo mais r√°pido.

Se sua solu√ß√£o for **multi-regi√£o**, voc√™ deve adicionar v√°rios **appliances CloudHSM na segunda regi√£o e resolver a conectividade entre regi√µes com uma conex√£o VPN privada** ou algum m√©todo para garantir que o tr√°fego esteja sempre protegido entre o appliance em cada camada da conex√£o. Se voc√™ tiver uma solu√ß√£o multi-regi√£o, precisa pensar em como **replicar chaves e configurar dispositivos CloudHSM adicionais nas regi√µes onde voc√™ opera**. Voc√™ pode rapidamente entrar em um cen√°rio onde tem seis ou oito dispositivos espalhados por v√°rias regi√µes, permitindo total redund√¢ncia de suas chaves de criptografia.

**CloudHSM** √© um servi√ßo de classe empresarial para armazenamento seguro de chaves e pode ser usado como uma **raiz de confian√ßa para uma empresa**. Ele pode armazenar chaves privadas em PKI e chaves de autoridade certificadora em implementa√ß√µes X509. Al√©m das chaves sim√©tricas usadas em algoritmos sim√©tricos como AES, **o KMS armazena e protege fisicamente apenas chaves sim√©tricas (n√£o pode atuar como uma autoridade certificadora)**, ent√£o, se voc√™ precisar armazenar chaves PKI e CA, um ou dois ou tr√™s CloudHSM podem ser sua solu√ß√£o.

**CloudHSM √© consideravelmente mais caro que o Key Management Service**. O CloudHSM √© um appliance de hardware, ent√£o voc√™ tem custos fixos para provisionar o dispositivo CloudHSM, al√©m de um custo por hora para operar o appliance. O custo √© multiplicado pelo n√∫mero de appliances CloudHSM necess√°rios para atender aos seus requisitos espec√≠ficos.\
Al√©m disso, deve-se considerar a compra de software de terceiros, como su√≠tes de software SafeNet ProtectV e o tempo e esfor√ßo de integra√ß√£o. O Key Management Service √© baseado em uso e depende do n√∫mero de chaves que voc√™ possui e das opera√ß√µes de entrada e sa√≠da. Como o gerenciamento de chaves fornece integra√ß√£o perfeita com muitos servi√ßos da AWS, os custos de integra√ß√£o devem ser significativamente menores. Os custos devem ser considerados um fator secund√°rio em solu√ß√µes de criptografia. A criptografia √© tipicamente usada para seguran√ßa e conformidade.

**Com o CloudHSM, apenas voc√™ tem acesso √†s chaves** e, sem entrar em muitos detalhes, com o CloudHSM voc√™ gerencia suas pr√≥prias chaves. **Com o KMS, voc√™ e a Amazon co-gerenciam suas chaves**. A AWS possui muitas salvaguardas de pol√≠ticas contra abusos e **ainda n√£o pode acessar suas chaves em nenhuma das solu√ß√µes**. A principal distin√ß√£o √© a conformidade em rela√ß√£o √† propriedade e gerenciamento de chaves, e com o CloudHSM, este √© um appliance de hardware que voc√™ gerencia e mant√©m com acesso exclusivo a voc√™ e somente voc√™.

### Sugest√µes para CloudHSM

1. Sempre implemente o CloudHSM em uma **configura√ß√£o HA** com pelo menos dois appliances em **zonas de disponibilidade separadas**, e, se poss√≠vel, implemente um terceiro, seja no local ou em outra regi√£o da AWS.
2. Tenha cuidado ao **inicializar** um **CloudHSM**. Esta a√ß√£o **destruir√° as chaves**, ent√£o tenha outra c√≥pia das chaves ou tenha certeza absoluta de que voc√™ n√£o precisa e nunca precisar√° dessas chaves para descriptografar qualquer dado.
3. O CloudHSM apenas **suporta certas vers√µes de firmware** e software. Antes de realizar qualquer atualiza√ß√£o, certifique-se de que o firmware e/ou software √© suportado pela AWS. Voc√™ pode sempre entrar em contato com o suporte da AWS para verificar se o guia de atualiza√ß√£o n√£o est√° claro.
4. A **configura√ß√£o de rede nunca deve ser alterada.** Lembre-se, est√° em um data center da AWS e a AWS est√° monitorando o hardware base para voc√™. Isso significa que, se o hardware falhar, eles o substituir√£o para voc√™, mas apenas se souberem que falhou.
5. O **encaminhamento SysLog n√£o deve ser removido ou alterado**. Voc√™ pode sempre **adicionar** um encaminhador SysLog para direcionar os logs para sua pr√≥pria ferramenta de coleta.
6. A configura√ß√£o de **SNMP** tem as mesmas restri√ß√µes b√°sicas que a rede e a pasta SysLog. Isso **n√£o deve ser alterado ou removido**. Uma configura√ß√£o **adicional** de SNMP √© aceit√°vel, apenas certifique-se de n√£o alterar a que j√° est√° no appliance.
7. Outra boa pr√°tica interessante da AWS √© **n√£o alterar a configura√ß√£o NTP**. N√£o est√° claro o que aconteceria se voc√™ o fizesse, ent√£o tenha em mente que, se voc√™ n√£o usar a mesma configura√ß√£o NTP para o resto de sua solu√ß√£o, poder√° ter duas fontes de tempo. Apenas esteja ciente disso e saiba que o CloudHSM deve permanecer com a fonte NTP existente.

A cobran√ßa inicial para o CloudHSM √© de $5,000 para alocar o appliance de hardware dedicado para seu uso, depois h√° uma cobran√ßa hor√°ria associada √† execu√ß√£o do CloudHSM que atualmente √© de $1.88 por hora de opera√ß√£o, ou aproximadamente $1,373 por m√™s.

A raz√£o mais comum para usar o CloudHSM s√£o os padr√µes de conformidade que voc√™ deve atender por raz√µes regulat√≥rias. **O KMS n√£o oferece suporte a dados para chaves assim√©tricas. O CloudHSM permite que voc√™ armazene chaves assim√©tricas com seguran√ßa**.

A **chave p√∫blica √© instalada no appliance HSM durante o provisionamento** para que voc√™ possa acessar a inst√¢ncia CloudHSM via SSH.

### O que √© um M√≥dulo de Seguran√ßa de Hardware

Um m√≥dulo de seguran√ßa de hardware (HSM) √© um dispositivo criptogr√°fico dedicado que √© usado para gerar, armazenar e gerenciar chaves criptogr√°ficas e proteger dados sens√≠veis. Ele √© projetado para fornecer um alto n√≠vel de seguran√ßa isolando fisicamente e eletronicamente as fun√ß√µes criptogr√°ficas do restante do sistema.

A forma como um HSM funciona pode variar dependendo do modelo e fabricante espec√≠ficos, mas, geralmente, os seguintes passos ocorrem:

1. **Gera√ß√£o de chaves**: O HSM gera uma chave criptogr√°fica aleat√≥ria usando um gerador de n√∫meros aleat√≥rios seguro.
2. **Armazenamento de chaves**: A chave √© **armazenada com seguran√ßa dentro do HSM, onde s√≥ pode ser acessada por usu√°rios ou processos autorizados**.
3. **Gerenciamento de chaves**: O HSM fornece uma gama de fun√ß√µes de gerenciamento de chaves, incluindo rota√ß√£o de chaves, backup e revoga√ß√£o.
4. **Opera√ß√µes criptogr√°ficas**: O HSM realiza uma variedade de opera√ß√µes criptogr√°ficas, incluindo criptografia, descriptografia, assinatura digital e troca de chaves. Essas opera√ß√µes s√£o **realizadas dentro do ambiente seguro do HSM**, que protege contra acesso n√£o autorizado e adultera√ß√£o.
5. **Registro de auditoria**: O HSM registra todas as opera√ß√µes criptogr√°ficas e tentativas de acesso, que podem ser usadas para fins de conformidade e auditoria de seguran√ßa.

Os HSMs podem ser usados para uma ampla gama de aplica√ß√µes, incluindo transa√ß√µes online seguras, certificados digitais, comunica√ß√µes seguras e criptografia de dados. Eles s√£o frequentemente usados em ind√∫strias que exigem um alto n√≠vel de seguran√ßa, como finan√ßas, sa√∫de e governo.

No geral, o alto n√≠vel de seguran√ßa fornecido pelos HSMs torna **muito dif√≠cil extrair chaves brutas deles, e tentar faz√™-lo √© frequentemente considerado uma viola√ß√£o de seguran√ßa**. No entanto, pode haver **certos cen√°rios** onde uma **chave bruta poderia ser extra√≠da** por pessoal autorizado para fins espec√≠ficos, como no caso de um procedimento de recupera√ß√£o de chaves.

### Enumera√ß√£o
```
TODO
```
{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Treinamento AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Treinamento GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
