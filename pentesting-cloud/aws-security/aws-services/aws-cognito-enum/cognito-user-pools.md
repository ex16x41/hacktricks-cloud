# Cognito User Pools

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

KullanÄ±cÄ± havuzu, Amazon Cognito'daki bir kullanÄ±cÄ± dizinidir. Bir kullanÄ±cÄ± havuzu ile kullanÄ±cÄ±larÄ±nÄ±z **Amazon Cognito Ã¼zerinden web veya mobil uygulamanÄ±za giriÅŸ yapabilir** veya **Ã¼Ã§Ã¼ncÃ¼ taraf** bir kimlik saÄŸlayÄ±cÄ±sÄ± (IdP) aracÄ±lÄ±ÄŸÄ±yla **federasyon** yapabilir. KullanÄ±cÄ±larÄ±nÄ±z doÄŸrudan veya bir Ã¼Ã§Ã¼ncÃ¼ taraf aracÄ±lÄ±ÄŸÄ±yla giriÅŸ yapsa da, kullanÄ±cÄ± havuzunun tÃ¼m Ã¼yeleri, bir SDK aracÄ±lÄ±ÄŸÄ±yla eriÅŸebileceÄŸiniz bir dizin profiline sahiptir.

KullanÄ±cÄ± havuzlarÄ± ÅŸunlarÄ± saÄŸlar:

* KayÄ±t ve giriÅŸ hizmetleri.
* KullanÄ±cÄ±larÄ± giriÅŸ yaptÄ±rmak iÃ§in yerleÅŸik, Ã¶zelleÅŸtirilebilir bir web arayÃ¼zÃ¼.
* Facebook, Google, Amazon ile GiriÅŸ ve Apple ile GiriÅŸ gibi sosyal giriÅŸler ve kullanÄ±cÄ± havuzunuzdan SAML ve OIDC kimlik saÄŸlayÄ±cÄ±larÄ± aracÄ±lÄ±ÄŸÄ±yla.
* KullanÄ±cÄ± dizini yÃ¶netimi ve kullanÄ±cÄ± profilleri.
* Ã‡ok faktÃ¶rlÃ¼ kimlik doÄŸrulama (MFA), ele geÃ§irilmiÅŸ kimlik bilgileri kontrolÃ¼, hesap ele geÃ§irme korumasÄ± ve telefon ve e-posta doÄŸrulamasÄ± gibi gÃ¼venlik Ã¶zellikleri.
* AWS Lambda tetikleyicileri aracÄ±lÄ±ÄŸÄ±yla Ã¶zelleÅŸtirilmiÅŸ iÅŸ akÄ±ÅŸlarÄ± ve kullanÄ±cÄ± gÃ¶Ã§Ã¼.

UygulamalarÄ±n **kaynak kodu** genellikle **kullanÄ±cÄ± havuzu kimliÄŸi** ve **istemci uygulama kimliÄŸi** (ve bazen **uygulama sÄ±rrÄ±**?) iÃ§erir; bunlar, bir kullanÄ±cÄ±nÄ±n Cognito KullanÄ±cÄ± Havuzuna **giriÅŸ yapmasÄ±** iÃ§in gereklidir.

### Potansiyel saldÄ±rÄ±lar

* **KayÄ±t**: VarsayÄ±lan olarak bir kullanÄ±cÄ± kendini kaydedebilir, bu nedenle kendisi iÃ§in bir kullanÄ±cÄ± oluÅŸturabilir.
* **KullanÄ±cÄ± numarasÄ± belirleme**: KayÄ±t iÅŸlevi, zaten var olan kullanÄ±cÄ± adlarÄ±nÄ± bulmak iÃ§in kullanÄ±labilir. Bu bilgi, kaba kuvvet saldÄ±rÄ±sÄ± iÃ§in yararlÄ± olabilir.
* **GiriÅŸ kaba kuvvet**: [**Kimlik DoÄŸrulama**](cognito-user-pools.md#authentication) bÃ¶lÃ¼mÃ¼nde, bir kullanÄ±cÄ±nÄ±n **giriÅŸ yapmasÄ±** iÃ§in sahip olduÄŸu tÃ¼m **yÃ¶ntemleri** bulabilirsiniz; bunlarÄ± **geÃ§erli kimlik bilgilerini bulmak iÃ§in** kaba kuvvetle denemek isteyebilirsiniz.

### Pentesting iÃ§in araÃ§lar

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), artÄ±k bir hesapta tÃ¼m Cognito varlÄ±klarÄ±nÄ±n sayÄ±mÄ±nÄ± otomatikleÅŸtiren ve zayÄ±f yapÄ±landÄ±rmalarÄ±, eriÅŸim kontrolÃ¼ iÃ§in kullanÄ±lan kullanÄ±cÄ± Ã¶zniteliklerini vb. iÅŸaret eden `cognito__enum` ve `cognito__attack` modÃ¼llerini iÃ§eriyor ve ayrÄ±ca kullanÄ±cÄ± oluÅŸturmayÄ± (MFA desteÄŸi dahil) ve deÄŸiÅŸtirilebilir Ã¶zel Ã¶zniteliklere, kullanÄ±labilir kimlik havuzu kimlik bilgilerine, id token'larÄ±ndaki Ã¼stlenilebilir rollere dayalÄ± ayrÄ±calÄ±k yÃ¼kseltmeyi otomatikleÅŸtiriyor.\
ModÃ¼llerin iÅŸlevleri hakkÄ±nda bilgi iÃ§in [blog yazÄ±sÄ±nÄ±n](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2) 2. kÄ±smÄ±na bakÄ±n. Kurulum talimatlarÄ± iÃ§in ana [Pacu](https://github.com/RhinoSecurityLabs/pacu) sayfasÄ±na bakÄ±n.
```bash
# Run cognito__enum usage to gather all user pools, user pool clients, identity pools, users, etc. visible in the current AWS account
Pacu (new:test) > run cognito__enum

# cognito__attack usage to attempt user creation and all privesc vectors against a given identity pool and user pool client:
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner), istenmeyen hesap oluÅŸturma ve hesap oracle'Ä± da dahil olmak Ã¼zere Cognito Ã¼zerinde farklÄ± saldÄ±rÄ±larÄ± uygulayan bir Python CLI aracÄ±dÄ±r. Daha fazla bilgi iÃ§in [bu baÄŸlantÄ±ya](https://github.com/padok-team/cognito-scanner) bakÄ±n.
```bash
# Install
pip install cognito-scanner
# Run
cognito-scanner --help
```
* [CognitoAttributeEnum](https://github.com/punishell/CognitoAttributeEnum): Bu script, kullanÄ±cÄ±lar iÃ§in geÃ§erli nitelikleri listelemeye olanak tanÄ±r.
```bash
python cognito-attribute-enu.py -client_id 16f1g98bfuj9i0g3f8be36kkrl
```
## KayÄ±t

User Pools, **varsayÄ±lan olarak** **yeni kullanÄ±cÄ±larÄ±n kaydolmasÄ±na** izin verir.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### EÄŸer herkes kayÄ±t olabiliyorsa

KullanÄ±cÄ± hakkÄ±nda **daha fazla ayrÄ±ntÄ± saÄŸlamanÄ±z gerektiÄŸini** belirten bir hata bulabilirsiniz:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
AÅŸaÄŸÄ±daki gibi bir JSON ile gerekli bilgileri saÄŸlayabilirsiniz:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
Bu iÅŸlevselliÄŸi **mevcut kullanÄ±cÄ±larÄ± listelemek** iÃ§in de kullanabilirsiniz. O isimle zaten bir kullanÄ±cÄ± varsa hata mesajÄ±:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Ã–nceki komutta **Ã¶zel niteliklerin "custom:" ile baÅŸladÄ±ÄŸÄ±nÄ±** not edin.\
AyrÄ±ca, kayÄ±t sÄ±rasÄ±nda **kullanÄ±cÄ± iÃ§in yeni Ã¶zel nitelikler oluÅŸturamayacaÄŸÄ±nÄ±zÄ±** bilin. Sadece **varsayÄ±lan niteliklere** (gerekli olmasalar bile) ve **belirtilen Ã¶zel niteliklere** deÄŸer verebilirsiniz.
{% endhint %}

Ya da sadece bir istemci kimliÄŸinin var olup olmadÄ±ÄŸÄ±nÄ± test etmek iÃ§in. Ä°stemci kimliÄŸi yoksa bu hata:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### EÄŸer yalnÄ±zca admin kullanÄ±cÄ±larÄ± kaydedebiliyorsa

Bu hatayÄ± bulacaksÄ±nÄ±z ve kullanÄ±cÄ±larÄ± kaydedemeyecek veya listeleyemeyeceksiniz:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### KayÄ±t DoÄŸrulama

Cognito, **yeni bir kullanÄ±cÄ±yÄ± e-posta veya telefon numarasÄ±nÄ± doÄŸrulayarak doÄŸrulamaya** olanak tanÄ±r. Bu nedenle, bir kullanÄ±cÄ± oluÅŸtururken genellikle en az kullanÄ±cÄ± adÄ± ve ÅŸifre ile birlikte **e-posta ve/veya telefon numarasÄ±** istenecektir. Sadece **kontrol ettiÄŸiniz** birini ayarlayÄ±n, bÃ¶ylece yeni oluÅŸturulan kullanÄ±cÄ± **hesabÄ±nÄ±zÄ±** **doÄŸrulamak** iÃ§in kodu alacaksÄ±nÄ±z:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
AynÄ± e-posta ve telefon numarasÄ±nÄ± kullanabiliyormuÅŸ gibi gÃ¶rÃ¼nse de, oluÅŸturulan kullanÄ±cÄ±yÄ± doÄŸrulamak istediÄŸinizde Cognito aynÄ± bilgilerin kullanÄ±lmasÄ±na itiraz edecek ve **hesabÄ± doÄŸrulamanÄ±za izin vermeyecektir**.
{% endhint %}

### Yetki YÃ¼kseltme / Ã–zellikleri GÃ¼ncelleme

VarsayÄ±lan olarak bir kullanÄ±cÄ± **Ã¶zelliklerinin deÄŸerini deÄŸiÅŸtirebilir** gibi:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Ã–zel nitelik privesc

{% hint style="danger" %}
**Ã–zel nitelikler** (Ã¶rneÄŸin `isAdmin`) kullanÄ±ldÄ±ÄŸÄ±nÄ± gÃ¶rebilirsiniz, Ã§Ã¼nkÃ¼ varsayÄ±lan olarak **kendi niteliklerinizin deÄŸerlerini deÄŸiÅŸtirebilirsiniz**, bu nedenle deÄŸeri kendiniz deÄŸiÅŸtirerek **yetki yÃ¼kseltebilirsiniz**!
{% endhint %}

#### E-posta/kullanÄ±cÄ± adÄ± deÄŸiÅŸtirme privesc

Bir kullanÄ±cÄ±nÄ±n **e-posta ve telefon numarasÄ±nÄ± deÄŸiÅŸtirmek iÃ§in** bunu kullanabilirsiniz, ancak o zaman, hesap doÄŸrulanmÄ±ÅŸ kalsa bile, bu nitelikler **doÄŸrulanmamÄ±ÅŸ durumda ayarlanÄ±r** (tekrar doÄŸrulamanÄ±z gerekir).

{% hint style="warning" %}
E-posta veya telefon numarasÄ± ile **giriÅŸ yapamayacaksÄ±nÄ±z** ta ki onlarÄ± doÄŸrulayana kadar, ancak **kullanÄ±cÄ± adÄ± ile giriÅŸ yapabileceksiniz**.\
E-posta deÄŸiÅŸtirilmiÅŸ ve doÄŸrulanmamÄ±ÅŸ olsa bile, **`email`** **alanÄ±nda** ID Token iÃ§inde gÃ¶rÃ¼necektir ve **`email_verified`** alanÄ± **false** olacaktÄ±r, ancak uygulama **bunu kontrol etmiyorsa diÄŸer kullanÄ±cÄ±larÄ± taklit edebilirsiniz**.

AyrÄ±ca, **`name`** alanÄ±na sadece **isim niteliÄŸini** deÄŸiÅŸtirerek istediÄŸiniz her ÅŸeyi koyabileceÄŸinizi unutmayÄ±n. EÄŸer bir uygulama **o** alanÄ± bir nedenle **`email`** (veya baÅŸka bir nitelik) yerine **kontrol ediyorsa**, diÄŸer kullanÄ±cÄ±larÄ± **taklit edebilirsiniz**.
{% endhint %}

Her neyse, e-posta adresinizi Ã¶rneÄŸin eriÅŸebileceÄŸiniz yeni bir e-posta ile deÄŸiÅŸtirdiyseniz, o e-posta adresinde aldÄ±ÄŸÄ±nÄ±z kod ile **e-postayÄ± onaylayabilirsiniz**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
**`telefon_numarasÄ±`** yerine **`email`** kullanarak **yeni bir telefon numarasÄ±nÄ±** deÄŸiÅŸtire/doÄŸrulamak.

{% hint style="info" %}
YÃ¶netici, **kullanÄ±cÄ±nÄ±n tercih ettiÄŸi kullanÄ±cÄ± adÄ±yla giriÅŸ yapma** seÃ§eneÄŸini de etkinleÅŸtirebilir. Bu deÄŸeri, **baÅŸka bir kullanÄ±cÄ±yÄ± taklit etmek iÃ§in zaten kullanÄ±lan herhangi bir kullanÄ±cÄ± adÄ± veya tercih edilen\_kullanÄ±cÄ± adÄ±** olarak deÄŸiÅŸtiremeyeceÄŸinizi unutmayÄ±n.
{% endhint %}

### Åifreyi Kurtarma/DeÄŸiÅŸtirme

Bir ÅŸifreyi kurtarmak, sadece **kullanÄ±cÄ± adÄ±nÄ±** (veya email veya telefon kabul edilir) bilmek ve oraya bir kod gÃ¶nderileceÄŸi iÃ§in buna eriÅŸim saÄŸlamak mÃ¼mkÃ¼ndÃ¼r:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
Sunucunun yanÄ±tÄ± her zaman olumlu olacak, sanki kullanÄ±cÄ± adÄ± varmÄ±ÅŸ gibi. Bu yÃ¶ntemi kullanÄ±cÄ±larÄ± listelemek iÃ§in kullanamazsÄ±nÄ±z.
{% endhint %}

AÅŸaÄŸÄ±daki kod ile ÅŸifreyi deÄŸiÅŸtirebilirsiniz:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Åifreyi deÄŸiÅŸtirmek iÃ§in **Ã¶nceki ÅŸifreyi bilmeniz gerekir**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Kimlik DoÄŸrulama

Bir kullanÄ±cÄ± havuzu **farklÄ± kimlik doÄŸrulama yÃ¶ntemlerini** destekler. EÄŸer bir **kullanÄ±cÄ± adÄ± ve ÅŸifre** varsa, giriÅŸ yapmak iÃ§in de **farklÄ± yÃ¶ntemler** desteklenir.\
AyrÄ±ca, bir kullanÄ±cÄ± Havuzda kimlik doÄŸrulandÄ±ÄŸÄ±nda **3 tÃ¼r token verilir**: **ID Token**, **EriÅŸim token** ve **Yenileme token**.

* [**ID Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Bu, **kimliÄŸi doÄŸrulanmÄ±ÅŸ kullanÄ±cÄ±nÄ±n** `name`, `email` ve `phone_number` gibi iddialarÄ±nÄ± iÃ§erir. ID token, **kullanÄ±cÄ±larÄ± kaynak sunucularÄ±nÄ±za veya sunucu uygulamalarÄ±nÄ±za kimlik doÄŸrulamak iÃ§in** de kullanÄ±labilir. DÄ±ÅŸ uygulamalarda kullanÄ±yorsanÄ±z, ID token iÃ§indeki herhangi bir iddiayÄ± gÃ¼venilir kÄ±lmadan Ã¶nce **imzayÄ± doÄŸrulamalÄ±sÄ±nÄ±z**.
* ID Token, **kullanÄ±cÄ±nÄ±n Ã¶zellik deÄŸerlerini** iÃ§eren token'dÄ±r, hatta Ã¶zel olanlarÄ± bile.
* [**EriÅŸim Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Bu, kimliÄŸi doÄŸrulanmÄ±ÅŸ kullanÄ±cÄ± hakkÄ±nda iddialar, **kullanÄ±cÄ±nÄ±n gruplarÄ±nÄ±n listesi ve kapsamlarÄ±n listesi** iÃ§erir. EriÅŸim token'Ä±n amacÄ±, kullanÄ±cÄ± havuzundaki kullanÄ±cÄ± baÄŸlamÄ±nda **API iÅŸlemlerini yetkilendirmektir**. Ã–rneÄŸin, eriÅŸim token'Ä±nÄ± kullanarak **kullanÄ±cÄ±nÄ±za** kullanÄ±cÄ± Ã¶zelliklerini ekleme, deÄŸiÅŸtirme veya silme izni verebilirsiniz.
* [**Yenileme Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Yenileme token'larÄ± ile kullanÄ±cÄ± iÃ§in **yeni ID Token ve EriÅŸim Token** alabilirsiniz, ta ki **yenileme token geÃ§ersiz olana kadar**. **VarsayÄ±lan olarak**, yenileme token'Ä±, uygulama kullanÄ±cÄ±nÄ±zÄ±n kullanÄ±cÄ± havuzuna giriÅŸ yaptÄ±ÄŸÄ± tarihten **30 gÃ¼n sonra sÃ¼resi dolmaktadÄ±r**. KullanÄ±cÄ± havuzunuz iÃ§in bir uygulama oluÅŸturduÄŸunuzda, uygulamanÄ±n yenileme token sÃ¼resini **60 dakika ile 10 yÄ±l arasÄ±nda herhangi bir deÄŸere** ayarlayabilirsiniz.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Bu, sunucu tarafÄ± kimlik doÄŸrulama akÄ±ÅŸÄ±dÄ±r:

* Sunucu tarafÄ± uygulama, **`AdminInitiateAuth` API iÅŸlemini** Ã§aÄŸÄ±rÄ±r ( `InitiateAuth` yerine). Bu iÅŸlem, **`cognito-idp:AdminInitiateAuth`** ve **`cognito-idp:AdminRespondToAuthChallenge`** izinlerini iÃ§eren AWS kimlik bilgileri gerektirir. Ä°ÅŸlem, gerekli kimlik doÄŸrulama parametrelerini dÃ¶ndÃ¼rÃ¼r.
* Sunucu tarafÄ± uygulama **kimlik doÄŸrulama parametrelerine** sahip olduktan sonra, **`AdminRespondToAuthChallenge` API iÅŸlemini** Ã§aÄŸÄ±rÄ±r. `AdminRespondToAuthChallenge` API iÅŸlemi yalnÄ±zca AWS kimlik bilgilerini saÄŸladÄ±ÄŸÄ±nÄ±zda baÅŸarÄ±lÄ± olur.

Bu **yÃ¶ntem varsayÄ±lan olarak etkin deÄŸildir**.

**GiriÅŸ yapmak iÃ§in** ÅŸunlarÄ± **bilmeniz gerekir**:

* kullanÄ±cÄ± havuzu kimliÄŸi
* istemci kimliÄŸi
* kullanÄ±cÄ± adÄ±
* ÅŸifre
* istemci sÄ±rrÄ± (sadece uygulama bir sÄ±r kullanacak ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸsa)

{% hint style="info" %}
Bu yÃ¶ntemle **giriÅŸ yapabilmek iÃ§in** uygulamanÄ±n `ALLOW_ADMIN_USER_PASSWORD_AUTH` ile giriÅŸ yapmaya izin vermesi gerekir.\
AyrÄ±ca, bu iÅŸlemi gerÃ§ekleÅŸtirmek iÃ§in **`cognito-idp:AdminInitiateAuth`** ve **`cognito-idp:AdminRespondToAuthChallenge`** izinlerine sahip kimlik bilgilerine ihtiyacÄ±nÄ±z vardÄ±r.
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>GiriÅŸ iÃ§in Kod</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Bu yÃ¶ntem, baÅŸka bir basit ve **geleneksel kullanÄ±cÄ± ve ÅŸifre kimlik doÄŸrulama** akÄ±ÅŸÄ±dÄ±r. **Geleneksel** kimlik doÄŸrulama yÃ¶nteminin **Cognito'ya** **geÃ§irilmesi** Ã¶nerilir ve ardÄ±ndan **devre dÄ±ÅŸÄ± bÄ±rakÄ±lmasÄ±** ve bunun yerine **ALLOW\_USER\_SRP\_AUTH** yÃ¶nteminin **kullanÄ±lmasÄ±** Ã¶nerilir (Ã§Ã¼nkÃ¼ bu yÃ¶ntem ÅŸifreyi aÄŸ Ã¼zerinden asla gÃ¶ndermez).\
Bu **yÃ¶ntem varsayÄ±lan olarak ETKÄ°N deÄŸildir**.

Kod iÃ§indeki **Ã¶nceki kimlik doÄŸrulama yÃ¶ntemi** ile ana **fark**, **kullanÄ±cÄ± havuzunun kimliÄŸini bilmenize gerek olmamasÄ±** ve **Cognito KullanÄ±cÄ± Havuzunda ek izinlere ihtiyaÃ§ duymamanÄ±zdÄ±r**.

**GiriÅŸ yapmak iÃ§in** bilmeniz **gerekir**:

* istemci kimliÄŸi
* kullanÄ±cÄ± adÄ±
* ÅŸifre
* istemci sÄ±rrÄ± (sadece uygulama bir sÄ±r kullanacak ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸsa)

{% hint style="info" %}
Bu yÃ¶ntemle **giriÅŸ yapabilmek iÃ§in** uygulamanÄ±n ALLOW\_USER\_PASSWORD\_AUTH ile giriÅŸ yapmasÄ±na izin vermesi gerekir.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>GiriÅŸ yapmak iÃ§in Python kodu</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Bu senaryo, Ã¶nceki senaryoya benzer ancak **ÅŸifreyi** aÄŸa gÃ¶nderme yerine **bir zorluk kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtirilir** (yani ÅŸifre, ÅŸifreli bile olsa aÄŸ Ã¼zerinden iletilmez).\
Bu **yÃ¶ntem varsayÄ±lan olarak etkindir**.

**GiriÅŸ yapmak iÃ§in** ÅŸunlarÄ± bilmeniz **gerekir**:

* kullanÄ±cÄ± havuzu kimliÄŸi
* istemci kimliÄŸi
* kullanÄ±cÄ± adÄ±
* ÅŸifre
* istemci sÄ±rrÄ± (sadece uygulama bir sÄ±r kullanacak ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸsa)

<details>

<summary>GiriÅŸ yapmak iÃ§in kod</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Bu **yÃ¶ntem her zaman geÃ§erli olacak** (devre dÄ±ÅŸÄ± bÄ±rakÄ±lamaz) ancak geÃ§erli bir yenileme token'Ä±na sahip olmanÄ±z gerekir.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>Yenileme kodu</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

Bu durumda **kimlik doÄŸrulama**, **bir lambda fonksiyonunun yÃ¼rÃ¼tÃ¼lmesi** yoluyla gerÃ§ekleÅŸtirilecektir.

## Ek GÃ¼venlik

### GeliÅŸmiÅŸ GÃ¼venlik

VarsayÄ±lan olarak devre dÄ±ÅŸÄ±dÄ±r, ancak etkinleÅŸtirildiÄŸinde, Cognito **hesap ele geÃ§irmelerini bulabilir**. OlasÄ±lÄ±ÄŸÄ± en aza indirmek iÃ§in **aynÄ± ÅŸehirdeki bir aÄŸdan, aynÄ± kullanÄ±cÄ± aracÄ±nÄ± kullanarak** (ve mÃ¼mkÃ¼nse IP ile) giriÅŸ yapmalÄ±sÄ±nÄ±z.

### **MFA HatÄ±rlama cihazÄ±**

KullanÄ±cÄ± aynÄ± cihazdan giriÅŸ yaparsa, MFA atlanabilir, bu nedenle MFA korumasÄ±nÄ± atlatmak iÃ§in aynÄ± meta verilerle (IP?) aynÄ± tarayÄ±cÄ±dan giriÅŸ yapmayÄ± deneyin.

## KullanÄ±cÄ± Havuzu GruplarÄ± IAM Rolleri

**KullanÄ±cÄ±larÄ± KullanÄ±cÄ± Havuzu** gruplarÄ±na eklemek mÃ¼mkÃ¼ndÃ¼r ve bu gruplar bir **IAM rolÃ¼** ile iliÅŸkilidir.\
AyrÄ±ca, **kullanÄ±cÄ±lar**, **farklÄ± IAM rolleri** eklenmiÅŸ **1'den fazla gruba atanabilir**.

Bir grubun, ekli bir IAM rolÃ¼ olan bir grubun iÃ§inde olsa bile, o grubun IAM kimlik bilgilerine eriÅŸebilmesi iÃ§in **KullanÄ±cÄ± Havuzunun bir Kimlik Havuzu tarafÄ±ndan gÃ¼venilir olmasÄ±** gerektiÄŸini unutmayÄ±n (ve o Kimlik Havuzunun ayrÄ±ntÄ±larÄ±nÄ± bilmek).

KullanÄ±cÄ±, KullanÄ±cÄ± Havuzunda (`aws cognito-idp initiate-auth...`) kimlik doÄŸrulandÄ±ÄŸÄ±nda **IdToken'da belirtilen IAM rolÃ¼nÃ¼** almak iÃ§in bir diÄŸer gereklilik, **Kimlik SaÄŸlayÄ±cÄ± Kimlik doÄŸrulama saÄŸlayÄ±cÄ±sÄ±nÄ±n** **rolÃ¼n token'dan seÃ§ilmesi gerektiÄŸini** belirtmesidir.

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

Bir kullanÄ±cÄ±nÄ±n eriÅŸim saÄŸladÄ±ÄŸÄ± **roller**, **`IdToken`** iÃ§indedir ve bir kullanÄ±cÄ±, **`aws cognito-identity get-credentials-for-identity`** ile **hangi rol iÃ§in kimlik bilgileri almak istediÄŸini** **`--custom-role-arn`** ile seÃ§ebilir.\
Ancak, eÄŸer **varsayÄ±lan seÃ§enek** **yapÄ±landÄ±rÄ±lmÄ±ÅŸ olan** ise (`varsayÄ±lan rolÃ¼ kullan`), ve IdToken'dan bir role eriÅŸmeye Ã§alÄ±ÅŸÄ±rsanÄ±z, **hata** alÄ±rsÄ±nÄ±z (bu nedenle Ã¶nceki yapÄ±landÄ±rma gereklidir):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
**KullanÄ±cÄ± Havuzu Grubu**'na atanan rolÃ¼n, **KullanÄ±cÄ± Havuzuna gÃ¼venen Kimlik SaÄŸlayÄ±cÄ±** tarafÄ±ndan **eriÅŸilebilir** olmasÄ± gerektiÄŸini unutmayÄ±n (Ã§Ã¼nkÃ¼ IAM rolÃ¼ **oturum kimlik bilgileri buradan elde edilecektir**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
