# Cognito User Pools

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</details>
{% endhint %}

## Temel Bilgiler

Bir user pool, Amazon Cognito'da bir kullanÄ±cÄ± dizinidir. Bir user pool ile kullanÄ±cÄ±larÄ±nÄ±z Amazon Cognito aracÄ±lÄ±ÄŸÄ±yla **web veya mobil uygulamanÄ±za giriÅŸ yapabilir** veya **Ã¼Ã§Ã¼ncÃ¼ taraf** bir kimlik saÄŸlayÄ±cÄ± (IdP) aracÄ±lÄ±ÄŸÄ±yla federasyon yapabilir. KullanÄ±cÄ±larÄ±nÄ±z doÄŸrudan veya Ã¼Ã§Ã¼ncÃ¼ taraf aracÄ±lÄ±ÄŸÄ±yla giriÅŸ yapsa da, user pool'un tÃ¼m Ã¼yelerinin bir SDK aracÄ±lÄ±ÄŸÄ±yla eriÅŸebileceÄŸiniz bir dizin profili vardÄ±r.

User pool'lar ÅŸunlarÄ± saÄŸlar:

* KayÄ±t ve giriÅŸ hizmetleri.
* KullanÄ±cÄ±larÄ± giriÅŸ yaptÄ±rmak iÃ§in yerleÅŸik, Ã¶zelleÅŸtirilebilir bir web UI.
* Facebook, Google, Amazon ile GiriÅŸ ve Apple ile GiriÅŸ gibi sosyal giriÅŸler ve user pool'unuzdan SAML ve OIDC kimlik saÄŸlayÄ±cÄ±larÄ±.
* KullanÄ±cÄ± dizini yÃ¶netimi ve kullanÄ±cÄ± profilleri.
* Ã‡ok faktÃ¶rlÃ¼ kimlik doÄŸrulama (MFA), tehlikeye atÄ±lmÄ±ÅŸ kimlik bilgileri kontrolÃ¼, hesap ele geÃ§irme korumasÄ± ve telefon ve e-posta doÄŸrulamasÄ± gibi gÃ¼venlik Ã¶zellikleri.
* AWS Lambda tetikleyicileri aracÄ±lÄ±ÄŸÄ±yla Ã¶zelleÅŸtirilmiÅŸ iÅŸ akÄ±ÅŸlarÄ± ve kullanÄ±cÄ± geÃ§iÅŸi.

UygulamalarÄ±n **kaynak kodu** genellikle **user pool ID** ve **client application ID** (ve bazen **application secret**?) iÃ§erir, bu da bir kullanÄ±cÄ±nÄ±n Cognito User Pool'a **giriÅŸ yapmasÄ±** iÃ§in gereklidir.

### Potansiyel saldÄ±rÄ±lar

* **KayÄ±t**: VarsayÄ±lan olarak bir kullanÄ±cÄ± kendini kaydedebilir, bu yÃ¼zden kendisi iÃ§in bir kullanÄ±cÄ± oluÅŸturabilir.
* **KullanÄ±cÄ± enumarasyonu**: KayÄ±t iÅŸlevi, zaten var olan kullanÄ±cÄ± adlarÄ±nÄ± bulmak iÃ§in kullanÄ±labilir. Bu bilgi brute-force saldÄ±rÄ±sÄ± iÃ§in yararlÄ± olabilir.
* **GiriÅŸ brute-force**: [**Authentication**](cognito-user-pools.md#authentication) bÃ¶lÃ¼mÃ¼nde bir kullanÄ±cÄ±nÄ±n **giriÅŸ yapmasÄ±** iÃ§in tÃ¼m **yÃ¶ntemler** bulunmaktadÄ±r, bunlarÄ± brute-force ile **geÃ§erli kimlik bilgilerini bulmak** iÃ§in deneyebilirsiniz.

### Pentesting iÃ§in AraÃ§lar

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), AWS exploitation framework'Ã¼, artÄ±k bir hesaptaki tÃ¼m Cognito varlÄ±klarÄ±nÄ±n enumarasyonunu otomatikleÅŸtiren ve zayÄ±f yapÄ±landÄ±rmalarÄ±, eriÅŸim kontrolÃ¼ iÃ§in kullanÄ±lan kullanÄ±cÄ± Ã¶zniteliklerini vb. iÅŸaretleyen "cognito\_\_enum" ve "cognito\_\_attack" modÃ¼llerini iÃ§erir ve ayrÄ±ca kullanÄ±cÄ± oluÅŸturmayÄ± (MFA desteÄŸi dahil) ve deÄŸiÅŸtirilebilir Ã¶zel Ã¶zniteliklere, kullanÄ±labilir kimlik havuzu kimlik bilgilerine, id token'larÄ±nda devralÄ±nabilir rollere dayalÄ± ayrÄ±calÄ±k yÃ¼kseltmeyi otomatikleÅŸtirir.

ModÃ¼llerin iÅŸlevlerinin aÃ§Ä±klamasÄ± iÃ§in [blog yazÄ±sÄ±nÄ±n](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2) 2. bÃ¶lÃ¼mÃ¼ne bakÄ±n. Kurulum talimatlarÄ± iÃ§in ana [Pacu](https://github.com/RhinoSecurityLabs/pacu) sayfasÄ±na bakÄ±n.

#### KullanÄ±m

Belirli bir kimlik havuzu ve user pool client'a karÅŸÄ± kullanÄ±cÄ± oluÅŸturma ve tÃ¼m privesc vektÃ¶rlerini denemek iÃ§in Ã¶rnek cognito\_\_attack kullanÄ±mÄ±:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
AWS hesabÄ±nda gÃ¶rÃ¼nen tÃ¼m user pools, user pool clients, identity pools, users vb. toplamak iÃ§in cognito\_\_enum kullanÄ±m Ã¶rneÄŸi:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) is a CLI tool in python that implements different attacks on Cognito including unwanted account creation and account oracle.

#### Kurulum
```bash
$ pip install cognito-scanner
```
#### KullanÄ±m
```bash
$ cognito-scanner --help
```
Daha fazla bilgi iÃ§in https://github.com/padok-team/cognito-scanner adresine bakÄ±n.

## Registration

User Pools, **varsayÄ±lan** olarak **yeni kullanÄ±cÄ±larÄ±n kaydolmasÄ±na** izin verir.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Herkes kayÄ±t olabilir

KullanÄ±cÄ± hakkÄ±nda **daha fazla bilgi saÄŸlamanÄ±z** gerektiÄŸini belirten bir hata ile karÅŸÄ±laÅŸabilirsiniz:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
Gerekli detaylarÄ± ÅŸu ÅŸekilde bir JSON ile saÄŸlayabilirsiniz:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
Bu iÅŸlevi ayrÄ±ca **mevcut kullanÄ±cÄ±larÄ± listelemek** iÃ§in de kullanabilirsiniz. Bu, o isimle zaten bir kullanÄ±cÄ± mevcut olduÄŸunda alÄ±nan hata mesajÄ±dÄ±r:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Ã–nceki komutta **Ã¶zel Ã¶zniteliklerin "custom:" ile baÅŸladÄ±ÄŸÄ±na** dikkat edin.\
AyrÄ±ca, kayÄ±t olurken kullanÄ±cÄ± iÃ§in **yeni Ã¶zel Ã¶znitelikler oluÅŸturamayacaÄŸÄ±nÄ±zÄ±** bilin. Sadece **varsayÄ±lan Ã¶zniteliklere** (gerekli olmasalar bile) ve **belirtilen Ã¶zel Ã¶zniteliklere** deÄŸer verebilirsiniz.
{% endhint %}

Veya sadece bir client id'nin var olup olmadÄ±ÄŸÄ±nÄ± test etmek iÃ§in. Ä°ÅŸte client-id yoksa alÄ±nacak hata:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### EÄŸer sadece admin kullanÄ±cÄ± kaydedebiliyorsa

Bu hatayÄ± alacaksÄ±nÄ±z ve kullanÄ±cÄ± kaydedemeyecek veya listeleyemeyeceksiniz:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Verifying Registration

Cognito, **yeni bir kullanÄ±cÄ±yÄ± e-posta veya telefon numarasÄ±nÄ± doÄŸrulayarak doÄŸrulamaya** olanak tanÄ±r. Bu nedenle, bir kullanÄ±cÄ± oluÅŸtururken genellikle en azÄ±ndan kullanÄ±cÄ± adÄ± ve ÅŸifre ile **e-posta ve/veya telefon numarasÄ±** gerekecektir. **Kontrol ettiÄŸiniz** birini ayarlayÄ±n, bÃ¶ylece **yeni oluÅŸturulan kullanÄ±cÄ± hesabÄ±nÄ±zÄ±** doÄŸrulamak iÃ§in kodu alÄ±rsÄ±nÄ±z, bu ÅŸekilde:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
**AynÄ± e-posta** ve telefon numarasÄ±nÄ± kullanabiliyormuÅŸsunuz gibi gÃ¶rÃ¼nse de, oluÅŸturulan kullanÄ±cÄ±yÄ± doÄŸrulamanÄ±z gerektiÄŸinde Cognito aynÄ± bilgileri kullanmanÄ±zdan ÅŸikayet edecek ve **hesabÄ± doÄŸrulamanÄ±za izin vermeyecek**.
{% endhint %}

### AyrÄ±calÄ±k YÃ¼kseltme / Ã–zellikleri GÃ¼ncelleme

VarsayÄ±lan olarak bir kullanÄ±cÄ±, **Ã¶zelliklerinin deÄŸerini** ÅŸu ÅŸekilde deÄŸiÅŸtirebilir:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Ã–zel Ã¶znitelik privesc

{% hint style="danger" %}
**Ã–zel Ã¶zniteliklerin** kullanÄ±ldÄ±ÄŸÄ±nÄ± gÃ¶rebilirsiniz (Ã¶rneÄŸin `isAdmin`), varsayÄ±lan olarak **kendi Ã¶zniteliklerinizin deÄŸerlerini deÄŸiÅŸtirebildiÄŸiniz** iÃ§in, deÄŸeri kendiniz deÄŸiÅŸtirerek **ayrÄ±calÄ±klarÄ± yÃ¼kseltebilirsiniz**!
{% endhint %}

#### E-posta/kullanÄ±cÄ± adÄ± deÄŸiÅŸtirme privesc

Bir kullanÄ±cÄ±nÄ±n **e-posta ve telefon numarasÄ±nÄ± deÄŸiÅŸtirmek** iÃ§in bunu kullanabilirsiniz, ancak hesap doÄŸrulanmÄ±ÅŸ olarak kalsa bile, bu Ã¶znitelikler **doÄŸrulanmamÄ±ÅŸ durumda** ayarlanÄ±r (tekrar doÄŸrulamanÄ±z gerekir).

{% hint style="warning" %}
**E-posta veya telefon numarasÄ± ile giriÅŸ yapamayacaksÄ±nÄ±z** doÄŸrulayana kadar, ancak **kullanÄ±cÄ± adÄ± ile giriÅŸ yapabileceksiniz**.\
E-posta deÄŸiÅŸtirilmiÅŸ ve doÄŸrulanmamÄ±ÅŸ olsa bile, ID Token iÃ§inde **`email`** **alanÄ±nda** gÃ¶rÃ¼necek ve **`email_verified`** alanÄ± **false** olacak, ancak uygulama **bunu kontrol etmiyorsa diÄŸer kullanÄ±cÄ±larÄ± taklit edebilirsiniz**.

AyrÄ±ca, **`name`** alanÄ±na sadece **isim Ã¶zniteliÄŸini** deÄŸiÅŸtirerek herhangi bir ÅŸey koyabileceÄŸinizi unutmayÄ±n. Bir uygulama **herhangi bir nedenle** bu alanÄ± **`email`** (veya baÅŸka bir Ã¶znitelik) yerine **kontrol ediyorsa** diÄŸer kullanÄ±cÄ±larÄ± **taklit edebilirsiniz**.
{% endhint %}

Her neyse, eÄŸer bir nedenle e-postanÄ±zÄ± yeni bir e-posta adresine deÄŸiÅŸtirdiyseniz, o e-posta adresine aldÄ±ÄŸÄ±nÄ±z kod ile e-postayÄ± **doÄŸrulayabilirsiniz**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
**`phone_number`** yerine **`email`** kullanarak **yeni bir telefon numarasÄ±nÄ±** deÄŸiÅŸtirin/doÄŸrulayÄ±n.

{% hint style="info" %}
Admin ayrÄ±ca **kullanÄ±cÄ± tercihli kullanÄ±cÄ± adÄ± ile giriÅŸ yapma** seÃ§eneÄŸini de etkinleÅŸtirebilir. Bu deÄŸeri **zaten kullanÄ±lan herhangi bir kullanÄ±cÄ± adÄ± veya preferred\_username** olarak deÄŸiÅŸtiremeyeceÄŸinizi unutmayÄ±n.
{% endhint %}

### Åifre Kurtarma/DeÄŸiÅŸtirme

Sadece **kullanÄ±cÄ± adÄ±nÄ± bilerek** (veya email veya telefon kabul edilir) ve eriÅŸime sahip olarak bir ÅŸifreyi kurtarmak mÃ¼mkÃ¼ndÃ¼r, Ã§Ã¼nkÃ¼ bir kod oraya gÃ¶nderilecektir:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
Sunucunun yanÄ±tÄ± her zaman olumlu olacaktÄ±r, sanki kullanÄ±cÄ± adÄ± varmÄ±ÅŸ gibi. Bu yÃ¶ntemi kullanÄ±cÄ±larÄ± numaralandÄ±rmak iÃ§in kullanamazsÄ±nÄ±z.
{% endhint %}

Åifreyi ÅŸu kodla deÄŸiÅŸtirebilirsiniz:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Åifreyi deÄŸiÅŸtirmek iÃ§in **Ã¶nceki ÅŸifreyi bilmeniz** gerekir:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Authentication

Bir kullanÄ±cÄ± havuzu, ona **kimlik doÄŸrulamak iÃ§in farklÄ± yollarÄ±** destekler. EÄŸer bir **kullanÄ±cÄ± adÄ± ve ÅŸifre** varsa, giriÅŸ yapmak iÃ§in de **farklÄ± yÃ¶ntemler** desteklenir.\
AyrÄ±ca, bir kullanÄ±cÄ± havuzunda kimlik doÄŸrulandÄ±ktan sonra **3 tÃ¼r token verilir**: **ID Token**, **Access token** ve **Refresh token**.

* [**ID Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): KimliÄŸi doÄŸrulanmÄ±ÅŸ kullanÄ±cÄ± hakkÄ±nda `name`, `email` ve `phone_number` gibi iddialar iÃ§erir. ID token, **kullanÄ±cÄ±larÄ± kaynak sunucularÄ±nÄ±za veya sunucu uygulamalarÄ±nÄ±za kimlik doÄŸrulamak** iÃ§in de kullanÄ±labilir. ID token'Ä± harici uygulamalarda kullanÄ±yorsanÄ±z, iÃ§indeki iddialara gÃ¼venmeden Ã¶nce **imzasÄ±nÄ± doÄŸrulamanÄ±z** gerekir.
* ID Token, **kullanÄ±cÄ±nÄ±n nitelik deÄŸerlerini** iÃ§eren token'dÄ±r, hatta Ã¶zel olanlarÄ± bile.
* [**Access Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): KimliÄŸi doÄŸrulanmÄ±ÅŸ kullanÄ±cÄ± hakkÄ±nda iddialar, **kullanÄ±cÄ±nÄ±n gruplarÄ±nÄ±n bir listesi ve kapsamlarÄ±n bir listesi** iÃ§erir. Access token'Ä±n amacÄ±, kullanÄ±cÄ± havuzundaki kullanÄ±cÄ± baÄŸlamÄ±nda **API iÅŸlemlerini yetkilendirmektir**. Ã–rneÄŸin, access token'Ä± kullanarak kullanÄ±cÄ±nÄ±za kullanÄ±cÄ± niteliklerini ekleme, deÄŸiÅŸtirme veya silme izni verebilirsiniz.
* [**Refresh Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Refresh token'lar ile kullanÄ±cÄ± iÃ§in **yeni ID Token ve Access Token** alabilirsiniz, refresh token **geÃ§ersiz olana kadar**. **VarsayÄ±lan olarak**, refresh token, uygulama kullanÄ±cÄ±nÄ±z kullanÄ±cÄ± havuzunuza giriÅŸ yaptÄ±ktan **30 gÃ¼n sonra** sona erer. KullanÄ±cÄ± havuzunuz iÃ§in bir uygulama oluÅŸturduÄŸunuzda, uygulamanÄ±n refresh token sÃ¼resini **60 dakika ile 10 yÄ±l arasÄ±nda herhangi bir deÄŸere** ayarlayabilirsiniz.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Bu, sunucu tarafÄ± kimlik doÄŸrulama akÄ±ÅŸÄ±dÄ±r:

* Sunucu tarafÄ± uygulama, **`AdminInitiateAuth` API iÅŸlemini** (`InitiateAuth` yerine) Ã§aÄŸÄ±rÄ±r. Bu iÅŸlem, **`cognito-idp:AdminInitiateAuth`** ve **`cognito-idp:AdminRespondToAuthChallenge`** izinlerini iÃ§eren AWS kimlik bilgilerini gerektirir. Ä°ÅŸlem, gerekli kimlik doÄŸrulama parametrelerini dÃ¶ndÃ¼rÃ¼r.
* Sunucu tarafÄ± uygulama **kimlik doÄŸrulama parametrelerine** sahip olduktan sonra, **`AdminRespondToAuthChallenge` API iÅŸlemini** Ã§aÄŸÄ±rÄ±r. `AdminRespondToAuthChallenge` API iÅŸlemi, yalnÄ±zca AWS kimlik bilgilerini saÄŸladÄ±ÄŸÄ±nÄ±zda baÅŸarÄ±lÄ± olur.

Bu **yÃ¶ntem varsayÄ±lan olarak etkin deÄŸildir**.

**GiriÅŸ yapmak** iÃ§in **bilmeniz gerekenler**:

* user pool id
* client id
* username
* password
* client secret (yalnÄ±zca uygulama bir secret kullanacak ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸsa)

{% hint style="info" %}
Bu yÃ¶ntemle **giriÅŸ yapabilmek** iÃ§in uygulamanÄ±n `ALLOW_ADMIN_USER_PASSWORD_AUTH` ile giriÅŸe izin vermesi gerekir.\
AyrÄ±ca, bu iÅŸlemi gerÃ§ekleÅŸtirmek iÃ§in **`cognito-idp:AdminInitiateAuth`** ve **`cognito-idp:AdminRespondToAuthChallenge`** izinlerine sahip kimlik bilgilerine ihtiyacÄ±nÄ±z var.
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>GiriÅŸ Kodu</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Bu yÃ¶ntem, baÅŸka bir basit ve **geleneksel kullanÄ±cÄ± & ÅŸifre doÄŸrulama** akÄ±ÅŸÄ±dÄ±r. Geleneksel bir doÄŸrulama yÃ¶ntemini **Cognito'ya taÅŸÄ±mak** ve ardÄ±ndan bunu **devre dÄ±ÅŸÄ± bÄ±rakmak** ve **ALLOW\_USER\_SRP\_AUTH** yÃ¶ntemini kullanmak **Ã¶nerilir** (Ã§Ã¼nkÃ¼ bu yÃ¶ntem ÅŸifreyi aÄŸ Ã¼zerinden asla gÃ¶ndermez).\
Bu **yÃ¶ntem varsayÄ±lan olarak etkin deÄŸildir**.

Kod iÃ§indeki **Ã¶nceki doÄŸrulama yÃ¶ntemiyle** olan **ana fark**, **kullanÄ±cÄ± havuzu kimliÄŸini bilmenize gerek olmamasÄ±** ve Cognito KullanÄ±cÄ± Havuzunda **ek izinlere ihtiyacÄ±nÄ±z olmamasÄ±dÄ±r**.

**GiriÅŸ yapmak** iÃ§in bilmeniz gerekenler:

* client id
* username
* password
* client secret (yalnÄ±zca uygulama bir secret kullanacak ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸsa)

{% hint style="info" %}
Bu yÃ¶ntemle **giriÅŸ yapabilmek** iÃ§in uygulamanÄ±n ALLOW\_USER\_PASSWORD\_AUTH ile giriÅŸe izin vermesi gerekir.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>GiriÅŸ iÃ§in Python kodu</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Bu senaryo Ã¶nceki senaryoya benzer, ancak **ÅŸifreyi** aÄŸ Ã¼zerinden gÃ¶ndererek giriÅŸ yapmak yerine **bir challenge authentication gerÃ§ekleÅŸtirilir** (yani ÅŸifre aÄŸ Ã¼zerinden ÅŸifrelenmiÅŸ bile olsa dolaÅŸmaz).\
Bu **yÃ¶ntem varsayÄ±lan olarak etkindir**.

**GiriÅŸ yapmak** iÃ§in **bilmeniz gerekenler**:

* user pool id
* client id
* username
* password
* client secret (yalnÄ±zca uygulama bir secret kullanacak ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸsa)

<details>

<summary>GiriÅŸ yapmak iÃ§in kod</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Bu **yÃ¶ntem her zaman geÃ§erli olacak** (devre dÄ±ÅŸÄ± bÄ±rakÄ±lamaz) ancak geÃ§erli bir refresh token'a sahip olmanÄ±z gerekir.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>Yenilemek iÃ§in kod</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

Bu durumda **kimlik doÄŸrulama**, **bir lambda fonksiyonunun yÃ¼rÃ¼tÃ¼lmesi** yoluyla gerÃ§ekleÅŸtirilecektir.

## Ekstra GÃ¼venlik

### GeliÅŸmiÅŸ GÃ¼venlik

VarsayÄ±lan olarak devre dÄ±ÅŸÄ±dÄ±r, ancak etkinleÅŸtirilirse, Cognito **hesap ele geÃ§irmelerini bulabilir**. OlasÄ±lÄ±ÄŸÄ± en aza indirmek iÃ§in **aynÄ± ÅŸehirdeki bir aÄŸdan, aynÄ± kullanÄ±cÄ± aracÄ±sÄ±nÄ± kullanarak** (ve mÃ¼mkÃ¼nse aynÄ± IP ile) giriÅŸ yapmalÄ±sÄ±nÄ±z.

### **MFA CihazÄ± HatÄ±rla**

KullanÄ±cÄ± aynÄ± cihazdan giriÅŸ yaparsa, MFA atlanabilir, bu nedenle MFA korumasÄ±nÄ± atlamak iÃ§in aynÄ± tarayÄ±cÄ±dan aynÄ± metadata (IP?) ile giriÅŸ yapmayÄ± deneyin.

## User Pool GruplarÄ± IAM Rolleri

**IAM rolleri** ile iliÅŸkili **User Pool** gruplarÄ±na **kullanÄ±cÄ±lar** eklemek mÃ¼mkÃ¼ndÃ¼r.\
AyrÄ±ca, **kullanÄ±cÄ±lar** farklÄ± IAM rolleri eklenmiÅŸ **birden fazla gruba atanabilir**.

Bir grup, IAM rolÃ¼ eklenmiÅŸ bir grubun iÃ§inde olsa bile, o grubun IAM kimlik bilgilerine eriÅŸebilmek iÃ§in **User Pool'un bir Identity Pool tarafÄ±ndan gÃ¼venilir olmasÄ±** (ve o Identity Pool'un detaylarÄ±nÄ± bilmesi) gerekmektedir.

Bir kullanÄ±cÄ±nÄ±n User Pool'da kimlik doÄŸrulamasÄ± yapÄ±ldÄ±ÄŸÄ±nda (`aws cognito-idp initiate-auth...`) **IdToken'da belirtilen IAM rolÃ¼nÃ¼** alabilmesi iÃ§in, **Identity Provider Authentication provider**'Ä±n **rolÃ¼n token'dan seÃ§ilmesi gerektiÄŸini** belirtmesi gerekmektedir.

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

Bir kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi **roller** **`IdToken`** iÃ§inde yer alÄ±r ve kullanÄ±cÄ± **`aws cognito-identity get-credentials-for-identity`** komutundaki **`--custom-role-arn`** ile **hangi rol iÃ§in kimlik bilgileri istediÄŸini seÃ§ebilir**.\
Ancak, **varsayÄ±lan seÃ§enek** **yapÄ±landÄ±rÄ±lmÄ±ÅŸ** ise (`use default role`), ve IdToken'dan bir role eriÅŸmeye Ã§alÄ±ÅŸÄ±rsanÄ±z, **hata** alÄ±rsÄ±nÄ±z (bu yÃ¼zden Ã¶nceki yapÄ±landÄ±rma gereklidir):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
**User Pool Group**'a atanan rolÃ¼n, **User Pool'a gÃ¼venen** **Kimlik SaÄŸlayÄ±cÄ±** tarafÄ±ndan **eriÅŸilebilir** olmasÄ± gerektiÄŸini unutmayÄ±n (Ã§Ã¼nkÃ¼ IAM rolÃ¼ **oturum kimlik bilgileri buradan elde edilecektir**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **HackTricks** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.

</details>
{% endhint %}
