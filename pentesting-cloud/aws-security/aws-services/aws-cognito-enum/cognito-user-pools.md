# Cognito User Pools

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Pula u偶ytkownik贸w to katalog u偶ytkownik贸w w Amazon Cognito. Dziki puli u偶ytkownik贸w, Twoi u偶ytkownicy mog **zalogowa si do Twojej aplikacji internetowej lub mobilnej** za porednictwem Amazon Cognito, **lub federowa** przez **dostawc** to偶samoci (IdP) zewntrznego. Niezale偶nie od tego, czy Twoi u偶ytkownicy loguj si bezporednio, czy przez stron trzeci, wszyscy czonkowie puli u偶ytkownik贸w maj profil katalogu, do kt贸rego mo偶esz uzyska dostp za porednictwem SDK.

Pule u偶ytkownik贸w oferuj:

* Usugi rejestracji i logowania.
* Wbudowany, dostosowywalny interfejs u偶ytkownika do logowania u偶ytkownik贸w.
* Logowanie spoecznociowe za pomoc Facebooka, Google, Logowanie z Amazon i Logowanie z Apple, oraz przez dostawc贸w to偶samoci SAML i OIDC z Twojej puli u偶ytkownik贸w.
* Zarzdzanie katalogiem u偶ytkownik贸w i profilami u偶ytkownik贸w.
* Funkcje bezpieczestwa, takie jak uwierzytelnianie wieloskadnikowe (MFA), kontrole dotyczce skompromitowanych powiadcze, ochrona przed przejciem konta oraz weryfikacja telefonu i e-maila.
* Dostosowane przepywy pracy i migracja u偶ytkownik贸w za pomoc wyzwalaczy AWS Lambda.

**Kod 藕r贸dowy** aplikacji zazwyczaj zawiera r贸wnie偶 **ID puli u偶ytkownik贸w** oraz **ID aplikacji klienckiej**, (a czasami **sekret aplikacji**?), kt贸re s potrzebne do **logowania u偶ytkownika** do puli u偶ytkownik贸w Cognito.

### Potential attacks

* **Rejestracja**: Domylnie u偶ytkownik mo偶e zarejestrowa si samodzielnie, wic mo偶e stworzy konto dla siebie.
* **Enumaracja u偶ytkownik贸w**: Funkcjonalno rejestracji mo偶e by u偶ywana do znajdowania nazw u偶ytkownik贸w, kt贸re ju偶 istniej. Ta informacja mo偶e by przydatna do ataku brute-force.
* **Brute-force logowania**: W sekcji [**Uwierzytelnianie**](cognito-user-pools.md#authentication) masz wszystkie **metody**, kt贸re u偶ytkownik ma do **logowania**, mo偶esz spr贸bowa przeprowadzi atak brute-force, aby **znale藕 wa偶ne powiadczenia**.

### Tools for pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), teraz zawiera moduy `cognito__enum` i `cognito__attack`, kt贸re automatyzuj enumeracj wszystkich zasob贸w Cognito w koncie i oznaczaj sabe konfiguracje, atrybuty u偶ytkownik贸w u偶ywane do kontroli dostpu itp., a tak偶e automatyzuj tworzenie u偶ytkownik贸w (w tym wsparcie MFA) oraz eskalacj uprawnie na podstawie modyfikowalnych atrybut贸w niestandardowych, u偶ywalnych powiadcze z puli to偶samoci, r贸l, kt贸re mo偶na przyj w tokenach id itp.\
Aby uzyska opis funkcji modu贸w, zobacz cz 2 [postu na blogu](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Aby uzyska instrukcje instalacji, zobacz g贸wn stron [Pacu](https://github.com/RhinoSecurityLabs/pacu).
```bash
# Run cognito__enum usage to gather all user pools, user pool clients, identity pools, users, etc. visible in the current AWS account
Pacu (new:test) > run cognito__enum

# cognito__attack usage to attempt user creation and all privesc vectors against a given identity pool and user pool client:
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) to narzdzie CLI w pythonie, kt贸re implementuje r贸偶ne ataki na Cognito, w tym niechciane tworzenie kont i oracle kont. Sprawd藕 [ten link](https://github.com/padok-team/cognito-scanner) po wicej informacji.
```bash
# Install
pip install cognito-scanner
# Run
cognito-scanner --help
```
* [CognitoAttributeEnum](https://github.com/punishell/CognitoAttributeEnum): Ten skrypt umo偶liwia enumeracj wa偶nych atrybut贸w dla u偶ytkownik贸w.
```bash
python cognito-attribute-enu.py -client_id 16f1g98bfuj9i0g3f8be36kkrl
```
## Rejestracja

User Pools pozwala **domylnie** na **rejestrowanie nowych u偶ytkownik贸w**.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Jeli ktokolwiek mo偶e si zarejestrowa

Mo偶esz napotka bd wskazujcy, 偶e musisz **poda wicej szczeg贸贸w** dotyczcych u偶ytkownika:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
Mo偶esz dostarczy potrzebne szczeg贸y w formacie JSON, takim jak:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
Mo偶esz r贸wnie偶 u偶y tej funkcjonalnoci do **enumeracji istniejcych u偶ytkownik贸w.** Oto komunikat o bdzie, gdy u偶ytkownik o tej nazwie ju偶 istnieje:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Zauwa偶 w poprzedniej komendzie, jak **niestandardowe atrybuty zaczynaj si od "custom:"**.\
Wiedz r贸wnie偶, 偶e podczas rejestracji **nie mo偶esz tworzy nowych niestandardowych atrybut贸w dla u偶ytkownika**. Mo偶esz tylko przypisa warto do **domylnych atrybut贸w** (nawet jeli nie s wymagane) oraz **okrelonych niestandardowych atrybut贸w**.
{% endhint %}

Lub po prostu, aby sprawdzi, czy identyfikator klienta istnieje. Oto bd, jeli identyfikator klienta nie istnieje:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### Jeli tylko administrator mo偶e rejestrowa u偶ytkownik贸w

Zauwa偶ysz ten bd i nie bdziesz w stanie zarejestrowa ani wyenumerowa u偶ytkownik贸w:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Verifying Registration

Cognito pozwala na **weryfikacj nowego u偶ytkownika poprzez potwierdzenie jego adresu e-mail lub numeru telefonu**. Dlatego podczas tworzenia u偶ytkownika zazwyczaj bdziesz musia poda przynajmniej nazw u偶ytkownika i haso oraz **adres e-mail i/lub numer telefonu**. Po prostu ustaw jeden **kt贸ry kontrolujesz**, aby otrzyma kod do **potwierdzenia** nowo utworzonego konta **u偶ytkownika** w ten spos贸b:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
Nawet jeli **wyglda na to, 偶e mo偶esz u偶y tego samego adresu e-mail** i numeru telefonu, gdy musisz zweryfikowa utworzonego u偶ytkownika, Cognito bdzie narzeka na u偶ycie tych samych informacji i **nie pozwoli ci zweryfikowa konta**.
{% endhint %}

### Eskalacja uprawnie / Aktualizacja atrybut贸w

Domylnie u偶ytkownik mo偶e **zmienia warto swoich atrybut贸w** za pomoc czego takiego:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Privesc atrybut贸w niestandardowych

{% hint style="danger" %}
Mo偶esz znale藕 **atrybuty niestandardowe** (takie jak `isAdmin`), poniewa偶 domylnie mo偶esz **zmienia wartoci swoich wasnych atrybut贸w**, co mo偶e pozwoli ci na **eskalacj uprawnie** poprzez zmian wartoci samodzielnie!
{% endhint %}

#### Privesc modyfikacji e-maila/nazwy u偶ytkownika

Mo偶esz u偶y tego do **modyfikacji e-maila i numeru telefonu** u偶ytkownika, ale nawet jeli konto pozostaje zweryfikowane, te atrybuty s **ustawione w statusie nieweryfikowanym** (musisz je zweryfikowa ponownie).

{% hint style="warning" %}
Nie **bdziesz m贸g zalogowa si za pomoc e-maila lub numeru telefonu** dop贸ki ich nie zweryfikujesz, ale bdziesz **m贸g zalogowa si za pomoc nazwy u偶ytkownika**.\
Zauwa偶, 偶e nawet jeli e-mail zosta zmodyfikowany i niezweryfikowany, pojawi si w tokenie ID w **polu** **`email`**, a pole **`email_verified`** bdzie **faszywe**, ale jeli aplikacja **nie sprawdza tego, mo偶esz podszy si pod innych u偶ytkownik贸w**.

Ponadto, zauwa偶, 偶e mo偶esz wpisa cokolwiek w pole **`name`**, po prostu modyfikujc **atrybut nazwy**. Jeli aplikacja **sprawdza** to pole z jakiego powodu **zamiast `email`** (lub jakiegokolwiek innego atrybutu), mo偶esz by w stanie **podszy si pod innych u偶ytkownik贸w**.
{% endhint %}

W ka偶dym razie, jeli z jakiego powodu zmienie sw贸j e-mail na nowy, do kt贸rego masz dostp, mo偶esz **potwierdzi e-mail za pomoc kodu, kt贸ry otrzymae na ten adres e-mail**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
U偶yj **`phone_number`** zamiast **`email`**, aby zmieni/weryfikowa **nowy numer telefonu**.

{% hint style="info" %}
Administrator mo偶e r贸wnie偶 wczy opcj **logowania za pomoc preferowanej nazwy u偶ytkownika**. Nale偶y pamita, 偶e nie bdziesz m贸g zmieni tej wartoci na **dowoln nazw u偶ytkownika lub preferred\_username, kt贸ra ju偶 jest u偶ywana** do podszywania si pod innego u偶ytkownika.
{% endhint %}

### Przywracanie/Zmiana Hasa

Mo偶liwe jest przywr贸cenie hasa, znajc **nazw u偶ytkownika** (lub akceptowany jest email lub telefon), a dostp do niego jest konieczny, poniewa偶 kod zostanie tam wysany:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
Odpowied藕 serwera zawsze bdzie pozytywna, jakby nazwa u偶ytkownika istniaa. Nie mo偶esz u偶y tej metody do enumeracji u偶ytkownik贸w.
{% endhint %}

Za pomoc kodu mo偶esz zmieni haso na:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Aby zmieni haso, musisz **zna poprzednie haso**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Autoryzacja

Pula u偶ytkownik贸w obsuguje **r贸偶ne sposoby autoryzacji**. Jeli masz **nazwa u偶ytkownika i haso**, obsugiwane s r贸wnie偶 **r贸偶ne metody** logowania.\
Ponadto, gdy u偶ytkownik jest uwierzytelniony w Puli, **przyznawane s 3 typy token贸w**: **Token ID**, **Token dostpu** i **Token odwie偶ania**.

* [**Token ID**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Zawiera informacje o **to偶samoci uwierzytelnionego u偶ytkownika**, takie jak `name`, `email` i `phone_number`. Token ID mo偶e by r贸wnie偶 u偶ywany do **uwierzytelniania u偶ytkownik贸w w serwerach zasob贸w lub aplikacjach serwerowych**. Musisz **zweryfikowa** **podpis** tokena ID, zanim bdziesz m贸g zaufa jakimkolwiek informacjom wewntrz tokena ID, jeli u偶ywasz go w aplikacjach zewntrznych.
* Token ID to token, kt贸ry **zawiera wartoci atrybut贸w u偶ytkownika**, nawet tych niestandardowych.
* [**Token dostpu**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Zawiera informacje o uwierzytelnionym u偶ytkowniku, list **grup u偶ytkownika oraz list zakres贸w**. Celem tokena dostpu jest **autoryzacja operacji API** w kontekcie u偶ytkownika w puli u偶ytkownik贸w. Na przykad, mo偶esz u偶y tokena dostpu, aby **przyzna u偶ytkownikowi dostp** do dodawania, zmieniania lub usuwania atrybut贸w u偶ytkownika.
* [**Token odwie偶ania**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Dziki tokenom odwie偶ania mo偶esz **uzyska nowe tokeny ID i tokeny dostpu** dla u偶ytkownika, dop贸ki **token odwie偶ania jest wa偶ny**. Domylnie token odwie偶ania **wygasa 30 dni po** zalogowaniu si u偶ytkownika do puli u偶ytkownik贸w. Gdy tworzysz aplikacj dla swojej puli u偶ytkownik贸w, mo偶esz ustawi czas wyganicia tokena odwie偶ania aplikacji na **dowoln warto midzy 60 minutami a 10 latami**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

To jest przepyw autoryzacji po stronie serwera:

* Aplikacja po stronie serwera wywouje operacj API **`AdminInitiateAuth`** (zamiast `InitiateAuth`). Ta operacja wymaga powiadcze AWS z uprawnieniami, kt贸re obejmuj **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**. Operacja zwraca wymagane parametry autoryzacji.
* Po uzyskaniu **parametr贸w autoryzacji** przez aplikacj po stronie serwera, wywouje operacj API **`AdminRespondToAuthChallenge`**. Operacja API `AdminRespondToAuthChallenge` koczy si sukcesem tylko wtedy, gdy dostarczysz powiadczenia AWS.

Ta **metoda NIE jest wczona** domylnie.

Aby **zalogowa si**, musisz zna:

* identyfikator puli u偶ytkownik贸w
* identyfikator klienta
* nazw u偶ytkownika
* haso
* sekret klienta (tylko jeli aplikacja jest skonfigurowana do u偶ywania sekretu)

{% hint style="info" %}
Aby **m贸c zalogowa si t metod**, ta aplikacja musi zezwala na logowanie z `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Ponadto, aby wykona t akcj, potrzebujesz powiadcze z uprawnieniami **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**.
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>Kod do logowania</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Ta metoda to kolejny prosty i **tradycyjny spos贸b uwierzytelniania u偶ytkownika i hasa**. Zaleca si **migracj tradycyjnej** metody uwierzytelniania **do Cognito** i **zaleca si** nastpnie **wyczenie** jej oraz **u偶ycie** metody **ALLOW\_USER\_SRP\_AUTH** zamiast (poniewa偶 ta nigdy nie wysya hasa przez sie).\
Ta **metoda NIE jest wczona** domylnie.

G贸wna **r贸偶nica** w por贸wnaniu do **poprzedniej metody uwierzytelniania** w kodzie polega na tym, 偶e **nie musisz zna identyfikatora puli u偶ytkownik贸w** i 偶e **nie potrzebujesz dodatkowych uprawnie** w puli u偶ytkownik贸w Cognito.

Aby **zalogowa si**, musisz zna:

* identyfikator klienta
* nazw u偶ytkownika
* haso
* tajny klucz klienta (tylko jeli aplikacja jest skonfigurowana do u偶ywania tajnego klucza)

{% hint style="info" %}
Aby **m贸c si zalogowa t metod**, ta aplikacja musi zezwala na logowanie z ALLOW\_USER\_PASSWORD\_AUTH.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Kod Python do logowania</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Ten scenariusz jest podobny do poprzedniego, ale **zamiast wysya haso** przez sie, aby si zalogowa, **przeprowadzana jest autoryzacja wyzwania** (wic haso nie jest przesyane, nawet w zaszyfrowanej formie przez sie).\
Ta **metoda jest wczona** domylnie.

Aby **zalogowa si**, musisz zna:

* identyfikator puli u偶ytkownik贸w
* identyfikator klienta
* nazw u偶ytkownika
* haso
* sekret klienta (tylko jeli aplikacja jest skonfigurowana do u偶ywania sekretu)

<details>

<summary>Code to login</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Ta **metoda zawsze bdzie wa偶na** (nie mo偶na jej wyczy), ale musisz mie wa偶ny token odwie偶ania.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>Kod do odwie偶enia</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

W tym przypadku **uwierzytelnianie** bdzie przeprowadzane poprzez **wykonanie funkcji lambda**.

## Dodatkowe zabezpieczenia

### Zaawansowane zabezpieczenia

Domylnie jest wyczone, ale jeli jest wczone, Cognito mo偶e by w stanie **znale藕 przejcia konta**. Aby zminimalizowa prawdopodobiestwo, powiniene logowa si z **sieci w tej samej miejscowoci, u偶ywajc tego samego agenta u偶ytkownika** (i IP, jeli to mo偶liwe)**.**

### **MFA Pamitaj urzdzenie**

Jeli u偶ytkownik loguje si z tego samego urzdzenia, MFA mo偶e by ominite, dlatego spr贸buj zalogowa si z tej samej przegldarki z tymi samymi metadanymi (IP?), aby spr贸bowa obej ochron MFA.

## Role IAM grup u偶ytkownik贸w

Mo偶liwe jest dodanie **u偶ytkownik贸w do grupy User Pool**, kt贸re s zwizane z jedn **rol IAM**.\
Ponadto, **u偶ytkownicy** mog by przypisani do **wicej ni偶 1 grupy z r贸偶nymi rolami IAM**.

Zauwa偶, 偶e nawet jeli grupa znajduje si w grupie z przypisan rol IAM, aby uzyska dostp do powiadcze IAM tej grupy, konieczne jest, aby **User Pool by zaufany przez Identity Pool** (i zna szczeg贸y tego Identity Pool).

Innym wymogiem, aby uzyska **rol IAM wskazan w IdToken**, gdy u偶ytkownik jest uwierzytelniony w User Pool (`aws cognito-idp initiate-auth...`), jest to, 偶e **dostawca uwierzytelniania Identity Provider** musi wskaza, 偶e **rola musi by wybrana z tokena.**

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

**Role**, do kt贸rych u偶ytkownik ma dostp, s **w `IdToken`**, a u偶ytkownik mo偶e **wybra, dla kt贸rej roli chciaby uzyska powiadczenia** za pomoc **`--custom-role-arn`** z `aws cognito-identity get-credentials-for-identity`.\
Jednak jeli **domylna opcja** jest t **skonfigurowan** (`use default role`), a ty pr贸bujesz uzyska dostp do roli z IdToken, otrzymasz **bd** (dlatego potrzebna jest wczeniejsza konfiguracja):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
Zauwa偶, 偶e rola przypisana do **User Pool Group** musi by **dostpna dla Dostawcy To偶samoci**, kt贸ry **ufa User Pool** (poniewa偶 **powiadczenia sesji roli IAM bd uzyskiwane z niego**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
