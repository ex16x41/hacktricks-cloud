# Cognito User Pools

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

Um pool de usu√°rios √© um diret√≥rio de usu√°rios no Amazon Cognito. Com um pool de usu√°rios, seus usu√°rios podem **fazer login em seu aplicativo web ou m√≥vel** atrav√©s do Amazon Cognito, **ou se federar** atrav√©s de um **provedor de identidade** (IdP) de terceiros. Se seus usu√°rios fizerem login diretamente ou atrav√©s de um terceiro, todos os membros do pool de usu√°rios t√™m um perfil de diret√≥rio que voc√™ pode acessar atrav√©s de um SDK.

Os pools de usu√°rios fornecem:

* Servi√ßos de registro e login.
* Uma interface web personaliz√°vel integrada para fazer login de usu√°rios.
* Login social com Facebook, Google, Login com Amazon e Login com Apple, e atrav√©s de provedores de identidade SAML e OIDC do seu pool de usu√°rios.
* Gerenciamento de diret√≥rio de usu√°rios e perfis de usu√°rios.
* Recursos de seguran√ßa, como autentica√ß√£o multifatorial (MFA), verifica√ß√µes de credenciais comprometidas, prote√ß√£o contra tomada de conta e verifica√ß√£o de telefone e e-mail.
* Fluxos de trabalho personalizados e migra√ß√£o de usu√°rios atrav√©s de gatilhos AWS Lambda.

O **c√≥digo-fonte** das aplica√ß√µes geralmente tamb√©m conter√° o **ID do pool de usu√°rios** e o **ID da aplica√ß√£o cliente**, (e √†s vezes o **segredo da aplica√ß√£o**?) que s√£o necess√°rios para um **usu√°rio fazer login** em um Pool de Usu√°rios Cognito.

### Ataques potenciais

* **Registro**: Por padr√£o, um usu√°rio pode se registrar, ent√£o ele poderia criar um usu√°rio para si mesmo.
* **Enumera√ß√£o de usu√°rios**: A funcionalidade de registro pode ser usada para encontrar nomes de usu√°rios que j√° existem. Essa informa√ß√£o pode ser √∫til para um ataque de for√ßa bruta.
* **For√ßa bruta de login**: Na se√ß√£o [**Autentica√ß√£o**](cognito-user-pools.md#authentication) voc√™ tem todos os **m√©todos** que um usu√°rio tem para **fazer login**, voc√™ poderia tentar for√ßar a entrada **encontrar credenciais v√°lidas**.

### Ferramentas para pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), agora inclui os m√≥dulos `cognito__enum` e `cognito__attack` que automatizam a enumera√ß√£o de todos os ativos Cognito em uma conta e sinalizam configura√ß√µes fracas, atributos de usu√°rio usados para controle de acesso, etc., e tamb√©m automatizam a cria√ß√£o de usu√°rios (incluindo suporte a MFA) e escalonamento de privil√©gios com base em atributos personalizados modific√°veis, credenciais de pool de identidade utiliz√°veis, fun√ß√µes assum√≠veis em tokens de id, etc.\
Para uma descri√ß√£o das fun√ß√µes dos m√≥dulos, veja a parte 2 do [post do blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para instru√ß√µes de instala√ß√£o, veja a p√°gina principal do [Pacu](https://github.com/RhinoSecurityLabs/pacu).
```bash
# Run cognito__enum usage to gather all user pools, user pool clients, identity pools, users, etc. visible in the current AWS account
Pacu (new:test) > run cognito__enum

# cognito__attack usage to attempt user creation and all privesc vectors against a given identity pool and user pool client:
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) √© uma ferramenta CLI em python que implementa diferentes ataques ao Cognito, incluindo cria√ß√£o indesejada de contas e oracle de contas. Confira [este link](https://github.com/padok-team/cognito-scanner) para mais informa√ß√µes.
```bash
# Install
pip install cognito-scanner
# Run
cognito-scanner --help
```
* [CognitoAttributeEnum](https://github.com/punishell/CognitoAttributeEnum): Este script permite enumerar atributos v√°lidos para usu√°rios.
```bash
python cognito-attribute-enu.py -client_id 16f1g98bfuj9i0g3f8be36kkrl
```
## Registro

User Pools permite por **padr√£o** **registrar novos usu√°rios**.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Se qualquer um pode se registrar

Voc√™ pode encontrar um erro indicando que voc√™ precisa **fornecer mais detalhes** sobre o usu√°rio:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
Voc√™ pode fornecer os detalhes necess√°rios com um JSON como:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
Voc√™ pode usar essa funcionalidade tamb√©m para **enumerar usu√°rios existentes.** Esta √© a mensagem de erro quando um usu√°rio j√° existe com esse nome:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Note na comando anterior como os **atributos personalizados come√ßam com "custom:"**.\
Tamb√©m saiba que ao registrar voc√™ **n√£o pode criar novos atributos personalizados para o usu√°rio**. Voc√™ s√≥ pode atribuir valor a **atributos padr√£o** (mesmo que n√£o sejam obrigat√≥rios) e **atributos personalizados especificados**.
{% endhint %}

Ou apenas para testar se um client id existe. Este √© o erro se o client-id n√£o existir:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### Se apenas o administrador puder registrar usu√°rios

Voc√™ encontrar√° esse erro e n√£o poder√° registrar ou enumerar usu√°rios:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Verifying Registration

Cognito permite **verificar um novo usu√°rio verificando seu e-mail ou n√∫mero de telefone**. Portanto, ao criar um usu√°rio, geralmente ser√° necess√°rio pelo menos o nome de usu√°rio e a senha e o **e-mail e/ou n√∫mero de telefone**. Basta definir um **que voc√™ controla** para que voc√™ receba o c√≥digo para **verificar sua** nova **conta** de usu√°rio assim:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
Mesmo que **pare√ßa que voc√™ pode usar o mesmo e-mail** e n√∫mero de telefone, quando voc√™ precisar verificar o usu√°rio criado, o Cognito reclamar√° sobre o uso das mesmas informa√ß√µes e **n√£o permitir√° que voc√™ verifique a conta**.
{% endhint %}

### Escala√ß√£o de Privil√©gios / Atualizando Atributos

Por padr√£o, um usu√°rio pode **modificar o valor de seus atributos** com algo como:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Privesc de atributo personalizado

{% hint style="danger" %}
Voc√™ pode encontrar **atributos personalizados** sendo usados (como `isAdmin`), pois por padr√£o voc√™ pode **mudar os valores dos seus pr√≥prios atributos**, voc√™ pode ser capaz de **escalar privil√©gios** mudando o valor voc√™ mesmo!
{% endhint %}

#### Privesc de modifica√ß√£o de email/nome de usu√°rio

Voc√™ pode usar isso para **modificar o email e o n√∫mero de telefone** de um usu√°rio, mas ent√£o, mesmo que a conta permane√ßa verificada, esses atributos est√£o **definidos como n√£o verificados** (voc√™ precisa verific√°-los novamente).

{% hint style="warning" %}
Voc√™ **n√£o poder√° fazer login com email ou n√∫mero de telefone** at√© que os verifique, mas voc√™ poder√° **fazer login com o nome de usu√°rio**.\
Note que mesmo que o email tenha sido modificado e n√£o verificado, ele aparecer√° no Token de ID dentro do **campo** **`email`** e o campo **`email_verified`** ser√° **falso**, mas se o app **n√£o estiver verificando isso, voc√™ pode se passar por outros usu√°rios**.

Al√©m disso, note que voc√™ pode colocar qualquer coisa dentro do campo **`name`** apenas modificando o **atributo name**. Se um app **estiver verificando** **aquele** campo por algum motivo **em vez do `email`** (ou qualquer outro atributo), voc√™ pode ser capaz de **se passar por outros usu√°rios**.
{% endhint %}

De qualquer forma, se por algum motivo voc√™ mudou seu email, por exemplo, para um novo que voc√™ pode acessar, voc√™ pode **confirmar o email com o c√≥digo que recebeu naquele endere√ßo de email**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
Use **`phone_number`** em vez de **`email`** para alterar/verificar um **novo n√∫mero de telefone**.

{% hint style="info" %}
O administrador tamb√©m pode habilitar a op√ß√£o de **login com um nome de usu√°rio preferido pelo usu√°rio**. Note que voc√™ n√£o poder√° alterar este valor para **qualquer nome de usu√°rio ou preferred\_username j√° em uso** para se passar por um usu√°rio diferente.
{% endhint %}

### Recuperar/Alterar Senha

√â poss√≠vel recuperar uma senha apenas **sabendo o nome de usu√°rio** (ou email ou telefone √© aceito) e tendo acesso a ele, pois um c√≥digo ser√° enviado l√°:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
A resposta do servidor sempre ser√° positiva, como se o nome de usu√°rio existisse. Voc√™ n√£o pode usar este m√©todo para enumerar usu√°rios.
{% endhint %}

Com o c√≥digo, voc√™ pode alterar a senha com:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Para mudar a senha, voc√™ precisa **saber a senha anterior**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Autentica√ß√£o

Um pool de usu√°rios suporta **diferentes maneiras de autenticar**. Se voc√™ tem um **nome de usu√°rio e senha**, tamb√©m existem **diferentes m√©todos** suportados para login.\
Al√©m disso, quando um usu√°rio √© autenticado no Pool, **3 tipos de tokens s√£o fornecidos**: O **Token de ID**, o **Token de Acesso** e o **Token de Atualiza√ß√£o**.

* [**Token de ID**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Ele cont√©m declara√ß√µes sobre a **identidade do usu√°rio autenticado**, como `nome`, `email` e `n√∫mero_de_telefone`. O token de ID tamb√©m pode ser usado para **autenticar usu√°rios em seus servidores de recursos ou aplica√ß√µes de servidor**. Voc√™ deve **verificar** a **assinatura** do token de ID antes de confiar em qualquer declara√ß√£o dentro do token de ID se voc√™ us√°-lo em aplica√ß√µes externas.
* O Token de ID √© o token que **cont√©m os valores dos atributos do usu√°rio**, mesmo os personalizados.
* [**Token de Acesso**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Ele cont√©m declara√ß√µes sobre o usu√°rio autenticado, uma lista dos **grupos do usu√°rio e uma lista de escopos**. O prop√≥sito do token de acesso √© **autorizar opera√ß√µes de API** no contexto do usu√°rio no pool de usu√°rios. Por exemplo, voc√™ pode usar o token de acesso para **conceder ao seu usu√°rio acesso** para adicionar, alterar ou excluir atributos de usu√°rio.
* [**Token de Atualiza√ß√£o**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Com tokens de atualiza√ß√£o, voc√™ pode **obter novos Tokens de ID e Tokens de Acesso** para o usu√°rio at√© que o **token de atualiza√ß√£o seja inv√°lido**. Por **padr√£o**, o token de atualiza√ß√£o **expira 30 dias ap√≥s** o usu√°rio da sua aplica√ß√£o fazer login no seu pool de usu√°rios. Quando voc√™ cria uma aplica√ß√£o para seu pool de usu√°rios, pode definir a expira√ß√£o do token de atualiza√ß√£o da aplica√ß√£o para **qualquer valor entre 60 minutos e 10 anos**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Este √© o fluxo de autentica√ß√£o do lado do servidor:

* O aplicativo do lado do servidor chama a **opera√ß√£o da API `AdminInitiateAuth`** (em vez de `InitiateAuth`). Esta opera√ß√£o requer credenciais da AWS com permiss√µes que incluem **`cognito-idp:AdminInitiateAuth`** e **`cognito-idp:AdminRespondToAuthChallenge`**. A opera√ß√£o retorna os par√¢metros de autentica√ß√£o necess√°rios.
* Depois que o aplicativo do lado do servidor tem os **par√¢metros de autentica√ß√£o**, ele chama a **opera√ß√£o da API `AdminRespondToAuthChallenge`**. A opera√ß√£o da API `AdminRespondToAuthChallenge` s√≥ tem sucesso quando voc√™ fornece credenciais da AWS.

Este **m√©todo N√ÉO est√° habilitado** por padr√£o.

Para **fazer login**, voc√™ **precisa** saber:

* id do pool de usu√°rios
* id do cliente
* nome de usu√°rio
* senha
* segredo do cliente (apenas se a aplica√ß√£o estiver configurada para usar um segredo)

{% hint style="info" %}
Para **poder fazer login com este m√©todo**, essa aplica√ß√£o deve permitir login com `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Al√©m disso, para realizar esta a√ß√£o, voc√™ precisa de credenciais com as permiss√µes **`cognito-idp:AdminInitiateAuth`** e **`cognito-idp:AdminRespondToAuthChallenge`**
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>C√≥digo para Login</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Este m√©todo √© outro fluxo simples e **tradicional de autentica√ß√£o de usu√°rio e senha**. √â recomendado **migrar um m√©todo de autentica√ß√£o tradicional** **para o Cognito** e **recomendado** ent√£o **desativ√°-lo** e **usar** o m√©todo **ALLOW\_USER\_SRP\_AUTH** em vez disso (j√° que esse nunca envia a senha pela rede).\
Este **m√©todo N√ÉO est√° habilitado** por padr√£o.

A principal **diferen√ßa** em rela√ß√£o ao **m√©todo de autentica√ß√£o anterior** dentro do c√≥digo √© que voc√™ **n√£o precisa saber o ID do pool de usu√°rios** e que voc√™ **n√£o precisa de permiss√µes extras** no Cognito User Pool.

Para **fazer login** voc√™ **precisa** saber:

* client id
* username
* password
* client secret (apenas se o aplicativo estiver configurado para usar um segredo)

{% hint style="info" %}
Para **poder fazer login com este m√©todo**, o aplicativo deve permitir login com ALLOW\_USER\_PASSWORD\_AUTH.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>C√≥digo Python para Login</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Este cen√°rio √© semelhante ao anterior, mas **em vez de enviar a senha** pela rede para fazer login, uma **autentica√ß√£o de desafio √© realizada** (portanto, nenhuma senha √© transmitida, mesmo que criptografada, pela rede).\
Este **m√©todo est√° habilitado** por padr√£o.

Para **fazer login**, voc√™ **precisa** saber:

* id do pool de usu√°rios
* id do cliente
* nome de usu√°rio
* senha
* segredo do cliente (apenas se o aplicativo estiver configurado para usar um segredo)

<details>

<summary>C√≥digo para login</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Este **m√©todo sempre ser√° v√°lido** (n√£o pode ser desativado), mas voc√™ precisa ter um token de atualiza√ß√£o v√°lido.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>C√≥digo para atualizar</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

Neste caso, a **autentica√ß√£o** ser√° realizada atrav√©s da **execu√ß√£o de uma fun√ß√£o lambda**.

## Seguran√ßa Extra

### Seguran√ßa Avan√ßada

Por padr√£o, est√° desativado, mas se ativado, o Cognito pode ser capaz de **encontrar tomadas de conta**. Para minimizar a probabilidade, voc√™ deve fazer login de uma **rede dentro da mesma cidade, usando o mesmo agente de usu√°rio** (e IP, se poss√≠vel)**.**

### **MFA Lembrar dispositivo**

Se o usu√°rio fizer login do mesmo dispositivo, a MFA pode ser contornada, portanto, tente fazer login do mesmo navegador com os mesmos metadados (IP?) para tentar contornar a prote√ß√£o da MFA.

## Grupos de User Pool Fun√ß√µes IAM

√â poss√≠vel adicionar **usu√°rios a grupos de User Pool** que est√£o relacionados a uma **fun√ß√£o IAM**.\
Al√©m disso, **usu√°rios** podem ser atribu√≠dos a **mais de 1 grupo com diferentes fun√ß√µes IAM** anexadas.

Observe que, mesmo que um grupo esteja dentro de um grupo com uma fun√ß√£o IAM anexada, para poder acessar as credenciais IAM desse grupo, √© necess√°rio que o **User Pool seja confi√°vel por um Identity Pool** (e conhecer os detalhes desse Identity Pool).

Outro requisito para obter a **fun√ß√£o IAM indicada no IdToken** quando um usu√°rio √© autenticado no User Pool (`aws cognito-idp initiate-auth...`) √© que o **provedor de autentica√ß√£o do Provedor de Identidade** precisa indicar que a **fun√ß√£o deve ser selecionada do token.**

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

As **fun√ß√µes** √†s quais um usu√°rio tem acesso est√£o **dentro do `IdToken`**, e um usu√°rio pode **selecionar qual fun√ß√£o gostaria de obter credenciais** com o **`--custom-role-arn`** do `aws cognito-identity get-credentials-for-identity`.\
No entanto, se a **op√ß√£o padr√£o** for a **configurada** (`usar fun√ß√£o padr√£o`), e voc√™ tentar acessar uma fun√ß√£o do IdToken, voc√™ receber√° **erro** (√© por isso que a configura√ß√£o anterior √© necess√°ria):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
Observe que o papel atribu√≠do a um **Grupo de User Pool** precisa ser **acess√≠vel pelo Provedor de Identidade** que **confia no User Pool** (j√° que as **credenciais de sess√£o do papel IAM ser√£o obtidas a partir dele**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
