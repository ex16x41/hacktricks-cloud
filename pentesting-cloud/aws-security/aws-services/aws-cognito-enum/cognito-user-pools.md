# Cognito ç”¨æˆ·æ± 

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

ç”¨æˆ·æ± æ˜¯ Amazon Cognito ä¸­çš„ç”¨æˆ·ç›®å½•ã€‚é€šè¿‡ç”¨æˆ·æ± ï¼Œæ‚¨çš„ç”¨æˆ·å¯ä»¥é€šè¿‡ Amazon Cognito **ç™»å½•åˆ°æ‚¨çš„ç½‘é¡µæˆ–ç§»åŠ¨åº”ç”¨**ï¼Œ**æˆ–é€šè¿‡** **ç¬¬ä¸‰æ–¹** èº«ä»½æä¾›è€… (IdP) è¿›è¡Œè”åˆèº«ä»½éªŒè¯ã€‚æ— è®ºç”¨æˆ·æ˜¯ç›´æ¥ç™»å½•è¿˜æ˜¯é€šè¿‡ç¬¬ä¸‰æ–¹ï¼Œæ‰€æœ‰ç”¨æˆ·æ± çš„æˆå‘˜éƒ½æœ‰ä¸€ä¸ªå¯ä»¥é€šè¿‡ SDK è®¿é—®çš„ç›®å½•é…ç½®æ–‡ä»¶ã€‚

ç”¨æˆ·æ± æä¾›ï¼š

* æ³¨å†Œå’Œç™»å½•æœåŠ¡ã€‚
* å†…ç½®çš„ã€å¯è‡ªå®šä¹‰çš„ç½‘é¡µç”¨æˆ·ç•Œé¢ä»¥ç™»å½•ç”¨æˆ·ã€‚
* é€šè¿‡ Facebookã€Googleã€Amazon ç™»å½•å’Œ Apple ç™»å½•ï¼Œä»¥åŠé€šè¿‡ SAML å’Œ OIDC èº«ä»½æä¾›è€…çš„ç¤¾äº¤ç™»å½•ã€‚
* ç”¨æˆ·ç›®å½•ç®¡ç†å’Œç”¨æˆ·é…ç½®æ–‡ä»¶ã€‚
* å®‰å…¨åŠŸèƒ½ï¼Œå¦‚å¤šå› ç´ èº«ä»½éªŒè¯ (MFA)ã€å¯¹è¢«æ³„éœ²å‡­è¯çš„æ£€æŸ¥ã€è´¦æˆ·æ¥ç®¡ä¿æŠ¤ï¼Œä»¥åŠç”µè¯å’Œç”µå­é‚®ä»¶éªŒè¯ã€‚
* é€šè¿‡ AWS Lambda è§¦å‘å™¨è‡ªå®šä¹‰å·¥ä½œæµå’Œç”¨æˆ·è¿ç§»ã€‚

åº”ç”¨ç¨‹åºçš„ **æºä»£ç ** é€šå¸¸è¿˜ä¼šåŒ…å« **ç”¨æˆ·æ±  ID** å’Œ **å®¢æˆ·ç«¯åº”ç”¨ç¨‹åº ID**ï¼ˆæœ‰æ—¶è¿˜æœ‰ **åº”ç”¨ç¨‹åºå¯†é’¥**ï¼Ÿï¼‰ï¼Œè¿™äº›éƒ½æ˜¯ **ç”¨æˆ·ç™»å½•** Cognito ç”¨æˆ·æ± æ‰€éœ€çš„ã€‚

### æ½œåœ¨æ”»å‡»

* **æ³¨å†Œ**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥è‡ªæˆ‘æ³¨å†Œï¼Œå› æ­¤ä»–å¯ä»¥ä¸ºè‡ªå·±åˆ›å»ºä¸€ä¸ªç”¨æˆ·ã€‚
* **ç”¨æˆ·æšä¸¾**ï¼šæ³¨å†ŒåŠŸèƒ½å¯ç”¨äºæŸ¥æ‰¾å·²å­˜åœ¨çš„ç”¨æˆ·åã€‚è¿™äº›ä¿¡æ¯å¯¹äºæš´åŠ›ç ´è§£æ”»å‡»å¯èƒ½å¾ˆæœ‰ç”¨ã€‚
* **ç™»å½•æš´åŠ›ç ´è§£**ï¼šåœ¨ [**èº«ä»½éªŒè¯**](cognito-user-pools.md#authentication) éƒ¨åˆ†ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ç”¨æˆ· **ç™»å½•** çš„æ‰€æœ‰ **æ–¹æ³•**ï¼Œæ‚¨å¯ä»¥å°è¯•æš´åŠ›ç ´è§£å®ƒä»¬ä»¥ **æ‰¾åˆ°æœ‰æ•ˆå‡­è¯**ã€‚

### æ¸—é€æµ‹è¯•å·¥å…·

* [Pacu](https://github.com/RhinoSecurityLabs/pacu)ï¼Œç°åœ¨åŒ…æ‹¬ `cognito__enum` å’Œ `cognito__attack` æ¨¡å—ï¼Œè¿™äº›æ¨¡å—è‡ªåŠ¨æšä¸¾è´¦æˆ·ä¸­çš„æ‰€æœ‰ Cognito èµ„äº§å¹¶æ ‡è®°å¼±é…ç½®ã€ç”¨äºè®¿é—®æ§åˆ¶çš„ç”¨æˆ·å±æ€§ç­‰ï¼ŒåŒæ—¶è¿˜è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼ˆåŒ…æ‹¬ MFA æ”¯æŒï¼‰å’ŒåŸºäºå¯ä¿®æ”¹è‡ªå®šä¹‰å±æ€§ã€å¯ç”¨èº«ä»½æ± å‡­è¯ã€å¯å‡è®¾è§’è‰²çš„ ID ä»¤ç‰Œç­‰è¿›è¡Œæƒé™æå‡ã€‚\
æœ‰å…³æ¨¡å—åŠŸèƒ½çš„æè¿°ï¼Œè¯·å‚è§ [åšå®¢æ–‡ç« ](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2) çš„ç¬¬ 2 éƒ¨åˆ†ã€‚æœ‰å…³å®‰è£…è¯´æ˜ï¼Œè¯·å‚è§ä¸» [Pacu](https://github.com/RhinoSecurityLabs/pacu) é¡µé¢ã€‚
```bash
# Run cognito__enum usage to gather all user pools, user pool clients, identity pools, users, etc. visible in the current AWS account
Pacu (new:test) > run cognito__enum

# cognito__attack usage to attempt user creation and all privesc vectors against a given identity pool and user pool client:
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) æ˜¯ä¸€ä¸ªç”¨ Python ç¼–å†™çš„ CLI å·¥å…·ï¼Œå®æ–½å¯¹ Cognito çš„ä¸åŒæ”»å‡»ï¼ŒåŒ…æ‹¬ä¸å¿…è¦çš„è´¦æˆ·åˆ›å»ºå’Œè´¦æˆ· oracleã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [this link](https://github.com/padok-team/cognito-scanner)ã€‚
```bash
# Install
pip install cognito-scanner
# Run
cognito-scanner --help
```
* [CognitoAttributeEnum](https://github.com/punishell/CognitoAttributeEnum): è¯¥è„šæœ¬å…è®¸æšä¸¾ç”¨æˆ·çš„æœ‰æ•ˆå±æ€§ã€‚
```bash
python cognito-attribute-enu.py -client_id 16f1g98bfuj9i0g3f8be36kkrl
```
## æ³¨å†Œ

User Pools é»˜è®¤å…è®¸ **æ³¨å†Œæ–°ç”¨æˆ·**ã€‚
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### å¦‚æœä»»ä½•äººéƒ½å¯ä»¥æ³¨å†Œ

æ‚¨å¯èƒ½ä¼šå‘ç°ä¸€ä¸ªé”™è¯¯ï¼ŒæŒ‡ç¤ºæ‚¨éœ€è¦**æä¾›æ›´å¤šå…³äºç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯**ï¼š
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
æ‚¨å¯ä»¥æä¾›æ‰€éœ€çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ ¼å¼ä¸º JSONï¼Œä¾‹å¦‚ï¼š
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½æ¥**æšä¸¾ç°æœ‰ç”¨æˆ·ã€‚** å½“å·²å­˜åœ¨è¯¥åç§°çš„ç”¨æˆ·æ—¶ï¼Œé”™è¯¯æ¶ˆæ¯ä¸ºï¼š
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
æ³¨æ„åœ¨ä¹‹å‰çš„å‘½ä»¤ä¸­ï¼Œ**è‡ªå®šä¹‰å±æ€§ä»¥ "custom:" å¼€å¤´**ã€‚\
è¿˜è¦çŸ¥é“ï¼Œåœ¨æ³¨å†Œæ—¶ï¼Œæ‚¨**æ— æ³•ä¸ºç”¨æˆ·åˆ›å»ºæ–°çš„è‡ªå®šä¹‰å±æ€§**ã€‚æ‚¨åªèƒ½ä¸º**é»˜è®¤å±æ€§**ï¼ˆå³ä½¿å®ƒä»¬ä¸æ˜¯å¿…éœ€çš„ï¼‰å’Œ**æŒ‡å®šçš„è‡ªå®šä¹‰å±æ€§**èµ‹å€¼ã€‚
{% endhint %}

æˆ–è€…åªæ˜¯æµ‹è¯•å®¢æˆ·ç«¯ ID æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœ client-id ä¸å­˜åœ¨ï¼Œåˆ™ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### å¦‚æœåªæœ‰ç®¡ç†å‘˜å¯ä»¥æ³¨å†Œç”¨æˆ·

æ‚¨å°†ä¼šå‘ç°æ­¤é”™è¯¯ï¼Œæ‚¨å°†æ— æ³•æ³¨å†Œæˆ–æšä¸¾ç”¨æˆ·ï¼š
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### éªŒè¯æ³¨å†Œ

Cognito å…è®¸é€šè¿‡éªŒè¯**ç”µå­é‚®ä»¶æˆ–ç”µè¯å·ç **æ¥**éªŒè¯æ–°ç”¨æˆ·**ã€‚å› æ­¤ï¼Œåœ¨åˆ›å»ºç”¨æˆ·æ—¶ï¼Œé€šå¸¸è‡³å°‘éœ€è¦ç”¨æˆ·åå’Œå¯†ç ï¼Œä»¥åŠ**ç”µå­é‚®ä»¶å’Œ/æˆ–ç”µè¯å·ç **ã€‚åªéœ€è®¾ç½®ä¸€ä¸ª**æ‚¨æ§åˆ¶çš„**ï¼Œè¿™æ ·æ‚¨å°±ä¼šæ”¶åˆ°ä»£ç æ¥**éªŒè¯æ‚¨çš„**æ–°åˆ›å»ºçš„ç”¨æˆ·**å¸æˆ·**ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
å³ä½¿**çœ‹èµ·æ¥ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç”µå­é‚®ä»¶**å’Œç”µè¯å·ç ï¼Œå½“ä½ éœ€è¦éªŒè¯åˆ›å»ºçš„ç”¨æˆ·æ—¶ï¼ŒCognitoä¼šæŠ±æ€¨ä½¿ç”¨ç›¸åŒçš„ä¿¡æ¯ï¼Œå¹¶ä¸”**ä¸ä¼šè®©ä½ éªŒè¯è´¦æˆ·**ã€‚
{% endhint %}

### æƒé™æå‡ / æ›´æ–°å±æ€§

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥**ä¿®æ”¹å…¶å±æ€§çš„å€¼**ï¼Œä¾‹å¦‚ï¼š
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### è‡ªå®šä¹‰å±æ€§æƒé™æå‡

{% hint style="danger" %}
æ‚¨å¯èƒ½ä¼šå‘ç°ä½¿ç”¨äº†**è‡ªå®šä¹‰å±æ€§**ï¼ˆä¾‹å¦‚`isAdmin`ï¼‰ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹æ‚¨å¯ä»¥**æ›´æ”¹è‡ªå·±å±æ€§çš„å€¼**ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿé€šè¿‡è‡ªå·±æ›´æ”¹å€¼æ¥**æå‡æƒé™**ï¼
{% endhint %}

#### ç”µå­é‚®ä»¶/ç”¨æˆ·åä¿®æ”¹æƒé™æå‡

æ‚¨å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½**ä¿®æ”¹ç”¨æˆ·çš„ç”µå­é‚®ä»¶å’Œç”µè¯å·ç **ï¼Œä½†æ˜¯ï¼Œå³ä½¿å¸æˆ·ä»ç„¶è¢«éªŒè¯ï¼Œè¿™äº›å±æ€§ä¹Ÿä¼šè¢«**è®¾ç½®ä¸ºæœªéªŒè¯çŠ¶æ€**ï¼ˆæ‚¨éœ€è¦å†æ¬¡éªŒè¯å®ƒä»¬ï¼‰ã€‚

{% hint style="warning" %}
æ‚¨**æ— æ³•ä½¿ç”¨ç”µå­é‚®ä»¶æˆ–ç”µè¯å·ç ç™»å½•**ï¼Œç›´åˆ°æ‚¨éªŒè¯å®ƒä»¬ï¼Œä½†æ‚¨å°†èƒ½å¤Ÿ**ä½¿ç”¨ç”¨æˆ·åç™»å½•**ã€‚\
è¯·æ³¨æ„ï¼Œå³ä½¿ç”µå­é‚®ä»¶å·²è¢«ä¿®æ”¹ä¸”æœªéªŒè¯ï¼Œå®ƒä»ä¼šå‡ºç°åœ¨IDä»¤ç‰Œä¸­çš„**`email`** **å­—æ®µ**ä¸­ï¼Œå¹¶ä¸”å­—æ®µ**`email_verified`**å°†ä¸º**false**ï¼Œä½†å¦‚æœåº”ç”¨ç¨‹åº**æ²¡æœ‰æ£€æŸ¥ï¼Œæ‚¨å¯èƒ½ä¼šå†’å……å…¶ä»–ç”¨æˆ·**ã€‚

æ­¤å¤–ï¼Œè¯·æ³¨æ„ï¼Œæ‚¨å¯ä»¥åœ¨**`name`**å­—æ®µä¸­æ”¾å…¥ä»»ä½•å†…å®¹ï¼Œåªéœ€ä¿®æ”¹**nameå±æ€§**ã€‚å¦‚æœåº”ç”¨ç¨‹åº**å‡ºäºæŸç§åŸå› æ£€æŸ¥**è¯¥å­—æ®µè€Œä¸æ˜¯`email`ï¼ˆæˆ–ä»»ä½•å…¶ä»–å±æ€§ï¼‰ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿ**å†’å……å…¶ä»–ç”¨æˆ·**ã€‚
{% endhint %}

æ— è®ºå¦‚ä½•ï¼Œå¦‚æœå‡ºäºæŸç§åŸå› æ‚¨å°†ç”µå­é‚®ä»¶æ›´æ”¹ä¸ºå¯ä»¥è®¿é—®çš„æ–°ç”µå­é‚®ä»¶ï¼Œæ‚¨å¯ä»¥**ä½¿ç”¨æ‚¨åœ¨è¯¥ç”µå­é‚®ä»¶åœ°å€æ”¶åˆ°çš„ä»£ç ç¡®è®¤ç”µå­é‚®ä»¶**ï¼š
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
ä½¿ç”¨ **`phone_number`** è€Œä¸æ˜¯ **`email`** æ¥æ›´æ”¹/éªŒè¯ **æ–°ç”µè¯å·ç **ã€‚

{% hint style="info" %}
ç®¡ç†å‘˜è¿˜å¯ä»¥å¯ç”¨ **ä½¿ç”¨ç”¨æˆ·é¦–é€‰ç”¨æˆ·åç™»å½•** çš„é€‰é¡¹ã€‚è¯·æ³¨æ„ï¼Œæ‚¨å°†æ— æ³•å°†æ­¤å€¼æ›´æ”¹ä¸º **ä»»ä½•å·²è¢«ä½¿ç”¨çš„ç”¨æˆ·åæˆ–é¦–é€‰ç”¨æˆ·å** ä»¥å†’å……å…¶ä»–ç”¨æˆ·ã€‚
{% endhint %}

### æ¢å¤/æ›´æ”¹å¯†ç 

åªéœ€ **çŸ¥é“ç”¨æˆ·å**ï¼ˆæˆ–æ¥å—ç”µå­é‚®ä»¶æˆ–ç”µè¯ï¼‰å¹¶è®¿é—®å®ƒï¼Œå› ä¸ºä»£ç å°†å‘é€åˆ°é‚£é‡Œï¼Œæ‚¨å°±å¯ä»¥æ¢å¤å¯†ç ï¼š
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
æœåŠ¡å™¨çš„å“åº”æ€»æ˜¯ä¼šæ˜¯ç§¯æçš„ï¼Œå°±åƒç”¨æˆ·åå­˜åœ¨ä¸€æ ·ã€‚æ‚¨æ— æ³•ä½¿ç”¨æ­¤æ–¹æ³•æ¥æšä¸¾ç”¨æˆ·
{% endhint %}

ä½¿ç”¨ä»£ç å¯ä»¥æ›´æ”¹å¯†ç ï¼š
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
è¦æ›´æ”¹å¯†ç ï¼Œæ‚¨éœ€è¦**çŸ¥é“ä¹‹å‰çš„å¯†ç **ï¼š
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## è®¤è¯

ç”¨æˆ·æ± æ”¯æŒ**ä¸åŒçš„è®¤è¯æ–¹å¼**ã€‚å¦‚æœæ‚¨æœ‰**ç”¨æˆ·åå’Œå¯†ç **ï¼Œä¹Ÿæ”¯æŒ**ä¸åŒçš„æ–¹æ³•**è¿›è¡Œç™»å½•ã€‚\
æ­¤å¤–ï¼Œå½“ç”¨æˆ·åœ¨æ± ä¸­è¢«è®¤è¯æ—¶ï¼Œ**ä¼šå‘æ”¾3ç§ç±»å‹çš„ä»¤ç‰Œ**ï¼š**IDä»¤ç‰Œ**ã€**è®¿é—®ä»¤ç‰Œ**å’Œ**åˆ·æ–°ä»¤ç‰Œ**ã€‚

* [**IDä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html)ï¼šå®ƒåŒ…å«å…³äº**å·²è®¤è¯ç”¨æˆ·èº«ä»½**çš„å£°æ˜ï¼Œä¾‹å¦‚`name`ã€`email`å’Œ`phone_number`ã€‚IDä»¤ç‰Œä¹Ÿå¯ä»¥ç”¨äº**å¯¹æ‚¨çš„èµ„æºæœåŠ¡å™¨æˆ–æœåŠ¡å™¨åº”ç”¨ç¨‹åºè¿›è¡Œç”¨æˆ·è®¤è¯**ã€‚å¦‚æœæ‚¨åœ¨å¤–éƒ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨IDä»¤ç‰Œï¼Œæ‚¨å¿…é¡»**éªŒè¯**IDä»¤ç‰Œçš„**ç­¾å**ï¼Œæ‰èƒ½ä¿¡ä»»IDä»¤ç‰Œä¸­çš„ä»»ä½•å£°æ˜ã€‚
* IDä»¤ç‰Œæ˜¯**åŒ…å«ç”¨æˆ·å±æ€§å€¼**çš„ä»¤ç‰Œï¼Œç”šè‡³åŒ…æ‹¬è‡ªå®šä¹‰å±æ€§ã€‚
* [**è®¿é—®ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html)ï¼šå®ƒåŒ…å«å…³äºå·²è®¤è¯ç”¨æˆ·çš„å£°æ˜ã€**ç”¨æˆ·ç»„åˆ—è¡¨**å’Œ**ä½œç”¨åŸŸåˆ—è¡¨**ã€‚è®¿é—®ä»¤ç‰Œçš„ç›®çš„æ˜¯åœ¨ç”¨æˆ·æ± ä¸­**æˆæƒAPIæ“ä½œ**ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è®¿é—®ä»¤ç‰Œ**æˆäºˆç”¨æˆ·è®¿é—®**æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤ç”¨æˆ·å±æ€§çš„æƒé™ã€‚
* [**åˆ·æ–°ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html)ï¼šä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼Œæ‚¨å¯ä»¥ä¸ºç”¨æˆ·**è·å–æ–°çš„IDä»¤ç‰Œå’Œè®¿é—®ä»¤ç‰Œ**ï¼Œç›´åˆ°**åˆ·æ–°ä»¤ç‰Œå¤±æ•ˆ**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ·æ–°ä»¤ç‰Œ**åœ¨åº”ç”¨ç¨‹åºç”¨æˆ·ç™»å½•åˆ°ç”¨æˆ·æ± å30å¤©è¿‡æœŸ**ã€‚å½“æ‚¨ä¸ºç”¨æˆ·æ± åˆ›å»ºåº”ç”¨ç¨‹åºæ—¶ï¼Œå¯ä»¥å°†åº”ç”¨ç¨‹åºçš„åˆ·æ–°ä»¤ç‰Œè¿‡æœŸæ—¶é—´è®¾ç½®ä¸º**60åˆ†é’Ÿåˆ°10å¹´ä¹‹é—´çš„ä»»ä½•å€¼**ã€‚

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

è¿™æ˜¯æœåŠ¡å™¨ç«¯è®¤è¯æµç¨‹ï¼š

* æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºè°ƒç”¨**`AdminInitiateAuth` APIæ“ä½œ**ï¼ˆè€Œä¸æ˜¯`InitiateAuth`ï¼‰ã€‚æ­¤æ“ä½œéœ€è¦å…·æœ‰åŒ…æ‹¬**`cognito-idp:AdminInitiateAuth`**å’Œ**`cognito-idp:AdminRespondToAuthChallenge`**æƒé™çš„AWSå‡­è¯ã€‚è¯¥æ“ä½œè¿”å›æ‰€éœ€çš„è®¤è¯å‚æ•°ã€‚
* åœ¨æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºè·å¾—**è®¤è¯å‚æ•°**åï¼Œå®ƒè°ƒç”¨**`AdminRespondToAuthChallenge` APIæ“ä½œ**ã€‚åªæœ‰åœ¨æä¾›AWSå‡­è¯æ—¶ï¼Œ`AdminRespondToAuthChallenge` APIæ“ä½œæ‰ä¼šæˆåŠŸã€‚

æ­¤**æ–¹æ³•é»˜è®¤æƒ…å†µä¸‹æœªå¯ç”¨**ã€‚

è¦**ç™»å½•**ï¼Œæ‚¨**éœ€è¦**çŸ¥é“ï¼š

* ç”¨æˆ·æ± ID
* å®¢æˆ·ç«¯ID
* ç”¨æˆ·å
* å¯†ç 
* å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…åœ¨åº”ç”¨ç¨‹åºé…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶ï¼‰

{% hint style="info" %}
ä¸ºäº†**èƒ½å¤Ÿä½¿ç”¨æ­¤æ–¹æ³•ç™»å½•**ï¼Œè¯¥åº”ç”¨ç¨‹åºå¿…é¡»å…è®¸ä½¿ç”¨`ALLOW_ADMIN_USER_PASSWORD_AUTH`è¿›è¡Œç™»å½•ã€‚\
æ­¤å¤–ï¼Œè¦æ‰§è¡Œæ­¤æ“ä½œï¼Œæ‚¨éœ€è¦å…·æœ‰**`cognito-idp:AdminInitiateAuth`**å’Œ**`cognito-idp:AdminRespondToAuthChallenge`**æƒé™çš„å‡­è¯ã€‚
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>ç™»å½•ä»£ç </summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

æ­¤æ–¹æ³•æ˜¯å¦ä¸€ç§ç®€å•ä¸”**ä¼ ç»Ÿçš„ç”¨æˆ·å’Œå¯†ç è®¤è¯**æµç¨‹ã€‚å»ºè®®å°†**ä¼ ç»Ÿçš„**è®¤è¯æ–¹æ³•**è¿ç§»åˆ°Cognito**ï¼Œå¹¶å»ºè®®éšå**ç¦ç”¨**å®ƒï¼Œæ”¹ä¸ºä½¿ç”¨**ALLOW\_USER\_SRP\_AUTH**æ–¹æ³•ï¼ˆå› ä¸ºè¯¥æ–¹æ³•ä»ä¸é€šè¿‡ç½‘ç»œå‘é€å¯†ç ï¼‰ã€‚\
æ­¤**æ–¹æ³•é»˜è®¤æƒ…å†µä¸‹æœªå¯ç”¨**ã€‚

ä¸ä»£ç ä¸­çš„**å‰ä¸€ç§è®¤è¯æ–¹æ³•**çš„ä¸»è¦**åŒºåˆ«**åœ¨äºæ‚¨**ä¸éœ€è¦çŸ¥é“ç”¨æˆ·æ± ID**ï¼Œå¹¶ä¸”æ‚¨**ä¸éœ€è¦é¢å¤–çš„æƒé™**åœ¨Cognitoç”¨æˆ·æ± ä¸­ã€‚

è¦**ç™»å½•**ï¼Œæ‚¨**éœ€è¦**çŸ¥é“ï¼š

* å®¢æˆ·ç«¯ID
* ç”¨æˆ·å
* å¯†ç 
* å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…åœ¨åº”ç”¨ç¨‹åºé…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶ï¼‰

{% hint style="info" %}
ä¸ºäº†**èƒ½å¤Ÿä½¿ç”¨æ­¤æ–¹æ³•ç™»å½•**ï¼Œè¯¥åº”ç”¨ç¨‹åºå¿…é¡»å…è®¸ä½¿ç”¨ALLOW\_USER\_PASSWORD\_AUTHç™»å½•ã€‚
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>ç”¨äºç™»å½•çš„Pythonä»£ç </summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

è¿™ä¸ªåœºæ™¯ä¸ä¹‹å‰çš„ç±»ä¼¼ï¼Œä½†**ä¸æ˜¯é€šè¿‡ç½‘ç»œå‘é€å¯†ç **æ¥ç™»å½•ï¼Œè€Œæ˜¯**æ‰§è¡ŒæŒ‘æˆ˜è®¤è¯**ï¼ˆå› æ­¤æ²¡æœ‰å¯†ç å³ä½¿åŠ å¯†åä¹Ÿä¸ä¼šåœ¨ç½‘ç»œä¸­ä¼ è¾“ï¼‰ã€‚\
è¿™ä¸ª**æ–¹æ³•æ˜¯é»˜è®¤å¯ç”¨çš„**ã€‚

è¦**ç™»å½•**ï¼Œæ‚¨**éœ€è¦**çŸ¥é“ï¼š

* ç”¨æˆ·æ±  ID
* å®¢æˆ·ç«¯ ID
* ç”¨æˆ·å
* å¯†ç 
* å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…åœ¨åº”ç”¨ç¨‹åºé…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶éœ€è¦ï¼‰

<details>

<summary>Code to login</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

æ­¤**æ–¹æ³•å§‹ç»ˆæœ‰æ•ˆ**ï¼ˆæ— æ³•ç¦ç”¨ï¼‰ï¼Œä½†æ‚¨éœ€è¦æ‹¥æœ‰æœ‰æ•ˆçš„åˆ·æ–°ä»¤ç‰Œã€‚
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>åˆ·æ–°ä»£ç </summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**èº«ä»½éªŒè¯**å°†é€šè¿‡**æ‰§è¡Œä¸€ä¸ªlambdaå‡½æ•°**æ¥è¿›è¡Œã€‚

## é¢å¤–å®‰å…¨æ€§

### é«˜çº§å®‰å…¨æ€§

é»˜è®¤æƒ…å†µä¸‹æ˜¯ç¦ç”¨çš„ï¼Œä½†å¦‚æœå¯ç”¨ï¼ŒCognitoå¯èƒ½èƒ½å¤Ÿ**å‘ç°è´¦æˆ·æ¥ç®¡**ã€‚ä¸ºäº†æœ€å°åŒ–è¿™ç§å¯èƒ½æ€§ï¼Œæ‚¨åº”è¯¥ä»**åŒä¸€åŸå¸‚çš„ç½‘ç»œç™»å½•ï¼Œä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·ä»£ç†**ï¼ˆå¦‚æœå¯èƒ½çš„è¯ï¼Œä½¿ç”¨ç›¸åŒçš„IPï¼‰ã€‚

### **MFA è®°ä½è®¾å¤‡**

å¦‚æœç”¨æˆ·ä»åŒä¸€è®¾å¤‡ç™»å½•ï¼ŒMFAå¯èƒ½ä¼šè¢«ç»•è¿‡ï¼Œå› æ­¤å°è¯•ä»ç›¸åŒçš„æµè§ˆå™¨å’Œç›¸åŒçš„å…ƒæ•°æ®ï¼ˆIPï¼Ÿï¼‰ç™»å½•ï¼Œä»¥å°è¯•ç»•è¿‡MFAä¿æŠ¤ã€‚

## ç”¨æˆ·æ± ç»„ IAM è§’è‰²

å¯ä»¥å°†**ç”¨æˆ·æ·»åŠ åˆ°ä¸ä¸€ä¸ª**IAMè§’è‰²**ç›¸å…³çš„ç”¨æˆ·æ± ç»„ä¸­ã€‚\
æ­¤å¤–ï¼Œ**ç”¨æˆ·**å¯ä»¥è¢«åˆ†é…åˆ°**å¤šä¸ªå…·æœ‰ä¸åŒIAMè§’è‰²**çš„ç»„ä¸­ã€‚

è¯·æ³¨æ„ï¼Œå³ä½¿ä¸€ä¸ªç»„åœ¨ä¸€ä¸ªé™„æœ‰IAMè§’è‰²çš„ç»„å†…ï¼Œè¦èƒ½å¤Ÿè®¿é—®è¯¥ç»„çš„IAMå‡­è¯ï¼Œéœ€è¦**ç”¨æˆ·æ± è¢«èº«ä»½æ± ä¿¡ä»»**ï¼ˆå¹¶äº†è§£è¯¥èº«ä»½æ± çš„è¯¦ç»†ä¿¡æ¯ï¼‰ã€‚

å¦ä¸€ä¸ªè¦æ±‚æ˜¯åœ¨ç”¨æˆ·åœ¨ç”¨æˆ·æ± ä¸­ç»è¿‡èº«ä»½éªŒè¯æ—¶è·å–**IdTokenä¸­æŒ‡ç¤ºçš„IAMè§’è‰²**ï¼ˆ`aws cognito-idp initiate-auth...`ï¼‰ï¼Œéœ€è¦**èº«ä»½æä¾›è€…èº«ä»½éªŒè¯æä¾›è€…**æŒ‡ç¤º**è§’è‰²å¿…é¡»ä»ä»¤ç‰Œä¸­é€‰æ‹©**ã€‚

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

ç”¨æˆ·å¯ä»¥è®¿é—®çš„**è§’è‰²**åœ¨**`IdToken`**ä¸­ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨`aws cognito-identity get-credentials-for-identity`ä¸­çš„**`--custom-role-arn`**é€‰æ‹©ä»–å¸Œæœ›è·å–å‡­è¯çš„**è§’è‰²**ã€‚\
ç„¶è€Œï¼Œå¦‚æœ**é»˜è®¤é€‰é¡¹**æ˜¯**é…ç½®çš„**ï¼ˆ`ä½¿ç”¨é»˜è®¤è§’è‰²`ï¼‰ï¼Œå¹¶ä¸”æ‚¨å°è¯•ä»IdTokenè®¿é—®ä¸€ä¸ªè§’è‰²ï¼Œæ‚¨å°†ä¼šå¾—åˆ°**é”™è¯¯**ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦ä¹‹å‰çš„é…ç½®ï¼‰ï¼š 

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œåˆ†é…ç»™ **ç”¨æˆ·æ± ç»„** çš„è§’è‰²éœ€è¦è¢« **ä¿¡ä»»ç”¨æˆ·æ± çš„èº«ä»½æä¾›è€…** **è®¿é—®**ï¼ˆå› ä¸º IAM è§’è‰² **ä¼šè¯å‡­è¯å°†ä»ä¸­è·å–**ï¼‰ã€‚
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
