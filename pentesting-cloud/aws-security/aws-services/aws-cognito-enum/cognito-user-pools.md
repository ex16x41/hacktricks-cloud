# Cognito User Pools

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã¯Amazon Cognitoã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯Amazon Cognitoã‚’é€šã˜ã¦**ã‚¦ã‚§ãƒ–ã¾ãŸã¯ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³**ã—ãŸã‚Šã€**ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®**ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆIdPï¼‰ã‚’é€šã˜ã¦**ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç›´æ¥ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã‹ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã‚’é€šã˜ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã‹ã«é–¢ã‚ã‚‰ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã®ã™ã¹ã¦ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯SDKã‚’é€šã˜ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã‚’æä¾›ã—ã¾ã™ï¼š

* ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãŠã‚ˆã³ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã€‚
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã•ã›ã‚‹ãŸã‚ã®çµ„ã¿è¾¼ã¿ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªã‚¦ã‚§ãƒ–UIã€‚
* Facebookã€Googleã€Amazonã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã€Appleã§ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€SAMLãŠã‚ˆã³OIDCã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’é€šã˜ãŸã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€‚
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç®¡ç†ãŠã‚ˆã³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€‚
* å¤šè¦ç´ èªè¨¼ï¼ˆMFAï¼‰ã€æ¼æ´©ã—ãŸè³‡æ ¼æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¹—ã£å–ã‚Šä¿è­·ã€é›»è©±ãŠã‚ˆã³ãƒ¡ãƒ¼ãƒ«ã®æ¤œè¨¼ãªã©ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã€‚
* AWS Lambdaãƒˆãƒªã‚¬ãƒ¼ã‚’é€šã˜ãŸã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŠã‚ˆã³ãƒ¦ãƒ¼ã‚¶ãƒ¼ç§»è¡Œã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®**ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰**ã«ã¯é€šå¸¸ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ID**ãŠã‚ˆã³**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ID**ï¼ˆãŠã‚ˆã³æ™‚ã«ã¯**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ**ï¼Ÿï¼‰ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‚‰ã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒCognito User Poolã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹**ãŸã‚ã«å¿…è¦ã§ã™ã€‚

### æ½œåœ¨çš„ãªæ”»æ’ƒ

* **ç™»éŒ²**ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã§ç™»éŒ²ã§ãã‚‹ãŸã‚ã€è‡ªåˆ†è‡ªèº«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* **ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ—æŒ™**ï¼šç™»éŒ²æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®æƒ…å ±ã¯ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã«å½¹ç«‹ã¡ã¾ã™ã€‚
* **ãƒ­ã‚°ã‚¤ãƒ³ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹**ï¼š[**èªè¨¼**](cognito-user-pools.md#authentication)ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ**ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹**ãŸã‚ã®ã™ã¹ã¦ã®**æ–¹æ³•**ãŒè¨˜è¼‰ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‚‰ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—ã¦**æœ‰åŠ¹ãªè³‡æ ¼æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒšãƒ³ãƒ†ã‚¹ãƒˆç”¨ãƒ„ãƒ¼ãƒ«

* [Pacu](https://github.com/RhinoSecurityLabs/pacu)ã€AWSã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã¯ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã®ã™ã¹ã¦ã®Cognitoè³‡ç”£ã®åˆ—æŒ™ã‚’è‡ªå‹•åŒ–ã—ã€å¼±ã„æ§‹æˆã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ãªã©ã‚’ãƒ•ãƒ©ã‚°ã™ã‚‹ã€Œcognito\_\_enumã€ãŠã‚ˆã³ã€Œcognito\_\_attackã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆMFAã‚µãƒãƒ¼ãƒˆã‚’å«ã‚€ï¼‰ãŠã‚ˆã³å¤‰æ›´å¯èƒ½ãªã‚«ã‚¹ã‚¿ãƒ å±æ€§ã€ä½¿ç”¨å¯èƒ½ãªã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«è³‡æ ¼æƒ…å ±ã€idãƒˆãƒ¼ã‚¯ãƒ³å†…ã®å¼•ãå—ã‘å¯èƒ½ãªãƒ­ãƒ¼ãƒ«ã«åŸºã¥ãç‰¹æ¨©æ˜‡æ ¼ã‚’è‡ªå‹•åŒ–ã—ã¾ã™ã€‚

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ©Ÿèƒ½ã®èª¬æ˜ã«ã¤ã„ã¦ã¯ã€[ãƒ–ãƒ­ã‚°è¨˜äº‹](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)ã®ãƒ‘ãƒ¼ãƒˆ2ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã«ã¤ã„ã¦ã¯ã€ãƒ¡ã‚¤ãƒ³ã®[Pacu](https://github.com/RhinoSecurityLabs/pacu)ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### ä½¿ç”¨æ–¹æ³•

æŒ‡å®šã•ã‚ŒãŸã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ãŠã‚ˆã³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãŠã‚ˆã³ã™ã¹ã¦ã®ç‰¹æ¨©æ˜‡æ ¼ãƒ™ã‚¯ãƒˆãƒ«ã‚’è©¦ã¿ã‚‹ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«cognito\_\_attackä½¿ç”¨æ³•ï¼š
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
ç¾åœ¨ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§è¡¨ç¤ºã•ã‚Œã‚‹ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã©ã‚’åé›†ã™ã‚‹ãŸã‚ã®cognito\_\_enumã®ä½¿ç”¨ä¾‹:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) ã¯ã€ä¸è¦ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã‚„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚ªãƒ©ã‚¯ãƒ«ã‚’å«ã‚€Cognitoã¸ã®ã•ã¾ã–ã¾ãªæ”»æ’ƒã‚’å®Ÿè£…ã™ã‚‹pythonã®CLIãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

#### Installationï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
```bash
$ pip install cognito-scanner
```
#### Usage

```html
<!DOCTYPE html>
<html>
<head>
    <title>aws-cognito-enum</title>
</head>
<body>
    <h1>aws-cognito-enum</h1>
    <p>aws-cognito-enumã¯ã€AWS Cognito User Poolsã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’åˆ—æŒ™ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p>
</body>
</html>
```

```bash
$ aws-cognito-enum -u <username> -p <password> -r <region> -c <client_id>
```

#### Example

```bash
$ aws-cognito-enum -u exampleuser -p examplepassword -r us-west-2 -c 1h57kf5cpq17m0eml12EXAMPLE
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã€ãŠã‚ˆã³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’ä½¿ç”¨ã—ã¦AWS Cognito User Poolsã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’åˆ—æŒ™ã—ã¾ã™ã€‚
```bash
$ cognito-scanner --help
```
è©³ç´°ã«ã¤ã„ã¦ã¯ã€https://github.com/padok-team/cognito-scanner ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## Registration

User Poolsã¯**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**ã§**æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²**ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã¾ã™ã€‚
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### èª°ã§ã‚‚ç™»éŒ²ã§ãã‚‹å ´åˆ

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹**è©³ç´°æƒ…å ±ã‚’æä¾›**ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
```markdown
å¿…è¦ãªè©³ç´°ã¯ã€æ¬¡ã®ã‚ˆã†ãªJSONã§æä¾›ã§ãã¾ã™ï¼š
```
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦**æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ—æŒ™**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€ãã®åå‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
å‰ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€**ã‚«ã‚¹ã‚¿ãƒ å±æ€§ãŒ "custom:" ã§å§‹ã¾ã‚‹**ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚\
ã¾ãŸã€ç™»éŒ²æ™‚ã«**æ–°ã—ã„ã‚«ã‚¹ã‚¿ãƒ å±æ€§ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä½œæˆã™ã‚‹ã“ã¨ã¯ã§ããªã„**ã“ã¨ã‚‚çŸ¥ã£ã¦ãŠã„ã¦ãã ã•ã„ã€‚**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå±æ€§**ï¼ˆå¿…é ˆã§ãªãã¦ã‚‚ï¼‰ã¨**æŒ‡å®šã•ã‚ŒãŸã‚«ã‚¹ã‚¿ãƒ å±æ€§**ã«ã®ã¿å€¤ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
{% endhint %}

ã¾ãŸã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã ã‘ã§ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### If only admin can register users

ç®¡ç†è€…ã®ã¿ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã§ãã‚‹å ´åˆã€æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã¾ãŸã¯åˆ—æŒ™ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Verifying Registration

Cognitoã¯**ãƒ¡ãƒ¼ãƒ«ã¾ãŸã¯é›»è©±ç•ªå·ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œè¨¼**ã—ã¾ã™ã€‚ãã®ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹éš›ã«ã¯é€šå¸¸ã€å°‘ãªãã¨ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãã—ã¦**ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŠã‚ˆã³/ã¾ãŸã¯é›»è©±ç•ªå·**ãŒå¿…è¦ã§ã™ã€‚**ã‚ãªãŸãŒç®¡ç†ã™ã‚‹**ã‚‚ã®ã‚’è¨­å®šã™ã‚‹ã ã‘ã§ã€**æ–°ã—ãä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã‚’**ç¢ºèªã™ã‚‹**ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
**åŒã˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚„é›»è©±ç•ªå·ã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«è¦‹ãˆã¦ã‚‚ã€ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€Cognitoã¯åŒã˜æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã¤ã„ã¦ä¸æº€ã‚’è¨€ã„ã€**ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç¢ºèªã•ã›ã¾ã›ã‚“**ã€‚
{% endhint %}

### æ¨©é™æ˜‡æ ¼ / å±æ€§ã®æ›´æ–°

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ¬¡ã®ã‚ˆã†ã«ã—ã¦**è‡ªåˆ†ã®å±æ€§ã®å€¤ã‚’å¤‰æ›´**ã§ãã¾ã™:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Custom attribute privesc

{% hint style="danger" %}
**ã‚«ã‚¹ã‚¿ãƒ å±æ€§**ï¼ˆä¾‹ãˆã° `isAdmin`ï¼‰ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯**è‡ªåˆ†ã®å±æ€§ã®å€¤ã‚’å¤‰æ›´**ã§ãã‚‹ãŸã‚ã€è‡ªåˆ†ã§å€¤ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§**æ¨©é™ã‚’æ˜‡æ ¼**ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼
{% endhint %}

#### Email/username modification privesc

ã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„é›»è©±ç•ªå·ã‚’å¤‰æ›´**ã§ãã¾ã™ãŒã€ãã®å¾Œã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ¤œè¨¼æ¸ˆã¿ã®ã¾ã¾ã§ã‚ã£ã¦ã‚‚ã€ãã‚Œã‚‰ã®å±æ€§ã¯**æœªæ¤œè¨¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**ã«è¨­å®šã•ã‚Œã¾ã™ï¼ˆå†åº¦æ¤œè¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚

{% hint style="warning" %}
**ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„é›»è©±ç•ªå·ã§ãƒ­ã‚°ã‚¤ãƒ³**ã™ã‚‹ã“ã¨ã¯**æ¤œè¨¼ã™ã‚‹ã¾ã§ã§ãã¾ã›ã‚“**ãŒã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ãƒ­ã‚°ã‚¤ãƒ³**ã™ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ã€‚\
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰æ›´ã•ã‚Œã¦æœªæ¤œè¨¼ã®ã¾ã¾ã§ã‚‚ã€IDãƒˆãƒ¼ã‚¯ãƒ³å†…ã®**`email`** **ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**ã«è¡¨ç¤ºã•ã‚Œã€**`email_verified`** ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯**false**ã«ãªã‚Šã¾ã™ãŒã€ã‚¢ãƒ—ãƒªãŒãã‚Œã‚’**ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ãªã„å ´åˆã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã‚Šã™ã¾ã™**ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã•ã‚‰ã«ã€**`name`** ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä½•ã§ã‚‚å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã€**nameå±æ€§**ã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚ã‚¢ãƒ—ãƒªãŒä½•ã‚‰ã‹ã®ç†ç”±ã§**`email`**ï¼ˆã¾ãŸã¯ä»–ã®å±æ€§ï¼‰ã§ã¯ãªã**ãã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯**ã—ã¦ã„ã‚‹å ´åˆã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã‚Šã™ã¾ã™ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
{% endhint %}

ã„ãšã‚Œã«ã›ã‚ˆã€ä¾‹ãˆã°æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›´ã—ãŸå ´åˆã€ãã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å±Šã„ãŸã‚³ãƒ¼ãƒ‰ã§**ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèª**ã§ãã¾ã™ï¼š
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
**`phone_number`** ã‚’ **`email`** ã®ä»£ã‚ã‚Šã«ä½¿ç”¨ã—ã¦ã€**æ–°ã—ã„é›»è©±ç•ªå·** ã‚’å¤‰æ›´/ç¢ºèªã—ã¾ã™ã€‚

{% hint style="info" %}
ç®¡ç†è€…ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¥½ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã“ã®å€¤ã‚’**æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ preferred\_username** ã«å¤‰æ›´ã—ã¦ã€åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã‚Šã™ã¾ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
{% endhint %}

### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å›å¾©/å¤‰æ›´

ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã‚„é›»è©±ç•ªå·ãŒå—ã‘å…¥ã‚Œã‚‰ã‚Œã¾ã™ï¼‰ã‚’çŸ¥ã£ã¦ã„ã‚‹ã ã‘ã§ã€ãã“ã«ã‚³ãƒ¼ãƒ‰ãŒé€ä¿¡ã•ã‚Œã‚‹ãŸã‚ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å›å¾©ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
ã‚µãƒ¼ãƒãƒ¼ã®å¿œç­”ã¯å¸¸ã«è‚¯å®šçš„ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå­˜åœ¨ã™ã‚‹ã‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã®æ–¹æ³•ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ—æŒ™ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
{% endhint %}

ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã¾ã™:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã«ã¯ã€**ä»¥å‰ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’çŸ¥ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## èªè¨¼

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã¯**ç•°ãªã‚‹èªè¨¼æ–¹æ³•**ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚**ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ãŒã‚ã‚‹å ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹**ç•°ãªã‚‹æ–¹æ³•**ã‚‚ã‚ã‚Šã¾ã™ã€‚\
ã•ã‚‰ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ¼ãƒ«ã§èªè¨¼ã•ã‚Œã‚‹ã¨ã€**3ç¨®é¡ã®ãƒˆãƒ¼ã‚¯ãƒ³**ãŒæä¾›ã•ã‚Œã¾ã™ï¼š**IDãƒˆãƒ¼ã‚¯ãƒ³**ã€**ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³**ã€**ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³**ã§ã™ã€‚

* [**IDãƒˆãƒ¼ã‚¯ãƒ³**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): ã“ã‚Œã¯ã€èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«é–¢ã™ã‚‹ã‚¯ãƒ¬ãƒ¼ãƒ **ï¼ˆ`name`ã€`email`ã€`phone_number`ãªã©ï¼‰ã‚’å«ã¿ã¾ã™ã€‚IDãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€**ãƒªã‚½ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼ã‚„ã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ã™ã‚‹ãŸã‚**ã«ã‚‚ä½¿ç”¨ã§ãã¾ã™ã€‚å¤–éƒ¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã™ã‚‹å ´åˆã€IDãƒˆãƒ¼ã‚¯ãƒ³å†…ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ä¿¡é ¼ã™ã‚‹å‰ã«ã€IDãƒˆãƒ¼ã‚¯ãƒ³ã®**ç½²åã‚’æ¤œè¨¼**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
* IDãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±æ€§å€¤**ï¼ˆã‚«ã‚¹ã‚¿ãƒ å±æ€§ã‚‚å«ã‚€ï¼‰ã‚’å«ã‚€ãƒˆãƒ¼ã‚¯ãƒ³ã§ã™ã€‚
* [**ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): ã“ã‚Œã¯ã€èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹ã‚¯ãƒ¬ãƒ¼ãƒ ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒªã‚¹ãƒˆã€ãŠã‚ˆã³ã‚¹ã‚³ãƒ¼ãƒ—ã®ãƒªã‚¹ãƒˆ**ã‚’å«ã¿ã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç›®çš„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§**APIæ“ä½œã‚’èªå¯ã™ã‚‹**ã“ã¨ã§ã™ã€‚ä¾‹ãˆã°ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã®è¿½åŠ ã€å¤‰æ›´ã€å‰Šé™¤ã®**ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* [**ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**æ–°ã—ã„IDãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—**ã§ãã¾ã™ã€‚**ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã«ãªã‚‹ã¾ã§**ã§ã™ã€‚**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯**ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã‹ã‚‰**30æ—¥å¾Œã«æœŸé™åˆ‡ã‚Œ**ã«ãªã‚Šã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ç”¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹éš›ã«ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’**60åˆ†ã‹ã‚‰10å¹´ã®é–“ã®ä»»æ„ã®å€¤ã«è¨­å®š**ã§ãã¾ã™ã€‚

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

ã“ã‚Œã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®èªè¨¼ãƒ•ãƒ­ãƒ¼ã§ã™ï¼š

* ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¢ãƒ—ãƒªã¯ã€**`AdminInitiateAuth` APIæ“ä½œ**ï¼ˆ`InitiateAuth`ã®ä»£ã‚ã‚Šï¼‰ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã“ã®æ“ä½œã«ã¯ã€**`cognito-idp:AdminInitiateAuth`**ãŠã‚ˆã³**`cognito-idp:AdminRespondToAuthChallenge`**ã‚’å«ã‚€æ¨©é™ã‚’æŒã¤AWSã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãŒå¿…è¦ã§ã™ã€‚ã“ã®æ“ä½œã¯å¿…è¦ãªèªè¨¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿”ã—ã¾ã™ã€‚
* ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¢ãƒ—ãƒªãŒ**èªè¨¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**ã‚’å–å¾—ã—ãŸå¾Œã€**`AdminRespondToAuthChallenge` APIæ“ä½œ**ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚`AdminRespondToAuthChallenge` APIæ“ä½œã¯ã€AWSã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’æä¾›ã—ãŸå ´åˆã«ã®ã¿æˆåŠŸã—ã¾ã™ã€‚

ã“ã®**æ–¹æ³•ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“**ã€‚

**ãƒ­ã‚°ã‚¤ãƒ³**ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ãŒ**å¿…è¦**ã§ã™ï¼š

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ID
* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
* ãƒ¦ãƒ¼ã‚¶ãƒ¼å
* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆã‚¢ãƒ—ãƒªãŒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰

{% hint style="info" %}
ã“ã®æ–¹æ³•ã§**ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã«ã¯**ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒ`ALLOW_ADMIN_USER_PASSWORD_AUTH`ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¨±å¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\
ã•ã‚‰ã«ã€ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€**`cognito-idp:AdminInitiateAuth`**ãŠã‚ˆã³**`cognito-idp:AdminRespondToAuthChallenge`**ã®æ¨©é™ã‚’æŒã¤ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãŒå¿…è¦ã§ã™ã€‚
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

ã“ã®æ–¹æ³•ã¯ã€ã‚‚ã†ä¸€ã¤ã®ã‚·ãƒ³ãƒ—ãƒ«ã§**ä¼çµ±çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼**ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚**ä¼çµ±çš„ãª**èªè¨¼æ–¹æ³•ã‚’**Cognitoã«ç§»è¡Œ**ã—ã€ãã®å¾Œ**ç„¡åŠ¹åŒ–**ã—ã¦**ALLOW\_USER\_SRP\_AUTH**ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒ**æ¨å¥¨ã•ã‚Œã¾ã™**ï¼ˆã“ã®æ–¹æ³•ã§ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚\
ã“ã®**æ–¹æ³•ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“**ã€‚

**å‰ã®èªè¨¼æ–¹æ³•**ã¨ã®ä¸»ãª**é•ã„**ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«IDã‚’çŸ¥ã‚‹å¿…è¦ãŒãªã„**ã“ã¨ã¨ã€Cognito User Poolã§**è¿½åŠ ã®æ¨©é™ãŒå¿…è¦ãªã„**ã“ã¨ã§ã™ã€‚

**ãƒ­ã‚°ã‚¤ãƒ³**ã™ã‚‹ãŸã‚ã«**å¿…è¦ãªã‚‚ã®**ã¯ä»¥ä¸‹ã§ã™ï¼š

* client id
* username
* password
* client secretï¼ˆã‚¢ãƒ—ãƒªãŒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰

{% hint style="info" %}
ã“ã®æ–¹æ³•ã§**ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã¯**ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒALLOW\_USER\_PASSWORD\_AUTHã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¨±å¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã®Pythonã‚³ãƒ¼ãƒ‰</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

ã“ã®ã‚·ãƒŠãƒªã‚ªã¯å‰ã®ã‚‚ã®ã¨ä¼¼ã¦ã„ã¾ã™ãŒã€**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±ã§é€ä¿¡ã™ã‚‹ä»£ã‚ã‚Šã«**ã€**ãƒãƒ£ãƒ¬ãƒ³ã‚¸èªè¨¼ãŒè¡Œã‚ã‚Œã¾ã™**ï¼ˆã—ãŸãŒã£ã¦ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ã¦ã‚‚ãƒãƒƒãƒˆã‚’é€šã˜ã¦ç§»å‹•ã—ã¾ã›ã‚“ï¼‰ã€‚\
ã“ã®**æ–¹æ³•ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹**ã§ã™ã€‚

**ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹**ã«ã¯ä»¥ä¸‹ãŒ**å¿…è¦**ã§ã™ï¼š

* user pool id
* client id
* username
* password
* client secretï¼ˆã‚¢ãƒ—ãƒªãŒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰

<details>

<summary>ãƒ­ã‚°ã‚¤ãƒ³ã®ãŸã‚ã®ã‚³ãƒ¼ãƒ‰</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

ã“ã®**ãƒ¡ã‚½ãƒƒãƒ‰ã¯å¸¸ã«æœ‰åŠ¹**ï¼ˆç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼‰ã§ã™ãŒã€æœ‰åŠ¹ãªãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™ã€‚
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

ã“ã®å ´åˆã€**èªè¨¼**ã¯**Lambdaé–¢æ•°ã®å®Ÿè¡Œ**ã‚’é€šã˜ã¦è¡Œã‚ã‚Œã¾ã™ã€‚

## è¿½åŠ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç„¡åŠ¹ã§ã™ãŒã€æœ‰åŠ¹ã«ã™ã‚‹ã¨Cognitoã¯**ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¹—ã£å–ã‚Šã‚’æ¤œå‡º**ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç¢ºç‡ã‚’æœ€å°é™ã«ã™ã‚‹ãŸã‚ã«ã¯ã€**åŒã˜éƒ½å¸‚å†…ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã€åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ï¼ˆå¯èƒ½ã§ã‚ã‚Œã°IPã‚‚ï¼‰ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### **MFA ãƒ‡ãƒã‚¤ã‚¹ã®è¨˜æ†¶**

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒã˜ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€MFAãŒãƒã‚¤ãƒ‘ã‚¹ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ã¨åŒã˜ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆIPï¼Ÿï¼‰ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦ã¿ã€MFAä¿è­·ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ã‚’è©¦ã¿ã¦ãã ã•ã„ã€‚

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã®IAMãƒ­ãƒ¼ãƒ«

**IAMãƒ­ãƒ¼ãƒ«**ã«é–¢é€£ã™ã‚‹**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«**ã‚°ãƒ«ãƒ¼ãƒ—ã«**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ **ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚\
ã•ã‚‰ã«ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã¯**ç•°ãªã‚‹IAMãƒ­ãƒ¼ãƒ«**ãŒä»˜ä¸ã•ã‚ŒãŸ**è¤‡æ•°ã®ã‚°ãƒ«ãƒ¼ãƒ—**ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚°ãƒ«ãƒ¼ãƒ—ãŒIAMãƒ­ãƒ¼ãƒ«ã‚’æŒã¤ã‚°ãƒ«ãƒ¼ãƒ—å†…ã«ã‚ã£ã¦ã‚‚ã€ãã®ã‚°ãƒ«ãƒ¼ãƒ—ã®IAMè³‡æ ¼æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ãŒã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ä¿¡é ¼ã•ã‚Œã¦ã„ã‚‹**ï¼ˆãŠã‚ˆã³ãã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ã®è©³ç´°ã‚’çŸ¥ã£ã¦ã„ã‚‹ï¼‰å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã§èªè¨¼ã•ã‚Œã‚‹éš›ã«ï¼ˆ`aws cognito-idp initiate-auth...`ï¼‰ã€**IdTokenã«ç¤ºã•ã‚ŒãŸIAMãƒ­ãƒ¼ãƒ«**ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ã‚‚ã†ä¸€ã¤ã®è¦ä»¶ã¯ã€**ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**ãŒ**ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ­ãƒ¼ãƒ«ã‚’é¸æŠã™ã‚‹å¿…è¦ãŒã‚ã‚‹**ã“ã¨ã‚’ç¤ºã™å¿…è¦ãŒã‚ã‚‹ã“ã¨ã§ã™ã€‚

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹**ãƒ­ãƒ¼ãƒ«**ã¯**`IdToken`å†…**ã«ã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**`aws cognito-identity get-credentials-for-identity`ã®**`--custom-role-arn`**ã‚’ä½¿ç”¨ã—ã¦**ã©ã®ãƒ­ãƒ¼ãƒ«ã®è³‡æ ¼æƒ…å ±ã‚’å–å¾—ã—ãŸã„ã‹ã‚’**é¸æŠã§ãã¾ã™ã€‚\
ã—ã‹ã—ã€**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³**ãŒ**è¨­å®š**ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆ`use default role`ï¼‰ã€IdTokenã‹ã‚‰ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ã¨**ã‚¨ãƒ©ãƒ¼**ãŒç™ºç”Ÿã—ã¾ã™ï¼ˆãã®ãŸã‚ã€å‰è¿°ã®è¨­å®šãŒå¿…è¦ã§ã™ï¼‰ï¼š

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
**User Pool Group** ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã¯ã€**User Pool ã‚’ä¿¡é ¼ã™ã‚‹ Identity Provider** ã«ã‚ˆã£ã¦**ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ï¼ˆIAM ãƒ­ãƒ¼ãƒ«ã®**ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼æƒ…å ±ãŒãã“ã‹ã‚‰å–å¾—ã•ã‚Œã‚‹ãŸã‚**ï¼‰ã€‚
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚
* PRã‚’æå‡ºã—ã¦[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã§ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>
{% endhint %}
