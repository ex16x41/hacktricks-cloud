# Cognito User Pools

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

User pool je direktorijum korisnika u Amazon Cognitu. Sa user pool-om, vaÅ¡i korisnici mogu **da se prijave na vaÅ¡u web ili mobilnu aplikaciju** putem Amazona Cognita, **ili da se federiÅ¡u** putem **treÄ‡e strane** provajdera identiteta (IdP). Bilo da se vaÅ¡i korisnici prijavljuju direktno ili putem treÄ‡e strane, svi Älanovi user pool-a imaju profil u direktorijumu kojem moÅ¾ete pristupiti putem SDK-a.

User pool-ovi pruÅ¾aju:

* Usluge registracije i prijave.
* UgraÄ‘eni, prilagodljivi web UI za prijavu korisnika.
* DruÅ¡tvenu prijavu putem Facebook-a, Google-a, Login with Amazon, i Sign in with Apple, kao i putem SAML i OIDC provajdera identiteta iz vaÅ¡eg user pool-a.
* Upravljanje korisniÄkim direktorijumom i korisniÄkim profilima.
* Bezbednosne funkcije kao Å¡to su viÅ¡efaktorska autentifikacija (MFA), provere za kompromitovane akreditive, zaÅ¡tita od preuzimanja naloga, i verifikacija telefona i email-a.
* PrilagoÄ‘ene radne tokove i migraciju korisnika putem AWS Lambda okidaÄa.

**Izvorni kod** aplikacija obiÄno takoÄ‘e sadrÅ¾i **user pool ID** i **ID klijentske aplikacije**, (i ponekad **tajnu aplikacije**?) koji su potrebni za **prijavu korisnika** u Cognito User Pool.

### Potential attacks

* **Registracija**: Po defaultu, korisnik se moÅ¾e registrovati sam, tako da moÅ¾e kreirati korisnika za sebe.
* **Enumeracija korisnika**: Funkcionalnost registracije moÅ¾e se koristiti za pronalaÅ¾enje korisniÄkih imena koja veÄ‡ postoje. Ove informacije mogu biti korisne za napad brute-force.
* **Brute-force prijava**: U [**Authentication**](cognito-user-pools.md#authentication) sekciji imate sve **metode** koje korisnik ima za **prijavu**, moÅ¾ete pokuÅ¡ati da ih brute-force-ujete **da pronaÄ‘ete validne akreditive**.

### Tools for pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), sada ukljuÄuje `cognito__enum` i `cognito__attack` module koji automatski enumeriÅ¡u sve Cognito resurse u nalogu i oznaÄavaju slabe konfiguracije, korisniÄke atribute koriÅ¡Ä‡ene za kontrolu pristupa, itd., i takoÄ‘e automatski kreiraju korisnike (ukljuÄujuÄ‡i podrÅ¡ku za MFA) i eskalaciju privilegija na osnovu modifikabilnih prilagoÄ‘enih atributa, upotrebljivih akreditiva identiteta, preuzimljivih uloga u id tokenima, itd.\
Za opis funkcija modula pogledajte deo 2 [blog posta](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Za uputstva za instalaciju pogledajte glavnu [Pacu](https://github.com/RhinoSecurityLabs/pacu) stranicu.
```bash
# Run cognito__enum usage to gather all user pools, user pool clients, identity pools, users, etc. visible in the current AWS account
Pacu (new:test) > run cognito__enum

# cognito__attack usage to attempt user creation and all privesc vectors against a given identity pool and user pool client:
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) je CLI alat u pythonu koji implementira razliÄite napade na Cognito ukljuÄujuÄ‡i neÅ¾eljeno kreiranje naloga i oracle naloga. Proverite [ovaj link](https://github.com/padok-team/cognito-scanner) za viÅ¡e informacija.
```bash
# Install
pip install cognito-scanner
# Run
cognito-scanner --help
```
* [CognitoAttributeEnum](https://github.com/punishell/CognitoAttributeEnum): Ovaj skript omoguÄ‡ava enumeraciju validnih atributa za korisnike.
```bash
python cognito-attribute-enu.py -client_id 16f1g98bfuj9i0g3f8be36kkrl
```
## Registracija

User Pools omoguÄ‡ava **podrazumevano** da se **registruju novi korisnici**.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Ako bilo ko moÅ¾e da se registruje

MoÅ¾da Ä‡ete naiÄ‡i na greÅ¡ku koja ukazuje da treba da **obezbedite viÅ¡e detalja** o korisniku:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
MoÅ¾ete pruÅ¾iti potrebne detalje sa JSON-om kao Å¡to je:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
MoÅ¾ete koristiti ovu funkcionalnost takoÄ‘e da **enumeriÅ¡ete postojeÄ‡e korisnike.** Ovo je poruka o greÅ¡ci kada korisnik veÄ‡ postoji sa tim imenom:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ğ¶ÑšÑƒ Ñƒ Ğ¿Ñ€ĞµÑ‚Ñ…Ğ¾Ğ´Ğ½Ğ¾Ñ˜ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¸ ĞºĞ°ĞºĞ¾ **Ğ¿Ñ€Ğ¸Ğ»Ğ°Ğ³Ğ¾Ñ’ĞµĞ½Ğµ Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ğµ Ğ¿Ğ¾Ñ‡Ğ¸ÑšÑƒ ÑĞ° "custom:"**.\
Ğ¢Ğ°ĞºĞ¾Ñ’Ğµ Ğ·Ğ½Ğ°Ñ˜Ñ‚Ğµ Ğ´Ğ° Ğ¿Ñ€Ğ¸Ğ»Ğ¸ĞºĞ¾Ğ¼ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ˜Ğµ **Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ĞºÑ€ĞµĞ¸Ñ€Ğ°Ñ‚Ğ¸ Ğ½Ğ¾Ğ²Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ°Ğ³Ğ¾Ñ’ĞµĞ½Ğµ Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ğµ Ğ·Ğ° ĞºĞ¾Ñ€Ğ¸ÑĞ½Ğ¸ĞºĞ°**. ĞœĞ¾Ğ¶ĞµÑ‚Ğµ ÑĞ°Ğ¼Ğ¾ Ğ´Ğ°Ñ‚Ğ¸ Ğ²Ñ€ĞµĞ´Ğ½Ğ¾ÑÑ‚ **Ğ¿Ğ¾Ğ´Ñ€Ğ°Ğ·ÑƒĞ¼ĞµĞ²Ğ°Ğ½Ğ¸Ğ¼ Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ğ¸Ğ¼Ğ°** (Ñ‡Ğ°Ğº Ğ¸ Ğ°ĞºĞ¾ Ğ½Ğ¸ÑÑƒ Ğ¾Ğ±Ğ°Ğ²ĞµĞ·Ğ½Ğ¸) Ğ¸ **Ğ¿Ñ€Ğ¸Ğ»Ğ°Ğ³Ğ¾Ñ’ĞµĞ½Ğ¸Ğ¼ Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ğ¸Ğ¼Ğ° ĞºĞ¾Ñ˜Ğ¸ ÑÑƒ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸**.
{% endhint %}

Ğ˜Ğ»Ğ¸ ÑĞ°Ğ¼Ğ¾ Ğ´Ğ° Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ°Ñ‚Ğµ Ğ´Ğ° Ğ»Ğ¸ ĞºĞ»Ğ¸Ñ˜ĞµĞ½Ñ‚ Ğ¸Ğ´ Ğ¿Ğ¾ÑÑ‚Ğ¾Ñ˜Ğ¸. ĞĞ²Ğ¾ Ñ˜Ğµ Ğ³Ñ€ĞµÑˆĞºĞ° Ğ°ĞºĞ¾ ĞºĞ»Ğ¸Ñ˜ĞµĞ½Ñ‚-Ğ¸Ğ´ Ğ½Ğµ Ğ¿Ğ¾ÑÑ‚Ğ¾Ñ˜Ğ¸:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### Ako samo administrator moÅ¾e da registruje korisnike

NaÄ‡i Ä‡ete ovu greÅ¡ku i neÄ‡ete moÄ‡i da registrujete ili enumeriÅ¡ete korisnike:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Verifying Registration

Cognito omoguÄ‡ava da **verifikujete novog korisnika verifikovanjem njegovog emaila ili broja telefona**. Stoga, prilikom kreiranja korisnika obiÄno Ä‡e vam biti potrebni barem korisniÄko ime i lozinka, kao i **email i/ili broj telefona**. Samo postavite jedan **koji kontroliÅ¡ete** kako biste primili kod za **verifikaciju vaÅ¡eg** novokreiranog korisniÄkog **naloga** ovako:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
ÄŒak i ako **izgleda da moÅ¾ete koristiti istu email adresu** i broj telefona, kada treba da verifikujete kreiranog korisnika, Cognito Ä‡e se Å¾aliti na koriÅ¡Ä‡enje istih informacija i **neÄ‡e vam dozvoliti da verifikujete nalog**.
{% endhint %}

### Eskalacija privilegija / AÅ¾uriranje atributa

Po defaultu, korisnik moÅ¾e **modifikovati vrednost svojih atributa** sa neÄim poput:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Privesc prilagoÄ‘enih atributa

{% hint style="danger" %}
MoÅ¾ete pronaÄ‡i **prilagoÄ‘ene atribute** koji se koriste (kao Å¡to je `isAdmin`), jer po defaultu moÅ¾ete **promeniti vrednosti svojih atributa**, moÅ¾da Ä‡ete moÄ‡i da **escalate privilegije** menjajuÄ‡i vrednost sami!
{% endhint %}

#### Privesc modifikacije emaila/korisniÄkog imena

MoÅ¾ete koristiti ovo da **modifikujete email i broj telefona** korisnika, ali tada, Äak i ako raÄun ostane kao verifikovan, ti atributi su **postavljeni u status neproveren** (morate ih ponovo verifikovati).

{% hint style="warning" %}
NeÄ‡ete moÄ‡i da se prijavite sa emailom ili brojem telefona dok ih ne verifikujete, ali Ä‡ete moÄ‡i da se **prijavite sa korisniÄkim imenom**.\
Imajte na umu da Äak i ako je email modifikovan i nije verifikovan, pojaviÄ‡e se u ID Token-u unutar **`email`** **polja** i polje **`email_verified`** Ä‡e biti **false**, ali ako aplikacija **ne proverava to, moÅ¾da Ä‡ete moÄ‡i da se pretvarate da ste drugi korisnici**.

Pored toga, imajte na umu da moÅ¾ete staviti bilo Å¡ta unutar **`name`** polja jednostavno menjajuÄ‡i **atribut imena**. Ako aplikacija **proverava** to polje iz nekog razloga **umesto `email`** (ili bilo kog drugog atributa), moÅ¾da Ä‡ete moÄ‡i da **se pretvarate da ste drugi korisnici**.
{% endhint %}

U svakom sluÄaju, ako ste iz nekog razloga promenili svoj email, na primer na novi koji moÅ¾ete da pristupite, moÅ¾ete **potvrditi email sa kodom koji ste primili na tu email adresu**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
Koristite **`phone_number`** umesto **`email`** za promenu/verifikaciju **novog broja telefona**.

{% hint style="info" %}
Administrator takoÄ‘e moÅ¾e omoguÄ‡iti opciju da se **prijavi sa korisniÄkim imenom po izboru korisnika**. Imajte na umu da neÄ‡ete moÄ‡i da promenite ovu vrednost na **bilo koje korisniÄko ime ili preferred\_username koje se veÄ‡ koristi** za impersonaciju drugog korisnika.
{% endhint %}

### Oporavak/Promena lozinke

MoguÄ‡e je oporaviti lozinku samo **znajuÄ‡i korisniÄko ime** (ili email ili telefon se prihvata) i imati pristup jer Ä‡e kod biti poslat tamo:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
Odgovor servera Ä‡e uvek biti pozitivan, kao da korisniÄko ime postoji. Ne moÅ¾ete koristiti ovu metodu za enumeraciju korisnika.
{% endhint %}

Sa kodom moÅ¾ete promeniti lozinku sa:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Da biste promenili lozinku, potrebno je da **znate prethodnu lozinku**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Autentifikacija

Grupa korisnika podrÅ¾ava **razliÄite naÄine autentifikacije**. Ako imate **korisniÄko ime i lozinku**, takoÄ‘e su podrÅ¾ane **razliÄite metode** za prijavu.\
Pored toga, kada je korisnik autentifikovan u grupi, **dodeljuju se 3 vrste tokena**: **ID token**, **Access token** i **Refresh token**.

* [**ID Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): SadrÅ¾i tvrdnje o **identitetu autentifikovanog korisnika**, kao Å¡to su `ime`, `email` i `broj_telefona`. ID token se takoÄ‘e moÅ¾e koristiti za **autentifikaciju korisnika na vaÅ¡im serverskim resursima ili aplikacijama**. Morate **verifikovati** **potpis** ID tokena pre nego Å¡to moÅ¾ete verovati bilo kojim tvrdnjama unutar ID tokena ako ga koristite u spoljnim aplikacijama.
* ID Token je token koji **sadrÅ¾i vrednosti atributa korisnika**, Äak i prilagoÄ‘enih.
* [**Access Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): SadrÅ¾i tvrdnje o autentifikovanom korisniku, listu **grupa korisnika i listu opsega**. Svrha access tokena je da **ovlasti API operacije** u kontekstu korisnika u grupi korisnika. Na primer, moÅ¾ete koristiti access token da **dodelite svom korisniku pristup** za dodavanje, promenu ili brisanje atributa korisnika.
* [**Refresh Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Sa refresh tokenima moÅ¾ete **dobiti nove ID tokene i Access tokene** za korisnika dok **refresh token nije nevaÅ¾eÄ‡i**. Po **defaultu**, refresh token **isteÄe 30 dana nakon** Å¡to se korisnik vaÅ¡e aplikacije prijavi u vaÅ¡u grupu korisnika. Kada kreirate aplikaciju za vaÅ¡u grupu korisnika, moÅ¾ete postaviti isteka refresh tokena aplikacije na **bilo koju vrednost izmeÄ‘u 60 minuta i 10 godina**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Ovo je tok autentifikacije sa servera:

* Aplikacija na serveru poziva **`AdminInitiateAuth` API operaciju** (umesto `InitiateAuth`). Ova operacija zahteva AWS kredencijale sa dozvolama koje ukljuÄuju **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**. Operacija vraÄ‡a potrebne parametre za autentifikaciju.
* Nakon Å¡to aplikacija na serveru ima **parametre za autentifikaciju**, poziva **`AdminRespondToAuthChallenge` API operaciju**. `AdminRespondToAuthChallenge` API operacija uspeva samo kada obezbedite AWS kredencijale.

Ova **metoda NIJE omoguÄ‡ena** po defaultu.

Da biste **prijavili** potrebno je da znate:

* id grupe korisnika
* id klijenta
* korisniÄko ime
* lozinku
* tajnu klijenta (samo ako je aplikacija konfigurisana da koristi tajnu)

{% hint style="info" %}
Da biste bili **u moguÄ‡nosti da se prijavite ovom metodom**, ta aplikacija mora dozvoliti prijavu sa `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Pored toga, da biste izvrÅ¡ili ovu akciju, potrebni su vam kredencijali sa dozvolama **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>Kod za prijavu</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Ova metoda je joÅ¡ jedan jednostavan i **tradicionalni korisniÄki i lozinka autentifikacioni** tok. PreporuÄuje se da se **migrira tradicionalna** autentifikacija **na Cognito** i **preporuÄuje** se da se zatim **onemoguÄ‡i** i **koristi** metoda **ALLOW\_USER\_SRP\_AUTH** umesto (jer ta nikada ne Å¡alje lozinku preko mreÅ¾e).\
Ova **metoda NIJE omoguÄ‡ena** po defaultu.

Glavna **razlika** sa **prethodnom autentifikacionom metodom** unutar koda je da **ne morate znati ID korisniÄkog bazena** i da **ne trebate dodatne dozvole** u Cognito korisniÄkom bazenu.

Da biste **se prijavili**, morate znati:

* client id
* korisniÄko ime
* lozinka
* client secret (samo ako je aplikacija konfigurisana da koristi tajnu)

{% hint style="info" %}
Da biste bili **u moguÄ‡nosti da se prijavite ovom metodom**, ta aplikacija mora dozvoliti prijavu sa ALLOW\_USER\_PASSWORD\_AUTH.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Python kod za prijavu</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Ovaj scenario je sliÄan prethodnom, ali **umesto slanja lozinke** kroz mreÅ¾u za prijavu, **izvodi se autentifikacija izazovom** (tako da lozinka ne prolazi Äak ni enkriptovana kroz mreÅ¾u).\
Ova **metoda je omoguÄ‡ena** po defaultu.

Da biste **prijavili** potrebno je da znate:

* id korisniÄkog bazena
* id klijenta
* korisniÄko ime
* lozinku
* klijentsku tajnu (samo ako je aplikacija konfigurisana da koristi tajnu)

<details>

<summary>Code to login</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Ova **metoda Ä‡e uvek biti validna** (ne moÅ¾e biti onemoguÄ‡ena) ali morate imati validan refresh token.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>Kod za osveÅ¾avanje</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

U ovom sluÄaju, **autentifikacija** Ä‡e se vrÅ¡iti kroz **izvrÅ¡enje lambda funkcije**.

## Dodatna sigurnost

### Napredna sigurnost

Podrazumevano je onemoguÄ‡ena, ali ako je omoguÄ‡ena, Cognito bi mogao da **pronaÄ‘e preuzimanje naloga**. Da biste minimizirali verovatnoÄ‡u, trebali biste se prijaviti sa **mreÅ¾e unutar istog grada, koristeÄ‡i isti korisniÄki agent** (i IP ako je to moguÄ‡e)**.**

### **MFA Zapamti ureÄ‘aj**

Ako se korisnik prijavi sa istog ureÄ‘aja, MFA moÅ¾e biti zaobiÄ‘ena, stoga pokuÅ¡ajte da se prijavite iz istog pregledaÄa sa istim metapodacima (IP?) kako biste pokuÅ¡ali da zaobiÄ‘ete MFA zaÅ¡titu.

## IAM uloge grupa korisniÄkog bazena

MoguÄ‡e je dodati **korisnike u grupe korisniÄkog bazena** koje su povezane sa jednom **IAM ulogom**.\
Å taviÅ¡e, **korisnici** mogu biti dodeljeni **viÅ¡e od 1 grupi sa razliÄitim IAM ulogama**.

Napomena da Äak i ako je grupa unutar grupe sa dodeljenom IAM ulogom, da bi mogli da pristupite IAM kredencijalima te grupe, potrebno je da **KorisniÄki bazen bude poveren od strane Identitetskog bazena** (i da znate detalje tog Identitetskog bazena).

JoÅ¡ jedan zahtev da dobijete **IAM ulogu navedenu u IdToken-u** kada je korisnik autentifikovan u KorisniÄkom bazenu (`aws cognito-idp initiate-auth...`) je da **provajder autentifikacije identiteta** treba da naznaÄi da **uloga mora biti izabrana iz tokena.**

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

**Uloge** kojima korisnik ima pristup su **unutar `IdToken`**, i korisnik moÅ¾e **izabrati koju ulogu Å¾eli za kredencijale** sa **`--custom-role-arn`** iz `aws cognito-identity get-credentials-for-identity`.\
MeÄ‘utim, ako je **podrazumevana opcija** ona **konfigurisana** (`use default role`), i pokuÅ¡ate da pristupite ulozi iz IdToken-a, dobiÄ‡ete **greÅ¡ku** (zato je potrebna prethodna konfiguracija):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
Napomena da uloga dodeljena **grupi korisniÄkih pool-a** mora biti **dostupna provajderu identiteta** koji **veruje korisniÄkom pool-u** (jer Ä‡e **session kredencijali IAM uloge biti dobijeni iz njega**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
