# Cognito User Pools

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

ç”¨æˆ·æ± æ˜¯ Amazon Cognito ä¸­çš„ç”¨æˆ·ç›®å½•ã€‚é€šè¿‡ç”¨æˆ·æ± ï¼Œæ‚¨çš„ç”¨æˆ·å¯ä»¥é€šè¿‡ Amazon Cognito **ç™»å½•æ‚¨çš„ web æˆ–ç§»åŠ¨åº”ç”¨ç¨‹åº**ï¼Œ**æˆ–é€šè¿‡ç¬¬ä¸‰æ–¹**èº«ä»½æä¾›å•† (IdP) è¿›è¡Œè”åˆç™»å½•ã€‚æ— è®ºæ‚¨çš„ç”¨æˆ·æ˜¯ç›´æ¥ç™»å½•è¿˜æ˜¯é€šè¿‡ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œç”¨æˆ·æ± çš„æ‰€æœ‰æˆå‘˜éƒ½æœ‰ä¸€ä¸ªå¯ä»¥é€šè¿‡ SDK è®¿é—®çš„ç›®å½•é…ç½®æ–‡ä»¶ã€‚

ç”¨æˆ·æ± æä¾›ï¼š

* æ³¨å†Œå’Œç™»å½•æœåŠ¡ã€‚
* å†…ç½®çš„ã€å¯å®šåˆ¶çš„ web UI ä»¥ç™»å½•ç”¨æˆ·ã€‚
* é€šè¿‡ Facebookã€Googleã€Login with Amazon å’Œ Sign in with Apple è¿›è¡Œç¤¾äº¤ç™»å½•ï¼Œä»¥åŠé€šè¿‡ SAML å’Œ OIDC èº«ä»½æä¾›å•†ä»æ‚¨çš„ç”¨æˆ·æ± è¿›è¡Œç™»å½•ã€‚
* ç”¨æˆ·ç›®å½•ç®¡ç†å’Œç”¨æˆ·é…ç½®æ–‡ä»¶ã€‚
* å®‰å…¨åŠŸèƒ½ï¼Œå¦‚å¤šå› ç´ è®¤è¯ (MFA)ã€å—æŸå‡­è¯æ£€æŸ¥ã€è´¦æˆ·æ¥ç®¡ä¿æŠ¤ä»¥åŠç”µè¯å’Œç”µå­é‚®ä»¶éªŒè¯ã€‚
* é€šè¿‡ AWS Lambda è§¦å‘å™¨å®šåˆ¶å·¥ä½œæµå’Œç”¨æˆ·è¿ç§»ã€‚

åº”ç”¨ç¨‹åºçš„**æºä»£ç **é€šå¸¸è¿˜åŒ…å«**ç”¨æˆ·æ±  ID**å’Œ**å®¢æˆ·ç«¯åº”ç”¨ç¨‹åº ID**ï¼Œï¼ˆæœ‰æ—¶è¿˜åŒ…æ‹¬**åº”ç”¨ç¨‹åºå¯†é’¥**ï¼Ÿï¼‰è¿™äº›æ˜¯ç”¨æˆ·ç™»å½•åˆ° Cognito ç”¨æˆ·æ± æ‰€éœ€çš„ã€‚

### æ½œåœ¨æ”»å‡»

* **æ³¨å†Œ**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œæ³¨å†Œï¼Œå› æ­¤ä»–å¯ä»¥ä¸ºè‡ªå·±åˆ›å»ºä¸€ä¸ªç”¨æˆ·ã€‚
* **ç”¨æˆ·æšä¸¾**ï¼šæ³¨å†ŒåŠŸèƒ½å¯ç”¨äºæŸ¥æ‰¾å·²å­˜åœ¨çš„ç”¨æˆ·åã€‚æ­¤ä¿¡æ¯å¯¹äºæš´åŠ›ç ´è§£æ”»å‡»éå¸¸æœ‰ç”¨ã€‚
* **ç™»å½•æš´åŠ›ç ´è§£**ï¼šåœ¨[**è®¤è¯**](cognito-user-pools.md#authentication)éƒ¨åˆ†ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ç”¨æˆ·ç™»å½•çš„æ‰€æœ‰**æ–¹æ³•**ï¼Œæ‚¨å¯ä»¥å°è¯•æš´åŠ›ç ´è§£å®ƒä»¬**æ‰¾åˆ°æœ‰æ•ˆå‡­è¯**ã€‚

### æ¸—é€æµ‹è¯•å·¥å…·

* [Pacu](https://github.com/RhinoSecurityLabs/pacu)ï¼ŒAWS åˆ©ç”¨æ¡†æ¶ï¼Œç°åœ¨åŒ…æ‹¬ "cognito\_\_enum" å’Œ "cognito\_\_attack" æ¨¡å—ï¼Œè¿™äº›æ¨¡å—è‡ªåŠ¨æšä¸¾è´¦æˆ·ä¸­çš„æ‰€æœ‰ Cognito èµ„äº§å¹¶æ ‡è®°å¼±é…ç½®ã€ç”¨äºè®¿é—®æ§åˆ¶çš„ç”¨æˆ·å±æ€§ç­‰ï¼Œè¿˜è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼ˆåŒ…æ‹¬ MFA æ”¯æŒï¼‰å’ŒåŸºäºå¯ä¿®æ”¹çš„è‡ªå®šä¹‰å±æ€§ã€å¯ç”¨çš„èº«ä»½æ± å‡­è¯ã€id ä»¤ç‰Œä¸­å¯å‡å®šçš„è§’è‰²ç­‰è¿›è¡Œæƒé™æå‡ã€‚

æœ‰å…³æ¨¡å—åŠŸèƒ½çš„æè¿°ï¼Œè¯·å‚è§[åšå®¢æ–‡ç« ](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)çš„ç¬¬ 2 éƒ¨åˆ†ã€‚æœ‰å…³å®‰è£…è¯´æ˜ï¼Œè¯·å‚è§ [Pacu](https://github.com/RhinoSecurityLabs/pacu) ä¸»é¡µé¢ã€‚

#### ç”¨æ³•

ç¤ºä¾‹ cognito\_\_attack ç”¨æ³•ï¼Œå°è¯•åœ¨ç»™å®šçš„èº«ä»½æ± å’Œç”¨æˆ·æ± å®¢æˆ·ç«¯ä¸Šåˆ›å»ºç”¨æˆ·å¹¶è¿›è¡Œæ‰€æœ‰æƒé™æå‡å‘é‡ï¼š
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
ç¤ºä¾‹ cognito\_\_enum ç”¨æ³•ï¼Œä»¥æ”¶é›†å½“å‰ AWS è´¦æˆ·ä¸­å¯è§çš„æ‰€æœ‰ç”¨æˆ·æ± ã€ç”¨æˆ·æ± å®¢æˆ·ç«¯ã€èº«ä»½æ± ã€ç”¨æˆ·ç­‰ï¼š
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) æ˜¯ä¸€ä¸ªç”¨ Python ç¼–å†™çš„ CLI å·¥å…·ï¼Œå®æ–½åŒ…æ‹¬ä¸å¿…è¦çš„è´¦æˆ·åˆ›å»ºå’Œè´¦æˆ· oracle åœ¨å†…çš„ä¸åŒæ”»å‡»ã€‚

#### å®‰è£…
```bash
$ pip install cognito-scanner
```
#### ä½¿ç”¨æ–¹æ³•
```bash
$ cognito-scanner --help
```
æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ https://github.com/padok-team/cognito-scanner

## Registration

User Pools é»˜è®¤å…è®¸**æ³¨å†Œæ–°ç”¨æˆ·**ã€‚
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### å¦‚æœä»»ä½•äººéƒ½å¯ä»¥æ³¨å†Œ

ä½ å¯èƒ½ä¼šå‘ç°ä¸€ä¸ªé”™è¯¯ï¼Œæç¤ºä½ éœ€è¦**æä¾›æ›´å¤šå…³äºç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯**ï¼š
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
```json
{
  "UserPoolId": "us-east-1_example",
  "ClientId": "1example23456789"
}
```

```json
{
  "UserPoolId": "us-east-1_example",
  "ClientId": "1example23456789"
}
```
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½æ¥**æšä¸¾ç°æœ‰ç”¨æˆ·ã€‚** å½“ä¸€ä¸ªç”¨æˆ·å·²ç»å­˜åœ¨æ—¶ï¼Œä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯æ¶ˆæ¯ï¼š
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
æ³¨æ„åœ¨å‰é¢çš„å‘½ä»¤ä¸­ï¼Œ**è‡ªå®šä¹‰å±æ€§ä»¥ "custom:" å¼€å¤´**ã€‚\
è¿˜è¦çŸ¥é“åœ¨æ³¨å†Œæ—¶ï¼Œ**ä¸èƒ½ä¸ºç”¨æˆ·åˆ›å»ºæ–°çš„è‡ªå®šä¹‰å±æ€§**ã€‚ä½ åªèƒ½ä¸º**é»˜è®¤å±æ€§**ï¼ˆå³ä½¿å®ƒä»¬ä¸æ˜¯å¿…éœ€çš„ï¼‰å’Œ**æŒ‡å®šçš„è‡ªå®šä¹‰å±æ€§**èµ‹å€¼ã€‚
{% endhint %}

æˆ–è€…åªæ˜¯æµ‹è¯•ä¸€ä¸ª client id æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœ client-id ä¸å­˜åœ¨ï¼Œä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### å¦‚æœåªæœ‰ç®¡ç†å‘˜å¯ä»¥æ³¨å†Œç”¨æˆ·

ä½ ä¼šå‘ç°è¿™ä¸ªé”™è¯¯ï¼Œå¹¶ä¸”ä½ å°†æ— æ³•æ³¨å†Œæˆ–æšä¸¾ç”¨æˆ·ï¼š
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Verifying Registration

Cognito å…è®¸é€šè¿‡éªŒè¯ç”µå­é‚®ä»¶æˆ–ç”µè¯å·ç æ¥**éªŒè¯æ–°ç”¨æˆ·**ã€‚å› æ­¤ï¼Œåœ¨åˆ›å»ºç”¨æˆ·æ—¶ï¼Œé€šå¸¸éœ€è¦è‡³å°‘æä¾›ç”¨æˆ·åå’Œå¯†ç ä»¥åŠ**ç”µå­é‚®ä»¶å’Œ/æˆ–ç”µè¯å·ç **ã€‚åªéœ€è®¾ç½®ä¸€ä¸ª**ä½ æ§åˆ¶çš„**ï¼Œè¿™æ ·ä½ å°±ä¼šæ”¶åˆ°ä»£ç æ¥**éªŒè¯ä½ **æ–°åˆ›å»ºçš„ç”¨æˆ·**è´¦æˆ·**ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
å³ä½¿**çœ‹èµ·æ¥ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç”µå­é‚®ä»¶**å’Œç”µè¯å·ç ï¼Œå½“ä½ éœ€è¦éªŒè¯åˆ›å»ºçš„ç”¨æˆ·æ—¶ï¼ŒCognito ä¼šæŠ±æ€¨ä½¿ç”¨ç›¸åŒçš„ä¿¡æ¯å¹¶ä¸”**ä¸ä¼šè®©ä½ éªŒè¯è´¦æˆ·**ã€‚
{% endhint %}

### æƒé™æå‡ / æ›´æ–°å±æ€§

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥**ä¿®æ”¹å…¶å±æ€§çš„å€¼**ï¼Œä¾‹å¦‚ï¼š
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### è‡ªå®šä¹‰å±æ€§æƒé™æå‡

{% hint style="danger" %}
ä½ å¯èƒ½ä¼šå‘ç°ä½¿ç”¨äº†**è‡ªå®šä¹‰å±æ€§**ï¼ˆä¾‹å¦‚ `isAdmin`ï¼‰ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ä½ å¯ä»¥**æ›´æ”¹è‡ªå·±çš„å±æ€§å€¼**ï¼Œä½ å¯èƒ½èƒ½å¤Ÿé€šè¿‡è‡ªå·±æ›´æ”¹å€¼æ¥**æå‡æƒé™**ï¼
{% endhint %}

#### é‚®ç®±/ç”¨æˆ·åä¿®æ”¹æƒé™æå‡

ä½ å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•**ä¿®æ”¹ç”¨æˆ·çš„é‚®ç®±å’Œç”µè¯å·ç **ï¼Œä½†å³ä½¿è´¦æˆ·ä»ç„¶æ˜¯å·²éªŒè¯çŠ¶æ€ï¼Œè¿™äº›å±æ€§ä¹Ÿä¼šè¢«**è®¾ç½®ä¸ºæœªéªŒè¯çŠ¶æ€**ï¼ˆä½ éœ€è¦å†æ¬¡éªŒè¯å®ƒä»¬ï¼‰ã€‚

{% hint style="warning" %}
åœ¨ä½ éªŒè¯ä¹‹å‰ï¼Œä½ **æ— æ³•ä½¿ç”¨é‚®ç®±æˆ–ç”µè¯å·ç ç™»å½•**ï¼Œä½†ä½ å¯ä»¥**ä½¿ç”¨ç”¨æˆ·åç™»å½•**ã€‚\
æ³¨æ„ï¼Œå³ä½¿é‚®ç®±è¢«ä¿®æ”¹ä¸”æœªéªŒè¯ï¼Œå®ƒä»ä¼šå‡ºç°åœ¨ ID Token çš„ **`email`** **å­—æ®µ**ä¸­ï¼Œå¹¶ä¸”å­—æ®µ **`email_verified`** å°†ä¸º**false**ï¼Œä½†å¦‚æœåº”ç”¨**æ²¡æœ‰æ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œä½ å¯èƒ½ä¼šå†’å……å…¶ä»–ç”¨æˆ·**ã€‚

æ­¤å¤–ï¼Œæ³¨æ„ä½ å¯ä»¥é€šè¿‡ä¿®æ”¹**name å±æ€§**åœ¨ **`name`** å­—æ®µä¸­æ”¾å…¥ä»»ä½•å†…å®¹ã€‚å¦‚æœåº”ç”¨**å‡ºäºæŸç§åŸå› æ£€æŸ¥**è¯¥å­—æ®µè€Œä¸æ˜¯**`email`**ï¼ˆæˆ–ä»»ä½•å…¶ä»–å±æ€§ï¼‰ï¼Œä½ å¯èƒ½èƒ½å¤Ÿ**å†’å……å…¶ä»–ç”¨æˆ·**ã€‚
{% endhint %}

æ— è®ºå¦‚ä½•ï¼Œå¦‚æœç”±äºæŸç§åŸå› ä½ å°†é‚®ç®±æ›´æ”¹ä¸ºä¸€ä¸ªä½ å¯ä»¥è®¿é—®çš„æ–°é‚®ç®±ï¼Œä½ å¯ä»¥**ä½¿ç”¨ä½ åœ¨è¯¥é‚®ç®±åœ°å€æ”¶åˆ°çš„ä»£ç ç¡®è®¤é‚®ç®±**ï¼š
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
ä½¿ç”¨ **`phone_number`** è€Œä¸æ˜¯ **`email`** æ¥æ›´æ”¹/éªŒè¯ä¸€ä¸ª**æ–°ç”µè¯å·ç **ã€‚

{% hint style="info" %}
ç®¡ç†å‘˜ä¹Ÿå¯ä»¥å¯ç”¨**ä½¿ç”¨ç”¨æˆ·é¦–é€‰ç”¨æˆ·åç™»å½•**çš„é€‰é¡¹ã€‚è¯·æ³¨æ„ï¼Œæ‚¨å°†æ— æ³•å°†æ­¤å€¼æ›´æ”¹ä¸º**ä»»ä½•å·²è¢«ä½¿ç”¨çš„ç”¨æˆ·åæˆ–é¦–é€‰\_ç”¨æˆ·å**æ¥å†’å……å…¶ä»–ç”¨æˆ·ã€‚
{% endhint %}

### æ¢å¤/æ›´æ”¹å¯†ç 

åªéœ€**çŸ¥é“ç”¨æˆ·å**ï¼ˆæˆ–æ¥å—ç”µå­é‚®ä»¶æˆ–ç”µè¯ï¼‰å¹¶èƒ½å¤Ÿè®¿é—®å®ƒï¼Œå› ä¸ºä»£ç å°†å‘é€åˆ°é‚£é‡Œï¼Œå°±å¯ä»¥æ¢å¤å¯†ç ï¼š
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
æœåŠ¡å™¨çš„å“åº”æ€»æ˜¯ä¼šæ˜¯æ­£é¢çš„ï¼Œå°±åƒç”¨æˆ·åå­˜åœ¨ä¸€æ ·ã€‚ä½ ä¸èƒ½ä½¿ç”¨è¿™ç§æ–¹æ³•æ¥æšä¸¾ç”¨æˆ·
{% endhint %}

ä½¿ç”¨ä»£ç ä½ å¯ä»¥æ›´æ”¹å¯†ç ï¼š
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
è¦æ›´æ”¹å¯†ç ï¼Œæ‚¨éœ€è¦**çŸ¥é“ä¹‹å‰çš„å¯†ç **ï¼š
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## è®¤è¯

ç”¨æˆ·æ± æ”¯æŒ**ä¸åŒçš„è®¤è¯æ–¹å¼**ã€‚å¦‚æœä½ æœ‰**ç”¨æˆ·åå’Œå¯†ç **ï¼Œä¹Ÿæœ‰**ä¸åŒçš„æ–¹æ³•**æ”¯æŒç™»å½•ã€‚\
æ­¤å¤–ï¼Œå½“ç”¨æˆ·åœ¨æ± ä¸­è®¤è¯åï¼Œä¼šæä¾›**3ç§ç±»å‹çš„ä»¤ç‰Œ**ï¼š**ID ä»¤ç‰Œ**ã€**è®¿é—®ä»¤ç‰Œ**å’Œ**åˆ·æ–°ä»¤ç‰Œ**ã€‚

* [**ID ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html)ï¼šå®ƒåŒ…å«å…³äº**å·²è®¤è¯ç”¨æˆ·èº«ä»½**çš„å£°æ˜ï¼Œå¦‚ `name`ã€`email` å’Œ `phone_number`ã€‚ID ä»¤ç‰Œè¿˜å¯ä»¥ç”¨äº**è®¤è¯ç”¨æˆ·åˆ°ä½ çš„èµ„æºæœåŠ¡å™¨æˆ–æœåŠ¡å™¨åº”ç”¨ç¨‹åº**ã€‚å¦‚æœåœ¨å¤–éƒ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ ID ä»¤ç‰Œï¼Œå¿…é¡»**éªŒè¯** ID ä»¤ç‰Œçš„**ç­¾å**ï¼Œæ‰èƒ½ä¿¡ä»» ID ä»¤ç‰Œä¸­çš„ä»»ä½•å£°æ˜ã€‚
* ID ä»¤ç‰Œæ˜¯**åŒ…å«ç”¨æˆ·å±æ€§å€¼**çš„ä»¤ç‰Œï¼Œç”šè‡³åŒ…æ‹¬è‡ªå®šä¹‰å±æ€§ã€‚
* [**è®¿é—®ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html)ï¼šå®ƒåŒ…å«å…³äºå·²è®¤è¯ç”¨æˆ·çš„å£°æ˜ã€**ç”¨æˆ·ç»„åˆ—è¡¨å’ŒèŒƒå›´åˆ—è¡¨**ã€‚è®¿é—®ä»¤ç‰Œçš„ç›®çš„æ˜¯**æˆæƒ API æ“ä½œ**ï¼Œåœ¨ç”¨æˆ·æ± çš„ä¸Šä¸‹æ–‡ä¸­ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨è®¿é—®ä»¤ç‰Œ**æˆäºˆç”¨æˆ·è®¿é—®æƒé™**ï¼Œä»¥æ·»åŠ ã€æ›´æ”¹æˆ–åˆ é™¤ç”¨æˆ·å±æ€§ã€‚
* [**åˆ·æ–°ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html)ï¼šä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼Œå¯ä»¥**è·å–æ–°çš„ ID ä»¤ç‰Œå’Œè®¿é—®ä»¤ç‰Œ**ï¼Œç›´åˆ°**åˆ·æ–°ä»¤ç‰Œå¤±æ•ˆ**ã€‚**é»˜è®¤æƒ…å†µä¸‹**ï¼Œåˆ·æ–°ä»¤ç‰Œåœ¨åº”ç”¨ç¨‹åºç”¨æˆ·ç™»å½•åˆ°ç”¨æˆ·æ± å**30å¤©åè¿‡æœŸ**ã€‚åˆ›å»ºç”¨æˆ·æ± çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œå¯ä»¥å°†åº”ç”¨ç¨‹åºçš„åˆ·æ–°ä»¤ç‰Œè¿‡æœŸæ—¶é—´è®¾ç½®ä¸º**60åˆ†é’Ÿåˆ°10å¹´ä¹‹é—´çš„ä»»ä½•å€¼**ã€‚

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

è¿™æ˜¯æœåŠ¡å™¨ç«¯è®¤è¯æµç¨‹ï¼š

* æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºè°ƒç”¨ **`AdminInitiateAuth` API æ“ä½œ**ï¼ˆè€Œä¸æ˜¯ `InitiateAuth`ï¼‰ã€‚æ­¤æ“ä½œéœ€è¦å…·æœ‰**`cognito-idp:AdminInitiateAuth`**å’Œ**`cognito-idp:AdminRespondToAuthChallenge`**æƒé™çš„ AWS å‡­è¯ã€‚æ“ä½œè¿”å›æ‰€éœ€çš„è®¤è¯å‚æ•°ã€‚
* æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºè·å–**è®¤è¯å‚æ•°**åï¼Œè°ƒç”¨ **`AdminRespondToAuthChallenge` API æ“ä½œ**ã€‚`AdminRespondToAuthChallenge` API æ“ä½œåªæœ‰åœ¨æä¾› AWS å‡­è¯æ—¶æ‰ä¼šæˆåŠŸã€‚

æ­¤**æ–¹æ³•é»˜è®¤æœªå¯ç”¨**ã€‚

è¦**ç™»å½•**ï¼Œä½ **éœ€è¦**çŸ¥é“ï¼š

* ç”¨æˆ·æ±  ID
* å®¢æˆ·ç«¯ ID
* ç”¨æˆ·å
* å¯†ç 
* å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…å½“åº”ç”¨ç¨‹åºé…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶ï¼‰

{% hint style="info" %}
ä¸ºäº†**èƒ½å¤Ÿä½¿ç”¨æ­¤æ–¹æ³•ç™»å½•**ï¼Œåº”ç”¨ç¨‹åºå¿…é¡»å…è®¸ä½¿ç”¨ `ALLOW_ADMIN_USER_PASSWORD_AUTH` ç™»å½•ã€‚\
æ­¤å¤–ï¼Œæ‰§è¡Œæ­¤æ“ä½œéœ€è¦å…·æœ‰**`cognito-idp:AdminInitiateAuth`**å’Œ**`cognito-idp:AdminRespondToAuthChallenge`**æƒé™çš„å‡­è¯ã€‚
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>ç™»å½•ä»£ç </summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

è¿™ç§æ–¹æ³•æ˜¯å¦ä¸€ç§ç®€å•ä¸”**ä¼ ç»Ÿçš„ç”¨æˆ·å’Œå¯†ç è®¤è¯**æµç¨‹ã€‚å»ºè®®**å°†ä¼ ç»Ÿ**çš„è®¤è¯æ–¹æ³•**è¿ç§»åˆ° Cognito**ï¼Œç„¶å**ç¦ç”¨**å®ƒï¼Œå¹¶**ä½¿ç”¨** **ALLOW\_USER\_SRP\_AUTH** æ–¹æ³•ï¼ˆå› ä¸ºè¿™ç§æ–¹æ³•ä»ä¸é€šè¿‡ç½‘ç»œå‘é€å¯†ç ï¼‰ã€‚\
è¿™ç§**æ–¹æ³•é»˜è®¤ä¸å¯ç”¨**ã€‚

ä¸**ä¹‹å‰çš„è®¤è¯æ–¹æ³•**ç›¸æ¯”ï¼Œä¸»è¦**åŒºåˆ«**åœ¨äºä½ **ä¸éœ€è¦çŸ¥é“ç”¨æˆ·æ±  ID**ï¼Œä¹Ÿ**ä¸éœ€è¦é¢å¤–çš„æƒé™**åœ¨ Cognito ç”¨æˆ·æ± ä¸­ã€‚

è¦**ç™»å½•**ï¼Œä½ **éœ€è¦**çŸ¥é“ï¼š

* client id
* username
* password
* client secretï¼ˆä»…å½“åº”ç”¨é…ç½®ä¸ºä½¿ç”¨ secret æ—¶ï¼‰

{% hint style="info" %}
ä¸ºäº†**èƒ½å¤Ÿä½¿ç”¨è¿™ç§æ–¹æ³•ç™»å½•**ï¼Œåº”ç”¨å¿…é¡»å…è®¸ä½¿ç”¨ ALLOW\_USER\_PASSWORD\_AUTH ç™»å½•ã€‚
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Python ä»£ç ç™»å½•</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

è¿™ä¸ªåœºæ™¯ä¸å‰ä¸€ä¸ªç±»ä¼¼ï¼Œä½†**ä¸æ˜¯é€šè¿‡ç½‘ç»œå‘é€å¯†ç **æ¥ç™»å½•ï¼Œè€Œæ˜¯**æ‰§è¡ŒæŒ‘æˆ˜è®¤è¯**ï¼ˆå› æ­¤æ²¡æœ‰å¯†ç å³ä½¿åŠ å¯†ä¹Ÿä¸ä¼šé€šè¿‡ç½‘ç»œä¼ è¾“ï¼‰ã€‚\
è¿™ç§**æ–¹æ³•é»˜è®¤å¯ç”¨**ã€‚

è¦**ç™»å½•**ï¼Œä½ **éœ€è¦**çŸ¥é“ï¼š

* user pool id
* client id
* username
* password
* client secretï¼ˆä»…å½“åº”ç”¨é…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶ï¼‰

<details>

<summary>Code to login</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

è¿™ä¸ª**æ–¹æ³•æ€»æ˜¯æœ‰æ•ˆçš„**ï¼ˆå®ƒä¸èƒ½è¢«ç¦ç”¨ï¼‰ï¼Œä½†ä½ éœ€è¦æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„refresh tokenã€‚
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>åˆ·æ–°ä»£ç </summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**è®¤è¯**å°†é€šè¿‡**æ‰§è¡Œä¸€ä¸ªlambdaå‡½æ•°**æ¥è¿›è¡Œã€‚

## é¢å¤–å®‰å…¨

### é«˜çº§å®‰å…¨

é»˜è®¤æƒ…å†µä¸‹æ˜¯ç¦ç”¨çš„ï¼Œä½†å¦‚æœå¯ç”¨ï¼ŒCognitoå¯ä»¥**å‘ç°è´¦æˆ·æ¥ç®¡**ã€‚ä¸ºäº†å°½é‡å‡å°‘è¿™ç§å¯èƒ½æ€§ï¼Œä½ åº”è¯¥ä»**åŒä¸€åŸå¸‚å†…çš„ç½‘ç»œï¼Œä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·ä»£ç†**ï¼ˆå¦‚æœå¯èƒ½çš„è¯ï¼Œä½¿ç”¨ç›¸åŒçš„IPï¼‰ç™»å½•ã€‚

### **MFA è®°ä½è®¾å¤‡**

å¦‚æœç”¨æˆ·ä»åŒä¸€è®¾å¤‡ç™»å½•ï¼ŒMFAå¯èƒ½ä¼šè¢«ç»•è¿‡ï¼Œå› æ­¤å°è¯•ä»ç›¸åŒçš„æµè§ˆå™¨ä½¿ç”¨ç›¸åŒçš„å…ƒæ•°æ®ï¼ˆIPï¼Ÿï¼‰ç™»å½•ï¼Œä»¥å°è¯•ç»•è¿‡MFAä¿æŠ¤ã€‚

## ç”¨æˆ·æ± ç»„ IAM è§’è‰²

å¯ä»¥å°†**ç”¨æˆ·æ·»åŠ åˆ°ä¸ä¸€ä¸ª**IAMè§’è‰²**ç›¸å…³çš„**ç”¨æˆ·æ± ç»„**ä¸­ã€‚\
æ­¤å¤–ï¼Œ**ç”¨æˆ·**å¯ä»¥è¢«åˆ†é…åˆ°**å¤šä¸ªé™„æœ‰ä¸åŒIAMè§’è‰²çš„ç»„**ä¸­ã€‚

è¯·æ³¨æ„ï¼Œå³ä½¿ä¸€ä¸ªç»„åœ¨ä¸€ä¸ªé™„æœ‰IAMè§’è‰²çš„ç»„å†…ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—®è¯¥ç»„çš„IAMå‡­è¯ï¼Œéœ€è¦**ç”¨æˆ·æ± è¢«èº«ä»½æ± ä¿¡ä»»**ï¼ˆå¹¶çŸ¥é“è¯¥èº«ä»½æ± çš„è¯¦ç»†ä¿¡æ¯ï¼‰ã€‚

å½“ç”¨æˆ·åœ¨ç”¨æˆ·æ± ä¸­è®¤è¯æ—¶ï¼ˆ`aws cognito-idp initiate-auth...`ï¼‰ï¼Œè¦è·å–**IdTokenä¸­æŒ‡ç¤ºçš„IAMè§’è‰²**ï¼Œéœ€è¦**èº«ä»½æä¾›è€…è®¤è¯æä¾›è€…**æŒ‡ç¤º**è§’è‰²å¿…é¡»ä»ä»¤ç‰Œä¸­é€‰æ‹©**ã€‚

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

ç”¨æˆ·å¯ä»¥è®¿é—®çš„**è§’è‰²**åœ¨**`IdToken`**ä¸­ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨**`--custom-role-arn`**ä»`aws cognito-identity get-credentials-for-identity`ä¸­**é€‰æ‹©ä»–æƒ³è¦çš„å‡­è¯è§’è‰²**ã€‚\
ç„¶è€Œï¼Œå¦‚æœ**é»˜è®¤é€‰é¡¹**æ˜¯**é…ç½®çš„**ï¼ˆ`ä½¿ç”¨é»˜è®¤è§’è‰²`ï¼‰ï¼Œå¹¶ä¸”ä½ å°è¯•ä»IdTokenè®¿é—®ä¸€ä¸ªè§’è‰²ï¼Œä½ å°†ä¼šå¾—åˆ°**é”™è¯¯**ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦ä¹‹å‰çš„é…ç½®ï¼‰ï¼š

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œåˆ†é…ç»™ **User Pool Group** çš„è§’è‰²éœ€è¦è¢« **ä¿¡ä»» User Pool çš„ Identity Provider** **è®¿é—®**ï¼ˆå› ä¸º IAM è§’è‰²çš„ **ä¼šè¯å‡­è¯å°†ä»ä¸­è·å–**ï¼‰ã€‚
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
