# Cognito User Pools

{% hint style="success" %}
Naucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

## Podstawowe informacje

Pula u偶ytkownik贸w to katalog u偶ytkownik贸w w Amazon Cognito. Dziki puli u偶ytkownik贸w, Twoi u偶ytkownicy mog **logowa si do Twojej aplikacji webowej lub mobilnej** za porednictwem Amazon Cognito, **lub federowa** si przez **zewntrznego** dostawc to偶samoci (IdP). Niezale偶nie od tego, czy u偶ytkownicy loguj si bezporednio, czy przez stron trzeci, wszyscy czonkowie puli u偶ytkownik贸w maj profil w katalogu, do kt贸rego mo偶na uzyska dostp za pomoc SDK.

Pule u偶ytkownik贸w oferuj:

* Usugi rejestracji i logowania.
* Wbudowany, konfigurowalny interfejs webowy do logowania u偶ytkownik贸w.
* Logowanie spoecznociowe z Facebook, Google, Login with Amazon i Sign in with Apple oraz przez dostawc贸w to偶samoci SAML i OIDC z Twojej puli u偶ytkownik贸w.
* Zarzdzanie katalogiem u偶ytkownik贸w i profilami u偶ytkownik贸w.
* Funkcje bezpieczestwa, takie jak uwierzytelnianie wieloskadnikowe (MFA), sprawdzanie skompromitowanych powiadcze, ochrona przed przejciem konta oraz weryfikacja telefonu i e-maila.
* Dostosowane przepywy pracy i migracja u偶ytkownik贸w za pomoc wyzwalaczy AWS Lambda.

**Kod 藕r贸dowy** aplikacji zazwyczaj zawiera r贸wnie偶 **ID puli u偶ytkownik贸w** i **ID aplikacji klienckiej** (a czasami **sekret aplikacji**?), kt贸re s potrzebne do **logowania u偶ytkownika** do puli u偶ytkownik贸w Cognito.

### Potencjalne ataki

* **Rejestracja**: Domylnie u偶ytkownik mo偶e zarejestrowa si samodzielnie, wic mo偶e stworzy konto dla siebie.
* **Enumeracja u偶ytkownik贸w**: Funkcjonalno rejestracji mo偶e by u偶yta do znalezienia nazw u偶ytkownik贸w, kt贸re ju偶 istniej. Ta informacja mo偶e by przydatna do ataku brute-force.
* **Brute-force logowania**: W sekcji [**Authentication**](cognito-user-pools.md#authentication) znajdziesz wszystkie **metody**, kt贸re u偶ytkownik ma do **logowania**, mo偶esz spr贸bowa brute-force, aby **znale藕 prawidowe powiadczenia**.

### Narzdzia do pentestingu

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), framework do eksploatacji AWS, teraz zawiera moduy "cognito\_\_enum" i "cognito\_\_attack", kt贸re automatyzuj enumeracj wszystkich zasob贸w Cognito w koncie i oznaczaj sabe konfiguracje, atrybuty u偶ytkownik贸w u偶ywane do kontroli dostpu itp., a tak偶e automatyzuj tworzenie u偶ytkownik贸w (w tym wsparcie MFA) i eskalacj uprawnie na podstawie modyfikowalnych atrybut贸w niestandardowych, u偶ywalnych powiadcze puli to偶samoci, r贸l mo偶liwych do przyjcia w tokenach id itp.

Opis funkcji modu贸w znajdziesz w czci 2 [postu na blogu](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Instrukcje instalacji znajdziesz na g贸wnej stronie [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### U偶ycie

Przykadowe u偶ycie cognito\_\_attack do pr贸by tworzenia u偶ytkownik贸w i wszystkich wektor贸w privesc przeciwko danej puli to偶samoci i klientowi puli u偶ytkownik贸w:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Przykad u偶ycia cognito\_\_enum do zebrania wszystkich pul u偶ytkownik贸w, klient贸w pul u偶ytkownik贸w, pul to偶samoci, u偶ytkownik贸w itp. widocznych w bie偶cym koncie AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) jest narzdziem CLI w pythonie, kt贸re implementuje r贸偶ne ataki na Cognito, w tym niechciane tworzenie kont i konto oracle.

#### Instalacja
```bash
$ pip install cognito-scanner
```
#### U偶ycie
```bash
$ cognito-scanner --help
```
Aby uzyska wicej informacji, sprawd藕 https://github.com/padok-team/cognito-scanner

## Rejestracja

User Pools domylnie pozwala na **rejestracj nowych u偶ytkownik贸w**.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Jeli ka偶dy mo偶e si zarejestrowa

Mo偶esz napotka bd informujcy, 偶e musisz **poda wicej szczeg贸贸w** dotyczcych u偶ytkownika:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
Mo偶esz poda potrzebne szczeg贸y za pomoc JSON, takiego jak:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
Mo偶esz u偶y tej funkcjonalnoci r贸wnie偶 do **enumeracji istniejcych u偶ytkownik贸w.** To jest komunikat o bdzie, gdy u偶ytkownik o tej nazwie ju偶 istnieje:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Zwr贸 uwag w poprzednim poleceniu, jak **niestandardowe atrybuty zaczynaj si od "custom:"**.\
Wiedz r贸wnie偶, 偶e podczas rejestracji **nie mo偶esz tworzy nowych niestandardowych atrybut贸w dla u偶ytkownika**. Mo偶esz jedynie przypisywa wartoci do **domylnych atrybut贸w** (nawet jeli nie s wymagane) oraz **okrelonych niestandardowych atrybut贸w**.
{% endhint %}

Lub po prostu, aby sprawdzi, czy istnieje client id. To jest bd, jeli client-id nie istnieje:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### Jeli tylko administrator mo偶e rejestrowa u偶ytkownik贸w

Znajdziesz ten bd i nie bdziesz w stanie zarejestrowa ani wyliczy u偶ytkownik贸w:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Weryfikacja Rejestracji

Cognito pozwala na **weryfikacj nowego u偶ytkownika poprzez weryfikacj jego adresu email lub numeru telefonu**. Dlatego te偶, podczas tworzenia u偶ytkownika zazwyczaj wymagane bd przynajmniej nazwa u偶ytkownika i haso oraz **adres email i/lub numer telefonu**. Ustaw jeden, **kt贸ry kontrolujesz**, aby otrzyma kod do **weryfikacji swojego** nowo utworzonego **konta u偶ytkownika** w ten spos贸b:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
Nawet jeli **wyglda na to, 偶e mo偶esz u偶y tego samego e-maila** i numeru telefonu, gdy bdziesz musia zweryfikowa utworzonego u偶ytkownika, Cognito bdzie narzeka na u偶ycie tych samych informacji i **nie pozwoli ci zweryfikowa konta**.
{% endhint %}

### Eskalacja uprawnie / Aktualizacja atrybut贸w

Domylnie u偶ytkownik mo偶e **modyfikowa warto swoich atrybut贸w** za pomoc czego takiego jak:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Custom attribute privesc

{% hint style="danger" %}
Mo偶esz znale藕 **niestandardowe atrybuty** u偶ywane (takie jak `isAdmin`), poniewa偶 domylnie mo偶esz **zmienia wartoci swoich wasnych atrybut贸w**, mo偶esz by w stanie **eskalowa uprawnienia** zmieniajc warto samodzielnie!
{% endhint %}

#### Email/username modification privesc

Mo偶esz u偶y tego do **modyfikacji adresu email i numeru telefonu** u偶ytkownika, ale wtedy, nawet jeli konto pozostaje zweryfikowane, te atrybuty s **ustawione jako niezweryfikowane** (musisz je ponownie zweryfikowa).

{% hint style="warning" %}
**Nie bdziesz w stanie zalogowa si za pomoc emaila lub numeru telefonu** dop贸ki ich nie zweryfikujesz, ale bdziesz **m贸g zalogowa si za pomoc nazwy u偶ytkownika**.\
Zauwa偶, 偶e nawet jeli email zosta zmodyfikowany i niezweryfikowany, pojawi si w Tokenie ID w polu **`email`** i pole **`email_verified`** bdzie miao warto **false**, ale jeli aplikacja **tego nie sprawdza, mo偶esz podszy si pod innych u偶ytkownik贸w**.

Ponadto, zauwa偶, 偶e mo偶esz umieci cokolwiek w polu **`name`** po prostu modyfikujc **atrybut name**. Jeli aplikacja **sprawdza** **to** pole z jakiego powodu **zamiast `email`** (lub jakiegokolwiek innego atrybutu), mo偶esz by w stanie **podszy si pod innych u偶ytkownik贸w**.
{% endhint %}

W ka偶dym razie, jeli z jakiego powodu zmienie sw贸j email na nowy, do kt贸rego masz dostp, mo偶esz **potwierdzi email za pomoc kodu, kt贸ry otrzymae na ten adres email**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
U偶yj **`phone_number`** zamiast **`email`** do zmiany/weryfikacji **nowego numeru telefonu**.

{% hint style="info" %}
Administrator mo偶e r贸wnie偶 wczy opcj **logowania si za pomoc preferowanej nazwy u偶ytkownika**. Zauwa偶, 偶e nie bdziesz m贸g zmieni tej wartoci na **dowoln nazw u偶ytkownika lub preferred\_username, kt贸ra jest ju偶 u偶ywana**, aby podszy si pod innego u偶ytkownika.
{% endhint %}

### Odzyskiwanie/Zmiana Hasa

Mo偶liwe jest odzyskanie hasa, majc tylko **nazw u偶ytkownika** (lub akceptowany jest email lub telefon) i majc do niego dostp, poniewa偶 kod zostanie tam wysany:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
Odpowied藕 serwera zawsze bdzie pozytywna, jakby nazwa u偶ytkownika istniaa. Nie mo偶esz u偶y tej metody do enumeracji u偶ytkownik贸w
{% endhint %}

Za pomoc kodu mo偶esz zmieni haso za pomoc:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Aby zmieni haso, musisz **zna poprzednie haso**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Autoryzacja

Pula u偶ytkownik贸w obsuguje **r贸偶ne sposoby autoryzacji**. Jeli masz **nazw u偶ytkownika i haso**, istniej r贸wnie偶 **r贸偶ne metody** logowania.\
Ponadto, gdy u偶ytkownik jest uwierzytelniony w Puli, **wydawane s 3 rodzaje token贸w**: **ID Token**, **Access token** i **Refresh token**.

* [**ID Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Zawiera roszczenia dotyczce **to偶samoci uwierzytelnionego u偶ytkownika**, takie jak `name`, `email` i `phone_number`. ID token mo偶e by r贸wnie偶 u偶ywany do **uwierzytelniania u偶ytkownik贸w na serwerach zasob贸w lub aplikacjach serwerowych**. Musisz **zweryfikowa** **podpis** ID tokena, zanim zaufasz jakimkolwiek roszczeniom zawartym w ID tokenie, jeli u偶ywasz go w aplikacjach zewntrznych.
* ID Token to token, kt贸ry **zawiera wartoci atrybut贸w u偶ytkownika**, nawet te niestandardowe.
* [**Access Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Zawiera roszczenia dotyczce uwierzytelnionego u偶ytkownika, list **grup u偶ytkownika i list zakres贸w**. Celem access tokena jest **autoryzacja operacji API** w kontekcie u偶ytkownika w puli u偶ytkownik贸w. Na przykad, mo偶esz u偶y access tokena, aby **przyzna u偶ytkownikowi dostp** do dodawania, zmieniania lub usuwania atrybut贸w u偶ytkownika.
* [**Refresh Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Dziki refresh tokenom mo偶esz **uzyska nowe ID Tokeny i Access Tokeny** dla u偶ytkownika, dop贸ki **refresh token nie stanie si niewa偶ny**. **Domylnie**, refresh token **wygasa 30 dni po** zalogowaniu si u偶ytkownika do puli u偶ytkownik贸w. Tworzc aplikacj dla swojej puli u偶ytkownik贸w, mo偶esz ustawi czas wyganicia refresh tokena na **dowoln warto midzy 60 minutami a 10 latami**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

To jest przepyw autoryzacji po stronie serwera:

* Aplikacja po stronie serwera wywouje operacj API **`AdminInitiateAuth`** (zamiast `InitiateAuth`). Ta operacja wymaga powiadcze AWS z uprawnieniami obejmujcymi **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**. Operacja zwraca wymagane parametry autoryzacji.
* Po uzyskaniu przez aplikacj po stronie serwera **parametr贸w autoryzacji**, wywouje ona operacj API **`AdminRespondToAuthChallenge`**. Operacja API `AdminRespondToAuthChallenge` koczy si sukcesem tylko wtedy, gdy dostarczysz powiadczenia AWS.

Ta **metoda NIE jest domylnie wczona**.

Aby **zalogowa si**, **musisz zna**:

* id puli u偶ytkownik贸w
* id klienta
* nazw u偶ytkownika
* haso
* sekret klienta (tylko jeli aplikacja jest skonfigurowana do u偶ywania sekretu)

{% hint style="info" %}
Aby **m贸c zalogowa si t metod**, aplikacja musi umo偶liwia logowanie za pomoc `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Ponadto, aby wykona t akcj, potrzebujesz powiadcze z uprawnieniami **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>Kod do logowania</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Ta metoda to kolejny prosty i **tradycyjny przepyw uwierzytelniania u偶ytkownika i hasa**. Zaleca si **migracj tradycyjnej** metody uwierzytelniania **do Cognito** i **nastpnie jej wyczenie** oraz **u偶ycie** metody **ALLOW\_USER\_SRP\_AUTH** (poniewa偶 ta nigdy nie wysya hasa przez sie).\
Ta **metoda NIE jest domylnie wczona**.

G贸wna **r贸偶nica** w stosunku do **poprzedniej metody uwierzytelniania** w kodzie polega na tym, 偶e **nie musisz zna ID puli u偶ytkownik贸w** i **nie potrzebujesz dodatkowych uprawnie** w Cognito User Pool.

Aby **zalogowa si**, **musisz zna**:

* client id
* username
* password
* client secret (tylko jeli aplikacja jest skonfigurowana do u偶ywania sekretu)

{% hint style="info" %}
Aby **m贸c zalogowa si t metod**, aplikacja musi pozwala na logowanie z ALLOW\_USER\_PASSWORD\_AUTH.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Python code to Login</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Ten scenariusz jest podobny do poprzedniego, ale **zamiast wysyania hasa** przez sie do logowania, **wykonywane jest uwierzytelnianie wyzwania** (wic haso nie jest przesyane nawet zaszyfrowane przez sie).\
Ta **metoda jest domylnie wczona**.

Aby **zalogowa si**, **musisz zna**:

* user pool id
* client id
* username
* password
* client secret (tylko jeli aplikacja jest skonfigurowana do u偶ywania sekretu)

<details>

<summary>Kod do logowania</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Ta **metoda zawsze bdzie wa偶na** (nie mo偶na jej wyczy), ale musisz mie wa偶ny refresh token.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>Kod do odwie偶enia</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

W tym przypadku **uwierzytelnianie** bdzie przeprowadzane poprzez **wykonanie funkcji lambda**.

## Dodatkowe zabezpieczenia

### Zaawansowane zabezpieczenia

Domylnie jest wyczone, ale jeli jest wczone, Cognito mo偶e by w stanie **wykry przejcia konta**. Aby zminimalizowa prawdopodobiestwo, powiniene logowa si z **sieci w tym samym miecie, u偶ywajc tego samego agenta u偶ytkownika** (i jeli to mo偶liwe, tego samego IP).

### **MFA Zapamitaj urzdzenie**

Jeli u偶ytkownik loguje si z tego samego urzdzenia, MFA mo偶e zosta pominite, dlatego spr贸buj zalogowa si z tej samej przegldarki z tymi samymi metadanymi (IP?), aby spr贸bowa obej ochron MFA.

## Role IAM grup puli u偶ytkownik贸w

Mo偶liwe jest dodanie **u偶ytkownik贸w do grup puli u偶ytkownik贸w** powizanych z jedn **rol IAM**.\
Ponadto, **u偶ytkownicy** mog by przypisani do **wicej ni偶 jednej grupy z r贸偶nymi rolami IAM**.

Nale偶y zauwa偶y, 偶e nawet jeli grupa jest wewntrz grupy z przypisan rol IAM, aby m贸c uzyska dostp do powiadcze IAM tej grupy, konieczne jest, aby **pula u偶ytkownik贸w bya zaufana przez pul to偶samoci** (i znaa szczeg贸y tej puli to偶samoci).

Innym wymogiem, aby uzyska **rol IAM wskazan w IdToken** podczas uwierzytelniania u偶ytkownika w puli u偶ytkownik贸w (`aws cognito-idp initiate-auth...`), jest to, 偶e **dostawca uwierzytelniania dostawcy to偶samoci** musi wskaza, 偶e **rola musi by wybrana z tokenu.**

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

**Role**, do kt贸rych u偶ytkownik ma dostp, s **wewntrz `IdToken`**, a u偶ytkownik mo偶e **wybra, kt贸r rol chciaby uzyska powiadczenia** za pomoc **`--custom-role-arn`** z `aws cognito-identity get-credentials-for-identity`.\
Jednak偶e, jeli **domylna opcja** jest **skonfigurowana** (`use default role`), i spr贸bujesz uzyska dostp do roli z IdToken, otrzymasz **bd** (dlatego potrzebna jest wczeniejsza konfiguracja):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
Zauwa偶, 偶e rola przypisana do **User Pool Group** musi by **dostpna przez Identity Provider**, kt贸ry **ufa User Pool** (poniewa偶 **powiadczenia sesji IAM role bd z niego uzyskiwane**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
Ucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytori贸w na githubie**.

</details>
{% endhint %}
