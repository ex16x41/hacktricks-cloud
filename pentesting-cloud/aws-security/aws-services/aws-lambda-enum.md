# AWS - Lambda Enum

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repo's.

</details>
{% endhint %}

## Lambda

Amazon Web Services (AWS) Lambda word beskryf as 'n **rekenaardiens** wat die uitvoering van kode moontlik maak sonder die noodsaaklikheid vir bediener voorsiening of bestuur. Dit word gekenmerk deur sy vermo√´ om **outomaties hulpbron toewysing te hanteer** wat nodig is vir kode uitvoering, wat funksies soos ho√´ beskikbaarheid, skaalbaarheid, en sekuriteit verseker. 'n Beduidende aspek van Lambda is sy prysmodel, waar **koste slegs gebaseer is op die rekenaartyd wat gebruik word**, wat die behoefte aan aanvanklike beleggings of langtermyn verpligtinge uitskakel.

Om 'n lambda aan te roep is dit moontlik om dit so **gereeld as wat jy wil** aan te roep (met Cloudwatch), 'n **URL** eindpunt bloot te stel en dit aan te roep, dit via **API Gateway** aan te roep of selfs gebaseer op **gebeurtenisse** soos **veranderings** aan data in 'n **S3** emmer of opdaterings aan 'n **DynamoDB** tabel.

Die **kode** van 'n lambda word gestoor in **`/var/task`**.

### Lambda Aliases Gewigte

'n Lambda kan **verskeie weergawes** h√™.\
En dit kan **meer as 1** weergawe h√™ wat blootgestel word via **aliases**. Die **gewigte** van **elke** van die **weergawes** wat binne 'n alias blootgestel word, sal bepaal **watter alias die aanroep ontvang** (dit kan byvoorbeeld 90%-10% wees).\
As die kode van **een** van die aliases **kwesbaar** is, kan jy **versoeke stuur totdat die kwesbare** weergawes die uitbuiting ontvang.

![](<../../../.gitbook/assets/image (223).png>)

### Hulpbronbeleide

Lambda hulpbronbeleide laat toe om **toegang te gee aan ander dienste/rekeninge om** byvoorbeeld die lambda aan te roep.\
Byvoorbeeld, dit is die beleid om **enigiemand toe te laat om toegang te h√™ tot 'n lambda wat via URL blootgestel word**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

Of dit om 'n API Gateway toe te laat om dit aan te roep:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda Databasis Proxies

Wanneer daar **honderde** **gelyktydige lambda versoeke** is, as elkeen van hulle moet **koppel en 'n verbinding met 'n databasis sluit**, gaan dit net nie werk nie (lambdas is toestandloos, kan nie verbindings oop hou nie).\
Dan, as jou **Lambda funksies met RDS Proxy in plaas van jou databasis instansie interaksie het**. Dit hanteer die verbinding poel wat nodig is vir die skaal van baie gelyktydige verbindings wat deur gelyktydige Lambda funksies geskep word. Dit laat jou Lambda toepassings toe om **bestaande verbindings te hergebruik**, eerder as om nuwe verbindings vir elke funksie aanroep te skep.

### Lambda EFS L√™erstelsels

Om data te bewaar en selfs te deel **kan Lambdas toegang h√™ tot EFS en dit monteer**, sodat Lambda in staat sal wees om daarvan te lees en te skryf.

### Lambda L√™ers

'n Lambda _laag_ is 'n .zip-l√™er argief wat **bykomende kode** of ander inhoud kan bevat. 'n Laag kan biblioteke, 'n [pasgemaakte runtime](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), data, of konfigurasiel√™ers bevat.

Dit is moontlik om tot **vyf lae per funksie** in te sluit. Wanneer jy 'n laag in 'n funksie insluit, word die **inhoud na die `/opt`** gids in die uitvoering omgewing onttrek.

Deur **standaard**, is die **lae** wat jy skep **privaat** vir jou AWS rekening. Jy kan kies om **'n laag met ander rekeninge te deel of om** die laag **publiek te maak**. As jou funksies 'n laag gebruik wat deur 'n ander rekening gepubliseer is, kan jou funksies **aanhou om die laag weergawe te gebruik nadat dit verwyder is, of nadat jou toestemming om toegang tot die laag te h√™ herroep is**. Jy kan egter nie 'n nuwe funksie skep of funksies opdateer wat 'n verwyderde laag weergawe gebruik nie.

Funksies wat as 'n houerbeeld ontplooi is, gebruik nie lae nie. In plaas daarvan, pak jy jou voorkeur runtime, biblioteke, en ander afhanklikhede in die houerbeeld wanneer jy die beeld bou.

### Lambda Uitbreidings

Lambda uitbreidings verbeter funksies deur integrasie met verskeie **monitering, waarneembaarheid, sekuriteit, en bestuur gereedskap**. Hierdie uitbreidings, bygevoeg via [.zip argiewe met Lambda lae](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) of ingesluit in [houerbeeld ontplooiings](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), werk in twee modusse: **intern** en **ekstern**.

* **Interne uitbreidings** smelt saam met die runtime proses, manipuleer sy opstart met behulp van **taal-spesifieke omgewing veranderlikes** en **omslag skrifte**. Hierdie aanpassing geld vir 'n reeks runtimes, insluitend **Java Correto 8 en 11, Node.js 10 en 12, en .NET Core 3.1**.
* **Eksterne uitbreidings** werk as afsonderlike prosesse, handhaaf operasie belyning met die Lambda funksie se lewensiklus. Hulle is versoenbaar met verskeie runtimes soos **Node.js 10 en 12, Python 3.7 en 3.8, Ruby 2.5 en 2.7, Java Corretto 8 en 11, .NET Core 3.1**, en **pasgemaakte runtimes**.

### Enumerasie
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Roep 'n lambda aan

#### Manueel
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### Via blootgestelde URL

As die Lambda-funksie 'n blootgestelde URL het, kan ons dit direk aanroep en die reaksie ondersoek. Dit kan ons help om sensitiewe inligting te lek of die funksie se gedrag te verstaan.

#### Via AWS CLI

Ons kan die AWS CLI gebruik om Lambda-funksies te lys en inligting oor hulle te kry. Hier is 'n voorbeeldopdrag:

```bash
aws lambda list-functions --region <region>
```

#### Via IAM Roles

As ons toegang het tot 'n IAM rol wat toestemming het om Lambda-funksies te lys, kan ons die volgende opdrag gebruik:

```bash
aws lambda list-functions --region <region> --profile <profile>
```

#### Via CloudFormation

As die Lambda-funksie deur CloudFormation geskep is, kan ons die CloudFormation sjablone nagaan om inligting oor die funksie te kry.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Roep Lambda-funksie via URL

Nou is dit tyd om moontlike lambda-funksies te vind om uit te voer:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (262).png>)

'n Lambda-funksie genaamd "Level6" is beskikbaar. Kom ons vind uit hoe om dit aan te roep:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (102).png>)

Nou, dat jy die naam en die ID ken, kan jy die Naam kry:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (237).png>)

En uiteindelik roep die funksie aan deur toegang te verkry (let op dat die ID, Naam en funksie-naam in die URL verskyn): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Ander Snellers

Daar is baie ander bronne wat 'n lambda kan sneller

<figure><img src="../../../.gitbook/assets/image (167).png" alt=""><figcaption></figcaption></figure>

### Privesc

Op die volgende bladsy kan jy kyk hoe om **Lambda-permissies te misbruik om voorregte te verhoog**:

{% content-ref url="../aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Onauthentiseerde Toegang

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Post Eksploitasie

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Volharding

{% content-ref url="../aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Verwysings

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
