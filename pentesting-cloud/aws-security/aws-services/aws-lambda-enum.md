# AWS - Lambda Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda

Η υπηρεσία Amazon Web Services (AWS) Lambda περιγράφεται ως μια **υπηρεσία υπολογισμού** που επιτρέπει την εκτέλεση κώδικα χωρίς την ανάγκη παροχής ή διαχείρισης διακομιστή. Χαρακτηρίζεται από την ικανότητά της να **διαχειρίζεται αυτόματα την κατανομή πόρων** που απαιτούνται για την εκτέλεση του κώδικα, εξασφαλίζοντας χαρακτηριστικά όπως η υψηλή διαθεσιμότητα, η κλιμάκωση και η ασφάλεια. Ένας σημαντικός τομέας της Lambda είναι το μοντέλο τιμολόγησής της, όπου **οι χρεώσεις βασίζονται αποκλειστικά στον χρόνο υπολογισμού που χρησιμοποιείται**, εξαλείφοντας την ανάγκη για αρχικές επενδύσεις ή μακροχρόνιες υποχρεώσεις.

Για να καλέσετε μια lambda, είναι δυνατόν να την καλέσετε **τόσο συχνά όσο θέλετε** (με το Cloudwatch), να **εκθέσετε** ένα **URL** endpoint και να την καλέσετε, να την καλέσετε μέσω **API Gateway** ή ακόμη και με βάση **γεγονότα** όπως **αλλαγές** στα δεδομένα σε έναν **S3** κάδο ή ενημερώσεις σε έναν **DynamoDB** πίνακα.

Ο **κώδικας** μιας lambda αποθηκεύεται στο **`/var/task`**.

### Lambda Aliases Weights

Μια Lambda μπορεί να έχει **πολλές εκδόσεις**.\
Και μπορεί να έχει **περισσότερες από 1** έκδοση εκτεθειμένη μέσω **ψευδωνύμων**. Τα **βάρη** των **καθένα** από τις **εκδόσεις** που εκτίθενται μέσα σε ένα ψευδώνυμο θα αποφασίσουν **ποιο ψευδώνυμο θα λάβει την κλήση** (μπορεί να είναι 90%-10% για παράδειγμα).\
Εάν ο κώδικας **ενός** από τα ψευδώνυμα είναι **ευάλωτος**, μπορείτε να στείλετε **αιτήματα μέχρι να λάβει η ευάλωτη** έκδοση την εκμετάλλευση.

![](<../../../.gitbook/assets/image (223).png>)

### Resource Policies

Οι πολιτικές πόρων Lambda επιτρέπουν να **δώσουν πρόσβαση σε άλλες υπηρεσίες/λογαριασμούς για να καλέσουν** τη lambda για παράδειγμα.\
Για παράδειγμα, αυτή είναι η πολιτική για να επιτρέψει **σε οποιονδήποτε να έχει πρόσβαση σε μια lambda που εκτίθεται μέσω URL**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

Ή αυτή για να επιτρέψει σε ένα API Gateway να την καλέσει:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda Database Proxies

Όταν υπάρχουν **εκατοντάδες** **ταυτόχρονες αιτήσεις lambda**, αν η καθεμία από αυτές χρειάζεται να **συνδεθεί και να κλείσει μια σύνδεση σε μια βάση δεδομένων**, απλά δεν θα λειτουργήσει (οι lambdas είναι χωρίς κατάσταση, δεν μπορούν να διατηρήσουν ανοιχτές συνδέσεις).\
Έτσι, αν οι **λειτουργίες Lambda σας αλληλεπιδρούν με το RDS Proxy αντί** της βάσης δεδομένων σας. Διαχειρίζεται την πισίνα συνδέσεων που είναι απαραίτητη για την κλιμάκωση πολλών ταυτόχρονων συνδέσεων που δημιουργούνται από ταυτόχρονες λειτουργίες Lambda. Αυτό επιτρέπει στις εφαρμογές Lambda σας να **ξαναχρησιμοποιούν υπάρχουσες συνδέσεις**, αντί να δημιουργούν νέες συνδέσεις για κάθε κλήση λειτουργίας.

### Lambda EFS Filesystems

Για να διατηρήσουν και να μοιραστούν δεδομένα, **οι Lambdas μπορούν να έχουν πρόσβαση σε EFS και να τα τοποθετήσουν**, έτσι ώστε η Lambda να μπορεί να διαβάσει και να γράψει από αυτό.

### Lambda Layers

Ένα _layer_ Lambda είναι ένα αρχείο .zip που **μπορεί να περιέχει επιπλέον κώδικα** ή άλλο περιεχόμενο. Ένα layer μπορεί να περιέχει βιβλιοθήκες, μια [προσαρμοσμένη εκτέλεση](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), δεδομένα ή αρχεία ρυθμίσεων.

Είναι δυνατόν να συμπεριλάβετε έως **πέντε layers ανά λειτουργία**. Όταν συμπεριλαμβάνετε ένα layer σε μια λειτουργία, το **περιεχόμενο εξάγεται στον φάκελο `/opt`** στο περιβάλλον εκτέλεσης.

Από **προεπιλογή**, τα **layers** που δημιουργείτε είναι **ιδιωτικά** για τον λογαριασμό σας AWS. Μπορείτε να επιλέξετε να **μοιραστείτε** ένα layer με άλλους λογαριασμούς ή να **κάνετε** το layer **δημόσιο**. Εάν οι λειτουργίες σας καταναλώνουν ένα layer που δημοσίευσε διαφορετικός λογαριασμός, οι λειτουργίες σας μπορούν να **συνεχίσουν να χρησιμοποιούν την έκδοση του layer μετά την διαγραφή του, ή αφού ανακληθεί η άδειά σας να έχετε πρόσβαση στο layer**. Ωστόσο, δεν μπορείτε να δημιουργήσετε μια νέα λειτουργία ή να ενημερώσετε λειτουργίες χρησιμοποιώντας μια διαγραμμένη έκδοση layer.

Οι λειτουργίες που αναπτύσσονται ως εικόνα κοντέινερ δεν χρησιμοποιούν layers. Αντίθετα, συσκευάζετε την προτιμώμενη εκτέλεση, τις βιβλιοθήκες και άλλες εξαρτήσεις στην εικόνα κοντέινερ όταν δημιουργείτε την εικόνα.

### Lambda Extensions

Οι επεκτάσεις Lambda ενισχύουν τις λειτουργίες ενσωματώνοντας διάφορα **εργαλεία παρακολούθησης, παρατηρησιμότητας, ασφάλειας και διακυβέρνησης**. Αυτές οι επεκτάσεις, που προστίθενται μέσω [.zip αρχείων χρησιμοποιώντας layers Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ή περιλαμβάνονται σε [αναπτύξεις εικόνας κοντέινερ](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), λειτουργούν σε δύο λειτουργίες: **εσωτερική** και **εξωτερική**.

* Οι **εσωτερικές επεκτάσεις** συγχωνεύονται με τη διαδικασία εκτέλεσης, χειρίζονται την εκκίνηση της χρησιμοποιώντας **μεταβλητές περιβάλλοντος συγκεκριμένες για τη γλώσσα** και **σενάρια περιτύλιξης**. Αυτή η προσαρμογή ισχύει για μια σειρά εκτελέσεων, συμπεριλαμβανομένων των **Java Correto 8 και 11, Node.js 10 και 12, και .NET Core 3.1**.
* Οι **εξωτερικές επεκτάσεις** εκτελούνται ως ξεχωριστές διαδικασίες, διατηρώντας τη λειτουργική ευθυγράμμιση με τον κύκλο ζωής της λειτουργίας Lambda. Είναι συμβατές με διάφορες εκτελέσεις όπως **Node.js 10 και 12, Python 3.7 και 3.8, Ruby 2.5 και 2.7, Java Corretto 8 και 11, .NET Core 3.1**, και **προσαρμοσμένες εκτελέσεις**.

### Enumeration
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Invoke a lambda

#### Manual
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### Μέσω εκτεθειμένου URL
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Call Lambda function via URL

Τώρα είναι η ώρα να ανακαλύψουμε πιθανές λειτουργίες lambda για εκτέλεση:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (262).png>)

Μια συνάρτηση lambda με το όνομα "Level6" είναι διαθέσιμη. Ας δούμε πώς να την καλέσουμε:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (102).png>)

Τώρα, που γνωρίζετε το όνομα και το ID μπορείτε να αποκτήσετε το Όνομα:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (237).png>)

Και τελικά καλέστε τη συνάρτηση πρόσβασης (παρατηρήστε ότι το ID, το Όνομα και το όνομα της συνάρτησης εμφανίζονται στη διεύθυνση URL): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Άλλοι Ενεργοποιητές

Υπάρχουν πολλές άλλες πηγές που μπορούν να ενεργοποιήσουν μια lambda

<figure><img src="../../../.gitbook/assets/image (167).png" alt=""><figcaption></figcaption></figure>

### Privesc

Στην επόμενη σελίδα μπορείτε να ελέγξετε πώς να **καταχραστείτε τις άδειες Lambda για να κλιμακώσετε τα προνόμια**:

{% content-ref url="../aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Μη Αυθεντική Πρόσβαση

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Μετά την Εκμετάλλευση

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Επιμονή

{% content-ref url="../aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Αναφορές

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
