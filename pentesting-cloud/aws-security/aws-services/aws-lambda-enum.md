# AWS - Lambda Enum

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## Lambda

Amazon Web Services (AWS) Lambda è¢«æè¿°ä¸ºä¸€ç§ **è®¡ç®—æœåŠ¡**ï¼Œå®ƒå…è®¸åœ¨æ— éœ€æœåŠ¡å™¨é…ç½®æˆ–ç®¡ç†çš„æƒ…å†µä¸‹æ‰§è¡Œä»£ç ã€‚å…¶ç‰¹ç‚¹æ˜¯èƒ½å¤Ÿ **è‡ªåŠ¨å¤„ç†** ä»£ç æ‰§è¡Œæ‰€éœ€çš„èµ„æºåˆ†é…ï¼Œç¡®ä¿é«˜å¯ç”¨æ€§ã€å¯æ‰©å±•æ€§å’Œå®‰å…¨æ€§ã€‚Lambda çš„ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯å…¶å®šä»·æ¨¡å¼ï¼Œ**ä»…æ ¹æ®ä½¿ç”¨çš„è®¡ç®—æ—¶é—´æ”¶è´¹**ï¼Œæ— éœ€åˆå§‹æŠ•èµ„æˆ–é•¿æœŸä¹‰åŠ¡ã€‚

è°ƒç”¨ lambda å¯ä»¥é€šè¿‡ **ä»»æ„é¢‘ç‡**ï¼ˆä½¿ç”¨ Cloudwatchï¼‰ã€**æš´éœ²**ä¸€ä¸ª **URL** ç«¯ç‚¹å¹¶è°ƒç”¨å®ƒã€é€šè¿‡ **API Gateway** è°ƒç”¨ï¼Œç”šè‡³åŸºäº **äº‹ä»¶**ï¼ˆå¦‚ **S3** å­˜å‚¨æ¡¶ä¸­çš„æ•°æ®æ›´æ”¹æˆ– **DynamoDB** è¡¨çš„æ›´æ–°ï¼‰æ¥è°ƒç”¨ã€‚

lambda çš„ **ä»£ç ** å­˜å‚¨åœ¨ **`/var/task`**ã€‚

### Lambda åˆ«åæƒé‡

ä¸€ä¸ª Lambda å¯ä»¥æœ‰ **å¤šä¸ªç‰ˆæœ¬**ã€‚\
å¹¶ä¸”å¯ä»¥é€šè¿‡ **åˆ«å** æš´éœ² **å¤šä¸ªç‰ˆæœ¬**ã€‚åˆ«åä¸­æš´éœ²çš„ **æ¯ä¸ªç‰ˆæœ¬** çš„ **æƒé‡** å°†å†³å®š **å“ªä¸ªåˆ«åæ¥æ”¶è°ƒç”¨**ï¼ˆä¾‹å¦‚å¯ä»¥æ˜¯ 90%-10%ï¼‰ã€‚\
å¦‚æœ **æŸä¸ª** åˆ«åçš„ä»£ç  **å­˜åœ¨æ¼æ´**ï¼Œä½ å¯ä»¥å‘é€ **è¯·æ±‚ç›´åˆ°æ¼æ´ç‰ˆæœ¬æ¥æ”¶åˆ°æ”»å‡»**ã€‚

![](<../../../.gitbook/assets/image (223).png>)

### èµ„æºç­–ç•¥

Lambda èµ„æºç­–ç•¥å…è®¸ **æˆäºˆå…¶ä»–æœåŠ¡/è´¦æˆ·è°ƒç”¨** lambda çš„æƒé™ã€‚\
ä¾‹å¦‚ï¼Œè¿™æ˜¯å…è®¸ **ä»»ä½•äººè®¿é—®é€šè¿‡ URL æš´éœ²çš„ lambda** çš„ç­–ç•¥ï¼š

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

æˆ–è€…è¿™æ˜¯å…è®¸ API Gateway è°ƒç”¨å®ƒçš„ç­–ç•¥ï¼š

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda æ•°æ®åº“ä»£ç†

å½“æœ‰ **æ•°ç™¾ä¸ªå¹¶å‘ lambda è¯·æ±‚** æ—¶ï¼Œå¦‚æœæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦ **è¿æ¥å’Œå…³é—­æ•°æ®åº“è¿æ¥**ï¼Œè¿™æ˜¯è¡Œä¸é€šçš„ï¼ˆlambdas æ˜¯æ— çŠ¶æ€çš„ï¼Œæ— æ³•ä¿æŒè¿æ¥æ‰“å¼€ï¼‰ã€‚\
å› æ­¤ï¼Œå¦‚æœä½ çš„ **Lambda å‡½æ•°ä¸ RDS Proxy äº¤äº’** è€Œä¸æ˜¯ä¸æ•°æ®åº“å®ä¾‹äº¤äº’ï¼Œå®ƒä¼šå¤„ç†å¹¶å‘ Lambda å‡½æ•°åˆ›å»ºçš„è®¸å¤šåŒæ—¶è¿æ¥æ‰€éœ€çš„è¿æ¥æ± ã€‚è¿™å…è®¸ä½ çš„ Lambda åº”ç”¨ç¨‹åº **é‡ç”¨ç°æœ‰è¿æ¥**ï¼Œè€Œä¸æ˜¯ä¸ºæ¯æ¬¡å‡½æ•°è°ƒç”¨åˆ›å»ºæ–°è¿æ¥ã€‚

### Lambda EFS æ–‡ä»¶ç³»ç»Ÿ

ä¸ºäº†ä¿å­˜ç”šè‡³å…±äº«æ•°æ®ï¼Œ**Lambdas å¯ä»¥è®¿é—® EFS å¹¶æŒ‚è½½å®ƒä»¬**ï¼Œè¿™æ · Lambda å°±å¯ä»¥è¯»å–å’Œå†™å…¥å…¶ä¸­çš„æ•°æ®ã€‚

### Lambda å±‚

Lambda _å±‚_ æ˜¯ä¸€ä¸ª .zip æ–‡ä»¶å½’æ¡£ï¼Œ**å¯ä»¥åŒ…å«é¢å¤–çš„ä»£ç ** æˆ–å…¶ä»–å†…å®¹ã€‚å±‚å¯ä»¥åŒ…å«åº“ã€[è‡ªå®šä¹‰è¿è¡Œæ—¶](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html)ã€æ•°æ®æˆ–é…ç½®æ–‡ä»¶ã€‚

æ¯ä¸ªå‡½æ•°æœ€å¤šå¯ä»¥åŒ…å« **äº”ä¸ªå±‚**ã€‚å½“ä½ åœ¨å‡½æ•°ä¸­åŒ…å«ä¸€ä¸ªå±‚æ—¶ï¼Œ**å†…å®¹ä¼šè¢«è§£å‹åˆ°æ‰§è¡Œç¯å¢ƒä¸­çš„ `/opt`** ç›®å½•ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œä½ åˆ›å»ºçš„ **å±‚** æ˜¯ **ç§æœ‰** çš„ï¼Œä»…é™äºä½ çš„ AWS è´¦æˆ·ã€‚ä½ å¯ä»¥é€‰æ‹© **ä¸å…¶ä»–è´¦æˆ·å…±äº«** å±‚æˆ– **å…¬å¼€** å±‚ã€‚å¦‚æœä½ çš„å‡½æ•°ä½¿ç”¨äº†å…¶ä»–è´¦æˆ·å‘å¸ƒçš„å±‚ï¼Œå³ä½¿è¯¥å±‚ç‰ˆæœ¬è¢«åˆ é™¤æˆ–ä½ çš„è®¿é—®æƒé™è¢«æ’¤é”€ï¼Œä½ çš„å‡½æ•°ä»ç„¶å¯ä»¥ **ç»§ç»­ä½¿ç”¨è¯¥å±‚ç‰ˆæœ¬**ã€‚ä½†æ˜¯ï¼Œä½ ä¸èƒ½ä½¿ç”¨å·²åˆ é™¤çš„å±‚ç‰ˆæœ¬åˆ›å»ºæ–°å‡½æ•°æˆ–æ›´æ–°å‡½æ•°ã€‚

ä½œä¸ºå®¹å™¨é•œåƒéƒ¨ç½²çš„å‡½æ•°ä¸ä½¿ç”¨å±‚ã€‚ç›¸åï¼Œä½ åœ¨æ„å»ºé•œåƒæ—¶å°†é¦–é€‰çš„è¿è¡Œæ—¶ã€åº“å’Œå…¶ä»–ä¾èµ–é¡¹æ‰“åŒ…åˆ°å®¹å™¨é•œåƒä¸­ã€‚

### Lambda æ‰©å±•

Lambda æ‰©å±•é€šè¿‡é›†æˆå„ç§ **ç›‘æ§ã€å¯è§‚å¯Ÿæ€§ã€å®‰å…¨å’Œæ²»ç†å·¥å…·** æ¥å¢å¼ºå‡½æ•°ã€‚è¿™äº›æ‰©å±•é€šè¿‡ [.zip å½’æ¡£ä½¿ç”¨ Lambda å±‚](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) æˆ–åŒ…å«åœ¨ [å®¹å™¨é•œåƒéƒ¨ç½²](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/) ä¸­æ·»åŠ ï¼Œåˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼š**å†…éƒ¨** å’Œ **å¤–éƒ¨**ã€‚

* **å†…éƒ¨æ‰©å±•** ä¸è¿è¡Œæ—¶è¿›ç¨‹åˆå¹¶ï¼Œä½¿ç”¨ **ç‰¹å®šè¯­è¨€çš„ç¯å¢ƒå˜é‡** å’Œ **åŒ…è£…è„šæœ¬** æ“ä½œå…¶å¯åŠ¨ã€‚è¿™ç§è‡ªå®šä¹‰é€‚ç”¨äºä¸€ç³»åˆ—è¿è¡Œæ—¶ï¼ŒåŒ…æ‹¬ **Java Correto 8 å’Œ 11ã€Node.js 10 å’Œ 12 ä»¥åŠ .NET Core 3.1**ã€‚
* **å¤–éƒ¨æ‰©å±•** ä½œä¸ºç‹¬ç«‹è¿›ç¨‹è¿è¡Œï¼Œä¸ Lambda å‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸä¿æŒæ“ä½œä¸€è‡´ã€‚å®ƒä»¬å…¼å®¹å„ç§è¿è¡Œæ—¶ï¼Œå¦‚ **Node.js 10 å’Œ 12ã€Python 3.7 å’Œ 3.8ã€Ruby 2.5 å’Œ 2.7ã€Java Corretto 8 å’Œ 11ã€.NET Core 3.1** å’Œ **è‡ªå®šä¹‰è¿è¡Œæ—¶**ã€‚

### æšä¸¾
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### è°ƒç”¨ä¸€ä¸ªlambda

#### æ‰‹åŠ¨
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### é€šè¿‡æš´éœ²çš„URL

```html
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<path>
```

If the URL is exposed, it can be accessed directly. This can lead to unauthorized access if proper authentication and authorization are not implemented.

å¦‚æœURLæš´éœ²ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ã€‚å¦‚æœæ²¡æœ‰å®æ–½é€‚å½“çš„èº«ä»½éªŒè¯å’Œæˆæƒï¼Œè¿™å¯èƒ½å¯¼è‡´æœªç»æˆæƒçš„è®¿é—®ã€‚

#### Via AWS CLI

```bash
aws lambda list-functions --region <region>
```

Using the AWS CLI, you can list all the Lambda functions in a specific region.

ä½¿ç”¨AWS CLIï¼Œä½ å¯ä»¥åˆ—å‡ºç‰¹å®šåŒºåŸŸå†…çš„æ‰€æœ‰Lambdaå‡½æ•°ã€‚

#### Via AWS SDK

```python
import boto3

client = boto3.client('lambda', region_name='<region>')
response = client.list_functions()
print(response)
```

Using the AWS SDK for Python (boto3), you can programmatically list all the Lambda functions in a specific region.

ä½¿ç”¨AWS SDK for Python (boto3)ï¼Œä½ å¯ä»¥é€šè¿‡ç¼–ç¨‹æ–¹å¼åˆ—å‡ºç‰¹å®šåŒºåŸŸå†…çš„æ‰€æœ‰Lambdaå‡½æ•°ã€‚
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### é€šè¿‡ URL è°ƒç”¨ Lambda å‡½æ•°

ç°åœ¨æ˜¯æ—¶å€™æ‰¾å‡ºå¯èƒ½æ‰§è¡Œçš„ lambda å‡½æ•°äº†ï¼š
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (262).png>)

ä¸€ä¸ªåä¸º "Level6" çš„lambdaå‡½æ•°å¯ç”¨ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è°ƒç”¨å®ƒï¼š
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (102).png>)

ç°åœ¨ï¼Œä½ çŸ¥é“äº†åç§°å’ŒIDï¼Œä½ å¯ä»¥è·å–åç§°ï¼š
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (237).png>)

æœ€åè°ƒç”¨è¯¥å‡½æ•°ï¼ˆæ³¨æ„IDã€Nameå’Œfunction-nameå‡ºç°åœ¨URLä¸­ï¼‰ï¼š[https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### å…¶ä»–è§¦å‘å™¨

æœ‰å¾ˆå¤šå…¶ä»–æ¥æºå¯ä»¥è§¦å‘lambda

<figure><img src="../../../.gitbook/assets/image (167).png" alt=""><figcaption></figcaption></figure>

### Privesc

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œä½ å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨Lambdaæƒé™æ¥æå‡æƒé™**ï¼š

{% content-ref url="../aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### æœªç»èº«ä»½éªŒè¯çš„è®¿é—®

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### åæœŸåˆ©ç”¨

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### æŒä¹…æ€§

{% content-ref url="../aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹ GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤PRsåˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æ¥åˆ†äº«é»‘å®¢æŠ€å·§**ã€‚

</details>
{% endhint %}
