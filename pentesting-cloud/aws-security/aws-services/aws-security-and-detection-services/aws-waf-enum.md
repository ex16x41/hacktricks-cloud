# AWS - WAF Enum

## AWS - WAF Enum

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## AWS WAF

AWS WAF je **vatrozid za web aplikacije** dizajniran da **zaÅ¡titi web aplikacije ili API-je** od raznih web eksploatacija koje mogu uticati na njihovu dostupnost, sigurnost ili potroÅ¡nju resursa. OmoguÄ‡ava korisnicima da kontroliÅ¡u dolazni saobraÄ‡aj postavljanjem **pravila sigurnosti** koja ublaÅ¾avaju tipiÄne vektore napada kao Å¡to su SQL injekcija ili skriptovanje izmeÄ‘u sajtova, kao i definisanjem prilagoÄ‘enih pravila filtriranja.

### KljuÄni koncepti

#### Web ACL (Lista kontrole pristupa)

Web ACL je zbirka pravila koja moÅ¾ete primeniti na svoje web aplikacije ili API-je. Kada poveÅ¾ete Web ACL sa resursom, AWS WAF ispituje dolazne zahteve na osnovu pravila definisanih u Web ACL-u i preduzima odreÄ‘ene akcije.

#### Grupa pravila

Grupa pravila je ponovo upotrebljiva zbirka pravila koja moÅ¾ete primeniti na viÅ¡e Web ACL-a. Grupe pravila pomaÅ¾u u upravljanju i odrÅ¾avanju doslednih skupova pravila Å¡irom razliÄitih web aplikacija ili API-ja.

Svaka grupa pravila ima svoju povezanu **kapacitet**, koja pomaÅ¾e u izraÄunavanju i kontroli operativnih resursa koji se koriste za pokretanje vaÅ¡ih pravila, grupa pravila i web ACL-a. Kada se njena vrednost postavi tokom kreiranja, nije moguÄ‡e izmeniti je.

#### Pravilo

Pravilo definiÅ¡e skup uslova koje AWS WAF koristi za ispitivanje dolaznih web zahteva. Postoje dve glavne vrste pravila:

1. **Redovno pravilo**: Ova vrsta pravila koristi odreÄ‘ene uslove da odredi da li da dozvoli, blokira ili broji web zahteve.
2. **Pravilo zasnovano na brzini**: Broji zahteve sa odreÄ‘ene IP adrese tokom petominutnog perioda. Ovde korisnici definiÅ¡u prag, a ako broj zahteva sa IP adrese premaÅ¡i ovaj limit u pet minuta, naredni zahtevi sa te IP adrese se blokiraju dok brzina zahteva ne padne ispod praga. Minimalni prag za pravila zasnovana na brzini je **2000 zahteva**.

#### Upravljana pravila

AWS WAF nudi unapred konfigurisane, upravljane skupove pravila koje odrÅ¾ava AWS i prodavci na AWS Marketplace-u. Ovi skupovi pravila pruÅ¾aju zaÅ¡titu od uobiÄajenih pretnji i redovno se aÅ¾uriraju kako bi se reÅ¡ile nove ranjivosti.

#### IP skup

IP skup je lista IP adresa ili opsega IP adresa koje Å¾elite da dozvolite ili blokirate. IP skupovi pojednostavljuju proces upravljanja pravilima zasnovanim na IP adresama.

#### Regex obrazac skup

Regex obrazac skup sadrÅ¾i jedan ili viÅ¡e regularnih izraza (regex) koji definiÅ¡u obrasce za pretragu u web zahtevima. Ovo je korisno za sloÅ¾enije scenarije usklaÄ‘ivanja, kao Å¡to je filtriranje specifiÄnih sekvenci karaktera.

#### Lock Token

Lock Token se koristi za kontrolu konkurencije prilikom aÅ¾uriranja WAF resursa. Osigurava da promene ne budu sluÄajno prepisane od strane viÅ¡e korisnika ili procesa koji pokuÅ¡avaju da aÅ¾uriraju isti resurs istovremeno.

#### API kljuÄevi

API kljuÄevi u AWS WAF se koriste za autentifikaciju zahteva za odreÄ‘ene API operacije. Ovi kljuÄevi su Å¡ifrovani i bezbedno upravljani kako bi se kontrolisao pristup i osiguralo da samo ovlaÅ¡Ä‡eni korisnici mogu da vrÅ¡e promene u WAF konfiguracijama.

* **Primer**: Integracija CAPTCHA API-ja.

#### Politika dozvola

Politika dozvola je IAM politika koja specificira ko moÅ¾e da vrÅ¡i radnje na AWS WAF resursima. Definisanjem dozvola moÅ¾ete kontrolisati pristup WAF resursima i osigurati da samo ovlaÅ¡Ä‡eni korisnici mogu da kreiraju, aÅ¾uriraju ili briÅ¡u konfiguracije.

#### Opseg

Parametar opsega u AWS WAF specificira da li se WAF pravila i konfiguracije primenjuju na regionalnu aplikaciju ili Amazon CloudFront distribuciju.

* **REGIONAL**: Primena na regionalne usluge kao Å¡to su Application Load Balancers (ALB), Amazon API Gateway REST API, AWS AppSync GraphQL API, Amazon Cognito korisniÄki bazen, AWS App Runner usluga i AWS Verified Access instanca. Specifikujete AWS region u kojem se ovi resursi nalaze.
* **CLOUDFRONT**: Primena na Amazon CloudFront distribucije, koje su globalne. WAF konfiguracije za CloudFront se upravljaju kroz region `us-east-1` bez obzira na to gde se sadrÅ¾aj isporuÄuje.

### KljuÄne karakteristike

#### Kriterijumi praÄ‡enja (Uslovi)

**Uslovi** specificiraju elemente dolaznih HTTP/HTTPS zahteva koje AWS WAF prati, ukljuÄujuÄ‡i XSS, geografsku lokaciju (GEO), IP adrese, ograniÄenja veliÄine, SQL injekciju i obrasce (stringove i regex usklaÄ‘ivanje). VaÅ¾no je napomenuti da **zahtevi ograniÄeni na CloudFront nivou na osnovu zemlje neÄ‡e dostiÄ‡i WAF**.

Svaki AWS nalog moÅ¾e konfigurisati:

* **100 uslova** za svaku vrstu (osim za Regex, gde je dozvoljeno samo **10 uslova**, ali ovaj limit moÅ¾e biti poveÄ‡an).
* **100 pravila** i **50 Web ACL-a**.
* Maksimalno **5 pravila zasnovanih na brzini**.
* Propusnost od **10,000 zahteva po sekundi** kada je WAF implementiran sa aplikacionim balansirnikom optereÄ‡enja.

#### Akcije pravila

Akcije su dodeljene svakom pravilu, a opcije su:

* **Dozvoli**: Zahtev se prosleÄ‘uje odgovarajuÄ‡oj CloudFront distribuciji ili aplikacionom balansirniku optereÄ‡enja.
* **Blokiraj**: Zahtev se odmah prekida.
* **Broj**: Broji zahteve koji ispunjavaju uslove pravila. Ovo je korisno za testiranje pravila, potvrÄ‘ivanje taÄnosti pravila pre nego Å¡to se postavi na Dozvoli ili Blokiraj.
* **CAPTCHA i izazov:** Proverava se da zahtev ne dolazi od bota koristeÄ‡i CAPTCHA zagonetke i tihe izazove.

Ako zahtev ne odgovara nijednom pravilu unutar Web ACL-a, podloÅ¾an je **podrazumevanoj akciji** (Dozvoli ili Blokiraj). Redosled izvrÅ¡enja pravila, definisan unutar Web ACL-a, je kljuÄan i obiÄno prati ovu sekvencu:

1. Dozvoli IP adrese sa bele liste.
2. Blokiraj IP adrese sa crne liste.
3. Blokiraj zahteve koji odgovaraju bilo kojim Å¡tetnim potpisima.

#### CloudWatch integracija

AWS WAF se integriÅ¡e sa CloudWatch za praÄ‡enje, nudeÄ‡i metrike kao Å¡to su AllowedRequests, BlockedRequests, CountedRequests i PassedRequests. Ove metrike se izveÅ¡tavaju svake minute po defaultu i Äuvaju se tokom perioda od dve nedelje.

### Enumeracija

Da biste interagovali sa CloudFront distribucijama, morate specificirati region US East (N. Virginia):

* CLI - Specifikujte region US East kada koristite CloudFront opseg: `--scope CLOUDFRONT --region=us-east-1`.
* API i SDK-ovi - Za sve pozive, koristite region endpoint us-east-1.

Da biste interagovali sa regionalnim uslugama, trebate specificirati region:

* Primer sa regionom Evropa (Å panija): `--scope REGIONAL --region=eu-south-2`
```bash
# Web ACLs #

## Retrieve a list of web access control lists (Web ACLs) available in your AWS account
aws wafv2 list-web-acls --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve details about the specified Web ACL
aws wafv2 get-web-acl --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

## Retrieve a list of resources associated with a specific web access control list (Web ACL)
aws wafv2 list-resources-for-web-acl --web-acl-arn <value> # Additional permissions needed depending on the protected resource type: cognito-idp:ListResourcesForWebACL, ec2:DescribeVerifiedAccessInstanceWebAclAssociations or apprunner:ListAssociatedServicesForWebAcl
## Retrieve the Web ACL associated with the specified AWS resource
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Additional permissions needed depending on the protected resource type: cognito-idp:GetWebACLForResource, ec2:GetVerifiedAccessInstanceWebAcl, wafv2:GetWebACL or apprunner:DescribeWebAclForService

# Rule groups #

## List of the rule groups available in your AWS account
aws wafv2 list-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the details of a specific rule group
aws wafv2 get-rule-group [--name <value>] [--id <value>] [--arn <value>] [--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>]
## Retrieve the IAM policy attached to the specified rule group
aws wafv2 get-permission-policy --resource-arn <rule-group-arn> # Just the owner of the Rule Group can do this operation

# Managed rule groups (by AWS or by a third-party) #

## List the managed rule groups that are available
aws wafv2 list-available-managed-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## List the available versions of the specified managed rule group
aws wafv2 list-available-managed-rule-group-versions --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about a specific managed rule group
aws wafv2 describe-managed-rule-group --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--version-name <value>]
## Retrieve high-level information about all managed rule groups
aws wafv2 describe-all-managed-products --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about all managed rule groups from a specific vendor
aws wafv2 describe-managed-products-by-vendor --vendor-name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# IP sets #

## List the IP sets that are available in your AWS account
aws wafv2 list-ip-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the specific IP set
aws wafv2 get-ip-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the keys that are currently being managed by a rate-based rule.
aws wafv2 get-rate-based-statement-managed-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>\
--web-acl-name <value> --web-acl-id <value> --rule-name <value> [--rule-group-rule-name <value>]

# Regex pattern sets #

## List all the regex pattern sets that you manage
aws wafv2 list-regex-pattern-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieves the specified regex pattern sets
aws wafv2 get-regex-pattern-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# API Keys #

## List API keys for the specified scope
aws wafv2 list-api-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve decrypted API key
aws wafv2 get-decrypted-api-key --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --api-key <value>

# Logs #

## List of logging configurations (storage location of the logs)
aws wafv2 list-logging-configurations --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--log-scope <value>]
## Retrieve the logging configuration settings associated with a specific web ACL
aws wafv2 get-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]

# Miscelaneous #

## Retrieve a list of the tags associated to the specified resource
aws wafv2 list-tags-for-resource resource-arn <value>

## Retrieve a sample of web requests that match a specified rule within a WebACL during a specified time range
aws wafv2 get-sampled-requests --web-acl-arn <value> --rule-metric-name <value> --time-window <value> --max-items <1-500> --scope <value>

## Obtains the web ACL capacity unit (WCU) requirements for a specified scope and ruleset
aws wafv2 check-capacity --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --rules <value>

## List of available releases for the AWS WAFv2 mobile SDK
aws wafv2 list-mobile-sdk-releases --platform <IOS | ANDROID>
## Retrieves information for the specified mobile SDK release
aws wafv2 get-mobile-sdk-release --platform <value> --release-version <value>

```
### Post Exploitation / Bypass

{% hint style="success" %}
Iz perspektive napadaÄa, ova usluga moÅ¾e pomoÄ‡i napadaÄu da identifikuje WAF zaÅ¡tite i mreÅ¾ne izloÅ¾enosti koje bi mu mogle pomoÄ‡i da kompromituje druge veb stranice.

MeÄ‘utim, napadaÄ bi takoÄ‘e mogao biti zainteresovan za ometanje ove usluge kako veb stranice ne bi bile zaÅ¡tiÄ‡ene WAF-om.
{% endhint %}

U mnogim operacijama brisanja i aÅ¾uriranja biÄ‡e neophodno obezbediti **lock token**. Ovaj token se koristi za kontrolu konkurencije nad resursima, osiguravajuÄ‡i da promene ne budu sluÄajno prepisane od strane viÅ¡e korisnika ili procesa koji pokuÅ¡avaju da aÅ¾uriraju isti resurs istovremeno. Da biste dobili ovaj token, mogli biste izvrÅ¡iti odgovarajuÄ‡e **list** ili **get** operacije nad specifiÄnim resursom.

#### **`wafv2:CreateRuleGroup`, `wafv2:UpdateRuleGroup`, `wafv2:DeleteRuleGroup`**

NapadaÄ bi mogao da kompromituje bezbednost pogoÄ‘enog resursa na sledeÄ‡e naÄine:

* Kreiranjem pravnih grupa koje bi, na primer, mogle blokirati legitimni saobraÄ‡aj sa legitimnih IP adresa, uzrokujuÄ‡i uskraÄ‡ivanje usluge.
* AÅ¾uriranjem pravnih grupa, sa moguÄ‡noÅ¡Ä‡u da modifikuje njihove akcije, na primer, sa **Block** na **Allow**.
* Brisanjem pravnih grupa koje pruÅ¾aju kritiÄne mere bezbednosti.
```bash
# Create Rule Group
aws wafv2 create-rule-group --name <value> --capacity <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Update Rule Group
aws wafv2 update-rule-group --name <value> --id <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Delete Rule Group
aws wafv2 delete-rule-group --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Ğ¡Ğ»ĞµĞ´ĞµÑ›Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·ÑƒÑ˜Ñƒ Ğ³Ñ€ÑƒĞ¿Ñƒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° ĞºĞ¾Ñ˜Ğ° Ğ±Ğ¸ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ°Ğ»Ğ° Ğ»ĞµĞ³Ğ¸Ñ‚Ğ¸Ğ¼Ğ°Ğ½ ÑĞ°Ğ¾Ğ±Ñ€Ğ°Ñ›Ğ°Ñ˜ Ğ¸Ğ· ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ğ¸Ñ… IP Ğ°Ğ´Ñ€ĞµÑĞ°:
```bash
aws wafv2 create-rule-group --name BlockLegitimateIPsRuleGroup --capacity 1 --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=BlockLegitimateIPsRuleGroup --scope CLOUDFRONT --region us-east-1 --rules file://rule.json
```
Datoteka **rule.json** bi izgledala ovako:
```json
[
{
"Name":"BlockLegitimateIPsRule",
"Priority":0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:global/ipset/legitIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action":{
"Block":{}
},
"VisibilityConfig":{
"SampledRequestsEnabled":false,
"CloudWatchMetricsEnabled":false,
"MetricName":"BlockLegitimateIPsRule"
}
}
]
```
**Potencijalni uticaj**: NeovlaÅ¡Ä‡en pristup, curenje podataka i potencijalni DoS napadi.

#### **`wafv2:CreateWebACL`, `wafv2:UpdateWebACL`, `wafv2:DeleteWebACL`**

Sa ovim dozvolama, napadaÄ bi mogao da:

* Kreira novi Web ACL, uvodeÄ‡i pravila koja ili dozvoljavaju zlonamerni saobraÄ‡aj ili blokiraju legitimni saobraÄ‡aj, efikasno ÄineÄ‡i WAF beskorisnim ili uzrokujuÄ‡i uskraÄ‡ivanje usluge.
* AÅ¾urira postojeÄ‡e Web ACL-ove, imajuÄ‡i moguÄ‡nost da modifikuje pravila kako bi dozvolio napade kao Å¡to su SQL injekcija ili cross-site scripting, koji su prethodno bili blokirani, ili ometa normalan protok saobraÄ‡aja blokirajuÄ‡i validne zahteve.
* ObriÅ¡e Web ACL, ostavljajuÄ‡i pogoÄ‘ene resurse potpuno nezaÅ¡tiÄ‡enim, izlaÅ¾uÄ‡i ih Å¡irokom spektru web napada.

{% hint style="info" %}
MoÅ¾ete obrisati navedeni **WebACL** samo ako je **ManagedByFirewallManager** false.
{% endhint %}
```bash
# Create Web ACL
aws wafv2 create-web-acl --name <value> --default-action <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Update Web ACL
aws wafv2 update-web-acl --name <value> --id <value> --default-action <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Delete Web ACL
aws wafv2 delete-web-acl --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
SledeÄ‡i primeri pokazuju kako aÅ¾urirati Web ACL da blokira legitimni saobraÄ‡aj iz odreÄ‘enog IP skupa. Ako izvorni IP ne odgovara nijednom od tih IP adresa, podrazumevana akcija bi takoÄ‘e bila blokiranje, Å¡to uzrokuje DoS.

**Original Web ACL**:
```json
{
"WebACL": {
"Name": "AllowLegitimateIPsWebACL",
"Id": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/AllowLegitimateIPsWebACL/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"DefaultAction": {
"Allow": {}
},
"Description": "",
"Rules": [
{
"Name": "AllowLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Allow": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsRule"
}
}
],
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsWebACL"
},
"Capacity": 1,
"ManagedByFirewallManager": false,
"LabelNamespace": "awswaf:123456789012:webacl:AllowLegitimateIPsWebACL:"
},
"LockToken": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}

```
ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ·Ğ° Ğ°Ğ¶ÑƒÑ€Ğ¸Ñ€Ğ°ÑšĞµ Web ACL:
```json
aws wafv2 update-web-acl --name AllowLegitimateIPsWebACL --scope REGIONAL --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --default-action Block={} --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=AllowLegitimateIPsWebACL --rules file://rule.json --region us-east-1
```
Datoteka **rule.json** bi izgledala ovako:
```json
[
{
"Name": "BlockLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Block": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "BlockLegitimateIPRule"
}
}
]
```
**Potencijalni uticaj**: NeovlaÅ¡Ä‡en pristup, curenje podataka i potencijalni DoS napadi.

#### **`wafv2:AssociateWebACL`, `wafv2:DisassociateWebACL`**

Dozvola **`wafv2:AssociateWebACL`** bi omoguÄ‡ila napadaÄu da poveÅ¾e web ACL-ove (Liste za kontrolu pristupa) sa resursima, Å¡to bi omoguÄ‡ilo zaobilaÅ¾enje bezbednosnih kontrola, dopuÅ¡tajuÄ‡i neovlaÅ¡Ä‡enoj mreÅ¾noj komunikaciji da doÄ‘e do aplikacije, Å¡to potencijalno moÅ¾e dovesti do eksploatacija poput SQL injekcije ili cross-site scripting (XSS). S druge strane, sa dozvolom **`wafv2:DisassociateWebACL`**, napadaÄ bi mogao privremeno onemoguÄ‡iti bezbednosne zaÅ¡tite, izlaÅ¾uÄ‡i resurse ranjivostima bez otkrivanja.

Dodatne dozvole bi bile potrebne u zavisnosti od tipa zaÅ¡tiÄ‡enog resursa:

* **PoveÅ¾i**
* apigateway:SetWebACL
* apprunner:AssociateWebAcl
* appsync:SetWebACL
* cognito-idp:AssociateWebACL
* ec2:AssociateVerifiedAccessInstanceWebAcl
* elasticloadbalancing:SetWebAcl
* **Odvoji**
* apigateway:SetWebACL
* apprunner:DisassociateWebAcl
* appsync:SetWebACL
* cognito-idp:DisassociateWebACL
* ec2:DisassociateVerifiedAccessInstanceWebAcl
* elasticloadbalancing:SetWebAcl
```bash
# Associate
aws wafv2 associate-web-acl --web-acl-arn <value> --resource-arn <value>
# Disassociate
aws wafv2 disassociate-web-acl --resource-arn <value>
```
**Potencijalni uticaj**: Kompromitovana sigurnost resursa, poveÄ‡an rizik od eksploatacije i potencijalni prekidi usluga unutar AWS okruÅ¾enja zaÅ¡tiÄ‡enih AWS WAF-om.

#### **`wafv2:CreateIPSet` , `wafv2:UpdateIPSet`, `wafv2:DeleteIPSet`**

NapadaÄ bi mogao da kreira, aÅ¾urira i obriÅ¡e IP setove kojima upravlja AWS WAF. Ovo bi moglo biti opasno jer bi mogao da kreira nove IP setove za omoguÄ‡avanje zlonamernog saobraÄ‡aja, modifikuje IP setove kako bi blokirao legitimni saobraÄ‡aj, aÅ¾urira postojeÄ‡e IP setove da ukljuÄe zlonamerne IP adrese, ukloni pouzdane IP adrese ili obriÅ¡e kritiÄne IP setove koji su namenjeni zaÅ¡titi kritiÄnih resursa.
```bash
# Create IP set
aws wafv2 create-ip-set --name <value> --ip-address-version <IPV4 | IPV6> --addresses <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Update IP set
aws wafv2 update-ip-set --name <value> --id <value> --addresses <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete IP set
aws wafv2 delete-ip-set --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
SledeÄ‡i primer pokazuje kako da **prepiÅ¡ete postojeÄ‡i IP skup Å¾eljenim IP skupom**:
```bash
aws wafv2 update-ip-set --name LegitimateIPv4Set --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --addresses 99.99.99.99/32 --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --scope CLOUDFRONT --region us-east-1
```
**Potencijalni uticaj**: NeovlaÅ¡Ä‡en pristup i blokiranje legitimnog saobraÄ‡aja.

#### **`wafv2:CreateRegexPatternSet`** , **`wafv2:UpdateRegexPatternSet`**, **`wafv2:DeleteRegexPatternSet`**

NapadaÄ sa ovim dozvolama mogao bi da manipuliÅ¡e skupovima obrazaca regularnih izraza koje koristi AWS WAF za kontrolu i filtriranje dolaznog saobraÄ‡aja na osnovu specifiÄnih obrazaca.

* Kreiranje novih regex obrazaca bi pomoglo napadaÄu da dozvoli Å¡tetan sadrÅ¾aj
* AÅ¾uriranjem postojeÄ‡ih obrazaca, napadaÄ bi mogao da zaobiÄ‘e sigurnosna pravila
* Brisanje obrazaca koji su dizajnirani da blokiraju zlonamerne aktivnosti moglo bi omoguÄ‡iti napadaÄu da poÅ¡alje zlonamerne podatke i zaobiÄ‘e sigurnosne mere.
```bash
# Create regex pattern set
aws wafv2 create-regex-pattern-set --name <value> --regular-expression-list <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--description <value>]
# Update regex pattern set
aws wafv2 update-regex-pattern-set --name <value> --id <value> --regular-expression-list <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete regex pattern set
aws wafv2 delete-regex-pattern-set --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --id <value> --lock-token <value>
```
**Potencijalni Uticaj**: ObilaÅ¾enje bezbednosnih kontrola, omoguÄ‡avanje zlonamernog sadrÅ¾aja i potencijalno izlaganje osetljivih podataka ili ometanje usluga i resursa zaÅ¡tiÄ‡enih AWS WAF-om.

#### **(`wavf2:PutLoggingConfiguration` &** `iam:CreateServiceLinkedRole`), **`wafv2:DeleteLoggingConfiguration`**

NapadaÄ sa **`wafv2:DeleteLoggingConfiguration`** mogao bi da ukloni konfiguraciju logovanja iz specificiranog Web ACL-a. Nakon toga, sa **`wavf2:PutLoggingConfiguration`** i **`iam:CreateServiceLinkedRole`** dozvolama, napadaÄ bi mogao da kreira ili zameni konfiguracije logovanja (nakon Å¡to ih je obrisao) kako bi ili potpuno spreÄio logovanje ili preusmerio logove na neovlaÅ¡Ä‡ene destinacije, kao Å¡to su Amazon S3 bucket-i, Amazon CloudWatch Logs log grupa ili Amazon Kinesis Data Firehose pod kontrolom.

Tokom procesa kreiranja, servis automatski postavlja potrebne dozvole da omoguÄ‡i pisanje logova na specificiranu destinaciju logovanja:

* **Amazon CloudWatch Logs:** AWS WAF kreira politiku resursa na odreÄ‘enoj CloudWatch Logs log grupi. Ova politika osigurava da AWS WAF ima potrebne dozvole za pisanje logova u log grupu.
* **Amazon S3 Bucket:** AWS WAF kreira politiku bucket-a na odreÄ‘enom S3 bucket-u. Ova politika dodeljuje AWS WAF potrebne dozvole za upload logova u specificirani bucket.
* **Amazon Kinesis Data Firehose:** AWS WAF kreira ulogu povezanu sa servisom specifiÄno za interakciju sa Kinesis Data Firehose. Ova uloga omoguÄ‡ava AWS WAF da isporuÄuje logove u konfigurisan Firehose stream.

{% hint style="info" %}
MoguÄ‡e je definisati samo jednu destinaciju logovanja po web ACL-u.
{% endhint %}
```bash
# Put logging configuration
aws wafv2 put-logging-configuration --logging-configuration <value>
# Delete logging configuration
aws wafv2 delete-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]
```
**Potencijalni Uticaj:** Zamagljena vidljivost u bezbednosne dogaÄ‘aje, oteÅ¾an proces odgovora na incidente i olakÅ¡avanje tajnih zlonamernih aktivnosti unutar AWS WAF-zaÅ¡tiÄ‡enih okruÅ¾enja.

#### **`wafv2:DeleteAPIKey`**

NapadaÄ sa ovim dozvolama mogao bi da obriÅ¡e postojeÄ‡e API kljuÄeve, ÄineÄ‡i CAPTCHA neefikasnim i ometajuÄ‡i funkcionalnost koja se oslanja na to, kao Å¡to su slanje obrazaca i kontrole pristupa. U zavisnosti od implementacije ovog CAPTCHA, to bi moglo dovesti ili do zaobilaÅ¾enja CAPTCHA ili do DoS-a ako upravljanje greÅ¡kama nije pravilno postavljeno u resursu.
```bash
# Delete API key
aws wafv2 delete-api-key --api-key <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Potencijalni uticaj**: OnemoguÄ‡avanje CAPTCHA zaÅ¡tita ili ometanje funkcionalnosti aplikacije, Å¡to moÅ¾e dovesti do bezbednosnih propusta i potencijalne kraÄ‘e podataka.

#### **`wafv2:TagResource`, `wafv2:UntagResource`**

NapadaÄ bi mogao da doda, izmeni ili ukloni oznake sa AWS WAFv2 resursa, kao Å¡to su Web ACL-ovi, grupe pravila, IP setovi, regex obrasci i konfiguracije logovanja.
```bash
# Tag
aws wafv2 tag-resource --resource-arn <value> --tags <value>
# Untag
aws wafv2 untag-resource --resource-arn <value> --tag-keys <value>
```
**Potencijalni uticaj**: Manipulacija resursima, curenje informacija, manipulacija troÅ¡kovima i operativne smetnje.

## Reference

* [https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:\~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application](https://www.citrusconsulting.com/aws-web-application-firewall-waf/)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awswafv2.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awswafv2.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
