# AWS - WAF Enum

## AWS - WAF Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## AWS WAF

AWS WAF es un **firewall de aplicaciones web** dise침ado para **proteger aplicaciones web o APIs** contra diversas explotaciones web que pueden afectar su disponibilidad, seguridad o consumo de recursos. Permite a los usuarios controlar el tr치fico entrante configurando **reglas de seguridad** que mitigan vectores de ataque t칤picos como inyecci칩n SQL o scripting entre sitios y tambi칠n definiendo reglas de filtrado personalizadas.

### Conceptos clave

#### Web ACL (Lista de Control de Acceso)

Una Web ACL es una colecci칩n de reglas que puedes aplicar a tus aplicaciones web o APIs. Cuando asocias una Web ACL con un recurso, AWS WAF inspecciona las solicitudes entrantes seg칰n las reglas definidas en la Web ACL y toma las acciones especificadas.

#### Grupo de Reglas

Un Grupo de Reglas es una colecci칩n reutilizable de reglas que puedes aplicar a m칰ltiples Web ACLs. Los grupos de reglas ayudan a gestionar y mantener conjuntos de reglas consistentes en diferentes aplicaciones web o APIs.

Cada grupo de reglas tiene su **capacidad** asociada, que ayuda a calcular y controlar los recursos operativos que se utilizan para ejecutar tus reglas, grupos de reglas y Web ACLs. Una vez que su valor se establece durante la creaci칩n, no es posible modificarlo.

#### Regla

Una regla define un conjunto de condiciones que AWS WAF utiliza para inspeccionar las solicitudes web entrantes. Hay dos tipos principales de reglas:

1. **Regla Regular**: Este tipo de regla utiliza condiciones especificadas para determinar si permitir, bloquear o contar las solicitudes web.
2. **Regla Basada en Tasa**: Cuenta las solicitudes de una direcci칩n IP espec칤fica durante un per칤odo de cinco minutos. Aqu칤, los usuarios definen un umbral, y si el n칰mero de solicitudes de una IP excede este l칤mite dentro de cinco minutos, las solicitudes subsiguientes de esa IP se bloquean hasta que la tasa de solicitudes caiga por debajo del umbral. El umbral m칤nimo para las reglas basadas en tasa es de **2000 solicitudes**.

#### Reglas Administradas

AWS WAF ofrece conjuntos de reglas administradas preconfigurados que son mantenidos por AWS y vendedores del AWS Marketplace. Estos conjuntos de reglas proporcionan protecci칩n contra amenazas comunes y se actualizan regularmente para abordar nuevas vulnerabilidades.

#### Conjunto de IP

Un Conjunto de IP es una lista de direcciones IP o rangos de direcciones IP que deseas permitir o bloquear. Los conjuntos de IP simplifican el proceso de gesti칩n de reglas basadas en IP.

#### Conjunto de Patrones Regex

Un Conjunto de Patrones Regex contiene una o m치s expresiones regulares (regex) que definen patrones a buscar en las solicitudes web. Esto es 칰til para escenarios de coincidencia m치s complejos, como filtrar secuencias espec칤ficas de caracteres.

#### Token de Bloqueo

Un Token de Bloqueo se utiliza para el control de concurrencia al realizar actualizaciones en los recursos de WAF. Asegura que los cambios no sean sobrescritos accidentalmente por m칰ltiples usuarios o procesos que intentan actualizar el mismo recurso simult치neamente.

#### Claves API

Las Claves API en AWS WAF se utilizan para autenticar solicitudes a ciertas operaciones de API. Estas claves est치n encriptadas y se gestionan de manera segura para controlar el acceso y asegurar que solo los usuarios autorizados puedan realizar cambios en las configuraciones de WAF.

* **Ejemplo**: Integraci칩n de la API de CAPTCHA.

#### Pol칤tica de Permisos

Una Pol칤tica de Permisos es una pol칤tica IAM que especifica qui칠n puede realizar acciones en los recursos de AWS WAF. Al definir permisos, puedes controlar el acceso a los recursos de WAF y asegurar que solo los usuarios autorizados puedan crear, actualizar o eliminar configuraciones.

#### Alcance

El par치metro de alcance en AWS WAF especifica si las reglas y configuraciones de WAF se aplican a una aplicaci칩n regional o a una distribuci칩n de Amazon CloudFront.

* **REGIONAL**: Se aplica a servicios regionales como Application Load Balancers (ALB), Amazon API Gateway REST API, AWS AppSync GraphQL API, grupo de usuarios de Amazon Cognito, servicio AWS App Runner e instancia de AWS Verified Access. Especificas la regi칩n de AWS donde se encuentran estos recursos.
* **CLOUDFRONT**: Se aplica a distribuciones de Amazon CloudFront, que son globales. Las configuraciones de WAF para CloudFront se gestionan a trav칠s de la regi칩n `us-east-1` independientemente de d칩nde se sirva el contenido.

### Caracter칤sticas clave

#### Criterios de Monitoreo (Condiciones)

**Condiciones** especifican los elementos de las solicitudes HTTP/HTTPS entrantes que AWS WAF monitorea, que incluyen XSS, ubicaci칩n geogr치fica (GEO), direcciones IP, restricciones de tama침o, inyecci칩n SQL y patrones (coincidencias de cadenas y regex). Es importante notar que **las solicitudes restringidas a nivel de CloudFront seg칰n el pa칤s no llegar치n a WAF**.

Cada cuenta de AWS puede configurar:

* **100 condiciones** para cada tipo (excepto para Regex, donde solo se permiten **10 condiciones**, pero este l칤mite puede aumentarse).
* **100 reglas** y **50 Web ACLs**.
* Un m치ximo de **5 reglas basadas en tasa**.
* Un rendimiento de **10,000 solicitudes por segundo** cuando WAF se implementa con un balanceador de carga de aplicaciones.

#### Acciones de regla

Las acciones se asignan a cada regla, con opciones que son:

* **Permitir**: La solicitud se reenv칤a a la distribuci칩n de CloudFront o al balanceador de carga de aplicaciones correspondiente.
* **Bloquear**: La solicitud se termina inmediatamente.
* **Contar**: Cuenta las solicitudes que cumplen con las condiciones de la regla. Esto es 칰til para probar la regla, confirmando la precisi칩n de la regla antes de configurarla para Permitir o Bloquear.
* **CAPTCHA y Desaf칤o:** Se verifica que la solicitud no provenga de un bot utilizando acertijos de CAPTCHA y desaf칤os silenciosos.

Si una solicitud no coincide con ninguna regla dentro de la Web ACL, se somete a la **acci칩n predeterminada** (Permitir o Bloquear). El orden de ejecuci칩n de las reglas, definido dentro de una Web ACL, es crucial y t칤picamente sigue esta secuencia:

1. Permitir IPs en la lista blanca.
2. Bloquear IPs en la lista negra.
3. Bloquear solicitudes que coincidan con cualquier firma perjudicial.

#### Integraci칩n con CloudWatch

AWS WAF se integra con CloudWatch para monitoreo, ofreciendo m칠tricas como AllowedRequests, BlockedRequests, CountedRequests y PassedRequests. Estas m칠tricas se informan cada minuto por defecto y se retienen durante un per칤odo de dos semanas.

### Enumeraci칩n

Para interactuar con distribuciones de CloudFront, debes especificar la Regi칩n US East (N. Virginia):

* CLI - Especifica la Regi칩n US East cuando uses el alcance de CloudFront: `--scope CLOUDFRONT --region=us-east-1`.
* API y SDKs - Para todas las llamadas, usa el endpoint de la regi칩n us-east-1.

Para interactuar con servicios regionales, debes especificar la regi칩n:

* Ejemplo con la regi칩n Europa (Espa침a): `--scope REGIONAL --region=eu-south-2`
```bash
# Web ACLs #

## Retrieve a list of web access control lists (Web ACLs) available in your AWS account
aws wafv2 list-web-acls --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve details about the specified Web ACL
aws wafv2 get-web-acl --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

## Retrieve a list of resources associated with a specific web access control list (Web ACL)
aws wafv2 list-resources-for-web-acl --web-acl-arn <value> # Additional permissions needed depending on the protected resource type: cognito-idp:ListResourcesForWebACL, ec2:DescribeVerifiedAccessInstanceWebAclAssociations or apprunner:ListAssociatedServicesForWebAcl
## Retrieve the Web ACL associated with the specified AWS resource
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Additional permissions needed depending on the protected resource type: cognito-idp:GetWebACLForResource, ec2:GetVerifiedAccessInstanceWebAcl, wafv2:GetWebACL or apprunner:DescribeWebAclForService

# Rule groups #

## List of the rule groups available in your AWS account
aws wafv2 list-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the details of a specific rule group
aws wafv2 get-rule-group [--name <value>] [--id <value>] [--arn <value>] [--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>]
## Retrieve the IAM policy attached to the specified rule group
aws wafv2 get-permission-policy --resource-arn <rule-group-arn> # Just the owner of the Rule Group can do this operation

# Managed rule groups (by AWS or by a third-party) #

## List the managed rule groups that are available
aws wafv2 list-available-managed-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## List the available versions of the specified managed rule group
aws wafv2 list-available-managed-rule-group-versions --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about a specific managed rule group
aws wafv2 describe-managed-rule-group --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--version-name <value>]
## Retrieve high-level information about all managed rule groups
aws wafv2 describe-all-managed-products --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about all managed rule groups from a specific vendor
aws wafv2 describe-managed-products-by-vendor --vendor-name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# IP sets #

## List the IP sets that are available in your AWS account
aws wafv2 list-ip-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the specific IP set
aws wafv2 get-ip-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the keys that are currently being managed by a rate-based rule.
aws wafv2 get-rate-based-statement-managed-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>\
--web-acl-name <value> --web-acl-id <value> --rule-name <value> [--rule-group-rule-name <value>]

# Regex pattern sets #

## List all the regex pattern sets that you manage
aws wafv2 list-regex-pattern-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieves the specified regex pattern sets
aws wafv2 get-regex-pattern-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# API Keys #

## List API keys for the specified scope
aws wafv2 list-api-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve decrypted API key
aws wafv2 get-decrypted-api-key --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --api-key <value>

# Logs #

## List of logging configurations (storage location of the logs)
aws wafv2 list-logging-configurations --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--log-scope <value>]
## Retrieve the logging configuration settings associated with a specific web ACL
aws wafv2 get-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]

# Miscelaneous #

## Retrieve a list of the tags associated to the specified resource
aws wafv2 list-tags-for-resource resource-arn <value>

## Retrieve a sample of web requests that match a specified rule within a WebACL during a specified time range
aws wafv2 get-sampled-requests --web-acl-arn <value> --rule-metric-name <value> --time-window <value> --max-items <1-500> --scope <value>

## Obtains the web ACL capacity unit (WCU) requirements for a specified scope and ruleset
aws wafv2 check-capacity --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --rules <value>

## List of available releases for the AWS WAFv2 mobile SDK
aws wafv2 list-mobile-sdk-releases --platform <IOS | ANDROID>
## Retrieves information for the specified mobile SDK release
aws wafv2 get-mobile-sdk-release --platform <value> --release-version <value>

```
### Post Exploitation / Bypass

{% hint style="success" %}
Desde la perspectiva de un atacante, este servicio puede ayudar al atacante a identificar las protecciones de WAF y las exposiciones de red que podr칤an ayudarle a comprometer otras webs.

Sin embargo, un atacante tambi칠n podr칤a estar interesado en interrumpir este servicio para que las webs no est칠n protegidas por el WAF.
{% endhint %}

En muchas de las operaciones de Eliminar y Actualizar ser칤a necesario proporcionar el **token de bloqueo**. Este token se utiliza para el control de concurrencia sobre los recursos, asegurando que los cambios no sean sobrescritos accidentalmente por m칰ltiples usuarios o procesos que intentan actualizar el mismo recurso simult치neamente. Para obtener este token, podr칤as realizar las operaciones correspondientes de **listar** o **obtener** sobre el recurso espec칤fico.

#### **`wafv2:CreateRuleGroup`, `wafv2:UpdateRuleGroup`, `wafv2:DeleteRuleGroup`**

Un atacante podr칤a comprometer la seguridad del recurso afectado al:

* Crear grupos de reglas que podr칤an, por ejemplo, bloquear tr치fico leg칤timo de direcciones IP leg칤timas, causando una denegaci칩n de servicio.
* Actualizar grupos de reglas, pudiendo modificar sus acciones, por ejemplo, de **Bloquear** a **Permitir**.
* Eliminar grupos de reglas que proporcionan medidas de seguridad cr칤ticas.
```bash
# Create Rule Group
aws wafv2 create-rule-group --name <value> --capacity <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Update Rule Group
aws wafv2 update-rule-group --name <value> --id <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Delete Rule Group
aws wafv2 delete-rule-group --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Los siguientes ejemplos muestran un grupo de reglas que bloquear칤a el tr치fico leg칤timo de direcciones IP espec칤ficas:
```bash
aws wafv2 create-rule-group --name BlockLegitimateIPsRuleGroup --capacity 1 --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=BlockLegitimateIPsRuleGroup --scope CLOUDFRONT --region us-east-1 --rules file://rule.json
```
El archivo **rule.json** se ver칤a as칤:
```json
[
{
"Name":"BlockLegitimateIPsRule",
"Priority":0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:global/ipset/legitIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action":{
"Block":{}
},
"VisibilityConfig":{
"SampledRequestsEnabled":false,
"CloudWatchMetricsEnabled":false,
"MetricName":"BlockLegitimateIPsRule"
}
}
]
```
**Impacto Potencial**: Acceso no autorizado, filtraciones de datos y posibles ataques DoS.

#### **`wafv2:CreateWebACL`, `wafv2:UpdateWebACL`, `wafv2:DeleteWebACL`**

Con estos permisos, un atacante podr칤a:

* Crear un nuevo Web ACL, introduciendo reglas que permitan el tr치fico malicioso o bloqueen el tr치fico leg칤timo, haciendo que el WAF sea in칰til o causando una denegaci칩n de servicio.
* Actualizar Web ACLs existentes, pudiendo modificar reglas para permitir ataques como inyecci칩n SQL o scripting entre sitios, que anteriormente estaban bloqueados, o interrumpir el flujo normal de tr치fico bloqueando solicitudes v치lidas.
* Eliminar un Web ACL, dejando los recursos afectados completamente desprotegidos, exponi칠ndolos a una amplia gama de ataques web.

{% hint style="info" %}
Solo puedes eliminar el **WebACL** especificado si **ManagedByFirewallManager** es falso.
{% endhint %}
```bash
# Create Web ACL
aws wafv2 create-web-acl --name <value> --default-action <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Update Web ACL
aws wafv2 update-web-acl --name <value> --id <value> --default-action <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Delete Web ACL
aws wafv2 delete-web-acl --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Los siguientes ejemplos muestran c칩mo actualizar un Web ACL para bloquear el tr치fico leg칤timo de un conjunto de IP espec칤fico. Si la IP de origen no coincide con ninguna de esas IP, la acci칩n predeterminada tambi칠n ser칤a bloquearla, causando un DoS.

**Web ACL original**:
```json
{
"WebACL": {
"Name": "AllowLegitimateIPsWebACL",
"Id": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/AllowLegitimateIPsWebACL/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"DefaultAction": {
"Allow": {}
},
"Description": "",
"Rules": [
{
"Name": "AllowLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Allow": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsRule"
}
}
],
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsWebACL"
},
"Capacity": 1,
"ManagedByFirewallManager": false,
"LabelNamespace": "awswaf:123456789012:webacl:AllowLegitimateIPsWebACL:"
},
"LockToken": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}

```
Comando para actualizar el Web ACL:
```json
aws wafv2 update-web-acl --name AllowLegitimateIPsWebACL --scope REGIONAL --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --default-action Block={} --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=AllowLegitimateIPsWebACL --rules file://rule.json --region us-east-1
```
El archivo **rule.json** se ver칤a as칤:
```json
[
{
"Name": "BlockLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Block": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "BlockLegitimateIPRule"
}
}
]
```
**Impacto Potencial**: Acceso no autorizado, filtraciones de datos y posibles ataques DoS.

#### **`wafv2:AssociateWebACL`, `wafv2:DisassociateWebACL`**

El permiso **`wafv2:AssociateWebACL`** permitir칤a a un atacante asociar ACLs web (Listas de Control de Acceso) con recursos, pudiendo eludir controles de seguridad, permitiendo que tr치fico no autorizado llegue a la aplicaci칩n, lo que podr칤a llevar a explotaciones como inyecci칩n SQL o scripting entre sitios (XSS). Por el contrario, con el permiso **`wafv2:DisassociateWebACL`**, el atacante podr칤a deshabilitar temporalmente las protecciones de seguridad, exponiendo los recursos a vulnerabilidades sin detecci칩n.

Se necesitar칤an permisos adicionales dependiendo del tipo de recurso protegido:

* **Asociar**
* apigateway:SetWebACL
* apprunner:AssociateWebAcl
* appsync:SetWebACL
* cognito-idp:AssociateWebACL
* ec2:AssociateVerifiedAccessInstanceWebAcl
* elasticloadbalancing:SetWebAcl
* **Desasociar**
* apigateway:SetWebACL
* apprunner:DisassociateWebAcl
* appsync:SetWebACL
* cognito-idp:DisassociateWebACL
* ec2:DisassociateVerifiedAccessInstanceWebAcl
* elasticloadbalancing:SetWebAcl
```bash
# Associate
aws wafv2 associate-web-acl --web-acl-arn <value> --resource-arn <value>
# Disassociate
aws wafv2 disassociate-web-acl --resource-arn <value>
```
**Impacto Potencial**: Compromiso de la seguridad de los recursos, aumento del riesgo de explotaci칩n y posibles interrupciones del servicio dentro de los entornos de AWS protegidos por AWS WAF.

#### **`wafv2:CreateIPSet` , `wafv2:UpdateIPSet`, `wafv2:DeleteIPSet`**

Un atacante podr칤a crear, actualizar y eliminar los conjuntos de IP gestionados por AWS WAF. Esto podr칤a ser peligroso ya que podr칤a crear nuevos conjuntos de IP para permitir tr치fico malicioso, modificar conjuntos de IP para bloquear tr치fico leg칤timo, actualizar conjuntos de IP existentes para incluir direcciones IP maliciosas, eliminar direcciones IP de confianza o eliminar conjuntos de IP cr칤ticos que est치n destinados a proteger recursos cr칤ticos.
```bash
# Create IP set
aws wafv2 create-ip-set --name <value> --ip-address-version <IPV4 | IPV6> --addresses <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Update IP set
aws wafv2 update-ip-set --name <value> --id <value> --addresses <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete IP set
aws wafv2 delete-ip-set --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
El siguiente ejemplo muestra c칩mo **sobrescribir el conjunto de IP existente por el conjunto de IP deseado**:
```bash
aws wafv2 update-ip-set --name LegitimateIPv4Set --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --addresses 99.99.99.99/32 --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --scope CLOUDFRONT --region us-east-1
```
**Impacto Potencial**: Acceso no autorizado y bloqueo de tr치fico leg칤timo.

#### **`wafv2:CreateRegexPatternSet`** , **`wafv2:UpdateRegexPatternSet`**, **`wafv2:DeleteRegexPatternSet`**

Un atacante con estos permisos podr칤a manipular los conjuntos de patrones de expresiones regulares utilizados por AWS WAF para controlar y filtrar el tr치fico entrante basado en patrones espec칤ficos.

* Crear nuevos patrones regex ayudar칤a a un atacante a permitir contenido da침ino
* Al actualizar los patrones existentes, un atacante podr칤a eludir las reglas de seguridad
* Eliminar patrones dise침ados para bloquear actividades maliciosas podr칤a permitir a un atacante enviar cargas 칰tiles maliciosas y eludir las medidas de seguridad.
```bash
# Create regex pattern set
aws wafv2 create-regex-pattern-set --name <value> --regular-expression-list <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--description <value>]
# Update regex pattern set
aws wafv2 update-regex-pattern-set --name <value> --id <value> --regular-expression-list <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete regex pattern set
aws wafv2 delete-regex-pattern-set --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --id <value> --lock-token <value>
```
**Impacto Potencial**: Eludir controles de seguridad, permitiendo contenido malicioso y potencialmente exponiendo datos sensibles o interrumpiendo servicios y recursos protegidos por AWS WAF.

#### **(`wavf2:PutLoggingConfiguration` &** `iam:CreateServiceLinkedRole`), **`wafv2:DeleteLoggingConfiguration`**

Un atacante con el **`wafv2:DeleteLoggingConfiguration`** podr칤a eliminar la configuraci칩n de registro del Web ACL especificado. Posteriormente, con los permisos **`wavf2:PutLoggingConfiguration`** y **`iam:CreateServiceLinkedRole`**, un atacante podr칤a crear o reemplazar configuraciones de registro (despu칠s de haberla eliminado) para evitar el registro por completo o redirigir los registros a destinos no autorizados, como buckets de Amazon S3, grupos de logs de Amazon CloudWatch Logs o un Amazon Kinesis Data Firehose bajo control.

Durante el proceso de creaci칩n, el servicio configura autom치ticamente los permisos necesarios para permitir que los registros se escriban en el destino de registro especificado:

* **Amazon CloudWatch Logs:** AWS WAF crea una pol칤tica de recursos en el grupo de logs de CloudWatch Logs designado. Esta pol칤tica asegura que AWS WAF tenga los permisos requeridos para escribir registros en el grupo de logs.
* **Amazon S3 Bucket:** AWS WAF crea una pol칤tica de bucket en el bucket de S3 designado. Esta pol칤tica otorga a AWS WAF los permisos necesarios para subir registros al bucket especificado.
* **Amazon Kinesis Data Firehose:** AWS WAF crea un rol vinculado al servicio espec칤ficamente para interactuar con Kinesis Data Firehose. Este rol permite a AWS WAF entregar registros al stream de Firehose configurado.

{% hint style="info" %}
Es posible definir solo un destino de registro por web ACL.
{% endhint %}
```bash
# Put logging configuration
aws wafv2 put-logging-configuration --logging-configuration <value>
# Delete logging configuration
aws wafv2 delete-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]
```
**Impacto Potencial:** Visibilidad oscurecida en eventos de seguridad, dificultando el proceso de respuesta a incidentes y facilitando actividades maliciosas encubiertas dentro de entornos protegidos por AWS WAF.

#### **`wafv2:DeleteAPIKey`**

Un atacante con estos permisos podr칤a eliminar claves API existentes, haciendo que el CAPTCHA sea ineficaz y interrumpiendo la funcionalidad que depende de 칠l, como env칤os de formularios y controles de acceso. Dependiendo de la implementaci칩n de este CAPTCHA, esto podr칤a llevar a un bypass de CAPTCHA o a un DoS si la gesti칩n de errores no est치 configurada correctamente en el recurso.
```bash
# Delete API key
aws wafv2 delete-api-key --api-key <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Impacto Potencial**: Deshabilitar las protecciones CAPTCHA o interrumpir la funcionalidad de la aplicaci칩n, lo que lleva a brechas de seguridad y posible robo de datos.

#### **`wafv2:TagResource`, `wafv2:UntagResource`**

Un atacante podr칤a agregar, modificar o eliminar etiquetas de los recursos de AWS WAFv2, como ACLs web, grupos de reglas, conjuntos de IP, conjuntos de patrones regex y configuraciones de registro.
```bash
# Tag
aws wafv2 tag-resource --resource-arn <value> --tags <value>
# Untag
aws wafv2 untag-resource --resource-arn <value> --tag-keys <value>
```
**Impacto Potencial**: Manipulaci칩n de recursos, filtraci칩n de informaci칩n, manipulaci칩n de costos y interrupci칩n operativa.

## Referencias

* [https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:\~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application](https://www.citrusconsulting.com/aws-web-application-firewall-waf/)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awswafv2.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awswafv2.html)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
