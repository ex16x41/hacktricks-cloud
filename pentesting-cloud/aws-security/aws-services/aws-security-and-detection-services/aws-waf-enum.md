# AWS - WAF Enum

## AWS - WAF Enum

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## AWS WAF

AWS WAF est un **pare-feu d'application web** con√ßu pour **prot√©ger les applications web ou les API** contre diverses exploitations web qui peuvent affecter leur disponibilit√©, s√©curit√© ou consommation de ressources. Il permet aux utilisateurs de contr√¥ler le trafic entrant en configurant des **r√®gles de s√©curit√©** qui att√©nuent les vecteurs d'attaque typiques comme l'injection SQL ou le cross-site scripting et en d√©finissant √©galement des r√®gles de filtrage personnalis√©es.

### Concepts cl√©s

#### Web ACL (Liste de Contr√¥le d'Acc√®s)

Une Web ACL est un ensemble de r√®gles que vous pouvez appliquer √† vos applications web ou API. Lorsque vous associez une Web ACL √† une ressource, AWS WAF inspecte les requ√™tes entrantes en fonction des r√®gles d√©finies dans la Web ACL et prend les actions sp√©cifi√©es.

#### Groupe de R√®gles

Un Groupe de R√®gles est une collection r√©utilisable de r√®gles que vous pouvez appliquer √† plusieurs Web ACL. Les groupes de r√®gles aident √† g√©rer et √† maintenir des ensembles de r√®gles coh√©rents √† travers diff√©rentes applications web ou API.

Chaque groupe de r√®gles a sa **capacit√©** associ√©e, qui aide √† calculer et √† contr√¥ler les ressources op√©rationnelles utilis√©es pour ex√©cuter vos r√®gles, groupes de r√®gles et Web ACL. Une fois sa valeur d√©finie lors de la cr√©ation, il n'est pas possible de la modifier.

#### R√®gle

Une r√®gle d√©finit un ensemble de conditions que AWS WAF utilise pour inspecter les requ√™tes web entrantes. Il existe deux types principaux de r√®gles :

1. **R√®gle R√©guli√®re** : Ce type de r√®gle utilise des conditions sp√©cifi√©es pour d√©terminer s'il faut autoriser, bloquer ou compter les requ√™tes web.
2. **R√®gle Bas√©e sur le Taux** : Compte les requ√™tes provenant d'une adresse IP sp√©cifique sur une p√©riode de cinq minutes. Ici, les utilisateurs d√©finissent un seuil, et si le nombre de requ√™tes d'une IP d√©passe cette limite dans les cinq minutes, les requ√™tes suivantes de cette IP sont bloqu√©es jusqu'√† ce que le taux de requ√™tes tombe en dessous du seuil. Le seuil minimum pour les r√®gles bas√©es sur le taux est de **2000 requ√™tes**.

#### R√®gles G√©r√©es

AWS WAF propose des ensembles de r√®gles g√©r√©s pr√©configur√©s qui sont maintenus par AWS et les vendeurs du march√© AWS. Ces ensembles de r√®gles offrent une protection contre les menaces courantes et sont r√©guli√®rement mis √† jour pour traiter de nouvelles vuln√©rabilit√©s.

#### Ensemble d'IP

Un Ensemble d'IP est une liste d'adresses IP ou de plages d'adresses IP que vous souhaitez autoriser ou bloquer. Les ensembles d'IP simplifient le processus de gestion des r√®gles bas√©es sur les IP.

#### Ensemble de Mod√®les Regex

Un Ensemble de Mod√®les Regex contient une ou plusieurs expressions r√©guli√®res (regex) qui d√©finissent des motifs √† rechercher dans les requ√™tes web. Cela est utile pour des sc√©narios de correspondance plus complexes, tels que le filtrage de s√©quences sp√©cifiques de caract√®res.

#### Jeton de Verrouillage

Un Jeton de Verrouillage est utilis√© pour le contr√¥le de la concurrence lors de la mise √† jour des ressources WAF. Il garantit que les modifications ne sont pas accidentellement √©cras√©es par plusieurs utilisateurs ou processus tentant de mettre √† jour la m√™me ressource simultan√©ment.

#### Cl√©s API

Les Cl√©s API dans AWS WAF sont utilis√©es pour authentifier les requ√™tes √† certaines op√©rations API. Ces cl√©s sont crypt√©es et g√©r√©es de mani√®re s√©curis√©e pour contr√¥ler l'acc√®s et garantir que seuls les utilisateurs autoris√©s peuvent apporter des modifications aux configurations WAF.

* **Exemple** : Int√©gration de l'API CAPTCHA.

#### Politique de Permission

Une Politique de Permission est une politique IAM qui sp√©cifie qui peut effectuer des actions sur les ressources AWS WAF. En d√©finissant des permissions, vous pouvez contr√¥ler l'acc√®s aux ressources WAF et garantir que seuls les utilisateurs autoris√©s peuvent cr√©er, mettre √† jour ou supprimer des configurations.

#### Port√©e

Le param√®tre de port√©e dans AWS WAF sp√©cifie si les r√®gles et configurations WAF s'appliquent √† une application r√©gionale ou √† une distribution Amazon CloudFront.

* **R√âGIONAL** : S'applique aux services r√©gionaux tels que les √©quilibreurs de charge d'application (ALB), l'API REST d'Amazon API Gateway, l'API GraphQL AWS AppSync, le pool d'utilisateurs Amazon Cognito, le service AWS App Runner et l'instance AWS Verified Access. Vous sp√©cifiez la r√©gion AWS o√π ces ressources sont situ√©es.
* **CLOUDFRONT** : S'applique aux distributions Amazon CloudFront, qui sont globales. Les configurations WAF pour CloudFront sont g√©r√©es via la r√©gion `us-east-1` ind√©pendamment de l'endroit o√π le contenu est servi.

### Fonctionnalit√©s cl√©s

#### Crit√®res de Surveillance (Conditions)

**Conditions** sp√©cifient les √©l√©ments des requ√™tes HTTP/HTTPS entrantes que AWS WAF surveille, qui incluent XSS, localisation g√©ographique (GEO), adresses IP, contraintes de taille, injection SQL et motifs (correspondance de cha√Ænes et regex). Il est important de noter que **les requ√™tes restreintes au niveau de CloudFront en fonction du pays n'atteindront pas WAF**.

Chaque compte AWS peut configurer :

* **100 conditions** pour chaque type (sauf pour Regex, o√π seules **10 conditions** sont autoris√©es, mais cette limite peut √™tre augment√©e).
* **100 r√®gles** et **50 Web ACLs**.
* Un maximum de **5 r√®gles bas√©es sur le taux**.
* Un d√©bit de **10 000 requ√™tes par seconde** lorsque WAF est mis en ≈ìuvre avec un √©quilibreur de charge d'application.

#### Actions de R√®gle

Des actions sont assign√©es √† chaque r√®gle, avec les options suivantes :

* **Autoriser** : La requ√™te est transmise √† la distribution CloudFront appropri√©e ou √† l'√©quilibreur de charge d'application.
* **Bloquer** : La requ√™te est imm√©diatement termin√©e.
* **Compter** : Compte les requ√™tes r√©pondant aux conditions de la r√®gle. Cela est utile pour tester la r√®gle, confirmant l'exactitude de la r√®gle avant de la d√©finir sur Autoriser ou Bloquer.
* **CAPTCHA et Challenge :** Il est v√©rifi√© que la requ√™te ne provient pas d'un bot √† l'aide de puzzles CAPTCHA et de d√©fis silencieux.

Si une requ√™te ne correspond √† aucune r√®gle dans la Web ACL, elle subit l'**action par d√©faut** (Autoriser ou Bloquer). L'ordre d'ex√©cution des r√®gles, d√©fini dans une Web ACL, est crucial et suit g√©n√©ralement cette s√©quence :

1. Autoriser les IPs sur liste blanche.
2. Bloquer les IPs sur liste noire.
3. Bloquer les requ√™tes correspondant √† des signatures nuisibles.

#### Int√©gration CloudWatch

AWS WAF s'int√®gre √† CloudWatch pour la surveillance, offrant des m√©triques telles que AllowedRequests, BlockedRequests, CountedRequests et PassedRequests. Ces m√©triques sont rapport√©es chaque minute par d√©faut et conserv√©es pendant une p√©riode de deux semaines.

### √ânum√©ration

Pour interagir avec les distributions CloudFront, vous devez sp√©cifier la r√©gion US East (N. Virginia) :

* CLI - Sp√©cifiez la r√©gion US East lorsque vous utilisez la port√©e CloudFront : `--scope CLOUDFRONT --region=us-east-1`.
* API et SDKs - Pour tous les appels, utilisez le point de terminaison de la r√©gion us-east-1.

Pour interagir avec les services r√©gionaux, vous devez sp√©cifier la r√©gion :

* Exemple avec la r√©gion Europe (Espagne) : `--scope REGIONAL --region=eu-south-2`
```bash
# Web ACLs #

## Retrieve a list of web access control lists (Web ACLs) available in your AWS account
aws wafv2 list-web-acls --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve details about the specified Web ACL
aws wafv2 get-web-acl --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

## Retrieve a list of resources associated with a specific web access control list (Web ACL)
aws wafv2 list-resources-for-web-acl --web-acl-arn <value> # Additional permissions needed depending on the protected resource type: cognito-idp:ListResourcesForWebACL, ec2:DescribeVerifiedAccessInstanceWebAclAssociations or apprunner:ListAssociatedServicesForWebAcl
## Retrieve the Web ACL associated with the specified AWS resource
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Additional permissions needed depending on the protected resource type: cognito-idp:GetWebACLForResource, ec2:GetVerifiedAccessInstanceWebAcl, wafv2:GetWebACL or apprunner:DescribeWebAclForService

# Rule groups #

## List of the rule groups available in your AWS account
aws wafv2 list-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the details of a specific rule group
aws wafv2 get-rule-group [--name <value>] [--id <value>] [--arn <value>] [--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>]
## Retrieve the IAM policy attached to the specified rule group
aws wafv2 get-permission-policy --resource-arn <rule-group-arn> # Just the owner of the Rule Group can do this operation

# Managed rule groups (by AWS or by a third-party) #

## List the managed rule groups that are available
aws wafv2 list-available-managed-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## List the available versions of the specified managed rule group
aws wafv2 list-available-managed-rule-group-versions --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about a specific managed rule group
aws wafv2 describe-managed-rule-group --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--version-name <value>]
## Retrieve high-level information about all managed rule groups
aws wafv2 describe-all-managed-products --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about all managed rule groups from a specific vendor
aws wafv2 describe-managed-products-by-vendor --vendor-name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# IP sets #

## List the IP sets that are available in your AWS account
aws wafv2 list-ip-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the specific IP set
aws wafv2 get-ip-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the keys that are currently being managed by a rate-based rule.
aws wafv2 get-rate-based-statement-managed-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>\
--web-acl-name <value> --web-acl-id <value> --rule-name <value> [--rule-group-rule-name <value>]

# Regex pattern sets #

## List all the regex pattern sets that you manage
aws wafv2 list-regex-pattern-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieves the specified regex pattern sets
aws wafv2 get-regex-pattern-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# API Keys #

## List API keys for the specified scope
aws wafv2 list-api-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve decrypted API key
aws wafv2 get-decrypted-api-key --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --api-key <value>

# Logs #

## List of logging configurations (storage location of the logs)
aws wafv2 list-logging-configurations --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--log-scope <value>]
## Retrieve the logging configuration settings associated with a specific web ACL
aws wafv2 get-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]

# Miscelaneous #

## Retrieve a list of the tags associated to the specified resource
aws wafv2 list-tags-for-resource resource-arn <value>

## Retrieve a sample of web requests that match a specified rule within a WebACL during a specified time range
aws wafv2 get-sampled-requests --web-acl-arn <value> --rule-metric-name <value> --time-window <value> --max-items <1-500> --scope <value>

## Obtains the web ACL capacity unit (WCU) requirements for a specified scope and ruleset
aws wafv2 check-capacity --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --rules <value>

## List of available releases for the AWS WAFv2 mobile SDK
aws wafv2 list-mobile-sdk-releases --platform <IOS | ANDROID>
## Retrieves information for the specified mobile SDK release
aws wafv2 get-mobile-sdk-release --platform <value> --release-version <value>

```
### Post Exploitation / Bypass

{% hint style="success" %}
Du point de vue d'un attaquant, ce service peut aider l'attaquant √† identifier les protections WAF et les expositions r√©seau qui pourraient l'aider √† compromettre d'autres sites web.

Cependant, un attaquant pourrait √©galement √™tre int√©ress√© √† perturber ce service afin que les sites ne soient pas prot√©g√©s par le WAF.
{% endhint %}

Dans de nombreuses op√©rations de suppression et de mise √† jour, il serait n√©cessaire de fournir le **token de verrouillage**. Ce token est utilis√© pour le contr√¥le de la concurrence sur les ressources, garantissant que les modifications ne sont pas accidentellement √©cras√©es par plusieurs utilisateurs ou processus tentant de mettre √† jour la m√™me ressource simultan√©ment. Afin d'obtenir ce token, vous pourriez effectuer les op√©rations **list** ou **get** correspondantes sur la ressource sp√©cifique.

#### **`wafv2:CreateRuleGroup`, `wafv2:UpdateRuleGroup`, `wafv2:DeleteRuleGroup`**

Un attaquant serait en mesure de compromettre la s√©curit√© de la ressource affect√©e en :

* Cr√©ant des groupes de r√®gles qui pourraient, par exemple, bloquer le trafic l√©gitime provenant d'adresses IP l√©gitimes, provoquant une d√©ni de service.
* Mettant √† jour des groupes de r√®gles, pouvant modifier ses actions par exemple de **Block** √† **Allow**.
* Supprimant des groupes de r√®gles qui fournissent des mesures de s√©curit√© critiques.
```bash
# Create Rule Group
aws wafv2 create-rule-group --name <value> --capacity <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Update Rule Group
aws wafv2 update-rule-group --name <value> --id <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Delete Rule Group
aws wafv2 delete-rule-group --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Les exemples suivants montrent un groupe de r√®gles qui bloquerait le trafic l√©gitime provenant d'adresses IP sp√©cifiques :
```bash
aws wafv2 create-rule-group --name BlockLegitimateIPsRuleGroup --capacity 1 --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=BlockLegitimateIPsRuleGroup --scope CLOUDFRONT --region us-east-1 --rules file://rule.json
```
Le fichier **rule.json** ressemblerait √† :
```json
[
{
"Name":"BlockLegitimateIPsRule",
"Priority":0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:global/ipset/legitIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action":{
"Block":{}
},
"VisibilityConfig":{
"SampledRequestsEnabled":false,
"CloudWatchMetricsEnabled":false,
"MetricName":"BlockLegitimateIPsRule"
}
}
]
```
**Impact potentiel** : Acc√®s non autoris√©, violations de donn√©es et attaques potentielles par d√©ni de service.

#### **`wafv2:CreateWebACL`, `wafv2:UpdateWebACL`, `wafv2:DeleteWebACL`**

Avec ces autorisations, un attaquant pourrait :

* Cr√©er un nouveau Web ACL, introduisant des r√®gles qui permettent soit le passage de trafic malveillant, soit le blocage de trafic l√©gitime, rendant ainsi le WAF inutile ou provoquant un d√©ni de service.
* Mettre √† jour des Web ACL existants, pouvant modifier des r√®gles pour permettre des attaques telles que l'injection SQL ou le scripting intersite, qui √©taient auparavant bloqu√©es, ou perturber le flux de trafic normal en bloquant des requ√™tes valides.
* Supprimer un Web ACL, laissant les ressources affect√©es enti√®rement non prot√©g√©es, les exposant √† un large √©ventail d'attaques web.

{% hint style="info" %}
Vous ne pouvez supprimer le **WebACL** sp√©cifi√© que si **ManagedByFirewallManager** est faux.
{% endhint %}
```bash
# Create Web ACL
aws wafv2 create-web-acl --name <value> --default-action <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Update Web ACL
aws wafv2 update-web-acl --name <value> --id <value> --default-action <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Delete Web ACL
aws wafv2 delete-web-acl --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Les exemples suivants montrent comment mettre √† jour un Web ACL pour bloquer le trafic l√©gitime d'un ensemble d'IP sp√©cifique. Si l'IP d'origine ne correspond √† aucune de ces IP, l'action par d√©faut serait √©galement de le bloquer, provoquant un DoS.

**Web ACL d'origine**:
```json
{
"WebACL": {
"Name": "AllowLegitimateIPsWebACL",
"Id": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/AllowLegitimateIPsWebACL/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"DefaultAction": {
"Allow": {}
},
"Description": "",
"Rules": [
{
"Name": "AllowLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Allow": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsRule"
}
}
],
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsWebACL"
},
"Capacity": 1,
"ManagedByFirewallManager": false,
"LabelNamespace": "awswaf:123456789012:webacl:AllowLegitimateIPsWebACL:"
},
"LockToken": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}

```
Commande pour mettre √† jour le Web ACL :
```json
aws wafv2 update-web-acl --name AllowLegitimateIPsWebACL --scope REGIONAL --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --default-action Block={} --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=AllowLegitimateIPsWebACL --rules file://rule.json --region us-east-1
```
Le fichier **rule.json** ressemblerait √† :
```json
[
{
"Name": "BlockLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Block": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "BlockLegitimateIPRule"
}
}
]
```
**Impact potentiel** : Acc√®s non autoris√©, violations de donn√©es et attaques potentielles par d√©ni de service (DoS).

#### **`wafv2:AssociateWebACL`, `wafv2:DisassociateWebACL`**

La permission **`wafv2:AssociateWebACL`** permettrait √† un attaquant d'associer des ACL web (Listes de Contr√¥le d'Acc√®s) avec des ressources, pouvant contourner les contr√¥les de s√©curit√©, permettant √† un trafic non autoris√© d'atteindre l'application, ce qui pourrait conduire √† des exploits comme l'injection SQL ou le cross-site scripting (XSS). Inversement, avec la permission **`wafv2:DisassociateWebACL`**, l'attaquant pourrait d√©sactiver temporairement les protections de s√©curit√©, exposant les ressources √† des vuln√©rabilit√©s sans d√©tection.

Des permissions suppl√©mentaires seraient n√©cessaires en fonction du type de ressource prot√©g√©e :

* **Associer**
* apigateway:SetWebACL
* apprunner:AssociateWebAcl
* appsync:SetWebACL
* cognito-idp:AssociateWebACL
* ec2:AssociateVerifiedAccessInstanceWebAcl
* elasticloadbalancing:SetWebAcl
* **Dissocier**
* apigateway:SetWebACL
* apprunner:DisassociateWebAcl
* appsync:SetWebACL
* cognito-idp:DisassociateWebACL
* ec2:DisassociateVerifiedAccessInstanceWebAcl
* elasticloadbalancing:SetWebAcl
```bash
# Associate
aws wafv2 associate-web-acl --web-acl-arn <value> --resource-arn <value>
# Disassociate
aws wafv2 disassociate-web-acl --resource-arn <value>
```
**Impact potentiel** : S√©curit√© des ressources compromises, risque accru d'exploitation et interruptions potentielles de service au sein des environnements AWS prot√©g√©s par AWS WAF.

#### **`wafv2:CreateIPSet` , `wafv2:UpdateIPSet`, `wafv2:DeleteIPSet`**

Un attaquant pourrait cr√©er, mettre √† jour et supprimer les ensembles d'IP g√©r√©s par AWS WAF. Cela pourrait √™tre dangereux car il pourrait cr√©er de nouveaux ensembles d'IP pour autoriser le trafic malveillant, modifier des ensembles d'IP afin de bloquer le trafic l√©gitime, mettre √† jour des ensembles d'IP existants pour inclure des adresses IP malveillantes, supprimer des adresses IP de confiance ou supprimer des ensembles d'IP critiques destin√©s √† prot√©ger des ressources critiques.
```bash
# Create IP set
aws wafv2 create-ip-set --name <value> --ip-address-version <IPV4 | IPV6> --addresses <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Update IP set
aws wafv2 update-ip-set --name <value> --id <value> --addresses <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete IP set
aws wafv2 delete-ip-set --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
L'exemple suivant montre comment **√©craser l'ensemble d'IP existant par l'ensemble d'IP souhait√©** :
```bash
aws wafv2 update-ip-set --name LegitimateIPv4Set --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --addresses 99.99.99.99/32 --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --scope CLOUDFRONT --region us-east-1
```
**Impact potentiel** : Acc√®s non autoris√© et blocage du trafic l√©gitime.

#### **`wafv2:CreateRegexPatternSet`** , **`wafv2:UpdateRegexPatternSet`**, **`wafv2:DeleteRegexPatternSet`**

Un attaquant disposant de ces autorisations pourrait manipuler les ensembles de motifs d'expressions r√©guli√®res utilis√©s par AWS WAF pour contr√¥ler et filtrer le trafic entrant en fonction de motifs sp√©cifiques.

* La cr√©ation de nouveaux motifs regex aiderait un attaquant √† autoriser du contenu nuisible
* En mettant √† jour les motifs existants, un attaquant pourrait contourner les r√®gles de s√©curit√©
* La suppression de motifs con√ßus pour bloquer les activit√©s malveillantes pourrait permettre √† un attaquant d'envoyer des charges utiles malveillantes et de contourner les mesures de s√©curit√©.
```bash
# Create regex pattern set
aws wafv2 create-regex-pattern-set --name <value> --regular-expression-list <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--description <value>]
# Update regex pattern set
aws wafv2 update-regex-pattern-set --name <value> --id <value> --regular-expression-list <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete regex pattern set
aws wafv2 delete-regex-pattern-set --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --id <value> --lock-token <value>
```
**Impact potentiel** : Contourner les contr√¥les de s√©curit√©, permettant √† un contenu malveillant de passer et exposant potentiellement des donn√©es sensibles ou perturbant les services et ressources prot√©g√©s par AWS WAF.

#### **(`wavf2:PutLoggingConfiguration` &** `iam:CreateServiceLinkedRole`), **`wafv2:DeleteLoggingConfiguration`**

Un attaquant avec le **`wafv2:DeleteLoggingConfiguration`** serait capable de supprimer la configuration de journalisation de l'ACL Web sp√©cifi√©. Par la suite, avec les permissions **`wavf2:PutLoggingConfiguration`** et **`iam:CreateServiceLinkedRole`**, un attaquant pourrait cr√©er ou remplacer des configurations de journalisation (apr√®s l'avoir supprim√©e) pour soit emp√™cher compl√®tement la journalisation, soit rediriger les journaux vers des destinations non autoris√©es, telles que des buckets Amazon S3, un groupe de journaux Amazon CloudWatch Logs ou un Amazon Kinesis Data Firehose sous contr√¥le.

Lors du processus de cr√©ation, le service configure automatiquement les permissions n√©cessaires pour permettre l'√©criture des journaux √† la destination de journalisation sp√©cifi√©e :

* **Amazon CloudWatch Logs :** AWS WAF cr√©e une politique de ressource sur le groupe de journaux CloudWatch Logs d√©sign√©. Cette politique garantit qu'AWS WAF dispose des permissions requises pour √©crire des journaux dans le groupe de journaux.
* **Bucket Amazon S3 :** AWS WAF cr√©e une politique de bucket sur le bucket S3 d√©sign√©. Cette politique accorde √† AWS WAF les permissions n√©cessaires pour t√©l√©charger des journaux dans le bucket sp√©cifi√©.
* **Amazon Kinesis Data Firehose :** AWS WAF cr√©e un r√¥le li√© au service sp√©cifiquement pour interagir avec Kinesis Data Firehose. Ce r√¥le permet √† AWS WAF de livrer des journaux au flux Firehose configur√©.

{% hint style="info" %}
Il est possible de d√©finir une seule destination de journalisation par ACL Web.
{% endhint %}
```bash
# Put logging configuration
aws wafv2 put-logging-configuration --logging-configuration <value>
# Delete logging configuration
aws wafv2 delete-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]
```
**Impact potentiel :** Obscurcir la visibilit√© sur les √©v√©nements de s√©curit√©, rendre le processus de r√©ponse aux incidents difficile et faciliter des activit√©s malveillantes discr√®tes au sein des environnements prot√©g√©s par AWS WAF.

#### **`wafv2:DeleteAPIKey`**

Un attaquant avec ces permissions serait capable de supprimer des cl√©s API existantes, rendant le CAPTCHA inefficace et perturbant la fonctionnalit√© qui en d√©pend, comme les soumissions de formulaires et les contr√¥les d'acc√®s. Selon l'impl√©mentation de ce CAPTCHA, cela pourrait conduire soit √† un contournement du CAPTCHA, soit √† un DoS si la gestion des erreurs n'est pas correctement configur√©e dans la ressource.
```bash
# Delete API key
aws wafv2 delete-api-key --api-key <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Impact potentiel** : D√©sactiver les protections CAPTCHA ou perturber la fonctionnalit√© de l'application, entra√Ænant des violations de s√©curit√© et un vol potentiel de donn√©es.

#### **`wafv2:TagResource`, `wafv2:UntagResource`**

Un attaquant pourrait ajouter, modifier ou supprimer des balises des ressources AWS WAFv2, telles que les ACL Web, les groupes de r√®gles, les ensembles d'IP, les ensembles de motifs regex et les configurations de journalisation.
```bash
# Tag
aws wafv2 tag-resource --resource-arn <value> --tags <value>
# Untag
aws wafv2 untag-resource --resource-arn <value> --tag-keys <value>
```
**Impact potentiel** : Manipulation des ressources, fuite d'informations, manipulation des co√ªts et perturbation op√©rationnelle.

## R√©f√©rences

* [https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:\~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application](https://www.citrusconsulting.com/aws-web-application-firewall-waf/)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awswafv2.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awswafv2.html)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
