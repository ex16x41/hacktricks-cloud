# AWS - WAF Enum

## AWS - WAF Enum

{% hint style="success" %}
Ucz si i wicz AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## AWS WAF

AWS WAF to **zapora aplikacji webowej**, zaprojektowana w celu **ochrony aplikacji webowych lub API** przed r贸偶nymi exploitami webowymi, kt贸re mog wpyn na ich dostpno, bezpieczestwo lub zu偶ycie zasob贸w. Umo偶liwia u偶ytkownikom kontrolowanie ruchu przychodzcego poprzez ustawienie **regu bezpieczestwa**, kt贸re agodz typowe wektory atak贸w, takie jak SQL injection czy cross-site scripting, a tak偶e poprzez definiowanie niestandardowych regu filtrujcych.

### Kluczowe pojcia

#### Web ACL (Lista Kontroli Dostpu)

Web ACL to zbi贸r regu, kt贸re mo偶na zastosowa do aplikacji webowych lub API. Gdy powi偶esz Web ACL z zasobem, AWS WAF sprawdza przychodzce 偶dania na podstawie regu zdefiniowanych w Web ACL i podejmuje okrelone dziaania.

#### Grupa regu

Grupa regu to wielokrotnego u偶ytku zbi贸r regu, kt贸re mo偶na zastosowa do wielu Web ACL. Grupy regu pomagaj zarzdza i utrzymywa sp贸jne zestawy regu w r贸偶nych aplikacjach webowych lub API.

Ka偶da grupa regu ma przypisan **pojemno**, kt贸ra pomaga obliczy i kontrolowa zasoby operacyjne u偶ywane do uruchamiania twoich regu, grup regu i Web ACL. Po ustawieniu wartoci podczas tworzenia, nie mo偶na jej zmieni.

#### Regua

Regua definiuje zestaw warunk贸w, kt贸re AWS WAF wykorzystuje do sprawdzania przychodzcych 偶da webowych. Istniej dwa g贸wne typy regu:

1. **Regua standardowa**: Ten typ reguy wykorzystuje okrelone warunki do ustalenia, czy zezwoli, zablokowa lub zliczy 偶dania webowe.
2. **Regua oparta na szybkoci**: Zlicza 偶dania z okrelonego adresu IP w cigu piciu minut. U偶ytkownicy definiuj pr贸g, a jeli liczba 偶da z danego IP przekroczy ten limit w cigu piciu minut, kolejne 偶dania z tego IP s blokowane, a偶 wska藕nik 偶da spadnie poni偶ej progu. Minimalny pr贸g dla regu opartych na szybkoci to **2000 偶da**.

#### Zarzdzane reguy

AWS WAF oferuje wstpnie skonfigurowane, zarzdzane zestawy regu, kt贸re s utrzymywane przez AWS i sprzedawc贸w z AWS Marketplace. Te zestawy regu zapewniaj ochron przed powszechnymi zagro偶eniami i s regularnie aktualizowane w celu rozwizania nowych luk.

#### Zestaw IP

Zestaw IP to lista adres贸w IP lub zakres贸w adres贸w IP, kt贸re chcesz zezwoli lub zablokowa. Zestawy IP upraszczaj proces zarzdzania reguami opartymi na IP.

#### Zestaw wzorc贸w Regex

Zestaw wzorc贸w Regex zawiera jedn lub wicej wyra偶e regularnych (regex), kt贸re definiuj wzorce do wyszukiwania w 偶daniach webowych. Jest to przydatne w bardziej zo偶onych scenariuszach dopasowywania, takich jak filtrowanie konkretnych sekwencji znak贸w.

#### Token blokady

Token blokady jest u偶ywany do kontroli wsp贸bie偶noci podczas aktualizacji zasob贸w WAF. Zapewnia, 偶e zmiany nie s przypadkowo nadpisywane przez wielu u偶ytkownik贸w lub procesy pr贸bujce jednoczenie zaktualizowa ten sam zas贸b.

#### Klucze API

Klucze API w AWS WAF s u偶ywane do uwierzytelniania 偶da do okrelonych operacji API. Te klucze s szyfrowane i zarzdzane w spos贸b bezpieczny, aby kontrolowa dostp i zapewni, 偶e tylko autoryzowani u偶ytkownicy mog wprowadza zmiany w konfiguracjach WAF.

* **Przykad**: Integracja z API CAPTCHA.

#### Polityka uprawnie

Polityka uprawnie to polityka IAM, kt贸ra okrela, kto mo偶e wykonywa dziaania na zasobach AWS WAF. Definiujc uprawnienia, mo偶esz kontrolowa dostp do zasob贸w WAF i zapewni, 偶e tylko autoryzowani u偶ytkownicy mog tworzy, aktualizowa lub usuwa konfiguracje.

#### Zakres

Parametr zakresu w AWS WAF okrela, czy reguy i konfiguracje WAF maj zastosowanie do aplikacji regionalnej czy dystrybucji Amazon CloudFront.

* **REGIONAL**: Dotyczy regionalnych usug, takich jak Application Load Balancers (ALB), Amazon API Gateway REST API, AWS AppSync GraphQL API, Amazon Cognito user pool, AWS App Runner service i AWS Verified Access instance. Okrelasz region AWS, w kt贸rym znajduj si te zasoby.
* **CLOUDFRONT**: Dotyczy dystrybucji Amazon CloudFront, kt贸re s globalne. Konfiguracje WAF dla CloudFront s zarzdzane przez region `us-east-1`, niezale偶nie od tego, gdzie tre jest serwowana.

### Kluczowe funkcje

#### Kryteria monitorowania (Warunki)

**Warunki** okrelaj elementy przychodzcych 偶da HTTP/HTTPS, kt贸re AWS WAF monitoruje, w tym XSS, lokalizacj geograficzn (GEO), adresy IP, ograniczenia rozmiaru, SQL Injection i wzorce (dopasowywanie cig贸w i regex). Wa偶ne jest, aby zauwa偶y, 偶e **偶dania ograniczone na poziomie CloudFront na podstawie kraju nie dotr do WAF**.

Ka偶de konto AWS mo偶e skonfigurowa:

* **100 warunk贸w** dla ka偶dego typu (z wyjtkiem Regex, gdzie dozwolone s tylko **10 warunk贸w**, ale ten limit mo偶na zwikszy).
* **100 regu** i **50 Web ACL**.
* Maksymalnie **5 regu opartych na szybkoci**.
* Przepustowo **10,000 偶da na sekund**, gdy WAF jest wdro偶ony z aplikacyjnym load balancerem.

#### Dziaania regu

Dziaania s przypisane do ka偶dej reguy, a opcje to:

* **Zezw贸l**: 呕danie jest przekazywane do odpowiedniej dystrybucji CloudFront lub Application Load Balancer.
* **Zablokuj**: 呕danie jest natychmiast przerywane.
* **Zlicz**: Zlicza 偶dania speniajce warunki reguy. Jest to przydatne do testowania regu, potwierdzania dokadnoci reguy przed ustawieniem jej na Zezw贸l lub Zablokuj.
* **CAPTCHA i Wyzwanie:** Weryfikuje, 偶e 偶danie nie pochodzi od bota, u偶ywajc zagadek CAPTCHA i cichych wyzwa.

Jeli 偶danie nie pasuje do 偶adnej reguy w Web ACL, podlega **domylnemu dziaaniu** (Zezw贸l lub Zablokuj). Kolejno wykonywania regu, zdefiniowana w Web ACL, jest kluczowa i zazwyczaj przebiega w nastpujcej kolejnoci:

1. Zezw贸l na biae listy IP.
2. Zablokuj czarne listy IP.
3. Zablokuj 偶dania pasujce do jakichkolwiek szkodliwych sygnatur.

#### Integracja z CloudWatch

AWS WAF integruje si z CloudWatch w celu monitorowania, oferujc metryki takie jak AllowedRequests, BlockedRequests, CountedRequests i PassedRequests. Te metryki s raportowane co minut domylnie i przechowywane przez okres dw贸ch tygodni.

### Enumeracja

Aby interagowa z dystrybucjami CloudFront, musisz okreli region US East (N. Virginia):

* CLI - Okrel region US East, gdy u偶ywasz zakresu CloudFront: `--scope CLOUDFRONT --region=us-east-1`.
* API i SDK - Dla wszystkich wywoa u偶yj punktu kocowego regionu us-east-1.

Aby interagowa z usugami regionalnymi, powiniene okreli region:

* Przykad z regionem Europa (Hiszpania): `--scope REGIONAL --region=eu-south-2`
```bash
# Web ACLs #

## Retrieve a list of web access control lists (Web ACLs) available in your AWS account
aws wafv2 list-web-acls --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve details about the specified Web ACL
aws wafv2 get-web-acl --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

## Retrieve a list of resources associated with a specific web access control list (Web ACL)
aws wafv2 list-resources-for-web-acl --web-acl-arn <value> # Additional permissions needed depending on the protected resource type: cognito-idp:ListResourcesForWebACL, ec2:DescribeVerifiedAccessInstanceWebAclAssociations or apprunner:ListAssociatedServicesForWebAcl
## Retrieve the Web ACL associated with the specified AWS resource
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Additional permissions needed depending on the protected resource type: cognito-idp:GetWebACLForResource, ec2:GetVerifiedAccessInstanceWebAcl, wafv2:GetWebACL or apprunner:DescribeWebAclForService

# Rule groups #

## List of the rule groups available in your AWS account
aws wafv2 list-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the details of a specific rule group
aws wafv2 get-rule-group [--name <value>] [--id <value>] [--arn <value>] [--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>]
## Retrieve the IAM policy attached to the specified rule group
aws wafv2 get-permission-policy --resource-arn <rule-group-arn> # Just the owner of the Rule Group can do this operation

# Managed rule groups (by AWS or by a third-party) #

## List the managed rule groups that are available
aws wafv2 list-available-managed-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## List the available versions of the specified managed rule group
aws wafv2 list-available-managed-rule-group-versions --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about a specific managed rule group
aws wafv2 describe-managed-rule-group --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--version-name <value>]
## Retrieve high-level information about all managed rule groups
aws wafv2 describe-all-managed-products --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about all managed rule groups from a specific vendor
aws wafv2 describe-managed-products-by-vendor --vendor-name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# IP sets #

## List the IP sets that are available in your AWS account
aws wafv2 list-ip-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the specific IP set
aws wafv2 get-ip-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the keys that are currently being managed by a rate-based rule.
aws wafv2 get-rate-based-statement-managed-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>\
--web-acl-name <value> --web-acl-id <value> --rule-name <value> [--rule-group-rule-name <value>]

# Regex pattern sets #

## List all the regex pattern sets that you manage
aws wafv2 list-regex-pattern-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieves the specified regex pattern sets
aws wafv2 get-regex-pattern-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# API Keys #

## List API keys for the specified scope
aws wafv2 list-api-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve decrypted API key
aws wafv2 get-decrypted-api-key --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --api-key <value>

# Logs #

## List of logging configurations (storage location of the logs)
aws wafv2 list-logging-configurations --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--log-scope <value>]
## Retrieve the logging configuration settings associated with a specific web ACL
aws wafv2 get-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]

# Miscelaneous #

## Retrieve a list of the tags associated to the specified resource
aws wafv2 list-tags-for-resource resource-arn <value>

## Retrieve a sample of web requests that match a specified rule within a WebACL during a specified time range
aws wafv2 get-sampled-requests --web-acl-arn <value> --rule-metric-name <value> --time-window <value> --max-items <1-500> --scope <value>

## Obtains the web ACL capacity unit (WCU) requirements for a specified scope and ruleset
aws wafv2 check-capacity --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --rules <value>

## List of available releases for the AWS WAFv2 mobile SDK
aws wafv2 list-mobile-sdk-releases --platform <IOS | ANDROID>
## Retrieves information for the specified mobile SDK release
aws wafv2 get-mobile-sdk-release --platform <value> --release-version <value>

```
### Post Exploitation / Bypass

{% hint style="success" %}
Z perspektywy atakujcego, ta usuga mo偶e pom贸c atakujcemu zidentyfikowa zabezpieczenia WAF i ekspozycje sieciowe, kt贸re mog pom贸c mu w kompromitacji innych stron.

Jednak atakujcy mo偶e by r贸wnie偶 zainteresowany zak贸ceniem tej usugi, aby strony nie byy chronione przez WAF.
{% endhint %}

W wielu operacjach usuwania i aktualizacji konieczne byoby podanie **tokena blokady**. Token ten jest u偶ywany do kontroli wsp贸bie偶noci nad zasobami, zapewniajc, 偶e zmiany nie s przypadkowo nadpisywane przez wielu u偶ytkownik贸w lub procesy pr贸bujce jednoczenie zaktualizowa ten sam zas贸b. Aby uzyska ten token, mo偶na wykona odpowiednie operacje **list** lub **get** na konkretnym zasobie.

#### **`wafv2:CreateRuleGroup`, `wafv2:UpdateRuleGroup`, `wafv2:DeleteRuleGroup`**

Atakujcy m贸gby skompromitowa bezpieczestwo dotknitego zasobu poprzez:

* Tworzenie grup regu, kt贸re mogyby na przykad blokowa legalny ruch z legalnych adres贸w IP, powodujc odmow usugi.
* Aktualizowanie grup regu, majc mo偶liwo modyfikacji ich dziaa na przykad z **Block** na **Allow**.
* Usuwanie grup regu, kt贸re zapewniaj krytyczne rodki bezpieczestwa.
```bash
# Create Rule Group
aws wafv2 create-rule-group --name <value> --capacity <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Update Rule Group
aws wafv2 update-rule-group --name <value> --id <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Delete Rule Group
aws wafv2 delete-rule-group --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Poni偶sze przykady pokazuj grup regu, kt贸ra zablokowaaby legalny ruch z okrelonych adres贸w IP:
```bash
aws wafv2 create-rule-group --name BlockLegitimateIPsRuleGroup --capacity 1 --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=BlockLegitimateIPsRuleGroup --scope CLOUDFRONT --region us-east-1 --rules file://rule.json
```
Plik **rule.json** wygldaby nastpujco:
```json
[
{
"Name":"BlockLegitimateIPsRule",
"Priority":0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:global/ipset/legitIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action":{
"Block":{}
},
"VisibilityConfig":{
"SampledRequestsEnabled":false,
"CloudWatchMetricsEnabled":false,
"MetricName":"BlockLegitimateIPsRule"
}
}
]
```
**Potencjalny wpyw**: Nieautoryzowany dostp, naruszenia danych i potencjalne ataki DoS.

#### **`wafv2:CreateWebACL`, `wafv2:UpdateWebACL`, `wafv2:DeleteWebACL`**

Dziki tym uprawnieniom, atakujcy m贸gby:

* Utworzy nowy Web ACL, wprowadzajc zasady, kt贸re albo przepuszczaj zoliwy ruch, albo blokuj legalny ruch, skutecznie czynic WAF bezu偶ytecznym lub powodujc odmow usugi.
* Zaktualizowa istniejce Web ACL, majc mo偶liwo modyfikacji zasad w celu zezwolenia na ataki takie jak SQL injection lub cross-site scripting, kt贸re wczeniej byy blokowane, lub zak贸ci normalny przepyw ruchu, blokujc wa偶ne 偶dania.
* Usun Web ACL, pozostawiajc dotknite zasoby cakowicie niechronione, nara偶ajc je na szeroki zakres atak贸w internetowych.

{% hint style="info" %}
Mo偶esz usun okrelony **WebACL** tylko wtedy, gdy **ManagedByFirewallManager** jest faszywe.
{% endhint %}
```bash
# Create Web ACL
aws wafv2 create-web-acl --name <value> --default-action <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Update Web ACL
aws wafv2 update-web-acl --name <value> --id <value> --default-action <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Delete Web ACL
aws wafv2 delete-web-acl --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Przykady poni偶ej pokazuj, jak zaktualizowa Web ACL, aby zablokowa legalny ruch z okrelonego zestawu adres贸w IP. Jeli adres IP 藕r贸dowy nie pasuje do 偶adnego z tych adres贸w IP, domylna akcja r贸wnie偶 bdzie polega na zablokowaniu go, co spowoduje DoS.

**Oryginalny Web ACL**:
```json
{
"WebACL": {
"Name": "AllowLegitimateIPsWebACL",
"Id": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/AllowLegitimateIPsWebACL/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"DefaultAction": {
"Allow": {}
},
"Description": "",
"Rules": [
{
"Name": "AllowLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Allow": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsRule"
}
}
],
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsWebACL"
},
"Capacity": 1,
"ManagedByFirewallManager": false,
"LabelNamespace": "awswaf:123456789012:webacl:AllowLegitimateIPsWebACL:"
},
"LockToken": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}

```
Polecenie do zaktualizowania Web ACL:
```json
aws wafv2 update-web-acl --name AllowLegitimateIPsWebACL --scope REGIONAL --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --default-action Block={} --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=AllowLegitimateIPsWebACL --rules file://rule.json --region us-east-1
```
Plik **rule.json** wygldaby nastpujco:
```json
[
{
"Name": "BlockLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Block": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "BlockLegitimateIPRule"
}
}
]
```
**Potencjalny wpyw**: Nieautoryzowany dostp, naruszenia danych i potencjalne ataki DoS.

#### **`wafv2:AssociateWebACL`, `wafv2:DisassociateWebACL`**

Uprawnienie **`wafv2:AssociateWebACL`** pozwolioby atakujcemu na powizanie web ACL (List Kontroli Dostpu) z zasobami, co umo偶liwioby obejcie zabezpiecze, pozwalajc na nieautoryzowany ruch do aplikacji, co potencjalnie prowadzioby do wykorzystania luk, takich jak SQL injection lub cross-site scripting (XSS). Z drugiej strony, z uprawnieniem **`wafv2:DisassociateWebACL`**, atakujcy m贸gby tymczasowo wyczy zabezpieczenia, nara偶ajc zasoby na luki bez wykrycia.

Dodatkowe uprawnienia byyby potrzebne w zale偶noci od typu chronionego zasobu:

* **Powi偶**
* apigateway:SetWebACL
* apprunner:AssociateWebAcl
* appsync:SetWebACL
* cognito-idp:AssociateWebACL
* ec2:AssociateVerifiedAccessInstanceWebAcl
* elasticloadbalancing:SetWebAcl
* **Rozwi偶**
* apigateway:SetWebACL
* apprunner:DisassociateWebAcl
* appsync:SetWebACL
* cognito-idp:DisassociateWebACL
* ec2:DisassociateVerifiedAccessInstanceWebAcl
* elasticloadbalancing:SetWebAcl
```bash
# Associate
aws wafv2 associate-web-acl --web-acl-arn <value> --resource-arn <value>
# Disassociate
aws wafv2 disassociate-web-acl --resource-arn <value>
```
**Potencjalny wpyw**: Kompromitacja bezpieczestwa zasob贸w, zwikszone ryzyko wykorzystania oraz potencjalne zak贸cenia usug w rodowiskach AWS chronionych przez AWS WAF.

#### **`wafv2:CreateIPSet` , `wafv2:UpdateIPSet`, `wafv2:DeleteIPSet`**

Atakujcy m贸gby tworzy, aktualizowa i usuwa zestawy IP zarzdzane przez AWS WAF. Mo偶e to by niebezpieczne, poniewa偶 m贸gby tworzy nowe zestawy IP, aby zezwoli na zoliwy ruch, modyfikowa zestawy IP w celu zablokowania legalnego ruchu, aktualizowa istniejce zestawy IP, aby uwzgldni zoliwe adresy IP, usuwa zaufane adresy IP lub usuwa krytyczne zestawy IP, kt贸re maj na celu ochron krytycznych zasob贸w.
```bash
# Create IP set
aws wafv2 create-ip-set --name <value> --ip-address-version <IPV4 | IPV6> --addresses <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Update IP set
aws wafv2 update-ip-set --name <value> --id <value> --addresses <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete IP set
aws wafv2 delete-ip-set --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Poni偶szy przykad pokazuje, jak **nadpisa istniejcy zestaw IP po偶danym zestawem IP**:
```bash
aws wafv2 update-ip-set --name LegitimateIPv4Set --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --addresses 99.99.99.99/32 --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --scope CLOUDFRONT --region us-east-1
```
**Potencjalny wpyw**: Nieautoryzowany dostp i blokowanie legalnego ruchu.

#### **`wafv2:CreateRegexPatternSet`** , **`wafv2:UpdateRegexPatternSet`**, **`wafv2:DeleteRegexPatternSet`**

Napastnik z tymi uprawnieniami m贸gby manipulowa zestawami wzorc贸w wyra偶e regularnych u偶ywanymi przez AWS WAF do kontrolowania i filtrowania przychodzcego ruchu na podstawie okrelonych wzorc贸w.

* Tworzenie nowych wzorc贸w regex pomogoby napastnikowi w zezwoleniu na szkodliw tre
* Aktualizujc istniejce wzorce, napastnik m贸gby obej zasady bezpieczestwa
* Usunicie wzorc贸w zaprojektowanych w celu blokowania zoliwych dziaa mogoby umo偶liwi napastnikowi wysyanie zoliwych adunk贸w i obejcie rodk贸w bezpieczestwa.
```bash
# Create regex pattern set
aws wafv2 create-regex-pattern-set --name <value> --regular-expression-list <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--description <value>]
# Update regex pattern set
aws wafv2 update-regex-pattern-set --name <value> --id <value> --regular-expression-list <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete regex pattern set
aws wafv2 delete-regex-pattern-set --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --id <value> --lock-token <value>
```
**Potencjalny wpyw**: Ominicie zabezpiecze, umo偶liwiajce wprowadzenie zoliwej treci i potencjalne ujawnienie danych wra偶liwych lub zak贸cenie usug i zasob贸w chronionych przez AWS WAF.

#### **(`wavf2:PutLoggingConfiguration` &** `iam:CreateServiceLinkedRole`), **`wafv2:DeleteLoggingConfiguration`**

Atakujcy z uprawnieniami **`wafv2:DeleteLoggingConfiguration`** m贸gby usun konfiguracj logowania z okrelonego Web ACL. Nastpnie, z uprawnieniami **`wavf2:PutLoggingConfiguration`** i **`iam:CreateServiceLinkedRole`**, atakujcy m贸gby utworzy lub zastpi konfiguracje logowania (po ich usuniciu), aby cakowicie uniemo偶liwi logowanie lub przekierowa logi do nieautoryzowanych miejsc, takich jak kosze Amazon S3, grupy log贸w Amazon CloudWatch Logs lub Amazon Kinesis Data Firehose pod kontrol.

Podczas procesu tworzenia, usuga automatycznie ustawia niezbdne uprawnienia, aby umo偶liwi zapis log贸w do okrelonego miejsca logowania:

* **Amazon CloudWatch Logs:** AWS WAF tworzy polityk zasob贸w na wyznaczonej grupie log贸w CloudWatch. Polityka ta zapewnia, 偶e AWS WAF ma wymagane uprawnienia do zapisywania log贸w w grupie log贸w.
* **Amazon S3 Bucket:** AWS WAF tworzy polityk kosza na wyznaczonym koszu S3. Polityka ta przyznaje AWS WAF niezbdne uprawnienia do przesyania log贸w do okrelonego kosza.
* **Amazon Kinesis Data Firehose:** AWS WAF tworzy rol powizan z usug specjalnie do interakcji z Kinesis Data Firehose. Rola ta pozwala AWS WAF na dostarczanie log贸w do skonfigurowanego strumienia Firehose.

{% hint style="info" %}
Mo偶liwe jest zdefiniowanie tylko jednego miejsca logowania na web ACL.
{% endhint %}
```bash
# Put logging configuration
aws wafv2 put-logging-configuration --logging-configuration <value>
# Delete logging configuration
aws wafv2 delete-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]
```
**Potencjalny wpyw:** Ukryta widoczno zdarze bezpieczestwa, utrudnienie procesu reagowania na incydenty oraz uatwienie ukrytych zoliwych dziaa w rodowiskach chronionych przez AWS WAF.

#### **`wafv2:DeleteAPIKey`**

Atakujcy z tymi uprawnieniami m贸gby usun istniejce klucze API, co uczynioby CAPTCHA nieskutecznym i zak贸cioby funkcjonalno, kt贸ra na nim polega, tak jak przesyanie formularzy i kontrole dostpu. W zale偶noci od implementacji tego CAPTCHA, mogoby to prowadzi do obejcia CAPTCHA lub do DoS, jeli zarzdzanie bdami nie jest odpowiednio ustawione w zasobie.
```bash
# Delete API key
aws wafv2 delete-api-key --api-key <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Potencjalny wpyw**: Wyczenie ochrony CAPTCHA lub zak贸cenie funkcjonalnoci aplikacji, prowadzce do narusze bezpieczestwa i potencjalnej kradzie偶y danych.

#### **`wafv2:TagResource`, `wafv2:UntagResource`**

Napastnik m贸gby doda, zmodyfikowa lub usun tagi z zasob贸w AWS WAFv2, takich jak Web ACL, grupy regu, zestawy IP, zestawy wzorc贸w regex oraz konfiguracje logowania.
```bash
# Tag
aws wafv2 tag-resource --resource-arn <value> --tags <value>
# Untag
aws wafv2 untag-resource --resource-arn <value> --tag-keys <value>
```
**Potencjalny wpyw**: Manipulacja zasobami, wyciek informacji, manipulacja kosztami i zak贸cenia operacyjne.

## Odniesienia

* [https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:\~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application](https://www.citrusconsulting.com/aws-web-application-firewall-waf/)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awswafv2.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awswafv2.html)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
