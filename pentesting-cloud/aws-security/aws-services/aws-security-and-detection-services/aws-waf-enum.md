# AWS - WAF Enum

## AWS - WAF Enum

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## AWS WAF

AWS WAF √© um **firewall de aplica√ß√£o web** projetado para **proteger aplica√ß√µes web ou APIs** contra v√°rias explora√ß√µes web que podem impactar sua disponibilidade, seguran√ßa ou consumo de recursos. Ele capacita os usu√°rios a controlar o tr√°fego de entrada configurando **regras de seguran√ßa** que mitigam vetores de ataque t√≠picos, como inje√ß√£o SQL ou cross-site scripting, e tamb√©m definindo regras de filtragem personalizadas.

### Conceitos-chave

#### Web ACL (Lista de Controle de Acesso)

Uma Web ACL √© uma cole√ß√£o de regras que voc√™ pode aplicar √†s suas aplica√ß√µes web ou APIs. Quando voc√™ associa uma Web ACL a um recurso, o AWS WAF inspeciona as solicita√ß√µes de entrada com base nas regras definidas na Web ACL e toma as a√ß√µes especificadas.

#### Grupo de Regras

Um Grupo de Regras √© uma cole√ß√£o reutiliz√°vel de regras que voc√™ pode aplicar a v√°rias Web ACLs. Grupos de regras ajudam a gerenciar e manter conjuntos de regras consistentes em diferentes aplica√ß√µes web ou APIs.

Cada grupo de regras tem sua **capacidade** associada, que ajuda a calcular e controlar os recursos operacionais usados para executar suas regras, grupos de regras e Web ACLs. Uma vez que seu valor √© definido durante a cria√ß√£o, n√£o √© poss√≠vel modific√°-lo.

#### Regra

Uma regra define um conjunto de condi√ß√µes que o AWS WAF usa para inspecionar as solicita√ß√µes web de entrada. Existem dois tipos principais de regras:

1. **Regra Regular**: Este tipo de regra usa condi√ß√µes especificadas para determinar se deve permitir, bloquear ou contar solicita√ß√µes web.
2. **Regra Baseada em Taxa**: Conta solicita√ß√µes de um endere√ßo IP espec√≠fico durante um per√≠odo de cinco minutos. Aqui, os usu√°rios definem um limite, e se o n√∫mero de solicita√ß√µes de um IP exceder esse limite dentro de cinco minutos, as solicita√ß√µes subsequentes desse IP s√£o bloqueadas at√© que a taxa de solicita√ß√µes caia abaixo do limite. O limite m√≠nimo para regras baseadas em taxa √© **2000 solicita√ß√µes**.

#### Regras Gerenciadas

O AWS WAF oferece conjuntos de regras gerenciadas pr√©-configurados que s√£o mantidos pela AWS e vendedores do AWS Marketplace. Esses conjuntos de regras fornecem prote√ß√£o contra amea√ßas comuns e s√£o atualizados regularmente para abordar novas vulnerabilidades.

#### Conjunto de IP

Um Conjunto de IP √© uma lista de endere√ßos IP ou intervalos de endere√ßos IP que voc√™ deseja permitir ou bloquear. Conjuntos de IP simplificam o processo de gerenciamento de regras baseadas em IP.

#### Conjunto de Padr√µes Regex

Um Conjunto de Padr√µes Regex cont√©m uma ou mais express√µes regulares (regex) que definem padr√µes a serem pesquisados em solicita√ß√µes web. Isso √© √∫til para cen√°rios de correspond√™ncia mais complexos, como filtrar sequ√™ncias espec√≠ficas de caracteres.

#### Token de Bloqueio

Um Token de Bloqueio √© usado para controle de concorr√™ncia ao fazer atualiza√ß√µes nos recursos do WAF. Ele garante que as altera√ß√µes n√£o sejam acidentalmente sobrescritas por v√°rios usu√°rios ou processos que tentam atualizar o mesmo recurso simultaneamente.

#### Chaves de API

As Chaves de API no AWS WAF s√£o usadas para autenticar solicita√ß√µes a certas opera√ß√µes de API. Essas chaves s√£o criptografadas e gerenciadas de forma segura para controlar o acesso e garantir que apenas usu√°rios autorizados possam fazer altera√ß√µes nas configura√ß√µes do WAF.

* **Exemplo**: Integra√ß√£o da API CAPTCHA.

#### Pol√≠tica de Permiss√£o

Uma Pol√≠tica de Permiss√£o √© uma pol√≠tica IAM que especifica quem pode realizar a√ß√µes nos recursos do AWS WAF. Ao definir permiss√µes, voc√™ pode controlar o acesso aos recursos do WAF e garantir que apenas usu√°rios autorizados possam criar, atualizar ou excluir configura√ß√µes.

#### Escopo

O par√¢metro de escopo no AWS WAF especifica se as regras e configura√ß√µes do WAF se aplicam a uma aplica√ß√£o regional ou a uma distribui√ß√£o Amazon CloudFront.

* **REGIONAL**: Aplica-se a servi√ßos regionais, como Application Load Balancers (ALB), Amazon API Gateway REST API, AWS AppSync GraphQL API, Amazon Cognito user pool, AWS App Runner service e AWS Verified Access instance. Voc√™ especifica a regi√£o AWS onde esses recursos est√£o localizados.
* **CLOUDFRONT**: Aplica-se a distribui√ß√µes Amazon CloudFront, que s√£o globais. As configura√ß√µes do WAF para CloudFront s√£o gerenciadas atrav√©s da regi√£o `us-east-1`, independentemente de onde o conte√∫do √© servido.

### Recursos principais

#### Crit√©rios de Monitoramento (Condi√ß√µes)

**Condi√ß√µes** especificam os elementos das solicita√ß√µes HTTP/HTTPS de entrada que o AWS WAF monitora, que incluem XSS, localiza√ß√£o geogr√°fica (GEO), endere√ßos IP, restri√ß√µes de tamanho, inje√ß√£o SQL e padr√µes (correspond√™ncia de strings e regex). √â importante notar que **solicita√ß√µes restritas no n√≠vel do CloudFront com base no pa√≠s n√£o chegar√£o ao WAF**.

Cada conta AWS pode configurar:

* **100 condi√ß√µes** para cada tipo (exceto para Regex, onde apenas **10 condi√ß√µes** s√£o permitidas, mas esse limite pode ser aumentado).
* **100 regras** e **50 Web ACLs**.
* Um m√°ximo de **5 regras baseadas em taxa**.
* Um throughput de **10.000 solicita√ß√µes por segundo** quando o WAF √© implementado com um balanceador de carga de aplica√ß√£o.

#### A√ß√µes de regra

A√ß√µes s√£o atribu√≠das a cada regra, com as op√ß√µes sendo:

* **Permitir**: A solicita√ß√£o √© encaminhada para a distribui√ß√£o CloudFront ou Balanceador de Carga de Aplica√ß√£o apropriado.
* **Bloquear**: A solicita√ß√£o √© encerrada imediatamente.
* **Contar**: Conta as solicita√ß√µes que atendem √†s condi√ß√µes da regra. Isso √© √∫til para teste de regras, confirmando a precis√£o da regra antes de defini-la como Permitir ou Bloquear.
* **CAPTCHA e Desafio:** √â verificado se a solicita√ß√£o n√£o vem de um bot usando quebra-cabe√ßas CAPTCHA e desafios silenciosos.

Se uma solicita√ß√£o n√£o corresponder a nenhuma regra dentro da Web ACL, ela passa pela **a√ß√£o padr√£o** (Permitir ou Bloquear). A ordem de execu√ß√£o das regras, definida dentro de uma Web ACL, √© crucial e normalmente segue esta sequ√™ncia:

1. Permitir IPs na lista branca.
2. Bloquear IPs na lista negra.
3. Bloquear solicita√ß√µes que correspondam a quaisquer assinaturas prejudiciais.

#### Integra√ß√£o com CloudWatch

O AWS WAF se integra ao CloudWatch para monitoramento, oferecendo m√©tricas como AllowedRequests, BlockedRequests, CountedRequests e PassedRequests. Essas m√©tricas s√£o relatadas a cada minuto por padr√£o e retidas por um per√≠odo de duas semanas.

### Enumera√ß√£o

Para interagir com distribui√ß√µes CloudFront, voc√™ deve especificar a Regi√£o US East (N. Virginia):

* CLI - Especifique a Regi√£o US East ao usar o escopo CloudFront: `--scope CLOUDFRONT --region=us-east-1`.
* API e SDKs - Para todas as chamadas, use o endpoint da Regi√£o us-east-1.

Para interagir com servi√ßos regionais, voc√™ deve especificar a regi√£o:

* Exemplo com a regi√£o Europa (Espanha): `--scope REGIONAL --region=eu-south-2`
```bash
# Web ACLs #

## Retrieve a list of web access control lists (Web ACLs) available in your AWS account
aws wafv2 list-web-acls --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve details about the specified Web ACL
aws wafv2 get-web-acl --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

## Retrieve a list of resources associated with a specific web access control list (Web ACL)
aws wafv2 list-resources-for-web-acl --web-acl-arn <value> # Additional permissions needed depending on the protected resource type: cognito-idp:ListResourcesForWebACL, ec2:DescribeVerifiedAccessInstanceWebAclAssociations or apprunner:ListAssociatedServicesForWebAcl
## Retrieve the Web ACL associated with the specified AWS resource
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Additional permissions needed depending on the protected resource type: cognito-idp:GetWebACLForResource, ec2:GetVerifiedAccessInstanceWebAcl, wafv2:GetWebACL or apprunner:DescribeWebAclForService

# Rule groups #

## List of the rule groups available in your AWS account
aws wafv2 list-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the details of a specific rule group
aws wafv2 get-rule-group [--name <value>] [--id <value>] [--arn <value>] [--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>]
## Retrieve the IAM policy attached to the specified rule group
aws wafv2 get-permission-policy --resource-arn <rule-group-arn> # Just the owner of the Rule Group can do this operation

# Managed rule groups (by AWS or by a third-party) #

## List the managed rule groups that are available
aws wafv2 list-available-managed-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## List the available versions of the specified managed rule group
aws wafv2 list-available-managed-rule-group-versions --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about a specific managed rule group
aws wafv2 describe-managed-rule-group --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--version-name <value>]
## Retrieve high-level information about all managed rule groups
aws wafv2 describe-all-managed-products --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about all managed rule groups from a specific vendor
aws wafv2 describe-managed-products-by-vendor --vendor-name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# IP sets #

## List the IP sets that are available in your AWS account
aws wafv2 list-ip-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the specific IP set
aws wafv2 get-ip-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the keys that are currently being managed by a rate-based rule.
aws wafv2 get-rate-based-statement-managed-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>\
--web-acl-name <value> --web-acl-id <value> --rule-name <value> [--rule-group-rule-name <value>]

# Regex pattern sets #

## List all the regex pattern sets that you manage
aws wafv2 list-regex-pattern-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieves the specified regex pattern sets
aws wafv2 get-regex-pattern-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# API Keys #

## List API keys for the specified scope
aws wafv2 list-api-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve decrypted API key
aws wafv2 get-decrypted-api-key --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --api-key <value>

# Logs #

## List of logging configurations (storage location of the logs)
aws wafv2 list-logging-configurations --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--log-scope <value>]
## Retrieve the logging configuration settings associated with a specific web ACL
aws wafv2 get-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]

# Miscelaneous #

## Retrieve a list of the tags associated to the specified resource
aws wafv2 list-tags-for-resource resource-arn <value>

## Retrieve a sample of web requests that match a specified rule within a WebACL during a specified time range
aws wafv2 get-sampled-requests --web-acl-arn <value> --rule-metric-name <value> --time-window <value> --max-items <1-500> --scope <value>

## Obtains the web ACL capacity unit (WCU) requirements for a specified scope and ruleset
aws wafv2 check-capacity --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --rules <value>

## List of available releases for the AWS WAFv2 mobile SDK
aws wafv2 list-mobile-sdk-releases --platform <IOS | ANDROID>
## Retrieves information for the specified mobile SDK release
aws wafv2 get-mobile-sdk-release --platform <value> --release-version <value>

```
### P√≥s Explora√ß√£o / Bypass

{% hint style="success" %}
Do ponto de vista de um atacante, este servi√ßo pode ajudar o atacante a identificar prote√ß√µes WAF e exposi√ß√µes de rede que poderiam ajud√°-lo a comprometer outros sites.

No entanto, um atacante tamb√©m poderia estar interessado em interromper este servi√ßo para que os sites n√£o sejam protegidos pelo WAF.
{% endhint %}

Em muitas das opera√ß√µes de Exclus√£o e Atualiza√ß√£o, seria necess√°rio fornecer o **token de bloqueio**. Este token √© usado para controle de concorr√™ncia sobre os recursos, garantindo que as altera√ß√µes n√£o sejam acidentalmente sobrescritas por v√°rios usu√°rios ou processos tentando atualizar o mesmo recurso simultaneamente. Para obter este token, voc√™ poderia realizar as opera√ß√µes correspondentes de **listar** ou **obter** sobre o recurso espec√≠fico.

#### **`wafv2:CreateRuleGroup`, `wafv2:UpdateRuleGroup`, `wafv2:DeleteRuleGroup`**

Um atacante seria capaz de comprometer a seguran√ßa do recurso afetado ao:

* Criar grupos de regras que poderiam, por exemplo, bloquear tr√°fego leg√≠timo de endere√ßos IP leg√≠timos, causando uma nega√ß√£o de servi√ßo.
* Atualizar grupos de regras, podendo modificar suas a√ß√µes, por exemplo, de **Bloquear** para **Permitir**.
* Excluir grupos de regras que fornecem medidas de seguran√ßa cr√≠ticas.
```bash
# Create Rule Group
aws wafv2 create-rule-group --name <value> --capacity <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Update Rule Group
aws wafv2 update-rule-group --name <value> --id <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Delete Rule Group
aws wafv2 delete-rule-group --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Os seguintes exemplos mostram um grupo de regras que bloquearia o tr√°fego leg√≠timo de endere√ßos IP espec√≠ficos:
```bash
aws wafv2 create-rule-group --name BlockLegitimateIPsRuleGroup --capacity 1 --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=BlockLegitimateIPsRuleGroup --scope CLOUDFRONT --region us-east-1 --rules file://rule.json
```
O arquivo **rule.json** teria a seguinte apar√™ncia:
```json
[
{
"Name":"BlockLegitimateIPsRule",
"Priority":0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:global/ipset/legitIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action":{
"Block":{}
},
"VisibilityConfig":{
"SampledRequestsEnabled":false,
"CloudWatchMetricsEnabled":false,
"MetricName":"BlockLegitimateIPsRule"
}
}
]
```
**Impacto Potencial**: Acesso n√£o autorizado, vazamentos de dados e potenciais ataques DoS.

#### **`wafv2:CreateWebACL`, `wafv2:UpdateWebACL`, `wafv2:DeleteWebACL`**

Com essas permiss√µes, um atacante poderia:

* Criar um novo Web ACL, introduzindo regras que permitem o tr√°fego malicioso ou bloqueiam o tr√°fego leg√≠timo, tornando efetivamente o WAF in√∫til ou causando uma nega√ß√£o de servi√ßo.
* Atualizar Web ACLs existentes, podendo modificar regras para permitir ataques como inje√ß√£o SQL ou cross-site scripting, que foram anteriormente bloqueados, ou interromper o fluxo normal de tr√°fego bloqueando solicita√ß√µes v√°lidas.
* Deletar um Web ACL, deixando os recursos afetados completamente desprotegidos, expondo-os a uma ampla gama de ataques na web.

{% hint style="info" %}
Voc√™ s√≥ pode deletar o **WebACL** especificado se **ManagedByFirewallManager** for falso.
{% endhint %}
```bash
# Create Web ACL
aws wafv2 create-web-acl --name <value> --default-action <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Update Web ACL
aws wafv2 update-web-acl --name <value> --id <value> --default-action <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Delete Web ACL
aws wafv2 delete-web-acl --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Os seguintes exemplos mostram como atualizar um Web ACL para bloquear o tr√°fego leg√≠timo de um conjunto de IPs espec√≠fico. Se o IP de origem n√£o corresponder a nenhum desses IPs, a a√ß√£o padr√£o tamb√©m ser√° bloque√°-lo, causando um DoS.

**Web ACL Original**:
```json
{
"WebACL": {
"Name": "AllowLegitimateIPsWebACL",
"Id": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/AllowLegitimateIPsWebACL/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"DefaultAction": {
"Allow": {}
},
"Description": "",
"Rules": [
{
"Name": "AllowLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Allow": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsRule"
}
}
],
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsWebACL"
},
"Capacity": 1,
"ManagedByFirewallManager": false,
"LabelNamespace": "awswaf:123456789012:webacl:AllowLegitimateIPsWebACL:"
},
"LockToken": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}

```
Comando para atualizar o Web ACL:
```json
aws wafv2 update-web-acl --name AllowLegitimateIPsWebACL --scope REGIONAL --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --default-action Block={} --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=AllowLegitimateIPsWebACL --rules file://rule.json --region us-east-1
```
O arquivo **rule.json** teria a seguinte apar√™ncia:
```json
[
{
"Name": "BlockLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Block": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "BlockLegitimateIPRule"
}
}
]
```
**Impacto Potencial**: Acesso n√£o autorizado, vazamentos de dados e potenciais ataques DoS.

#### **`wafv2:AssociateWebACL`, `wafv2:DisassociateWebACL`**

A permiss√£o **`wafv2:AssociateWebACL`** permitiria que um atacante associasse ACLs da web (Listas de Controle de Acesso) com recursos, podendo contornar controles de seguran√ßa, permitindo que tr√°fego n√£o autorizado chegasse √† aplica√ß√£o, potencialmente levando a explora√ß√µes como inje√ß√£o SQL ou script entre sites (XSS). Por outro lado, com a permiss√£o **`wafv2:DisassociateWebACL`**, o atacante poderia desativar temporariamente as prote√ß√µes de seguran√ßa, expondo os recursos a vulnerabilidades sem detec√ß√£o.

As permiss√µes adicionais seriam necess√°rias dependendo do tipo de recurso protegido:

* **Associar**
* apigateway:SetWebACL
* apprunner:AssociateWebAcl
* appsync:SetWebACL
* cognito-idp:AssociateWebACL
* ec2:AssociateVerifiedAccessInstanceWebAcl
* elasticloadbalancing:SetWebAcl
* **Desassociar**
* apigateway:SetWebACL
* apprunner:DisassociateWebAcl
* appsync:SetWebACL
* cognito-idp:DisassociateWebACL
* ec2:DisassociateVerifiedAccessInstanceWebAcl
* elasticloadbalancing:SetWebAcl
```bash
# Associate
aws wafv2 associate-web-acl --web-acl-arn <value> --resource-arn <value>
# Disassociate
aws wafv2 disassociate-web-acl --resource-arn <value>
```
**Impacto Potencial**: Comprometimento da seguran√ßa dos recursos, aumento do risco de explora√ß√£o e potenciais interrup√ß√µes de servi√ßo dentro de ambientes AWS protegidos pelo AWS WAF.

#### **`wafv2:CreateIPSet` , `wafv2:UpdateIPSet`, `wafv2:DeleteIPSet`**

Um atacante seria capaz de criar, atualizar e deletar os conjuntos de IP gerenciados pelo AWS WAF. Isso poderia ser perigoso, pois poderia criar novos conjuntos de IP para permitir tr√°fego malicioso, modificar conjuntos de IP para bloquear tr√°fego leg√≠timo, atualizar conjuntos de IP existentes para incluir endere√ßos IP maliciosos, remover endere√ßos IP confi√°veis ou deletar conjuntos de IP cr√≠ticos que s√£o destinados a proteger recursos cr√≠ticos.
```bash
# Create IP set
aws wafv2 create-ip-set --name <value> --ip-address-version <IPV4 | IPV6> --addresses <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Update IP set
aws wafv2 update-ip-set --name <value> --id <value> --addresses <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete IP set
aws wafv2 delete-ip-set --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
O seguinte exemplo mostra como **substituir o conjunto de IP existente pelo conjunto de IP desejado**:
```bash
aws wafv2 update-ip-set --name LegitimateIPv4Set --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --addresses 99.99.99.99/32 --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --scope CLOUDFRONT --region us-east-1
```
**Impacto Potencial**: Acesso n√£o autorizado e bloqueio de tr√°fego leg√≠timo.

#### **`wafv2:CreateRegexPatternSet`**, **`wafv2:UpdateRegexPatternSet`**, **`wafv2:DeleteRegexPatternSet`**

Um atacante com essas permiss√µes seria capaz de manipular os conjuntos de padr√µes de express√£o regular usados pelo AWS WAF para controlar e filtrar o tr√°fego de entrada com base em padr√µes espec√≠ficos.

* Criar novos padr√µes regex ajudaria um atacante a permitir conte√∫do prejudicial
* Atualizando os padr√µes existentes, um atacante conseguiria contornar regras de seguran√ßa
* Deletar padr√µes que s√£o projetados para bloquear atividades maliciosas poderia levar um atacante a enviar cargas √∫teis maliciosas e contornar as medidas de seguran√ßa.
```bash
# Create regex pattern set
aws wafv2 create-regex-pattern-set --name <value> --regular-expression-list <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--description <value>]
# Update regex pattern set
aws wafv2 update-regex-pattern-set --name <value> --id <value> --regular-expression-list <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete regex pattern set
aws wafv2 delete-regex-pattern-set --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --id <value> --lock-token <value>
```
**Impacto Potencial**: Bypass de controles de seguran√ßa, permitindo conte√∫do malicioso e potencialmente expondo dados sens√≠veis ou interrompendo servi√ßos e recursos protegidos pelo AWS WAF.

#### **(`wavf2:PutLoggingConfiguration` &** `iam:CreateServiceLinkedRole`), **`wafv2:DeleteLoggingConfiguration`**

Um atacante com a **`wafv2:DeleteLoggingConfiguration`** seria capaz de remover a configura√ß√£o de registro do Web ACL especificado. Subsequentemente, com as permiss√µes **`wavf2:PutLoggingConfiguration`** e **`iam:CreateServiceLinkedRole`**, um atacante poderia criar ou substituir configura√ß√µes de registro (ap√≥s t√™-las deletado) para impedir completamente o registro ou redirecionar logs para destinos n√£o autorizados, como buckets do Amazon S3, grupo de logs do Amazon CloudWatch Logs ou um Amazon Kinesis Data Firehose sob controle.

Durante o processo de cria√ß√£o, o servi√ßo configura automaticamente as permiss√µes necess√°rias para permitir que os logs sejam gravados no destino de registro especificado:

* **Amazon CloudWatch Logs:** O AWS WAF cria uma pol√≠tica de recurso no grupo de logs do CloudWatch Logs designado. Esta pol√≠tica garante que o AWS WAF tenha as permiss√µes necess√°rias para gravar logs no grupo de logs.
* **Bucket do Amazon S3:** O AWS WAF cria uma pol√≠tica de bucket no bucket S3 designado. Esta pol√≠tica concede ao AWS WAF as permiss√µes necess√°rias para fazer upload de logs no bucket especificado.
* **Amazon Kinesis Data Firehose:** O AWS WAF cria um papel vinculado ao servi√ßo especificamente para interagir com o Kinesis Data Firehose. Este papel permite que o AWS WAF entregue logs ao stream do Firehose configurado.

{% hint style="info" %}
√â poss√≠vel definir apenas um destino de registro por web ACL.
{% endhint %}
```bash
# Put logging configuration
aws wafv2 put-logging-configuration --logging-configuration <value>
# Delete logging configuration
aws wafv2 delete-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]
```
**Impacto Potencial:** Visibilidade obscura em eventos de seguran√ßa, dificultando o processo de resposta a incidentes e facilitando atividades maliciosas encobertas em ambientes protegidos pelo AWS WAF.

#### **`wafv2:DeleteAPIKey`**

Um atacante com essas permiss√µes seria capaz de deletar chaves de API existentes, tornando o CAPTCHA ineficaz e interrompendo a funcionalidade que depende dele, como envios de formul√°rios e controles de acesso. Dependendo da implementa√ß√£o desse CAPTCHA, isso poderia levar a uma bypass de CAPTCHA ou a um DoS se o gerenciamento de erros n√£o estiver configurado corretamente no recurso.
```bash
# Delete API key
aws wafv2 delete-api-key --api-key <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Impacto Potencial**: Desativar prote√ß√µes CAPTCHA ou interromper a funcionalidade do aplicativo, levando a viola√ß√µes de seguran√ßa e potencial roubo de dados.

#### **`wafv2:TagResource`, `wafv2:UntagResource`**

Um atacante seria capaz de adicionar, modificar ou remover tags de recursos do AWS WAFv2, como ACLs da Web, grupos de regras, conjuntos de IP, conjuntos de padr√µes regex e configura√ß√µes de registro.
```bash
# Tag
aws wafv2 tag-resource --resource-arn <value> --tags <value>
# Untag
aws wafv2 untag-resource --resource-arn <value> --tag-keys <value>
```
**Impacto Potencial**: Manipula√ß√£o de recursos, vazamento de informa√ß√µes, manipula√ß√£o de custos e interrup√ß√£o operacional.

## Refer√™ncias

* [https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:\~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application](https://www.citrusconsulting.com/aws-web-application-firewall-waf/)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awswafv2.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awswafv2.html)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
