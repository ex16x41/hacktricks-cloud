# AWS - WAF Enum

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

# AWS WAF

AWS WAF je **web aplikacioni firewall** dizajniran da **zaÅ¡titi web aplikacije ili API-je** od razliÄitih web eksploatacija koje mogu uticati na njihovu dostupnost, sigurnost ili potroÅ¡nju resursa. OmoguÄ‡ava korisnicima kontrolu nad dolaznim saobraÄ‡ajem postavljanjem **sigurnosnih pravila** koja umanjuju tipiÄne vektore napada poput SQL injection-a ili cross-site scripting-a, kao i definisanjem prilagoÄ‘enih pravila filtriranja.

## KljuÄni koncepti

### Web ACL (Access Control List)

Web ACL je kolekcija pravila koja moÅ¾ete primeniti na svoje web aplikacije ili API-je. Kada poveÅ¾ete Web ACL sa resursom, AWS WAF inspicira dolazne zahteve na osnovu pravila definisanih u Web ACL i preduzima odreÄ‘ene akcije.

### Rule Group

Rule Group je ponovno upotrebljiva kolekcija pravila koju moÅ¾ete primeniti na viÅ¡e Web ACL-ova. Rule grupe pomaÅ¾u u upravljanju i odrÅ¾avanju doslednih skupova pravila preko razliÄitih web aplikacija ili API-ja.

Svaka rule grupa ima svoj **kapacitet**, koji pomaÅ¾e u izraÄunavanju i kontroli resursa koji se koriste za pokretanje vaÅ¡ih pravila, rule grupa i web ACL-ova. Jednom kada se vrednost postavi prilikom kreiranja, nije moguÄ‡e je menjati.

### Pravilo

Pravilo definiÅ¡e skup uslova koje AWS WAF koristi za inspekciju dolaznih web zahteva. Postoje dva glavna tipa pravila:

1. **Regularno Pravilo**: Ovaj tip pravila koristi odreÄ‘ene uslove da bi odredio da li treba dozvoliti, blokirati ili prebrojati web zahteve.
2. **Rate-Based Pravilo**: Broji zahteve sa odreÄ‘ene IP adrese tokom petominutnog perioda. Korisnici ovde definiÅ¡u prag, i ako broj zahteva sa IP adrese premaÅ¡i ovaj limit u roku od pet minuta, naknadni zahtevi sa te IP adrese su blokirani dok se stopa zahteva ne spusti ispod praga. Minimalni prag za rate-based pravila je **2000 zahteva**.

### Upravljana Pravila

AWS WAF nudi prekonfigurisane, upravljane setove pravila koje odrÅ¾avaju AWS i prodavci AWS Marketplace-a. Ovi setovi pravila pruÅ¾aju zaÅ¡titu od uobiÄajenih pretnji i redovno se aÅ¾uriraju kako bi se adresovale nove ranjivosti.

### IP Set

IP Set je lista IP adresa ili opsega IP adresa koje Å¾elite da dozvolite ili blokirate. IP setovi pojednostavljuju proces upravljanja IP baziranim pravilima.

### Regex Pattern Set

Regex Pattern Set sadrÅ¾i jedan ili viÅ¡e regularnih izraza (regex) koji definiÅ¡u obrasce za pretragu u web zahtevima. Ovo je korisno za sloÅ¾enije scenarije uparivanja, kao Å¡to je filtriranje specifiÄnih sekvenci karaktera.

### Lock Token

Lock Token se koristi za kontrolu konkurentnosti prilikom aÅ¾uriranja WAF resursa. On osigurava da promene ne budu sluÄajno prepisane od strane viÅ¡e korisnika ili procesa koji pokuÅ¡avaju da aÅ¾uriraju isti resurs istovremeno.

### API KljuÄevi

API KljuÄevi u AWS WAF-u se koriste za autentifikaciju zahteva ka odreÄ‘enim API operacijama. Ovi kljuÄevi su enkriptovani i bezbedno upravljani kako bi se kontrolisao pristup i osiguralo da samo ovlaÅ¡Ä‡eni korisnici mogu vrÅ¡iti promene na WAF konfiguracijama.

- **Primer**: Integracija CAPTCHA API-ja.

### Politika Dozvola

Politika Dozvola je IAM politika koja specificira ko moÅ¾e vrÅ¡iti akcije na AWS WAF resursima. Definisanjem dozvola, moÅ¾ete kontrolisati pristup WAF resursima i osigurati da samo ovlaÅ¡Ä‡eni korisnici mogu kreirati, aÅ¾urirati ili brisati konfiguracije.

### Opseg

Parametar opsega u AWS WAF-u specificira da li se WAF pravila i konfiguracije primenjuju na regionalnu aplikaciju ili Amazon CloudFront distribuciju.

- **REGIONAL**: Primenjuje se na regionalne servise poput Application Load Balancer-a (ALB), Amazon API Gateway REST API-ja, AWS AppSync GraphQL API-ja, Amazon Cognito korisniÄkog bazena, AWS App Runner servisa i AWS Verified Access instance. Navodite AWS region gde se ovi resursi nalaze.
- **CLOUDFRONT**: Primenjuje se na Amazon CloudFront distribucije, koje su globalne. WAF konfiguracije za CloudFront se upravljaju kroz region `us-east-1` bez obzira gde se sadrÅ¾aj servira.

## KljuÄne funkcije

### Kriterijumi praÄ‡enja (Uslovi)

**Uslovi** specificiraju elemente dolaznih HTTP/HTTPS zahteva koje AWS WAF prati, ukljuÄujuÄ‡i XSS, geografsku lokaciju (GEO), IP adrese, ograniÄenja veliÄine, SQL Injection i obrasce (stringove i regex uparivanje). VaÅ¾no je napomenuti da **zahtevi ograniÄeni na nivou CloudFront-a na osnovu zemlje neÄ‡e stiÄ‡i do WAF-a**.

Svaki AWS nalog moÅ¾e konfigurisati:

- **100 uslova** za svaki tip (osim za Regex, gde su dozvoljeni samo **10 uslova**, ali ovaj limit moÅ¾e biti poveÄ‡an).
- **100 pravila** i **50 Web ACL-ova**.
- Maksimalno **5 rate-based pravila**.
- Protok od **10,000 zahteva u sekundi** kada se WAF implementira sa application load balancer-om.

### Akcije pravila

Akcije su dodeljene svakom pravilu, sa opcijama:

- **Dozvoli**: Zahtev se prosleÄ‘uje odgovarajuÄ‡oj CloudFront distribuciji ili Application Load Balancer-u.
- **Blokiraj**: Zahtev se odmah prekida.
- **Broj**: Broji zahteve koji ispunjavaju uslove pravila. Ovo je korisno za testiranje pravila, potvrÄ‘ujuÄ‡i taÄnost pravila pre nego Å¡to se postavi na Dozvoli ili Blokiraj.
- **CAPTCHA i Izazov:** Proverava se da li zahtev ne dolazi od bota koriÅ¡Ä‡enjem CAPTCHA slagalica i tihih izazova.

Ako zahtev ne odgovara nijednom pravilu unutar Web ACL-a, prolazi kroz **podrazumevanu akciju** (Dozvoli ili Blokiraj). Redosled izvrÅ¡enja pravila, definisan unutar Web ACL-a, je kljuÄan i obiÄno prati ovaj redosled:

1. Dozvoli IP adrese na beloj listi.
2. Blokiraj IP adrese na crnoj listi.
3. Blokiraj zahteve koji odgovaraju bilo kojim Å¡tetnim potpisima.

### CloudWatch Integracija

AWS WAF se integriÅ¡e sa CloudWatch-om za praÄ‡enje, nudeÄ‡i metrike poput DozvoljeniZahtevi, BlokiraniZahtevi, BrojaniZahtevi i ProÅ¡liZahtevi. Ove metrike se podnose svaki minut podrazumevano i zadrÅ¾avaju se u periodu od dve nedelje.

## Enumeracija

Da biste interagovali sa CloudFront distribucijama, morate specificirati Region US East (N. Virginia):

- CLI - Specificirajte Region US East kada koristite CloudFront opseg: `--scope CLOUDFRONT --region=us-east-1`.
- API i SDK-ovi - Za sve pozive, koristite Region endpoint us-east-1.

Da biste interagovali sa regionalnim servisima, trebalo bi da specificirate region:

- Primer sa regionom Evropa (Å panija): `--scope REGIONAL --region=eu-south-2`
```bash
# Web ACLs #

## Retrieve a list of web access control lists (Web ACLs) available in your AWS account
aws wafv2 list-web-acls --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve details about the specified Web ACL
aws wafv2 get-web-acl --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

## Retrieve a list of resources associated with a specific web access control list (Web ACL)
aws wafv2 list-resources-for-web-acl --web-acl-arn <value> # Additional permissions needed depending on the protected resource type: cognito-idp:ListResourcesForWebACL, ec2:DescribeVerifiedAccessInstanceWebAclAssociations or apprunner:ListAssociatedServicesForWebAcl
## Retrieve the Web ACL associated with the specified AWS resource
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Additional permissions needed depending on the protected resource type: cognito-idp:GetWebACLForResource, ec2:GetVerifiedAccessInstanceWebAcl, wafv2:GetWebACL or apprunner:DescribeWebAclForService

# Rule groups #

## List of the rule groups available in your AWS account
aws wafv2 list-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the details of a specific rule group
aws wafv2 get-rule-group [--name <value>] [--id <value>] [--arn <value>] [--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>]
## Retrieve the IAM policy attached to the specified rule group
aws wafv2 get-permission-policy --resource-arn <rule-group-arn> # Just the owner of the Rule Group can do this operation

# Managed rule groups (by AWS or by a third-party) #

## List the managed rule groups that are available
aws wafv2 list-available-managed-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## List the available versions of the specified managed rule group
aws wafv2 list-available-managed-rule-group-versions --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about a specific managed rule group
aws wafv2 describe-managed-rule-group --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--version-name <value>]
## Retrieve high-level information about all managed rule groups
aws wafv2 describe-all-managed-products --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about all managed rule groups from a specific vendor
aws wafv2 describe-managed-products-by-vendor --vendor-name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# IP sets #

## List the IP sets that are available in your AWS account
aws wafv2 list-ip-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the specific IP set
aws wafv2 get-ip-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the keys that are currently being managed by a rate-based rule.
aws wafv2 get-rate-based-statement-managed-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>\
--web-acl-name <value> --web-acl-id <value> --rule-name <value> [--rule-group-rule-name <value>]

# Regex pattern sets #

## List all the regex pattern sets that you manage
aws wafv2 list-regex-pattern-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieves the specified regex pattern sets
aws wafv2 get-regex-pattern-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# API Keys #

## List API keys for the specified scope
aws wafv2 list-api-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve decrypted API key
aws wafv2 get-decrypted-api-key --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --api-key <value>

# Logs #

## List of logging configurations (storage location of the logs)
aws wafv2 list-logging-configurations --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--log-scope <value>]
## Retrieve the logging configuration settings associated with a specific web ACL
aws wafv2 get-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]

# Miscelaneous #

## Retrieve a list of the tags associated to the specified resource
aws wafv2 list-tags-for-resource resource-arn <value>

## Retrieve a sample of web requests that match a specified rule within a WebACL during a specified time range
aws wafv2 get-sampled-requests --web-acl-arn <value> --rule-metric-name <value> --time-window <value> --max-items <1-500> --scope <value>

## Obtains the web ACL capacity unit (WCU) requirements for a specified scope and ruleset
aws wafv2 check-capacity --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --rules <value>

## List of available releases for the AWS WAFv2 mobile SDK
aws wafv2 list-mobile-sdk-releases --platform <IOS | ANDROID>
## Retrieves information for the specified mobile SDK release
aws wafv2 get-mobile-sdk-release --platform <value> --release-version <value>

```
## Post Eksploatacija / Bypass

{% hint style="success" %}
Sa perspektive napadaÄa, ovaj servis moÅ¾e pomoÄ‡i napadaÄu da identifikuje WAF zaÅ¡tite i mreÅ¾ne ekspozicije koje bi mu mogle pomoÄ‡i da kompromituje druge veb stranice.

MeÄ‘utim, napadaÄ bi takoÄ‘e mogao biti zainteresovan za ometanje ovog servisa kako veb stranice ne bi bile zaÅ¡tiÄ‡ene od WAF-a.
{% endhint %}

U mnogim operacijama Brisanja i AÅ¾uriranja bilo bi potrebno pruÅ¾iti **token za zakljuÄavanje**. Ovaj token se koristi za kontrolu konkurentnosti nad resursima, osiguravajuÄ‡i da promene ne budu sluÄajno prepisane od strane viÅ¡e korisnika ili procesa koji pokuÅ¡avaju da aÅ¾uriraju isti resurs istovremeno. Da biste dobili ovaj token, moÅ¾ete izvrÅ¡iti odgovarajuÄ‡e **list** ili **get** operacije nad odreÄ‘enim resursom.

### **`wafv2:CreateRuleGroup`, `wafv2:UpdateRuleGroup`, `wafv2:DeleteRuleGroup`**

NapadaÄ bi mogao ugroziti sigurnost pogoÄ‘enog resursa tako Å¡to bi:

- Kreirao grupe pravila koje bi, na primer, mogle blokirati legitimni saobraÄ‡aj sa legitimnih IP adresa, uzrokujuÄ‡i uskraÄ‡ivanje usluge.
- AÅ¾urirao grupe pravila, moguÄ‡i da izmeni njihove akcije, na primer sa **Blokiraj** na **Dozvoli**.
- Brisanje grupa pravila koje pruÅ¾aju kljuÄne sigurnosne mere.
```bash
# Create Rule Group
aws wafv2 create-rule-group --name <value> --capacity <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Update Rule Group
aws wafv2 update-rule-group --name <value> --id <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Delete Rule Group
aws wafv2 delete-rule-group --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
SledeÄ‡i primeri pokazuju grupu pravila koja bi blokirala legitiman saobraÄ‡aj sa odreÄ‘enih IP adresa:
```bash
aws wafv2 create-rule-group --name BlockLegitimateIPsRuleGroup --capacity 1 --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=BlockLegitimateIPsRuleGroup --scope CLOUDFRONT --region us-east-1 --rules file://rule.json
```
Fajl **rule.json** bi izgledao ovako:
```json
[
{
"Name":"BlockLegitimateIPsRule",
"Priority":0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:global/ipset/legitIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action":{
"Block":{}
},
"VisibilityConfig":{
"SampledRequestsEnabled":false,
"CloudWatchMetricsEnabled":false,
"MetricName":"BlockLegitimateIPsRule"
}
}
]
```
**Potencijalni uticaj**: NeovlaÅ¡Ä‡en pristup, povrede podataka i potencijalni DoS napadi.

### **`wafv2:CreateWebACL`, `wafv2:UpdateWebACL`, `wafv2:DeleteWebACL`**

Sa ovim dozvolama, napadaÄ bi bio u moguÄ‡nosti da:

- Kreira novi Web ACL, uvodeÄ‡i pravila koja ili dozvoljavaju zlonamerni saobraÄ‡aj ili blokiraju legitimni saobraÄ‡aj, efikasno ÄineÄ‡i WAF beskorisnim ili izazivajuÄ‡i odbijanje usluge.
- AÅ¾urira postojeÄ‡e Web ACL-ove, moguÄ‡i da modifikuje pravila kako bi dozvolio napade poput SQL ubacivanja ili skriptovanja preko stranica, koji su prethodno blokirani, ili da poremeti normalan tok saobraÄ‡aja blokiranjem validnih zahteva.
- ObriÅ¡e Web ACL, ostavljajuÄ‡i pogoÄ‘ene resurse potpuno nezaÅ¡tiÄ‡enim, izlaÅ¾uÄ‡i ih Å¡irokom spektru web napada.

{% hint style="info" %}

MoÅ¾ete obrisati navedeni **WebACL** samo ako je **ManagedByFirewallManager** false.

{% endhint %}
```bash
# Create Web ACL
aws wafv2 create-web-acl --name <value> --default-action <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Update Web ACL
aws wafv2 update-web-acl --name <value> --id <value> --default-action <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Delete Web ACL
aws wafv2 delete-web-acl --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Originalni Web ACL**:
```json
{
"WebACL": {
"Name": "AllowLegitimateIPsWebACL",
"Id": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/AllowLegitimateIPsWebACL/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"DefaultAction": {
"Allow": {}
},
"Description": "",
"Rules": [
{
"Name": "AllowLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Allow": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsRule"
}
}
],
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsWebACL"
},
"Capacity": 1,
"ManagedByFirewallManager": false,
"LabelNamespace": "awswaf:123456789012:webacl:AllowLegitimateIPsWebACL:"
},
"LockToken": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}

```
### Komanda za aÅ¾uriranje Web ACL-a:

```bash
aws waf update-web-acl --web-acl-id <web-acl-id> --updates Action=INSERT,ActivatedRule={Priority=1,RuleId=<rule-id>}
```
```json
aws wafv2 update-web-acl --name AllowLegitimateIPsWebACL --scope REGIONAL --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --default-action Block={} --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=AllowLegitimateIPsWebACL --rules file://rule.json --region us-east-1
```
Fajl **rule.json** bi izgledao ovako:
```json
[
{
"Name": "BlockLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Block": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "BlockLegitimateIPRule"
}
}
]
```
**Potencijalni uticaj**: NeovlaÅ¡Ä‡en pristup, curenje podataka i potencijalni DoS napadi.

### **`wafv2:AssociateWebACL`, `wafv2:DisassociateWebACL`**

Dozvola **`wafv2:AssociateWebACL`** omoguÄ‡ila bi napadaÄu da poveÅ¾e web ACL-ove (Access Control List) sa resursima, omoguÄ‡avajuÄ‡i zaobilaÅ¾enje sigurnosnih kontrola, dozvoljavajuÄ‡i neovlaÅ¡Ä‡enom saobraÄ‡aju da dostigne aplikaciju, potencijalno dovodeÄ‡i do eksploatacije kao Å¡to su SQL injection ili cross-site scripting (XSS). S druge strane, sa dozvolom **`wafv2:DisassociateWebACL`**, napadaÄ bi mogao privremeno onemoguÄ‡iti sigurnosne zaÅ¡tite, izlaÅ¾uÄ‡i resurse ranjivostima bez otkrivanja.

Dodatne dozvole bi bile potrebne u zavisnosti od tipa zaÅ¡tiÄ‡enog resursa:

- **Povezivanje**
- apigateway:SetWebACL
- apprunner:AssociateWebAcl
- appsync:SetWebACL
- cognito-idp:AssociateWebACL
- ec2:AssociateVerifiedAccessInstanceWebAcl
- elasticloadbalancing:SetWebAcl
- **Razdvajanje**
- apigateway:SetWebACL
- apprunner:DisassociateWebAcl
- appsync:SetWebACL
- cognito-idp:DisassociateWebACL
- ec2:DisassociateVerifiedAccessInstanceWebAcl
- elasticloadbalancing:SetWebAcl
```bash
# Associate
aws wafv2 associate-web-acl --web-acl-arn <value> --resource-arn <value>
# Disassociate
aws wafv2 disassociate-web-acl --resource-arn <value>
```
**Potencijalni Uticaj**: UgroÅ¾ena sigurnost resursa, poveÄ‡an rizik od eksploatacije i potencijalne prekide usluga unutar AWS okruÅ¾enja zaÅ¡tiÄ‡enog AWS WAF-om.

### **`wafv2:CreateIPSet`, `wafv2:UpdateIPSet`, `wafv2:DeleteIPSet`**

NapadaÄ bi bio u moguÄ‡nosti da kreira, aÅ¾urira i obriÅ¡e IP setove koje upravlja AWS WAF-om. Ovo moÅ¾e biti opasno jer bi mogao da kreira nove IP setove kako bi omoguÄ‡io zlonamerni saobraÄ‡aj, modifikuje IP setove kako bi blokirao legitimni saobraÄ‡aj, aÅ¾urira postojeÄ‡e IP setove da ukljuÄi zlonamerne IP adrese, ukloni pouzdane IP adrese ili obriÅ¡e kljuÄne IP setove koji su namenjeni zaÅ¡tititi kljuÄne resurse.
```bash
# Create IP set
aws wafv2 create-ip-set --name <value> --ip-address-version <IPV4 | IPV6> --addresses <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Update IP set
aws wafv2 update-ip-set --name <value> --id <value> --addresses <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete IP set
aws wafv2 delete-ip-set --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
SledeÄ‡i primer pokazuje kako **prepisati postojeÄ‡i IP set Å¾eljenim IP setom**:
```bash
aws wafv2 update-ip-set --name LegitimateIPv4Set --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --addresses 99.99.99.99/32 --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --scope CLOUDFRONT --region us-east-1
```
**Potencijalni uticaj**: NeovlaÅ¡Ä‡en pristup i blokiranje legitimnog saobraÄ‡aja.

### **`wafv2:CreateRegexPatternSet`**, **`wafv2:UpdateRegexPatternSet`**, **`wafv2:DeleteRegexPatternSet`**

NapadaÄ sa ovim ovlaÅ¡Ä‡enjima bio bi u moguÄ‡nosti da manipuliÅ¡e skupovima regularnih izraza koje koristi AWS WAF kako bi kontrolisao i filtrirao dolazni saobraÄ‡aj na osnovu specifiÄnih obrazaca.

- Kreiranje novih regex obrazaca bi pomoglo napadaÄu da omoguÄ‡i Å¡tetan sadrÅ¾aj
- AÅ¾uriranjem postojeÄ‡ih obrazaca, napadaÄ bi mogao da zaobiÄ‘e sigurnosna pravila
- Brisanje obrazaca koji su dizajnirani da blokiraju zlonamerne aktivnosti moglo bi dovesti napadaÄa do slanja zlonamernih payload-ova i zaobilaÅ¾enja sigurnosnih mera.
```bash
# Create regex pattern set
aws wafv2 create-regex-pattern-set --name <value> --regular-expression-list <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--description <value>]
# Update regex pattern set
aws wafv2 update-regex-pattern-set --name <value> --id <value> --regular-expression-list <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete regex pattern set
aws wafv2 delete-regex-pattern-set --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --id <value> --lock-token <value>
```
**Potencijalni uticaj**: ZaobilaÅ¾enje sigurnosnih kontrola, omoguÄ‡avanje zlonamernog sadrÅ¾aja i potencijalno otkrivanje osetljivih podataka ili ometanje usluga i resursa zaÅ¡tiÄ‡enih od strane AWS WAF.

### **(`wavf2:PutLoggingConfiguration` &** `iam:CreateServiceLinkedRole`), **`wafv2:DeleteLoggingConfiguration`**

NapadaÄ sa dozvolom **`wafv2:DeleteLoggingConfiguration`** bio bi u moguÄ‡nosti da ukloni konfiguraciju beleÅ¾enja sa odreÄ‘enog Web ACL-a. Nakon toga, sa dozvolama **`wavf2:PutLoggingConfiguration`** i **`iam:CreateServiceLinkedRole`**, napadaÄ bi mogao da kreira ili zameni konfiguracije beleÅ¾enja (nakon Å¡to je obrisao) kako bi spreÄio beleÅ¾enje u potpunosti ili preusmerio zapise ka neovlaÅ¡Ä‡enim odrediÅ¡tima, poput Amazon S3 kanti, Amazon CloudWatch Logs grupe zapisa ili Amazon Kinesis Data Firehose pod kontrolom.

Tokom procesa kreiranja, servis automatski postavlja neophodne dozvole kako bi omoguÄ‡io pisanje zapisa na odreÄ‘eno odrediÅ¡te beleÅ¾enja:

- **Amazon CloudWatch Logs:** AWS WAF kreira pravilo resursa na odreÄ‘enoj CloudWatch Logs grupi zapisa. Ovo pravilo osigurava da AWS WAF ima potrebne dozvole za pisanje zapisa u grupu zapisa.
- **Amazon S3 kanta:** AWS WAF kreira pravilo kante na odreÄ‘enoj S3 kanti. Ovo pravilo dodeljuje AWS WAF-u dozvole neophodne za otpremanje zapisa na odreÄ‘enu kantu.
- **Amazon Kinesis Data Firehose:** AWS WAF kreira ulogu specifiÄnu za servis za interakciju sa Kinesis Data Firehose-om. Ova uloga omoguÄ‡ava AWS WAF-u da dostavlja zapise ka konfigurisanom Firehose toku.

{% hint style="info" %}

MoguÄ‡e je definisati samo jedno odrediÅ¡te beleÅ¾enja po web ACL-u.

{% endhint %}
```bash
# Put logging configuration
aws wafv2 put-logging-configuration --logging-configuration <value>
# Delete logging configuration
aws wafv2 delete-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]
```
**Potencijalni uticaj:** OteÅ¾ava vidljivost dogaÄ‘aja vezanih za bezbednost, oteÅ¾ava proces odgovora na incidente i olakÅ¡ava prikrivene zlonamerne aktivnosti unutar okruÅ¾enja zaÅ¡titenog AWS WAF-om.

### **`wafv2:DeleteAPIKey`**

NapadaÄ sa ovim dozvolama bio bi u moguÄ‡nosti da obriÅ¡e postojeÄ‡e API kljuÄeve, Äime bi CAPTCHA postala neefikasna i poremetila funkcionalnost koja zavisi od nje, kao Å¡to su podnoÅ¡enje obrazaca i kontrola pristupa. Zavisno od implementacije ove CAPTCHA-e, ovo bi moglo dovesti ili do zaobilaÅ¾enja CAPTCHA-e ili do DoS napada ako upravljanje greÅ¡kama nije pravilno postavljeno na resursu.
```bash
# Delete API key
aws wafv2 delete-api-key --api-key <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Potencijalni uticaj**: OnemoguÄ‡avanje CAPTCHA zaÅ¡tite ili ometanje funkcionalnosti aplikacije, Å¡to moÅ¾e dovesti do sigurnosnih propusta i potencijalne kraÄ‘e podataka.

### **`wafv2:TagResource`, `wafv2:UntagResource`**

NapadaÄ bi bio u moguÄ‡nosti da dodaje, modifikuje ili uklanja oznake sa AWS WAFv2 resursa, kao Å¡to su Web ACL-ovi, grupa pravila, IP setovi, regex Å¡ablon setovi i konfiguracije beleÅ¾enja.
```bash
# Tag
aws wafv2 tag-resource --resource-arn <value> --tags <value>
# Untag
aws wafv2 untag-resource --resource-arn <value> --tag-keys <value>
```
**Potencijalni uticaj**: Menjanje resursa, otkrivanje informacija, manipulacija troÅ¡kovima i operativne smetnje.

# Reference
* [https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application](https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awswafv2.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awswafv2.html)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
