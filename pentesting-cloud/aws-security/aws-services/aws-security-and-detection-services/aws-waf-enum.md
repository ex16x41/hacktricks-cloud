# AWS - WAF Enum

<details>

<summary><strong>Zacznij nauk hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>

# AWS WAF

AWS WAF to **firewall aplikacji internetowych** zaprojektowany do **ochrony aplikacji internetowych lub interfejs贸w API** przed r贸偶nymi atakami internetowymi, kt贸re mog wpyn na ich dostpno, bezpieczestwo lub zu偶ycie zasob贸w. Umo偶liwia u偶ytkownikom kontrolowanie ruchu przychodzcego poprzez ustawianie **regu bezpieczestwa**, kt贸re agodz typowe wektory atak贸w, takie jak wstrzyknicia SQL lub ataki typu cross-site scripting oraz poprzez definiowanie niestandardowych regu filtrowania.

## Kluczowe koncepcje

### Web ACL (Access Control List)

Web ACL to zbi贸r regu, kt贸re mo偶na zastosowa do aplikacji internetowych lub interfejs贸w API. Gdy skojarzysz Web ACL z zasobem, AWS WAF sprawdza przychodzce 偶dania na podstawie zdefiniowanych regu w Web ACL i podejmuje okrelone dziaania.

### Grupa Regu

Grupa Regu to wielokrotnie u偶ywana kolekcja regu, kt贸re mo偶na zastosowa do wielu Web ACL. Grupy regu pomagaj zarzdza i utrzymywa sp贸jne zestawy regu w r贸偶nych aplikacjach internetowych lub interfejsach API.

Ka偶da grupa regu ma swoj powizan **pojemno**, kt贸ra pomaga obliczy i kontrolowa zasoby operacyjne u偶ywane do uruchamiania twoich regu, grup regu i Web ACL. Po ustawieniu wartoci podczas tworzenia, nie mo偶na jej modyfikowa.

### Regua

Regua definiuje zestaw warunk贸w, kt贸re AWS WAF wykorzystuje do sprawdzania przychodzcych 偶da internetowych. Istniej dwa g贸wne typy regu:

1. **Regua Regularna**: Ten typ reguy u偶ywa okrelonych warunk贸w do okrelenia, czy zezwoli, zablokowa czy zliczy 偶dania internetowe.
2. **Regua Oparta na Czstotliwoci**: Liczy 偶dania z okrelonego adresu IP w cigu piciu minut. Tutaj u偶ytkownicy definiuj pr贸g, a jeli liczba 偶da z danego IP przekroczy ten limit w cigu piciu minut, kolejne 偶dania z tego IP s blokowane, dop贸ki czstotliwo 偶da nie spadnie poni偶ej progu. Minimalny pr贸g dla regu opartych na czstotliwoci to **2000 偶da**.

### Zarzdzane Reguy

AWS WAF oferuje prekonfigurowane, zarzdzane zestawy regu utrzymywane przez AWS i sprzedawc贸w z AWS Marketplace. Te zestawy regu zapewniaj ochron przed powszechnymi zagro偶eniami i s regularnie aktualizowane, aby rozwizywa nowe podatnoci.

### Zestaw Adres贸w IP

Zestaw Adres贸w IP to lista adres贸w IP lub zakres贸w adres贸w IP, kt贸re chcesz zezwoli lub zablokowa. Zestawy IP uatwiaj zarzdzanie reguami opartymi na adresach IP.

### Zestaw Wzorc贸w Regex

Zestaw Wzorc贸w Regex zawiera jedno lub wicej wyra偶e regularnych (regex), kt贸re definiuj wzorce do wyszukiwania w 偶daniach internetowych. Jest to przydatne do bardziej zo偶onych scenariuszy dopasowywania, takich jak filtrowanie konkretnych sekwencji znak贸w.

### Token Blokady

Token Blokady su偶y do kontroli wsp贸bie偶noci podczas aktualizacji zasob贸w WAF. Zapewnia, 偶e zmiany nie zostan przypadkowo nadpisane przez wielu u偶ytkownik贸w lub procesy pr贸bujce jednoczenie aktualizowa ten sam zas贸b.

### Klucze API

Klucze API w AWS WAF su偶 do uwierzytelniania 偶da do okrelonych operacji interfejsu API. Klucze te s szyfrowane i zarzdzane w spos贸b bezpieczny, aby kontrolowa dostp i zapewni, 偶e tylko upowa偶nieni u偶ytkownicy mog dokonywa zmian w konfiguracjach WAF.

- **Przykad**: Integracja z API CAPTCHA.

### Polityka Uprawnie

Polityka Uprawnie to polityka IAM, kt贸ra okrela, kto mo偶e wykonywa dziaania na zasobach AWS WAF. Poprzez definiowanie uprawnie mo偶esz kontrolowa dostp do zasob贸w WAF i zapewni, 偶e tylko upowa偶nieni u偶ytkownicy mog tworzy, aktualizowa lub usuwa konfiguracje.

### Zakres

Parametr zakresu w AWS WAF okrela, czy reguy i konfiguracje WAF maj zastosowanie do regionalnej aplikacji czy dystrybucji Amazon CloudFront.

- **REGIONAL**: Dotyczy usug regionalnych, takich jak Load Balancer aplikacji (ALB), Amazon API Gateway REST API, AWS AppSync GraphQL API, pulpit u偶ytkownika Amazon Cognito, usuga AWS App Runner i instancja AWS Verified Access. Okrelasz region AWS, w kt贸rym znajduj si te zasoby.
- **CLOUDFRONT**: Dotyczy dystrybucji Amazon CloudFront, kt贸re s globalne. Konfiguracje WAF dla CloudFront s zarzdzane przez region `us-east-1`, niezale偶nie od tego, gdzie jest dostarczana zawarto.

## G贸wne funkcje

### Kryteria Monitorowania (Warunki)

**Warunki** okrelaj elementy przychodzcych 偶da HTTP/HTTPS, kt贸re AWS WAF monitoruje, obejmujc XSS, lokalizacj geograficzn (GEO), adresy IP, ograniczenia wielkoci, wstrzyknicia SQL oraz wzorce (dopasowanie cig贸w znak贸w i regex). Wa偶ne jest, 偶e **偶dania ograniczone na poziomie CloudFront na podstawie kraju nie dotr do WAF**.

Ka偶de konto AWS mo偶e skonfigurowa:

- **100 warunk贸w** dla ka偶dego typu (z wyjtkiem Regex, gdzie dozwolone jest tylko **10 warunk贸w**, ale ten limit mo偶na zwikszy).
- **100 regu** i **50 Web ACL**.
- Maksymalnie **5 regu opartych na czstotliwoci**.
- Przepustowo **10 000 偶da na sekund** przy implementacji WAF z balanserem obci偶enia aplikacji.

### Dziaania Regu

Dziaania s przypisywane do ka偶dej reguy, a opcje to:

- **Zezw贸l**: 呕danie jest przekazywane do odpowiedniej dystrybucji CloudFront lub balansera obci偶enia aplikacji.
- **Zablokuj**: 呕danie jest natychmiast zakoczone.
- **Zlicz**: Liczy 偶dania speniajce warunki reguy. Jest to przydatne do testowania reguy, potwierdzania dokadnoci reguy przed ustawieniem jej na Zezwalaj lub Blokuj.
- **CAPTCHA i Wyzwanie:** Sprawdzane jest, czy 偶danie nie pochodzi od bota, u偶ywajc amig贸wek CAPTCHA i cichych wyzwa.

Jeli 偶danie nie pasuje do 偶adnej reguy w Web ACL, podlega **domylnej akcji** (Zezw贸l lub Zablokuj). Kolejno wykonywania regu, zdefiniowana w ramach Web ACL, jest kluczowa i zazwyczaj pod偶a za t sekwencj:

1. Zezwalaj na IP z biaej listy.
2. Zablokuj IP z czarnej listy.
3. Zablokuj 偶dania pasujce do jakichkolwiek szkodliwych sygnatur.

### Integracja z CloudWatch

AWS WAF integruje si z CloudWatch w celu monitorowania, oferujc metryki takie jak AllowedRequests, BlockedRequests, CountedRequests i PassedRequests. Te metryki s raportowane co minut domylnie i przechowywane przez okres dw贸ch tygodni.

## Wyliczanie

Aby dziaa z dystrybucjami CloudFront, musisz okreli Region US East (N. Virginia):

- CLI - Okrel Region US East podczas korzystania z zakresu CloudFront: `--scope CLOUDFRONT --region=us-east-1`.
- API i SDK - Dla wszystkich wywoa u偶yj punktu kocowego Regionu us-east-1.

Aby dziaa z usugami regionalnymi, powiniene okreli region:

- Przykad z regionem Europa (Hiszpania): `--scope REGIONAL --region=eu-south-2`
```bash
# Web ACLs #

## Retrieve a list of web access control lists (Web ACLs) available in your AWS account
aws wafv2 list-web-acls --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve details about the specified Web ACL
aws wafv2 get-web-acl --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

## Retrieve a list of resources associated with a specific web access control list (Web ACL)
aws wafv2 list-resources-for-web-acl --web-acl-arn <value> # Additional permissions needed depending on the protected resource type: cognito-idp:ListResourcesForWebACL, ec2:DescribeVerifiedAccessInstanceWebAclAssociations or apprunner:ListAssociatedServicesForWebAcl
## Retrieve the Web ACL associated with the specified AWS resource
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Additional permissions needed depending on the protected resource type: cognito-idp:GetWebACLForResource, ec2:GetVerifiedAccessInstanceWebAcl, wafv2:GetWebACL or apprunner:DescribeWebAclForService

# Rule groups #

## List of the rule groups available in your AWS account
aws wafv2 list-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the details of a specific rule group
aws wafv2 get-rule-group [--name <value>] [--id <value>] [--arn <value>] [--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>]
## Retrieve the IAM policy attached to the specified rule group
aws wafv2 get-permission-policy --resource-arn <rule-group-arn> # Just the owner of the Rule Group can do this operation

# Managed rule groups (by AWS or by a third-party) #

## List the managed rule groups that are available
aws wafv2 list-available-managed-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## List the available versions of the specified managed rule group
aws wafv2 list-available-managed-rule-group-versions --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about a specific managed rule group
aws wafv2 describe-managed-rule-group --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--version-name <value>]
## Retrieve high-level information about all managed rule groups
aws wafv2 describe-all-managed-products --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about all managed rule groups from a specific vendor
aws wafv2 describe-managed-products-by-vendor --vendor-name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# IP sets #

## List the IP sets that are available in your AWS account
aws wafv2 list-ip-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the specific IP set
aws wafv2 get-ip-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the keys that are currently being managed by a rate-based rule.
aws wafv2 get-rate-based-statement-managed-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>\
--web-acl-name <value> --web-acl-id <value> --rule-name <value> [--rule-group-rule-name <value>]

# Regex pattern sets #

## List all the regex pattern sets that you manage
aws wafv2 list-regex-pattern-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieves the specified regex pattern sets
aws wafv2 get-regex-pattern-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# API Keys #

## List API keys for the specified scope
aws wafv2 list-api-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve decrypted API key
aws wafv2 get-decrypted-api-key --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --api-key <value>

# Logs #

## List of logging configurations (storage location of the logs)
aws wafv2 list-logging-configurations --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--log-scope <value>]
## Retrieve the logging configuration settings associated with a specific web ACL
aws wafv2 get-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]

# Miscelaneous #

## Retrieve a list of the tags associated to the specified resource
aws wafv2 list-tags-for-resource resource-arn <value>

## Retrieve a sample of web requests that match a specified rule within a WebACL during a specified time range
aws wafv2 get-sampled-requests --web-acl-arn <value> --rule-metric-name <value> --time-window <value> --max-items <1-500> --scope <value>

## Obtains the web ACL capacity unit (WCU) requirements for a specified scope and ruleset
aws wafv2 check-capacity --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --rules <value>

## List of available releases for the AWS WAFv2 mobile SDK
aws wafv2 list-mobile-sdk-releases --platform <IOS | ANDROID>
## Retrieves information for the specified mobile SDK release
aws wafv2 get-mobile-sdk-release --platform <value> --release-version <value>

```
## Post Eksploatacja / Ominicie

{% hint style="success" %}
Z perspektywy atakujcego, ta usuga mo偶e pom贸c atakujcemu zidentyfikowa zabezpieczenia WAF oraz nara偶enia sieciowe, kt贸re mog mu pom贸c w skompromitowaniu innych stron internetowych.

Jednak atakujcy mo偶e tak偶e by zainteresowany zak贸ceniem tej usugi, aby strony nie byy chronione przez WAF.
{% endhint %}

W wielu operacjach Usu i Aktualizuj konieczne bdzie podanie **tokena blokady**. Ten token su偶y do kontroli wsp贸bie偶noci nad zasobami, zapewniajc, 偶e zmiany nie zostan przypadkowo nadpisane przez wielu u偶ytkownik贸w lub procesy pr贸bujce jednoczenie aktualizowa ten sam zas贸b. Aby uzyska ten token, mo偶na wykona odpowiednie operacje **list** lub **get** na okrelonym zasobie.

### **`wafv2:CreateRuleGroup`, `wafv2:UpdateRuleGroup`, `wafv2:DeleteRuleGroup`**

Atakujcy m贸gby skompromitowa bezpieczestwo dotknitego zasobu poprzez:

- Tworzenie grup regu, kt贸re na przykad mog blokowa ruch z prawidowych adres贸w IP, powodujc odmow usugi.
- Aktualizacja grup regu, umo偶liwiajc modyfikacj dziaa, na przykad z **Blokuj** na **Zezwalaj**.
- Usuwanie grup regu, kt贸re zapewniaj istotne rodki bezpieczestwa.
```bash
# Create Rule Group
aws wafv2 create-rule-group --name <value> --capacity <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Update Rule Group
aws wafv2 update-rule-group --name <value> --id <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Delete Rule Group
aws wafv2 delete-rule-group --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Przykady pokazuj grup regu, kt贸ra zablokowaaby legalny ruch z okrelonych adres贸w IP:
```bash
aws wafv2 create-rule-group --name BlockLegitimateIPsRuleGroup --capacity 1 --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=BlockLegitimateIPsRuleGroup --scope CLOUDFRONT --region us-east-1 --rules file://rule.json
```
Plik **rule.json** miaby posta:
```json
[
{
"Name":"BlockLegitimateIPsRule",
"Priority":0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:global/ipset/legitIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action":{
"Block":{}
},
"VisibilityConfig":{
"SampledRequestsEnabled":false,
"CloudWatchMetricsEnabled":false,
"MetricName":"BlockLegitimateIPsRule"
}
}
]
```
**Potencjalne skutki**: Nieautoryzowany dostp, naruszenia danych oraz potencjalne ataki typu DoS.

### **`wafv2:CreateWebACL`, `wafv2:UpdateWebACL`, `wafv2:DeleteWebACL`**

Z tymi uprawnieniami atakujcy byby w stanie:

- Tworzy nowy Web ACL, wprowadzajc reguy, kt贸re pozwalaj na przepuszczenie zoliwego ruchu lub blokuj prawidowy ruch, skutecznie uniemo偶liwiajc dziaanie WAF lub powodujc odmow usugi.
- Aktualizowa istniejce Web ACL, modyfikujc reguy umo偶liwiajce ataki takie jak wstrzyknicia SQL lub ataki typu cross-site scripting, kt贸re wczeniej byy blokowane, lub zak贸ca normalny przepyw ruchu, blokujc prawidowe 偶dania.
- Usuwa Web ACL, pozostawiajc dotknite zasoby cakowicie niechronione, nara偶ajc je na szeroki zakres atak贸w internetowych.

{% hint style="info" %}

Mo偶esz usun okrelony **WebACL** tylko jeli **ManagedByFirewallManager** ma warto false.

{% endhint %}
```bash
# Create Web ACL
aws wafv2 create-web-acl --name <value> --default-action <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Update Web ACL
aws wafv2 update-web-acl --name <value> --id <value> --default-action <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Delete Web ACL
aws wafv2 delete-web-acl --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Oto przykady pokazujce, jak zaktualizowa list kontroln sieci Web (Web ACL), aby zablokowa legalny ruch z okrelonego zestawu adres贸w IP. Jeli adres IP 藕r贸dowy nie pasuje do 偶adnego z tych adres贸w IP, domylna akcja r贸wnie偶 go zablokuje, co spowoduje atak typu DoS.**

**Oryginalna lista kontrolna sieci Web (Web ACL):**
```json
{
"WebACL": {
"Name": "AllowLegitimateIPsWebACL",
"Id": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/AllowLegitimateIPsWebACL/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"DefaultAction": {
"Allow": {}
},
"Description": "",
"Rules": [
{
"Name": "AllowLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Allow": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsRule"
}
}
],
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsWebACL"
},
"Capacity": 1,
"ManagedByFirewallManager": false,
"LabelNamespace": "awswaf:123456789012:webacl:AllowLegitimateIPsWebACL:"
},
"LockToken": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}

```
### Update Web ACL

### Aktualizacja listy kontrolnej sieci Web

```bash
aws waf update-web-acl --web-acl-id <value> --updates <value>
```
```json
aws wafv2 update-web-acl --name AllowLegitimateIPsWebACL --scope REGIONAL --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --default-action Block={} --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=AllowLegitimateIPsWebACL --rules file://rule.json --region us-east-1
```
Plik **rule.json** miaby posta:
```json
[
{
"Name": "BlockLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Block": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "BlockLegitimateIPRule"
}
}
]
```
**Potencjalny wpyw**: Nieautoryzowany dostp, naruszenia danych oraz potencjalne ataki typu DoS.

### **`wafv2:AssociateWebACL`, `wafv2:DisassociateWebACL`**

Uprawnienie **`wafv2:AssociateWebACL`** umo偶liwioby atakujcemu powizanie list kontrolnych dostpu (ACL) z zasobami, co pozwolioby omin kontrole bezpieczestwa, umo偶liwiajc nieautoryzowany ruch do aplikacji, potencjalnie prowadzc do eksploatacji takiej jak wstrzyknicia SQL lub ataki typu cross-site scripting (XSS). Z kolei, dziki uprawnieniu **`wafv2:DisassociateWebACL`**, atakujcy m贸gby tymczasowo wyczy zabezpieczenia, nara偶ajc zasoby na podatnoci bez wykrycia.

Dodatkowe uprawnienia bd wymagane w zale偶noci od typu chronionego zasobu:

- **Powi偶**
- apigateway:SetWebACL
- apprunner:AssociateWebAcl
- appsync:SetWebACL
- cognito-idp:AssociateWebACL
- ec2:AssociateVerifiedAccessInstanceWebAcl
- elasticloadbalancing:SetWebAcl
- **Rozcz**
- apigateway:SetWebACL
- apprunner:DisassociateWebAcl
- appsync:SetWebACL
- cognito-idp:DisassociateWebACL
- ec2:DisassociateVerifiedAccessInstanceWebAcl
- elasticloadbalancing:SetWebAcl
```bash
# Associate
aws wafv2 associate-web-acl --web-acl-arn <value> --resource-arn <value>
# Disassociate
aws wafv2 disassociate-web-acl --resource-arn <value>
```
**Potencjalny wpyw**: Zwikszone ryzyko bezpieczestwa zasob贸w, zwikszone ryzyko eksploatacji oraz potencjalne zak贸cenia w wiadczeniu usug w rodowiskach AWS chronionych przez AWS WAF.

### **`wafv2:CreateIPSet`, `wafv2:UpdateIPSet`, `wafv2:DeleteIPSet`**

Atakujcy byby w stanie tworzy, aktualizowa i usuwa zestawy IP zarzdzane przez AWS WAF. Mo偶e to by niebezpieczne, poniewa偶 m贸gby tworzy nowe zestawy IP, aby zezwoli na zoliwy ruch, modyfikowa zestawy IP w celu zablokowania prawidowego ruchu, aktualizowa istniejce zestawy IP, aby zawieray zoliwe adresy IP, usuwa zaufane adresy IP lub usuwa krytyczne zestawy IP, kt贸re maj chroni krytyczne zasoby.
```bash
# Create IP set
aws wafv2 create-ip-set --name <value> --ip-address-version <IPV4 | IPV6> --addresses <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Update IP set
aws wafv2 update-ip-set --name <value> --id <value> --addresses <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete IP set
aws wafv2 delete-ip-set --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Poni偶szy przykad pokazuje, jak **nadpisa istniejcy zestaw IP przez po偶dany zestaw IP**:
```bash
aws wafv2 update-ip-set --name LegitimateIPv4Set --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --addresses 99.99.99.99/32 --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --scope CLOUDFRONT --region us-east-1
```
**Potencjalny wpyw**: Nieautoryzowany dostp i blokada legalnego ruchu.

### **`wafv2:CreateRegexPatternSet`**, **`wafv2:UpdateRegexPatternSet`**, **`wafv2:DeleteRegexPatternSet`**

Atakujcy posiadajcy te uprawnienia byby w stanie manipulowa zestawami wzorc贸w wyra偶e regularnych u偶ywanych przez AWS WAF do kontrolowania i filtrowania przychodzcego ruchu na podstawie okrelonych wzorc贸w.

- Tworzenie nowych wzorc贸w regex pomogoby atakujcemu w dopuszczeniu szkodliwej zawartoci
- Aktualizujc istniejce wzorce, atakujcy m贸gby omin zasady bezpieczestwa
- Usuwanie wzorc贸w zaprojektowanych do blokowania zoliwych dziaa mogoby skoni atakujcego do wysyania zoliwych adunk贸w i omijania rodk贸w bezpieczestwa.
```bash
# Create regex pattern set
aws wafv2 create-regex-pattern-set --name <value> --regular-expression-list <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--description <value>]
# Update regex pattern set
aws wafv2 update-regex-pattern-set --name <value> --id <value> --regular-expression-list <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete regex pattern set
aws wafv2 delete-regex-pattern-set --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --id <value> --lock-token <value>
```
**Potencjalne skutki**: Ominicie kontroli bezpieczestwa, umo偶liwiajce wstrzyknicie zoliwej zawartoci i potencjalnie ujawnienie poufnych danych lub zak贸cenie usug i zasob贸w chronionych przez AWS WAF.

### **(`wavf2:PutLoggingConfiguration` &** `iam:CreateServiceLinkedRole`), **`wafv2:DeleteLoggingConfiguration`**

Atakujcy posiadajcy uprawnienia **`wafv2:DeleteLoggingConfiguration`** m贸gby usun konfiguracj logowania z okrelonego Web ACL. Nastpnie, posiadajc uprawnienia **`wavf2:PutLoggingConfiguration`** i **`iam:CreateServiceLinkedRole`**, atakujcy m贸gby utworzy lub zastpi konfiguracje logowania (po jej usuniciu), aby albo cakowicie uniemo偶liwi logowanie, albo przekierowa logi do nieautoryzowanych miejsc docelowych, takich jak wiadra Amazon S3, grupa log贸w Amazon CloudWatch Logs lub strumie Amazon Kinesis Data Firehose pod kontrol.

Podczas procesu tworzenia usuga automatycznie ustawia niezbdne uprawnienia, aby umo偶liwi zapisywanie log贸w do okrelonego miejsca docelowego logowania:

- **Amazon CloudWatch Logs:** AWS WAF tworzy polityk zasobu na wyznaczonej grupie log贸w CloudWatch Logs. Ta polityka zapewnia, 偶e AWS WAF ma wymagane uprawnienia do zapisywania log贸w do grupy log贸w.
- **Wiadro Amazon S3:** AWS WAF tworzy polityk wiadra na wyznaczonym wiadrze S3. Ta polityka nadaje AWS WAF uprawnienia niezbdne do przesyania log贸w do okrelonego wiadra.
- **Amazon Kinesis Data Firehose:** AWS WAF tworzy rol powizan z usug specjalnie do interakcji z Kinesis Data Firehose. Ta rola umo偶liwia AWS WAF dostarczanie log贸w do skonfigurowanego strumienia Firehose.

{% hint style="info" %}

Mo偶liwe jest zdefiniowanie tylko jednego miejsca docelowego logowania na jeden Web ACL.

{% endhint %}
```bash
# Put logging configuration
aws wafv2 put-logging-configuration --logging-configuration <value>
# Delete logging configuration
aws wafv2 delete-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]
```
**Potencjalny wpyw:** Zaciemnienie widocznoci zdarze zwizanych z bezpieczestwem, utrudnienie procesu reagowania na incydenty oraz uatwienie ukrytych zoliwych dziaa w rodowiskach chronionych przez AWS WAF.

### **`wafv2:DeleteAPIKey`**

Atakujcy posiadajcy te uprawnienia m贸gby usun istniejce klucze API, uniemo偶liwiajc dziaanie CAPTCHA i zak贸cajc funkcjonalno z ni zwizan, tak jak przesyanie formularzy i kontrole dostpu. W zale偶noci od implementacji tego CAPTCHA, mo偶e to prowadzi do jego pominicia lub DoS, jeli zarzdzanie bdami nie jest odpowiednio skonfigurowane w zasobie.
```bash
# Delete API key
aws wafv2 delete-api-key --api-key <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Potencjalne skutki**: Wyczenie ochrony CAPTCHA lub zak贸cenie funkcjonalnoci aplikacji, co prowadzi do narusze bezpieczestwa i potencjalnej kradzie偶y danych.

### **`wafv2:TagResource`, `wafv2:UntagResource`**

Atakujcy byby w stanie doda, zmodyfikowa lub usun tagi z zasob贸w AWS WAFv2, takich jak listy kontrolne sieci Web ACL, grupy regu, zestawy adres贸w IP, zestawy wzorc贸w regex oraz konfiguracje logowania.
```bash
# Tag
aws wafv2 tag-resource --resource-arn <value> --tags <value>
# Untag
aws wafv2 untag-resource --resource-arn <value> --tag-keys <value>
```
**Potencjalne skutki**: Sfaszowanie zasob贸w, wyciek informacji, manipulacja kosztami i zak贸cenia operacyjne.

# Odnoniki
* [https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application](https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awswafv2.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awswafv2.html)

<details>

<summary><strong>Zdobd藕 wiedz na temat hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
