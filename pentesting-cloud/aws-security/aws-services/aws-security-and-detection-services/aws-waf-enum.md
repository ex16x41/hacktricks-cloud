# AWS - WAF Enum

## AWS - WAF Enum

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Bize katÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi** **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n,** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek.

</details>
{% endhint %}

## AWS WAF

AWS WAF, **web uygulamalarÄ±nÄ± veya API'leri** Ã§eÅŸitli web istismarlarÄ±na karÅŸÄ± **korumak** iÃ§in tasarlanmÄ±ÅŸ bir **web uygulama gÃ¼venlik duvarÄ±dÄ±r**. KullanÄ±cÄ±lara, SQL enjeksiyonu veya Ã§apraz site betikleme gibi tipik saldÄ±rÄ± vektÃ¶rlerini azaltan **gÃ¼venlik kurallarÄ±** oluÅŸturarak gelen trafiÄŸi kontrol etme imkanÄ± sunar ve ayrÄ±ca Ã¶zel filtreleme kurallarÄ± tanÄ±mlayarak.

### Temel kavramlar

#### Web ACL (EriÅŸim Kontrol Listesi)

Web ACL, web uygulamalarÄ±nÄ±za veya API'lerinize uygulayabileceÄŸiniz bir kural koleksiyonudur. Bir Web ACL'yi bir kaynakla iliÅŸkilendirdiÄŸinizde, AWS WAF, Web ACL'de tanÄ±mlanan kurallara gÃ¶re gelen istekleri inceler ve belirtilen eylemleri gerÃ§ekleÅŸtirir.

#### Kural Grubu

Kural Grubu, birden fazla Web ACL'ye uygulayabileceÄŸiniz yeniden kullanÄ±labilir bir kural koleksiyonudur. Kural gruplarÄ±, farklÄ± web uygulamalarÄ± veya API'ler arasÄ±nda tutarlÄ± kural setlerini yÃ¶netmeye ve sÃ¼rdÃ¼rmeye yardÄ±mcÄ± olur.

Her kural grubunun iliÅŸkili bir **kapasitesi** vardÄ±r; bu, kurallarÄ±nÄ±zÄ±, kural gruplarÄ±nÄ±zÄ± ve web ACL'lerinizi Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanÄ±lan iÅŸletim kaynaklarÄ±nÄ± hesaplamaya ve kontrol etmeye yardÄ±mcÄ± olur. OluÅŸturma sÄ±rasÄ±nda deÄŸeri belirlendikten sonra, deÄŸiÅŸtirilmesi mÃ¼mkÃ¼n deÄŸildir.

#### Kural

Bir kural, AWS WAF'nin gelen web isteklerini incelemek iÃ§in kullandÄ±ÄŸÄ± bir dizi koÅŸulu tanÄ±mlar. Ä°ki ana kural tÃ¼rÃ¼ vardÄ±r:

1. **DÃ¼zenli Kural**: Bu kural tÃ¼rÃ¼, web isteklerini kabul etme, engelleme veya sayma kararÄ±nÄ± vermek iÃ§in belirli koÅŸullarÄ± kullanÄ±r.
2. **Oran TabanlÄ± Kural**: Belirli bir IP adresinden gelen istekleri beÅŸ dakikalÄ±k bir sÃ¼re iÃ§inde sayar. Burada, kullanÄ±cÄ±lar bir eÅŸik tanÄ±mlar ve bir IP'den gelen istek sayÄ±sÄ± bu sÄ±nÄ±rÄ± beÅŸ dakika iÃ§inde aÅŸarsa, o IP'den gelen sonraki istekler, istek oranÄ± eÅŸik altÄ±na dÃ¼ÅŸene kadar engellenir. Oran tabanlÄ± kurallar iÃ§in minimum eÅŸik **2000 istektir**.

#### YÃ¶netilen Kurallar

AWS WAF, AWS ve AWS Marketplace satÄ±cÄ±larÄ± tarafÄ±ndan yÃ¶netilen Ã¶nceden yapÄ±landÄ±rÄ±lmÄ±ÅŸ kural setleri sunar. Bu kural setleri, yaygÄ±n tehditlere karÅŸÄ± koruma saÄŸlar ve yeni gÃ¼venlik aÃ§Ä±klarÄ±nÄ± ele almak iÃ§in dÃ¼zenli olarak gÃ¼ncellenir.

#### IP Seti

IP Seti, izin vermek veya engellemek istediÄŸiniz IP adresleri veya IP adresi aralÄ±klarÄ±nÄ±n bir listesidir. IP setleri, IP tabanlÄ± kurallarÄ± yÃ¶netme sÃ¼recini basitleÅŸtirir.

#### Regex Desen Seti

Regex Desen Seti, web isteklerinde aramak iÃ§in desenleri tanÄ±mlayan bir veya daha fazla dÃ¼zenli ifade (regex) iÃ§erir. Bu, belirli karakter dizilerini filtrelemek gibi daha karmaÅŸÄ±k eÅŸleÅŸtirme senaryolarÄ± iÃ§in yararlÄ±dÄ±r.

#### Kilit Tokeni

Kilit Tokeni, WAF kaynaklarÄ±nÄ± gÃ¼ncellerken eÅŸzamanlÄ±lÄ±k kontrolÃ¼ iÃ§in kullanÄ±lÄ±r. Bu, deÄŸiÅŸikliklerin aynÄ± kaynaÄŸÄ± gÃ¼ncellemeye Ã§alÄ±ÅŸan birden fazla kullanÄ±cÄ± veya iÅŸlem tarafÄ±ndan yanlÄ±ÅŸlÄ±kla Ã¼zerine yazÄ±lmadÄ±ÄŸÄ±ndan emin olur.

#### API AnahtarlarÄ±

AWS WAF'deki API AnahtarlarÄ±, belirli API iÅŸlemlerine yapÄ±lan istekleri kimlik doÄŸrulamak iÃ§in kullanÄ±lÄ±r. Bu anahtarlar ÅŸifrelenir ve gÃ¼venli bir ÅŸekilde yÃ¶netilir, bÃ¶ylece yalnÄ±zca yetkili kullanÄ±cÄ±larÄ±n WAF yapÄ±landÄ±rmalarÄ±nda deÄŸiÅŸiklik yapabilmesi saÄŸlanÄ±r.

* **Ã–rnek**: CAPTCHA API'sinin entegrasyonu.

#### Ä°zin PolitikasÄ±

Ä°zin PolitikasÄ±, AWS WAF kaynaklarÄ± Ã¼zerinde hangi eylemlerin gerÃ§ekleÅŸtirilebileceÄŸini belirten bir IAM politikasÄ±nÄ± ifade eder. Ä°zinleri tanÄ±mlayarak, WAF kaynaklarÄ±na eriÅŸimi kontrol edebilir ve yalnÄ±zca yetkili kullanÄ±cÄ±larÄ±n yapÄ±landÄ±rmalarÄ± oluÅŸturmasÄ±nÄ±, gÃ¼ncellemesini veya silmesini saÄŸlayabilirsiniz.

#### Kapsam

AWS WAF'deki kapsam parametresi, WAF kurallarÄ±nÄ±n ve yapÄ±landÄ±rmalarÄ±nÄ±n bÃ¶lgesel bir uygulamaya veya bir Amazon CloudFront daÄŸÄ±tÄ±mÄ±na uygulanÄ±p uygulanmadÄ±ÄŸÄ±nÄ± belirtir.

* **BÃ–LGESEL**: Uygulama YÃ¼k Dengeleyicileri (ALB), Amazon API Gateway REST API, AWS AppSync GraphQL API, Amazon Cognito kullanÄ±cÄ± havuzu, AWS App Runner hizmeti ve AWS Verified Access Ã¶rneÄŸi gibi bÃ¶lgesel hizmetlere uygulanÄ±r. Bu kaynaklarÄ±n bulunduÄŸu AWS bÃ¶lgesini belirtirsiniz.
* **CLOUDFRONT**: Amazon CloudFront daÄŸÄ±tÄ±mlarÄ±na uygulanÄ±r, bu daÄŸÄ±tÄ±mlar kÃ¼reseldir. CloudFront iÃ§in WAF yapÄ±landÄ±rmalarÄ±, iÃ§eriÄŸin nerede sunulduÄŸuna bakÄ±lmaksÄ±zÄ±n `us-east-1` bÃ¶lgesi Ã¼zerinden yÃ¶netilir.

### Temel Ã¶zellikler

#### Ä°zleme Kriterleri (KoÅŸullar)

**KoÅŸullar**, AWS WAF'nin izlediÄŸi gelen HTTP/HTTPS isteklerinin unsurlarÄ±nÄ± belirtir; bunlar arasÄ±nda XSS, coÄŸrafi konum (GEO), IP adresleri, Boyut kÄ±sÄ±tlamalarÄ±, SQL Enjeksiyonu ve desenler (dize ve regex eÅŸleÅŸtirme) bulunur. **Ãœlkeye dayalÄ± olarak CloudFront seviyesinde kÄ±sÄ±tlanan isteklerin WAF'ye ulaÅŸmayacaÄŸÄ±nÄ±** belirtmek Ã¶nemlidir.

Her AWS hesabÄ± ÅŸunlarÄ± yapÄ±landÄ±rabilir:

* Her tÃ¼r iÃ§in **100 koÅŸul** (Regex iÃ§in yalnÄ±zca **10 koÅŸul** izin verilir, ancak bu sÄ±nÄ±r artÄ±rÄ±labilir).
* **100 kural** ve **50 Web ACL**.
* En fazla **5 oran tabanlÄ± kural**.
* Uygulama yÃ¼k dengeleyicisi ile WAF uygulandÄ±ÄŸÄ±nda **saniyede 10,000 istek** throughput'u.

#### Kural eylemleri

Eylemler, her kurala atanÄ±r ve seÃ§enekler ÅŸunlardÄ±r:

* **Ä°zin Ver**: Ä°stek, uygun CloudFront daÄŸÄ±tÄ±mÄ±na veya Uygulama YÃ¼k Dengeleyicisine iletilir.
* **Engelle**: Ä°stek hemen sonlandÄ±rÄ±lÄ±r.
* **Say**: KuralÄ±n koÅŸullarÄ±nÄ± karÅŸÄ±layan istekleri sayar. Bu, kural testleri iÃ§in yararlÄ±dÄ±r, kuralÄ±n doÄŸruluÄŸunu onaylamak iÃ§in Ä°zin Ver veya Engelle olarak ayarlamadan Ã¶nce.
* **CAPTCHA ve Challenge:** Ä°steÄŸin bir bot tarafÄ±ndan gelmediÄŸi, CAPTCHA bulmacalarÄ± ve sessiz zorluklar kullanÄ±larak doÄŸrulanÄ±r.

EÄŸer bir istek Web ACL iÃ§indeki hiÃ§bir kuralla eÅŸleÅŸmezse, **varsayÄ±lan eylem** (Ä°zin Ver veya Engelle) uygulanÄ±r. Bir Web ACL iÃ§inde tanÄ±mlanan kural yÃ¼rÃ¼tme sÄ±rasÄ± kritik Ã¶neme sahiptir ve genellikle ÅŸu sÄ±rayÄ± takip eder:

1. Beyaz listeye alÄ±nmÄ±ÅŸ IP'lere izin ver.
2. Kara listeye alÄ±nmÄ±ÅŸ IP'leri engelle.
3. ZararlÄ± imzalara uyan istekleri engelle.

#### CloudWatch Entegrasyonu

AWS WAF, izleme iÃ§in CloudWatch ile entegre olur ve AllowedRequests, BlockedRequests, CountedRequests ve PassedRequests gibi metrikler sunar. Bu metrikler varsayÄ±lan olarak her dakika raporlanÄ±r ve iki hafta boyunca saklanÄ±r.

### SayÄ±m

CloudFront daÄŸÄ±tÄ±mlarÄ±yla etkileÅŸimde bulunmak iÃ§in, US East (N. Virginia) BÃ¶lgesini belirtmelisiniz:

* CLI - CloudFront kapsamÄ±nÄ± kullanÄ±rken US East BÃ¶lgesini belirtin: `--scope CLOUDFRONT --region=us-east-1`.
* API ve SDK'lar - TÃ¼m Ã§aÄŸrÄ±lar iÃ§in, us-east-1 BÃ¶lge uÃ§ noktasÄ±nÄ± kullanÄ±n.

BÃ¶lgesel hizmetlerle etkileÅŸimde bulunmak iÃ§in, bÃ¶lgeyi belirtmelisiniz:

* BÃ¶lge Avrupa (Ä°spanya) ile Ã¶rnek: `--scope REGIONAL --region=eu-south-2`
```bash
# Web ACLs #

## Retrieve a list of web access control lists (Web ACLs) available in your AWS account
aws wafv2 list-web-acls --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve details about the specified Web ACL
aws wafv2 get-web-acl --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

## Retrieve a list of resources associated with a specific web access control list (Web ACL)
aws wafv2 list-resources-for-web-acl --web-acl-arn <value> # Additional permissions needed depending on the protected resource type: cognito-idp:ListResourcesForWebACL, ec2:DescribeVerifiedAccessInstanceWebAclAssociations or apprunner:ListAssociatedServicesForWebAcl
## Retrieve the Web ACL associated with the specified AWS resource
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Additional permissions needed depending on the protected resource type: cognito-idp:GetWebACLForResource, ec2:GetVerifiedAccessInstanceWebAcl, wafv2:GetWebACL or apprunner:DescribeWebAclForService

# Rule groups #

## List of the rule groups available in your AWS account
aws wafv2 list-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the details of a specific rule group
aws wafv2 get-rule-group [--name <value>] [--id <value>] [--arn <value>] [--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>]
## Retrieve the IAM policy attached to the specified rule group
aws wafv2 get-permission-policy --resource-arn <rule-group-arn> # Just the owner of the Rule Group can do this operation

# Managed rule groups (by AWS or by a third-party) #

## List the managed rule groups that are available
aws wafv2 list-available-managed-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## List the available versions of the specified managed rule group
aws wafv2 list-available-managed-rule-group-versions --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about a specific managed rule group
aws wafv2 describe-managed-rule-group --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--version-name <value>]
## Retrieve high-level information about all managed rule groups
aws wafv2 describe-all-managed-products --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about all managed rule groups from a specific vendor
aws wafv2 describe-managed-products-by-vendor --vendor-name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# IP sets #

## List the IP sets that are available in your AWS account
aws wafv2 list-ip-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the specific IP set
aws wafv2 get-ip-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the keys that are currently being managed by a rate-based rule.
aws wafv2 get-rate-based-statement-managed-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>\
--web-acl-name <value> --web-acl-id <value> --rule-name <value> [--rule-group-rule-name <value>]

# Regex pattern sets #

## List all the regex pattern sets that you manage
aws wafv2 list-regex-pattern-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieves the specified regex pattern sets
aws wafv2 get-regex-pattern-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# API Keys #

## List API keys for the specified scope
aws wafv2 list-api-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve decrypted API key
aws wafv2 get-decrypted-api-key --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --api-key <value>

# Logs #

## List of logging configurations (storage location of the logs)
aws wafv2 list-logging-configurations --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--log-scope <value>]
## Retrieve the logging configuration settings associated with a specific web ACL
aws wafv2 get-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]

# Miscelaneous #

## Retrieve a list of the tags associated to the specified resource
aws wafv2 list-tags-for-resource resource-arn <value>

## Retrieve a sample of web requests that match a specified rule within a WebACL during a specified time range
aws wafv2 get-sampled-requests --web-acl-arn <value> --rule-metric-name <value> --time-window <value> --max-items <1-500> --scope <value>

## Obtains the web ACL capacity unit (WCU) requirements for a specified scope and ruleset
aws wafv2 check-capacity --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --rules <value>

## List of available releases for the AWS WAFv2 mobile SDK
aws wafv2 list-mobile-sdk-releases --platform <IOS | ANDROID>
## Retrieves information for the specified mobile SDK release
aws wafv2 get-mobile-sdk-release --platform <value> --release-version <value>

```
### Post Exploitation / Bypass

{% hint style="success" %}
Bir saldÄ±rganÄ±n perspektifinden, bu hizmet saldÄ±rgana WAF korumalarÄ±nÄ± ve diÄŸer web sitelerini tehlikeye atmasÄ±na yardÄ±mcÄ± olabilecek aÄŸ aÃ§Ä±klarÄ±nÄ± tanÄ±mlamasÄ±nda yardÄ±mcÄ± olabilir.

Ancak, bir saldÄ±rgan bu hizmeti kesintiye uÄŸratmakla da ilgilenebilir, bÃ¶ylece web siteleri WAF tarafÄ±ndan korunmaz.
{% endhint %}

Silme ve GÃ¼ncelleme iÅŸlemlerinin Ã§oÄŸunda **lock token** saÄŸlamak gerekli olacaktÄ±r. Bu token, kaynaklar Ã¼zerinde eÅŸzamanlÄ±lÄ±k kontrolÃ¼ iÃ§in kullanÄ±lÄ±r ve deÄŸiÅŸikliklerin birden fazla kullanÄ±cÄ± veya iÅŸlemin aynÄ± kaynaÄŸÄ± aynÄ± anda gÃ¼ncellemeye Ã§alÄ±ÅŸÄ±rken kazara Ã¼zerine yazÄ±lmasÄ±nÄ± Ã¶nler. Bu token'Ä± elde etmek iÃ§in, belirli kaynak Ã¼zerinde ilgili **list** veya **get** iÅŸlemlerini gerÃ§ekleÅŸtirebilirsiniz.

#### **`wafv2:CreateRuleGroup`, `wafv2:UpdateRuleGroup`, `wafv2:DeleteRuleGroup`**

Bir saldÄ±rgan, etkilenen kaynaÄŸÄ±n gÃ¼venliÄŸini tehlikeye atabilir:

* Ã–rneÄŸin, meÅŸru IP adreslerinden gelen meÅŸru trafiÄŸi engelleyebilecek kural gruplarÄ± oluÅŸturarak, hizmet reddine neden olabilir.
* Kural gruplarÄ±nÄ± gÃ¼ncelleyerek, Ã¶rneÄŸin **Block**'tan **Allow**'a eylemlerini deÄŸiÅŸtirebilir.
* Kritik gÃ¼venlik Ã¶nlemleri saÄŸlayan kural gruplarÄ±nÄ± silerek.
```bash
# Create Rule Group
aws wafv2 create-rule-group --name <value> --capacity <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Update Rule Group
aws wafv2 update-rule-group --name <value> --id <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Delete Rule Group
aws wafv2 delete-rule-group --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
AÅŸaÄŸÄ±daki Ã¶rnekler, belirli IP adreslerinden gelen meÅŸru trafiÄŸi engelleyecek bir kural grubunu gÃ¶stermektedir:
```bash
aws wafv2 create-rule-group --name BlockLegitimateIPsRuleGroup --capacity 1 --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=BlockLegitimateIPsRuleGroup --scope CLOUDFRONT --region us-east-1 --rules file://rule.json
```
**rule.json** dosyasÄ± ÅŸÃ¶yle gÃ¶rÃ¼necektir:
```json
[
{
"Name":"BlockLegitimateIPsRule",
"Priority":0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:global/ipset/legitIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action":{
"Block":{}
},
"VisibilityConfig":{
"SampledRequestsEnabled":false,
"CloudWatchMetricsEnabled":false,
"MetricName":"BlockLegitimateIPsRule"
}
}
]
```
**Potansiyel Etki**: Yetkisiz eriÅŸim, veri ihlalleri ve potansiyel DoS saldÄ±rÄ±larÄ±.

#### **`wafv2:CreateWebACL`, `wafv2:UpdateWebACL`, `wafv2:DeleteWebACL`**

Bu izinlerle, bir saldÄ±rgan ÅŸunlarÄ± yapabilir:

* Yeni bir Web ACL oluÅŸturmak, kÃ¶tÃ¼ niyetli trafiÄŸi geÃ§iren veya meÅŸru trafiÄŸi engelleyen kurallar ekleyerek WAF'Ä± etkisiz hale getirmek veya hizmet reddine neden olmak.
* Mevcut Web ACL'leri gÃ¼ncellemek, daha Ã¶nce engellenmiÅŸ SQL enjeksiyonu veya Ã§apraz site betikleme gibi saldÄ±rÄ±lara izin verecek ÅŸekilde kurallarÄ± deÄŸiÅŸtirmek veya geÃ§erli istekleri engelleyerek normal trafik akÄ±ÅŸÄ±nÄ± bozmak.
* Bir Web ACL'yi silmek, etkilenen kaynaklarÄ± tamamen korumasÄ±z bÄ±rakmak ve geniÅŸ bir web saldÄ±rÄ±sÄ± yelpazesine maruz bÄ±rakmak.

{% hint style="info" %}
Belirtilen **WebACL**'yi yalnÄ±zca **ManagedByFirewallManager** false ise silebilirsiniz.
{% endhint %}
```bash
# Create Web ACL
aws wafv2 create-web-acl --name <value> --default-action <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Update Web ACL
aws wafv2 update-web-acl --name <value> --id <value> --default-action <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Delete Web ACL
aws wafv2 delete-web-acl --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
AÅŸaÄŸÄ±daki Ã¶rnekler, belirli bir IP kÃ¼mesinden gelen meÅŸru trafiÄŸi engellemek iÃ§in bir Web ACL'sini nasÄ±l gÃ¼ncelleyeceÄŸinizi gÃ¶stermektedir. EÄŸer kaynak IP bu IP'lerden herhangi biriyle eÅŸleÅŸmiyorsa, varsayÄ±lan eylem de onu engellemek olacaktÄ±r ve bu bir DoS'a neden olabilir.

**Orijinal Web ACL**:
```json
{
"WebACL": {
"Name": "AllowLegitimateIPsWebACL",
"Id": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/AllowLegitimateIPsWebACL/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"DefaultAction": {
"Allow": {}
},
"Description": "",
"Rules": [
{
"Name": "AllowLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Allow": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsRule"
}
}
],
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsWebACL"
},
"Capacity": 1,
"ManagedByFirewallManager": false,
"LabelNamespace": "awswaf:123456789012:webacl:AllowLegitimateIPsWebACL:"
},
"LockToken": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}

```
Web ACL'yi gÃ¼ncellemek iÃ§in komut:
```json
aws wafv2 update-web-acl --name AllowLegitimateIPsWebACL --scope REGIONAL --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --default-action Block={} --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=AllowLegitimateIPsWebACL --rules file://rule.json --region us-east-1
```
**rule.json** dosyasÄ± ÅŸÃ¶yle gÃ¶rÃ¼necektir:
```json
[
{
"Name": "BlockLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Block": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "BlockLegitimateIPRule"
}
}
]
```
**Potansiyel Etki**: Yetkisiz eriÅŸim, veri ihlalleri ve potansiyel DoS saldÄ±rÄ±larÄ±.

#### **`wafv2:AssociateWebACL`, `wafv2:DisassociateWebACL`**

**`wafv2:AssociateWebACL`** izni, bir saldÄ±rganÄ±n web ACL'lerini (EriÅŸim Kontrol Listeleri) kaynaklarla iliÅŸkilendirmesine izin vererek, gÃ¼venlik kontrollerini atlatmasÄ±na, yetkisiz trafiÄŸin uygulamaya ulaÅŸmasÄ±na olanak tanÄ±yabilir; bu da SQL enjeksiyonu veya Ã§apraz site betikleme (XSS) gibi istismarlarla sonuÃ§lanabilir. Tersine, **`wafv2:DisassociateWebACL`** izni ile saldÄ±rgan, gÃ¼venlik korumalarÄ±nÄ± geÃ§ici olarak devre dÄ±ÅŸÄ± bÄ±rakabilir ve kaynaklarÄ± tespit edilmeden zafiyetlere maruz bÄ±rakabilir.

Korunan kaynak tÃ¼rÃ¼ne baÄŸlÄ± olarak ek izinler gerekli olacaktÄ±r:

* **Ä°liÅŸkilendir**
* apigateway:SetWebACL
* apprunner:AssociateWebAcl
* appsync:SetWebACL
* cognito-idp:AssociateWebACL
* ec2:AssociateVerifiedAccessInstanceWebAcl
* elasticloadbalancing:SetWebAcl
* **AyrÄ±ÅŸtÄ±r**
* apigateway:SetWebACL
* apprunner:DisassociateWebAcl
* appsync:SetWebACL
* cognito-idp:DisassociateWebACL
* ec2:DisassociateVerifiedAccessInstanceWebAcl
* elasticloadbalancing:SetWebAcl
```bash
# Associate
aws wafv2 associate-web-acl --web-acl-arn <value> --resource-arn <value>
# Disassociate
aws wafv2 disassociate-web-acl --resource-arn <value>
```
**Potansiyel Etki**: Kompromize olmuÅŸ kaynak gÃ¼venliÄŸi, istismar riski artÄ±ÅŸÄ± ve AWS WAF ile korunan AWS ortamlarÄ±nda potansiyel hizmet kesintileri.

#### **`wafv2:CreateIPSet` , `wafv2:UpdateIPSet`, `wafv2:DeleteIPSet`**

Bir saldÄ±rgan, AWS WAF tarafÄ±ndan yÃ¶netilen IP setlerini oluÅŸturma, gÃ¼ncelleme ve silme yeteneÄŸine sahip olacaktÄ±r. Bu tehlikeli olabilir Ã§Ã¼nkÃ¼ kÃ¶tÃ¼ niyetli trafiÄŸe izin vermek iÃ§in yeni IP setleri oluÅŸturabilir, meÅŸru trafiÄŸi engellemek iÃ§in IP setlerini deÄŸiÅŸtirebilir, mevcut IP setlerini kÃ¶tÃ¼ niyetli IP adreslerini iÃ§erecek ÅŸekilde gÃ¼ncelleyebilir, gÃ¼venilir IP adreslerini kaldÄ±rabilir veya kritik kaynaklarÄ± korumak iÃ§in tasarlanmÄ±ÅŸ kritik IP setlerini silebilir.
```bash
# Create IP set
aws wafv2 create-ip-set --name <value> --ip-address-version <IPV4 | IPV6> --addresses <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Update IP set
aws wafv2 update-ip-set --name <value> --id <value> --addresses <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete IP set
aws wafv2 delete-ip-set --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
AÅŸaÄŸÄ±daki Ã¶rnek, **istenen IP seti ile mevcut IP setini nasÄ±l geÃ§ersiz kÄ±lacaÄŸÄ±nÄ±zÄ±** gÃ¶stermektedir:
```bash
aws wafv2 update-ip-set --name LegitimateIPv4Set --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --addresses 99.99.99.99/32 --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --scope CLOUDFRONT --region us-east-1
```
**Potansiyel Etki**: Yetkisiz eriÅŸim ve meÅŸru trafiÄŸin engellenmesi.

#### **`wafv2:CreateRegexPatternSet`**, **`wafv2:UpdateRegexPatternSet`**, **`wafv2:DeleteRegexPatternSet`**

Bu izinlere sahip bir saldÄ±rgan, AWS WAF tarafÄ±ndan kullanÄ±lan dÃ¼zenli ifade desen setlerini manipÃ¼le ederek belirli desenlere dayalÄ± olarak gelen trafiÄŸi kontrol edebilir ve filtreleyebilir.

* Yeni regex desenleri oluÅŸturmak, bir saldÄ±rgana zararlÄ± iÃ§eriÄŸi kabul ettirebilir
* Mevcut desenleri gÃ¼ncelleyerek, bir saldÄ±rgan gÃ¼venlik kurallarÄ±nÄ± atlatabilir
* KÃ¶tÃ¼ niyetli faaliyetleri engellemek iÃ§in tasarlanmÄ±ÅŸ desenleri silmek, bir saldÄ±rgana zararlÄ± yÃ¼kler gÃ¶ndermesine ve gÃ¼venlik Ã¶nlemlerini atlatmasÄ±na yol aÃ§abilir.
```bash
# Create regex pattern set
aws wafv2 create-regex-pattern-set --name <value> --regular-expression-list <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--description <value>]
# Update regex pattern set
aws wafv2 update-regex-pattern-set --name <value> --id <value> --regular-expression-list <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete regex pattern set
aws wafv2 delete-regex-pattern-set --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --id <value> --lock-token <value>
```
**Potansiyel Etki**: GÃ¼venlik kontrollerini aÅŸmak, kÃ¶tÃ¼ niyetli iÃ§eriÄŸe izin vermek ve potansiyel olarak hassas verileri aÃ§Ä±ÄŸa Ã§Ä±karmak veya AWS WAF tarafÄ±ndan korunan hizmetleri ve kaynaklarÄ± kesintiye uÄŸratmak.

#### **(`wavf2:PutLoggingConfiguration` &** `iam:CreateServiceLinkedRole`), **`wafv2:DeleteLoggingConfiguration`**

**`wafv2:DeleteLoggingConfiguration`** yetkisine sahip bir saldÄ±rgan, belirtilen Web ACL'den gÃ¼nlÃ¼kleme yapÄ±landÄ±rmasÄ±nÄ± kaldÄ±rabilir. ArdÄ±ndan, **`wavf2:PutLoggingConfiguration`** ve **`iam:CreateServiceLinkedRole`** izinleri ile bir saldÄ±rgan, gÃ¼nlÃ¼kleme yapÄ±landÄ±rmalarÄ±nÄ± oluÅŸturabilir veya deÄŸiÅŸtirebilir (silindikten sonra) ya gÃ¼nlÃ¼klemeyi tamamen engellemek ya da gÃ¼nlÃ¼kleri yetkisiz hedeflere, Ã¶rneÄŸin Amazon S3 bucket'larÄ±na, Amazon CloudWatch Logs gÃ¼nlÃ¼k grubuna veya kontrol altÄ±ndaki bir Amazon Kinesis Data Firehose'a yÃ¶nlendirmek iÃ§in.

OluÅŸturma sÃ¼reci sÄ±rasÄ±nda, hizmet, belirtilen gÃ¼nlÃ¼kleme hedefine gÃ¼nlÃ¼klerin yazÄ±lmasÄ±na izin vermek iÃ§in gerekli izinleri otomatik olarak ayarlar:

* **Amazon CloudWatch Logs:** AWS WAF, belirlenen CloudWatch Logs gÃ¼nlÃ¼k grubunda bir kaynak politikasÄ± oluÅŸturur. Bu politika, AWS WAF'Ä±n gÃ¼nlÃ¼kleri gÃ¼nlÃ¼k grubuna yazmak iÃ§in gereken izinlere sahip olmasÄ±nÄ± saÄŸlar.
* **Amazon S3 Bucket:** AWS WAF, belirlenen S3 bucket'Ä±nda bir bucket politikasÄ± oluÅŸturur. Bu politika, AWS WAF'a belirtilen bucket'a gÃ¼nlÃ¼k yÃ¼klemek iÃ§in gerekli izinleri verir.
* **Amazon Kinesis Data Firehose:** AWS WAF, Kinesis Data Firehose ile etkileÅŸimde bulunmak iÃ§in Ã¶zel olarak bir hizmet baÄŸlantÄ±lÄ± rol oluÅŸturur. Bu rol, AWS WAF'Ä±n yapÄ±landÄ±rÄ±lmÄ±ÅŸ Firehose akÄ±ÅŸÄ±na gÃ¼nlÃ¼kleri iletmesine olanak tanÄ±r.

{% hint style="info" %}
Her web ACL iÃ§in yalnÄ±zca bir gÃ¼nlÃ¼kleme hedefi tanÄ±mlamak mÃ¼mkÃ¼ndÃ¼r.
{% endhint %}
```bash
# Put logging configuration
aws wafv2 put-logging-configuration --logging-configuration <value>
# Delete logging configuration
aws wafv2 delete-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]
```
**Potansiyel Etki:** GÃ¼venlik olaylarÄ±na dair gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ belirsizleÅŸtirir, olay yanÄ±t sÃ¼recini zorlaÅŸtÄ±rÄ±r ve AWS WAF ile korunan ortamlarda gizli kÃ¶tÃ¼ niyetli faaliyetleri kolaylaÅŸtÄ±rÄ±r.

#### **`wafv2:DeleteAPIKey`**

Bu izinlere sahip bir saldÄ±rgan, mevcut API anahtarlarÄ±nÄ± silebilir, bu da CAPTCHA'nÄ±n etkisiz hale gelmesine ve form gÃ¶nderimleri ve eriÅŸim kontrolleri gibi buna baÄŸlÄ± iÅŸlevlerin bozulmasÄ±na neden olur. Bu CAPTCHA'nÄ±n uygulanmasÄ±na baÄŸlÄ± olarak, bu ya bir CAPTCHA atlatmasÄ±na ya da kaynakta hata yÃ¶netimi dÃ¼zgÃ¼n ayarlanmamÄ±ÅŸsa bir DoS'a yol aÃ§abilir.
```bash
# Delete API key
aws wafv2 delete-api-key --api-key <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**OlasÄ± Etki**: CAPTCHA korumalarÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakma veya uygulama iÅŸlevselliÄŸini bozma, gÃ¼venlik ihlallerine ve potansiyel veri hÄ±rsÄ±zlÄ±ÄŸÄ±na yol aÃ§ma.

#### **`wafv2:TagResource`, `wafv2:UntagResource`**

Bir saldÄ±rgan, AWS WAFv2 kaynaklarÄ±ndan, Ã¶rneÄŸin Web ACL'leri, kural gruplarÄ±, IP setleri, regex desen setleri ve gÃ¼nlÃ¼kleme yapÄ±landÄ±rmalarÄ±ndan etiket ekleyebilir, deÄŸiÅŸtirebilir veya kaldÄ±rabilir.
```bash
# Tag
aws wafv2 tag-resource --resource-arn <value> --tags <value>
# Untag
aws wafv2 untag-resource --resource-arn <value> --tag-keys <value>
```
**Potansiyel Etki**: Kaynak manipÃ¼lasyonu, bilgi sÄ±zÄ±ntÄ±sÄ±, maliyet manipÃ¼lasyonu ve operasyonel kesinti.

## Referanslar

* [https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:\~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application](https://www.citrusconsulting.com/aws-web-application-firewall-waf/)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awswafv2.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_awswafv2.html)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
