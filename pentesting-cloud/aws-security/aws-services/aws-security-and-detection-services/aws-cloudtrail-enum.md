# AWS - CloudTrail Enum

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **è®°å½•å’Œç›‘æ§æ‚¨ AWS ç¯å¢ƒä¸­çš„æ´»åŠ¨**ã€‚å®ƒæ•è·è¯¦ç»†çš„ **äº‹ä»¶æ—¥å¿—**ï¼ŒåŒ…æ‹¬è°åœ¨ä½•æ—¶ã€ä»ä½•å¤„è¿›è¡Œäº†ä»€ä¹ˆæ“ä½œï¼Œé€‚ç”¨äºä¸ AWS èµ„æºçš„æ‰€æœ‰äº¤äº’ã€‚è¿™æä¾›äº†æ›´æ”¹å’Œæ“ä½œçš„å®¡è®¡è·Ÿè¸ªï¼Œæœ‰åŠ©äºå®‰å…¨åˆ†æã€åˆè§„å®¡è®¡å’Œèµ„æºæ›´æ”¹è·Ÿè¸ªã€‚CloudTrail å¯¹äºç†è§£ç”¨æˆ·å’Œèµ„æºè¡Œä¸ºã€å¢å¼ºå®‰å…¨æ€åŠ¿ä»¥åŠç¡®ä¿åˆè§„æ€§è‡³å…³é‡è¦ã€‚

æ¯ä¸ªè®°å½•çš„äº‹ä»¶åŒ…å«ï¼š

* è¢«è°ƒç”¨çš„ API åç§°ï¼š `eventName`
* è¢«è°ƒç”¨çš„æœåŠ¡ï¼š `eventSource`
* æ—¶é—´ï¼š `eventTime`
* IP åœ°å€ï¼š `SourceIPAddress`
* ä»£ç†æ–¹æ³•ï¼š `userAgent`ã€‚ç¤ºä¾‹ï¼š
* Signing.amazonaws.com - æ¥è‡ª AWS ç®¡ç†æ§åˆ¶å°
* console.amazonaws.com - è´¦æˆ·çš„æ ¹ç”¨æˆ·
* lambda.amazonaws.com - AWS Lambda
* è¯·æ±‚å‚æ•°ï¼š `requestParameters`
* å“åº”å…ƒç´ ï¼š `responseElements`

äº‹ä»¶æ¯ **çº¦ 5 åˆ†é’Ÿå†™å…¥ä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ ¼å¼ä¸º JSON**ï¼Œå®ƒä»¬ç”± CloudTrail ä¿å­˜ï¼Œæœ€åï¼Œæ—¥å¿—æ–‡ä»¶ **å¤§çº¦åœ¨ 15 åˆ†é’Ÿåäº¤ä»˜åˆ° S3**ã€‚\
CloudTrail çš„æ—¥å¿—å¯ä»¥ **è·¨è´¦æˆ·å’Œè·¨åŒºåŸŸèšåˆã€‚**\
CloudTrail å…è®¸ä½¿ç”¨ **æ—¥å¿—æ–‡ä»¶å®Œæ•´æ€§ï¼Œä»¥ä¾¿èƒ½å¤ŸéªŒè¯æ‚¨çš„æ—¥å¿—æ–‡ä»¶è‡ª CloudTrail äº¤ä»˜ç»™æ‚¨ä»¥æ¥æ˜¯å¦ä¿æŒä¸å˜**ã€‚å®ƒåœ¨æ‘˜è¦æ–‡ä»¶ä¸­åˆ›å»ºæ—¥å¿—çš„ SHA-256 å“ˆå¸Œã€‚æ¯å°æ—¶åˆ›å»ºæ–°æ—¥å¿—çš„ sha-256 å“ˆå¸Œã€‚\
åˆ›å»º Trail æ—¶ï¼Œäº‹ä»¶é€‰æ‹©å™¨å°†å…è®¸æ‚¨æŒ‡ç¤ºè¦è®°å½•çš„ Trailï¼šç®¡ç†ã€æ•°æ®æˆ–æ´å¯Ÿäº‹ä»¶ã€‚

æ—¥å¿—ä¿å­˜åœ¨ S3 å­˜å‚¨æ¡¶ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨æœåŠ¡å™¨ç«¯åŠ å¯† (SSE-S3)ï¼Œå› æ­¤ AWS å°†ä¸ºæœ‰æƒè®¿é—®çš„äººè§£å¯†å†…å®¹ï¼Œä½†ä¸ºäº†é¢å¤–çš„å®‰å…¨æ€§ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¸¦æœ‰ KMS å’Œæ‚¨è‡ªå·±çš„å¯†é’¥çš„ SSEã€‚

æ—¥å¿—å­˜å‚¨åœ¨ **å…·æœ‰ä»¥ä¸‹åç§°æ ¼å¼çš„ S3 å­˜å‚¨æ¡¶ä¸­**ï¼š

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* BucketName ä¸ºï¼š **`aws-cloudtrail-logs-<accountid>-<random>`**
* ç¤ºä¾‹ï¼š **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

åœ¨æ¯ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œæ¯ä¸ªæ—¥å¿—å°†å…·æœ‰ **éµå¾ªä»¥ä¸‹æ ¼å¼çš„åç§°**ï¼š **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

æ—¥å¿—æ–‡ä»¶å‘½åçº¦å®š

![](<../../../../.gitbook/assets/image (122).png>)

æ­¤å¤–ï¼Œ**æ‘˜è¦æ–‡ä»¶ï¼ˆç”¨äºæ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§ï¼‰**å°†ä½äº **åŒä¸€ä¸ªå­˜å‚¨æ¡¶**ä¸­ï¼š

![](<../../../../.gitbook/assets/image (195).png>)

### ä»å¤šä¸ªè´¦æˆ·èšåˆæ—¥å¿—

* åœ¨æ‚¨å¸Œæœ›æ—¥å¿—æ–‡ä»¶äº¤ä»˜åˆ°çš„ AWS è´¦æˆ·ä¸­åˆ›å»ºä¸€ä¸ª Trail
* å¯¹ç›®æ ‡ S3 å­˜å‚¨æ¡¶åº”ç”¨æƒé™ï¼Œå…è®¸ CloudTrail çš„è·¨è´¦æˆ·è®¿é—®ï¼Œå¹¶å…è®¸æ¯ä¸ªéœ€è¦è®¿é—®çš„ AWS è´¦æˆ·
* åœ¨å…¶ä»– AWS è´¦æˆ·ä¸­åˆ›å»ºä¸€ä¸ªæ–° Trailï¼Œå¹¶é€‰æ‹©ä½¿ç”¨æ­¥éª¤ 1 ä¸­åˆ›å»ºçš„å­˜å‚¨æ¡¶

ç„¶è€Œï¼Œå³ä½¿æ‚¨å¯ä»¥å°†æ‰€æœ‰æ—¥å¿—ä¿å­˜åœ¨åŒä¸€ä¸ª S3 å­˜å‚¨æ¡¶ä¸­ï¼Œæ‚¨ä¹Ÿæ— æ³•å°†æ¥è‡ªå¤šä¸ªè´¦æˆ·çš„ CloudTrail æ—¥å¿—èšåˆåˆ°å±äºå•ä¸ª AWS è´¦æˆ·çš„ CloudWatch Logs ä¸­ã€‚

{% hint style="danger" %}
è¯·è®°ä½ï¼Œä¸€ä¸ªè´¦æˆ·å¯ä»¥æœ‰ **ä¸åŒçš„ Trails** ä» CloudTrail **å¯ç”¨**ï¼Œåœ¨ä¸åŒçš„å­˜å‚¨æ¡¶ä¸­å­˜å‚¨ç›¸åŒï¼ˆæˆ–ä¸åŒï¼‰çš„æ—¥å¿—ã€‚
{% endhint %}

### ä»æ‰€æœ‰ç»„ç»‡è´¦æˆ·è·å– CloudTrail åˆ° 1 ä¸ª

åˆ›å»º CloudTrail æ—¶ï¼Œå¯ä»¥æŒ‡ç¤ºä¸ºç»„ç»‡ä¸­çš„æ‰€æœ‰è´¦æˆ·æ¿€æ´» CloudTrailï¼Œå¹¶å°†æ—¥å¿—è·å–åˆ°ä¸€ä¸ªå­˜å‚¨æ¡¶ä¸­ï¼š

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

è¿™æ ·ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°åœ¨æ‰€æœ‰è´¦æˆ·çš„æ‰€æœ‰åŒºåŸŸé…ç½® CloudTrailï¼Œå¹¶å°†æ—¥å¿—é›†ä¸­åœ¨ä¸€ä¸ªè´¦æˆ·ä¸­ï¼ˆæ‚¨åº”è¯¥ä¿æŠ¤è¯¥è´¦æˆ·ï¼‰ã€‚

### æ—¥å¿—æ–‡ä»¶æ£€æŸ¥

æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œæ¥æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœªè¢«æ›´æ”¹

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### æ—¥å¿—åˆ° CloudWatch

**CloudTrail å¯ä»¥è‡ªåŠ¨å°†æ—¥å¿—å‘é€åˆ° CloudWatchï¼Œä»¥ä¾¿æ‚¨å¯ä»¥è®¾ç½®è­¦æŠ¥ï¼Œå½“æ‰§è¡Œå¯ç–‘æ´»åŠ¨æ—¶æé†’æ‚¨ã€‚**\
è¯·æ³¨æ„ï¼Œä¸ºäº†å…è®¸ CloudTrail å°†æ—¥å¿—å‘é€åˆ° CloudWatchï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ª **è§’è‰²** æ¥å…è®¸è¯¥æ“ä½œã€‚å¦‚æœå¯èƒ½ï¼Œå»ºè®®ä½¿ç”¨ AWS é»˜è®¤è§’è‰²æ¥æ‰§è¡Œè¿™äº›æ“ä½œã€‚æ­¤è§’è‰²å°†å…è®¸ CloudTrailï¼š

* CreateLogStream: è¿™å…è®¸åˆ›å»º CloudWatch Logs æ—¥å¿—æµ
* PutLogEvents: å°† CloudTrail æ—¥å¿—ä¼ é€åˆ° CloudWatch Logs æ—¥å¿—æµ

### äº‹ä»¶å†å²

CloudTrail äº‹ä»¶å†å²å…è®¸æ‚¨åœ¨è¡¨ä¸­æ£€æŸ¥å·²è®°å½•çš„æ—¥å¿—ï¼š

![](<../../../../.gitbook/assets/image (89).png>)

### æ´å¯Ÿ

**CloudTrail æ´å¯Ÿ** è‡ªåŠ¨ **åˆ†æ** æ¥è‡ª CloudTrail è·¯å¾„çš„å†™å…¥ç®¡ç†äº‹ä»¶ï¼Œå¹¶ **æé†’** æ‚¨ **å¼‚å¸¸æ´»åŠ¨**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ `TerminateInstance` äº‹ä»¶çš„å¢åŠ ä¸æ—¢å®šåŸºçº¿ä¸åŒï¼Œæ‚¨å°†çœ‹åˆ°å®ƒä½œä¸ºæ´å¯Ÿäº‹ä»¶ã€‚è¿™äº›äº‹ä»¶ä½¿ **å‘ç°å’Œå“åº”å¼‚å¸¸ API æ´»åŠ¨æ¯”ä»¥å¾€ä»»ä½•æ—¶å€™éƒ½æ›´å®¹æ˜“**ã€‚

æ´å¯Ÿå­˜å‚¨åœ¨ä¸ CloudTrail æ—¥å¿—ç›¸åŒçš„å­˜å‚¨æ¡¶ä¸­ï¼š`BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### å®‰å…¨

| CloudTrail æ—¥å¿—æ–‡ä»¶å®Œæ•´æ€§        | <ul><li>éªŒè¯æ—¥å¿—æ˜¯å¦è¢«ç¯¡æ”¹ï¼ˆä¿®æ”¹æˆ–åˆ é™¤ï¼‰</li><li><p>ä½¿ç”¨æ‘˜è¦æ–‡ä»¶ï¼ˆä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºå“ˆå¸Œï¼‰</p><ul><li>SHA-256 å“ˆå¸Œ</li><li>ä½¿ç”¨ RSA è¿›è¡Œæ•°å­—ç­¾åçš„ SHA-256</li><li>ç”± Amazon æ‹¥æœ‰çš„ç§é’¥</li></ul></li><li>åˆ›å»ºæ‘˜è¦æ–‡ä»¶éœ€è¦ 1 å°æ—¶ï¼ˆæ¯å°æ—¶çš„æ•´ç‚¹å®Œæˆï¼‰</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| é˜²æ­¢æœªç»æˆæƒçš„è®¿é—®             | <ul><li><p>ä½¿ç”¨ IAM ç­–ç•¥å’Œ S3 å­˜å‚¨æ¡¶ç­–ç•¥</p><ul><li>å®‰å…¨å›¢é˜Ÿ â€”> ç®¡ç†å‘˜è®¿é—®</li><li>å®¡è®¡å‘˜ â€”> åªè¯»è®¿é—®</li></ul></li><li>ä½¿ç”¨ SSE-S3/SSE-KMS åŠ å¯†æ—¥å¿—</li></ul>                                                                                                                                        |
| é˜²æ­¢æ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤ | <ul><li>ä½¿ç”¨ IAM å’Œå­˜å‚¨æ¡¶ç­–ç•¥é™åˆ¶åˆ é™¤è®¿é—®</li><li>é…ç½® S3 MFA åˆ é™¤</li><li>ä½¿ç”¨æ—¥å¿—æ–‡ä»¶éªŒè¯è¿›è¡ŒéªŒè¯</li></ul>                                                                                                                                                                                            |

## è®¿é—®é¡¾é—®

AWS è®¿é—®é¡¾é—®ä¾èµ–äºè¿‡å» 400 å¤©çš„ AWS **CloudTrail æ—¥å¿—æ¥æ”¶é›†å…¶æ´å¯Ÿ**ã€‚CloudTrail æ•è·åœ¨ AWS è´¦æˆ·ä¸­è¿›è¡Œçš„ AWS API è°ƒç”¨å’Œç›¸å…³äº‹ä»¶çš„å†å²è®°å½•ã€‚è®¿é—®é¡¾é—®åˆ©ç”¨è¿™äº›æ•°æ® **æ˜¾ç¤ºæœåŠ¡æœ€åä¸€æ¬¡è®¿é—®çš„æ—¶é—´**ã€‚é€šè¿‡åˆ†æ CloudTrail æ—¥å¿—ï¼Œè®¿é—®é¡¾é—®å¯ä»¥ç¡®å®š IAM ç”¨æˆ·æˆ–è§’è‰²è®¿é—®äº†å“ªäº› AWS æœåŠ¡ä»¥åŠä½•æ—¶å‘ç”Ÿè¯¥è®¿é—®ã€‚è¿™å¸®åŠ© AWS ç®¡ç†å‘˜åšå‡ºæœ‰å…³ **ç²¾ç‚¼æƒé™** çš„æ˜æ™ºå†³ç­–ï¼Œå› ä¸ºä»–ä»¬å¯ä»¥è¯†åˆ«é•¿æ—¶é—´æœªè¢«è®¿é—®çš„æœåŠ¡ï¼Œå¹¶å¯èƒ½æ ¹æ®å®é™…ä½¿ç”¨æ¨¡å¼å‡å°‘è¿‡äºå®½æ³›çš„æƒé™ã€‚

{% hint style="success" %}
å› æ­¤ï¼Œè®¿é—®é¡¾é—®é€šçŸ¥æœ‰å…³ **ç»™äºˆç”¨æˆ·çš„ä¸å¿…è¦æƒé™**ï¼Œä»¥ä¾¿ç®¡ç†å‘˜å¯ä»¥åˆ é™¤å®ƒä»¬
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## æ“ä½œ

### æšä¸¾
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV æ³¨å…¥**

åœ¨ CloudTrail ä¸­æ‰§è¡Œ CVS æ³¨å…¥æ˜¯å¯èƒ½çš„ï¼Œå¦‚æœæ—¥å¿—ä»¥ CSV æ ¼å¼å¯¼å‡ºå¹¶åœ¨ Excel ä¸­æ‰“å¼€ï¼Œå°†æ‰§è¡Œä»»æ„ä»£ç ã€‚\
ä»¥ä¸‹ä»£ç å°†ç”Ÿæˆä¸€ä¸ªåŒ…å«æœ‰æ•ˆè´Ÿè½½çš„å Trail åç§°çš„æ—¥å¿—æ¡ç›®ï¼š
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
æœ‰å…³ CSV æ³¨å…¥çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹é¡µé¢ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

æœ‰å…³æ­¤ç‰¹å®šæŠ€æœ¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **ç»•è¿‡æ£€æµ‹**

### HoneyTokens **ç»•è¿‡**

Honeytokens çš„åˆ›å»ºæ˜¯ä¸ºäº† **æ£€æµ‹æ•æ„Ÿä¿¡æ¯çš„å¤–æ³„**ã€‚åœ¨ AWS çš„æƒ…å†µä¸‹ï¼Œå®ƒä»¬æ˜¯ **ä½¿ç”¨å—åˆ°ç›‘æ§çš„ AWS å¯†é’¥**ï¼Œå¦‚æœæŸä¸ªæ“ä½œè§¦å‘äº†è¯¥å¯†é’¥çš„åŠ¨ä½œï¼Œé‚£ä¹ˆå°±å¿…é¡»æœ‰äººçªƒå–äº†è¯¥å¯†é’¥ã€‚

ç„¶è€Œï¼Œåƒ [**Canarytokens**](https://canarytokens.org/generate)**ã€** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**ã€** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) åˆ›å»ºçš„ Honeytokens è¦ä¹ˆä½¿ç”¨å¯è¯†åˆ«çš„è´¦æˆ·åç§°ï¼Œè¦ä¹ˆä¸ºæ‰€æœ‰å®¢æˆ·ä½¿ç”¨ç›¸åŒçš„ AWS è´¦æˆ· IDã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨å¯ä»¥åœ¨ä¸è®© Cloudtrail åˆ›å»ºä»»ä½•æ—¥å¿—çš„æƒ…å†µä¸‹è·å–è´¦æˆ·åç§°å’Œ/æˆ–è´¦æˆ· IDï¼Œ**æ‚¨å°±å¯ä»¥çŸ¥é“è¯¥å¯†é’¥æ˜¯å¦æ˜¯ Honeytoken**ã€‚

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam__detect_honeytokens/main.py#L57) æœ‰ä¸€äº›è§„åˆ™æ¥æ£€æµ‹å¯†é’¥æ˜¯å¦å±äº [**Canarytokens**](https://canarytokens.org/generate)**ã€** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**ã€** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* å¦‚æœ **`canarytokens.org`** å‡ºç°åœ¨è§’è‰²åç§°ä¸­ï¼Œæˆ–è€…è´¦æˆ· ID **`534261010715`** å‡ºç°åœ¨é”™è¯¯æ¶ˆæ¯ä¸­ã€‚
* æœ€è¿‘æµ‹è¯•æ—¶ï¼Œä»–ä»¬ä½¿ç”¨çš„è´¦æˆ·æ˜¯ **`717712589309`**ï¼Œå¹¶ä¸”åç§°ä¸­ä»ç„¶åŒ…å« **`canarytokens.com`** å­—ç¬¦ä¸²ã€‚
* å¦‚æœ **`SpaceCrab`** å‡ºç°åœ¨é”™è¯¯æ¶ˆæ¯ä¸­çš„è§’è‰²åç§°ä¸­
* **SpaceSiren** ä½¿ç”¨ **uuids** ç”Ÿæˆç”¨æˆ·åï¼š`[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* å¦‚æœ **åç§°çœ‹èµ·æ¥åƒæ˜¯éšæœºç”Ÿæˆçš„**ï¼Œé‚£ä¹ˆå®ƒæ˜¯ HoneyToken çš„æ¦‚ç‡å¾ˆé«˜ã€‚

#### ä»å¯†é’¥ ID è·å–è´¦æˆ· ID

æ‚¨å¯ä»¥ä» **è®¿é—®å¯†é’¥** ä¸­çš„ **ç¼–ç ** è·å– **è´¦æˆ· ID**ï¼Œå¦‚ [**æ­¤å¤„æ‰€è¿°**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489)ï¼Œå¹¶ä½¿ç”¨æ‚¨çš„ Honeytokens AWS è´¦æˆ·åˆ—è¡¨æ£€æŸ¥è´¦æˆ· IDï¼š
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
æ£€æŸ¥æ›´å¤šä¿¡æ¯è¯·è®¿é—® [**åŸå§‹ç ”ç©¶**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489)ã€‚

#### ä¸ç”Ÿæˆæ—¥å¿—

æœ€æœ‰æ•ˆçš„æŠ€æœ¯å®é™…ä¸Šæ˜¯ä¸€ä¸ªç®€å•çš„æ–¹æ³•ã€‚åªéœ€ä½¿ç”¨æ‚¨åˆšåˆšæ‰¾åˆ°çš„å¯†é’¥è®¿é—®æ‚¨è‡ªå·±æ”»å‡»è€…è´¦æˆ·ä¸­çš„æŸä¸ªæœåŠ¡ã€‚è¿™å°†ä½¿ **CloudTrail åœ¨æ‚¨è‡ªå·±çš„ AWS è´¦æˆ·ä¸­ç”Ÿæˆæ—¥å¿—ï¼Œè€Œä¸æ˜¯åœ¨å—å®³è€…çš„è´¦æˆ·ä¸­**ã€‚

é—®é¢˜æ˜¯è¾“å‡ºå°†æ˜¾ç¤ºä¸€ä¸ªé”™è¯¯ï¼ŒæŒ‡ç¤ºè´¦æˆ· ID å’Œè´¦æˆ·åç§°ï¼Œå› æ­¤ **æ‚¨å°†èƒ½å¤Ÿçœ‹åˆ°å®ƒæ˜¯å¦æ˜¯ä¸€ä¸ª Honeytoken**ã€‚

#### æ²¡æœ‰æ—¥å¿—çš„ AWS æœåŠ¡

è¿‡å»æœ‰ä¸€äº› **AWS æœåŠ¡ä¸ä¼šå°†æ—¥å¿—å‘é€åˆ° CloudTrail**ï¼ˆåœ¨è¿™é‡Œæ‰¾åˆ° [åˆ—è¡¨](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)ï¼‰ã€‚å…¶ä¸­ä¸€äº›æœåŠ¡ä¼š **å“åº”** ä¸€ä¸ª **é”™è¯¯**ï¼Œå…¶ä¸­åŒ…å« **å¯†é’¥è§’è‰²çš„ ARN**ï¼Œå¦‚æœæœ‰äººæœªç»æˆæƒï¼ˆå³ Honeytoken å¯†é’¥ï¼‰å°è¯•è®¿é—®å®ƒã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œ**æ”»å‡»è€…å¯ä»¥åœ¨ä¸è§¦å‘ä»»ä½•æ—¥å¿—çš„æƒ…å†µä¸‹è·å–å¯†é’¥çš„ ARN**ã€‚åœ¨ ARN ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥çœ‹åˆ° **AWS è´¦æˆ· ID å’Œåç§°**ï¼Œå¾ˆå®¹æ˜“çŸ¥é“ HoneyToken çš„å…¬å¸è´¦æˆ· ID å’Œåç§°ï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥è¯†åˆ«è¯¥ä»¤ç‰Œæ˜¯å¦ä¸º HoneyTokenã€‚

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œæ‰€æœ‰è¢«å‘ç°ä¸åˆ›å»º CloudTrail æ—¥å¿—çš„å…¬å…± API ç°åœ¨å·²è¢«ä¿®å¤ï¼Œå› æ­¤æ‚¨å¯èƒ½éœ€è¦è‡ªå·±å¯»æ‰¾...

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [**åŸå§‹ç ”ç©¶**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/)ã€‚
{% endhint %}

### è®¿é—®ç¬¬ä¸‰æ–¹åŸºç¡€è®¾æ–½

æŸäº› AWS æœåŠ¡å°† **ç”Ÿæˆä¸€äº›åŸºç¡€è®¾æ–½**ï¼Œä¾‹å¦‚ **æ•°æ®åº“** æˆ– **Kubernetes** é›†ç¾¤ï¼ˆEKSï¼‰ã€‚ç”¨æˆ· **ç›´æ¥ä¸è¿™äº›æœåŠ¡äº¤äº’**ï¼ˆå¦‚ Kubernetes APIï¼‰ **ä¸ä¼šä½¿ç”¨ AWS API**ï¼Œå› æ­¤ CloudTrail å°†æ— æ³•çœ‹åˆ°æ­¤é€šä¿¡ã€‚

å› æ­¤ï¼Œå…·æœ‰ EKS è®¿é—®æƒé™çš„ç”¨æˆ·å¦‚æœå‘ç° EKS API çš„ URLï¼Œå¯ä»¥åœ¨æœ¬åœ°ç”Ÿæˆä¸€ä¸ªä»¤ç‰Œï¼Œå¹¶ **ç›´æ¥ä¸ API æœåŠ¡äº¤è°ˆè€Œä¸è¢« CloudTrail æ£€æµ‹åˆ°**ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è§ï¼š

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### ä¿®æ”¹ CloudTrail é…ç½®

#### åˆ é™¤è½¨è¿¹
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### åœæ­¢è·Ÿè¸ª
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### ç¦ç”¨å¤šåŒºåŸŸæ—¥å¿—è®°å½•

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### é€šè¿‡äº‹ä»¶é€‰æ‹©å™¨ç¦ç”¨æ—¥å¿—è®°å½•

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

åœ¨ç¬¬ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªåŒ…å«å•ä¸ªå¯¹è±¡çš„ JSON æ•°ç»„ä½œä¸ºäº‹ä»¶é€‰æ‹©å™¨ã€‚`"ReadWriteType": "ReadOnly"` è¡¨ç¤º **äº‹ä»¶é€‰æ‹©å™¨ä»…åº”æ•è·åªè¯»äº‹ä»¶**ï¼ˆå› æ­¤ CloudTrail insights **ä¸ä¼šæ£€æŸ¥å†™å…¥** äº‹ä»¶ï¼Œä¾‹å¦‚ï¼‰ã€‚

æ‚¨å¯ä»¥æ ¹æ®æ‚¨çš„å…·ä½“è¦æ±‚è‡ªå®šä¹‰äº‹ä»¶é€‰æ‹©å™¨ã€‚

#### é€šè¿‡ S3 ç”Ÿå‘½å‘¨æœŸç­–ç•¥åˆ é™¤æ—¥å¿—

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### ä¿®æ”¹æ¡¶é…ç½®

* åˆ é™¤ S3 æ¡¶
* æ›´æ”¹æ¡¶ç­–ç•¥ä»¥æ‹’ç»æ¥è‡ª CloudTrail æœåŠ¡çš„ä»»ä½•å†™å…¥
* å‘ S3 æ¡¶æ·»åŠ ç”Ÿå‘½å‘¨æœŸç­–ç•¥ä»¥åˆ é™¤å¯¹è±¡
* ç¦ç”¨ç”¨äºåŠ å¯† CloudTrail æ—¥å¿—çš„ kms å¯†é’¥

### Cloudtrail å‹’ç´¢è½¯ä»¶

#### S3 å‹’ç´¢è½¯ä»¶

æ‚¨å¯ä»¥ **ç”Ÿæˆä¸€ä¸ªéå¯¹ç§°å¯†é’¥** å¹¶ä½¿ **CloudTrail ä½¿ç”¨è¯¥å¯†é’¥åŠ å¯†æ•°æ®**ï¼Œç„¶å **åˆ é™¤ç§é’¥**ï¼Œä»¥ä¾¿ CloudTrail å†…å®¹æ— æ³•æ¢å¤ã€‚\
è¿™åŸºæœ¬ä¸Šæ˜¯ **S3-KMS å‹’ç´¢è½¯ä»¶**ï¼Œè¯¦è§ï¼š

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS å‹’ç´¢è½¯ä»¶**

è¿™æ˜¯ä»¥ä¸åŒæƒé™è¦æ±‚æ‰§è¡Œå‰è¿°æ”»å‡»çš„æœ€ç®€å•æ–¹æ³•ï¼š

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **å‚è€ƒæ–‡çŒ®**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
