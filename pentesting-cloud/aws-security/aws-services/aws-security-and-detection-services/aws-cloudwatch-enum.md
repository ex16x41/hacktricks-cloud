# AWS - CloudWatch Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## CloudWatch

**CloudWatch** **recopila** datos de monitoreo y operaci√≥n en forma de registros/m√©tricas/eventos proporcionando una **vista unificada de los recursos de AWS**, aplicaciones y servicios.\
Los eventos de registro de CloudWatch tienen una **limitaci√≥n de tama√±o de 256KB en cada l√≠nea de registro**.\
Puede establecer **alarmas de alta resoluci√≥n**, visualizar **registros** y **m√©tricas** lado a lado, tomar acciones automatizadas, solucionar problemas y descubrir informaci√≥n para optimizar aplicaciones.

Puede monitorear, por ejemplo, registros de CloudTrail. Los eventos que se monitorean:

* Cambios en los Grupos de Seguridad y NACLs
* Iniciar, detener, reiniciar y terminar instancias de EC2
* Cambios en las Pol√≠ticas de Seguridad dentro de IAM y S3
* Intentos de inicio de sesi√≥n fallidos en la Consola de Administraci√≥n de AWS
* Llamadas a la API que resultaron en autorizaci√≥n fallida
* Filtros para buscar en CloudWatch: [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

## Key concepts

### Namespaces

Un namespace es un contenedor para m√©tricas de CloudWatch. Ayuda a categorizar e aislar m√©tricas, facilitando su gesti√≥n y an√°lisis.

* **Ejemplos**: AWS/EC2 para m√©tricas relacionadas con EC2, AWS/RDS para m√©tricas de RDS.

### Metrics

Las m√©tricas son puntos de datos recopilados a lo largo del tiempo que representan el rendimiento o la utilizaci√≥n de los recursos de AWS. Las m√©tricas pueden ser recopiladas de servicios de AWS, aplicaciones personalizadas o integraciones de terceros.

* **Ejemplo**: CPUUtilization, NetworkIn, DiskReadOps.

### Dimensions

Las dimensiones son pares clave-valor que son parte de las m√©tricas. Ayudan a identificar de manera √∫nica una m√©trica y proporcionan contexto adicional, siendo 30 el n√∫mero m√°ximo de dimensiones que se pueden asociar con una m√©trica. Las dimensiones tambi√©n permiten filtrar y agregar m√©tricas en funci√≥n de atributos espec√≠ficos.

* **Ejemplo**: Para instancias de EC2, las dimensiones pueden incluir InstanceId, InstanceType y AvailabilityZone.

### Statistics

Las estad√≠sticas son c√°lculos matem√°ticos realizados sobre los datos de m√©tricas para resumirlos a lo largo del tiempo. Las estad√≠sticas comunes incluyen Promedio, Suma, M√≠nimo, M√°ximo y Conteo de Muestras.

* **Ejemplo**: Calcular la utilizaci√≥n promedio de CPU durante un per√≠odo de una hora.

### Units

Las unidades son el tipo de medida asociado con una m√©trica. Las unidades ayudan a proporcionar contexto y significado a los datos de la m√©trica. Las unidades comunes incluyen Porcentaje, Bytes, Segundos, Conteo.

* **Ejemplo**: CPUUtilization podr√≠a medirse en Porcentaje, mientras que NetworkIn podr√≠a medirse en Bytes.

## CloudWatch Features

### Dashboard

**Los Dashboards de CloudWatch** proporcionan **vistas personalizables de sus m√©tricas de AWS CloudWatch**. Es posible crear y configurar dashboards para visualizar datos y monitorear recursos en una sola vista, combinando diferentes m√©tricas de varios servicios de AWS.

**Caracter√≠sticas Clave**:

* **Widgets**: Bloques de construcci√≥n de dashboards, incluyendo gr√°ficos, texto, alarmas y m√°s.
* **Personalizaci√≥n**: El dise√±o y el contenido se pueden personalizar para adaptarse a necesidades espec√≠ficas de monitoreo.

**Ejemplo de Caso de Uso**:

* Un solo dashboard que muestra m√©tricas clave para todo su entorno de AWS, incluyendo instancias de EC2, bases de datos RDS y buckets de S3.

### Metric Stream and Metric Data

**Metric Streams** en AWS CloudWatch le permiten transmitir continuamente m√©tricas de CloudWatch a un destino de su elecci√≥n en casi tiempo real. Esto es particularmente √∫til para monitoreo avanzado, an√°lisis y dashboards personalizados utilizando herramientas fuera de AWS.

**Los Datos de M√©tricas** dentro de Metric Streams se refieren a las mediciones o puntos de datos reales que se est√°n transmitiendo. Estos puntos de datos representan varias m√©tricas como la utilizaci√≥n de CPU, el uso de memoria, etc., para los recursos de AWS.

**Ejemplo de Caso de Uso**:

* Enviar m√©tricas en tiempo real a un servicio de monitoreo de terceros para an√°lisis avanzado.
* Archivar m√©tricas en un bucket de Amazon S3 para almacenamiento a largo plazo y cumplimiento.

### Alarm

**Las Alarmas de CloudWatch** monitorean sus m√©tricas y realizan acciones basadas en umbrales predefinidos. Cuando una m√©trica supera un umbral, la alarma puede realizar una o m√°s acciones, como enviar notificaciones a trav√©s de SNS, activar una pol√≠tica de autoescalado o ejecutar una funci√≥n de AWS Lambda.

**Componentes Clave**:

* **Umbral**: El valor en el que se activa la alarma.
* **Per√≠odos de Evaluaci√≥n**: El n√∫mero de per√≠odos sobre los cuales se eval√∫an los datos.
* **Puntos de Datos para la Alarma**: El n√∫mero de per√≠odos con un umbral alcanzado necesario para activar la alarma.
* **Acciones**: Lo que sucede cuando se activa el estado de la alarma (por ejemplo, notificar a trav√©s de SNS).

**Ejemplo de Caso de Uso**:

* Monitorear la utilizaci√≥n de CPU de la instancia de EC2 y enviar una notificaci√≥n a trav√©s de SNS si supera el 80% durante 5 minutos consecutivos.

### Anomaly Detectors

**Los Detectores de Anomal√≠as** utilizan aprendizaje autom√°tico para detectar autom√°ticamente anomal√≠as en sus m√©tricas. Puede aplicar la detecci√≥n de anomal√≠as a cualquier m√©trica de CloudWatch para identificar desviaciones de patrones normales que podr√≠an indicar problemas.

**Componentes Clave**:

* **Entrenamiento del Modelo**: CloudWatch utiliza datos hist√≥ricos para entrenar un modelo y establecer c√≥mo se ve el comportamiento normal.
* **Banda de Detecci√≥n de Anomal√≠as**: Una representaci√≥n visual del rango esperado de valores para una m√©trica.

**Ejemplo de Caso de Uso**:

* Detectar patrones inusuales de utilizaci√≥n de CPU en una instancia de EC2 que podr√≠an indicar una brecha de seguridad o un problema de aplicaci√≥n.

### Insight Rules and Managed Insight Rules

**Las Reglas de Insight** le permiten identificar tendencias, detectar picos u otros patrones de inter√©s en sus datos de m√©tricas utilizando **expresiones matem√°ticas poderosas** para definir las condiciones bajo las cuales se deben tomar acciones. Estas reglas pueden ayudarle a identificar anomal√≠as o comportamientos inusuales en el rendimiento y la utilizaci√≥n de sus recursos.

**Las Reglas de Insight Administradas** son reglas de **insight preconfiguradas proporcionadas por AWS**. Est√°n dise√±adas para monitorear servicios espec√≠ficos de AWS o casos de uso comunes y se pueden habilitar sin necesidad de una configuraci√≥n detallada.

**Ejemplo de Caso de Uso**:

* Monitoreo del Rendimiento de RDS: Habilitar una regla de insight administrada para Amazon RDS que monitorea indicadores clave de rendimiento como la utilizaci√≥n de CPU, el uso de memoria y el I/O de disco. Si alguna de estas m√©tricas supera los umbrales operativos seguros, la regla puede activar una alerta o una acci√≥n de mitigaci√≥n automatizada.

### CloudWatch Logs <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

Permite **agregar y monitorear registros de aplicaciones** y sistemas de **servicios de AWS** (incluyendo CloudTrail) y **de aplicaciones/sistemas** (**CloudWatch Agent** se puede instalar en un host). Los registros pueden ser **almacenados indefinidamente** (dependiendo de la configuraci√≥n del Grupo de Registros) y pueden ser exportados.

**Elementos**:

| **Grupo de Registros**   | Una **colecci√≥n de flujos de registros** que comparten la misma retenci√≥n, monitoreo y configuraciones de control de acceso                                                     |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Flujo de Registros**   | Una secuencia de **eventos de registro** que comparten la **misma fuente**                                                                                                |
| **Filtros de Suscripci√≥n** | Definen un **patr√≥n de filtro que coincide con eventos** en un grupo de registros particular, envi√°ndolos a un flujo de Kinesis Data Firehose, flujo de Kinesis o una funci√≥n Lambda |

### CloudWatch Monitoring & Events

CloudWatch **b√°sico** agrega datos **cada 5 minutos** (el **detallado** lo hace **cada 1 minuto**). Despu√©s de la agregaci√≥n, **verifica los umbrales de las alarmas** en caso de que necesite activar una.\
En ese caso, CloudWatch puede estar preparado para enviar un evento y realizar algunas acciones autom√°ticas (funciones de AWS Lambda, temas de SNS, colas de SQS, flujos de Kinesis)

### Agent Installation

Puede instalar agentes dentro de sus m√°quinas/contenedores para enviar autom√°ticamente los registros de vuelta a CloudWatch.

* **Crear** un **rol** y **adjuntarlo** a la **instancia** con permisos que permitan a CloudWatch recopilar datos de las instancias adem√°s de interactuar con el administrador de sistemas de AWS SSM (CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM)
* **Descargar** e **instalar** el **agente** en la instancia de EC2 ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). Puede descargarlo desde dentro de la EC2 o instalarlo autom√°ticamente usando AWS System Manager seleccionando el paquete AWS-ConfigureAWSPackage
* **Configurar** y **iniciar** el Agente de CloudWatch

Un grupo de registros tiene muchos flujos. Un flujo tiene muchos eventos. Y dentro de cada flujo, los eventos est√°n garantizados en orden.

## Enumeration
```bash
# Dashboards #

## Returns a list of the dashboards of your account
aws cloudwatch list-dashboards

## Retrieves the details of the specified dashboard
aws cloudwatch get-dashboard --dashboard-name <value>

# Metrics #

## Returns a list of the specified metric
aws cloudwatch list-metrics [--namespace <value>] [--metric-name <value>] [--dimensions <value>] [--include-linked-accounts | --no-include-linked-accounts]

## Retrieves metric data (this operation can include a CloudWatch Metrics Insights query, and one or more metric math functions)
aws cloudwatch get-metric-data --metric-data-queries <value> --start-time <value> --end-time <value>

## Retrieves statistics for the specified metric and namespace over a range of time
aws cloudwatch get-metric-statistics --namespace <value> --metric-name <value> [--dimensions <value>] --start-time <value> --end-time <value> --period <value>

## Returns a list of the metric streams of your account
aws cloudwatch list-metric-streams

## Retrieves information about the specified metric stream
aws cloudwatch get-metric-stream --name <value>

## Retrieve snapshots of the specified metric widgets
aws cloudwatch get-metric-widget-image --metric-widget <value>

# Alarms #

## Retrieves the specified alarm
aws cloudwatch describe-alarms [--alarm-names <value>] [--alarm-name-prefix <value>] [--alarm-types <value>] [--state-value <value>]

## Retrieves the alarms history, even for deleted alarms
aws cloudwatch describe-alarm-history [--alarm-name <value>] [--alarm-types <value>] [--history-item-type <ConfigurationUpdate | StateUpdate | Action>] [--start-date <value>] [--end-date <value>]

## Retrieves standard alarms based on the specified metric
aws cloudwatch escribe-alarms-for-metric --metric-name <value> --namespace <value> [--dimensions <value>]

# Anomaly Detections #

## Lists the anomaly detection models that you have created in your account
aws cloudwatch describe-anomaly-detectors [--namespace <value>] [--metric-name <value>] [--dimensions <value>]

## Lists all the Contributor Insight rules in your account
aws cloudwatch describe-insight-rules

## Retrieves the data collected over a time range for a given Contributor Insight rule
aws cloudwatch get-insight-rule-report --rule-name <value> --start-time <value> --end-time <value> --period <value>

## Lists managed Contributor Insights rules in your account for a specified resource
aws cloudwatch list-managed-insight-rules --resource-arn <value>

# Tags #

## Lists the tags associated with the specified CloudWatch resources
aws cloudwatch list-tags-for-resource --resource-arn <value>

# CloudWatch Logs #
aws logs tail "<log_group_name>" --followaws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# CloudWatch Events #
aws events list-rules
aws events describe-rule --name <name>aws events list-targets-by-rule --rule <name>aws events list-archives
aws events describe-archive --archive-name <name>aws events list-connections
aws events describe-connection --name <name>aws events list-endpoints
aws events describe-endpoint --name <name>aws events list-event-sources
aws events describe-event-source --name <name>aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## Post-Exploitation / Bypass

### **`cloudwatch:DeleteAlarms`,`cloudwatch:PutMetricAlarm` , `cloudwatch:PutCompositeAlarm`**

Un atacante con estos permisos podr√≠a socavar significativamente la infraestructura de monitoreo y alertas de una organizaci√≥n. Al eliminar alarmas existentes, un atacante podr√≠a deshabilitar alertas cruciales que notifican a los administradores sobre problemas cr√≠ticos de rendimiento, brechas de seguridad o fallos operativos. Adem√°s, al crear o modificar alarmas m√©tricas, el atacante tambi√©n podr√≠a enga√±ar a los administradores con alertas falsas o silenciar alarmas leg√≠timas, enmascarando efectivamente actividades maliciosas y evitando respuestas oportunas a incidentes reales.

Adem√°s, con el permiso **`cloudwatch:PutCompositeAlarm`**, un atacante podr√≠a crear un bucle o ciclo de alarmas compuestas, donde la alarma compuesta A depende de la alarma compuesta B, y la alarma compuesta B tambi√©n depende de la alarma compuesta A. En este escenario, no es posible eliminar ninguna alarma compuesta que sea parte del ciclo porque siempre hay una alarma compuesta que depende de esa alarma que deseas eliminar.
```bash
aws cloudwatch put-metric-alarm --cli-input-json <value> | --alarm-name <value> --comparison-operator <value> --evaluation-periods <value> [--datapoints-to-alarm <value>] [--threshold <value>] [--alarm-description <value>] [--alarm-actions <value>] [--metric-name <value>] [--namespace <value>] [--statistic <value>] [--dimensions <value>] [--period <value>]
aws cloudwatch delete-alarms --alarm-names <value>
aws cloudwatch put-composite-alarm --alarm-name <value> --alarm-rule <value> [--no-actions-enabled | --actions-enabled [--alarm-actions <value>] [--insufficient-data-actions <value>] [--ok-actions <value>] ]
```
El siguiente ejemplo muestra c√≥mo hacer que una alarma de m√©trica sea ineficaz:

* Esta alarma de m√©trica monitorea la utilizaci√≥n promedio de CPU de una instancia EC2 espec√≠fica, eval√∫a la m√©trica cada 300 segundos y requiere 6 per√≠odos de evaluaci√≥n (30 minutos en total). Si la utilizaci√≥n promedio de CPU supera el 60% durante al menos 4 de estos per√≠odos, la alarma se activar√° y enviar√° una notificaci√≥n al tema SNS especificado.
* Al modificar el umbral para que sea m√°s del 99%, establecer el per√≠odo en 10 segundos, los per√≠odos de evaluaci√≥n en 8640 (ya que 8640 per√≠odos de 10 segundos equivalen a 1 d√≠a), y los puntos de datos a alarma en 8640 tambi√©n, ser√≠a necesario que la utilizaci√≥n de CPU estuviera por encima del 99% cada 10 segundos durante todo el per√≠odo de 24 horas para activar una alarma.

{% tabs %}
{% tab title="Original Metric Alarm" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-01234567890123456"
}
],
"AlarmActions": [
"arn:aws:sns:us-east-1:123456789012:example_sns"
],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 4,
"EvaluationPeriods": 6,
"Period": 300,
"Statistic": "Average",
"Threshold": 60,
"AlarmDescription": "CPU Utilization of i-01234567890123456 over 60%",
"AlarmName": "EC2 instance i-01234567890123456 CPU Utilization"
}
```
{% endtab %}

{% tab title="Alarma de M√©trica Modificada" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0645d6d414dadf9f8"
}
],
"AlarmActions": [],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 8640,
"EvaluationPeriods": 8640,
"Period": 10,
"Statistic": "Average",
"Threshold": 99,
"AlarmDescription": "CPU Utilization of i-01234567890123456 with 60% as threshold",
"AlarmName": "Instance i-0645d6d414dadf9f8 CPU Utilization"
}

```
{% endtab %}
{% endtabs %}

**Impacto Potencial**: Falta de notificaciones para eventos cr√≠ticos, problemas potencialmente no detectados, alertas falsas, suprimir alertas genuinas y potencialmente detecciones perdidas de incidentes reales.

### **`cloudwatch:DeleteAlarmActions`, `cloudwatch:EnableAlarmActions`, `cloudwatch:SetAlarmState`**

Al eliminar acciones de alarma, el atacante podr√≠a prevenir alertas cr√≠ticas y respuestas autom√°ticas de ser activadas cuando se alcanza un estado de alarma, como notificar a los administradores o activar actividades de autoescalado. Habilitar o re-habilitar acciones de alarma de manera inapropiada tambi√©n podr√≠a llevar a comportamientos inesperados, ya sea reactivando acciones previamente deshabilitadas o modificando qu√© acciones se activan, lo que podr√≠a causar confusi√≥n y desv√≠o en la respuesta a incidentes.

Adem√°s, un atacante con el permiso podr√≠a manipular los estados de alarma, siendo capaz de crear falsas alarmas para distraer y confundir a los administradores, o silenciar alarmas genuinas para ocultar actividades maliciosas en curso o fallos cr√≠ticos del sistema.

* Si usas **`SetAlarmState`** en una alarma compuesta, la alarma compuesta no garantiza volver a su estado real. Regresa a su estado real solo una vez que cualquiera de sus alarmas hijas cambie de estado. Tambi√©n se reevaluar√° si actualizas su configuraci√≥n.
```bash
aws cloudwatch disable-alarm-actions --alarm-names <value>
aws cloudwatch enable-alarm-actions --alarm-names <value>
aws cloudwatch set-alarm-state --alarm-name <value> --state-value <OK | ALARM | INSUFFICIENT_DATA> --state-reason <value> [--state-reason-data <value>]
```
**Impacto Potencial**: Falta de notificaciones para eventos cr√≠ticos, problemas potencialmente no detectados, alertas falsas, suprimir alertas genuinas y potencialmente detecciones perdidas de incidentes reales.

### **`cloudwatch:DeleteAnomalyDetector`, `cloudwatch:PutAnomalyDetector`**

Un atacante podr√≠a comprometer la capacidad de detecci√≥n y respuesta a patrones inusuales o anomal√≠as en los datos de m√©tricas. Al eliminar detectores de anomal√≠as existentes, un atacante podr√≠a deshabilitar mecanismos cr√≠ticos de alerta; y al crear o modificarlos, podr√≠a desconfigurarlos o crear falsos positivos para distraer o abrumar la supervisi√≥n.
```bash
aws cloudwatch delete-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value>]
aws cloudwatch put-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value> --configuration <value> --metric-characteristics <value>]
```
El siguiente ejemplo muestra c√≥mo hacer que un detector de anomal√≠as de m√©tricas sea ineficaz. Este detector de anomal√≠as de m√©tricas monitorea la utilizaci√≥n promedio de CPU de una instancia EC2 espec√≠fica, y solo al agregar el par√°metro ‚ÄúExcludedTimeRanges‚Äù con el rango de tiempo deseado, ser√≠a suficiente para asegurar que el detector de anomal√≠as no analice ni alerte sobre ning√∫n dato relevante durante ese per√≠odo.

{% tabs %}
{% tab title="Original Metric Anomaly Detector" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
}
}
```
{% endtab %}

{% tab title="Detector de Anomal√≠as de M√©tricas Modificado" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
},
"Configuration": {
"ExcludedTimeRanges": [
{
"StartTime": "2023-01-01T00:00:00Z",
"EndTime": "2053-01-01T23:59:59Z"
}
],
"Timezone": "Europe/Madrid"
}
}
```
{% endtab %}
{% endtabs %}

**Impacto Potencial**: Efecto directo en la detecci√≥n de patrones inusuales o amenazas de seguridad.

### **`cloudwatch:DeleteDashboards`, `cloudwatch:PutDashboard`**

Un atacante podr√≠a comprometer las capacidades de monitoreo y visualizaci√≥n de una organizaci√≥n al crear, modificar o eliminar sus paneles. Estos permisos podr√≠an ser utilizados para eliminar la visibilidad cr√≠tica sobre el rendimiento y la salud de los sistemas, alterar paneles para mostrar datos incorrectos o ocultar actividades maliciosas.
```bash
aws cloudwatch delete-dashboards --dashboard-names <value>
aws cloudwatch put-dashboard --dashboard-name <value> --dashboard-body <value>
```
**Impacto Potencial**: P√©rdida de visibilidad de monitoreo e informaci√≥n enga√±osa.

### **`cloudwatch:DeleteInsightRules`, `cloudwatch:PutInsightRule`, `cloudwatch:PutManagedInsightRule`**

Las reglas de insight se utilizan para detectar anomal√≠as, optimizar el rendimiento y gestionar recursos de manera efectiva. Al eliminar reglas de insight existentes, un atacante podr√≠a eliminar capacidades cr√≠ticas de monitoreo, dejando al sistema ciego ante problemas de rendimiento y amenazas de seguridad. Adem√°s, un atacante podr√≠a crear o modificar reglas de insight para generar datos enga√±osos o ocultar actividades maliciosas, lo que llevar√≠a a diagn√≥sticos incorrectos y respuestas inapropiadas del equipo de operaciones.
```bash
aws cloudwatch delete-insight-rules --rule-names <value>
aws cloudwatch put-insight-rule --rule-name <value> --rule-definition <value> [--rule-state <value>]
aws cloudwatch put-managed-insight-rules --managed-rules <value>
```
**Impacto Potencial**: Dificultad para detectar y responder a problemas de rendimiento y anomal√≠as, toma de decisiones mal informadas y potencialmente ocultar actividades maliciosas o fallos del sistema.

### **`cloudwatch:DisableInsightRules`, `cloudwatch:EnableInsightRules`**

Al deshabilitar reglas de informaci√≥n cr√≠ticas, un atacante podr√≠a cegar efectivamente a la organizaci√≥n sobre m√©tricas clave de rendimiento y seguridad. Por el contrario, al habilitar o configurar reglas enga√±osas, podr√≠a ser posible generar datos falsos, crear ruido u ocultar actividad maliciosa.
```bash
aws cloudwatch disable-insight-rules --rule-names <value>
aws cloudwatch enable-insight-rules --rule-names <value>
```
**Impacto Potencial**: Confusi√≥n entre el equipo de operaciones, lo que lleva a respuestas retrasadas a problemas reales y acciones innecesarias basadas en alertas falsas.

### **`cloudwatch:DeleteMetricStream` , `cloudwatch:PutMetricStream` , `cloudwatch:PutMetricData`**

Un atacante con los permisos **`cloudwatch:DeleteMetricStream`** , **`cloudwatch:PutMetricStream`** podr√≠a crear y eliminar flujos de datos de m√©tricas, comprometiendo la seguridad, la monitorizaci√≥n y la integridad de los datos:

* **Crear flujos maliciosos**: Crear flujos de m√©tricas para enviar datos sensibles a destinos no autorizados.
* **Manipulaci√≥n de recursos**: La creaci√≥n de nuevos flujos de m√©tricas con datos excesivos podr√≠a producir mucho ruido, causando alertas incorrectas y enmascarando problemas reales.
* **Interrupci√≥n de la monitorizaci√≥n**: Al eliminar flujos de m√©tricas, los atacantes interrumpir√≠an el flujo continuo de datos de monitorizaci√≥n. De esta manera, sus actividades maliciosas estar√≠an efectivamente ocultas.

De manera similar, con el permiso **`cloudwatch:PutMetricData`**, ser√≠a posible agregar datos a un flujo de m√©tricas. Esto podr√≠a llevar a un DoS debido a la cantidad de datos inapropiados a√±adidos, haci√©ndolo completamente in√∫til.
```bash
aws cloudwatch delete-metric-stream --name <value>
aws cloudwatch put-metric-stream --name <value> [--include-filters <value>] [--exclude-filters <value>] --firehose-arn <value> --role-arn <value> --output-format <value>
aws cloudwatch put-metric-data --namespace <value> [--metric-data <value>] [--metric-name <value>] [--timestamp <value>] [--unit <value>] [--value <value>] [--dimensions <value>]
```
Ejemplo de agregar datos correspondientes a un 70% de utilizaci√≥n de CPU en una instancia EC2 dada:
```bash
aws cloudwatch put-metric-data --namespace "AWS/EC2" --metric-name "CPUUtilization" --value 70 --unit "Percent" --dimensions "InstanceId=i-0123456789abcdefg"
```
**Impacto Potencial**: Disrupci√≥n en el flujo de datos de monitoreo, afectando la detecci√≥n de anomal√≠as e incidentes, manipulaci√≥n de recursos y aumento de costos debido a la creaci√≥n de flujos de m√©tricas excesivos.

### **`cloudwatch:StopMetricStreams`, `cloudwatch:StartMetricStreams`**

Un atacante controlar√≠a el flujo de los flujos de datos de m√©tricas afectados (cada flujo de datos si no hay restricci√≥n de recursos). Con el permiso **`cloudwatch:StopMetricStreams`**, los atacantes podr√≠an ocultar sus actividades maliciosas deteniendo flujos de m√©tricas cr√≠ticos.
```bash
aws cloudwatch stop-metric-streams --names <value>
aws cloudwatch start-metric-streams --names <value>
```
**Impacto Potencial**: Disrupci√≥n en el flujo de datos de monitoreo, afectando la detecci√≥n de anomal√≠as e incidentes.

### **`cloudwatch:TagResource`, `cloudwatch:UntagResource`**

Un atacante podr√≠a agregar, modificar o eliminar etiquetas de los recursos de CloudWatch (actualmente solo alarmas y reglas de Contributor Insights). Esto podr√≠a interrumpir las pol√≠ticas de control de acceso de su organizaci√≥n basadas en etiquetas.
```bash
aws cloudwatch tag-resource --resource-arn <value> --tags <value>
aws cloudwatch untag-resource --resource-arn <value> --tag-keys <value>
```
**Impacto Potencial**: Disrupci√≥n de las pol√≠ticas de control de acceso basadas en etiquetas.

## Referencias

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_amazoncloudwatch.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_amazoncloudwatch.html)
* [https://docs.aws.amazon.com/es\_es/AmazonCloudWatch/latest/monitoring/cloudwatch\_concepts.html#Metric](https://docs.aws.amazon.com/es\_es/AmazonCloudWatch/latest/monitoring/cloudwatch\_concepts.html#Metric)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
