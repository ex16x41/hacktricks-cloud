# CloudWatch

**CloudWatch** zbiera dane monitorujÄ…ce i operacyjne w postaci logÃ³w/metryk/zdarzeÅ„, zapewniajÄ…c **spÃ³jny widok zasobÃ³w AWS**, aplikacji i usÅ‚ug.\
Zdarzenia logÃ³w CloudWatch majÄ… **ograniczenie rozmiaru 256 KB na kaÅ¼dÄ… liniÄ™ logu**.\
MoÅ¼na ustawiÄ‡ **alarmy o wysokiej rozdzielczoÅ›ci**, wizualizowaÄ‡ **logi** i **metryki** obok siebie, podejmowaÄ‡ dziaÅ‚ania automatyczne, rozwiÄ…zywaÄ‡ problemy i odkrywaÄ‡ wskazÃ³wki do optymalizacji aplikacji.

MoÅ¼na monitorowaÄ‡ na przykÅ‚ad logi z CloudTrail. Zdarzenia, ktÃ³re sÄ… monitorowane:

* Zmiany w grupach zabezpieczeÅ„ i NACL
* Uruchamianie, zatrzymywanie, restartowanie i usuwanie instancji EC2
* Zmiany w politykach zabezpieczeÅ„ w IAM i S3
* Nieudane prÃ³by logowania do Konsoli ZarzÄ…dzania AWS
* WywoÅ‚ania API, ktÃ³re skutkowaÅ‚y nieudanÄ… autoryzacjÄ…
* Filtry do wyszukiwania w CloudWatch: [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

## Kluczowe pojÄ™cia

### Przestrzenie nazw

PrzestrzeÅ„ nazw to kontener na metryki CloudWatch. Pomaga kategoryzowaÄ‡ i izolowaÄ‡ metryki, uÅ‚atwiajÄ…c ich zarzÄ…dzanie i analizÄ™.

- **PrzykÅ‚ady**: AWS/EC2 dla metryk zwiÄ…zanych z EC2, AWS/RDS dla metryk RDS.

### Metryki

Metryki to punkty danych zbierane w czasie, ktÃ³re reprezentujÄ… wydajnoÅ›Ä‡ lub wykorzystanie zasobÃ³w AWS. Metryki moÅ¼na zbieraÄ‡ z usÅ‚ug AWS, aplikacji niestandardowych lub integracji zewnÄ™trznych.

- **PrzykÅ‚ad**: CPUUtilization, NetworkIn, DiskReadOps.

### Wymiary

Wymiary to pary klucz-wartoÅ›Ä‡, ktÃ³re sÄ… czÄ™Å›ciÄ… metryk. PomagajÄ… one jednoznacznie zidentyfikowaÄ‡ metrykÄ™ i dostarczyÄ‡ dodatkowego kontekstu, przy czym 30 to maksymalna liczba wymiarÃ³w, ktÃ³re moÅ¼na powiÄ…zaÄ‡ z metrykÄ…. Wymiary pozwalajÄ… rÃ³wnieÅ¼ filtrowaÄ‡ i agregowaÄ‡ metryki na podstawie okreÅ›lonych atrybutÃ³w.

- **PrzykÅ‚ad**: Dla instancji EC2 wymiary mogÄ… obejmowaÄ‡ InstanceId, InstanceType i AvailabilityZone.

### Statystyki

Statystyki to obliczenia matematyczne przeprowadzane na danych metrycznych w celu ich podsumowania w czasie. Powszechne statystyki obejmujÄ… ÅšredniÄ…, SumÄ™, Minimum, Maksimum i LiczbÄ™ prÃ³bek.

- **PrzykÅ‚ad**: Obliczanie Å›redniego zuÅ¼ycia CPU w okresie jednej godziny.

### Jednostki

Jednostki to rodzaj pomiaru powiÄ…zany z metrykÄ…. Jednostki pomagajÄ… dostarczyÄ‡ kontekst i znaczenie danych metrycznych. Powszechne jednostki obejmujÄ… Procent, Bajty, Sekundy, LiczbÄ™.

- **PrzykÅ‚ad**: CPUUtilization moÅ¼e byÄ‡ mierzone w procentach, podczas gdy NetworkIn moÅ¼e byÄ‡ mierzone w bajtach.

## Funkcje CloudWatch

### Panel

**Panele CloudWatch** zapewniajÄ… dostosowane **widoki metryk AWS CloudWatch**. MoÅ¼na tworzyÄ‡ i konfigurowaÄ‡ panele, aby wizualizowaÄ‡ dane i monitorowaÄ‡ zasoby w jednym widoku, Å‚Ä…czÄ…c rÃ³Å¼ne metryki z rÃ³Å¼nych usÅ‚ug AWS.

**GÅ‚Ã³wne funkcje**:

- **Widgety**: Bloki konstrukcyjne paneli, w tym wykresy, tekst, alarmy i inne.
- **Dostosowanie**: UkÅ‚ad i zawartoÅ›Ä‡ mogÄ… byÄ‡ dostosowane do konkretnych potrzeb monitorowania.

**PrzykÅ‚adowe zastosowanie**:

- Jeden panel pokazujÄ…cy kluczowe metryki dla caÅ‚ego Å›rodowiska AWS, w tym instancje EC2, bazy danych RDS i kubeÅ‚ki S3.

### StrumieÅ„ metryk i dane metryk

**Strumienie metryk** w AWS CloudWatch umoÅ¼liwiajÄ… ciÄ…gÅ‚e przesyÅ‚anie metryk CloudWatch do wybranego miejsca docelowego w czasie rzeczywistym. Jest to szczegÃ³lnie przydatne do zaawansowanego monitorowania, analizy i dostosowywania paneli za pomocÄ… narzÄ™dzi spoza AWS.

**Dane metryk** wewnÄ…trz Strumieni metryk odnoszÄ… siÄ™ do rzeczywistych pomiarÃ³w lub punktÃ³w danych, ktÃ³re sÄ… przesyÅ‚ane. Te punkty danych reprezentujÄ… rÃ³Å¼ne metryki, takie jak zuÅ¼ycie CPU, uÅ¼ycie pamiÄ™ci, itp., dla zasobÃ³w AWS.

**PrzykÅ‚adowe zastosowanie**:

- WysyÅ‚anie metryk w czasie rzeczywistym do usÅ‚ugi monitorowania osÃ³b trzecich w celu zaawansowanej analizy.
- Archiwizowanie metryk w kubeÅ‚ku Amazon S3 w celu dÅ‚ugoterminowego przechowywania i zgodnoÅ›ci.

### Alarm

**Alarmy CloudWatch** monitorujÄ… twoje metryki i wykonujÄ… dziaÅ‚ania na podstawie zdefiniowanych progÃ³w. Gdy metryka przekroczy prÃ³g, alarm moÅ¼e wykonaÄ‡ jedno lub wiÄ™cej dziaÅ‚aÅ„, takich jak wysyÅ‚anie powiadomieÅ„ za poÅ›rednictwem SNS, uruchamianie polityki automatycznego skalowania lub uruchamianie funkcji AWS Lambda.

**GÅ‚Ã³wne skÅ‚adniki**:

- **PrÃ³g**: WartoÅ›Ä‡, przy ktÃ³rej alarm zostaje uruchomiony.
- **Okresy oceny**: Liczba okresÃ³w, w ktÃ³rych dane sÄ… oceniane.
- **Punkty danych do alarmu**: Liczba okresÃ³w z osiÄ…gniÄ™tym progiem potrzebna do uruchomienia alarmu.
- **DziaÅ‚ania**: Co siÄ™ dzieje, gdy stan alarmu zostanie uruchomiony (np. powiadomienie za poÅ›rednictwem SNS).

**PrzykÅ‚adowe zastosowanie**:

- Monitorowanie zuÅ¼ycia CPU instancji EC2 i wysyÅ‚anie powiadomienia za poÅ›rednictwem SNS, jeÅ›li przekroczy 80% przez 5 kolejnych minut.

### Detektory anomalii

**Detektory anomalii** wykorzystujÄ… uczenie maszynowe do automatycznego wykrywania anomalii w twoich metrykach. MoÅ¼esz zastosowaÄ‡ detekcjÄ™ anomalii do dowolnej metryki CloudWatch, aby zidentyfikowaÄ‡ odstÄ™pstwa od normalnych wzorcÃ³w, ktÃ³re mogÄ… wskazywaÄ‡ na problemy.

**GÅ‚Ã³wne skÅ‚adniki**:

- **Szkolenie modelu**: CloudWatch wykorzystuje dane historyczne do szkolenia modelu i ustalenia, jak wyglÄ…da normalne zachowanie.
- **Pasmo detekcji anomalii**: Wizualna reprezentacja zakresu wartoÅ›ci oczekiwanych dla metryki.

**PrzykÅ‚adowe zastosowanie**:

- Wykrywanie nietypowych wzorcÃ³w zuÅ¼ycia CPU w instancji EC2, ktÃ³re mogÄ… wskazywaÄ‡ na naruszenie bezpieczeÅ„stwa lub problem z aplikacjÄ….

### Zasady Insight i ZarzÄ…dzane zasady Insight

**Zasady Insight** pozwalajÄ… identyfikowaÄ‡ trendy, wykrywaÄ‡ szpilki lub inne interesujÄ…ce wzorce w danych metrycznych za pomocÄ… **potÄ™Å¼nych wyraÅ¼eÅ„ matematycznych**, aby zdefiniowaÄ‡ warunki, w ktÃ³rych naleÅ¼y podjÄ…Ä‡ dziaÅ‚ania. Te zasady mogÄ… pomÃ³c zidentyfikowaÄ‡ anomalie lub nietypowe zachowania w wydajnoÅ›ci i wykorzystaniu zasobÃ³w.

**ZarzÄ…dzane zasady Insight** to prekonfigurowane **zasady Insight dostarczane przez AWS**. ZostaÅ‚y zaprojektowane do monitorowania okreÅ›lonych usÅ‚ug AWS lub powszechnych przypadkÃ³w uÅ¼ycia i mogÄ… byÄ‡ wÅ‚Ä…czone bez potrzeby szczegÃ³Å‚owej konfiguracji.

**PrzykÅ‚adowe zastosowanie**:

- Monitorowanie wydajnoÅ›ci RDS: WÅ‚Ä…cz zarzÄ…dzonÄ… zasadÄ™ Insight dla Amazon RDS, ktÃ³ra monitoruje kluczowe wskaÅºniki wydajnoÅ›ci, takie jak zuÅ¼ycie CPU, uÅ¼ycie pamiÄ™ci i operacje wejÅ›cia/wyjÅ›cia dysku. JeÅ›li ktÃ³rykolwiek z tych wskaÅºnikÃ³w przekroczy bezpieczne progi operacyjne, zasada moÅ¼e wywoÅ‚aÄ‡ alert lub automatyczne dziaÅ‚anie naprawcze.

### Logi CloudWatch <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

Pozwala na **agregowanie i monitorowanie logÃ³w z aplikacji** i systemÃ³w z **usÅ‚ug AWS** (w tym CloudTrail) i **z aplikacji/systemÃ³w** (**Agent CloudWatch** moÅ¼e byÄ‡ zainstalowany na hoÅ›cie). Logi mogÄ… byÄ‡ **przechowywane czas nieokreÅ›lony** (w zaleÅ¼noÅ›ci od ustawieÅ„ Grupy LogÃ³w) i mogÄ… byÄ‡ eksportowane.

**Elementy**:

| **Grupa logÃ³w**         | **ZbiÃ³r strumieni logÃ³w**, ktÃ³re dzielÄ… te same ustawienia retencji, monitorowania i kontroli dostÄ™pu                                                     |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **StrumieÅ„ logÃ³w**       | Sekwencja **zdarzeÅ„ logÃ³w**, ktÃ³re dzielÄ… **ten sam ÅºrÃ³dÅ‚o**                                                                                                  |
| **Filtry subskrypcji**   | DefiniujÄ… **wzorzec filtru, ktÃ³ry pasuje do zdarzeÅ„** w okreÅ›lonej grupie logÃ³w, wysyÅ‚ajÄ… je do strumienia Kinesis Data Firehose, strumienia Kinesis lub funkcji Lambda |
### Monitorowanie i zdarzenia CloudWatch

CloudWatch **podstawowy** agreguje dane **co 5 minut** (ten **szczegÃ³Å‚owy** robi to **co 1 minutÄ™**). Po agregacji **sprawdza progi alarmÃ³w**, w przypadku koniecznoÅ›ci ich wyzwolenia.\
W takim przypadku CloudWatch moÅ¼e byÄ‡ skonfigurowany do wysyÅ‚ania zdarzenia i wykonywania automatycznych akcji (funkcje AWS Lambda, tematy SNS, kolejki SQS, strumienie Kinesis)

### Instalacja agenta

MoÅ¼esz zainstalowaÄ‡ agenty wewnÄ…trz swoich maszyn/kontenerÃ³w, aby automatycznie wysyÅ‚aÄ‡ dzienniki z powrotem do CloudWatch.

* **UtwÃ³rz** rolÄ™ i **doÅ‚Ä…cz** jÄ… do **instancji** z uprawnieniami umoÅ¼liwiajÄ…cymi CloudWatch zbieranie danych z instancji oraz interakcjÄ™ z menedÅ¼erem systemÃ³w AWS SSM (CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM)
* **Pobierz** i **zainstaluj** agenta na instancji EC2 ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). MoÅ¼esz pobraÄ‡ go z wewnÄ…trz EC2 lub zainstalowaÄ‡ automatycznie za pomocÄ… AWS System Manager, wybierajÄ…c pakiet AWS-ConfigureAWSPackage
* **Skonfiguruj** i **uruchom** agenta CloudWatch

Grupa dziennikÃ³w ma wiele strumieni. StrumieÅ„ ma wiele zdarzeÅ„. WewnÄ…trz kaÅ¼dego strumienia zdarzenia sÄ… gwarantowane w kolejnoÅ›ci.

## Wyliczenie
```bash
# Dashboards #

## Returns a list of the dashboards of your account
aws cloudwatch list-dashboards

## Retrieves the details of the specified dashboard
aws cloudwatch get-dashboard --dashboard-name <value>

# Metrics #

## Returns a list of the specified metric
aws cloudwatch list-metrics [--namespace <value>] [--metric-name <value>] [--dimensions <value>] [--include-linked-accounts | --no-include-linked-accounts]

## Retrieves metric data (this operation can include a CloudWatch Metrics Insights query, and one or more metric math functions)
aws cloudwatch get-metric-data --metric-data-queries <value> --start-time <value> --end-time <value>

## Retrieves statistics for the specified metric and namespace over a range of time
aws cloudwatch get-metric-statistics --namespace <value> --metric-name <value> [--dimensions <value>] --start-time <value> --end-time <value> --period <value>

## Returns a list of the metric streams of your account
aws cloudwatch list-metric-streams

## Retrieves information about the specified metric stream
aws cloudwatch get-metric-stream --name <value>

## Retrieve snapshots of the specified metric widgets
aws cloudwatch get-metric-widget-image --metric-widget <value>

# Alarms #

## Retrieves the specified alarm
aws cloudwatch describe-alarms [--alarm-names <value>] [--alarm-name-prefix <value>] [--alarm-types <value>] [--state-value <value>]

## Retrieves the alarms history, even for deleted alarms
aws cloudwatch describe-alarm-history [--alarm-name <value>] [--alarm-types <value>] [--history-item-type <ConfigurationUpdate | StateUpdate | Action>] [--start-date <value>] [--end-date <value>]

## Retrieves standard alarms based on the specified metric
aws cloudwatch escribe-alarms-for-metric --metric-name <value> --namespace <value> [--dimensions <value>]

# Anomaly Detections #

## Lists the anomaly detection models that you have created in your account
aws cloudwatch describe-anomaly-detectors [--namespace <value>] [--metric-name <value>] [--dimensions <value>]

## Lists all the Contributor Insight rules in your account
aws cloudwatch describe-insight-rules

## Retrieves the data collected over a time range for a given Contributor Insight rule
aws cloudwatch get-insight-rule-report --rule-name <value> --start-time <value> --end-time <value> --period <value>

## Lists managed Contributor Insights rules in your account for a specified resource
aws cloudwatch list-managed-insight-rules --resource-arn <value>

# Tags #

## Lists the tags associated with the specified CloudWatch resources
aws cloudwatch list-tags-for-resource --resource-arn <value>

# CloudWatch Logs #
aws logs tail "<log_group_name>" --followaws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# CloudWatch Events #
aws events list-rules
aws events describe-rule --name <name>aws events list-targets-by-rule --rule <name>aws events list-archives
aws events describe-archive --archive-name <name>aws events list-connections
aws events describe-connection --name <name>aws events list-endpoints
aws events describe-endpoint --name <name>aws events list-event-sources
aws events describe-event-source --name <name>aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## Post-Eksploatacja / OminiÄ™cie

### **`cloudwatch:DeleteAlarms`,`cloudwatch:PutMetricAlarm` ,Â `cloudwatch:PutCompositeAlarm`**

AtakujÄ…cy posiadajÄ…cy te uprawnienia mÃ³gÅ‚by znaczÄ…co osÅ‚abiÄ‡ infrastrukturÄ™ monitoringu i alarmowania organizacji. Poprzez usuwanie istniejÄ…cych alarmÃ³w, atakujÄ…cy mÃ³gÅ‚by wyÅ‚Ä…czyÄ‡ istotne alerty informujÄ…ce administratorÃ³w o krytycznych problemach wydajnoÅ›ci, naruszeniach bezpieczeÅ„stwa lub awariach operacyjnych. Ponadto, poprzez tworzenie lub modyfikowanie alarmÃ³w metryk, atakujÄ…cy mÃ³gÅ‚by rÃ³wnieÅ¼ wprowadziÄ‡ w bÅ‚Ä…d administratorÃ³w faÅ‚szywymi alarmami lub wyciszyÄ‡ prawidÅ‚owe alarmy, efektywnie maskujÄ…c zÅ‚oÅ›liwe dziaÅ‚ania i uniemoÅ¼liwiajÄ…c szybkÄ… reakcjÄ™ na rzeczywiste incydenty.

Dodatkowo, dziÄ™ki uprawnieniom **`cloudwatch:PutCompositeAlarm`**, atakujÄ…cy byÅ‚by w stanie stworzyÄ‡ pÄ™tlÄ™ lub cykl alarmÃ³w zÅ‚oÅ¼onych, gdzie alarm zÅ‚oÅ¼ony A zaleÅ¼y od alarmu zÅ‚oÅ¼onego B, a alarm zÅ‚oÅ¼ony B rÃ³wnieÅ¼ zaleÅ¼y od alarmu zÅ‚oÅ¼onego A. W tym scenariuszu nie jest moÅ¼liwe usuniÄ™cie Å¼adnego alarmu zÅ‚oÅ¼onego bÄ™dÄ…cego czÄ™Å›ciÄ… cyklu, poniewaÅ¼ zawsze istnieje alarm zÅ‚oÅ¼ony, ktÃ³ry zaleÅ¼y od tego alarmu, ktÃ³ry chcesz usunÄ…Ä‡.
```bash
aws cloudwatch put-metric-alarm --cli-input-json <value> | --alarm-name <value> --comparison-operator <value> --evaluation-periods <value> [--datapoints-to-alarm <value>] [--threshold <value>] [--alarm-description <value>] [--alarm-actions <value>] [--metric-name <value>] [--namespace <value>] [--statistic <value>] [--dimensions <value>] [--period <value>]
aws cloudwatch delete-alarms --alarm-names <value>
aws cloudwatch put-composite-alarm --alarm-name <value> --alarm-rule <value> [--no-actions-enabled | --actions-enabled [--alarm-actions <value>] [--insufficient-data-actions <value>] [--ok-actions <value>] ]
```
PoniÅ¼szy przykÅ‚ad pokazuje, jak uczyniÄ‡ alarm metryczny nieskutecznym:

- Ten alarm metryczny monitoruje Å›rednie obciÄ…Å¼enie procesora okreÅ›lonej instancji EC2, ocenia metrykÄ™ co 300 sekund i wymaga 6 okresÃ³w oceny (Å‚Ä…cznie 30 minut). JeÅ›li Å›rednie obciÄ…Å¼enie procesora przekroczy 60% przez co najmniej 4 z tych okresÃ³w, alarm zostanie uruchomiony i wysÅ‚a powiadomienie do okreÅ›lonego tematu SNS.
- ZmieniajÄ…c PrÃ³g na wartoÅ›Ä‡ wiÄ™kszÄ… niÅ¼ 99%, ustawiajÄ…c Okres na 10 sekund, LiczbÄ™ okresÃ³w oceny na 8640 (poniewaÅ¼ 8640 okresÃ³w po 10 sekund rÃ³wna siÄ™ 1 dniu), a takÅ¼e LiczbÄ™ punktÃ³w danych do alarmu na 8640, konieczne byÅ‚oby, aby obciÄ…Å¼enie procesora przekraczaÅ‚o 99% co 10 sekund przez caÅ‚Ä… dobÄ™, aby uruchomiÄ‡ alarm.

{% tabs %}
{% tab title="Oryginalny Alarm Metryczny" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-01234567890123456"
}
],
"AlarmActions": [
"arn:aws:sns:us-east-1:123456789012:example_sns"
],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 4,
"EvaluationPeriods": 6,
"Period": 300,
"Statistic": "Average",
"Threshold": 60,
"AlarmDescription": "CPU Utilization of i-01234567890123456 over 60%",
"AlarmName": "EC2 instance i-01234567890123456 CPU Utilization"
}
```
{% endtab %}
{% tab title="Zmodyfikowany alarm metryki" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0645d6d414dadf9f8"
}
],
"AlarmActions": [],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 8640,
"EvaluationPeriods": 8640,
"Period": 10,
"Statistic": "Average",
"Threshold": 99,
"AlarmDescription": "CPU Utilization of i-01234567890123456 with 60% as threshold",
"AlarmName": "Instance i-0645d6d414dadf9f8 CPU Utilization"
}

```
{% endtab %}
{% endtabs %}
**Potencjalne skutki**: Brak powiadomieÅ„ o istotnych zdarzeniach, potencjalne niewykryte problemy, faÅ‚szywe alarmy, wyciszenie prawdziwych alarmÃ³w i potencjalne pominiÄ™cie wykrycia rzeczywistych incydentÃ³w.

### **`cloudwatch:DeleteAlarmActions`,Â `cloudwatch:EnableAlarmActions` , `cloudwatch:SetAlarmState`**

Poprzez usuniÄ™cie dziaÅ‚aÅ„ alarmowych, atakujÄ…cy mÃ³gÅ‚by zapobiec wywoÅ‚aniu krytycznych alarmÃ³w i automatycznych odpowiedzi, gdy stan alarmowy zostanie osiÄ…gniÄ™ty, na przykÅ‚ad powiadamianie administratorÃ³w lub wywoÅ‚ywanie dziaÅ‚aÅ„ automatycznego skalowania. NiewÅ‚aÅ›ciwe wÅ‚Ä…czenie lub ponowne wÅ‚Ä…czenie dziaÅ‚aÅ„ alarmowych moÅ¼e rÃ³wnieÅ¼ prowadziÄ‡ do nieoczekiwanych zachowaÅ„, zarÃ³wno poprzez ponowne aktywowanie wczeÅ›niej wyÅ‚Ä…czonych dziaÅ‚aÅ„, jak i poprzez zmianÄ™ wywoÅ‚ywanych dziaÅ‚aÅ„, co potencjalnie moÅ¼e powodowaÄ‡ zamieszanie i bÅ‚Ä™dne kierowanie reakcjÄ… na incydent.

Dodatkowo, atakujÄ…cy posiadajÄ…cy odpowiednie uprawnienia mÃ³gÅ‚by manipulowaÄ‡ stanami alarmowymi, tworzÄ…c faÅ‚szywe alarmy w celu rozproszenia i dezorientacji administratorÃ³w, lub wyciszajÄ…c prawdziwe alarmy, aby ukryÄ‡ trwajÄ…ce zÅ‚oÅ›liwe dziaÅ‚ania lub krytyczne awarie systemu.

- JeÅ›li uÅ¼yjesz **`SetAlarmState`** na alarmie zÅ‚oÅ¼onym, alarm zÅ‚oÅ¼ony nie jest gwarantowany, Å¼e wrÃ³ci do swojego rzeczywistego stanu. Wraca do swojego rzeczywistego stanu tylko wtedy, gdy ktÃ³rykolwiek z jego alarmÃ³w potomnych zmieni stan. Jest rÃ³wnieÅ¼ ponownie oceniany, jeÅ›li zaktualizujesz jego konfiguracjÄ™.
```bash
aws cloudwatch disable-alarm-actions --alarm-names <value>
aws cloudwatch enable-alarm-actions --alarm-names <value>
aws cloudwatch set-alarm-state --alarm-name <value> --state-value <OK | ALARM | INSUFFICIENT_DATA> --state-reason <value> [--state-reason-data <value>]
```
**Potencjalny wpÅ‚yw**: Brak powiadomieÅ„ o istotnych zdarzeniach, potencjalne niewykryte problemy, faÅ‚szywe alarmy, tÅ‚umienie prawdziwych alarmÃ³w i potencjalnie pominiÄ™cie wykrycia rzeczywistych incydentÃ³w.

### **`cloudwatch:DeleteAnomalyDetector`,Â `cloudwatch:PutAnomalyDetector`**

AtakujÄ…cy mÃ³gÅ‚by zagroziÄ‡ zdolnoÅ›ciom wykrywania i reagowania na nietypowe wzorce lub anomalie w danych metrycznych. Poprzez usuwanie istniejÄ…cych detektorÃ³w anomalii, atakujÄ…cy mÃ³gÅ‚by wyÅ‚Ä…czyÄ‡ krytyczne mechanizmy alarmowania; a poprzez tworzenie lub modyfikowanie ich, mÃ³gÅ‚by albo Åºle skonfigurowaÄ‡, albo tworzyÄ‡ faÅ‚szywe pozytywy w celu rozproszenia lub przytÅ‚oczenia monitoringu.
```bash
aws cloudwatch delete-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value>]
aws cloudwatch put-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value> --configuration <value> --metric-characteristics <value>]
```
PoniÅ¼szy przykÅ‚ad pokazuje, jak uczyniÄ‡ detektor anomalii metrycznych nieskutecznym. Ten detektor anomalii metrycznych monitoruje Å›rednie wykorzystanie procesora okreÅ›lonej instancji EC2, i wystarczy dodaÄ‡ parametr â€ExcludedTimeRangesâ€ z poÅ¼Ä…danym zakresem czasowym, aby zapewniÄ‡, Å¼e detektor anomalii nie analizuje ani nie alarmuje o Å¼adnych istotnych danych w tym okresie.

{% tabs %}
{% tab title="Oryginalny Detektor Anomalii Metrycznych" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
}
}
```
{% endtab %}
{% tab title="Zmodyfikowany detektor anomalii metryk" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
},
"Configuration": {
"ExcludedTimeRanges": [
{
"StartTime": "2023-01-01T00:00:00Z",
"EndTime": "2053-01-01T23:59:59Z"
}
],
"Timezone": "Europe/Madrid"
}
}
```
{% endtab %}
{% endtabs %}
**Potencjalne skutki**: BezpoÅ›redni wpÅ‚yw na wykrywanie nietypowych wzorcÃ³w lub zagroÅ¼eÅ„ bezpieczeÅ„stwa.

### **`cloudwatch:DeleteDashboards`,Â `cloudwatch:PutDashboard`**

AtakujÄ…cy mÃ³gÅ‚by naruszyÄ‡ zdolnoÅ›ci monitorowania i wizualizacji organizacji poprzez tworzenie, modyfikowanie lub usuwanie jej pulpitÃ³w nawigacyjnych. Te uprawnienia mogÄ… byÄ‡ wykorzystane do usuniÄ™cia kluczowej widocznoÅ›ci wydajnoÅ›ci i stanu zdrowia systemÃ³w, zmiany pulpitÃ³w nawigacyjnych w celu wyÅ›wietlania nieprawidÅ‚owych danych lub ukrywania zÅ‚oÅ›liwych dziaÅ‚aÅ„.
```bash
aws cloudwatch delete-dashboards --dashboard-names <value>
aws cloudwatch put-dashboard --dashboard-name <value> --dashboard-body <value>
```
**Potencjalny wpÅ‚yw**: Utrata widocznoÅ›ci monitorowania i wprowadzanie w bÅ‚Ä…d.

### **`cloudwatch:DeleteInsightRules`,Â `cloudwatch:PutInsightRule` ,`cloudwatch:PutManagedInsightRule`**

Zasady Insight sÄ… uÅ¼ywane do wykrywania anomalii, optymalizacji wydajnoÅ›ci i efektywnego zarzÄ…dzania zasobami. Poprzez usuniÄ™cie istniejÄ…cych zasad Insight, atakujÄ…cy mÃ³gÅ‚by usunÄ…Ä‡ krytyczne zdolnoÅ›ci monitorowania, pozostawiajÄ…c system Å›lepy na problemy wydajnoÅ›ciowe i zagroÅ¼enia bezpieczeÅ„stwa. Dodatkowo, atakujÄ…cy mÃ³gÅ‚by tworzyÄ‡ lub modyfikowaÄ‡ zasady Insight w celu generowania mylÄ…cych danych lub ukrywania zÅ‚oÅ›liwych dziaÅ‚aÅ„, co prowadziÅ‚oby do nieprawidÅ‚owych diagnoz i nieodpowiednich reakcji ze strony zespoÅ‚u operacyjnego.
```bash
aws cloudwatch delete-insight-rules --rule-names <value>
aws cloudwatch put-insight-rule --rule-name <value> --rule-definition <value> [--rule-state <value>]
aws cloudwatch put-managed-insight-rules --managed-rules <value>
```
**Potencjalny wpÅ‚yw**: TrudnoÅ›Ä‡ w wykrywaniu i reagowaniu na problemy wydajnoÅ›ciowe i anomalie, podejmowanie decyzji na podstawie bÅ‚Ä™dnych informacji oraz potencjalne ukrywanie zÅ‚oÅ›liwych dziaÅ‚aÅ„ lub awarii systemu.

### **`cloudwatch:DisableInsightRules`,Â `cloudwatch:EnableInsightRules`**

Poprzez wyÅ‚Ä…czenie istotnych reguÅ‚ Insight, atakujÄ…cy mÃ³gÅ‚by skutecznie oÅ›lepiÄ‡ organizacjÄ™ w zakresie kluczowych metryk dotyczÄ…cych wydajnoÅ›ci i bezpieczeÅ„stwa. Z kolei, poprzez wÅ‚Ä…czenie lub konfigurowanie wprowadzajÄ…cych w bÅ‚Ä…d reguÅ‚, moÅ¼liwe byÅ‚oby generowanie faÅ‚szywych danych, tworzenie szumu lub ukrywanie zÅ‚oÅ›liwej aktywnoÅ›ci.
```bash
aws cloudwatch disable-insight-rules --rule-names <value>
aws cloudwatch enable-insight-rules --rule-names <value>
```
**Potencjalne skutki**: Dezorientacja wÅ›rÃ³d zespoÅ‚u operacyjnego, prowadzÄ…ca do opÃ³Åºnionych reakcji na rzeczywiste problemy i niepotrzebnych dziaÅ‚aÅ„ opartych na faÅ‚szywych alertach.

### **`cloudwatch:DeleteMetricStream`, `cloudwatch:PutMetricStream`, `cloudwatch:PutMetricData`**

AtakujÄ…cy posiadajÄ…cy uprawnienia **`cloudwatch:DeleteMetricStream`**, **`cloudwatch:PutMetricStream`** mÃ³gÅ‚by tworzyÄ‡ i usuwaÄ‡ strumienie danych metrycznych, naruszajÄ…c bezpieczeÅ„stwo, monitorowanie i integralnoÅ›Ä‡ danych:

- **Tworzenie zÅ‚oÅ›liwych strumieni**: Tworzenie strumieni metrycznych do wysyÅ‚ania poufnych danych do nieautoryzowanych miejsc.
- **Manipulacja zasobami**: Tworzenie nowych strumieni metrycznych z nadmiernymi danymi mogÅ‚oby generowaÄ‡ wiele szumu, powodujÄ…c bÅ‚Ä™dne alerty, maskujÄ…c prawdziwe problemy.
- **ZakÅ‚Ã³cenie monitoringu**: UsuwajÄ…c strumienie metryczne, atakujÄ…cy zakÅ‚Ã³ciliby ciÄ…gÅ‚y przepÅ‚yw danych monitorujÄ…cych. W ten sposÃ³b ich zÅ‚oÅ›liwe dziaÅ‚ania zostaÅ‚yby skutecznie ukryte.

Podobnie, posiadajÄ…c uprawnienia **`cloudwatch:PutMetricData`**, moÅ¼liwe byÅ‚oby dodawanie danych do strumienia metrycznego. MogÅ‚oby to prowadziÄ‡ do ataku typu DoS ze wzglÄ™du na iloÅ›Ä‡ nieprawidÅ‚owych danych dodanych, sprawiajÄ…c, Å¼e byÅ‚by caÅ‚kowicie bezuÅ¼yteczny.
```bash
aws cloudwatch delete-metric-stream --name <value>
aws cloudwatch put-metric-stream --name <value> [--include-filters <value>] [--exclude-filters <value>] --firehose-arn <value> --role-arn <value> --output-format <value>
aws cloudwatch put-metric-data --namespace <value> [--metric-data <value>] [--metric-name <value>] [--timestamp <value>] [--unit <value>] [--value <value>] [--dimensions <value>]
```
PrzykÅ‚ad dodawania danych odpowiadajÄ…cych 70% wykorzystania CPU dla okreÅ›lonej instancji EC2:
```bash
aws cloudwatch put-metric-data --namespace "AWS/EC2" --metric-name "CPUUtilization" --value 70 --unit "Percent" --dimensions "InstanceId=i-0123456789abcdefg"
```
**Potencjalny wpÅ‚yw**: ZakÅ‚Ã³cenie przepÅ‚ywu danych monitorujÄ…cych, wpÅ‚ywajÄ…ce na wykrywanie anomalii i incydentÃ³w, manipulacjÄ™ zasobami oraz wzrost kosztÃ³w zwiÄ…zany z tworzeniem nadmiernych strumieni metryk.

### **`cloudwatch:StopMetricStreams`,Â `cloudwatch:StartMetricStreams`**

AtakujÄ…cy mÃ³gÅ‚by kontrolowaÄ‡ przepÅ‚yw dotkniÄ™tych strumieni danych metrycznych (kaÅ¼dy strumieÅ„ danych, jeÅ›li nie ma ograniczenia zasobÃ³w). DziÄ™ki uprawnieniu **`cloudwatch:StopMetricStreams`**, atakujÄ…cy mogliby ukryÄ‡ swoje zÅ‚oÅ›liwe dziaÅ‚ania poprzez zatrzymywanie kluczowych strumieni metryk.
```bash
aws cloudwatch stop-metric-streams --names <value>
aws cloudwatch start-metric-streams --names <value>
```
**Potencjalne skutki**: ZakÅ‚Ã³cenie przepÅ‚ywu danych monitorujÄ…cych, wpÅ‚ywajÄ…ce na wykrywanie anomalii i incydentÃ³w.

### **`cloudwatch:TagResource`,Â `cloudwatch:UntagResource`**

AtakujÄ…cy byÅ‚by w stanie dodaÄ‡, zmodyfikowaÄ‡ lub usunÄ…Ä‡ tagi z zasobÃ³w CloudWatch (obecnie tylko alarmÃ³w i reguÅ‚ Contributor Insights). MoÅ¼e to zakÅ‚Ã³ciÄ‡ polityki kontroli dostÄ™pu organizacji oparte na tagach.
```bash
aws cloudwatch tag-resource --resource-arn <value> --tags <value>
aws cloudwatch untag-resource --resource-arn <value> --tag-keys <value>
```
**Potencjalny wpÅ‚yw**: ZakÅ‚Ã³cenie polityk kontroli dostÄ™pu opartych na tagach.

## OdnoÅ›niki

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazoncloudwatch.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazoncloudwatch.html)
* [https://docs.aws.amazon.com/es_es/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html#Metric](https://docs.aws.amazon.com/es_es/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html#Metric)

<details>

<summary><strong>Zacznij od zera i zostaÅ„ ekspertem AWS z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
