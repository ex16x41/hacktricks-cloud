# AWS - CloudWatch Enum

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## CloudWatch

**CloudWatch** **sammelt** √úberwachungs- und Betriebs-**daten** in Form von Protokollen/Metriken/Ereignissen und bietet eine **einheitliche Ansicht der AWS-Ressourcen**, Anwendungen und Dienste.\
CloudWatch Log-Ereignisse haben eine **Gr√∂√üenbeschr√§nkung von 256 KB pro Protokollzeile**.\
Es kann **Hochaufl√∂sungsalarme** einstellen, **Protokolle** und **Metriken** nebeneinander visualisieren, automatisierte Aktionen durchf√ºhren, Probleme beheben und Erkenntnisse gewinnen, um Anwendungen zu optimieren.

Sie k√∂nnen beispielsweise Protokolle von CloudTrail √ºberwachen. √úberwachte Ereignisse:

* √Ñnderungen an Sicherheitsgruppen und NACLs
* Starten, Stoppen, Neustarten und Beenden von EC2-Instanzen
* √Ñnderungen an Sicherheitsrichtlinien innerhalb von IAM und S3
* Fehlgeschlagene Anmeldeversuche bei der AWS Management Console
* API-Aufrufe, die zu fehlgeschlagener Autorisierung f√ºhrten
* Filter zur Suche in CloudWatch: [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

## Schl√ºsselkonzepte

### Namespaces

Ein Namespace ist ein Container f√ºr CloudWatch-Metriken. Er hilft, Metriken zu kategorisieren und zu isolieren, was die Verwaltung und Analyse erleichtert.

* **Beispiele**: AWS/EC2 f√ºr EC2-bezogene Metriken, AWS/RDS f√ºr RDS-Metriken.

### Metriken

Metriken sind Datenpunkte, die √ºber die Zeit gesammelt werden und die Leistung oder Nutzung von AWS-Ressourcen darstellen. Metriken k√∂nnen von AWS-Diensten, benutzerdefinierten Anwendungen oder Drittanbieter-Integrationen gesammelt werden.

* **Beispiel**: CPUUtilization, NetworkIn, DiskReadOps.

### Dimensionen

Dimensionen sind Schl√ºssel-Wert-Paare, die Teil von Metriken sind. Sie helfen, eine Metrik eindeutig zu identifizieren und bieten zus√§tzlichen Kontext, wobei 30 die maximale Anzahl von Dimensionen ist, die mit einer Metrik verkn√ºpft werden k√∂nnen. Dimensionen erm√∂glichen auch das Filtern und Aggregieren von Metriken basierend auf bestimmten Attributen.

* **Beispiel**: F√ºr EC2-Instanzen k√∂nnten Dimensionen InstanceId, InstanceType und AvailabilityZone umfassen.

### Statistiken

Statistiken sind mathematische Berechnungen, die auf Metrikdaten durchgef√ºhrt werden, um sie √ºber die Zeit zusammenzufassen. Zu den g√§ngigen Statistiken geh√∂ren Durchschnitt, Summe, Minimum, Maximum und SampleCount.

* **Beispiel**: Berechnung der durchschnittlichen CPU-Auslastung √ºber einen Zeitraum von einer Stunde.

### Einheiten

Einheiten sind der Messungstyp, der mit einer Metrik verbunden ist. Einheiten helfen, Kontext und Bedeutung zu den Metrikdaten zu liefern. G√§ngige Einheiten sind Prozent, Bytes, Sekunden, Anzahl.

* **Beispiel**: CPUUtilization k√∂nnte in Prozent gemessen werden, w√§hrend NetworkIn in Bytes gemessen werden k√∂nnte.

## CloudWatch-Funktionen

### Dashboard

**CloudWatch Dashboards** bieten anpassbare **Ansichten Ihrer AWS CloudWatch-Metriken**. Es ist m√∂glich, Dashboards zu erstellen und zu konfigurieren, um Daten zu visualisieren und Ressourcen in einer einzigen Ansicht zu √ºberwachen, indem verschiedene Metriken aus verschiedenen AWS-Diensten kombiniert werden.

**Hauptmerkmale**:

* **Widgets**: Bausteine von Dashboards, einschlie√ülich Grafiken, Text, Alarme und mehr.
* **Anpassung**: Layout und Inhalt k√∂nnen an spezifische √úberwachungsbed√ºrfnisse angepasst werden.

**Beispielanwendung**:

* Ein einzelnes Dashboard, das wichtige Metriken f√ºr Ihre gesamte AWS-Umgebung anzeigt, einschlie√ülich EC2-Instanzen, RDS-Datenbanken und S3-Buckets.

### Metrikstream und Metrikdaten

**Metrikstreams** in AWS CloudWatch erm√∂glichen es Ihnen, CloudWatch-Metriken kontinuierlich in nahezu Echtzeit an ein Ziel Ihrer Wahl zu streamen. Dies ist besonders n√ºtzlich f√ºr fortgeschrittene √úberwachung, Analysen und benutzerdefinierte Dashboards mit Tools au√üerhalb von AWS.

**Metrikdaten** innerhalb von Metrikstreams beziehen sich auf die tats√§chlichen Messungen oder Datenpunkte, die gestreamt werden. Diese Datenpunkte repr√§sentieren verschiedene Metriken wie CPU-Auslastung, Speichernutzung usw. f√ºr AWS-Ressourcen.

**Beispielanwendung**:

* Echtzeitmetriken an einen Drittanbieter-√úberwachungsdienst f√ºr fortgeschrittene Analysen senden.
* Metriken in einem Amazon S3-Bucket f√ºr die langfristige Speicherung und Compliance archivieren.

### Alarm

**CloudWatch-Alarme** √ºberwachen Ihre Metriken und f√ºhren Aktionen basierend auf vordefinierten Schwellenwerten aus. Wenn eine Metrik einen Schwellenwert √ºberschreitet, kann der Alarm eine oder mehrere Aktionen ausf√ºhren, wie z. B. Benachrichtigungen √ºber SNS senden, eine Auto-Scaling-Richtlinie ausl√∂sen oder eine AWS Lambda-Funktion ausf√ºhren.

**Hauptkomponenten**:

* **Schwellenwert**: Der Wert, bei dem der Alarm ausgel√∂st wird.
* **Bewertungszeitr√§ume**: Die Anzahl der Zeitr√§ume, √ºber die Daten bewertet werden.
* **Datapoints to Alarm**: Die Anzahl der Zeitr√§ume mit einem erreichten Schwellenwert, die erforderlich sind, um den Alarm auszul√∂sen.
* **Aktionen**: Was passiert, wenn ein Alarmzustand ausgel√∂st wird (z. B. Benachrichtigung √ºber SNS).

**Beispielanwendung**:

* √úberwachung der CPU-Auslastung einer EC2-Instanz und Senden einer Benachrichtigung √ºber SNS, wenn sie 80 % f√ºr 5 aufeinanderfolgende Minuten √ºberschreitet.

### Anomalie-Detektoren

**Anomalie-Detektoren** verwenden maschinelles Lernen, um automatisch Anomalien in Ihren Metriken zu erkennen. Sie k√∂nnen die Anomalieerkennung auf jede CloudWatch-Metrik anwenden, um Abweichungen von normalen Mustern zu identifizieren, die auf Probleme hinweisen k√∂nnten.

**Hauptkomponenten**:

* **Modelltraining**: CloudWatch verwendet historische Daten, um ein Modell zu trainieren und festzustellen, wie normales Verhalten aussieht.
* **Anomalieerkennungsband**: Eine visuelle Darstellung des erwarteten Wertebereichs f√ºr eine Metrik.

**Beispielanwendung**:

* Erkennung ungew√∂hnlicher CPU-Auslastungsmuster in einer EC2-Instanz, die auf einen Sicherheitsvorfall oder ein Anwendungsproblem hinweisen k√∂nnten.

### Insight-Regeln und verwaltete Insight-Regeln

**Insight-Regeln** erm√∂glichen es Ihnen, Trends zu identifizieren, Spitzen zu erkennen oder andere Muster von Interesse in Ihren Metrikdaten mithilfe von **leistungsstarken mathematischen Ausdr√ºcken** zu definieren, unter welchen Bedingungen Aktionen ergriffen werden sollten. Diese Regeln k√∂nnen Ihnen helfen, Anomalien oder ungew√∂hnliches Verhalten in der Leistung und Nutzung Ihrer Ressourcen zu identifizieren.

**Verwaltete Insight-Regeln** sind vorkonfigurierte **Insight-Regeln, die von AWS bereitgestellt werden**. Sie sind darauf ausgelegt, spezifische AWS-Dienste oder g√§ngige Anwendungsf√§lle zu √ºberwachen und k√∂nnen ohne detaillierte Konfiguration aktiviert werden.

**Beispielanwendung**:

* √úberwachung der RDS-Leistung: Aktivieren Sie eine verwaltete Insight-Regel f√ºr Amazon RDS, die wichtige Leistungsindikatoren wie CPU-Auslastung, Speichernutzung und Festplatten-I/O √ºberwacht. Wenn eine dieser Metriken sichere Betriebsgrenzen √ºberschreitet, kann die Regel einen Alarm oder eine automatisierte Minderung ausl√∂sen.

### CloudWatch-Protokolle <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

Erm√∂glicht das **Aggregieren und √úberwachen von Protokollen aus Anwendungen** und Systemen von **AWS-Diensten** (einschlie√ülich CloudTrail) und **von Apps/Systemen** (**CloudWatch-Agent** kann auf einem Host installiert werden). Protokolle k√∂nnen **unbegrenzt gespeichert** werden (abh√§ngig von den Einstellungen der Protokollgruppe) und k√∂nnen exportiert werden.

**Elemente**:

| **Protokollgruppe**      | Eine **Sammlung von Protokollstreams**, die dieselben Aufbewahrungs-, √úberwachungs- und Zugriffskontrolleinstellungen teilen                                   |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Protokollstream**      | Eine Sequenz von **Protokolldaten**, die die **gleiche Quelle** teilen                                                                                   |
| **Abonnementfilter**     | Definieren ein **Filtermuster, das Ereignisse** in einer bestimmten Protokollgruppe √ºbereinstimmt, senden sie an Kinesis Data Firehose-Stream, Kinesis-Stream oder eine Lambda-Funktion |

### CloudWatch-√úberwachung & Ereignisse

CloudWatch **grundlegend** aggregiert Daten **alle 5 Minuten** (die **detaillierte** macht das **jede Minute**). Nach der Aggregation **√ºberpr√ºft es die Schwellenwerte der Alarme**, falls es einen ausl√∂sen muss.\
In diesem Fall kann CloudWatch bereit sein, ein Ereignis zu senden und einige automatische Aktionen durchzuf√ºhren (AWS-Lambda-Funktionen, SNS-Themen, SQS-Warteschlangen, Kinesis-Streams).

### Agenteninstallation

Sie k√∂nnen Agenten in Ihren Maschinen/Containern installieren, um automatisch die Protokolle an CloudWatch zur√ºckzusenden.

* **Erstellen** Sie eine **Rolle** und **h√§ngen** Sie sie an die **Instanz** mit Berechtigungen, die es CloudWatch erm√∂glichen, Daten von den Instanzen zu sammeln, zus√§tzlich zur Interaktion mit dem AWS Systems Manager SSM (CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM).
* **Laden** Sie den **Agenten** herunter und **installieren** Sie ihn auf der EC2-Instanz ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). Sie k√∂nnen ihn von innerhalb der EC2 herunterladen oder automatisch mit AWS Systems Manager installieren, indem Sie das Paket AWS-ConfigureAWSPackage ausw√§hlen.
* **Konfigurieren** und **starten** Sie den CloudWatch-Agenten.

Eine Protokollgruppe hat viele Streams. Ein Stream hat viele Ereignisse. Und innerhalb jedes Streams sind die Ereignisse in der Reihenfolge garantiert.

## Enumeration
```bash
# Dashboards #

## Returns a list of the dashboards of your account
aws cloudwatch list-dashboards

## Retrieves the details of the specified dashboard
aws cloudwatch get-dashboard --dashboard-name <value>

# Metrics #

## Returns a list of the specified metric
aws cloudwatch list-metrics [--namespace <value>] [--metric-name <value>] [--dimensions <value>] [--include-linked-accounts | --no-include-linked-accounts]

## Retrieves metric data (this operation can include a CloudWatch Metrics Insights query, and one or more metric math functions)
aws cloudwatch get-metric-data --metric-data-queries <value> --start-time <value> --end-time <value>

## Retrieves statistics for the specified metric and namespace over a range of time
aws cloudwatch get-metric-statistics --namespace <value> --metric-name <value> [--dimensions <value>] --start-time <value> --end-time <value> --period <value>

## Returns a list of the metric streams of your account
aws cloudwatch list-metric-streams

## Retrieves information about the specified metric stream
aws cloudwatch get-metric-stream --name <value>

## Retrieve snapshots of the specified metric widgets
aws cloudwatch get-metric-widget-image --metric-widget <value>

# Alarms #

## Retrieves the specified alarm
aws cloudwatch describe-alarms [--alarm-names <value>] [--alarm-name-prefix <value>] [--alarm-types <value>] [--state-value <value>]

## Retrieves the alarms history, even for deleted alarms
aws cloudwatch describe-alarm-history [--alarm-name <value>] [--alarm-types <value>] [--history-item-type <ConfigurationUpdate | StateUpdate | Action>] [--start-date <value>] [--end-date <value>]

## Retrieves standard alarms based on the specified metric
aws cloudwatch escribe-alarms-for-metric --metric-name <value> --namespace <value> [--dimensions <value>]

# Anomaly Detections #

## Lists the anomaly detection models that you have created in your account
aws cloudwatch describe-anomaly-detectors [--namespace <value>] [--metric-name <value>] [--dimensions <value>]

## Lists all the Contributor Insight rules in your account
aws cloudwatch describe-insight-rules

## Retrieves the data collected over a time range for a given Contributor Insight rule
aws cloudwatch get-insight-rule-report --rule-name <value> --start-time <value> --end-time <value> --period <value>

## Lists managed Contributor Insights rules in your account for a specified resource
aws cloudwatch list-managed-insight-rules --resource-arn <value>

# Tags #

## Lists the tags associated with the specified CloudWatch resources
aws cloudwatch list-tags-for-resource --resource-arn <value>

# CloudWatch Logs #
aws logs tail "<log_group_name>" --followaws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# CloudWatch Events #
aws events list-rules
aws events describe-rule --name <name>aws events list-targets-by-rule --rule <name>aws events list-archives
aws events describe-archive --archive-name <name>aws events list-connections
aws events describe-connection --name <name>aws events list-endpoints
aws events describe-endpoint --name <name>aws events list-event-sources
aws events describe-event-source --name <name>aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## Post-Exploitation / Bypass

### **`cloudwatch:DeleteAlarms`,`cloudwatch:PutMetricAlarm` , `cloudwatch:PutCompositeAlarm`**

Ein Angreifer mit diesen Berechtigungen k√∂nnte die √úberwachungs- und Alarmierungsinfrastruktur einer Organisation erheblich untergraben. Durch das L√∂schen vorhandener Alarme k√∂nnte ein Angreifer entscheidende Benachrichtigungen deaktivieren, die Administratoren √ºber kritische Leistungsprobleme, Sicherheitsverletzungen oder betriebliche Ausf√§lle informieren. Dar√ºber hinaus k√∂nnte der Angreifer durch das Erstellen oder √Ñndern von Metrik-Alarmen auch Administratoren mit falschen Alarmen in die Irre f√ºhren oder legitime Alarme zum Schweigen bringen, wodurch b√∂swillige Aktivit√§ten effektiv maskiert und rechtzeitige Reaktionen auf tats√§chliche Vorf√§lle verhindert werden.

Dar√ºber hinaus k√∂nnte ein Angreifer mit der Berechtigung **`cloudwatch:PutCompositeAlarm`** eine Schleife oder einen Zyklus von zusammengesetzten Alarmen erstellen, bei dem zusammengesetzter Alarm A von zusammengesetztem Alarm B abh√§ngt und zusammengesetzter Alarm B auch von zusammengesetztem Alarm A abh√§ngt. In diesem Szenario ist es nicht m√∂glich, einen zusammengesetzten Alarm, der Teil des Zyklus ist, zu l√∂schen, da immer noch ein zusammengesetzter Alarm existiert, der von dem Alarm abh√§ngt, den Sie l√∂schen m√∂chten.
```bash
aws cloudwatch put-metric-alarm --cli-input-json <value> | --alarm-name <value> --comparison-operator <value> --evaluation-periods <value> [--datapoints-to-alarm <value>] [--threshold <value>] [--alarm-description <value>] [--alarm-actions <value>] [--metric-name <value>] [--namespace <value>] [--statistic <value>] [--dimensions <value>] [--period <value>]
aws cloudwatch delete-alarms --alarm-names <value>
aws cloudwatch put-composite-alarm --alarm-name <value> --alarm-rule <value> [--no-actions-enabled | --actions-enabled [--alarm-actions <value>] [--insufficient-data-actions <value>] [--ok-actions <value>] ]
```
Das folgende Beispiel zeigt, wie man einen Metrikalarm unwirksam macht:

* Dieser Metrikalarm √ºberwacht die durchschnittliche CPU-Auslastung einer bestimmten EC2-Instanz, bewertet die Metrik alle 300 Sekunden und erfordert 6 Bewertungsperioden (insgesamt 30 Minuten). Wenn die durchschnittliche CPU-Auslastung in mindestens 4 dieser Perioden 60 % √ºberschreitet, wird der Alarm ausgel√∂st und sendet eine Benachrichtigung an das angegebene SNS-Thema.
* Durch die √Ñnderung des Schwellenwerts auf mehr als 99 %, das Setzen der Periode auf 10 Sekunden, der Bewertungsperioden auf 8640 (da 8640 Perioden von 10 Sekunden 1 Tag entsprechen) und der Datapoints to Alarm auf ebenfalls 8640, w√§re es erforderlich, dass die CPU-Auslastung in den gesamten 24 Stunden alle 10 Sekunden √ºber 99 % liegt, um einen Alarm auszul√∂sen.

{% tabs %}
{% tab title="Original Metric Alarm" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-01234567890123456"
}
],
"AlarmActions": [
"arn:aws:sns:us-east-1:123456789012:example_sns"
],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 4,
"EvaluationPeriods": 6,
"Period": 300,
"Statistic": "Average",
"Threshold": 60,
"AlarmDescription": "CPU Utilization of i-01234567890123456 over 60%",
"AlarmName": "EC2 instance i-01234567890123456 CPU Utilization"
}
```
{% endtab %}

{% tab title="Modifizierte Metrik-Alarme" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0645d6d414dadf9f8"
}
],
"AlarmActions": [],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 8640,
"EvaluationPeriods": 8640,
"Period": 10,
"Statistic": "Average",
"Threshold": 99,
"AlarmDescription": "CPU Utilization of i-01234567890123456 with 60% as threshold",
"AlarmName": "Instance i-0645d6d414dadf9f8 CPU Utilization"
}

```
{% endtab %}
{% endtabs %}

**Potenzielle Auswirkungen**: Fehlende Benachrichtigungen f√ºr kritische Ereignisse, potenzielle unentdeckte Probleme, falsche Alarme, Unterdr√ºckung echter Alarme und m√∂glicherweise verpasste Erkennungen realer Vorf√§lle.

### **`cloudwatch:DeleteAlarmActions`, `cloudwatch:EnableAlarmActions`, `cloudwatch:SetAlarmState`**

Durch das L√∂schen von Alarmaktionen k√∂nnte der Angreifer kritische Warnungen und automatisierte Reaktionen daran hindern, ausgel√∂st zu werden, wenn ein Alarmzustand erreicht wird, wie z. B. die Benachrichtigung von Administratoren oder das Ausl√∂sen von Auto-Scaling-Aktivit√§ten. Das unangemessene Aktivieren oder Wiederaktivieren von Alarmaktionen k√∂nnte ebenfalls zu unerwartetem Verhalten f√ºhren, entweder durch die Reaktivierung zuvor deaktivierter Aktionen oder durch die √Ñnderung, welche Aktionen ausgel√∂st werden, was potenziell zu Verwirrung und Fehlleitungen bei der Vorfallreaktion f√ºhren k√∂nnte.

Dar√ºber hinaus k√∂nnte ein Angreifer mit der Berechtigung Alarmzust√§nde manipulieren, indem er falsche Alarme erstellt, um Administratoren abzulenken und zu verwirren, oder echte Alarme zum Schweigen bringt, um laufende b√∂swillige Aktivit√§ten oder kritische Systemausf√§lle zu verbergen.

* Wenn Sie **`SetAlarmState`** bei einem zusammengesetzten Alarm verwenden, ist nicht garantiert, dass der zusammengesetzte Alarm in seinen tats√§chlichen Zustand zur√ºckkehrt. Er kehrt nur dann in seinen tats√§chlichen Zustand zur√ºck, wenn einer seiner untergeordneten Alarme den Zustand √§ndert. Er wird auch neu bewertet, wenn Sie seine Konfiguration aktualisieren.
```bash
aws cloudwatch disable-alarm-actions --alarm-names <value>
aws cloudwatch enable-alarm-actions --alarm-names <value>
aws cloudwatch set-alarm-state --alarm-name <value> --state-value <OK | ALARM | INSUFFICIENT_DATA> --state-reason <value> [--state-reason-data <value>]
```
**Potenzielle Auswirkungen**: Fehlende Benachrichtigungen f√ºr kritische Ereignisse, potenzielle unentdeckte Probleme, falsche Alarme, Unterdr√ºckung echter Alarme und m√∂glicherweise verpasste Erkennungen echter Vorf√§lle.

### **`cloudwatch:DeleteAnomalyDetector`, `cloudwatch:PutAnomalyDetector`**

Ein Angreifer k√∂nnte die F√§higkeit zur Erkennung und Reaktion auf ungew√∂hnliche Muster oder Anomalien in den Metrikdaten gef√§hrden. Durch das L√∂schen vorhandener Anomalie-Detektoren k√∂nnte ein Angreifer kritische Alarmmechanismen deaktivieren; und durch das Erstellen oder √Ñndern dieser k√∂nnte er entweder Fehlkonfigurationen vornehmen oder falsche Positivmeldungen erzeugen, um die √úberwachung abzulenken oder zu √ºberw√§ltigen.
```bash
aws cloudwatch delete-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value>]
aws cloudwatch put-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value> --configuration <value> --metric-characteristics <value>]
```
Das folgende Beispiel zeigt, wie man einen Metrik-Anomalie-Detektor unwirksam macht. Dieser Metrik-Anomalie-Detektor √ºberwacht die durchschnittliche CPU-Auslastung einer bestimmten EC2-Instanz, und allein durch das Hinzuf√ºgen des Parameters ‚ÄûExcludedTimeRanges‚Äú mit dem gew√ºnschten Zeitbereich w√§re es ausreichend, um sicherzustellen, dass der Anomalie-Detektor w√§hrend dieses Zeitraums keine relevanten Daten analysiert oder warnt.

{% tabs %}
{% tab title="Original Metric Anomaly Detector" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
}
}
```
{% endtab %}

{% tab title="Modifizierter Metrik-Anomalie-Detektor" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
},
"Configuration": {
"ExcludedTimeRanges": [
{
"StartTime": "2023-01-01T00:00:00Z",
"EndTime": "2053-01-01T23:59:59Z"
}
],
"Timezone": "Europe/Madrid"
}
}
```
{% endtab %}
{% endtabs %}

**Potenzielle Auswirkungen**: Direkte Auswirkungen auf die Erkennung ungew√∂hnlicher Muster oder Sicherheitsbedrohungen.

### **`cloudwatch:DeleteDashboards`, `cloudwatch:PutDashboard`**

Ein Angreifer k√∂nnte die √úberwachungs- und Visualisierungsf√§higkeiten einer Organisation gef√§hrden, indem er deren Dashboards erstellt, √§ndert oder l√∂scht. Diese Berechtigungen k√∂nnten genutzt werden, um die kritische Sichtbarkeit auf die Leistung und Gesundheit von Systemen zu entfernen, Dashboards so zu √§ndern, dass falsche Daten angezeigt werden, oder b√∂swillige Aktivit√§ten zu verbergen.
```bash
aws cloudwatch delete-dashboards --dashboard-names <value>
aws cloudwatch put-dashboard --dashboard-name <value> --dashboard-body <value>
```
**Potenzielle Auswirkungen**: Verlust der √úberwachungsansicht und irref√ºhrende Informationen.

### **`cloudwatch:DeleteInsightRules`, `cloudwatch:PutInsightRule`, `cloudwatch:PutManagedInsightRule`**

Insight-Regeln werden verwendet, um Anomalien zu erkennen, die Leistung zu optimieren und Ressourcen effektiv zu verwalten. Durch das L√∂schen vorhandener Insight-Regeln k√∂nnte ein Angreifer kritische √úberwachungsf√§higkeiten entfernen, wodurch das System blind f√ºr Leistungsprobleme und Sicherheitsbedrohungen bleibt. Dar√ºber hinaus k√∂nnte ein Angreifer Insight-Regeln erstellen oder √§ndern, um irref√ºhrende Daten zu generieren oder b√∂swillige Aktivit√§ten zu verbergen, was zu falschen Diagnosen und unangemessenen Reaktionen des Betriebsteams f√ºhren w√ºrde.
```bash
aws cloudwatch delete-insight-rules --rule-names <value>
aws cloudwatch put-insight-rule --rule-name <value> --rule-definition <value> [--rule-state <value>]
aws cloudwatch put-managed-insight-rules --managed-rules <value>
```
**Potenzielle Auswirkungen**: Schwierigkeiten bei der Erkennung und Reaktion auf Leistungsprobleme und Anomalien, fehlerhafte Entscheidungsfindung und m√∂glicherweise das Verbergen b√∂sartiger Aktivit√§ten oder Systemausf√§lle.

### **`cloudwatch:DisableInsightRules`, `cloudwatch:EnableInsightRules`**

Durch das Deaktivieren kritischer Einsichtsregeln k√∂nnte ein Angreifer die Organisation effektiv blind f√ºr wichtige Leistungs- und Sicherheitsmetriken machen. Umgekehrt k√∂nnte es durch das Aktivieren oder Konfigurieren irref√ºhrender Regeln m√∂glich sein, falsche Daten zu erzeugen, L√§rm zu erzeugen oder b√∂sartige Aktivit√§ten zu verbergen.
```bash
aws cloudwatch disable-insight-rules --rule-names <value>
aws cloudwatch enable-insight-rules --rule-names <value>
```
**Potenzielle Auswirkungen**: Verwirrung im Operationsteam, was zu verz√∂gerten Reaktionen auf tats√§chliche Probleme und unn√∂tigen Ma√ünahmen aufgrund falscher Alarme f√ºhrt.

### **`cloudwatch:DeleteMetricStream` , `cloudwatch:PutMetricStream` , `cloudwatch:PutMetricData`**

Ein Angreifer mit den Berechtigungen **`cloudwatch:DeleteMetricStream`** , **`cloudwatch:PutMetricStream`** w√§re in der Lage, Metrikdatenstr√∂me zu erstellen und zu l√∂schen, was die Sicherheit, √úberwachung und Datenintegrit√§t gef√§hrdet:

* **B√∂sartige Streams erstellen**: Metrikstr√∂me erstellen, um sensible Daten an unbefugte Ziele zu senden.
* **Ressourcenmanipulation**: Die Erstellung neuer Metrikstr√∂me mit √ºberm√§√üigen Daten k√∂nnte viel L√§rm erzeugen, was zu falschen Alarmen f√ºhrt und wahre Probleme maskiert.
* **√úberwachungsst√∂rung**: Durch das L√∂schen von Metrikstr√∂men w√ºrden Angreifer den kontinuierlichen Fluss von √úberwachungsdaten st√∂ren. Auf diese Weise w√§ren ihre b√∂sartigen Aktivit√§ten effektiv verborgen.

√Ñhnlich w√§re es mit der Berechtigung **`cloudwatch:PutMetricData`** m√∂glich, Daten zu einem Metrikstrom hinzuzuf√ºgen. Dies k√∂nnte zu einem DoS f√ºhren, aufgrund der Menge an unzul√§ssigen Daten, die hinzugef√ºgt werden, wodurch es v√∂llig nutzlos wird.
```bash
aws cloudwatch delete-metric-stream --name <value>
aws cloudwatch put-metric-stream --name <value> [--include-filters <value>] [--exclude-filters <value>] --firehose-arn <value> --role-arn <value> --output-format <value>
aws cloudwatch put-metric-data --namespace <value> [--metric-data <value>] [--metric-name <value>] [--timestamp <value>] [--unit <value>] [--value <value>] [--dimensions <value>]
```
Beispiel f√ºr das Hinzuf√ºgen von Daten, die 70 % der CPU-Auslastung √ºber eine gegebene EC2-Instanz entsprechen:
```bash
aws cloudwatch put-metric-data --namespace "AWS/EC2" --metric-name "CPUUtilization" --value 70 --unit "Percent" --dimensions "InstanceId=i-0123456789abcdefg"
```
**Potenzielle Auswirkungen**: St√∂rung des Flusses von √úberwachungsdaten, die die Erkennung von Anomalien und Vorf√§llen beeintr√§chtigt, Ressourcennutzung manipuliert und Kosten erh√∂ht, aufgrund der Erstellung √ºberm√§√üiger Metrikstr√∂me.

### **`cloudwatch:StopMetricStreams`, `cloudwatch:StartMetricStreams`**

Ein Angreifer w√ºrde den Fluss der betroffenen Metrikdatenstr√∂me kontrollieren (jeder Datenstrom, wenn es keine Ressourcenbeschr√§nkung gibt). Mit der Berechtigung **`cloudwatch:StopMetricStreams`** k√∂nnten Angreifer ihre b√∂sartigen Aktivit√§ten verbergen, indem sie kritische Metrikstr√∂me stoppen.
```bash
aws cloudwatch stop-metric-streams --names <value>
aws cloudwatch start-metric-streams --names <value>
```
**Potenzielle Auswirkungen**: St√∂rung des Flusses von √úberwachungsdaten, die die Erkennung von Anomalien und Vorf√§llen beeintr√§chtigt.

### **`cloudwatch:TagResource`, `cloudwatch:UntagResource`**

Ein Angreifer k√∂nnte in der Lage sein, Tags von CloudWatch-Ressourcen (derzeit nur Alarme und Contributor Insights-Regeln) hinzuzuf√ºgen, zu √§ndern oder zu entfernen. Dies k√∂nnte die Zugriffssteuerungsrichtlinien Ihrer Organisation, die auf Tags basieren, st√∂ren.
```bash
aws cloudwatch tag-resource --resource-arn <value> --tags <value>
aws cloudwatch untag-resource --resource-arn <value> --tag-keys <value>
```
**Potenzielle Auswirkungen**: St√∂rung der tag-basierten Zugriffskontrollrichtlinien.

## Referenzen

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_amazoncloudwatch.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_amazoncloudwatch.html)
* [https://docs.aws.amazon.com/es\_es/AmazonCloudWatch/latest/monitoring/cloudwatch\_concepts.html#Metric](https://docs.aws.amazon.com/es\_es/AmazonCloudWatch/latest/monitoring/cloudwatch\_concepts.html#Metric)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
