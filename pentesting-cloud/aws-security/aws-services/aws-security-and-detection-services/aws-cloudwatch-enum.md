# AWS - CloudWatch Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## CloudWatch

**CloudWatch** **zbiera** dane monitorujÄ…ce i operacyjne **w formie logÃ³w/metryk/wydarzeÅ„**, zapewniajÄ…c **jednolity widok zasobÃ³w AWS**, aplikacji i usÅ‚ug.\
CloudWatch Log Event ma **ograniczenie rozmiaru 256KB na kaÅ¼dÄ… liniÄ™ logu**.\
MoÅ¼e ustawiaÄ‡ **alarmy o wysokiej rozdzielczoÅ›ci**, wizualizowaÄ‡ **logi** i **metryki** obok siebie, podejmowaÄ‡ automatyczne dziaÅ‚ania, rozwiÄ…zywaÄ‡ problemy i odkrywaÄ‡ spostrzeÅ¼enia w celu optymalizacji aplikacji.

MoÅ¼esz monitorowaÄ‡ na przykÅ‚ad logi z CloudTrail. Monitorowane wydarzenia:

* Zmiany w grupach zabezpieczeÅ„ i NACL
* Uruchamianie, zatrzymywanie, ponowne uruchamianie i koÅ„czenie instancji EC2
* Zmiany w politykach zabezpieczeÅ„ w IAM i S3
* Nieudane prÃ³by logowania do konsoli zarzÄ…dzania AWS
* WywoÅ‚ania API, ktÃ³re zakoÅ„czyÅ‚y siÄ™ nieudanym autoryzowaniem
* Filtry do wyszukiwania w cloudwatch: [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

## Kluczowe pojÄ™cia

### Przestrzenie nazw

PrzestrzeÅ„ nazw to kontener dla metryk CloudWatch. Pomaga w kategoryzacji i izolacji metryk, co uÅ‚atwia ich zarzÄ…dzanie i analizÄ™.

* **PrzykÅ‚ady**: AWS/EC2 dla metryk zwiÄ…zanych z EC2, AWS/RDS dla metryk RDS.

### Metryki

Metryki to punkty danych zbierane w czasie, ktÃ³re reprezentujÄ… wydajnoÅ›Ä‡ lub wykorzystanie zasobÃ³w AWS. Metryki mogÄ… byÄ‡ zbierane z usÅ‚ug AWS, aplikacji niestandardowych lub integracji zewnÄ™trznych.

* **PrzykÅ‚ad**: CPUUtilization, NetworkIn, DiskReadOps.

### Wymiary

Wymiary to pary klucz-wartoÅ›Ä‡, ktÃ³re sÄ… czÄ™Å›ciÄ… metryk. PomagajÄ… unikalnie zidentyfikowaÄ‡ metrykÄ™ i dostarczajÄ… dodatkowego kontekstu, przy czym maksymalna liczba wymiarÃ³w, ktÃ³re moÅ¼na powiÄ…zaÄ‡ z metrykÄ…, wynosi 30. Wymiary umoÅ¼liwiajÄ… rÃ³wnieÅ¼ filtrowanie i agregowanie metryk na podstawie okreÅ›lonych atrybutÃ³w.

* **PrzykÅ‚ad**: Dla instancji EC2 wymiary mogÄ… obejmowaÄ‡ InstanceId, InstanceType i AvailabilityZone.

### Statystyki

Statystyki to obliczenia matematyczne wykonywane na danych metrycznych w celu ich podsumowania w czasie. Powszechne statystyki to Åšrednia, Suma, Minimum, Maksimum i LiczbaPrÃ³bek.

* **PrzykÅ‚ad**: Obliczanie Å›redniego wykorzystania CPU w okresie jednej godziny.

### Jednostki

Jednostki to typ pomiaru zwiÄ…zany z metrykÄ…. Jednostki pomagajÄ… dostarczyÄ‡ kontekst i znaczenie dla danych metrycznych. Powszechne jednostki to Procent, Bajty, Sekundy, Liczba.

* **PrzykÅ‚ad**: CPUUtilization moÅ¼e byÄ‡ mierzony w Procentach, podczas gdy NetworkIn moÅ¼e byÄ‡ mierzony w Bajtach.

## Funkcje CloudWatch

### Dashboard

**CloudWatch Dashboards** zapewniajÄ… dostosowywane **widoki metryk AWS CloudWatch**. MoÅ¼liwe jest tworzenie i konfigurowanie dashboardÃ³w w celu wizualizacji danych i monitorowania zasobÃ³w w jednym widoku, Å‚Ä…czÄ…c rÃ³Å¼ne metryki z rÃ³Å¼nych usÅ‚ug AWS.

**Kluczowe funkcje**:

* **Widgety**: Elementy budujÄ…ce dashboardy, w tym wykresy, tekst, alarmy i inne.
* **Dostosowanie**: UkÅ‚ad i zawartoÅ›Ä‡ mogÄ… byÄ‡ dostosowane do konkretnych potrzeb monitorowania.

**PrzykÅ‚ad zastosowania**:

* Jeden dashboard pokazujÄ…cy kluczowe metryki dla caÅ‚ego Å›rodowiska AWS, w tym instancji EC2, baz danych RDS i kubeÅ‚kÃ³w S3.

### StrumieÅ„ metryk i dane metryczne

**Strumienie metryk** w AWS CloudWatch umoÅ¼liwiajÄ… ciÄ…gÅ‚e przesyÅ‚anie metryk CloudWatch do wybranego miejsca docelowego w niemal rzeczywistym czasie. Jest to szczegÃ³lnie przydatne do zaawansowanego monitorowania, analityki i niestandardowych dashboardÃ³w przy uÅ¼yciu narzÄ™dzi spoza AWS.

**Dane metryczne** w strumieniach metryk odnoszÄ… siÄ™ do rzeczywistych pomiarÃ³w lub punktÃ³w danych, ktÃ³re sÄ… przesyÅ‚ane. Te punkty danych reprezentujÄ… rÃ³Å¼ne metryki, takie jak wykorzystanie CPU, uÅ¼ycie pamiÄ™ci itp., dla zasobÃ³w AWS.

**PrzykÅ‚ad zastosowania**:

* WysyÅ‚anie metryk w czasie rzeczywistym do zewnÄ™trznej usÅ‚ugi monitorujÄ…cej w celu zaawansowanej analizy.
* Archiwizowanie metryk w kubeÅ‚ku Amazon S3 do dÅ‚ugoterminowego przechowywania i zgodnoÅ›ci.

### Alarm

**Alarmy CloudWatch** monitorujÄ… twoje metryki i wykonujÄ… dziaÅ‚ania na podstawie zdefiniowanych progÃ³w. Gdy metryka przekroczy prÃ³g, alarm moÅ¼e wykonaÄ‡ jedno lub wiÄ™cej dziaÅ‚aÅ„, takich jak wysyÅ‚anie powiadomieÅ„ za poÅ›rednictwem SNS, uruchamianie polityki automatycznego skalowania lub uruchamianie funkcji AWS Lambda.

**Kluczowe komponenty**:

* **PrÃ³g**: WartoÅ›Ä‡, przy ktÃ³rej alarm siÄ™ uruchamia.
* **Okresy oceny**: Liczba okresÃ³w, w ktÃ³rych dane sÄ… oceniane.
* **Punkty danych do alarmu**: Liczba okresÃ³w z osiÄ…gniÄ™tym progiem potrzebna do uruchomienia alarmu.
* **DziaÅ‚ania**: Co siÄ™ dzieje, gdy stan alarmu jest uruchamiany (np. powiadomienie za poÅ›rednictwem SNS).

**PrzykÅ‚ad zastosowania**:

* Monitorowanie wykorzystania CPU instancji EC2 i wysyÅ‚anie powiadomienia za poÅ›rednictwem SNS, jeÅ›li przekroczy 80% przez 5 kolejnych minut.

### Wykrywacze anomalii

**Wykrywacze anomalii** wykorzystujÄ… uczenie maszynowe do automatycznego wykrywania anomalii w twoich metrykach. MoÅ¼esz zastosowaÄ‡ wykrywanie anomalii do dowolnej metryki CloudWatch, aby zidentyfikowaÄ‡ odchylenia od normalnych wzorcÃ³w, ktÃ³re mogÄ… wskazywaÄ‡ na problemy.

**Kluczowe komponenty**:

* **Szkolenie modelu**: CloudWatch wykorzystuje dane historyczne do szkolenia modelu i ustalania, jak wyglÄ…da normalne zachowanie.
* **Pasmo wykrywania anomalii**: Wizualna reprezentacja oczekiwanego zakresu wartoÅ›ci dla metryki.

**PrzykÅ‚ad zastosowania**:

* Wykrywanie nietypowych wzorcÃ³w wykorzystania CPU w instancji EC2, ktÃ³re mogÄ… wskazywaÄ‡ na naruszenie bezpieczeÅ„stwa lub problem z aplikacjÄ….

### ReguÅ‚y spostrzeÅ¼eÅ„ i zarzÄ…dzane reguÅ‚y spostrzeÅ¼eÅ„

**ReguÅ‚y spostrzeÅ¼eÅ„** pozwalajÄ… zidentyfikowaÄ‡ trendy, wykrywaÄ‡ szczyty lub inne interesujÄ…ce wzorce w danych metrycznych, uÅ¼ywajÄ…c **potÄ™Å¼nych wyraÅ¼eÅ„ matematycznych** do zdefiniowania warunkÃ³w, na podstawie ktÃ³rych powinny byÄ‡ podejmowane dziaÅ‚ania. Te reguÅ‚y mogÄ… pomÃ³c w identyfikacji anomalii lub nietypowych zachowaÅ„ w wydajnoÅ›ci i wykorzystaniu zasobÃ³w.

**ZarzÄ…dzane reguÅ‚y spostrzeÅ¼eÅ„** to wstÄ™pnie skonfigurowane **reguÅ‚y spostrzeÅ¼eÅ„ dostarczane przez AWS**. SÄ… zaprojektowane do monitorowania konkretnych usÅ‚ug AWS lub powszechnych przypadkÃ³w uÅ¼ycia i mogÄ… byÄ‡ wÅ‚Ä…czane bez potrzeby szczegÃ³Å‚owej konfiguracji.

**PrzykÅ‚ad zastosowania**:

* Monitorowanie wydajnoÅ›ci RDS: WÅ‚Ä…cz zarzÄ…dzanÄ… reguÅ‚Ä™ spostrzeÅ¼eÅ„ dla Amazon RDS, ktÃ³ra monitoruje kluczowe wskaÅºniki wydajnoÅ›ci, takie jak wykorzystanie CPU, uÅ¼ycie pamiÄ™ci i I/O dysku. JeÅ›li ktÃ³rakolwiek z tych metryk przekroczy bezpieczne progi operacyjne, reguÅ‚a moÅ¼e uruchomiÄ‡ alert lub automatycznÄ… akcjÄ™ Å‚agodzÄ…cÄ….

### Logi CloudWatch <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

Pozwala na **agregacjÄ™ i monitorowanie logÃ³w z aplikacji** i systemÃ³w z **usÅ‚ug AWS** (w tym CloudTrail) oraz **z aplikacji/systemÃ³w** (**CloudWatch Agent** moÅ¼e byÄ‡ zainstalowany na hoÅ›cie). Logi mogÄ… byÄ‡ **przechowywane bezterminowo** (w zaleÅ¼noÅ›ci od ustawieÅ„ grupy logÃ³w) i mogÄ… byÄ‡ eksportowane.

**Elementy**:

| **Grupa logÃ³w**         | **kolekcja strumieni logÃ³w**, ktÃ³re dzielÄ… te same ustawienia przechowywania, monitorowania i kontroli dostÄ™pu                                                     |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **StrumieÅ„ logÃ³w**      | Sekwencja **zdarzeÅ„ logÃ³w**, ktÃ³re dzielÄ… **to samo ÅºrÃ³dÅ‚o**                                                                                                |
| **Filtry subskrypcyjne** | DefiniujÄ… **wzorzec filtru, ktÃ³ry pasuje do zdarzeÅ„** w danej grupie logÃ³w, wysyÅ‚ajÄ… je do strumienia Kinesis Data Firehose, strumienia Kinesis lub funkcji Lambda |

### Monitorowanie i zdarzenia CloudWatch

CloudWatch **podstawowy** agreguje dane **co 5 minut** (ten **szczegÃ³Å‚owy** robi to **co 1 minutÄ™**). Po agregacji **sprawdza progi alarmÃ³w**, aby zobaczyÄ‡, czy naleÅ¼y uruchomiÄ‡ jeden.\
W takim przypadku CloudWatch moÅ¼e byÄ‡ przygotowany do wysÅ‚ania zdarzenia i wykonania pewnych automatycznych dziaÅ‚aÅ„ (funkcje AWS lambda, tematy SNS, kolejki SQS, strumienie Kinesis)

### Instalacja agenta

MoÅ¼esz zainstalowaÄ‡ agentÃ³w wewnÄ…trz swoich maszyn/kontenerÃ³w, aby automatycznie wysyÅ‚aÄ‡ logi z powrotem do CloudWatch.

* **UtwÃ³rz** **rolÄ™** i **przypisz** jÄ… do **instancji** z uprawnieniami pozwalajÄ…cymi CloudWatch na zbieranie danych z instancji oprÃ³cz interakcji z menedÅ¼erem systemÃ³w AWS SSM (CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM)
* **Pobierz** i **zainstaluj** **agenta** na instancji EC2 ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). MoÅ¼esz go pobraÄ‡ z wnÄ™trza EC2 lub zainstalowaÄ‡ automatycznie za pomocÄ… AWS System Manager, wybierajÄ…c pakiet AWS-ConfigureAWSPackage
* **Skonfiguruj** i **uruchom** agenta CloudWatch

Grupa logÃ³w ma wiele strumieni. StrumieÅ„ ma wiele zdarzeÅ„. A w kaÅ¼dym strumieniu zdarzenia sÄ… gwarantowane w kolejnoÅ›ci.

## Enumeracja
```bash
# Dashboards #

## Returns a list of the dashboards of your account
aws cloudwatch list-dashboards

## Retrieves the details of the specified dashboard
aws cloudwatch get-dashboard --dashboard-name <value>

# Metrics #

## Returns a list of the specified metric
aws cloudwatch list-metrics [--namespace <value>] [--metric-name <value>] [--dimensions <value>] [--include-linked-accounts | --no-include-linked-accounts]

## Retrieves metric data (this operation can include a CloudWatch Metrics Insights query, and one or more metric math functions)
aws cloudwatch get-metric-data --metric-data-queries <value> --start-time <value> --end-time <value>

## Retrieves statistics for the specified metric and namespace over a range of time
aws cloudwatch get-metric-statistics --namespace <value> --metric-name <value> [--dimensions <value>] --start-time <value> --end-time <value> --period <value>

## Returns a list of the metric streams of your account
aws cloudwatch list-metric-streams

## Retrieves information about the specified metric stream
aws cloudwatch get-metric-stream --name <value>

## Retrieve snapshots of the specified metric widgets
aws cloudwatch get-metric-widget-image --metric-widget <value>

# Alarms #

## Retrieves the specified alarm
aws cloudwatch describe-alarms [--alarm-names <value>] [--alarm-name-prefix <value>] [--alarm-types <value>] [--state-value <value>]

## Retrieves the alarms history, even for deleted alarms
aws cloudwatch describe-alarm-history [--alarm-name <value>] [--alarm-types <value>] [--history-item-type <ConfigurationUpdate | StateUpdate | Action>] [--start-date <value>] [--end-date <value>]

## Retrieves standard alarms based on the specified metric
aws cloudwatch escribe-alarms-for-metric --metric-name <value> --namespace <value> [--dimensions <value>]

# Anomaly Detections #

## Lists the anomaly detection models that you have created in your account
aws cloudwatch describe-anomaly-detectors [--namespace <value>] [--metric-name <value>] [--dimensions <value>]

## Lists all the Contributor Insight rules in your account
aws cloudwatch describe-insight-rules

## Retrieves the data collected over a time range for a given Contributor Insight rule
aws cloudwatch get-insight-rule-report --rule-name <value> --start-time <value> --end-time <value> --period <value>

## Lists managed Contributor Insights rules in your account for a specified resource
aws cloudwatch list-managed-insight-rules --resource-arn <value>

# Tags #

## Lists the tags associated with the specified CloudWatch resources
aws cloudwatch list-tags-for-resource --resource-arn <value>

# CloudWatch Logs #
aws logs tail "<log_group_name>" --followaws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# CloudWatch Events #
aws events list-rules
aws events describe-rule --name <name>aws events list-targets-by-rule --rule <name>aws events list-archives
aws events describe-archive --archive-name <name>aws events list-connections
aws events describe-connection --name <name>aws events list-endpoints
aws events describe-endpoint --name <name>aws events list-event-sources
aws events describe-event-source --name <name>aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## Post-Exploitation / Bypass

### **`cloudwatch:DeleteAlarms`,`cloudwatch:PutMetricAlarm` , `cloudwatch:PutCompositeAlarm`**

AtakujÄ…cy z tymi uprawnieniami mÃ³gÅ‚by znaczÄ…co osÅ‚abiÄ‡ infrastrukturÄ™ monitorowania i powiadamiania organizacji. UsuwajÄ…c istniejÄ…ce alarmy, atakujÄ…cy mÃ³gÅ‚by wyÅ‚Ä…czyÄ‡ kluczowe powiadomienia, ktÃ³re informujÄ… administratorÃ³w o krytycznych problemach z wydajnoÅ›ciÄ…, naruszeniach bezpieczeÅ„stwa lub awariach operacyjnych. Ponadto, tworzÄ…c lub modyfikujÄ…c alarmy metryczne, atakujÄ…cy mÃ³gÅ‚by rÃ³wnieÅ¼ wprowadzaÄ‡ administratorÃ³w w bÅ‚Ä…d faÅ‚szywymi powiadomieniami lub uciszaÄ‡ uzasadnione alarmy, skutecznie maskujÄ…c zÅ‚oÅ›liwe dziaÅ‚ania i uniemoÅ¼liwiajÄ…c terminowe reakcje na rzeczywiste incydenty.

Dodatkowo, z uprawnieniem **`cloudwatch:PutCompositeAlarm`**, atakujÄ…cy mÃ³gÅ‚by stworzyÄ‡ pÄ™tlÄ™ lub cykl alarmÃ³w zÅ‚oÅ¼onych, gdzie alarm zÅ‚oÅ¼ony A zaleÅ¼y od alarmu zÅ‚oÅ¼onego B, a alarm zÅ‚oÅ¼ony B rÃ³wnieÅ¼ zaleÅ¼y od alarmu zÅ‚oÅ¼onego A. W tym scenariuszu nie jest moÅ¼liwe usuniÄ™cie jakiegokolwiek alarmu zÅ‚oÅ¼onego, ktÃ³ry jest czÄ™Å›ciÄ… cyklu, poniewaÅ¼ zawsze istnieje jeszcze alarm zÅ‚oÅ¼ony, ktÃ³ry zaleÅ¼y od alarmu, ktÃ³ry chcesz usunÄ…Ä‡.
```bash
aws cloudwatch put-metric-alarm --cli-input-json <value> | --alarm-name <value> --comparison-operator <value> --evaluation-periods <value> [--datapoints-to-alarm <value>] [--threshold <value>] [--alarm-description <value>] [--alarm-actions <value>] [--metric-name <value>] [--namespace <value>] [--statistic <value>] [--dimensions <value>] [--period <value>]
aws cloudwatch delete-alarms --alarm-names <value>
aws cloudwatch put-composite-alarm --alarm-name <value> --alarm-rule <value> [--no-actions-enabled | --actions-enabled [--alarm-actions <value>] [--insufficient-data-actions <value>] [--ok-actions <value>] ]
```
PrzykÅ‚ad poniÅ¼ej pokazuje, jak uczyniÄ‡ alarm metryczny nieskutecznym:

* Ten alarm metryczny monitoruje Å›rednie wykorzystanie CPU konkretnej instancji EC2, ocenia metrykÄ™ co 300 sekund i wymaga 6 okresÃ³w oceny (Å‚Ä…cznie 30 minut). JeÅ›li Å›rednie wykorzystanie CPU przekroczy 60% przez co najmniej 4 z tych okresÃ³w, alarm zostanie uruchomiony i wyÅ›le powiadomienie do okreÅ›lonego tematu SNS.
* Poprzez modyfikacjÄ™ progu na wiÄ™cej niÅ¼ 99%, ustawienie okresu na 10 sekund, okresÃ³w oceny na 8640 (poniewaÅ¼ 8640 okresÃ³w po 10 sekund rÃ³wna siÄ™ 1 dzieÅ„) oraz punktÃ³w danych do alarmu na 8640, konieczne byÅ‚oby, aby wykorzystanie CPU byÅ‚o powyÅ¼ej 99% co 10 sekund przez caÅ‚y 24-godzinny okres, aby uruchomiÄ‡ alarm.

{% tabs %}
{% tab title="Original Metric Alarm" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-01234567890123456"
}
],
"AlarmActions": [
"arn:aws:sns:us-east-1:123456789012:example_sns"
],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 4,
"EvaluationPeriods": 6,
"Period": 300,
"Statistic": "Average",
"Threshold": 60,
"AlarmDescription": "CPU Utilization of i-01234567890123456 over 60%",
"AlarmName": "EC2 instance i-01234567890123456 CPU Utilization"
}
```
{% endtab %}

{% tab title="Zmodyfikowany Alarm Metryczny" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0645d6d414dadf9f8"
}
],
"AlarmActions": [],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 8640,
"EvaluationPeriods": 8640,
"Period": 10,
"Statistic": "Average",
"Threshold": 99,
"AlarmDescription": "CPU Utilization of i-01234567890123456 with 60% as threshold",
"AlarmName": "Instance i-0645d6d414dadf9f8 CPU Utilization"
}

```
{% endtab %}
{% endtabs %}

**Potencjalny wpÅ‚yw**: Brak powiadomieÅ„ o krytycznych zdarzeniach, potencjalne niezauwaÅ¼one problemy, faÅ‚szywe alerty, tÅ‚umienie prawdziwych alertÃ³w i potencjalnie pominiÄ™te wykrycia rzeczywistych incydentÃ³w.

### **`cloudwatch:DeleteAlarmActions`, `cloudwatch:EnableAlarmActions`, `cloudwatch:SetAlarmState`**

UsuwajÄ…c akcje alarmowe, atakujÄ…cy moÅ¼e uniemoÅ¼liwiÄ‡ uruchomienie krytycznych powiadomieÅ„ i automatycznych odpowiedzi, gdy osiÄ…gniÄ™ty zostanie stan alarmu, na przykÅ‚ad powiadamianie administratorÃ³w lub uruchamianie dziaÅ‚aÅ„ auto-skalowania. NiewÅ‚aÅ›ciwe wÅ‚Ä…czanie lub ponowne wÅ‚Ä…czanie akcji alarmowych moÅ¼e rÃ³wnieÅ¼ prowadziÄ‡ do nieoczekiwanych zachowaÅ„, zarÃ³wno przez reaktywacjÄ™ wczeÅ›niej wyÅ‚Ä…czonych akcji, jak i przez modyfikacjÄ™, ktÃ³re akcje sÄ… uruchamiane, co moÅ¼e powodowaÄ‡ zamieszanie i bÅ‚Ä™dne kierowanie w odpowiedzi na incydenty.

Ponadto, atakujÄ…cy z odpowiednimi uprawnieniami mÃ³gÅ‚by manipulowaÄ‡ stanami alarmÃ³w, majÄ…c moÅ¼liwoÅ›Ä‡ tworzenia faÅ‚szywych alarmÃ³w, aby odwrÃ³ciÄ‡ uwagÄ™ i zdezorientowaÄ‡ administratorÃ³w, lub uciszaÄ‡ prawdziwe alarmy, aby ukryÄ‡ trwajÄ…ce zÅ‚oÅ›liwe dziaÅ‚ania lub krytyczne awarie systemu.

* JeÅ›li uÅ¼yjesz **`SetAlarmState`** na alarmie zÅ‚oÅ¼onym, alarm zÅ‚oÅ¼ony nie ma gwarancji, Å¼e powrÃ³ci do swojego rzeczywistego stanu. Powraca do swojego rzeczywistego stanu tylko wtedy, gdy ktÃ³rykolwiek z jego alarmÃ³w podrzÄ™dnych zmieni stan. Jest rÃ³wnieÅ¼ ponownie oceniany, jeÅ›li zaktualizujesz jego konfiguracjÄ™.
```bash
aws cloudwatch disable-alarm-actions --alarm-names <value>
aws cloudwatch enable-alarm-actions --alarm-names <value>
aws cloudwatch set-alarm-state --alarm-name <value> --state-value <OK | ALARM | INSUFFICIENT_DATA> --state-reason <value> [--state-reason-data <value>]
```
**Potencjalny wpÅ‚yw**: Brak powiadomieÅ„ o krytycznych zdarzeniach, potencjalne niezauwaÅ¼one problemy, faÅ‚szywe alerty, tÅ‚umienie prawdziwych alertÃ³w i potencjalnie pominiÄ™te wykrycia rzeczywistych incydentÃ³w.

### **`cloudwatch:DeleteAnomalyDetector`, `cloudwatch:PutAnomalyDetector`**

AtakujÄ…cy mÃ³gÅ‚by skompromitowaÄ‡ zdolnoÅ›Ä‡ do wykrywania i reagowania na nietypowe wzorce lub anomalie w danych metrycznych. UsuwajÄ…c istniejÄ…ce detektory anomalii, atakujÄ…cy mÃ³gÅ‚by wyÅ‚Ä…czyÄ‡ krytyczne mechanizmy powiadamiania; a tworzÄ…c lub modyfikujÄ…c je, mÃ³gÅ‚by albo bÅ‚Ä™dnie skonfigurowaÄ‡, albo stworzyÄ‡ faÅ‚szywe alarmy, aby odwrÃ³ciÄ‡ uwagÄ™ lub przytÅ‚oczyÄ‡ monitoring.
```bash
aws cloudwatch delete-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value>]
aws cloudwatch put-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value> --configuration <value> --metric-characteristics <value>]
```
PrzykÅ‚ad poniÅ¼ej pokazuje, jak uczyniÄ‡ detektor anomalii metrycznych nieskutecznym. Ten detektor anomalii metrycznych monitoruje Å›rednie wykorzystanie CPU konkretnej instancji EC2, a dodanie parametru â€ExcludedTimeRangesâ€ z poÅ¼Ä…danym zakresem czasowym wystarczy, aby zapewniÄ‡, Å¼e detektor anomalii nie analizuje ani nie ostrzega o Å¼adnych istotnych danych w tym okresie.

{% tabs %}
{% tab title="Oryginalny detektor anomalii metrycznych" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
}
}
```
{% endtab %}

{% tab title="Zmodyfikowany Detektor Anomalii Metryki" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
},
"Configuration": {
"ExcludedTimeRanges": [
{
"StartTime": "2023-01-01T00:00:00Z",
"EndTime": "2053-01-01T23:59:59Z"
}
],
"Timezone": "Europe/Madrid"
}
}
```
{% endtab %}
{% endtabs %}

**Potencjalny wpÅ‚yw**: BezpoÅ›redni wpÅ‚yw na wykrywanie nietypowych wzorcÃ³w lub zagroÅ¼eÅ„ bezpieczeÅ„stwa.

### **`cloudwatch:DeleteDashboards`, `cloudwatch:PutDashboard`**

Napastnik mÃ³gÅ‚by skompromitowaÄ‡ moÅ¼liwoÅ›ci monitorowania i wizualizacji organizacji, tworzÄ…c, modyfikujÄ…c lub usuwajÄ…c jej pulpity nawigacyjne. Te uprawnienia mogÅ‚yby zostaÄ‡ wykorzystane do usuniÄ™cia krytycznej widocznoÅ›ci wydajnoÅ›ci i stanu systemÃ³w, zmiany pulpitÃ³w nawigacyjnych w celu wyÅ›wietlania nieprawidÅ‚owych danych lub ukrycia zÅ‚oÅ›liwych dziaÅ‚aÅ„.
```bash
aws cloudwatch delete-dashboards --dashboard-names <value>
aws cloudwatch put-dashboard --dashboard-name <value> --dashboard-body <value>
```
**Potencjalny wpÅ‚yw**: Utrata widocznoÅ›ci monitorowania i wprowadzajÄ…ce w bÅ‚Ä…d informacje.

### **`cloudwatch:DeleteInsightRules`, `cloudwatch:PutInsightRule`, `cloudwatch:PutManagedInsightRule`**

ReguÅ‚y insight sÄ… uÅ¼ywane do wykrywania anomalii, optymalizacji wydajnoÅ›ci i efektywnego zarzÄ…dzania zasobami. UsuwajÄ…c istniejÄ…ce reguÅ‚y insight, atakujÄ…cy mÃ³gÅ‚by usunÄ…Ä‡ krytyczne moÅ¼liwoÅ›ci monitorowania, pozostawiajÄ…c system Å›lepym na problemy z wydajnoÅ›ciÄ… i zagroÅ¼enia bezpieczeÅ„stwa. Dodatkowo, atakujÄ…cy mÃ³gÅ‚by tworzyÄ‡ lub modyfikowaÄ‡ reguÅ‚y insight, aby generowaÄ‡ wprowadzajÄ…ce w bÅ‚Ä…d dane lub ukrywaÄ‡ zÅ‚oÅ›liwe dziaÅ‚ania, co prowadziÅ‚oby do bÅ‚Ä™dnych diagnoz i niewÅ‚aÅ›ciwych reakcji ze strony zespoÅ‚u operacyjnego.
```bash
aws cloudwatch delete-insight-rules --rule-names <value>
aws cloudwatch put-insight-rule --rule-name <value> --rule-definition <value> [--rule-state <value>]
aws cloudwatch put-managed-insight-rules --managed-rules <value>
```
**Potencjalny wpÅ‚yw**: TrudnoÅ›ci w wykrywaniu i reagowaniu na problemy z wydajnoÅ›ciÄ… oraz anomalie, bÅ‚Ä™dne podejmowanie decyzji i potencjalne ukrywanie zÅ‚oÅ›liwych dziaÅ‚aÅ„ lub awarii systemu.

### **`cloudwatch:DisableInsightRules`, `cloudwatch:EnableInsightRules`**

DezaktywujÄ…c krytyczne zasady wglÄ…du, atakujÄ…cy mÃ³gÅ‚by skutecznie oÅ›lepiÄ‡ organizacjÄ™ na kluczowe metryki wydajnoÅ›ci i bezpieczeÅ„stwa. Z drugiej strony, wÅ‚Ä…czajÄ…c lub konfigurujÄ…c mylÄ…ce zasady, mogÅ‚oby byÄ‡ moÅ¼liwe generowanie faÅ‚szywych danych, tworzenie szumÃ³w lub ukrywanie zÅ‚oÅ›liwej aktywnoÅ›ci.
```bash
aws cloudwatch disable-insight-rules --rule-names <value>
aws cloudwatch enable-insight-rules --rule-names <value>
```
**Potencjalny wpÅ‚yw**: Zamieszanie w zespole operacyjnym, prowadzÄ…ce do opÃ³Åºnionych reakcji na rzeczywiste problemy i niepotrzebnych dziaÅ‚aÅ„ na podstawie faÅ‚szywych alertÃ³w.

### **`cloudwatch:DeleteMetricStream` , `cloudwatch:PutMetricStream` , `cloudwatch:PutMetricData`**

AtakujÄ…cy z uprawnieniami **`cloudwatch:DeleteMetricStream`** , **`cloudwatch:PutMetricStream`** mÃ³gÅ‚by tworzyÄ‡ i usuwaÄ‡ strumienie danych metrycznych, kompromitujÄ…c bezpieczeÅ„stwo, monitorowanie i integralnoÅ›Ä‡ danych:

* **Tworzenie zÅ‚oÅ›liwych strumieni**: Tworzenie strumieni metrycznych w celu wysyÅ‚ania wraÅ¼liwych danych do nieautoryzowanych miejsc docelowych.
* **Manipulacja zasobami**: Tworzenie nowych strumieni metrycznych z nadmiernymi danymi mogÅ‚oby generowaÄ‡ duÅ¼o szumÃ³w, powodujÄ…c bÅ‚Ä™dne alerty, maskujÄ…c prawdziwe problemy.
* **ZakÅ‚Ã³cenie monitorowania**: UsuwajÄ…c strumienie metryczne, atakujÄ…cy zakÅ‚Ã³ciliby ciÄ…gÅ‚y przepÅ‚yw danych monitorujÄ…cych. W ten sposÃ³b ich zÅ‚oÅ›liwe dziaÅ‚ania byÅ‚yby skutecznie ukryte.

Podobnie, z uprawnieniem **`cloudwatch:PutMetricData`**, moÅ¼liwe byÅ‚oby dodawanie danych do strumienia metrycznego. MogÅ‚oby to prowadziÄ‡ do DoS z powodu iloÅ›ci niewÅ‚aÅ›ciwych danych dodanych, czyniÄ…c go caÅ‚kowicie bezuÅ¼ytecznym.
```bash
aws cloudwatch delete-metric-stream --name <value>
aws cloudwatch put-metric-stream --name <value> [--include-filters <value>] [--exclude-filters <value>] --firehose-arn <value> --role-arn <value> --output-format <value>
aws cloudwatch put-metric-data --namespace <value> [--metric-data <value>] [--metric-name <value>] [--timestamp <value>] [--unit <value>] [--value <value>] [--dimensions <value>]
```
PrzykÅ‚ad dodawania danych odpowiadajÄ…cych 70% wykorzystania CPU na danej instancji EC2:
```bash
aws cloudwatch put-metric-data --namespace "AWS/EC2" --metric-name "CPUUtilization" --value 70 --unit "Percent" --dimensions "InstanceId=i-0123456789abcdefg"
```
**Potencjalny wpÅ‚yw**: ZakÅ‚Ã³cenie przepÅ‚ywu danych monitorujÄ…cych, wpÅ‚ywajÄ…ce na wykrywanie anomalii i incydentÃ³w, manipulacja zasobami oraz wzrost kosztÃ³w z powodu tworzenia nadmiernych strumieni metryk.

### **`cloudwatch:StopMetricStreams`, `cloudwatch:StartMetricStreams`**

Napastnik kontrolowaÅ‚by przepÅ‚yw danych metryk w dotkniÄ™tych strumieniach (kaÅ¼dy strumieÅ„ danych, jeÅ›li nie ma ograniczeÅ„ zasobÃ³w). PosiadajÄ…c uprawnienie **`cloudwatch:StopMetricStreams`**, napastnicy mogliby ukryÄ‡ swoje zÅ‚oÅ›liwe dziaÅ‚ania, zatrzymujÄ…c krytyczne strumienie metryk.
```bash
aws cloudwatch stop-metric-streams --names <value>
aws cloudwatch start-metric-streams --names <value>
```
**Potencjalny wpÅ‚yw**: ZakÅ‚Ã³cenie przepÅ‚ywu danych monitorujÄ…cych, wpÅ‚ywajÄ…ce na wykrywanie anomalii i incydentÃ³w.

### **`cloudwatch:TagResource`, `cloudwatch:UntagResource`**

Napastnik mÃ³gÅ‚by dodaÄ‡, zmodyfikowaÄ‡ lub usunÄ…Ä‡ tagi z zasobÃ³w CloudWatch (obecnie tylko alarmy i zasady Contributor Insights). MoÅ¼e to zakÅ‚Ã³ciÄ‡ polityki kontroli dostÄ™pu w Twojej organizacji oparte na tagach.
```bash
aws cloudwatch tag-resource --resource-arn <value> --tags <value>
aws cloudwatch untag-resource --resource-arn <value> --tag-keys <value>
```
**Potencjalny wpÅ‚yw**: ZakÅ‚Ã³cenie polityk kontroli dostÄ™pu opartych na tagach.

## Odniesienia

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list\_amazoncloudwatch.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list\_amazoncloudwatch.html)
* [https://docs.aws.amazon.com/es\_es/AmazonCloudWatch/latest/monitoring/cloudwatch\_concepts.html#Metric](https://docs.aws.amazon.com/es\_es/AmazonCloudWatch/latest/monitoring/cloudwatch\_concepts.html#Metric)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
