# AWS - CloudWatch Enum

{% hint style="success" %}
UÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
UÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## CloudWatch

**CloudWatch** **sakuplja** nadzorne i operativne **podatke** u obliku zapisa/metriÄkih podataka/dogaÄ‘aja pruÅ¾ajuÄ‡i **ujedinjeni prikaz AWS resursa**, aplikacija i usluga.\
CloudWatch Log dogaÄ‘aji imaju **ograniÄenje veliÄine od 256KB po svakoj liniji zapisa**.\
MoÅ¾e postaviti **alarme visoke rezolucije**, vizualizovati **zapise** i **metrike** jedan pored drugog, preduzimati automatske akcije, reÅ¡avati probleme i otkrivati uvide radi optimizacije aplikacija.

MoÅ¾ete pratiti na primer zapise iz CloudTrail-a. DogaÄ‘aji koji se prate:

* Promene u sigurnosnim grupama i NACL-ima
* Pokretanje, zaustavljanje, ponovno pokretanje i gaÅ¡enje EC2 instanci
* Promene u sigurnosnim politikama unutar IAM-a i S3
* NeuspeÅ¡ni pokuÅ¡aji prijave u AWS Management konzolu
* API pozivi koji su rezultirali neuspeÅ¡nom autorizacijom
* Filteri za pretragu u cloudwatch-u: [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

## KljuÄni koncepti

### Prostori imena

Prostor imena je kontejner za CloudWatch metrike. PomaÅ¾e u kategorizaciji i izolaciji metrika, olakÅ¡avajuÄ‡i njihovo upravljanje i analizu.

- **Primeri**: AWS/EC2 za metrike povezane sa EC2, AWS/RDS za RDS metrike.

### Metrike

Metrike su podaci prikupljeni tokom vremena koji predstavljaju performanse ili iskoriÅ¡Ä‡enost AWS resursa. Metrike se mogu prikupljati iz AWS usluga, prilagoÄ‘enih aplikacija ili integracija treÄ‡ih strana.

- **Primer**: CPUUtilization, NetworkIn, DiskReadOps.

### Dimenzije

Dimenzije su parovi kljuÄ-vrednost koji su deo metrika. PomaÅ¾u u jedinstvenom identifikovanju metrike i pruÅ¾anju dodatnog konteksta, pri Äemu je 30 najveÄ‡i broj dimenzija koje se mogu povezati sa metrikom. Dimenzije takoÄ‘e omoguÄ‡avaju filtriranje i agregiranje metrika na osnovu specifiÄnih atributa.

- **Primer**: Za EC2 instance, dimenzije mogu ukljuÄivati InstanceId, InstanceType i AvailabilityZone.

### Statistike

Statistike su matematiÄki proraÄuni izvrÅ¡eni nad metriÄkim podacima radi sumiranja tokom vremena. UobiÄajene statistike ukljuÄuju Prosek, Zbir, Minimum, Maksimum i Broj uzoraka.

- **Primer**: RaÄunanje proseÄne iskoriÅ¡Ä‡enosti CPU-a tokom perioda od jednog sata.

### Jedinice

Jedinice su vrsta merenja povezana sa metrikom. Jedinice pomaÅ¾u u pruÅ¾anju konteksta i znaÄenja podataka metrike. UobiÄajene jedinice ukljuÄuju Procenat, Bajtovi, Sekunde, Broj.

- **Primer**: CPUUtilization moÅ¾e biti meren u Procentima, dok NetworkIn moÅ¾e biti meren u Bajtovima.

## CloudWatch Funkcije

### Tabla

**CloudWatch Table** pruÅ¾a prilagodljive **prikaze vaÅ¡ih AWS CloudWatch metrika**. MoguÄ‡e je kreirati i konfigurisati table za vizualizaciju podataka i praÄ‡enje resursa u jednom prikazu, kombinujuÄ‡i razliÄite metrike iz razliÄitih AWS usluga.

**KljuÄne funkcije**:

- **VidÅ¾eti**: GraÄ‘evinski blokovi tabli, ukljuÄujuÄ‡i grafikone, tekst, alarme i viÅ¡e.
- **PrilagoÄ‘avanje**: Izgled i sadrÅ¾aj mogu se prilagoditi da odgovaraju specifiÄnim potrebama praÄ‡enja.

**Primer upotrebe**:

- Jedna tabla koja prikazuje kljuÄne metrike za ceo vaÅ¡ AWS okruÅ¾enje, ukljuÄujuÄ‡i EC2 instance, RDS baze podataka i S3 kofere.

### Tok Metrike i MetriÄki Podaci

**Tokovi metrike** u AWS CloudWatch omoguÄ‡avaju vam kontinuirano strujanje CloudWatch metrika do odrediÅ¡ta po vaÅ¡em izboru u gotovo realnom vremenu. Ovo je posebno korisno za napredno praÄ‡enje, analitiku i prilagoÄ‘ene table koristeÄ‡i alate van AWS-a.

**MetriÄki podaci** unutar Tokova metrike odnose se na stvarna merenja ili podatke koji se struje. Ovi podaci predstavljaju razliÄite metrike poput iskoriÅ¡Ä‡enja CPU-a, iskoriÅ¡Ä‡enja memorije, itd., za AWS resurse.

**Primer upotrebe**:

- Slanje metrika u realnom vremenu treÄ‡oj monitoring usluzi za naprednu analizu.
- Arhiviranje metrika u Amazon S3 kofu za dugoroÄno skladiÅ¡tenje i usklaÄ‘enost.

### Alarm

**CloudWatch Alarmi** prate vaÅ¡e metrike i vrÅ¡e akcije na osnovu unapred definisanih pragova. Kada metrika preÄ‘e prag, alarm moÅ¾e izvrÅ¡iti jednu ili viÅ¡e akcija kao Å¡to su slanje obaveÅ¡tenja putem SNS-a, pokretanje politike automatskog skaliranja ili pokretanje AWS Lambda funkcije.

**KljuÄni Komponenti**:

- **Prag**: Vrednost na kojoj alarm reaguje.
- **Periodi Evaluacije**: Broj perioda tokom kojih se podaci procenjuju.
- **Podaci do Alarma**: Broj perioda sa dostignutim pragom potrebnih za pokretanje alarma.
- **Akcije**: Å ta se deÅ¡ava kada je stanje alarma aktivirano (npr. obaveÅ¡tavanje putem SNS-a).

**Primer upotrebe**:

- PraÄ‡enje iskoriÅ¡Ä‡enja CPU-a EC2 instance i slanje obaveÅ¡tenja putem SNS-a ako preÄ‘e 80% tokom 5 uzastopnih minuta.

### Detektori Anomalija

**Detektori Anomalija** koriste maÅ¡insko uÄenje za automatsko otkrivanje anomalija u vaÅ¡im metrikama. MoÅ¾ete primeniti detekciju anomalija na bilo koju CloudWatch metriku kako biste identifikovali odstupanja od normalnih obrazaca koja mogu ukazivati na probleme.

**KljuÄni Komponenti**:

- **Obuka Modela**: CloudWatch koristi istorijske podatke za obuku modela i utvrÄ‘ivanje kako normalno ponaÅ¡anje izgleda.
- **Opseg Detekcije Anomalija**: Vizuelna reprezentacija oÄekivanog opsega vrednosti za metriku.

**Primer upotrebe**:

- Otkrivanje neobiÄnih obrazaca iskoriÅ¡Ä‡enja CPU-a u EC2 instanci koji mogu ukazivati na sigurnosni prekrÅ¡aj ili problem sa aplikacijom.

### Pravila Uvida i Upravljana Pravila Uvida

**Pravila Uvida** vam omoguÄ‡avaju da identifikujete trendove, detektujete skokove ili druge obrasce od interesa u vaÅ¡im metriÄkim podacima koristeÄ‡i **moÄ‡ne matematiÄke izraze** za definisanje uslova pod kojima treba preduzeti akcije. Ova pravila vam mogu pomoÄ‡i da identifikujete anomalije ili neobiÄna ponaÅ¡anja u performansama i iskoriÅ¡Ä‡enju resursa.

**Upravljana Pravila Uvida** su prethodno konfigurisana **pravila uvida koja pruÅ¾a AWS**. Namenjena su praÄ‡enju specifiÄnih AWS usluga ili uobiÄajenih sluÄajeva upotrebe i mogu se omoguÄ‡iti bez potrebe za detaljnom konfiguracijom.

**Primer upotrebe**:

- PraÄ‡enje Performansi RDS-a: OmoguÄ‡ite upravljano pravilo uvida za Amazon RDS koje prati kljuÄne pokazatelje performansi kao Å¡to su iskoriÅ¡Ä‡enje CPU-a, iskoriÅ¡Ä‡enje memorije i disk I/O. Ako neki od ovih metrika preÄ‘e sigurne operativne pragove, pravilo moÅ¾e pokrenuti upozorenje ili automatsku akciju za ublaÅ¾avanje.

### CloudWatch Zapisi <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

OmoguÄ‡ava **agregiranje i praÄ‡enje zapisa iz aplikacija** i sistema iz **AWS usluga** (ukljuÄujuÄ‡i CloudTrail) i **iz aplikacija/sistema** (**CloudWatch Agent** moÅ¾e biti instaliran na hostu). Zapisi mogu biti **Äuvani neograniÄeno** (u zavisnosti od postavki Grupe zapisa) i mogu biti izvezeni.

**Elementi**:

| **Grupa Zapisa**        | **Kolekcija tokova zapisa** koji dele iste postavke zadrÅ¾avanja, nadzora i kontrole pristupa                                                     |
| ----------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Tok Zapisa**          | Sekvenca **log dogaÄ‘aja** koji dele **isti izvor**                                                                                                         |
| **Filteri Pretplate**   | DefiniÅ¡u **obrazac filtera koji se podudara sa dogaÄ‘ajima** u odreÄ‘enoj grupi zapisa, Å¡alju ih na Kinesis Data Firehose tok, Kinesis tok ili Lambda funkciju |
### PraÄ‡enje i dogaÄ‘aji CloudWatch-a

CloudWatch **osnovno** agregira podatke **svakih 5 minuta** (detaljno radi to **svakih 1 minut**). Nakon agregacije, proverava **pragove alarma** u sluÄaju potrebe za aktiviranjem jednog.\
U tom sluÄaju, CloudWatch moÅ¾e biti pripremljen da poÅ¡alje dogaÄ‘aj i izvrÅ¡i neke automatske akcije (AWS lambda funkcije, SNS teme, SQS redove, Kinesis tokove)

### Instalacija agenta

MoÅ¾ete instalirati agente unutar vaÅ¡ih maÅ¡ina/kontejnera kako bi automatski slali dnevnike nazad u CloudWatch.

* **Napravite** ulogu i **dodelite** je **instanci** sa dozvolama koje omoguÄ‡avaju CloudWatch-u da prikuplja podatke sa instanci, pored interakcije sa AWS sistem menadÅ¾erom SSM (CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM)
* **Preuzmite** i **instalirajte** agenta na EC2 instancu ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). MoÅ¾ete ga preuzeti unutar EC2 ili instalirati automatski koristeÄ‡i AWS System Manager birajuÄ‡i paket AWS-ConfigureAWSPackage
* **KonfiguriÅ¡ite** i **pokrenite** CloudWatch agenta

Grupa dnevnika ima mnogo tokova. Tok ima mnogo dogaÄ‘aja. I unutar svakog toka, dogaÄ‘aji su garantovano poreÄ‘ani.
```bash
# Dashboards #

## Returns a list of the dashboards of your account
aws cloudwatch list-dashboards

## Retrieves the details of the specified dashboard
aws cloudwatch get-dashboard --dashboard-name <value>

# Metrics #

## Returns a list of the specified metric
aws cloudwatch list-metrics [--namespace <value>] [--metric-name <value>] [--dimensions <value>] [--include-linked-accounts | --no-include-linked-accounts]

## Retrieves metric data (this operation can include a CloudWatch Metrics Insights query, and one or more metric math functions)
aws cloudwatch get-metric-data --metric-data-queries <value> --start-time <value> --end-time <value>

## Retrieves statistics for the specified metric and namespace over a range of time
aws cloudwatch get-metric-statistics --namespace <value> --metric-name <value> [--dimensions <value>] --start-time <value> --end-time <value> --period <value>

## Returns a list of the metric streams of your account
aws cloudwatch list-metric-streams

## Retrieves information about the specified metric stream
aws cloudwatch get-metric-stream --name <value>

## Retrieve snapshots of the specified metric widgets
aws cloudwatch get-metric-widget-image --metric-widget <value>

# Alarms #

## Retrieves the specified alarm
aws cloudwatch describe-alarms [--alarm-names <value>] [--alarm-name-prefix <value>] [--alarm-types <value>] [--state-value <value>]

## Retrieves the alarms history, even for deleted alarms
aws cloudwatch describe-alarm-history [--alarm-name <value>] [--alarm-types <value>] [--history-item-type <ConfigurationUpdate | StateUpdate | Action>] [--start-date <value>] [--end-date <value>]

## Retrieves standard alarms based on the specified metric
aws cloudwatch escribe-alarms-for-metric --metric-name <value> --namespace <value> [--dimensions <value>]

# Anomaly Detections #

## Lists the anomaly detection models that you have created in your account
aws cloudwatch describe-anomaly-detectors [--namespace <value>] [--metric-name <value>] [--dimensions <value>]

## Lists all the Contributor Insight rules in your account
aws cloudwatch describe-insight-rules

## Retrieves the data collected over a time range for a given Contributor Insight rule
aws cloudwatch get-insight-rule-report --rule-name <value> --start-time <value> --end-time <value> --period <value>

## Lists managed Contributor Insights rules in your account for a specified resource
aws cloudwatch list-managed-insight-rules --resource-arn <value>

# Tags #

## Lists the tags associated with the specified CloudWatch resources
aws cloudwatch list-tags-for-resource --resource-arn <value>

# CloudWatch Logs #
aws logs tail "<log_group_name>" --followaws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# CloudWatch Events #
aws events list-rules
aws events describe-rule --name <name>aws events list-targets-by-rule --rule <name>aws events list-archives
aws events describe-archive --archive-name <name>aws events list-connections
aws events describe-connection --name <name>aws events list-endpoints
aws events describe-endpoint --name <name>aws events list-event-sources
aws events describe-event-source --name <name>aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## Post-Eksploatacija / ZaobilaÅ¾enje

### **`cloudwatch:DeleteAlarms`,`cloudwatch:PutMetricAlarm` ,Â `cloudwatch:PutCompositeAlarm`**

NapadaÄ sa ovim dozvolama moÅ¾e znaÄajno oslabiti nadzornu i upozoravajuÄ‡u infrastrukturu organizacije. Brisanjem postojeÄ‡ih alarma, napadaÄ moÅ¾e onemoguÄ‡iti kljuÄna upozorenja koja obaveÅ¡tavaju administratore o kritiÄnim problemima performansi, sigurnosnim propustima ili operativnim neuspesima. Osim toga, kreiranjem ili modifikovanjem metriÄkih alarma, napadaÄ takoÄ‘e moÅ¾e zavarati administratore laÅ¾nim upozorenjima ili uÄ‡utkati legitimne alarme, efikasno maskirajuÄ‡i zlonamerne aktivnosti i spreÄavajuÄ‡i pravovremene odgovore na stvarne incidente.

Pored toga, sa dozvolom **`cloudwatch:PutCompositeAlarm`**, napadaÄ bi mogao da kreira petlju ili ciklus kompozitnih alarma, gde kompozitni alarm A zavisi od kompozitnog alarma B, a kompozitni alarm B takoÄ‘e zavisi od kompozitnog alarma A. U ovom scenariju, nije moguÄ‡e obrisati bilo koji kompozitni alarm koji je deo ciklusa jer uvek postoji joÅ¡ uvek kompozitni alarm koji zavisi od tog alarma koji Å¾elite da obriÅ¡ete.
```bash
aws cloudwatch put-metric-alarm --cli-input-json <value> | --alarm-name <value> --comparison-operator <value> --evaluation-periods <value> [--datapoints-to-alarm <value>] [--threshold <value>] [--alarm-description <value>] [--alarm-actions <value>] [--metric-name <value>] [--namespace <value>] [--statistic <value>] [--dimensions <value>] [--period <value>]
aws cloudwatch delete-alarms --alarm-names <value>
aws cloudwatch put-composite-alarm --alarm-name <value> --alarm-rule <value> [--no-actions-enabled | --actions-enabled [--alarm-actions <value>] [--insufficient-data-actions <value>] [--ok-actions <value>] ]
```
Primer ispod pokazuje kako uÄiniti metriÄki alarm neefikasnim:

- Ovaj metriÄki alarm prati proseÄnu iskoriÅ¡Ä‡enost CPU-a odreÄ‘ene EC2 instance, procenjuje metriku svakih 300 sekundi i zahteva 6 evaluacionih perioda (ukupno 30 minuta). Ako proseÄna iskoriÅ¡Ä‡enost CPU-a premaÅ¡i 60% tokom najmanje 4 od ovih perioda, alarm Ä‡e se aktivirati i poslati obaveÅ¡tenje na odreÄ‘enu SNS temu.
- Modifikovanjem Praga da bude veÄ‡i od 99%, postavljanjem Perioda na 10 sekundi, Evaluacionih perioda na 8640 (poÅ¡to 8640 perioda od 10 sekundi iznosi 1 dan), i TaÄaka podataka za Alarm takoÄ‘e na 8640, bilo bi potrebno da iskoriÅ¡Ä‡enost CPU-a bude preko 99% svakih 10 sekundi tokom celog 24-Äasovnog perioda da bi se aktivirao alarm.

{% tabs %}
{% tab title="Original Metric Alarm" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-01234567890123456"
}
],
"AlarmActions": [
"arn:aws:sns:us-east-1:123456789012:example_sns"
],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 4,
"EvaluationPeriods": 6,
"Period": 300,
"Statistic": "Average",
"Threshold": 60,
"AlarmDescription": "CPU Utilization of i-01234567890123456 over 60%",
"AlarmName": "EC2 instance i-01234567890123456 CPU Utilization"
}
```
{% endtab %}
{% tab title="Modifikovani metriÄki alarm" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0645d6d414dadf9f8"
}
],
"AlarmActions": [],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 8640,
"EvaluationPeriods": 8640,
"Period": 10,
"Statistic": "Average",
"Threshold": 99,
"AlarmDescription": "CPU Utilization of i-01234567890123456 with 60% as threshold",
"AlarmName": "Instance i-0645d6d414dadf9f8 CPU Utilization"
}

```
{% endtab %}
{% endtabs %}
**Potencijalni uticaj**: Nedostatak obaveÅ¡tenja o kritiÄnim dogaÄ‘ajima, potencijalni nedetektovani problemi, laÅ¾na upozorenja, suzbijanje pravih upozorenja i potencijalno propuÅ¡tanje otkrivanja stvarnih incidenata.

### **`cloudwatch:DeleteAlarmActions`,Â `cloudwatch:EnableAlarmActions` , `cloudwatch:SetAlarmState`**

Brisanjem akcija alarma, napadaÄ moÅ¾e spreÄiti da se kritiÄna upozorenja i automatski odgovori aktiviraju kada se dostigne stanje alarma, kao Å¡to je obaveÅ¡tavanje administratora ili pokretanje aktivnosti automatskog skaliranja. Nepravilno omoguÄ‡avanje ili ponovno omoguÄ‡avanje akcija alarma takoÄ‘e moÅ¾e dovesti do neoÄekivanih ponaÅ¡anja, bilo ponovnim aktiviranjem prethodno onemoguÄ‡enih akcija ili izmenom koje akcije se pokreÄ‡u, potencijalno izazivajuÄ‡i zabunu i pogreÅ¡no usmeravanje u odgovoru na incidente.

Pored toga, napadaÄ sa dozvolom moÅ¾e manipulisati stanjima alarma, moguÄ‡i stvaranje laÅ¾nih alarma radi ometanja i zbunjivanja administratora, ili utiÅ¡avanje pravih alarma radi skrivanja trenutnih zlonamernih aktivnosti ili kritiÄnih sistemskih kvarova.

- Ako koristite **`SetAlarmState`** na kompozitnom alarmu, kompozitni alarm nije garantovan da Ä‡e se vratiti u svoje stvarno stanje. VraÄ‡a se u svoje stvarno stanje samo kada se bilo koji od njegovih deÄijih alarma promeni. TakoÄ‘e se ponovo procenjuje ako aÅ¾urirate njegovu konfiguraciju.
```bash
aws cloudwatch disable-alarm-actions --alarm-names <value>
aws cloudwatch enable-alarm-actions --alarm-names <value>
aws cloudwatch set-alarm-state --alarm-name <value> --state-value <OK | ALARM | INSUFFICIENT_DATA> --state-reason <value> [--state-reason-data <value>]
```
**Potencijalni uticaj**: Nedostatak obaveÅ¡tenja o kritiÄnim dogaÄ‘ajima, potencijalni neotkriveni problemi, laÅ¾na upozorenja, suzbijanje pravih upozorenja i potencijalno propuÅ¡tanje otkrivanja stvarnih incidenata.

### **`cloudwatch:DeleteAnomalyDetector`,Â `cloudwatch:PutAnomalyDetector`**

NapadaÄ bi mogao da ugrozi sposobnost detekcije i odgovora na neobiÄne obrasce ili anomalije u metriÄkim podacima. Brisanjem postojeÄ‡ih detektora anomalija, napadaÄ bi mogao da onemoguÄ‡i kritiÄne mehanizme upozoravanja; a kreiranjem ili modifikovanjem istih, mogao bi ili da pogreÅ¡no konfiguriÅ¡e ili da stvori laÅ¾ne pozitivne rezultate kako bi ometali ili preplavili nadgledanje.
```bash
aws cloudwatch delete-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value>]
aws cloudwatch put-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value> --configuration <value> --metric-characteristics <value>]
```
Primer u nastavku pokazuje kako uÄiniti detektor anomalija metrika neefikasnim. Ovaj detektor anomalija metrika prati proseÄnu iskoriÅ¡Ä‡enost CPU-a odreÄ‘ene EC2 instance, i samo dodavanjem parametra "ExcludedTimeRanges" sa Å¾eljenim vremenskim opsegom, bilo bi dovoljno osigurati da detektor anomalija ne analizira ili ne upozorava na bilo kakve relevantne podatke tokom tog perioda.

{% tabs %}
{% tab title="Originalni detektor anomalija metrika" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
}
}
```
{% endtab %}
{% tab title="Modifikovani detektor anomalija metrika" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
},
"Configuration": {
"ExcludedTimeRanges": [
{
"StartTime": "2023-01-01T00:00:00Z",
"EndTime": "2053-01-01T23:59:59Z"
}
],
"Timezone": "Europe/Madrid"
}
}
```
**Potencijalni uticaj**: Direktan efekat u otkrivanju neobiÄnih obrazaca ili sigurnosnih pretnji.

### **`cloudwatch:DeleteDashboards`,Â `cloudwatch:PutDashboard`**

NapadaÄ bi mogao da ugrozi moguÄ‡nosti praÄ‡enja i vizualizacije organizacije tako Å¡to bi kreirao, modifikovao ili brisao njene kontrolne table. Ova dozvola moÅ¾e biti iskoriÅ¡Ä‡ena da se ukloni kritiÄna vidljivost u performansama i zdravlju sistema, izmeni kontrolne table da prikaÅ¾u netaÄne podatke ili sakriju zlonamerne aktivnosti.
```bash
aws cloudwatch delete-dashboards --dashboard-names <value>
aws cloudwatch put-dashboard --dashboard-name <value> --dashboard-body <value>
```
**Potencijalni uticaj**: Gubitak vidljivosti nad praÄ‡enjem i pogreÅ¡ne informacije.

### **`cloudwatch:DeleteInsightRules`,Â `cloudwatch:PutInsightRule` ,`cloudwatch:PutManagedInsightRule`**

Pravila uvida se koriste za otkrivanje anomalija, optimizaciju performansi i efikasno upravljanje resursima. Brisanjem postojeÄ‡ih pravila uvida, napadaÄ bi mogao ukloniti kljuÄne moguÄ‡nosti praÄ‡enja, ostavljajuÄ‡i sistem slepim za probleme performansi i sigurnosne pretnje. Dodatno, napadaÄ bi mogao kreirati ili modifikovati pravila uvida kako bi generisao pogreÅ¡ne podatke ili sakrio zlonamerne aktivnosti, Å¡to dovodi do netaÄne dijagnostike i neadekvatnih odgovora od strane operativnog tima.
```bash
aws cloudwatch delete-insight-rules --rule-names <value>
aws cloudwatch put-insight-rule --rule-name <value> --rule-definition <value> [--rule-state <value>]
aws cloudwatch put-managed-insight-rules --managed-rules <value>
```
**Potencijalni uticaj**: TeÅ¡koÄ‡e u otkrivanju i reagovanju na probleme performansi i anomalije, dezinformisano donoÅ¡enje odluka i potencijalno skrivanje zlonamernih aktivnosti ili sistemskih kvarova.

### **`cloudwatch:DisableInsightRules`,Â `cloudwatch:EnableInsightRules`**

OnemoguÄ‡avanjem kljuÄnih pravila za uvid, napadaÄ bi efikasno mogao oslepiti organizaciju za kljuÄne performanse i sigurnosne metrike. Obrnuto, omoguÄ‡avanjem ili konfigurisanjem obmanjujuÄ‡ih pravila, moguÄ‡e je generisati laÅ¾ne podatke, stvarati buku ili sakriti zlonamerne aktivnosti.
```bash
aws cloudwatch disable-insight-rules --rule-names <value>
aws cloudwatch enable-insight-rules --rule-names <value>
```
**Potencijalni uticaj**: Konfuzija meÄ‘u operativnim timom, Å¡to dovodi do kaÅ¡njenja u reagovanju na stvarne probleme i nepotrebnih akcija zasnovanih na laÅ¾nim upozorenjima.

### **`cloudwatch:DeleteMetricStream`, `cloudwatch:PutMetricStream`, `cloudwatch:PutMetricData`**

NapadaÄ sa dozvolama **`cloudwatch:DeleteMetricStream`**, `cloudwatch:PutMetricStream` bi mogao da kreira i obriÅ¡e tokove metriÄkih podataka, ugroÅ¾avajuÄ‡i bezbednost, praÄ‡enje i integritet podataka:

- **Kreiranje zlonamernih tokova**: Kreiranje metriÄkih tokova radi slanja osetljivih podataka neovlaÅ¡Ä‡enim odrediÅ¡tima.
- **Manipulacija resursima**: Kreiranje novih metriÄkih tokova sa prekomernim podacima moÅ¾e proizvesti mnogo buke, uzrokujuÄ‡i netaÄna upozorenja, maskiranje pravih problema.
- **PoremeÄ‡aj praÄ‡enja**: Brisanjem metriÄkih tokova, napadaÄi bi poremetili kontinuirani tok podataka za praÄ‡enje. Na taj naÄin, njihove zlonamerne aktivnosti bi bile efikasno sakrivene.

SliÄno, sa dozvolom **`cloudwatch:PutMetricData`**, bilo bi moguÄ‡e dodati podatke u metriÄki tok. To bi moglo dovesti do DoS napada zbog velike koliÄine nepravilnih podataka dodatih, ÄineÄ‡i ga potpuno beskorisnim.
```bash
aws cloudwatch delete-metric-stream --name <value>
aws cloudwatch put-metric-stream --name <value> [--include-filters <value>] [--exclude-filters <value>] --firehose-arn <value> --role-arn <value> --output-format <value>
aws cloudwatch put-metric-data --namespace <value> [--metric-data <value>] [--metric-name <value>] [--timestamp <value>] [--unit <value>] [--value <value>] [--dimensions <value>]
```
Primer dodavanja podataka koji odgovaraju 70% iskoriÅ¡Ä‡enja CPU-a na odreÄ‘enoj EC2 instanci:
```bash
aws cloudwatch put-metric-data --namespace "AWS/EC2" --metric-name "CPUUtilization" --value 70 --unit "Percent" --dimensions "InstanceId=i-0123456789abcdefg"
```
**Potencijalni uticaj**: Prekid u protoku podataka za praÄ‡enje, utiÄuÄ‡i na otkrivanje anomalija i incidenata, manipulaciju resursima i poveÄ‡anje troÅ¡kova zbog stvaranja prekomernih tokova metrika.

### **`cloudwatch:StopMetricStreams`,Â `cloudwatch:StartMetricStreams`**

NapadaÄ bi kontrolisao protok pogoÄ‘enih tokova metriÄkih podataka (svaki tok podataka ako nema ograniÄenja resursa). Sa dozvolom **`cloudwatch:StopMetricStreams`**, napadaÄi bi mogli sakriti svoje zlonamerne aktivnosti zaustavljanjem kritiÄnih tokova metrika.
```bash
aws cloudwatch stop-metric-streams --names <value>
aws cloudwatch start-metric-streams --names <value>
```
**Potencijalni uticaj**: Prekid u protoku podataka za praÄ‡enje, utiÄuÄ‡i na otkrivanje anomalija i incidenata.

### **`cloudwatch:TagResource`,Â `cloudwatch:UntagResource`**

NapadaÄ bi mogao da doda, izmeni ili ukloni oznake sa CloudWatch resursa (trenutno samo alarma i pravila Contributor Insights). Ovo bi moglo da poremeti politike kontrole pristupa vaÅ¡e organizacije zasnovane na oznakama.
```bash
aws cloudwatch tag-resource --resource-arn <value> --tags <value>
aws cloudwatch untag-resource --resource-arn <value> --tag-keys <value>
```
**Potencijalni uticaj**: PoremecÌaj politika kontrole pristupa zasnovanih na oznakama.

## Reference

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazoncloudwatch.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazoncloudwatch.html)
* [https://docs.aws.amazon.com/es_es/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html#Metric](https://docs.aws.amazon.com/es_es/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html#Metric)

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
