# AWS - GuardDuty Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## GuardDuty

Secondo la [**documentazione**](https://aws.amazon.com/guardduty/features/): GuardDuty combina **apprendimento automatico, rilevamento di anomalie, monitoraggio della rete e scoperta di file dannosi**, utilizzando sia AWS che fonti di terze parti leader del settore per aiutare a proteggere i carichi di lavoro e i dati su AWS. GuardDuty √® in grado di analizzare decine di miliardi di eventi provenienti da pi√π fonti di dati AWS, come i log degli eventi di AWS CloudTrail, i log di flusso di Amazon Virtual Private Cloud (VPC), i log di audit e di sistema di Amazon Elastic Kubernetes Service (EKS) e i log delle query DNS.

Amazon GuardDuty **identifica attivit√† insolite all'interno dei tuoi account**, analizza la **rilevanza di sicurezza** dell'attivit√† e fornisce il **contesto** in cui √® stata invocata. Questo consente a un risponditore di determinare se deve dedicare tempo a ulteriori indagini.

Gli avvisi **appaiono nella console di GuardDuty (90 giorni)** e negli eventi di CloudWatch.

{% hint style="warning" %}
Quando un utente **disabilita GuardDuty**, smetter√† di monitorare il tuo ambiente AWS e non generer√† nuovi risultati, e i **risultati esistenti andranno persi**.\
Se lo fermi semplicemente, i risultati esistenti rimarranno.
{% endhint %}

### Esempio di Risultati

* **Riconoscimento**: Attivit√† che suggerisce riconoscimento da parte di un attaccante, come **attivit√† API insolite**, tentativi di **accesso** al database sospetti, **scansione delle porte** intra-VPC, modelli insoliti di richieste di accesso fallite o probing di porte non bloccate da un IP noto come malevolo.
* **Compromissione dell'istanza**: Attivit√† che indica una compromissione dell'istanza, come **mining di criptovalute, attivit√† di comando e controllo (C\&C) di backdoor**, malware che utilizza algoritmi di generazione di domini (DGA), attivit√† di negazione del servizio in uscita, volume di traffico di rete **insolitamente alto**, protocolli di rete insoliti, comunicazione dell'istanza in uscita con un IP noto come malevolo, credenziali temporanee di Amazon EC2 utilizzate da un indirizzo IP esterno e esfiltrazione di dati tramite DNS.
* **Compromissione dell'account**: Modelli comuni indicativi di compromissione dell'account includono chiamate API da una geolocalizzazione insolita o proxy di anonimizzazione, tentativi di disabilitare il logging di AWS CloudTrail, modifiche che indeboliscono la politica della password dell'account, lanci di istanze o infrastrutture insolite, distribuzioni di infrastruttura in una regione insolita, furto di credenziali, attivit√† di accesso al database sospette e chiamate API da indirizzi IP noti come malevoli.
* **Compromissione del bucket**: Attivit√† che indica una compromissione del bucket, come modelli di accesso ai dati sospetti che indicano un uso improprio delle credenziali, attivit√† API di Amazon S3 insolite da un host remoto, accesso non autorizzato a S3 da indirizzi IP noti come malevoli e chiamate API per recuperare dati nei bucket S3 da un utente senza una storia precedente di accesso al bucket o invocato da una posizione insolita. Amazon GuardDuty monitora e analizza continuamente gli eventi di dati S3 di AWS CloudTrail (ad es. GetObject, ListObjects, DeleteObject) per rilevare attivit√† sospette in tutti i tuoi bucket Amazon S3.

<details>

<summary>Informazioni sui Risultati</summary>

Riepilogo dei risultati:

* Tipo di risultato
* Gravit√†: 7-8.9 Alta, 4-6.9 Media, 01-3.9 Bassa
* Regione
* ID account
* ID risorsa
* Tempo di rilevamento
* Quale lista di minacce √® stata utilizzata

Il corpo ha queste informazioni:

* Risorsa interessata
* Azione
* Attore: Indirizzo IP, porta e dominio
* Informazioni aggiuntive

</details>

### Tutti i Risultati

Accedi a un elenco di tutti i risultati di GuardDuty in: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-active.html)

### Multi Account

#### Per Invito

Puoi **invitare altri account** a un diverso account AWS GuardDuty in modo che **ogni account sia monitorato dallo stesso GuardDuty**. L'account principale deve invitare gli account membri e poi il rappresentante dell'account membro deve accettare l'invito.

#### Via Organizzazione

Puoi designare qualsiasi account all'interno dell'organizzazione come **amministratore delegato di GuardDuty**. Solo l'account di gestione dell'organizzazione pu√≤ designare un amministratore delegato.

Un account che viene designato come amministratore delegato diventa un account amministratore di GuardDuty, ha GuardDuty abilitato automaticamente nella regione AWS designata e ha anche il **permesso di abilitare e gestire GuardDuty per tutti gli account nell'organizzazione all'interno di quella regione**. Gli altri account nell'organizzazione possono essere visualizzati e aggiunti come account membri di GuardDuty associati a questo account amministratore delegato.

## Enumerazione

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Bypass di GuardDuty

### Linee Guida Generali

Cerca di scoprire il maggior numero possibile di informazioni sul comportamento delle credenziali che intendi utilizzare:

* Orari in cui viene utilizzato
* Localit√†
* User Agents / Servizi (Potrebbe essere utilizzato da awscli, webconsole, lambda...)
* Permessi utilizzati regolarmente

Con queste informazioni, ricrea il maggior numero possibile dello stesso scenario per utilizzare l'accesso:

* Se √® un **utente o un ruolo accessibile da un utente**, cerca di utilizzarlo nelle stesse ore, dalla stessa geolocalizzazione (anche lo stesso ISP e IP se possibile)
* Se √® un **ruolo utilizzato da un servizio**, crea lo stesso servizio nella stessa regione e utilizzalo da l√¨ negli stessi intervalli di tempo
* Cerca sempre di utilizzare gli **stessi permessi** che questo principale ha utilizzato
* Se hai bisogno di **utilizzare altri permessi o abusare di un permesso** (ad esempio, scaricare 1.000.000 di file di log di cloudtrail) fallo **lentamente** e con il **minimo numero di interazioni** con AWS (awscli a volte chiama diverse API di lettura prima di quella di scrittura)

### Rompere GuardDuty

#### `guardduty:UpdateDetector`

Con questo permesso potresti disabilitare GuardDuty per evitare di attivare avvisi.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Gli attaccanti con questo permesso hanno la capacit√† di **utilizzare filtri per l'archiviazione automatica** delle scoperte:

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Gli attaccanti con i privilegi precedenti potrebbero modificare la [**lista IP fidata**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_upload-lists.html) di GuardDuty aggiungendo il proprio indirizzo IP e evitare di generare avvisi.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Gli attaccanti potrebbero rimuovere la destinazione per prevenire gli avvisi:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Eliminare questa destinazione di pubblicazione **non influenzer√† la generazione o la visibilit√† dei risultati all'interno della console di GuardDuty**. GuardDuty continuer√† ad analizzare gli eventi nel tuo ambiente AWS, identificare comportamenti sospetti o inaspettati e generare risultati.
{% endhint %}

### Esempi di bypass di risultati specifici

Nota che ci sono decine di risultati di GuardDuty, tuttavia, **come Red Teamer non tutti influenzeranno te**, e cosa migliore, hai la **documentazione completa di ciascuno di essi** in [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-active.html) quindi dai un'occhiata prima di intraprendere qualsiasi azione per non essere scoperto.

Ecco un paio di esempi di bypass di risultati specifici di GuardDuty:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty rileva le richieste API AWS da strumenti comuni di penetration testing e attiva un [PenTest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#pentest-iam-kalilinux).\
√à rilevato dal **nome dell'agente utente** che viene passato nella richiesta API.\
Pertanto, **modificando l'agente utente** √® possibile impedire a GuardDuty di rilevare l'attacco.

Per prevenire questo puoi cercare nello script `session.py` nel pacchetto `botocore` e modificare l'agente utente, oppure impostare Burp Suite come proxy AWS CLI e cambiare l'agente utente con il MitM o semplicemente utilizzare un OS come Ubuntu, Mac o Windows per prevenire l'attivazione di questo avviso.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Estrarre le credenziali EC2 dal servizio di metadata e **utilizzarle all'esterno** dell'ambiente AWS attiva l'allerta [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). Al contrario, utilizzare queste credenziali dalla tua istanza EC2 attiva l'allerta [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws). Tuttavia, **utilizzare le credenziali su un'altra istanza EC2 compromessa all'interno dello stesso account rimane non rilevato**, senza attivare alcun avviso.

{% hint style="success" %}
Pertanto, **usa le credenziali esfiltrate dall'interno della macchina** in cui le hai trovate per non attivare questo avviso.
{% endhint %}

## Riferimenti

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
Impara e pratica il hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Impara e pratica il hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
