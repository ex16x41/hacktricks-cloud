# AWS - GuardDuty Enum

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Bize katÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi** **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n,** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek.

</details>
{% endhint %}

## GuardDuty

[**belgelere**](https://aws.amazon.com/guardduty/features/) gÃ¶re: GuardDuty, AWS ve sektÃ¶rdeki Ã¶nde gelen Ã¼Ã§Ã¼ncÃ¼ taraf kaynaklarÄ± kullanarak **makine Ã¶ÄŸrenimi, anomali tespiti, aÄŸ izleme ve kÃ¶tÃ¼ amaÃ§lÄ± dosya keÅŸfini** birleÅŸtirir ve AWS Ã¼zerindeki iÅŸ yÃ¼klerini ve verileri korumaya yardÄ±mcÄ± olur. GuardDuty, AWS CloudTrail olay gÃ¼nlÃ¼kleri, Amazon Sanal Ã–zel Bulut (VPC) AkÄ±ÅŸ GÃ¼nlÃ¼kleri, Amazon Elastik Kubernetes Servisi (EKS) denetim ve sistem dÃ¼zeyi gÃ¼nlÃ¼kleri ve DNS sorgu gÃ¼nlÃ¼kleri gibi birden fazla AWS veri kaynaÄŸÄ±nda on milyarlarca olayÄ± analiz etme yeteneÄŸine sahiptir.

Amazon GuardDuty, **hesaplarÄ±nÄ±zda olaÄŸandÄ±ÅŸÄ± etkinlikleri tanÄ±mlar**, etkinliÄŸin **gÃ¼venlik Ã¶nemini** analiz eder ve hangi **baÄŸlamda** tetiklendiÄŸini verir. Bu, bir yanÄ±tlayÄ±cÄ±nÄ±n daha fazla araÅŸtÄ±rmaya zaman harcayÄ±p harcamayacaÄŸÄ±na karar vermesine olanak tanÄ±r.

UyarÄ±lar **GuardDuty konsolunda (90 gÃ¼n)** ve CloudWatch OlaylarÄ±nda gÃ¶rÃ¼nÃ¼r.

{% hint style="warning" %}
Bir kullanÄ±cÄ± **GuardDuty'yi devre dÄ±ÅŸÄ± bÄ±raktÄ±ÄŸÄ±nda**, AWS ortamÄ±nÄ±zÄ± izlemeyi durdurur ve hiÃ§ yeni bulgu Ã¼retmez, ayrÄ±ca **mevcut bulgular kaybolur**.\
Sadece durdurursanÄ±z, mevcut bulgular kalÄ±r.
{% endhint %}

### Bulgular Ã–rneÄŸi

* **KeÅŸif**: Bir saldÄ±rgan tarafÄ±ndan keÅŸif Ã¶neren etkinlikler, Ã¶rneÄŸin **olaÄŸandÄ±ÅŸÄ± API etkinliÄŸi**, ÅŸÃ¼pheli veritabanÄ± **giriÅŸ** giriÅŸimleri, intra-VPC **port taramasÄ±**, olaÄŸandÄ±ÅŸÄ± baÅŸarÄ±sÄ±z giriÅŸ isteÄŸi desenleri veya bilinen kÃ¶tÃ¼ IP'den engellenmemiÅŸ port taramasÄ±.
* **Ã–rnek ihlali**: Bir Ã¶rnek ihlalini gÃ¶steren etkinlikler, Ã¶rneÄŸin **kripto para madenciliÄŸi, arka kapÄ± komut ve kontrol (C\&C)** etkinliÄŸi, alan adÄ± Ã¼retim algoritmalarÄ± (DGA) kullanan kÃ¶tÃ¼ amaÃ§lÄ± yazÄ±lÄ±mlar, outbound hizmet reddi etkinliÄŸi, olaÄŸandÄ±ÅŸÄ± **yÃ¼ksek aÄŸ** trafiÄŸi hacmi, olaÄŸandÄ±ÅŸÄ± aÄŸ protokolleri, bilinen kÃ¶tÃ¼ niyetli bir IP ile outbound Ã¶rnek iletiÅŸimi, dÄ±ÅŸ bir IP adresi tarafÄ±ndan kullanÄ±lan geÃ§ici Amazon EC2 kimlik bilgileri ve DNS kullanarak veri sÄ±zdÄ±rma.
* **Hesap ihlali**: Hesap ihlalini gÃ¶steren yaygÄ±n desenler, olaÄŸandÄ±ÅŸÄ± bir coÄŸrafi konumdan veya anonimleÅŸtirme proxy'sinden API Ã§aÄŸrÄ±larÄ±, AWS CloudTrail gÃ¼nlÃ¼klerini devre dÄ±ÅŸÄ± bÄ±rakma giriÅŸimleri, hesap ÅŸifre politikalarÄ±nÄ± zayÄ±flatan deÄŸiÅŸiklikler, olaÄŸandÄ±ÅŸÄ± Ã¶rnek veya altyapÄ± baÅŸlatmalarÄ±, olaÄŸandÄ±ÅŸÄ± bir bÃ¶lgede altyapÄ± daÄŸÄ±tÄ±mlarÄ±, kimlik bilgisi hÄ±rsÄ±zlÄ±ÄŸÄ±, ÅŸÃ¼pheli veritabanÄ± giriÅŸ etkinliÄŸi ve bilinen kÃ¶tÃ¼ niyetli IP adreslerinden API Ã§aÄŸrÄ±larÄ±.
* **Kova ihlali**: Kimlik bilgisi kÃ¶tÃ¼ye kullanÄ±mÄ±nÄ± gÃ¶steren ÅŸÃ¼pheli veri eriÅŸim desenleri, uzak bir hosttan olaÄŸandÄ±ÅŸÄ± Amazon S3 API etkinliÄŸi, bilinen kÃ¶tÃ¼ niyetli IP adreslerinden yetkisiz S3 eriÅŸimi ve daha Ã¶nce kova eriÅŸim geÃ§miÅŸi olmayan bir kullanÄ±cÄ±dan veya olaÄŸandÄ±ÅŸÄ± bir yerden tetiklenen S3 kovalarÄ±ndaki verileri almak iÃ§in API Ã§aÄŸrÄ±larÄ± gibi bir kova ihlalini gÃ¶steren etkinlikler. Amazon GuardDuty, tÃ¼m Amazon S3 kovalarÄ±nÄ±zda ÅŸÃ¼pheli etkinlikleri tespit etmek iÃ§in AWS CloudTrail S3 veri olaylarÄ±nÄ± (Ã¶rneÄŸin, GetObject, ListObjects, DeleteObject) sÃ¼rekli olarak izler ve analiz eder.

<details>

<summary>Bulgu Bilgisi</summary>

Bulgu Ã¶zeti:

* Bulgu tÃ¼rÃ¼
* Ciddiyet: 7-8.9 YÃ¼ksek, 4-6.9 Orta, 01-3.9 DÃ¼ÅŸÃ¼k
* BÃ¶lge
* Hesap ID
* Kaynak ID
* Tespit zamanÄ±
* Hangi tehdit listesinin kullanÄ±ldÄ±ÄŸÄ±

GÃ¶vdede bu bilgiler vardÄ±r:

* Etkilenen kaynak
* Eylem
* AktÃ¶r: IP adresi, port ve alan adÄ±
* Ek Bilgi

</details>

### TÃ¼m Bulgular

TÃ¼m GuardDuty bulgularÄ±nÄ±n listesini eriÅŸin: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Ã‡oklu Hesaplar

#### Davetle

DiÄŸer hesaplarÄ± farklÄ± bir AWS GuardDuty hesabÄ±na **davet edebilirsiniz**, bÃ¶ylece **her hesap aynÄ± GuardDuty'den izlenir**. Ana hesap, Ã¼ye hesaplarÄ± davet etmelidir ve ardÄ±ndan Ã¼ye hesabÄ±n temsilcisi daveti kabul etmelidir.

#### Organizasyon Ãœzerinden

Organizasyondaki herhangi bir hesabÄ± **GuardDuty delege yÃ¶neticisi** olarak belirleyebilirsiniz. Sadece organizasyon yÃ¶netim hesabÄ± bir delege yÃ¶neticisi atayabilir.

Delege yÃ¶neticisi olarak belirlenen bir hesap, GuardDuty yÃ¶neticisi hesabÄ± haline gelir, belirlenen AWS BÃ¶lgesinde GuardDuty otomatik olarak etkinleÅŸtirilir ve ayrÄ±ca o BÃ¶lgedeki organizasyondaki tÃ¼m hesaplar iÃ§in GuardDuty'yi etkinleÅŸtirme ve yÃ¶netme **izinine** sahip olur. Organizasyondaki diÄŸer hesaplar, bu delege yÃ¶neticisi hesabÄ±yla iliÅŸkili GuardDuty Ã¼ye hesaplarÄ± olarak gÃ¶rÃ¼ntÃ¼lenebilir ve eklenebilir.

## Enumeration

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty Bypass

### Genel Rehberlik

KullanacaÄŸÄ±nÄ±z kimlik bilgileri hakkÄ±nda mÃ¼mkÃ¼n olduÄŸunca fazla bilgi edinmeye Ã§alÄ±ÅŸÄ±n:

* KullanÄ±m zamanlarÄ±
* Lokasyonlar
* KullanÄ±cÄ± AjanlarÄ± / Hizmetler (awscli, webconsole, lambda gibi kullanÄ±labilir...)
* DÃ¼zenli olarak kullanÄ±lan izinler

Bu bilgilerle, eriÅŸimi kullanmak iÃ§in mÃ¼mkÃ¼n olduÄŸunca aynÄ± senaryoyu yeniden oluÅŸturun:

* EÄŸer bu bir **kullanÄ±cÄ± veya bir kullanÄ±cÄ± tarafÄ±ndan eriÅŸilen bir rol** ise, aynÄ± saatlerde, aynÄ± coÄŸrafi konumdan (mÃ¼mkÃ¼nse aynÄ± ISP ve IP ile) kullanmaya Ã§alÄ±ÅŸÄ±n
* EÄŸer bu bir **hizmet tarafÄ±ndan kullanÄ±lan bir rol** ise, aynÄ± bÃ¶lgede aynÄ± hizmeti oluÅŸturun ve oradan aynÄ± zaman dilimlerinde kullanÄ±n
* Bu prensibin kullandÄ±ÄŸÄ± **aynÄ± izinleri** kullanmaya her zaman Ã§alÄ±ÅŸÄ±n
* EÄŸer **baÅŸka izinler kullanmanÄ±z veya bir izni kÃ¶tÃ¼ye kullanmanÄ±z** gerekiyorsa (Ã¶rneÄŸin, 1.000.000 cloudtrail gÃ¼nlÃ¼k dosyasÄ± indirmek) bunu **yavaÅŸÃ§a** ve AWS ile **minimum etkileÅŸim** ile yapÄ±n (awscli bazen yazma iÅŸleminden Ã¶nce birkaÃ§ okuma API'sini Ã§aÄŸÄ±rÄ±r)

### GuardDuty'yi KÄ±rma

#### `guardduty:UpdateDetector`

Bu izinle, uyarÄ±larÄ± tetiklememek iÃ§in GuardDuty'yi devre dÄ±ÅŸÄ± bÄ±rakabilirsiniz.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Bu izne sahip saldÄ±rganlar, bulgularÄ±n otomatik olarak **arÅŸivlenmesi iÃ§in filtreler kullanma** yeteneÄŸine sahiptir:

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Ã–nceki yetkilere sahip saldÄ±rganlar, GuardDuty'nin [**GÃ¼venilir IP listesine**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) kendi IP adreslerini ekleyerek bunu deÄŸiÅŸtirebilir ve uyarÄ± oluÅŸturmaktan kaÃ§Ä±nabilirler.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

SaldÄ±rganlar, uyarÄ±larÄ±n Ã¶nlenmesi iÃ§in hedefi kaldÄ±rabilir: 

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Bu yayÄ±n hedefini silmek, **GuardDuty konsolundaki bulgularÄ±n oluÅŸturulmasÄ±nÄ± veya gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ etkilemeyecektir**. GuardDuty, AWS ortamÄ±nÄ±zdaki olaylarÄ± analiz etmeye, ÅŸÃ¼pheli veya beklenmedik davranÄ±ÅŸlarÄ± tanÄ±mlamaya ve bulgular Ã¼retmeye devam edecektir.
{% endhint %}

### Belirli BulgularÄ±n Atlatma Ã–rnekleri

GuardDuty bulgularÄ±nÄ±n onlarca olduÄŸunu unutmayÄ±n, ancak **KÄ±rmÄ±zÄ± Ekip Ã¼yesi olarak bunlarÄ±n hepsi sizi etkilemeyecek** ve daha da iyisi, **her birinin tam belgelerine sahipsiniz** [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) bu yÃ¼zden herhangi bir iÅŸlem yapmadan Ã¶nce gÃ¶z atÄ±n, yakalanmamak iÃ§in.

Ä°ÅŸte belirli GuardDuty bulgularÄ±nÄ±n atlatma Ã¶rneklerinden birkaÃ§Ä±:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty, yaygÄ±n penetrasyon test araÃ§larÄ±ndan gelen AWS API isteklerini tespit eder ve [PenTest Bulgusu](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) tetikler.\
Bu, API isteÄŸinde iletilen **kullanÄ±cÄ± ajanÄ± adÄ±** ile tespit edilir.\
Bu nedenle, **kullanÄ±cÄ± ajanÄ±nÄ± deÄŸiÅŸtirmek**, GuardDuty'nin saldÄ±rÄ±yÄ± tespit etmesini Ã¶nlemek mÃ¼mkÃ¼ndÃ¼r.

Bunu Ã¶nlemek iÃ§in `botocore` paketindeki `session.py` dosyasÄ±nÄ± arayabilir ve kullanÄ±cÄ± ajanÄ±nÄ± deÄŸiÅŸtirebilir veya Burp Suite'i AWS CLI proxy'si olarak ayarlayÄ±p kullanÄ±cÄ± ajanÄ±nÄ± MitM ile deÄŸiÅŸtirebilir ya da sadece Ubuntu, Mac veya Windows gibi bir iÅŸletim sistemi kullanarak bu uyarÄ±nÄ±n tetiklenmesini Ã¶nleyebilirsiniz.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

EC2 kimlik bilgilerini metadata hizmetinden Ã§Ä±karmak ve **bunlarÄ± AWS ortamÄ±nÄ±n dÄ±ÅŸÄ±nda kullanmak**, [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) uyarÄ±sÄ±nÄ± tetikler. Tersine, bu kimlik bilgilerini EC2 Ã¶rneÄŸinizden kullanmak, [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) uyarÄ±sÄ±nÄ± tetikler. Ancak, **kimlik bilgilerini aynÄ± hesap iÃ§indeki baÅŸka bir ele geÃ§irilmiÅŸ EC2 Ã¶rneÄŸinde kullanmak tespit edilmez**, herhangi bir uyarÄ± oluÅŸturmaz.

{% hint style="success" %}
Bu nedenle, **bulduÄŸunuz makinenin iÃ§inden sÄ±zdÄ±rÄ±lan kimlik bilgilerini kullanÄ±n** ki bu uyarÄ±yÄ± tetiklemesin.
{% endhint %}

## Referanslar

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
