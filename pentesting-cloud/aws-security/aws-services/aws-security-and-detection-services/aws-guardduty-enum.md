# AWS - GuardDuty Enum

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## GuardDuty

Prema [**dokumentaciji**](https://aws.amazon.com/guardduty/features/): GuardDuty kombinuje **maÅ¡insko uÄenje, detekciju anomalija, nadgledanje mreÅ¾e i otkrivanje zlonamernih fajlova**, koristeÄ‡i kako AWS tako i vodeÄ‡e izvore treÄ‡ih strana kako bi pomogao u zaÅ¡titi radnih optereÄ‡enja i podataka na AWS-u. GuardDuty je sposoban da analizira desetine milijardi dogaÄ‘aja sa viÅ¡e AWS izvora podataka, kao Å¡to su AWS CloudTrail evidencije dogaÄ‘aja, Amazon Virtual Private Cloud (VPC) Flow Logs, Amazon Elastic Kubernetes Service (EKS) revizije i sistemske evidencije, i DNS upiti.

Amazon GuardDuty **identifikuje neobiÄnu aktivnost unutar vaÅ¡ih naloga**, analizira **bezbednosnu relevantnost** aktivnosti i pruÅ¾a **kontekst** u kojem je pozvana. To omoguÄ‡ava odgovornom licu da odredi da li treba da potroÅ¡i vreme na dalje istraÅ¾ivanje.

Upozorenja **se pojavljuju u GuardDuty konzoli (90 dana)** i CloudWatch dogaÄ‘ajima.

{% hint style="warning" %}
Kada korisnik **onemoguÄ‡i GuardDuty**, prestaje da nadgleda vaÅ¡e AWS okruÅ¾enje i neÄ‡e generisati nove nalaze uopÅ¡te, a **postojeÄ‡i nalazi Ä‡e biti izgubljeni**.\
Ako ga samo zaustavite, postojeÄ‡i nalazi Ä‡e ostati.
{% endhint %}

### Primeri Nalaza

* **Rekognosciranje**: Aktivnost koja sugeriÅ¡e rekognosciranje od strane napadaÄa, poput **neobiÄne API aktivnosti**, sumnjivih pokuÅ¡aja **prijavljivanja** na bazu podataka, intra-VPC **skeniranja portova**, neobiÄnih obrazaca neuspelih zahteva za prijavljivanje ili probiranja otvorenih portova sa poznate loÅ¡e IP adrese.
* **Kompromitovanje instance**: Aktivnost koja ukazuje na kompromitovanje instance, poput **rudarenja kriptovaluta, komande za daljinsko upravljanje (C\&C)** aktivnosti, malvera koji koristi algoritme za generisanje domena (DGA), odlazne aktivnosti odbijanja usluge, neuobiÄajeno **visokog saobraÄ‡aja na mreÅ¾i**, neobiÄnih mreÅ¾nih protokola, odlazne komunikacije instance sa poznatom zlonamernom IP adresom, privremeno koriÅ¡Ä‡enje Amazon EC2 akreditiva od strane spoljne IP adrese i eksfiltracija podataka koriÅ¡Ä‡enjem DNS-a.
* **Kompromitovanje naloga**: UobiÄajeni obrasci koji ukazuju na kompromitovanje naloga ukljuÄuju API pozive sa neobiÄne geolokacije ili anonimizujuÄ‡eg proksija, pokuÅ¡aje onemoguÄ‡avanja AWS CloudTrail logovanja, promene koje oslabljuju politiku lozinke naloga, neuobiÄajene instance ili lansiranja infrastrukture, implementacije infrastrukture u neuobiÄajenoj regiji, kraÄ‘u akreditiva, sumnjivu aktivnost prijavljivanja na bazu podataka i API pozive sa poznatih zlonamernih IP adresa.
* **Kompromitovanje kante**: Aktivnost koja ukazuje na kompromitovanje kante, poput sumnjivih obrazaca pristupa podacima koji ukazuju na zloupotrebu akreditiva, neobiÄne Amazon S3 API aktivnosti sa udaljenog hosta, neovlaÅ¡Ä‡enog pristupa S3 sa poznatih zlonamernih IP adresa i API poziva za povlaÄenje podataka iz S3 kanti od strane korisnika bez prethodne istorije pristupa kanti ili pozvanih sa neuobiÄajene lokacije. Amazon GuardDuty kontinuirano nadgleda i analizira AWS CloudTrail S3 dogaÄ‘aje (npr. GetObject, ListObjects, DeleteObject) kako bi otkrio sumnjivu aktivnost Å¡irom svih vaÅ¡ih Amazon S3 kanti.

<details>

<summary>Informacije o Nalazima</summary>

SaÅ¾etak nalaza:

* Tip nalaza
* Ozbiljnost: 7-8.9 Visoka, 4-6.9 Srednja, 01-3.9 Niska
* Region
* ID naloga
* ID resursa
* Vreme otkrivanja
* Koja lista pretnji je koriÅ¡Ä‡ena

Telo sadrÅ¾i ove informacije:

* PogoÄ‘eni resurs
* Akcija
* Akter: IP adresa, port i domen
* Dodatne informacije

</details>

### Svi Nalazi

Pristupite listi svih nalaza GuardDuty-a na: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### ViÅ¡estruki Nalozi

#### Pozivom

MoÅ¾ete **pozvati druge naloge** u drugi AWS GuardDuty nalog tako da **svaki nalog bude nadgledan iz istog GuardDuty-a**. Glavni nalog mora pozvati naloge Älanove, a zatim predstavnik naloga Älana mora prihvatiti poziv.

#### Preko Organizacije

MoÅ¾ete odrediti bilo koji nalog unutar organizacije da bude **delegirani administrator GuardDuty-a**. Samo glavni nalog organizacije moÅ¾e odrediti delegiranog administratora.

Nalog koji bude odreÄ‘en kao delegirani administrator postaje administratorski nalog GuardDuty-a, automatski ima omoguÄ‡en GuardDuty u odreÄ‘enom AWS regionu, i takoÄ‘e ima **dozvolu da omoguÄ‡i i upravlja GuardDuty-om za sve naloge u organizaciji unutar tog regiona**. Ostali nalozi u organizaciji mogu biti pregledani i dodati kao Älanski nalozi GuardDuty-a povezani sa ovim delegiranim administratorskim nalogom.

## Enumeracija

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Bypass GuardDuty-a

### OpÅ¡te smernice

PokuÅ¡ajte da saznate Å¡to viÅ¡e informacija o ponaÅ¡anju akreditacija koje Ä‡ete koristiti:

* Vremena kada se koristi
* Lokacije
* KorisniÄki agenti / Servisi (MoÅ¾e se koristiti iz awscli, web konzole, lambda...)
* Dozvole koje se redovno koriste

Sa ovim informacijama, rekreirajte Å¡to je viÅ¡e moguÄ‡e isti scenario za koriÅ¡Ä‡enje pristupa:

* Ako je to **korisnik ili uloga kojoj pristupa korisnik**, pokuÅ¡ajte da je koristite u istim satima, sa iste geolokacije (Äak i isti ISP i IP ako je moguÄ‡e)
* Ako je to **uloga koju koristi servis**, kreirajte isti servis u istom regionu i koristite ga odande u istim vremenskim intervalima
* Uvek pokuÅ¡ajte da koristite **iste dozvole** koje je ovaj princip koristio
* Ako trebate da **koristite druge dozvole ili zloupotrebite dozvolu** (na primer, preuzmite 1.000.000 cloudtrail datoteka sa logovima) uradite to **sporo** i sa **minimalnom koliÄinom interakcija** sa AWS-om (awscli ponekad poziva nekoliko Äitanja API-ja pre pisanja)

### ObilaÅ¾enje GuardDuty-a

#### `guardduty:UpdateDetector`

Sa ovom dozvolom moÅ¾ete onemoguÄ‡iti GuardDuty kako biste izbegli pokretanje alarma.
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
#### `guardduty:CreateFilter`

NapadaÄi sa ovlaÅ¡Ä‡enjem imaju moguÄ‡nost da **koriste filtere za automatsko** arhiviranje nalaza:
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

NapadaÄi sa prethodnim privilegijama mogu da modifikuju GuardDuty-ovu [**listu pouzdanih IP adresa**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) dodavanjem svoje IP adrese i izbegavanjem generisanja upozorenja.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

NapadaÄi bi mogli ukloniti odrediÅ¡te kako bi spreÄili upozorenja:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Brisanje ovog odrediÅ¡ta objavljivanja **neÄ‡e uticati na generisanje ili vidljivost nalaza unutar GuardDuty konzole**. GuardDuty Ä‡e nastaviti da analizira dogaÄ‘aje u vaÅ¡em AWS okruÅ¾enju, identifikuje sumnjivo ili neoÄekivano ponaÅ¡anje i generiÅ¡e nalaze.
{% endhint %}

### Primeri zaobilaÅ¾enja specifiÄnih nalaza

Imajte na umu da postoji desetine nalaza GuardDuty-a, meÄ‘utim, **kao Red Teamer neÄ‡e vas sve to pogoditi**, a Å¡to je joÅ¡ bolje, imate **potpunu dokumentaciju za svaki od njih** na [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) pa pogledajte pre nego Å¡to preduzmete bilo kakvu akciju da ne biste bili uhvaÄ‡eni.

Evo nekoliko primera zaobilaÅ¾enja specifiÄnih nalaza GuardDuty-a:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty detektuje AWS API zahteve iz uobiÄajenih alata za testiranje proboja i pokreÄ‡e [PenTest nalaz](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Detektuje se po **imeni korisniÄkog agenta** koji se prosleÄ‘uje u API zahtevu.\
Stoga, **modifikovanjem korisniÄkog agenta** moguÄ‡e je spreÄiti GuardDuty da detektuje napad.

Da biste to spreÄili, moÅ¾ete pretraÅ¾iti skriptu `session.py` u paketu `botocore` i modifikovati korisniÄkog agenta, ili postaviti Burp Suite kao AWS CLI proxy i promeniti korisniÄki agent pomoÄ‡u MitM-a ili jednostavno koristiti OS poput Ubuntu-a, Mac-a ili Windows-a da biste spreÄili da se ovaj alarm aktivira.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

IzvlaÄenje EC2 akreditiva iz usluge metapodataka i **njihovo koriÅ¡Ä‡enje van** AWS okruÅ¾enja aktivira upozorenje [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). Nasuprot tome, koriÅ¡Ä‡enje ovih akreditiva sa vaÅ¡e EC2 instance pokreÄ‡e upozorenje [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws). Ipak, **koriÅ¡Ä‡enje akreditiva na drugoj kompromitovanoj EC2 instanci unutar istog naloga ostaje neprimeÄ‡eno**, ne izazivajuÄ‡i nikakvo upozorenje.

{% hint style="success" %}
Stoga, **koristite izvaÄ‘ene akreditive unutar maÅ¡ine** gde ste ih pronaÅ¡li kako ne biste aktivirali ovaj alarm.
{% endhint %}

## Reference

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
