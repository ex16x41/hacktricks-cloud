# AWS - GuardDuty Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## GuardDuty

Prema [**dokumentaciji**](https://aws.amazon.com/guardduty/features/): GuardDuty kombinuje **ma코insko u캜enje, detekciju anomalija, pra캖enje mre쬰 i otkrivanje zlonamernih datoteka**, koriste캖i kako AWS, tako i vode캖e izvore tre캖ih strana kako bi pomogao u za코titi radnih optere캖enja i podataka na AWS-u. GuardDuty je sposoban da analizira desetine milijardi doga캠aja iz vi코e AWS izvora podataka, kao 코to su AWS CloudTrail logovi doga캠aja, Amazon Virtual Private Cloud (VPC) Flow logovi, Amazon Elastic Kubernetes Service (EKS) revizijski i sistemski logovi, i DNS upiti.

Amazon GuardDuty **identifikuje neobi캜nu aktivnost unutar va코ih naloga**, analizira **bezbednosnu relevantnost** aktivnosti i daje **kontekst** u kojem je aktivnost pokrenuta. Ovo omogu캖ava odgovara캜u da odredi da li treba da potro코i vreme na dalju istragu.

Upozorenja **se pojavljuju u GuardDuty konzoli (90 dana)** i CloudWatch doga캠ajima.

{% hint style="warning" %}
Kada korisnik **onemogu캖i GuardDuty**, prestaje da prati va코e AWS okru쬰nje i ne캖e generisati nove nalaze, a **postoje캖i nalazi 캖e biti izgubljeni**.\
Ako ga samo zaustavite, postoje캖i nalazi 캖e ostati.
{% endhint %}

### Primer Nalaza

* **Reconnaissance**: Aktivnost koja sugeri코e izvi캠anje od strane napada캜a, kao 코to su **neobi캜ne API aktivnosti**, sumnjivi poku코aji **prijavljivanja** na bazu podataka, intra-VPC **skeniranje portova**, neobi캜ni obrasci neuspe코nih zahteva za prijavljivanje, ili neblokirano ispitivanje portova sa poznate lo코e IP adrese.
* **Kompromitovanje instance**: Aktivnost koja ukazuje na kompromitovanje instance, kao 코to su **rudarenje kriptovaluta, backdoor komanda i kontrola (C\&C)** aktivnosti, zlonameran softver koji koristi algoritme generisanja domena (DGA), outbound aktivnosti uskra캖ivanja usluge, neobi캜no **visok** obim mre쬹og saobra캖aja, neobi캜ni mre쬹i protokoli, outbound komunikacija instance sa poznatom zlonamernom IP adresom, privremene Amazon EC2 akreditivi kori코캖eni od strane spoljne IP adrese, i eksfiltracija podataka kori코캖enjem DNS-a.
* **Kompromitovanje naloga**: Uobi캜ajeni obrasci koji ukazuju na kompromitovanje naloga uklju캜uju API pozive iz neobi캜ne geolokacije ili anonimnog proksija, poku코aje onemogu캖avanja AWS CloudTrail logovanja, promene koje oslabljuju politiku lozinki naloga, neobi캜ne instance ili lansiranja infrastrukture, implementacije infrastrukture u neobi캜noj regiji, kra캠u akreditiva, sumnjivu aktivnost prijavljivanja na bazu podataka, i API pozive iz poznatih zlonamernih IP adresa.
* **Kompromitovanje bucket-a**: Aktivnost koja ukazuje na kompromitovanje bucket-a, kao 코to su sumnjivi obrasci pristupa podacima koji ukazuju na zloupotrebu akreditiva, neobi캜ne Amazon S3 API aktivnosti sa udaljenog hosta, neovla코캖en pristup S3-u sa poznatih zlonamernih IP adresa, i API pozivi za preuzimanje podataka iz S3 bucket-a od korisnika bez prethodne istorije pristupa bucket-u ili pokrenutih iz neobi캜ne lokacije. Amazon GuardDuty kontinuirano prati i analizira AWS CloudTrail S3 doga캠aje podataka (npr. GetObject, ListObjects, DeleteObject) kako bi otkrio sumnjivu aktivnost 코irom svih va코ih Amazon S3 bucket-a.

<details>

<summary>Informacije o nalazima</summary>

Sa쬰tak nalaza:

* Tip nalaza
* Ozbiljnost: 7-8.9 Visoka, 4-6.9 Srednja, 01-3.9 Niska
* Regija
* ID naloga
* ID resursa
* Vreme detekcije
* Koja je lista pretnji kori코캖ena

Telo sadr쬴 ove informacije:

* Pogo캠eni resurs
* Akcija
* Akter: IP adresa, port i domen
* Dodatne informacije

</details>

### Svi Nalazi

Pristupite listi svih GuardDuty nalaza na: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Vi코e Nalozi

#### Po Pozivu

Mo쬰te **pozvati druge naloge** u razli캜it AWS GuardDuty nalog tako da **svaki nalog bude pra캖en iz istog GuardDuty**. Glavni nalog mora pozvati 캜lanove naloga, a zatim predstavnik 캜lanskog naloga mora prihvatiti poziv.

#### Putem Organizacije

Mo쬰te odrediti bilo koji nalog unutar organizacije da bude **delegirani administrator GuardDuty**. Samo nalog za upravljanje organizacijom mo쬰 odrediti delegiranog administratora.

Nalog koji se odredi kao delegirani administrator postaje nalog administratora GuardDuty, automatski ima omogu캖enu GuardDuty u odre캠enoj AWS regiji, i tako캠e ima **dozvolu da omogu캖i i upravlja GuardDuty za sve naloge u organizaciji unutar te regije**. Ostali nalozi u organizaciji mogu se pregledati i dodati kao 캜lanovi GuardDuty povezani sa ovim delegiranim administratorskim nalogom.

## Enumeration

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty Bypass

### General Guidance

Poku코ajte da saznate 코to je mogu캖e vi코e o pona코anju kredencijala koje 캖ete koristiti:

* Vremena kada su kori코캖eni
* Lokacije
* User Agents / Usluge (Mo쬰 se koristiti iz awscli, webconsole, lambda...)
* Dozvole koje se redovno koriste

Sa ovom informacijom, rekreirajte 코to je mogu캖e vi코e istog scenarija za kori코캖enje pristupa:

* Ako je to **korisnik ili uloga kojoj pristupa korisnik**, poku코ajte da je koristite u istim satima, iz iste geolokacije (캜ak i istog ISP-a i IP-a ako je mogu캖e)
* Ako je to **uloga koju koristi usluga**, kreirajte istu uslugu u istoj regiji i koristite je odatle u istim vremenskim intervalima
* Uvek poku코ajte da koristite **iste dozvole** koje je ovaj princip koristio
* Ako treba da **koristite druge dozvole ili zloupotrebite dozvolu** (na primer, preuzmite 1.000.000 cloudtrail log fajlova) radite to **polako** i sa **minimalnim brojem interakcija** sa AWS-om (awscli ponekad poziva nekoliko read API-ja pre write API-ja)

### Breaking GuardDuty

#### `guardduty:UpdateDetector`

Sa ovom dozvolom mogli biste da onemogu캖ite GuardDuty kako biste izbegli aktiviranje alarma.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Napada캜i sa ovom dozvolom imaju mogu캖nost da **koriste filtre za automatsko** arhiviranje nalaza:

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Napada캜i sa prethodnim privilegijama mogli bi da modifikuju GuardDuty-ovu [**Listu pouzdanih IP adresa**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) dodaju캖i svoju IP adresu i izbegavaju캖i generisanje upozorenja.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Napada캜i bi mogli ukloniti odredi코te kako bi spre캜ili upozorenje:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Brisanje ove destinacije za objavljivanje **ne캖e uticati na generisanje ili vidljivost nalaza unutar GuardDuty konzole**. GuardDuty 캖e nastaviti da analizira doga캠aje u va코em AWS okru쬰nju, identifikuje sumnjivo ili neo캜ekivano pona코anje i generi코e nalaze.
{% endhint %}

### Primeri zaobila쬰nja specifi캜nih nalaza

Imajte na umu da postoji desetine GuardDuty nalaza, me캠utim, **kao Red Teamer, ne캖ete biti pogo캠eni svim njima**, a 코to je bolje, imate **potpunu dokumentaciju o svakom od njih** u [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) pa pogledajte pre nego 코to preduzmete bilo kakvu akciju da ne biste bili uhva캖eni.

Evo nekoliko primera specifi캜nih zaobila쬰nja GuardDuty nalaza:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty detektuje AWS API zahteve iz uobi캜ajenih alata za penetraciono testiranje i aktivira [PenTest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Detektuje se po **nazivu korisni캜kog agenta** koji se prosle캠uje u API zahtevu.\
Stoga, **modifikovanjem korisni캜kog agenta** mogu캖e je spre캜iti GuardDuty da detektuje napad.

Da biste to spre캜ili, mo쬰te pretra쬴ti skriptu `session.py` u `botocore` paketu i modifikovati korisni캜ki agent, ili postaviti Burp Suite kao AWS CLI proxy i promeniti korisni캜ki agent sa MitM ili jednostavno koristiti OS kao 코to su Ubuntu, Mac ili Windows, 코to 캖e spre캜iti aktiviranje ovog upozorenja.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Ekstrakcija EC2 kredencijala iz metadata servisa i **kori코캖enje njih van** AWS okru쬰nja aktivira [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) upozorenje. Nasuprot tome, kori코캖enje ovih kredencijala sa va코e EC2 instance aktivira [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) upozorenje. Ipak, **kori코캖enje kredencijala na drugoj kompromitovanoj EC2 instanci unutar istog naloga prolazi neprime캖eno**, ne podi쬿캖i nikakvo upozorenje.

{% hint style="success" %}
Stoga, **koristite exfiltrirane kredencijale iznutra ma코ine** gde ste ih prona코li da ne biste aktivirali ovo upozorenje.
{% endhint %}

## Reference

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr코ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
