# AWS - GuardDuty Enum

{% hint style="success" %}
Naucz si i wicz Hacking AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}

## GuardDuty

Zgodnie z [**dokumentacj**](https://aws.amazon.com/guardduty/features/): GuardDuty czy **uczenie maszynowe, wykrywanie anomalii, monitorowanie sieci i odkrywanie zoliwych plik贸w**, korzystajc zar贸wno z 藕r贸de AWS, jak i wiodcych na rynku 藕r贸de zewntrznych, aby pom贸c w ochronie obci偶e pracy i danych w AWS. GuardDuty jest zdolny do analizowania dziesitek miliard贸w zdarze z wielu 藕r贸de danych AWS, takich jak dzienniki zdarze AWS CloudTrail, dzienniki przepyw贸w Amazon Virtual Private Cloud (VPC), audyt i dzienniki systemowe Amazon Elastic Kubernetes Service (EKS) oraz dzienniki zapyta DNS.

Amazon GuardDuty **identyfikuje nietypow aktywno w Twoich kontach**, analizuje **istotno z punktu widzenia bezpieczestwa** tej aktywnoci i podaje **kontekst**, w jakim zostaa wywoana. Pozwala to osobie reagujcej okreli, czy powinna powici czas na dalsze dochodzenie.

Alerty **pojawiaj si w konsoli GuardDuty (90 dni)** i zdarzeniach CloudWatch.

{% hint style="warning" %}
Gdy u偶ytkownik **wycza GuardDuty**, przestaje monitorowa rodowisko AWS i nie generuje 偶adnych nowych ustale, a **istniejce ustalenia zostan utracone**.\
Jeli po prostu go zatrzymasz, istniejce ustalenia pozostan.
{% endhint %}

### Przykad Ustale

* **Rozpoznanie**: Aktywno sugerujca rozpoznanie przez atakujcego, takie jak **nietypowa aktywno API**, podejrzane pr贸by **logowania do bazy danych**, skanowanie port贸w wewntrz-VPC, nietypowe wzorce nieudanych pr贸b logowania, lub sondowanie port贸w znanego zego IP.
* **Zagro偶enie instancji**: Aktywno wskazujca na zagro偶enie instancji, takie jak **kopanie kryptowalut, dziaanie backdoor command and control (C\&C)**, zoliwe oprogramowanie u偶ywajce algorytm贸w generowania domen (DGA), wychodzca aktywno odmowy usugi, nietypowy **wysoki ruch** sieciowy, nietypowe protokoy sieciowe, wychodzca komunikacja instancji z znanym zoliwym IP, tymczasowe powiadczenia Amazon EC2 u偶ywane przez zewntrzny adres IP, i wyciek danych za pomoc DNS.
* **Zagro偶enie konta**: Powszechne wzorce wskazujce na zagro偶enie konta obejmuj wywoania API z nietypowej geolokalizacji lub anonimizujcego proxy, pr贸by wyczenia rejestrowania AWS CloudTrail, zmiany osabiajce polityk hasa konta, nietypowe uruchomienia instancji lub infrastruktury, wdro偶enia infrastruktury w nietypowym regionie, kradzie偶 powiadcze, podejrzana aktywno logowania do bazy danych, i wywoania API z znanych zoliwych adres贸w IP.
* **Zagro偶enie kubeka**: Aktywno wskazujca na zagro偶enie kubeka, takie jak podejrzane wzorce dostpu do danych wskazujce na nadu偶ycie powiadcze, nietypowa aktywno API Amazon S3 z hosta zdalnego, nieautoryzowany dostp do S3 z znanych zoliwych adres贸w IP, i wywoania API do pobierania danych z kubek贸w S3 przez u偶ytkownika bez wczeniejszej historii dostpu do kubeka lub wywoane z nietypowej lokalizacji. Amazon GuardDuty cigle monitoruje i analizuje zdarzenia danych S3 AWS CloudTrail (np. GetObject, ListObjects, DeleteObject) w celu wykrycia podejrzanej aktywnoci we wszystkich kubekach Amazon S3.

<details>

<summary>Informacje o Ustaleniach</summary>

Podsumowanie ustale:

* Typ ustalenia
* Powaga: 7-8.9 Wysoka, 4-6.9 rednia, 01-3.9 Niska
* Region
* ID konta
* ID zasobu
* Czas wykrycia
* Kt贸ra lista zagro偶e zostaa u偶yta

Tre zawiera te informacje:

* Dotknity zas贸b
* Dziaanie
* Aktor: Adres IP, port i domena
* Dodatkowe informacje

</details>

### Wszystkie Ustalenia

Dostp do listy wszystkich ustale GuardDuty: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Wielokrotne Konta

#### Poprzez Zaproszenie

Mo偶esz **zaprosi inne konta** do innego konta AWS GuardDuty, aby **ka偶de konto byo monitorowane z tego samego GuardDuty**. Konto g贸wne musi zaprosi konta czonkowskie, a nastpnie przedstawiciel konta czonkowskiego musi zaakceptowa zaproszenie.

#### Poprzez Organizacj

Mo偶esz wyznaczy dowolne konto w organizacji jako **administratora delegowanego GuardDuty**. Tylko konto zarzdzajce organizacj mo偶e wyznaczy administratora delegowanego.

Konto, kt贸re zostaje wyznaczone jako administrator delegowany, staje si kontem administratora GuardDuty, ma automatycznie wczony GuardDuty w wyznaczonym regionie AWS, a tak偶e ma **uprawnienie do wczania i zarzdzania GuardDuty dla wszystkich kont w organizacji w tym regionie**. Pozostae konta w organizacji mog by przegldane i dodawane jako konta czonkowskie GuardDuty powizane z tym kontem administratora delegowanego.

## Wyliczanie

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty Ominicie

### Og贸lne Wskaz贸wki

Spr贸buj dowiedzie si jak najwicej o zachowaniu powiadcze, kt贸rych zamierzasz u偶y:

* Czasy, w kt贸rych s u偶ywane
* Lokalizacje
* Agenty u偶ytkownika / Usugi (Mo偶e by u偶ywane z awscli, konsoli internetowej, lambdy...)
* Regularnie u偶ywane uprawnienia

Majc te informacje, odtw贸rz jak najdokadniej ten sam scenariusz, aby uzyska dostp:

* Jeli jest to **u偶ytkownik lub rola dostpna przez u偶ytkownika**, spr贸buj u偶y jej o tych samych godzinach, z tej samej geolokacji (nawet tego samego dostawcy usug internetowych i adresu IP, jeli to mo偶liwe)
* Jeli jest to **rola u偶ywana przez usug**, utw贸rz t sam usug w tej samej regionie i u偶yj jej stamtd w tych samych przedziaach czasowych
* Zawsze spr贸buj u偶y **tych samych uprawnie**, jakie u偶ywa ten podmiot
* Jeli musisz **u偶y innych uprawnie lub nadu偶y uprawnienia** (na przykad, pobierz 1.000.000 plik贸w dziennika cloudtrail) zr贸b to **powoli** i z **minimaln iloci interakcji** z AWS (awscli czasami wywouje kilka interfejs贸w API do odczytu przed zapisaniem)

### Zamanie GuardDuty

#### `guardduty:UpdateDetector`

Z tym uprawnieniem mo偶esz wyczy GuardDuty, aby unikn wyzwalania alert贸w.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
#### `guardduty:CreateFilter`

Atakujcy posiadajcy to uprawnienie maj mo偶liwo **u偶ywania filtr贸w do automatycznego** archiwizowania wynik贸w:
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Atakujcy posiadajcy wczeniejsze uprawnienia mog modyfikowa [**list zaufanych adres贸w IP**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) GuardDuty, dodajc sw贸j adres IP i unikajc generowania alert贸w.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Atakujcy mog usun cel, aby zapobiec generowaniu alert贸w:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Usunicie tego miejsca publikacji **nie wpynie na generowanie ani widoczno wynik贸w w konsoli GuardDuty**. GuardDuty bdzie nadal analizowa zdarzenia w Twoim rodowisku AWS, identyfikowa podejrzane lub nieoczekiwane zachowanie i generowa wyniki.
{% endhint %}

### Konkretne Przykady Ominicia Wynik贸w

Zauwa偶, 偶e istnieje wiele wynik贸w GuardDuty, jednak **nie wszystkie z nich bd miay wpyw na Ciebie jako Red Teamera**, a co lepsze, masz **pen dokumentacj ka偶dego z nich** pod adresem [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html), wic zerknij przed podjciem jakiejkolwiek akcji, aby nie zosta wykrytym.

Oto kilka przykad贸w omijania konkretnych wynik贸w GuardDuty:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty wykrywa 偶dania interfejsu API AWS z popularnych narzdzi do test贸w penetracyjnych i wywouje wynik [PenTest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Jest to wykrywane przez **nazw agenta u偶ytkownika**, kt贸ra jest przekazywana w 偶daniu interfejsu API.\
Dlatego **zmieniajc agenta u偶ytkownika** mo偶na zapobiec wykryciu ataku przez GuardDuty.

Aby temu zapobiec, mo偶esz wyszuka skrypt `session.py` w pakiecie `botocore` i zmodyfikowa agenta u偶ytkownika, lub ustawi Burp Suite jako proxy AWS CLI i zmieni nag贸wek user-agent za pomoc MitM, lub po prostu u偶y systemu operacyjnego takiego jak Ubuntu, Mac lub Windows, aby zapobiec wywoaniu tego alertu.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Wydobycie powiadcze EC2 z usugi metadanych i **wykorzystanie ich poza** rodowiskiem AWS aktywuje alert [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). Natomiast wykorzystanie tych powiadcze z Twojej instancji EC2 wywouje alert [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws). Jednak **u偶ycie powiadcze na innej skompromitowanej instancji EC2 w ramach tego samego konta pozostaje niewykryte**, nie wywoujc 偶adnego alertu.

{% hint style="success" %}
Dlatego **u偶ywaj wydobytych powiadcze wewntrz maszyny**, gdzie je znalaze, aby nie wywoywa tego alertu.
{% endhint %}

## Odnoniki

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub grupy [**telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}
