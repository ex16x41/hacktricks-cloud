# AWS - GuardDuty Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## GuardDuty

Prema [**dokumentaciji**](https://aws.amazon.com/guardduty/features/): GuardDuty kombinuje **maÅ¡insko uÄenje, detekciju anomalija, praÄ‡enje mreÅ¾e i otkrivanje zlonamernih datoteka**, koristeÄ‡i kako AWS, tako i vodeÄ‡e izvore treÄ‡ih strana kako bi pomogao u zaÅ¡titi radnih optereÄ‡enja i podataka na AWS-u. GuardDuty je sposoban da analizira desetine milijardi dogaÄ‘aja iz viÅ¡e AWS izvora podataka, kao Å¡to su AWS CloudTrail logovi dogaÄ‘aja, Amazon Virtual Private Cloud (VPC) Flow Logs, Amazon Elastic Kubernetes Service (EKS) revizijski i sistemski logovi, i DNS upiti.

Amazon GuardDuty **identifikuje neobiÄnu aktivnost unutar vaÅ¡ih naloga**, analizira **bezbednosnu relevantnost** aktivnosti i daje **kontekst** u kojem je aktivnost pokrenuta. Ovo omoguÄ‡ava odgovaraÄu da odredi da li treba da potroÅ¡i vreme na dalju istragu.

Upozorenja **se pojavljuju u GuardDuty konzoli (90 dana)** i CloudWatch dogaÄ‘ajima.

{% hint style="warning" %}
Kada korisnik **onemoguÄ‡i GuardDuty**, prestaje da prati vaÅ¡e AWS okruÅ¾enje i neÄ‡e generisati nove nalaze, a **postojeÄ‡i nalazi Ä‡e biti izgubljeni**.\
Ako ga samo zaustavite, postojeÄ‡i nalazi Ä‡e ostati.
{% endhint %}

### Primer Nalaza

* **Reconnaissance**: Aktivnost koja sugeriÅ¡e izviÄ‘anje od strane napadaÄa, kao Å¡to su **neobiÄne API aktivnosti**, sumnjivi pokuÅ¡aji **prijavljivanja** u bazu podataka, intra-VPC **skeniranje portova**, neobiÄni obrasci neuspeÅ¡nih zahteva za prijavljivanje, ili neblokirani portovi sa poznate loÅ¡e IP adrese.
* **Kompromitovanje instance**: Aktivnost koja ukazuje na kompromitovanje instance, kao Å¡to su **rudarenje kriptovaluta, backdoor komanda i kontrola (C\&C)**, zlonamerni softver koji koristi algoritme generisanja domena (DGA), outbound aktivnosti uskraÄ‡ivanja usluge, neobiÄno **visok** obim mreÅ¾nog saobraÄ‡aja, neobiÄni mreÅ¾ni protokoli, outbound komunikacija instance sa poznatom zlonamernom IP adresom, privremene Amazon EC2 akreditivi koriÅ¡Ä‡eni od strane spoljne IP adrese, i exfiltracija podataka koriÅ¡Ä‡enjem DNS-a.
* **Kompromitovanje naloga**: UobiÄajeni obrasci koji ukazuju na kompromitovanje naloga ukljuÄuju API pozive iz neobiÄne geolokacije ili anonimnog proksija, pokuÅ¡aje onemoguÄ‡avanja AWS CloudTrail logovanja, promene koje oslabljuju politiku lozinki naloga, neobiÄne instance ili lansiranja infrastrukture, implementacije infrastrukture u neobiÄnoj regiji, kraÄ‘u akreditiva, sumnjive aktivnosti prijavljivanja u bazu podataka, i API pozive iz poznatih zlonamernih IP adresa.
* **Kompromitovanje bucket-a**: Aktivnost koja ukazuje na kompromitovanje bucket-a, kao Å¡to su sumnjivi obrasci pristupa podacima koji ukazuju na zloupotrebu akreditiva, neobiÄne Amazon S3 API aktivnosti sa udaljenog hosta, neovlaÅ¡Ä‡en pristup S3-u sa poznatih zlonamernih IP adresa, i API pozivi za preuzimanje podataka iz S3 bucket-a od korisnika bez prethodne istorije pristupa bucket-u ili pokrenutih iz neobiÄne lokacije. Amazon GuardDuty kontinuirano prati i analizira AWS CloudTrail S3 dogaÄ‘aje podataka (npr. GetObject, ListObjects, DeleteObject) kako bi otkrio sumnjivu aktivnost Å¡irom svih vaÅ¡ih Amazon S3 bucket-a.

<details>

<summary>Informacije o nalazima</summary>

SaÅ¾etak nalaza:

* Tip nalaza
* Ozbiljnost: 7-8.9 Visoka, 4-6.9 Srednja, 01-3.9 Niska
* Regija
* ID naloga
* ID resursa
* Vreme detekcije
* Koja je lista pretnji koriÅ¡Ä‡ena

Telo sadrÅ¾i ove informacije:

* PogoÄ‘eni resurs
* Akcija
* Akter: IP adresa, port i domen
* Dodatne informacije

</details>

### Svi Nalazi

Pristupite listi svih GuardDuty nalaza na: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### ViÅ¡e Naloga

#### Po Pozivu

MoÅ¾ete **pozvati druge naloge** u razliÄit AWS GuardDuty nalog tako da **svaki nalog bude praÄ‡en iz istog GuardDuty**. Glavni nalog mora pozvati Älanove naloga, a zatim predstavnik Älanskog naloga mora prihvatiti poziv.

#### Putem Organizacije

MoÅ¾ete odrediti bilo koji nalog unutar organizacije da bude **delegirani administrator GuardDuty**. Samo nalog za upravljanje organizacijom moÅ¾e odrediti delegiranog administratora.

Nalog koji se odredi kao delegirani administrator postaje nalog administratora GuardDuty, automatski ima omoguÄ‡enu GuardDuty u odreÄ‘enoj AWS regiji, i takoÄ‘e ima **dozvolu da omoguÄ‡i i upravlja GuardDuty za sve naloge u organizaciji unutar te regije**. Ostali nalozi u organizaciji mogu se videti i dodati kao Älanovi GuardDuty povezani sa ovim delegiranim administratorskim nalogom.

## Enumeration

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty Bypass

### General Guidance

PokuÅ¡ajte da saznate Å¡to je moguÄ‡e viÅ¡e o ponaÅ¡anju kredencijala koje Ä‡ete koristiti:

* Vremena kada se koriste
* Lokacije
* User Agents / Servisi (MoÅ¾e se koristiti iz awscli, webconsole, lambda...)
* Dozvole koje se redovno koriste

Sa ovom informacijom, rekreirajte Å¡to je moguÄ‡e viÅ¡e istog scenarija za koriÅ¡Ä‡enje pristupa:

* Ako je to **korisnik ili uloga kojoj pristupa korisnik**, pokuÅ¡ajte da je koristite u istim satima, iz iste geolokacije (Äak i istog ISP-a i IP-a ako je moguÄ‡e)
* Ako je to **uloga koju koristi servis**, kreirajte isti servis u istoj regiji i koristite ga odatle u istim vremenskim intervalima
* Uvek pokuÅ¡ajte da koristite **iste dozvole** koje je ovaj princip koristio
* Ako treba da **koristite druge dozvole ili zloupotrebite dozvolu** (na primer, preuzmite 1.000.000 cloudtrail log fajlova) radite to **polako** i sa **minimalnim brojem interakcija** sa AWS-om (awscli ponekad poziva nekoliko read API-ja pre write API-ja)

### Breaking GuardDuty

#### `guardduty:UpdateDetector`

Sa ovom dozvolom mogli biste da onemoguÄ‡ite GuardDuty kako biste izbegli aktiviranje alarma.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

NapadaÄi sa ovom dozvolom imaju moguÄ‡nost da **koriste filtre za automatsko** arhiviranje nalaza:

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

NapadaÄi sa prethodnim privilegijama mogli bi da modifikuju GuardDuty-ovu [**Listu pouzdanih IP adresa**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) dodajuÄ‡i svoju IP adresu i izbegavajuÄ‡i generisanje upozorenja.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
#### `guardduty:DeletePublishingDestination`

NapadaÄi bi mogli ukloniti odrediÅ¡te kako bi spreÄili upozorenja:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Brisanje ove destinacije za objavljivanje **neÄ‡e uticati na generisanje ili vidljivost nalaza unutar GuardDuty konzole**. GuardDuty Ä‡e nastaviti da analizira dogaÄ‘aje u vaÅ¡em AWS okruÅ¾enju, identifikuje sumnjivo ili neoÄekivano ponaÅ¡anje i generiÅ¡e nalaze.
{% endhint %}

### Primeri zaobilaÅ¾enja specifiÄnih nalaza

Imajte na umu da postoji desetine GuardDuty nalaza, meÄ‘utim, **kao Red Teamer, neÄ‡ete biti pogoÄ‘eni svim njima**, a Å¡to je bolje, imate **potpunu dokumentaciju o svakom od njih** na [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) pa pogledajte pre nego Å¡to preduzmete bilo kakvu akciju da ne biste bili uhvaÄ‡eni.

Evo nekoliko primera specifiÄnih zaobilaÅ¾enja GuardDuty nalaza:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty detektuje AWS API zahteve iz uobiÄajenih alata za penetraciono testiranje i aktivira [PenTest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Detektuje se po **nazivu korisniÄkog agenta** koji se prosleÄ‘uje u API zahtevu.\
Stoga, **modifikovanjem korisniÄkog agenta** moguÄ‡e je spreÄiti GuardDuty da detektuje napad.

Da biste to spreÄili, moÅ¾ete pretraÅ¾iti skriptu `session.py` u `botocore` paketu i modifikovati korisniÄki agent, ili postaviti Burp Suite kao AWS CLI proxy i promeniti korisniÄki agent sa MitM ili jednostavno koristiti OS kao Å¡to su Ubuntu, Mac ili Windows, Å¡to Ä‡e spreÄiti aktiviranje ovog upozorenja.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Ekstrakcija EC2 kredencijala iz metadata servisa i **koriÅ¡Ä‡enje njih van** AWS okruÅ¾enja aktivira [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) upozorenje. Nasuprot tome, koriÅ¡Ä‡enje ovih kredencijala sa vaÅ¡e EC2 instance aktivira [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) upozorenje. Ipak, **koriÅ¡Ä‡enje kredencijala na drugoj kompromitovanoj EC2 instanci unutar istog naloga prolazi neprimeÄ‡eno**, ne podiÅ¾uÄ‡i nikakvo upozorenje.

{% hint style="success" %}
Stoga, **koristite exfiltrirane kredencijale iznutra maÅ¡ine** gde ste ih pronaÅ¡li da ne biste aktivirali ovo upozorenje.
{% endhint %}

## Reference

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
