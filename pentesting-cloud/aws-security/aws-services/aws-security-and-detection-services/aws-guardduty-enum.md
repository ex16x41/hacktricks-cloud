# AWS - GuardDuty Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## GuardDuty

Selon les [**docs**](https://aws.amazon.com/guardduty/features/): GuardDuty combine **l'apprentissage automatique, la d√©tection d'anomalies, la surveillance du r√©seau et la d√©couverte de fichiers malveillants**, en utilisant √† la fois AWS et des sources tierces de premier plan pour aider √† prot√©ger les charges de travail et les donn√©es sur AWS. GuardDuty est capable d'analyser des dizaines de milliards d'√©v√©nements √† travers plusieurs sources de donn√©es AWS, telles que les journaux d'√©v√©nements AWS CloudTrail, les journaux de flux Amazon Virtual Private Cloud (VPC), les journaux d'audit et de syst√®me d'Amazon Elastic Kubernetes Service (EKS), et les journaux de requ√™tes DNS.

Amazon GuardDuty **identifie les activit√©s inhabituelles au sein de vos comptes**, analyse la **pertinence de s√©curit√©** de l'activit√© et fournit le **contexte** dans lequel elle a √©t√© invoqu√©e. Cela permet √† un intervenant de d√©terminer s'il doit consacrer du temps √† une enqu√™te plus approfondie.

Les alertes **apparaissent dans la console GuardDuty (90 jours)** et dans les √©v√©nements CloudWatch.

{% hint style="warning" %}
Lorsque un utilisateur **d√©sactive GuardDuty**, il cessera de surveiller votre environnement AWS et ne g√©n√©rera aucune nouvelle d√©couverte, et les **d√©couvertes existantes seront perdues**.\
Si vous l'arr√™tez simplement, les d√©couvertes existantes resteront.
{% endhint %}

### Exemples de D√©couvertes

* **Reconnaissance**: Activit√© sugg√©rant une reconnaissance par un attaquant, telle que **une activit√© API inhabituelle**, des tentatives de **connexion** √† une base de donn√©es suspectes, un **scan de port** intra-VPC, des mod√®les de requ√™tes de connexion √©chou√©es inhabituels, ou un sondage de port non bloqu√© √† partir d'une IP connue comme malveillante.
* **Compromission d'instance**: Activit√© indiquant une compromission d'instance, telle que **minage de cryptomonnaie, activit√© de commande et de contr√¥le (C\&C)** par porte d√©rob√©e, malware utilisant des algorithmes de g√©n√©ration de domaine (DGA), activit√© de d√©ni de service sortant, volume de trafic **r√©seau** anormalement **√©lev√©**, protocoles r√©seau inhabituels, communication sortante d'instance avec une IP malveillante connue, des identifiants Amazon EC2 temporaires utilis√©s par une adresse IP externe, et exfiltration de donn√©es utilisant DNS.
* **Compromission de compte**: Les mod√®les courants indicatifs de compromission de compte incluent des appels API provenant d'une g√©olocalisation inhabituelle ou d'un proxy anonymisant, des tentatives de d√©sactiver la journalisation AWS CloudTrail, des changements qui affaiblissent la politique de mot de passe du compte, des lancements d'instances ou d'infrastructures inhabituels, des d√©ploiements d'infrastructure dans une r√©gion inhabituelle, le vol d'identifiants, une activit√© de connexion √† la base de donn√©es suspecte, et des appels API provenant d'adresses IP malveillantes connues.
* **Compromission de bucket**: Activit√© indiquant une compromission de bucket, telle que des mod√®les d'acc√®s aux donn√©es suspects indiquant un usage abusif des identifiants, une activit√© API Amazon S3 inhabituelle provenant d'un h√¥te distant, un acc√®s S3 non autoris√© √† partir d'adresses IP malveillantes connues, et des appels API pour r√©cup√©rer des donn√©es dans des buckets S3 d'un utilisateur sans historique pr√©alable d'acc√®s au bucket ou invoqu√©s depuis un emplacement inhabituel. Amazon GuardDuty surveille et analyse en continu les √©v√©nements de donn√©es S3 d'AWS CloudTrail (par exemple, GetObject, ListObjects, DeleteObject) pour d√©tecter des activit√©s suspectes √† travers tous vos buckets Amazon S3.

<details>

<summary>Informations sur les D√©couvertes</summary>

R√©sum√© des d√©couvertes:

* Type de d√©couverte
* Gravit√©: 7-8.9 √âlev√©, 4-6.9 Moyen, 01-3.9 Faible
* R√©gion
* ID de compte
* ID de ressource
* Heure de d√©tection
* Quelle liste de menaces a √©t√© utilis√©e

Le corps contient ces informations:

* Ressource affect√©e
* Action
* Acteur: Adresse IP, port et domaine
* Informations suppl√©mentaires

</details>

### Toutes les D√©couvertes

Acc√©dez √† une liste de toutes les d√©couvertes GuardDuty sur: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Multi Comptes

#### Par Invitation

Vous pouvez **inviter d'autres comptes** √† un compte AWS GuardDuty diff√©rent afin que **chaque compte soit surveill√© depuis le m√™me GuardDuty**. Le compte principal doit inviter les comptes membres et ensuite le repr√©sentant du compte membre doit accepter l'invitation.

#### Via Organisation

Vous pouvez d√©signer n'importe quel compte au sein de l'organisation comme **administrateur d√©l√©gu√© GuardDuty**. Seul le compte de gestion de l'organisation peut d√©signer un administrateur d√©l√©gu√©.

Un compte qui est d√©sign√© comme administrateur d√©l√©gu√© devient un compte administrateur GuardDuty, a GuardDuty activ√© automatiquement dans la r√©gion AWS d√©sign√©e, et a √©galement **la permission d'activer et de g√©rer GuardDuty pour tous les comptes de l'organisation dans cette r√©gion**. Les autres comptes de l'organisation peuvent √™tre visualis√©s et ajout√©s en tant que comptes membres GuardDuty associ√©s √† ce compte administrateur d√©l√©gu√©.

## √ânum√©ration

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Contournement de GuardDuty

### Conseils g√©n√©raux

Essayez de d√©couvrir autant que possible sur le comportement des identifiants que vous allez utiliser :

* Heures d'utilisation
* Lieux
* Agents utilisateurs / Services (Cela pourrait √™tre utilis√© depuis awscli, webconsole, lambda...)
* Permissions r√©guli√®rement utilis√©es

Avec ces informations, recr√©ez autant que possible le m√™me sc√©nario pour utiliser l'acc√®s :

* Si c'est un **utilisateur ou un r√¥le acc√©d√© par un utilisateur**, essayez de l'utiliser aux m√™mes heures, depuis la m√™me g√©olocalisation (m√™me le m√™me FAI et IP si possible)
* Si c'est un **r√¥le utilis√© par un service**, cr√©ez le m√™me service dans la m√™me r√©gion et utilisez-le depuis l√† dans les m√™mes plages horaires
* Essayez toujours d'utiliser les **m√™mes permissions** que ce principal a utilis√©es
* Si vous devez **utiliser d'autres permissions ou abuser d'une permission** (par exemple, t√©l√©charger 1.000.000 de fichiers journaux cloudtrail), faites-le **lentement** et avec le **minimum d'interactions** avec AWS (awscli appelle parfois plusieurs API de lecture avant celle d'√©criture)

### Contournement de GuardDuty

#### `guardduty:UpdateDetector`

Avec cette permission, vous pourriez d√©sactiver GuardDuty pour √©viter de d√©clencher des alertes.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Les attaquants disposant de cette autorisation ont la capacit√© de **utiliser des filtres pour l'archivage automatique** des r√©sultats :

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Les attaquants disposant des privil√®ges pr√©c√©dents pourraient modifier la [**liste IP de confiance**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) de GuardDuty en y ajoutant leur adresse IP et √©viter de g√©n√©rer des alertes.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Les attaquants pourraient supprimer la destination pour emp√™cher les alertes :

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
La suppression de cette destination de publication **n'affectera pas la g√©n√©ration ou la visibilit√© des r√©sultats dans la console GuardDuty**. GuardDuty continuera √† analyser les √©v√©nements dans votre environnement AWS, √† identifier les comportements suspects ou inattendus, et √† g√©n√©rer des r√©sultats.
{% endhint %}

### Exemples de contournement de r√©sultats sp√©cifiques

Notez qu'il existe des dizaines de r√©sultats GuardDuty, cependant, **en tant que Red Teamer, tous ne vous affecteront pas**, et ce qui est mieux, vous avez la **documentation compl√®te de chacun d'eux** sur [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) donc jetez un ≈ìil avant de faire quoi que ce soit pour ne pas vous faire prendre.

Voici quelques exemples de contournement de r√©sultats sp√©cifiques de GuardDuty :

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty d√©tecte les requ√™tes API AWS provenant d'outils de test de p√©n√©tration courants et d√©clenche un [R√©sultat PenTest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Il est d√©tect√© par le **nom de l'agent utilisateur** qui est pass√© dans la requ√™te API.\
Par cons√©quent, **modifier l'agent utilisateur** permet d'emp√™cher GuardDuty de d√©tecter l'attaque.

Pour √©viter cela, vous pouvez rechercher dans le script `session.py` dans le package `botocore` et modifier l'agent utilisateur, ou d√©finir Burp Suite comme proxy AWS CLI et changer l'agent utilisateur avec le MitM ou simplement utiliser un OS comme Ubuntu, Mac ou Windows pour emp√™cher cette alerte de se d√©clencher.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

L'extraction des identifiants EC2 du service de m√©tadonn√©es et **leur utilisation √† l'ext√©rieur** de l'environnement AWS active l'alerte [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). Inversement, l'utilisation de ces identifiants depuis votre instance EC2 d√©clenche l'alerte [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws). Pourtant, **l'utilisation des identifiants sur une autre instance EC2 compromise au sein du m√™me compte passe inaper√ßue**, ne d√©clenchant aucune alerte.

{% hint style="success" %}
Par cons√©quent, **utilisez les identifiants exfiltr√©s depuis l'int√©rieur de la machine** o√π vous les avez trouv√©s pour ne pas d√©clencher cette alerte.
{% endhint %}

## R√©f√©rences

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR au** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
