# AWS - GuardDuty Enum

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## GuardDuty

Laut den [**Docs**](https://aws.amazon.com/guardduty/features/): GuardDuty kombiniert **maschinelles Lernen, Anomalieerkennung, Netzwerk√ºberwachung und Entdeckung b√∂sartiger Dateien**, indem sowohl AWS- als auch branchenf√ºhrende Drittanbieterquellen verwendet werden, um Workloads und Daten auf AWS zu sch√ºtzen. GuardDuty ist in der Lage, Dutzende von Milliarden von Ereignissen √ºber mehrere AWS-Datenquellen zu analysieren, wie z. B. AWS CloudTrail-Ereignisprotokolle, Amazon Virtual Private Cloud (VPC) Flow Logs, Amazon Elastic Kubernetes Service (EKS) Audit- und Systemprotokolle sowie DNS-Abfrageprotokolle.

Amazon GuardDuty **identifiziert ungew√∂hnliche Aktivit√§ten innerhalb Ihrer Konten**, analysiert die **Sicherheitsrelevanz** der Aktivit√§t und gibt den **Kontext** an, in dem sie ausgel√∂st wurde. Dies erm√∂glicht es einem Reaktionsbeauftragten zu bestimmen, ob er Zeit f√ºr weitere Untersuchungen aufwenden sollte.

Alarme **erscheinen in der GuardDuty-Konsole (90 Tage)** und CloudWatch-Ereignissen.

{% hint style="warning" %}
Wenn ein Benutzer **GuardDuty deaktiviert**, wird die √úberwachung Ihrer AWS-Umgebung eingestellt und es werden keine neuen Erkenntnisse mehr generiert, und die **bestehenden Erkenntnisse gehen verloren**.\
Wenn Sie es einfach nur stoppen, bleiben die bestehenden Erkenntnisse erhalten.
{% endhint %}

### Beispiel f√ºr Erkenntnisse

* **Aufkl√§rung**: Aktivit√§ten, die auf eine Aufkl√§rung durch einen Angreifer hindeuten, wie z. B. **ungew√∂hnliche API-Aktivit√§ten**, verd√§chtige Datenbank-**Anmelde**versuche, intra-VPC-**Port-Scans**, ungew√∂hnliche Muster bei fehlgeschlagenen Anmeldeanfragen oder unblockierte Portabfragen von einer bekannten schlechten IP.
* **Instanzkompromittierung**: Aktivit√§ten, die auf eine Instanzkompromittierung hinweisen, wie z. B. **Kryptow√§hrungs-Mining, Backdoor-Befehls- und Kontrollaktivit√§ten (C\&C)**, Malware, die Domain-Generierungsalgorithmen (DGA) verwendet, ausgehende Denial-of-Service-Aktivit√§ten, ungew√∂hnlich **hohe Netzwerk**verkehrsvolumina, ungew√∂hnliche Netzwerkprotokolle, ausgehende Instanzkommunikation mit einer bekannten b√∂sartigen IP, tempor√§re Amazon EC2-Anmeldeinformationen, die von einer externen IP-Adresse verwendet werden, und Datenexfiltration √ºber DNS.
* **Konto-Kompromittierung**: H√§ufige Muster, die auf eine Konto-Kompromittierung hindeuten, umfassen API-Aufrufe von einem ungew√∂hnlichen geografischen Standort oder anonymisierenden Proxy, Versuche, das AWS CloudTrail-Logging zu deaktivieren, √Ñnderungen, die die Passwort-Richtlinie des Kontos schw√§chen, ungew√∂hnliche Instanz- oder Infrastrukturstarts, Infrastrukturbereitstellungen in einer ungew√∂hnlichen Region, Anmeldeinformationen-Diebstahl, verd√§chtige Datenbank-Anmeldeaktivit√§ten und API-Aufrufe von bekannten b√∂sartigen IP-Adressen.
* **Bucket-Kompromittierung**: Aktivit√§ten, die auf eine Bucket-Kompromittierung hinweisen, wie z. B. verd√§chtige Datenzugriffsmuster, die auf einen Missbrauch von Anmeldeinformationen hindeuten, ungew√∂hnliche Amazon S3 API-Aktivit√§ten von einem Remote-Host, unbefugter S3-Zugriff von bekannten b√∂sartigen IP-Adressen und API-Aufrufe zum Abrufen von Daten in S3-Buckets von einem Benutzer ohne vorherige Historie des Zugriffs auf den Bucket oder die von einem ungew√∂hnlichen Standort aus ausgel√∂st wurden. Amazon GuardDuty √ºberwacht und analysiert kontinuierlich AWS CloudTrail S3-Datenereignisse (z. B. GetObject, ListObjects, DeleteObject), um verd√§chtige Aktivit√§ten in all Ihren Amazon S3-Buckets zu erkennen.

<details>

<summary>Erkenntnisinformationen</summary>

Erkenntnissummary:

* Erkenntnistyp
* Schweregrad: 7-8.9 Hoch, 4-6.9 Mittel, 01-3.9 Niedrig
* Region
* Konto-ID
* Ressourcen-ID
* Zeitpunkt der Erkennung
* Welche Bedrohungsliste verwendet wurde

Der K√∂rper enth√§lt diese Informationen:

* Betroffene Ressource
* Aktion
* Akteur: IP-Adresse, Port und Domain
* Zus√§tzliche Informationen

</details>

### Alle Erkenntnisse

Zugriff auf eine Liste aller GuardDuty-Erkenntnisse unter: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Mehrere Konten

#### Nach Einladung

Sie k√∂nnen **andere Konten** zu einem anderen AWS GuardDuty-Konto einladen, sodass **jedes Konto von demselben GuardDuty √ºberwacht wird**. Das Master-Konto muss die Mitgliedskonten einladen, und dann muss der Vertreter des Mitgliedskontos die Einladung annehmen.

#### √úber Organisation

Sie k√∂nnen jedes Konto innerhalb der Organisation als **GuardDuty-Delegierten-Administrator** benennen. Nur das Organisationsverwaltungs-Konto kann einen delegierten Administrator benennen.

Ein Konto, das als delegierter Administrator benannt wird, wird zu einem GuardDuty-Administratorkonto, hat GuardDuty automatisch in der benannten AWS-Region aktiviert und hat auch die **Berechtigung, GuardDuty f√ºr alle Konten in der Organisation innerhalb dieser Region zu aktivieren und zu verwalten**. Die anderen Konten in der Organisation k√∂nnen als GuardDuty-Mitgliedskonten angezeigt und hinzugef√ºgt werden, die mit diesem delegierten Administratorkonto verbunden sind.

## Enumeration

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty Bypass

### Allgemeine Hinweise

Versuchen Sie, so viel wie m√∂glich √ºber das Verhalten der Anmeldeinformationen herauszufinden, die Sie verwenden m√∂chten:

* Zeiten, zu denen sie verwendet werden
* Standorte
* Benutzeragenten / Dienste (Es k√∂nnte von awscli, webconsole, lambda... verwendet werden)
* Regelm√§√üig verwendete Berechtigungen

Mit diesen Informationen rekonstruieren Sie so viel wie m√∂glich dasselbe Szenario, um den Zugriff zu nutzen:

* Wenn es sich um einen **Benutzer oder eine Rolle handelt, auf die ein Benutzer zugreift**, versuchen Sie, es zur gleichen Zeit, von derselben Geolokation (sogar demselben ISP und IP, wenn m√∂glich) zu verwenden
* Wenn es sich um eine **Rolle handelt, die von einem Dienst verwendet wird**, erstellen Sie denselben Dienst in derselben Region und verwenden Sie ihn von dort aus in denselben Zeitbereichen
* Versuchen Sie immer, die **gleichen Berechtigungen** zu verwenden, die dieser Principal verwendet hat
* Wenn Sie **andere Berechtigungen verwenden oder eine Berechtigung missbrauchen** m√ºssen (zum Beispiel, 1.000.000 CloudTrail-Protokolldateien herunterladen), tun Sie dies **langsam** und mit der **minimalen Anzahl von Interaktionen** mit AWS (awscli ruft manchmal mehrere Lese-APIs vor der Schreib-API auf)

### GuardDuty umgehen

#### `guardduty:UpdateDetector`

Mit dieser Berechtigung k√∂nnten Sie GuardDuty deaktivieren, um das Ausl√∂sen von Warnungen zu vermeiden.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Angreifer mit dieser Berechtigung haben die M√∂glichkeit, **Filter f√ºr die automatische** Archivierung von Erkenntnissen zu verwenden:

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Angreifer mit den vorherigen Berechtigungen k√∂nnten die [**Vertrauensw√ºrdige IP-Liste**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) von GuardDuty √§ndern, indem sie ihre IP-Adresse hinzuf√ºgen und so das Generieren von Warnungen vermeiden.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Angreifer k√∂nnten das Ziel entfernen, um Warnungen zu verhindern:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Das L√∂schen dieses Ver√∂ffentlichungsziels wird **keine Auswirkungen auf die Generierung oder Sichtbarkeit von Ergebnissen in der GuardDuty-Konsole haben**. GuardDuty wird weiterhin Ereignisse in Ihrer AWS-Umgebung analysieren, verd√§chtiges oder unerwartetes Verhalten identifizieren und Ergebnisse generieren.
{% endhint %}

### Beispiele f√ºr spezifische Findings-Byp√§sse

Beachten Sie, dass es Dutzende von GuardDuty-Findings gibt, jedoch **werden nicht alle von ihnen Sie als Red Teamer betreffen**, und was noch besser ist, Sie haben die **vollst√§ndige Dokumentation zu jedem von ihnen** unter [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html), also werfen Sie einen Blick darauf, bevor Sie Ma√ünahmen ergreifen, um nicht erwischt zu werden.

Hier sind ein paar Beispiele f√ºr spezifische GuardDuty Findings-Byp√§sse:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty erkennt AWS API-Anfragen von g√§ngigen Penetrationstest-Tools und l√∂st ein [PenTest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) aus.\
Es wird durch den **User-Agent-Namen** erkannt, der in der API-Anfrage √ºbergeben wird.\
Daher ist es **m√∂glich, GuardDuty zu verhindern, den Angriff zu erkennen, indem man den User-Agent √§ndert**.

Um dies zu verhindern, k√∂nnen Sie im Skript `session.py` im `botocore`-Paket nach dem User-Agent suchen und ihn √§ndern oder Burp Suite als AWS CLI-Proxy einrichten und den User-Agent mit MitM √§ndern oder einfach ein Betriebssystem wie Ubuntu, Mac oder Windows verwenden, um zu verhindern, dass dieser Alarm ausgel√∂st wird.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Das Extrahieren von EC2-Anmeldeinformationen aus dem Metadatenservice und **deren Nutzung au√üerhalb** der AWS-Umgebung aktiviert den [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) Alarm. Im Gegensatz dazu l√∂st die Verwendung dieser Anmeldeinformationen von Ihrer EC2-Instanz den [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) Alarm aus. Dennoch **bleibt die Verwendung der Anmeldeinformationen auf einer anderen kompromittierten EC2-Instanz innerhalb desselben Kontos unentdeckt**, ohne einen Alarm auszul√∂sen.

{% hint style="success" %}
Daher **verwenden Sie die exfiltrierten Anmeldeinformationen von innerhalb der Maschine**, in der Sie sie gefunden haben, um diesen Alarm nicht auszul√∂sen.
{% endhint %}

## Referenzen

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
