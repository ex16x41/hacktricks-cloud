# AWS - GuardDuty Enum

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## GuardDuty

Zgodnie z [**dokumentacj**](https://aws.amazon.com/guardduty/features/): GuardDuty czy **uczenie maszynowe, wykrywanie anomalii, monitorowanie sieci i odkrywanie zoliwych plik贸w**, korzystajc zar贸wno z AWS, jak i wiodcych 藕r贸de zewntrznych, aby pom贸c w ochronie obci偶e i danych na AWS. GuardDuty jest w stanie analizowa dziesitki miliard贸w zdarze z wielu 藕r贸de danych AWS, takich jak logi zdarze AWS CloudTrail, logi przepywu Amazon Virtual Private Cloud (VPC), logi audytowe i systemowe Amazon Elastic Kubernetes Service (EKS) oraz logi zapyta DNS.

Amazon GuardDuty **identyfikuje nietypow aktywno w Twoich kontach**, analizuje **znaczenie bezpieczestwa** tej aktywnoci i podaje **kontekst**, w jakim zostaa wywoana. Umo偶liwia to osobie reagujcej okrelenie, czy powinna powici czas na dalsze dochodzenie.

Alerty **pojawiaj si w konsoli GuardDuty (90 dni)** oraz w CloudWatch Events.

{% hint style="warning" %}
Gdy u偶ytkownik **wyczy GuardDuty**, przestanie monitorowa Twoje rodowisko AWS i nie wygeneruje 偶adnych nowych ustale, a **istniejce ustalenia zostan utracone**.\
Jeli po prostu go zatrzymasz, istniejce ustalenia pozostan.
{% endhint %}

### Przykad Ustale

* **Rozpoznanie**: Aktywno sugerujca rozpoznanie przez atakujcego, takie jak **nietypowa aktywno API**, podejrzane pr贸by **logowania** do bazy danych, skanowanie **port贸w** wewntrz VPC, nietypowe wzorce nieudanych pr贸b logowania lub skanowanie port贸w z znanego zego adresu IP.
* **Kompromitacja instancji**: Aktywno wskazujca na kompromitacj instancji, taka jak **kopanie kryptowalut, zoliwe polecenia i kontrola (C\&C)**, zoliwe oprogramowanie wykorzystujce algorytmy generowania domen (DGA), aktywno odmowy usugi wychodzcej, nietypowo **wysoki** wolumen ruchu sieciowego, nietypowe protokoy sieciowe, komunikacja instancji wychodzcej z znanym zoliwym adresem IP, tymczasowe powiadczenia Amazon EC2 u偶ywane przez zewntrzny adres IP oraz eksfiltracja danych przy u偶yciu DNS.
* **Kompromitacja konta**: Typowe wzorce wskazujce na kompromitacj konta obejmuj wywoania API z nietypowej geolokalizacji lub proxy anonimowego, pr贸by wyczenia logowania AWS CloudTrail, zmiany osabiajce polityk hase konta, nietypowe uruchomienia instancji lub infrastruktury, wdro偶enia infrastruktury w nietypowym regionie, kradzie偶 powiadcze, podejrzana aktywno logowania do bazy danych oraz wywoania API z znanych zoliwych adres贸w IP.
* **Kompromitacja koszyka**: Aktywno wskazujca na kompromitacj koszyka, taka jak podejrzane wzorce dostpu do danych wskazujce na nadu偶ycie powiadcze, nietypowa aktywno API Amazon S3 z zdalnego hosta, nieautoryzowany dostp S3 z znanych zoliwych adres贸w IP oraz wywoania API w celu pobrania danych z koszyk贸w S3 od u偶ytkownika bez wczeniejszej historii dostpu do koszyka lub wywoane z nietypowej lokalizacji. Amazon GuardDuty nieprzerwanie monitoruje i analizuje zdarzenia danych S3 AWS CloudTrail (np. GetObject, ListObjects, DeleteObject), aby wykrywa podejrzan aktywno we wszystkich Twoich koszykach Amazon S3.

<details>

<summary>Informacje o Ustaleniach</summary>

Podsumowanie ustale:

* Typ ustalenia
* Powaga: 7-8.9 Wysoka, 4-6.9 rednia, 01-3.9 Niska
* Region
* ID konta
* ID zasobu
* Czas wykrycia
* Kt贸ra lista zagro偶e zostaa u偶yta

Tre zawiera te informacje:

* Zas贸b dotknity
* Akcja
* Aktor: adres IP, port i domena
* Dodatkowe informacje

</details>

### Wszystkie Ustalenia

Uzyskaj dostp do listy wszystkich ustale GuardDuty w: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Wiele Kont

#### Na Zaproszenie

Mo偶esz **zaprosi inne konta** do innego konta AWS GuardDuty, aby **ka偶de konto byo monitorowane z tego samego GuardDuty**. Konto g贸wne musi zaprosi konta czonkowskie, a nastpnie przedstawiciel konta czonkowskiego musi zaakceptowa zaproszenie.

#### Poprzez Organizacj

Mo偶esz wyznaczy dowolne konto w organizacji jako **delegowanego administratora GuardDuty**. Tylko konto zarzdzajce organizacj mo偶e wyznaczy delegowanego administratora.

Konto, kt贸re zostanie wyznaczone jako delegowany administrator, staje si kontem administratora GuardDuty, ma automatycznie wczony GuardDuty w wyznaczonym regionie AWS i ma r贸wnie偶 **uprawnienia do wczania i zarzdzania GuardDuty dla wszystkich kont w organizacji w tym regionie**. Inne konta w organizacji mog by wywietlane i dodawane jako konta czonkowskie GuardDuty zwizane z tym kontem delegowanego administratora.

## Enumeracja

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty Bypass

### General Guidance

Spr贸buj dowiedzie si jak najwicej o zachowaniu powiadcze, kt贸rych zamierzasz u偶y:

* Czas, w kt贸rym s u偶ywane
* Lokalizacje
* User Agents / Usugi (mo偶e by u偶ywane z awscli, webconsole, lambda...)
* Uprawnienia regularnie u偶ywane

Z t informacj, odtw贸rz jak najwicej tego samego scenariusza, aby u偶y dostpu:

* Jeli to jest **u偶ytkownik lub rola dostpna przez u偶ytkownika**, spr贸buj u偶y jej w tych samych godzinach, z tej samej geolokalizacji (nawet tego samego ISP i IP, jeli to mo偶liwe)
* Jeli to jest **rola u偶ywana przez usug**, stw贸rz t sam usug w tym samym regionie i u偶yj jej stamtd w tych samych przedziaach czasowych
* Zawsze staraj si u偶ywa **tych samych uprawnie**, kt贸re ten podmiot u偶ywa
* Jeli musisz **u偶y innych uprawnie lub nadu偶y uprawnienia** (na przykad, pobra 1.000.000 plik贸w dziennika cloudtrail), r贸b to **powoli** i z **minimaln iloci interakcji** z AWS (awscli czasami wywouje kilka API do odczytu przed zapisem)

### Breaking GuardDuty

#### `guardduty:UpdateDetector`

Dziki temu uprawnieniu mo偶esz wyczy GuardDuty, aby unikn wyzwalania alert贸w.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Atakujcy z tym uprawnieniem maj mo偶liwo **stosowania filtr贸w do automatycznego** archiwizowania wynik贸w:

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Napastnicy z wczeniejszymi uprawnieniami mogli modyfikowa [**Zaufan list IP**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) GuardDuty, dodajc do niej sw贸j adres IP i unika generowania alert贸w.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Napastnicy mog usun miejsce docelowe, aby zapobiec powiadomieniom:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Usunicie tego miejsca publikacji **nie wpynie na generowanie ani widoczno ustale w konsoli GuardDuty**. GuardDuty bdzie nadal analizowa zdarzenia w Twoim rodowisku AWS, identyfikowa podejrzane lub nieoczekiwane zachowanie i generowa ustalenia.
{% endhint %}

### Przykady obejcia konkretnych ustale

Zauwa偶, 偶e istnieje dziesitki ustale GuardDuty, jednak **jako Red Teamer nie wszystkie z nich bd miay na Ciebie wpyw**, a co lepsze, masz pen dokumentacj ka偶dego z nich w [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html), wic zapoznaj si z ni przed podjciem jakichkolwiek dziaa, aby nie zosta zapanym.

Oto kilka przykad贸w konkretnych obej ustale GuardDuty:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty wykrywa 偶dania API AWS z popularnych narzdzi do testowania penetracyjnego i uruchamia [ustalenie PenTest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Wykrywa to na podstawie **nazwa agenta u偶ytkownika**, kt贸ra jest przekazywana w 偶daniu API.\
Dlatego **modyfikujc agenta u偶ytkownika**, mo偶na zapobiec wykryciu ataku przez GuardDuty.

Aby temu zapobiec, mo偶esz poszuka w skrypcie `session.py` w pakiecie `botocore` i zmodyfikowa agenta u偶ytkownika, lub ustawi Burp Suite jako proxy AWS CLI i zmieni agenta u偶ytkownika za pomoc MitM lub po prostu u偶y systemu operacyjnego takiego jak Ubuntu, Mac lub Windows, co zapobiegnie uruchomieniu tego alertu.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Ekstrakcja powiadcze EC2 z usugi metadanych i **wykorzystywanie ich na zewntrz** rodowiska AWS aktywuje alert [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). Z kolei wykorzystanie tych powiadcze z instancji EC2 uruchamia alert [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws). Jednak **u偶ycie powiadcze na innej skompromitowanej instancji EC2 w tym samym koncie pozostaje niewykryte**, nie generujc alertu.

{% hint style="success" %}
Dlatego **u偶yj wyekstrahowanych powiadcze z wntrza maszyny**, w kt贸rej je znalaze, aby nie uruchomi tego alertu.
{% endhint %}

## Referencje

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
