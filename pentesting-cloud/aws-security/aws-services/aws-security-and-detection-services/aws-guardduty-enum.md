# AWS - GuardDuty Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## GuardDuty

Seg煤n la [**documentaci贸n**](https://aws.amazon.com/guardduty/features/): GuardDuty combina **aprendizaje autom谩tico, detecci贸n de anomal铆as, monitoreo de red y descubrimiento de archivos maliciosos**, utilizando tanto AWS como fuentes de terceros l铆deres en la industria para ayudar a proteger cargas de trabajo y datos en AWS. GuardDuty es capaz de analizar decenas de miles de millones de eventos a trav茅s de m煤ltiples fuentes de datos de AWS, como registros de eventos de AWS CloudTrail, registros de flujo de Amazon Virtual Private Cloud (VPC), registros de auditor铆a y de nivel de sistema de Amazon Elastic Kubernetes Service (EKS), y registros de consultas DNS.

Amazon GuardDuty **identifica actividades inusuales dentro de tus cuentas**, analiza la **relevancia de seguridad** de la actividad y proporciona el **contexto** en el que fue invocada. Esto permite a un respondedor determinar si debe dedicar tiempo a una investigaci贸n adicional.

Las alertas **aparecen en la consola de GuardDuty (90 d铆as)** y en CloudWatch Events.

{% hint style="warning" %}
Cuando un usuario **desactiva GuardDuty**, dejar谩 de monitorear tu entorno de AWS y no generar谩 nuevos hallazgos, y los **hallazgos existentes se perder谩n**.\
Si solo lo detienes, los hallazgos existentes permanecer谩n.
{% endhint %}

### Ejemplo de Hallazgos

* **Reconocimiento**: Actividad que sugiere reconocimiento por parte de un atacante, como **actividad inusual de API**, intentos de **inicio de sesi贸n** en bases de datos sospechosos, **escaneo de puertos** intra-VPC, patrones inusuales de solicitudes de inicio de sesi贸n fallidas, o sondeo de puertos no bloqueados desde una IP conocida como mala.
* **Compromiso de instancia**: Actividad que indica un compromiso de instancia, como **miner铆a de criptomonedas, actividad de comando y control (C\&C)** de puerta trasera, malware utilizando algoritmos de generaci贸n de dominios (DGA), actividad de denegaci贸n de servicio saliente, volumen de tr谩fico de red **inusualmente alto**, protocolos de red inusuales, comunicaci贸n de instancia saliente con una IP maliciosa conocida, credenciales temporales de Amazon EC2 utilizadas por una direcci贸n IP externa, y exfiltraci贸n de datos utilizando DNS.
* **Compromiso de cuenta**: Patrones comunes indicativos de compromiso de cuenta incluyen llamadas a la API desde una geolocalizaci贸n inusual o proxy de anonimizaci贸n, intentos de desactivar el registro de AWS CloudTrail, cambios que debilitan la pol铆tica de contrase帽as de la cuenta, lanzamientos inusuales de instancias o infraestructura, implementaciones de infraestructura en una regi贸n inusual, robo de credenciales, actividad sospechosa de inicio de sesi贸n en bases de datos, y llamadas a la API desde direcciones IP maliciosas conocidas.
* **Compromiso de bucket**: Actividad que indica un compromiso de bucket, como patrones de acceso a datos sospechosos que indican uso indebido de credenciales, actividad inusual de API de Amazon S3 desde un host remoto, acceso no autorizado a S3 desde direcciones IP maliciosas conocidas, y llamadas a la API para recuperar datos en buckets de S3 desde un usuario sin historial previo de acceso al bucket o invocadas desde una ubicaci贸n inusual. Amazon GuardDuty monitorea y analiza continuamente los eventos de datos de S3 de AWS CloudTrail (por ejemplo, GetObject, ListObjects, DeleteObject) para detectar actividad sospechosa en todos tus buckets de Amazon S3.

<details>

<summary>Informaci贸n de Hallazgos</summary>

Resumen del hallazgo:

* Tipo de hallazgo
* Severidad: 7-8.9 Alto, 4-6.9 Medio, 01-3.9 Bajo
* Regi贸n
* ID de cuenta
* ID de recurso
* Hora de detecci贸n
* Qu茅 lista de amenazas se utiliz贸

El cuerpo tiene esta informaci贸n:

* Recurso afectado
* Acci贸n
* Actor: Direcci贸n IP, puerto y dominio
* Informaci贸n adicional

</details>

### Todos los Hallazgos

Accede a una lista de todos los hallazgos de GuardDuty en: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### M煤ltiples Cuentas

#### Por Invitaci贸n

Puedes **invitar a otras cuentas** a una cuenta diferente de AWS GuardDuty para que **todas las cuentas sean monitoreadas desde el mismo GuardDuty**. La cuenta maestra debe invitar a las cuentas miembros y luego el representante de la cuenta miembro debe aceptar la invitaci贸n.

#### A trav茅s de la Organizaci贸n

Puedes designar cualquier cuenta dentro de la organizaci贸n como el **administrador delegado de GuardDuty**. Solo la cuenta de gesti贸n de la organizaci贸n puede designar un administrador delegado.

Una cuenta que se designa como administrador delegado se convierte en una cuenta de administrador de GuardDuty, tiene GuardDuty habilitado autom谩ticamente en la regi贸n de AWS designada, y tambi茅n tiene la **permiso para habilitar y gestionar GuardDuty para todas las cuentas en la organizaci贸n dentro de esa regi贸n**. Las otras cuentas en la organizaci贸n pueden ser vistas y a帽adidas como cuentas miembros de GuardDuty asociadas con esta cuenta de administrador delegado.

## Enumeraci贸n

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Bypass de GuardDuty

### Gu铆a General

Intenta averiguar tanto como sea posible sobre el comportamiento de las credenciales que vas a usar:

* Tiempos que se utiliza
* Ubicaciones
* Agentes de Usuario / Servicios (Podr铆a ser utilizado desde awscli, webconsole, lambda...)
* Permisos utilizados regularmente

Con esta informaci贸n, recrea tanto como sea posible el mismo escenario para usar el acceso:

* Si es un **usuario o un rol accedido por un usuario**, intenta usarlo en las mismas horas, desde la misma geolocalizaci贸n (incluso el mismo ISP y IP si es posible)
* Si es un **rol utilizado por un servicio**, crea el mismo servicio en la misma regi贸n y 煤salo desde all铆 en los mismos rangos de tiempo
* Siempre intenta usar los **mismos permisos** que este principal ha utilizado
* Si necesitas **usar otros permisos o abusar de un permiso** (por ejemplo, descargar 1.000.000 de archivos de registro de cloudtrail) hazlo **lentamente** y con la **m铆nima cantidad de interacciones** con AWS (awscli a veces llama a varias APIs de lectura antes de la de escritura)

### Rompiendo GuardDuty

#### `guardduty:UpdateDetector`

Con este permiso podr铆as desactivar GuardDuty para evitar activar alertas.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Los atacantes con este permiso tienen la capacidad de **emplear filtros para la archivaci贸n autom谩tica** de hallazgos:

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Los atacantes con los privilegios anteriores podr铆an modificar la [**Lista de IPs de confianza**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) de GuardDuty a帽adiendo su direcci贸n IP a ella y evitar generar alertas.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Los atacantes podr铆an eliminar el destino para evitar alertas:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Eliminar este destino de publicaci贸n **no afectar谩 la generaci贸n o visibilidad de los hallazgos dentro de la consola de GuardDuty**. GuardDuty continuar谩 analizando eventos en su entorno de AWS, identificando comportamientos sospechosos o inesperados, y generando hallazgos.
{% endhint %}

### Ejemplos Espec铆ficos de Bypass de Hallazgos

Tenga en cuenta que hay decenas de hallazgos de GuardDuty, sin embargo, **como Red Teamer, no todos ellos te afectar谩n**, y lo que es mejor, tienes la **documentaci贸n completa de cada uno de ellos** en [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) as铆 que 茅chale un vistazo antes de realizar cualquier acci贸n para no ser atrapado.

Aqu铆 tienes un par de ejemplos de bypass de hallazgos espec铆ficos de GuardDuty:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty detecta solicitudes de API de AWS de herramientas comunes de pruebas de penetraci贸n y activa un [Hallazgo de PenTest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Se detecta por el **nombre del agente de usuario** que se pasa en la solicitud de API.\
Por lo tanto, **modificar el agente de usuario** es posible para evitar que GuardDuty detecte el ataque.

Para prevenir esto, puedes buscar en el script `session.py` en el paquete `botocore` y modificar el agente de usuario, o configurar Burp Suite como el proxy de AWS CLI y cambiar el agente de usuario con MitM o simplemente usar un sistema operativo como Ubuntu, Mac o Windows evitar谩 que se active esta alerta.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Extraer credenciales de EC2 del servicio de metadatos y **utilizarlas fuera** del entorno de AWS activa la alerta [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). Por el contrario, emplear estas credenciales desde tu instancia de EC2 activa la alerta [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws). Sin embargo, **usar las credenciales en otra instancia de EC2 comprometida dentro de la misma cuenta no se detecta**, sin generar ninguna alerta.

{% hint style="success" %}
Por lo tanto, **usa las credenciales exfiltradas desde dentro de la m谩quina** donde las encontraste para no activar esta alerta.
{% endhint %}

## Referencias

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
