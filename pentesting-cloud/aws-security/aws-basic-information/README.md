# AWS - Informaci칩n B치sica

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## Jerarqu칤a de Organizaci칩n

![](<../../../.gitbook/assets/image (151).png>)

### Cuentas

En AWS hay una **cuenta ra칤z,** que es el **contenedor principal para todas las cuentas** de tu **organizaci칩n**. Sin embargo, no necesitas usar esa cuenta para desplegar recursos, puedes crear **otras cuentas para separar diferentes infraestructuras de AWS** entre ellas.

Esto es muy interesante desde un punto de vista de **seguridad**, ya que **una cuenta no podr치 acceder a los recursos de otra cuenta** (excepto si se crean puentes espec칤ficamente), as칤 que de esta manera puedes crear l칤mites entre los despliegues.

Por lo tanto, hay **dos tipos de cuentas en una organizaci칩n** (estamos hablando de cuentas de AWS y no de cuentas de usuario): una 칰nica cuenta que se designa como la cuenta de gesti칩n, y una o m치s cuentas miembro.

*   La **cuenta de gesti칩n (la cuenta ra칤z)** es la cuenta que usas para crear la organizaci칩n. Desde la cuenta de gesti칩n de la organizaci칩n, puedes hacer lo siguiente:

* Crear cuentas en la organizaci칩n
* Invitar a otras cuentas existentes a la organizaci칩n
* Eliminar cuentas de la organizaci칩n
* Gestionar invitaciones
* Aplicar pol칤ticas a entidades (ra칤ces, OUs o cuentas) dentro de la organizaci칩n
* Habilitar la integraci칩n con servicios de AWS compatibles para proporcionar funcionalidad de servicio en todas las cuentas de la organizaci칩n.
* Es posible iniciar sesi칩n como el usuario ra칤z usando el correo electr칩nico y la contrase침a utilizados para crear esta cuenta ra칤z/organizaci칩n.

La cuenta de gesti칩n tiene las **responsabilidades de una cuenta pagadora** y es responsable de pagar todos los cargos que son acumulados por las cuentas miembro. No puedes cambiar la cuenta de gesti칩n de una organizaci칩n.
* **Las cuentas miembro** constituyen el resto de las cuentas en una organizaci칩n. Una cuenta puede ser miembro de solo una organizaci칩n a la vez. Puedes adjuntar una pol칤tica a una cuenta para aplicar controles solo a esa cuenta.
* Las cuentas miembro **deben usar una direcci칩n de correo electr칩nico v치lida** y pueden tener un **nombre**, en general no podr치n gestionar la facturaci칩n (pero podr칤an recibir acceso a ella).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Unidades de Organizaci칩n**

Las cuentas pueden agruparse en **Unidades de Organizaci칩n (OU)**. De esta manera, puedes crear **pol칤ticas** para la Unidad de Organizaci칩n que se van a **aplicar a todas las cuentas hijas**. Ten en cuenta que una OU puede tener otras OUs como hijas.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

Una **pol칤tica de control de servicio (SCP)** es una pol칤tica que especifica los servicios y acciones que los usuarios y roles pueden usar en las cuentas que la SCP afecta. Las SCP son **similares a las pol칤ticas de permisos de IAM** excepto que **no otorgan ning칰n permiso**. En cambio, las SCP especifican los **permisos m치ximos** para una organizaci칩n, unidad organizativa (OU) o cuenta. Cuando adjuntas una SCP a la ra칤z de tu organizaci칩n o a una OU, la **SCP limita los permisos para las entidades en las cuentas miembros**.

Esta es la 칔NICA forma en que **incluso el usuario ra칤z puede ser detenido** de hacer algo. Por ejemplo, podr칤a usarse para evitar que los usuarios deshabiliten CloudTrail o eliminen copias de seguridad.\
La 칰nica forma de eludir esto es comprometer tambi칠n la **cuenta maestra** que configura las SCP (la cuenta maestra no puede ser bloqueada).

{% hint style="warning" %}
Ten en cuenta que **las SCP solo restringen a los principales en la cuenta**, por lo que otras cuentas no se ven afectadas. Esto significa que tener una SCP que niegue `s3:GetObject` no detendr치 a las personas de **acceder a un bucket S3 p칰blico** en tu cuenta.
{% endhint %}

Ejemplos de SCP:

* Negar completamente la cuenta ra칤z
* Solo permitir regiones espec칤ficas
* Solo permitir servicios en la lista blanca
*   Negar que GuardDuty, CloudTrail y S3 Public Block Access sean

deshabilitados
*   Negar que los roles de seguridad/respuesta a incidentes sean eliminados o

modificados.
* Negar que las copias de seguridad sean eliminadas.
* Negar la creaci칩n de usuarios IAM y claves de acceso

Encuentra **ejemplos JSON** en [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** es el **nombre 칰nico** que tiene cada recurso dentro de AWS, se compone as칤:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Note que hay 4 particiones en AWS pero solo 3 formas de llamarlas:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Gesti칩n de Identidad y Acceso

IAM es el servicio que te permitir치 gestionar **Autenticaci칩n**, **Autorizaci칩n** y **Control de Acceso** dentro de tu cuenta de AWS.

* **Autenticaci칩n** - Proceso de definir una identidad y la verificaci칩n de esa identidad. Este proceso se puede subdividir en: Identificaci칩n y verificaci칩n.
* **Autorizaci칩n** - Determina a qu칠 puede acceder una identidad dentro de un sistema una vez que ha sido autenticada.
* **Control de Acceso** - El m칠todo y proceso de c칩mo se concede acceso a un recurso seguro.

IAM se puede definir por su capacidad para gestionar, controlar y gobernar los mecanismos de autenticaci칩n, autorizaci칩n y control de acceso de identidades a tus recursos dentro de tu cuenta de AWS.

### [Usuario ra칤z de la cuenta de AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Cuando creas por primera vez una cuenta de Amazon Web Services (AWS), comienzas con una 칰nica identidad de inicio de sesi칩n que tiene **acceso completo a todos** los servicios y recursos de AWS en la cuenta. Este es el _**usuario ra칤z**_ de la cuenta de AWS y se accede iniciando sesi칩n con la **direcci칩n de correo electr칩nico y la contrase침a que usaste para crear la cuenta**.

Ten en cuenta que un nuevo **usuario administrador** tendr치 **menos permisos que el usuario ra칤z**.

Desde el punto de vista de la seguridad, se recomienda crear otros usuarios y evitar usar este.

### [Usuarios de IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Un _usuario_ de IAM es una entidad que creas en AWS para **representar a la persona o aplicaci칩n** que lo utiliza para **interactuar con AWS**. Un usuario en AWS consiste en un nombre y credenciales (contrase침a y hasta dos claves de acceso).

Cuando creas un usuario de IAM, le otorgas **permisos** haci칠ndolo **miembro de un grupo de usuarios** que tiene pol칤ticas de permisos apropiadas adjuntas (recomendado), o **adjuntando pol칤ticas directamente** al usuario.

Los usuarios pueden tener **MFA habilitado para iniciar sesi칩n** a trav칠s de la consola. Los tokens API de los usuarios con MFA habilitado no est치n protegidos por MFA. Si deseas **restringir el acceso de las claves API de un usuario usando MFA**, necesitas indicar en la pol칤tica que para realizar ciertas acciones se necesita que MFA est칠 presente (ejemplo [**aqu칤**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **ID de clave de acceso**: 20 caracteres alfanum칠ricos aleatorios en may칰sculas como AKHDNAPO86BSHKDIRYT
* **ID de clave de acceso secreta**: 40 caracteres aleatorios en may칰sculas y min칰sculas: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (No es posible recuperar IDs de claves de acceso secretas perdidas).

Siempre que necesites **cambiar la clave de acceso**, este es el proceso que debes seguir:\
_Crear una nueva clave de acceso -> Aplicar la nueva clave al sistema/aplicaci칩n -> marcar la original como inactiva -> Probar y verificar que la nueva clave de acceso funciona -> Eliminar la antigua clave de acceso_

### MFA - Autenticaci칩n de M칰ltiples Factores

Se utiliza para **crear un factor adicional para la autenticaci칩n** adem치s de tus m칠todos existentes, como la contrase침a, creando as칤 un nivel de autenticaci칩n multifactor.\
Puedes usar una **aplicaci칩n virtual gratuita o un dispositivo f칤sico**. Puedes usar aplicaciones como Google Authenticator de forma gratuita para activar un MFA en AWS.

Las pol칤ticas con condiciones de MFA se pueden adjuntar a lo siguiente:

* Un usuario o grupo de IAM
* Un recurso como un bucket de Amazon S3, cola de Amazon SQS o tema de Amazon SNS
* La pol칤tica de confianza de un rol de IAM que puede ser asumido por un usuario

Si deseas **acceder a trav칠s de CLI** a un recurso que **verifica MFA**, necesitas llamar a **`GetSessionToken`**. Eso te dar치 un token con informaci칩n sobre MFA.\
Ten en cuenta que **las credenciales de `AssumeRole` no contienen esta informaci칩n**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Como [**se indica aqu칤**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), hay muchos casos diferentes en los que **MFA no se puede usar**.

### [Grupos de usuarios de IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Un [grupo de usuarios de IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) es una forma de **adjuntar pol칤ticas a m칰ltiples usuarios** a la vez, lo que puede facilitar la gesti칩n de los permisos para esos usuarios. **Los roles y grupos no pueden ser parte de un grupo**.

Puedes adjuntar una **pol칤tica basada en identidad a un grupo de usuarios** para que todos los **usuarios** en el grupo de usuarios **reciban los permisos de la pol칤tica**. **No puedes** identificar un **grupo de usuarios** como un **`Principal`** en una **pol칤tica** (como una pol칤tica basada en recursos) porque los grupos se relacionan con permisos, no con autenticaci칩n, y los principales son entidades IAM autenticadas.

Aqu칤 hay algunas caracter칤sticas importantes de los grupos de usuarios:

* Un **grupo** de usuarios puede **contener muchos usuarios**, y un **usuario** puede **pertenecer a m칰ltiples grupos**.
* **Los grupos de usuarios no pueden estar anidados**; solo pueden contener usuarios, no otros grupos de usuarios.
* No hay **un grupo de usuarios predeterminado que incluya autom치ticamente a todos los usuarios en la cuenta de AWS**. Si deseas tener un grupo de usuarios as칤, debes crearlo y asignar a cada nuevo usuario a 칠l.
* El n칰mero y tama침o de los recursos IAM en una cuenta de AWS, como el n칰mero de grupos y el n칰mero de grupos de los que un usuario puede ser miembro, son limitados. Para m치s informaci칩n, consulta [cuotas de IAM y AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Roles de IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Un **rol** de IAM es muy **similar** a un **usuario**, en el sentido de que es una **identidad con pol칤ticas de permisos que determinan qu칠** puede y no puede hacer en AWS. Sin embargo, un rol **no tiene ninguna credencial** (contrase침a o claves de acceso) asociada. En lugar de estar asociado de manera 칰nica a una persona, un rol est치 destinado a ser **asumido por cualquier persona que lo necesite (y tenga suficientes permisos)**. Un **usuario de IAM puede asumir un rol para temporalmente** adquirir diferentes permisos para una tarea espec칤fica. Un rol puede ser **asignado a un** [**usuario federado**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html) que inicia sesi칩n utilizando un proveedor de identidad externo en lugar de IAM.

Un rol de IAM consta de **dos tipos de pol칤ticas**: una **pol칤tica de confianza**, que no puede estar vac칤a, definiendo **qui칠n puede asumir** el rol, y una **pol칤tica de permisos**, que no puede estar vac칤a, definiendo **qu칠 puede acceder**.

#### Servicio de Token de Seguridad de AWS (STS)

El Servicio de Token de Seguridad de AWS (STS) es un servicio web que facilita la **emisi칩n de credenciales temporales de privilegios limitados**. Est치 espec칤ficamente dise침ado para:

### [Credenciales temporales en IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Las credenciales temporales se utilizan principalmente con roles de IAM**, pero tambi칠n hay otros usos. Puedes solicitar credenciales temporales que tengan un conjunto de permisos m치s restringido que tu usuario IAM est치ndar. Esto **previene** que **realices accidentalmente tareas que no est치n permitidas** por las credenciales m치s restringidas. Un beneficio de las credenciales temporales es que expiran autom치ticamente despu칠s de un per칤odo de tiempo establecido. Tienes control sobre la duraci칩n durante la cual las credenciales son v치lidas.

### Pol칤ticas

#### Permisos de Pol칤ticas

Se utilizan para asignar permisos. Hay 2 tipos:

* Pol칤ticas administradas por AWS (preconfiguradas por AWS)
* Pol칤ticas administradas por el cliente: configuradas por ti. Puedes crear pol칤ticas basadas en pol칤ticas administradas por AWS (modificando una de ellas y creando la tuya propia), utilizando el generador de pol칤ticas (una vista GUI que te ayuda a otorgar y denegar permisos) o escribiendo la tuya propia.

Por **defecto, el acceso** es **denegado**, el acceso se otorgar치 si se ha especificado un rol expl칤cito.\
Si **existe un solo "Deny", anular치 el "Allow"**, excepto para las solicitudes que utilizan las credenciales de seguridad ra칤z de la cuenta de AWS (que est치n permitidas por defecto).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
Los [campos globales que se pueden usar para condiciones en cualquier servicio est치n documentados aqu칤](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
Los [campos espec칤ficos que se pueden usar para condiciones por servicio est치n documentados aqu칤](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Pol칤ticas en l칤nea

Este tipo de pol칤ticas son **asignadas directamente** a un usuario, grupo o rol. Entonces, no aparecen en la lista de Pol칤ticas ya que ning칰n otro puede usarlas.\
Las pol칤ticas en l칤nea son 칰tiles si deseas **mantener una relaci칩n estricta uno a uno entre una pol칤tica y la identidad** a la que se aplica. Por ejemplo, quieres asegurarte de que los permisos en una pol칤tica no se asignen inadvertidamente a una identidad diferente de la que est치n destinados. Cuando usas una pol칤tica en l칤nea, los permisos en la pol칤tica no pueden ser adjuntados inadvertidamente a la identidad incorrecta. Adem치s, cuando usas la Consola de Administraci칩n de AWS para eliminar esa identidad, las pol칤ticas incrustadas en la identidad tambi칠n se eliminan. Eso es porque son parte de la entidad principal.

#### Pol칤ticas de Bucket de Recursos

Estas son **pol칤ticas** que se pueden definir en **recursos**. **No todos los recursos de AWS las soportan**.

Si un principal no tiene una denegaci칩n expl칤cita sobre ellos, y una pol칤tica de recurso les otorga acceso, entonces se les permite.

### L칤mites de IAM

Los l칤mites de IAM se pueden usar para **limitar los permisos a los que un usuario o rol deber칤a tener acceso**. De esta manera, incluso si se otorgan un conjunto diferente de permisos al usuario por una **pol칤tica diferente**, la operaci칩n **fallar치** si intenta usarlos.

Un l칤mite es solo una pol칤tica adjunta a un usuario que **indica el nivel m치ximo de permisos que el usuario o rol puede tener**. As칤 que, **incluso si el usuario tiene acceso de Administrador**, si el l칤mite indica que solo puede leer buckets S췅, ese es el m치ximo que puede hacer.

**Esto**, **SCPs** y **seguir el principio de menor privilegio** son las formas de controlar que los usuarios no tengan m치s permisos de los que necesitan.

### Pol칤ticas de Sesi칩n

Una pol칤tica de sesi칩n es una **pol칤tica establecida cuando se asume un rol** de alguna manera. Esto ser치 como un **l칤mite de IAM para esa sesi칩n**: Esto significa que la pol칤tica de sesi칩n no otorga permisos, sino que **los restringe a los indicados en la pol칤tica** (siendo los permisos m치ximos los que tiene el rol).

Esto es 칰til para **medidas de seguridad**: Cuando un administrador va a asumir un rol muy privilegiado, podr칤a restringir el permiso solo a los indicados en la pol칤tica de sesi칩n en caso de que la sesi칩n se vea comprometida.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Nota que por defecto **AWS podr칤a agregar pol칤ticas de sesi칩n a las sesiones** que se van a generar por razones de terceros. Por ejemplo, en [roles asumidos de cognito no autenticados](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) por defecto (usando autenticaci칩n mejorada), AWS generar치 **credenciales de sesi칩n con una pol칤tica de sesi칩n** que limita los servicios a los que la sesi칩n puede acceder [**a la siguiente lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Por lo tanto, si en alg칰n momento te enfrentas al error "... porque ninguna pol칤tica de sesi칩n permite el ...", y el rol tiene acceso para realizar la acci칩n, es porque **hay una pol칤tica de sesi칩n que lo impide**.

### Federaci칩n de Identidad

La federaci칩n de identidad **permite a los usuarios de proveedores de identidad que son externos** a AWS acceder a los recursos de AWS de manera segura sin tener que proporcionar credenciales de usuario de AWS de una cuenta IAM v치lida.\
Un ejemplo de un proveedor de identidad puede ser tu propio **Microsoft Active Directory** corporativo (a trav칠s de **SAML**) o servicios de **OpenID** (como **Google**). El acceso federado permitir치 a los usuarios dentro de 칠l acceder a AWS.

Para configurar esta confianza, se genera un **Proveedor de Identidad IAM (SAML u OAuth)** que **confiar치** en la **otra plataforma**. Luego, al menos un **rol IAM es asignado (confiando) al Proveedor de Identidad**. Si un usuario de la plataforma confiable accede a AWS, lo har치 como el rol mencionado.

Sin embargo, generalmente querr치s dar un **rol diferente dependiendo del grupo del usuario** en la plataforma de terceros. Entonces, varios **roles IAM pueden confiar** en el Proveedor de Identidad de terceros y la plataforma de terceros ser치 la que permitir치 a los usuarios asumir un rol u otro.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### Centro de Identidad IAM

AWS IAM Identity Center (sucesor de AWS Single Sign-On) ampl칤a las capacidades de AWS Identity and Access Management (IAM) para proporcionar un **lugar central** que re칰ne la **administraci칩n de usuarios y su acceso a cuentas de AWS** y aplicaciones en la nube.

El dominio de inicio de sesi칩n ser치 algo como `<user_input>.awsapps.com`.

Para iniciar sesi칩n a los usuarios, hay 3 fuentes de identidad que se pueden usar:

* Directorio del Centro de Identidad: Usuarios regulares de AWS
* Active Directory: Soporta diferentes conectores
* Proveedor de Identidad Externo: Todos los usuarios y grupos provienen de un Proveedor de Identidad externo (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

En el caso m치s simple del directorio del Centro de Identidad, el **Centro de Identidad tendr치 una lista de usuarios y grupos** y podr치 **asignar pol칤ticas** a ellos para **cualquiera de las cuentas** de la organizaci칩n.

Para dar acceso a un usuario/grupo del Centro de Identidad a una cuenta, se **crear치 un Proveedor de Identidad SAML que conf칤e en el Centro de Identidad**, y se **crear치 un rol que conf칤e en el Proveedor de Identidad con las pol칤ticas indicadas** en la cuenta de destino.

#### AwsSSOInlinePolicy

Es posible **dar permisos a trav칠s de pol칤ticas en l칤nea a roles creados a trav칠s del Centro de Identidad IAM**. Los roles creados en las cuentas que se les dan **pol칤ticas en l칤nea en AWS Identity Center** tendr치n estos permisos en una pol칤tica en l칤nea llamada **`AwsSSOInlinePolicy`**.

Por lo tanto, incluso si ves 2 roles con una pol칤tica en l칤nea llamada **`AwsSSOInlinePolicy`**, **no significa que tenga los mismos permisos**.

### Confianza y Roles entre Cuentas

**Un usuario** (confiando) puede crear un Rol entre Cuentas con algunas pol칤ticas y luego, **permitir a otro usuario** (confiado) **acceder a su cuenta** pero solo **teniendo el acceso indicado en las nuevas pol칤ticas del rol**. Para crear esto, solo crea un nuevo Rol y selecciona Rol entre Cuentas. Los roles para Acceso entre Cuentas ofrecen dos opciones. Proporcionar acceso entre cuentas de AWS que posees, y proporcionar acceso entre una cuenta que posees y una cuenta de AWS de terceros.\
Se recomienda **especificar el usuario que es confiado y no poner algo gen칠rico** porque si no, otros usuarios autenticados como usuarios federados tambi칠n podr치n abusar de esta confianza.

### AWS Simple AD

No soportado:

* Relaciones de Confianza
* Centro de Administraci칩n de AD
* Soporte completo de API de PS
* Papelera de reciclaje de AD
* Cuentas de servicio administradas por grupos
* Extensiones de esquema
* Sin acceso directo a OS o Instancias

#### Federaci칩n Web o Autenticaci칩n OpenID

La aplicaci칩n utiliza AssumeRoleWithWebIdentity para crear credenciales temporales. Sin embargo, esto no otorga acceso a la consola de AWS, solo acceso a recursos dentro de AWS.

### Otras opciones de IAM

* Puedes **establecer una configuraci칩n de pol칤tica de contrase침as** con opciones como longitud m칤nima y requisitos de contrase침a.
* Puedes **descargar "Informe de Credenciales"** con informaci칩n sobre las credenciales actuales (como tiempo de creaci칩n del usuario, si la contrase침a est치 habilitada...). Puedes generar un informe de credenciales tan a menudo como una vez cada **cuatro horas**.

AWS Identity and Access Management (IAM) proporciona **control de acceso granular** en toda AWS. Con IAM, puedes especificar **qui칠n puede acceder a qu칠 servicios y recursos**, y bajo qu칠 condiciones. Con las pol칤ticas de IAM, gestionas los permisos para tu fuerza laboral y sistemas para **asegurar permisos de menor privilegio**.

### Prefijos de ID de IAM

En [**esta p치gina**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) puedes encontrar los **prefijos de ID de IAM** de las claves dependiendo de su naturaleza:

| ABIA | [Token portador del servicio AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Credencial espec칤fica del contexto                                                                                                                                                                                           |
| AGPA | Grupo de usuarios                                                                                                                                                                                                            |
| AIDA | Usuario IAM                                                                                                                                                                                                              |
| AIPA | Perfil de instancia de Amazon EC2                                                                                                                                                                                           |
| AKIA | Clave de acceso                                                                                                                                                                                                            |
| ANPA | Pol칤tica administrada                                                                                                                                                                                                        |
| ANVA | Versi칩n en una pol칤tica administrada                                                                                                                                                                                           |
| APKA | Clave p칰blica                                                                                                                                                                                                            |
| AROA | Rol                                                                                                                                                                                                                  |
| ASCA | Certificado                                                                                                                                                                                                           |
| ASIA | [IDs de claves de acceso temporales (AWS STS)](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) utilizan este prefijo, pero son 칰nicos solo en combinaci칩n con la clave de acceso secreta y el token de sesi칩n. |

### Permisos recomendados para auditar cuentas

Los siguientes privilegios otorgan varios accesos de lectura de metadatos:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Varios

### Autenticaci칩n CLI

Para que un usuario regular se autentique en AWS a trav칠s de CLI, necesitas tener **credenciales locales**. Por defecto, puedes configurarlas **manualmente** en `~/.aws/credentials` o **ejecutando** `aws configure`.\
En ese archivo puedes tener m치s de un perfil, si **no se especifica un perfil** usando el **aws cli**, se utilizar치 el llamado **`[default]`** en ese archivo.\
Ejemplo de archivo de credenciales con m치s de 1 perfil:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Si necesitas acceder a **diferentes cuentas de AWS** y tu perfil tiene acceso para **asumir un rol dentro de esas cuentas**, no necesitas llamar manualmente a STS cada vez (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) y configurar las credenciales.

Puedes usar el archivo `~/.aws/config` para [**indicar qu칠 roles asumir**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), y luego usar el par치metro `--profile` como de costumbre (el `assume-role` se realizar치 de manera transparente para el usuario).\
Un ejemplo de archivo de configuraci칩n:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Con este archivo de configuraci칩n, puedes usar aws cli as칤:
```
aws --profile acc2 ...
```
Si est치s buscando algo **similar** a esto pero para el **navegador**, puedes revisar la **extensi칩n** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Referencias

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
