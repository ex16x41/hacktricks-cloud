# AWS - Podstawowe informacje

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

## Hierarchia organizacji

![](<../../../.gitbook/assets/image (151).png>)

### Konta

W AWS istnieje **konto g贸wne,** kt贸re jest **rodzicem dla wszystkich kont** w twojej **organizacji**. Jednak nie musisz u偶ywa tego konta do wdra偶ania zasob贸w, mo偶esz stworzy **inne konta, aby oddzieli r贸偶ne infrastruktury AWS** midzy sob.

Jest to bardzo interesujce z punktu widzenia **bezpieczestwa**, poniewa偶 **jedno konto nie bdzie mogo uzyska dostpu do zasob贸w innego konta** (chyba 偶e specjalnie utworzone s mosty), dziki czemu mo偶esz stworzy granice midzy wdro偶eniami.

Dlatego w organizacji istniej **dwa typy kont** (m贸wimy o kontach AWS, a nie kontach u偶ytkownik贸w): jedno konto, kt贸re jest wyznaczone jako konto zarzdzajce, oraz jedno lub wicej kont czonkowskich.

*   **Konto zarzdzajce (konto g贸wne)** to konto, kt贸rego u偶ywasz do tworzenia organizacji. Z konta zarzdzajcego organizacj mo偶esz zrobi nastpujce rzeczy:

* Tworzy konta w organizacji
* Zaprasza inne istniejce konta do organizacji
* Usuwa konta z organizacji
* Zarzdza zaproszeniami
* Stosowa polityki do podmiot贸w (korzeni, OU lub kont) w organizacji
* Wczy integracj z obsugiwanymi usugami AWS, aby zapewni funkcjonalno usug we wszystkich kontach w organizacji.
* Mo偶liwe jest zalogowanie si jako u偶ytkownik g贸wny, u偶ywajc adresu e-mail i hasa u偶ytego do utworzenia tego konta g贸wnego/organizacji.

Konto zarzdzajce ma **odpowiedzialnoci konta patnika** i jest odpowiedzialne za opacanie wszystkich opat, kt贸re s naliczane przez konta czonkowskie. Nie mo偶esz zmieni konta zarzdzajcego organizacj.
* **Konta czonkowskie** skadaj si z pozostaych kont w organizacji. Konto mo偶e by czonkiem tylko jednej organizacji w danym czasie. Mo偶esz przypisa polityk do konta, aby zastosowa kontrole tylko do tego jednego konta.
* Konta czonkowskie **musz u偶ywa wa偶nego adresu e-mail** i mog mie **nazw**, generalnie nie bd mogy zarzdza rozliczeniami (ale mog otrzyma do nich dostp).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Jednostki Organizacyjne**

Konta mog by grupowane w **Jednostki Organizacyjne (OU)**. W ten spos贸b mo偶esz tworzy **polityki** dla Jednostki Organizacyjnej, kt贸re bd **stosowane do wszystkich kont podrzdnych**. Zauwa偶, 偶e OU mo偶e mie inne OU jako dzieci.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

**Polityka kontroli usug (SCP)** to polityka, kt贸ra okrela usugi i dziaania, kt贸re u偶ytkownicy i role mog wykorzystywa w kontach, na kt贸re wpywa SCP. SCP s **podobne do polityk uprawnie IAM**, z tym 偶e **nie przyznaj 偶adnych uprawnie**. Zamiast tego, SCP okrelaj **maksymalne uprawnienia** dla organizacji, jednostki organizacyjnej (OU) lub konta. Gdy doczysz SCP do korzenia swojej organizacji lub OU, **SCP ogranicza uprawnienia dla podmiot贸w w kontach czonkowskich**.

To jest JEDYNY spos贸b, aby **nawet u偶ytkownik root m贸g by powstrzymany** przed zrobieniem czego. Na przykad, mo偶e by u偶yty do powstrzymania u偶ytkownik贸w przed wyczaniem CloudTrail lub usuwaniem kopii zapasowych.\
Jedynym sposobem na obejcie tego jest r贸wnie偶 skompromitowanie **konta g贸wnego**, kt贸re konfiguruje SCP (konto g贸wne nie mo偶e by zablokowane).

{% hint style="warning" %}
Zauwa偶, 偶e **SCP ograniczaj tylko podmioty w koncie**, wic inne konta nie s dotknite. Oznacza to, 偶e posiadanie SCP, kt贸re odmawia `s3:GetObject`, nie powstrzyma ludzi przed **uzyskiwaniem dostpu do publicznego koszyka S3** w twoim koncie.
{% endhint %}

Przykady SCP:

* Cakowicie odm贸wi kontu root
* Zezwoli tylko na okrelone regiony
* Zezwoli tylko na usugi z biaej listy
*   Odm贸wi wyczenia GuardDuty, CloudTrail i S3 Public Block Access
*   Odm贸wi usunicia lub modyfikacji r贸l odpowiedzialnoci za bezpieczestwo/incydenty.
* Odm贸wi usunicia kopii zapasowych.
* Odm贸wi tworzenia u偶ytkownik贸w IAM i kluczy dostpu

Znajd藕 **przykady JSON** w [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** to **unikalna nazwa**, kt贸r ma ka偶dy zas贸b w AWS, skada si z tego:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Zauwa偶, 偶e w AWS s 4 partycje, ale tylko 3 sposoby ich nazywania:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Zarzdzanie To偶samoci i Dostpem

IAM to usuga, kt贸ra pozwala zarzdza **Uwierzytelnianiem**, **Autoryzacj** i **Kontrol Dostpu** w Twoim koncie AWS.

* **Uwierzytelnianie** - Proces definiowania to偶samoci i weryfikacji tej to偶samoci. Proces ten mo偶na podzieli na: Identyfikacj i weryfikacj.
* **Autoryzacja** - Okrela, do czego to偶samo ma dostp w systemie po jej uwierzytelnieniu.
* **Kontrola Dostpu** - Metoda i proces, w jaki spos贸b przyznawany jest dostp do zabezpieczonego zasobu.

IAM mo偶na zdefiniowa przez jego zdolno do zarzdzania, kontrolowania i regulowania mechanizm贸w uwierzytelniania, autoryzacji i kontroli dostpu to偶samoci do Twoich zasob贸w w Twoim koncie AWS.

### [U偶ytkownik g贸wny konta AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Kiedy po raz pierwszy tworzysz konto Amazon Web Services (AWS), zaczynasz od pojedynczej to偶samoci logowania, kt贸ra ma **peny dostp do wszystkich** usug i zasob贸w AWS w koncie. To jest _**g贸wny u偶ytkownik**_ konta AWS i uzyskuje si do niego dostp, logujc si za pomoc **adresu e-mail i hasa, kt贸re u偶ye do utworzenia konta**.

Zauwa偶, 偶e nowy **u偶ytkownik admina** bdzie mia **mniej uprawnie ni偶 u偶ytkownik g贸wny**.

Z punktu widzenia bezpieczestwa zaleca si tworzenie innych u偶ytkownik贸w i unikanie korzystania z tego.

### [U偶ytkownicy IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

U偶ytkownik IAM to podmiot, kt贸ry tworzysz w AWS, aby **reprezentowa osob lub aplikacj**, kt贸ra u偶ywa go do **interakcji z AWS**. U偶ytkownik w AWS skada si z nazwy i powiadcze (haso i do dw贸ch kluczy dostpu).

Kiedy tworzysz u偶ytkownika IAM, przyznajesz mu **uprawnienia**, czynic go **czonkiem grupy u偶ytkownik贸w**, kt贸ra ma odpowiednie polityki uprawnie (zalecane), lub **bezporednio przypisujc polityki** do u偶ytkownika.

U偶ytkownicy mog mie **wczone MFA do logowania** przez konsol. Tokeny API u偶ytkownik贸w z wczonym MFA nie s chronione przez MFA. Jeli chcesz **ograniczy dostp kluczy API u偶ytkownik贸w za pomoc MFA**, musisz wskaza w polityce, 偶e aby wykona okrelone dziaania, MFA musi by obecne (przykad [**tutaj**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **ID klucza dostpu**: 20 losowych wielkich liter alfanumerycznych, takich jak AKHDNAPO86BSHKDIRYT
* **ID tajnego klucza dostpu**: 40 losowych wielkich i maych liter: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Nie ma mo偶liwoci odzyskania utraconych ID tajnych kluczy dostpu).

Kiedy musisz **zmieni klucz dostpu**, powiniene postpowa wedug tego procesu:\
_Utw贸rz nowy klucz dostpu -> Zastosuj nowy klucz do systemu/aplikacji -> oznacz oryginalny jako nieaktywny -> Przetestuj i zweryfikuj, 偶e nowy klucz dostpu dziaa -> Usu stary klucz dostpu_

### MFA - Uwierzytelnianie wieloskadnikowe

Jest u偶ywane do **tworzenia dodatkowego czynnika uwierzytelniania** opr贸cz istniejcych metod, takich jak haso, tworzc w ten spos贸b wieloskadnikowy poziom uwierzytelniania.\
Mo偶esz u偶y **darmowej aplikacji wirtualnej lub fizycznego urzdzenia**. Mo偶esz u偶ywa aplikacji takich jak Google Authenticator za darmo, aby aktywowa MFA w AWS.

Polityki z warunkami MFA mog by przypisane do nastpujcych:

* U偶ytkownika lub grupy IAM
* Zasobu, takiego jak koszyk Amazon S3, kolejka Amazon SQS lub temat Amazon SNS
* Polityki zaufania roli IAM, kt贸ra mo偶e by przyjta przez u偶ytkownika

Jeli chcesz **uzyska dostp przez CLI** do zasobu, kt贸ry **sprawdza MFA**, musisz wywoa **`GetSessionToken`**. To da ci token z informacjami o MFA.\
Zauwa偶, 偶e **powiadczenia `AssumeRole` nie zawieraj tych informacji**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
As [**stated here**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), istnieje wiele r贸偶nych przypadk贸w, w kt贸rych **MFA nie mo偶e by u偶ywane**.

### [Grupy u偶ytkownik贸w IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Grupa [u偶ytkownik贸w IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) to spos贸b na **przypisanie polityk do wielu u偶ytkownik贸w** jednoczenie, co mo偶e uatwi zarzdzanie uprawnieniami tych u偶ytkownik贸w. **Role i grupy nie mog by czci grupy**.

Mo偶esz przypisa **polityk opart na to偶samoci do grupy u偶ytkownik贸w**, aby wszyscy **u偶ytkownicy** w grupie u偶ytkownik贸w **otrzymali uprawnienia polityki**. **Nie mo偶esz** zidentyfikowa **grupy u偶ytkownik贸w** jako **`Principal`** w **polityce** (takiej jak polityka oparta na zasobach), poniewa偶 grupy odnosz si do uprawnie, a nie do uwierzytelniania, a podmioty s uwierzytelnionymi jednostkami IAM.

Oto kilka wa偶nych cech grup u偶ytkownik贸w:

* Grupa **u偶ytkownik贸w** mo偶e **zawiera wielu u偶ytkownik贸w**, a **u偶ytkownik** mo偶e **nale偶e do wielu grup**.
* **Grupy u偶ytkownik贸w nie mog by zagnie偶d偶one**; mog zawiera tylko u偶ytkownik贸w, a nie inne grupy u偶ytkownik贸w.
* Nie ma **domylnej grupy u偶ytkownik贸w, kt贸ra automatycznie obejmuje wszystkich u偶ytkownik贸w w koncie AWS**. Jeli chcesz mie tak grup u偶ytkownik贸w, musisz j utworzy i przypisa do niej ka偶dego nowego u偶ytkownika.
* Liczba i rozmiar zasob贸w IAM w koncie AWS, takich jak liczba grup oraz liczba grup, do kt贸rych u偶ytkownik mo偶e nale偶e, s ograniczone. Aby uzyska wicej informacji, zobacz [kwoty IAM i AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Role IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Rola IAM jest bardzo **podobna** do **u偶ytkownika**, poniewa偶 jest to **to偶samo z politykami uprawnie, kt贸re okrelaj, co** mo偶e i czego nie mo偶e robi w AWS. Jednak rola **nie ma 偶adnych powiadcze** (hasa ani kluczy dostpu) zwizanych z ni. Zamiast by unikalnie przypisana do jednej osoby, rola ma by **przyjmowana przez ka偶dego, kto jej potrzebuje (i ma wystarczajce uprawnienia)**. U偶ytkownik **IAM mo偶e przyj rol, aby tymczasowo** uzyska r贸偶ne uprawnienia do konkretnego zadania. Rola mo偶e by **przypisana do** [**u偶ytkownika federacyjnego**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html), kt贸ry loguje si za pomoc zewntrznego dostawcy to偶samoci zamiast IAM.

Rola IAM skada si z **dw贸ch typ贸w polityk**: **polityki zaufania**, kt贸ra nie mo偶e by pusta, definiujcej **kto mo偶e przyj** rol, oraz **polityki uprawnie**, kt贸ra nie mo偶e by pusta, definiujcej **co mo偶e uzyska dostp**.

#### Usuga AWS Security Token Service (STS)

Usuga AWS Security Token Service (STS) to usuga internetowa, kt贸ra uatwia **wydawanie tymczasowych, ograniczonych powiadcze**. Jest specjalnie dostosowana do:

### [Tymczasowe powiadczenia w IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Tymczasowe powiadczenia s g贸wnie u偶ywane z rolami IAM**, ale maj r贸wnie偶 inne zastosowania. Mo偶esz za偶da tymczasowych powiadcze, kt贸re maj bardziej ograniczony zestaw uprawnie ni偶 standardowy u偶ytkownik IAM. To **zapobiega** przypadkowemu **wykonywaniu zada, kt贸re nie s dozwolone** przez bardziej ograniczone powiadczenia. Korzyci tymczasowych powiadcze jest to, 偶e wygasaj automatycznie po okrelonym czasie. Masz kontrol nad czasem, przez jaki powiadczenia s wa偶ne.

### Polityki

#### Uprawnienia polityki

Su偶 do przypisywania uprawnie. Istniej 2 typy:

* Polityki zarzdzane przez AWS (wstpnie skonfigurowane przez AWS)
* Polityki zarzdzane przez klienta: skonfigurowane przez Ciebie. Mo偶esz tworzy polityki na podstawie polityk zarzdzanych przez AWS (modyfikujc jedn z nich i tworzc wasn), korzystajc z generatora polityk (widok GUI, kt贸ry pomaga w przyznawaniu i odmawianiu uprawnie) lub piszc wasne.

Zgodnie z **domylnym dostpem** jest **odmowa**, dostp zostanie przyznany, jeli okrelono wyra藕n rol.\
Jeli **istnieje pojedyncza "Deny", to nadpisze "Allow"**, z wyjtkiem 偶da, kt贸re u偶ywaj powiadcze bezpieczestwa g贸wnego konta AWS (kt贸re s dozwolone domylnie).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
The [global fields that can be used for conditions in any service are documented here](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
The [specific fields that can be used for conditions per service are documented here](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline Policies

Ten rodzaj polityk jest **bezporednio przypisany** do u偶ytkownika, grupy lub roli. Wtedy nie pojawiaj si one na licie Polityk, poniewa偶 nikt inny nie mo偶e ich u偶ywa.\
Polityki inline s przydatne, jeli chcesz **utrzyma cisy zwizek jeden do jednego midzy polityk a to偶samoci**, do kt贸rej jest stosowana. Na przykad, chcesz mie pewno, 偶e uprawnienia w polityce nie s przypadkowo przypisane do to偶samoci innej ni偶 ta, dla kt贸rej s przeznaczone. Kiedy u偶ywasz polityki inline, uprawnienia w polityce nie mog by przypadkowo przypisane do niewaciwej to偶samoci. Dodatkowo, gdy u偶ywasz konsoli zarzdzania AWS do usunicia tej to偶samoci, polityki osadzone w to偶samoci s r贸wnie偶 usuwane. To dlatego, 偶e s czci g贸wnego podmiotu.

#### Resource Bucket Policies

To s **polityki**, kt贸re mog by definiowane w **zasobach**. **Nie wszystkie zasoby AWS je wspieraj**.

Jeli g贸wny podmiot nie ma wyra藕nego odmowy dostpu do nich, a polityka zasob贸w przyznaje im dostp, to s one dozwolone.

### IAM Boundaries

Granice IAM mog by u偶ywane do **ograniczenia uprawnie, do kt贸rych u偶ytkownik lub rola powinny mie dostp**. W ten spos贸b, nawet jeli inny zestaw uprawnie jest przyznawany u偶ytkownikowi przez **inn polityk**, operacja **nie powiedzie si**, jeli spr贸buje ich u偶y.

Granica to po prostu polityka przypisana do u偶ytkownika, kt贸ra **wskazuje maksymalny poziom uprawnie, jakie u偶ytkownik lub rola mog mie**. Tak wic, **nawet jeli u偶ytkownik ma dostp administratora**, jeli granica wskazuje, 偶e mo偶e tylko czyta koszyki S路, to jest to maksymalne, co mo偶e zrobi.

**To**, **SCP** i **przestrzeganie zasady najmniejszych uprawnie** to sposoby kontrolowania, aby u偶ytkownicy nie mieli wicej uprawnie ni偶 te, kt贸rych potrzebuj.

### Session Policies

Polityka sesji to **polityka ustawiana, gdy rola jest przyjmowana** w jaki spos贸b. Bdzie to jak **granica IAM dla tej sesji**: Oznacza to, 偶e polityka sesji nie przyznaje uprawnie, ale **ogranicza je do tych wskazanych w polityce** (maksymalne uprawnienia to te, kt贸re ma rola).

To jest przydatne dla **rodk贸w bezpieczestwa**: Kiedy administrator ma przyj bardzo uprzywilejowan rol, mo偶e ograniczy uprawnienia tylko do tych wskazanych w polityce sesji, w przypadku gdy sesja zostanie skompromitowana.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Note that by default **AWS mo偶e doda polityki sesji do sesji**, kt贸re bd generowane z powodu innych przyczyn. Na przykad, w [nieautoryzowanych rolach przyjtych przez cognito](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) domylnie (korzystajc z ulepszonej autoryzacji), AWS wygeneruje **powiadczenia sesji z polityk sesji**, kt贸ra ogranicza usugi, do kt贸rych sesja ma dostp [**do nastpujcej listy**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Dlatego, jeli w pewnym momencie napotkasz bd "... poniewa偶 偶adna polityka sesji nie zezwala na ...", a rola ma dostp do wykonania akcji, to dlatego, 偶e **istnieje polityka sesji, kt贸ra to uniemo偶liwia**.

### Federacja To偶samoci

Federacja to偶samoci **pozwala u偶ytkownikom z dostawc贸w to偶samoci, kt贸rzy s zewntrzni** dla AWS, na bezpieczny dostp do zasob贸w AWS bez koniecznoci podawania powiadcze u偶ytkownika AWS z wa偶nego konta IAM.\
Przykadem dostawcy to偶samoci mo偶e by twoje wasne korporacyjne **Microsoft Active Directory** (poprzez **SAML**) lub usugi **OpenID** (jak **Google**). Dostp federacyjny pozwoli u偶ytkownikom w nim na dostp do AWS.

Aby skonfigurowa to zaufanie, generowany jest **dostawca to偶samoci IAM (SAML lub OAuth)**, kt贸ry **ufa** **innej platformie**. Nastpnie, przynajmniej jedna **rola IAM jest przypisana (ufajca) do dostawcy to偶samoci**. Jeli u偶ytkownik z zaufanej platformy uzyskuje dostp do AWS, uzyskuje dostp jako wspomniana rola.

Jednak zazwyczaj chcesz nada **inn rol w zale偶noci od grupy u偶ytkownika** na zewntrznej platformie. Wtedy kilka **r贸l IAM mo偶e ufa** zewntrznemu dostawcy to偶samoci, a zewntrzna platforma bdzie t, kt贸ra pozwoli u偶ytkownikom przyj jedn rol lub inn.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### Centrum To偶samoci IAM

AWS IAM Identity Center (nastpca AWS Single Sign-On) rozszerza mo偶liwoci AWS Identity and Access Management (IAM), aby zapewni **centralne miejsce**, kt贸re czy **administracj u偶ytkownikami i ich dostpem do kont AWS** oraz aplikacji w chmurze.

Domena logowania bdzie wyglda jak `<user_input>.awsapps.com`.

Aby zalogowa u偶ytkownik贸w, mo偶na u偶y 3 藕r贸de to偶samoci:

* Katalog Centrum To偶samoci: Zwykli u偶ytkownicy AWS
* Active Directory: Obsuguje r贸偶ne konektory
* Zewntrzny dostawca to偶samoci: Wszyscy u偶ytkownicy i grupy pochodz z zewntrznego dostawcy to偶samoci (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

W najprostszym przypadku katalogu Centrum To偶samoci, **Centrum To偶samoci bdzie miao list u偶ytkownik贸w i grup** i bdzie mogo **przypisywa polityki** do nich do **dowolnych kont** organizacji.

Aby nada dostp u偶ytkownikowi/grupie Centrum To偶samoci do konta, **zostanie utworzony zaufany dostawca to偶samoci SAML**, a **rola ufajca dostawcy to偶samoci z wskazanymi politykami zostanie utworzona** w docelowym koncie.

#### AwsSSOInlinePolicy

Mo偶liwe jest **nadawanie uprawnie za pomoc polityk inline do r贸l utworzonych za pomoc IAM Identity Center**. Role utworzone w kontach, kt贸rym nadano **polityki inline w AWS Identity Center**, bd miay te uprawnienia w polityce inline o nazwie **`AwsSSOInlinePolicy`**.

Dlatego, nawet jeli zobaczysz 2 role z polityk inline o nazwie **`AwsSSOInlinePolicy`**, to **nie oznacza, 偶e maj te same uprawnienia**.

### Zaufania i Role Midzy Kontami

**U偶ytkownik** (ufajcy) mo偶e utworzy rol midzykontow z pewnymi politykami, a nastpnie **zezwoli innemu u偶ytkownikowi** (zaufanemu) na **dostp do swojego konta**, ale tylko **majc dostp wskazany w nowych politykach roli**. Aby to utworzy, wystarczy utworzy now rol i wybra rol midzykontow. Role do dostpu midzykontowego oferuj dwie opcje. Zapewnienie dostpu midzy kontami AWS, kt贸re posiadasz, oraz zapewnienie dostpu midzy kontem, kt贸re posiadasz, a zewntrznym kontem AWS.\
Zaleca si **okrelenie u偶ytkownika, kt贸ry jest zaufany, a nie podawanie czego og贸lnego**, poniewa偶 w przeciwnym razie inni uwierzytelnieni u偶ytkownicy, tacy jak u偶ytkownicy federacyjni, bd mogli r贸wnie偶 nadu偶ywa tego zaufania.

### AWS Simple AD

Nieobsugiwane:

* Relacje zaufania
* Centrum administracyjne AD
* Pene wsparcie PS API
* Kosz na mieci AD
* Zarzdzane konta usug grupowych
* Rozszerzenia schematu
* Brak bezporedniego dostpu do OS lub instancji

#### Federacja Webowa lub Uwierzytelnianie OpenID

Aplikacja u偶ywa AssumeRoleWithWebIdentity do tworzenia tymczasowych powiadcze. Jednak nie daje to dostpu do konsoli AWS, tylko dostp do zasob贸w w AWS.

### Inne opcje IAM

* Mo偶esz **ustawi polityk hase**, okrelajc takie opcje jak minimalna dugo i wymagania dotyczce hase.
* Mo偶esz **pobra "Raport powiadcze"** z informacjami o bie偶cych powiadczeniach (takimi jak czas utworzenia u偶ytkownika, czy haso jest wczone...). Mo偶esz generowa raport powiadcze tak czsto, jak co **cztery godziny**.

AWS Identity and Access Management (IAM) zapewnia **szczeg贸ow kontrol dostpu** w caym AWS. Dziki IAM mo偶esz okreli **kto mo偶e uzyska dostp do jakich usug i zasob贸w**, oraz na jakich warunkach. Dziki politykom IAM zarzdzasz uprawnieniami dla swojej siy roboczej i system贸w, aby **zapewni minimalne uprawnienia**.

### Prefiksy ID IAM

Na [**tej stronie**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) mo偶esz znale藕 **prefiksy ID IAM** kluczy w zale偶noci od ich natury:

| ABIA | [Token nosiciela usugi AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Powiadczenie specyficzne dla kontekstu                                                                                                                                                                                           |
| AGPA | Grupa u偶ytkownik贸w                                                                                                                                                                                                            |
| AIDA | U偶ytkownik IAM                                                                                                                                                                                                              |
| AIPA | Profil instancji Amazon EC2                                                                                                                                                                                           |
| AKIA | Klucz dostpu                                                                                                                                                                                                            |
| ANPA | Polityka zarzdzana                                                                                                                                                                                                        |
| ANVA | Wersja w polityce zarzdzanej                                                                                                                                                                                           |
| APKA | Klucz publiczny                                                                                                                                                                                                            |
| AROA | Rola                                                                                                                                                                                                                  |
| ASCA | Certyfikat                                                                                                                                                                                                           |
| ASIA | [Tymczasowe identyfikatory kluczy dostpu (AWS STS)](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) u偶ywaj tego prefiksu, ale s unikalne tylko w poczeniu z tajnym kluczem dostpu i tokenem sesji. |

### Zalecane uprawnienia do audytu kont

Nastpujce uprawnienia przyznaj r贸偶ny dostp do metadanych:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## R贸偶ne

### Uwierzytelnianie CLI

Aby zwyky u偶ytkownik m贸g uwierzytelni si w AWS za pomoc CLI, musisz mie **lokalne powiadczenia**. Domylnie mo偶esz je skonfigurowa **rcznie** w `~/.aws/credentials` lub **uruchamiajc** `aws configure`.\
W tym pliku mo偶esz mie wicej ni偶 jeden profil, jeli **偶aden profil** nie jest okrelony przy u偶yciu **aws cli**, u偶ywany bdzie ten o nazwie **`[default]`** w tym pliku.\
Przykad pliku powiadcze z wicej ni偶 1 profilem:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Jeli musisz uzyska dostp do **r贸偶nych kont AWS** i Tw贸j profil ma dostp do **przyjcia roli w tych kontach**, nie musisz rcznie wywoywa STS za ka偶dym razem (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) i konfigurowa powiadcze.

Mo偶esz u偶y pliku `~/.aws/config`, aby [**wskaza, kt贸re role przyj**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), a nastpnie u偶y parametru `--profile` jak zwykle (operacja `assume-role` zostanie wykonana w spos贸b przezroczysty dla u偶ytkownika).\
Przykad pliku konfiguracyjnego:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Z tym plikiem konfiguracyjnym mo偶esz nastpnie u偶ywa aws cli, jak:
```
aws --profile acc2 ...
```
Jeli szukasz czego **podobnego** do tego, ale dla **przegldarki**, mo偶esz sprawdzi **rozszerzenie** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Odniesienia

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
