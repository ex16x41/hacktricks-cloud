# AWS - Informations de base

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Hi√©rarchie de l'organisation

![](<../../../.gitbook/assets/image (151).png>)

### Comptes

Dans AWS, il y a un **compte root**, qui est le **conteneur parent pour tous les comptes** de votre **organisation**. Cependant, vous n'avez pas besoin d'utiliser ce compte pour d√©ployer des ressources, vous pouvez cr√©er **d'autres comptes pour s√©parer diff√©rentes infrastructures AWS** entre elles.

C'est tr√®s int√©ressant d'un point de vue **s√©curit√©**, car **un compte ne pourra pas acc√©der aux ressources d'un autre compte** (sauf si des ponts sont sp√©cifiquement cr√©√©s), de cette mani√®re vous pouvez cr√©er des limites entre les d√©ploiements.

Par cons√©quent, il y a **deux types de comptes dans une organisation** (nous parlons de comptes AWS et non de comptes utilisateurs) : un seul compte d√©sign√© comme le compte de gestion, et un ou plusieurs comptes membres.

*   Le **compte de gestion (le compte root)** est le compte que vous utilisez pour cr√©er l'organisation. √Ä partir du compte de gestion de l'organisation, vous pouvez faire ce qui suit :

* Cr√©er des comptes dans l'organisation
* Inviter d'autres comptes existants √† l'organisation
* Supprimer des comptes de l'organisation
* G√©rer les invitations
* Appliquer des politiques aux entit√©s (roots, OUs ou comptes) au sein de l'organisation
* Activer l'int√©gration avec les services AWS pris en charge pour fournir des fonctionnalit√©s de service √† tous les comptes de l'organisation.
* Il est possible de se connecter en tant qu'utilisateur root en utilisant l'email et le mot de passe utilis√©s pour cr√©er ce compte root/organisation.

Le compte de gestion a les **responsabilit√©s d'un compte payeur** et est responsable du paiement de tous les frais accumul√©s par les comptes membres. Vous ne pouvez pas changer le compte de gestion d'une organisation.
* **Les comptes membres** constituent tous les autres comptes d'une organisation. Un compte ne peut √™tre membre que d'une seule organisation √† la fois. Vous pouvez attacher une politique √† un compte pour appliquer des contr√¥les uniquement √† ce compte.
* Les comptes membres **doivent utiliser une adresse email valide** et peuvent avoir un **nom**, en g√©n√©ral, ils ne pourront pas g√©rer la facturation (mais ils pourraient y avoir acc√®s).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Unit√©s d'Organisation**

Les comptes peuvent √™tre regroup√©s en **Unit√©s d'Organisation (OU)**. De cette fa√ßon, vous pouvez cr√©er des **politiques** pour l'Unit√© d'Organisation qui vont √™tre **appliqu√©es √† tous les comptes enfants**. Notez qu'une OU peut avoir d'autres OUs comme enfants.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

Une **service control policy (SCP)** est une politique qui sp√©cifie les services et les actions que les utilisateurs et les r√¥les peuvent utiliser dans les comptes que la SCP affecte. Les SCP sont **similaires aux politiques de permissions IAM** sauf qu'elles **ne donnent aucune permission**. Au lieu de cela, les SCP sp√©cifient les **permissions maximales** pour une organisation, une unit√© organisationnelle (OU) ou un compte. Lorsque vous attachez une SCP √† la racine de votre organisation ou √† une OU, la **SCP limite les permissions pour les entit√©s dans les comptes membres**.

C'est le SEUL moyen par lequel **m√™me l'utilisateur root peut √™tre arr√™t√©** de faire quelque chose. Par exemple, cela pourrait √™tre utilis√© pour emp√™cher les utilisateurs de d√©sactiver CloudTrail ou de supprimer des sauvegardes.\
Le seul moyen de contourner cela est de compromettre √©galement le **compte principal** qui configure les SCP (le compte principal ne peut pas √™tre bloqu√©).

{% hint style="warning" %}
Notez que **les SCP ne restreignent que les principaux dans le compte**, donc d'autres comptes ne sont pas affect√©s. Cela signifie qu'avoir une SCP qui refuse `s3:GetObject` n'arr√™tera pas les gens d'**acc√©der √† un bucket S3 public** dans votre compte.
{% endhint %}

Exemples de SCP :

* Refuser compl√®tement le compte root
* Autoriser uniquement des r√©gions sp√©cifiques
* Autoriser uniquement des services sur liste blanche
*   Refuser que GuardDuty, CloudTrail et S3 Public Block Access soient d√©sactiv√©s
*   Refuser que les r√¥les de s√©curit√©/r√©ponse aux incidents soient supprim√©s ou modifi√©s.
* Refuser que les sauvegardes soient supprim√©es.
* Refuser de cr√©er des utilisateurs IAM et des cl√©s d'acc√®s

Trouvez des **exemples JSON** dans [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples.html)

### ARN

**Amazon Resource Name** est le **nom unique** que chaque ressource √† l'int√©rieur d'AWS poss√®de, il est compos√© comme ceci :
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Notez qu'il y a 4 partitions dans AWS mais seulement 3 fa√ßons de les appeler :

* AWS Standard : `aws`
* AWS China : `aws-cn`
* AWS US public Internet (GovCloud) : `aws-us-gov`
* AWS Secret (US Classified) : `aws`

## IAM - Gestion des identit√©s et des acc√®s

IAM est le service qui vous permettra de g√©rer **l'authentification**, **l'autorisation** et **le contr√¥le d'acc√®s** au sein de votre compte AWS.

* **Authentification** - Processus de d√©finition d'une identit√© et de v√©rification de cette identit√©. Ce processus peut √™tre subdivis√© en : Identification et v√©rification.
* **Autorisation** - D√©termine ce qu'une identit√© peut acc√©der au sein d'un syst√®me une fois qu'elle a √©t√© authentifi√©e.
* **Contr√¥le d'acc√®s** - La m√©thode et le processus par lesquels l'acc√®s est accord√© √† une ressource s√©curis√©e.

IAM peut √™tre d√©fini par sa capacit√© √† g√©rer, contr√¥ler et gouverner les m√©canismes d'authentification, d'autorisation et de contr√¥le d'acc√®s des identit√©s √† vos ressources au sein de votre compte AWS.

### [Utilisateur root du compte AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html) <a href="#id_root" id="id_root"></a>

Lorsque vous cr√©ez un compte Amazon Web Services (AWS) pour la premi√®re fois, vous commencez avec une identit√© de connexion unique qui a **un acc√®s complet √† tous** les services et ressources AWS dans le compte. C'est l'**utilisateur root** du compte AWS et il est accessible en se connectant avec **l'adresse e-mail et le mot de passe que vous avez utilis√©s pour cr√©er le compte**.

Notez qu'un nouvel **utilisateur admin** aura **moins de permissions que l'utilisateur root**.

D'un point de vue s√©curit√©, il est recommand√© de cr√©er d'autres utilisateurs et d'√©viter d'utiliser celui-ci.

### [Utilisateurs IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Un _utilisateur_ IAM est une entit√© que vous cr√©ez dans AWS pour **repr√©senter la personne ou l'application** qui l'utilise pour **interagir avec AWS**. Un utilisateur dans AWS se compose d'un nom et de credentials (mot de passe et jusqu'√† deux cl√©s d'acc√®s).

Lorsque vous cr√©ez un utilisateur IAM, vous lui accordez des **permissions** en le rendant **membre d'un groupe d'utilisateurs** qui a des politiques de permission appropri√©es attach√©es (recommand√©), ou en **attachant directement des politiques** √† l'utilisateur.

Les utilisateurs peuvent avoir **MFA activ√© pour se connecter** via la console. Les tokens API des utilisateurs avec MFA activ√© ne sont pas prot√©g√©s par MFA. Si vous souhaitez **restreindre l'acc√®s des cl√©s API d'un utilisateur en utilisant MFA**, vous devez indiquer dans la politique qu'en vue d'effectuer certaines actions, MFA doit √™tre pr√©sent (exemple [**ici**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_configure-api-require.html)).

#### CLI

* **ID de cl√© d'acc√®s** : 20 caract√®res alphanum√©riques majuscules al√©atoires comme AKHDNAPO86BSHKDIRYT
* **ID de cl√© d'acc√®s secr√®te** : 40 caract√®res al√©atoires en majuscules et minuscules : S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Il n'est pas possible de r√©cup√©rer les ID de cl√© d'acc√®s secr√®te perdus).

Chaque fois que vous devez **changer la cl√© d'acc√®s**, voici le processus que vous devez suivre :\
&#xNAN;_&#x43;r√©er une nouvelle cl√© d'acc√®s -> Appliquer la nouvelle cl√© au syst√®me/application -> marquer l'original comme inactif -> Tester et v√©rifier que la nouvelle cl√© d'acc√®s fonctionne -> Supprimer l'ancienne cl√© d'acc√®s_

### MFA - Authentification Multi-Facteurs

Il est utilis√© pour **cr√©er un facteur suppl√©mentaire pour l'authentification** en plus de vos m√©thodes existantes, telles que le mot de passe, cr√©ant ainsi un niveau d'authentification multi-facteurs.\
Vous pouvez utiliser une **application virtuelle gratuite ou un dispositif physique**. Vous pouvez utiliser des applications comme Google Authenticator gratuitement pour activer un MFA dans AWS.

Les politiques avec des conditions MFA peuvent √™tre attach√©es aux √©l√©ments suivants :

* Un utilisateur ou un groupe IAM
* Une ressource telle qu'un bucket Amazon S3, une file d'attente Amazon SQS ou un sujet Amazon SNS
* La politique de confiance d'un r√¥le IAM qui peut √™tre assum√© par un utilisateur

Si vous souhaitez **acc√©der via CLI** √† une ressource qui **v√©rifie MFA**, vous devez appeler **`GetSessionToken`**. Cela vous donnera un token avec des informations sur MFA.\
Notez que **les credentials `AssumeRole` ne contiennent pas cette information**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
As [**indiqu√© ici**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_configure-api-require.html), il existe de nombreux cas o√π **MFA ne peut pas √™tre utilis√©**.

### [Groupes d'utilisateurs IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Un [groupe d'utilisateurs IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html) est un moyen de **joindre des politiques √† plusieurs utilisateurs** √† la fois, ce qui peut faciliter la gestion des autorisations pour ces utilisateurs. **Les r√¥les et les groupes ne peuvent pas faire partie d'un groupe**.

Vous pouvez attacher une **politique bas√©e sur l'identit√© √† un groupe d'utilisateurs** afin que tous les **utilisateurs** du groupe d'utilisateurs **re√ßoivent les autorisations de la politique**. Vous **ne pouvez pas** identifier un **groupe d'utilisateurs** comme un **`Principal`** dans une **politique** (comme une politique bas√©e sur les ressources) car les groupes sont li√©s aux autorisations, pas √† l'authentification, et les principaux sont des entit√©s IAM authentifi√©es.

Voici quelques caract√©ristiques importantes des groupes d'utilisateurs :

* Un **groupe d'utilisateurs** peut **contenir plusieurs utilisateurs**, et un **utilisateur** peut **appartenir √† plusieurs groupes**.
* **Les groupes d'utilisateurs ne peuvent pas √™tre imbriqu√©s** ; ils ne peuvent contenir que des utilisateurs, pas d'autres groupes d'utilisateurs.
* Il n'y a **pas de groupe d'utilisateurs par d√©faut qui inclut automatiquement tous les utilisateurs du compte AWS**. Si vous souhaitez avoir un groupe d'utilisateurs comme √ßa, vous devez le cr√©er et assigner chaque nouvel utilisateur √† celui-ci.
* Le nombre et la taille des ressources IAM dans un compte AWS, comme le nombre de groupes, et le nombre de groupes dont un utilisateur peut √™tre membre, sont limit√©s. Pour plus d'informations, voir [Quotas IAM et AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_iam-quotas.html).

### [R√¥les IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Un **r√¥le IAM** est tr√®s **similaire** √† un **utilisateur**, en ce sens qu'il s'agit d'une **identit√© avec des politiques d'autorisation qui d√©terminent ce qu'elle** peut et ne peut pas faire dans AWS. Cependant, un r√¥le **n'a pas de credentials** (mot de passe ou cl√©s d'acc√®s) qui lui sont associ√©s. Au lieu d'√™tre associ√© de mani√®re unique √† une personne, un r√¥le est destin√© √† √™tre **assum√© par quiconque en a besoin (et a suffisamment de permissions)**. Un **utilisateur IAM peut assumer un r√¥le pour temporairement** prendre des autorisations diff√©rentes pour une t√¢che sp√©cifique. Un r√¥le peut √™tre **assign√© √† un** [**utilisateur f√©d√©r√©**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers.html) qui se connecte en utilisant un fournisseur d'identit√© externe au lieu d'IAM.

Un r√¥le IAM se compose de **deux types de politiques** : Une **politique de confiance**, qui ne peut pas √™tre vide, d√©finissant **qui peut assumer** le r√¥le, et une **politique d'autorisation**, qui ne peut pas √™tre vide, d√©finissant **ce qu'il peut acc√©der**.

#### Service de jetons de s√©curit√© AWS (STS)

Le Service de jetons de s√©curit√© AWS (STS) est un service web qui facilite l'**√©mission de credentials temporaires √† privil√®ges limit√©s**. Il est sp√©cifiquement con√ßu pour :

### [Credentials temporaires dans IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Les credentials temporaires sont principalement utilis√©s avec les r√¥les IAM**, mais il existe √©galement d'autres utilisations. Vous pouvez demander des credentials temporaires qui ont un ensemble de permissions plus restreint que votre utilisateur IAM standard. Cela **emp√™che** que vous **effectuiez accidentellement des t√¢ches qui ne sont pas autoris√©es** par les credentials plus restreints. Un avantage des credentials temporaires est qu'ils expirent automatiquement apr√®s une p√©riode d√©termin√©e. Vous avez le contr√¥le sur la dur√©e pendant laquelle les credentials sont valides.

### Politiques

#### Permissions de politique

Sont utilis√©es pour attribuer des permissions. Il existe 2 types :

* Politiques g√©r√©es par AWS (pr√©configur√©es par AWS)
* Politiques g√©r√©es par le client : Configur√©es par vous. Vous pouvez cr√©er des politiques bas√©es sur des politiques g√©r√©es par AWS (en modifiant l'une d'elles et en cr√©ant la v√¥tre), en utilisant le g√©n√©rateur de politiques (une vue GUI qui vous aide √† accorder et refuser des permissions) ou en √©crivant la v√¥tre.

Par **d√©faut, l'acc√®s** est **refus√©**, l'acc√®s sera accord√© si un r√¥le explicite a √©t√© sp√©cifi√©.\
Si **un seul "Refuser" existe, il remplacera le "Autoriser"**, sauf pour les demandes qui utilisent les credentials de s√©curit√© root du compte AWS (qui sont autoris√©es par d√©faut).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
Les [champs globaux qui peuvent √™tre utilis√©s pour des conditions dans n'importe quel service sont document√©s ici](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-resourceaccount).\
Les [champs sp√©cifiques qui peuvent √™tre utilis√©s pour des conditions par service sont document√©s ici](https://docs.aws.amazon.com/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html).

#### Politiques Inline

Ce type de politiques est **directement attribu√©** √† un utilisateur, un groupe ou un r√¥le. Ainsi, elles n'apparaissent pas dans la liste des Politiques car d'autres peuvent les utiliser.\
Les politiques inline sont utiles si vous souhaitez **maintenir une relation stricte un √† un entre une politique et l'identit√©** √† laquelle elle est appliqu√©e. Par exemple, vous voulez vous assurer que les autorisations dans une politique ne sont pas attribu√©es par inadvertance √† une identit√© autre que celle pour laquelle elles sont destin√©es. Lorsque vous utilisez une politique inline, les autorisations dans la politique ne peuvent pas √™tre attach√©es par inadvertance √† la mauvaise identit√©. De plus, lorsque vous utilisez la console de gestion AWS pour supprimer cette identit√©, les politiques int√©gr√©es dans l'identit√© sont √©galement supprim√©es. C'est parce qu'elles font partie de l'entit√© principale.

#### Politiques de Bucket de Ressources

Ce sont des **politiques** qui peuvent √™tre d√©finies dans des **ressources**. **Toutes les ressources d'AWS ne les prennent pas en charge**.

Si un principal n'a pas de refus explicite √† leur √©gard, et qu'une politique de ressource leur accorde l'acc√®s, alors ils sont autoris√©s.

### Limites IAM

Les limites IAM peuvent √™tre utilis√©es pour **limiter les autorisations auxquelles un utilisateur ou un r√¥le devrait avoir acc√®s**. De cette fa√ßon, m√™me si un ensemble diff√©rent d'autorisations est accord√© √† l'utilisateur par une **politique diff√©rente**, l'op√©ration **√©chouera** s'il essaie de les utiliser.

Une limite est simplement une politique attach√©e √† un utilisateur qui **indique le niveau maximum d'autorisations que l'utilisateur ou le r√¥le peut avoir**. Donc, **m√™me si l'utilisateur a un acc√®s Administrateur**, si la limite indique qu'il ne peut lire que des buckets S¬∑, c'est le maximum qu'il peut faire.

**Cela**, **les SCP** et **le respect du principe du moindre privil√®ge** sont les moyens de contr√¥ler que les utilisateurs n'ont pas plus d'autorisations que celles dont ils ont besoin.

### Politiques de Session

Une politique de session est une **politique d√©finie lorsqu'un r√¥le est assum√©** d'une mani√®re ou d'une autre. Cela sera comme une **limite IAM pour cette session** : Cela signifie que la politique de session ne donne pas d'autorisations mais **les restreint √† celles indiqu√©es dans la politique** (les autorisations maximales √©tant celles que le r√¥le a).

Ceci est utile pour des **mesures de s√©curit√©** : Lorsque un administrateur va assumer un r√¥le tr√®s privil√©gi√©, il pourrait restreindre l'autorisation uniquement √† celles indiqu√©es dans la politique de session au cas o√π la session serait compromise.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Notez qu'en d√©faut, **AWS peut ajouter des politiques de session aux sessions** qui vont √™tre g√©n√©r√©es pour d'autres raisons. Par exemple, dans [les r√¥les suppos√©s cognito non authentifi√©s](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) par d√©faut (en utilisant l'authentification am√©lior√©e), AWS g√©n√©rera **des identifiants de session avec une politique de session** qui limite les services auxquels cette session peut acc√©der [**√† la liste suivante**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Par cons√©quent, si √† un moment donn√© vous rencontrez l'erreur "... parce qu'aucune politique de session ne permet le ...", et que le r√¥le a acc√®s pour effectuer l'action, c'est parce que **il y a une politique de session qui l'emp√™che**.

### F√©d√©ration d'identit√©

La f√©d√©ration d'identit√© **permet aux utilisateurs des fournisseurs d'identit√© qui sont externes** √† AWS d'acc√©der aux ressources AWS de mani√®re s√©curis√©e sans avoir √† fournir les identifiants d'utilisateur AWS d'un compte IAM valide.\
Un exemple de fournisseur d'identit√© peut √™tre votre propre **Microsoft Active Directory** (via **SAML**) ou des services **OpenID** (comme **Google**). L'acc√®s f√©d√©r√© permettra alors aux utilisateurs de celui-ci d'acc√©der √† AWS.

Pour configurer cette confiance, un **fournisseur d'identit√© IAM est g√©n√©r√© (SAML ou OAuth)** qui **fera confiance** √† la **autre plateforme**. Ensuite, au moins un **r√¥le IAM est attribu√© (faisant confiance) au fournisseur d'identit√©**. Si un utilisateur de la plateforme de confiance acc√®de √† AWS, il le fera en acc√©dant au r√¥le mentionn√©.

Cependant, vous voudrez g√©n√©ralement donner un **r√¥le diff√©rent en fonction du groupe de l'utilisateur** dans la plateforme tierce. Ensuite, plusieurs **r√¥les IAM peuvent faire confiance** au fournisseur d'identit√© tiers et la plateforme tierce sera celle qui permettra aux utilisateurs d'assumer un r√¥le ou un autre.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### Centre d'identit√© IAM

AWS IAM Identity Center (successeur d'AWS Single Sign-On) √©tend les capacit√©s de la gestion des identit√©s et des acc√®s AWS (IAM) pour fournir un **endroit central** qui regroupe **l'administration des utilisateurs et leur acc√®s aux** comptes AWS et aux applications cloud.

Le domaine de connexion sera quelque chose comme `<user_input>.awsapps.com`.

Pour connecter les utilisateurs, il y a 3 sources d'identit√© qui peuvent √™tre utilis√©es :

* R√©pertoire Identity Center : Utilisateurs AWS r√©guliers
* Active Directory : Prend en charge diff√©rents connecteurs
* Fournisseur d'identit√© externe : Tous les utilisateurs et groupes proviennent d'un fournisseur d'identit√© externe (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

Dans le cas le plus simple du r√©pertoire Identity Center, le **Centre d'identit√© aura une liste d'utilisateurs et de groupes** et pourra **attribuer des politiques** √† ceux-ci pour **n'importe lequel des comptes** de l'organisation.

Pour donner acc√®s √† un utilisateur/groupe du Centre d'identit√© √† un compte, un **fournisseur d'identit√© SAML faisant confiance au Centre d'identit√© sera cr√©√©**, et un **r√¥le faisant confiance au fournisseur d'identit√© avec les politiques indiqu√©es sera cr√©√©** dans le compte de destination.

#### AwsSSOInlinePolicy

Il est possible de **donner des autorisations via des politiques en ligne aux r√¥les cr√©√©s via IAM Identity Center**. Les r√¥les cr√©√©s dans les comptes recevant **des politiques en ligne dans AWS Identity Center** auront ces autorisations dans une politique en ligne appel√©e **`AwsSSOInlinePolicy`**.

Par cons√©quent, m√™me si vous voyez 2 r√¥les avec une politique en ligne appel√©e **`AwsSSOInlinePolicy`**, cela **ne signifie pas qu'ils ont les m√™mes autorisations**.

### Confiances et r√¥les inter-comptes

**Un utilisateur** (faisant confiance) peut cr√©er un r√¥le inter-comptes avec certaines politiques et ensuite, **permettre √† un autre utilisateur** (de confiance) d'**acc√©der √† son compte** mais uniquement **avec l'acc√®s indiqu√© dans les nouvelles politiques de r√¥le**. Pour cr√©er cela, il suffit de cr√©er un nouveau r√¥le et de s√©lectionner le r√¥le inter-comptes. Les r√¥les pour l'acc√®s inter-comptes offrent deux options. Fournir un acc√®s entre les comptes AWS que vous poss√©dez, et fournir un acc√®s entre un compte que vous poss√©dez et un compte AWS tiers.\
Il est recommand√© de **sp√©cifier l'utilisateur qui est de confiance et de ne pas mettre quelque chose de g√©n√©rique** car sinon, d'autres utilisateurs authentifi√©s comme les utilisateurs f√©d√©r√©s pourront √©galement abuser de cette confiance.

### AWS Simple AD

Non pris en charge :

* Relations de confiance
* Centre d'administration AD
* Prise en charge compl√®te de l'API PS
* Corbeille AD
* Comptes de service g√©r√©s par groupe
* Extensions de sch√©ma
* Pas d'acc√®s direct au syst√®me d'exploitation ou aux instances

#### F√©d√©ration Web ou authentification OpenID

L'application utilise AssumeRoleWithWebIdentity pour cr√©er des identifiants temporaires. Cependant, cela ne donne pas acc√®s √† la console AWS, juste acc√®s aux ressources au sein d'AWS.

### Autres options IAM

* Vous pouvez **d√©finir des param√®tres de politique de mot de passe** tels que la longueur minimale et les exigences de mot de passe.
* Vous pouvez **t√©l√©charger un "Rapport d'identifiants"** avec des informations sur les identifiants actuels (comme le temps de cr√©ation de l'utilisateur, si le mot de passe est activ√©...). Vous pouvez g√©n√©rer un rapport d'identifiants aussi souvent qu'une fois toutes les **quatre heures**.

La gestion des identit√©s et des acc√®s AWS (IAM) fournit un **contr√¥le d'acc√®s granulaire** sur l'ensemble d'AWS. Avec IAM, vous pouvez sp√©cifier **qui peut acc√©der √† quels services et ressources**, et sous quelles conditions. Avec les politiques IAM, vous g√©rez les autorisations de votre main-d'≈ìuvre et de vos syst√®mes pour **assurer des autorisations de moindre privil√®ge**.

### Pr√©fixes d'ID IAM

Dans [**cette page**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_identifiers.html#identifiers-unique-ids), vous pouvez trouver les **pr√©fixes d'ID IAM** des cl√©s en fonction de leur nature :

| ABIA | [Jeton porteur de service AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_bearer.html)                                                                                                          |
| ---- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Identifiant sp√©cifique au contexte                                                                                                                                                                                          |
| AGPA | Groupe d'utilisateurs                                                                                                                                                                                                           |
| AIDA | Utilisateur IAM                                                                                                                                                                                                             |
| AIPA | Profil d'instance Amazon EC2                                                                                                                                                                                          |
| AKIA | Cl√© d'acc√®s                                                                                                                                                                                                           |
| ANPA | Politique g√©r√©e                                                                                                                                                                                                       |
| ANVA | Version dans une politique g√©r√©e                                                                                                                                                                                          |
| APKA | Cl√© publique                                                                                                                                                                                                           |
| AROA | R√¥le                                                                                                                                                                                                                 |
| ASCA | Certificat                                                                                                                                                                                                          |
| ASIA | [Identifiants de cl√© d'acc√®s temporaires (AWS STS)](https://docs.aws.amazon.com/STS/latest/APIReference/API_Credentials.html) utilisent ce pr√©fixe, mais ne sont uniques qu'en combinaison avec la cl√© d'acc√®s secr√®te et le jeton de session. |

### Autorisations recommand√©es pour auditer les comptes

Les privil√®ges suivants accordent divers acc√®s en lecture des m√©tadonn√©es :

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Divers

### Authentification CLI

Pour qu'un utilisateur r√©gulier s'authentifie √† AWS via CLI, vous devez avoir des **identifiants locaux**. Par d√©faut, vous pouvez les configurer **manuellement** dans `~/.aws/credentials` ou en **ex√©cutant** `aws configure`.\
Dans ce fichier, vous pouvez avoir plus d'un profil, si **aucun profil** n'est sp√©cifi√© en utilisant le **cli aws**, celui appel√© **`[default]`** dans ce fichier sera utilis√©.\
Exemple de fichier d'identifiants avec plus d'un profil :
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Si vous devez acc√©der √† **diff√©rents comptes AWS** et que votre profil a √©t√© autoris√© √† **assumer un r√¥le dans ces comptes**, vous n'avez pas besoin d'appeler manuellement STS √† chaque fois (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) et de configurer les identifiants.

Vous pouvez utiliser le fichier `~/.aws/config` pour [**indiquer quels r√¥les assumer**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), puis utiliser le param√®tre `--profile` comme d'habitude (l'`assume-role` sera effectu√© de mani√®re transparente pour l'utilisateur).\
Un exemple de fichier de configuration :
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Avec ce fichier de configuration, vous pouvez ensuite utiliser aws cli comme :
```
aws --profile acc2 ...
```
Si vous recherchez quelque chose de **similaire** √† cela mais pour le **navigateur**, vous pouvez consulter l'**extension** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## R√©f√©rences

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_getting-started_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PR au** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
