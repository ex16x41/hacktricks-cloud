# AWS - Basic Information

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Hijerarhija Organizacije

![](<../../../.gitbook/assets/image (151).png>)

### Nalozi

U AWS-u postoji **root nalog**, koji je **glavni kontejner za sve naloge** vaÅ¡e **organizacije**. MeÄ‘utim, ne morate koristiti taj nalog za implementaciju resursa, moÅ¾ete kreirati **druge naloge da biste odvojili razliÄite AWS** infrastrukture izmeÄ‘u njih.

Ovo je veoma interesantno sa **bezbednosnog** aspekta, jer **jedan nalog neÄ‡e moÄ‡i da pristupi resursima iz drugog naloga** (osim ako se specifiÄno ne kreiraju mostovi), tako da na ovaj naÄin moÅ¾ete kreirati granice izmeÄ‘u implementacija.

Dakle, postoje **dve vrste naloga u organizaciji** (govorimo o AWS nalozima, a ne korisniÄkim nalozima): jedan nalog koji je oznaÄen kao upravljaÄki nalog i jedan ili viÅ¡e Älanova naloga.

*   **UpravljaÄki nalog (root nalog)** je nalog koji koristite za kreiranje organizacije. Iz upravljaÄkog naloga organizacije, moÅ¾ete uraditi sledeÄ‡e:

* Kreirati naloge u organizaciji
* Pozvati druge postojeÄ‡e naloge u organizaciju
* Ukloniti naloge iz organizacije
* Upravljati pozivnicama
* Primenjivati politike na entitete (root, OU, ili naloge) unutar organizacije
* OmoguÄ‡iti integraciju sa podrÅ¾anim AWS uslugama kako bi se obezbedila funkcionalnost usluga preko svih naloga u organizaciji.
* MoguÄ‡e je prijaviti se kao root korisnik koristeÄ‡i email i lozinku koriÅ¡Ä‡ene za kreiranje ovog root naloga/organizacije.

UpravljaÄki nalog ima **odgovornosti platioca** i odgovoran je za plaÄ‡anje svih troÅ¡kova koje naprave Älanovi naloga. Ne moÅ¾ete promeniti upravljaÄki nalog organizacije.
* **ÄŒlanovi naloga** Äine sve ostale naloge u organizaciji. Nalog moÅ¾e biti Älan samo jedne organizacije u isto vreme. MoÅ¾ete priloÅ¾iti politiku nalogu da biste primenili kontrole samo na taj jedan nalog.
* ÄŒlanovi naloga **moraju koristiti vaÅ¾eÄ‡u email adresu** i mogu imati **ime**, generalno neÄ‡e moÄ‡i da upravljaju naplatom (ali im moÅ¾e biti dat pristup tome).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organization Units**

Nalozi mogu biti grupisani u **Organization Units (OU)**. Na ovaj naÄin, moÅ¾ete kreirati **politike** za Organization Unit koje Ä‡e biti **primenjene na sve podreÄ‘ene naloge**. Imajte na umu da jedan OU moÅ¾e imati druge OUs kao podreÄ‘ene.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

**Service control policy (SCP)** je politika koja specificira usluge i akcije koje korisnici i uloge mogu koristiti u nalozima na koje SCP utiÄe. SCP-ovi su **sliÄni IAM** politikama dozvola osim Å¡to **ne dodeljuju nikakve dozvole**. Umesto toga, SCP-ovi specificiraju **maksimalne dozvole** za organizaciju, organizacionu jedinicu (OU) ili nalog. Kada prikaÄite SCP na koren vaÅ¡e organizacije ili OU, **SCP ograniÄava dozvole za entitete u Älanovima naloga**.

Ovo je JEDINI naÄin da se **Äak i root korisnik zaustavi** od obavljanja neÄega. Na primer, moÅ¾e se koristiti za spreÄavanje korisnika da onemoguÄ‡e CloudTrail ili briÅ¡u bekape.\
Jedini naÄin da se ovo zaobiÄ‘e je da se kompromituje i **master nalog** koji konfiguriÅ¡e SCP-ove (master nalog ne moÅ¾e biti blokiran).

{% hint style="warning" %}
Napomena da **SCP-ovi samo ograniÄavaju subjekte u nalogu**, tako da drugi nalozi nisu pogoÄ‘eni. Ovo znaÄi da SCP koji zabranjuje `s3:GetObject` neÄ‡e spreÄiti ljude da **pristupe javnom S3 bucket-u** u vaÅ¡em nalogu.
{% endhint %}

Primeri SCP-ova:

* Potpuno zabraniti root nalog
* Dozvoliti samo specifiÄne regione
* Dozvoliti samo usluge sa bele liste
*   Zabraniti onemoguÄ‡avanje GuardDuty, CloudTrail, i S3 Public Block Access
*   Zabraniti brisanje ili modifikaciju uloga za bezbednost/odgovor na incidente
* Zabraniti brisanje bekapa
* Zabraniti kreiranje IAM korisnika i pristupnih kljuÄeva

PronaÄ‘ite **JSON primere** na [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** je **jedinstveno ime** koje svaki resurs unutar AWS-a ima, sastavljeno je ovako:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Napomena da postoje 4 particije u AWS-u, ali samo 3 naÄina da ih pozovete:

* AWS Standard: `aws`
* AWS Kina: `aws-cn`
* AWS US javni internet (GovCloud): `aws-us-gov`
* AWS Tajni (US Klasifikovani): `aws`

## IAM - Upravljanje identitetom i pristupom

IAM je usluga koja vam omoguÄ‡ava da upravljate **Autentifikacijom**, **Autorizacijom** i **Kontrolom pristupa** unutar vaÅ¡eg AWS naloga.

* **Autentifikacija** - Proces definisanja identiteta i verifikacije tog identiteta. Ovaj proces se moÅ¾e podeliti na: Identifikaciju i verifikaciju.
* **Autorizacija** - OdreÄ‘uje Å¡ta identitet moÅ¾e da pristupi unutar sistema nakon Å¡to je autentifikovan.
* **Kontrola pristupa** - Metod i proces kako se pristup odobrava sigurnom resursu.

IAM se moÅ¾e definisati po svojoj sposobnosti da upravlja, kontroliÅ¡e i reguliÅ¡e mehanizme autentifikacije, autorizacije i kontrole pristupa identiteta vaÅ¡im resursima unutar vaÅ¡eg AWS naloga.

### [AWS nalog root korisnik](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Kada prvi put kreirate Amazon Web Services (AWS) nalog, poÄinjete sa jednim identitetom za prijavu koji ima **potpun pristup svim** AWS uslugama i resursima u nalogu. Ovo je AWS nalog _**root korisnik**_ i pristupa mu se prijavom sa **email adresom i lozinkom koju ste koristili za kreiranje naloga**.

Napomena da novi **admin korisnik** ima **manje dozvole od root korisnika**.

Sa sigurnosne taÄke glediÅ¡ta, preporuÄuje se kreiranje drugih korisnika i izbegavanje koriÅ¡Ä‡enja ovog.

### [IAM korisnici](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

IAM _korisnik_ je entitet koji kreirate u AWS-u da **predstavlja osobu ili aplikaciju** koja ga koristi za **interakciju sa AWS-om**. Korisnik u AWS-u se sastoji od imena i akreditiva (lozinka i do dva pristupna kljuÄa).

Kada kreirate IAM korisnika, dodeljujete mu **dozvole** tako Å¡to ga Äinite **Älanom korisniÄke grupe** koja ima odgovarajuÄ‡e politike dozvola (preporuÄeno), ili direktnim dodeljivanjem politika korisniku.

Korisnici mogu imati **MFA omoguÄ‡eno za prijavu** putem konzole. API tokeni korisnika sa omoguÄ‡enim MFA nisu zaÅ¡tiÄ‡eni MFA-om. Ako Å¾elite da **ograniÄite pristup API kljuÄevima korisnika koristeÄ‡i MFA** morate naznaÄiti u politici da je za obavljanje odreÄ‘enih akcija potrebna MFA (primer [**ovde**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **ID pristupnog kljuÄa**: 20 nasumiÄnih velikih alfanumeriÄkih karaktera kao AKHDNAPO86BSHKDIRYT
* **Tajni pristupni kljuÄ ID**: 40 nasumiÄnih velikih i malih karaktera: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Nije moguÄ‡e povratiti izgubljene tajne pristupne kljuÄeve).

Kad god treba da **promenite pristupni kljuÄ** ovo je proces koji treba da sledite:\
_Kreirajte novi pristupni kljuÄ -> Primeni novi kljuÄ na sistem/aplikaciju -> oznaÄite originalni kao neaktivan -> Testirajte i verifikujte da novi pristupni kljuÄ radi -> ObriÅ¡ite stari pristupni kljuÄ_

### MFA - ViÅ¡efaktorska autentifikacija

Koristi se za **kreiranje dodatnog faktora za autentifikaciju** pored postojeÄ‡ih metoda, kao Å¡to je lozinka, Äime se kreira viÅ¡efaktorski nivo autentifikacije.\
MoÅ¾ete koristiti **besplatnu virtuelnu aplikaciju ili fiziÄki ureÄ‘aj**. MoÅ¾ete koristiti aplikacije kao Å¡to je google authentication besplatno za aktiviranje MFA u AWS-u.

Politike sa MFA uslovima mogu se dodeliti sledeÄ‡em:

* IAM korisniku ili grupi
* Resursu kao Å¡to je Amazon S3 bucket, Amazon SQS red, ili Amazon SNS tema
* Politici poverenja IAM uloge koju moÅ¾e preuzeti korisnik

Ako Å¾elite da **pristupite putem CLI** resursu koji **proverava MFA** morate pozvati **`GetSessionToken`**. To Ä‡e vam dati token sa informacijama o MFA.\
Napomena da **`AssumeRole` akreditivi ne sadrÅ¾e ove informacije**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Kao Å¡to je [**navedeno ovde**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), postoji mnogo razliÄitih sluÄajeva gde **MFA ne moÅ¾e biti koriÅ¡Ä‡en**.

### [IAM korisniÄke grupe](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

IAM [korisniÄka grupa](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) je naÄin da se **priloÅ¾e politike za viÅ¡e korisnika** odjednom, Å¡to moÅ¾e olakÅ¡ati upravljanje dozvolama za te korisnike. **Uloge i grupe ne mogu biti deo grupe**.

MoÅ¾ete priloÅ¾iti **politiku zasnovanu na identitetu korisniÄkoj grupi** tako da svi **korisnici** u korisniÄkoj grupi **dobiju dozvole politike**. **Ne moÅ¾ete** identifikovati **korisniÄku grupu** kao **`Principal`** u **politici** (kao Å¡to je politika zasnovana na resursima) jer se grupe odnose na dozvole, a ne na autentifikaciju, i principal su autentifikovane IAM entitete.

Evo nekih vaÅ¾nih karakteristika korisniÄkih grupa:

* KorisniÄka **grupa** moÅ¾e **sadrÅ¾ati mnogo korisnika**, a **korisnik** moÅ¾e **pripadati viÅ¡e grupa**.
* **KorisniÄke grupe ne mogu biti ugnjeÅ¾dene**; mogu sadrÅ¾ati samo korisnike, a ne druge korisniÄke grupe.
* Ne postoji **podrazumevana korisniÄka grupa koja automatski ukljuÄuje sve korisnike u AWS nalogu**. Ako Å¾elite da imate takvu korisniÄku grupu, morate je kreirati i dodeliti svakog novog korisnika njoj.
* Broj i veliÄina IAM resursa u AWS nalogu, kao Å¡to je broj grupa i broj grupa Äiji Älan korisnik moÅ¾e biti, su ograniÄeni. Za viÅ¡e informacija, pogledajte [IAM i AWS STS kvote](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [IAM uloge](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

IAM **uloga** je veoma **sliÄna** **korisniku**, u smislu da je to **identitet sa politikama dozvola koje odreÄ‘uju Å¡ta** moÅ¾e i ne moÅ¾e raditi u AWS-u. MeÄ‘utim, uloga **nema nikakve akreditive** (lozinku ili pristupne kljuÄeve) povezane sa njom. Umesto da bude jedinstveno povezana sa jednom osobom, uloga je namenjena da bude **preuzeta od strane bilo koga kome je potrebna (i ima dovoljno dozvola)**. **IAM korisnik moÅ¾e preuzeti ulogu da privremeno** preuzme razliÄite dozvole za odreÄ‘eni zadatak. Uloga moÅ¾e biti **dodeljena** [**federisanom korisniku**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html) koji se prijavljuje koristeÄ‡i eksternog provajdera identiteta umesto IAM-a.

IAM uloga se sastoji od **dve vrste politika**: **Politike poverenja**, koja ne moÅ¾e biti prazna, definiÅ¡uÄ‡i **ko moÅ¾e preuzeti** ulogu, i **politike dozvola**, koja ne moÅ¾e biti prazna, definiÅ¡uÄ‡i **Å¡ta moÅ¾e pristupiti**.

#### AWS Security Token Service (STS)

AWS Security Token Service (STS) je web servis koji olakÅ¡ava **izdavanje privremenih, ograniÄenih akreditiva**. Posebno je prilagoÄ‘en za:

### [Privremeni akreditivi u IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Privremeni akreditivi se prvenstveno koriste sa IAM ulogama**, ali postoje i druge upotrebe. MoÅ¾ete zatraÅ¾iti privremene akreditive koji imaju ograniÄeniji skup dozvola od vaÅ¡eg standardnog IAM korisnika. Ovo **spreÄava** vas da **sluÄajno izvrÅ¡ite zadatke koji nisu dozvoljeni** sa ograniÄenijim akreditivima. Prednost privremenih akreditiva je Å¡to automatski istiÄu nakon odreÄ‘enog vremenskog perioda. Imate kontrolu nad trajanjem vaÅ¾enja akreditiva.

### Politike

#### Dozvole politike

Koriste se za dodeljivanje dozvola. Postoje 2 tipa:

* AWS upravljane politike (prekonfigurisane od strane AWS-a)
* Politike upravljane od strane korisnika: Konfigurisane od strane vas. MoÅ¾ete kreirati politike na osnovu AWS upravljanih politika (modifikovanjem jedne od njih i kreiranjem sopstvene), koristeÄ‡i generator politika (GUI prikaz koji vam pomaÅ¾e u dodeljivanju i odbijanju dozvola) ili pisanjem sopstvene.

Po **podrazumevanom pristupu** je **odbijeno**, pristup Ä‡e biti odobren ako je eksplicitna uloga specificirana.\
Ako **postoji jedno "Odbijanje", ono Ä‡e nadjaÄati "Dozvolu"**, osim za zahteve koji koriste root sigurnosne akreditive AWS naloga (koji su dozvoljeni po podrazumevanom).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
[Globalna polja koja se mogu koristiti za uslove u bilo kojoj usluzi su dokumentovana ovde](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
[SpecifiÄna polja koja se mogu koristiti za uslove po usluzi su dokumentovana ovde](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline Policies

Ovakve politike su **direktno dodeljene** korisniku, grupi ili ulozi. Zbog toga se ne pojavljuju na listi politika kao Å¡to to mogu druge.\
Inline policies su korisne ako Å¾elite da **odrÅ¾avate strogu vezu jedan-na-jedan izmeÄ‘u politike i identiteta** na koji se primenjuje. Na primer, Å¾elite da budete sigurni da dozvole u politici nisu nenamerno dodeljene identitetu koji nije predviÄ‘en. Kada koristite inline policy, dozvole u politici ne mogu biti nenamerno dodeljene pogreÅ¡nom identitetu. Pored toga, kada koristite AWS Management Console za brisanje tog identiteta, politike ugraÄ‘ene u identitet se takoÄ‘e briÅ¡u. To je zato Å¡to su deo glavnog entiteta.

#### Resource Bucket Policies

Ovo su **politike** koje se mogu definisati u **resursima**. **Nisu svi resursi AWS-a podrÅ¾ani**.

Ako principal nema eksplicitno odbijanje na njima, a resursna politika im daje pristup, onda im je dozvoljeno.

### IAM Boundaries

IAM boundaries se mogu koristiti za **ograniÄavanje dozvola koje korisnik ili uloga treba da imaju**. Na ovaj naÄin, Äak i ako je korisniku dodeljen drugaÄiji set dozvola putem **drugaÄije politike**, operacija Ä‡e **propasti** ako pokuÅ¡a da ih koristi.

Boundary je samo politika prikaÄena korisniku koja **oznaÄava maksimalni nivo dozvola koje korisnik ili uloga mogu imati**. Dakle, **Äak i ako korisnik ima administratorski pristup**, ako boundary oznaÄava da moÅ¾e samo da Äita S3 bucket-e, to je maksimum koji moÅ¾e da uradi.

**Ovo**, **SCPs** i **praÄ‡enje principa najmanjih privilegija** su naÄini da se kontroliÅ¡e da korisnici nemaju viÅ¡e dozvola nego Å¡to im je potrebno.

### Session Policies

Session policy je **politika postavljena kada se preuzme uloga** na neki naÄin. Ovo Ä‡e biti kao **IAM boundary za tu sesiju**: To znaÄi da session policy ne daje dozvole veÄ‡ **ograniÄava na one navedene u politici** (maksimalne dozvole su one koje uloga ima).

Ovo je korisno za **bezbednosne mere**: Kada admin preuzima veoma privilegovanu ulogu, mogao bi da ograniÄi dozvole samo na one navedene u session policy u sluÄaju da sesija bude kompromitovana.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Imajte na umu da **AWS moÅ¾e dodati sesijske politike sesijama** koje Ä‡e biti generisane zbog treÄ‡ih razloga. Na primer, u [neautentifikovanim cognito preuzetim ulogama](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) po defaultu (koristeÄ‡i poboljÅ¡anu autentifikaciju), AWS Ä‡e generisati **sesijske akreditive sa sesijskom politikom** koja ograniÄava usluge kojima ta sesija moÅ¾e pristupiti [**na sledeÄ‡u listu**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Dakle, ako u nekom trenutku naiÄ‘ete na greÅ¡ku "... jer nijedna sesijska politika ne dozvoljava ...", a uloga ima pristup za izvrÅ¡enje akcije, to je zato Å¡to **postoji sesijska politika koja to spreÄava**.

### Identitetska Federacija

Identitetska federacija **omoguÄ‡ava korisnicima iz provajdera identiteta koji su eksterni** za AWS da pristupe AWS resursima sigurno bez potrebe da dostavljaju AWS korisniÄke akreditive sa validnog IAM korisniÄkog naloga.\
Primer provajdera identiteta moÅ¾e biti vaÅ¡a korporativna **Microsoft Active Directory** (preko **SAML**) ili **OpenID** usluge (kao Å¡to je **Google**). Federisani pristup Ä‡e tada omoguÄ‡iti korisnicima unutar njega da pristupe AWS-u.

Da biste konfigurisali ovo poverenje, generiÅ¡e se **IAM provajder identiteta (SAML ili OAuth)** koji Ä‡e **verovati** **drugoj platformi**. Zatim, najmanje jedna **IAM uloga se dodeljuje (verujuÄ‡i) provajderu identiteta**. Ako korisnik sa poverljive platforme pristupi AWS-u, on Ä‡e pristupati kao pomenuta uloga.

MeÄ‘utim, obiÄno Ä‡ete Å¾eleti da date **drugaÄiju ulogu u zavisnosti od grupe korisnika** na treÄ‡oj platformi. Tada, nekoliko **IAM uloga moÅ¾e verovati** treÄ‡em provajderu identiteta i treÄ‡a platforma Ä‡e biti ta koja omoguÄ‡ava korisnicima da preuzmu jednu ili drugu ulogu.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

AWS IAM Identity Center (naslednik AWS Single Sign-On) proÅ¡iruje moguÄ‡nosti AWS Identity and Access Management (IAM) da pruÅ¾i **centralno mesto** koje okuplja **administraciju korisnika i njihov pristup AWS** nalozima i cloud aplikacijama.

Domen za prijavu Ä‡e biti neÅ¡to poput `<user_input>.awsapps.com`.

Za prijavu korisnika, mogu se koristiti 3 izvora identiteta:

* Identity Center Directory: Regularni AWS korisnici
* Active Directory: PodrÅ¾ava razliÄite konektore
* External Identity Provider: Svi korisnici i grupe dolaze od eksternog provajdera identiteta (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

U najjednostavnijem sluÄaju Identity Center direktorijuma, **Identity Center Ä‡e imati listu korisnika i grupa** i moÄ‡i Ä‡e da **dodeli politike** njima za **bilo koji od naloga** organizacije.

Da biste dali pristup korisniku/grupi iz Identity Center-a nalogu, **biÄ‡e kreiran SAML provajder identiteta koji veruje Identity Center-u**, i **uloga koja veruje provajderu identiteta sa navedenim politikama biÄ‡e kreirana** na odrediÅ¡nom nalogu.

#### AwsSSOInlinePolicy

MoguÄ‡e je **dati dozvole putem inline politika ulogama kreiranim preko IAM Identity Center-a**. Uloge kreirane na nalozima kojima se daju **inline politike u AWS Identity Center-u** Ä‡e imati te dozvole u inline politici nazvanoj **`AwsSSOInlinePolicy`**.

Dakle, Äak i ako vidite 2 uloge sa inline politikom nazvanom **`AwsSSOInlinePolicy`**, to **ne znaÄi da imaju iste dozvole**.

### Cross Account Trusts and Roles

**Korisnik** (verujuÄ‡i) moÅ¾e kreirati Cross Account Role sa nekim politikama i zatim, **dozvoliti drugom korisniku** (pouzdani) da **pristupi njegovom nalogu** ali samo **imajuÄ‡i pristup naveden u novim politikama uloge**. Da biste ovo kreirali, samo kreirajte novu Ulogu i izaberite Cross Account Role. Uloge za Cross-Account Access nude dve opcije. OmoguÄ‡avanje pristupa izmeÄ‘u AWS naloga koje posedujete i omoguÄ‡avanje pristupa izmeÄ‘u naloga koji posedujete i treÄ‡eg AWS naloga.\
PreporuÄuje se da **navedete korisnika kojem se veruje i ne stavite neÅ¡to generiÄko** jer Ä‡e u suprotnom, drugi autentifikovani korisnici poput federisanih korisnika moÄ‡i takoÄ‘e da zloupotrebe ovo poverenje.

### AWS Simple AD

Nije podrÅ¾ano:

* Trust Relations
* AD Admin Center
* Full PS API support
* AD Recycle Bin
* Group Managed Service Accounts
* Schema Extensions
* No Direct access to OS or Instances

#### Web Federation or OpenID Authentication

Aplikacija koristi AssumeRoleWithWebIdentity za kreiranje privremenih akreditiva. MeÄ‘utim, ovo ne omoguÄ‡ava pristup AWS konzoli, samo pristup resursima unutar AWS-a.

### Other IAM options

* MoÅ¾ete **postaviti opcije politike lozinki** kao Å¡to su minimalna duÅ¾ina i zahtevi za lozinku.
* MoÅ¾ete **preuzeti "Credential Report"** sa informacijama o trenutnim akreditivima (kao Å¡to je vreme kreiranja korisnika, da li je lozinka omoguÄ‡ena...). MoÅ¾ete generisati izveÅ¡taj o akreditivima najÄeÅ¡Ä‡e jednom na **Äetiri sata**.

AWS Identity and Access Management (IAM) pruÅ¾a **preciznu kontrolu pristupa** preko celog AWS-a. Sa IAM-om, moÅ¾ete specificirati **ko moÅ¾e pristupiti kojim uslugama i resursima**, i pod kojim uslovima. Sa IAM politikama, upravljate dozvolama za vaÅ¡u radnu snagu i sisteme da **osigurate dozvole najmanje privilegije**.

### IAM ID Prefixes

Na [**ovoj stranici**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) moÅ¾ete pronaÄ‡i **IAM ID prefikse** kljuÄeva u zavisnosti od njihove prirode:

| ABIA | [AWS STS service bearer token](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Context-specific credential                                                                                                                                                                                           |
| AGPA | User group                                                                                                                                                                                                            |
| AIDA | IAM user                                                                                                                                                                                                              |
| AIPA | Amazon EC2 instance profile                                                                                                                                                                                           |
| AKIA | Access key                                                                                                                                                                                                            |
| ANPA | Managed policy                                                                                                                                                                                                        |
| ANVA | Version in a managed policy                                                                                                                                                                                           |
| APKA | Public key                                                                                                                                                                                                            |
| AROA | Role                                                                                                                                                                                                                  |
| ASCA | Certificate                                                                                                                                                                                                           |
| ASIA | [Temporary (AWS STS) access key IDs](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) use this prefix, but are unique only in combination with the secret access key and the session token. |

### Recommended permissions to audit accounts

SledeÄ‡e privilegije omoguÄ‡avaju razliÄite nivoe Äitanja metapodataka:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Misc

### CLI Authentication

Da bi se regularni korisnik autentifikovao na AWS putem CLI, potrebno je da ima **lokalne akreditive**. Po defaultu, moÅ¾ete ih konfigurisati **ruÄno** u `~/.aws/credentials` ili **pokretanjem** `aws configure`.\
U toj datoteci moÅ¾ete imati viÅ¡e od jednog profila, ako **nijedan profil** nije specificiran koristeÄ‡i **aws cli**, koristiÄ‡e se onaj nazvan **`[default]`** u toj datoteci.\
Primer datoteke sa akreditivima sa viÅ¡e od jednog profila:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Ako treba da pristupite **razliÄitim AWS nalozima** i vaÅ¡em profilu je dat pristup da **preuzme ulogu unutar tih naloga**, ne morate ruÄno pozivati STS svaki put (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) i konfigurisati akreditive.

MoÅ¾ete koristiti fajl `~/.aws/config` da[ **naznaÄite koje uloge da preuzmete**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), a zatim koristiti parametar `--profile` kao i obiÄno (preuzimanje uloge Ä‡e biti izvedeno na transparentan naÄin za korisnika).\
Primer konfiguracionog fajla:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Sa ovom konfiguracionom datotekom moÅ¾ete koristiti aws cli kao:
```
aws --profile acc2 ...
```
Ako traÅ¾ite neÅ¡to **sliÄno** ovome, ali za **pregledaÄ**, moÅ¾ete proveriti **ekstenziju** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Reference

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
