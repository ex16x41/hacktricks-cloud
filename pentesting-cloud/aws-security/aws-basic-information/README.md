# AWS - Grundinformationen

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Organisationshierarchie

![](<../../../.gitbook/assets/image (151).png>)

### Konten

In AWS gibt es ein **Root-Konto**, das der **Elterncontainer f√ºr alle Konten** Ihrer **Organisation** ist. Sie m√ºssen jedoch dieses Konto nicht verwenden, um Ressourcen bereitzustellen; Sie k√∂nnen **andere Konten erstellen, um verschiedene AWS** Infrastrukturen voneinander zu trennen.

Dies ist aus **Sicherheits**sicht sehr interessant, da **ein Konto nicht auf Ressourcen eines anderen Kontos zugreifen kann** (es sei denn, es werden speziell Br√ºcken erstellt), sodass Sie auf diese Weise Grenzen zwischen Bereitstellungen schaffen k√∂nnen.

Daher gibt es **zwei Arten von Konten in einer Organisation** (wir sprechen von AWS-Konten und nicht von Benutzerkonten): ein einzelnes Konto, das als Verwaltungskonto bezeichnet wird, und ein oder mehrere Mitgliedskonten.

*   Das **Verwaltungskonto (das Root-Konto)** ist das Konto, das Sie verwenden, um die Organisation zu erstellen. Vom Verwaltungskonto der Organisation aus k√∂nnen Sie Folgendes tun:

* Konten in der Organisation erstellen
* Andere bestehende Konten zur Organisation einladen
* Konten aus der Organisation entfernen
* Einladungen verwalten
* Richtlinien auf Entit√§ten (Wurzeln, OUs oder Konten) innerhalb der Organisation anwenden
* Die Integration mit unterst√ºtzten AWS-Diensten aktivieren, um die Dienstfunktionalit√§t √ºber alle Konten in der Organisation bereitzustellen.
* Es ist m√∂glich, sich als Root-Benutzer mit der E-Mail-Adresse und dem Passwort anzumelden, die zum Erstellen dieses Root-Kontos/der Organisation verwendet wurden.

Das Verwaltungskonto hat die **Verantwortlichkeiten eines Zahlungskontos** und ist verantwortlich f√ºr die Bezahlung aller Geb√ºhren, die von den Mitgliedskonten angefallen sind. Sie k√∂nnen das Verwaltungskonto einer Organisation nicht √§ndern.
* **Mitgliedskonten** bilden alle anderen Konten in einer Organisation. Ein Konto kann nur Mitglied einer Organisation gleichzeitig sein. Sie k√∂nnen eine Richtlinie an ein Konto anh√§ngen, um Kontrollen nur f√ºr dieses eine Konto anzuwenden.
* Mitgliedskonten **m√ºssen eine g√ºltige E-Mail-Adresse verwenden** und k√∂nnen einen **Namen** haben; im Allgemeinen werden sie nicht in der Lage sein, die Abrechnung zu verwalten (aber sie k√∂nnten Zugang dazu erhalten).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organisationseinheiten**

Konten k√∂nnen in **Organisationseinheiten (OU)** gruppiert werden. Auf diese Weise k√∂nnen Sie **Richtlinien** f√ºr die Organisationseinheit erstellen, die auf **alle untergeordneten Konten angewendet werden**. Beachten Sie, dass eine OU andere OUs als Kinder haben kann.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

Eine **Service Control Policy (SCP)** ist eine Richtlinie, die die Dienste und Aktionen angibt, die Benutzer und Rollen in den Konten, auf die die SCP Einfluss hat, verwenden k√∂nnen. SCPs sind **√§hnlich wie IAM** Berechtigungsrichtlinien, mit dem Unterschied, dass sie **keine Berechtigungen gew√§hren**. Stattdessen geben SCPs die **maximalen Berechtigungen** f√ºr eine Organisation, eine organisatorische Einheit (OU) oder ein Konto an. Wenn Sie eine SCP an den Stamm Ihrer Organisation oder an eine OU anh√§ngen, **beschr√§nkt die SCP die Berechtigungen f√ºr Entit√§ten in Mitgliedskonten**.

Dies ist der EINZIGE Weg, wie **sogar der Root-Benutzer daran gehindert werden kann**, etwas zu tun. Zum Beispiel k√∂nnte es verwendet werden, um Benutzer daran zu hindern, CloudTrail zu deaktivieren oder Backups zu l√∂schen.\
Der einzige Weg, dies zu umgehen, besteht darin, auch das **Master-Konto** zu kompromittieren, das die SCPs konfiguriert (das Master-Konto kann nicht blockiert werden).

{% hint style="warning" %}
Beachten Sie, dass **SCPs nur die Prinzipale im Konto einschr√§nken**, sodass andere Konten nicht betroffen sind. Das bedeutet, dass eine SCP, die `s3:GetObject` verweigert, nicht verhindert, dass Personen **auf einen √∂ffentlichen S3-Bucket** in Ihrem Konto zugreifen.
{% endhint %}

SCP-Beispiele:

* Den Root-Account vollst√§ndig verweigern
* Nur bestimmte Regionen zulassen
* Nur genehmigte Dienste zulassen
*   Verweigern, dass GuardDuty, CloudTrail und S3 Public Block Access deaktiviert werden
*   Verweigern, dass Sicherheits-/Vorfallreaktionsrollen gel√∂scht oder

modifiziert werden.
* Verweigern, dass Backups gel√∂scht werden.
* Verweigern, dass IAM-Benutzer und Zugriffsschl√ºssel erstellt werden.

Finden Sie **JSON-Beispiele** in [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples.html)

### ARN

**Amazon Resource Name** ist der **einzigartige Name**, den jede Ressource innerhalb von AWS hat, er setzt sich wie folgt zusammen:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Beachten Sie, dass es 4 Partitionen in AWS gibt, aber nur 3 M√∂glichkeiten, sie zu benennen:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identit√§ts- und Zugriffsmanagement

IAM ist der Dienst, der es Ihnen erm√∂glicht, **Authentifizierung**, **Autorisierung** und **Zugriffskontrolle** innerhalb Ihres AWS-Kontos zu verwalten.

* **Authentifizierung** - Prozess der Definition einer Identit√§t und der √úberpr√ºfung dieser Identit√§t. Dieser Prozess kann unterteilt werden in: Identifikation und Verifizierung.
* **Autorisierung** - Bestimmt, auf was eine Identit√§t innerhalb eines Systems zugreifen kann, nachdem sie authentifiziert wurde.
* **Zugriffskontrolle** - Die Methode und der Prozess, wie der Zugriff auf eine sichere Ressource gew√§hrt wird.

IAM kann durch seine F√§higkeit definiert werden, Authentifizierungs-, Autorisierungs- und Zugriffskontrollmechanismen von Identit√§ten zu Ihren Ressourcen innerhalb Ihres AWS-Kontos zu verwalten, zu steuern und zu regeln.

### [AWS-Konto-Root-Benutzer](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html) <a href="#id_root" id="id_root"></a>

Wenn Sie zum ersten Mal ein Amazon Web Services (AWS)-Konto erstellen, beginnen Sie mit einer einzigen Anmeldeidentit√§t, die **vollst√§ndigen Zugriff auf alle** AWS-Dienste und -Ressourcen im Konto hat. Dies ist der _**Root-Benutzer**_ des AWS-Kontos und wird durch die Anmeldung mit der **E-Mail-Adresse und dem Passwort, die Sie zur Erstellung des Kontos verwendet haben**, aufgerufen.

Beachten Sie, dass ein neuer **Admin-Benutzer** **weniger Berechtigungen als der Root-Benutzer** hat.

Aus sicherheitstechnischer Sicht wird empfohlen, andere Benutzer zu erstellen und diesen zu vermeiden.

### [IAM-Benutzer](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Ein IAM _Benutzer_ ist eine Entit√§t, die Sie in AWS erstellen, um **die Person oder Anwendung** darzustellen, die sie verwendet, um **mit AWS zu interagieren**. Ein Benutzer in AWS besteht aus einem Namen und Anmeldeinformationen (Passwort und bis zu zwei Zugriffsschl√ºssel).

Wenn Sie einen IAM-Benutzer erstellen, gew√§hren Sie ihm **Berechtigungen**, indem Sie ihn zu einer **Gruppe von Benutzern** machen, die geeignete Berechtigungspolicen angeh√§ngt hat (empfohlen), oder indem Sie **direkt Richtlinien** an den Benutzer anh√§ngen.

Benutzer k√∂nnen **MFA aktivieren, um sich** √ºber die Konsole anzumelden. API-Token von MFA-aktivierten Benutzern sind nicht durch MFA gesch√ºtzt. Wenn Sie den **Zugriff der API-Schl√ºssel eines Benutzers mithilfe von MFA einschr√§nken** m√∂chten, m√ºssen Sie in der Richtlinie angeben, dass zur Ausf√ºhrung bestimmter Aktionen MFA vorhanden sein muss (Beispiel [**hier**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_configure-api-require.html)).

#### CLI

* **Zugriffsschl√ºssel-ID**: 20 zuf√§llige Gro√übuchstaben-Zahlenkombinationen wie AKHDNAPO86BSHKDIRYT
* **Geheimer Zugriffsschl√ºssel-ID**: 40 zuf√§llige Gro√ü- und Kleinbuchstaben: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Es ist nicht m√∂glich, verlorene geheime Zugriffsschl√ºssel-IDs wiederherzustellen).

Wann immer Sie den **Zugriffsschl√ºssel √§ndern** m√ºssen, sollten Sie diesen Prozess befolgen:\
&#xNAN;_&#x43;reate a new access key -> Apply the new key to system/application -> mark original one as inactive -> Test and verify new access key is working -> Delete old access key_

### MFA - Multi-Faktor-Authentifizierung

Es wird verwendet, um **einen zus√§tzlichen Faktor f√ºr die Authentifizierung** zus√§tzlich zu Ihren bestehenden Methoden, wie Passwort, zu erstellen und somit ein mehrstufiges Authentifizierungsniveau zu schaffen.\
Sie k√∂nnen eine **kostenlose virtuelle Anwendung oder ein physisches Ger√§t** verwenden. Sie k√∂nnen Apps wie Google Authenticator kostenlos verwenden, um eine MFA in AWS zu aktivieren.

Richtlinien mit MFA-Bedingungen k√∂nnen an Folgendes angeh√§ngt werden:

* Ein IAM-Benutzer oder eine Gruppe
* Eine Ressource wie einen Amazon S3-Bucket, eine Amazon SQS-Warteschlange oder ein Amazon SNS-Thema
* Die Vertrauensrichtlinie einer IAM-Rolle, die von einem Benutzer √ºbernommen werden kann

Wenn Sie √ºber die CLI auf eine Ressource zugreifen m√∂chten, die **MFA √ºberpr√ºft**, m√ºssen Sie **`GetSessionToken`** aufrufen. Das gibt Ihnen ein Token mit Informationen √ºber MFA.\
Beachten Sie, dass **`AssumeRole`-Anmeldeinformationen diese Informationen nicht enthalten**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
As [**hier angegeben**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_configure-api-require.html), gibt es viele verschiedene F√§lle, in denen **MFA nicht verwendet werden kann**.

### [IAM-Benutzergruppen](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Eine IAM [Benutzergruppe](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html) ist eine M√∂glichkeit, **Richtlinien gleichzeitig mehreren Benutzern zuzuordnen**, was die Verwaltung der Berechtigungen f√ºr diese Benutzer erleichtern kann. **Rollen und Gruppen k√∂nnen kein Teil einer Gruppe sein**.

Sie k√∂nnen eine **identit√§tsbasierte Richtlinie an eine Benutzergruppe anh√§ngen**, sodass alle **Benutzer** in der Benutzergruppe **die Berechtigungen der Richtlinie erhalten**. Sie **k√∂nnen** eine **Benutzergruppe** nicht als **`Principal`** in einer **Richtlinie** (wie einer ressourcenbasierten Richtlinie) identifizieren, da Gruppen sich auf Berechtigungen beziehen, nicht auf Authentifizierung, und Principals authentifizierte IAM-Entit√§ten sind.

Hier sind einige wichtige Merkmale von Benutzergruppen:

* Eine Benutzer **gruppe** kann **viele Benutzer enthalten**, und ein **Benutzer** kann **zu mehreren Gruppen geh√∂ren**.
* **Benutzergruppen k√∂nnen nicht geschachtelt werden**; sie k√∂nnen nur Benutzer enthalten, keine anderen Benutzergruppen.
* Es gibt **keine Standardbenutzergruppe, die automatisch alle Benutzer im AWS-Konto einschlie√üt**. Wenn Sie eine solche Benutzergruppe haben m√∂chten, m√ºssen Sie sie erstellen und jeden neuen Benutzer ihr zuweisen.
* Die Anzahl und Gr√∂√üe der IAM-Ressourcen in einem AWS-Konto, wie die Anzahl der Gruppen und die Anzahl der Gruppen, denen ein Benutzer angeh√∂ren kann, sind begrenzt. Weitere Informationen finden Sie unter [IAM- und AWS STS-Quoten](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_iam-quotas.html).

### [IAM-Rollen](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Eine IAM **Rolle** ist **sehr √§hnlich** zu einem **Benutzer**, da sie eine **Identit√§t mit Berechtigungspolitiken ist, die bestimmen, was** sie in AWS tun kann und was nicht. Eine Rolle **hat jedoch keine Anmeldeinformationen** (Passwort oder Zugriffsschl√ºssel), die mit ihr verbunden sind. Anstatt eindeutig mit einer Person verbunden zu sein, ist eine Rolle dazu gedacht, **von jedem, der sie ben√∂tigt (und gen√ºgend Berechtigungen hat), √ºbernommen zu werden**. Ein **IAM-Benutzer kann eine Rolle √ºbernehmen, um vor√ºbergehend** andere Berechtigungen f√ºr eine bestimmte Aufgabe zu erhalten. Eine Rolle kann einem **[federierten Benutzer](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers.html)** zugewiesen werden, der sich √ºber einen externen Identit√§tsanbieter anstelle von IAM anmeldet.

Eine IAM-Rolle besteht aus **zwei Arten von Richtlinien**: einer **Vertrauensrichtlinie**, die nicht leer sein kann und definiert, **wer die Rolle √ºbernehmen kann**, und einer **Berechtigungsrichtlinie**, die nicht leer sein kann und definiert, **auf was sie zugreifen kann**.

#### AWS Security Token Service (STS)

AWS Security Token Service (STS) ist ein Webdienst, der die **Ausstellung von tempor√§ren, eingeschr√§nkten Anmeldeinformationen** erleichtert. Er ist speziell auf folgende Aspekte zugeschnitten:

### [Tempor√§re Anmeldeinformationen in IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Tempor√§re Anmeldeinformationen werden haupts√§chlich mit IAM-Rollen verwendet**, es gibt jedoch auch andere Verwendungen. Sie k√∂nnen tempor√§re Anmeldeinformationen anfordern, die einen eingeschr√§nkteren Satz von Berechtigungen haben als Ihr standardm√§√üiger IAM-Benutzer. Dies **verhindert**, dass Sie **versehentlich Aufgaben ausf√ºhren, die nicht erlaubt sind** durch die eingeschr√§nkten Anmeldeinformationen. Ein Vorteil tempor√§rer Anmeldeinformationen ist, dass sie automatisch nach einer festgelegten Zeitspanne ablaufen. Sie haben die Kontrolle √ºber die Dauer, f√ºr die die Anmeldeinformationen g√ºltig sind.

### Richtlinien

#### Richtlinienberechtigungen

Werden verwendet, um Berechtigungen zuzuweisen. Es gibt 2 Arten:

* AWS verwaltete Richtlinien (vorkonfiguriert von AWS)
* Kundenverwaltete Richtlinien: Von Ihnen konfiguriert. Sie k√∂nnen Richtlinien basierend auf AWS verwalteten Richtlinien erstellen (eine davon √§ndern und Ihre eigene erstellen), den Richtlinien-Generator verwenden (eine GUI-Ansicht, die Ihnen hilft, Berechtigungen zu gew√§hren und zu verweigern) oder Ihre eigenen schreiben.

Standardm√§√üig ist der Zugriff **verweigert**, der Zugriff wird gew√§hrt, wenn eine explizite Rolle angegeben wurde.\
Wenn **einzelne "Verweigerung" existiert, wird sie die "Erlauben" √ºberschreiben**, mit Ausnahme von Anfragen, die die Root-Sicherheitsanmeldeinformationen des AWS-Kontos verwenden (die standardm√§√üig erlaubt sind).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
Die [globalen Felder, die f√ºr Bedingungen in jedem Dienst verwendet werden k√∂nnen, sind hier dokumentiert](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-resourceaccount).\
Die [spezifischen Felder, die f√ºr Bedingungen pro Dienst verwendet werden k√∂nnen, sind hier dokumentiert](https://docs.aws.amazon.com/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html).

#### Inline-Richtlinien

Diese Art von Richtlinien wird **direkt einem Benutzer, einer Gruppe oder einer Rolle zugewiesen**. Daher erscheinen sie nicht in der Richtlinienliste, da sie von niemand anderem verwendet werden k√∂nnen.\
Inline-Richtlinien sind n√ºtzlich, wenn Sie eine **strikte Eins-zu-eins-Beziehung zwischen einer Richtlinie und der Identit√§t** aufrechterhalten m√∂chten, auf die sie angewendet wird. Zum Beispiel m√∂chten Sie sicherstellen, dass die Berechtigungen in einer Richtlinie nicht versehentlich einer anderen Identit√§t zugewiesen werden, als der, f√ºr die sie bestimmt sind. Wenn Sie eine Inline-Richtlinie verwenden, k√∂nnen die Berechtigungen in der Richtlinie nicht versehentlich der falschen Identit√§t zugeordnet werden. Dar√ºber hinaus werden beim L√∂schen dieser Identit√§t √ºber die AWS Management Console auch die in der Identit√§t eingebetteten Richtlinien gel√∂scht. Das liegt daran, dass sie Teil der Hauptentit√§t sind.

#### Ressourcen-Bucket-Richtlinien

Dies sind **Richtlinien**, die in **Ressourcen** definiert werden k√∂nnen. **Nicht alle Ressourcen von AWS unterst√ºtzen sie**.

Wenn eine Hauptentit√§t keine ausdr√ºckliche Ablehnung auf ihnen hat und eine Ressourcenrichtlinie ihnen Zugriff gew√§hrt, dann sind sie erlaubt.

### IAM-Grenzen

IAM-Grenzen k√∂nnen verwendet werden, um **die Berechtigungen, auf die ein Benutzer oder eine Rolle Zugriff haben sollte, einzuschr√§nken**. Auf diese Weise wird die Operation **fehlschlagen**, selbst wenn ein anderes Set von Berechtigungen dem Benutzer durch eine **andere Richtlinie** gew√§hrt wird, wenn er versucht, sie zu verwenden.

Eine Grenze ist einfach eine Richtlinie, die einem Benutzer angeh√§ngt ist, die **das maximale Niveau der Berechtigungen angibt, die der Benutzer oder die Rolle haben kann**. Also, **selbst wenn der Benutzer Administratorzugriff hat**, wenn die Grenze angibt, dass er nur S¬∑ Buckets lesen kann, ist das das Maximum, was er tun kann.

**Dies**, **SCPs** und **das Befolgen des Prinzips der geringsten Privilegien** sind die M√∂glichkeiten, um zu kontrollieren, dass Benutzer nicht mehr Berechtigungen haben, als sie ben√∂tigen.

### Sitzungsrichtlinien

Eine Sitzungsrichtlinie ist eine **Richtlinie, die festgelegt wird, wenn eine Rolle angenommen wird**. Dies wird wie eine **IAM-Grenze f√ºr diese Sitzung** sein: Das bedeutet, dass die Sitzungsrichtlinie keine Berechtigungen gew√§hrt, sondern **sie auf die in der Richtlinie angegebenen beschr√§nkt** (wobei die maximalen Berechtigungen die sind, die die Rolle hat).

Dies ist n√ºtzlich f√ºr **Sicherheitsma√ünahmen**: Wenn ein Administrator eine sehr privilegierte Rolle annehmen m√∂chte, k√∂nnte er die Berechtigungen auf nur die in der Sitzungsrichtlinie angegebenen beschr√§nken, falls die Sitzung kompromittiert wird.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Note that by default **AWS k√∂nnte Sitzungspolitiken zu Sitzungen hinzuf√ºgen**, die aufgrund dritter Gr√ºnde generiert werden. Zum Beispiel in [unauthentifizierten Cognito-angenommenen Rollen](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) wird AWS standardm√§√üig (unter Verwendung verbesserter Authentifizierung) **Sitzungscodes mit einer Sitzungspolitik** generieren, die die Dienste einschr√§nkt, auf die die Sitzung zugreifen kann [**auf die folgende Liste**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Daher, wenn Sie irgendwann den Fehler "... weil keine Sitzungspolitik dies erlaubt ..." erhalten und die Rolle Zugriff auf die Aktion hat, liegt es daran, dass **eine Sitzungspolitik dies verhindert**.

### Identit√§tsf√∂deration

Die Identit√§tsf√∂deration **erm√∂glicht Benutzern von Identit√§tsanbietern, die extern** zu AWS sind, sicher auf AWS-Ressourcen zuzugreifen, ohne AWS-Benutzerdaten von einem g√ºltigen IAM-Benutzerkonto angeben zu m√ºssen.\
Ein Beispiel f√ºr einen Identit√§tsanbieter kann Ihr eigenes Unternehmens-**Microsoft Active Directory** (√ºber **SAML**) oder **OpenID**-Dienste (wie **Google**) sein. Der f√∂derierte Zugriff erm√∂glicht es dann den Benutzern innerhalb davon, auf AWS zuzugreifen.

Um dieses Vertrauen zu konfigurieren, wird ein **IAM-Identit√§tsanbieter (SAML oder OAuth)** generiert, der die **andere Plattform** **vertraut**. Dann wird mindestens eine **IAM-Rolle (vertrauend) dem Identit√§tsanbieter zugewiesen**. Wenn ein Benutzer von der vertrauensw√ºrdigen Plattform auf AWS zugreift, greift er als die genannte Rolle zu.

Sie m√∂chten jedoch normalerweise **eine andere Rolle je nach Gruppe des Benutzers** auf der Drittanbieterplattform vergeben. Dann k√∂nnen mehrere **IAM-Rollen dem Drittanbieter-Identit√§tsanbieter vertrauen**, und die Drittanbieterplattform wird diejenige sein, die es Benutzern erm√∂glicht, eine Rolle oder die andere zu √ºbernehmen.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

AWS IAM Identity Center (Nachfolger von AWS Single Sign-On) erweitert die M√∂glichkeiten von AWS Identity and Access Management (IAM), um einen **zentralen Ort** bereitzustellen, der die **Verwaltung von Benutzern und deren Zugriff auf AWS**-Konten und Cloud-Anwendungen zusammenf√ºhrt.

Die Anmeldedom√§ne wird etwas sein wie `<user_input>.awsapps.com`.

Um Benutzer anzumelden, k√∂nnen 3 Identit√§tsquellen verwendet werden:

* Identity Center-Verzeichnis: Regul√§re AWS-Benutzer
* Active Directory: Unterst√ºtzt verschiedene Connectoren
* Externer Identit√§tsanbieter: Alle Benutzer und Gruppen stammen von einem externen Identit√§tsanbieter (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

Im einfachsten Fall des Identity Center-Verzeichnisses wird das **Identity Center eine Liste von Benutzern & Gruppen** haben und in der Lage sein, **Richtlinien** f√ºr sie zu **irgendeinem der Konten** der Organisation zuzuweisen.

Um einem Benutzer/einer Gruppe im Identity Center Zugriff auf ein Konto zu gew√§hren, wird ein **SAML-Identit√§tsanbieter, der dem Identity Center vertraut, erstellt**, und eine **Rolle, die dem Identit√§tsanbieter mit den angegebenen Richtlinien vertraut, wird im Zielkonto erstellt**.

#### AwsSSOInlinePolicy

Es ist m√∂glich, **Berechtigungen √ºber Inline-Richtlinien f√ºr Rollen zu vergeben, die √ºber IAM Identity Center erstellt wurden**. Die in den Konten erstellten Rollen, die **Inline-Richtlinien im AWS Identity Center** erhalten, haben diese Berechtigungen in einer Inline-Richtlinie namens **`AwsSSOInlinePolicy`**.

Daher bedeutet es nicht, dass, selbst wenn Sie 2 Rollen mit einer Inline-Richtlinie namens **`AwsSSOInlinePolicy`** sehen, dass sie **die gleichen Berechtigungen haben**.

### Cross Account Trusts und Rollen

**Ein Benutzer** (vertrauend) kann eine Cross-Account-Rolle mit einigen Richtlinien erstellen und dann **einem anderen Benutzer** (vertrauensw√ºrdig) erlauben, **auf sein Konto zuzugreifen**, jedoch nur **mit dem Zugriff, der in den neuen Rollrichtlinien angegeben ist**. Um dies zu erstellen, erstellen Sie einfach eine neue Rolle und w√§hlen Sie Cross-Account-Rolle aus. Rollen f√ºr den Cross-Account-Zugriff bieten zwei Optionen. Bereitstellung des Zugriffs zwischen AWS-Konten, die Sie besitzen, und Bereitstellung des Zugriffs zwischen einem Konto, das Sie besitzen, und einem Drittanbieter-AWS-Konto.\
Es wird empfohlen, **den Benutzer, der vertraut ist, anzugeben und nichts Allgemeines zu verwenden**, da sonst andere authentifizierte Benutzer wie f√∂derierte Benutzer dieses Vertrauen ebenfalls missbrauchen k√∂nnen.

### AWS Simple AD

Nicht unterst√ºtzt:

* Vertrauensverh√§ltnisse
* AD-Admin-Center
* Vollst√§ndige PS-API-Unterst√ºtzung
* AD-Warenkorb
* Gruppenverwaltete Dienstkonten
* Schemaerweiterungen
* Kein direkter Zugriff auf OS oder Instanzen

#### Web-F√∂deration oder OpenID-Authentifizierung

Die App verwendet die AssumeRoleWithWebIdentity, um tempor√§re Anmeldeinformationen zu erstellen. Dies gew√§hrt jedoch keinen Zugriff auf die AWS-Konsole, sondern nur auf Ressourcen innerhalb von AWS.

### Weitere IAM-Optionen

* Sie k√∂nnen **eine Passwortrichtlinieneinstellung** mit Optionen wie Mindestl√§nge und Passwortanforderungen festlegen.
* Sie k√∂nnen **einen "Credential Report" herunterladen**, der Informationen √ºber aktuelle Anmeldeinformationen (wie Erstellungszeit des Benutzers, ob das Passwort aktiviert ist...) enth√§lt. Sie k√∂nnen einen Berechtigungsbericht so oft wie einmal alle **vier Stunden** generieren.

AWS Identity and Access Management (IAM) bietet **fein abgestufte Zugriffskontrolle** √ºber alle von AWS. Mit IAM k√∂nnen Sie **festlegen, wer auf welche Dienste und Ressourcen zugreifen kann** und unter welchen Bedingungen. Mit IAM-Richtlinien verwalten Sie Berechtigungen f√ºr Ihre Mitarbeiter und Systeme, um **die Berechtigungen mit minimalen Rechten** sicherzustellen.

### IAM-ID-Pr√§fixe

Auf [**dieser Seite**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_identifiers.html#identifiers-unique-ids) finden Sie die **IAM-ID-Pr√§fixe** von Schl√ºsseln, abh√§ngig von ihrer Natur:

| ABIA | [AWS STS-Dienst-Tr√§ger-Token](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_bearer.html)                                                                                                          |
| ---- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Kontextbezogene Anmeldeinformationen                                                                                                                                                                                          |
| AGPA | Benutzergruppe                                                                                                                                                                                                           |
| AIDA | IAM-Benutzer                                                                                                                                                                                                             |
| AIPA | Amazon EC2-Instanzprofil                                                                                                                                                                                          |
| AKIA | Zugriffsschl√ºssel                                                                                                                                                                                                           |
| ANPA | Verwaltete Richtlinie                                                                                                                                                                                                       |
| ANVA | Version in einer verwalteten Richtlinie                                                                                                                                                                                          |
| APKA | √ñffentlicher Schl√ºssel                                                                                                                                                                                                           |
| AROA | Rolle                                                                                                                                                                                                                 |
| ASCA | Zertifikat                                                                                                                                                                                                          |
| ASIA | [Tempor√§re (AWS STS) Zugriffsschl√ºssel-IDs](https://docs.aws.amazon.com/STS/latest/APIReference/API_Credentials.html) verwenden dieses Pr√§fix, sind jedoch nur in Kombination mit dem geheimen Zugriffsschl√ºssel und dem Sitzungstoken eindeutig. |

### Empfohlene Berechtigungen zur √úberpr√ºfung von Konten

Die folgenden Berechtigungen gew√§hren verschiedenen Lesezugriff auf Metadaten:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Sonstiges

### CLI-Authentifizierung

Damit ein regul√§rer Benutzer sich √ºber die CLI bei AWS authentifizieren kann, m√ºssen **lokale Anmeldeinformationen** vorhanden sein. Standardm√§√üig k√∂nnen Sie diese **manuell** in `~/.aws/credentials` konfigurieren oder **ausf√ºhren** `aws configure`.\
In dieser Datei k√∂nnen Sie mehr als ein Profil haben. Wenn **kein Profil** angegeben ist, wird das in dieser Datei genannte **`[default]`** verwendet.\
Beispiel einer Anmeldeinformationsdatei mit mehr als 1 Profil:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Wenn Sie auf **verschiedene AWS-Konten** zugreifen m√ºssen und Ihr Profil Zugriff auf **das √úbernehmen einer Rolle in diesen Konten** erhalten hat, m√ºssen Sie nicht jedes Mal manuell STS aufrufen (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) und die Anmeldeinformationen konfigurieren.

Sie k√∂nnen die Datei `~/.aws/config` verwenden, um [**anzugeben, welche Rollen √ºbernommen werden sollen**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), und dann den Parameter `--profile` wie gewohnt verwenden (das `assume-role` wird f√ºr den Benutzer transparent durchgef√ºhrt).\
Ein Beispiel f√ºr eine Konfigurationsdatei:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Mit dieser Konfigurationsdatei k√∂nnen Sie dann aws cli wie folgt verwenden:
```
aws --profile acc2 ...
```
Wenn Sie nach etwas **√§hnlichem** suchen, aber f√ºr den **Browser**, k√∂nnen Sie die **Erweiterung** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en) √ºberpr√ºfen.

## Referenzen

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_getting-started_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
