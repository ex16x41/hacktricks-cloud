# AWS - Podstawowe Informacje

{% hint style="success" %}
Ucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Hierarchia Organizacji

![](<../../../.gitbook/assets/image (151).png>)

### Konta

W AWS istnieje **konto root**, kt贸re jest **nadrzdnym kontenerem dla wszystkich kont** w Twojej **organizacji**. Nie musisz jednak u偶ywa tego konta do wdra偶ania zasob贸w, mo偶esz tworzy **inne konta, aby oddzieli r贸偶ne infrastruktury AWS** midzy sob.

Jest to bardzo interesujce z punktu widzenia **bezpieczestwa**, poniewa偶 **jedno konto nie bdzie mogo uzyska dostpu do zasob贸w z innego konta** (chyba 偶e specjalnie utworzone s mosty), dziki czemu mo偶na tworzy granice midzy wdro偶eniami.

W zwizku z tym, w organizacji istniej **dwa rodzaje kont** (m贸wimy o kontach AWS, a nie kontach u偶ytkownik贸w): jedno konto wyznaczone jako konto zarzdzajce oraz jedno lub wicej kont czonkowskich.

*   **Konto zarzdzajce (konto root)** to konto, kt贸rego u偶ywasz do tworzenia organizacji. Z konta zarzdzajcego organizacj mo偶esz wykonywa nastpujce czynnoci:

* Tworzy konta w organizacji
* Zaprasza inne istniejce konta do organizacji
* Usuwa konta z organizacji
* Zarzdza zaproszeniami
* Stosowa polityki do jednostek (korzeni, OU lub kont) w organizacji
* Wcza integracj z obsugiwanymi usugami AWS, aby zapewni funkcjonalno usug we wszystkich kontach w organizacji.
* Mo偶liwe jest logowanie si jako u偶ytkownik root za pomoc e-maila i hasa u偶ytego do utworzenia tego konta root/organizacji.

Konto zarzdzajce ma **odpowiedzialno konta patnika** i jest odpowiedzialne za opacanie wszystkich opat naliczanych przez konta czonkowskie. Nie mo偶na zmieni konta zarzdzajcego organizacj.
* **Konta czonkowskie** stanowi reszt kont w organizacji. Konto mo偶e by czonkiem tylko jednej organizacji na raz. Mo偶esz doczy polityk do konta, aby zastosowa kontrol tylko do tego jednego konta.
* Konta czonkowskie **musz u偶ywa wa偶nego adresu e-mail** i mog mie **nazw**, zazwyczaj nie bd mogy zarzdza rozliczeniami (ale mog mie do nich dostp).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organization Units**

Konta mog by grupowane w **Organization Units (OU)**. W ten spos贸b mo偶esz tworzy **polityki** dla Organization Unit, kt贸re bd **stosowane do wszystkich kont podrzdnych**. Zauwa偶, 偶e OU mo偶e mie inne OU jako podrzdne.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

**Service control policy (SCP)** to polityka, kt贸ra okrela usugi i dziaania, z kt贸rych mog korzysta u偶ytkownicy i role w kontach, na kt贸re wpywa SCP. SCP s **podobne do polityk uprawnie IAM**, z t r贸偶nic, 偶e **nie przyznaj 偶adnych uprawnie**. Zamiast tego, SCP okrelaj **maksymalne uprawnienia** dla organizacji, jednostki organizacyjnej (OU) lub konta. Gdy doczysz SCP do korzenia organizacji lub OU, **SCP ogranicza uprawnienia dla podmiot贸w w kontach czonkowskich**.

To jest JEDYNY spos贸b, aby **nawet u偶ytkownik root nie m贸g czego zrobi**. Na przykad, mo偶e by u偶ywany do uniemo偶liwienia u偶ytkownikom wyczania CloudTrail lub usuwania kopii zapasowych.\
Jedynym sposobem na obejcie tego jest r贸wnie偶 skompromitowanie **konta g贸wnego**, kt贸re konfiguruje SCP (konto g贸wne nie mo偶e by zablokowane).

{% hint style="warning" %}
Nale偶y pamita, 偶e **SCP ograniczaj tylko podmioty w koncie**, wic inne konta nie s dotknite. Oznacza to, 偶e posiadanie SCP odmawiajcego `s3:GetObject` nie uniemo偶liwi ludziom **dostpu do publicznego bucketu S3** w twoim koncie.
{% endhint %}

Przykady SCP:

* Cakowite odm贸wienie dostpu kontu root
* Zezwalanie tylko na okrelone regiony
* Zezwalanie tylko na usugi z biaej listy
*   Odm贸wienie wyczenia GuardDuty, CloudTrail i S3 Public Block Access
*   Odm贸wienie usunicia lub modyfikacji r贸l bezpieczestwa/reakcji na incydenty
* Odm贸wienie usunicia kopii zapasowych
* Odm贸wienie tworzenia u偶ytkownik贸w IAM i kluczy dostpu

Znajd藕 **przykady JSON** na [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** to **unikalna nazwa**, kt贸r ma ka偶dy zas贸b w AWS, skada si z:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Zauwa偶, 偶e w AWS s 4 partycje, ale tylko 3 sposoby, aby je wywoa:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identity and Access Management

IAM to usuga, kt贸ra pozwala zarzdza **Uwierzytelnianiem**, **Autoryzacj** i **Kontrol Dostpu** w Twoim koncie AWS.

* **Uwierzytelnianie** - Proces definiowania to偶samoci i weryfikacji tej to偶samoci. Proces ten mo偶na podzieli na: Identyfikacj i weryfikacj.
* **Autoryzacja** - Okrela, do czego to偶samo ma dostp w systemie po jej uwierzytelnieniu.
* **Kontrola Dostpu** - Metoda i proces przyznawania dostpu do zasobu zabezpieczonego

IAM mo偶na zdefiniowa przez jego zdolno do zarzdzania, kontrolowania i nadzorowania mechanizm贸w uwierzytelniania, autoryzacji i kontroli dostpu to偶samoci do zasob贸w w Twoim koncie AWS.

### [U偶ytkownik root konta AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Kiedy po raz pierwszy tworzysz konto Amazon Web Services (AWS), zaczynasz od pojedynczej to偶samoci logowania, kt贸ra ma **peny dostp do wszystkich** usug i zasob贸w AWS w koncie. Jest to _**u偶ytkownik root konta AWS**_ i uzyskuje si do niego dostp, logujc si za pomoc **adresu e-mail i hasa, kt贸rych u偶ye do utworzenia konta**.

Zauwa偶, 偶e nowy **u偶ytkownik admin** bdzie mia **mniej uprawnie ni偶 u偶ytkownik root**.

Z punktu widzenia bezpieczestwa zaleca si tworzenie innych u偶ytkownik贸w i unikanie u偶ywania tego.

### [U偶ytkownicy IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

U偶ytkownik IAM to jednostka, kt贸r tworzysz w AWS, aby **reprezentowa osob lub aplikacj**, kt贸ra u偶ywa jej do **interakcji z AWS**. U偶ytkownik w AWS skada si z nazwy i powiadcze (haso i do dw贸ch kluczy dostpu).

Kiedy tworzysz u偶ytkownika IAM, nadajesz mu **uprawnienia**, czynic go **czonkiem grupy u偶ytkownik贸w**, kt贸ra ma odpowiednie polityki uprawnie (zalecane), lub **bezporednio przypisujc polityki** do u偶ytkownika.

U偶ytkownicy mog mie **wczone MFA do logowania** przez konsol. Tokeny API u偶ytkownik贸w z wczonym MFA nie s chronione przez MFA. Jeli chcesz **ograniczy dostp do kluczy API u偶ytkownika za pomoc MFA**, musisz wskaza w polityce, 偶e aby wykona okrelone dziaania, MFA musi by obecne (przykad [**tutaj**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **Access Key ID**: 20 losowych wielkich liter i cyfr, np. AKHDNAPO86BSHKDIRYT
* **Secret access key ID**: 40 losowych wielkich i maych liter: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Nie mo偶na odzyska utraconych identyfikator贸w kluczy dostpu).

Kiedy musisz **zmieni klucz dostpu**, oto proces, kt贸ry powiniene wykona:\
_Utw贸rz nowy klucz dostpu -> Zastosuj nowy klucz do systemu/aplikacji -> oznacz oryginalny jako nieaktywny -> Przetestuj i zweryfikuj dziaanie nowego klucza dostpu -> Usu stary klucz dostpu_

### MFA - Multi Factor Authentication

Jest u偶ywane do **tworzenia dodatkowego czynnika uwierzytelniania** opr贸cz istniejcych metod, takich jak haso, tworzc w ten spos贸b wielopoziomowe uwierzytelnianie.\
Mo偶esz u偶y **darmowej aplikacji wirtualnej lub fizycznego urzdzenia**. Mo偶esz u偶y aplikacji takich jak google authentication za darmo, aby aktywowa MFA w AWS.

Polityki z warunkami MFA mog by przypisane do nastpujcych:

* U偶ytkownik lub grupa IAM
* Zas贸b, taki jak Amazon S3 bucket, Amazon SQS queue, lub Amazon SNS topic
* Polityka zaufania roli IAM, kt贸r mo偶e przyj u偶ytkownik

Jeli chcesz **uzyska dostp przez CLI** do zasobu, kt贸ry **sprawdza MFA**, musisz wywoa **`GetSessionToken`**. To da ci token z informacjami o MFA.\
Zauwa偶, 偶e **powiadczenia `AssumeRole` nie zawieraj tych informacji**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Jak [**stwierdzono tutaj**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), istnieje wiele r贸偶nych przypadk贸w, w kt贸rych **MFA nie mo偶e by u偶ywane**.

### [Grupy u偶ytkownik贸w IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Grupa u偶ytkownik贸w IAM to spos贸b na **przypisanie polityk do wielu u偶ytkownik贸w** jednoczenie, co mo偶e uatwi zarzdzanie uprawnieniami tych u偶ytkownik贸w. **Role i grupy nie mog by czci grupy**.

Mo偶esz przypisa **polityk opart na to偶samoci do grupy u偶ytkownik贸w**, aby wszyscy **u偶ytkownicy** w grupie u偶ytkownik贸w **otrzymali uprawnienia polityki**. **Nie mo偶esz** zidentyfikowa **grupy u偶ytkownik贸w** jako **`Principal`** w **polityce** (takiej jak polityka oparta na zasobach), poniewa偶 grupy odnosz si do uprawnie, a nie uwierzytelniania, a principal to uwierzytelnione jednostki IAM.

Oto kilka wa偶nych cech grup u偶ytkownik贸w:

* Grupa u偶ytkownik贸w mo偶e **zawiera wielu u偶ytkownik贸w**, a u偶ytkownik mo偶e **nale偶e do wielu grup**.
* **Grupy u偶ytkownik贸w nie mog by zagnie偶d偶one**; mog zawiera tylko u偶ytkownik贸w, a nie inne grupy u偶ytkownik贸w.
* **Nie ma domylnej grupy u偶ytkownik贸w, kt贸ra automatycznie obejmuje wszystkich u偶ytkownik贸w w koncie AWS**. Jeli chcesz mie tak grup u偶ytkownik贸w, musisz j utworzy i przypisa do niej ka偶dego nowego u偶ytkownika.
* Liczba i rozmiar zasob贸w IAM w koncie AWS, takich jak liczba grup i liczba grup, do kt贸rych u偶ytkownik mo偶e nale偶e, s ograniczone. Wicej informacji znajdziesz w [IAM and AWS STS quotas](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Role IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Rola IAM jest bardzo **podobna** do **u偶ytkownika**, poniewa偶 jest to **to偶samo z politykami uprawnie, kt贸re okrelaj, co** mo偶e, a czego nie mo偶e robi w AWS. Jednak rola **nie ma 偶adnych powiadcze** (hasa ani kluczy dostpu) zwizanych z ni. Zamiast by unikalnie powizana z jedn osob, rola jest przeznaczona do **przyjmowania przez ka偶dego, kto jej potrzebuje (i ma wystarczajce uprawnienia)**. U偶ytkownik IAM mo偶e **przyj rol, aby tymczasowo** uzyska inne uprawnienia do wykonania okrelonego zadania. Rola mo偶e by **przypisana do** [**u偶ytkownika federacyjnego**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html), kt贸ry loguje si za pomoc zewntrznego dostawcy to偶samoci zamiast IAM.

Rola IAM skada si z **dw贸ch rodzaj贸w polityk**: **Polityki zaufania**, kt贸ra nie mo偶e by pusta, definiujcej **kto mo偶e przyj** rol, oraz **polityki uprawnie**, kt贸ra nie mo偶e by pusta, definiujcej **do czego ma dostp**.

#### AWS Security Token Service (STS)

AWS Security Token Service (STS) to usuga internetowa, kt贸ra uatwia **wydawanie tymczasowych, ograniczonych uprawnie powiadcze**. Jest specjalnie dostosowana do:

### [Tymczasowe powiadczenia w IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Tymczasowe powiadczenia s g贸wnie u偶ywane z rolami IAM**, ale istniej r贸wnie偶 inne zastosowania. Mo偶esz za偶da tymczasowych powiadcze, kt贸re maj bardziej ograniczony zestaw uprawnie ni偶 standardowy u偶ytkownik IAM. To **zapobiega** przypadkowemu **wykonywaniu zada, kt贸re nie s dozwolone** przez bardziej ograniczone powiadczenia. Korzyci z tymczasowych powiadcze jest to, 偶e automatycznie wygasaj po okrelonym czasie. Masz kontrol nad czasem, przez jaki powiadczenia s wa偶ne.

### Polityki

#### Uprawnienia polityki

Su偶 do przypisywania uprawnie. Istniej 2 rodzaje:

* Polityki zarzdzane przez AWS (wstpnie skonfigurowane przez AWS)
* Polityki zarzdzane przez klienta: Konfigurowane przez Ciebie. Mo偶esz tworzy polityki na podstawie polityk zarzdzanych przez AWS (modyfikujc jedn z nich i tworzc wasn), u偶ywajc generatora polityk (widok GUI, kt贸ry pomaga w przyznawaniu i odmawianiu uprawnie) lub piszc wasne.

Domylnie dostp jest **odm贸wiony**, dostp zostanie przyznany, jeli okrelono wyra藕n rol.\
Jeli istnieje pojedyncze "Deny", nadpisze ono "Allow", z wyjtkiem 偶da, kt贸re u偶ywaj g贸wnych powiadcze zabezpiecze konta AWS (kt贸re s dozwolone domylnie).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
[Globalne pola, kt贸re mog by u偶ywane do warunk贸w w dowolnej usudze, s udokumentowane tutaj](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
[Specyficzne pola, kt贸re mog by u偶ywane do warunk贸w na usug, s udokumentowane tutaj](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline Policies

Ten rodzaj polityk jest **bezporednio przypisany** do u偶ytkownika, grupy lub roli. Wtedy nie pojawiaj si one na licie Polityk, poniewa偶 nikt inny nie mo偶e ich u偶ywa.\
Inline policies s przydatne, jeli chcesz **utrzyma cisy zwizek jeden do jednego midzy polityk a to偶samoci**, do kt贸rej jest stosowana. Na przykad, chcesz mie pewno, 偶e uprawnienia w polityce nie zostan przypadkowo przypisane do innej to偶samoci ni偶 ta, do kt贸rej s przeznaczone. Kiedy u偶ywasz inline policy, uprawnienia w polityce nie mog by przypadkowo przypisane do niewaciwej to偶samoci. Dodatkowo, kiedy u偶ywasz AWS Management Console do usunicia tej to偶samoci, polityki osadzone w to偶samoci s r贸wnie偶 usuwane. Dzieje si tak, poniewa偶 s one czci g贸wnego podmiotu.

#### Resource Bucket Policies

S to **polityki**, kt贸re mog by zdefiniowane w **zasobach**. **Nie wszystkie zasoby AWS je obsuguj**.

Jeli podmiot nie ma wyra藕nego odmowy na nich, a polityka zasob贸w przyznaje im dostp, to s one dozwolone.

### IAM Boundaries

IAM boundaries mog by u偶ywane do **ograniczenia uprawnie, do kt贸rych u偶ytkownik lub rola powinna mie dostp**. W ten spos贸b, nawet jeli inny zestaw uprawnie jest przyznany u偶ytkownikowi przez **inn polityk**, operacja **zawiedzie**, jeli spr贸buje ich u偶y.

Boundary to po prostu polityka przypisana do u偶ytkownika, kt贸ra **wskazuje maksymalny poziom uprawnie, jakie u偶ytkownik lub rola mog mie**. Wic, **nawet jeli u偶ytkownik ma dostp Administratora**, jeli boundary wskazuje, 偶e mo偶e tylko czyta S3 buckets, to jest to maksymalne, co mo偶e zrobi.

**To**, **SCPs** i **przestrzeganie zasady najmniejszych uprawnie** to sposoby na kontrolowanie, aby u偶ytkownicy nie mieli wicej uprawnie ni偶 potrzebuj.

### Session Policies

Session policy to **polityka ustawiona, gdy rola jest przyjmowana** w jaki spos贸b. Bdzie to jak **IAM boundary dla tej sesji**: Oznacza to, 偶e session policy nie przyznaje uprawnie, ale **ogranicza je do tych wskazanych w polityce** (maksymalne uprawnienia to te, kt贸re ma rola).

Jest to przydatne dla **rodk贸w bezpieczestwa**: Kiedy administrator ma przyj bardzo uprzywilejowan rol, mo偶e ograniczy uprawnienia tylko do tych wskazanych w session policy na wypadek, gdyby sesja zostaa skompromitowana.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Zauwa偶, 偶e domylnie **AWS mo偶e doda polityki sesji do sesji**, kt贸re bd generowane z powodu trzecich powod贸w. Na przykad, w [nieautoryzowanych rolach przyjtych przez cognito](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) domylnie (u偶ywajc ulepszonego uwierzytelniania), AWS wygeneruje **powiadczenia sesji z polityk sesji**, kt贸ra ogranicza usugi, do kt贸rych sesja mo偶e uzyska dostp [**do nastpujcej listy**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Dlatego, jeli w pewnym momencie napotkasz bd "... poniewa偶 偶adna polityka sesji nie pozwala na ...", a rola ma dostp do wykonania akcji, to dlatego, 偶e **istnieje polityka sesji, kt贸ra to uniemo偶liwia**.

### Federacja To偶samoci

Federacja to偶samoci **pozwala u偶ytkownikom z dostawc贸w to偶samoci, kt贸rzy s zewntrzni** wobec AWS, na bezpieczny dostp do zasob贸w AWS bez koniecznoci podawania powiadcze u偶ytkownika AWS z wa偶nego konta IAM.\
Przykadem dostawcy to偶samoci mo偶e by Twoja wasna korporacyjna **Microsoft Active Directory** (przez **SAML**) lub usugi **OpenID** (jak **Google**). Dostp federacyjny pozwoli wtedy u偶ytkownikom w nim na dostp do AWS.

Aby skonfigurowa to zaufanie, generowany jest **dostawca to偶samoci IAM (SAML lub OAuth)**, kt贸ry bdzie **ufa** **innej platformie**. Nastpnie, co najmniej jedna **rola IAM jest przypisana (ufajca) do dostawcy to偶samoci**. Jeli u偶ytkownik z zaufanej platformy uzyska dostp do AWS, bdzie mia dostp jako wspomniana rola.

Jednak zazwyczaj bdziesz chcia przyzna **inn rol w zale偶noci od grupy u偶ytkownika** na platformie trzeciej. Wtedy, kilka **r贸l IAM mo偶e ufa** dostawcy to偶samoci trzeciej strony, a platforma trzeciej strony bdzie t, kt贸ra pozwala u偶ytkownikom przyj jedn rol lub inn.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

AWS IAM Identity Center (nastpca AWS Single Sign-On) rozszerza mo偶liwoci AWS Identity and Access Management (IAM), aby zapewni **centralne miejsce**, kt贸re czy **administracj u偶ytkownikami i ich dostpem do kont AWS** oraz aplikacji w chmurze.

Domena logowania bdzie wyglda jak `<user_input>.awsapps.com`.

Aby zalogowa u偶ytkownik贸w, mo偶na u偶y 3 藕r贸de to偶samoci:

* Identity Center Directory: Zwykli u偶ytkownicy AWS
* Active Directory: Obsuguje r贸偶ne konektory
* Zewntrzny dostawca to偶samoci: Wszyscy u偶ytkownicy i grupy pochodz od zewntrznego dostawcy to偶samoci (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

W najprostszym przypadku katalogu Identity Center, **Identity Center bdzie mia list u偶ytkownik贸w i grup** i bdzie m贸g **przypisywa polityki** do nich do **dowolnego z kont** organizacji.

Aby przyzna dostp u偶ytkownikowi/grupie Identity Center do konta, **zostanie utworzony dostawca to偶samoci SAML ufajcy Identity Center**, a **rola ufajca dostawcy to偶samoci z wskazanymi politykami zostanie utworzona** na docelowym koncie.

#### AwsSSOInlinePolicy

Mo偶liwe jest **przyznanie uprawnie za pomoc polityk inline do r贸l tworzonych przez IAM Identity Center**. Role tworzone na kontach, kt贸rym przyznawane s **polityki inline w AWS Identity Center**, bd miay te uprawnienia w polityce inline zwanej **`AwsSSOInlinePolicy`**.

Dlatego, nawet jeli widzisz 2 role z polityk inline zwan **`AwsSSOInlinePolicy`**, to **nie oznacza, 偶e maj te same uprawnienia**.

### Cross Account Trusts and Roles

**U偶ytkownik** (ufajcy) mo偶e utworzy rol Cross Account z pewnymi politykami, a nastpnie **pozwoli innemu u偶ytkownikowi** (zaufanemu) **uzyska dostp do jego konta**, ale tylko **majc dostp wskazany w nowych politykach roli**. Aby to utworzy, wystarczy utworzy now rol i wybra Cross Account Role. Role dla dostpu midzy kontami oferuj dwie opcje. Zapewnienie dostpu midzy kontami AWS, kt贸re posiadasz, oraz zapewnienie dostpu midzy kontem, kt贸re posiadasz, a kontem AWS trzeciej strony.\
Zaleca si **okrelenie u偶ytkownika, kt贸ry jest zaufany, a nie umieszczanie czego og贸lnego**, poniewa偶 w przeciwnym razie inni uwierzytelnieni u偶ytkownicy, tacy jak u偶ytkownicy federacyjni, bd mogli r贸wnie偶 nadu偶ywa tego zaufania.

### AWS Simple AD

Nieobsugiwane:

* Relacje zaufania
* Centrum administracyjne AD
* Pene wsparcie API PS
* Kosz na mieci AD
* Zarzdzane konta usug grupowych
* Rozszerzenia schematu
* Brak bezporedniego dostpu do OS lub instancji

#### Web Federation or OpenID Authentication

Aplikacja u偶ywa AssumeRoleWithWebIdentity do tworzenia tymczasowych powiadcze. Jednak to nie przyznaje dostpu do konsoli AWS, tylko dostp do zasob贸w w AWS.

### Inne opcje IAM

* Mo偶esz **ustawi polityk hase**, okrelajc opcje takie jak minimalna dugo i wymagania dotyczce hasa.
* Mo偶esz **pobra "Raport powiadcze"** z informacjami o bie偶cych powiadczeniach (takich jak czas utworzenia u偶ytkownika, czy haso jest wczone...). Mo偶esz generowa raport powiadcze tak czsto, jak raz na **cztery godziny**.

AWS Identity and Access Management (IAM) zapewnia **drobnoziarnist kontrol dostpu** w caym AWS. Dziki IAM mo偶esz okreli **kto mo偶e uzyska dostp do kt贸rych usug i zasob贸w**, i na jakich warunkach. Dziki politykom IAM zarzdzasz uprawnieniami dla swojej siy roboczej i system贸w, aby **zapewni uprawnienia najmniejszego przywileju**.

### IAM ID Prefixes

Na [**tej stronie**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) mo偶esz znale藕 **prefiksy ID IAM** kluczy w zale偶noci od ich natury:

| ABIA | [AWS STS service bearer token](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Kontekstowe powiadczenie                                                                                                                                                                                             |
| AGPA | Grupa u偶ytkownik贸w                                                                                                                                                                                                    |
| AIDA | U偶ytkownik IAM                                                                                                                                                                                                        |
| AIPA | Profil instancji Amazon EC2                                                                                                                                                                                           |
| AKIA | Klucz dostpu                                                                                                                                                                                                         |
| ANPA | Zarzdzana polityka                                                                                                                                                                                                   |
| ANVA | Wersja w zarzdzanej polityce                                                                                                                                                                                         |
| APKA | Klucz publiczny                                                                                                                                                                                                       |
| AROA | Rola                                                                                                                                                                                                                  |
| ASCA | Certyfikat                                                                                                                                                                                                            |
| ASIA | [Tymczasowe (AWS STS) identyfikatory kluczy dostpu](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) u偶ywaj tego prefiksu, ale s unikalne tylko w poczeniu z tajnym kluczem dostpu i tokenem sesji. |

### Zalecane uprawnienia do audytu kont

Nastpujce uprawnienia przyznaj r贸偶ne dostpy do metadanych:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## R贸偶ne

### CLI Authentication

Aby zwyky u偶ytkownik m贸g uwierzytelni si w AWS za pomoc CLI, musisz mie **lokalne powiadczenia**. Domylnie mo偶esz je skonfigurowa **rcznie** w `~/.aws/credentials` lub **uruchamiajc** `aws configure`.\
W tym pliku mo偶esz mie wicej ni偶 jeden profil, jeli **偶aden profil** nie jest okrelony przy u偶yciu **aws cli**, u偶ywany bdzie ten o nazwie **`[default]`** w tym pliku.\
Przykad pliku powiadcze z wicej ni偶 jednym profilem:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Jeli potrzebujesz dostpu do **r贸偶nych kont AWS** i Tw贸j profil ma dostp do **przyjcia roli w tych kontach**, nie musisz rcznie wywoywa STS za ka偶dym razem (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) i konfigurowa powiadcze.

Mo偶esz u偶y pliku `~/.aws/config`, aby [**wskaza, kt贸re role przyj**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), a nastpnie u偶y parametru `--profile` jak zwykle (operacja `assume-role` zostanie wykonana w spos贸b przejrzysty dla u偶ytkownika).\
Przykad pliku konfiguracyjnego:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Z tym plikiem konfiguracyjnym mo偶esz nastpnie u偶ywa aws cli, na przykad:
```
aws --profile acc2 ...
```
Jeli szukasz czego **podobnego** do tego, ale dla **przegldarki**, mo偶esz sprawdzi **rozszerzenie** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## References

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
Ucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
