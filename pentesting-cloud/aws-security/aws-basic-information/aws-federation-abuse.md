# AWS - ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‚ªç”¨

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ **ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦**ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰**ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}

## SAML

SAMLã«é–¢ã™ã‚‹æƒ…å ±ã¯ã“ã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„:

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

**SAMLã‚’ä»‹ã—ãŸã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**ã‚’æ§‹æˆã™ã‚‹ã«ã¯ã€**åå‰**ã¨**SAMLæ§‹æˆå…¨ä½“ã‚’å«ã‚€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿XML**ï¼ˆ**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ã€**å…¬é–‹éµã‚’å«ã‚€è¨¼æ˜æ›¸**ï¼‰ã‚’æä¾›ã™ã‚‹ã ã‘ã§ã™ã€‚

## OIDC - Github Actionsã®æ‚ªç”¨

Identityãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨ã—ã¦githubã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã«ã¯:

1. _ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚¿ã‚¤ãƒ—_ã¨ã—ã¦**OpenID Connect**ã‚’é¸æŠã—ã¾ã™ã€‚
2. _ãƒ—ãƒ­ãƒã‚¤ãƒ€URL_ã«ã¯ `https://token.actions.githubusercontent.com` ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
3. ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ã‚µãƒ ãƒ—ãƒªãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ã«ã¯ã€_Get thumbprint_ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
4. _Audience_ ã«ã¯ `sts.amazonaws.com` ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
5. githubã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã¨ã™ã‚‹**æ¨©é™**ã¨ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ä¿¡é ¼ã™ã‚‹**ãƒˆãƒ©ã‚¹ãƒˆãƒãƒªã‚·ãƒ¼**ã‚’æŒã¤**æ–°ã—ã„ãƒ­ãƒ¼ãƒ«**ã‚’ä½œæˆã—ã¾ã™:
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. å‰ã®ãƒãƒªã‚·ãƒ¼ã§ã€**çµ„ç¹”**ã®**ãƒªãƒã‚¸ãƒˆãƒª**ã‹ã‚‰ã®**ãƒ–ãƒ©ãƒ³ãƒ**ã ã‘ãŒç‰¹å®šã®**ãƒˆãƒªã‚¬ãƒ¼**ã§èªå¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
7. githubã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒ**æ¨¡å€£**ã§ãã‚‹**ãƒ­ãƒ¼ãƒ«**ã®**ARN**ã¯ã€githubã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒçŸ¥ã‚‹å¿…è¦ãŒã‚ã‚‹ã€Œç§˜å¯†ã€ã§ã‚ã‚Šã€ãã‚Œã‚’**ç’°å¢ƒ**å†…ã®**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ**ã«**ä¿å­˜**ã—ã¾ã™ã€‚
8. æœ€å¾Œã«ã€AWSã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«githubã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ§‹æˆã—ã¾ã™:
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKSã®æ‚ªç”¨
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
æ¬¡ã®ã‚ˆã†ã«ã—ã¦ã€**EKS**ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§**OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**ã‚’ç°¡å˜ã«ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®**OIDC URL**ã‚’**æ–°ã—ã„Open ID Identityãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**ã¨ã—ã¦è¨­å®šã™ã‚‹ã ã‘ã§ã™ã€‚ã“ã‚Œã¯ä¸€èˆ¬çš„ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ã§ã™ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
ã“ã®ãƒãƒªã‚·ãƒ¼ã¯ã€**id** ãŒ `20C159CDF6F2349B68846BEC03BE031B` ã® **EKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼** ã®ã¿ãŒãã®å½¹å‰²ã‚’å¼•ãå—ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã“ã¨ã‚’æ­£ã—ãç¤ºã—ã¦ã„ã¾ã™ã€‚ãŸã ã—ã€ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãã‚Œã‚’å¼•ãå—ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚’ç¤ºã—ã¦ã„ãªã„ãŸã‚ã€**Web ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã¤ä»»æ„ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ** ãŒãã®å½¹å‰²ã‚’å¼•ãå—ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãã®å½¹å‰²ã‚’å¼•ãå—ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚’æŒ‡å®šã™ã‚‹ã«ã¯**ã€**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹æ¡ä»¶** ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°:

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## å‚è€ƒ

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦**ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰**ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
