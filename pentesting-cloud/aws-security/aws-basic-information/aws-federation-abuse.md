# AWS - Federation Abuse

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## SAML

Î“Î¹Î± Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Ï„Î¿ SAML, Ï€Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ»Î­Î³Î¾Ï„Îµ:

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

Î“Î¹Î± Î½Î± ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ„Îµ Î¼Î¹Î± **ÎŸÎ¼Î¿ÏƒÏ€Î¿Î½Î´Î¯Î± Î¤Î±Ï…Ï„ÏŒÏ„Î·Ï„Î±Ï‚ Î¼Î­ÏƒÏ‰ SAML**, Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î±Ï€Î»ÏÏ‚ Î½Î± Ï€Î±ÏÎ­Ï‡ÎµÏ„Îµ Î­Î½Î± **ÏŒÎ½Î¿Î¼Î±** ÎºÎ±Î¹ Ï„Î¿ **metadata XML** Ï€Î¿Ï… Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ SAML (**endpoints**, **Ï€Î¹ÏƒÏ„Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÏŒ** Î¼Îµ Î´Î·Î¼ÏŒÏƒÎ¹Î¿ ÎºÎ»ÎµÎ¹Î´Î¯)

## OIDC - Github Actions Abuse

Î“Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Î¼Î¹Î± github action Ï‰Ï‚ Ï€Î¬ÏÎ¿Ï‡Î¿ Ï„Î±Ï…Ï„ÏŒÏ„Î·Ï„Î±Ï‚:

1. Î“Î¹Î± _Î¤ÏÏ€Î¿Ï‚ Î Î±ÏÏŒÏ‡Î¿Ï…_, ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ **OpenID Connect**.
2. Î“Î¹Î± _URL Î Î±ÏÏŒÏ‡Î¿Ï…_, ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ `https://token.actions.githubusercontent.com`
3. ÎšÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº ÏƒÏ„Î¿ _Get thumbprint_ Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï„Î¿ thumbprint Ï„Î¿Ï… Ï€Î±ÏÏŒÏ‡Î¿Ï…
4. Î“Î¹Î± _Audience_, ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ `sts.amazonaws.com`
5. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î­Î½Î±Î½ **Î½Î­Î¿ ÏÏŒÎ»Î¿** Î¼Îµ Ï„Î¹Ï‚ **Î¬Î´ÎµÎ¹ÎµÏ‚** Ï€Î¿Ï… Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î· github action ÎºÎ±Î¹ Î¼Î¹Î± **Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎµÎ¼Ï€Î¹ÏƒÏ„Î¿ÏƒÏÎ½Î·Ï‚** Ï€Î¿Ï… ÎµÎ¼Ï€Î¹ÏƒÏ„ÎµÏÎµÏ„Î±Î¹ Ï„Î¿Î½ Ï€Î¬ÏÎ¿Ï‡Î¿ ÏŒÏ€Ï‰Ï‚:
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏƒÏ„Î·Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® Ï€ÏÏ‚ Î¼ÏŒÎ½Î¿ Î¼Î¹Î± **ÎºÎ»Î¬Î´Î¿Ï‚** Î±Ï€ÏŒ **Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î¿** Î¼Î¹Î±Ï‚ **Î¿ÏÎ³Î¬Î½Ï‰ÏƒÎ·Ï‚** ÎµÎ¯Ï‡Îµ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´Î¿Ï„Î·Î¸ÎµÎ¯ Î¼Îµ Î¼Î¹Î± ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î· **ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·**.
7. Î¤Î¿ **ARN** Ï„Î¿Ï… **ÏÏŒÎ»Î¿Ï…** Ï€Î¿Ï… Î· github action Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± **Ï€Î±ÏÎ¹ÏƒÏ„Î¬Î½ÎµÎ¹** Î¸Î± ÎµÎ¯Î½Î±Î¹ Ï„Î¿ "Î¼Ï…ÏƒÏ„Î¹ÎºÏŒ" Ï€Î¿Ï… Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î½Î± Î³Î½Ï‰ÏÎ¯Î¶ÎµÎ¹ Î· github action, Î¿Ï€ÏŒÏ„Îµ **Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÏ„Îµ** Ï„Î¿ Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± **Î¼Ï…ÏƒÏ„Î¹ÎºÏŒ** Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± **Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½**.
8. Î¤Î­Î»Î¿Ï‚, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Î¼Î¹Î± github action Î³Î¹Î± Î½Î± ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ„Îµ Ï„Î± AWS creds Ï€Î¿Ï… Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½ Î±Ï€ÏŒ Ï„Î· ÏÎ¿Î® ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚:
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKS ÎšÎ±Ï„Î¬Ï‡ÏÎ·ÏƒÎ·
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸Î¿ÏÎ½ **OIDC providers** ÏƒÎµ Î­Î½Î± **EKS** cluster Î±Ï€Î»Î¬ ÏÏ…Î¸Î¼Î¯Î¶Î¿Î½Ï„Î±Ï‚ Ï„Î¿ **OIDC URL** Ï„Î¿Ï… cluster Ï‰Ï‚ **Î½Î­Î¿ Open ID Identity provider**. Î‘Ï…Ï„Î® ÎµÎ¯Î½Î±Î¹ Î¼Î¹Î± ÎºÎ¿Î¹Î½Î® Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Î‘Ï…Ï„Î® Î· Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® Ï…Ï€Î¿Î´ÎµÎ¹ÎºÎ½ÏÎµÎ¹ ÏƒÏ‰ÏƒÏ„Î¬ ÏŒÏ„Î¹ **Î¼ÏŒÎ½Î¿** Ï„Î¿ **EKS cluster** Î¼Îµ **id** `20C159CDF6F2349B68846BEC03BE031B` Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î±Î½Î±Î»Î¬Î²ÎµÎ¹ Ï„Î¿Î½ ÏÏŒÎ»Î¿. Î©ÏƒÏ„ÏŒÏƒÎ¿, Î´ÎµÎ½ Ï…Ï€Î¿Î´ÎµÎ¹ÎºÎ½ÏÎµÎ¹ Ï€Î¿Î¹Î¿Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿Î½ Î±Î½Î±Î»Î¬Î²ÎµÎ¹, Ï€ÏÎ¬Î³Î¼Î± Ï€Î¿Ï… ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ ÏŒÏ„Î¹ **ÎŸÎ ÎŸÎ™ÎŸÎ£Î”Î—Î ÎŸÎ¤Î• Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Î¼Îµ Î­Î½Î± web identity token** Î¸Î± ÎµÎ¯Î½Î±Î¹ **ÏƒÎµ Î¸Î­ÏƒÎ· Î½Î± Î±Î½Î±Î»Î¬Î²ÎµÎ¹** Ï„Î¿Î½ ÏÏŒÎ»Î¿.

Î“Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ´Î¹Î¿ÏÎ¹ÏƒÏ„ÎµÎ¯ **Ï€Î¿Î¹Î¿Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Î¸Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î±Î½Î±Î»Î¬Î²ÎµÎ¹ Ï„Î¿Î½ ÏÏŒÎ»Î¿,** ÎµÎ¯Î½Î±Î¹ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î¿ Î½Î± Ï€ÏÎ¿ÏƒÎ´Î¹Î¿ÏÎ¹ÏƒÏ„ÎµÎ¯ Î¼Î¹Î± **ÏƒÏ…Î½Î¸Î®ÎºÎ·** ÏŒÏ€Î¿Ï… Ï„Î¿ **ÏŒÎ½Î¿Î¼Î± Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ ÎµÎ¯Î½Î±Î¹ ÎºÎ±Î¸Î¿ÏÎ¹ÏƒÎ¼Î­Î½Î¿**, ÏŒÏ€Ï‰Ï‚: 

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ ÎºÏŒÎ»Ï€Î± hacking Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
