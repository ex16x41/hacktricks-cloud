# AWS - Federation Abuse

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## SAML

SAML ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç:

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

**SAML ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§è‡§ï ‡§™‡§π‡§ö‡§æ‡§® ‡§∏‡§Ç‡§ò** ‡§ï‡•ã ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§Ü‡§™‡§ï‡•ã ‡§ï‡•á‡§µ‡§≤ ‡§è‡§ï **‡§®‡§æ‡§Æ** ‡§î‡§∞ **‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ XML** ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§∏‡§≠‡•Ä SAML ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§® (**‡§è‡§Ç‡§°‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏**, **‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡•á ‡§∏‡§æ‡§• ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡§§‡•ç‡§∞**) ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•à‡§Ç‡•§

## OIDC - Github Actions Abuse

‡§è‡§ï github ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•ã ‡§™‡§π‡§ö‡§æ‡§® ‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è:

1. _‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞_ ‡§ï‡•á ‡§≤‡§ø‡§è, **OpenID Connect** ‡§ö‡•Å‡§®‡•á‡§Ç‡•§
2. _‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ URL_ ‡§ï‡•á ‡§≤‡§ø‡§è, `https://token.actions.githubusercontent.com` ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§
3. ‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ ‡§ï‡§æ ‡§•‡§Ç‡§¨‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è _Get thumbprint_ ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§
4. _Audience_ ‡§ï‡•á ‡§≤‡§ø‡§è, `sts.amazonaws.com` ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§
5. ‡§è‡§ï **‡§®‡§Ø‡§æ ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ** ‡§¨‡§®‡§æ‡§è‡§Ç ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç github ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•ã ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï **‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡§æ‡§Å** ‡§î‡§∞ ‡§è‡§ï **‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§®‡•Ä‡§§‡§ø** ‡§π‡•ã ‡§ú‡•ã ‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ ‡§™‡§∞ ‡§≠‡§∞‡•ã‡§∏‡§æ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•ã ‡§ú‡•à‡§∏‡•á:
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. ‡§™‡§ø‡§õ‡§≤‡•á ‡§®‡•Ä‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•á‡§µ‡§≤ ‡§è‡§ï **‡§∂‡§æ‡§ñ‡§æ** ‡§ï‡•ã ‡§è‡§ï **‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§®** ‡§ï‡•á **‡§≠‡§Ç‡§°‡§æ‡§∞** ‡§∏‡•á ‡§è‡§ï ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü **‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞** ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§•‡§æ‡•§
7. **‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ** ‡§ï‡§æ **ARN** ‡§ú‡§ø‡§∏‡•á github ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ **‡§™‡•ç‡§∞‡§§‡§ø‡§®‡§ø‡§ß‡§ø‡§§‡•ç‡§µ** ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§π‡•ã‡§ó‡•Ä, ‡§µ‡§π "‡§ó‡•Å‡§™‡•ç‡§§" ‡§π‡•ã‡§ó‡§æ ‡§ú‡§ø‡§∏‡•á github ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•ã ‡§ú‡§æ‡§®‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à, ‡§á‡§∏‡§≤‡§ø‡§è ‡§á‡§∏‡•á ‡§è‡§ï **‡§ó‡•Å‡§™‡•ç‡§§** ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§è‡§ï **‡§™‡§∞‡•ç‡§Ø‡§æ‡§µ‡§∞‡§£** ‡§Æ‡•á‡§Ç **‡§∏‡•ç‡§ü‡•ã‡§∞** ‡§ï‡§∞‡•á‡§Ç‡•§
8. ‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç, ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§™‡•ç‡§∞‡§µ‡§æ‡§π ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§è ‡§ú‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•á AWS ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï github ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç:
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKS ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
‡§Ø‡§π ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§ï‡§ø **EKS** ‡§ï‡•ç‡§≤‡§∏‡•ç‡§ü‡§∞ ‡§Æ‡•á‡§Ç **OIDC providers** ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§ï‡§ø‡§è ‡§ú‡§æ‡§è‡§Ç, ‡§¨‡§∏ ‡§ï‡•ç‡§≤‡§∏‡•ç‡§ü‡§∞ ‡§ï‡•á **OIDC URL** ‡§ï‡•ã **‡§®‡§è Open ID Identity provider** ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§ü ‡§ï‡§∞‡§ï‡•á‡•§ ‡§Ø‡§π ‡§è‡§ï ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§®‡•Ä‡§§‡§ø ‡§π‡•à:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
‡§Ø‡§π ‡§®‡•Ä‡§§‡§ø ‡§∏‡§π‡•Ä ‡§¢‡§Ç‡§ó ‡§∏‡•á ‡§∏‡§Ç‡§ï‡•á‡§§ ‡§ï‡§∞ ‡§∞‡§π‡•Ä ‡§π‡•à ‡§ï‡§ø **‡§ï‡•á‡§µ‡§≤** **EKS ‡§ï‡•ç‡§≤‡§∏‡•ç‡§ü‡§∞** ‡§ú‡§ø‡§∏‡§ï‡§æ **id** `20C159CDF6F2349B68846BEC03BE031B` ‡§π‡•à, ‡§µ‡§π ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ó‡•ç‡§∞‡§π‡§£ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§π‡§æ‡§≤‡§æ‡§Å‡§ï‡§ø, ‡§Ø‡§π ‡§Ø‡§π ‡§®‡§π‡•Ä‡§Ç ‡§¨‡§§‡§æ ‡§∞‡§π‡§æ ‡§π‡•à ‡§ï‡§ø ‡§ï‡•å‡§® ‡§∏‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§á‡§∏‡•á ‡§ó‡•ç‡§∞‡§π‡§£ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à, ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§Ö‡§∞‡•ç‡§• ‡§π‡•à ‡§ï‡§ø **‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§µ‡•á‡§¨ ‡§™‡§π‡§ö‡§æ‡§® ‡§ü‡•ã‡§ï‡§® ‡§π‡•à** ‡§µ‡§π ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ó‡•ç‡§∞‡§π‡§£ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç **‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§π‡•ã‡§ó‡§æ**‡•§

**‡§ú‡§ø‡§∏ ‡§∏‡•á‡§µ‡§æ ‡§ñ‡§æ‡§§‡•á ‡§ï‡•ã ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ó‡•ç‡§∞‡§π‡§£ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è,** ‡§â‡§∏‡•á ‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§è‡§ï **‡§∂‡§∞‡•ç‡§§** ‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü ‡§ï‡§∞‡§®‡§æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à ‡§ú‡§π‡§æ‡§Å **‡§∏‡•á‡§µ‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§®‡§æ‡§Æ ‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à**, ‡§ú‡•à‡§∏‡•á: 

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

{% hint style="success" %}
AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Å**](https://github.com/sponsors/carlospolop) ‡§¶‡•á‡§ñ‡•á‡§Ç!
* **üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**telegram ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ **Twitter** üê¶ ‡§™‡§∞ ‡§π‡§Æ‡•á‡§Ç **‡§´‡•â‡§≤‡•ã** ‡§ï‡§∞‡•á‡§Ç [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞** [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ‡§∞‡§ø‡§™‡•ã‡§ú‡§ø‡§ü‡§∞‡•Ä ‡§Æ‡•á‡§Ç PR ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§

</details>
{% endhint %}
