# AWS - S3 Unauthenticated Enum

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## S3 Public Buckets

Un bucket se considera **‚Äúp√∫blico‚Äù** si **cualquier usuario puede listar el contenido** del bucket, y **‚Äúprivado‚Äù** si el contenido del bucket **solo puede ser listado o escrito por ciertos usuarios**.

Las empresas pueden tener **permisos de buckets mal configurados** dando acceso ya sea a todo o a todos los autenticados en AWS en cualquier cuenta (es decir, a cualquiera). Nota que, incluso con tales configuraciones err√≥neas, algunas acciones podr√≠an no poder realizarse ya que los buckets pueden tener sus propias listas de control de acceso (ACLs).

**Aprende sobre la mala configuraci√≥n de AWS-S3 aqu√≠:** [**http://flaws.cloud**](http://flaws.cloud/) **y** [**http://flaws2.cloud/**](http://flaws2.cloud)

### Finding AWS Buckets

Diferentes m√©todos para encontrar cuando una p√°gina web est√° usando AWS para almacenar algunos recursos:

#### Enumeration & OSINT:

* Usando el plugin de navegador **wappalyzer**
* Usando burp (**spidering** la web) o navegando manualmente por la p√°gina, todos los **recursos** **cargados** se guardar√°n en el Historial.
*   **Revisar recursos** en dominios como:

```
http://s3.amazonaws.com/[bucket_name]/
http://[bucket_name].s3.amazonaws.com/
```
* Revisar **CNAMES** ya que `resources.domain.com` podr√≠a tener el CNAME `bucket.s3.amazonaws.com`
* Revisar [https://buckets.grayhatwarfare.com](https://buckets.grayhatwarfare.com/), una web con **buckets abiertos ya descubiertos**.
* El **nombre del bucket** y el **nombre del dominio del bucket** deben ser **los mismos.**
* **flaws.cloud** est√° en la **IP** 52.92.181.107 y si vas all√≠ te redirige a [https://aws.amazon.com/s3/](https://aws.amazon.com/s3/). Adem√°s, `dig -x 52.92.181.107` da `s3-website-us-west-2.amazonaws.com`.
* Para verificar que es un bucket tambi√©n puedes **visitar** [https://flaws.cloud.s3.amazonaws.com/](https://flaws.cloud.s3.amazonaws.com/).

#### Brute-Force

Puedes encontrar buckets mediante **fuerza bruta de nombres** relacionados con la empresa que est√°s pentesteando:

* [https://github.com/sa7mon/S3Scanner](https://github.com/sa7mon/S3Scanner)
* [https://github.com/clario-tech/s3-inspector](https://github.com/clario-tech/s3-inspector)
* [https://github.com/jordanpotti/AWSBucketDump](https://github.com/jordanpotti/AWSBucketDump) (Contiene una lista con nombres potenciales de buckets)
* [https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets](https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets)
* [https://github.com/smaranchand/bucky](https://github.com/smaranchand/bucky)
* [https://github.com/tomdev/teh\_s3\_bucketeers](https://github.com/tomdev/teh\_s3\_bucketeers)
* [https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3)
* [https://github.com/Eilonh/s3crets\_scanner](https://github.com/Eilonh/s3crets\_scanner)
* [https://github.com/belane/CloudHunter](https://github.com/belane/CloudHunter)

<pre class="language-bash"><code class="lang-bash"># Generar una lista de palabras para crear permutaciones
curl -s https://raw.githubusercontent.com/cujanovic/goaltdns/master/words.txt > /tmp/words-s3.txt.temp
curl -s https://raw.githubusercontent.com/jordanpotti/AWSBucketDump/master/BucketNames.txt >>/tmp/words-s3.txt.temp
cat /tmp/words-s3.txt.temp | sort -u > /tmp/words-s3.txt

# Generar una lista de palabras basada en los dominios y subdominios a probar
## Escribe esos dominios y subdominios en subdomains.txt
cat subdomains.txt > /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "-" >> /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "\n" | sort -u >> /tmp/words-hosts-s3.txt

# Crear permutaciones basadas en una lista con los dominios y subdominios a atacar
goaltdns -l /tmp/words-hosts-s3.txt -w /tmp/words-s3.txt -o /tmp/final-words-s3.txt.temp
## La herramienta anterior est√° especializada en crear permutaciones para subdominios, filtremos esa lista
<strong>### Eliminar l√≠neas que terminan con "."
</strong>cat /tmp/final-words-s3.txt.temp | grep -Ev "\.$" > /tmp/final-words-s3.txt.temp2
### Crear lista sin TLD
cat /tmp/final-words-s3.txt.temp2 | sed -E 's/\.[a-zA-Z0-9]+$//' > /tmp/final-words-s3.txt.temp3
### Crear lista sin puntos
cat /tmp/final-words-s3.txt.temp3 | tr -d "." > /tmp/final-words-s3.txt.temp4http://phantom.s3.amazonaws.com/
### Crear lista sin guiones
cat /tmp/final-words-s3.txt.temp3 | tr "." "-" > /tmp/final-words-s3.txt.temp5

## Generar la lista de palabras final
cat /tmp/final-words-s3.txt.temp2 /tmp/final-words-s3.txt.temp3 /tmp/final-words-s3.txt.temp4 /tmp/final-words-s3.txt.temp5 | grep -v -- "-\." | awk '{print tolower($0)}' | sort -u > /tmp/final-words-s3.txt

## Llamar a s3scanner
s3scanner --threads 100 scan --buckets-file /tmp/final-words-s3.txt  | grep bucket_exists
</code></pre>

#### Loot S3 Buckets

Dado que los buckets S3 est√°n abiertos, [**BucketLoot**](https://github.com/redhuntlabs/BucketLoot) puede **buscar autom√°ticamente informaci√≥n interesante**.

### Find the Region

Puedes encontrar todas las regiones soportadas por AWS en [**https://docs.aws.amazon.com/general/latest/gr/s3.html**](https://docs.aws.amazon.com/general/latest/gr/s3.html)

#### By DNS

Puedes obtener la regi√≥n de un bucket con un **`dig`** y **`nslookup`** haciendo una **solicitud DNS de la IP descubierta**:
```bash
dig flaws.cloud
;; ANSWER SECTION:
flaws.cloud.    5    IN    A    52.218.192.11

nslookup 52.218.192.11
Non-authoritative answer:
11.192.218.52.in-addr.arpa name = s3-website-us-west-2.amazonaws.com.
```
Comprueba que el dominio resuelto tenga la palabra "website".\
Puedes acceder al sitio web est√°tico yendo a: `flaws.cloud.s3-website-us-west-2.amazonaws.com`\
o puedes acceder al bucket visitando: `flaws.cloud.s3-us-west-2.amazonaws.com`

#### Intentando

Si intentas acceder a un bucket, pero en el **nombre de dominio especificas otra regi√≥n** (por ejemplo, el bucket est√° en `bucket.s3.amazonaws.com` pero intentas acceder a `bucket.s3-website-us-west-2.amazonaws.com`, entonces ser√°s **indicado a la ubicaci√≥n correcta**:

![](<../../../.gitbook/assets/image (106).png>)

### Enumerando el bucket

Para probar la apertura del bucket, un usuario puede simplemente ingresar la URL en su navegador web. Un bucket privado responder√° con "Access Denied". Un bucket p√∫blico listar√° los primeros 1,000 objetos que se han almacenado.

Abierto para todos:

![](<../../../.gitbook/assets/image (201).png>)

Privado:

![](<../../..//.gitbook/assets/image (83).png>)

Tambi√©n puedes verificar esto con el cli:
```bash
#Use --no-sign-request for check Everyones permissions
#Use --profile <PROFILE_NAME> to indicate the AWS profile(keys) that youwant to use: Check for "Any Authenticated AWS User" permissions
#--recursive if you want list recursivelyls
#Opcionally you can select the region if you now it
aws s3 ls s3://flaws.cloud/ [--no-sign-request] [--profile <PROFILE_NAME>] [ --recursive] [--region us-west-2]
```
Si el bucket no tiene un nombre de dominio, al intentar enumerarlo, **solo pon el nombre del bucket** y no todo el dominio de AWSs3. Ejemplo: `s3://<BUCKETNAME>`

### Plantilla de URL p√∫blica
```
https://{user_provided}.s3.amazonaws.com
```
### Obtener ID de cuenta desde un Bucket p√∫blico

Es posible determinar una cuenta de AWS aprovechando la nueva **`S3:ResourceAccount`** **Policy Condition Key**. Esta condici√≥n **restringe el acceso basado en el bucket S3** en el que se encuentra una cuenta (otras pol√≠ticas basadas en cuentas restringen seg√∫n la cuenta en la que se encuentra el principal solicitante).\
Y debido a que la pol√≠tica puede contener **comodines**, es posible encontrar el n√∫mero de cuenta **un n√∫mero a la vez**.

Esta herramienta automatiza el proceso:
```bash
# Installation
pipx install s3-account-search
pip install s3-account-search
# With a bucket
s3-account-search arn:aws:iam::123456789012:role/s3_read s3://my-bucket
# With an object
s3-account-search arn:aws:iam::123456789012:role/s3_read s3://my-bucket/path/to/object.ext
```
Esta t√©cnica tambi√©n funciona con URLs de API Gateway, URLs de Lambda, conjuntos de datos de Data Exchange e incluso para obtener el valor de etiquetas (si conoces la clave de la etiqueta). Puedes encontrar m√°s informaci√≥n en la [**investigaci√≥n original**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) y la herramienta [**conditional-love**](https://github.com/plerionhq/conditional-love/) para automatizar esta explotaci√≥n.

### Confirmando que un bucket pertenece a una cuenta de AWS

Como se explica en [**esta publicaci√≥n de blog**](https://blog.plerion.com/things-you-wish-you-didnt-need-to-know-about-s3/)**, si tienes permisos para listar un bucket** es posible confirmar un accountID al que pertenece el bucket enviando una solicitud como:
```bash
curl -X GET "[bucketname].amazonaws.com/" \
-H "x-amz-expected-bucket-owner: [correct-account-id]"

<?xml version="1.0" encoding="UTF-8"?>
<ListBucketResult xmlns="http://s3.amazonaws.com/doc/2006-03-01/">...</ListBucketResult>
```
Si el error es "Access Denied" significa que el ID de la cuenta es incorrecto.

### Usar correos electr√≥nicos como enumeraci√≥n de cuenta ra√≠z

Como se explica en [**esta publicaci√≥n de blog**](https://blog.plerion.com/things-you-wish-you-didnt-need-to-know-about-s3/), es posible verificar si una direcci√≥n de correo electr√≥nico est√° relacionada con alguna cuenta de AWS **intentando otorgar permisos a un correo electr√≥nico** sobre un bucket S3 a trav√©s de ACLs. Si esto no genera un error, significa que el correo electr√≥nico es un usuario ra√≠z de alguna cuenta de AWS:
```python
s3_client.put_bucket_acl(
Bucket=bucket_name,
AccessControlPolicy={
'Grants': [
{
'Grantee': {
'EmailAddress': 'some@emailtotest.com',
'Type': 'AmazonCustomerByEmail',
},
'Permission': 'READ'
},
],
'Owner': {
'DisplayName': 'Whatever',
'ID': 'c3d78ab5093a9ab8a5184de715d409c2ab5a0e2da66f08c2f6cc5c0bdeadbeef'
}
}
)
```
## Referencias

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/](https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/)

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
