# AWS - API Gateway Unauthenticated Enum

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz hakowanie AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz hakowanie GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}

### API Invoke bypass

WedÅ‚ug prezentacji [Attack Vectors for APIs Using AWS API Gateway Lambda Authorizers - Alexandre & Leonardo](https://www.youtube.com/watch?v=bsPKk7WDOnE), Lambda Authorizers mogÄ… byÄ‡ skonfigurowane **uÅ¼ywajÄ…c skÅ‚adni IAM** do nadawania uprawnieÅ„ do wywoÅ‚ywania punktÃ³w koÅ„cowych API. To jest zaczerpniÄ™te [**z dokumentacji**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Permission",
"Action": [
"execute-api:Execution-operation"
],
"Resource": [
"arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
]
}
]
}
```
Problem z tym sposobem nadawania uprawnieÅ„ do wywoÅ‚ywania punktÃ³w koÅ„cowych polega na tym, Å¼e **"\*" oznacza "cokolwiek"** i **nie ma wiÄ™cej obsÅ‚ugiwanej skÅ‚adni regex**.

Kilka przykÅ‚adÃ³w:

* ReguÅ‚a taka jak `arn:aws:execute-apis:sa-east-1:accid:api-id/prod/*/dashboard/*`, aby daÄ‡ kaÅ¼demu uÅ¼ytkownikowi dostÄ™p do `/dashboard/user/{username}`, da im rÃ³wnieÅ¼ dostÄ™p do innych tras, takich jak `/admin/dashboard/createAdmin` na przykÅ‚ad.

{% hint style="warning" %}
NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e **"\*" nie przestaje siÄ™ rozszerzaÄ‡ z ukoÅ›nikami**, dlatego, jeÅ›li uÅ¼yjesz "\*" w api-id na przykÅ‚ad, moÅ¼e to rÃ³wnieÅ¼ oznaczaÄ‡ "dowolny etap" lub "dowolnÄ… metodÄ™", o ile koÅ„cowy regex jest nadal waÅ¼ny.\
WiÄ™c `arn:aws:execute-apis:sa-east-1:accid:*/prod/GET/dashboard/*`\
MoÅ¼e zweryfikowaÄ‡ Å¼Ä…danie post do etapu testowego na Å›cieÅ¼kÄ™ `/prod/GET/dashboard/admin` na przykÅ‚ad.
{% endhint %}

Zawsze powinieneÅ› mieÄ‡ jasnoÅ›Ä‡, co chcesz umoÅ¼liwiÄ‡ do dostÄ™pu, a nastÄ™pnie sprawdziÄ‡, czy inne scenariusze sÄ… moÅ¼liwe z nadanymi uprawnieniami.

WiÄ™cej informacji, oprÃ³cz [**dokumentacji**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html), moÅ¼na znaleÅºÄ‡ w kodzie do implementacji autoryzatorÃ³w w [**tym oficjalnym github aws**](https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/tree/master/blueprints).

### Wstrzykiwanie Polityki IAM

W tej samej [**prezentacji**](https://www.youtube.com/watch?v=bsPKk7WDOnE) jest przedstawiony fakt, Å¼e jeÅ›li kod uÅ¼ywa **danych wejÅ›ciowych uÅ¼ytkownika** do **generowania polityk IAM**, mogÄ… byÄ‡ tam zawarte wildcardy (i inne, takie jak "." lub specyficzne ciÄ…gi znakÃ³w) w celu **obejÅ›cia ograniczeÅ„**.

### Publiczny szablon URL
```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```
### Get Account ID from public API Gateway URL

Podobnie jak w przypadku S3 buckets, Data Exchange i Lambda URLs gateways, moÅ¼liwe jest znalezienie ID konta, wykorzystujÄ…c **`aws:ResourceAccount`** **Policy Condition Key** z publicznego API Gateway URL. Odbywa siÄ™ to poprzez znajdowanie ID konta znak po znaku, wykorzystujÄ…c wildcardy w sekcji **`aws:ResourceAccount`** polityki.\
Ta technika pozwala rÃ³wnieÅ¼ uzyskaÄ‡ **wartoÅ›ci tagÃ³w**, jeÅ›li znasz klucz tagu (istniejÄ… pewne domyÅ›lne interesujÄ…ce).

WiÄ™cej informacji znajdziesz w [**oryginalnym badaniu**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) oraz narzÄ™dziu [**conditional-love**](https://github.com/plerionhq/conditional-love/) do automatyzacji tej eksploatacji.

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
