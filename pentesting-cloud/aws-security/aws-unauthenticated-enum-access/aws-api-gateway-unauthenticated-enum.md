# AWS - API Gateway Unauthenticated Enum

{% hint style="success" %}
AWS í•´í‚¹ í•™ìŠµ ë° ì—°ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ í•™ìŠµ ë° ì—°ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”:** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œ.

</details>
{% endhint %}

### API Invoke ìš°íšŒ

[Attack Vectors for APIs Using AWS API Gateway Lambda Authorizers - Alexandre & Leonardo](https://www.youtube.com/watch?v=bsPKk7WDOnE) ë°œí‘œì— ë”°ë¥´ë©´, Lambda AuthorizersëŠ” **IAM êµ¬ë¬¸**ì„ ì‚¬ìš©í•˜ì—¬ API ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•˜ë„ë¡ êµ¬ì„±ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” [**ë¬¸ì„œ**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html)ì—ì„œ ê°€ì ¸ì˜¨ ê²ƒì…ë‹ˆë‹¤:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Permission",
"Action": [
"execute-api:Execution-operation"
],
"Resource": [
"arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
]
}
]
}
```
ì´ ë°©ë²•ìœ¼ë¡œ ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ë¬¸ì œëŠ” **"\*"ê°€ "ëª¨ë“  ê²ƒ"ì„ ì˜ë¯¸**í•˜ë©° **ë” ì´ìƒ ì •ê·œ í‘œí˜„ì‹ êµ¬ë¬¸ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ”ë‹¤**ëŠ” ì ì…ë‹ˆë‹¤.

ëª‡ ê°€ì§€ ì˜ˆ:

* ê° ì‚¬ìš©ìì—ê²Œ `/dashboard/user/{username}`ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•˜ê¸° ìœ„í•´ `arn:aws:execute-apis:sa-east-1:accid:api-id/prod/*/dashboard/*`ì™€ ê°™ì€ ê·œì¹™ì„ ì‚¬ìš©í•˜ë©´ ì˜ˆë¥¼ ë“¤ì–´ `/admin/dashboard/createAdmin`ê³¼ ê°™ì€ ë‹¤ë¥¸ ê²½ë¡œì—ë„ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

{% hint style="warning" %}
**"\*"ëŠ” ìŠ¬ë˜ì‹œë¡œ í™•ì¥ì´ ë©ˆì¶”ì§€ ì•ŠëŠ”ë‹¤**ëŠ” ì ì— ìœ ì˜í•˜ì‹­ì‹œì˜¤. ë”°ë¼ì„œ ì˜ˆë¥¼ ë“¤ì–´ api-idì— "\*"ë¥¼ ì‚¬ìš©í•˜ë©´ ìµœì¢… ì •ê·œ í‘œí˜„ì‹ì´ ì—¬ì „íˆ ìœ íš¨í•œ í•œ "ëª¨ë“  ë‹¨ê³„" ë˜ëŠ” "ëª¨ë“  ë©”ì„œë“œ"ë¥¼ ë‚˜íƒ€ë‚¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.\
ë”°ë¼ì„œ `arn:aws:execute-apis:sa-east-1:accid:*/prod/GET/dashboard/*`\
ëŠ” ì˜ˆë¥¼ ë“¤ì–´ `/prod/GET/dashboard/admin` ê²½ë¡œë¡œ í…ŒìŠ¤íŠ¸ ë‹¨ê³„ì— ëŒ€í•œ post ìš”ì²­ì„ ê²€ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

í•­ìƒ ë¬´ì—‡ì„ í—ˆìš©í• ì§€ ëª…í™•íˆ í•˜ê³  ë¶€ì—¬ëœ ê¶Œí•œìœ¼ë¡œ ë‹¤ë¥¸ ì‹œë‚˜ë¦¬ì˜¤ê°€ ê°€ëŠ¥í•œì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

ì¶”ê°€ ì •ë³´ëŠ” [**docs**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html) ì™¸ì—ë„ [**ì´ ê³µì‹ aws github**](https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/tree/master/blueprints)ì—ì„œ authorizersë¥¼ êµ¬í˜„í•˜ëŠ” ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### IAM Policy Injection

ë™ì¼í•œ [**talk**](https://www.youtube.com/watch?v=bsPKk7WDOnE)ì—ì„œ ì½”ë“œê°€ **ì‚¬ìš©ì ì…ë ¥**ì„ ì‚¬ìš©í•˜ì—¬ **IAM ì •ì±…ì„ ìƒì„±**í•˜ëŠ” ê²½ìš°, ì™€ì¼ë“œì¹´ë“œ(ë° "." ë˜ëŠ” íŠ¹ì • ë¬¸ìì—´ ë“±)ê°€ í¬í•¨ë˜ì–´ **ì œí•œì„ ìš°íšŒ**í•  ìˆ˜ ìˆë‹¤ëŠ” ì‚¬ì‹¤ì´ ë…¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.

### Public URL template
```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```
### Get Account ID from public API Gateway URL

S3 ë²„í‚·, Data Exchange ë° Lambda URL ê²Œì´íŠ¸ì›¨ì´ì™€ ë§ˆì°¬ê°€ì§€ë¡œ, ê³µê°œ API Gateway URLì—ì„œ **`aws:ResourceAccount`** **Policy Condition Key**ë¥¼ ì•…ìš©í•˜ì—¬ ê³„ì • IDë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì •ì±…ì˜ **`aws:ResourceAccount`** ì„¹ì…˜ì—ì„œ ì™€ì¼ë“œì¹´ë“œë¥¼ ì•…ìš©í•˜ì—¬ í•œ ë²ˆì— í•œ ë¬¸ìì”© ê³„ì • IDë¥¼ ì°¾ëŠ” ë°©ì‹ìœ¼ë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤.\
ì´ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë©´ íƒœê·¸ í‚¤ë¥¼ ì•Œê³  ìˆëŠ” ê²½ìš° **íƒœê·¸ì˜ ê°’**ë„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ê¸°ë³¸ì ìœ¼ë¡œ í¥ë¯¸ë¡œìš´ ê²ƒë“¤ì´ ìˆìŠµë‹ˆë‹¤).

ìì„¸í•œ ë‚´ìš©ì€ [**original research**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) ë° ì´ ìµìŠ¤í”Œë¡œì‡ì„ ìë™í™”í•˜ëŠ” ë„êµ¬ [**conditional-love**](https://github.com/plerionhq/conditional-love/)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="success" %}
AWS í•´í‚¹ í•™ìŠµ ë° ì—°ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ í•™ìŠµ ë° ì—°ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram group**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* PRì„ ì œì¶œí•˜ì—¬ [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
