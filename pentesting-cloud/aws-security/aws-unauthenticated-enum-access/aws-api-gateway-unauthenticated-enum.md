# AWS - API Gateway Unauthenticated Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Contournement de l'invocation de l'API

Selon la pr√©sentation [Attack Vectors for APIs Using AWS API Gateway Lambda Authorizers - Alexandre & Leonardo](https://www.youtube.com/watch?v=bsPKk7WDOnE), les Lambda Authorizers peuvent √™tre configur√©s **en utilisant la syntaxe IAM** pour donner des permissions d'invocation des points de terminaison de l'API. Cela est tir√© [**des docs**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Permission",
"Action": [
"execute-api:Execution-operation"
],
"Resource": [
"arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
]
}
]
}
```
Le probl√®me avec cette fa√ßon de donner des permissions pour invoquer des points de terminaison est que le **"\*" implique "tout"** et qu'il **n'y a plus de syntaxe regex support√©e**.

Quelques exemples :

* Une r√®gle telle que `arn:aws:execute-apis:sa-east-1:accid:api-id/prod/*/dashboard/*` afin de donner √† chaque utilisateur acc√®s √† `/dashboard/user/{username}` leur donnera acc√®s √† d'autres routes telles que `/admin/dashboard/createAdmin` par exemple.

{% hint style="warning" %}
Notez que **"\*" ne cesse pas de s'√©tendre avec des barres obliques**, donc, si vous utilisez "\*" dans api-id par exemple, cela pourrait √©galement indiquer "n'importe quelle √©tape" ou "n'importe quelle m√©thode" tant que la regex finale est toujours valide.\
Ainsi, `arn:aws:execute-apis:sa-east-1:accid:*/prod/GET/dashboard/*`\
Peut valider une requ√™te post pour tester l'√©tape vers le chemin `/prod/GET/dashboard/admin` par exemple.
{% endhint %}

Vous devez toujours avoir clairement en t√™te ce que vous souhaitez autoriser √† acc√©der et ensuite v√©rifier si d'autres sc√©narios sont possibles avec les permissions accord√©es.

Pour plus d'infos, en plus des [**docs**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html), vous pouvez trouver du code pour impl√©menter des autorisateurs dans [**ce github officiel aws**](https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/tree/master/blueprints).

### Injection de politique IAM

Dans la m√™me [**pr√©sentation**](https://www.youtube.com/watch?v=bsPKk7WDOnE), il est expos√© que si le code utilise **l'entr√©e utilisateur** pour **g√©n√©rer les politiques IAM**, des jokers (et d'autres tels que "." ou des cha√Ænes sp√©cifiques) peuvent y √™tre inclus dans le but de **contourner les restrictions**.

### Mod√®le d'URL publique
```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```
### Obtenir l'ID de compte √† partir de l'URL publique de l'API Gateway

Tout comme avec les buckets S3, les passerelles Data Exchange et Lambda, il est possible de trouver l'ID de compte d'un compte en abusant de la **`aws:ResourceAccount`** **Policy Condition Key** √† partir d'une URL publique de l'API Gateway. Cela se fait en trouvant l'ID de compte un caract√®re √† la fois en abusant des jokers dans la section **`aws:ResourceAccount`** de la politique.\
Cette technique permet √©galement d'obtenir **les valeurs des tags** si vous connaissez la cl√© du tag (il y en a quelques-unes par d√©faut int√©ressantes).

Vous pouvez trouver plus d'informations dans la [**recherche originale**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) et l'outil [**conditional-love**](https://github.com/plerionhq/conditional-love/) pour automatiser cette exploitation.

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
