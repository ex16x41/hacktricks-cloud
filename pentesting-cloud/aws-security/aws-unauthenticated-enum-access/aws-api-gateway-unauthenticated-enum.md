# AWS - API Gateway Unauthenticated Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### API Invoke bypass

Zgodnie z prezentacjÄ… [Attack Vectors for APIs Using AWS API Gateway Lambda Authorizers - Alexandre & Leonardo](https://www.youtube.com/watch?v=bsPKk7WDOnE), Lambda Authorizers mogÄ… byÄ‡ konfigurowane **przy uÅ¼yciu skÅ‚adni IAM** w celu nadania uprawnieÅ„ do wywoÅ‚ywania punktÃ³w koÅ„cowych API. To jest wziÄ™te [**z dokumentacji**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Permission",
"Action": [
"execute-api:Execution-operation"
],
"Resource": [
"arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
]
}
]
}
```
Problem z tym sposobem nadawania uprawnieÅ„ do wywoÅ‚ywania punktÃ³w koÅ„cowych polega na tym, Å¼e **"\*" oznacza "cokolwiek"** i **nie obsÅ‚uguje wiÄ™cej skÅ‚adni regex**.

Kilka przykÅ‚adÃ³w:

* ReguÅ‚a taka jak `arn:aws:execute-apis:sa-east-1:accid:api-id/prod/*/dashboard/*`, aby daÄ‡ kaÅ¼demu uÅ¼ytkownikowi dostÄ™p do `/dashboard/user/{username}`, da im dostÄ™p do innych tras, takich jak `/admin/dashboard/createAdmin`, na przykÅ‚ad.

{% hint style="warning" %}
ZauwaÅ¼, Å¼e **"\*" nie przestaje siÄ™ rozwijaÄ‡ z ukoÅ›nikami**, dlatego, jeÅ›li uÅ¼yjesz "\*" w api-id, na przykÅ‚ad, moÅ¼e to rÃ³wnieÅ¼ oznaczaÄ‡ "dowolny etap" lub "dowolnÄ… metodÄ™", o ile koÅ„cowy regex jest nadal waÅ¼ny.\
WiÄ™c `arn:aws:execute-apis:sa-east-1:accid:*/prod/GET/dashboard/*`\
MoÅ¼e zwalidowaÄ‡ Å¼Ä…danie POST do etapu testowego do Å›cieÅ¼ki `/prod/GET/dashboard/admin`, na przykÅ‚ad.
{% endhint %}

Zawsze powinieneÅ› mieÄ‡ jasno okreÅ›lone, co chcesz zezwoliÄ‡ na dostÄ™p, a nastÄ™pnie sprawdziÄ‡, czy inne scenariusze sÄ… moÅ¼liwe z przyznanymi uprawnieniami.

Aby uzyskaÄ‡ wiÄ™cej informacji, oprÃ³cz [**dokumentacji**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html), moÅ¼esz znaleÅºÄ‡ kod do implementacji autoryzatorÃ³w w [**tym oficjalnym githubie aws**](https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/tree/master/blueprints).

### Wstrzykiwanie polityki IAM

W tej samej [**prezentacji**](https://www.youtube.com/watch?v=bsPKk7WDOnE) ujawniono fakt, Å¼e jeÅ›li kod uÅ¼ywa **danych wejÅ›ciowych uÅ¼ytkownika** do **generowania polityk IAM**, dzikie znaki (i inne, takie jak "." lub konkretne ciÄ…gi) mogÄ… byÄ‡ tam zawarte w celu **obejÅ›cia ograniczeÅ„**.

### Szablon publicznego URL
```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```
### Uzyskaj identyfikator konta z publicznego adresu URL API Gateway

Podobnie jak w przypadku koszykÃ³w S3, Data Exchange i adresÃ³w URL bramek Lambda, moÅ¼liwe jest znalezienie identyfikatora konta, wykorzystujÄ…c **`aws:ResourceAccount`** **Policy Condition Key** z publicznego adresu URL API Gateway. Robi siÄ™ to, znajdujÄ…c identyfikator konta jeden znak na raz, wykorzystujÄ…c znaki wieloznaczne w sekcji **`aws:ResourceAccount`** polityki.\
Ta technika pozwala rÃ³wnieÅ¼ uzyskaÄ‡ **wartoÅ›ci tagÃ³w**, jeÅ›li znasz klucz tagu (istnieje kilka domyÅ›lnych, interesujÄ…cych).

MoÅ¼esz znaleÅºÄ‡ wiÄ™cej informacji w [**oryginalnych badaniach**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) oraz w narzÄ™dziu [**conditional-love**](https://github.com/plerionhq/conditional-love/), aby zautomatyzowaÄ‡ tÄ™ eksploitacjÄ™.

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
