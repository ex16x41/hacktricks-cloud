# AWS - API Gateway Unauthenticated Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### API Invoke bypass

Σύμφωνα με την ομιλία [Attack Vectors for APIs Using AWS API Gateway Lambda Authorizers - Alexandre & Leonardo](https://www.youtube.com/watch?v=bsPKk7WDOnE), οι Lambda Authorizers μπορούν να ρυθμιστούν **χρησιμοποιώντας σύνταξη IAM** για να δώσουν άδειες για την κλήση API endpoints. Αυτό προέρχεται [**από τα έγγραφα**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Permission",
"Action": [
"execute-api:Execution-operation"
],
"Resource": [
"arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
]
}
]
}
```
Το πρόβλημα με αυτόν τον τρόπο παροχής δικαιωμάτων για την κλήση endpoints είναι ότι το **"\*" υποδηλώνει "οτιδήποτε"** και δεν υποστηρίζεται **καμία άλλη σύνταξη regex**.

Ορισμένα παραδείγματα:

* Ένας κανόνας όπως `arn:aws:execute-apis:sa-east-1:accid:api-id/prod/*/dashboard/*` προκειμένου να δώσει σε κάθε χρήστη πρόσβαση στο `/dashboard/user/{username}` θα τους δώσει πρόσβαση σε άλλες διαδρομές όπως το `/admin/dashboard/createAdmin` για παράδειγμα.

{% hint style="warning" %}
Σημειώστε ότι το **"\*" δεν σταματά να επεκτείνεται με διαγωνίους**, επομένως, αν χρησιμοποιήσετε "\*" στο api-id για παράδειγμα, μπορεί επίσης να υποδηλώνει "οποιοδήποτε στάδιο" ή "οποιαδήποτε μέθοδο" εφόσον η τελική regex είναι ακόμα έγκυρη.\
Έτσι, `arn:aws:execute-apis:sa-east-1:accid:*/prod/GET/dashboard/*`\
Μπορεί να επικυρώσει ένα αίτημα POST για να δοκιμάσει το στάδιο στη διαδρομή `/prod/GET/dashboard/admin` για παράδειγμα.
{% endhint %}

Πρέπει πάντα να έχετε σαφές τι θέλετε να επιτρέψετε να έχει πρόσβαση και στη συνέχεια να ελέγξετε αν είναι δυνατές άλλες καταστάσεις με τα παραχωρηθέντα δικαιώματα.

Για περισσότερες πληροφορίες, εκτός από τα [**docs**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html), μπορείτε να βρείτε κώδικα για την υλοποίηση authorizers σε [**αυτό το επίσημο aws github**](https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/tree/master/blueprints).

### IAM Policy Injection

Στην ίδια [**ομιλία**](https://www.youtube.com/watch?v=bsPKk7WDOnE) εκτίθεται το γεγονός ότι αν ο κώδικας χρησιμοποιεί **είσοδο χρήστη** για να **δημιουργήσει τις IAM πολιτικές**, wildcards (και άλλα όπως "." ή συγκεκριμένες συμβολοσειρές) μπορούν να περιληφθούν εκεί με στόχο την **παράκαμψη περιορισμών**.

### Δημόσιο πρότυπο URL
```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```
### Πάρε το ID λογαριασμού από τη δημόσια διεύθυνση URL του API Gateway

Ακριβώς όπως με τα S3 buckets, τα Data Exchange και τις διευθύνσεις URL των Lambda gateways, είναι δυνατόν να βρείτε το ID λογαριασμού ενός λογαριασμού εκμεταλλευόμενοι το **`aws:ResourceAccount`** **Policy Condition Key** από μια δημόσια διεύθυνση URL του API Gateway. Αυτό γίνεται βρίσκοντας το ID λογαριασμού χαρακτήρα προς χαρακτήρα εκμεταλλευόμενοι τα wildcards στην ενότητα **`aws:ResourceAccount`** της πολιτικής.\
Αυτή η τεχνική επιτρέπει επίσης να αποκτήσετε **τιμές ετικετών** αν γνωρίζετε το κλειδί της ετικέτας (υπάρχουν μερικές προεπιλεγμένες ενδιαφέρουσες).

Μπορείτε να βρείτε περισσότερες πληροφορίες στην [**αρχική έρευνα**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) και το εργαλείο [**conditional-love**](https://github.com/plerionhq/conditional-love/) για να αυτοματοποιήσετε αυτή την εκμετάλλευση.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
