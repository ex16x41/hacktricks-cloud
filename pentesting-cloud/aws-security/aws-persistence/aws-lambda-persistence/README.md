# AWS - Lambda Persistence

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}

## Lambda

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="../../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistence

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **рдХреЛрдИ рд▓реЗрдпрд░ рдкреЗрд╢ рдХрд░реЗрдВ/backdoor рдХрд░реЗрдВ рддрд╛рдХрд┐ рдЬрдм lambda рдХреЛ stealthy рддрд░реАрдХреЗ рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдП рддреЛ рдордирдорд╛рдирд╛ рдХреЛрдб рдЪрд▓ рд╕рдХреЗ**:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension Persistence

Lambda Layers рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдП рдФрд░ lambda рдореЗрдВ рд╕реНрдерд╛рдпреА рд░реВрдк рд╕реЗ рдмрдиреЗ рд░рд╣реЗрдВ, рдмрд▓реНрдХрд┐ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдЪреБрд░рд╛рдПрдВ рдФрд░ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВред

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### Via resource policies

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдмрд╛рд╣рд░реА рдЦрд╛рддреЛрдВ рдХреЛ рд╡рд┐рднрд┐рдиреНрди lambda рдХреНрд░рд┐рдпрд╛рдУрдВ (рдЬреИрд╕реЗ invoke рдпрд╛ update code) рддрдХ рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рдП:

<figure><img src="../../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

рдПрдХ Lambda рдореЗрдВ **рд╡рд┐рднрд┐рдиреНрди рд╕рдВрд╕реНрдХрд░рдг** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ (рдкреНрд░рддреНрдпреЗрдХ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд╕рд╛рде рдЕрд▓рдЧ рдХреЛрдб)ред\
рдлрд┐рд░, рдЖрдк lambda рдХреЗ **рд╡рд┐рднрд┐рдиреНрди рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХреЗ рд╕рд╛рде рд╡рд┐рднрд┐рдиреНрди рдЙрдкрдирд╛рдо** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдХреЛ рд╡рд┐рднрд┐рдиреНрди рд╡рдЬрди рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
рдЗрд╕ рддрд░рд╣ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **backdoored version 1** рдФрд░ **version 2 рдХреЗрд╡рд▓ рд╡реИрдз рдХреЛрдб рдХреЗ рд╕рд╛рде** рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рдХреЗрд╡рд▓ 1%** рдЕрдиреБрд░реЛрдзреЛрдВ рдореЗрдВ рд╕рдВрд╕реНрдХрд░рдг 1 рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ stealth рдмрдирд╛ рд░рд╣реЗред

<figure><img src="../../../../.gitbook/assets/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Lambda рдХрд╛ рдореВрд▓ рдХреЛрдб рдХреЙрдкреА рдХрд░реЗрдВ
2. **рдореВрд▓ рдХреЛрдб рдХреЛ backdooring рдХрд░рддреЗ рд╣реБрдП рдПрдХ рдирдпрд╛ рд╕рдВрд╕реНрдХрд░рдг рдмрдирд╛рдПрдВ** (рдпрд╛ рдХреЗрд╡рд▓ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХреЛрдб рдХреЗ рд╕рд╛рде)ред рдЙрд╕ рд╕рдВрд╕реНрдХрд░рдг рдХреЛ рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд░реЗрдВ рдФрд░ **$LATEST рдкрд░ рддреИрдирд╛рдд рдХрд░реЗрдВ**
1. рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП lambda рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд API рдЧреЗрдЯрд╡реЗ рдХреЛ рдХреЙрд▓ рдХрд░реЗрдВ
3. **рдореВрд▓ рдХреЛрдб рдХреЗ рд╕рд╛рде рдПрдХ рдирдпрд╛ рд╕рдВрд╕реНрдХрд░рдг рдмрдирд╛рдПрдВ**, рдЙрд╕ **рд╕рдВрд╕реНрдХрд░рдг рдХреЛ рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд░реЗрдВ** рдФрд░ **$LATEST рдкрд░ рддреИрдирд╛рдд рдХрд░реЗрдВ**ред
1. рдпрд╣ рдкрд┐рдЫрд▓реЗ рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ backdoored рдХреЛрдб рдХреЛ рдЫрд┐рдкрд╛ рджреЗрдЧрд╛
4. API рдЧреЗрдЯрд╡реЗ рдкрд░ рдЬрд╛рдПрдВ рдФрд░ **рдПрдХ рдирдпрд╛ POST рд╡рд┐рдзрд┐ рдмрдирд╛рдПрдВ** (рдпрд╛ рдХреЛрдИ рдЕрдиреНрдп рд╡рд┐рдзрд┐ рдЪреБрдиреЗрдВ) рдЬреЛ lambda рдХреЗ backdoored рд╕рдВрд╕реНрдХрд░рдг рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. рдЕрдВрддрд┐рдо :1 рдХреЛ рдиреЛрдЯ рдХрд░реЗрдВ рдЬреЛ **рдХрд╛рд░реНрдп рдХреЗ рд╕рдВрд╕реНрдХрд░рдг рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ** (рдЗрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ рд╕рдВрд╕реНрдХрд░рдг 1 backdoored рд╣реЛрдЧрд╛)ред
5. рдмрдирд╛рдП рдЧрдП POST рд╡рд┐рдзрд┐ рдХрд╛ рдЪрдпрди рдХрд░реЗрдВ рдФрд░ рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ **`Deploy API`** рдЪреБрдиреЗрдВ
6. рдЕрдм, рдЬрдм рдЖрдк **POST рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд╛рд░реНрдп рдХреЛ рдХреЙрд▓ рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдЖрдкрдХрд╛ Backdoor** рд╕рдХреНрд░рд┐рдп рд╣реЛрдЧрд╛

### Cron/Event actuator

рдпрд╣ рддрдереНрдп рдХрд┐ рдЖрдк **lambda рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рддрдм рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрдм рдХреБрдЫ рд╣реЛрддрд╛ рд╣реИ рдпрд╛ рдЬрдм рдХреБрдЫ рд╕рдордп рдмреАрддрддрд╛ рд╣реИ** lambda рдХреЛ рд╕реНрдерд╛рдпреАрддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдФрд░ рдкрд╣рдЪрд╛рди рд╕реЗ рдмрдЪрдиреЗ рдХрд╛ рдПрдХ рдЕрдЪреНрдЫрд╛ рдФрд░ рд╕рд╛рдорд╛рдиреНрдп рддрд░реАрдХрд╛ рдмрдирд╛рддрд╛ рд╣реИред\
рдпрд╣рд╛рдВ рдЖрдкрдХреЗ **AWS рдореЗрдВ рдЙрдкрд╕реНрдерд┐рддрд┐ рдХреЛ stealth рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП lambdas рдмрдирд╛рдиреЗ рдХреЗ рдХреБрдЫ рд╡рд┐рдЪрд╛рд░ рд╣реИрдВ**ред

* рд╣рд░ рдмрд╛рд░ рдЬрдм рдПрдХ рдирдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ lambda рдПрдХ рдирдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреБрдВрдЬреА рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рднреЗрдЬрддрд╛ рд╣реИред
* рд╣рд░ рдмрд╛рд░ рдЬрдм рдПрдХ рдирдИ рднреВрдорд┐рдХрд╛ рдмрдирд╛рдИ рдЬрд╛рддреА рд╣реИ, рддреЛ lambda рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ assume role рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрддрд╛ рд╣реИред
* рд╣рд░ рдмрд╛рд░ рдЬрдм рдирдП cloudtrail рд▓реЙрдЧ рдЙрддреНрдкрдиреНрди рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдЙрдиреНрд╣реЗрдВ рд╣рдЯрд╛ рджреЗрдВ/рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВ

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
