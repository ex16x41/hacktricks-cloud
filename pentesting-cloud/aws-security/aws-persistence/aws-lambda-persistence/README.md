# AWS - Lambda Persistence

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Lambda

Para m谩s informaci贸n revisa:

{% content-ref url="../../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistence

Es posible **introducir/backdoor una capa para ejecutar c贸digo arbitrario** cuando la lambda se ejecuta de manera sigilosa:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension Persistence

Abusando de Lambda Layers tambi茅n es posible abusar de extensiones y persistir en la lambda, pero tambi茅n robar y modificar solicitudes.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### V铆a pol铆ticas de recursos

Es posible otorgar acceso a diferentes acciones de lambda (como invocar o actualizar c贸digo) a cuentas externas:

<figure><img src="../../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

### Versiones, Alias y Pesos

Una Lambda puede tener **diferentes versiones** (con diferente c贸digo cada versi贸n).\
Luego, puedes crear **diferentes alias con diferentes versiones** de la lambda y asignar diferentes pesos a cada una.\
De esta manera, un atacante podr铆a crear una **versi贸n 1 con backdoor** y una **versi贸n 2 solo con el c贸digo leg铆timo** y **ejecutar solo la versi贸n 1 en el 1%** de las solicitudes para permanecer sigiloso.

<figure><img src="../../../../.gitbook/assets/image (120).png" alt=""><figcaption></figcaption></figure>

### Backdoor de Versi贸n + API Gateway

1. Copia el c贸digo original de la Lambda
2. **Crea una nueva versi贸n con backdoor** del c贸digo original (o solo con c贸digo malicioso). Publica y **despliega esa versi贸n** a $LATEST
1. Llama al API gateway relacionado con la lambda para ejecutar el c贸digo
3. **Crea una nueva versi贸n con el c贸digo original**, Publ铆cala y despliega esa **versi贸n** a $LATEST.
1. Esto ocultar谩 el c贸digo con backdoor en una versi贸n anterior
4. Ve al API Gateway y **crea un nuevo m茅todo POST** (o elige cualquier otro m茅todo) que ejecutar谩 la versi贸n con backdoor de la lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Nota el final :1 del arn **indicando la versi贸n de la funci贸n** (la versi贸n 1 ser谩 la que tiene backdoor en este escenario).
5. Selecciona el m茅todo POST creado y en Acciones selecciona **`Deploy API`**
6. Ahora, cuando **llames a la funci贸n v铆a POST tu Backdoor** ser谩 invocado

### Actuador Cron/Event

El hecho de que puedas hacer que **las funciones lambda se ejecuten cuando algo sucede o cuando pasa alg煤n tiempo** hace que lambda sea una forma agradable y com煤n de obtener persistencia y evitar la detecci贸n.\
Aqu铆 tienes algunas ideas para hacer tu **presencia en AWS m谩s sigilosa creando lambdas**.

* Cada vez que se crea un nuevo usuario, lambda genera una nueva clave de usuario y la env铆a al atacante.
* Cada vez que se crea un nuevo rol, lambda otorga permisos de asumir rol a usuarios comprometidos.
* Cada vez que se generan nuevos logs de cloudtrail, eliminarlos/alterarlos

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
