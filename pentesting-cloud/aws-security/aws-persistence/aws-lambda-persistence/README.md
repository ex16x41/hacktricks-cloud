# AWS - Lambda Persistence

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Lambda

Daha fazla bilgi iÃ§in kontrol edin:

{% content-ref url="../../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistence

Lambda Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda **rastgele kodu Ã§alÄ±ÅŸtÄ±rmak iÃ§in bir katman tanÄ±tmak/arka kapÄ± oluÅŸturmak** mÃ¼mkÃ¼ndÃ¼r:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension Persistence

Lambda KatmanlarÄ±nÄ± kÃ¶tÃ¼ye kullanarak, uzantÄ±larÄ± da kÃ¶tÃ¼ye kullanmak ve lambda'da kalÄ±cÄ± olmak mÃ¼mkÃ¼ndÃ¼r, ayrÄ±ca istekleri Ã§almak ve deÄŸiÅŸtirmek de mÃ¼mkÃ¼ndÃ¼r.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### Via resource policies

DÄ±ÅŸ hesaplara farklÄ± lambda eylemlerine (Ã¶rneÄŸin, Ã§aÄŸÄ±rma veya kodu gÃ¼ncelleme) eriÅŸim vermek mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

Bir Lambda'nÄ±n **farklÄ± sÃ¼rÃ¼mleri** olabilir (her sÃ¼rÃ¼mde farklÄ± kodlar).\
Sonra, lambda'nÄ±n **farklÄ± sÃ¼rÃ¼mleri ile farklÄ± takma adlar** oluÅŸturabilir ve her birine farklÄ± aÄŸÄ±rlÄ±klar ayarlayabilirsiniz.\
Bu ÅŸekilde bir saldÄ±rgan **arka kapÄ±lÄ± sÃ¼rÃ¼m 1** ve **yalnÄ±zca meÅŸru kod iÃ§eren sÃ¼rÃ¼m 2** oluÅŸturabilir ve **isteklerin %1'inde yalnÄ±zca sÃ¼rÃ¼m 1'i Ã§alÄ±ÅŸtÄ±rarak** gizli kalabilir.

<figure><img src="../../../../.gitbook/assets/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Lambda'nÄ±n orijinal kodunu kopyalayÄ±n
2. Orijinal kodu (veya yalnÄ±zca kÃ¶tÃ¼ niyetli kod ile) **arka kapÄ± oluÅŸturarak yeni bir sÃ¼rÃ¼m oluÅŸturun**. Bu sÃ¼rÃ¼mÃ¼ yayÄ±nlayÄ±n ve **$LATEST'e daÄŸÄ±tÄ±n**
1. Kodu Ã§alÄ±ÅŸtÄ±rmak iÃ§in lambda ile ilgili API geÃ§idini Ã§aÄŸÄ±rÄ±n
3. **Orijinal kod ile yeni bir sÃ¼rÃ¼m oluÅŸturun**, bu **sÃ¼rÃ¼mÃ¼** yayÄ±nlayÄ±n ve **$LATEST'e daÄŸÄ±tÄ±n**.
1. Bu, arka kapÄ±lÄ± kodu Ã¶nceki bir sÃ¼rÃ¼mde gizleyecektir
4. API GeÃ§idine gidin ve **arka kapÄ±lÄ± sÃ¼rÃ¼mÃ¼ Ã§alÄ±ÅŸtÄ±racak yeni bir POST yÃ¶ntemi oluÅŸturun**: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Sonundaki :1'in **fonksiyonun sÃ¼rÃ¼mÃ¼nÃ¼ belirttiÄŸini** unutmayÄ±n (bu senaryoda sÃ¼rÃ¼m 1 arka kapÄ±lÄ± olacaktÄ±r).
5. OluÅŸturulan POST yÃ¶ntemini seÃ§in ve Eylemler'de **`API'yi DaÄŸÄ±t`** seÃ§in
6. ArtÄ±k, **POST ile fonksiyonu Ã§aÄŸÄ±rdÄ±ÄŸÄ±nÄ±zda arka kapÄ±nÄ±z** tetiklenecektir

### Cron/Event actuator

**Lambda fonksiyonlarÄ±nÄ±n bir ÅŸey olduÄŸunda veya bir sÃ¼re geÃ§tiÄŸinde Ã§alÄ±ÅŸmasÄ±nÄ± saÄŸlamak**, lambda'yÄ± kalÄ±cÄ±lÄ±k elde etmek ve tespit edilmekten kaÃ§Ä±nmak iÃ§in gÃ¼zel ve yaygÄ±n bir yol haline getirir.\
AWS'deki **varlÄ±ÄŸÄ±nÄ±zÄ± daha gizli hale getirmek iÃ§in lambdalar oluÅŸturma** konusunda bazÄ± fikirleriniz var.

* Her yeni kullanÄ±cÄ± oluÅŸturulduÄŸunda, lambda yeni bir kullanÄ±cÄ± anahtarÄ± oluÅŸturur ve bunu saldÄ±rgana gÃ¶nderir.
* Her yeni rol oluÅŸturulduÄŸunda, lambda, ele geÃ§irilmiÅŸ kullanÄ±cÄ±lara rol Ã¼stlenme izinleri verir.
* Her yeni cloudtrail gÃ¼nlÃ¼ÄŸÃ¼ oluÅŸturulduÄŸunda, bunlarÄ± siler/deÄŸiÅŸtirir.
