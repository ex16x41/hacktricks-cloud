# AWS - Lambda Persistence

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **HackTricks'e ve** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github depolarÄ±na PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.**

</details>
{% endhint %}

## Lambda

Daha fazla bilgi iÃ§in kontrol edin:

{% content-ref url="../../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistence

Lambda Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda gizli bir ÅŸekilde keyfi kod Ã§alÄ±ÅŸtÄ±rmak iÃ§in bir katman eklemek/backdoorlamak mÃ¼mkÃ¼ndÃ¼r:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension Persistence

Lambda Layers'Ä± kÃ¶tÃ¼ye kullanarak, uzantÄ±larÄ± kÃ¶tÃ¼ye kullanmak ve lambda iÃ§inde kalÄ±cÄ± olmak, ayrÄ±ca istekleri Ã§almak ve deÄŸiÅŸtirmek de mÃ¼mkÃ¼ndÃ¼r.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### Kaynak politikalarÄ± aracÄ±lÄ±ÄŸÄ±yla

FarklÄ± lambda eylemlerine (Ã¶rneÄŸin, Ã§aÄŸÄ±rma veya kod gÃ¼ncelleme) dÄ±ÅŸ hesaplara eriÅŸim izni vermek mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

### SÃ¼rÃ¼mler, Takma Adlar ve AÄŸÄ±rlÄ±klar

Bir Lambda'nÄ±n **farklÄ± sÃ¼rÃ¼mleri** olabilir (her sÃ¼rÃ¼mde farklÄ± kodlarla).\
Daha sonra, lambda'nÄ±n **farklÄ± sÃ¼rÃ¼mleriyle farklÄ± takma adlar** oluÅŸturabilir ve her birine farklÄ± aÄŸÄ±rlÄ±klar atayabilirsiniz.\
Bu ÅŸekilde bir saldÄ±rgan, **backdoorlanmÄ±ÅŸ bir sÃ¼rÃ¼m 1** ve **sadece meÅŸru kod iÃ§eren bir sÃ¼rÃ¼m 2** oluÅŸturabilir ve **isteklerin sadece %1'inde sÃ¼rÃ¼m 1'i Ã§alÄ±ÅŸtÄ±rarak** gizli kalabilir.

<figure><img src="../../../../.gitbook/assets/image (120).png" alt=""><figcaption></figcaption></figure>

### SÃ¼rÃ¼m Backdoor + API Gateway

1. Lambda'nÄ±n orijinal kodunu kopyalayÄ±n
2. Orijinal kodu backdoorlayarak (veya sadece kÃ¶tÃ¼ niyetli kodla) **yeni bir sÃ¼rÃ¼m oluÅŸturun**. Bu sÃ¼rÃ¼mÃ¼ $LATEST'e **yayÄ±nlayÄ±n ve daÄŸÄ±tÄ±n**
1. Kodu Ã§alÄ±ÅŸtÄ±rmak iÃ§in lambda ile ilgili API gateway'ini Ã§aÄŸÄ±rÄ±n
3. **Orijinal kodla yeni bir sÃ¼rÃ¼m oluÅŸturun**, yayÄ±nlayÄ±n ve bu **sÃ¼rÃ¼mÃ¼** $LATEST'e daÄŸÄ±tÄ±n.
1. Bu, backdoorlanmÄ±ÅŸ kodu Ã¶nceki bir sÃ¼rÃ¼mde gizleyecektir
4. API Gateway'e gidin ve **yeni bir POST yÃ¶ntemi oluÅŸturun** (veya baÅŸka bir yÃ¶ntemi seÃ§in) ve bu yÃ¶ntem backdoorlanmÄ±ÅŸ lambda sÃ¼rÃ¼mÃ¼nÃ¼ Ã§alÄ±ÅŸtÄ±racaktÄ±r: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. arn'Ä±n sonundaki :1'in **iÅŸlevin sÃ¼rÃ¼mÃ¼nÃ¼ belirttiÄŸini** unutmayÄ±n (bu senaryoda sÃ¼rÃ¼m 1 backdoorlanmÄ±ÅŸ olan olacaktÄ±r).
5. OluÅŸturulan POST yÃ¶ntemini seÃ§in ve Eylemler'de **`Deploy API`** seÃ§in
6. Åimdi, **POST yÃ¶ntemiyle iÅŸlevi Ã§aÄŸÄ±rdÄ±ÄŸÄ±nÄ±zda Backdoor** Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r

### Cron/Olay tetikleyici

Lambda iÅŸlevlerinin **bir ÅŸey olduÄŸunda veya belirli bir sÃ¼re geÃ§tiÄŸinde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi** lambda'yÄ± kalÄ±cÄ±lÄ±k saÄŸlamak ve tespitten kaÃ§Ä±nmak iÃ§in gÃ¼zel ve yaygÄ±n bir yol haline getirir.\
Ä°ÅŸte **AWS'deki varlÄ±ÄŸÄ±nÄ±zÄ± daha gizli hale getirmek iÃ§in lambda oluÅŸturarak** bazÄ± fikirler.

* Yeni bir kullanÄ±cÄ± oluÅŸturulduÄŸunda lambda yeni bir kullanÄ±cÄ± anahtarÄ± oluÅŸturur ve saldÄ±rgana gÃ¶nderir.
* Yeni bir rol oluÅŸturulduÄŸunda lambda, ele geÃ§irilmiÅŸ kullanÄ±cÄ±lara rol alma izinleri verir.
* Yeni cloudtrail gÃ¼nlÃ¼kleri oluÅŸturulduÄŸunda, bunlarÄ± silin/deÄŸiÅŸtirin

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **HackTricks'e ve** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github depolarÄ±na PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.**

</details>
{% endhint %}
