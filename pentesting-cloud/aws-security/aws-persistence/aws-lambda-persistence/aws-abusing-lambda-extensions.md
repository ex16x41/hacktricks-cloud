# AWS - Abusing Lambda Extensions

{% hint style="success" %}
AWS Hacking ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡•ã ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§¶‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§ì‡§Ç**](https://github.com/sponsors/carlospolop) ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç!
* üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**telegram ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ ‡§π‡§Æ‡•á‡§Ç **Twitter** üê¶ ‡§™‡§∞ **‡§´‡•â‡§≤‡•ã** ‡§ï‡§∞‡•á‡§Ç [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç** [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos ‡§Æ‡•á‡§Ç PRs ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§ï‡•á‡•§

</details>
{% endhint %}

## Lambda Extensions

Lambda extensions ‡§µ‡§ø‡§≠‡§ø‡§®‡•ç‡§® **monitoring, observability, security, ‡§î‡§∞ governance tools** ‡§ï‡•á ‡§∏‡§æ‡§• functions ‡§ï‡•ã enhance ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ø‡•á extensions, [.zip archives using Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§Ø‡§æ [container image deployments](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§ï‡§ø‡§è ‡§ú‡§æ‡§§‡•á ‡§π‡•à‡§Ç, ‡§¶‡•ã ‡§Æ‡•ã‡§°‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç: **internal** ‡§î‡§∞ **external**‡•§

* **Internal extensions** runtime process ‡§ï‡•á ‡§∏‡§æ‡§• merge ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç, ‡§á‡§∏‡§ï‡•á startup ‡§ï‡•ã **language-specific environment variables** ‡§î‡§∞ **wrapper scripts** ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á manipulate ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ø‡§π customization ‡§µ‡§ø‡§≠‡§ø‡§®‡•ç‡§® runtimes ‡§™‡§∞ ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã‡§§‡§æ ‡§π‡•à, ‡§ú‡•à‡§∏‡•á **Java Correto 8 ‡§î‡§∞ 11, Node.js 10 ‡§î‡§∞ 12, ‡§î‡§∞ .NET Core 3.1**‡•§
* **External extensions** ‡§Ö‡§≤‡§ó processes ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ö‡§≤‡§§‡•á ‡§π‡•à‡§Ç, Lambda function ‡§ï‡•á lifecycle ‡§ï‡•á ‡§∏‡§æ‡§• operation alignment ‡§¨‡§®‡§æ‡§è ‡§∞‡§ñ‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ø‡•á ‡§µ‡§ø‡§≠‡§ø‡§®‡•ç‡§® runtimes ‡§ï‡•á ‡§∏‡§æ‡§• compatible ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç ‡§ú‡•à‡§∏‡•á **Node.js 10 ‡§î‡§∞ 12, Python 3.7 ‡§î‡§∞ 3.8, Ruby 2.5 ‡§î‡§∞ 2.7, Java Corretto 8 ‡§î‡§∞ 11, .NET Core 3.1**, ‡§î‡§∞ **custom runtimes**‡•§

[**Lambda extensions ‡§ï‡•à‡§∏‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç, ‡§á‡§∏‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è docs ‡§¶‡•á‡§ñ‡•á‡§Ç**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html)‡•§

### External Extension for Persistence, Stealing Requests & modifying Requests

‡§Ø‡§π ‡§á‡§∏ ‡§™‡•ã‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ‡§ø‡§§ ‡§§‡§ï‡§®‡•Ä‡§ï ‡§ï‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§π‡•à: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

‡§Ø‡§π ‡§™‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§ï‡§ø Lambda runtime environment ‡§Æ‡•á‡§Ç default Linux kernel ‚Äú**process\_vm\_readv**‚Äù ‡§î‡§∞ ‚Äú**process\_vm\_writev**‚Äù system calls ‡§ï‡•á ‡§∏‡§æ‡§• compiled ‡§π‡•à‡•§ ‡§î‡§∞ ‡§∏‡§≠‡•Ä processes ‡§è‡§ï ‡§π‡•Ä user ID ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ö‡§≤‡§§‡•á ‡§π‡•à‡§Ç, ‡§Ø‡§π‡§æ‡§Ç ‡§§‡§ï ‡§ï‡§ø external extension ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§®‡§æ‡§è ‡§ó‡§è ‡§®‡§è process ‡§≠‡•Ä‡•§ **‡§á‡§∏‡§ï‡§æ ‡§Æ‡§§‡§≤‡§¨ ‡§π‡•à ‡§ï‡§ø ‡§è‡§ï external extension ‡§ï‡•ã Rapid ‡§ï‡•Ä heap memory ‡§§‡§ï ‡§™‡•Ç‡§∞‡•ç‡§£ read ‡§î‡§∞ write access ‡§π‡•à, design ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ‡•§**

‡§á‡§∏‡§ï‡•á ‡§Ö‡§≤‡§æ‡§µ‡§æ, ‡§ú‡§¨‡§ï‡§ø Lambda extensions ‡§ï‡•á ‡§™‡§æ‡§∏ **invocation events ‡§ï‡•ã subscribe ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ ‡§π‡•à**, AWS ‡§á‡§® extensions ‡§ï‡•ã raw data ‡§™‡•ç‡§∞‡§ï‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø **extensions ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§§‡§ï ‡§™‡§π‡•Å‡§Ç‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§∏‡§ï‡§§‡•á** ‡§ú‡•ã HTTP request ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§™‡•ç‡§∞‡•á‡§∑‡§ø‡§§ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§

Init (Rapid) process ‡§∏‡§≠‡•Ä API requests ‡§ï‡•Ä ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä ‡§ï‡§∞‡§§‡§æ ‡§π‡•à [http://127.0.0.1:9001](http://127.0.0.1:9001/) ‡§™‡§∞ ‡§ú‡§¨‡§ï‡§ø Lambda extensions ‡§ï‡•ã initialize ‡§î‡§∞ run ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä runtime code ‡§ï‡•á execution ‡§∏‡•á ‡§™‡§π‡§≤‡•á, ‡§≤‡•á‡§ï‡§ø‡§® Rapid ‡§ï‡•á ‡§¨‡§æ‡§¶‡•§

<figure><img src="../../../../.gitbook/assets/image (254).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

Variable **`AWS_LAMBDA_RUNTIME_API`** **IP** address ‡§î‡§∞ **port** number ‡§ï‡•ã Rapid API ‡§ï‡•á **child runtime processes** ‡§î‡§∞ ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ extensions ‡§ï‡•ã ‡§á‡§Ç‡§ó‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§

{% hint style="warning" %}
**`AWS_LAMBDA_RUNTIME_API`** environment variable ‡§ï‡•ã ‡§è‡§ï **`port`** ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡§ï‡§∞, ‡§ú‡§ø‡§∏ ‡§§‡§ï ‡§π‡§Æ‡•á‡§Ç ‡§™‡§π‡•Å‡§Ç‡§ö ‡§π‡•à, Lambda runtime ‡§ï‡•á ‡§≠‡•Ä‡§§‡§∞ ‡§∏‡§≠‡•Ä actions ‡§ï‡•ã intercept ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à (**man-in-the-middle**)‡•§ ‡§Ø‡§π ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø extension Rapid Init ‡§ï‡•á ‡§∏‡§Æ‡§æ‡§® privileges ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ö‡§≤‡§§‡§æ ‡§π‡•à, ‡§î‡§∞ system ‡§ï‡§æ kernel **process memory ‡§ï‡•á modification** ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§§‡§æ ‡§π‡•à, ‡§ú‡§ø‡§∏‡§∏‡•á port number ‡§ï‡•ã ‡§¨‡§¶‡§≤‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•ã ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§
{% endhint %}

‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø **extensions ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä runtime code ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§ö‡§≤‡§§‡•á ‡§π‡•à‡§Ç**, environment variable ‡§ï‡•ã modify ‡§ï‡§∞‡§®‡•á ‡§∏‡•á runtime process (‡§ú‡•à‡§∏‡•á, Python, Java, Node, Ruby) ‡§ï‡•á startup ‡§™‡§∞ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ ‡§™‡§°‡§º‡•á‡§ó‡§æ‡•§ ‡§á‡§∏‡§ï‡•á ‡§Ö‡§≤‡§æ‡§µ‡§æ, **‡§π‡§Æ‡§æ‡§∞‡•á ‡§¨‡§æ‡§¶ ‡§≤‡•ã‡§° ‡§ï‡§ø‡§è ‡§ó‡§è extensions**, ‡§ú‡•ã ‡§á‡§∏ variable ‡§™‡§∞ ‡§®‡§ø‡§∞‡•ç‡§≠‡§∞ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç, ‡§≠‡•Ä ‡§π‡§Æ‡§æ‡§∞‡•á extension ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á route ‡§π‡•ã‡§Ç‡§ó‡•á‡•§ ‡§Ø‡§π setup malware ‡§ï‡•ã runtime environment ‡§ï‡•á ‡§≠‡•Ä‡§§‡§∞ ‡§∏‡•Ä‡§ß‡•á security measures ‡§Ø‡§æ logging extensions ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á bypass ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§

<figure><img src="../../../../.gitbook/assets/image (267).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

Tool [**lambda-spy**](https://github.com/clearvector/lambda-spy) ‡§ï‡•ã ‡§â‡§∏ **memory write** ‡§ï‡•ã perform ‡§ï‡§∞‡§®‡•á ‡§î‡§∞ lambda requests, ‡§Ö‡§®‡•ç‡§Ø **extensions** **requests** ‡§∏‡•á ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä **‡§ö‡•ã‡§∞‡•Ä** ‡§ï‡§∞‡§®‡•á ‡§î‡§∞ ‡§Ø‡§π‡§æ‡§Ç ‡§§‡§ï ‡§ï‡§ø **modify** ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§•‡§æ‡•§

## References

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
AWS Hacking ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡•ã ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§¶‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§ì‡§Ç**](https://github.com/sponsors/carlospolop) ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç!
* üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**telegram ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ ‡§π‡§Æ‡•á‡§Ç **Twitter** üê¶ ‡§™‡§∞ **‡§´‡•â‡§≤‡•ã** ‡§ï‡§∞‡•á‡§Ç [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç** [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos ‡§Æ‡•á‡§Ç PRs ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§ï‡•á‡•§

</details>
{% endhint %}
