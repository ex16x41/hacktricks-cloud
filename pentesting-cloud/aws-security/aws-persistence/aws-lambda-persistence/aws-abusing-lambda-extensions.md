# AWS - Abusando de las Extensiones de Lambda

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Extensiones de Lambda

Las extensiones de Lambda mejoran las funciones integr√°ndose con varias **herramientas de monitoreo, observabilidad, seguridad y gobernanza**. Estas extensiones, a√±adidas a trav√©s de [.zip archives usando capas de Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) o incluidas en [despliegues de im√°genes de contenedor](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), operan en dos modos: **interno** y **externo**.

* **Las extensiones internas** se fusionan con el proceso de ejecuci√≥n, manipulando su inicio usando **variables de entorno espec√≠ficas del lenguaje** y **scripts envolventes**. Esta personalizaci√≥n se aplica a una variedad de entornos de ejecuci√≥n, incluyendo **Java Correto 8 y 11, Node.js 10 y 12, y .NET Core 3.1**.
* **Las extensiones externas** se ejecutan como procesos separados, manteniendo la alineaci√≥n de operaci√≥n con el ciclo de vida de la funci√≥n Lambda. Son compatibles con varios entornos de ejecuci√≥n como **Node.js 10 y 12, Python 3.7 y 3.8, Ruby 2.5 y 2.7, Java Corretto 8 y 11, .NET Core 3.1**, y **entornos de ejecuci√≥n personalizados**.

Para m√°s informaci√≥n sobre [**c√≥mo funcionan las extensiones de lambda, consulta la documentaci√≥n**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Extensi√≥n Externa para Persistencia, Robo de Solicitudes y Modificaci√≥n de Solicitudes

Este es un resumen de la t√©cnica propuesta en esta publicaci√≥n: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Se encontr√≥ que el kernel de Linux por defecto en el entorno de ejecuci√≥n de Lambda est√° compilado con llamadas al sistema ‚Äú**process\_vm\_readv**‚Äù y ‚Äú**process\_vm\_writev**‚Äù. Y todos los procesos se ejecutan con el mismo ID de usuario, incluso el nuevo proceso creado para la extensi√≥n externa. **Esto significa que una extensi√≥n externa tiene acceso completo de lectura y escritura a la memoria heap de Rapid, por dise√±o.**

Adem√°s, aunque las extensiones de Lambda tienen la capacidad de **suscribirse a eventos de invocaci√≥n**, AWS no revela los datos en bruto a estas extensiones. Esto asegura que **las extensiones no pueden acceder a informaci√≥n sensible** transmitida a trav√©s de la solicitud HTTP.

El proceso Init (Rapid) monitorea todas las solicitudes de API en [http://127.0.0.1:9001](http://127.0.0.1:9001/) mientras las extensiones de Lambda son inicializadas y se ejecutan antes de la ejecuci√≥n de cualquier c√≥digo de entorno, pero despu√©s de Rapid.

<figure><img src="../../../../.gitbook/assets/image (254).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

La variable **`AWS_LAMBDA_RUNTIME_API`** indica la **IP** y el **n√∫mero de puerto** de la API Rapid a **los procesos de ejecuci√≥n secundarios** y extensiones adicionales.

{% hint style="warning" %}
Al cambiar la variable de entorno **`AWS_LAMBDA_RUNTIME_API`** a un **`puerto`** al que tengamos acceso, es posible interceptar todas las acciones dentro del entorno de ejecuci√≥n de Lambda (**man-in-the-middle**). Esto es posible porque la extensi√≥n se ejecuta con los mismos privilegios que Rapid Init, y el kernel del sistema permite la **modificaci√≥n de la memoria del proceso**, lo que permite la alteraci√≥n del n√∫mero de puerto.
{% endhint %}

Debido a que **las extensiones se ejecutan antes de cualquier c√≥digo de ejecuci√≥n**, modificar la variable de entorno influir√° en el proceso de ejecuci√≥n (por ejemplo, Python, Java, Node, Ruby) a medida que comienza. Adem√°s, **las extensiones cargadas despu√©s** de la nuestra, que dependen de esta variable, tambi√©n se enrutar√°n a trav√©s de nuestra extensi√≥n. Esta configuraci√≥n podr√≠a permitir que el malware eluda completamente las medidas de seguridad o las extensiones de registro directamente dentro del entorno de ejecuci√≥n.

<figure><img src="../../../../.gitbook/assets/image (267).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

La herramienta [**lambda-spy**](https://github.com/clearvector/lambda-spy) fue creada para realizar esa **escritura de memoria** y **robar informaci√≥n sensible** de las solicitudes de lambda, otras **solicitudes de extensiones** e incluso **modificarlas**.

## Referencias

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}
