# AWS - Abusing Lambda Extensions

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Lambda Extensions

Lambda æ‰©å±•é€šè¿‡ä¸å„ç§ **ç›‘æ§ã€å¯è§‚å¯Ÿæ€§ã€å®‰å…¨æ€§å’Œæ²»ç†å·¥å…·** é›†æˆæ¥å¢å¼ºåŠŸèƒ½ã€‚è¿™äº›æ‰©å±•é€šè¿‡ [.zip å‹ç¼©åŒ…ä½¿ç”¨ Lambda å±‚](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) æ·»åŠ æˆ–åŒ…å«åœ¨ [å®¹å™¨é•œåƒéƒ¨ç½²](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/) ä¸­ï¼Œä»¥ä¸¤ç§æ¨¡å¼è¿è¡Œï¼š**å†…éƒ¨** å’Œ **å¤–éƒ¨**ã€‚

* **å†…éƒ¨æ‰©å±•** ä¸è¿è¡Œæ—¶è¿›ç¨‹åˆå¹¶ï¼Œä½¿ç”¨ **ç‰¹å®šè¯­è¨€çš„ç¯å¢ƒå˜é‡** å’Œ **åŒ…è£…è„šæœ¬** æ“ä½œå…¶å¯åŠ¨ã€‚æ­¤è‡ªå®šä¹‰é€‚ç”¨äºå¤šç§è¿è¡Œæ—¶ï¼ŒåŒ…æ‹¬ **Java Correto 8 å’Œ 11ã€Node.js 10 å’Œ 12ï¼Œä»¥åŠ .NET Core 3.1**ã€‚
* **å¤–éƒ¨æ‰©å±•** ä½œä¸ºå•ç‹¬çš„è¿›ç¨‹è¿è¡Œï¼Œä¸ Lambda å‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸä¿æŒæ“ä½œä¸€è‡´ã€‚å®ƒä»¬ä¸å¤šç§è¿è¡Œæ—¶å…¼å®¹ï¼Œå¦‚ **Node.js 10 å’Œ 12ã€Python 3.7 å’Œ 3.8ã€Ruby 2.5 å’Œ 2.7ã€Java Corretto 8 å’Œ 11ã€.NET Core 3.1** ä»¥åŠ **è‡ªå®šä¹‰è¿è¡Œæ—¶**ã€‚

æœ‰å…³ [**Lambda æ‰©å±•å¦‚ä½•å·¥ä½œçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ–‡æ¡£**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html)ã€‚

### å¤–éƒ¨æ‰©å±•ç”¨äºæŒä¹…æ€§ã€çªƒå–è¯·æ±‚å’Œä¿®æ”¹è¯·æ±‚

è¿™æ˜¯æœ¬æ–‡ä¸­æå‡ºçš„æŠ€æœ¯æ‘˜è¦ï¼š[https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

å‘ç° Lambda è¿è¡Œæ—¶ç¯å¢ƒä¸­çš„é»˜è®¤ Linux å†…æ ¸æ˜¯ä½¿ç”¨ â€œ**process\_vm\_readv**â€ å’Œ â€œ**process\_vm\_writev**â€ ç³»ç»Ÿè°ƒç”¨ç¼–è¯‘çš„ã€‚æ‰€æœ‰è¿›ç¨‹éƒ½ä»¥ç›¸åŒçš„ç”¨æˆ· ID è¿è¡Œï¼Œå³ä½¿æ˜¯ä¸ºå¤–éƒ¨æ‰©å±•åˆ›å»ºçš„æ–°è¿›ç¨‹ã€‚**è¿™æ„å‘³ç€å¤–éƒ¨æ‰©å±•å¯ä»¥å®Œå…¨è¯»å–å’Œå†™å…¥ Rapid çš„å †å†…å­˜ï¼Œè¿™æ˜¯è®¾è®¡ä½¿ç„¶ã€‚**

æ­¤å¤–ï¼Œè™½ç„¶ Lambda æ‰©å±•æœ‰èƒ½åŠ› **è®¢é˜…è°ƒç”¨äº‹ä»¶**ï¼Œä½† AWS ä¸ä¼šå‘è¿™äº›æ‰©å±•é€éœ²åŸå§‹æ•°æ®ã€‚è¿™ç¡®ä¿äº† **æ‰©å±•æ— æ³•è®¿é—®é€šè¿‡ HTTP è¯·æ±‚ä¼ è¾“çš„æ•æ„Ÿä¿¡æ¯**ã€‚

Init (Rapid) è¿›ç¨‹åœ¨ [http://127.0.0.1:9001](http://127.0.0.1:9001/) ç›‘æ§æ‰€æœ‰ API è¯·æ±‚ï¼Œè€Œ Lambda æ‰©å±•åœ¨æ‰§è¡Œä»»ä½•è¿è¡Œæ—¶ä»£ç ä¹‹å‰åˆå§‹åŒ–å¹¶è¿è¡Œï¼Œä½†åœ¨ Rapid ä¹‹åã€‚

<figure><img src="../../../../.gitbook/assets/image (254).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

å˜é‡ **`AWS_LAMBDA_RUNTIME_API`** æŒ‡ç¤º **IP** åœ°å€å’Œ **ç«¯å£** å·ï¼Œä»¥ä¾¿ **å­è¿è¡Œæ—¶è¿›ç¨‹** å’Œå…¶ä»–æ‰©å±•ä½¿ç”¨ã€‚

{% hint style="warning" %}
é€šè¿‡å°† **`AWS_LAMBDA_RUNTIME_API`** ç¯å¢ƒå˜é‡æ›´æ”¹ä¸ºæˆ‘ä»¬å¯ä»¥è®¿é—®çš„ **`port`**ï¼Œå¯ä»¥æ‹¦æˆª Lambda è¿è¡Œæ—¶ä¸­çš„æ‰€æœ‰æ“ä½œï¼ˆ**ä¸­é—´äººæ”»å‡»**ï¼‰ã€‚è¿™æ˜¯å¯èƒ½çš„ï¼Œå› ä¸ºæ‰©å±•ä¸ Rapid Init å…·æœ‰ç›¸åŒçš„æƒé™ï¼Œå¹¶ä¸”ç³»ç»Ÿå†…æ ¸å…è®¸ **ä¿®æ”¹è¿›ç¨‹å†…å­˜**ï¼Œä»è€Œèƒ½å¤Ÿæ›´æ”¹ç«¯å£å·ã€‚
{% endhint %}

å› ä¸º **æ‰©å±•åœ¨ä»»ä½•è¿è¡Œæ—¶ä»£ç ä¹‹å‰è¿è¡Œ**ï¼Œä¿®æ”¹ç¯å¢ƒå˜é‡å°†å½±å“è¿è¡Œæ—¶è¿›ç¨‹ï¼ˆä¾‹å¦‚ï¼ŒPythonã€Javaã€Nodeã€Rubyï¼‰åœ¨å¯åŠ¨æ—¶çš„è¡Œä¸ºã€‚æ­¤å¤–ï¼Œ**åœ¨æˆ‘ä»¬ä¹‹ååŠ è½½çš„æ‰©å±•**ï¼Œä¾èµ–äºæ­¤å˜é‡çš„æ‰©å±•ï¼Œä¹Ÿå°†é€šè¿‡æˆ‘ä»¬çš„æ‰©å±•è¿›è¡Œè·¯ç”±ã€‚æ­¤è®¾ç½®å¯èƒ½ä½¿æ¶æ„è½¯ä»¶å®Œå…¨ç»•è¿‡å®‰å…¨æªæ–½æˆ–ç›´æ¥åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸­è®°å½•æ‰©å±•ã€‚

<figure><img src="../../../../.gitbook/assets/image (267).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

å·¥å…· [**lambda-spy**](https://github.com/clearvector/lambda-spy) è¢«åˆ›å»ºç”¨äºæ‰§è¡Œ **å†…å­˜å†™å…¥** å’Œ **çªƒå–æ•æ„Ÿä¿¡æ¯**ï¼Œä» lambda è¯·æ±‚ã€å…¶ä»– **æ‰©å±•** **è¯·æ±‚** ç”šè‡³ **ä¿®æ”¹å®ƒä»¬**ã€‚

## References

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
