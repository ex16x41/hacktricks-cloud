# AWS - Abusing Lambda Extensions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda Extensions

Lambda ekstenzije poboljÅ¡avaju funkcije integracijom sa raznim **alatima za praÄ‡enje, posmatranje, bezbednost i upravljanje**. Ove ekstenzije, dodate putem [.zip arhiva koristeÄ‡i Lambda slojeve](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ili ukljuÄene u [implementacije kontejnerskih slika](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), rade u dva reÅ¾ima: **interni** i **eksterni**.

* **Interni ekstenzije** se spajaju sa procesom izvrÅ¡avanja, manipuliÅ¡uÄ‡i njegovim pokretanjem koristeÄ‡i **promenljive okruÅ¾enja specifiÄne za jezik** i **wrapper skripte**. Ova prilagoÄ‘avanja se primenjuju na niz izvrÅ¡nih okruÅ¾enja, ukljuÄujuÄ‡i **Java Correto 8 i 11, Node.js 10 i 12, i .NET Core 3.1**.
* **Eksterni ekstenzije** rade kao odvojeni procesi, odrÅ¾avajuÄ‡i usklaÄ‘enost sa Å¾ivotnim ciklusom Lambda funkcije. Kompatibilni su sa raznim izvrÅ¡nim okruÅ¾enjima kao Å¡to su **Node.js 10 i 12, Python 3.7 i 3.8, Ruby 2.5 i 2.7, Java Corretto 8 i 11, .NET Core 3.1**, i **prilagoÄ‘enim izvrÅ¡nim okruÅ¾enjima**.

Za viÅ¡e informacija o [**kako lambda ekstenzije funkcioniÅ¡u proverite dokumentaciju**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Eksterni Ekstenzija za OdrÅ¾avanje, KraÄ‘u Zahteva & Modifikovanje Zahteva

Ovo je saÅ¾etak tehnike predloÅ¾ene u ovom postu: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Otkriveno je da je podrazumevani Linux kernel u Lambda okruÅ¾enju izvrÅ¡avanja kompajliran sa â€œ**process\_vm\_readv**â€ i â€œ**process\_vm\_writev**â€ sistemskim pozivima. I svi procesi se izvrÅ¡avaju sa istim korisniÄkim ID-jem, Äak i novi proces kreiran za eksternu ekstenziju. **To znaÄi da eksterni ekstenzija ima pun pristup za Äitanje i pisanje Rapid-ove heap memorije, po dizajnu.**

Å taviÅ¡e, dok Lambda ekstenzije imaju moguÄ‡nost da **pretplate na dogaÄ‘aje invokacije**, AWS ne otkriva sirove podatke ovim ekstenzijama. Ovo osigurava da **ekstenzije ne mogu pristupiti osetljivim informacijama** koje se prenose putem HTTP zahteva.

Init (Rapid) proces prati sve API zahteve na [http://127.0.0.1:9001](http://127.0.0.1:9001/) dok se Lambda ekstenzije inicijalizuju i izvrÅ¡avaju pre nego Å¡to se izvrÅ¡i bilo koji kod izvrÅ¡avanja, ali nakon Rapida.

<figure><img src="../../../../.gitbook/assets/image (254).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

Promenljiva **`AWS_LAMBDA_RUNTIME_API`** oznaÄava **IP** adresu i **broj** porta Rapid API-ju za **deÄije procese izvrÅ¡avanja** i dodatne ekstenzije.

{% hint style="warning" %}
Promenom **`AWS_LAMBDA_RUNTIME_API`** promenljive okruÅ¾enja na **`port`** kojem imamo pristup, moguÄ‡e je presresti sve akcije unutar Lambda izvrÅ¡avanja (**man-in-the-middle**). Ovo je moguÄ‡e jer ekstenzija radi sa istim privilegijama kao Rapid Init, a kernel sistema omoguÄ‡ava **modifikaciju memorije procesa**, omoguÄ‡avajuÄ‡i promenu broja porta.
{% endhint %}

BuduÄ‡i da **ekstenzije rade pre bilo kog koda izvrÅ¡avanja**, modifikovanje promenljive okruÅ¾enja Ä‡e uticati na proces izvrÅ¡avanja (npr. Python, Java, Node, Ruby) kada se pokrene. Å taviÅ¡e, **ekstenzije uÄitane posle** naÅ¡e, koje se oslanjaju na ovu promenljivu, takoÄ‘e Ä‡e prolaziti kroz naÅ¡u ekstenziju. Ova postavka bi mogla omoguÄ‡iti malveru da potpuno zaobiÄ‘e bezbednosne mere ili ekstenzije za logovanje direktno unutar okruÅ¾enja izvrÅ¡avanja.

<figure><img src="../../../../.gitbook/assets/image (267).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

Alat [**lambda-spy**](https://github.com/clearvector/lambda-spy) je kreiran da izvrÅ¡i tu **memorijsku pisanje** i **ukrade osetljive informacije** iz lambda zahteva, drugih **ekstenzija** **zahteva** i Äak **modifikuje ih**.

## References

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
