# AWS - KMS Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS

Για περισσότερες πληροφορίες ελέγξτε:

{% content-ref url="../aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### Grant acces via KMS policies

Ένας επιτιθέμενος θα μπορούσε να χρησιμοποιήσει την άδεια **`kms:PutKeyPolicy`** για να **δώσει πρόσβαση** σε ένα κλειδί σε έναν χρήστη υπό τον έλεγχό του ή ακόμη και σε έναν εξωτερικό λογαριασμό. Ελέγξτε τη [**σελίδα KMS Privesc**](../aws-privilege-escalation/aws-kms-privesc.md) για περισσότερες πληροφορίες.

### Eternal Grant

Οι παραχωρήσεις είναι ένας άλλος τρόπος για να δώσετε σε έναν κύριο κάποιες άδειες πάνω σε ένα συγκεκριμένο κλειδί. Είναι δυνατόν να δοθεί μια παραχώρηση που επιτρέπει σε έναν χρήστη να δημιουργεί παραχωρήσεις. Επιπλέον, ένας χρήστης μπορεί να έχει πολλές παραχωρήσεις (ακόμη και ταυτόσημες) πάνω στο ίδιο κλειδί.

Επομένως, είναι δυνατόν για έναν χρήστη να έχει 10 παραχωρήσεις με όλες τις άδειες. Ο επιτιθέμενος θα πρέπει να παρακολουθεί αυτό συνεχώς. Και αν σε κάποιο σημείο 1 παραχώρηση αφαιρεθεί, άλλες 10 θα πρέπει να δημιουργηθούν.

(Χρησιμοποιούμε 10 και όχι 2 για να μπορέσουμε να ανιχνεύσουμε ότι μια παραχώρηση αφαιρέθηκε ενώ ο χρήστης έχει ακόμη κάποιες παραχωρήσεις)
```bash
# To generate grants, generate 10 like this one
aws kms create-grant \
--key-id <key-id> \
--grantee-principal <user_arn> \
--operations "CreateGrant" "Decrypt"

# To monitor grants
aws kms list-grants --key-id <key-id>
```
{% hint style="info" %}
Μια παραχώρηση μπορεί να δώσει δικαιώματα μόνο από αυτό: [https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations](https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations)
{% endhint %}

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
