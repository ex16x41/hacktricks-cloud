# AWS - STS Persistence

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ ÎºÏŒÎ»Ï€Î± hacking Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## STS

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚, ÎµÏ€Î¹ÏƒÎºÎµÏ†Î¸ÎµÎ¯Ï„Îµ:

{% content-ref url="../aws-services/aws-sts-enum.md" %}
[aws-sts-enum.md](../aws-services/aws-sts-enum.md)
{% endcontent-ref %}

### Assume role token

ÎŸÎ¹ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¿Î¯ Ï„ÏŒÎºÎµÎ½ Î´ÎµÎ½ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î¿ÏÎ½, ÎµÏ€Î¿Î¼Î­Î½Ï‰Ï‚ Î· Î´Î¹Î±Ï„Î®ÏÎ·ÏƒÎ· ÎµÎ½ÏŒÏ‚ ÎµÎ½ÎµÏÎ³Î¿Ï Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¿Ï Ï„ÏŒÎºÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î­Î½Î±Ï‚ Ï„ÏÏŒÏ€Î¿Ï‚ Î³Î¹Î± Î½Î± Î´Î¹Î±Ï„Î·ÏÎ·Î¸ÎµÎ¯ Î· ÎµÏ€Î¹Î¼Î¿Î½Î®.

<pre class="language-bash"><code class="lang-bash">aws sts get-session-token --duration-seconds 129600

# ÎœÎµ MFA
aws sts get-session-token \
--serial-number &#x3C;mfa-device-name> \
--token-code &#x3C;code-from-token>

# Î¤Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î·Ï‚ ÏƒÏ…ÏƒÎºÎµÏ…Î®Ï‚ Ï…Î»Î¹ÎºÎ¿Ï ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Î¿ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Î±Ï€ÏŒ Ï„Î·Î½ Ï€Î¯ÏƒÏ‰ Ï€Î»ÎµÏ…ÏÎ¬ Ï„Î·Ï‚ ÏƒÏ…ÏƒÎºÎµÏ…Î®Ï‚, ÏŒÏ€Ï‰Ï‚ GAHT12345678
<strong># Î¤Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î·Ï‚ ÏƒÏ…ÏƒÎºÎµÏ…Î®Ï‚ SMS ÎµÎ¯Î½Î±Î¹ Ï„Î¿ ARN ÏƒÏ„Î¿ AWS, ÏŒÏ€Ï‰Ï‚ arn:aws:iam::123456789012:sms-mfa/username
</strong># Î¤Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î·Ï‚ ÎµÎ¹ÎºÎ¿Î½Î¹ÎºÎ®Ï‚ ÏƒÏ…ÏƒÎºÎµÏ…Î®Ï‚ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ ARN ÏƒÏ„Î¿ AWS, ÏŒÏ€Ï‰Ï‚ arn:aws:iam::123456789012:mfa/username
</code></pre>

### Role Chain Juggling

[**Î— Î±Î»Ï…ÏƒÎ¯Î´Î± ÏÏŒÎ»Ï‰Î½ ÎµÎ¯Î½Î±Î¹ Î¼Î¹Î± Î±Î½Î±Î³Î½Ï‰ÏÎ¹ÏƒÎ¼Î­Î½Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Ï„Î¿Ï… AWS**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_terms-and-concepts.html#Role%20chaining), Ï€Î¿Ï… ÏƒÏ…Ï‡Î½Î¬ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î³Î¹Î± Ï„Î· Î´Î¹Î±Ï„Î®ÏÎ·ÏƒÎ· Ï„Î·Ï‚ ÎºÏÏ…Ï†Î®Ï‚ ÎµÏ€Î¹Î¼Î¿Î½Î®Ï‚. Î ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Ï„Î·Î½ Î¹ÎºÎ±Î½ÏŒÏ„Î·Ï„Î± Î½Î± **Î±Î½Î±Î»Î±Î¼Î²Î¬Î½ÎµÏ„Îµ Î­Î½Î±Î½ ÏÏŒÎ»Î¿ Ï€Î¿Ï… ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î±Î½Î±Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Î­Î½Î±Î½ Î¬Î»Î»Î¿**, ÎµÎ½Î´ÎµÏ‡Î¿Î¼Î­Î½Ï‰Ï‚ ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†Î¿Î½Ï„Î±Ï‚ ÏƒÏ„Î¿Î½ Î±ÏÏ‡Î¹ÎºÏŒ ÏÏŒÎ»Î¿ Î¼Îµ **ÎºÏ…ÎºÎ»Î¹ÎºÏŒ Ï„ÏÏŒÏ€Î¿**. ÎšÎ¬Î¸Îµ Ï†Î¿ÏÎ¬ Ï€Î¿Ï… Î±Î½Î±Î»Î±Î¼Î²Î¬Î½ÎµÏ„Î±Î¹ Î­Î½Î±Ï‚ ÏÏŒÎ»Î¿Ï‚, Ï„Î¿ Ï€ÎµÎ´Î¯Î¿ Î»Î®Î¾Î·Ï‚ Ï„Ï‰Î½ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î·ÏÎ¯Ï‰Î½ Î±Î½Î±Î½ÎµÏÎ½ÎµÏ„Î±Î¹. Î©Ï‚ ÎµÎº Ï„Î¿ÏÏ„Î¿Ï…, ÎµÎ¬Î½ Î´ÏÎ¿ ÏÏŒÎ»Î¿Î¹ ÎµÎ¯Î½Î±Î¹ ÏÏ…Î¸Î¼Î¹ÏƒÎ¼Î­Î½Î¿Î¹ Î½Î± Î±Î½Î±Î»Î±Î¼Î²Î¬Î½Î¿Ï…Î½ Î¿ Î­Î½Î±Ï‚ Ï„Î¿Î½ Î¬Î»Î»Î¿, Î±Ï…Ï„Î® Î· ÏÏÎ¸Î¼Î¹ÏƒÎ· ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î·Î½ Î±Î¹ÏÎ½Î¹Î± Î±Î½Î±Î½Î­Ï‰ÏƒÎ· Ï„Ï‰Î½ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î·ÏÎ¯Ï‰Î½.

ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ [**ÎµÏÎ³Î±Î»ÎµÎ¯Î¿**](https://github.com/hotnops/AWSRoleJuggler/) Î³Î¹Î± Î½Î± Î´Î¹Î±Ï„Î·ÏÎ®ÏƒÎµÏ„Îµ Ï„Î·Î½ Î±Î»Ï…ÏƒÎ¯Î´Î± ÏÏŒÎ»Ï‰Î½:
```bash
./aws_role_juggler.py -h
usage: aws_role_juggler.py [-h] [-r ROLE_LIST [ROLE_LIST ...]]

optional arguments:
-h, --help            show this help message and exit
-r ROLE_LIST [ROLE_LIST ...], --role-list ROLE_LIST [ROLE_LIST ...]
```
{% hint style="danger" %}
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Ï„Î¿ [find\_circular\_trust.py](https://github.com/hotnops/AWSRoleJuggler/blob/master/find_circular_trust.py) ÏƒÎµÎ½Î¬ÏÎ¹Î¿ Î±Ï€ÏŒ Î±Ï…Ï„ÏŒ Ï„Î¿ Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î¿ Github Î´ÎµÎ½ Î²ÏÎ¯ÏƒÎºÎµÎ¹ ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ Ï„ÏÏŒÏ€Î¿Ï…Ï‚ Î¼Îµ Ï„Î¿Ï…Ï‚ Î¿Ï€Î¿Î¯Î¿Ï…Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î¼Î¿ÏÏ†Ï‰Î¸ÎµÎ¯ Î¼Î¹Î± Î±Î»Ï…ÏƒÎ¯Î´Î± ÏÏŒÎ»Ï‰Î½.
{% endhint %}

<details>

<summary>ÎšÏÎ´Î¹ÎºÎ±Ï‚ Î³Î¹Î± Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Role Juggling Î±Ï€ÏŒ Ï„Î¿ PowerShell</summary>
```powershell
# PowerShell script to check for role juggling possibilities using AWS CLI

# Check for AWS CLI installation
if (-not (Get-Command "aws" -ErrorAction SilentlyContinue)) {
Write-Error "AWS CLI is not installed. Please install it and configure it with 'aws configure'."
exit
}

# Function to list IAM roles
function List-IAMRoles {
aws iam list-roles --query "Roles[*].{RoleName:RoleName, Arn:Arn}" --output json
}

# Initialize error count
$errorCount = 0

# List all roles
$roles = List-IAMRoles | ConvertFrom-Json

# Attempt to assume each role
foreach ($role in $roles) {
$sessionName = "RoleJugglingTest-" + (Get-Date -Format FileDateTime)
try {
$credentials = aws sts assume-role --role-arn $role.Arn --role-session-name $sessionName --query "Credentials" --output json 2>$null | ConvertFrom-Json
if ($credentials) {
Write-Host "Successfully assumed role: $($role.RoleName)"
Write-Host "Access Key: $($credentials.AccessKeyId)"
Write-Host "Secret Access Key: $($credentials.SecretAccessKey)"
Write-Host "Session Token: $($credentials.SessionToken)"
Write-Host "Expiration: $($credentials.Expiration)"

# Set temporary credentials to assume the next role
$env:AWS_ACCESS_KEY_ID = $credentials.AccessKeyId
$env:AWS_SECRET_ACCESS_KEY = $credentials.SecretAccessKey
$env:AWS_SESSION_TOKEN = $credentials.SessionToken

# Try to assume another role using the temporary credentials
foreach ($nextRole in $roles) {
if ($nextRole.Arn -ne $role.Arn) {
$nextSessionName = "RoleJugglingTest-" + (Get-Date -Format FileDateTime)
try {
$nextCredentials = aws sts assume-role --role-arn $nextRole.Arn --role-session-name $nextSessionName --query "Credentials" --output json 2>$null | ConvertFrom-Json
if ($nextCredentials) {
Write-Host "Also successfully assumed role: $($nextRole.RoleName) from $($role.RoleName)"
Write-Host "Access Key: $($nextCredentials.AccessKeyId)"
Write-Host "Secret Access Key: $($nextCredentials.SecretAccessKey)"
Write-Host "Session Token: $($nextCredentials.SessionToken)"
Write-Host "Expiration: $($nextCredentials.Expiration)"
}
} catch {
$errorCount++
}
}
}

# Reset environment variables
Remove-Item Env:\AWS_ACCESS_KEY_ID
Remove-Item Env:\AWS_SECRET_ACCESS_KEY
Remove-Item Env:\AWS_SESSION_TOKEN
} else {
$errorCount++
}
} catch {
$errorCount++
}
}

# Output the number of errors if any
if ($errorCount -gt 0) {
Write-Host "$errorCount error(s) occurred during role assumption attempts."
} else {
Write-Host "No errors occurred. All roles checked successfully."
}

Write-Host "Role juggling check complete."
```
</details>

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ ÎºÏŒÎ»Ï€Î± hacking Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
