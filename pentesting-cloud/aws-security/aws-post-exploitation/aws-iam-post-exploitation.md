# AWS - IAM Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## IAM

IAM ì ‘ê·¼ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

## Confused Deputy Problem

ì™¸ë¶€ ê³„ì •(A)ì—ê²Œ ê·€í•˜ì˜ ê³„ì •ì—ì„œ ì—­í• ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•˜ë©´, í•´ë‹¹ ì™¸ë¶€ ê³„ì •ì— ì •í™•íˆ ëˆ„ê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ì§€ì— ëŒ€í•œ ê°€ì‹œì„±ì´ 0ì´ ë  ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤. ì´ëŠ” ë¬¸ì œì…ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ë‹¤ë¥¸ ì™¸ë¶€ ê³„ì •(B)ì´ ì™¸ë¶€ ê³„ì •(A)ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤ë©´, Bë„ ê·€í•˜ì˜ ê³„ì •ì— ì ‘ê·¼í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ë”°ë¼ì„œ ì™¸ë¶€ ê³„ì •ì´ ê·€í•˜ì˜ ê³„ì •ì—ì„œ ì—­í• ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•  ë•Œ `ExternalId`ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì™¸ë¶€ ê³„ì •(A)ì´ ê·€í•˜ì˜ ì¡°ì§ì—ì„œ ì—­í• ì„ ë§¡ê¸° ìœ„í•´ ì§€ì •í•´ì•¼ í•˜ëŠ” "ë¹„ë°€" ë¬¸ìì—´ì…ë‹ˆë‹¤. ì™¸ë¶€ ê³„ì • BëŠ” ì´ ë¬¸ìì—´ì„ ì•Œì§€ ëª»í•˜ê¸° ë•Œë¬¸ì—, Aì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ìˆë”ë¼ë„ ê·€í•˜ì˜ ì—­í• ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (95).png" alt=""><figcaption></figcaption></figure>

ê·¸ëŸ¬ë‚˜ ì´ `ExternalId` "ë¹„ë°€"ì€ ë¹„ë°€ì´ ì•„ë‹™ë‹ˆë‹¤. IAM ì—­í•  ì •ì±…ì„ ì½ì„ ìˆ˜ ìˆëŠ” ì‚¬ëŒì€ ëˆ„êµ¬ë‚˜ ì´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì™¸ë¶€ ê³„ì • Aê°€ ì´ë¥¼ ì•Œê³  ì™¸ë¶€ ê³„ì • Bê°€ ì´ë¥¼ ëª¨ë¥´ëŠ” í•œ, Bê°€ Aë¥¼ ì•…ìš©í•˜ì—¬ ê·€í•˜ì˜ ì—­í• ì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆì‹œ:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
{% hint style="warning" %}
ê³µê²©ìê°€ í˜¼ë™ëœ ëŒ€ë¦¬ì¸ì„ ì•…ìš©í•˜ë ¤ë©´ í˜„ì¬ ê³„ì •ì˜ ì£¼ì²´ê°€ ë‹¤ë¥¸ ê³„ì •ì˜ ì—­í• ì„ ê°€ì¥í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}

### ì˜ˆìƒì¹˜ ëª»í•œ ì‹ ë¢°

#### ì£¼ì²´ë¡œì„œì˜ ì™€ì¼ë“œì¹´ë“œ
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" },
}
```
ì´ ì •ì±…ì€ **ëª¨ë“  AWS**ê°€ ì—­í• ì„ ë§¡ì„ ìˆ˜ ìˆë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤.

#### Service as principal
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
ì´ ì •ì±…ì€ **ì–´ë–¤ ê³„ì •ì´ë“ ** ì´ Lambdaë¥¼ í˜¸ì¶œí•˜ë„ë¡ apigatewayë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

#### S3 as principal
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
S3 ë²„í‚·ì´ principalë¡œ ì§€ì •ëœ ê²½ìš°, S3 ë²„í‚·ì—ëŠ” Account IDê°€ ì—†ê¸° ë•Œë¬¸ì—, **ë²„í‚·ì„ ì‚­ì œí•˜ê³  ê³µê²©ìê°€ ìì‹ ì˜ ê³„ì •ì—** ë²„í‚·ì„ ìƒì„±í•˜ë©´ ì´ë¥¼ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### ì§€ì›ë˜ì§€ ì•ŠìŒ
```json
{
"Effect": "Allow",
"Principal": {"Service": "cloudtrail.amazonaws.com"},
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
Confused Deputy ë¬¸ì œë¥¼ í”¼í•˜ëŠ” ì¼ë°˜ì ì¸ ë°©ë²•ì€ `AWS:SourceArn` ì¡°ê±´ì„ ì‚¬ìš©í•˜ì—¬ ì›ë³¸ ARNì„ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **ì¼ë¶€ ì„œë¹„ìŠ¤ëŠ” ì´ë¥¼ ì§€ì›í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤** (ì¼ë¶€ ì†ŒìŠ¤ì— ë”°ë¥´ë©´ CloudTrailê³¼ ê°™ì€).

## References

* [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
