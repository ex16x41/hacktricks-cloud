# AWS - IAM Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## IAM

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Ï„Î·Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· IAM:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

## Confused Deputy Problem

Î•Î¬Î½ **ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÏ„Îµ ÏƒÎµ Î­Î½Î±Î½ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ (A)** Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î­Î½Î±Î½ **ÏÏŒÎ»Î¿** ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ ÏƒÎ±Ï‚, Ï€Î¹Î¸Î±Î½ÏŒÏ„Î±Ï„Î± Î¸Î± Î­Ï‡ÎµÏ„Îµ **0 Î¿ÏÎ±Ï„ÏŒÏ„Î·Ï„Î±** ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ **Ï€Î¿Î¹Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î±ÎºÏÎ¹Î²ÏÏ‚ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ**. Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Î­Î½Î± Ï€ÏÏŒÎ²Î»Î·Î¼Î±, ÎµÏ€ÎµÎ¹Î´Î® ÎµÎ¬Î½ Î­Î½Î±Ï‚ Î¬Î»Î»Î¿Ï‚ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒÏ‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ (B) Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿Î½ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ (A), ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¸Î±Î½ÏŒ ÏŒÏ„Î¹ **Î¿ B Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ ÏƒÎ±Ï‚**.

Î•Ï€Î¿Î¼Î­Î½Ï‰Ï‚, ÏŒÏ„Î±Î½ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Îµ ÏƒÎµ Î­Î½Î±Î½ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î­Î½Î±Î½ ÏÏŒÎ»Î¿ ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ ÏƒÎ±Ï‚, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± ÎºÎ±Î¸Î¿ÏÎ¯ÏƒÎµÏ„Îµ Î­Î½Î± `ExternalId`. Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Î¼Î¹Î± "Î¼Ï…ÏƒÏ„Î¹ÎºÎ®" ÏƒÏ…Î¼Î²Î¿Î»Î¿ÏƒÎµÎ¹ÏÎ¬ Ï€Î¿Ï… Î¿ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒÏ‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ (A) **Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎºÎ±Î¸Î¿ÏÎ¯ÏƒÎµÎ¹** Ï€ÏÎ¿ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… Î½Î± **Î±Î½Î±Î»Î¬Î²ÎµÎ¹ Ï„Î¿Î½ ÏÏŒÎ»Î¿ ÏƒÏ„Î·Î½ Î¿ÏÎ³Î¬Î½Ï‰ÏƒÎ® ÏƒÎ±Ï‚**. ÎšÎ±Î¸ÏÏ‚ Î¿ **ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒÏ‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ B Î´ÎµÎ½ Î¸Î± Î³Î½Ï‰ÏÎ¯Î¶ÎµÎ¹ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ…Î¼Î²Î¿Î»Î¿ÏƒÎµÎ¹ÏÎ¬**, Î±ÎºÏŒÎ¼Î· ÎºÎ±Î¹ Î±Î½ Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿Î½ A, **Î´ÎµÎ½ Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿Î½ ÏÏŒÎ»Î¿ ÏƒÎ±Ï‚**.

<figure><img src="../../../.gitbook/assets/image (95).png" alt=""><figcaption></figcaption></figure>

Î©ÏƒÏ„ÏŒÏƒÎ¿, ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î±Ï…Ï„Î® Î· "Î¼Ï…ÏƒÏ„Î¹ÎºÎ®" `ExternalId` **Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î¼Ï…ÏƒÏ„Î¹ÎºÎ®**, Î¿Ï€Î¿Î¹Î¿ÏƒÎ´Î®Ï€Î¿Ï„Îµ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± **Î´Î¹Î±Î²Î¬ÏƒÎµÎ¹ Ï„Î·Î½ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚ ÏÏŒÎ»Î¿Ï… IAM Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï„Î· Î´ÎµÎ¹**. Î‘Î»Î»Î¬ ÏŒÏƒÎ¿ Î¿ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒÏ‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ A Ï„Î¿ Î³Î½Ï‰ÏÎ¯Î¶ÎµÎ¹, Î±Î»Î»Î¬ Î¿ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒÏ‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ **B Î´ÎµÎ½ Ï„Î¿ Î³Î½Ï‰ÏÎ¯Î¶ÎµÎ¹**, Î±Ï…Ï„ÏŒ **Î±Ï€Î¿Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î¿Î½ B Î±Ï€ÏŒ Ï„Î¿ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯ Ï„Î¿Î½ A Î³Î¹Î± Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿Î½ ÏÏŒÎ»Î¿ ÏƒÎ±Ï‚**.

Example:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
{% hint style="warning" %}
Î“Î¹Î± Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯ Î­Î½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î­Î½Î±Î½ Î¼Ï€ÎµÏÎ´ÎµÎ¼Î­Î½Î¿ Î±Î½Î±Ï€Î»Î·ÏÏ‰Ï„Î®, Î¸Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± Î²ÏÎµÎ¹ Î¼Îµ ÎºÎ¬Ï€Î¿Î¹Î¿ Ï„ÏÏŒÏ€Î¿ Î±Î½ Î¿Î¹ ÎºÏÏÎ¹Î¿Î¹ Ï„Î¿Ï… Ï„ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Ï€ÏÎ¿ÏƒÏ€Î¿Î¹Î·Î¸Î¿ÏÎ½ ÏÏŒÎ»Î¿Ï…Ï‚ ÏƒÎµ Î¬Î»Î»Î¿Ï…Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿ÏÏ‚.
{% endhint %}

### Î‘Ï€ÏÎ¿ÏƒÎ´ÏŒÎºÎ·Ï„ÎµÏ‚ Î•Î¼Ï€Î¹ÏƒÏ„Î¿ÏƒÏÎ½ÎµÏ‚

#### Wildcard Ï‰Ï‚ ÎºÏÏÎ¹Î¿Ï‚
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" },
}
```
Î‘Ï…Ï„Î® Î· Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® **ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÎµ ÏŒÎ»Î± Ï„Î± AWS** Î½Î± Î±Î½Î±Î»Î¬Î²Î¿Ï…Î½ Ï„Î¿Î½ ÏÏŒÎ»Î¿.

#### Î¥Ï€Î·ÏÎµÏƒÎ¯Î± Ï‰Ï‚ ÎºÏÏÎ¹Î¿Ï‚
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
Î‘Ï…Ï„Î® Î· Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® **ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÎµ Î¿Ï€Î¿Î¹Î¿Î½Î´Î®Ï€Î¿Ï„Îµ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ** Î½Î± ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹ Ï„Î¿ apigateway Ï„Î¿Ï… Î³Î¹Î± Î½Î± ÎºÎ±Î»Î­ÏƒÎµÎ¹ Î±Ï…Ï„Î® Ï„Î· Lambda.

#### S3 Ï‰Ï‚ ÎºÏÏÎ¹Î¿Ï‚
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
Î‘Î½ Î­Î½Î± S3 bucket Î´Î¿Î¸ÎµÎ¯ Ï‰Ï‚ ÎºÏÏÎ¹Î¿Ï‚, ÎµÏ€ÎµÎ¹Î´Î® Ï„Î± S3 buckets Î´ÎµÎ½ Î­Ï‡Î¿Ï…Î½ ID Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï, Î±Î½ **Î´Î¹Î±Î³ÏÎ¬ÏˆÎ±Ï„Îµ Ï„Î¿ bucket ÏƒÎ±Ï‚ ÎºÎ±Î¹ Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Ï„Î¿ Î´Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ** ÏƒÏ„Î¿Î½ Î´Î¹ÎºÏŒ Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ, Ï„ÏŒÏ„Îµ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Î½ Î½Î± Ï„Î¿ ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„Î¿ÏÎ½ Î±Ï…Ï„ÏŒ.

#### Not supported
```json
{
"Effect": "Allow",
"Principal": {"Service": "cloudtrail.amazonaws.com"},
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
ÎˆÎ½Î±Ï‚ ÎºÎ¿Î¹Î½ÏŒÏ‚ Ï„ÏÏŒÏ€Î¿Ï‚ Î³Î¹Î± Î½Î± Î±Ï€Î¿Ï†ÎµÏ…Ï‡Î¸Î¿ÏÎ½ Ï„Î± Ï€ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î± Confused Deputy ÎµÎ¯Î½Î±Î¹ Î· Ï‡ÏÎ®ÏƒÎ· Î¼Î¹Î±Ï‚ ÏƒÏ…Î½Î¸Î®ÎºÎ·Ï‚ Î¼Îµ Ï„Î¿ `AWS:SourceArn` Î³Î¹Î± Î½Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹ Ï„Î¿ ARN Ï€ÏÎ¿Î­Î»ÎµÏ…ÏƒÎ·Ï‚. Î©ÏƒÏ„ÏŒÏƒÎ¿, **Î¿ÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î¼Î·Î½ Ï„Î¿ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶Î¿Ï…Î½** (ÏŒÏ€Ï‰Ï‚ Ï„Î¿ CloudTrail ÏƒÏÎ¼Ï†Ï‰Î½Î± Î¼Îµ Î¿ÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ Ï€Î·Î³Î­Ï‚).

## Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚

* [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
