# AWS - IAM Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## IAM

IAM рдПрдХреНрд╕реЗрд╕ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

## Confused Deputy Problem

рдпрджрд┐ рдЖрдк **рдПрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ (A)** рдХреЛ рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ **рдПрдХ рднреВрдорд┐рдХрд╛** рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдпрд╣ рдЬрд╛рдирдиреЗ рдХреА рдХреЛрдИ рджреГрд╢реНрдпрддрд╛ рдирд╣реАрдВ рд╣реЛрдЧреА рдХрд┐ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдХреМрди рдЙрд╕ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИ**ред рдпрд╣ рдПрдХ рд╕рдорд╕реНрдпрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрджрд┐ рдПрдХ рдЕрдиреНрдп рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ (B) рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ (A) рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **B рднреА рдЖрдкрдХреЗ рдЦрд╛рддреЗ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХреЗ**ред

рдЗрд╕рд▓рд┐рдП, рдЬрдм рдЖрдк рдПрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ рдХреЛ рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ рдПрдХ рднреВрдорд┐рдХрд╛ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдПрдХ `ExternalId` рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣ рдПрдХ "рдЧреБрдкреНрдд" рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╣реИ рдЬрд┐рд╕реЗ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ (A) рдХреЛ **рдЖрдкрдХреЗ рд╕рдВрдЧрдарди рдореЗрдВ рднреВрдорд┐рдХрд╛ рдЧреНрд░рд╣рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ**ред рдЪреВрдВрдХрд┐ **рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ B рдЗрд╕ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЛ рдирд╣реАрдВ рдЬрд╛рдирддрд╛**, рднрд▓реЗ рд╣реА рдЙрд╕рдХреЗ рдкрд╛рд╕ A рдкрд░ рдкрд╣реБрдБрдЪ рд╣реЛ, рд╡рд╣ **рдЖрдкрдХреА рднреВрдорд┐рдХрд╛ рддрдХ рдкрд╣реБрдБрдЪ рдирд╣реАрдВ рд╕рдХреЗрдЧрд╛**ред

<figure><img src="../../../.gitbook/assets/image (95).png" alt=""><figcaption></figcaption></figure>

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ `ExternalId` "рдЧреБрдкреНрдд" **рдЧреБрдкреНрдд рдирд╣реАрдВ рд╣реИ**, рдЬреЛ рдХреЛрдИ рднреА **IAM рднреВрдорд┐рдХрд╛ рдЧреНрд░рд╣рдг рдиреАрддрд┐ рдХреЛ рдкрдврд╝ рд╕рдХрддрд╛ рд╣реИ, рд╡рд╣ рдЗрд╕реЗ рджреЗрдЦ рд╕рдХреЗрдЧрд╛**ред рд▓реЗрдХрд┐рди рдЬрдм рддрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ A рдЗрд╕реЗ рдЬрд╛рдирддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ **B рдЗрд╕реЗ рдирд╣реАрдВ рдЬрд╛рдирддрд╛**, рдпрд╣ **B рдХреЛ A рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдкрдХреА рднреВрдорд┐рдХрд╛ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИ**ред

Example:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
{% hint style="warning" %}
рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдПрдХ рднреНрд░рдорд┐рдд рдбрд┐рдкреНрдЯреА рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рд╡рд░реНрддрдорд╛рди рдЦрд╛рддреЗ рдХреЗ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдЕрдиреНрдп рдЦрд╛рддреЛрдВ рдореЗрдВ рднреВрдорд┐рдХрд╛рдУрдВ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

### рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рдЯреНрд░рд╕реНрдЯ

#### рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" },
}
```
рдпрд╣ рдиреАрддрд┐ **рд╕рднреА AWS** рдХреЛ рднреВрдорд┐рдХрд╛ рдЧреНрд░рд╣рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред

#### рд╕реЗрд╡рд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдореБрдЦ
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
рдпрд╣ рдиреАрддрд┐ **рдХрд┐рд╕реА рднреА рдЦрд╛рддреЗ** рдХреЛ рдЕрдкрдиреЗ apigateway рдХреЛ рдЗрд╕ Lambda рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред

#### S3 рдХреЛ рдкреНрд░рдореБрдЦ рдХреЗ рд░реВрдк рдореЗрдВ
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
рдпрджрд┐ S3 рдмрдХреЗрдЯ рдХреЛ рдПрдХ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ S3 рдмрдХреЗрдЯ рдХрд╛ рдХреЛрдИ рдЦрд╛рддрд╛ рдЖрдИрдбреА рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рдпрджрд┐ рдЖрдкрдиреЗ **рдЕрдкрдирд╛ рдмрдХреЗрдЯ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдФрд░ рд╣рдорд▓рд╛рд╡рд░ рдиреЗ** рдЗрд╕реЗ рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ рдмрдирд╛рдпрд╛, рддреЛ рд╡реЗ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

#### рд╕рдорд░реНрдерд┐рдд рдирд╣реАрдВ
```json
{
"Effect": "Allow",
"Principal": {"Service": "cloudtrail.amazonaws.com"},
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рддрд░реАрдХрд╛ Confused Deputy рд╕рдорд╕реНрдпрд╛рдУрдВ рд╕реЗ рдмрдЪрдиреЗ рдХрд╛ `AWS:SourceArn` рдХреЗ рд╕рд╛рде рдПрдХ рд╢рд░реНрдд рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИ рддрд╛рдХрд┐ рдореВрд▓ ARN рдХреА рдЬрд╛рдВрдЪ рдХреА рдЬрд╛ рд╕рдХреЗред рд╣рд╛рд▓рд╛рдВрдХрд┐, **рдХреБрдЫ рд╕реЗрд╡рд╛рдПрдБ рдЗрд╕рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░ рд╕рдХрддреА рд╣реИрдВ** (рдЬреИрд╕реЗ рдХрд┐ рдХреБрдЫ рд╕реНрд░реЛрддреЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░ CloudTrail)ред

## рд╕рдВрджрд░реНрдн

* [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ рд╕рд╛рде рдЬреБрдбрд╝реЗрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
