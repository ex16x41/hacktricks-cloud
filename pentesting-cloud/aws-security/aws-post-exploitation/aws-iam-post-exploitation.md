# AWS - IAM Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## IAM

IAM ì ‘ê·¼ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

## Confused Deputy Problem

ì™¸ë¶€ ê³„ì •(A)ì´ ê·€í•˜ì˜ ê³„ì •ì˜ **ì—­í• **ì— ì ‘ê·¼í•˜ë„ë¡ **í—ˆìš©**í•˜ë©´, **ê·¸ ì™¸ë¶€ ê³„ì •ì— ì •í™•íˆ ëˆ„ê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ì§€ì— ëŒ€í•œ ê°€ì‹œì„±ì´ 0**ì´ ë  ê²ƒì…ë‹ˆë‹¤. ì´ëŠ” ë¬¸ì œì…ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ë‹¤ë¥¸ ì™¸ë¶€ ê³„ì •(B)ì´ ì™¸ë¶€ ê³„ì •(A)ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤ë©´, **Bë„ ê·€í•˜ì˜ ê³„ì •ì— ì ‘ê·¼í•  ìˆ˜ ìˆì„ ê°€ëŠ¥ì„±ì´ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤**.

ë”°ë¼ì„œ ì™¸ë¶€ ê³„ì •ì´ ê·€í•˜ì˜ ê³„ì •ì˜ ì—­í• ì— ì ‘ê·¼í•˜ë„ë¡ í—ˆìš©í•  ë•Œ `ExternalId`ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì™¸ë¶€ ê³„ì •(A)ì´ ê·€í•˜ì˜ ì¡°ì§ì—ì„œ **ì—­í• ì„ ë§¡ê¸° ìœ„í•´ ë°˜ë“œì‹œ ì§€ì •í•´ì•¼ í•˜ëŠ”** "ë¹„ë°€" ë¬¸ìì—´ì…ë‹ˆë‹¤. **ì™¸ë¶€ ê³„ì • BëŠ” ì´ ë¬¸ìì—´ì„ ì•Œì§€ ëª»í•˜ë¯€ë¡œ**, Aì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ìˆë”ë¼ë„ **ê·€í•˜ì˜ ì—­í• ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.

<figure><img src="../../../.gitbook/assets/image (95).png" alt=""><figcaption></figcaption></figure>

ê·¸ëŸ¬ë‚˜ ì´ `ExternalId` "ë¹„ë°€"ì€ **ë¹„ë°€ì´ ì•„ë‹™ë‹ˆë‹¤**. IAM ì—­í•  ë§¡ê¸° ì •ì±…ì„ **ì½ì„ ìˆ˜ ìˆëŠ” ì‚¬ëŒì€ ëˆ„êµ¬ë‚˜ ì´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. í•˜ì§€ë§Œ ì™¸ë¶€ ê³„ì • Aê°€ ì´ë¥¼ ì•Œê³  ìˆê³ , ì™¸ë¶€ ê³„ì • **BëŠ” ì´ë¥¼ ëª¨ë¥¸ë‹¤ë©´**, ì´ëŠ” **Bê°€ Aë¥¼ ì•…ìš©í•˜ì—¬ ê·€í•˜ì˜ ì—­í• ì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤**.

ì˜ˆì‹œ:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
{% hint style="warning" %}
ê³µê²©ìê°€ í˜¼ë€ìŠ¤ëŸ¬ìš´ ëŒ€ë¦¬ì¸ì„ ì´ìš©í•˜ë ¤ë©´ í˜„ì¬ ê³„ì •ì˜ ì£¼ì²´ê°€ ë‹¤ë¥¸ ê³„ì •ì˜ ì—­í• ì„ ê°€ì¥í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}

### ì˜ˆìƒì¹˜ ëª»í•œ ì‹ ë¢°

#### ì£¼ì²´ë¡œì„œì˜ ì™€ì¼ë“œì¹´ë“œ
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" },
}
```
ì´ ì •ì±…ì€ **ëª¨ë“  AWS**ê°€ ì—­í• ì„ ë§¡ë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤.

#### ì„œë¹„ìŠ¤ ì£¼ì²´ë¡œì„œ
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
ì´ ì •ì±…ì€ **ëª¨ë“  ê³„ì •**ì´ ìì‹ ì˜ apigatewayë¥¼ êµ¬ì„±í•˜ì—¬ ì´ Lambdaë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤.

#### S3ë¥¼ ì£¼ì²´ë¡œ
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
S3 ë²„í‚·ì´ ì£¼ì²´ë¡œ ì£¼ì–´ì§€ë©´, S3 ë²„í‚·ì—ëŠ” ê³„ì • IDê°€ ì—†ê¸° ë•Œë¬¸ì—, ë§Œì•½ **ë‹¹ì‹ ì˜ ë²„í‚·ì„ ì‚­ì œí•˜ê³  ê³µê²©ìê°€** ìì‹ ì˜ ê³„ì •ì—ì„œ ê·¸ê²ƒì„ ìƒì„±í•˜ë©´, ê·¸ë“¤ì€ ì´ë¥¼ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### ì§€ì›ë˜ì§€ ì•ŠìŒ
```json
{
"Effect": "Allow",
"Principal": {"Service": "cloudtrail.amazonaws.com"},
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
Confused Deputy ë¬¸ì œë¥¼ í”¼í•˜ëŠ” ì¼ë°˜ì ì¸ ë°©ë²•ì€ `AWS:SourceArn` ì¡°ê±´ì„ ì‚¬ìš©í•˜ì—¬ ì›ë³¸ ARNì„ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **ì¼ë¶€ ì„œë¹„ìŠ¤ëŠ” ì´ë¥¼ ì§€ì›í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤** (ì¼ë¶€ ì¶œì²˜ì— ë”°ë¥´ë©´ CloudTrailê³¼ ê°™ì€).

## References

* [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
