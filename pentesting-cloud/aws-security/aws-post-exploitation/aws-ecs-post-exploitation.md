# AWS - ECS Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## ECS

For more information check:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### Host IAM Roles

ECS ‡§Æ‡•á‡§Ç ‡§è‡§ï **IAM ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø** ‡§ï‡•ã ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§∏‡§æ‡§á‡§® ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§ **‡§Ø‡§¶‡§ø** ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§è‡§ï **EC2** ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ö‡§≤‡§æ‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à, ‡§§‡•ã **EC2 ‡§â‡§¶‡§æ‡§π‡§∞‡§£** ‡§ï‡•á ‡§∏‡§æ‡§• **‡§è‡§ï ‡§î‡§∞ IAM** ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ú‡•Å‡§°‡§º‡•Ä ‡§π‡•ã‡§ó‡•Ä‡•§\
‡§á‡§∏‡§ï‡§æ ‡§Æ‡§§‡§≤‡§¨ ‡§π‡•à ‡§ï‡§ø ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§è‡§ï ECS ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•ã **‡§∏‡§Æ‡§ù‡•å‡§§‡§æ** ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§´‡§≤ ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§Ü‡§™ ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á **ECR ‡§î‡§∞ EC2 ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ IAM ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç**‡•§ ‡§â‡§® ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§§‡§∞‡•Ä‡§ï‡•á ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¶‡•á‡§ñ‡•á‡§Ç:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§¶‡§ø EC2 ‡§â‡§¶‡§æ‡§π‡§∞‡§£ IMDSv2 ‡§ï‡•ã ‡§≤‡§æ‡§ó‡•Ç ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à, [**‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º‡•ã‡§Ç ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), **PUT ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡§æ ‡§â‡§§‡•ç‡§§‡§∞** ‡§Æ‡•á‡§Ç **‡§π‡•â‡§™ ‡§∏‡•Ä‡§Æ‡§æ 1** ‡§π‡•ã‡§ó‡•Ä, ‡§ú‡§ø‡§∏‡§∏‡•á EC2 ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§è‡§ï ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§∏‡•á EC2 ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ ‡§§‡§ï ‡§™‡§π‡•Å‡§Ç‡§ö‡§®‡§æ ‡§Ö‡§∏‡§Ç‡§≠‡§µ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ‡•§
{% endhint %}

### Privesc to node to steal other containers creds & secrets

‡§≤‡•á‡§ï‡§ø‡§® ‡§á‡§∏‡§ï‡•á ‡§Ö‡§≤‡§æ‡§µ‡§æ, EC2 ECs ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡•â‡§ï‡§∞ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡§æ ‡§π‡•à, ‡§á‡§∏‡§≤‡§ø‡§è ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§®‡•ã‡§° ‡§™‡§∞ ‡§≠‡§æ‡§ó‡§®‡•á ‡§Ø‡§æ **‡§°‡•â‡§ï‡§∞ ‡§∏‡•â‡§ï‡•á‡§ü ‡§§‡§ï ‡§™‡§π‡•Å‡§Ç‡§ö‡§®‡•á** ‡§Æ‡•á‡§Ç ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§Ü‡§™ **‡§ö‡•á‡§ï** ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø **‡§Ö‡§®‡•ç‡§Ø ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞** ‡§ï‡•å‡§® ‡§∏‡•á ‡§ö‡§≤ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç, ‡§î‡§∞ ‡§Ø‡§π‡§æ‡§Ç ‡§§‡§ï ‡§ï‡§ø **‡§â‡§®‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç** ‡§î‡§∞ **‡§â‡§®‡§ï‡•Ä IAM ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ‡§è‡§Å** ‡§ö‡•Å‡§∞‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

#### Making containers run in current host

‡§á‡§∏‡§ï‡•á ‡§Ö‡§≤‡§æ‡§µ‡§æ, **EC2 ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•Ä ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ** ‡§Ü‡§Æ‡§§‡•å‡§∞ ‡§™‡§∞ **‡§ï‡•ç‡§≤‡§∏‡•ç‡§ü‡§∞ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§®‡•ã‡§°‡•ç‡§∏ ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§è ‡§ú‡§æ ‡§∞‡§π‡•á EC2 ‡§â‡§¶‡§æ‡§π‡§∞‡§£‡•ã‡§Ç ‡§ï‡•Ä ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á** ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§ **‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡§æ‡§Å** ‡§∞‡§ñ‡•á‡§ó‡•Ä‡•§ ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **DRAINING** ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•Ä **‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡•ã ‡§∏‡§Ç‡§∂‡•ã‡§ß‡§ø‡§§** ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à, ‡§´‡§ø‡§∞ ECS **‡§á‡§∏‡§∏‡•á ‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§ó‡§æ** ‡§î‡§∞ ‡§ú‡•ã **REPLICA** ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ö‡§≤ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç, ‡§â‡§®‡•ç‡§π‡•á‡§Ç **‡§è‡§ï ‡§Ö‡§≤‡§ó ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§Æ‡•á‡§Ç ‡§ö‡§≤‡§æ‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ,** ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á **‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•á ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞** ‡§§‡§æ‡§ï‡§ø ‡§µ‡§π **‡§â‡§®‡§ï‡•Ä IAM ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ‡§è‡§Å** ‡§î‡§∞ ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•ã ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§∏‡•á **‡§ö‡•Å‡§∞‡§æ ‡§∏‡§ï‡•á‡•§**
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
**‡§ï‡•ç‡§≤‡§∏‡•ç‡§ü‡§∞ ‡§∏‡•á EC2 ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•ã ‡§°‡•Ä‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡§ï‡•á** ‡§Ø‡§π‡•Ä ‡§§‡§ï‡§®‡•Ä‡§ï ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§ ‡§Ø‡§π ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ï‡§Æ ‡§õ‡§ø‡§™‡•Ä ‡§π‡•Å‡§à ‡§π‡•à ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ø‡§π **‡§Ö‡§®‡•ç‡§Ø ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§Æ‡•á‡§Ç ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§ú‡§¨‡•Ç‡§∞ ‡§ï‡§∞‡•á‡§ó‡§æ:**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
‡§è‡§ï ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§§‡§ï‡§®‡•Ä‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ECS ‡§ï‡•ã ‡§Ø‡§π ‡§∏‡§Ç‡§ï‡•á‡§§ ‡§¶‡•á‡§®‡§æ ‡§π‡•à ‡§ï‡§ø **‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§Ø‡§æ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§¨‡§Ç‡§¶ ‡§π‡•ã ‡§ó‡§Ø‡§æ**‡•§ ‡§á‡§∏‡•á ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è 3 ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ APIs ‡§π‡•à‡§Ç:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### ECR ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞‡•ã‡§Ç ‡§∏‡•á ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ö‡•Å‡§∞‡§æ‡§®‡§æ

EC2 ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§™‡§æ‡§∏ ‡§∏‡§Ç‡§≠‡§µ‡§§‡§É `ecr:GetAuthorizationToken` ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§π‡•ã‡§ó‡•Ä, ‡§ú‡§ø‡§∏‡§∏‡•á ‡§á‡§∏‡•á **‡§á‡§Æ‡•á‡§ú ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°** ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Æ‡§ø‡§≤‡•á‡§ó‡•Ä (‡§Ü‡§™ ‡§á‡§®‡§Æ‡•á‡§Ç ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ñ‡•ã‡§ú ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç)‡•§ 

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
