# AWS - ECSåæ¸—é€

{% hint style="success" %}
å­¦ä¹ å¹¶å®è·µAWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶å®è·µGCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ECS

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### ä¸»æœºIAMè§’è‰²

åœ¨ECSä¸­ï¼Œ**IAMè§’è‰²å¯ä»¥åˆ†é…ç»™**è¿è¡Œåœ¨å®¹å™¨å†…çš„ä»»åŠ¡ã€‚**å¦‚æœ**ä»»åŠ¡åœ¨**EC2**å®ä¾‹å†…è¿è¡Œï¼Œåˆ™**EC2å®ä¾‹**å°†é™„åŠ **å¦ä¸€ä¸ªIAM**è§’è‰²ã€‚\
è¿™æ„å‘³ç€å¦‚æœæ‚¨è®¾æ³•**å…¥ä¾µ**ECSå®ä¾‹ï¼Œåˆ™å¯èƒ½**è·å–ä¸ECRå’ŒEC2å®ä¾‹å…³è”çš„IAMè§’è‰²**ã€‚æœ‰å…³å¦‚ä½•è·å–è¿™äº›å‡­æ®çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œå¦‚æœEC2å®ä¾‹æ­£åœ¨å¼ºåˆ¶æ‰§è¡ŒIMDSv2ï¼Œ[**æ ¹æ®æ–‡æ¡£**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html)ï¼Œ**PUTè¯·æ±‚çš„å“åº”**å°†å…·æœ‰**1ä¸ªè·³æ•°é™åˆ¶**ï¼Œè¿™å°†ä½¿å¾—æ— æ³•ä»EC2å®ä¾‹å†…çš„å®¹å™¨è®¿é—®EC2å…ƒæ•°æ®ã€‚
{% endhint %}

### æå‡æƒé™åˆ°èŠ‚ç‚¹ä»¥çªƒå–å…¶ä»–å®¹å™¨çš„å‡­æ®å’Œæœºå¯†ä¿¡æ¯

æ­¤å¤–ï¼ŒEC2ä½¿ç”¨dockeræ¥è¿è¡ŒECSä»»åŠ¡ï¼Œå› æ­¤å¦‚æœæ‚¨å¯ä»¥é€ƒé€¸åˆ°èŠ‚ç‚¹æˆ–**è®¿é—®dockerå¥—æ¥å­—**ï¼Œæ‚¨å¯ä»¥**æ£€æŸ¥**æ­£åœ¨è¿è¡Œçš„**å…¶ä»–å®¹å™¨**ï¼Œç”šè‡³**è¿›å…¥å…¶ä¸­**å¹¶**çªƒå–å®ƒä»¬çš„IAMè§’è‰²**ã€‚

#### ä½¿å®¹å™¨åœ¨å½“å‰ä¸»æœºä¸Šè¿è¡Œ

æ­¤å¤–ï¼Œ**EC2å®ä¾‹è§’è‰²**é€šå¸¸å…·æœ‰è¶³å¤Ÿçš„**æƒé™**æ¥**æ›´æ–°ç”¨ä½œèŠ‚ç‚¹çš„EC2å®ä¾‹**çš„å®¹å™¨å®ä¾‹çŠ¶æ€ã€‚æ”»å‡»è€…å¯ä»¥ä¿®æ”¹å®ä¾‹çš„**çŠ¶æ€ä¸ºDRAINING**ï¼Œç„¶åECSå°†**ä»ä¸­åˆ é™¤æ‰€æœ‰ä»»åŠ¡**ï¼Œå¹¶ä¸”ä½œä¸º**REPLICA**è¿è¡Œçš„ä»»åŠ¡å°†åœ¨ä¸åŒçš„å®ä¾‹ä¸­è¿è¡Œï¼Œå¯èƒ½åœ¨**æ”»å‡»è€…å®ä¾‹**å†…éƒ¨ï¼Œä»¥ä¾¿ä»–å¯ä»¥**çªƒå–å®ƒä»¬çš„IAMè§’è‰²**å’Œå®¹å™¨å†…çš„æ½œåœ¨æ•æ„Ÿä¿¡æ¯ã€‚
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
åŒæ ·çš„æŠ€æœ¯å¯ä»¥é€šè¿‡**ä»é›†ç¾¤ä¸­æ³¨é”€ EC2 å®ä¾‹**æ¥å®ç°ã€‚è¿™å¯èƒ½ä¸å¤Ÿéšè”½ï¼Œä½†ä¼š**å¼ºåˆ¶ä»»åŠ¡åœ¨å…¶ä»–å®ä¾‹ä¸Šè¿è¡Œï¼š**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
ä¸€ä¸ªå¼ºåˆ¶é‡æ–°æ‰§è¡Œä»»åŠ¡çš„æœ€ç»ˆæŠ€æœ¯æ˜¯å‘Šè¯‰ ECS **ä»»åŠ¡æˆ–å®¹å™¨å·²åœæ­¢**ã€‚æœ‰ä¸‰ä¸ªæ½œåœ¨çš„ API å¯ä»¥å®ç°è¿™ä¸€ç‚¹ï¼š
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### ä» ECR å®¹å™¨ä¸­çªƒå–æ•æ„Ÿä¿¡æ¯

EC2 å®ä¾‹å¯èƒ½è¿˜å…·æœ‰æƒé™ `ecr:GetAuthorizationToken`ï¼Œå…è®¸å…¶**ä¸‹è½½é•œåƒ**ï¼ˆæ‚¨å¯ä»¥åœ¨å…¶ä¸­æœç´¢æ•æ„Ÿä¿¡æ¯ï¼‰ã€‚
