# AWS - ECS åæœŸåˆ©ç”¨

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ECS

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### ä¸»æœº IAM è§’è‰²

åœ¨ ECS ä¸­ï¼Œ**IAM è§’è‰²å¯ä»¥åˆ†é…ç»™åœ¨å®¹å™¨å†…è¿è¡Œçš„ä»»åŠ¡**ã€‚**å¦‚æœ**ä»»åŠ¡åœ¨ **EC2** å®ä¾‹å†…è¿è¡Œï¼Œ**EC2 å®ä¾‹**å°†é™„åŠ  **å¦ä¸€ä¸ª IAM** è§’è‰²ã€‚\
è¿™æ„å‘³ç€å¦‚æœä½ è®¾æ³• **æ”»é™·** ä¸€ä¸ª ECS å®ä¾‹ï¼Œä½ å¯èƒ½ä¼š **è·å¾—ä¸ ECR å’Œ EC2 å®ä¾‹ç›¸å…³è”çš„ IAM è§’è‰²**ã€‚æœ‰å…³å¦‚ä½•è·å–è¿™äº›å‡­æ®çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œå¦‚æœ EC2 å®ä¾‹å¼ºåˆ¶ä½¿ç”¨ IMDSv2ï¼Œ[**æ ¹æ®æ–‡æ¡£**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html)ï¼Œ**PUT è¯·æ±‚çš„å“åº”**å°†å…·æœ‰ **è·³æ•°é™åˆ¶ä¸º 1**ï¼Œä½¿å¾—æ— æ³•ä» EC2 å®ä¾‹å†…çš„å®¹å™¨è®¿é—® EC2 å…ƒæ•°æ®ã€‚
{% endhint %}

### ææƒåˆ°èŠ‚ç‚¹ä»¥çªƒå–å…¶ä»–å®¹å™¨çš„å‡­æ®å’Œç§˜å¯†

æ­¤å¤–ï¼ŒEC2 ä½¿ç”¨ Docker æ¥è¿è¡Œ ECs ä»»åŠ¡ï¼Œå› æ­¤å¦‚æœä½ èƒ½å¤Ÿé€ƒé€¸åˆ°èŠ‚ç‚¹æˆ– **è®¿é—® Docker å¥—æ¥å­—**ï¼Œä½ å¯ä»¥ **æ£€æŸ¥** è¿è¡Œçš„ **å…¶ä»–å®¹å™¨**ï¼Œç”šè‡³ **è¿›å…¥å®ƒä»¬** å¹¶ **çªƒå–å®ƒä»¬é™„åŠ çš„ IAM è§’è‰²**ã€‚

#### ä½¿å®¹å™¨åœ¨å½“å‰ä¸»æœºä¸Šè¿è¡Œ

æ­¤å¤–ï¼Œ**EC2 å®ä¾‹è§’è‰²**é€šå¸¸ä¼šæœ‰è¶³å¤Ÿçš„ **æƒé™** æ¥ **æ›´æ–°ä½œä¸ºé›†ç¾¤å†…èŠ‚ç‚¹ä½¿ç”¨çš„ EC2 å®ä¾‹çš„å®¹å™¨å®ä¾‹çŠ¶æ€**ã€‚æ”»å‡»è€…å¯ä»¥å°† **å®ä¾‹çš„çŠ¶æ€ä¿®æ”¹ä¸º DRAINING**ï¼Œç„¶å ECS å°† **ä»ä¸­ç§»é™¤æ‰€æœ‰ä»»åŠ¡**ï¼Œå¹¶ä¸”ä½œä¸º **REPLICA** è¿è¡Œçš„ä»»åŠ¡å°† **åœ¨ä¸åŒçš„å®ä¾‹ä¸­è¿è¡Œï¼Œ** å¯èƒ½åœ¨ **æ”»å‡»è€…çš„å®ä¾‹** å†…ï¼Œè¿™æ ·ä»–å°±å¯ä»¥ **çªƒå–å®ƒä»¬çš„ IAM è§’è‰²** å’Œæ½œåœ¨çš„æ•æ„Ÿä¿¡æ¯ã€‚
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
ç›¸åŒçš„æŠ€æœ¯å¯ä»¥é€šè¿‡ **ä»é›†ç¾¤ä¸­æ³¨é”€ EC2 å®ä¾‹** æ¥å®ç°ã€‚è¿™å¯èƒ½ä¸é‚£ä¹ˆéšè”½ï¼Œä½†å®ƒå°† **å¼ºåˆ¶ä»»åŠ¡åœ¨å…¶ä»–å®ä¾‹ä¸­è¿è¡Œï¼š**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
ä¸€ç§å¼ºåˆ¶é‡æ–°æ‰§è¡Œä»»åŠ¡çš„æœ€ç»ˆæŠ€æœ¯æ˜¯é€šè¿‡æŒ‡ç¤ºECS **ä»»åŠ¡æˆ–å®¹å™¨å·²åœæ­¢**ã€‚æœ‰3ä¸ªæ½œåœ¨çš„APIå¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼š
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### ä»ECRå®¹å™¨ä¸­çªƒå–æ•æ„Ÿä¿¡æ¯

EC2å®ä¾‹å¯èƒ½è¿˜å…·æœ‰`ecr:GetAuthorizationToken`æƒé™ï¼Œå…è®¸å…¶**ä¸‹è½½é•œåƒ**ï¼ˆæ‚¨å¯ä»¥åœ¨å…¶ä¸­æœç´¢æ•æ„Ÿä¿¡æ¯ï¼‰ã€‚

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
