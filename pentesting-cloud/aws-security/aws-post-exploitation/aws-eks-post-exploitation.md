# AWS - EKSåæ¸—é€

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## EKS

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹

{% content-ref url="../aws-services/aws-eks-enum.md" %}
[aws-eks-enum.md](../aws-services/aws-eks-enum.md)
{% endcontent-ref %}

### ä»AWSæ§åˆ¶å°æšä¸¾é›†ç¾¤

å¦‚æœæ‚¨æ‹¥æœ‰**`eks:AccessKubernetesApi`**æƒé™ï¼Œæ‚¨å¯ä»¥é€šè¿‡AWS EKSæ§åˆ¶å°æŸ¥çœ‹Kuberneteså¯¹è±¡ï¼ˆ[äº†è§£æ›´å¤š](https://docs.aws.amazon.com/eks/latest/userguide/view-workloads.html)ï¼‰ã€‚

### è¿æ¥åˆ°AWS Kubernetesé›†ç¾¤

* ç®€å•æ–¹æ³•ï¼š
```bash
# Generate kubeconfig
aws eks update-kubeconfig --name aws-eks-dev
```
* ä¸é‚£ä¹ˆç®€å•çš„æ–¹æ³•ï¼š

å¦‚æœä½ å¯ä»¥ä½¿ç”¨ **`aws eks get-token --name <cluster_name>`** å‘½ä»¤è·å–ä¸€ä¸ªä»¤ç‰Œï¼Œä½†æ˜¯æ²¡æœ‰æƒé™è·å–é›†ç¾¤ä¿¡æ¯ï¼ˆdescribeClusterï¼‰ï¼Œä½ å¯ä»¥ **å‡†å¤‡è‡ªå·±çš„ `~/.kube/config`**ã€‚ç„¶è€Œï¼Œå³ä½¿æœ‰äº†ä»¤ç‰Œï¼Œä½ ä»ç„¶éœ€è¦ **è¿æ¥åˆ°çš„urlç«¯ç‚¹**ï¼ˆå¦‚æœä½ æˆåŠŸä»ä¸€ä¸ªpodä¸­è·å–äº†JWTä»¤ç‰Œï¼Œè¯·é˜…è¯»[è¿™é‡Œ](#get-api-server-endpoint-from-a-jwt-token)ï¼‰å’Œ **é›†ç¾¤çš„åç§°**ã€‚

åœ¨æˆ‘çš„æƒ…å†µä¸‹ï¼Œæˆ‘æ²¡æœ‰åœ¨CloudWatchæ—¥å¿—ä¸­æ‰¾åˆ°è¿™äº›ä¿¡æ¯ï¼Œä½†æˆ‘åœ¨ **LaunchTemplates userData** å’Œ **EC2 machines userData** ä¸­æ‰¾åˆ°äº†ã€‚ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨ **userData** ä¸­çœ‹åˆ°è¿™äº›ä¿¡æ¯ï¼Œä¾‹å¦‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼ˆé›†ç¾¤åç§°ä¸ºcluster-nameï¼‰ï¼š
```bash
API_SERVER_URL=https://6253F6CA47F81264D8E16FAA7A103A0D.gr7.us-east-1.eks.amazonaws.com

/etc/eks/bootstrap.sh cluster-name --kubelet-extra-args '--node-labels=eks.amazonaws.com/sourceLaunchTemplateVersion=1,alpha.eksctl.io/cluster-name=cluster-name,alpha.eksctl.io/nodegroup-name=prd-ondemand-us-west-2b,role=worker,eks.amazonaws.com/nodegroup-image=ami-002539dd2c532d0a5,eks.amazonaws.com/capacityType=ON_DEMAND,eks.amazonaws.com/nodegroup=prd-ondemand-us-west-2b,type=ondemand,eks.amazonaws.com/sourceLaunchTemplateId=lt-0f0f0ba62bef782e5 --max-pods=58' --b64-cluster-ca $B64_CLUSTER_CA --apiserver-endpoint $API_SERVER_URL --dns-cluster-ip $K8S_CLUSTER_DNS_IP --use-max-pods false
```
{% endcode %}

<details>

<summary>kubeé…ç½®</summary>
```yaml
describe-cache-parametersapiVersion: v1
clusters:
- cluster:
certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1USXlPREUyTWpjek1Wb1hEVE15TVRJeU5URTJNamN6TVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDlXCk9OS0ZqeXZoRUxDZGhMNnFwWkMwa1d0UURSRVF1UzVpRDcwK2pjbjFKWXZ4a3FsV1ZpbmtwOUt5N2x2ME5mUW8KYkNqREFLQWZmMEtlNlFUWVVvOC9jQXJ4K0RzWVlKV3dzcEZGbWlsY1lFWFZHMG5RV1VoMVQ3VWhOanc0MllMRQpkcVpzTGg4OTlzTXRLT1JtVE5sN1V6a05pTlUzSytueTZSRysvVzZmbFNYYnRiT2kwcXJSeFVpcDhMdWl4WGRVCnk4QTg3VjRjbllsMXo2MUt3NllIV3hhSm11eWI5enRtbCtBRHQ5RVhOUXhDMExrdWcxSDBqdTl1MDlkU09YYlkKMHJxY2lINjYvSTh0MjlPZ3JwNkY0dit5eUNJUjZFQURRaktHTFVEWUlVSkZ4WXA0Y1pGcVA1aVJteGJ5Nkh3UwpDSE52TWNJZFZRRUNQMlg5R2c4Q0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZQVXFsekhWZmlDd0xqalhPRmJJUUc3L0VxZ1hNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBS1o4c0l4aXpsemx0aXRPcGcySgpYV0VUSThoeWxYNWx6cW1mV0dpZkdFVVduUDU3UEVtWW55eWJHbnZ5RlVDbnczTldMRTNrbEVMQVE4d0tLSG8rCnBZdXAzQlNYamdiWFovdWVJc2RhWlNucmVqNU1USlJ3SVFod250ZUtpU0J4MWFRVU01ZGdZc2c4SlpJY3I2WC8KRG5POGlHOGxmMXVxend1dUdHSHM2R1lNR0Mvd1V0czVvcm1GS291SmtSUWhBZElMVkNuaStYNCtmcHUzT21UNwprS3VmR0tyRVlKT09VL1c2YTB3OTRycU9iSS9Mem1GSWxJQnVNcXZWVDBwOGtlcTc1eklpdGNzaUJmYVVidng3Ci9sMGhvS1RqM0IrOGlwbktIWW4wNGZ1R2F2YVJRbEhWcldDVlZ4c3ZyYWpxOUdJNWJUUlJ6TnpTbzFlcTVZNisKRzVBPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
server: https://6253F6CA47F81264D8E16FAA7A103A0D.gr7.us-west-2.eks.amazonaws.com
name: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
contexts:
- context:
cluster: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
user: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
name: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
current-context: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
kind: Config
preferences: {}
users:
- name: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
user:
exec:
apiVersion: client.authentication.k8s.io/v1beta1
args:
- --region
- us-west-2
- --profile
- <profile>
- eks
- get-token
- --cluster-name
- <cluster-name>
command: aws
env: null
interactiveMode: IfAvailable
provideClusterInfo: false
```
</details>

### ä» AWS åˆ° Kubernetes

**EKS é›†ç¾¤çš„åˆ›å»ºè€…**å§‹ç»ˆå¯ä»¥è¿›å…¥ç»„ä¸­çš„ kubernetes é›†ç¾¤éƒ¨åˆ†çš„ **`system:masters`**ï¼ˆk8s ç®¡ç†å‘˜ï¼‰ã€‚åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œ**æ²¡æœ‰ç›´æ¥çš„æ–¹æ³•**å¯ä»¥æ‰¾åˆ°**åˆ›å»ºé›†ç¾¤çš„äºº**ï¼ˆæ‚¨å¯ä»¥æ£€æŸ¥ CloudTrailï¼‰ã€‚å¹¶ä¸”**æ²¡æœ‰åŠæ³•**å»**ç§»é™¤**è¿™ä¸ª**ç‰¹æƒ**ã€‚

æˆäºˆ**æ›´å¤š AWS IAM ç”¨æˆ·æˆ–è§’è‰²å¯¹ K8s çš„è®¿é—®æƒé™**çš„æ–¹æ³•æ˜¯ä½¿ç”¨ **`aws-auth`** **configmap**ã€‚

{% hint style="warning" %}
å› æ­¤ï¼Œä»»ä½•å…·æœ‰å¯¹ **`aws-auth`** config map çš„**å†™å…¥è®¿é—®æƒé™**çš„äººéƒ½å°†èƒ½å¤Ÿ** compromise æ•´ä¸ªé›†ç¾¤**ã€‚&#x20;
{% endhint %}

æœ‰å…³å¦‚ä½•åœ¨**ç›¸åŒæˆ–ä¸åŒå¸æˆ·ä¸­å‘ IAM è§’è‰²å’Œç”¨æˆ·æˆäºˆé¢å¤–æƒé™**ä»¥åŠå¦‚ä½•**æ»¥ç”¨**æ­¤åŠŸèƒ½ï¼Œè¯·æŸ¥çœ‹[**æ­¤é¡µé¢**](../../kubernetes-security/abusing-roles-clusterroles-in-kubernetes/#aws-eks-aws-auth-configmaps)ã€‚

è¿˜å¯ä»¥æŸ¥çœ‹[**è¿™ç¯‡å¾ˆæ£’çš„æ–‡ç« **](https://blog.lightspin.io/exploiting-eks-authentication-vulnerability-in-aws-iam-authenticator) **ä»¥äº†è§£ IAM èº«ä»½éªŒè¯ -> Kubernetes çš„å·¥ä½œåŸç†**ã€‚

### ä» Kubernetes åˆ° AWS

å¯ä»¥å…è®¸**ä¸º kubernetes æœåŠ¡å¸æˆ·å¯ç”¨ OpenID èº«ä»½éªŒè¯**ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨ AWS ä¸­æ‰®æ¼”è§’è‰²ã€‚äº†è§£[**æ­¤é¡µé¢ä¸­çš„å·¥ä½œæ–¹å¼**](../../kubernetes-security/kubernetes-pivoting-to-clouds.md#workflow-of-iam-role-for-service-accounts-1)ã€‚

### ä» JWT ä»¤ç‰Œè·å– Api æœåŠ¡å™¨ç«¯ç‚¹

è§£ç  JWT ä»¤ç‰Œï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—é›†ç¾¤ ID å’ŒåŒºåŸŸã€‚
![image](https://github.com/HackTricks-wiki/hacktricks-cloud/assets/87022719/0e47204a-eea5-4fcb-b702-36dc184a39e9)
çŸ¥é“ EKS URL çš„æ ‡å‡†æ ¼å¼æ˜¯
```bash
https://<cluster-id>.<two-random-chars><number>.<region>.eks.amazonaws.com
```
æœªæ‰¾åˆ°ä»»ä½•è§£é‡Šâ€œä¸¤ä¸ªå­—ç¬¦â€å’Œâ€œæ•°å­—â€æ ‡å‡†çš„æ–‡æ¡£ã€‚ä½†é€šè¿‡è‡ªå·±çš„æµ‹è¯•ï¼Œæˆ‘å‘ç°ä»¥ä¸‹å¸¸è§ç»„åˆï¼š
- gr7
- yl4

æ— è®ºå¦‚ä½•ï¼Œç”±äºåªæœ‰3ä¸ªå­—ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è„šæœ¬æ¥ç”Ÿæˆåˆ—è¡¨ã€‚
```python
from itertools import product
from string import ascii_lowercase

letter_combinations = product('abcdefghijklmnopqrstuvwxyz', repeat = 2)
number_combinations = product('0123456789', repeat = 1)

result = [
f'{''.join(comb[0])}{comb[1][0]}'
for comb in product(letter_combinations, number_combinations)
]

with open('out.txt', 'w') as f:
f.write('\n'.join(result))
```
ç„¶åä½¿ç”¨ wfuzz
```bash
wfuzz -Z -z file,out.txt --hw 0 https://<cluster-id>.FUZZ.<region>.eks.amazonaws.com
```
{% hint style="warning" %}
è®°å¾—æ›¿æ¢ <cluster-id> å’Œ <region>ã€‚
{% endhint %}

### ç»•è¿‡ CloudTrail

å¦‚æœæ”»å‡»è€…è·å¾—äº†æ‹¥æœ‰å¯¹ EKS çš„æƒé™çš„ AWS å‡­æ®ã€‚å¦‚æœæ”»å‡»è€…é…ç½®è‡ªå·±çš„ `kubeconfig`ï¼ˆè€Œä¸è°ƒç”¨ `update-kubeconfig`ï¼‰å¦‚å‰æ‰€è¿°ï¼Œ`get-token` ä¸ä¼šåœ¨ CloudTrail ä¸­ç”Ÿæˆæ—¥å¿—ï¼Œå› ä¸ºå®ƒä¸ä¸ AWS API äº¤äº’ï¼ˆå®ƒåªæ˜¯åœ¨æœ¬åœ°åˆ›å»ºä»¤ç‰Œï¼‰ã€‚

å› æ­¤ï¼Œå½“æ”»å‡»è€…ä¸ EKS é›†ç¾¤é€šä¿¡æ—¶ï¼ŒCloudTrail ä¸ä¼šè®°å½•ä»»ä½•ä¸è¢«ç›—ç”¨æˆ·è®¿é—®æœ‰å…³çš„å†…å®¹ã€‚

è¯·æ³¨æ„ï¼ŒEKS é›†ç¾¤å¯èƒ½å·²å¯ç”¨æ—¥å¿—è®°å½•ï¼Œå°†è®°å½•æ­¤è®¿é—®ï¼ˆå°½ç®¡é»˜è®¤æƒ…å†µä¸‹å·²ç¦ç”¨ï¼‰ã€‚

### EKS å‹’ç´¢ï¼Ÿ

é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ›å»ºé›†ç¾¤çš„ç”¨æˆ·æˆ–è§’è‰²å§‹ç»ˆå…·æœ‰å¯¹é›†ç¾¤çš„ç®¡ç†å‘˜ç‰¹æƒã€‚è¿™æ˜¯ AWS å¯¹ Kubernetes é›†ç¾¤å”¯ä¸€çš„â€œå®‰å…¨â€è®¿é—®ã€‚

å› æ­¤ï¼Œå¦‚æœæ”»å‡»è€…ä½¿ç”¨ fargate çªƒå–äº†é›†ç¾¤å¹¶åˆ é™¤äº†æ‰€æœ‰å…¶ä»–ç®¡ç†å‘˜å¹¶åˆ é™¤äº†åˆ›å»ºé›†ç¾¤çš„ AWS ç”¨æˆ·/è§’è‰²ï¼Œåˆ™æ”»å‡»è€…å¯èƒ½å·²ç»å‹’ç´¢äº†é›†ç¾¤ã€‚

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œå¦‚æœé›†ç¾¤ä½¿ç”¨ EC2 VMï¼Œå¯èƒ½å¯ä»¥ä»èŠ‚ç‚¹è·å–ç®¡ç†å‘˜ç‰¹æƒå¹¶æ¢å¤é›†ç¾¤ã€‚

å®é™…ä¸Šï¼Œå¦‚æœé›†ç¾¤ä½¿ç”¨ Fargateï¼Œæ‚¨å¯ä»¥ä» EC2 èŠ‚ç‚¹è·å–ç®¡ç†å‘˜ç‰¹æƒæˆ–å°†æ‰€æœ‰å†…å®¹ç§»åŠ¨åˆ° EC2 åˆ°é›†ç¾¤ä¸­ï¼Œå¹¶é€šè¿‡è®¿é—®èŠ‚ç‚¹ä¸­çš„ä»¤ç‰Œæ¥æ¢å¤å®ƒã€‚
{% endhint %}

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹  AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹  GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
