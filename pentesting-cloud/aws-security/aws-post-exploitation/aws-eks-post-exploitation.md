# AWS - EKS åæ¸—é€

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## EKS

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹

{% content-ref url="../aws-services/aws-eks-enum.md" %}
[aws-eks-enum.md](../aws-services/aws-eks-enum.md)
{% endcontent-ref %}

### ä» AWS æ§åˆ¶å°æšä¸¾é›†ç¾¤

å¦‚æœæ‚¨æ‹¥æœ‰æƒé™ **`eks:AccessKubernetesApi`**ï¼Œæ‚¨å¯ä»¥é€šè¿‡ AWS EKS æ§åˆ¶å° **æŸ¥çœ‹ Kubernetes å¯¹è±¡** ([äº†è§£æ›´å¤š](https://docs.aws.amazon.com/eks/latest/userguide/view-workloads.html))ã€‚

### è¿æ¥åˆ° AWS Kubernetes é›†ç¾¤

* ç®€å•æ–¹æ³•ï¼š
```bash
# Generate kubeconfig
aws eks update-kubeconfig --name aws-eks-dev
```
* ä¸æ˜¯é‚£ä¹ˆç®€å•çš„æ–¹æ³•ï¼š

å¦‚æœä½ å¯ä»¥ **è·å–ä¸€ä¸ªä»¤ç‰Œ**ï¼Œä½¿ç”¨ **`aws eks get-token --name <cluster_name>`**ï¼Œä½†ä½ æ²¡æœ‰æƒé™è·å–é›†ç¾¤ä¿¡æ¯ï¼ˆdescribeClusterï¼‰ï¼Œä½ å¯ä»¥ **å‡†å¤‡ä½ è‡ªå·±çš„ `~/.kube/config`**ã€‚ç„¶è€Œï¼Œæ‹¥æœ‰ä»¤ç‰Œåï¼Œä½ ä»ç„¶éœ€è¦ **è¿æ¥çš„ URL ç«¯ç‚¹**ï¼ˆå¦‚æœä½ è®¾æ³•ä»ä¸€ä¸ª pod è·å–äº† JWT ä»¤ç‰Œï¼Œè¯·é˜…è¯» [è¿™é‡Œ](aws-eks-post-exploitation.md#get-api-server-endpoint-from-a-jwt-token)ï¼‰å’Œ **é›†ç¾¤çš„åç§°**ã€‚

åœ¨æˆ‘çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘æ²¡æœ‰åœ¨ CloudWatch æ—¥å¿—ä¸­æ‰¾åˆ°ä¿¡æ¯ï¼Œä½†æˆ‘ **åœ¨ LaunchTemplates çš„ userData ä¸­æ‰¾åˆ°äº†å®ƒ**ï¼Œå¹¶ä¸”åœ¨ **EC2 æœºå™¨çš„ userData ä¸­ä¹Ÿæ‰¾åˆ°äº†**ã€‚ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨ **userData** ä¸­çœ‹åˆ°è¿™äº›ä¿¡æ¯ï¼Œä¾‹å¦‚åœ¨ä¸‹ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼ˆé›†ç¾¤åç§°æ˜¯ cluster-nameï¼‰ï¼š

{% code overflow="wrap" %}
```bash
API_SERVER_URL=https://6253F6CA47F81264D8E16FAA7A103A0D.gr7.us-east-1.eks.amazonaws.com

/etc/eks/bootstrap.sh cluster-name --kubelet-extra-args '--node-labels=eks.amazonaws.com/sourceLaunchTemplateVersion=1,alpha.eksctl.io/cluster-name=cluster-name,alpha.eksctl.io/nodegroup-name=prd-ondemand-us-west-2b,role=worker,eks.amazonaws.com/nodegroup-image=ami-002539dd2c532d0a5,eks.amazonaws.com/capacityType=ON_DEMAND,eks.amazonaws.com/nodegroup=prd-ondemand-us-west-2b,type=ondemand,eks.amazonaws.com/sourceLaunchTemplateId=lt-0f0f0ba62bef782e5 --max-pods=58' --b64-cluster-ca $B64_CLUSTER_CA --apiserver-endpoint $API_SERVER_URL --dns-cluster-ip $K8S_CLUSTER_DNS_IP --use-max-pods false
```
{% endcode %}

<details>

<summary>kube é…ç½®</summary>
```yaml
describe-cache-parametersapiVersion: v1
clusters:
- cluster:
certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1USXlPREUyTWpjek1Wb1hEVE15TVRJeU5URTJNamN6TVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDlXCk9OS0ZqeXZoRUxDZGhMNnFwWkMwa1d0UURSRVF1UzVpRDcwK2pjbjFKWXZ4a3FsV1ZpbmtwOUt5N2x2ME5mUW8KYkNqREFLQWZmMEtlNlFUWVVvOC9jQXJ4K0RzWVlKV3dzcEZGbWlsY1lFWFZHMG5RV1VoMVQ3VWhOanc0MllMRQpkcVpzTGg4OTlzTXRLT1JtVE5sN1V6a05pTlUzSytueTZSRysvVzZmbFNYYnRiT2kwcXJSeFVpcDhMdWl4WGRVCnk4QTg3VjRjbllsMXo2MUt3NllIV3hhSm11eWI5enRtbCtBRHQ5RVhOUXhDMExrdWcxSDBqdTl1MDlkU09YYlkKMHJxY2lINjYvSTh0MjlPZ3JwNkY0dit5eUNJUjZFQURRaktHTFVEWUlVSkZ4WXA0Y1pGcVA1aVJteGJ5Nkh3UwpDSE52TWNJZFZRRUNQMlg5R2c4Q0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZQVXFsekhWZmlDd0xqalhPRmJJUUc3L0VxZ1hNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBS1o4c0l4aXpsemx0aXRPcGcySgpYV0VUSThoeWxYNWx6cW1mV0dpZkdFVVduUDU3UEVtWW55eWJHbnZ5RlVDbnczTldMRTNrbEVMQVE4d0tLSG8rCnBZdXAzQlNYamdiWFovdWVJc2RhWlNucmVqNU1USlJ3SVFod250ZUtpU0J4MWFRVU01ZGdZc2c4SlpJY3I2WC8KRG5POGlHOGxmMXVxend1dUdHSHM2R1lNR0Mvd1V0czVvcm1GS291SmtSUWhBZElMVkNuaStYNCtmcHUzT21UNwprS3VmR0tyRVlKT09VL1c2YTB3OTRycU9iSS9Mem1GSWxJQnVNcXZWVDBwOGtlcTc1eklpdGNzaUJmYVVidng3Ci9sMGhvS1RqM0IrOGlwbktIWW4wNGZ1R2F2YVJRbEhWcldDVlZ4c3ZyYWpxOUdJNWJUUlJ6TnpTbzFlcTVZNisKRzVBPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
server: https://6253F6CA47F81264D8E16FAA7A103A0D.gr7.us-west-2.eks.amazonaws.com
name: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
contexts:
- context:
cluster: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
user: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
name: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
current-context: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
kind: Config
preferences: {}
users:
- name: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
user:
exec:
apiVersion: client.authentication.k8s.io/v1beta1
args:
- --region
- us-west-2
- --profile
- <profile>
- eks
- get-token
- --cluster-name
- <cluster-name>
command: aws
env: null
interactiveMode: IfAvailable
provideClusterInfo: false
```
</details>

### ä» AWS åˆ° Kubernetes

**EKS é›†ç¾¤**çš„**åˆ›å»ºè€…****æ€»æ˜¯**èƒ½å¤Ÿè¿›å…¥**`system:masters`**ç»„çš„ Kubernetes é›†ç¾¤éƒ¨åˆ†ï¼ˆk8s ç®¡ç†å‘˜ï¼‰ã€‚åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œ**æ²¡æœ‰ç›´æ¥çš„æ–¹æ³•**æ¥æŸ¥æ‰¾**è°åˆ›å»ºäº†**è¯¥é›†ç¾¤ï¼ˆæ‚¨å¯ä»¥æ£€æŸ¥ CloudTrailï¼‰ã€‚å¹¶ä¸”**æ— æ³•****ç§»é™¤**è¯¥**æƒé™**ã€‚

æˆäºˆ**æ›´å¤š AWS IAM ç”¨æˆ·æˆ–è§’è‰²å¯¹ K8s çš„è®¿é—®æƒé™**çš„æ–¹æ³•æ˜¯ä½¿ç”¨**configmap** **`aws-auth`**ã€‚

{% hint style="warning" %}
å› æ­¤ï¼Œä»»ä½•å¯¹ config map **`aws-auth`**å…·æœ‰**å†™è®¿é—®æƒé™**çš„äººéƒ½å°†èƒ½å¤Ÿ**å±å®³æ•´ä¸ªé›†ç¾¤**ã€‚
{% endhint %}

æœ‰å…³å¦‚ä½•åœ¨**åŒä¸€æˆ–ä¸åŒè´¦æˆ·**ä¸­**æˆäºˆ IAM è§’è‰²å’Œç”¨æˆ·é¢å¤–æƒé™**ä»¥åŠå¦‚ä½•**æ»¥ç”¨**æ­¤æƒé™çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[**privesc æ£€æŸ¥æ­¤é¡µé¢**](../../kubernetes-security/abusing-roles-clusterroles-in-kubernetes/#aws-eks-aws-auth-configmaps)ã€‚

è¿˜å¯ä»¥æŸ¥çœ‹[**è¿™ç¯‡ç²¾å½©çš„**](https://blog.lightspin.io/exploiting-eks-authentication-vulnerability-in-aws-iam-authenticator) **æ–‡ç« ä»¥äº†è§£ IAM -> Kubernetes çš„èº«ä»½éªŒè¯æ˜¯å¦‚ä½•å·¥ä½œçš„**ã€‚

### ä» Kubernetes åˆ° AWS

å¯ä»¥å…è®¸**Kubernetes æœåŠ¡è´¦æˆ·çš„ OpenID èº«ä»½éªŒè¯**ä»¥å…è®¸å®ƒä»¬åœ¨ AWS ä¸­æ‰¿æ‹…è§’è‰²ã€‚äº†è§£[**è¿™åœ¨æ­¤é¡µé¢ä¸­çš„å·¥ä½œåŸç†**](../../kubernetes-security/kubernetes-pivoting-to-clouds.md#workflow-of-iam-role-for-service-accounts-1)ã€‚

### ä» JWT ä»¤ç‰Œè·å– Api æœåŠ¡å™¨ç«¯ç‚¹

è§£ç  JWT ä»¤ç‰Œï¼Œæˆ‘ä»¬è·å¾—é›†ç¾¤ ID å’ŒåŒºåŸŸã€‚![image](https://github.com/HackTricks-wiki/hacktricks-cloud/assets/87022719/0e47204a-eea5-4fcb-b702-36dc184a39e9) çŸ¥é“ EKS URL çš„æ ‡å‡†æ ¼å¼æ˜¯
```bash
https://<cluster-id>.<two-random-chars><number>.<region>.eks.amazonaws.com
```
æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ–‡æ¡£æ¥è§£é‡Šâ€œä¸¤ä¸ªå­—ç¬¦â€å’Œâ€œæ•°å­—â€çš„æ ‡å‡†ã€‚ä½†æˆ‘è‡ªå·±è¿›è¡Œäº†ä¸€äº›æµ‹è¯•ï¼Œå‘ç°è¿™äº›æ˜¯é‡å¤å‡ºç°çš„ï¼š

* gr7
* yl4

æ— è®ºå¦‚ä½•ï¼Œè¿™åªæ˜¯3ä¸ªå­—ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å®ƒä»¬è¿›è¡Œæš´åŠ›ç ´è§£ã€‚ä½¿ç”¨ä¸‹é¢çš„è„šæœ¬ç”Ÿæˆåˆ—è¡¨ã€‚
```python
from itertools import product
from string import ascii_lowercase

letter_combinations = product('abcdefghijklmnopqrstuvwxyz', repeat = 2)
number_combinations = product('0123456789', repeat = 1)

result = [
f'{''.join(comb[0])}{comb[1][0]}'
for comb in product(letter_combinations, number_combinations)
]

with open('out.txt', 'w') as f:
f.write('\n'.join(result))
```
ç„¶åä½¿ç”¨ wfuzz
```bash
wfuzz -Z -z file,out.txt --hw 0 https://<cluster-id>.FUZZ.<region>.eks.amazonaws.com
```
{% hint style="warning" %}
è®°å¾—æ›¿æ¢ & .
{% endhint %}

### ç»•è¿‡ CloudTrail

å¦‚æœæ”»å‡»è€…è·å¾—äº†å…·æœ‰ **EKS æƒé™** çš„ AWS å‡­è¯ã€‚å¦‚æœæ”»å‡»è€…é…ç½®è‡ªå·±çš„ **`kubeconfig`**ï¼ˆå¦‚å‰æ‰€è¿°ï¼Œä¸è°ƒç”¨ **`update-kubeconfig`**ï¼‰ï¼Œåˆ™ **`get-token`** ä¸ä¼šåœ¨ Cloudtrail ä¸­ç”Ÿæˆæ—¥å¿—ï¼Œå› ä¸ºå®ƒä¸ä¸ AWS API äº¤äº’ï¼ˆå®ƒåªæ˜¯æœ¬åœ°åˆ›å»ºä»¤ç‰Œï¼‰ã€‚

å› æ­¤ï¼Œå½“æ”»å‡»è€…ä¸ EKS é›†ç¾¤äº¤äº’æ—¶ï¼Œ**cloudtrail ä¸ä¼šè®°å½•ä¸è¢«ç›—ç”¨æˆ·åŠå…¶è®¿é—®ç›¸å…³çš„ä»»ä½•å†…å®¹**ã€‚

è¯·æ³¨æ„ï¼Œ**EKS é›†ç¾¤å¯èƒ½å¯ç”¨äº†æ—¥å¿—**ï¼Œå°†è®°å½•æ­¤è®¿é—®ï¼ˆå°½ç®¡é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä»¬æ˜¯ç¦ç”¨çš„ï¼‰ã€‚

### EKS å‹’ç´¢ï¼Ÿ

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**åˆ›å»º**é›†ç¾¤çš„ **ç”¨æˆ·æˆ–è§’è‰²** **å§‹ç»ˆä¼šæ‹¥æœ‰é›†ç¾¤çš„ç®¡ç†å‘˜æƒé™**ã€‚è¿™æ˜¯ AWS å¯¹ Kubernetes é›†ç¾¤çš„å”¯ä¸€â€œå®‰å…¨â€è®¿é—®ã€‚

å› æ­¤ï¼Œå¦‚æœ **æ”»å‡»è€…é€šè¿‡ fargate ç ´åäº†é›†ç¾¤**ï¼Œå¹¶ **ç§»é™¤äº†æ‰€æœ‰å…¶ä»–ç®¡ç†å‘˜**ï¼Œå¹¶ **åˆ é™¤äº†åˆ›å»º**é›†ç¾¤çš„ AWS ç”¨æˆ·/è§’è‰²ï¼Œ~~æ”»å‡»è€…å¯èƒ½å·²ç» **å‹’ç´¢äº†é›†ç¾¤**~~**ã€‚

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œå¦‚æœé›†ç¾¤ä½¿ç”¨ **EC2 è™šæ‹Ÿæœº**ï¼Œåˆ™å¯èƒ½ä» **èŠ‚ç‚¹** è·å–ç®¡ç†å‘˜æƒé™å¹¶æ¢å¤é›†ç¾¤ã€‚

å®é™…ä¸Šï¼Œå¦‚æœé›†ç¾¤ä½¿ç”¨ Fargateï¼Œæ‚¨å¯ä»¥å°† EC2 èŠ‚ç‚¹æˆ–å°†æ‰€æœ‰å†…å®¹ç§»åŠ¨åˆ° EC2 é›†ç¾¤å¹¶é€šè¿‡è®¿é—®èŠ‚ç‚¹ä¸­çš„ä»¤ç‰Œæ¥æ¢å¤å®ƒã€‚
{% endhint %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
