# AWS Pentesting

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

**åœ¨å¼€å§‹ pentesting** ä¸€ä¸ª **AWS** ç¯å¢ƒä¹‹å‰ï¼Œä½ éœ€è¦äº†è§£ä¸€äº›å…³äº AWS å¦‚ä½•å·¥ä½œçš„**åŸºæœ¬çŸ¥è¯†**ï¼Œä»¥å¸®åŠ©ä½ ç†è§£éœ€è¦åšä»€ä¹ˆï¼Œå¦‚ä½•å‘ç°é”™è¯¯é…ç½®ä»¥åŠå¦‚ä½•åˆ©ç”¨å®ƒä»¬ã€‚

ç»„ç»‡å±‚æ¬¡ç»“æ„ã€IAM å’Œå…¶ä»–åŸºæœ¬æ¦‚å¿µåœ¨ä»¥ä¸‹å†…å®¹ä¸­è§£é‡Šï¼š

{% content-ref url="aws-basic-information/" %}
[aws-basic-information](aws-basic-information/)
{% endcontent-ref %}

## å­¦ä¹ å®éªŒå®¤

* [https://github.com/RhinoSecurityLabs/cloudgoat](https://github.com/RhinoSecurityLabs/cloudgoat)
* [https://github.com/BishopFox/iam-vulnerable](https://github.com/BishopFox/iam-vulnerable)
* [https://github.com/nccgroup/sadcloud](https://github.com/nccgroup/sadcloud)
* [https://github.com/bridgecrewio/terragoat](https://github.com/bridgecrewio/terragoat)
* [https://github.com/ine-labs/AWSGoat](https://github.com/ine-labs/AWSGoat)
* [http://flaws.cloud/](http://flaws.cloud/)
* [http://flaws2.cloud/](http://flaws2.cloud/)

æ¨¡æ‹Ÿæ”»å‡»çš„å·¥å…·ï¼š

* [https://github.com/Datadog/stratus-red-team/](https://github.com/Datadog/stratus-red-team/)
* [https://github.com/sbasu7241/AWS-Threat-Simulation-and-Detection/tree/main](https://github.com/sbasu7241/AWS-Threat-Simulation-and-Detection/tree/main)

## AWS Pentester/Red Team æ–¹æ³•è®º

ä¸ºäº†å®¡è®¡ä¸€ä¸ª AWS ç¯å¢ƒï¼Œäº†è§£ä»¥ä¸‹å†…å®¹éå¸¸é‡è¦ï¼š**ä½¿ç”¨äº†å“ªäº›æœåŠ¡**ï¼Œ**æš´éœ²äº†ä»€ä¹ˆ**ï¼Œè°å¯¹ä»€ä¹ˆæœ‰**è®¿é—®æƒé™**ï¼Œä»¥åŠå†…éƒ¨ AWS æœåŠ¡å’Œ**å¤–éƒ¨æœåŠ¡**å¦‚ä½•è¿æ¥ã€‚

ä» Red Team çš„è§’åº¦æ¥çœ‹ï¼Œ**æ”»ç ´ AWS ç¯å¢ƒçš„ç¬¬ä¸€æ­¥**æ˜¯è®¾æ³•è·å–ä¸€äº›**å‡­è¯**ã€‚è¿™é‡Œæœ‰ä¸€äº›è·å–å‡­è¯çš„æƒ³æ³•ï¼š

* githubï¼ˆæˆ–ç±»ä¼¼å¹³å°ï¼‰ä¸Šçš„**æ³„æ¼** - OSINT
* **ç¤¾ä¼šå·¥ç¨‹**
* **å¯†ç **é‡ç”¨ï¼ˆå¯†ç æ³„æ¼ï¼‰
* AWS æ‰˜ç®¡åº”ç”¨ç¨‹åºä¸­çš„æ¼æ´
* å…·æœ‰è®¿é—®å…ƒæ•°æ®ç«¯ç‚¹çš„ [**Server Side Request Forgery**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)
* **æœ¬åœ°æ–‡ä»¶è¯»å–**
* `/home/USERNAME/.aws/credentials`
* `C:\Users\USERNAME\.aws\credentials`
* ç¬¬ä¸‰æ–¹**æ³„æ¼**
* **å†…éƒ¨**å‘˜å·¥
* [**Cognito** ](aws-services/aws-cognito-enum/#cognito)å‡­è¯

æˆ–è€…é€šè¿‡**æ”»ç ´æš´éœ²çš„æœªè®¤è¯æœåŠ¡**ï¼š

{% content-ref url="aws-unauthenticated-enum-access/" %}
[aws-unauthenticated-enum-access](aws-unauthenticated-enum-access/)
{% endcontent-ref %}

æˆ–è€…å¦‚æœä½ åœ¨è¿›è¡Œ**å®¡æŸ¥**ï¼Œä½ å¯ä»¥ç›´æ¥**è¯·æ±‚è¿™äº›è§’è‰²çš„å‡­è¯**ï¼š

{% content-ref url="aws-permissions-for-a-pentest.md" %}
[aws-permissions-for-a-pentest.md](aws-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
åœ¨ä½ è®¾æ³•è·å–å‡­è¯åï¼Œä½ éœ€è¦çŸ¥é“**è¿™äº›å‡­è¯å±äºè°**ï¼Œä»¥åŠ**ä»–ä»¬æœ‰æƒè®¿é—®ä»€ä¹ˆ**ï¼Œæ‰€ä»¥ä½ éœ€è¦è¿›è¡Œä¸€äº›åŸºæœ¬çš„æšä¸¾ï¼š
{% endhint %}

## åŸºæœ¬æšä¸¾

### SSRF

å¦‚æœä½ åœ¨ AWS å†…éƒ¨çš„æœºå™¨ä¸Šå‘ç°äº† SSRFï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢ä»¥è·å–æŠ€å·§ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Whoami

ä½ éœ€è¦çŸ¥é“çš„ç¬¬ä¸€ä»¶äº‹æ˜¯ä½ æ˜¯è°ï¼ˆåœ¨å“ªä¸ªè´¦æˆ·ä¸­ä»¥åŠå…³äº AWS ç¯å¢ƒçš„å…¶ä»–ä¿¡æ¯ï¼‰ï¼š
```bash
# Easiest way, but might be monitored?
aws sts get-caller-identity
aws iam get-user # This will get your own user

# If you have a Key ID
aws sts get-access-key-info --access-key-id=ASIA1234567890123456

# Get inside error message
aws sns publish --topic-arn arn:aws:sns:us-east-1:*account id*:aaa --message aaa

# From metadata
TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/dynamic/instance-identity/document
```
{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œå…¬å¸å¯èƒ½ä¼šä½¿ç”¨**canary tokens**æ¥è¯†åˆ«**ä»¤ç‰Œè¢«ç›—ç”¨å’Œä½¿ç”¨**çš„æƒ…å†µã€‚å»ºè®®åœ¨ä½¿ç”¨ä»¤ç‰Œä¹‹å‰æ£€æŸ¥å®ƒæ˜¯å¦æ˜¯canary tokenã€‚\
æ›´å¤šä¿¡æ¯è¯·[**æŸ¥çœ‹æ­¤é¡µé¢**](aws-services/aws-security-and-detection-services/aws-cloudtrail-enum.md#honeytokens-bypass)ã€‚
{% endhint %}

### Org Enumeration

{% content-ref url="aws-services/aws-organizations-enum.md" %}
[aws-organizations-enum.md](aws-services/aws-organizations-enum.md)
{% endcontent-ref %}

### IAM Enumeration

å¦‚æœä½ æœ‰è¶³å¤Ÿçš„æƒé™ï¼Œ**æ£€æŸ¥AWSè´¦æˆ·å†…æ¯ä¸ªå®ä½“çš„æƒé™**å°†å¸®åŠ©ä½ äº†è§£ä½ å’Œå…¶ä»–èº«ä»½å¯ä»¥åšä»€ä¹ˆä»¥åŠå¦‚ä½•**æå‡æƒé™**ã€‚

å¦‚æœä½ æ²¡æœ‰è¶³å¤Ÿçš„æƒé™æ¥æšä¸¾IAMï¼Œä½ å¯ä»¥**æš´åŠ›ç ´è§£å®ƒä»¬**æ¥æ‰¾å‡ºå®ƒä»¬ã€‚\
æŸ¥çœ‹**å¦‚ä½•è¿›è¡Œæšä¸¾å’Œæš´åŠ›ç ´è§£**ï¼š

{% content-ref url="aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](aws-services/aws-iam-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
ç°åœ¨ä½ **æœ‰äº†ä¸€äº›å…³äºä½ å‡­è¯çš„ä¿¡æ¯**ï¼ˆå¦‚æœä½ æ˜¯çº¢é˜Ÿï¼Œå¸Œæœ›ä½ **æ²¡æœ‰è¢«æ£€æµ‹åˆ°**ï¼‰ã€‚æ˜¯æ—¶å€™å¼„æ¸…æ¥šç¯å¢ƒä¸­ä½¿ç”¨äº†å“ªäº›æœåŠ¡äº†ã€‚\
åœ¨ä»¥ä¸‹éƒ¨åˆ†ï¼Œä½ å¯ä»¥æŸ¥çœ‹ä¸€äº›**æšä¸¾å¸¸è§æœåŠ¡**çš„æ–¹æ³•ã€‚
{% endhint %}

## Services Enumeration, Post-Exploitation & Persistence

AWSæœ‰å¤§é‡çš„æœåŠ¡ï¼Œåœ¨ä»¥ä¸‹é¡µé¢ä¸­ä½ ä¼šæ‰¾åˆ°**åŸºæœ¬ä¿¡æ¯ã€æšä¸¾**é€ŸæŸ¥è¡¨ã€å¦‚ä½•**é¿å…æ£€æµ‹**ã€è·å¾—**æŒä¹…æ€§**ä»¥åŠå…¶ä»–ä¸€äº›**åæœŸåˆ©ç”¨**æŠ€å·§ï¼š

{% content-ref url="aws-services/" %}
[aws-services](aws-services/)
{% endcontent-ref %}

è¯·æ³¨æ„ï¼Œä½ **ä¸éœ€è¦**æ‰‹åŠ¨å®Œæˆæ‰€æœ‰å·¥ä½œï¼Œä¸‹é¢çš„å¸–å­ä¸­ä½ å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå…³äº[**è‡ªåŠ¨åŒ–å·¥å…·**](./#automated-tools)çš„**éƒ¨åˆ†**ã€‚

æ­¤å¤–ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µä½ å¯èƒ½ä¼šå‘ç°**æ›´å¤šæš´éœ²ç»™æœªè®¤è¯ç”¨æˆ·çš„æœåŠ¡**ï¼Œä½ å¯èƒ½èƒ½å¤Ÿåˆ©ç”¨å®ƒä»¬ï¼š

{% content-ref url="aws-unauthenticated-enum-access/" %}
[aws-unauthenticated-enum-access](aws-unauthenticated-enum-access/)
{% endcontent-ref %}

## Privilege Escalation

å¦‚æœä½ èƒ½**è‡³å°‘æ£€æŸ¥ä½ è‡ªå·±åœ¨ä¸åŒèµ„æºä¸Šçš„æƒé™**ï¼Œä½ å¯ä»¥**æ£€æŸ¥æ˜¯å¦èƒ½å¤Ÿè·å¾—æ›´å¤šæƒé™**ã€‚ä½ åº”è¯¥è‡³å°‘å…³æ³¨ä»¥ä¸‹æƒé™ï¼š

{% content-ref url="aws-privilege-escalation/" %}
[aws-privilege-escalation](aws-privilege-escalation/)
{% endcontent-ref %}

## Publicly Exposed Services

åœ¨æšä¸¾AWSæœåŠ¡æ—¶ï¼Œä½ å¯èƒ½ä¼šå‘ç°ä¸€äº›**å°†å…ƒç´ æš´éœ²ç»™äº’è”ç½‘**çš„æœåŠ¡ï¼ˆVM/Containersç«¯å£ã€æ•°æ®åº“æˆ–é˜Ÿåˆ—æœåŠ¡ã€å¿«ç…§æˆ–buckets...ï¼‰ã€‚\
ä½œä¸ºæ¸—é€æµ‹è¯•å‘˜/çº¢é˜Ÿæˆå‘˜ï¼Œä½ åº”è¯¥å§‹ç»ˆæ£€æŸ¥æ˜¯å¦èƒ½åœ¨è¿™äº›æœåŠ¡ä¸­æ‰¾åˆ°**æ•æ„Ÿä¿¡æ¯/æ¼æ´**ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½ä¸ºä½ æä¾›**è¿›ä¸€æ­¥è®¿é—®AWSè´¦æˆ·**çš„é€”å¾„ã€‚

åœ¨æœ¬ä¹¦ä¸­ï¼Œä½ åº”è¯¥æ‰¾åˆ°**å…³äºå¦‚ä½•å‘ç°æš´éœ²çš„AWSæœåŠ¡ä»¥åŠå¦‚ä½•æ£€æŸ¥å®ƒä»¬**çš„ä¿¡æ¯ã€‚å…³äºå¦‚ä½•åœ¨æš´éœ²çš„ç½‘ç»œæœåŠ¡ä¸­æ‰¾åˆ°**æ¼æ´**ï¼Œæˆ‘å»ºè®®ä½ **æœç´¢**ç‰¹å®šçš„**æœåŠ¡**ï¼š

{% embed url="https://book.hacktricks.xyz/" %}

## Compromising the Organization

### From the root/management account

å½“ç®¡ç†è´¦æˆ·åœ¨ç»„ç»‡ä¸­åˆ›å»ºæ–°è´¦æˆ·æ—¶ï¼Œä¼šåœ¨æ–°è´¦æˆ·ä¸­åˆ›å»ºä¸€ä¸ª**æ–°è§’è‰²**ï¼Œé»˜è®¤åä¸º**`OrganizationAccountAccessRole`**ï¼Œå¹¶èµ‹äºˆ**AdministratorAccess**ç­–ç•¥ï¼Œä½¿ç®¡ç†è´¦æˆ·å¯ä»¥è®¿é—®æ–°è´¦æˆ·ã€‚

<figure><img src="../../.gitbook/assets/image (171).png" alt=""><figcaption></figcaption></figure>

å› æ­¤ï¼Œä¸ºäº†ä»¥ç®¡ç†å‘˜èº«ä»½è®¿é—®å­è´¦æˆ·ï¼Œä½ éœ€è¦ï¼š

* **æ”»ç ´**ç®¡ç†è´¦æˆ·å¹¶æ‰¾åˆ°**å­è´¦æˆ·çš„ID**å’Œ**è§’è‰²çš„åç§°**ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸ºOrganizationAccountAccessRoleï¼‰ï¼Œå…è®¸ç®¡ç†è´¦æˆ·ä»¥ç®¡ç†å‘˜èº«ä»½è®¿é—®ã€‚
* è¦æ‰¾åˆ°å­è´¦æˆ·ï¼Œè¯·è½¬åˆ°awsæ§åˆ¶å°ä¸­çš„ç»„ç»‡éƒ¨åˆ†æˆ–è¿è¡Œ`aws organizations list-accounts`
* ä½ æ— æ³•ç›´æ¥æ‰¾åˆ°è§’è‰²çš„åç§°ï¼Œå› æ­¤æ£€æŸ¥æ‰€æœ‰è‡ªå®šä¹‰IAMç­–ç•¥å¹¶æœç´¢ä»»ä½•å…è®¸**`sts:AssumeRole`**è®¿é—®å…ˆå‰å‘ç°çš„å­è´¦æˆ·çš„ç­–ç•¥ã€‚
* **æ”»ç ´**ç®¡ç†è´¦æˆ·ä¸­å…·æœ‰**`sts:AssumeRole`**æƒé™çš„**ä¸»ä½“**ï¼Œä»¥è®¿é—®å­è´¦æˆ·ä¸­çš„è§’è‰²ï¼ˆå³ä½¿è´¦æˆ·å…è®¸ç®¡ç†è´¦æˆ·ä¸­çš„ä»»ä½•äººè¿›è¡Œå†’å……ï¼Œä½œä¸ºå¤–éƒ¨è´¦æˆ·ï¼Œä»ç„¶éœ€è¦ç‰¹å®šçš„`sts:AssumeRole`æƒé™ï¼‰ã€‚

## Automated Tools

### Recon

* [**aws-recon**](https://github.com/darkbitio/aws-recon): ä¸€ä¸ªç”¨Rubyç¼–å†™çš„å¤šçº¿ç¨‹AWSå®‰å…¨**åº“å­˜æ”¶é›†å·¥å…·**ã€‚
```bash
# Install
gem install aws_recon

# Recon and get json
AWS_PROFILE=<profile> aws_recon \
--services S3,EC2 \
--regions global,us-east-1,us-east-2 \
--verbose
```
* [**cloudlist**](https://github.com/projectdiscovery/cloudlist): Cloudlist æ˜¯ä¸€ä¸ª**å¤šäº‘å·¥å…·ï¼Œç”¨äºä»äº‘æä¾›å•†è·å–èµ„äº§**ï¼ˆä¸»æœºåã€IP åœ°å€ï¼‰ã€‚
* [**cloudmapper**](https://github.com/duo-labs/cloudmapper): CloudMapper å¸®åŠ©ä½ åˆ†æ Amazon Web Services (AWS) ç¯å¢ƒã€‚å®ƒç°åœ¨åŒ…å«æ›´å¤šåŠŸèƒ½ï¼ŒåŒ…æ‹¬å®‰å…¨é—®é¢˜å®¡è®¡ã€‚
```bash
# Installation steps in github
# Create a config.json file with the aws info, like:
{
"accounts": [
{
"default": true,
"id": "<account id>",
"name": "dev"
}
],
"cidrs":
{
"2.2.2.2/28": {"name": "NY Office"}
}
}

# Enumerate
python3 cloudmapper.py collect --profile dev
## Number of resources discovered
python3 cloudmapper.py stats --accounts dev

# Create HTML report
## In the report you will find all the info already
python3 cloudmapper.py report --accounts dev

# Identify potential issues
python3 cloudmapper.py audit --accounts dev --json > audit.json
python3 cloudmapper.py audit --accounts dev --markdow > audit.md
python3 cloudmapper.py iam_report --accounts dev

# Identify admins
## The permissions search for are in https://github.com/duo-labs/cloudmapper/blob/4df9fd7303e0337ff16a08f5e58f1d46047c4a87/shared/iam_audit.py#L163-L175
python3 cloudmapper.py find_admins --accounts dev

# Identify unused elements
python3 cloudmapper.py find_unused --accounts dev

# Identify publivly exposed resources
python3 cloudmapper.py public --accounts dev

python cloudmapper.py prepare #Prepare webserver
python cloudmapper.py webserver #Show webserver
```
* [**cartography**](https://github.com/lyft/cartography): Cartography æ˜¯ä¸€ä¸ª Python å·¥å…·ï¼Œå®ƒå°†åŸºç¡€è®¾æ–½èµ„äº§åŠå…¶ä¹‹é—´çš„å…³ç³»æ•´åˆåœ¨ä¸€ä¸ªç”± Neo4j æ•°æ®åº“é©±åŠ¨çš„ç›´è§‚å›¾å½¢è§†å›¾ä¸­ã€‚
```bash
# Install
pip install cartography
## At the time of this writting you need neo4j version 3.5.*

# Get AWS info
AWS_PROFILE=dev cartography --neo4j-uri bolt://127.0.0.1:7687 --neo4j-password-prompt  --neo4j-user neo4j
```
* [**starbase**](https://github.com/JupiterOne/starbase): Starbase æ”¶é›†æ¥è‡ªæœåŠ¡å’Œç³»ç»Ÿçš„èµ„äº§å’Œå…³ç³»ï¼ŒåŒ…æ‹¬äº‘åŸºç¡€è®¾æ–½ã€SaaS åº”ç”¨ç¨‹åºã€å®‰å…¨æ§åˆ¶ç­‰ï¼Œå¹¶å°†å…¶æ•´åˆåˆ°ç”± Neo4j æ•°æ®åº“æ”¯æŒçš„ç›´è§‚å›¾å½¢è§†å›¾ä¸­ã€‚
* [**aws-inventory**](https://github.com/nccgroup/aws-inventory): (ä½¿ç”¨ python2) è¿™æ˜¯ä¸€ä¸ªå°è¯•**å‘ç°è´¦æˆ·ä¸­æ‰€æœ‰** [**AWS èµ„æº**](https://docs.aws.amazon.com/general/latest/gr/glos-chap.html#resource)çš„å·¥å…·ã€‚
* [**aws\_public\_ips**](https://github.com/arkadiyt/aws\_public\_ips): è¿™æ˜¯ä¸€ä¸ª**è·å–ä¸ AWS è´¦æˆ·å…³è”çš„æ‰€æœ‰å…¬å…± IP åœ°å€**ï¼ˆåŒ…æ‹¬ IPv4/IPv6ï¼‰çš„å·¥å…·ã€‚

### Privesc & Exploiting

* [**SkyArk**](https://github.com/cyberark/SkyArk)**:** å‘ç°æ‰«æçš„ AWS ç¯å¢ƒä¸­æœ€æœ‰ç‰¹æƒçš„ç”¨æˆ·ï¼ŒåŒ…æ‹¬ AWS Shadow Adminsã€‚å®ƒä½¿ç”¨ powershellã€‚ä½ å¯ä»¥åœ¨ [https://github.com/cyberark/SkyArk/blob/master/AWStealth/AWStealth.ps1](https://github.com/cyberark/SkyArk/blob/master/AWStealth/AWStealth.ps1) ä¸­çš„ **`Check-PrivilegedPolicy`** å‡½æ•°ä¸­æ‰¾åˆ°**ç‰¹æƒç­–ç•¥çš„å®šä¹‰**ã€‚
* [**pacu**](https://github.com/RhinoSecurityLabs/pacu): Pacu æ˜¯ä¸€ä¸ªå¼€æºçš„ **AWS exploitation framework**ï¼Œè®¾è®¡ç”¨äºå¯¹äº‘ç¯å¢ƒè¿›è¡Œè¿›æ”»æ€§å®‰å…¨æµ‹è¯•ã€‚å®ƒå¯ä»¥**æšä¸¾**ã€å‘ç°**é…ç½®é”™è¯¯**å¹¶**åˆ©ç”¨**å®ƒä»¬ã€‚ä½ å¯ä»¥åœ¨ [https://github.com/RhinoSecurityLabs/pacu/blob/866376cd711666c775bbfcde0524c817f2c5b181/pacu/modules/iam\_\_privesc\_scan/main.py#L134](https://github.com/RhinoSecurityLabs/pacu/blob/866376cd711666c775bbfcde0524c817f2c5b181/pacu/modules/iam\_\_privesc\_scan/main.py#L134) ä¸­çš„ **`user_escalation_methods`** å­—å…¸ä¸­æ‰¾åˆ°**ç‰¹æƒæƒé™çš„å®šä¹‰**ã€‚
* æ³¨æ„ï¼Œpacu **åªæ£€æŸ¥ä½ è‡ªå·±çš„ privescs è·¯å¾„**ï¼ˆè€Œä¸æ˜¯æ•´ä¸ªè´¦æˆ·èŒƒå›´ï¼‰ã€‚
```bash
# Install
## Feel free to use venvs
pip3 install pacu

# Use pacu CLI
pacu
> import_keys <profile_name> # import 1 profile from .aws/credentials
> import_keys --all # import all profiles
> list # list modules
> exec iam__enum_permissions # Get permissions
> exec iam__privesc_scan # List privileged permissions
```
* [**PMapper**](https://github.com/nccgroup/PMapper): Principal Mapper (PMapper) æ˜¯ä¸€ä¸ªè„šæœ¬å’Œåº“ï¼Œç”¨äºè¯†åˆ« AWS è´¦æˆ·æˆ– AWS ç»„ç»‡ä¸­ AWS Identity and Access Management (IAM) é…ç½®çš„é£é™©ã€‚å®ƒå°†è´¦æˆ·ä¸­çš„ä¸åŒ IAM Users å’Œ Roles å»ºæ¨¡ä¸ºæœ‰å‘å›¾ï¼Œä»è€Œèƒ½å¤Ÿæ£€æŸ¥ **privilege escalation** ä»¥åŠæ”»å‡»è€…å¯èƒ½é‡‡å–çš„å…¶ä»–è·¯å¾„ä»¥è·å– AWS ä¸­èµ„æºæˆ–æ“ä½œçš„è®¿é—®æƒé™ã€‚ä½ å¯ä»¥åœ¨ [https://github.com/nccgroup/PMapper/tree/master/principalmapper/graphing](https://github.com/nccgroup/PMapper/tree/master/principalmapper/graphing) ä¸­ä»¥ `_edges.py` ç»“å°¾çš„æ–‡ä»¶åä¸­æ£€æŸ¥ **permissions used to find privesc** è·¯å¾„ã€‚
```bash
# Install
pip install principalmapper

# Get data
pmapper --profile dev graph create
pmapper --profile dev graph display # Show basic info
# Generate graph
pmapper --profile dev visualize # Generate svg graph file (can also be png, dot and graphml)
pmapper --profile dev visualize --only-privesc # Only privesc permissions

# Generate analysis
pmapper --profile dev analysis
## Run queries
pmapper --profile dev query 'who can do iam:CreateUser'
pmapper --profile dev query 'preset privesc *' # Get privescs with admins

# Get organization hierarchy data
pmapper --profile dev orgs create
pmapper --profile dev orgs display
```
* [**cloudsplaining**](https://github.com/salesforce/cloudsplaining): Cloudsplaining æ˜¯ä¸€ä¸ª AWS IAM å®‰å…¨è¯„ä¼°å·¥å…·ï¼Œå¯ä»¥è¯†åˆ«æœ€å°æƒé™è¿è§„å¹¶ç”Ÿæˆé£é™©ä¼˜å…ˆçš„ HTML æŠ¥å‘Šã€‚\
å®ƒå°†æ˜¾ç¤ºæ½œåœ¨çš„**æƒé™è¿‡é«˜**çš„å®¢æˆ·ã€å†…è”å’Œ aws **ç­–ç•¥**ä»¥åŠå“ªäº›**ä¸»ä½“æœ‰æƒè®¿é—®å®ƒä»¬**ã€‚ï¼ˆå®ƒä¸ä»…æ£€æŸ¥ privescï¼Œè¿˜æ£€æŸ¥å…¶ä»–æœ‰è¶£çš„æƒé™ï¼Œæ¨èä½¿ç”¨ï¼‰ã€‚
```bash
# Install
pip install cloudsplaining

# Download IAM policies to check
## Only the ones attached with the versions used
cloudsplaining download --profile dev

# Analyze the IAM policies
cloudsplaining scan --input-file /private/tmp/cloudsplaining/dev.json --output /tmp/files/
```
* [**cloudjack**](https://github.com/prevade/cloudjack): CloudJack è¯„ä¼° AWS è´¦æˆ·æ˜¯å¦å­˜åœ¨ç”±äº Route53 å’Œ CloudFront é…ç½®åˆ†ç¦»è€Œå¯¼è‡´çš„ **å­åŸŸååŠ«æŒæ¼æ´**ã€‚
* [**ccat**](https://github.com/RhinoSecurityLabs/ccat): åˆ—å‡º ECR ä»“åº“ -> æ‹‰å– ECR ä»“åº“ -> åé—¨å®ƒ -> æ¨é€å¸¦åé—¨çš„é•œåƒ
* [**Dufflebag**](https://github.com/bishopfox/dufflebag): Dufflebag æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œç”¨äº **æœç´¢** å…¬å…± Elastic Block Storage (**EBS) å¿«ç…§ä¸­çš„**ç§˜å¯†**ï¼Œè¿™äº›ç§˜å¯†å¯èƒ½æ˜¯æ„å¤–ç•™ä¸‹çš„ã€‚

### å®¡è®¡

* [**cloudsploit**](https://github.com/aquasecurity/cloudsploit)**:** CloudSploit by Aqua æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæ—¨åœ¨æ£€æµ‹ **äº‘åŸºç¡€è®¾æ–½è´¦æˆ·ä¸­çš„å®‰å…¨é£é™©**ï¼ŒåŒ…æ‹¬ï¼šAmazon Web Services (AWS)ã€Microsoft Azureã€Google Cloud Platform (GCP)ã€Oracle Cloud Infrastructure (OCI) å’Œ GitHubï¼ˆå®ƒä¸ä¼šæŸ¥æ‰¾ ShadowAdminsï¼‰ã€‚
```bash
./index.js --csv=file.csv --console=table --config ./config.js

# Compiance options: --compliance {hipaa,cis,cis1,cis2,pci}
## use "cis" for cis level 1 and 2
```
* [**Prowler**](https://github.com/prowler-cloud/prowler): Prowler æ˜¯ä¸€ä¸ªå¼€æºå®‰å…¨å·¥å…·ï¼Œç”¨äºæ‰§è¡Œ AWS å®‰å…¨æœ€ä½³å®è·µè¯„ä¼°ã€å®¡è®¡ã€äº‹ä»¶å“åº”ã€æŒç»­ç›‘æ§ã€åŠ å›ºå’Œå–è¯å‡†å¤‡ã€‚
```bash
# Install python3, jq and git
# Install
pip install prowler
prowler -v

# Run
prowler <provider>
prowler aws --profile custom-profile [-M csv json json-asff html]
```
* [**CloudFox**](https://github.com/BishopFox/cloudfox): CloudFox å¸®åŠ©æ‚¨åœ¨ä¸ç†Ÿæ‚‰çš„äº‘ç¯å¢ƒä¸­è·å¾—æ€åŠ¿æ„ŸçŸ¥ã€‚å®ƒæ˜¯ä¸€ä¸ªå¼€æºå‘½ä»¤è¡Œå·¥å…·ï¼Œæ—¨åœ¨å¸®åŠ©æ¸—é€æµ‹è¯•äººå‘˜å’Œå…¶ä»–è¿›æ”»æ€§å®‰å…¨ä¸“ä¸šäººå‘˜æ‰¾åˆ°äº‘åŸºç¡€è®¾æ–½ä¸­å¯åˆ©ç”¨çš„æ”»å‡»è·¯å¾„ã€‚
```bash
cloudfox aws --profile [profile-name] all-checks
```
* [**ScoutSuite**](https://github.com/nccgroup/ScoutSuite): Scout Suite æ˜¯ä¸€ä¸ªå¼€æºçš„å¤šäº‘å®‰å…¨å®¡è®¡å·¥å…·ï¼Œå¯ä»¥å¯¹äº‘ç¯å¢ƒè¿›è¡Œå®‰å…¨æ€åŠ¿è¯„ä¼°ã€‚
```bash
# Install
virtualenv -p python3 venv
source venv/bin/activate
pip install scoutsuite
scout --help

# Get info
scout aws -p dev
```
* [**cs-suite**](https://github.com/SecurityFTW/cs-suite): Cloud Security Suite (ä½¿ç”¨ python2.7ï¼Œçœ‹èµ·æ¥æ²¡æœ‰ç»´æŠ¤)
* [**Zeus**](https://github.com/DenizParlak/Zeus): Zeus æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œç”¨äº AWS EC2 / S3 / CloudTrail / CloudWatch / KMS æœ€ä½³åŠ å›ºå®è·µï¼ˆçœ‹èµ·æ¥æ²¡æœ‰ç»´æŠ¤ï¼‰ã€‚å®ƒåªæ£€æŸ¥ç³»ç»Ÿå†…é»˜è®¤é…ç½®çš„å‡­è¯ã€‚

### æŒç»­å®¡è®¡

* [**cloud-custodian**](https://github.com/cloud-custodian/cloud-custodian): Cloud Custodian æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†å…¬å…±äº‘è´¦æˆ·å’Œèµ„æºçš„è§„åˆ™å¼•æ“ã€‚å®ƒå…è®¸ç”¨æˆ·**å®šä¹‰ç­–ç•¥ä»¥å®ç°è‰¯å¥½çš„äº‘åŸºç¡€è®¾æ–½ç®¡ç†**ï¼Œæ—¢å®‰å…¨åˆæˆæœ¬ä¼˜åŒ–ã€‚å®ƒå°†è®¸å¤šç»„ç»‡çš„ä¸´æ—¶è„šæœ¬æ•´åˆæˆä¸€ä¸ªè½»é‡ä¸”çµæ´»çš„å·¥å…·ï¼Œå…·æœ‰ç»Ÿä¸€çš„æŒ‡æ ‡å’ŒæŠ¥å‘Šã€‚
* [**pacbot**](https://github.com/tmobile/pacbot)**: Policy as Code Bot (PacBot)** æ˜¯ä¸€ä¸ªå¹³å°ï¼Œç”¨äº**æŒç»­åˆè§„ç›‘æ§ã€åˆè§„æŠ¥å‘Šå’Œäº‘å®‰å…¨è‡ªåŠ¨åŒ–**ã€‚åœ¨ PacBot ä¸­ï¼Œå®‰å…¨å’Œåˆè§„ç­–ç•¥ä»¥ä»£ç å½¢å¼å®ç°ã€‚PacBot å‘ç°çš„æ‰€æœ‰èµ„æºéƒ½ä¼šæ ¹æ®è¿™äº›ç­–ç•¥è¿›è¡Œè¯„ä¼°ï¼Œä»¥è¡¡é‡ç­–ç•¥ç¬¦åˆæ€§ã€‚PacBot çš„**è‡ªåŠ¨ä¿®å¤**æ¡†æ¶æä¾›äº†é€šè¿‡é‡‡å–é¢„å®šä¹‰æ“ä½œè‡ªåŠ¨å“åº”ç­–ç•¥è¿è§„çš„èƒ½åŠ›ã€‚
* [**streamalert**](https://github.com/airbnb/streamalert)**:** StreamAlert æ˜¯ä¸€ä¸ªæ— æœåŠ¡å™¨çš„ã€**å®æ—¶**æ•°æ®åˆ†ææ¡†æ¶ï¼Œä½¿æ‚¨èƒ½å¤Ÿ**æ‘„å–ã€åˆ†æå’Œè­¦æŠ¥**æ¥è‡ªä»»ä½•ç¯å¢ƒçš„æ•°æ®ï¼Œ**ä½¿ç”¨æ‚¨å®šä¹‰çš„æ•°æ®æºå’Œè­¦æŠ¥é€»è¾‘**ã€‚è®¡ç®—æœºå®‰å…¨å›¢é˜Ÿä½¿ç”¨ StreamAlert æ¯å¤©æ‰«ææ•°TBçš„æ—¥å¿—æ•°æ®ä»¥è¿›è¡Œäº‹ä»¶æ£€æµ‹å’Œå“åº”ã€‚

## DEBUG: æ•è· AWS cli è¯·æ±‚
```bash
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080

# Capture with burp nor verifying ssl
aws --no-verify-ssl ...

# Dowload brup cert and transform it to pem
curl http://127.0.0.1:8080/cert --output Downloads/certificate.cer
openssl x509 -inform der -in Downloads/certificate.cer -out Downloads/certificate.pem

# Indicate the ca cert to trust
export AWS_CA_BUNDLE=~/Downloads/certificate.pem

# Run aws cli normally trusting burp cert
aws ...
```
## å‚è€ƒèµ„æ–™

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://cloudsecdocs.com/aws/defensive/tooling/audit/](https://cloudsecdocs.com/aws/defensive/tooling/audit/)

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº« hacking æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
