# AWS - EMR Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## EMR

Περισσότερες **πληροφορίες σχετικά με το EMR** στο:

{% content-ref url="../aws-services/aws-emr-enum.md" %}
[aws-emr-enum.md](../aws-services/aws-emr-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `elasticmapreduce:RunJobFlow`

Ένας επιτιθέμενος με αυτές τις άδειες μπορεί να **τρέξει ένα νέο EMR cluster συνδέοντας ρόλους EC2** και να προσπαθήσει να κλέψει τα διαπιστευτήριά του.\
Σημειώστε ότι για να το κάνετε αυτό θα χρειαστεί να **γνωρίζετε κάποιο ssh priv key που έχει εισαχθεί στον λογαριασμό** ή να εισάγετε ένα, και να μπορείτε να **ανοίξετε την πόρτα 22 στον κύριο κόμβο** (μπορείτε να το κάνετε αυτό με τα χαρακτηριστικά `EmrManagedMasterSecurityGroup` και/ή `ServiceAccessSecurityGroup` μέσα στο `--ec2-attributes`).
```bash
# Import EC2 ssh key (you will need extra permissions for this)
ssh-keygen -b 2048 -t rsa -f /tmp/sshkey -q -N ""
chmod 400 /tmp/sshkey
base64 /tmp/sshkey.pub > /tmp/pub.key
aws ec2 import-key-pair \
--key-name "privesc" \
--public-key-material file:///tmp/pub.key


aws emr create-cluster \
--release-label emr-5.15.0 \
--instance-type m4.large \
--instance-count 1 \
--service-role EMR_DefaultRole \
--ec2-attributes InstanceProfile=EMR_EC2_DefaultRole,KeyName=privesc

# Wait 1min and connect via ssh to an EC2 instance of the cluster)
aws emr describe-cluster --cluster-id <id>
# In MasterPublicDnsName you can find the DNS to connect to the master instance
## You cna also get this info listing EC2 instances
```
Σημειώστε πώς ένας **ρόλος EMR** καθορίζεται στο `--service-role` και ένας **ρόλος ec2** καθορίζεται στο `--ec2-attributes` μέσα στο `InstanceProfile`. Ωστόσο, αυτή η τεχνική επιτρέπει μόνο την κλοπή των διαπιστευτηρίων του ρόλου EC2 (καθώς θα συνδεθείτε μέσω ssh) αλλά όχι του ρόλου IAM EMR.

**Πιθανές Επιπτώσεις:** Privesc στον ρόλο υπηρεσίας EC2 που καθορίζεται.

### `elasticmapreduce:CreateEditor`, `iam:ListRoles`, `elasticmapreduce:ListClusters`, `iam:PassRole`, `elasticmapreduce:DescribeEditor`, `elasticmapreduce:OpenEditorInConsole`

Με αυτές τις άδειες, ένας επιτιθέμενος μπορεί να πάει στην **κονσόλα AWS**, να δημιουργήσει ένα Notebook και να έχει πρόσβαση σε αυτό για να κλέψει τον ρόλο IAM.

{% hint style="danger" %}
Ακόμα και αν επισυνάψετε έναν ρόλο IAM στην περίπτωση του notebook, στις δοκιμές μου παρατήρησα ότι ήμουν σε θέση να κλέψω διαπιστευτήρια που διαχειρίζεται το AWS και όχι διαπιστευτήρια που σχετίζονται με τον ρόλο IAM.
{% endhint %}

**Πιθανές Επιπτώσεις:** Privesc στον ρόλο που διαχειρίζεται το AWS arn:aws:iam::420254708011:instance-profile/prod-EditorInstanceProfile

### `elasticmapreduce:OpenEditorInConsole`

Μόνο με αυτή την άδεια, ένας επιτιθέμενος θα είναι σε θέση να έχει πρόσβαση στο **Jupyter Notebook και να κλέψει τον ρόλο IAM** που σχετίζεται με αυτό.\
Η διεύθυνση URL του notebook είναι `https://<notebook-id>.emrnotebooks-prod.eu-west-1.amazonaws.com/<notebook-id>/lab/`

{% hint style="danger" %}
Ακόμα και αν επισυνάψετε έναν ρόλο IAM στην περίπτωση του notebook, στις δοκιμές μου παρατήρησα ότι ήμουν σε θέση να κλέψω διαπιστευτήρια που διαχειρίζεται το AWS και όχι διαπιστευτήρια που σχετίζονται με τον ρόλο IAM.
{% endhint %}

**Πιθανές Επιπτώσεις:** Privesc στον ρόλο που διαχειρίζεται το AWS arn:aws:iam::420254708011:instance-profile/prod-EditorInstanceProfile

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
