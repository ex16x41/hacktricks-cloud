# AWS - Apigatewayææƒ

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## Apigateway

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-api-gateway-enum.md" %}
[aws-api-gateway-enum.md](../aws-services/aws-api-gateway-enum.md)
{% endcontent-ref %}

### `apigateway:POST`

æ‹¥æœ‰æ­¤æƒé™ï¼Œæ‚¨å¯ä»¥ä¸ºå·²é…ç½®çš„APIç”ŸæˆAPIå¯†é’¥ï¼ˆæŒ‰åŒºåŸŸï¼‰ã€‚
```bash
aws --region <region> apigateway create-api-key
```
**æ½œåœ¨å½±å“ï¼š** ä½¿ç”¨è¿™ç§æŠ€æœ¯æ— æ³•æå‡æƒé™ï¼Œä½†å¯èƒ½ä¼šè®¿é—®åˆ°æ•æ„Ÿä¿¡æ¯ã€‚

### `apigateway:GET`

æ‹¥æœ‰æ­¤æƒé™åï¼Œæ‚¨å¯ä»¥è·å–é…ç½®çš„ APIï¼ˆæŒ‰åŒºåŸŸï¼‰ç”Ÿæˆçš„ API å¯†é’¥ã€‚
```bash
aws --region <region> apigateway get-api-keys
aws --region <region> apigateway get-api-key --api-key <key> --include-value
```
**æ½œåœ¨å½±å“ï¼š** ä½¿ç”¨è¿™ç§æŠ€æœ¯æ— æ³•æå‡æƒé™ï¼Œä½†å¯èƒ½ä¼šè·å–å¯¹æ•æ„Ÿä¿¡æ¯çš„è®¿é—®æƒé™ã€‚

### `apigateway:UpdateRestApiPolicy`, `apigateway:PATCH`

æ‹¥æœ‰è¿™äº›æƒé™åï¼Œå¯ä»¥ä¿®æ”¹ API çš„èµ„æºç­–ç•¥ï¼Œä½¿è‡ªå·±èƒ½å¤Ÿè°ƒç”¨å®ƒå¹¶æ»¥ç”¨ API ç½‘å…³å¯èƒ½å…·æœ‰çš„è®¿é—®æƒé™ï¼ˆæ¯”å¦‚è°ƒç”¨ä¸€ä¸ªå­˜åœ¨æ¼æ´çš„ Lambda å‡½æ•°ï¼‰ã€‚

{% code overflow="wrap" %}
```bash
aws apigateway update-rest-api \
--rest-api-id api-id \
--patch-operations op=replace,path=/policy,value='"{\"jsonEscapedPolicyDocument\"}"'
```
{% endcode %}

**æ½œåœ¨å½±å“ï¼š** é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½æ— æ³•ç›´æ¥ä½¿ç”¨æ­¤æŠ€æœ¯è¿›è¡Œæƒé™æå‡ï¼Œä½†å¯èƒ½ä¼šè®¿é—®åˆ°æ•æ„Ÿä¿¡æ¯ã€‚

### `apigateway:PutIntegration`, `apigateway:CreateDeployment`, `iam:PassRole`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

æ‹¥æœ‰ `apigateway:PutIntegration`ã€`apigateway:CreateDeployment` å’Œ `iam:PassRole` æƒé™çš„æ”»å‡»è€…å¯ä»¥**å‘ç°æœ‰ API Gateway REST API æ·»åŠ ä¸€ä¸ªå…·æœ‰é™„åŠ  IAM è§’è‰²çš„ Lambda å‡½æ•°çš„æ–°é›†æˆ**ã€‚æ”»å‡»è€…éšåå¯ä»¥**è§¦å‘ Lambda å‡½æ•°æ‰§è¡Œä»»æ„ä»£ç ï¼Œå¹¶å¯èƒ½è®¿é—®ä¸ IAM è§’è‰²å…³è”çš„èµ„æº**ã€‚

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"
LAMBDA_ROLE_ARN="arn:aws:iam::account-id:role/lambda-role"

# Add a new integration to the API Gateway REST API
aws apigateway put-integration --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --type AWS_PROXY --integration-http-method POST --uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations --credentials $LAMBDA_ROLE_ARN

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šè®¿é—®ä¸Lambdaå‡½æ•°çš„IAMè§’è‰²å…³è”çš„èµ„æºã€‚

### `apigateway:UpdateAuthorizer`, `apigateway:CreateDeployment`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

æ‹¥æœ‰`apigateway:UpdateAuthorizer`å’Œ`apigateway:CreateDeployment`æƒé™çš„æ”»å‡»è€…å¯ä»¥**ä¿®æ”¹ç°æœ‰çš„API Gatewayæˆæƒè€…**ï¼Œä»¥ç»•è¿‡å®‰å…¨æ£€æŸ¥æˆ–åœ¨è¿›è¡ŒAPIè¯·æ±‚æ—¶æ‰§è¡Œä»»æ„ä»£ç ã€‚

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
AUTHORIZER_ID="your-authorizer-id"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"

# Update the API Gateway authorizer
aws apigateway update-authorizer --rest-api-id $API_ID --authorizer-id $AUTHORIZER_ID --authorizer-uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šç»•è¿‡å®‰å…¨æ£€æŸ¥ï¼Œæœªç»æˆæƒè®¿é—® API èµ„æºã€‚

### `apigateway:UpdateVpcLink`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

æ‹¥æœ‰ `apigateway:UpdateVpcLink` æƒé™çš„æ”»å‡»è€…å¯ä»¥**ä¿®æ”¹ç°æœ‰çš„ VPC é“¾æ¥ï¼Œå°†å…¶æŒ‡å‘ä¸åŒçš„ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨ï¼Œä»è€Œå¯èƒ½å°†ç§æœ‰ API æµé‡é‡å®šå‘åˆ°æœªç»æˆæƒæˆ–æ¶æ„èµ„æº**ã€‚
```bash
bashCopy codeVPC_LINK_ID="your-vpc-link-id"
NEW_NLB_ARN="arn:aws:elasticloadbalancing:region:account-id:loadbalancer/net/new-load-balancer-name/50dc6c495c0c9188"

# Update the VPC Link
aws apigateway update-vpc-link --vpc-link-id $VPC_LINK_ID --patch-operations op=replace,path=/targetArns,value="[$NEW_NLB_ARN]"
```
**æ½œåœ¨å½±å“**ï¼šæœªç»æˆæƒè®¿é—®ç§æœ‰ API èµ„æºï¼Œæ‹¦æˆªæˆ–å¹²æ‰° API æµé‡ã€‚

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒ HackTricks çš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆçš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)** ä¸Šå…³æ³¨æˆ‘ä»¬**ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
