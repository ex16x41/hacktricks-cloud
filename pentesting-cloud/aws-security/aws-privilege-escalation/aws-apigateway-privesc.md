# AWS - Apigatewayææƒ

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Apigateway

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-api-gateway-enum.md" %}
[aws-api-gateway-enum.md](../aws-services/aws-api-gateway-enum.md)
{% endcontent-ref %}

### `apigateway:POST`

æ‹¥æœ‰æ­¤æƒé™ï¼Œæ‚¨å¯ä»¥ç”Ÿæˆå·²é…ç½®çš„APIï¼ˆæŒ‰åŒºåŸŸï¼‰çš„APIå¯†é’¥ã€‚
```bash
aws --region <region> apigateway create-api-key
```
**æ½œåœ¨å½±å“ï¼š** ä½¿ç”¨è¿™ç§æŠ€æœ¯æ— æ³•æå‡æƒé™ï¼Œä½†å¯èƒ½ä¼šè®¿é—®åˆ°æ•æ„Ÿä¿¡æ¯ã€‚

### `apigateway:GET`

é€šè¿‡æ­¤æƒé™ï¼Œæ‚¨å¯ä»¥è·å–é…ç½®çš„ APIï¼ˆæŒ‰åŒºåŸŸï¼‰ç”Ÿæˆçš„ API å¯†é’¥ã€‚
```bash
aws --region <region> apigateway get-api-keys
aws --region <region> apigateway get-api-key --api-key <key> --include-value
```
**æ½œåœ¨å½±å“:** ä½¿ç”¨è¿™ç§æŠ€æœ¯æ— æ³•æå‡æƒé™ï¼Œä½†å¯èƒ½ä¼šè®¿é—®åˆ°æ•æ„Ÿä¿¡æ¯ã€‚

### `apigateway:UpdateRestApiPolicy`, `apigateway:PATCH`

æ‹¥æœ‰è¿™äº›æƒé™åï¼Œå¯ä»¥ä¿®æ”¹ API çš„èµ„æºç­–ç•¥ï¼Œä½¿è‡ªå·±èƒ½å¤Ÿè°ƒç”¨å®ƒå¹¶æ»¥ç”¨ API ç½‘å…³å¯èƒ½å…·æœ‰çš„è®¿é—®æƒé™ï¼ˆæ¯”å¦‚è°ƒç”¨ä¸€ä¸ªå­˜åœ¨æ¼æ´çš„ Lambda å‡½æ•°ï¼‰ã€‚

{% code overflow="wrap" %}
```bash
aws apigateway update-rest-api \
--rest-api-id api-id \
--patch-operations op=replace,path=/policy,value='"{\"jsonEscapedPolicyDocument\"}"'
```
{% endcode %}

**æ½œåœ¨å½±å“ï¼š** é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½æ— æ³•ç›´æ¥ä½¿ç”¨æ­¤æŠ€æœ¯è¿›è¡Œæƒé™æå‡ï¼Œä½†å¯èƒ½ä¼šè®¿é—®åˆ°æ•æ„Ÿä¿¡æ¯ã€‚

### `apigateway:PutIntegration`ï¼Œ`apigateway:CreateDeployment`ï¼Œ`iam:PassRole`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

æ‹¥æœ‰`apigateway:PutIntegration`ï¼Œ`apigateway:CreateDeployment`å’Œ`iam:PassRole`æƒé™çš„æ”»å‡»è€…å¯ä»¥**å‘ç°æœ‰API Gateway REST APIæ·»åŠ ä¸€ä¸ªå…·æœ‰é™„åŠ IAMè§’è‰²çš„Lambdaå‡½æ•°çš„æ–°é›†æˆ**ã€‚æ”»å‡»è€…éšåå¯ä»¥**è§¦å‘Lambdaå‡½æ•°ä»¥æ‰§è¡Œä»»æ„ä»£ç ï¼Œå¹¶å¯èƒ½è®¿é—®ä¸IAMè§’è‰²å…³è”çš„èµ„æº**ã€‚

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"
LAMBDA_ROLE_ARN="arn:aws:iam::account-id:role/lambda-role"

# Add a new integration to the API Gateway REST API
aws apigateway put-integration --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --type AWS_PROXY --integration-http-method POST --uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations --credentials $LAMBDA_ROLE_ARN

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šè®¿é—®ä¸Lambdaå‡½æ•°çš„IAMè§’è‰²å…³è”çš„èµ„æºã€‚

### `apigateway:UpdateAuthorizer`ï¼Œ`apigateway:CreateDeployment`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

æ‹¥æœ‰`apigateway:UpdateAuthorizer`å’Œ`apigateway:CreateDeployment`æƒé™çš„æ”»å‡»è€…å¯ä»¥**ä¿®æ”¹ç°æœ‰çš„API Gatewayæˆæƒè€…**ï¼Œä»¥ç»•è¿‡å®‰å…¨æ£€æŸ¥æˆ–åœ¨è¿›è¡ŒAPIè¯·æ±‚æ—¶æ‰§è¡Œä»»æ„ä»£ç ã€‚

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
AUTHORIZER_ID="your-authorizer-id"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"

# Update the API Gateway authorizer
aws apigateway update-authorizer --rest-api-id $API_ID --authorizer-id $AUTHORIZER_ID --authorizer-uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šç»•è¿‡å®‰å…¨æ£€æŸ¥ï¼Œæœªç»æˆæƒè®¿é—® API èµ„æºã€‚

### `apigateway:UpdateVpcLink`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

æ‹¥æœ‰ `apigateway:UpdateVpcLink` æƒé™çš„æ”»å‡»è€…å¯ä»¥**ä¿®æ”¹ç°æœ‰çš„ VPC é“¾æ¥ï¼Œå°†å…¶æŒ‡å‘ä¸åŒçš„ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨ï¼Œä»è€Œå°†ç§æœ‰ API æµé‡é‡å®šå‘åˆ°æœªç»æˆæƒæˆ–æ¶æ„èµ„æº**ã€‚
```bash
bashCopy codeVPC_LINK_ID="your-vpc-link-id"
NEW_NLB_ARN="arn:aws:elasticloadbalancing:region:account-id:loadbalancer/net/new-load-balancer-name/50dc6c495c0c9188"

# Update the VPC Link
aws apigateway update-vpc-link --vpc-link-id $VPC_LINK_ID --patch-operations op=replace,path=/targetArns,value="[$NEW_NLB_ARN]"
```
**æ½œåœ¨å½±å“**ï¼šæœªç»æˆæƒè®¿é—®ç§æœ‰ API èµ„æºï¼Œæ‹¦æˆªæˆ–å¹²æ‰° API æµé‡ã€‚

{% hint style="success" %}
å­¦ä¹ å¹¶å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
