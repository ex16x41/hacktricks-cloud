# Kubernetes SecurityContext(s)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## PodSecurityContext <a href="#podsecuritycontext-v1-core" id="podsecuritycontext-v1-core"></a>

[**æ¥è‡ªæ–‡æ¡£ï¼š**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)

åœ¨æŒ‡å®š Pod çš„å®‰å…¨ä¸Šä¸‹æ–‡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªå±æ€§ã€‚ä»é˜²å¾¡å®‰å…¨çš„è§’åº¦æ¥çœ‹ï¼Œæ‚¨åº”è¯¥è€ƒè™‘ï¼š

* å°† **runASNonRoot** è®¾ç½®ä¸º **True**
* é…ç½® **runAsUser**
* å¦‚æœå¯èƒ½ï¼Œè€ƒè™‘ **é™åˆ¶** **æƒé™**ï¼ŒæŒ‡æ˜ **seLinuxOptions** å’Œ **seccompProfile**
* **ä¸è¦** é€šè¿‡ **runAsGroup** å’Œ **supplementaryGroups** æä¾› **ç‰¹æƒ** **ç»„** è®¿é—®

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroup</strong></a><br><em>æ•´æ•°</em></p>                                                                                                                                                                                                                                                 | <p>é€‚ç”¨äº<strong>æ‰€æœ‰å®¹å™¨çš„ç‰¹æ®Šè¡¥å……ç»„</strong>ã€‚æŸäº›å·ç±»å‹å…è®¸ Kubelet <strong>æ›´æ”¹è¯¥å·çš„æ‰€æœ‰æƒ</strong>ï¼Œä½¿å…¶å½’ Pod æ‰€æœ‰ï¼š<br>1. æ‹¥æœ‰çš„ GID å°†æ˜¯ FSGroup<br>2. è®¾ç½®äº† setgid ä½ï¼ˆåœ¨å·ä¸­åˆ›å»ºçš„æ–°æ–‡ä»¶å°†ç”± FSGroup æ‹¥æœ‰ï¼‰<br>3. æƒé™ä½ä¸ rw-rw---- è¿›è¡Œ OR è¿ç®—ã€‚å¦‚æœæœªè®¾ç½®ï¼ŒKubelet å°†ä¸ä¼šä¿®æ”¹ä»»ä½•å·çš„æ‰€æœ‰æƒå’Œæƒé™</p> |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroupChangePolicy</strong></a><br><em>å­—ç¬¦ä¸²</em></p>                                                                                                                                                                                                                                      | è¿™å®šä¹‰äº†åœ¨ Pod å†…éƒ¨æš´éœ²ä¹‹å‰ **æ›´æ”¹å·çš„æ‰€æœ‰æƒå’Œæƒé™** çš„è¡Œä¸ºã€‚                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsGroup</strong></a><br><em>æ•´æ•°</em></p>                                                                                                                                                                                                                                              | **è¿è¡Œå®¹å™¨è¿›ç¨‹çš„å…¥å£ç‚¹çš„ GID**ã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™ä½¿ç”¨è¿è¡Œæ—¶é»˜è®¤å€¼ã€‚                                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>å¸ƒå°”å€¼</em></p>                                                                                                                                                                                                                                            | è¡¨ç¤ºå®¹å™¨å¿…é¡»ä»¥éæ ¹ç”¨æˆ·èº«ä»½è¿è¡Œã€‚å¦‚æœä¸º trueï¼ŒKubelet å°†åœ¨è¿è¡Œæ—¶éªŒè¯æ˜ åƒï¼Œä»¥ç¡®ä¿å®ƒä¸ä»¥ UID 0ï¼ˆæ ¹ï¼‰èº«ä»½è¿è¡Œï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ— æ³•å¯åŠ¨å®¹å™¨ã€‚                                                                                                                                                                                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsUser</strong></a><br><em>æ•´æ•°</em></p>                                                                                                                                                                                                                                               | **è¿è¡Œå®¹å™¨è¿›ç¨‹çš„å…¥å£ç‚¹çš„ UID**ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™é»˜è®¤ä¸ºæ˜ åƒå…ƒæ•°æ®ä¸­æŒ‡å®šçš„ç”¨æˆ·ã€‚                                                                                                                                                                                                                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>æœ‰å…³</em> <em><strong>seLinux</strong></em> çš„æ›´å¤šä¿¡æ¯</p>                                                           | **åº”ç”¨äºæ‰€æœ‰å®¹å™¨çš„ SELinux ä¸Šä¸‹æ–‡**ã€‚å¦‚æœæœªæŒ‡å®šï¼Œå®¹å™¨è¿è¡Œæ—¶å°†ä¸ºæ¯ä¸ªå®¹å™¨åˆ†é…ä¸€ä¸ªéšæœºçš„ SELinux ä¸Šä¸‹æ–‡ã€‚                                                                                                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a><br><em>æœ‰å…³</em> <em><strong>Seccomp</strong></em> çš„æ›´å¤šä¿¡æ¯</p>                                                           | æ­¤ Pod ä¸­å®¹å™¨ä½¿ç”¨çš„ **seccomp é€‰é¡¹**ã€‚                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>supplementalGroups</strong></a><br><em>æ•´æ•°æ•°ç»„</em></p>                                                                                                                                                                                                                                | é™¤äº†å®¹å™¨çš„ä¸»è¦ GID ä¹‹å¤–ï¼Œ**åº”ç”¨äºæ¯ä¸ªå®¹å™¨ä¸­è¿è¡Œçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹çš„ç»„** åˆ—è¡¨ã€‚                                                                                                                                                                                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>sysctls</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#sysctl-v1-core"><em>Sysctl</em></a> <em>æ•°ç»„</em><br><em>æœ‰å…³</em> <a href="https://www.garron.me/en/go2linux/sysctl-linux.html"><em><strong>sysctls</strong></em></a> çš„æ›´å¤šä¿¡æ¯</p> | Sysctls æŒæœ‰ **ç”¨äº Pod çš„å‘½åç©ºé—´ sysctls åˆ—è¡¨**ã€‚å…·æœ‰ä¸å—æ”¯æŒçš„ sysctlsï¼ˆç”±å®¹å™¨è¿è¡Œæ—¶ï¼‰å¯èƒ½ä¼šå¯¼è‡´å¯åŠ¨å¤±è´¥ã€‚                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                                                                           | åº”ç”¨äºæ‰€æœ‰å®¹å™¨çš„ Windows ç‰¹å®šè®¾ç½®ã€‚å¦‚æœæœªæŒ‡å®šï¼Œå°†ä½¿ç”¨å®¹å™¨çš„ SecurityContext ä¸­çš„é€‰é¡¹ã€‚                                                                                                                                                                                                                                                                                                                                               |

## SecurityContext

[**æ¥è‡ªæ–‡æ¡£ï¼š**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

æ­¤ä¸Šä¸‹æ–‡è®¾ç½®åœ¨ **å®¹å™¨å®šä¹‰** å†…ã€‚ä»é˜²å¾¡å®‰å…¨çš„è§’åº¦æ¥çœ‹ï¼Œæ‚¨åº”è¯¥è€ƒè™‘ï¼š

* **allowPrivilegeEscalation** è®¾ç½®ä¸º **False**
* ä¸è¦æ·»åŠ æ•æ„Ÿçš„ **èƒ½åŠ›**ï¼ˆå¹¶åˆ é™¤ä¸éœ€è¦çš„èƒ½åŠ›ï¼‰
* **privileged** è®¾ç½®ä¸º **False**
* å¦‚æœå¯èƒ½ï¼Œå°† **readOnlyFilesystem** è®¾ç½®ä¸º **True**
* å°† **runAsNonRoot** è®¾ç½®ä¸º **True** å¹¶è®¾ç½® **runAsUser**
* å¦‚æœå¯èƒ½ï¼Œè€ƒè™‘ **é™åˆ¶** **æƒé™**ï¼ŒæŒ‡æ˜ **seLinuxOptions** å’Œ **seccompProfile**
* **ä¸è¦** é€šè¿‡ **runAsGroup** æä¾› **ç‰¹æƒ** **ç»„** è®¿é—®ã€‚

è¯·æ³¨æ„ï¼Œåœ¨ **SecurityContext å’Œ PodSecurityContext** ä¸­è®¾ç½®çš„å±æ€§ï¼Œ**SecurityContext** ä¸­æŒ‡å®šçš„å€¼å…·æœ‰ **ä¼˜å…ˆæƒ**ã€‚

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>allowPrivilegeEscalation</strong></a><br><em>å¸ƒå°”å€¼</em></p>                                                                                                                                                                      | **AllowPrivilegeEscalation** æ§åˆ¶è¿›ç¨‹æ˜¯å¦å¯ä»¥ **è·å¾—æ¯”å…¶çˆ¶è¿›ç¨‹æ›´å¤šçš„ç‰¹æƒ**ã€‚æ­¤å¸ƒå°”å€¼ç›´æ¥æ§åˆ¶æ˜¯å¦å°†åœ¨å®¹å™¨è¿›ç¨‹ä¸Šè®¾ç½® no\_new\_privs æ ‡å¿—ã€‚å½“å®¹å™¨ä»¥ **Privileged** èº«ä»½è¿è¡Œæˆ–å…·æœ‰ **CAP\_SYS\_ADMIN** æ—¶ï¼ŒAllowPrivilegeEscalation å§‹ç»ˆä¸º true |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>capabilities</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#capabilities-v1-core"><em>Capabilities</em></a><br><em>æœ‰å…³</em> <em><strong>Capabilities</strong></em> çš„æ›´å¤šä¿¡æ¯</p>  | **è¿è¡Œå®¹å™¨æ—¶æ·»åŠ /åˆ é™¤çš„èƒ½åŠ›**ã€‚é»˜è®¤ä¸ºé»˜è®¤çš„èƒ½åŠ›é›†ã€‚                                                                                                                                                                                                                    |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>privileged</strong></a><br><em>å¸ƒå°”å€¼</em></p>                                                                                                                                                                                    | ä»¥ç‰¹æƒæ¨¡å¼è¿è¡Œå®¹å™¨ã€‚ç‰¹æƒå®¹å™¨ä¸­çš„è¿›ç¨‹åŸºæœ¬ä¸Š **ç­‰åŒäºä¸»æœºä¸Šçš„æ ¹ç”¨æˆ·**ã€‚é»˜è®¤ä¸º falseã€‚                                                                                                                                                                               |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>procMount</strong></a><br><em>å­—ç¬¦ä¸²</em></p>                                                                                                                                                                                      | procMount è¡¨ç¤º **ç”¨äºå®¹å™¨çš„ proc æŒ‚è½½ç±»å‹**ã€‚é»˜è®¤å€¼ä¸º DefaultProcMountï¼Œå®ƒä½¿ç”¨å®¹å™¨è¿è¡Œæ—¶çš„åªè¯»è·¯å¾„å’Œå±è”½è·¯å¾„çš„é»˜è®¤å€¼ã€‚                                                                                                                                    |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>readOnlyRootFilesystem</strong></a><br><em>å¸ƒå°”å€¼</em></p>                                                                                                                                                                        | æ­¤ **å®¹å™¨æ˜¯å¦å…·æœ‰åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ**ã€‚é»˜è®¤å€¼ä¸º falseã€‚                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsGroup</strong></a><br><em>æ•´æ•°</em></p>                                                                                                                                                                                    | **è¿è¡Œå®¹å™¨è¿›ç¨‹çš„å…¥å£ç‚¹çš„ GID**ã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™ä½¿ç”¨è¿è¡Œæ—¶é»˜è®¤å€¼ã€‚                                                                                                                                                                                                                                |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>å¸ƒå°”å€¼</em></p>                                                                                                                                                                                  | è¡¨ç¤ºå®¹å™¨å¿…é¡» **ä»¥éæ ¹ç”¨æˆ·èº«ä»½è¿è¡Œ**ã€‚å¦‚æœä¸º trueï¼ŒKubelet å°†åœ¨è¿è¡Œæ—¶éªŒè¯æ˜ åƒï¼Œä»¥ç¡®ä¿å®ƒä¸ä»¥ UID 0ï¼ˆæ ¹ï¼‰èº«ä»½è¿è¡Œï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ— æ³•å¯åŠ¨å®¹å™¨ã€‚                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsUser</strong></a><br><em>æ•´æ•°</em></p>                                                                                                                                                                                     | **è¿è¡Œå®¹å™¨è¿›ç¨‹çš„å…¥å£ç‚¹çš„ UID**ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™é»˜è®¤ä¸ºæ˜ åƒå…ƒæ•°æ®ä¸­æŒ‡å®šçš„ç”¨æˆ·ã€‚                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>æœ‰å…³</em> <em><strong>seLinux</strong></em> çš„æ›´å¤šä¿¡æ¯</p> | **åº”ç”¨äºå®¹å™¨çš„ SELinux ä¸Šä¸‹æ–‡**ã€‚å¦‚æœæœªæŒ‡å®šï¼Œå®¹å™¨è¿è¡Œæ—¶å°†ä¸ºæ¯ä¸ªå®¹å™¨åˆ†é…ä¸€ä¸ªéšæœºçš„ SELinux ä¸Šä¸‹æ–‡ã€‚                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a></p>                                                               | æ­¤å®¹å™¨ä½¿ç”¨çš„ **seccomp é€‰é¡¹**ã€‚                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                 | åº”ç”¨äºæ‰€æœ‰å®¹å™¨çš„ **Windows ç‰¹å®šè®¾ç½®**ã€‚                                                                                                                                                                                                                                                              |

## References

* [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)
* [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
