# Kubernetes Hardening

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Tools to analyse a cluster

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) рдПрдХ K8s рдУрдкрди-рд╕реЛрд░реНрд╕ рдЯреВрд▓ рд╣реИ рдЬреЛ рдПрдХ рдорд▓реНрдЯреА-рдХреНрд▓рд╛рдЙрдб K8s рд╕рд┐рдВрдЧрд▓ рдкреЗрди рдСрдл рдЧреНрд▓рд╛рд╕ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдЬреЛрдЦрд┐рдо рд╡рд┐рд╢реНрд▓реЗрд╖рдг, рд╕реБрд░рдХреНрд╖рд╛ рдЕрдиреБрдкрд╛рд▓рди, RBAC рд╡рд┐рдЬрд╝реБрдЕрд▓рд╛рдЗрдЬрд╝рд░ рдФрд░ рдЗрдореЗрдЬ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреА рд╕реНрдХреИрдирд┐рдВрдЧ рд╢рд╛рдорд┐рд▓ рд╣реИред Kubescape K8s рдХреНрд▓рд╕реНрдЯрд░, YAML рдлрд╝рд╛рдЗрд▓реЛрдВ рдФрд░ HELM рдЪрд╛рд░реНрдЯреНрд╕ рдХреЛ рд╕реНрдХреИрди рдХрд░рддрд╛ рд╣реИ, рдХрдИ рдврд╛рдВрдЪреЛрдВ (рдЬреИрд╕реЗ [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK┬о](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)) рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди, рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдФрд░ RBAC (рднреВрдорд┐рдХрд╛-рдЖрдзрд╛рд░рд┐рдд-рдПрдХреНрд╕реЗрд╕-рдирд┐рдпрдВрддреНрд░рдг) рдЙрд▓реНрд▓рдВрдШрдиреЛрдВ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рддрд╛ рд╣реИ, CI/CD рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдХреЗ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдЪрд░рдгреЛрдВ рдореЗрдВ рдЬреЛрдЦрд┐рдо рд╕реНрдХреЛрд░ рддреБрд░рдВрдд рдЧрдгрдирд╛ рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕рдордп рдХреЗ рд╕рд╛рде рдЬреЛрдЦрд┐рдо рдкреНрд░рд╡реГрддреНрддрд┐рдпреЛрдВ рдХреЛ рджрд┐рдЦрд╛рддрд╛ рд╣реИред
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

рдЙрдкрдХрд░рдг [**kube-bench**](https://github.com/aquasecurity/kube-bench) рдПрдХ рдРрд╕рд╛ рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ рдпрд╣ рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ Kubernetes рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рддреИрдирд╛рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) рдореЗрдВ рджрд╕реНрддрд╛рд╡реЗрдЬрд┐рдд рдЬрд╛рдВрдЪреЛрдВ рдХреЛ рдЪрд▓рд╛рдХрд░ред\
рдЖрдк рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВ:

* kube-bench рдХреЛ рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдЪрд▓рд╛рдирд╛ (рд╣реЛрд╕реНрдЯ рдХреЗ рд╕рд╛рде PID рдирд╛рдорд╕реНрдерд╛рди рд╕рд╛рдЭрд╛ рдХрд░рдирд╛)
* рдПрдХ рдХрдВрдЯреЗрдирд░ рдЪрд▓рд╛рдирд╛ рдЬреЛ рд╣реЛрд╕реНрдЯ рдкрд░ kube-bench рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рд╕реАрдзреЗ рд╣реЛрд╕реНрдЯ рдкрд░ kube-bench рдЪрд▓рд╛рдирд╛
* [Releases page](https://github.com/aquasecurity/kube-bench/releases) рд╕реЗ рдирд╡реАрдирддрдо рдмрд╛рдЗрдирд░реА рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛,
* рдЗрд╕реЗ рд╕реНрд░реЛрдд рд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдХрд░рдирд╛ред

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

рдЙрдкрдХрд░рдг [**kubeaudit**](https://github.com/Shopify/kubeaudit) рдПрдХ рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рдЙрдкрдХрд░рдг рдФрд░ рд╡рд┐рднрд┐рдиреНрди рд╕реБрд░рдХреНрд╖рд╛ рдЪрд┐рдВрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП **Kubernetes рдХреНрд▓рд╕реНрдЯрд░реНрд╕** рдХрд╛ рдСрдбрд┐рдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ Go рдкреИрдХреЗрдЬ рд╣реИред

Kubeaudit рдпрд╣ рдкрд╣рдЪрд╛рди рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рдХрд┐рд╕реА рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдЪрд▓ рд░рд╣рд╛ рд╣реИред рдпрджрд┐ рд╣рд╛рдВ, рддреЛ рдпрд╣ рдЙрд╕ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рд╕рднреА Kubernetes рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХрд╛ рдСрдбрд┐рдЯ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдЧрд╛:
```
kubeaudit all
```
рдпрд╣ рдЙрдкрдХрд░рдг `autofix` рддрд░реНрдХ рднреА рд░рдЦрддрд╛ рд╣реИ рддрд╛рдХрд┐ **рдкрд╛рдИ рдЧрдИ рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдареАрдХ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

рдЙрдкрдХрд░рдг [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) Kubernetes рдХреНрд▓рд╕реНрдЯрд░реЛрдВ рдореЗрдВ рд╕реБрд░рдХреНрд╖рд╛ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреА рдЦреЛрдЬ рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рдЙрдкрдХрд░рдг рдХреЛ Kubernetes рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рд╕реБрд░рдХреНрд╖рд╛ рдореБрджреНрджреЛрдВ рдХреЗ рдкреНрд░рддрд┐ рдЬрд╛рдЧрд░реВрдХрддрд╛ рдФрд░ рджреГрд╢реНрдпрддрд╛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рдХрд╕рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) рдПрдХ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреА рд╕реНрдХреИрдирд┐рдВрдЧ рдФрд░ CIS Docker рдмреЗрдВрдЪрдорд╛рд░реНрдХ рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЙрдирдХреЗ kubernetes рдХреНрд▓рд╕реНрдЯрд░реЛрдВ рдХрд╛ рд╕рдЯреАрдХ рдФрд░ рддрд╛рддреНрдХрд╛рд▓рд┐рдХ рдЬреЛрдЦрд┐рдо рдореВрд▓реНрдпрд╛рдВрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред Kubei рд╕рднреА рдЫрд╡рд┐рдпреЛрдВ рдХреЛ рд╕реНрдХреИрди рдХрд░рддрд╛ рд╣реИ рдЬреЛ Kubernetes рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИрдВ, рдЬрд┐рд╕рдореЗрдВ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкреЙрдб рдФрд░ рд╕рд┐рд╕реНрдЯрдо рдкреЙрдб рдХреА рдЫрд╡рд┐рдпрд╛рдБ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) Kubernetes рдХреЗ Role-based access control (RBAC) рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдореЙрдбрд▓ рдореЗрдВ рдЬреЛрдЦрд┐рдо рднрд░реЗ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП Kubernetes рдХреНрд▓рд╕реНрдЯрд░ рдХреЛ рд╕реНрдХреИрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдкрдХрд░рдг рд╣реИред

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) рдЕрдиреНрдп рдЙрдкрдХрд░рдгреЛрдВ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдЙрдЪреНрдЪ рдЬреЛрдЦрд┐рдо рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдПрдХ рдЙрдкрдХрд░рдг рд╣реИред рдЗрд╕рдореЗрдВ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ 3 рд╡рд┐рднрд┐рдиреНрди рдореЛрдб рд╣реИрдВ:

* **`find-role-relationships`**: рдЬреЛ рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдПрдЧрд╛ рдХрд┐ рдХреМрди рд╕реЗ AWS рднреВрдорд┐рдХрд╛рдПрдБ рдХрд┐рд╕ рдкреЙрдб рдореЗрдВ рдЪрд▓ рд░рд╣реА рд╣реИрдВ
* **`find-secrets`**: рдЬреЛ Pods, ConfigMaps, рдФрд░ Secrets рдЬреИрд╕реЗ K8s рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдореЗрдВ рд░рд╣рд╕реНрдпреЛрдВ рдХреА рдкрд╣рдЪрд╛рди рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддрд╛ рд╣реИред
* **`test-imds-access`**: рдЬреЛ рдкреЙрдб рдЪрд▓рд╛рдиреЗ рдФрд░ рдореЗрдЯрд╛рдбреЗрдЯрд╛ v1 рдФрд░ v2 рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдЧрд╛ред рдЪреЗрддрд╛рд╡рдиреА: рдпрд╣ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдПрдХ рдкреЙрдб рдЪрд▓рд╛рдПрдЧрд╛, рдмрд╣реБрдд рд╕рд╛рд╡рдзрд╛рди рд░рд╣реЗрдВ рдХреНрдпреЛрдВрдХрд┐ рд╢рд╛рдпрдж рдЖрдк рдпрд╣ рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ!

## **Audit IaC Code**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) рдПрдХ рдЙрдкрдпреЛрдЧрд┐рддрд╛ рд╣реИ рдЬреЛ рд▓рд╛рдЗрд╡ Kubernetes рдХреНрд▓рд╕реНрдЯрд░ рдХреЛ рд╕реНрдХреИрди рдХрд░рддреА рд╣реИ рдФрд░ **рддреИрдирд╛рдд рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдФрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд╕рд╛рде рд╕рдВрднрд╛рд╡рд┐рдд рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреА рд░рд┐рдкреЛрд░реНрдЯ рдХрд░рддреА рд╣реИ**ред рдпрд╣ рдЖрдкрдХреЗ рдХреНрд▓рд╕реНрдЯрд░ рдХреЛ рддреИрдирд╛рдд рдХрд┐рдП рдЧрдП рдЖрдзрд╛рд░ рдкрд░ рд╕реНрд╡рдЪреНрдЫ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЬреЛ рдбрд┐рд╕реНрдХ рдкрд░ рд╣реИ, рдЙрд╕рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдирд╣реАрдВред рдЕрдкрдиреЗ рдХреНрд▓рд╕реНрдЯрд░ рдХреЛ рд╕реНрдХреИрди рдХрд░рдХреЗ, рдпрд╣ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рддрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ рдХрд┐ рд╕рд░реНрд╡реЛрддреНрддрдо рдкреНрд░рдерд╛рдПрдБ рд▓рд╛рдЧреВ рд╣реИрдВ, рдЗрд╕ рдкреНрд░рдХрд╛рд░ рднрд╡рд┐рд╖реНрдп рдХреА рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рдПрдХ Kubernetes рдХреНрд▓рд╕реНрдЯрд░ рдХреЛ рд╕рдВрдЪрд╛рд▓рд┐рдд рдХрд░рддреЗ рд╕рдордп рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рд╕рдВрдЬреНрдЮрд╛рдирд╛рддреНрдордХ \_over\_load рдХреЛ рдХрдо рдХрд░рдирд╛ рд╣реИред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрджрд┐ рдЖрдкрдХреЗ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдПрдХ рдореЗрдЯреНрд░рд┐рдХ-рд╕рд░реНрд╡рд░ рд╣реИ, рддреЛ рдпрд╣ рд╕рдВрднрд╛рд╡рд┐рдд рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЗ рдЕрдзрд┐рдХ/рдХрдо рдЖрд╡рдВрдЯрди рдХреА рд░рд┐рдкреЛрд░реНрдЯ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдпрджрд┐ рдЖрдкрдХреЗ рдХреНрд▓рд╕реНрдЯрд░ рдХреА рдХреНрд╖рдорддрд╛ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЬрд╛рддреА рд╣реИ рддреЛ рдЖрдкрдХреЛ рдЪреЗрддрд╛рд╡рдиреА рджреЗрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддрд╛ рд╣реИред

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд **Infrastructure as Code solutions** рдореЗрдВ **рд╕реБрд░рдХреНрд╖рд╛ рдХрдордЬреЛрд░рд┐рдпреЛрдВ**, рдЕрдиреБрдкрд╛рд▓рди рдореБрджреНрджреЛрдВ, рдФрд░ рдмреБрдирд┐рдпрд╛рджреА рдврд╛рдВрдЪреЗ рдХреА рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рддрд╛ рд╣реИ: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM, рдФрд░ OpenAPI 3.0 рд╡рд┐рд╢рд┐рд╖реНрдЯрддрд╛рдПрдБ

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) рдмреБрдирд┐рдпрд╛рджреА рдврд╛рдВрдЪреЗ рдХреЗ рдХреЛрдб рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реНрдереИрддрд┐рдХ рдХреЛрдб рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдЙрдкрдХрд░рдг рд╣реИред

рдпрд╣ [Terraform](https://terraform.io), Terraform рдпреЛрдЬрдирд╛, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) рдпрд╛ [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рджрд╛рди рдХреА рдЧрдИ рдХреНрд▓рд╛рдЙрдб рдмреБрдирд┐рдпрд╛рджреА рдврд╛рдВрдЪреЗ рдХреЛ рд╕реНрдХреИрди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЧреНрд░рд╛рдл-рдЖрдзрд╛рд░рд┐рдд рд╕реНрдХреИрдирд┐рдВрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рдФрд░ рдЕрдиреБрдкрд╛рд▓рди рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рддрд╛ рд╣реИред

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) рдПрдХ рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ рдЖрдкрдХреЗ Kubernetes рдСрдмреНрдЬреЗрдХреНрдЯ рдкрд░рд┐рднрд╛рд╖рд╛рдУрдВ рдХрд╛ рд╕реНрдереИрддрд┐рдХ рдХреЛрдб рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рддрд╛ рд╣реИред

рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

| рд╡рд┐рддрд░рдг                                            | рдХрдорд╛рдВрдб / рд▓рд┐рдВрдХ                                                                          |
| ------------------------------------------------ | ------------------------------------------------------------------------------------- |
| macOS, Linux, рдФрд░ Windows рдХреЗ рд▓рд┐рдП рдкреВрд░реНрд╡-рдирд┐рд░реНрдорд┐рдд рдмрд╛рдЗрдирд░реА | [GitHub releases](https://github.com/zegl/kube-score/releases)                          |
| Docker                                          | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS рдФрд░ Linux)                      | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS рдФрд░ Linux) | `kubectl krew install score`                                                            |

## рдЯрд┐рдкреНрд╕

### Kubernetes PodSecurityContext рдФрд░ SecurityContext

рдЖрдк **Pods рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдВрджрд░реНрдн** ( _PodSecurityContext_ рдХреЗ рд╕рд╛рде) рдФрд░ **рдХрдВрдЯреЗрдирд░реЛрдВ** рдХрд╛ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдВрджрд░реНрдн ( _SecurityContext_ рдХреЗ рд╕рд╛рде) рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдЪрд▓рд╛рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╣реИрдВред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдкрдврд╝реЗрдВ:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes API Hardening

Kubernetes Api Server рддрдХ рдкрд╣реБрдБрдЪ рдХреА **рд╕реБрд░рдХреНрд╖рд╛ рдХрд░рдирд╛** рдмрд╣реБрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдЕрднрд┐рдиреЗрддрд╛ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдкрд░реНрдпрд╛рдкреНрдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реИрдВ, рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рд╡рд╛рддрд╛рд╡рд░рдг рдХреЛ рдХрдИ рддрд░реАрдХреЛрдВ рд╕реЗ рдиреБрдХрд╕рд╛рди рдкрд╣реБрдБрдЪрд╛ рд╕рдХрддрд╛ рд╣реИред\
рдпрд╣ **рдкрд╣реБрдБрдЪ** (API Server рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП **whitelist** рдореВрд▓реНрдпреЛрдВ рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрдВ рдФрд░ рдХрд┐рд╕реА рдЕрдиреНрдп рдХрдиреЗрдХреНрд╢рди рдХреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░реЗрдВ) рдФрд░ [**рдкреНрд░рдорд╛рдгреАрдХрд░рдг**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) ( **рдХрдо рд╕реЗ рдХрдо** **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░** рдХреЗ рд╕рд┐рджреНрдзрд╛рдВрдд рдХрд╛ рдкрд╛рд▓рди рдХрд░рддреЗ рд╣реБрдП) рджреЛрдиреЛрдВ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред рдФрд░ рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ **рдХрднреА рднреА** **рдЧреБрдордирд╛рдо** **рдЕрдиреБрд░реЛрдзреЛрдВ** рдХреА **рдЕрдиреБрдорддрд┐** **рдирд╣реАрдВ** рджреЗрдВред

**рд╕рд╛рдорд╛рдиреНрдп рдЕрдиреБрд░реЛрдз рдкреНрд░рдХреНрд░рд┐рдпрд╛:**\
рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ K8s ServiceAccount тАУ> рдкреНрд░рдорд╛рдгреАрдХрд░рдг тАУ> рдкреНрд░рд╛рдзрд┐рдХрд░рдг тАУ> рдкреНрд░рд╡реЗрд╢ рдирд┐рдпрдВрддреНрд░рдгред

**рдЯрд┐рдкреНрд╕**:

* рдкреЛрд░реНрдЯ рдмрдВрдж рдХрд░реЗрдВред
* рдЧреБрдордирд╛рдо рдкрд╣реБрдБрдЪ рд╕реЗ рдмрдЪреЗрдВред
* NodeRestriction; API рддрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдиреЛрдбреНрд╕ рд╕реЗ рдХреЛрдИ рдкрд╣реБрдБрдЪ рдирд╣реАрдВред
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* рдореВрд▓ рд░реВрдк рд╕реЗ kubelets рдХреЛ node-restriction.kubernetes.io/ рдЙрдкрд╕рд░реНрдЧ рдХреЗ рд╕рд╛рде рд▓реЗрдмрд▓ рдЬреЛрдбрд╝рдиреЗ/рд╣рдЯрд╛рдиреЗ/рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИред рдпрд╣ рд▓реЗрдмрд▓ рдЙрдкрд╕рд░реНрдЧ рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХреЗ рд▓рд┐рдП рдЙрдирдХреЗ рдиреЛрдб рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЛ рдХрд╛рд░реНрдпрднрд╛рд░ рдЕрд▓рдЧрд╛рд╡ рдХреЗ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рд▓реЗрдмрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд░рдХреНрд╖рд┐рдд рд╣реИ, рдФрд░ kubelets рдХреЛ рдЙрд╕ рдЙрдкрд╕рд░реНрдЧ рдХреЗ рд╕рд╛рде рд▓реЗрдмрд▓ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реЛрдЧреАред
* рдФрд░ рд╕рд╛рде рд╣реА, kubelets рдХреЛ рдЗрди рд▓реЗрдмрд▓реЛрдВ рдФрд░ рд▓реЗрдмрд▓ рдЙрдкрд╕рд░реНрдЧреЛрдВ рдХреЛ рдЬреЛрдбрд╝рдиреЗ/рд╣рдЯрд╛рдиреЗ/рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
* рд▓реЗрдмрд▓ рдХреЗ рд╕рд╛рде рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд╛рд░реНрдпрднрд╛рд░ рдЕрд▓рдЧрд╛рд╡ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВред
* API рдкрд╣реБрдБрдЪ рд╕реЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреЙрдбреНрд╕ рдХреЛ рд░реЛрдХреЗрдВред
* рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ ApiServer рдХреЗ рдкреНрд░рджрд░реНрд╢рди рд╕реЗ рдмрдЪреЗрдВред
* рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдБрдЪ RBAC рд╕реЗ рдмрдЪреЗрдВред
* рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдФрд░ IP whitelisting рдХреЗ рд╕рд╛рде ApiServer рдкреЛрд░реНрдЯред

### SecurityContext Hardening

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рдпрджрд┐ рдХреЛрдИ рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдПрдХ рдкреЙрдб рд╢реБрд░реВ рд╣реЛрдиреЗ рдкрд░ рд░реВрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореЗрдВ рд╕реЗ рдПрдХ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдЕрдзрд┐рдХ рд╕реБрд░рдХреНрд╖рд┐рдд рд╕рдВрджрд░реНрдн рдХреЗ рднреАрддрд░ рдЕрдкрдиреЗ рдЖрд╡реЗрджрди рдХреЛ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### рд╕рд╛рдорд╛рдиреНрдп рд╣рд╛рд░реНрдбрдирд┐рдВрдЧ

рдЖрдкрдХреЛ рдЕрдкрдиреЗ Kubernetes рд╡рд╛рддрд╛рд╡рд░рдг рдХреЛ рдЖрд╡рд╢реНрдпрдХрддрд╛рдиреБрд╕рд╛рд░ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рддрд╛рдХрд┐:

* рдирд┐рд░реНрднрд░рддрд╛рдПрдБ рдЕрджреНрдпрддрд┐рдд рд╣реЛрдВред
* рдмрдЧ рдФрд░ рд╕реБрд░рдХреНрд╖рд╛ рдкреИрдЪред

[**рд░рд┐рд▓реАрдЬрд╝ рдЪрдХреНрд░**](https://kubernetes.io/docs/setup/release/version-skew-policy/): рд╣рд░ 3 рдорд╣реАрдиреЗ рдореЗрдВ рдПрдХ рдирдпрд╛ рдорд╛рдЗрдирд░ рд░рд┐рд▓реАрдЬрд╝ рд╣реЛрддрд╛ рд╣реИ -- 1.20.3 = 1(рдореБрдЦреНрдп).20(рдорд╛рдЗрдирд░).3(рдкреИрдЪ)

**Kubernetes рдХреНрд▓рд╕реНрдЯрд░ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд╣реИ (рдпрд╣рд╛рдВ рд╕реЗ** [**рдпрд╣рд╛рдВ**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* рдорд╛рд╕реНрдЯрд░ рдиреЛрдб рдШрдЯрдХреЛрдВ рдХреЛ рдЗрд╕ рдЕрдиреБрдХреНрд░рдо рдХрд╛ рдкрд╛рд▓рди рдХрд░рддреЗ рд╣реБрдП рдЕрдкрдЧреНрд░реЗрдб рдХрд░реЗрдВ:
* etcd (рд╕рднреА рдЙрджрд╛рд╣рд░рдг)ред
* kube-apiserver (рд╕рднреА рдирд┐рдпрдВрддреНрд░рдг рд╡рд┐рдорд╛рди рд╣реЛрд╕реНрдЯ)ред
* kube-controller-managerред
* kube-schedulerред
* рдХреНрд▓рд╛рдЙрдб рдХрдВрдЯреНрд░реЛрд▓рд░ рдкреНрд░рдмрдВрдзрдХ, рдпрджрд┐ рдЖрдк рдПрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред
* рдХрд╛рд░реНрдпрдХрд░реНрддрд╛ рдиреЛрдб рдШрдЯрдХреЛрдВ рдЬреИрд╕реЗ kube-proxy, kubelet рдХреЛ рдЕрдкрдЧреНрд░реЗрдб рдХрд░реЗрдВред

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
