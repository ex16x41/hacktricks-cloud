# Kubernetes GÃ¼venliÄŸini SaÄŸlama

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Bir kÃ¼me analiz etmek iÃ§in araÃ§lar

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape), risk analizi, gÃ¼venlik uyumluluÄŸu, RBAC gÃ¶rselleÅŸtirici ve gÃ¶rÃ¼ntÃ¼ gÃ¼venlik aÃ§Ä±klarÄ± taramasÄ± dahil olmak Ã¼zere Ã§oklu bulut K8s tek bir gÃ¶rÃ¼nÃ¼m saÄŸlayan K8s aÃ§Ä±k kaynaklÄ± bir aracÄ±dÄ±r. Kubescape, K8s kÃ¼melerini, YAML dosyalarÄ±nÄ± ve HELM grafiklerini tarar, birden fazla Ã§erÃ§eveye (Ã¶rneÄŸin, [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) , [MITRE ATT\&CKÂ®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)) gÃ¶re yanlÄ±ÅŸ yapÄ±landÄ±rmalarÄ±, yazÄ±lÄ±m gÃ¼venlik aÃ§Ä±klarÄ±nÄ± ve RBAC (rol tabanlÄ± eriÅŸim kontrolÃ¼) ihlallerini CI/CD boru hattÄ±nÄ±n erken aÅŸamalarÄ±nda tespit eder, risk puanÄ±nÄ± anÄ±nda hesaplar ve zaman iÃ§indeki risk eÄŸilimlerini gÃ¶sterir.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

AraÃ§ [**kube-bench**](https://github.com/aquasecurity/kube-bench), Kubernetes'in gÃ¼venli bir ÅŸekilde daÄŸÄ±tÄ±lÄ±p daÄŸÄ±tÄ±lmadÄ±ÄŸÄ±nÄ± kontrol eden bir araÃ§tÄ±r ve [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) belgelerinde yer alan kontrolleri Ã§alÄ±ÅŸtÄ±rÄ±r.\
ÅunlarÄ± seÃ§ebilirsiniz:

* kube-bench'i bir konteynerin iÃ§inde Ã§alÄ±ÅŸtÄ±rmak (ana bilgisayarla PID ad alanÄ±nÄ± paylaÅŸarak)
* ana bilgisayarda kube-bench'i kuran bir konteyner Ã§alÄ±ÅŸtÄ±rmak ve ardÄ±ndan kube-bench'i doÄŸrudan ana bilgisayarda Ã§alÄ±ÅŸtÄ±rmak
* [Releases sayfasÄ±ndan](https://github.com/aquasecurity/kube-bench/releases) en son ikili dosyalarÄ± kurmak,
* kaynaktan derlemek.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

AraÃ§ [**kubeaudit**](https://github.com/Shopify/kubeaudit), Ã§eÅŸitli gÃ¼venlik endiÅŸeleri iÃ§in **Kubernetes kÃ¼melerini denetlemek** amacÄ±yla bir komut satÄ±rÄ± aracÄ± ve bir Go paketidir.

Kubeaudit, bir kÃ¼medeki bir konteyner iÃ§inde Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± tespit edebilir. EÄŸer Ã¶yleyse, o kÃ¼medeki tÃ¼m Kubernetes kaynaklarÄ±nÄ± denetlemeye Ã§alÄ±ÅŸacaktÄ±r:
```
kubeaudit all
```
Bu araÃ§ ayrÄ±ca `autofix` argÃ¼manÄ±na sahiptir **tespit edilen sorunlarÄ± otomatik olarak dÃ¼zeltmek iÃ§in.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

AraÃ§ [**kube-hunter**](https://github.com/aquasecurity/kube-hunter), Kubernetes kÃ¼melerindeki gÃ¼venlik zayÄ±flÄ±klarÄ±nÄ± avlar. AraÃ§, Kubernetes ortamlarÄ±ndaki gÃ¼venlik sorunlarÄ± iÃ§in farkÄ±ndalÄ±ÄŸÄ± ve gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ artÄ±rmak amacÄ±yla geliÅŸtirilmiÅŸtir.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei), kullanÄ±cÄ±larÄ±n Kubernetes kÃ¼melerinin doÄŸru ve anlÄ±k risk deÄŸerlendirmesini almasÄ±na olanak tanÄ±yan bir gÃ¼venlik aÃ§Ä±ÄŸÄ± tarama ve CIS Docker benchmark aracÄ±dÄ±r. Kubei, bir Kubernetes kÃ¼mesinde kullanÄ±lan tÃ¼m gÃ¶rÃ¼ntÃ¼leri, uygulama pod'larÄ± ve sistem pod'larÄ± dahil olmak Ã¼zere tarar.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan), Kubernetes'in Rol tabanlÄ± eriÅŸim kontrolÃ¼ (RBAC) yetkilendirme modelinde riskli izinler iÃ§in Kubernetes kÃ¼mesini tarayan bir araÃ§tÄ±r.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit), diÄŸer araÃ§larla karÅŸÄ±laÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda yÃ¼ksek riskli kontrollerin test edilmesi iÃ§in oluÅŸturulmuÅŸ bir araÃ§tÄ±r. Temelde 3 farklÄ± moda sahiptir:

* **`find-role-relationships`**: Hangi AWS rollerinin hangi pod'larda Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± bulur.
* **`find-secrets`**: Pod'lar, ConfigMap'ler ve Secrets gibi K8s kaynaklarÄ±nda gizli bilgileri tanÄ±mlamaya Ã§alÄ±ÅŸÄ±r.
* **`test-imds-access`**: Pod'larÄ± Ã§alÄ±ÅŸtÄ±rmaya ve metadata v1 ve v2'ye eriÅŸmeye Ã§alÄ±ÅŸÄ±r. UYARI: Bu, kÃ¼mede bir pod Ã§alÄ±ÅŸtÄ±racaktÄ±r, dikkatli olun Ã§Ã¼nkÃ¼ bunu yapmak istemiyor olabilirsiniz!

## **Audit IaC Code**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye), canlÄ± Kubernetes kÃ¼mesini tarayan ve **daÄŸÄ±tÄ±lan kaynaklar ve yapÄ±landÄ±rmalarla ilgili potansiyel sorunlarÄ± raporlayan** bir yardÄ±mcÄ± programdÄ±r. DaÄŸÄ±tÄ±lanlara gÃ¶re kÃ¼menizi temizler ve disk Ã¼zerinde bulunanlara gÃ¶re deÄŸil. KÃ¼menizi tarayarak, yanlÄ±ÅŸ yapÄ±landÄ±rmalarÄ± tespit eder ve en iyi uygulamalarÄ±n yerinde olmasÄ±nÄ± saÄŸlamanÄ±za yardÄ±mcÄ± olur, bÃ¶ylece gelecekteki baÅŸ aÄŸrÄ±larÄ±nÄ± Ã¶nler. AyrÄ±ca, kÃ¼meniz bir metric-server kullanÄ±yorsa, potansiyel kaynaklarÄ±n aÅŸÄ±rÄ±/az tahsislerini raporlar ve kÃ¼meniz kapasiteyi aÅŸarsa sizi uyarmaya Ã§alÄ±ÅŸÄ±r.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics), aÅŸaÄŸÄ±daki **Infrastructure as Code Ã§Ã¶zÃ¼mlerinde** **gÃ¼venlik aÃ§Ä±klarÄ±**, uyum sorunlarÄ± ve altyapÄ± yanlÄ±ÅŸ yapÄ±landÄ±rmalarÄ±nÄ± bulur: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM ve OpenAPI 3.0 spesifikasyonlarÄ±.

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov), altyapÄ±-as-code iÃ§in statik kod analizi aracÄ±dÄ±r.

[Terraform](https://terraform.io), Terraform planÄ±, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) veya [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) kullanÄ±larak saÄŸlanan bulut altyapÄ±sÄ±nÄ± tarar ve grafik tabanlÄ± tarama kullanarak gÃ¼venlik ve uyum yanlÄ±ÅŸ yapÄ±landÄ±rmalarÄ±nÄ± tespit eder.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score), Kubernetes nesne tanÄ±mlarÄ±nÄ±zÄ±n statik kod analizini gerÃ§ekleÅŸtiren bir araÃ§tÄ±r.

Kurmak iÃ§in:

| DaÄŸÄ±tÄ±m                                            | Komut / BaÄŸlantÄ±                                                                          |
| --------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| macOS, Linux ve Windows iÃ§in Ã¶nceden derlenmiÅŸ ikililer | [GitHub sÃ¼rÃ¼mleri](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub](https://hub.docker.com/r/zegl/kube-score/)) |
| Homebrew (macOS ve Linux)                          | `brew install kube-score`                                                                 |
| [Krew](https://krew.sigs.k8s.io/) (macOS ve Linux) | `kubectl krew install score`                                                              |

## Ä°puÃ§larÄ±

### Kubernetes PodSecurityContext ve SecurityContext

**Pod'larÄ±n gÃ¼venlik baÄŸlamÄ±nÄ±** ( _PodSecurityContext_ ile) ve Ã§alÄ±ÅŸtÄ±rÄ±lacak **konteynerlerin** gÃ¼venlik baÄŸlamÄ±nÄ± ( _SecurityContext_ ile) yapÄ±landÄ±rabilirsiniz. Daha fazla bilgi iÃ§in okuyun:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes API GÃ¼Ã§lendirme

Kubernetes Api Sunucusuna **eriÅŸimi korumak** Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ yeterli ayrÄ±calÄ±klara sahip kÃ¶tÃ¼ niyetli bir aktÃ¶r bunu kÃ¶tÃ¼ye kullanabilir ve ortamda birÃ§ok ÅŸekilde zarar verebilir.\
Hem **eriÅŸimi** (API Sunucusuna eriÅŸim iÃ§in **beyaz liste** kÃ¶kenleri ve diÄŸer tÃ¼m baÄŸlantÄ±larÄ± reddetmek) hem de [**kimlik doÄŸrulama**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) ( **en az ayrÄ±calÄ±k** ilkesini izleyerek) gÃ¼vence altÄ±na almak Ã¶nemlidir. Ve kesinlikle **asla** **anonim** **isteklere** **izin vermeyin**.

**Ortak Ä°stek sÃ¼reci:**\
KullanÄ±cÄ± veya K8s ServiceAccount â€“> Kimlik DoÄŸrulama â€“> Yetkilendirme â€“> Kabul KontrolÃ¼.

**Ä°puÃ§larÄ±**:

* PortlarÄ± kapatÄ±n.
* Anonim eriÅŸimi Ã¶nleyin.
* NodeRestriction; Belirli dÃ¼ÄŸÃ¼mlerden API'ye eriÅŸimi engelleyin.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Temelde, kubelet'lerin node-restriction.kubernetes.io/ Ã¶n eki ile etiket eklemesini/Ã§Ä±karmasÄ±nÄ±/gÃ¼ncellemesini engeller. Bu etiket Ã¶n eki, yÃ¶neticilerin Node nesnelerini iÅŸ yÃ¼kÃ¼ izolasyonu amacÄ±yla etiketlemesi iÃ§in ayrÄ±lmÄ±ÅŸtÄ±r ve kubelet'lerin bu Ã¶n ekle etiketleri deÄŸiÅŸtirmesine izin verilmeyecektir.
* AyrÄ±ca, kubelet'lerin bu etiketleri ve etiket Ã¶n eklerini eklemesine/Ã§Ä±karmasÄ±na/gÃ¼ncellemesine izin verir.
* Etiketlerle gÃ¼venli iÅŸ yÃ¼kÃ¼ izolasyonunu saÄŸlayÄ±n.
* Belirli pod'larÄ±n API eriÅŸimini engelleyin.
* ApiServer'Ä±n internete maruz kalmasÄ±nÄ± Ã¶nleyin.
* Yetkisiz eriÅŸim RBAC'sÄ±nÄ± Ã¶nleyin.
* ApiServer portunu gÃ¼venlik duvarÄ± ve IP beyaz listesi ile koruyun.

### SecurityContext GÃ¼Ã§lendirme

VarsayÄ±lan olarak, baÅŸka bir kullanÄ±cÄ± belirtilmediÄŸinde bir Pod baÅŸlatÄ±ldÄ±ÄŸÄ±nda root kullanÄ±cÄ±sÄ± kullanÄ±lacaktÄ±r. UygulamanÄ±zÄ± daha gÃ¼venli bir baÄŸlamda Ã§alÄ±ÅŸtÄ±rmak iÃ§in aÅŸaÄŸÄ±daki gibi bir ÅŸablon kullanabilirsiniz:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Genel GÃ¼Ã§lendirme

Kubernetes ortamÄ±nÄ±zÄ±, aÅŸaÄŸÄ±dakilere sahip olmak iÃ§in gerektiÄŸi sÄ±klÄ±kta gÃ¼ncellemelisiniz:

* BaÄŸÄ±mlÄ±lÄ±klarÄ±n gÃ¼ncel olmasÄ±.
* Hata ve gÃ¼venlik yamalarÄ±.

[**SÃ¼rÃ¼m dÃ¶ngÃ¼leri**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Her 3 ayda bir yeni bir kÃ¼Ã§Ã¼k sÃ¼rÃ¼m Ã§Ä±kar -- 1.20.3 = 1(BÃ¼yÃ¼k).20(KÃ¼Ã§Ã¼k).3(yama)

**Kubernetes KÃ¼mesini gÃ¼ncellemenin en iyi yolu (ÅŸuradan** [**buraya**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Master Node bileÅŸenlerini ÅŸu sÄ±rayla yÃ¼kseltin:
* etcd (tÃ¼m Ã¶rnekler).
* kube-apiserver (tÃ¼m kontrol dÃ¼zlemi sunucularÄ±).
* kube-controller-manager.
* kube-scheduler.
* bir tane kullanÄ±yorsanÄ±z cloud controller manager.
* kube-proxy, kubelet gibi Worker Node bileÅŸenlerini yÃ¼kseltin.

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
