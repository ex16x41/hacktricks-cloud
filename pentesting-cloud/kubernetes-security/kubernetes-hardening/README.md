# Kubernetes Hardening

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åˆ†æé›†ç¾¤çš„å·¥å…·

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) æ˜¯ä¸€ä¸ª K8s å¼€æºå·¥å…·ï¼Œæä¾›å¤šäº‘ K8s å•ä¸€è§†å›¾ï¼ŒåŒ…æ‹¬é£é™©åˆ†æã€å®‰å…¨åˆè§„ã€RBAC å¯è§†åŒ–å’Œé•œåƒæ¼æ´æ‰«æã€‚Kubescape æ‰«æ K8s é›†ç¾¤ã€YAML æ–‡ä»¶å’Œ HELM å›¾è¡¨ï¼Œæ ¹æ®å¤šä¸ªæ¡†æ¶ï¼ˆå¦‚ [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) ã€[MITRE ATT\&CKÂ®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)ï¼‰æ£€æµ‹é”™è¯¯é…ç½®ã€è½¯ä»¶æ¼æ´å’Œ RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰è¿è§„ï¼Œè®¡ç®—é£é™©è¯„åˆ†å¹¶å³æ—¶æ˜¾ç¤ºé£é™©è¶‹åŠ¿ã€‚
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

å·¥å…· [**kube-bench**](https://github.com/aquasecurity/kube-bench) æ˜¯ä¸€ä¸ªé€šè¿‡è¿è¡Œ [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) ä¸­è®°å½•çš„æ£€æŸ¥æ¥æ£€æŸ¥ Kubernetes æ˜¯å¦å®‰å…¨éƒ¨ç½²çš„å·¥å…·ã€‚\
æ‚¨å¯ä»¥é€‰æ‹©ï¼š

* ä»å®¹å™¨å†…éƒ¨è¿è¡Œ kube-benchï¼ˆä¸ä¸»æœºå…±äº« PID å‘½åç©ºé—´ï¼‰
* è¿è¡Œä¸€ä¸ªåœ¨ä¸»æœºä¸Šå®‰è£… kube-bench çš„å®¹å™¨ï¼Œç„¶åç›´æ¥åœ¨ä¸»æœºä¸Šè¿è¡Œ kube-bench
* ä» [Releases page](https://github.com/aquasecurity/kube-bench/releases) å®‰è£…æœ€æ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ
* ä»æºä»£ç ç¼–è¯‘ã€‚

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

å·¥å…· [**kubeaudit**](https://github.com/Shopify/kubeaudit) æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·å’Œ Go åŒ…ï¼Œç”¨äº **å®¡è®¡ Kubernetes é›†ç¾¤** çš„å„ç§å®‰å…¨é—®é¢˜ã€‚

Kubeaudit å¯ä»¥æ£€æµ‹å®ƒæ˜¯å¦åœ¨é›†ç¾¤ä¸­çš„å®¹å™¨å†…è¿è¡Œã€‚å¦‚æœæ˜¯ï¼Œå®ƒå°†å°è¯•å®¡è®¡è¯¥é›†ç¾¤ä¸­çš„æ‰€æœ‰ Kubernetes èµ„æºï¼š
```
kubeaudit all
```
è¯¥å·¥å…·è¿˜å…·æœ‰å‚æ•° `autofix` ä»¥ **è‡ªåŠ¨ä¿®å¤æ£€æµ‹åˆ°çš„é—®é¢˜ã€‚**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

è¯¥å·¥å…· [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) ç”¨äºå¯»æ‰¾ Kubernetes é›†ç¾¤ä¸­çš„å®‰å…¨å¼±ç‚¹ã€‚è¯¥å·¥å…·çš„å¼€å‘æ—¨åœ¨æé«˜å¯¹ Kubernetes ç¯å¢ƒä¸­å®‰å…¨é—®é¢˜çš„æ„è¯†å’Œå¯è§æ€§ã€‚
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) æ˜¯ä¸€ä¸ªæ¼æ´æ‰«æå’ŒCIS DockeråŸºå‡†å·¥å…·ï¼Œå…è®¸ç”¨æˆ·å¯¹å…¶Kubernetesé›†ç¾¤è¿›è¡Œå‡†ç¡®å’Œå³æ—¶çš„é£é™©è¯„ä¼°ã€‚Kubeiæ‰«æKubernetesé›†ç¾¤ä¸­ä½¿ç”¨çš„æ‰€æœ‰é•œåƒï¼ŒåŒ…æ‹¬åº”ç”¨ç¨‹åºPodå’Œç³»ç»ŸPodçš„é•œåƒã€‚

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) æ˜¯ä¸€ä¸ªç”¨äºæ‰«æKubernetesé›†ç¾¤ä¸­KubernetesåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰æˆæƒæ¨¡å‹ä¸­é£é™©æƒé™çš„å·¥å…·ã€‚

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºæµ‹è¯•ä¸å…¶ä»–å·¥å…·ç›¸æ¯”çš„å…¶ä»–é«˜é£é™©æ£€æŸ¥ã€‚å®ƒä¸»è¦æœ‰3ç§ä¸åŒçš„æ¨¡å¼ï¼š

* **`find-role-relationships`**: æ‰¾å‡ºå“ªäº›AWSè§’è‰²æ­£åœ¨è¿è¡Œåœ¨å“ªäº›Podä¸­
* **`find-secrets`**: å°è¯•è¯†åˆ«K8sèµ„æºä¸­çš„ç§˜å¯†ï¼Œä¾‹å¦‚Podsã€ConfigMapså’ŒSecretsã€‚
* **`test-imds-access`**: å°è¯•è¿è¡ŒPodå¹¶è®¿é—®å…ƒæ•°æ®v1å’Œv2ã€‚è­¦å‘Šï¼šè¿™å°†åœ¨é›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªPodï¼Œè¯·éå¸¸å°å¿ƒï¼Œå› ä¸ºæ‚¨å¯èƒ½ä¸æƒ³è¿™æ ·åšï¼

## **å®¡è®¡IaCä»£ç **

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) æ˜¯ä¸€ä¸ªå®ç”¨å·¥å…·ï¼Œæ‰«æå®æ—¶Kubernetesé›†ç¾¤å¹¶**æŠ¥å‘Šå·²éƒ¨ç½²èµ„æºå’Œé…ç½®çš„æ½œåœ¨é—®é¢˜**ã€‚å®ƒæ ¹æ®å·²éƒ¨ç½²çš„å†…å®¹è€Œä¸æ˜¯ç£ç›˜ä¸Šçš„å†…å®¹æ¥æ¸…ç†æ‚¨çš„é›†ç¾¤ã€‚é€šè¿‡æ‰«ææ‚¨çš„é›†ç¾¤ï¼Œå®ƒæ£€æµ‹é…ç½®é”™è¯¯å¹¶å¸®åŠ©æ‚¨ç¡®ä¿æœ€ä½³å®è·µåˆ°ä½ï¼Œä»è€Œé˜²æ­¢æœªæ¥çš„éº»çƒ¦ã€‚å®ƒæ—¨åœ¨å‡å°‘åœ¨å®é™…æ“ä½œKubernetesé›†ç¾¤æ—¶é¢ä¸´çš„è®¤çŸ¥è´Ÿæ‹…ã€‚æ­¤å¤–ï¼Œå¦‚æœæ‚¨çš„é›†ç¾¤ä½¿ç”¨äº†åº¦é‡æœåŠ¡å™¨ï¼Œå®ƒä¼šæŠ¥å‘Šæ½œåœ¨çš„èµ„æºè¿‡åº¦/ä¸è¶³åˆ†é…ï¼Œå¹¶å°è¯•åœ¨æ‚¨çš„é›†ç¾¤å®¹é‡ä¸è¶³æ—¶è­¦å‘Šæ‚¨ã€‚

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) åœ¨ä»¥ä¸‹**åŸºç¡€è®¾æ–½å³ä»£ç è§£å†³æ–¹æ¡ˆ**ä¸­å‘ç°**å®‰å…¨æ¼æ´**ã€åˆè§„æ€§é—®é¢˜å’ŒåŸºç¡€è®¾æ–½é…ç½®é”™è¯¯ï¼šTerraformã€Kubernetesã€Dockerã€AWS CloudFormationã€Ansibleã€Helmã€Microsoft ARMå’ŒOpenAPI 3.0è§„èŒƒ

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) æ˜¯ä¸€ä¸ªåŸºç¡€è®¾æ–½å³ä»£ç çš„é™æ€ä»£ç åˆ†æå·¥å…·ã€‚

å®ƒæ‰«æä½¿ç”¨[Terraform](https://terraform.io)æä¾›çš„äº‘åŸºç¡€è®¾æ–½ã€Terraformè®¡åˆ’ã€[Cloudformation](https://aws.amazon.com/cloudformation/)ã€[AWS SAM](https://aws.amazon.com/serverless/sam/)ã€[Kubernetes](https://kubernetes.io)ã€[Dockerfile](https://www.docker.com)ã€[Serverless](https://www.serverless.com)æˆ–[ARMæ¨¡æ¿](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview)ï¼Œå¹¶ä½¿ç”¨åŸºäºå›¾å½¢çš„æ‰«ææ£€æµ‹å®‰å…¨å’Œåˆè§„æ€§é…ç½®é”™è¯¯ã€‚

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) æ˜¯ä¸€ä¸ªå¯¹æ‚¨çš„Kuberneteså¯¹è±¡å®šä¹‰è¿›è¡Œé™æ€ä»£ç åˆ†æçš„å·¥å…·ã€‚

è¦å®‰è£…ï¼š

| å‘è¡Œç‰ˆ                                            | å‘½ä»¤ / é“¾æ¥                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| macOSã€Linuxå’ŒWindowsçš„é¢„æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶            | [GitHubå‘å¸ƒ](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub](https://hub.docker.com/r/zegl/kube-score/)) |
| Homebrewï¼ˆmacOSå’ŒLinuxï¼‰                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/)ï¼ˆmacOSå’ŒLinuxï¼‰ | `kubectl krew install score`                                                            |

## æç¤º

### Kubernetes PodSecurityContextå’ŒSecurityContext

æ‚¨å¯ä»¥é…ç½®**Podsçš„å®‰å…¨ä¸Šä¸‹æ–‡**ï¼ˆä½¿ç”¨_PodSecurityContext_ï¼‰å’Œå°†è¦è¿è¡Œçš„**å®¹å™¨**çš„å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨_SecurityContext_ï¼‰ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»ï¼š

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes APIåŠ å›º

ä¿æŠ¤å¯¹Kubernetes Api Serverçš„è®¿é—®éå¸¸é‡è¦ï¼Œå› ä¸ºå…·æœ‰è¶³å¤Ÿæƒé™çš„æ¶æ„è¡Œä¸ºè€…å¯èƒ½ä¼šæ»¥ç”¨å®ƒå¹¶ä»¥å¤šç§æ–¹å¼ç ´åç¯å¢ƒã€‚\
ç¡®ä¿**è®¿é—®**ï¼ˆ**ç™½åå•**è®¿é—®API Serverçš„æ¥æºå¹¶æ‹’ç»ä»»ä½•å…¶ä»–è¿æ¥ï¼‰å’Œ[**èº«ä»½éªŒè¯**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/)ï¼ˆéµå¾ª**æœ€å°****æƒé™**åŸåˆ™ï¼‰éƒ½å¾ˆé‡è¦ã€‚å¹¶ä¸”ç»å¯¹**æ°¸è¿œ****ä¸å…è®¸****åŒ¿å****è¯·æ±‚**ã€‚

**å¸¸è§è¯·æ±‚æµç¨‹ï¼š**\
ç”¨æˆ·æˆ–K8s ServiceAccount â€“> èº«ä»½éªŒè¯ â€“> æˆæƒ â€“> å½•å–æ§åˆ¶ã€‚

**æç¤º**ï¼š

* å…³é—­ç«¯å£ã€‚
* é¿å…åŒ¿åè®¿é—®ã€‚
* NodeRestrictionï¼›ä¸å…è®¸ç‰¹å®šèŠ‚ç‚¹è®¿é—®APIã€‚
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* åŸºæœ¬ä¸Šé˜²æ­¢kubeletsæ·»åŠ /åˆ é™¤/æ›´æ–°å¸¦æœ‰node-restriction.kubernetes.io/å‰ç¼€çš„æ ‡ç­¾ã€‚æ­¤æ ‡ç­¾å‰ç¼€ä¿ç•™ç»™ç®¡ç†å‘˜ä¸ºå·¥ä½œè´Ÿè½½éš”ç¦»ç›®çš„æ ‡è®°å…¶èŠ‚ç‚¹å¯¹è±¡ï¼Œkubeletså°†ä¸è¢«å…è®¸ä¿®æ”¹å¸¦æœ‰è¯¥å‰ç¼€çš„æ ‡ç­¾ã€‚
* è¿˜å…è®¸kubeletsæ·»åŠ /åˆ é™¤/æ›´æ–°è¿™äº›æ ‡ç­¾å’Œæ ‡ç­¾å‰ç¼€ã€‚
* ç¡®ä¿é€šè¿‡æ ‡ç­¾å®ç°å®‰å…¨çš„å·¥ä½œè´Ÿè½½éš”ç¦»ã€‚
* é¿å…ç‰¹å®šPodè®¿é—®APIã€‚
* é¿å…ApiServeræš´éœ²åœ¨äº’è”ç½‘ä¸Šã€‚
* é¿å…æœªç»æˆæƒçš„è®¿é—®RBACã€‚
* ApiServerç«¯å£ä½¿ç”¨é˜²ç«å¢™å’ŒIPç™½åå•ã€‚

### SecurityContextåŠ å›º

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæœªæŒ‡å®šå…¶ä»–ç”¨æˆ·ï¼Œåˆ™åœ¨å¯åŠ¨Podæ—¶å°†ä½¿ç”¨rootç”¨æˆ·ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ç±»ä¼¼äºä»¥ä¸‹æ¨¡æ¿çš„æ–¹å¼åœ¨æ›´å®‰å…¨çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œæ‚¨çš„åº”ç”¨ç¨‹åºï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### ä¸€èˆ¬åŠ å›º

æ‚¨åº”è¯¥æ ¹æ®éœ€è¦é¢‘ç¹æ›´æ–°æ‚¨çš„Kubernetesç¯å¢ƒï¼Œä»¥ç¡®ä¿ï¼š

* ä¾èµ–é¡¹ä¿æŒæœ€æ–°ã€‚
* ä¿®å¤æ¼æ´å’Œå®‰å…¨è¡¥ä¸ã€‚

[**å‘å¸ƒå‘¨æœŸ**](https://kubernetes.io/docs/setup/release/version-skew-policy/): æ¯3ä¸ªæœˆä¼šæœ‰ä¸€ä¸ªæ–°çš„æ¬¡è¦ç‰ˆæœ¬ -- 1.20.3 = 1(ä¸»è¦).20(æ¬¡è¦).3(è¡¥ä¸)

**æ›´æ–°Kubernetesé›†ç¾¤çš„æœ€ä½³æ–¹æ³•æ˜¯ï¼ˆæ¥è‡ª** [**è¿™é‡Œ**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**ï¼‰ï¼š**

* æŒ‰ç…§ä»¥ä¸‹é¡ºåºå‡çº§ä¸»èŠ‚ç‚¹ç»„ä»¶ï¼š
* etcdï¼ˆæ‰€æœ‰å®ä¾‹ï¼‰ã€‚
* kube-apiserverï¼ˆæ‰€æœ‰æ§åˆ¶å¹³é¢ä¸»æœºï¼‰ã€‚
* kube-controller-managerã€‚
* kube-schedulerã€‚
* å¦‚æœä½¿ç”¨äº‘æ§åˆ¶å™¨ç®¡ç†å™¨ï¼Œåˆ™å‡çº§å®ƒã€‚
* å‡çº§å·¥ä½œèŠ‚ç‚¹ç»„ä»¶ï¼Œå¦‚kube-proxyã€kubeletã€‚

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
