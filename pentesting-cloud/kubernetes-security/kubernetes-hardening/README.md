# Kubernetes Hardening

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’åˆ†æã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) ã¯ã€ãƒªã‚¹ã‚¯åˆ†æã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã€RBACãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã€ã‚¤ãƒ¡ãƒ¼ã‚¸è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ã‚’å«ã‚€ãƒãƒ«ãƒã‚¯ãƒ©ã‚¦ãƒ‰K8sã®å˜ä¸€ã®ãƒ“ãƒ¥ãƒ¼ã‚’æä¾›ã™ã‚‹K8sã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Kubescapeã¯K8sã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã€YAMLãƒ•ã‚¡ã‚¤ãƒ«ã€HELMãƒãƒ£ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€è¤‡æ•°ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼ˆä¾‹ãˆã°ã€[NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo)ã€[MITRE ATT\&CKÂ®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)ï¼‰ã«å¾“ã£ã¦èª¤è¨­å®šã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®è„†å¼±æ€§ã€RBACï¼ˆãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼‰é•åã‚’CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®åˆæœŸæ®µéšã§æ¤œå‡ºã—ã€ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ã‚’å³åº§ã«è¨ˆç®—ã—ã€æ™‚é–“ã®çµŒéã«ä¼´ã†ãƒªã‚¹ã‚¯ã®å‚¾å‘ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

ãƒ„ãƒ¼ãƒ« [**kube-bench**](https://github.com/aquasecurity/kube-bench) ã¯ã€[**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) ã«è¨˜è¼‰ã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€Kubernetes ãŒå®‰å…¨ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚\
æ¬¡ã®æ–¹æ³•ã‚’é¸æŠã§ãã¾ã™ï¼š

* ã‚³ãƒ³ãƒ†ãƒŠå†…ã‹ã‚‰ kube-bench ã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆãƒ›ã‚¹ãƒˆã¨ PID åå‰ç©ºé–“ã‚’å…±æœ‰ï¼‰
* ãƒ›ã‚¹ãƒˆã« kube-bench ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œã—ã€ãã®å¾Œãƒ›ã‚¹ãƒˆä¸Šã§ç›´æ¥ kube-bench ã‚’å®Ÿè¡Œã™ã‚‹
* [Releases page](https://github.com/aquasecurity/kube-bench/releases) ã‹ã‚‰æœ€æ–°ã®ãƒã‚¤ãƒŠãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
* ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã€‚

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

ãƒ„ãƒ¼ãƒ« [**kubeaudit**](https://github.com/Shopify/kubeaudit) ã¯ã€ã•ã¾ã–ã¾ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µã«å¯¾ã—ã¦ **Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ç›£æŸ»** ã™ã‚‹ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ãŠã‚ˆã³ Go ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚

Kubeaudit ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’æ¤œå‡ºã§ãã¾ã™ã€‚ã‚‚ã—ãã†ã§ã‚ã‚Œã°ã€ãã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ã™ã¹ã¦ã® Kubernetes ãƒªã‚½ãƒ¼ã‚¹ã‚’ç›£æŸ»ã—ã‚ˆã†ã¨ã—ã¾ã™ï¼š
```
kubeaudit all
```
ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¯ã€æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã‚’**è‡ªå‹•çš„ã«ä¿®æ­£ã™ã‚‹**ãŸã‚ã®å¼•æ•°`autofix`ã‚‚ã‚ã‚Šã¾ã™ã€‚

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

ãƒ„ãƒ¼ãƒ«[**kube-hunter**](https://github.com/aquasecurity/kube-hunter)ã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å¼±ç‚¹ã‚’æ¢ã—ã¾ã™ã€‚ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€Kubernetesç’°å¢ƒã«ãŠã‘ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã¸ã®èªè­˜ã¨å¯è¦–æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã«é–‹ç™ºã•ã‚Œã¾ã—ãŸã€‚
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã® Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®æ­£ç¢ºã§å³æ™‚ã®ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’å¾—ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ãŠã‚ˆã³ CIS Docker ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Kubei ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒãƒ‰ãŠã‚ˆã³ã‚·ã‚¹ãƒ†ãƒ ãƒãƒƒãƒ‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å«ã‚€ã€Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™ã€‚

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) ã¯ã€Kubernetes ã®ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ (RBAC) èªå¯ãƒ¢ãƒ‡ãƒ«ã«ãŠã‘ã‚‹ãƒªã‚¹ã‚¯ã®ã‚ã‚‹æ¨©é™ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) ã¯ã€ä»–ã®ãƒ„ãƒ¼ãƒ«ã¨æ¯”è¼ƒã—ã¦é«˜ãƒªã‚¹ã‚¯ãƒã‚§ãƒƒã‚¯ã®ä»–ã®ã‚¿ã‚¤ãƒ—ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«æ§‹ç¯‰ã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ä¸»ã« 3 ã¤ã®ç•°ãªã‚‹ãƒ¢ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ï¼š

* **`find-role-relationships`**: ã©ã® AWS ãƒ­ãƒ¼ãƒ«ãŒã©ã®ãƒãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã‚’è¦‹ã¤ã‘ã¾ã™
* **`find-secrets`**: Podsã€ConfigMapsã€Secrets ãªã©ã® K8s ãƒªã‚½ãƒ¼ã‚¹å†…ã®ç§˜å¯†ã‚’ç‰¹å®šã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚
* **`test-imds-access`**: ãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ v1 ãŠã‚ˆã³ v2 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚è­¦å‘Šï¼šã“ã‚Œã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§ãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã®ã§ã€æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã‚’è¡Œã„ãŸããªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼

## **IaC ã‚³ãƒ¼ãƒ‰ã®ç›£æŸ»**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) ã¯ã€ãƒ©ã‚¤ãƒ– Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€**ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã¨æ§‹æˆã«é–¢ã™ã‚‹æ½œåœ¨çš„ãªå•é¡Œã‚’å ±å‘Šã™ã‚‹**ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§ã™ã€‚ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã«ã‚ã‚‹ã‚‚ã®ã§ã¯ãªãã€ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‚‚ã®ã«åŸºã¥ã„ã¦ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã“ã¨ã§ã€èª¤ã£ãŸæ§‹æˆã‚’æ¤œå‡ºã—ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ãŒç¢ºç«‹ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã®ã«å½¹ç«‹ã¡ã€å°†æ¥ã®é ­ç—›ã‚’é˜²ãã¾ã™ã€‚Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’é‹ç”¨ã™ã‚‹éš›ã®èªçŸ¥çš„è² è·ã‚’è»½æ¸›ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚ã•ã‚‰ã«ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ãƒªã‚½ãƒ¼ã‚¹ã®éå‰°/ä¸è¶³å‰²ã‚Šå½“ã¦ã‚’å ±å‘Šã—ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒå®¹é‡ä¸è¶³ã«ãªã‚‹å ´åˆã«è­¦å‘Šã‚’è©¦ã¿ã¾ã™ã€‚

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) ã¯ã€ä»¥ä¸‹ã® **Infrastructure as Code ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³** ã«ãŠã‘ã‚‹ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§**ã€ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã®å•é¡Œã€ãŠã‚ˆã³ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®èª¤è¨­å®šã‚’è¦‹ã¤ã‘ã¾ã™ï¼šTerraformã€Kubernetesã€Dockerã€AWS CloudFormationã€Ansibleã€Helmã€Microsoft ARMã€ãŠã‚ˆã³ OpenAPI 3.0 ä»•æ§˜

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) ã¯ã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã¨ã—ã¦ã®ã‚³ãƒ¼ãƒ‰ã®ãŸã‚ã®é™çš„ã‚³ãƒ¼ãƒ‰åˆ†æãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

[Terraform](https://terraform.io)ã€Terraform ãƒ—ãƒ©ãƒ³ã€[Cloudformation](https://aws.amazon.com/cloudformation/)ã€[AWS SAM](https://aws.amazon.com/serverless/sam/)ã€[Kubernetes](https://kubernetes.io)ã€[Dockerfile](https://www.docker.com)ã€[Serverless](https://www.serverless.com) ã¾ãŸã¯ [ARM ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€ã‚°ãƒ©ãƒ•ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŠã‚ˆã³ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã®èª¤è¨­å®šã‚’æ¤œå‡ºã—ã¾ã™ã€‚

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) ã¯ã€Kubernetes ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå®šç¾©ã®é™çš„ã‚³ãƒ¼ãƒ‰åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ï¼š

| ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³                                        | ã‚³ãƒãƒ³ãƒ‰ / ãƒªãƒ³ã‚¯                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| macOSã€Linuxã€Windows ç”¨ã®ãƒ—ãƒªãƒ“ãƒ«ãƒ‰ãƒã‚¤ãƒŠãƒª    | [GitHub ãƒªãƒªãƒ¼ã‚¹](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS ãŠã‚ˆã³ Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS ãŠã‚ˆã³ Linux) | `kubectl krew install score`                                                            |

## ãƒ’ãƒ³ãƒˆ

### Kubernetes PodSecurityContext ã¨ SecurityContext

**Pod ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ** (_PodSecurityContext_) ã¨å®Ÿè¡Œã•ã‚Œã‚‹ **ã‚³ãƒ³ãƒ†ãƒŠ** ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ (_SecurityContext_) ã‚’æ§‹æˆã§ãã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€æ¬¡ã‚’ãŠèª­ã¿ãã ã•ã„ï¼š

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes API ãƒãƒ¼ãƒ‰ãƒ‹ãƒ³ã‚°

Kubernetes Api Server ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’**ä¿è­·ã™ã‚‹ã“ã¨**ã¯éå¸¸ã«é‡è¦ã§ã™ã€‚ååˆ†ãªæ¨©é™ã‚’æŒã¤æ‚ªæ„ã®ã‚ã‚‹ã‚¢ã‚¯ã‚¿ãƒ¼ãŒãã‚Œã‚’æ‚ªç”¨ã—ã€ç’°å¢ƒã«å¤šãã®æ–¹æ³•ã§æå®³ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\
**ã‚¢ã‚¯ã‚»ã‚¹**ï¼ˆAPI ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã‚ªãƒªã‚¸ãƒ³ã‚’ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã—ã€ä»–ã®æ¥ç¶šã‚’æ‹’å¦ã™ã‚‹ï¼‰ã¨ [**èªè¨¼**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/)ï¼ˆ**æœ€å°é™ã®æ¨©é™**ã®åŸå‰‡ã«å¾“ã†ï¼‰ã‚’ç¢ºä¿ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ãã—ã¦ã€**æ±ºã—ã¦** **åŒ¿å** **ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã—ãªã„**ã“ã¨ãŒé‡è¦ã§ã™ã€‚

**ä¸€èˆ¬çš„ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹ï¼š**\
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ K8s ServiceAccount â€“> èªè¨¼ â€“> èªå¯ â€“> å—ã‘å…¥ã‚Œåˆ¶å¾¡ã€‚

**ãƒ’ãƒ³ãƒˆ**ï¼š

* ãƒãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹ã€‚
* åŒ¿åã‚¢ã‚¯ã‚»ã‚¹ã‚’é¿ã‘ã‚‹ã€‚
* NodeRestriction; ç‰¹å®šã®ãƒãƒ¼ãƒ‰ã‹ã‚‰ API ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã™ã‚‹ã€‚
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* åŸºæœ¬çš„ã«ã€kubelet ãŒ node-restriction.kubernetes.io/ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒã¤ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ /å‰Šé™¤/æ›´æ–°ã™ã‚‹ã®ã‚’é˜²ãã¾ã™ã€‚ã“ã®ãƒ©ãƒ™ãƒ«ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯ã€ç®¡ç†è€…ãŒãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã®åˆ†é›¢ç›®çš„ã§ãƒãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ©ãƒ™ãƒ«ã‚’ä»˜ã‘ã‚‹ãŸã‚ã«äºˆç´„ã•ã‚Œã¦ãŠã‚Šã€kubelet ã¯ãã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒã¤ãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã¯è¨±å¯ã•ã‚Œã¾ã›ã‚“ã€‚
* ã¾ãŸã€kubelet ãŒã“ã‚Œã‚‰ã®ãƒ©ãƒ™ãƒ«ãŠã‚ˆã³ãƒ©ãƒ™ãƒ«ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ /å‰Šé™¤/æ›´æ–°ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã¾ã™ã€‚
* ãƒ©ãƒ™ãƒ«ã‚’ä½¿ç”¨ã—ã¦å®‰å…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã®åˆ†é›¢ã‚’ç¢ºä¿ã—ã¾ã™ã€‚
* ç‰¹å®šã®ãƒãƒƒãƒ‰ãŒ API ã‚¢ã‚¯ã‚»ã‚¹ã‚’é¿ã‘ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
* ApiServer ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«ã•ã‚‰ã•ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚
* èªå¯ã•ã‚Œã¦ã„ãªã„ã‚¢ã‚¯ã‚»ã‚¹ RBAC ã‚’é¿ã‘ã¾ã™ã€‚
* ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã¨ IP ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ãŸ ApiServer ãƒãƒ¼ãƒˆã€‚

### SecurityContext ãƒãƒ¼ãƒ‰ãƒ‹ãƒ³ã‚°

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒãƒƒãƒ‰ãŒé–‹å§‹ã•ã‚Œã‚‹ã¨ root ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚æ¬¡ã®ã‚ˆã†ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€ã‚ˆã‚Šå®‰å…¨ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã¾ã™ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### ä¸€èˆ¬çš„ãªãƒãƒ¼ãƒ‰ãƒ‹ãƒ³ã‚°

Kubernetes ç’°å¢ƒã¯ã€æ¬¡ã®ã“ã¨ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã«å¿…è¦ã«å¿œã˜ã¦é »ç¹ã«æ›´æ–°ã™ã‚‹ã¹ãã§ã™ï¼š

* ä¾å­˜é–¢ä¿‚ã‚’æœ€æ–°ã®çŠ¶æ…‹ã«ä¿ã¤ã€‚
* ãƒã‚°ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã€‚

[**ãƒªãƒªãƒ¼ã‚¹ã‚µã‚¤ã‚¯ãƒ«**](https://kubernetes.io/docs/setup/release/version-skew-policy/): 3ãƒ¶æœˆã”ã¨ã«æ–°ã—ã„ãƒã‚¤ãƒŠãƒ¼ãƒªãƒªãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ -- 1.20.3 = 1(ãƒ¡ã‚¸ãƒ£ãƒ¼).20(ãƒã‚¤ãƒŠãƒ¼).3(ãƒ‘ãƒƒãƒ)

**Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ›´æ–°ã™ã‚‹æœ€è‰¯ã®æ–¹æ³•ã¯ (ã“ã¡ã‚‰ã‹ã‚‰)** [**ã“ã¡ã‚‰**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**ã§ã™ï¼š**

* æ¬¡ã®é †åºã§ãƒã‚¹ã‚¿ãƒ¼ãƒãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ï¼š
* etcd (ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹)ã€‚
* kube-apiserver (ã™ã¹ã¦ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ›ã‚¹ãƒˆ)ã€‚
* kube-controller-managerã€‚
* kube-schedulerã€‚
* ã‚¯ãƒ©ã‚¦ãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆï¼‰ã€‚
* kube-proxyã€kubelet ãªã©ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

{% hint style="success" %}
AWS ãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP ãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
