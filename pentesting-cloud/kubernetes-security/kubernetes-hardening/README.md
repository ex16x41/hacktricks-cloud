# Kubernetes Hardening

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Ferramentas para analisar um cluster

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) √© uma ferramenta open-source K8s que fornece uma vis√£o √∫nica multi-cloud do K8s, incluindo an√°lise de risco, conformidade de seguran√ßa, visualizador de RBAC e verifica√ß√£o de vulnerabilidades de imagem. O Kubescape escaneia clusters K8s, arquivos YAML e gr√°ficos HELM, detectando configura√ß√µes incorretas de acordo com m√∫ltiplas estruturas (como a [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), vulnerabilidades de software e viola√ß√µes de RBAC (controle de acesso baseado em fun√ß√£o) nas primeiras etapas do pipeline CI/CD, calcula a pontua√ß√£o de risco instantaneamente e mostra tend√™ncias de risco ao longo do tempo.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

A ferramenta [**kube-bench**](https://github.com/aquasecurity/kube-bench) √© uma ferramenta que verifica se o Kubernetes est√° implantado de forma segura, executando as verifica√ß√µes documentadas no [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Voc√™ pode escolher:

* executar kube-bench de dentro de um cont√™iner (compartilhando o namespace PID com o host)
* executar um cont√™iner que instala kube-bench no host e, em seguida, executar kube-bench diretamente no host
* instalar os bin√°rios mais recentes da [p√°gina de Releases](https://github.com/aquasecurity/kube-bench/releases),
* compil√°-lo a partir do c√≥digo-fonte.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

A ferramenta [**kubeaudit**](https://github.com/Shopify/kubeaudit) √© uma ferramenta de linha de comando e um pacote Go para **auditar clusters Kubernetes** para v√°rias preocupa√ß√µes de seguran√ßa diferentes.

Kubeaudit pode detectar se est√° sendo executado dentro de um cont√™iner em um cluster. Se sim, tentar√° auditar todos os recursos do Kubernetes nesse cluster:
```
kubeaudit all
```
Esta ferramenta tamb√©m possui o argumento `autofix` para **corrigir automaticamente problemas detectados.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

A ferramenta [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) busca por fraquezas de seguran√ßa em clusters Kubernetes. A ferramenta foi desenvolvida para aumentar a conscientiza√ß√£o e a visibilidade sobre problemas de seguran√ßa em ambientes Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) √© uma ferramenta de varredura de vulnerabilidades e benchmark CIS Docker que permite aos usu√°rios obter uma avalia√ß√£o de risco precisa e imediata de seus clusters Kubernetes. Kubei escaneia todas as imagens que est√£o sendo usadas em um cluster Kubernetes, incluindo imagens de pods de aplica√ß√£o e pods de sistema.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) √© uma ferramenta para escanear clusters Kubernetes em busca de permiss√µes arriscadas no modelo de autoriza√ß√£o de controle de acesso baseado em fun√ß√£o (RBAC) do Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) √© uma ferramenta constru√≠da para testar outros tipos de verifica√ß√µes de alto risco em compara√ß√£o com outras ferramentas. Ela possui principalmente 3 modos diferentes:

* **`find-role-relationships`**: Que encontrar√° quais fun√ß√µes AWS est√£o sendo executadas em quais pods
* **`find-secrets`**: Que tenta identificar segredos em recursos K8s, como Pods, ConfigMaps e Secrets.
* **`test-imds-access`**: Que tentar√° executar pods e tentar acessar os metadados v1 e v2. AVISO: Isso executar√° um pod no cluster, tenha muito cuidado porque talvez voc√™ n√£o queira fazer isso!

## **Auditar C√≥digo IaC**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) √© uma utilidade que escaneia clusters Kubernetes ao vivo e **relata problemas potenciais com recursos e configura√ß√µes implantados**. Ele sanitiza seu cluster com base no que est√° implantado e n√£o no que est√° armazenado em disco. Ao escanear seu cluster, ele detecta configura√ß√µes incorretas e ajuda a garantir que as melhores pr√°ticas estejam em vigor, prevenindo assim dores de cabe√ßa futuras. Seu objetivo √© reduzir a sobrecarga cognitiva que se enfrenta ao operar um cluster Kubernetes no ambiente. Al√©m disso, se seu cluster empregar um metric-server, ele relata potenciais aloca√ß√µes excessivas ou insuficientes de recursos e tenta avis√°-lo caso seu cluster fique sem capacidade.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) encontra **vulnerabilidades de seguran√ßa**, problemas de conformidade e configura√ß√µes incorretas de infraestrutura nas seguintes **solu√ß√µes de Infraestrutura como C√≥digo**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM e especifica√ß√µes OpenAPI 3.0

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) √© uma ferramenta de an√°lise de c√≥digo est√°tico para infraestrutura como c√≥digo.

Ela escaneia a infraestrutura em nuvem provisionada usando [Terraform](https://terraform.io), plano Terraform, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) ou [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) e detecta configura√ß√µes incorretas de seguran√ßa e conformidade usando varredura baseada em grafo.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) √© uma ferramenta que realiza an√°lise de c√≥digo est√°tico das defini√ß√µes de objetos do Kubernetes.

Para instalar:

| Distribui√ß√£o                                        | Comando / Link                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Bin√°rios pr√©-compilados para macOS, Linux e Windows | [Lan√ßamentos do GitHub](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS e Linux)                           | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS e Linux) | `kubectl krew install score`                                                            |

## Dicas

### Kubernetes PodSecurityContext e SecurityContext

Voc√™ pode configurar o **contexto de seguran√ßa dos Pods** (com _PodSecurityContext_) e dos **containers** que ser√£o executados (com _SecurityContext_). Para mais informa√ß√µes, leia:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Endurecimento da API do Kubernetes

√â muito importante **proteger o acesso ao Kubernetes Api Server**, pois um ator malicioso com privil√©gios suficientes poderia abusar dele e causar danos de v√°rias maneiras ao ambiente.\
√â importante garantir tanto o **acesso** (**whitelist** de origens para acessar o API Server e negar qualquer outra conex√£o) quanto a [**autentica√ß√£o**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (seguindo o princ√≠pio do **menor** **privil√©gio**). E definitivamente **nunca** **permita** **requisi√ß√µes** **an√¥nimas**.

**Processo Comum de Requisi√ß√£o:**\
Usu√°rio ou K8s ServiceAccount ‚Äì> Autentica√ß√£o ‚Äì> Autoriza√ß√£o ‚Äì> Controle de Admiss√£o.

**Dicas**:

* Feche portas.
* Evite acesso an√¥nimo.
* NodeRestriction; Sem acesso de n√≥s espec√≠ficos ao API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Basicamente impede que kubelets adicionem/removam/atualizem r√≥tulos com um prefixo node-restriction.kubernetes.io/. Este prefixo de r√≥tulo √© reservado para administradores rotularem seus objetos Node para fins de isolamento de carga de trabalho, e kubelets n√£o poder√£o modificar r√≥tulos com esse prefixo.
* E tamb√©m, permite que kubelets adicionem/removam/atualizem esses r√≥tulos e prefixos de r√≥tulo.
* Garanta com r√≥tulos o isolamento seguro da carga de trabalho.
* Evite que pods espec√≠ficos acessem a API.
* Evite a exposi√ß√£o do ApiServer √† internet.
* Evite acesso n√£o autorizado RBAC.
* Porta do ApiServer com firewall e whitelist de IP.

### Endurecimento do SecurityContext

Por padr√£o, o usu√°rio root ser√° usado quando um Pod for iniciado, se nenhum outro usu√°rio for especificado. Voc√™ pode executar sua aplica√ß√£o dentro de um contexto mais seguro usando um template semelhante ao seguinte:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Endurecimento Geral

Voc√™ deve atualizar seu ambiente Kubernetes com a frequ√™ncia necess√°ria para ter:

* Depend√™ncias atualizadas.
* Corre√ß√µes de bugs e seguran√ßa.

[**Ciclos de lan√ßamento**](https://kubernetes.io/docs/setup/release/version-skew-policy/): A cada 3 meses h√° um novo lan√ßamento menor -- 1.20.3 = 1(Maior).20(Menor).3(corre√ß√£o)

**A melhor maneira de atualizar um Cluster Kubernetes √© (a partir de** [**aqui**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Atualize os componentes do N√≥ Master seguindo esta sequ√™ncia:
* etcd (todas as inst√¢ncias).
* kube-apiserver (todos os hosts do plano de controle).
* kube-controller-manager.
* kube-scheduler.
* cloud controller manager, se voc√™ usar um.
* Atualize os componentes do N√≥ Worker, como kube-proxy, kubelet.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
