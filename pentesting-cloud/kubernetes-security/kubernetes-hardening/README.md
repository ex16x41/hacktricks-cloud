# Kubernetes å¼ºåŒ–

{% hint style="success" %}
å­¦ä¹ å¹¶å®è·µ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶å®è·µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ç”¨äºåˆ†æé›†ç¾¤çš„å·¥å…·

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) æ˜¯ä¸€ä¸ª K8s å¼€æºå·¥å…·ï¼Œæä¾›å¤šäº‘ K8s å•ä¸€è§†å›¾ï¼ŒåŒ…æ‹¬é£é™©åˆ†æã€å®‰å…¨åˆè§„æ€§ã€RBAC å¯è§†åŒ–å™¨å’Œé•œåƒæ¼æ´æ‰«æã€‚Kubescape å¯æ‰«æ K8s é›†ç¾¤ã€YAML æ–‡ä»¶å’Œ HELM å›¾è¡¨ï¼Œæ ¹æ®å¤šä¸ªæ¡†æ¶ï¼ˆå¦‚ [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo)ã€[MITRE ATT\&CKÂ®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)ï¼‰æ£€æµ‹é…ç½®é”™è¯¯ã€è½¯ä»¶æ¼æ´å’Œ RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰è¿è§„ï¼Œè®¡ç®—é£é™©è¯„åˆ†å¹¶å³æ—¶æ˜¾ç¤ºé£é™©è¶‹åŠ¿ã€‚
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

å·¥å…· [**kube-bench**](https://github.com/aquasecurity/kube-bench) æ˜¯ä¸€ä¸ªæ£€æŸ¥ Kubernetes æ˜¯å¦å®‰å…¨éƒ¨ç½²çš„å·¥å…·ï¼Œé€šè¿‡è¿è¡Œ [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) ä¸­è®°å½•çš„æ£€æŸ¥é¡¹æ¥å®ç°ã€‚\
æ‚¨å¯ä»¥é€‰æ‹©ï¼š

* ä»å®¹å™¨å†…è¿è¡Œ kube-benchï¼ˆä¸ä¸»æœºå…±äº« PID å‘½åç©ºé—´ï¼‰
* è¿è¡Œä¸€ä¸ªåœ¨ä¸»æœºä¸Šå®‰è£… kube-bench å¹¶ç›´æ¥åœ¨ä¸»æœºä¸Šè¿è¡Œ kube-bench çš„å®¹å™¨
* ä» [Releases é¡µé¢](https://github.com/aquasecurity/kube-bench/releases) å®‰è£…æœ€æ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ
* ä»æºä»£ç ç¼–è¯‘ã€‚

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

å·¥å…· [**kubeaudit**](https://github.com/Shopify/kubeaudit) æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·å’Œ Go åŒ…ï¼Œç”¨äº**å®¡è®¡ Kubernetes é›†ç¾¤**ä»¥è§£å†³å„ç§ä¸åŒçš„å®‰å…¨é—®é¢˜ã€‚

Kubeaudit å¯ä»¥æ£€æµ‹æ˜¯å¦åœ¨é›†ç¾¤ä¸­çš„å®¹å™¨å†…è¿è¡Œã€‚å¦‚æœæ˜¯ï¼Œåˆ™ä¼šå°è¯•å®¡è®¡è¯¥é›†ç¾¤ä¸­çš„æ‰€æœ‰ Kubernetes èµ„æºï¼š
```
kubeaudit all
```
è¿™ä¸ªå·¥å…·è¿˜æœ‰ä¸€ä¸ªå‚æ•° `autofix`ï¼Œç”¨äº**è‡ªåŠ¨ä¿®å¤æ£€æµ‹åˆ°çš„é—®é¢˜ã€‚**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

è¯¥å·¥å…· [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) ç”¨äºåœ¨ Kubernetes é›†ç¾¤ä¸­å¯»æ‰¾å®‰å…¨å¼±ç‚¹ã€‚è¯¥å·¥å…·æ—¨åœ¨æé«˜ Kubernetes ç¯å¢ƒä¸­å®‰å…¨é—®é¢˜çš„æ„è¯†å’Œå¯è§æ€§ã€‚
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) æ˜¯ä¸€ä¸ªæ¼æ´æ‰«æå’Œ CIS Docker åŸºå‡†å·¥å…·ï¼Œå…è®¸ç”¨æˆ·å‡†ç¡®å’Œç«‹å³è¯„ä¼°å…¶ Kubernetes é›†ç¾¤çš„é£é™©ã€‚Kubei æ‰«æ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨çš„æ‰€æœ‰é•œåƒï¼ŒåŒ…æ‹¬åº”ç”¨ç¨‹åº pod å’Œç³»ç»Ÿ pod çš„é•œåƒã€‚

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) æ˜¯ä¸€ä¸ªç”¨äºæ‰«æ Kubernetes é›†ç¾¤ä¸­é£é™©æƒé™çš„å·¥å…·ï¼Œé’ˆå¯¹ Kubernetes çš„åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰æˆæƒæ¨¡å‹ã€‚

### [æ‰˜ç®¡ Kubernetes å®¡è®¡å·¥å…·åŒ…](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•å…¶ä»–ç±»å‹é«˜é£é™©æ£€æŸ¥çš„å·¥å…·ï¼Œä¸å…¶ä»–å·¥å…·ç›¸æ¯”ã€‚ä¸»è¦æœ‰ 3 ç§ä¸åŒçš„æ¨¡å¼ï¼š

* **`find-role-relationships`**ï¼šæŸ¥æ‰¾å“ªäº› AWS è§’è‰²åœ¨å“ªäº› pod ä¸­è¿è¡Œ
* **`find-secrets`**ï¼šå°è¯•è¯†åˆ« K8s èµ„æºä¸­çš„ç§˜å¯†ï¼Œå¦‚ Podsã€ConfigMaps å’Œ Secretsã€‚
* **`test-imds-access`**ï¼šå°è¯•è¿è¡Œ pod å¹¶å°è¯•è®¿é—®å…ƒæ•°æ® v1 å’Œ v2ã€‚è­¦å‘Šï¼šè¿™å°†åœ¨é›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ª podï¼Œè¯·éå¸¸å°å¿ƒï¼Œå› ä¸ºä¹Ÿè®¸æ‚¨ä¸æƒ³è¿™æ ·åšï¼

## **å®¡è®¡ IaC ä»£ç **

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) æ˜¯ä¸€ä¸ªå®ç”¨ç¨‹åºï¼Œç”¨äºæ‰«æå®æ—¶ Kubernetes é›†ç¾¤å¹¶**æŠ¥å‘Šéƒ¨ç½²èµ„æºå’Œé…ç½®çš„æ½œåœ¨é—®é¢˜**ã€‚å®ƒæ ¹æ®éƒ¨ç½²çš„å†…å®¹è€Œä¸æ˜¯ç£ç›˜ä¸Šçš„å†…å®¹å¯¹é›†ç¾¤è¿›è¡Œæ¸…ç†ã€‚é€šè¿‡æ‰«æé›†ç¾¤ï¼Œå®ƒæ£€æµ‹é…ç½®é”™è¯¯ï¼Œå¹¶å¸®åŠ©æ‚¨ç¡®ä¿æœ€ä½³å®è·µå¾—ä»¥å®æ–½ï¼Œä»è€Œé¢„é˜²æœªæ¥çš„é—®é¢˜ã€‚å®ƒæ—¨åœ¨å‡å°‘åœ¨é‡å¤–æ“ä½œ Kubernetes é›†ç¾¤æ—¶æ‰€é¢ä¸´çš„è®¤çŸ¥è´Ÿæ‹…ã€‚æ­¤å¤–ï¼Œå¦‚æœæ‚¨çš„é›†ç¾¤ä½¿ç”¨åº¦é‡æœåŠ¡å™¨ï¼Œå®ƒä¼šæŠ¥å‘Šæ½œåœ¨çš„èµ„æºè¿‡åº¦/ä¸è¶³åˆ†é…ï¼Œå¹¶åœ¨é›†ç¾¤èµ„æºä¸è¶³æ—¶å°è¯•è­¦å‘Šæ‚¨ã€‚

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) åœ¨ä»¥ä¸‹**åŸºç¡€è®¾æ–½å³ä»£ç è§£å†³æ–¹æ¡ˆ**ä¸­æŸ¥æ‰¾**å®‰å…¨æ¼æ´**ã€åˆè§„æ€§é—®é¢˜å’ŒåŸºç¡€è®¾æ–½é…ç½®é”™è¯¯ï¼šTerraformã€Kubernetesã€Dockerã€AWS CloudFormationã€Ansibleã€Helmã€Microsoft ARM å’Œ OpenAPI 3.0 è§„èŒƒ

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) æ˜¯ç”¨äºåŸºç¡€è®¾æ–½å³ä»£ç çš„é™æ€ä»£ç åˆ†æå·¥å…·ã€‚

å®ƒæ‰«æä½¿ç”¨ [Terraform](https://terraform.io)ã€Terraform planã€[Cloudformation](https://aws.amazon.com/cloudformation/)ã€[AWS SAM](https://aws.amazon.com/serverless/sam/)ã€[Kubernetes](https://kubernetes.io)ã€[Dockerfile](https://www.docker.com)ã€[Serverless](https://www.serverless.com) æˆ– [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) éƒ¨ç½²çš„äº‘åŸºç¡€è®¾æ–½ï¼Œå¹¶ä½¿ç”¨åŸºäºå›¾å½¢çš„æ‰«ææ£€æµ‹å®‰å…¨å’Œåˆè§„æ€§é…ç½®é”™è¯¯ã€‚

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) æ˜¯ä¸€ä¸ªæ‰§è¡Œ Kubernetes å¯¹è±¡å®šä¹‰çš„é™æ€ä»£ç åˆ†æå·¥å…·ã€‚

å®‰è£…æ–¹æ³•ï¼š

| å‘è¡Œç‰ˆ                                             | å‘½ä»¤ / é“¾æ¥                                                                             |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| é¢„æ„å»ºçš„ macOSã€Linux å’Œ Windows äºŒè¿›åˆ¶æ–‡ä»¶         | [GitHub releases](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrewï¼ˆmacOS å’Œ Linuxï¼‰                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/)ï¼ˆmacOS å’Œ Linuxï¼‰  | `kubectl krew install score`                                                            |

## æç¤º

### Kubernetes PodSecurityContext å’Œ SecurityContext

æ‚¨å¯ä»¥é…ç½®**Pod çš„å®‰å…¨ä¸Šä¸‹æ–‡**ï¼ˆä½¿ç”¨ _PodSecurityContext_ï¼‰å’Œå³å°†è¿è¡Œçš„**å®¹å™¨**çš„**å®‰å…¨ä¸Šä¸‹æ–‡**ï¼ˆä½¿ç”¨ _SecurityContext_ï¼‰ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»ï¼š

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes API ç¡¬åŒ–

éå¸¸é‡è¦çš„æ˜¯**ä¿æŠ¤å¯¹ Kubernetes Api æœåŠ¡å™¨çš„è®¿é—®**ï¼Œå› ä¸ºå…·æœ‰è¶³å¤Ÿç‰¹æƒçš„æ¶æ„è¡Œä¸ºè€…å¯èƒ½ä¼šæ»¥ç”¨å®ƒå¹¶ä»¥å¤šç§æ–¹å¼æŸå®³ç¯å¢ƒã€‚\
é‡è¦çš„æ˜¯ä¿æŠ¤**è®¿é—®**ï¼ˆ**ç™½åå•**æºä»¥è®¿é—® API æœåŠ¡å™¨å¹¶æ‹’ç»ä»»ä½•å…¶ä»–è¿æ¥ï¼‰å’Œ[**èº«ä»½éªŒè¯**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/)ï¼ˆéµå¾ª**æœ€å°ç‰¹æƒ**åŸåˆ™ï¼‰ã€‚ç»å¯¹**ä¸è¦****å…è®¸** **åŒ¿å** **è¯·æ±‚**ã€‚

**å¸¸è§è¯·æ±‚æµç¨‹ï¼š**\
ç”¨æˆ·æˆ– K8s ServiceAccount â€“> èº«ä»½éªŒè¯ â€“> æˆæƒ â€“> å‡†å…¥æ§åˆ¶ã€‚

**æç¤º**ï¼š

* å…³é—­ç«¯å£ã€‚
* é¿å…åŒ¿åè®¿é—®ã€‚
* NodeRestrictionï¼›ç¦æ­¢ç‰¹å®šèŠ‚ç‚¹è®¿é—® APIã€‚
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* åŸºæœ¬ä¸Šé˜²æ­¢ kubelets æ·»åŠ /åˆ é™¤/æ›´æ–°å…·æœ‰ node-restriction.kubernetes.io/ å‰ç¼€çš„æ ‡ç­¾ã€‚æ­¤æ ‡ç­¾å‰ç¼€ä¿ç•™ä¾›ç®¡ç†å‘˜ä¸ºäº†å·¥ä½œè´Ÿè½½éš”ç¦»ç›®çš„è€Œæ ‡è®°å…¶èŠ‚ç‚¹å¯¹è±¡ï¼Œkubelets å°†ä¸è¢«å…è®¸ä¿®æ”¹å…·æœ‰è¯¥å‰ç¼€çš„æ ‡ç­¾ã€‚
* åŒæ ·ï¼Œå…è®¸ kubelets æ·»åŠ /åˆ é™¤/æ›´æ–°è¿™äº›æ ‡ç­¾å’Œæ ‡ç­¾å‰ç¼€ã€‚
* ä½¿ç”¨æ ‡ç­¾ç¡®ä¿å®‰å…¨çš„å·¥ä½œè´Ÿè½½éš”ç¦»ã€‚
* é¿å…ç‰¹å®š pod è®¿é—® APIã€‚
* é¿å…å°† ApiServer æš´éœ²ç»™äº’è”ç½‘ã€‚
* é¿å…æœªç»æˆæƒçš„è®¿é—® RBACã€‚
* ä½¿ç”¨é˜²ç«å¢™å’Œ IP ç™½åå•è®¾ç½® ApiServer ç«¯å£ã€‚
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### ä¸€èˆ¬åŠ å›º

æ‚¨åº”è¯¥æ ¹æ®éœ€è¦å®šæœŸæ›´æ–°Kubernetesç¯å¢ƒï¼Œç¡®ä¿ï¼š

* ä¾èµ–é¡¹æ˜¯æœ€æ–°çš„ã€‚
* è¡¥ä¸å’Œå®‰å…¨è¡¥ä¸å·²å®‰è£…ã€‚

[**å‘å¸ƒå‘¨æœŸ**](https://kubernetes.io/docs/setup/release/version-skew-policy/)ï¼šæ¯3ä¸ªæœˆä¼šæœ‰ä¸€ä¸ªæ–°çš„æ¬¡è¦å‘å¸ƒç‰ˆæœ¬ -- 1.20.3 = 1(ä¸»è¦).20(æ¬¡è¦).3(è¡¥ä¸)

**æ›´æ–°Kubernetesé›†ç¾¤çš„æœ€ä½³æ–¹å¼æ˜¯ï¼ˆæ¥è‡ª** [**è¿™é‡Œ**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**ï¼‰ï¼š**

* æŒ‰ç…§ä»¥ä¸‹é¡ºåºå‡çº§ä¸»èŠ‚ç‚¹ç»„ä»¶ï¼š
* etcdï¼ˆæ‰€æœ‰å®ä¾‹ï¼‰ã€‚
* kube-apiserverï¼ˆæ‰€æœ‰æ§åˆ¶å¹³é¢ä¸»æœºï¼‰ã€‚
* kube-controller-managerã€‚
* kube-schedulerã€‚
* äº‘æ§åˆ¶å™¨ç®¡ç†å™¨ï¼ˆå¦‚æœä½¿ç”¨ï¼‰ã€‚
* å‡çº§WorkerèŠ‚ç‚¹ç»„ä»¶ï¼Œå¦‚kube-proxyã€kubeletã€‚

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚**

</details>
{% endhint %}
