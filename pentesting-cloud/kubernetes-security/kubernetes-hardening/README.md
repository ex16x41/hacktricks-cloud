# Renforcement de Kubernetes

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Outils pour analyser un cluster

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) est un outil open-source K8s fournissant une vue unique multi-cloud K8s, incluant l'analyse des risques, la conformit√© de s√©curit√©, un visualiseur RBAC et le scan des vuln√©rabilit√©s d'images. Kubescape scanne les clusters K8s, les fichiers YAML et les charts HELM, d√©tectant les erreurs de configuration selon plusieurs cadres (comme le [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), les vuln√©rabilit√©s logicielles et les violations RBAC (contr√¥le d'acc√®s bas√© sur les r√¥les) aux premi√®res √©tapes du pipeline CI/CD, calcule instantan√©ment le score de risque et montre les tendances de risque au fil du temps.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

L'outil [**kube-bench**](https://github.com/aquasecurity/kube-bench) est un outil qui v√©rifie si Kubernetes est d√©ploy√© de mani√®re s√©curis√©e en ex√©cutant les v√©rifications document√©es dans le [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Vous pouvez choisir de :

* ex√©cuter kube-bench depuis un conteneur (partageant l'espace de noms PID avec l'h√¥te)
* ex√©cuter un conteneur qui installe kube-bench sur l'h√¥te, puis ex√©cuter kube-bench directement sur l'h√¥te
* installer les derniers binaires depuis la [page des Releases](https://github.com/aquasecurity/kube-bench/releases),
* le compiler √† partir des sources.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

L'outil [**kubeaudit**](https://github.com/Shopify/kubeaudit) est un outil en ligne de commande et un package Go pour **auditer les clusters Kubernetes** pour diverses pr√©occupations de s√©curit√©.

Kubeaudit peut d√©tecter s'il s'ex√©cute dans un conteneur dans un cluster. Si c'est le cas, il essaiera d'auditer toutes les ressources Kubernetes dans ce cluster :
```
kubeaudit all
```
Cet outil a √©galement l'argument `autofix` pour **corriger automatiquement les probl√®mes d√©tect√©s.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

L'outil [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) recherche des faiblesses de s√©curit√© dans les clusters Kubernetes. L'outil a √©t√© d√©velopp√© pour accro√Ætre la sensibilisation et la visibilit√© des probl√®mes de s√©curit√© dans les environnements Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) est un outil de scan de vuln√©rabilit√©s et de r√©f√©rence CIS Docker qui permet aux utilisateurs d'obtenir une √©valuation des risques pr√©cise et imm√©diate de leurs clusters Kubernetes. Kubei scanne toutes les images utilis√©es dans un cluster Kubernetes, y compris les images des pods d'application et des pods syst√®me.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) est un outil pour scanner les clusters Kubernetes √† la recherche de permissions risqu√©es dans le mod√®le d'autorisation bas√© sur les r√¥les (RBAC) de Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) est un outil con√ßu pour tester d'autres types de v√©rifications √† haut risque par rapport aux autres outils. Il dispose principalement de 3 modes diff√©rents :

* **`find-role-relationships`** : Qui trouvera quels r√¥les AWS s'ex√©cutent dans quels pods
* **`find-secrets`** : Qui essaie d'identifier des secrets dans les ressources K8s telles que les Pods, ConfigMaps et Secrets.
* **`test-imds-access`** : Qui essaiera d'ex√©cuter des pods et d'acc√©der aux m√©tadonn√©es v1 et v2. AVERTISSEMENT : Cela ex√©cutera un pod dans le cluster, soyez tr√®s prudent car vous ne voudrez peut-√™tre pas faire cela !

## **Audit IaC Code**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) est un utilitaire qui scanne un cluster Kubernetes en direct et **signale les probl√®mes potentiels avec les ressources et configurations d√©ploy√©es**. Il assainit votre cluster en fonction de ce qui est d√©ploy√© et non de ce qui est stock√© sur le disque. En scannant votre cluster, il d√©tecte les erreurs de configuration et vous aide √† vous assurer que les meilleures pratiques sont en place, √©vitant ainsi de futurs maux de t√™te. Il vise √† r√©duire la surcharge cognitive √† laquelle on fait face lors de l'exploitation d'un cluster Kubernetes dans la nature. De plus, si votre cluster utilise un serveur de m√©triques, il signale les allocations de ressources sur/sous-utilis√©es et tente de vous avertir si votre cluster manque de capacit√©.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) trouve des **vuln√©rabilit√©s de s√©curit√©**, des probl√®mes de conformit√© et des erreurs de configuration d'infrastructure dans les **solutions Infrastructure as Code** suivantes : Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM et sp√©cifications OpenAPI 3.0.

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) est un outil d'analyse de code statique pour l'infrastructure en tant que code.

Il scanne l'infrastructure cloud provisionn√©e √† l'aide de [Terraform](https://terraform.io), du plan Terraform, de [Cloudformation](https://aws.amazon.com/cloudformation/), de [AWS SAM](https://aws.amazon.com/serverless/sam/), de [Kubernetes](https://kubernetes.io), de [Dockerfile](https://www.docker.com), de [Serverless](https://www.serverless.com) ou de [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) et d√©tecte les erreurs de configuration de s√©curit√© et de conformit√© √† l'aide d'un scan bas√© sur des graphes.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) est un outil qui effectue une analyse de code statique de vos d√©finitions d'objets Kubernetes.

Pour installer :

| Distribution                                        | Commande / Lien                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Binaries pr√©construits pour macOS, Linux et Windows | [Releases GitHub](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub](https://hub.docker.com/r/zegl/kube-score/)) |
| Homebrew (macOS et Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS et Linux) | `kubectl krew install score`                                                            |

## Conseils

### Kubernetes PodSecurityContext et SecurityContext

Vous pouvez configurer le **contexte de s√©curit√© des Pods** (avec _PodSecurityContext_) et des **conteneurs** qui vont √™tre ex√©cut√©s (avec _SecurityContext_). Pour plus d'informations, lisez :

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Durcissement de l'API Kubernetes

Il est tr√®s important de **prot√©ger l'acc√®s au serveur API Kubernetes** car un acteur malveillant disposant de privil√®ges suffisants pourrait en abuser et endommager l'environnement de plusieurs mani√®res.\
Il est important de s√©curiser √† la fois l'**acc√®s** (**whitelist** des origines pour acc√©der au serveur API et refuser toute autre connexion) et l'**authentification** (suivant le principe du **moindre** **privil√®ge**). Et surtout **ne jamais** **autoriser** **les** **requ√™tes** **anonymes**.

**Processus de demande commun :**\
Utilisateur ou K8s ServiceAccount ‚Äì> Authentification ‚Äì> Autorisation ‚Äì> Contr√¥le d'admission.

**Conseils** :

* Fermez les ports.
* √âvitez l'acc√®s anonyme.
* NodeRestriction ; Pas d'acc√®s depuis des n≈ìuds sp√©cifiques √† l'API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Cela emp√™che essentiellement les kubelets d'ajouter/supprimer/mettre √† jour des √©tiquettes avec un pr√©fixe node-restriction.kubernetes.io/. Ce pr√©fixe d'√©tiquette est r√©serv√© aux administrateurs pour √©tiqueter leurs objets Node √† des fins d'isolement des charges de travail, et les kubelets ne seront pas autoris√©s √† modifier les √©tiquettes avec ce pr√©fixe.
* Et aussi, permet aux kubelets d'ajouter/supprimer/mettre √† jour ces √©tiquettes et pr√©fixes d'√©tiquettes.
* Assurez-vous avec des √©tiquettes de l'isolement s√©curis√© des charges de travail.
* √âvitez que des pods sp√©cifiques n'acc√®dent √† l'API.
* √âvitez l'exposition de l'ApiServer √† Internet.
* √âvitez l'acc√®s non autoris√© RBAC.
* Port ApiServer avec pare-feu et liste blanche d'IP.

### Durcissement du SecurityContext

Par d√©faut, l'utilisateur root sera utilis√© lorsqu'un Pod est d√©marr√© si aucun autre utilisateur n'est sp√©cifi√©. Vous pouvez ex√©cuter votre application dans un contexte plus s√©curis√© en utilisant un mod√®le similaire √† celui-ci :
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Renforcement G√©n√©ral

Vous devez mettre √† jour votre environnement Kubernetes aussi souvent que n√©cessaire pour avoir :

* D√©pendances √† jour.
* Correctifs de bogues et de s√©curit√©.

[**Cycles de publication**](https://kubernetes.io/docs/setup/release/version-skew-policy/) : Chaque 3 mois, il y a une nouvelle version mineure -- 1.20.3 = 1(Majeur).20(Minor).3(patch)

**La meilleure fa√ßon de mettre √† jour un cluster Kubernetes est (depuis** [**ici**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**) :**

* Mettez √† niveau les composants du n≈ìud ma√Ætre en suivant cette s√©quence :
* etcd (toutes les instances).
* kube-apiserver (tous les h√¥tes du plan de contr√¥le).
* kube-controller-manager.
* kube-scheduler.
* cloud controller manager, si vous en utilisez un.
* Mettez √† niveau les composants du n≈ìud de travail tels que kube-proxy, kubelet.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
