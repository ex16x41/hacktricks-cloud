# Kubernetes Hardening

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Tools zur Analyse eines Clusters

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) ist ein K8s Open-Source-Tool, das eine Multi-Cloud K8s-√úbersicht bietet, einschlie√ülich Risikoanalyse, Sicherheitskonformit√§t, RBAC-Visualizer und Scannen von Bildanf√§lligkeiten. Kubescape scannt K8s-Cluster, YAML-Dateien und HELM-Diagramme, erkennt Fehlkonfigurationen gem√§√ü mehreren Rahmenwerken (wie dem [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), Softwareanf√§lligkeiten und RBAC (role-based-access-control) Verst√∂√üe in fr√ºhen Phasen der CI/CD-Pipeline, berechnet sofort den Risikowert und zeigt Risikotrends im Laufe der Zeit an.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Das Tool [**kube-bench**](https://github.com/aquasecurity/kube-bench) ist ein Tool, das √ºberpr√ºft, ob Kubernetes sicher bereitgestellt ist, indem es die im [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) dokumentierten Pr√ºfungen durchf√ºhrt.\
Sie k√∂nnen w√§hlen, ob Sie:

* kube-bench aus einem Container (mit gemeinsamem PID-Namespace mit dem Host) ausf√ºhren
* einen Container ausf√ºhren, der kube-bench auf dem Host installiert, und dann kube-bench direkt auf dem Host ausf√ºhren
* die neuesten Bin√§rdateien von der [Releases-Seite](https://github.com/aquasecurity/kube-bench/releases) installieren,
* es aus dem Quellcode kompilieren.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Das Tool [**kubeaudit**](https://github.com/Shopify/kubeaudit) ist ein Befehlszeilentool und ein Go-Paket, um **Kubernetes-Cluster** auf verschiedene Sicherheitsbedenken zu **pr√ºfen**.

Kubeaudit kann erkennen, ob es innerhalb eines Containers in einem Cluster ausgef√ºhrt wird. Wenn ja, wird es versuchen, alle Kubernetes-Ressourcen in diesem Cluster zu pr√ºfen:
```
kubeaudit all
```
Dieses Tool hat auch das Argument `autofix`, um **erkannt Probleme automatisch zu beheben.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

Das Tool [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) sucht nach Sicherheitsanf√§lligkeiten in Kubernetes-Clustern. Das Tool wurde entwickelt, um das Bewusstsein und die Sichtbarkeit f√ºr Sicherheitsprobleme in Kubernetes-Umgebungen zu erh√∂hen.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) ist ein Tool zur Schwachstellenscannung und zur CIS Docker-Benchmark, das es Benutzern erm√∂glicht, eine genaue und sofortige Risikobewertung ihrer Kubernetes-Cluster zu erhalten. Kubei scannt alle Images, die in einem Kubernetes-Cluster verwendet werden, einschlie√ülich der Images von Anwendungs-Pods und System-Pods.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) ist ein Tool zum Scannen von Kubernetes-Clustern auf riskante Berechtigungen im rollenbasierten Zugriffskontrollmodell (RBAC) von Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) ist ein Tool, das entwickelt wurde, um andere Arten von Hochrisikopr√ºfungen im Vergleich zu anderen Tools zu testen. Es hat haupts√§chlich 3 verschiedene Modi:

* **`find-role-relationships`**: Der herausfindet, welche AWS-Rollen in welchen Pods ausgef√ºhrt werden
* **`find-secrets`**: Der versucht, Geheimnisse in K8s-Ressourcen wie Pods, ConfigMaps und Secrets zu identifizieren.
* **`test-imds-access`**: Der versucht, Pods auszuf√ºhren und auf die Metadaten v1 und v2 zuzugreifen. WARNUNG: Dies wird einen Pod im Cluster ausf√ºhren, seien Sie sehr vorsichtig, da Sie dies m√∂glicherweise nicht tun m√∂chten!

## **Audit IaC Code**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) ist ein Dienstprogramm, das live Kubernetes-Cluster scannt und **potenzielle Probleme mit bereitgestellten Ressourcen und Konfigurationen meldet**. Es bereinigt Ihr Cluster basierend auf dem, was bereitgestellt ist, und nicht auf dem, was auf der Festplatte liegt. Durch das Scannen Ihres Clusters erkennt es Fehlkonfigurationen und hilft Ihnen sicherzustellen, dass bew√§hrte Verfahren vorhanden sind, um zuk√ºnftige Kopfschmerzen zu vermeiden. Es zielt darauf ab, die kognitive \_√úberlastung\_ zu reduzieren, die man beim Betrieb eines Kubernetes-Clusters in der Wildnis hat. Dar√ºber hinaus, wenn Ihr Cluster einen Metric-Server verwendet, meldet es potenzielle √úber-/Unterallokationen von Ressourcen und versucht, Sie zu warnen, falls Ihr Cluster die Kapazit√§t ersch√∂pft.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) findet **Sicherheitsanf√§lligkeiten**, Compliance-Probleme und Infrastrukturfehlkonfigurationen in den folgenden **Infrastructure as Code-L√∂sungen**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM und OpenAPI 3.0-Spezifikationen.

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) ist ein Tool zur statischen Codeanalyse f√ºr Infrastructure-as-Code.

Es scannt Cloud-Infrastruktur, die mit [Terraform](https://terraform.io), Terraform-Plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) oder [ARM-Vorlagen](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) bereitgestellt wurde, und erkennt Sicherheits- und Compliance-Fehlkonfigurationen mithilfe von graphbasiertem Scannen.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) ist ein Tool, das eine statische Codeanalyse Ihrer Kubernetes-Objektdokumentationen durchf√ºhrt.

Um zu installieren:

| Distribution                                        | Command / Link                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Vorgefertigte Bin√§rdateien f√ºr macOS, Linux und Windows    | [GitHub-Releases](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS und Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS und Linux) | `kubectl krew install score`                                                            |

## Tipps

### Kubernetes PodSecurityContext und SecurityContext

Sie k√∂nnen den **Sicherheitskontext der Pods** (mit _PodSecurityContext_) und der **Container**, die ausgef√ºhrt werden sollen (mit _SecurityContext_), konfigurieren. F√ºr weitere Informationen lesen Sie:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes API-H√§rtung

Es ist sehr wichtig, den **Zugang zum Kubernetes API-Server zu sch√ºtzen**, da ein b√∂swilliger Akteur mit ausreichenden Berechtigungen in der Lage sein k√∂nnte, ihn zu missbrauchen und die Umgebung auf viele Arten zu sch√§digen.\
Es ist wichtig, sowohl den **Zugang** (**Whitelist**-Urspr√ºnge f√ºr den Zugriff auf den API-Server und alle anderen Verbindungen abzulehnen) als auch die [**Authentifizierung**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (nach dem Prinzip der **geringsten** **Berechtigung**) zu sichern. Und auf keinen Fall **anonyme** **Anfragen** **erlauben**.

**Allgemeiner Anfrageprozess:**\
Benutzer oder K8s ServiceAccount ‚Äì> Authentifizierung ‚Äì> Autorisierung ‚Äì> Zulassungssteuerung.

**Tipps**:

* Ports schlie√üen.
* Anonymen Zugriff vermeiden.
* NodeRestriction; Kein Zugriff von bestimmten Knoten auf die API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Verhindert im Wesentlichen, dass Kubelets Labels mit einem node-restriction.kubernetes.io/ Pr√§fix hinzuf√ºgen/entfernen/aktualisieren. Dieses Label-Pr√§fix ist f√ºr Administratoren reserviert, um ihre Node-Objekte zu Labeln, um Arbeitslastisolationszwecke zu erf√ºllen, und Kubelets wird nicht erlaubt, Labels mit diesem Pr√§fix zu √§ndern.
* Und au√üerdem erlaubt es Kubelets, diese Labels und Label-Pr√§fixe hinzuzuf√ºgen/zu entfernen/zu aktualisieren.
* Stellen Sie mit Labels die sichere Arbeitslastisolierung sicher.
* Verhindern Sie, dass bestimmte Pods auf die API zugreifen.
* Vermeiden Sie die Exposition des ApiServers zum Internet.
* Vermeiden Sie unbefugten Zugriff auf RBAC.
* ApiServer-Port mit Firewall und IP-Whitelist.

### H√§rtung des SecurityContext

Standardm√§√üig wird der Root-Benutzer verwendet, wenn ein Pod gestartet wird, wenn kein anderer Benutzer angegeben ist. Sie k√∂nnen Ihre Anwendung in einem sichereren Kontext ausf√ºhren, indem Sie eine Vorlage verwenden, die der folgenden √§hnlich ist:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Allgemeine H√§rtung

Sie sollten Ihre Kubernetes-Umgebung so h√§ufig wie n√∂tig aktualisieren, um Folgendes zu gew√§hrleisten:

* Abh√§ngigkeiten auf dem neuesten Stand.
* Fehler- und Sicherheitsupdates.

[**Release-Zyklen**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Alle 3 Monate gibt es ein neues Minor-Release -- 1.20.3 = 1(Haupt).20(Minor).3(Patch)

**Der beste Weg, ein Kubernetes-Cluster zu aktualisieren, ist (von** [**hier**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Aktualisieren Sie die Master-Node-Komponenten in folgender Reihenfolge:
* etcd (alle Instanzen).
* kube-apiserver (alle Control-Plane-Hosts).
* kube-controller-manager.
* kube-scheduler.
* cloud controller manager, falls Sie einen verwenden.
* Aktualisieren Sie die Worker-Node-Komponenten wie kube-proxy, kubelet.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
