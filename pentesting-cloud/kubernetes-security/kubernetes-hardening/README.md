# Endurecimiento de Kubernetes

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## Herramientas para analizar un cl√∫ster

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) es una herramienta de c√≥digo abierto para K8s que proporciona una vista √∫nica de m√∫ltiples nubes de K8s, incluyendo an√°lisis de riesgos, cumplimiento de seguridad, visualizador de RBAC y escaneo de vulnerabilidades de im√°genes. Kubescape escanea cl√∫steres de K8s, archivos YAML y gr√°ficos HELM, detectando configuraciones incorrectas de acuerdo con m√∫ltiples marcos (como el [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), vulnerabilidades de software y violaciones de RBAC (control de acceso basado en roles) en las primeras etapas del pipeline CI/CD, calcula el puntaje de riesgo al instante y muestra tendencias de riesgo a lo largo del tiempo.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

La herramienta [**kube-bench**](https://github.com/aquasecurity/kube-bench) es una herramienta que verifica si Kubernetes est√° desplegado de manera segura al ejecutar las verificaciones documentadas en el [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Puedes elegir:

* ejecutar kube-bench desde dentro de un contenedor (compartiendo el espacio de nombres PID con el host)
* ejecutar un contenedor que instale kube-bench en el host, y luego ejecutar kube-bench directamente en el host
* instalar los √∫ltimos binarios desde la [p√°gina de Releases](https://github.com/aquasecurity/kube-bench/releases),
* compilarlo desde el c√≥digo fuente.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

La herramienta [**kubeaudit**](https://github.com/Shopify/kubeaudit) es una herramienta de l√≠nea de comandos y un paquete de Go para **auditar cl√∫steres de Kubernetes** por diversas preocupaciones de seguridad.

Kubeaudit puede detectar si se est√° ejecutando dentro de un contenedor en un cl√∫ster. Si es as√≠, intentar√° auditar todos los recursos de Kubernetes en ese cl√∫ster:
```
kubeaudit all
```
Esta herramienta tambi√©n tiene el argumento `autofix` para **arreglar autom√°ticamente los problemas detectados.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

La herramienta [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) busca debilidades de seguridad en cl√∫steres de Kubernetes. La herramienta fue desarrollada para aumentar la conciencia y visibilidad sobre los problemas de seguridad en entornos de Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) es una herramienta de escaneo de vulnerabilidades y de referencia CIS Docker que permite a los usuarios obtener una evaluaci√≥n de riesgo precisa e inmediata de sus cl√∫steres de Kubernetes. Kubei escanea todas las im√°genes que se est√°n utilizando en un cl√∫ster de Kubernetes, incluidas las im√°genes de los pods de aplicaci√≥n y los pods del sistema.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) es una herramienta para escanear cl√∫steres de Kubernetes en busca de permisos riesgosos en el modelo de autorizaci√≥n de control de acceso basado en roles (RBAC) de Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) es una herramienta dise√±ada para probar otros tipos de verificaciones de alto riesgo en comparaci√≥n con otras herramientas. Principalmente tiene 3 modos diferentes:

* **`find-role-relationships`**: Que encontrar√° qu√© roles de AWS se est√°n ejecutando en qu√© pods.
* **`find-secrets`**: Que intenta identificar secretos en los recursos de K8s como Pods, ConfigMaps y Secrets.
* **`test-imds-access`**: Que intentar√° ejecutar pods y tratar de acceder a los metadatos v1 y v2. ADVERTENCIA: Esto ejecutar√° un pod en el cl√∫ster, ten mucho cuidado porque tal vez no quieras hacer esto.

## **Auditar C√≥digo IaC**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) es una utilidad que escanea cl√∫steres de Kubernetes en vivo y **informa sobre problemas potenciales con los recursos y configuraciones desplegadas**. Sanitiza tu cl√∫ster en funci√≥n de lo que est√° desplegado y no de lo que est√° en disco. Al escanear tu cl√∫ster, detecta configuraciones incorrectas y te ayuda a asegurar que las mejores pr√°cticas est√©n en su lugar, evitando as√≠ futuros dolores de cabeza. Su objetivo es reducir la sobrecarga cognitiva que uno enfrenta al operar un cl√∫ster de Kubernetes en producci√≥n. Adem√°s, si tu cl√∫ster emplea un servidor de m√©tricas, informa sobre posibles sobreasignaciones/subasignaciones de recursos y intenta advertirte si tu cl√∫ster se queda sin capacidad.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) encuentra **vulnerabilidades de seguridad**, problemas de cumplimiento y configuraciones incorrectas de infraestructura en las siguientes **soluciones de Infraestructura como C√≥digo**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM y especificaciones OpenAPI 3.0.

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) es una herramienta de an√°lisis de c√≥digo est√°tico para infraestructura como c√≥digo.

Escanea la infraestructura en la nube provisionada utilizando [Terraform](https://terraform.io), plan de Terraform, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) o [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) y detecta configuraciones incorrectas de seguridad y cumplimiento utilizando escaneo basado en gr√°ficos.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) es una herramienta que realiza an√°lisis de c√≥digo est√°tico de tus definiciones de objetos de Kubernetes.

Para instalar:

| Distribuci√≥n                                        | Comando / Enlace                                                                          |
| --------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| Binarios preconstruidos para macOS, Linux y Windows | [Lanzamientos de GitHub](https://github.com/zegl/kube-score/releases)                    |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub](https://hub.docker.com/r/zegl/kube-score/)) |
| Homebrew (macOS y Linux)                           | `brew install kube-score`                                                                 |
| [Krew](https://krew.sigs.k8s.io/) (macOS y Linux)  | `kubectl krew install score`                                                              |

## Consejos

### Kubernetes PodSecurityContext y SecurityContext

Puedes configurar el **contexto de seguridad de los Pods** (con _PodSecurityContext_) y de los **contenedores** que se van a ejecutar (con _SecurityContext_). Para m√°s informaci√≥n, lee:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Endurecimiento de la API de Kubernetes

Es muy importante **proteger el acceso al servidor API de Kubernetes** ya que un actor malicioso con suficientes privilegios podr√≠a abusar de √©l y da√±ar el entorno de muchas maneras.\
Es importante asegurar tanto el **acceso** (**whitelist** de or√≠genes para acceder al servidor API y denegar cualquier otra conexi√≥n) como la [**autenticaci√≥n**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (siguiendo el principio de **m√≠nimos** **privilegios**). Y definitivamente **nunca** **permitir** **solicitudes** **an√≥nimas**.

**Proceso com√∫n de solicitud:**\
Usuario o K8s ServiceAccount ‚Äì> Autenticaci√≥n ‚Äì> Autorizaci√≥n ‚Äì> Control de Admisi√≥n.

**Consejos**:

* Cerrar puertos.
* Evitar acceso an√≥nimo.
* NodeRestriction; Sin acceso desde nodos espec√≠ficos a la API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* B√°sicamente previene que los kubelets a√±adan/eliminar/modifiquen etiquetas con un prefijo node-restriction.kubernetes.io/. Este prefijo de etiqueta est√° reservado para que los administradores etiqueten sus objetos Node con fines de aislamiento de carga de trabajo, y los kubelets no podr√°n modificar etiquetas con ese prefijo.
* Y tambi√©n, permite a los kubelets a√±adir/eliminar/actualizar estas etiquetas y prefijos de etiquetas.
* Asegurar con etiquetas el aislamiento seguro de la carga de trabajo.
* Evitar que pods espec√≠ficos accedan a la API.
* Evitar la exposici√≥n del ApiServer a Internet.
* Evitar acceso no autorizado RBAC.
* Puerto del ApiServer con firewall y lista blanca de IP.

### Endurecimiento de SecurityContext

Por defecto, se utilizar√° el usuario root cuando se inicie un Pod si no se especifica otro usuario. Puedes ejecutar tu aplicaci√≥n dentro de un contexto m√°s seguro utilizando una plantilla similar a la siguiente:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Endurecimiento General

Deber√≠as actualizar tu entorno de Kubernetes tan frecuentemente como sea necesario para tener:

* Dependencias actualizadas.
* Correcciones de errores y de seguridad.

[**Ciclos de lanzamiento**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Cada 3 meses hay un nuevo lanzamiento menor -- 1.20.3 = 1(Mayor).20(Menor).3(parche)

**La mejor manera de actualizar un cl√∫ster de Kubernetes es (desde** [**aqu√≠**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Actualiza los componentes del nodo maestro siguiendo esta secuencia:
* etcd (todas las instancias).
* kube-apiserver (todos los hosts del plano de control).
* kube-controller-manager.
* kube-scheduler.
* cloud controller manager, si usas uno.
* Actualiza los componentes del nodo trabajador como kube-proxy, kubelet.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
