# Podstawy Kubernetes

## Podstawy Kubernetes

{% hint style="success" %}
Dowiedz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) albo **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na GitHubie.

</details>
{% endhint %}

**Oryginalnym autorem tej strony jest** [**Jorge**](https://www.linkedin.com/in/jorge-belmonte-a924b616b/) **(przeczytaj jego oryginalny post** [**tutaj**](https://sickrov.github.io)**)**

## Architektura i Podstawy

### Co robi Kubernetes?

* Pozwala uruchamiaÄ‡ kontenery w silniku kontenerÃ³w.
* Harmonogram pozwala na efektywne wykonywanie kontenerÃ³w.
* Utrzymuje kontenery aktywne.
* Pozwala na komunikacjÄ™ miÄ™dzy kontenerami.
* UmoÅ¼liwia techniki wdraÅ¼ania.
* ZarzÄ…dza duÅ¼ymi iloÅ›ciami informacji.

### Architektura

![](https://sickrov.github.io/media/Screenshot-68.jpg)

* **Node**: system operacyjny z podem lub podami.
* **Pod**: Otoczka wokÃ³Å‚ kontenera lub wielu kontenerÃ³w. Pod powinien zawieraÄ‡ tylko jednÄ… aplikacjÄ™ (zazwyczaj pod uruchamia tylko 1 kontener). Pod jest sposobem, w jaki Kubernetes abstrahuje technologiÄ™ kontenerÃ³w.
* **UsÅ‚uga**: KaÅ¼dy pod ma 1 wewnÄ™trzny **adres IP** z wewnÄ™trznego zakresu wÄ™zÅ‚a. MoÅ¼e byÄ‡ rÃ³wnieÅ¼ wystawiony za pomocÄ… usÅ‚ugi. **UsÅ‚uga ma rÃ³wnieÅ¼ adres IP** i jej celem jest utrzymanie komunikacji miÄ™dzy podami, wiÄ™c jeÅ›li jeden umrze, **nowa replika** (z innym wewnÄ™trznym adresem IP) **bÄ™dzie dostÄ™pna** wystawiona pod **tym samym adresem IP usÅ‚ugi**. MoÅ¼e byÄ‡ skonfigurowany jako wewnÄ™trzny lub zewnÄ™trzny. UsÅ‚uga dziaÅ‚a rÃ³wnieÅ¼ jako **wywaÅ¼arka obciÄ…Å¼enia, gdy 2 pody sÄ… podÅ‚Ä…czone** do tej samej usÅ‚ugi.\
Gdy **usÅ‚uga** jest **utworzona**, moÅ¼na znaleÅºÄ‡ punkty koÅ„cowe kaÅ¼dej usÅ‚ugi wykonujÄ…c `kubectl get endpoints`
* **Kubelet**: GÅ‚Ã³wny agent wÄ™zÅ‚a. SkÅ‚adnik, ktÃ³ry nawiÄ…zuje komunikacjÄ™ miÄ™dzy wÄ™zÅ‚em a kubectl, i moÅ¼e uruchamiaÄ‡ tylko pody (poprzez serwer API). Kubelet nie zarzÄ…dza kontenerami, ktÃ³re nie zostaÅ‚y utworzone przez Kubernetes.
* **Kube-proxy**: jest usÅ‚ugÄ… odpowiedzialnÄ… za komunikacjÄ™ (usÅ‚ugi) miÄ™dzy serwerem API a wÄ™zÅ‚em. PodstawÄ… jest IPtables dla wÄ™zÅ‚Ã³w. Bardziej doÅ›wiadczeni uÅ¼ytkownicy mogÄ… zainstalowaÄ‡ inne kube-proxy od innych dostawcÃ³w.
* **Kontener pomocniczy (Sidecar container)**: Kontenery pomocnicze to kontenery, ktÃ³re powinny dziaÅ‚aÄ‡ razem z gÅ‚Ã³wnym kontenerem w podzie. Ten wzorzec kontenera pomocniczego rozszerza i ulepsza funkcjonalnoÅ›Ä‡ bieÅ¼Ä…cych kontenerÃ³w bez ich zmiany. Obecnie wiemy, Å¼e uÅ¼ywamy technologii kontenerÃ³w do spakowania wszystkich zaleÅ¼noÅ›ci potrzebnych do uruchomienia aplikacji w dowolnym miejscu. Kontener robi tylko jednÄ… rzecz i robi to bardzo dobrze.
* **Proces gÅ‚Ã³wny:**
* **Serwer API:** Jest to sposÃ³b, w jaki uÅ¼ytkownicy i pody komunikujÄ… siÄ™ z procesem gÅ‚Ã³wnym. Powinny byÄ‡ dozwolone tylko uwierzytelnione Å¼Ä…dania.
* **Planista (Scheduler)**: Planowanie oznacza zapewnienie, Å¼e Pody sÄ… dopasowane do WÄ™zÅ‚Ã³w, aby Kubelet mÃ³gÅ‚ je uruchomiÄ‡. Ma wystarczajÄ…co duÅ¼o inteligencji, aby zdecydowaÄ‡, ktÃ³ry wÄ™zeÅ‚ ma wiÄ™cej dostÄ™pnych zasobÃ³w i przypisaÄ‡ nowy pod do niego. NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e planista nie uruchamia nowych podÃ³w, tylko komunikuje siÄ™ z procesem Kubelet dziaÅ‚ajÄ…cym wewnÄ…trz wÄ™zÅ‚a, ktÃ³ry uruchomi nowy pod.
* **MenedÅ¼er kontrolera Kubernetesa**: Sprawdza zasoby, takie jak zbiory replik lub wdroÅ¼enia, aby sprawdziÄ‡, czy na przykÅ‚ad prawidÅ‚owa liczba podÃ³w lub wÄ™zÅ‚Ã³w jest uruchomiona. W przypadku braku poda, skontaktuje siÄ™ z planistÄ…, aby uruchomiÄ‡ nowy. Kontroluje replikacje, tokeny i usÅ‚ugi konta do interfejsu API.
* **etcd**: Przechowywanie danych, trwaÅ‚e, spÃ³jne i rozproszone. Jest to baza danych Kubernetes i przechowywania kluczy-wartoÅ›ci, w ktÃ³rej przechowuje peÅ‚ny stan klastrÃ³w (kaÅ¼da zmiana jest rejestrowana tutaj). SkÅ‚adniki takie jak Planista lub MenedÅ¼er kontrolera zaleÅ¼Ä… od tych danych, aby wiedzieÄ‡, jakie zmiany nastÄ…piÅ‚y (dostÄ™pne zasoby wÄ™zÅ‚Ã³w, liczba uruchomionych podÃ³w...)
* **MenedÅ¼er kontrolera chmury (Cloud controller manager)**: Jest to konkretny kontroler do sterowania przepÅ‚ywem i aplikacjami, np. jeÅ›li masz klastry w AWS lub OpenStack.

NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e poniewaÅ¼ moÅ¼e byÄ‡ kilka wÄ™zÅ‚Ã³w (uruchamiajÄ…cych kilka podÃ³w), moÅ¼e byÄ‡ rÃ³wnieÅ¼ kilka procesÃ³w gÅ‚Ã³wnych, ktÃ³rych dostÄ™p do serwera API jest zrÃ³wnowaÅ¼ony obciÄ…Å¼eniowo, a ich etcd zsynchronizowany.

**Woluminy:**

Gdy pod tworzy dane, ktÃ³re nie powinny zostaÄ‡ utracone po znikniÄ™ciu poda, powinny byÄ‡ przechowywane w woluminie fizycznym. **Kubernetes pozwala doÅ‚Ä…czyÄ‡ wolumin do poda, aby zachowaÄ‡ dane**. Wolumin moÅ¼e byÄ‡ na lokalnej maszynie lub w **zdalnym magazynie**. JeÅ›li uruchamiasz pody na rÃ³Å¼nych fizycznych wÄ™zÅ‚ach, powinieneÅ› uÅ¼yÄ‡ zdalnego magazynu, aby wszystkie pody miaÅ‚y do niego dostÄ™p.

**Inne konfiguracje:**

* **ConfigMap**: MoÅ¼esz skonfigurowaÄ‡ **adresy URL** do dostÄ™pu do usÅ‚ug. Pod pobierze dane stÄ…d, aby wiedzieÄ‡, jak komunikowaÄ‡ siÄ™ z resztÄ… usÅ‚ug (podÃ³w). NaleÅ¼y pamiÄ™taÄ‡, Å¼e to nie jest zalecane miejsce do przechowywania poufnych informacji!
* **Secret**: To jest miejsce do **przechowywania poufnych danych** takich jak hasÅ‚a, klucze API... zakodowane w B64. Pod bÄ™dzie mÃ³gÅ‚ uzyskaÄ‡ dostÄ™p do tych danych, aby uÅ¼yÄ‡ wymaganych poÅ›wiadczeÅ„.
* **WdroÅ¼enia (Deployments)**: Tutaj wskazuje siÄ™ komponenty do uruchomienia przez kubernetes. UÅ¼ytkownik zazwyczaj nie bÄ™dzie bezpoÅ›rednio pracowaÄ‡ z podami, pody sÄ… zasÅ‚oniÄ™te w **Zbiorach replik** (liczba tych samych replikowanych podÃ³w), ktÃ³re sÄ… uruchamiane za pomocÄ… wdroÅ¼eÅ„. NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e wdroÅ¼enia sÄ… przeznaczone dla **aplikacji bezstanowych**. MinimalnÄ… konfiguracjÄ… dla wdroÅ¼enia jest nazwa i obraz do uruchomienia.
* **StatefulSet**: Ten komponent jest przeznaczony specjalnie dla aplikacji takich jak **bazy danych**, ktÃ³re muszÄ… **uzyskaÄ‡ dostÄ™p do tego samego magazynu**.
* **Ingress**: To jest konfiguracja, ktÃ³ra sÅ‚uÅ¼y do **eksponowania aplikacji publicznie za pomocÄ… adresu URL**. NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e moÅ¼na to rÃ³wnieÅ¼ zrobiÄ‡ za pomocÄ… usÅ‚ug zewnÄ™trznych, ale to jest poprawny sposÃ³b eksponowania aplikacji.
* JeÅ›li wdroÅ¼ysz Ingress, bÄ™dziesz musiaÅ‚ utworzyÄ‡ **Kontrolery Ingress**. Kontroler Ingress to **pod**, ktÃ³ry bÄ™dzie punktem koÅ„cowym, ktÃ³ry otrzyma Å¼Ä…dania, sprawdzi je i rozÅ‚oÅ¼y je rÃ³wnomiernie na usÅ‚ugi. kontroler Ingress bÄ™dzie **wysyÅ‚aÄ‡ Å¼Ä…danie na podstawie skonfigurowanych reguÅ‚ Ingress**. NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e reguÅ‚y Ingress mogÄ… wskazywaÄ‡ na rÃ³Å¼ne Å›cieÅ¼ki lub nawet subdomeny do rÃ³Å¼nych wewnÄ™trznych usÅ‚ug kubernetes.
* LepszÄ… praktykÄ… bezpieczeÅ„stwa byÅ‚oby uÅ¼ycie rÃ³wnowaÅ¼nika obciÄ…Å¼enia chmury lub serwera proxy jako punktu wejÅ›cia, aby Å¼adna czÄ™Å›Ä‡ klastra Kubernetes nie byÅ‚a wystawiona.
* Gdy Å¼Ä…danie, ktÃ³re nie pasuje do Å¼adnej reguÅ‚y Ingress, zostanie otrzymane, kontroler Ingress przekieruje je do "**DomyÅ›lnego backendu**". MoÅ¼esz uÅ¼yÄ‡ `describe`, aby uzyskaÄ‡ adres tego parametru. 
* `minikube addons enable ingress`
### Infrastruktura PKI - Certyfikat CA:

![](https://sickrov.github.io/media/Screenshot-66.jpg)

* CA jest zaufanym ÅºrÃ³dÅ‚em dla wszystkich certyfikatÃ³w wewnÄ…trz klastra.
* UmoÅ¼liwia komponentom weryfikacjÄ™ siebie nawzajem.
* Wszystkie certyfikaty klastra sÄ… podpisane przez CA.
* ETCd ma swÃ³j wÅ‚asny certyfikat.
* Typy:
  * certyfikat apiservera.
  * certyfikat kubeleta.
  * certyfikat schedulera.

## Podstawowe dziaÅ‚ania

### Minikube

**Minikube** moÅ¼na uÅ¼yÄ‡ do przeprowadzenia **szybkich testÃ³w** na kubernetes bez koniecznoÅ›ci wdraÅ¼ania caÅ‚ego Å›rodowiska kubernetes. Uruchomi on **procesy master i node na jednej maszynie**. Minikube bÄ™dzie uÅ¼ywaÄ‡ virtualboxa do uruchomienia noda. Zobacz [**tutaj, jak go zainstalowaÄ‡**](https://minikube.sigs.k8s.io/docs/start/).
```
$ minikube start
ğŸ˜„  minikube v1.19.0 on Ubuntu 20.04
âœ¨  Automatically selected the virtualbox driver. Other choices: none, ssh
ğŸ’¿  Downloading VM boot image ...
> minikube-v1.19.0.iso.sha256: 65 B / 65 B [-------------] 100.00% ? p/s 0s
> minikube-v1.19.0.iso: 244.49 MiB / 244.49 MiB  100.00% 1.78 MiB p/s 2m17.
ğŸ‘  Starting control plane node minikube in cluster minikube
ğŸ’¾  Downloading Kubernetes v1.20.2 preload ...
> preloaded-images-k8s-v10-v1...: 491.71 MiB / 491.71 MiB  100.00% 2.59 MiB
ğŸ”¥  Creating virtualbox VM (CPUs=2, Memory=3900MB, Disk=20000MB) ...
ğŸ³  Preparing Kubernetes v1.20.2 on Docker 20.10.4 ...
â–ª Generating certificates and keys ...
â–ª Booting up control plane ...
â–ª Configuring RBAC rules ...
ğŸ”  Verifying Kubernetes components...
â–ª Using image gcr.io/k8s-minikube/storage-provisioner:v5
ğŸŒŸ  Enabled addons: storage-provisioner, default-storageclass
ğŸ„  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by defaul

$ minikube status
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured

---- ONCE YOU HAVE A K8 SERVICE RUNNING WITH AN EXTERNAL SERVICE -----
$ minikube service mongo-express-service
(This will open your browser to access the service exposed port)

$ minikube delete
ğŸ”¥  Deleting "minikube" in virtualbox ...
ğŸ’€  Removed all traces of the "minikube" cluster
```
### Podstawy Kubectl

**`Kubectl`** to narzÄ™dzie wiersza poleceÅ„ do klastrow kubernetes. Komunikuje siÄ™ z serwerem Api procesu gÅ‚Ã³wnego, aby wykonywaÄ‡ czynnoÅ›ci w kubernetes lub prosiÄ‡ o dane.
```bash
kubectl version #Get client and server version
kubectl get pod
kubectl get services
kubectl get deployment
kubectl get replicaset
kubectl get secret
kubectl get all
kubectl get ingress
kubectl get endpoints

#kubectl create deployment <deployment-name> --image=<docker image>
kubectl create deployment nginx-deployment --image=nginx
#Access the configuration of the deployment and modify it
#kubectl edit deployment <deployment-name>
kubectl edit deployment nginx-deployment
#Get the logs of the pod for debbugging (the output of the docker container running)
#kubectl logs <replicaset-id/pod-id>
kubectl logs nginx-deployment-84cd76b964
#kubectl describe pod <pod-id>
kubectl describe pod mongo-depl-5fd6b7d4b4-kkt9q
#kubectl exec -it <pod-id> -- bash
kubectl exec -it mongo-depl-5fd6b7d4b4-kkt9q -- bash
#kubectl describe service <service-name>
kubectl describe service mongodb-service
#kubectl delete deployment <deployment-name>
kubectl delete deployment mongo-depl
#Deploy from config file
kubectl apply -f deployment.yml
```
### Panel Minikube

Panel pozwala Å‚atwiej zobaczyÄ‡, co jest uruchomione w minikube, moÅ¼esz znaleÅºÄ‡ URL dostÄ™pu tutaj:
```
minikube dashboard --url


ğŸ”Œ  Enabling dashboard ...
â–ª Using image kubernetesui/dashboard:v2.3.1
â–ª Using image kubernetesui/metrics-scraper:v1.0.7
ğŸ¤”  Verifying dashboard health ...
ğŸš€  Launching proxy ...
ğŸ¤”  Verifying proxy health ...
http://127.0.0.1:50034/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/
```
### PrzykÅ‚ady plikÃ³w konfiguracyjnych YAML

KaÅ¼dy plik konfiguracyjny skÅ‚ada siÄ™ z 3 czÄ™Å›ci: **metadanych**, **specyfikacji** (co ma zostaÄ‡ uruchomione), **stanu** (stan docelowy).\
WewnÄ…trz specyfikacji pliku konfiguracyjnego wdroÅ¼enia moÅ¼na znaleÅºÄ‡ szablon zdefiniowany za pomocÄ… nowej struktury konfiguracyjnej okreÅ›lajÄ…cej obraz do uruchomienia:

**PrzykÅ‚ad deklaracji wdroÅ¼enia + usÅ‚ugi w tym samym pliku konfiguracyjnym (z** [**tutaj**](https://gitlab.com/nanuchi/youtube-tutorial-series/-/blob/master/demo-kubernetes-components/mongo.yaml)**)**

PoniewaÅ¼ usÅ‚uga zazwyczaj jest powiÄ…zana z jednym wdroÅ¼eniem, moÅ¼na zadeklarowaÄ‡ obie rzeczy w tym samym pliku konfiguracyjnym (usÅ‚uga zadeklarowana w tej konfiguracji jest dostÄ™pna tylko wewnÄ™trznie):
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
name: mongodb-deployment
labels:
app: mongodb
spec:
replicas: 1
selector:
matchLabels:
app: mongodb
template:
metadata:
labels:
app: mongodb
spec:
containers:
- name: mongodb
image: mongo
ports:
- containerPort: 27017
env:
- name: MONGO_INITDB_ROOT_USERNAME
valueFrom:
secretKeyRef:
name: mongodb-secret
key: mongo-root-username
- name: MONGO_INITDB_ROOT_PASSWORD
valueFrom:
secretKeyRef:
name: mongodb-secret
key: mongo-root-password
---
apiVersion: v1
kind: Service
metadata:
name: mongodb-service
spec:
selector:
app: mongodb
ports:
- protocol: TCP
port: 27017
targetPort: 27017
```
**PrzykÅ‚ad konfiguracji usÅ‚ugi zewnÄ™trznej**

Ta usÅ‚uga bÄ™dzie dostÄ™pna zewnÄ™trznie (sprawdÅº atrybuty `nodePort` i `type: LoadBalancer`):
```yaml
---
apiVersion: v1
kind: Service
metadata:
name: mongo-express-service
spec:
selector:
app: mongo-express
type: LoadBalancer
ports:
- protocol: TCP
port: 8081
targetPort: 8081
nodePort: 30000
```
{% hint style="info" %}
To jest przydatne do testowania, ale do produkcji powinieneÅ› mieÄ‡ tylko usÅ‚ugi wewnÄ™trzne i Ingress do wystawiania aplikacji.
{% endhint %}

**PrzykÅ‚ad pliku konfiguracyjnego Ingress**

To wystawi aplikacjÄ™ pod adresem `http://dashboard.com`.
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
name: dashboard-ingress
namespace: kubernetes-dashboard
spec:
rules:
- host: dashboard.com
http:
paths:
- backend:
serviceName: kubernetes-dashboard
servicePort: 80
```
**PrzykÅ‚ad pliku konfiguracyjnego z tajemnicami**

ZauwaÅ¼, jak hasÅ‚a sÄ… zakodowane w B64 (co nie jest bezpieczne!)
```yaml
apiVersion: v1
kind: Secret
metadata:
name: mongodb-secret
type: Opaque
data:
mongo-root-username: dXNlcm5hbWU=
mongo-root-password: cGFzc3dvcmQ=
```
**PrzykÅ‚ad ConfigMap**

**ConfigMap** to konfiguracja przekazywana do kapsuÅ‚ek, dziÄ™ki ktÃ³rej wiedzÄ…, jak zlokalizowaÄ‡ i uzyskaÄ‡ dostÄ™p do innych usÅ‚ug. W tym przypadku kaÅ¼da kapsuÅ‚ka bÄ™dzie wiedziaÅ‚a, Å¼e nazwa `mongodb-service` to adres kapsuÅ‚ki, z ktÃ³rÄ… mogÄ… siÄ™ komunikowaÄ‡ (ta kapsuÅ‚ka bÄ™dzie wykonywaÅ‚a mongodb):
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
name: mongodb-configmap
data:
database_url: mongodb-service
```
NastÄ™pnie, wewnÄ…trz konfiguracji **deploymentu** ten adres moÅ¼na okreÅ›liÄ‡ w nastÄ™pujÄ…cy sposÃ³b, aby zostaÅ‚ zaÅ‚adowany do Å›rodowiska poda:
```yaml
[...]
spec:
[...]
template:
[...]
spec:
containers:
- name: mongo-express
image: mongo-express
ports:
- containerPort: 8081
env:
- name: ME_CONFIG_MONGODB_SERVER
valueFrom:
configMapKeyRef:
name: mongodb-configmap
key: database_url
[...]
```
**PrzykÅ‚ad konfiguracji woluminu**

MoÅ¼esz znaleÅºÄ‡ rÃ³Å¼ne przykÅ‚ady plikÃ³w konfiguracyjnych yaml dotyczÄ…cych przechowywania na stronie [https://gitlab.com/nanuchi/youtube-tutorial-series/-/tree/master/kubernetes-volumes](https://gitlab.com/nanuchi/youtube-tutorial-series/-/tree/master/kubernetes-volumes).\
**ZauwaÅ¼, Å¼e woluminy nie znajdujÄ… siÄ™ w przestrzeniach nazw**

### Przestrzenie nazw

Kubernetes obsÅ‚uguje **wiele wirtualnych klastrÃ³w** wspieranych przez ten sam fizyczny klaster. Te wirtualne klastry nazywane sÄ… **przestrzeniami nazw**. SÄ… one przeznaczone do uÅ¼ytku w Å›rodowiskach z wieloma uÅ¼ytkownikami rozproszonymi po rÃ³Å¼nych zespoÅ‚ach lub projektach. Dla klastrÃ³w z kilkoma do kilkudziesiÄ™ciu uÅ¼ytkownikÃ³w nie powinieneÅ› w ogÃ³le musieÄ‡ tworzyÄ‡ ani myÅ›leÄ‡ o przestrzeniach nazw. PowinieneÅ› zaczÄ…Ä‡ uÅ¼ywaÄ‡ przestrzeni nazw tylko po to, aby lepiej kontrolowaÄ‡ i organizowaÄ‡ kaÅ¼dÄ… czÄ™Å›Ä‡ aplikacji wdroÅ¼onej w kubernetes.

Przestrzenie nazw zapewniajÄ… zakres dla nazw. Nazwy zasobÃ³w muszÄ… byÄ‡ unikalne w obrÄ™bie przestrzeni nazw, ale nie w obrÄ™bie rÃ³Å¼nych przestrzeni nazw. Przestrzenie nazw nie mogÄ… byÄ‡ zagnieÅ¼dÅ¼ane wewnÄ…trz siebie, a **kaÅ¼dy** zasÃ³b **Kubernetes** moÅ¼e znajdowaÄ‡ siÄ™ tylko **w** **jednej** **przestrzeni nazw**.

DomyÅ›lnie istnieje 4 przestrzenie nazw, jeÅ›li korzystasz z minikube:
```
kubectl get namespace
NAME              STATUS   AGE
default           Active   1d
kube-node-lease   Active   1d
kube-public       Active   1d
kube-system       Active   1d
```
* **kube-system**: Nie jest przeznaczony do uÅ¼ytku przez uÅ¼ytkownikÃ³w i nie powinieneÅ› go dotykaÄ‡. SÅ‚uÅ¼y do procesÃ³w master i kubectl.
* **kube-public**: Publicznie dostÄ™pne dane. Zawiera configmapÄ™, ktÃ³ra zawiera informacje o klastrze.
* **kube-node-lease**: OkreÅ›la dostÄ™pnoÅ›Ä‡ wÄ™zÅ‚a.
* **default**: PrzestrzeÅ„ nazw, ktÃ³rÄ… uÅ¼ytkownik bÄ™dzie uÅ¼ywaÅ‚ do tworzenia zasobÃ³w.
```bash
#Create namespace
kubectl create namespace my-namespace
```
{% hint style="info" %}
NaleÅ¼y pamiÄ™taÄ‡, Å¼e wiÄ™kszoÅ›Ä‡ zasobÃ³w Kubernetes (np. pods, services, kontrolery replikacji i inne) znajduje siÄ™ w pewnych przestrzeniach nazw. Jednak inne zasoby, takie jak zasoby przestrzeni nazw i zasoby niskiego poziomu, takie jak wÄ™zÅ‚y i persistenVolumes, nie znajdujÄ… siÄ™ w przestrzeni nazw. Aby sprawdziÄ‡, ktÃ³re zasoby Kubernetes znajdujÄ… siÄ™ w przestrzeni nazw, a ktÃ³re nie:
```bash
kubectl api-resources --namespaced=true #In a namespace
kubectl api-resources --namespaced=false #Not in a namespace
```
{% endhint %}

MoÅ¼esz zapisaÄ‡ przestrzeÅ„ nazw dla wszystkich kolejnych poleceÅ„ kubectl w tym kontekÅ›cie.
```bash
kubectl config set-context --current --namespace=<insert-namespace-name-here>
```
### Helm

Helm jest **menedÅ¼erem pakietÃ³w** dla Kubernetesa. Pozwala spakowaÄ‡ pliki YAML i rozpowszechniaÄ‡ je w publicznych i prywatnych repozytoriach. Te pakiety nazywane sÄ… **wykresami Helma**.
```
helm search <keyword>
```
## Sekrety Kubernetes

**Sekret** to obiekt, ktÃ³ry **zawiera poufne dane** takie jak hasÅ‚o, token lub klucz. Takie informacje mogÄ… byÄ‡ umieszczone w specyfikacji Pod lub w obrazie. UÅ¼ytkownicy mogÄ… tworzyÄ‡ Sekrety, a system rÃ³wnieÅ¼ tworzy Sekrety. Nazwa obiektu Sekretu musi byÄ‡ prawidÅ‚owÄ… **nazwÄ… poddomeny DNS**. Przeczytaj tutaj [oficjalnÄ… dokumentacjÄ™](https://kubernetes.io/docs/concepts/configuration/secret/).

Sekrety mogÄ… zawieraÄ‡:

- Klucze API, SSH.
- Tokeny OAuth.
- PoÅ›wiadczenia, hasÅ‚a (czysty tekst lub b64 + szyfrowanie).
- Informacje lub komentarze.
- Kod Å‚Ä…czenia z bazÄ… danych, ciÄ…gi... .

IstniejÄ… rÃ³Å¼ne typy sekretÃ³w w Kubernetes

| Typ wbudowany                       | UÅ¼ycie                                    |
| ----------------------------------- | ----------------------------------------- |
| **Opaque**                          | **dowolne dane zdefiniowane przez uÅ¼ytkownika (DomyÅ›lne)** |
| kubernetes.io/service-account-token | token konta usÅ‚ugi                       |
| kubernetes.io/dockercfg             | zserializowany plik \~/.dockercfg         |
| kubernetes.io/dockerconfigjson      | zserializowany plik \~/.docker/config.json|
| kubernetes.io/basic-auth            | poÅ›wiadczenia do autentykacji podstawowej |
| kubernetes.io/ssh-auth              | poÅ›wiadczenia do autentykacji SSH        |
| kubernetes.io/tls                   | dane dla klienta lub serwera TLS         |
| bootstrap.kubernetes.io/token       | dane tokena startowego                   |

{% hint style="info" %}
**Typ Opaque jest domyÅ›lny, to typowy zestaw klucz-wartoÅ›Ä‡ zdefiniowany przez uÅ¼ytkownikÃ³w.**
{% endhint %}

**Jak dziaÅ‚ajÄ… sekrety:**

![](https://sickrov.github.io/media/Screenshot-164.jpg)

PoniÅ¼szy plik konfiguracyjny definiuje **sekret** o nazwie `mysecret` z 2 parami klucz-wartoÅ›Ä‡ `username: YWRtaW4=` i `password: MWYyZDFlMmU2N2Rm`. Definiuje rÃ³wnieÅ¼ **pod** o nazwie `secretpod`, ktÃ³ry bÄ™dzie miaÅ‚ `username` i `password` zdefiniowane w `mysecret` ujawnione w **zmiennych Å›rodowiskowych** `SECRET_USERNAME` i `SECRET_PASSWOR`. BÄ™dzie rÃ³wnieÅ¼ **zamontowany** sekret `username` wewnÄ…trz `mysecret` pod Å›cieÅ¼kÄ… `/etc/foo/my-group/my-username` z uprawnieniami `0640`.

{% code title="secretpod.yaml" %}
```yaml
apiVersion: v1
kind: Secret
metadata:
name: mysecret
type: Opaque
data:
username: YWRtaW4=
password: MWYyZDFlMmU2N2Rm
---
apiVersion: v1
kind: Pod
metadata:
name: secretpod
spec:
containers:
- name: secretpod
image: nginx
env:
- name: SECRET_USERNAME
valueFrom:
secretKeyRef:
name: mysecret
key: username
- name: SECRET_PASSWORD
valueFrom:
secretKeyRef:
name: mysecret
key: password
volumeMounts:
- name: foo
mountPath: "/etc/foo"
restartPolicy: Never
volumes:
- name: foo
secret:
secretName: mysecret
items:
- key: username
path: my-group/my-username
mode: 0640
```
{% endcode %}
```bash
kubectl apply -f <secretpod.yaml>
kubectl get pods #Wait until the pod secretpod is running
kubectl exec -it  secretpod -- bash
env | grep SECRET && cat /etc/foo/my-group/my-username && echo
```
### Sekrety w etcd <a href="#discover-secrets-in-etcd" id="discover-secrets-in-etcd"></a>

**etcd** to spÃ³jny i wysoce dostÄ™pny **sklep kluczy-wartoÅ›ci** uÅ¼ywany jako magazyn danych klastra Kubernetes. PozwÃ³lmy na dostÄ™p do przechowywanych w etcd sekretÃ³w:
```bash
cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep etcd
```
Zobaczysz, Å¼e certyfikaty, klucze i adresy URL znajdujÄ… siÄ™ w systemie plikÃ³w. Gdy je uzyskasz, bÄ™dziesz mÃ³gÅ‚ poÅ‚Ä…czyÄ‡ siÄ™ z etcd.
```bash
#ETCDCTL_API=3 etcdctl --cert <path to client.crt> --key <path to client.ket> --cacert <path to CA.cert> endpoint=[<ip:port>] health

ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/etcd/ca.cert endpoint=[127.0.0.1:1234] health
```
Gdy juÅ¼ osiÄ…gniesz nawiÄ…zanie komunikacji, bÄ™dziesz mÃ³gÅ‚ uzyskaÄ‡ tajemnice:
```bash
#ETCDCTL_API=3 etcdctl --cert <path to client.crt> --key <path to client.ket> --cacert <path to CA.cert> endpoint=[<ip:port>] get <path/to/secret>

ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/etcd/ca.cert endpoint=[127.0.0.1:1234] get /registry/secrets/default/secret_02
```
**Dodawanie szyfrowania do ETCD**

DomyÅ›lnie wszystkie tajemnice sÄ… przechowywane w formie **czystego** tekstu wewnÄ…trz etcd, chyba Å¼e zastosujesz warstwÄ™ szyfrowania. PoniÅ¼szy przykÅ‚ad jest oparty na [https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/](https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/)

{% code title="encryption.yaml" %}
```yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
- resources:
- secrets
providers:
- aescbc:
keys:
- name: key1
secret: cjjPMcWpTPKhAdieVtd+KhG4NN+N6e3NmBPMXJvbfrY= #Any random key
- identity: {}
```
{% endcode %}

NastÄ™pnie musisz ustawiÄ‡ flagÄ™ `--encryption-provider-config` na `kube-apiserver`, aby wskazywaÅ‚a na lokalizacjÄ™ utworzonego pliku konfiguracyjnego. MoÅ¼esz zmodyfikowaÄ‡ `/etc/kubernetes/manifest/kube-apiserver.yaml` i dodaÄ‡ nastÄ™pujÄ…ce linie:
```yaml
containers:
- command:
- kube-apiserver
- --encriyption-provider-config=/etc/kubernetes/etcd/<configFile.yaml>
```
PrzewiÅ„ w dÃ³Å‚ w sekcji volumeMounts:
```yaml
- mountPath: /etc/kubernetes/etcd
name: etcd
readOnly: true
```
PrzewiÅ„ w dÃ³Å‚ w volumeMounts do hostPath:
```yaml
- hostPath:
path: /etc/kubernetes/etcd
type: DirectoryOrCreate
name: etcd
```
**Weryfikacja, czy dane sÄ… zaszyfrowane**

Dane sÄ… szyfrowane podczas zapisywania do etcd. Po ponownym uruchomieniu `kube-apiserver`, kaÅ¼dy nowo utworzony lub zaktualizowany sekret powinien byÄ‡ zaszyfrowany podczas przechowywania. Aby sprawdziÄ‡, moÅ¼esz uÅ¼yÄ‡ programu wiersza poleceÅ„ `etcdctl`, aby pobraÄ‡ zawartoÅ›Ä‡ swojego sekretu.

1. UtwÃ³rz nowy sekret o nazwie `secret1` w przestrzeni nazw `default`:

```
kubectl create secret generic secret1 -n default --from-literal=mykey=mydata
```
2. KorzystajÄ…c z polecenia etcdctl, odczytaj ten sekret z etcd:

`ETCDCTL_API=3 etcdctl get /registry/secrets/default/secret1 [...] | hexdump -C`

gdzie `[...]` muszÄ… byÄ‡ dodatkowymi argumentami do poÅ‚Ä…czenia z serwerem etcd.
3. Zweryfikuj, czy przechowywany sekret jest poprzedzony `k8s:enc:aescbc:v1:`, co wskazuje, Å¼e dostawca `aescbc` zaszyfrowaÅ‚ dane wynikowe.
4. Zweryfikuj, czy sekret jest poprawnie odszyfrowany podczas pobierania za pomocÄ… interfejsu API:

```
kubectl describe secret secret1 -n default
```

powinno pasowaÄ‡ do `mykey: bXlkYXRh`, mydata jest zakodowana, sprawdÅº [dekodowanie sekretu](https://kubernetes.io/docs/concepts/configuration/secret#decoding-a-secret), aby caÅ‚kowicie odszyfrowaÄ‡ sekret.

**PoniewaÅ¼ sekrety sÄ… szyfrowane podczas zapisywania, wykonanie aktualizacji na sekrecie spowoduje zaszyfrowanie tego treÅ›ci:**
```
kubectl get secrets --all-namespaces -o json | kubectl replace -f -
```
**Ostateczne wskazÃ³wki:**

* Staraj siÄ™ nie przechowywaÄ‡ tajemnic w systemie plikÃ³w, pobieraj je z innych miejsc.
* SprawdÅº [https://www.vaultproject.io/](https://www.vaultproject.io) aby zwiÄ™kszyÄ‡ ochronÄ™ swoich tajemnic.
* [https://kubernetes.io/docs/concepts/configuration/secret/#risks](https://kubernetes.io/docs/concepts/configuration/secret/#risks)
* [https://docs.cyberark.com/Product-Doc/OnlineHelp/AAM-DAP/11.2/en/Content/Integrations/Kubernetes\_deployApplicationsConjur-k8s-Secrets.htm](https://docs.cyberark.com/Product-Doc/OnlineHelp/AAM-DAP/11.2/en/Content/Integrations/Kubernetes\_deployApplicationsConjur-k8s-Secrets.htm)

## Referencje

{% embed url="https://sickrov.github.io/" %}

{% embed url="https://www.youtube.com/watch?v=X48VuDVv0do" %}

{% hint style="success" %}
Naucz siÄ™ i Ä‡wicz hakowanie AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz siÄ™ i Ä‡wicz hakowanie GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
