# Kubernetes Temelleri

## Kubernetes Temelleri

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

**Bu sayfanÄ±n orijinal yazarÄ±** [**Jorge**](https://www.linkedin.com/in/jorge-belmonte-a924b616b/) **(orijinal yazÄ±sÄ±nÄ±** [**buradan**](https://sickrov.github.io)** okuyun)**

## MimarlÄ±k ve Temeller

### Kubernetes'Ä±n GÃ¶revleri Nelerdir?

* Bir veya birden fazla konteyneri bir konteyner motorunda Ã§alÄ±ÅŸtÄ±rmayÄ± saÄŸlar.
* Konteynerleri etkin bir ÅŸekilde planlar.
* Konteynerleri Ã§alÄ±ÅŸÄ±r durumda tutar.
* Konteynerler arasÄ±nda iletiÅŸimi saÄŸlar.
* DaÄŸÄ±tÄ±m tekniklerine izin verir.
* Bilgi hacimlerini yÃ¶netir.

### MimarlÄ±k

![](https://sickrov.github.io/media/Screenshot-68.jpg)

* **Node**: bir veya birden fazla pod ile iÅŸletim sistemi.
* **Pod**: Bir veya birden fazla konteynerle sarÄ±lmÄ±ÅŸ bir yapÄ±. Bir pod yalnÄ±zca bir uygulama iÃ§ermelidir (bu nedenle genellikle bir pod yalnÄ±zca 1 konteyner Ã§alÄ±ÅŸtÄ±rÄ±r). Pod, konteyner teknolojisini Ã§alÄ±ÅŸtÄ±ran Kubernetes'in soyutlama ÅŸeklidir.
* **Servis**: Her pod'un, dÃ¼ÄŸÃ¼mÃ¼n iÃ§indeki dahili bir **IP adresi** vardÄ±r. Bununla birlikte, servis aracÄ±lÄ±ÄŸÄ±yla da dÄ±ÅŸa aÃ§Ä±labilir. **Servisin de bir IP adresi vardÄ±r** ve amacÄ± podlar arasÄ±ndaki iletiÅŸimi sÃ¼rdÃ¼rmektir, bÃ¶ylece biri Ã¶ldÃ¼ÄŸÃ¼nde **yeni bir yedek** (farklÄ± bir dahili IP ile) **servisin aynÄ± IP'sinde eriÅŸilebilir olacaktÄ±r**. Servis iÃ§ veya dÄ±ÅŸ olarak yapÄ±landÄ±rÄ±labilir. Servis, 2 pod aynÄ± servise baÄŸlandÄ±ÄŸÄ±nda bir **yÃ¼k dengeleyici olarak da hareket eder**.\
Bir **servis** **oluÅŸturulduÄŸunda**, her servisin uÃ§ noktalarÄ±nÄ± `kubectl get endpoints` komutunu Ã§alÄ±ÅŸtÄ±rarak bulabilirsiniz.
* **Kubelet**: Ana dÃ¼ÄŸÃ¼m ajanÄ±. DÃ¼ÄŸÃ¼m ve kubectl arasÄ±nda iletiÅŸim kuran bileÅŸen ve yalnÄ±zca podlarÄ± Ã§alÄ±ÅŸtÄ±rabilir (API sunucusu aracÄ±lÄ±ÄŸÄ±yla). Kubelet, Kubernetes tarafÄ±ndan oluÅŸturulmayan konteynerleri yÃ¶netmez.
* **Kube-proxy**: apisunucusu ve dÃ¼ÄŸÃ¼m arasÄ±ndaki iletiÅŸimlerden sorumlu olan servistir. Temel olarak dÃ¼ÄŸÃ¼mler iÃ§in bir IPtables'tÄ±r. Deneyimli kullanÄ±cÄ±lar diÄŸer satÄ±cÄ±larÄ±n kube-proxy'lerini de kurabilir.
* **Sidecar konteyner**: Sidecar konteynerleri, ana konteynerle birlikte Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± gereken konteynerlerdir. Bu sidecar deseni, mevcut konteynerlerin iÅŸlevselliÄŸini geniÅŸletir ve geliÅŸtirir ve bunlarÄ± deÄŸiÅŸtirmeden gÃ¼nceller. GÃ¼nÃ¼mÃ¼zde, uygulamanÄ±n her yerde Ã§alÄ±ÅŸmasÄ± iÃ§in tÃ¼m baÄŸÄ±mlÄ±lÄ±klarÄ± sarmak iÃ§in konteyner teknolojisini kullandÄ±ÄŸÄ±mÄ±zÄ± biliyoruz. Bir konteyner yalnÄ±zca bir ÅŸey yapar ve bu iÅŸi Ã§ok iyi yapar.
* **Ana iÅŸlem:**
* **API Sunucusu:** KullanÄ±cÄ±larÄ±n ve podlarÄ±n ana iÅŸlemle iletiÅŸim kurmak iÃ§in kullandÄ±ÄŸÄ± yol. YalnÄ±zca kimlik doÄŸrulama yapÄ±lmÄ±ÅŸ isteklere izin verilmelidir.
* **ZamanlayÄ±cÄ±**: Pod'larÄ±n Kubelet tarafÄ±ndan Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in Pod'larÄ±n DÃ¼ÄŸÃ¼mlere eÅŸleÅŸtirildiÄŸinden emin olma iÅŸlemine atÄ±fta bulunur. Hangi dÃ¼ÄŸÃ¼mÃ¼n daha fazla kullanÄ±labilir kaynaÄŸa sahip olduÄŸuna karar vermek iÃ§in yeterli zekaya sahiptir ve yeni pod'u bu dÃ¼ÄŸÃ¼me atar. ZamanlayÄ±cÄ± yeni pod baÅŸlatmaz, yalnÄ±zca yeni pod'u baÅŸlatacak olan dÃ¼ÄŸÃ¼m iÃ§inde Ã§alÄ±ÅŸan Kubelet iÅŸlemiyle iletiÅŸim kurar.
* **Kube Denetleyici YÃ¶neticisi**: Ã–rneÄŸin, doÄŸru sayÄ±da pod veya dÃ¼ÄŸÃ¼mÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lÄ±p Ã§alÄ±ÅŸtÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in replika setleri veya daÄŸÄ±tÄ±mlar gibi kaynaklarÄ± kontrol eder. Bir pod eksikse, yeni bir tane baÅŸlatmak iÃ§in zamanlayÄ±cÄ±yla iletiÅŸim kurar. API'ya replikasyon, belirteÃ§ler ve hesap hizmetleri kontrol eder.
* **etcd**: Veri depolama, kalÄ±cÄ±, tutarlÄ± ve daÄŸÄ±tÄ±lmÄ±ÅŸtÄ±r. Kubernetes'in veritabanÄ±dÄ±r ve kÃ¼menin tam durumunu tuttuÄŸu anahtar-deÄŸer depolama alanÄ±dÄ±r (her deÄŸiÅŸiklik buraya kaydedilir). ZamanlayÄ±cÄ± veya Denetleyici YÃ¶neticisi gibi bileÅŸenler, hangi deÄŸiÅŸikliklerin meydana geldiÄŸini bilmek iÃ§in bu verilere baÄŸÄ±mlÄ±dÄ±r (dÃ¼ÄŸÃ¼mlerin mevcut kaynaklarÄ±, Ã§alÄ±ÅŸan pod sayÄ±sÄ±...).
* **Bulut denetleyici yÃ¶neticisi**: AkÄ±ÅŸ kontrolleri ve uygulamalar iÃ§in Ã¶zel denetleyicidir, Ã¶rneÄŸin: AWS veya OpenStack'te kÃ¼meleriniz varsa.

BirÃ§ok dÃ¼ÄŸÃ¼m olabileceÄŸi gibi (birÃ§ok pod Ã§alÄ±ÅŸtÄ±ran), aynÄ± zamanda yÃ¼k dengeleyiciye eriÅŸimleri yÃ¼k dengeleyici ve etcd'leri senkronize edilen birkaÃ§ ana iÅŸlem olabilir.

**Hacimler:**

Bir pod, pod kaybolduÄŸunda kaybolmamasÄ± gereken veriler oluÅŸturduÄŸunda, bu verilerin saklanmasÄ± iÃ§in bir fiziksel hacme baÄŸlanmasÄ±na izin verir. **Kubernetes, verileri korumak iÃ§in bir pod'a bir hacim eklemeyi saÄŸlar**. Hacim yerel makinede veya **uzak depolama**da olabilir. FarklÄ± fiziksel dÃ¼ÄŸÃ¼mlerde pod'larÄ± Ã§alÄ±ÅŸtÄ±rÄ±yorsanÄ±z, tÃ¼m pod'larÄ±n buna eriÅŸebilmesi iÃ§in uzak depolama kullanmalÄ±sÄ±nÄ±z.

**DiÄŸer yapÄ±landÄ±rmalar:**

* **ConfigMap**: Servislere eriÅŸmek iÃ§in **URL'leri yapÄ±landÄ±rabilirsiniz**. Pod, buradan veri alarak diÄŸer servislerle (podlarla) nasÄ±l iletiÅŸim kuracaÄŸÄ±nÄ± bilecektir. Bu yer kimlik bilgilerini saklamak iÃ§in Ã¶nerilen yer deÄŸildir!
* **Secret**: Bu, ÅŸifreler, API anahtarlarÄ± gibi **gizli verileri saklamak iÃ§in** yerdir, B64 ile kodlanmÄ±ÅŸtÄ±r. Pod, gerekli kimlik bilgilerini kullanmak iÃ§in bu verilere eriÅŸebilecektir.
* **DaÄŸÄ±tÄ±mlar**: Kubernetes tarafÄ±ndan Ã§alÄ±ÅŸtÄ±rÄ±lacak bileÅŸenlerin belirtildiÄŸi yerdir. Bir kullanÄ±cÄ± genellikle doÄŸrudan pod'larla Ã§alÄ±ÅŸmaz, pod'lar **ReplicaSet'lerde** (Ã§oÄŸaltÄ±lan aynÄ± pod sayÄ±sÄ±) soyutlanÄ±r ve daÄŸÄ±tÄ±mlar aracÄ±lÄ±ÄŸÄ±yla Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r. DaÄŸÄ±tÄ±mlarÄ±n **durumsuz** uygulamalar iÃ§in olduÄŸunu unutmayÄ±n. Bir daÄŸÄ±tÄ±m iÃ§in minimum yapÄ±landÄ±rma adÄ± ve Ã§alÄ±ÅŸtÄ±rÄ±lacak gÃ¶rÃ¼ntÃ¼dÃ¼r.
* **StatefulSet**: Bu bileÅŸen, **veritabanlarÄ±** gibi **aynÄ± depolama alanÄ±na eriÅŸim gerektiren** uygulamalar iÃ§in Ã¶zel olarak tasarlanmÄ±ÅŸtÄ±r.
* **Ingress**: Bu, uygulamanÄ±n **URL ile halka aÃ§Ä±lmasÄ±nÄ± yapÄ±landÄ±rmak iÃ§in** kullanÄ±lan yapÄ±landÄ±rmadÄ±r. Bu, harici servisler kullanÄ±larak da yapÄ±labilir, ancak uygulamanÄ±n aÃ§Ä±lmasÄ± iÃ§in doÄŸru yol budur.
* Bir Ingress uygularsanÄ±z **Ingress Denetleyicileri** oluÅŸturmanÄ±z gerekecektir. Ingress Denetleyicisi, istekleri alacak ve kontrol edecek bir **pod** olacaktÄ±r ve bunlarÄ± hizmetlere yÃ¼k dengeleyecektir. Ingress denetleyicisi, **yapÄ±landÄ±rÄ±lan ingress kurallarÄ±na gÃ¶re isteÄŸi yÃ¶nlendirecektir**. Ingress kurallarÄ± farklÄ± yollara veya hatta farklÄ± dahili kubernetes servislerine farklÄ± alt alanlara iÅŸaret edebilir.
* Daha iyi bir gÃ¼venlik uygulamasÄ±, Kubernetes kÃ¼mesinin herhangi bir bÃ¶lÃ¼mÃ¼nÃ¼n aÃ§Ä±kta olmamasÄ± iÃ§in giriÅŸ noktasÄ± olarak bir bulut yÃ¼k dengeleyici veya bir proxy sunucusu kullanmaktÄ±r.
* EÅŸleÅŸmeyen bir ingress kuralÄ± alan bir istek alÄ±ndÄ±ÄŸÄ±nda, ingress denetleyicisi bunu "**VarsayÄ±lan arka uca**" yÃ¶nlendirecektir. Bu parametrenin adresini almak iÃ§in ingress denetleyicisini `describe` edebilirsiniz.
* `minikube addons enable ingress`
### PKI altyapÄ±sÄ± - Sertifika Otoritesi CA:

![](https://sickrov.github.io/media/Screenshot-66.jpg)

* CA, kÃ¼me iÃ§indeki tÃ¼m sertifikalar iÃ§in gÃ¼venilir kÃ¶ktÃ¼r.
* BileÅŸenlerin birbirini doÄŸrulamasÄ±na izin verir.
* TÃ¼m kÃ¼me sertifikalarÄ± CA tarafÄ±ndan imzalanmÄ±ÅŸtÄ±r.
* ETCd'nin kendi sertifikasÄ± vardÄ±r.
* tÃ¼rler:
  * apiserver sertifikasÄ±.
  * kubelet sertifikasÄ±.
  * scheduler sertifikasÄ±.

## Temel Eylemler

### Minikube

**Minikube**, tÃ¼m bir kubernetes ortamÄ±nÄ± daÄŸÄ±tmaya gerek olmadan kubernetes Ã¼zerinde bazÄ± **hÄ±zlÄ± testler** yapmak iÃ§in kullanÄ±labilir. **Master ve node iÅŸlemlerini aynÄ± makinede Ã§alÄ±ÅŸtÄ±racaktÄ±r**. Minikube, dÃ¼ÄŸÃ¼mÃ¼ Ã§alÄ±ÅŸtÄ±rmak iÃ§in virtualbox'Ä± kullanacaktÄ±r. [**Buradan nasÄ±l kurulacaÄŸÄ±nÄ±**](https://minikube.sigs.k8s.io/docs/start/) gÃ¶rÃ¼n.
```
$ minikube start
ğŸ˜„  minikube v1.19.0 on Ubuntu 20.04
âœ¨  Automatically selected the virtualbox driver. Other choices: none, ssh
ğŸ’¿  Downloading VM boot image ...
> minikube-v1.19.0.iso.sha256: 65 B / 65 B [-------------] 100.00% ? p/s 0s
> minikube-v1.19.0.iso: 244.49 MiB / 244.49 MiB  100.00% 1.78 MiB p/s 2m17.
ğŸ‘  Starting control plane node minikube in cluster minikube
ğŸ’¾  Downloading Kubernetes v1.20.2 preload ...
> preloaded-images-k8s-v10-v1...: 491.71 MiB / 491.71 MiB  100.00% 2.59 MiB
ğŸ”¥  Creating virtualbox VM (CPUs=2, Memory=3900MB, Disk=20000MB) ...
ğŸ³  Preparing Kubernetes v1.20.2 on Docker 20.10.4 ...
â–ª Generating certificates and keys ...
â–ª Booting up control plane ...
â–ª Configuring RBAC rules ...
ğŸ”  Verifying Kubernetes components...
â–ª Using image gcr.io/k8s-minikube/storage-provisioner:v5
ğŸŒŸ  Enabled addons: storage-provisioner, default-storageclass
ğŸ„  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by defaul

$ minikube status
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured

---- ONCE YOU HAVE A K8 SERVICE RUNNING WITH AN EXTERNAL SERVICE -----
$ minikube service mongo-express-service
(This will open your browser to access the service exposed port)

$ minikube delete
ğŸ”¥  Deleting "minikube" in virtualbox ...
ğŸ’€  Removed all traces of the "minikube" cluster
```
### Kubectl Temelleri

**`Kubectl`**, kubernetes kÃ¼meleri iÃ§in komut satÄ±rÄ± aracÄ±dÄ±r. Kubernetes'te iÅŸlemler gerÃ§ekleÅŸtirmek veya veri istemek iÃ§in ana iÅŸlem Api sunucusu ile iletiÅŸim kurar.
```bash
kubectl version #Get client and server version
kubectl get pod
kubectl get services
kubectl get deployment
kubectl get replicaset
kubectl get secret
kubectl get all
kubectl get ingress
kubectl get endpoints

#kubectl create deployment <deployment-name> --image=<docker image>
kubectl create deployment nginx-deployment --image=nginx
#Access the configuration of the deployment and modify it
#kubectl edit deployment <deployment-name>
kubectl edit deployment nginx-deployment
#Get the logs of the pod for debbugging (the output of the docker container running)
#kubectl logs <replicaset-id/pod-id>
kubectl logs nginx-deployment-84cd76b964
#kubectl describe pod <pod-id>
kubectl describe pod mongo-depl-5fd6b7d4b4-kkt9q
#kubectl exec -it <pod-id> -- bash
kubectl exec -it mongo-depl-5fd6b7d4b4-kkt9q -- bash
#kubectl describe service <service-name>
kubectl describe service mongodb-service
#kubectl delete deployment <deployment-name>
kubectl delete deployment mongo-depl
#Deploy from config file
kubectl apply -f deployment.yml
```
### Minikube Kontrol Paneli

Kontrol paneli, minikube'un ne Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± daha kolay gÃ¶rmek iÃ§in size olanak tanÄ±r, eriÅŸmek iÃ§in URL'yi aÅŸaÄŸÄ±da bulabilirsiniz:
```
minikube dashboard --url


ğŸ”Œ  Enabling dashboard ...
â–ª Using image kubernetesui/dashboard:v2.3.1
â–ª Using image kubernetesui/metrics-scraper:v1.0.7
ğŸ¤”  Verifying dashboard health ...
ğŸš€  Launching proxy ...
ğŸ¤”  Verifying proxy health ...
http://127.0.0.1:50034/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/
```
### YAML yapÄ±landÄ±rma dosyalarÄ± Ã¶rnekleri

Her yapÄ±landÄ±rma dosyasÄ± 3 bÃ¶lÃ¼me sahiptir: **metadata**, **specification** (baÅŸlatÄ±lmasÄ± gerekenler), **status** (istenen durum).\
DaÄŸÄ±tÄ±m yapÄ±landÄ±rma dosyasÄ±nÄ±n Ã¶zellikleri iÃ§inde, Ã§alÄ±ÅŸtÄ±rÄ±lacak gÃ¶rÃ¼ntÃ¼yÃ¼ tanÄ±mlayan yeni bir yapÄ±landÄ±rma yapÄ±sÄ± ile tanÄ±mlanan ÅŸablonu bulabilirsiniz:

**AynÄ± yapÄ±landÄ±rma dosyasÄ±nda bildirilen DaÄŸÄ±tÄ±m + Servis Ã¶rneÄŸi (buradan** [**buraya**](https://gitlab.com/nanuchi/youtube-tutorial-series/-/blob/master/demo-kubernetes-components/mongo.yaml)**)**

Bir servis genellikle bir daÄŸÄ±tÄ±mla iliÅŸkilidir, bu nedenle her ikisi de aynÄ± yapÄ±landÄ±rma dosyasÄ±nda bildirilebilir (bu yapÄ±landÄ±rmada bildirilen servis yalnÄ±zca dahili olarak eriÅŸilebilir):
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
name: mongodb-deployment
labels:
app: mongodb
spec:
replicas: 1
selector:
matchLabels:
app: mongodb
template:
metadata:
labels:
app: mongodb
spec:
containers:
- name: mongodb
image: mongo
ports:
- containerPort: 27017
env:
- name: MONGO_INITDB_ROOT_USERNAME
valueFrom:
secretKeyRef:
name: mongodb-secret
key: mongo-root-username
- name: MONGO_INITDB_ROOT_PASSWORD
valueFrom:
secretKeyRef:
name: mongodb-secret
key: mongo-root-password
---
apiVersion: v1
kind: Service
metadata:
name: mongodb-service
spec:
selector:
app: mongodb
ports:
- protocol: TCP
port: 27017
targetPort: 27017
```
**DÄ±ÅŸ hizmet yapÄ±landÄ±rmasÄ±nÄ±n bir Ã¶rneÄŸi**

Bu hizmet dÄ±ÅŸarÄ±dan eriÅŸilebilir olacaktÄ±r (`nodePort` ve `type: LoadBalancer` Ã¶zniteliklerini kontrol edin):
```yaml
---
apiVersion: v1
kind: Service
metadata:
name: mongo-express-service
spec:
selector:
app: mongo-express
type: LoadBalancer
ports:
- protocol: TCP
port: 8081
targetPort: 8081
nodePort: 30000
```
{% hint style="info" %}
Bu test etmek iÃ§in faydalÄ±dÄ±r ancak Ã¼retim iÃ§in yalnÄ±zca dahili hizmetlere ve uygulamayÄ± aÃ§Ä±ÄŸa Ã§Ä±karmak iÃ§in bir GiriÅŸe sahip olmalÄ±sÄ±nÄ±z.
{% endhint %}

**GiriÅŸ yapÄ±landÄ±rma dosyasÄ± Ã¶rneÄŸi**

Bu, uygulamayÄ± `http://dashboard.com` adresinde aÃ§Ä±ÄŸa Ã§Ä±karacaktÄ±r.
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
name: dashboard-ingress
namespace: kubernetes-dashboard
spec:
rules:
- host: dashboard.com
http:
paths:
- backend:
serviceName: kubernetes-dashboard
servicePort: 80
```
**Gizli yapÄ±landÄ±rma dosyasÄ± Ã¶rneÄŸi**

Åifrelerin B64'te kodlandÄ±ÄŸÄ±na dikkat edin (bu gÃ¼venli deÄŸil!)
```yaml
apiVersion: v1
kind: Secret
metadata:
name: mongodb-secret
type: Opaque
data:
mongo-root-username: dXNlcm5hbWU=
mongo-root-password: cGFzc3dvcmQ=
```
**ConfigMap Ã–rneÄŸi**

Bir **ConfigMap**, pod'lara verilen yapÄ±landÄ±rmadÄ±r, bÃ¶ylece diÄŸer hizmetlere nasÄ±l eriÅŸileceÄŸini ve bulunacaÄŸÄ±nÄ± bilirler. Bu durumda, her bir pod, `mongodb-service` adÄ±nÄ±n, iletiÅŸim kurabilecekleri bir podun adresi olduÄŸunu bilecektir (bu pod bir mongodb Ã§alÄ±ÅŸtÄ±racaktÄ±r):
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
name: mongodb-configmap
data:
database_url: mongodb-service
```
ArdÄ±ndan, bu adres bir **daÄŸÄ±tÄ±m yapÄ±landÄ±rmasÄ±** iÃ§inde aÅŸaÄŸÄ±daki ÅŸekilde belirtilebilir, bÃ¶ylece pod'un env iÃ§ine yÃ¼klenir:
```yaml
[...]
spec:
[...]
template:
[...]
spec:
containers:
- name: mongo-express
image: mongo-express
ports:
- containerPort: 8081
env:
- name: ME_CONFIG_MONGODB_SERVER
valueFrom:
configMapKeyRef:
name: mongodb-configmap
key: database_url
[...]
```
**Hacim yapÄ±landÄ±rmasÄ± Ã¶rneÄŸi**

Depolama yapÄ±landÄ±rma yaml dosyalarÄ±nÄ±n farklÄ± Ã¶rneklerini [https://gitlab.com/nanuchi/youtube-tutorial-series/-/tree/master/kubernetes-volumes](https://gitlab.com/nanuchi/youtube-tutorial-series/-/tree/master/kubernetes-volumes) adresinde bulabilirsiniz.\
**Hacimlerin ad alanlarÄ±nÄ±n iÃ§inde olmadÄ±ÄŸÄ±nÄ±** unutmayÄ±n

### Ad AlanlarÄ±

Kubernetes, aynÄ± fiziksel kÃ¼me tarafÄ±ndan desteklenen **Ã§oklu sanal kÃ¼meleri** destekler. Bu sanal kÃ¼meler **ad alanlarÄ±** olarak adlandÄ±rÄ±lÄ±r. Bunlar, birÃ§ok kullanÄ±cÄ±nÄ±n birden fazla takÄ±ma veya projeye yayÄ±ldÄ±ÄŸÄ± ortamlarda kullanÄ±lmak Ã¼zere tasarlanmÄ±ÅŸtÄ±r. BirkaÃ§ ila onlarca kullanÄ±cÄ±sÄ± olan kÃ¼meler iÃ§in, ad alanlarÄ± oluÅŸturmanÄ±za veya dÃ¼ÅŸÃ¼nmenize gerek yoktur. Kubernetes'te daÄŸÄ±tÄ±lan uygulamanÄ±n her bÃ¶lÃ¼mÃ¼nÃ¼ daha iyi kontrol etmek ve dÃ¼zenlemek iÃ§in ad alanlarÄ±nÄ± kullanmaya baÅŸlamalÄ±sÄ±nÄ±z.

Ad alanlarÄ±, isimler iÃ§in bir kapsam saÄŸlar. KaynaklarÄ±n isimleri bir ad alanÄ± iÃ§inde benzersiz olmalÄ±dÄ±r, ancak ad alanlarÄ± arasÄ±nda olmamalÄ±dÄ±r. Ad alanlarÄ± birbirinin iÃ§ine gÃ¶mÃ¼lemez ve **her** Kubernetes **kaynaÄŸÄ±** yalnÄ±zca **bir** **ad alÄ±nÄ±nda** olabilir.

Minikube kullanÄ±yorsanÄ±z varsayÄ±lan olarak 4 ad alanÄ± bulunmaktadÄ±r:
```
kubectl get namespace
NAME              STATUS   AGE
default           Active   1d
kube-node-lease   Active   1d
kube-public       Active   1d
kube-system       Active   1d
```
* **kube-system**: KullanÄ±cÄ±lar iÃ§in deÄŸil, ustalar ve kubectl iÅŸlemleri iÃ§indir ve dokunulmamalÄ±dÄ±r.
* **kube-public**: Genel olarak eriÅŸilebilir veriler. KÃ¼me bilgilerini iÃ§eren bir configmap iÃ§erir.
* **kube-node-lease**: Bir dÃ¼ÄŸÃ¼mÃ¼n kullanÄ±labilirliÄŸini belirler.
* **default**: KullanÄ±cÄ±nÄ±n kaynak oluÅŸturmak iÃ§in kullanacaÄŸÄ± ad alanÄ±.
```bash
#Create namespace
kubectl create namespace my-namespace
```
{% hint style="info" %}
Kubernetes kaynaklarÄ±nÄ±n Ã§oÄŸunun (Ã¶rneÄŸin pod'lar, servisler, replikasyon denetleyicileri ve diÄŸerleri) belirli bir isim alanÄ±nda olduÄŸunu unutmayÄ±n. Bununla birlikte, isim alanÄ± kaynaklarÄ± gibi diÄŸer kaynaklar ve dÃ¼ÅŸÃ¼k seviyeli kaynaklar, Ã¶rneÄŸin dÃ¼ÄŸÃ¼mler ve kalÄ±cÄ± birimler bir isim alanÄ±nda deÄŸildir. Hangi Kubernetes kaynaklarÄ±nÄ±n bir isim alanÄ±nda olduÄŸunu ve olmadÄ±ÄŸÄ±nÄ± gÃ¶rmek iÃ§in:
```bash
kubectl api-resources --namespaced=true #In a namespace
kubectl api-resources --namespaced=false #Not in a namespace
```
{% endhint %}

TÃ¼m sonraki kubectl komutlarÄ± iÃ§in ad alanÄ±nÄ± o baÄŸlamda kaydedebilirsiniz.
```bash
kubectl config set-context --current --namespace=<insert-namespace-name-here>
```
### Helm

Helm, Kubernetes iÃ§in paket yÃ¶neticisidir. YAML dosyalarÄ±nÄ± paketlemeye ve bunlarÄ± genel ve Ã¶zel depolarda daÄŸÄ±tmaya olanak tanÄ±r. Bu paketlere **Helm Charts** denir.
```
helm search <keyword>
```
## Kubernetes sÄ±rlarÄ±

Bir **Secret**, bir ÅŸifre, bir belirteÃ§ veya bir anahtar gibi **duyarlÄ± verileri iÃ§eren** bir nesnedir. Bu tÃ¼r bilgiler aksi takdirde bir Pod belirtimine veya bir gÃ¶rÃ¼ntÃ¼ye konulabilir. KullanÄ±cÄ±lar Secrets oluÅŸturabilir ve sistem de Secrets oluÅŸturabilir. Bir Secret nesnesinin adÄ± geÃ§erli bir **DNS alt alan adÄ±** olmalÄ±dÄ±r. [Resmi belgelere](https://kubernetes.io/docs/concepts/configuration/secret/) buradan bakabilirsiniz.

Secrets ÅŸunlar olabilir:

- API, SSH AnahtarlarÄ±.
- OAuth belirteÃ§leri.
- Kimlik bilgileri, Parolalar (dÃ¼z metin veya b64 + ÅŸifreleme).
- Bilgi veya yorumlar.
- VeritabanÄ± baÄŸlantÄ± kodu, dizelerâ€¦ .

Kubernetes'te farklÄ± tÃ¼rde sÄ±rlar bulunmaktadÄ±r

| YerleÅŸik TÃ¼r                        | KullanÄ±m                                     |
| ----------------------------------- | ----------------------------------------- |
| **Opaque**                          | **keyfi kullanÄ±cÄ± tanÄ±mlÄ± veri (VarsayÄ±lan)** |
| kubernetes.io/service-account-token | servis hesabÄ± belirteci                     |
| kubernetes.io/dockercfg             | serileÅŸtirilmiÅŸ \~/.dockercfg dosyasÄ±       |
| kubernetes.io/dockerconfigjson      | serileÅŸtirilmiÅŸ \~/.docker/config.json dosyasÄ± |
| kubernetes.io/basic-auth            | temel kimlik doÄŸrulama iÃ§in kimlik bilgileri |
| kubernetes.io/ssh-auth              | SSH kimlik doÄŸrulama iÃ§in kimlik bilgileri   |
| kubernetes.io/tls                   | bir TLS istemcisi veya sunucusu iÃ§in veri   |
| bootstrap.kubernetes.io/token       | baÅŸlangÄ±Ã§ belirteci verisi                  |

{% hint style="info" %}
**Opaque tÃ¼rÃ¼ varsayÄ±lan tÃ¼rdÃ¼r, kullanÄ±cÄ±lar tarafÄ±ndan tanÄ±mlanan tipik anahtar-deÄŸer Ã§iftidir.**
{% endhint %}

**SÄ±rlar nasÄ±l Ã§alÄ±ÅŸÄ±r:**

![](https://sickrov.github.io/media/Screenshot-164.jpg)

AÅŸaÄŸÄ±daki yapÄ±landÄ±rma dosyasÄ±, `username: YWRtaW4=` ve `password: MWYyZDFlMmU2N2Rm` olmak Ã¼zere 2 anahtar-deÄŸer Ã§iftine sahip `mysecret` adÄ±nda bir **secret** tanÄ±mlar. AyrÄ±ca, `mysecret` iÃ§inde tanÄ±mlanan `username` ve `password`'un **environment variables** `SECRET_USERNAME` ve `SECRET_PASSWOR` iÃ§inde aÃ§Ä±ÄŸa Ã§Ä±karÄ±lacaÄŸÄ± `secretpod` adÄ±nda bir **pod** tanÄ±mlar. AyrÄ±ca, `username` sÄ±rrÄ±nÄ± `/etc/foo/my-group/my-username` yolunda `0640` izinleriyle **mount** edecektir.

{% code title="secretpod.yaml" %}
```yaml
apiVersion: v1
kind: Secret
metadata:
name: mysecret
type: Opaque
data:
username: YWRtaW4=
password: MWYyZDFlMmU2N2Rm
---
apiVersion: v1
kind: Pod
metadata:
name: secretpod
spec:
containers:
- name: secretpod
image: nginx
env:
- name: SECRET_USERNAME
valueFrom:
secretKeyRef:
name: mysecret
key: username
- name: SECRET_PASSWORD
valueFrom:
secretKeyRef:
name: mysecret
key: password
volumeMounts:
- name: foo
mountPath: "/etc/foo"
restartPolicy: Never
volumes:
- name: foo
secret:
secretName: mysecret
items:
- key: username
path: my-group/my-username
mode: 0640
```
{% endcode %}
```bash
kubectl apply -f <secretpod.yaml>
kubectl get pods #Wait until the pod secretpod is running
kubectl exec -it  secretpod -- bash
env | grep SECRET && cat /etc/foo/my-group/my-username && echo
```
### etcd'teki SÄ±rlar <a href="#discover-secrets-in-etcd" id="discover-secrets-in-etcd"></a>

**etcd**, tÃ¼m kÃ¼me verileri iÃ§in Kubernetes destek deposu olarak kullanÄ±lan tutarlÄ± ve yÃ¼ksek eriÅŸilebilirlikte bir **anahtar-deÄŸer deposudur**. etcd'de saklanan sÄ±rlara eriÅŸelim:
```bash
cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep etcd
```
Sertifikalar, anahtarlar ve URL'lerin FS iÃ§inde bulunduÄŸunu gÃ¶receksiniz. Bunu aldÄ±ÄŸÄ±nÄ±zda etcd'ye baÄŸlanabileceksiniz.
```bash
#ETCDCTL_API=3 etcdctl --cert <path to client.crt> --key <path to client.ket> --cacert <path to CA.cert> endpoint=[<ip:port>] health

ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/etcd/ca.cert endpoint=[127.0.0.1:1234] health
```
Bir kez iletiÅŸim kurmayÄ± baÅŸardÄ±ÄŸÄ±nÄ±zda sÄ±rlara eriÅŸebileceksiniz:
```bash
#ETCDCTL_API=3 etcdctl --cert <path to client.crt> --key <path to client.ket> --cacert <path to CA.cert> endpoint=[<ip:port>] get <path/to/secret>

ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/etcd/ca.cert endpoint=[127.0.0.1:1234] get /registry/secrets/default/secret_02
```
**ETCD'ye Åifreleme Eklemek**

VarsayÄ±lan olarak, tÃ¼m sÄ±rlar, bir ÅŸifreleme katmanÄ± uygulamadÄ±kÃ§a etcd iÃ§inde dÃ¼z metin olarak saklanÄ±r. AÅŸaÄŸÄ±daki Ã¶rnek, [https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/](https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/) adresindeki bilgilere dayanmaktadÄ±r.

{% code title="encryption.yaml" %}
```yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
- resources:
- secrets
providers:
- aescbc:
keys:
- name: key1
secret: cjjPMcWpTPKhAdieVtd+KhG4NN+N6e3NmBPMXJvbfrY= #Any random key
- identity: {}
```
{% endcode %}

SonrasÄ±nda, oluÅŸturulan yapÄ±landÄ±rma dosyasÄ±nÄ±n konumunu gÃ¶stermek iÃ§in `kube-apiserver` Ã¼zerinde `--encryption-provider-config` bayraÄŸÄ±nÄ± ayarlamanÄ±z gerekir. `/etc/kubernetes/manifest/kube-apiserver.yaml` dosyasÄ±nÄ± deÄŸiÅŸtirerek aÅŸaÄŸÄ±daki satÄ±rlarÄ± ekleyebilirsiniz:
```yaml
containers:
- command:
- kube-apiserver
- --encriyption-provider-config=/etc/kubernetes/etcd/<configFile.yaml>
```
AÅŸaÄŸÄ± kaydÄ±rÄ±n volumeMounts bÃ¶lÃ¼mÃ¼nde:
```yaml
- mountPath: /etc/kubernetes/etcd
name: etcd
readOnly: true
```
AÅŸaÄŸÄ± kaydÄ±rÄ±n volumeMounts iÃ§inde hostPath:
```yaml
- hostPath:
path: /etc/kubernetes/etcd
type: DirectoryOrCreate
name: etcd
```
**Veri ÅŸifrelenmiÅŸ olduÄŸunu doÄŸrulama**

Veri etcd'ye yazÄ±ldÄ±ÄŸÄ±nda ÅŸifrelenir. `kube-apiserver`'Ä±nÄ±zÄ± yeniden baÅŸlattÄ±ktan sonra, depolandÄ±ÄŸÄ±nda yeni oluÅŸturulan veya gÃ¼ncellenen herhangi bir sÄ±rrÄ±n ÅŸifrelenmiÅŸ olmasÄ± gerekir. Kontrol etmek iÃ§in `etcdctl` komut satÄ±rÄ± programÄ±nÄ± kullanarak sÄ±rrÄ±nÄ±zÄ±n iÃ§eriÄŸini alabilirsiniz.

1. `default` ad alanÄ±nda `secret1` adÄ±nda yeni bir sÄ±r oluÅŸturun:

```
kubectl create secret generic secret1 -n default --from-literal=mykey=mydata
```
2. Etcdctl komut satÄ±rÄ±nÄ± kullanarak, o sÄ±rrÄ± etcd'den okuyun:

`ETCDCTL_API=3 etcdctl get /registry/secrets/default/secret1 [...] | hexdump -C`

`[...]` etcd sunucusuna baÄŸlanmak iÃ§in ek argÃ¼manlar olmalÄ±dÄ±r.
3. Depolanan sÄ±rrÄ±n, sonuÃ§ verilerinin ÅŸifrelemesini yapan `aescbc` saÄŸlayÄ±cÄ±sÄ±nÄ±n ÅŸifrelediÄŸini gÃ¶steren `k8s:enc:aescbc:v1:` ile baÅŸladÄ±ÄŸÄ±nÄ± doÄŸrulayÄ±n.
4. API aracÄ±lÄ±ÄŸÄ±yla alÄ±ndÄ±ÄŸÄ±nda sÄ±rrÄ±n doÄŸru bir ÅŸekilde ÅŸifrelenmediÄŸini doÄŸrulayÄ±n:

```
kubectl describe secret secret1 -n default
```

`mykey: bXlkYXRh` ile eÅŸleÅŸmelidir, mydata kodlanmÄ±ÅŸtÄ±r, sÄ±rrÄ± tamamen Ã§Ã¶zmek iÃ§in [bir sÄ±rrÄ± Ã§Ã¶zme](https://kubernetes.io/docs/concepts/configuration/secret#decoding-a-secret) baÄŸlantÄ±sÄ±na bakÄ±n.

**SÄ±rlar yazÄ±lÄ±rken ÅŸifrelendiÄŸinden, bir sÄ±rrÄ± gÃ¼ncellemek ÅŸifrelemesini saÄŸlayacaktÄ±r:**
```
kubectl get secrets --all-namespaces -o json | kubectl replace -f -
```
**Son ipuÃ§larÄ±:**

* FS iÃ§inde sÄ±rlarÄ± saklamamaya Ã§alÄ±ÅŸÄ±n, onlarÄ± baÅŸka yerlerden alÄ±n.
* SÄ±rlarÄ±nÄ±za daha fazla koruma eklemek iÃ§in [https://www.vaultproject.io/](https://www.vaultproject.io) adresine gÃ¶z atÄ±n.
* [https://kubernetes.io/docs/concepts/configuration/secret/#risks](https://kubernetes.io/docs/concepts/configuration/secret/#risks)
* [https://docs.cyberark.com/Product-Doc/OnlineHelp/AAM-DAP/11.2/en/Content/Integrations/Kubernetes\_deployApplicationsConjur-k8s-Secrets.htm](https://docs.cyberark.com/Product-Doc/OnlineHelp/AAM-DAP/11.2/en/Content/Integrations/Kubernetes\_deployApplicationsConjur-k8s-Secrets.htm)

## Referanslar

{% embed url="https://sickrov.github.io/" %}

{% embed url="https://www.youtube.com/watch?v=X48VuDVv0do" %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}
