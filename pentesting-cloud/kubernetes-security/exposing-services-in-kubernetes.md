# Kubernetes'te Hizmetleri Açığa Çıkarma

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

Kubernetes'te hizmetleri açığa çıkarmanın **farklı yolları** vardır, böylece hem **iç** uç noktalar hem de **dış** uç noktalar bunlara erişebilir. Bu Kubernetes yapılandırması oldukça kritik olup, yönetici **saldırganlara erişmemeleri gereken hizmetlere erişim verebilir**.

### Otomatik Sayım

K8s'in hizmetleri halka açma yollarını saymaya başlamadan önce, eğer ad alanlarını, hizmetleri ve girişleri listeleyebiliyorsanız, her şeyin halka açık olarak açığa çıktığını bulabileceğinizi bilin:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

Bir **ClusterIP** servisi, **varsayılan** Kubernetes **servisidir**. Bu, kümeniz içindeki diğer uygulamaların erişebileceği bir **hizmet sağlar**. **Dış erişim yoktur**.

Ancak, bu Kubernetes Proxy kullanılarak erişilebilir:
```bash
kubectl proxy --port=8080
```
Artık bu şemayı kullanarak Kubernetes API'si üzerinden hizmetlere erişebilirsiniz:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Örneğin, aşağıdaki URL'yi kullanabilirsiniz:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

bu hizmete erişmek için:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_This method requires you to run `kubectl` as an **authenticated user**._

Tüm ClusterIP'leri listeleyin:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

**NodePort** kullanıldığında, tüm Düğümlerde (Sanal Makineleri temsil eden) belirlenmiş bir port kullanılabilir hale gelir. Bu belirli porta yönlendirilen **Trafik**, sistematik olarak **servise yönlendirilir**. Genellikle, bu yöntem dezavantajları nedeniyle önerilmez.

Tüm NodePort'ları listele:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

NodePort spesifikasyonuna bir örnek:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Eğer yaml'da **nodePort** belirtmezseniz (açılacak port), **30000–32767 aralığında bir port kullanılacaktır**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Servisi harici olarak **bir bulut sağlayıcısının yük dengeleyicisini kullanarak** açar. GKE'de, bu, servisinize tüm trafiği yönlendirecek tek bir IP adresi sağlayan bir [Ağ Yük Dengeleyicisi](https://cloud.google.com/compute/docs/load-balancing/network/) başlatacaktır. AWS'de bir Yük Dengeleyici başlatacaktır.

Açık her servis için bir LoadBalancer için ödeme yapmanız gerekir, bu da pahalı olabilir.

Tüm LoadBalancers'ı listeleyin:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### Dış IP'ler <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Dış IP'ler, Load Balancer türündeki hizmetler tarafından açığa çıkarılır ve genellikle bir dış Bulut Sağlayıcı Load Balancer kullanıldığında kullanılır.

Bunları bulmak için, `EXTERNAL-IP` alanında değerleri olan yük dengeleyicilere bakın.
{% endhint %}

Küme içine **dış IP** ile (hedef IP olarak) gelen trafik, Hizmet portunda, **Hizmet uç noktalarından birine yönlendirilecektir**. `externalIPs`, Kubernetes tarafından yönetilmez ve küme yöneticisinin sorumluluğundadır.

Hizmet spesifikasyonunda, `externalIPs`, `ServiceTypes`'dan herhangi biri ile birlikte belirtilebilir. Aşağıdaki örnekte, "`my-service`" istemciler tarafından "`80.11.12.10:80`" (`externalIP:port`) üzerinden erişilebilir.
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Belgelerden:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) ExternalName türündeki Servisler **bir Servisi bir DNS adına eşler**, `my-service` veya `cassandra` gibi tipik bir seçiciye değil. Bu Servisleri `spec.externalName` parametresi ile belirtirsiniz.

Bu Servis tanımı, örneğin, `prod` ad alanındaki `my-service` Servisini `my.database.example.com` adresine eşler:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
`my-service.prod.svc.cluster.local` ana bilgisayarını ararken, küme DNS Servisi `my.database.example.com` değeriyle bir `CNAME` kaydı döndürür. `my-service`'e erişim, diğer Servislerle aynı şekilde çalışır, ancak **yönlendirme DNS seviyesinde** gerçekleşir, proxy veya yönlendirme yoluyla değil.

Tüm ExternalNames'leri listele:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

Yukarıdaki tüm örneklerden farklı olarak, **Ingress bir hizmet türü DEĞİLDİR**. Bunun yerine, **birden fazla hizmetin önünde yer alır ve “akıllı bir yönlendirici”** veya kümenize giriş noktası olarak işlev görür.

Ingress ile birçok farklı şey yapabilirsiniz ve **farklı yeteneklere sahip birçok Ingress kontrolörü vardır**.

Varsayılan GKE ingress kontrolörü sizin için bir [HTTP(S) Yük Dengeleyici](https://cloud.google.com/compute/docs/load-balancing/http/) oluşturacaktır. Bu, arka uç hizmetlerine hem yol tabanlı hem de alt alan tabanlı yönlendirme yapmanıza olanak tanır. Örneğin, foo.yourdomain.com üzerindeki her şeyi foo hizmetine, yourdomain.com/bar/ yolundaki her şeyi ise bar hizmetine gönderebilirsiniz.

GKE'deki bir Ingress nesnesi için [L7 HTTP Yük Dengeleyici](https://cloud.google.com/compute/docs/load-balancing/http/) ile YAML şu şekilde görünebilir:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Tüm girişleri listele:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Bu durumda, her birinin bilgilerini tek tek almak daha iyidir, böylece daha iyi okuyabilirsiniz:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Referanslar

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
