# Εκθέτοντας Υπηρεσίες στο Kubernetes

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Ειδικός Red Team του HackTricks στο AWS)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

Υπάρχουν **διαφορετικοί τρόποι εκθέτοντας υπηρεσίες** στο Kubernetes ώστε τόσο οι **εσωτερικές** όσο και οι **εξωτερικές** κατευθύνσεις να μπορούν να τις προσπελάσουν. Αυτή η διαμόρφωση στο Kubernetes είναι αρκετά κρίσιμη καθώς ο διαχειριστής θα μπορούσε να δώσει πρόσβαση σε **επιτιθέμενους σε υπηρεσίες στις οποίες δεν θα έπρεπε να έχουν πρόσβαση**.

### Αυτόματη Απαρίθμηση

Πριν ξεκινήσετε την απαρίθμηση των τρόπων που προσφέρει το K8s για την εκθεση υπηρεσιών στο κοινό, γνωρίστε ότι αν μπορείτε να καταλογίσετε τους χώρους ονομάτων, τις υπηρεσίες και τις εισόδους, μπορείτε να βρείτε τα πάντα που εκτίθενται στο κοινό με:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

Ένα υπηρεσία **ClusterIP** είναι η **προεπιλεγμένη** υπηρεσία του Kubernetes. Σας παρέχει μια **υπηρεσία μέσα** στο cluster σας που άλλες εφαρμογές μέσα στο cluster σας μπορούν να έχουν πρόσβαση. Δεν υπάρχει **εξωτερική πρόσβαση**.

Ωστόσο, αυτό μπορεί να προσπελαστεί χρησιμοποιώντας το Kubernetes Proxy:
```bash
kubectl proxy --port=8080
```
Τώρα, μπορείτε να πλοηγηθείτε μέσω του API του Kubernetes για να έχετε πρόσβαση σε υπηρεσίες χρησιμοποιώντας τον παρακάτω σχεδιασμό:

`http://localhost:8080/api/v1/proxy/namespaces/<ΟΝΟΜΑ-ΧΩΡΟΥ>/services/<ΟΝΟΜΑ-ΥΠΗΡΕΣΙΑΣ>:<ΟΝΟΜΑ-ΘΥΡΑΣ>/`

Για παράδειγμα, θα μπορούσατε να χρησιμοποιήσετε τον παρακάτω σύνδεσμο URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

για να έχετε πρόσβαση σε αυτήν την υπηρεσία:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Αυτή η μέθοδος απαιτεί να εκτελέσετε το `kubectl` ως έναν **εξουσιοδοτημένο χρήστη**._

Λίστα με όλες τις ClusterIPs:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

Όταν χρησιμοποιείται το **NodePort**, ένας καθορισμένος θύρας γίνεται διαθέσιμος σε όλους τους Κόμβους (που αντιπροσωπεύουν τις Εικονικές Μηχανές). Το **Κίνητρο** που κατευθύνεται σε αυτήν τη συγκεκριμένη θύρα δρομολογείται στη συνέχεια συστηματικά στην υπηρεσία. Συνήθως, αυτή η μέθοδος δεν συνιστάται λόγω των μειονεκτημάτων της.

Καταγράψτε όλους τους NodePorts:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

Ένα παράδειγμα της προδιαγραφής NodePort:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Αν **δεν καθορίσετε** το **nodePort** στο αρχείο yaml (είναι η θύρα που θα ανοίξει) θα χρησιμοποιηθεί μια θύρα στο **εύρος 30000–32767**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Εκθέτει την υπηρεσία εξωτερικά **χρησιμοποιώντας τον ισορροπητή φορτίου του παροχέα cloud**. Στο GKE, αυτό θα δημιουργήσει ένα [Ισορροπητή Φορτίου Δικτύου](https://cloud.google.com/compute/docs/load-balancing/network/) που θα σας δώσει μια μοναδική διεύθυνση IP που θα προωθεί όλη την κίνηση στην υπηρεσία σας. Στο AWS θα εκκινήσει έναν Ισορροπητή Φορτίου.

Πρέπει να πληρώσετε για έναν Ισορροπητή Φορτίου ανά εκτεθειμένη υπηρεσία, που μπορεί να είναι ακριβό.

Λίστα όλων των Ισορροπητών Φορτίου:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### Εξωτερικές Διευθύνσεις IP <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Οι εξωτερικές διευθύνσεις IP εκτίθενται από υπηρεσίες τύπου Load Balancers και χρησιμοποιούνται γενικά όταν χρησιμοποιείται ένας εξωτερικός Φορέας Φόρτου Στο Cloud.

Για να τις βρείτε, ελέγξτε τους φορείς φόρτου με τιμές στο πεδίο `EXTERNAL-IP`.
{% endhint %}

Η κίνηση που εισέρχεται στο cluster με την **εξωτερική IP** (ως **διεύθυνση IP προορισμού**), στη θύρα της Υπηρεσίας, θα **κατευθύνεται σε ένα από τα άκρα της Υπηρεσίας**. Οι `externalIPs` δεν διαχειρίζονται από το Kubernetes και είναι ευθύνη του διαχειριστή του cluster.

Στο προσδιορισμό της Υπηρεσίας, οι `externalIPs` μπορούν να καθοριστούν μαζί με οποιονδήποτε από τους `ServiceTypes`. Στο παρακάτω παράδειγμα, η "`my-service`" μπορεί να προσπελαστεί από πελάτες στη διεύθυνση "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Από τα έγγραφα:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) Οι υπηρεσίες τύπου ExternalName **αντιστοιχίζουν μια υπηρεσία σε ένα όνομα DNS**, όχι σε έναν τυπικό επιλογέα όπως `my-service` ή `cassandra`. Καθορίζετε αυτές τις Υπηρεσίες με την παράμετρο `spec.externalName`.

Αυτός ο ορισμός Υπηρεσίας, για παράδειγμα, αντιστοιχίζει την Υπηρεσία `my-service` στο χώρο ονομάτων `prod` στο `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Όταν αναζητείτε τον οικοδεσπότη `my-service.prod.svc.cluster.local`, η Υπηρεσία DNS του cluster επιστρέφει ένα εγγραφή `CNAME` με την τιμή `my.database.example.com`. Η πρόσβαση στο `my-service` λειτουργεί με τον ίδιο τρόπο με τις άλλες Υπηρεσίες, αλλά με την κρίσιμη διαφορά ότι **η ανακατεύθυνση συμβαίνει στο επίπεδο DNS** αντί για προώθηση ή διαμεσολάβηση.

Καταγράψτε όλα τα ExternalNames:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

Διαφορετικά από όλα τα παραπάνω παραδείγματα, **το Ingress ΔΕΝ είναι ένας τύπος υπηρεσίας**. Αντ' αυτού, βρίσκεται **μπροστά από πολλές υπηρεσίες και λειτουργεί ως ένα "έξυπνο δρομολογητή"** ή σημείο εισόδου στο cluster σας.

Μπορείτε να κάνετε πολλά διαφορετικά πράγματα με ένα Ingress, και υπάρχουν **πολλοί τύποι ελεγκτών Ingress που έχουν διαφορετικές δυνατότητες**.

Ο προεπιλεγμένος ελεγκτής Ingress του GKE θα δημιουργήσει έναν [HTTP(S) Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) για εσάς. Αυτό θα σας επιτρέψει να κάνετε δρομολόγηση βασισμένη σε διαδρομές και subdomains προς υπηρεσίες πίσω από αυτόν. Για παράδειγμα, μπορείτε να στείλετε τα πάντα στο foo.yourdomain.com στην υπηρεσία foo, και τα πάντα κάτω από το yourdomain.com/bar/ δρομολογημένα στην υπηρεσία bar.

Το YAML για ένα αντικείμενο Ingress στο GKE με έναν [L7 HTTP Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) μπορεί να μοιάζει με αυτό:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Καταγράψτε όλα τα ingresses:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Παρόλο που σε αυτήν την περίπτωση είναι καλύτερο να λάβετε τις πληροφορίες του καθενός ξεχωριστά για να τις διαβάσετε καλύτερα:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Αναφορές

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
