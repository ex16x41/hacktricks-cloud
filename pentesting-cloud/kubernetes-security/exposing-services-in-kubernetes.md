# åœ¨Kubernetesä¸­æš´éœ²æœåŠ¡

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶(ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶(GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

åœ¨Kubernetesä¸­æœ‰**ä¸åŒçš„æ–¹æ³•æ¥æš´éœ²æœåŠ¡**ï¼Œä»¥ä¾¿**å†…éƒ¨**ç«¯ç‚¹å’Œ**å¤–éƒ¨**ç«¯ç‚¹éƒ½å¯ä»¥è®¿é—®å®ƒä»¬ã€‚è¿™ä¸ªKubernetesé…ç½®éå¸¸å…³é”®ï¼Œå› ä¸ºç®¡ç†å‘˜å¯èƒ½ä¼šç»™**æ”»å‡»è€…è®¿é—®ä»–ä»¬ä¸åº”è¯¥èƒ½å¤Ÿè®¿é—®çš„æœåŠ¡**çš„æƒé™ã€‚

### è‡ªåŠ¨æšä¸¾

åœ¨å¼€å§‹æšä¸¾K8sæä¾›çš„æš´éœ²æœåŠ¡ç»™å…¬ä¼—çš„æ–¹æ³•ä¹‹å‰ï¼Œè¯·çŸ¥é“å¦‚æœæ‚¨å¯ä»¥åˆ—å‡ºå‘½åç©ºé—´ã€æœåŠ¡å’Œå…¥å£ï¼Œåˆ™å¯ä»¥æ‰¾åˆ°æ‰€æœ‰æš´éœ²ç»™å…¬ä¼—çš„å†…å®¹ï¼š
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

ä¸€ä¸ª **ClusterIP** æœåŠ¡æ˜¯ **é»˜è®¤** çš„ Kubernetes **æœåŠ¡**ã€‚å®ƒä¸ºæ‚¨æä¾›ä¸€ä¸ª **é›†ç¾¤å†…éƒ¨** çš„æœåŠ¡ï¼Œå…¶ä»–åº”ç”¨å¯ä»¥è®¿é—®è¯¥æœåŠ¡ã€‚æ²¡æœ‰ **å¤–éƒ¨è®¿é—®**ã€‚

ç„¶è€Œï¼Œå¯ä»¥ä½¿ç”¨ Kubernetes Proxy è¿›è¡Œè®¿é—®ï¼š
```bash
kubectl proxy --port=8080
```
ç°åœ¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ¡ˆå¯¼èˆª Kubernetes API ä»¥è®¿é—®æœåŠ¡ï¼š

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ URLï¼š

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

æ¥è®¿é—®æ­¤æœåŠ¡ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_æ­¤æ–¹æ³•è¦æ±‚æ‚¨ä»¥ **ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·** èº«ä»½è¿è¡Œ `kubectl`ã€‚_

åˆ—å‡ºæ‰€æœ‰ ClusterIPsï¼š

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

å½“ **NodePort** è¢«ä½¿ç”¨æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹ï¼ˆä»£è¡¨è™šæ‹Ÿæœºï¼‰ä¸Šä¼šå¼€æ”¾ä¸€ä¸ªæŒ‡å®šçš„ç«¯å£ã€‚æŒ‡å‘è¯¥ç‰¹å®šç«¯å£çš„ **æµé‡** ä¼šè¢«ç³»ç»Ÿåœ° **è·¯ç”±åˆ°æœåŠ¡**ã€‚é€šå¸¸ï¼Œç”±äºå…¶ç¼ºç‚¹ï¼Œè¿™ç§æ–¹æ³•ä¸æ¨èä½¿ç”¨ã€‚

åˆ—å‡ºæ‰€æœ‰ NodePortsï¼š

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

NodePort è§„æ ¼çš„ç¤ºä¾‹ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
å¦‚æœæ‚¨**ä¸æŒ‡å®š**yamlä¸­çš„**nodePort**ï¼ˆè¿™æ˜¯å°†è¦æ‰“å¼€çš„ç«¯å£ï¼‰ï¼Œå°†ä½¿ç”¨**30000â€“32767èŒƒå›´å†…çš„ç«¯å£**ã€‚

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

é€šè¿‡**ä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨**å°†æœåŠ¡å…¬å¼€åˆ°å¤–éƒ¨ã€‚åœ¨GKEä¸Šï¼Œè¿™å°†å¯åŠ¨ä¸€ä¸ª[ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨](https://cloud.google.com/compute/docs/load-balancing/network/)ï¼Œå®ƒå°†ä¸ºæ‚¨æä¾›ä¸€ä¸ªå•ä¸€çš„IPåœ°å€ï¼Œè¯¥åœ°å€å°†æ‰€æœ‰æµé‡è½¬å‘åˆ°æ‚¨çš„æœåŠ¡ã€‚åœ¨AWSä¸Šï¼Œå®ƒå°†å¯åŠ¨ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ã€‚

æ‚¨å¿…é¡»ä¸ºæ¯ä¸ªå…¬å¼€çš„æœåŠ¡æ”¯ä»˜è´Ÿè½½å‡è¡¡å™¨çš„è´¹ç”¨ï¼Œè¿™å¯èƒ½ä¼šå¾ˆæ˜‚è´µã€‚

åˆ—å‡ºæ‰€æœ‰è´Ÿè½½å‡è¡¡å™¨ï¼š

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### å¤–éƒ¨ IPs <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
å¤–éƒ¨ IPs æ˜¯ç”±ç±»å‹ä¸º Load Balancers çš„æœåŠ¡æš´éœ²çš„ï¼Œé€šå¸¸åœ¨ä½¿ç”¨å¤–éƒ¨äº‘æä¾›å•†çš„ Load Balancer æ—¶ä½¿ç”¨ã€‚

è¦æŸ¥æ‰¾å®ƒä»¬ï¼Œè¯·æ£€æŸ¥ `EXTERNAL-IP` å­—æ®µä¸­æœ‰å€¼çš„è´Ÿè½½å‡è¡¡å™¨ã€‚
{% endhint %}

æµå…¥é›†ç¾¤çš„æµé‡ä½¿ç”¨ **å¤–éƒ¨ IP**ï¼ˆä½œä¸º **ç›®æ ‡ IP**ï¼‰ï¼Œåœ¨æœåŠ¡ç«¯å£ä¸Šï¼Œå°†è¢« **è·¯ç”±åˆ°å…¶ä¸­ä¸€ä¸ªæœåŠ¡ç«¯ç‚¹**ã€‚`externalIPs` ä¸æ˜¯ç”± Kubernetes ç®¡ç†çš„ï¼Œè€Œæ˜¯é›†ç¾¤ç®¡ç†å‘˜çš„è´£ä»»ã€‚

åœ¨æœåŠ¡è§„æ ¼ä¸­ï¼Œ`externalIPs` å¯ä»¥ä¸ä»»ä½• `ServiceTypes` ä¸€èµ·æŒ‡å®šã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œ"`my-service`" å¯ä»¥é€šè¿‡ "`80.11.12.10:80`"ï¼ˆ`externalIP:port`ï¼‰è¢«å®¢æˆ·ç«¯è®¿é—®ã€‚
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**æ¥è‡ªæ–‡æ¡£:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) ExternalName ç±»å‹çš„æœåŠ¡ **å°†æœåŠ¡æ˜ å°„åˆ° DNS åç§°**ï¼Œè€Œä¸æ˜¯åƒ `my-service` æˆ– `cassandra` è¿™æ ·çš„å…¸å‹é€‰æ‹©å™¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `spec.externalName` å‚æ•°æ¥æŒ‡å®šè¿™äº›æœåŠ¡ã€‚

ä¾‹å¦‚ï¼Œæ­¤æœåŠ¡å®šä¹‰å°† `prod` å‘½åç©ºé—´ä¸­çš„ `my-service` æœåŠ¡æ˜ å°„åˆ° `my.database.example.com`ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
å½“æŸ¥æ‰¾ä¸»æœº `my-service.prod.svc.cluster.local` æ—¶ï¼Œé›†ç¾¤ DNS æœåŠ¡è¿”å›ä¸€ä¸ªå€¼ä¸º `my.database.example.com` çš„ `CNAME` è®°å½•ã€‚è®¿é—® `my-service` çš„æ–¹å¼ä¸å…¶ä»–æœåŠ¡ç›¸åŒï¼Œä½†æœ‰ä¸€ä¸ªå…³é”®çš„åŒºåˆ«ï¼Œå³ **é‡å®šå‘å‘ç”Ÿåœ¨ DNS å±‚é¢** è€Œä¸æ˜¯é€šè¿‡ä»£ç†æˆ–è½¬å‘ã€‚

åˆ—å‡ºæ‰€æœ‰ ExternalNamesï¼š

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

ä¸ä¸Šè¿°æ‰€æœ‰ç¤ºä¾‹ä¸åŒï¼Œ**Ingress ä¸æ˜¯ä¸€ç§æœåŠ¡ç±»å‹**ã€‚ç›¸åï¼Œå®ƒä½äº**å¤šä¸ªæœåŠ¡å‰é¢ï¼Œå……å½“â€œæ™ºèƒ½è·¯ç”±å™¨â€**æˆ–é›†ç¾¤çš„å…¥å£ç‚¹ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ Ingress åšå¾ˆå¤šä¸åŒçš„äº‹æƒ…ï¼Œå¹¶ä¸”æœ‰**è®¸å¤šç±»å‹çš„ Ingress æ§åˆ¶å™¨å…·æœ‰ä¸åŒçš„åŠŸèƒ½**ã€‚

é»˜è®¤çš„ GKE Ingress æ§åˆ¶å™¨å°†ä¸ºæ‚¨å¯åŠ¨ä¸€ä¸ª [HTTP(S) è´Ÿè½½å‡è¡¡å™¨](https://cloud.google.com/compute/docs/load-balancing/http/)ã€‚è¿™å°†å…è®¸æ‚¨å¯¹åç«¯æœåŠ¡è¿›è¡ŒåŸºäºè·¯å¾„å’Œå­åŸŸçš„è·¯ç”±ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å°† foo.yourdomain.com ä¸Šçš„æ‰€æœ‰è¯·æ±‚å‘é€åˆ° foo æœåŠ¡ï¼Œå°† yourdomain.com/bar/ è·¯å¾„ä¸‹çš„æ‰€æœ‰è¯·æ±‚å‘é€åˆ° bar æœåŠ¡ã€‚

åœ¨ GKE ä¸Šä½¿ç”¨ [L7 HTTP è´Ÿè½½å‡è¡¡å™¨](https://cloud.google.com/compute/docs/load-balancing/http/) çš„ Ingress å¯¹è±¡çš„ YAML å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
åˆ—å‡ºæ‰€æœ‰çš„ ingressesï¼š

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

è™½ç„¶åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé€ä¸ªè·å–æ¯ä¸ªä¿¡æ¯ä»¥ä¾¿æ›´å¥½åœ°é˜…è¯»æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼š
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### å‚è€ƒæ–‡çŒ®

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
