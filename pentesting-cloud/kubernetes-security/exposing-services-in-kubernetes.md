# åœ¨ Kubernetes ä¸­æš´éœ²æœåŠ¡

{% hint style="success" %}
å­¦ä¹ å¹¶å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§**ã€‚

</details>
{% endhint %}

åœ¨ Kubernetes ä¸­æœ‰**ä¸åŒçš„æ–¹æ³•æ¥æš´éœ²æœåŠ¡**ï¼Œä»¥ä¾¿**å†…éƒ¨**ç«¯ç‚¹å’Œ**å¤–éƒ¨**ç«¯ç‚¹å¯ä»¥è®¿é—®å®ƒä»¬ã€‚è¿™ç§ Kubernetes é…ç½®éå¸¸å…³é”®ï¼Œå› ä¸ºç®¡ç†å‘˜å¯èƒ½ä¼šæˆäºˆ**æ”»å‡»è€…è®¿é—®ä»–ä»¬ä¸åº”è¯¥è®¿é—®çš„æœåŠ¡**çš„æƒé™ã€‚

### è‡ªåŠ¨æšä¸¾

åœ¨å¼€å§‹æšä¸¾ K8s æä¾›çš„å°†æœåŠ¡æš´éœ²ç»™å…¬ä¼—çš„æ–¹æ³•ä¹‹å‰ï¼Œè¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨å¯ä»¥åˆ—å‡ºå‘½åç©ºé—´ã€æœåŠ¡å’Œå…¥å£ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰¾åˆ°æ‰€æœ‰æš´éœ²ç»™å…¬ä¼—çš„å†…å®¹ï¼š
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

**ClusterIP**æœåŠ¡æ˜¯Kubernetesçš„**é»˜è®¤æœåŠ¡**ã€‚å®ƒä¸ºæ‚¨çš„é›†ç¾¤æä¾›ä¸€ä¸ªå†…éƒ¨æœåŠ¡ï¼Œé›†ç¾¤ä¸­çš„å…¶ä»–åº”ç”¨ç¨‹åºå¯ä»¥è®¿é—®å®ƒã€‚**æ²¡æœ‰å¤–éƒ¨è®¿é—®**ã€‚

ä½†æ˜¯ï¼Œå¯ä»¥ä½¿ç”¨Kubernetesä»£ç†è®¿é—®æ­¤æœåŠ¡ï¼š
```bash
kubectl proxy --port=8080
```
ç°åœ¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ¡ˆæµè§ˆ Kubernetes API æ¥è®¿é—®æœåŠ¡ï¼š

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ URLï¼š

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

æ¥è®¿é—®æ­¤æœåŠ¡ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_è¿™ç§æ–¹æ³•è¦æ±‚æ‚¨ä»¥**ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·**èº«ä»½è¿è¡Œ `kubectl`ã€‚_

åˆ—å‡ºæ‰€æœ‰ ClusterIPsï¼š

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

å½“ä½¿ç”¨ **NodePort** æ—¶ï¼Œåœ¨æ‰€æœ‰èŠ‚ç‚¹ï¼ˆä»£è¡¨è™šæ‹Ÿæœºï¼‰ä¸Šéƒ½ä¼šæä¾›ä¸€ä¸ªæŒ‡å®šçš„ç«¯å£ã€‚ç„¶åï¼Œå‘é€åˆ°è¿™ä¸ªç‰¹å®šç«¯å£çš„ **æµé‡** ä¼šè¢«ç³»ç»Ÿåœ° **è·¯ç”±åˆ°æœåŠ¡**ã€‚é€šå¸¸ï¼Œç”±äºå…¶ç¼ºç‚¹ï¼Œä¸æ¨èä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚

åˆ—å‡ºæ‰€æœ‰ NodePorts:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

NodePortè§„èŒƒçš„ç¤ºä¾‹ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
å¦‚æœåœ¨yamlä¸­**ä¸æŒ‡å®š**nodePortï¼ˆå°†è¦æ‰“å¼€çš„ç«¯å£ï¼‰ï¼Œå°†ä½¿ç”¨**30000-32767èŒƒå›´å†…çš„ç«¯å£**ã€‚

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

ä½¿ç”¨**äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨**åœ¨å¤–éƒ¨å…¬å¼€æœåŠ¡ã€‚åœ¨GKEä¸Šï¼Œè¿™å°†å¯åŠ¨ä¸€ä¸ª[ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨](https://cloud.google.com/compute/docs/load-balancing/network/)ï¼Œå®ƒå°†ä¸ºæ‚¨æä¾›ä¸€ä¸ªå•ä¸€IPåœ°å€ï¼Œå°†æ‰€æœ‰æµé‡è½¬å‘åˆ°æ‚¨çš„æœåŠ¡ã€‚åœ¨AWSä¸Šï¼Œå®ƒå°†å¯åŠ¨ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ã€‚

æ‚¨éœ€è¦ä¸ºæ¯ä¸ªå…¬å¼€æœåŠ¡æ”¯ä»˜ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Œè¿™å¯èƒ½å¾ˆæ˜‚è´µã€‚

åˆ—å‡ºæ‰€æœ‰è´Ÿè½½å‡è¡¡å™¨ï¼š

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### å¤–éƒ¨ IP <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
å¤–éƒ¨ IP æ˜¯ç”±ç±»å‹ä¸ºè´Ÿè½½å‡è¡¡å™¨çš„æœåŠ¡æš´éœ²çš„ï¼Œé€šå¸¸åœ¨ä½¿ç”¨å¤–éƒ¨äº‘æä¾›å•†è´Ÿè½½å‡è¡¡å™¨æ—¶ä½¿ç”¨ã€‚

è¦æ‰¾åˆ°å®ƒä»¬ï¼Œè¯·æ£€æŸ¥å…·æœ‰ `EXTERNAL-IP` å­—æ®µå€¼çš„è´Ÿè½½å‡è¡¡å™¨ã€‚
{% endhint %}

è¿›å…¥é›†ç¾¤çš„æµé‡ï¼Œç›®æ ‡ IP æ˜¯**å¤–éƒ¨ IP**ï¼Œåœ¨æœåŠ¡ç«¯å£ä¸Šï¼Œå°†è¢«**è·¯ç”±åˆ°æœåŠ¡ç«¯ç‚¹ä¹‹ä¸€**ã€‚`externalIPs` ä¸å— Kubernetes ç®¡ç†ï¼Œæ˜¯é›†ç¾¤ç®¡ç†å‘˜çš„è´£ä»»ã€‚

åœ¨æœåŠ¡è§„èŒƒä¸­ï¼Œå¯ä»¥ä¸ä»»ä½• `ServiceTypes` ä¸€èµ·æŒ‡å®š `externalIPs`ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œ"`my-service`" å¯ä»¥é€šè¿‡ "`80.11.12.10:80`" (`externalIP:port`) è®¿é—®ã€‚
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**æ¥è‡ªæ–‡æ¡£ï¼š**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) ExternalNameç±»å‹çš„æœåŠ¡**å°†ä¸€ä¸ªæœåŠ¡æ˜ å°„åˆ°ä¸€ä¸ªDNSåç§°**ï¼Œè€Œä¸æ˜¯åƒ`my-service`æˆ–`cassandra`è¿™æ ·çš„å…¸å‹é€‰æ‹©å™¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨`spec.externalName`å‚æ•°æŒ‡å®šè¿™äº›æœåŠ¡ã€‚

ä¾‹å¦‚ï¼Œä»¥ä¸‹æœåŠ¡å®šä¹‰å°†`prod`å‘½åç©ºé—´ä¸­çš„`my-service`æœåŠ¡æ˜ å°„åˆ°`my.database.example.com`ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
å½“æŸ¥æ‰¾ä¸»æœº`my-service.prod.svc.cluster.local`æ—¶ï¼Œé›†ç¾¤ DNS æœåŠ¡è¿”å›ä¸€ä¸ªå€¼ä¸º`my.database.example.com`çš„`CNAME`è®°å½•ã€‚è®¿é—®`my-service`çš„æ–¹å¼ä¸å…¶ä»–æœåŠ¡ç›¸åŒï¼Œä½†å…³é”®çš„åŒºåˆ«åœ¨äº**é‡å®šå‘å‘ç”Ÿåœ¨ DNS çº§åˆ«**ï¼Œè€Œä¸æ˜¯é€šè¿‡ä»£ç†æˆ–è½¬å‘ã€‚

åˆ—å‡ºæ‰€æœ‰ ExternalNames:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

ä¸ä¸Šé¢æ‰€æœ‰ç¤ºä¾‹ä¸åŒï¼Œ**Ingressä¸æ˜¯ä¸€ç§æœåŠ¡ç±»å‹**ã€‚ç›¸åï¼Œå®ƒä½äº**å¤šä¸ªæœåŠ¡å‰é¢ï¼Œå……å½“â€œæ™ºèƒ½è·¯ç”±å™¨â€**æˆ–è¿›å…¥é›†ç¾¤çš„å…¥å£ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨Ingressæ‰§è¡Œè®¸å¤šä¸åŒçš„æ“ä½œï¼Œå¹¶ä¸”æœ‰**è®¸å¤šç§ä¸åŒåŠŸèƒ½çš„Ingressæ§åˆ¶å™¨**ã€‚

é»˜è®¤çš„GKE Ingressæ§åˆ¶å™¨å°†ä¸ºæ‚¨å¯åŠ¨ä¸€ä¸ª[HTTP(S)è´Ÿè½½å‡è¡¡å™¨](https://cloud.google.com/compute/docs/load-balancing/http/)ã€‚è¿™å°†ä½¿æ‚¨èƒ½å¤Ÿå¯¹åç«¯æœåŠ¡è¿›è¡ŒåŸºäºè·¯å¾„å’Œå­åŸŸçš„è·¯ç”±ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å°†foo.yourdomain.comä¸Šçš„æ‰€æœ‰å†…å®¹å‘é€åˆ°fooæœåŠ¡ï¼Œå¹¶å°†yourdomain.com/bar/è·¯å¾„ä¸‹çš„æ‰€æœ‰å†…å®¹å‘é€åˆ°baræœåŠ¡ã€‚

åœ¨GKEä¸Šä½¿ç”¨[L7 HTTPè´Ÿè½½å‡è¡¡å™¨](https://cloud.google.com/compute/docs/load-balancing/http/)çš„Ingresså¯¹è±¡çš„YAMLå¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
åˆ—å‡ºæ‰€æœ‰çš„å…¥å£ï¼š

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

å°½ç®¡åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¥½é€ä¸ªè·å–æ¯ä¸ªä¿¡æ¯ä»¥æ›´å¥½åœ°é˜…è¯»å®ƒï¼š
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### å‚è€ƒ

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
