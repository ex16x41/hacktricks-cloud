# Exposing Services in Kubernetes

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

IstniejÄ… **rÃ³Å¼ne sposoby na udostÄ™pnienie usÅ‚ug** w Kubernetes, aby zarÃ³wno **wewnÄ™trzne**, jak i **zewnÄ™trzne** punkty koÅ„cowe mogÅ‚y uzyskaÄ‡ do nich dostÄ™p. Ta konfiguracja Kubernetes jest doÅ›Ä‡ krytyczna, poniewaÅ¼ administrator moÅ¼e daÄ‡ dostÄ™p **atakujÄ…cym do usÅ‚ug, do ktÃ³rych nie powinni mieÄ‡ dostÄ™pu**.

### Automatic Enumeration

Zanim zaczniesz enumerowaÄ‡ sposoby, w jakie K8s oferuje udostÄ™pnienie usÅ‚ug publicznie, wiedz, Å¼e jeÅ›li moÅ¼esz wymieniÄ‡ przestrzenie nazw, usÅ‚ugi i ingressy, moÅ¼esz znaleÅºÄ‡ wszystko, co jest udostÄ™pnione publicznie za pomocÄ…:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

UsÅ‚uga **ClusterIP** jest **domyÅ›lnÄ…** usÅ‚ugÄ… Kubernetes. Daje ci **usÅ‚ugÄ™ wewnÄ…trz** twojego klastra, do ktÃ³rej mogÄ… uzyskaÄ‡ dostÄ™p inne aplikacje w twoim klastrze. **Brak dostÄ™pu zewnÄ™trznego**.

JednakÅ¼e, moÅ¼na uzyskaÄ‡ do niej dostÄ™p za pomocÄ… Proxy Kubernetes:
```bash
kubectl proxy --port=8080
```
Teraz moÅ¼esz nawigowaÄ‡ przez API Kubernetes, aby uzyskaÄ‡ dostÄ™p do usÅ‚ug, uÅ¼ywajÄ…c tego schematu:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Na przykÅ‚ad moÅ¼esz uÅ¼yÄ‡ nastÄ™pujÄ…cego adresu URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

aby uzyskaÄ‡ dostÄ™p do tej usÅ‚ugi:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Ta metoda wymaga, abyÅ› uruchomiÅ‚ `kubectl` jako **uwierzytelniony uÅ¼ytkownik**._

WyÅ›wietl wszystkie ClusterIP:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

Gdy **NodePort** jest wykorzystywany, wyznaczony port jest udostÄ™pniany na wszystkich WÄ™zÅ‚ach (reprezentujÄ…cych Wirtualne Maszyny). **Ruch** kierowany do tego konkretnego portu jest nastÄ™pnie systematycznie **przekierowywany do usÅ‚ugi**. Zazwyczaj ta metoda nie jest zalecana z powodu jej wad.

Lista wszystkich NodePortÃ³w:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

PrzykÅ‚ad specyfikacji NodePort:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
JeÅ›li **nie okreÅ›lisz** **nodePort** w yaml (to jest port, ktÃ³ry zostanie otwarty), zostanie uÅ¼yty port w **zakresie 30000â€“32767**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Ekspozycja usÅ‚ugi na zewnÄ…trz **za pomocÄ… load balancera dostawcy chmury**. Na GKE uruchomi to [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/), ktÃ³ry da ci jeden adres IP, ktÃ³ry przekieruje caÅ‚y ruch do twojej usÅ‚ugi. W AWS uruchomi Load Balancer.

Musisz pÅ‚aciÄ‡ za LoadBalancer za kaÅ¼dÄ… eksponowanÄ… usÅ‚ugÄ™, co moÅ¼e byÄ‡ kosztowne.

Lista wszystkich LoadBalancers:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### External IPs <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
ZewnÄ™trzne adresy IP sÄ… eksponowane przez usÅ‚ugi typu Load Balancers i sÄ… zazwyczaj uÅ¼ywane, gdy korzysta siÄ™ z zewnÄ™trznego Load Balancera dostawcy chmury.

Aby je znaleÅºÄ‡, sprawdÅº load balancery z wartoÅ›ciami w polu `EXTERNAL-IP`.
{% endhint %}

Ruch, ktÃ³ry wchodzi do klastra z **zewnÄ™trznym IP** (jako **adres docelowy**), na porcie usÅ‚ugi, bÄ™dzie **przekierowywany do jednego z punktÃ³w koÅ„cowych usÅ‚ugi**. `externalIPs` nie sÄ… zarzÄ…dzane przez Kubernetes i sÄ… odpowiedzialnoÅ›ciÄ… administratora klastra.

W specyfikacji usÅ‚ugi `externalIPs` mogÄ… byÄ‡ okreÅ›lone wraz z dowolnym z `ServiceTypes`. W poniÅ¼szym przykÅ‚adzie, "`my-service`" moÅ¼e byÄ‡ dostÄ™pny dla klientÃ³w na "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Z dokumentacji:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) UsÅ‚ugi typu ExternalName **mapujÄ… usÅ‚ugÄ™ do nazwy DNS**, a nie do typowego selektora, takiego jak `my-service` lub `cassandra`. Te usÅ‚ugi okreÅ›lasz za pomocÄ… parametru `spec.externalName`.

Ta definicja usÅ‚ugi, na przykÅ‚ad, mapuje usÅ‚ugÄ™ `my-service` w przestrzeni nazw `prod` do `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Kiedy wyszukujesz hosta `my-service.prod.svc.cluster.local`, usÅ‚uga DNS klastra zwraca rekord `CNAME` o wartoÅ›ci `my.database.example.com`. Uzyskiwanie dostÄ™pu do `my-service` dziaÅ‚a w ten sam sposÃ³b, co inne usÅ‚ugi, ale z kluczowÄ… rÃ³Å¼nicÄ…, Å¼e **przekierowanie odbywa siÄ™ na poziomie DNS** zamiast przez proxy lub przekazywanie.

WymieÅ„ wszystkie ExternalNames:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

W przeciwieÅ„stwie do wszystkich powyÅ¼szych przykÅ‚adÃ³w, **Ingress NIE jest typem usÅ‚ugi**. Zamiast tego, znajduje siÄ™ **przed wieloma usÅ‚ugami i dziaÅ‚a jako â€inteligentny routerâ€** lub punkt wejÅ›cia do twojego klastra.

MoÅ¼esz zrobiÄ‡ wiele rÃ³Å¼nych rzeczy z Ingress, a istnieje **wiele typÃ³w kontrolerÃ³w Ingress, ktÃ³re majÄ… rÃ³Å¼ne moÅ¼liwoÅ›ci**.

DomyÅ›lny kontroler ingress GKE uruchomi dla Ciebie [HTTP(S) Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/). To pozwoli Ci na routowanie oparte na Å›cieÅ¼kach oraz subdomenach do usÅ‚ug zaplecza. Na przykÅ‚ad, moÅ¼esz wysÅ‚aÄ‡ wszystko na foo.yourdomain.com do usÅ‚ugi foo, a wszystko pod Å›cieÅ¼kÄ… yourdomain.com/bar/ do usÅ‚ugi bar.

YAML dla obiektu Ingress na GKE z [L7 HTTP Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) moÅ¼e wyglÄ…daÄ‡ tak:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Wypisz wszystkie ingressy:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

ChociaÅ¼ w tym przypadku lepiej jest uzyskaÄ‡ informacje o kaÅ¼dym z osobna, aby lepiej je przeczytaÄ‡:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### References

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
