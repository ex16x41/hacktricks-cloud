# Exposing Services in Kubernetes

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Hay **diferentes formas de exponer servicios** en Kubernetes para que tanto los **puntos finales internos** como los **puntos finales externos** puedan acceder a ellos. Esta configuraci√≥n de Kubernetes es bastante cr√≠tica, ya que el administrador podr√≠a dar acceso a **atacantes a servicios a los que no deber√≠an poder acceder**.

### Enumeraci√≥n Autom√°tica

Antes de comenzar a enumerar las formas en que K8s ofrece exponer servicios al p√∫blico, sepa que si puede listar namespaces, servicios e ingresses, puede encontrar todo lo expuesto al p√∫blico con:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

Un **servicio ClusterIP** es el **servicio** predeterminado de Kubernetes. Te proporciona un **servicio dentro** de tu cl√∫ster al que otras aplicaciones dentro de tu cl√∫ster pueden acceder. No hay **acceso externo**.

Sin embargo, esto se puede acceder utilizando el Proxy de Kubernetes:
```bash
kubectl proxy --port=8080
```
Ahora, puedes navegar a trav√©s de la API de Kubernetes para acceder a los servicios utilizando este esquema:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Por ejemplo, podr√≠as usar la siguiente URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

para acceder a este servicio:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Este m√©todo requiere que ejecutes `kubectl` como un **usuario autenticado**._

Lista todos los ClusterIPs:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

Cuando se utiliza **NodePort**, se hace disponible un puerto designado en todos los Nodos (que representan las M√°quinas Virtuales). **El tr√°fico** dirigido a este puerto espec√≠fico se **rutea sistem√°ticamente al servicio**. T√≠picamente, este m√©todo no se recomienda debido a sus desventajas.

Lista todos los NodePorts:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

Un ejemplo de especificaci√≥n de NodePort:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Si **no especificas** el **nodePort** en el yaml (es el puerto que se abrir√°) se utilizar√° un puerto en el **rango 30000‚Äì32767**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Expone el Servicio externamente **utilizando el balanceador de carga de un proveedor de nube**. En GKE, esto iniciar√° un [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/) que te dar√° una √∫nica direcci√≥n IP que redirigir√° todo el tr√°fico a tu servicio. En AWS, lanzar√° un Load Balancer.

Tienes que pagar por un LoadBalancer por cada servicio expuesto, lo que puede ser costoso.

Lista todos los LoadBalancers:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### IPs Externos <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Los IPs externos son expuestos por servicios de tipo Load Balancers y generalmente se utilizan cuando se est√° utilizando un Load Balancer de un Proveedor de Nube externo.

Para encontrarlos, verifica los load balancers con valores en el campo `EXTERNAL-IP`.
{% endhint %}

El tr√°fico que ingresa al cl√∫ster con el **IP externo** (como **IP de destino**), en el puerto del Servicio, ser√° **enrutado a uno de los endpoints del Servicio**. `externalIPs` no son gestionados por Kubernetes y son responsabilidad del administrador del cl√∫ster.

En la especificaci√≥n del Servicio, `externalIPs` se pueden especificar junto con cualquiera de los `ServiceTypes`. En el ejemplo a continuaci√≥n, "`my-service`" puede ser accedido por clientes en "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**De la documentaci√≥n:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) Los servicios de tipo ExternalName **mapean un servicio a un nombre DNS**, no a un selector t√≠pico como `my-service` o `cassandra`. Especificas estos servicios con el par√°metro `spec.externalName`.

Esta definici√≥n de servicio, por ejemplo, mapea el servicio `my-service` en el espacio de nombres `prod` a `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Al buscar el host `my-service.prod.svc.cluster.local`, el Servicio DNS del cl√∫ster devuelve un registro `CNAME` con el valor `my.database.example.com`. Acceder a `my-service` funciona de la misma manera que otros Servicios, pero con la diferencia crucial de que **la redirecci√≥n ocurre a nivel de DNS** en lugar de a trav√©s de proxy o reenv√≠o.

Lista todos los ExternalNames:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

A diferencia de todos los ejemplos anteriores, **Ingress NO es un tipo de servicio**. En cambio, se sit√∫a **frente a m√∫ltiples servicios y act√∫a como un ‚Äúenrutador inteligente‚Äù** o punto de entrada a tu cl√∫ster.

Puedes hacer muchas cosas diferentes con un Ingress, y hay **muchos tipos de controladores de Ingress que tienen diferentes capacidades**.

El controlador de ingress predeterminado de GKE iniciar√° un [HTTP(S) Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) para ti. Esto te permitir√° hacer enrutamiento basado en rutas y subdominios a servicios de backend. Por ejemplo, puedes enviar todo en foo.yourdomain.com al servicio foo, y todo bajo la ruta yourdomain.com/bar/ al servicio bar.

El YAML para un objeto Ingress en GKE con un [L7 HTTP Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) podr√≠a verse as√≠:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Lista todos los ingresses:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Aunque en este caso es mejor obtener la informaci√≥n de cada uno uno por uno para leerla mejor:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Referencias

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}
