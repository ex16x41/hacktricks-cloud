# Expondo Servi√ßos no Kubernetes

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

Existem **diferentes maneiras de expor servi√ßos** no Kubernetes para que tanto **endpoints internos** quanto **endpoints externos** possam acess√°-los. Esta configura√ß√£o do Kubernetes √© bastante cr√≠tica, pois o administrador pode dar acesso a **atacantes a servi√ßos que eles n√£o deveriam conseguir acessar**.

### Enumera√ß√£o Autom√°tica

Antes de come√ßar a enumerar as maneiras que o K8s oferece para expor servi√ßos ao p√∫blico, saiba que se voc√™ pode listar namespaces, servi√ßos e ingresses, pode encontrar tudo exposto ao p√∫blico com:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

Um **servi√ßo ClusterIP** √© o **padr√£o** do **Kubernetes**. Ele fornece um **servi√ßo interno** no seu cluster que outros aplicativos dentro do seu cluster podem acessar. N√£o h√° **acesso externo**.

No entanto, isso pode ser acessado usando o Proxy do Kubernetes:
```bash
kubectl proxy --port=8080
```
Agora, voc√™ pode navegar pela API do Kubernetes para acessar servi√ßos usando este esquema:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Por exemplo, voc√™ poderia usar a seguinte URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

para acessar este servi√ßo:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Este m√©todo requer que voc√™ execute `kubectl` como um **usu√°rio autenticado**._

Liste todos os ClusterIPs:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

Quando **NodePort** √© utilizado, uma porta designada √© disponibilizada em todos os N√≥s (representando as M√°quinas Virtuais). **O tr√°fego** direcionado a esta porta espec√≠fica √© ent√£o sistematicamente **routed to the service**. Normalmente, este m√©todo n√£o √© recomendado devido √†s suas desvantagens.

Liste todos os NodePorts:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

Um exemplo de especifica√ß√£o NodePort:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Se voc√™ **n√£o especificar** o **nodePort** no yaml (√© a porta que ser√° aberta), uma porta na **faixa de 30000‚Äì32767 ser√° usada**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Exp√µe o Servi√ßo externamente **usando o balanceador de carga de um provedor de nuvem**. No GKE, isso ir√° iniciar um [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/) que lhe dar√° um √∫nico endere√ßo IP que encaminhar√° todo o tr√°fego para seu servi√ßo. No AWS, ele lan√ßar√° um Load Balancer.

Voc√™ tem que pagar por um LoadBalancer por servi√ßo exposto, o que pode ser caro.

Liste todos os LoadBalancers:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### IPs Externos <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
IPs externos s√£o expostos por servi√ßos do tipo Load Balancers e geralmente s√£o usados quando um Load Balancer de Provedor de Nuvem externo est√° sendo utilizado.

Para encontr√°-los, verifique os load balancers com valores no campo `EXTERNAL-IP`.
{% endhint %}

O tr√°fego que ingressa no cluster com o **IP externo** (como **IP de destino**), na porta do Servi√ßo, ser√° **routado para um dos endpoints do Servi√ßo**. `externalIPs` n√£o s√£o gerenciados pelo Kubernetes e s√£o de responsabilidade do administrador do cluster.

Na especifica√ß√£o do Servi√ßo, `externalIPs` podem ser especificados junto com qualquer um dos `ServiceTypes`. No exemplo abaixo, "`my-service`" pode ser acessado por clientes em "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Da documenta√ß√£o:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) Servi√ßos do tipo ExternalName **mapeiam um Servi√ßo para um nome DNS**, n√£o para um seletor t√≠pico como `my-service` ou `cassandra`. Voc√™ especifica esses Servi√ßos com o par√¢metro `spec.externalName`.

Esta defini√ß√£o de Servi√ßo, por exemplo, mapeia o Servi√ßo `my-service` no namespace `prod` para `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Ao procurar o host `my-service.prod.svc.cluster.local`, o Servi√ßo DNS do cluster retorna um registro `CNAME` com o valor `my.database.example.com`. Acessar `my-service` funciona da mesma forma que outros Servi√ßos, mas com a diferen√ßa crucial de que **a redire√ß√£o acontece no n√≠vel DNS** em vez de via proxy ou encaminhamento.

Liste todos os ExternalNames:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

Ao contr√°rio de todos os exemplos acima, **Ingress N√ÉO √© um tipo de servi√ßo**. Em vez disso, ele fica **na frente de v√°rios servi√ßos e atua como um ‚Äúroteador inteligente‚Äù** ou ponto de entrada para o seu cluster.

Voc√™ pode fazer muitas coisas diferentes com um Ingress, e existem **muitos tipos de controladores de Ingress que t√™m diferentes capacidades**.

O controlador de ingress padr√£o do GKE ir√° criar um [HTTP(S) Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) para voc√™. Isso permitir√° que voc√™ fa√ßa roteamento baseado em caminho e subdom√≠nio para servi√ßos de backend. Por exemplo, voc√™ pode enviar tudo em foo.seudominio.com para o servi√ßo foo, e tudo sob o caminho seudominio.com/bar/ para o servi√ßo bar.

O YAML para um objeto Ingress no GKE com um [L7 HTTP Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) pode parecer assim:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Liste todos os ingressos:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Embora neste caso seja melhor obter as informa√ß√µes de cada um individualmente para l√™-las melhor:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Refer√™ncias

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
