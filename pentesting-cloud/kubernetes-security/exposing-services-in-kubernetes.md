# Izlaganje usluga u Kubernetesu

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

Postoje **razliÄiti naÄini izlaganja usluga** u Kubernetesu tako da ih mogu pristupiti kako **interni** tako i **eksterni** endpointi. Ova konfiguracija u Kubernetesu je priliÄno kritiÄna jer administrator moÅ¾e omoguÄ‡iti pristup **napadaÄima uslugama do kojih ne bi trebali imati pristup**.

### Automatsko Nabrojavanje

Pre nego Å¡to poÄnete nabrajati naÄine na koje K8s omoguÄ‡ava izlaganje usluga javnosti, znajte da ako moÅ¾ete da nabrojite imenske prostore, usluge i ulaze, moÅ¾ete pronaÄ‡i sve Å¡to je izloÅ¾eno javnosti sa:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

**ClusterIP** servis je **podrazumevani** Kubernetes **servis**. PruÅ¾a vam **servis unutar** vaÅ¡eg klastera kojem mogu pristupiti druge aplikacije unutar vaÅ¡eg klastera. Ne postoji **spoljni pristup**.

MeÄ‘utim, ovome se moÅ¾e pristupiti koriÅ¡Ä‡enjem Kubernetes Proxy-ja:
```bash
kubectl proxy --port=8080
```
Sada moÅ¾ete da navigujete kroz Kubernetes API kako biste pristupili uslugama koristeÄ‡i ovu Å¡emu:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Na primer, moÅ¾ete koristiti sledeÄ‡i URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

da pristupite ovoj usluzi:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Ovaj metod zahteva da pokrenete `kubectl` kao **autentifikovan korisnik**._

Lista svih ClusterIP-ova:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

Kada se koristi **NodePort**, odreÄ‘eni port je dostupan na svim Ävorovima (predstavljajuÄ‡i virtuelne maÅ¡ine). **SaobraÄ‡aj** usmeren ka ovom specifiÄnom portu zatim se sistematski **usmerava ka servisu**. Ovaj metod obiÄno nije preporuÄljiv zbog svojih nedostataka.

Izlistaj sve NodePort-ove:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

Primer specifikacije NodePort:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Ako **ne navedete** **nodePort** u yaml datoteci (to je port koji Ä‡e biti otvoren) biÄ‡e koriÅ¡Ä‡en port u **opsegu 30000â€“32767**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

IzlaÅ¾e servis spolja **koristeÄ‡i load balancer provajdera oblaka**. Na GKE, ovo Ä‡e pokrenuti [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/) koji Ä‡e vam dati jednu IP adresu koja Ä‡e prosleÄ‘ivati sav saobraÄ‡aj ka vaÅ¡em servisu. Na AWS-u Ä‡e pokrenuti Load Balancer.

Morate platiti za svaki izloÅ¾eni servis LoadBalancer, Å¡to moÅ¾e biti skupo.

Izlistajte sve LoadBalancere:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### Spoljni IP-ovi <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Spoljni IP-ovi su izloÅ¾eni uslugama tipa Load Balancers i obiÄno se koriste kada se koristi spoljni Cloud Provider Load Balancer.

Za njihovo pronalaÅ¾enje, proverite balansere optereÄ‡enja sa vrednostima u polju `EXTERNAL-IP`.
{% endhint %}

SaobraÄ‡aj koji ulazi u klaster sa **spoljnim IP-om** (kao **odrediÅ¡ni IP**), na portu Servisa, Ä‡e biti **usmeren ka jednom od krajnjih taÄaka Servisa**. `externalIPs` nisu upravljani od strane Kubernetes-a i odgovornost su administratora klastera.

U specifikaciji Servisa, `externalIPs` mogu biti navedeni zajedno sa bilo kojim od `ServiceTypes`. U primeru ispod, "`moj-servis`" moÅ¾e biti pristupljen od strane klijenata na "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Iz dokumentacije:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) Servisi tipa ExternalName **mapiraju Servis na DNS ime**, a ne na tipiÄni selektor poput `my-service` ili `cassandra`. Ove Servise specificirate pomoÄ‡u parametra `spec.externalName`.

Na primer, ovako izgleda definicija ovog Servisa, gde se `my-service` Servis u `prod` namespace mapira na `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Kada potraÅ¾ite host `my-service.prod.svc.cluster.local`, DNS usluga klastera vraÄ‡a `CNAME` zapis sa vrednoÅ¡Ä‡u `my.database.example.com`. Pristupanje `my-service` radi na isti naÄin kao i drugi Servisi, ali sa kljuÄnom razlikom da **preusmeravanje se deÅ¡ava na nivou DNS-a** umesto putem proksiranja ili prosleÄ‘ivanja.

Lista svih ExternalNames:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

Za razliku od svih gore navedenih primera, **Ingress NIJE vrsta servisa**. Umesto toga, on sedi **ispred viÅ¡e servisa i deluje kao "pametni ruter"** ili ulazna taÄka u vaÅ¡ klaster.

MoÅ¾ete uraditi mnogo razliÄitih stvari sa Ingress-om, i postoji **mnogo vrsta Ingress kontrolera koji imaju razliÄite moguÄ‡nosti**.

Podrazumevani GKE Ingress kontroler Ä‡e pokrenuti [HTTP(S) Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) za vas. To Ä‡e vam omoguÄ‡iti rutiranje na osnovu putanje i poddomena ka pozadinskim servisima. Na primer, moÅ¾ete poslati sve sa foo.yourdomain.com ka servisu foo, i sve Å¡to je ispod putanje yourdomain.com/bar/ ka servisu bar.

YAML za Ingress objekat na GKE sa [L7 HTTP Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) moÅ¾e izgledati ovako:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Navedite sve ulaze:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Iako je u ovom sluÄaju bolje dobiti informacije jednu po jednu kako biste ih bolje proÄitali:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Reference

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
