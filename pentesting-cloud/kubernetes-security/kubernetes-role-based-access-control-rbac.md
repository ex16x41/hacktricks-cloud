# Kubernetes Role-Based Access Control(RBAC)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Role-Based Access Control (RBAC)

Kubernetes ina **moduli ya idhini inayoitwa Role-Based Access Control** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) ambayo husaidia kuweka ruhusa za matumizi kwa seva ya API.

Mfano wa ruhusa wa RBAC umejengwa kutoka **sehemu tatu tofauti**:

1. **Role\ClusterRole ¬≠‚Äì** Ruhusa halisi. Inajumuisha _**kanuni**_ zinazowrepresenta seti ya ruhusa. Kila kanuni ina [rasilimali](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) na [vitenzi](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Kitenzi ni kitendo ambacho kitawekwa kwenye rasilimali.
2. **Subject (Mtumiaji, Kundi au Akaunti ya Huduma) ‚Äì** Kitu ambacho kitapokea ruhusa.
3. **RoleBinding\ClusterRoleBinding ‚Äì** Muunganisho kati ya Role\ClusterRole na subject.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

Tofauti kati ya ‚Äú**Roles**‚Äù na ‚Äú**ClusterRoles**‚Äù ni mahali ambapo jukumu litatumika ‚Äì ‚Äú**Role**‚Äù itatoa ufikiaji kwa **namespace** moja **maalum**, wakati ‚Äú**ClusterRole**‚Äù inaweza kutumika katika **namespace zote** katika klasta. Zaidi ya hayo, **ClusterRoles** zinaweza pia kutoa ufikiaji kwa:

* Rasilimali za **cluster-scoped** (kama nodes).
* Mipangilio ya **non-resource** (kama /healthz).
* Rasilimali za namespaced (kama Pods), **katika namespace zote**.

Kuanzia **Kubernetes** 1.6 kuendelea, sera za **RBAC** zime **wezeshwa kwa default**. Lakini ili kuwezesha RBAC unaweza kutumia kitu kama:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Templates

Katika template ya **Role** au **ClusterRole** utahitaji kuashiria **jina la jukumu**, **namespace** (katika roles) na kisha **apiGroups**, **resources** na **verbs** za jukumu:

* **apiGroups** ni array inayoshikilia **API namespaces** tofauti ambazo sheria hii inatumika. Kwa mfano, ufafanuzi wa Pod unatumia apiVersion: v1. _Inaweza kuwa na thamani kama rbac.authorization.k8s.io au \[\*]_.
* **resources** ni array inayofafanua **ni rasilimali zipi sheria hii inatumika**. Unaweza kupata rasilimali zote kwa: `kubectl api-resources --namespaced=true`
* **verbs** ni array inayoshikilia **vitendo vilivyokubaliwa**. Kitenzi katika Kubernetes kinafafanua **aina ya hatua** unahitaji kutekeleza kwa rasilimali. Kwa mfano, kitenzi la orodha linatumika dhidi ya makusanyo wakati "pata" linatumika dhidi ya rasilimali moja.

### Rules Verbs

(_Taarifa hii ilichukuliwa kutoka_ [_**the docs**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| HTTP verb | request verb                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | tengeneza                                                                                                                                                     |
| GET, HEAD | pata (kwa rasilimali binafsi), orodha (kwa makusanyo, ikiwa ni pamoja na maudhui kamili ya kitu), angalia (kwa kuangalia rasilimali binafsi au mkusanyiko wa rasilimali) |
| PUT       | sasisha                                                                                                                                                       |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | futa (kwa rasilimali binafsi), futakoleksheni (kwa makusanyo)                                                                                                 |

Kubernetes wakati mwingine huangalia idhini kwa ruhusa za ziada kwa kutumia vitendo maalum. Kwa mfano:

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* kitenzi `use` kwenye rasilimali `podsecuritypolicies` katika kundi la API `policy`.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* vitendo `bind` na `escalate` kwenye rasilimali `roles` na `clusterroles` katika kundi la API `rbac.authorization.k8s.io`.
* [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* kitenzi `impersonate` kwenye `users`, `groups`, na `serviceaccounts` katika kundi la API msingi, na `userextras` katika kundi la API `authentication.k8s.io`.

{% hint style="warning" %}
Unaweza kupata **vitendo vyote ambavyo kila rasilimali inasaidia** ukitekeleza `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Examples

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Kwa mfano, unaweza kutumia **ClusterRole** kumruhusu mtumiaji maalum kuendesha:
```
kubectl get pods --all-namespaces
```
### **RoleBinding na ClusterRoleBinding**

[**Kutoka kwenye nyaraka:**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding) **Kifungo cha jukumu kinatoa ruhusa zilizofafanuliwa katika jukumu kwa mtumiaji au seti ya watumiaji**. Kinashikilia orodha ya wahusika (watumiaji, vikundi, au akaunti za huduma), na rejeleo kwa jukumu linalotolewa. **RoleBinding** inatoa ruhusa ndani ya **namespace** maalum wakati **ClusterRoleBinding** inatoa ufikiaji huo **kote kwenye klasta**.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Ruhusa ni za kuongezeka** hivyo ikiwa una clusterRole yenye ‚Äúorodhesha‚Äù na ‚Äúfuta‚Äù siri unaweza kuiongeza na Role yenye ‚Äúpata‚Äù. Hivyo kuwa makini na kila wakati jaribu majukumu yako na ruhusa na **eleza kile kinachoruhusiwa, kwa sababu kila kitu kinakataliwa kwa msingi.**

## **Kuhesabu RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Abuse Role/ClusterRoles for Privilege Escalation

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuatilie** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za hacking kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
