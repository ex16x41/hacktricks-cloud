# Kubernetes Role-Based Access Control(RBAC)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Role-Based Access Control (RBAC)

Kubernetes æœ‰ä¸€ä¸ª **åä¸ºåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) çš„æˆæƒæ¨¡å—ï¼Œå¸®åŠ©è®¾ç½® API æœåŠ¡å™¨çš„ä½¿ç”¨æƒé™ã€‚

RBAC çš„æƒé™æ¨¡å‹ç”± **ä¸‰ä¸ªç‹¬ç«‹éƒ¨åˆ†** æ„æˆï¼š

1. **Role\ClusterRole Â­â€“** å®é™…çš„æƒé™ã€‚å®ƒåŒ…å« _**è§„åˆ™**_ï¼Œè¡¨ç¤ºä¸€ç»„æƒé™ã€‚æ¯ä¸ªè§„åˆ™åŒ…å« [èµ„æº](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) å’Œ [åŠ¨è¯](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb)ã€‚åŠ¨è¯æ˜¯å°†åº”ç”¨äºèµ„æºçš„æ“ä½œã€‚
2. **Subject (ç”¨æˆ·ã€ç»„æˆ–æœåŠ¡è´¦æˆ·) â€“** å°†æ¥æ”¶æƒé™çš„å¯¹è±¡ã€‚
3. **RoleBinding\ClusterRoleBinding â€“** Role\ClusterRole å’Œä¸»ä½“ä¹‹é—´çš„è¿æ¥ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding_serviceaccount_and_role-1024x551.png)

â€œ**Roles**â€ å’Œ â€œ**ClusterRoles**â€ ä¹‹é—´çš„åŒºåˆ«ä»…åœ¨äºè§’è‰²çš„åº”ç”¨èŒƒå›´ â€“ â€œ**Role**â€ ä»…æˆäºˆå¯¹ **ä¸€ä¸ª** **ç‰¹å®š** **å‘½åç©ºé—´** çš„è®¿é—®ï¼Œè€Œ â€œ**ClusterRole**â€ å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„ **æ‰€æœ‰å‘½åç©ºé—´** ä¸­ä½¿ç”¨ã€‚æ­¤å¤–ï¼Œ**ClusterRoles** è¿˜å¯ä»¥æˆäºˆå¯¹ï¼š

* **é›†ç¾¤èŒƒå›´** çš„èµ„æºï¼ˆå¦‚èŠ‚ç‚¹ï¼‰ã€‚
* **éèµ„æº** ç«¯ç‚¹ï¼ˆå¦‚ /healthzï¼‰ã€‚
* å‘½åç©ºé—´èµ„æºï¼ˆå¦‚ Podsï¼‰ï¼Œ**è·¨æ‰€æœ‰å‘½åç©ºé—´**ã€‚

ä» **Kubernetes** 1.6 ç‰ˆæœ¬å¼€å§‹ï¼Œ**RBAC** ç­–ç•¥é»˜è®¤ **å¯ç”¨**ã€‚ä½†è¦å¯ç”¨ RBACï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹çš„å‘½ä»¤ï¼š
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## æ¨¡æ¿

åœ¨ **Role** æˆ– **ClusterRole** çš„æ¨¡æ¿ä¸­ï¼Œæ‚¨éœ€è¦æŒ‡æ˜ **è§’è‰²åç§°**ã€**å‘½åç©ºé—´**ï¼ˆåœ¨è§’è‰²ä¸­ï¼‰ï¼Œç„¶åæ˜¯ **apiGroups**ã€**èµ„æº** å’Œ **åŠ¨è¯**ï¼š

* **apiGroups** æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«æ­¤è§„åˆ™é€‚ç”¨çš„ä¸åŒ **API å‘½åç©ºé—´**ã€‚ä¾‹å¦‚ï¼ŒPod å®šä¹‰ä½¿ç”¨ apiVersion: v1ã€‚_å®ƒå¯ä»¥å…·æœ‰å¦‚ rbac.authorization.k8s.io æˆ– \[\*] çš„å€¼_ã€‚
* **èµ„æº** æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå®šä¹‰ **æ­¤è§„åˆ™é€‚ç”¨çš„èµ„æº**ã€‚æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ‰¾åˆ°æ‰€æœ‰èµ„æºï¼š`kubectl api-resources --namespaced=true`
* **åŠ¨è¯** æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å« **å…è®¸çš„åŠ¨è¯**ã€‚Kubernetes ä¸­çš„åŠ¨è¯å®šä¹‰äº†æ‚¨éœ€è¦å¯¹èµ„æºæ‰§è¡Œçš„ **æ“ä½œç±»å‹**ã€‚ä¾‹å¦‚ï¼Œlist åŠ¨è¯ç”¨äºé›†åˆï¼Œè€Œ "get" ç”¨äºå•ä¸ªèµ„æºã€‚

### è§„åˆ™åŠ¨è¯

(_æ­¤ä¿¡æ¯æ¥è‡ª_ [_**æ–‡æ¡£**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| HTTP åŠ¨è¯ | è¯·æ±‚åŠ¨è¯                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | getï¼ˆé’ˆå¯¹å•ä¸ªèµ„æºï¼‰ï¼Œlistï¼ˆé’ˆå¯¹é›†åˆï¼ŒåŒ…æ‹¬å®Œæ•´å¯¹è±¡å†…å®¹ï¼‰ï¼Œwatchï¼ˆç”¨äºè§‚å¯Ÿå•ä¸ªèµ„æºæˆ–èµ„æºé›†åˆï¼‰                                                             |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | deleteï¼ˆé’ˆå¯¹å•ä¸ªèµ„æºï¼‰ï¼Œdeletecollectionï¼ˆé’ˆå¯¹é›†åˆï¼‰                                                                                                         |

Kubernetes æœ‰æ—¶ä¼šä½¿ç”¨ä¸“é—¨çš„åŠ¨è¯æ£€æŸ¥é¢å¤–çš„æˆæƒæƒé™ã€‚ä¾‹å¦‚ï¼š

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* `use` åŠ¨è¯åœ¨ `policy` API ç»„ä¸­çš„ `podsecuritypolicies` èµ„æºä¸Šã€‚
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* `bind` å’Œ `escalate` åŠ¨è¯åœ¨ `rbac.authorization.k8s.io` API ç»„ä¸­çš„ `roles` å’Œ `clusterroles` èµ„æºä¸Šã€‚
* [èº«ä»½éªŒè¯](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* `impersonate` åŠ¨è¯åœ¨æ ¸å¿ƒ API ç»„ä¸­çš„ `users`ã€`groups` å’Œ `serviceaccounts` ä»¥åŠåœ¨ `authentication.k8s.io` API ç»„ä¸­çš„ `userextras` ä¸Šã€‚

{% hint style="warning" %}
æ‚¨å¯ä»¥é€šè¿‡æ‰§è¡Œ `kubectl api-resources --sort-by name -o wide` æ‰¾åˆ° **æ¯ä¸ªèµ„æºæ”¯æŒçš„æ‰€æœ‰åŠ¨è¯**ã€‚
{% endhint %}

### ç¤ºä¾‹

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="é›†ç¾¤è§’è‰²" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ **ClusterRole** å…è®¸ç‰¹å®šç”¨æˆ·è¿è¡Œï¼š
```
kubectl get pods --all-namespaces
```
### **RoleBinding å’Œ ClusterRoleBinding**

[**æ¥è‡ªæ–‡æ¡£ï¼š**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding) **è§’è‰²ç»‘å®šå°†è§’è‰²ä¸­å®šä¹‰çš„æƒé™æˆäºˆç”¨æˆ·æˆ–ç”¨æˆ·é›†**ã€‚å®ƒåŒ…å«ä¸€ä¸ªä¸»é¢˜åˆ—è¡¨ï¼ˆç”¨æˆ·ã€ç»„æˆ–æœåŠ¡è´¦æˆ·ï¼‰å’Œå¯¹è¢«æˆäºˆè§’è‰²çš„å¼•ç”¨ã€‚**RoleBinding** åœ¨ç‰¹å®š **å‘½åç©ºé—´** å†…æˆäºˆæƒé™ï¼Œè€Œ **ClusterRoleBinding** åˆ™åœ¨ **é›†ç¾¤èŒƒå›´** å†…æˆäºˆè®¿é—®æƒé™ã€‚

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**æƒé™æ˜¯ç´¯åŠ çš„**ï¼Œå› æ­¤å¦‚æœæ‚¨æœ‰ä¸€ä¸ª clusterRoleï¼Œå…·æœ‰â€œåˆ—å‡ºâ€å’Œâ€œåˆ é™¤â€ç§˜å¯†çš„æƒé™ï¼Œæ‚¨å¯ä»¥å°†å…¶ä¸å…·æœ‰â€œè·å–â€æƒé™çš„ Role ç»“åˆä½¿ç”¨ã€‚å› æ­¤ï¼Œè¯·åŠ¡å¿…æ³¨æ„å¹¶å§‹ç»ˆæµ‹è¯•æ‚¨çš„è§’è‰²å’Œæƒé™ï¼Œå¹¶**æŒ‡å®šå…è®¸çš„å†…å®¹ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰å†…å®¹éƒ½æ˜¯æ‹’ç»çš„ã€‚**

## **æšä¸¾ RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### æ»¥ç”¨è§’è‰²/é›†ç¾¤è§’è‰²è¿›è¡Œæƒé™æå‡

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
