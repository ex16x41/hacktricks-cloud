# Kubernetes Role-Based Access Control(RBAC)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Role-Based Access Control (RBAC)

Kubernetes ima **modul autorizacije nazvan Role-Based Access Control** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) koji pomaÅ¾e u postavljanju dozvola za koriÅ¡Ä‡enje API servera.

RBAC-ov model dozvola se sastoji od **tri pojedinaÄna dela**:

1. **Role\ClusterRole Â­â€“** Stvarna dozvola. SadrÅ¾i _**pravila**_ koja predstavljaju skup dozvola. Svako pravilo sadrÅ¾i [resurse](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) i [glagole](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Glagol je radnja koja Ä‡e se primeniti na resurs.
2. **Subject (Korisnik, Grupa ili ServiceAccount) â€“** Objekat koji Ä‡e primiti dozvole.
3. **RoleBinding\ClusterRoleBinding â€“** Povezivanje izmeÄ‘u Role\ClusterRole i subjekta.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

Razlika izmeÄ‘u â€œ**Roles**â€ i â€œ**ClusterRoles**â€ je samo u tome gde Ä‡e se uloga primeniti â€“ â€œ**Role**â€ Ä‡e omoguÄ‡iti pristup samo **jednom** **specifiÄnom** **namespace-u**, dok se â€œ**ClusterRole**â€ moÅ¾e koristiti u **svim namespace-ima** u klasteru. Å taviÅ¡e, **ClusterRoles** takoÄ‘e mogu omoguÄ‡iti pristup:

* **resursima sa opsegom klastera** (kao Å¡to su Ävorovi).
* **ne-resursnim** krajnjim taÄkama (kao Å¡to je /healthz).
* resursima sa namespace-om (kao Å¡to su Pods), **u svim namespace-ima**.

Od **Kubernetes** 1.6 pa nadalje, **RBAC** politike su **omoguÄ‡ene po defaultu**. Ali da biste omoguÄ‡ili RBAC, moÅ¾ete koristiti neÅ¡to poput:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Templates

U Å¡ablonu **Role** ili **ClusterRole** potrebno je da navedete **ime uloge**, **namespace** (u ulogama) i zatim **apiGroups**, **resources** i **verbs** uloge:

* **apiGroups** je niz koji sadrÅ¾i razliÄite **API namespace** na koje se ova pravila primenjuju. Na primer, definicija Pod koristi apiVersion: v1. _MoÅ¾e imati vrednosti kao Å¡to su rbac.authorization.k8s.io ili \[\*]_.
* **resources** je niz koji definiÅ¡e **koje resurse se ova pravila primenjuju**. Sve resurse moÅ¾ete pronaÄ‡i sa: `kubectl api-resources --namespaced=true`
* **verbs** je niz koji sadrÅ¾i **dozvoljene glagole**. Glagol u Kubernetes definiÅ¡e **tip akcije** koju treba primeniti na resurs. Na primer, glagol list se koristi za kolekcije dok se "get" koristi za pojedinaÄne resurse.

### Rules Verbs

(_Ove informacije su preuzete iz_ [_**dokumentacije**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| HTTP glagol | glagol zahteva                                                                                                                                                  |
| ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST        | create                                                                                                                                                        |
| GET, HEAD   | get (za pojedinaÄne resurse), list (za kolekcije, ukljuÄujuÄ‡i sadrÅ¾aj celog objekta), watch (za praÄ‡enje pojedinaÄnog resursa ili kolekcije resursa) |
| PUT         | update                                                                                                                                                        |
| PATCH       | patch                                                                                                                                                         |
| DELETE      | delete (za pojedinaÄne resurse), deletecollection (za kolekcije)                                                                                         |

Kubernetes ponekad proverava autorizaciju za dodatne dozvole koristeÄ‡i specijalizovane glagole. Na primer:

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* `use` glagol na `podsecuritypolicies` resursima u `policy` API grupi.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* `bind` i `escalate` glagoli na `roles` i `clusterroles` resursima u `rbac.authorization.k8s.io` API grupi.
* [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* `impersonate` glagol na `users`, `groups`, i `serviceaccounts` u core API grupi, i `userextras` u `authentication.k8s.io` API grupi.

{% hint style="warning" %}
MoÅ¾ete pronaÄ‡i **sve glagole koje svaki resurs podrÅ¾ava** izvrÅ¡avanjem `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Examples

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Na primer, moÅ¾ete koristiti **ClusterRole** da omoguÄ‡ite odreÄ‘enom korisniku da pokrene:
```
kubectl get pods --all-namespaces
```
### **RoleBinding i ClusterRoleBinding**

[**Iz dokumenata:**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding) **Role binding dodeljuje dozvole definisane u roli korisniku ili skupu korisnika**. SadrÅ¾i listu subjekata (korisnici, grupe ili servisni nalozi) i referencu na rolu koja se dodeljuje. **RoleBinding** dodeljuje dozvole unutar specifiÄnog **namespace-a**, dok **ClusterRoleBinding** dodeljuje taj pristup **na nivou klastera**.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Dozvole su aditivne** tako da ako imate clusterRole sa â€œlistâ€ i â€œdeleteâ€ tajnama, moÅ¾ete ga dodati sa Role koja ima â€œgetâ€. Tako da budite svesni i uvek testirajte svoje uloge i dozvole i **navedite Å¡ta je DOZVOLJENO, jer je sve po defaultu ZABRANJENO.**

## **Enumeracija RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Zloupotreba Role/ClusterRoles za Eskalaciju Privilegija

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
