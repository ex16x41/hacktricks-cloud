# KubernetesåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚**

</details>
{% endhint %}

## åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰

Kubernetesæœ‰ä¸€ä¸ªåä¸ºåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆ[RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)ï¼‰çš„**æˆæƒæ¨¡å—**ï¼Œå¯å¸®åŠ©è®¾ç½®å¯¹APIæœåŠ¡å™¨çš„ä½¿ç”¨æƒé™ã€‚

RBACçš„æƒé™æ¨¡å‹ç”±**ä¸‰ä¸ªç‹¬ç«‹éƒ¨åˆ†**æ„æˆï¼š

1. **Role\ClusterRole** â€“ å®é™…æƒé™ã€‚å®ƒåŒ…å«ä»£è¡¨ä¸€ç»„æƒé™çš„**è§„åˆ™**ã€‚æ¯ä¸ªè§„åˆ™åŒ…å«[èµ„æº](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types)å’Œ[åŠ¨è¯](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb)ã€‚åŠ¨è¯æ˜¯å°†åº”ç”¨äºèµ„æºçš„æ“ä½œã€‚
2. **Subjectï¼ˆç”¨æˆ·ã€ç»„æˆ–ServiceAccountï¼‰** â€“ å°†æ¥æ”¶æƒé™çš„å¯¹è±¡ã€‚
3. **RoleBinding\ClusterRoleBinding** â€“ Role\ClusterRoleå’ŒSubjectä¹‹é—´çš„è¿æ¥ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

â€œ**Roles**â€å’Œâ€œ**ClusterRoles**â€ä¹‹é—´çš„åŒºåˆ«ä»…åœ¨äºè§’è‰²å°†åº”ç”¨çš„ä½ç½® â€“ â€œ**Role**â€å°†ä»…æˆäºˆå¯¹**ä¸€ä¸ªç‰¹å®šå‘½åç©ºé—´**çš„è®¿é—®æƒé™ï¼Œè€Œâ€œ**ClusterRole**â€å¯ç”¨äº**é›†ç¾¤ä¸­çš„æ‰€æœ‰å‘½åç©ºé—´**ã€‚æ­¤å¤–ï¼Œ**ClusterRoles**è¿˜å¯ä»¥æˆäºˆå¯¹ä»¥ä¸‹å†…å®¹çš„è®¿é—®æƒé™ï¼š

* **é›†ç¾¤èŒƒå›´**èµ„æºï¼ˆå¦‚èŠ‚ç‚¹ï¼‰ã€‚
* **éèµ„æº**ç«¯ç‚¹ï¼ˆå¦‚/healthzï¼‰ã€‚
* å‘½åç©ºé—´èµ„æºï¼ˆå¦‚Podsï¼‰ï¼Œ**è·¨æ‰€æœ‰å‘½åç©ºé—´**ã€‚

ä»**Kubernetes** 1.6å¼€å§‹ï¼Œ**RBAC**ç­–ç•¥**é»˜è®¤å¯ç”¨**ã€‚ä½†è¦å¯ç”¨RBACï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## æ¨¡æ¿

åœ¨**Role**æˆ–**ClusterRole**çš„æ¨¡æ¿ä¸­ï¼Œæ‚¨éœ€è¦æŒ‡å®š**è§’è‰²çš„åç§°**ï¼Œ**å‘½åç©ºé—´**ï¼ˆåœ¨è§’è‰²ä¸­ï¼‰ï¼Œç„¶åæ˜¯è§’è‰²çš„**apiGroups**ï¼Œ**èµ„æº**å’Œ**åŠ¨è¯**ï¼š

- **apiGroups**æ˜¯ä¸€ä¸ªåŒ…å«æ­¤è§„åˆ™é€‚ç”¨äºçš„ä¸åŒ**APIå‘½åç©ºé—´**çš„æ•°ç»„ã€‚ä¾‹å¦‚ï¼ŒPodå®šä¹‰ä½¿ç”¨apiVersionï¼šv1ã€‚_å®ƒå¯ä»¥å…·æœ‰å€¼ï¼Œå¦‚rbac.authorization.k8s.ioæˆ–\[\*]_ã€‚
- **èµ„æº**æ˜¯ä¸€ä¸ªå®šä¹‰**æ­¤è§„åˆ™é€‚ç”¨äºå“ªäº›èµ„æº**çš„æ•°ç»„ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰¾åˆ°æ‰€æœ‰èµ„æºï¼š`kubectl api-resources --namespaced=true`
- **åŠ¨è¯**æ˜¯ä¸€ä¸ªåŒ…å«**å…è®¸çš„åŠ¨è¯**çš„æ•°ç»„ã€‚Kubernetesä¸­çš„åŠ¨è¯å®šä¹‰äº†æ‚¨éœ€è¦å¯¹èµ„æºåº”ç”¨çš„**æ“ä½œç±»å‹**ã€‚ä¾‹å¦‚ï¼ŒliståŠ¨è¯ç”¨äºé›†åˆï¼Œè€Œ"get"ç”¨äºå•ä¸ªèµ„æºã€‚

### è§„åˆ™åŠ¨è¯

ï¼ˆ_æ­¤ä¿¡æ¯æ‘˜è‡ª_ [_**æ–‡æ¡£**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb)ï¼‰

| HTTPåŠ¨è¯ | è¯·æ±‚åŠ¨è¯                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | getï¼ˆç”¨äºå•ä¸ªèµ„æºï¼‰ï¼Œlistï¼ˆç”¨äºé›†åˆï¼ŒåŒ…æ‹¬å®Œæ•´å¯¹è±¡å†…å®¹ï¼‰ï¼Œwatchï¼ˆç”¨äºç›‘è§†å•ä¸ªèµ„æºæˆ–èµ„æºé›†åˆï¼‰ |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | deleteï¼ˆç”¨äºå•ä¸ªèµ„æºï¼‰ï¼Œdeletecollectionï¼ˆç”¨äºé›†åˆï¼‰                                                                                         |

æœ‰æ—¶Kubernetesä½¿ç”¨ä¸“é—¨çš„åŠ¨è¯æ£€æŸ¥é™„åŠ æƒé™çš„æˆæƒã€‚ä¾‹å¦‚ï¼š

- [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
- åœ¨`policy` APIç»„ä¸­å¯¹`podsecuritypolicies`èµ„æºä½¿ç”¨`use`åŠ¨è¯ã€‚
- [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
- åœ¨`rbac.authorization.k8s.io` APIç»„ä¸­å¯¹`roles`å’Œ`clusterroles`èµ„æºä½¿ç”¨`bind`å’Œ`escalate`åŠ¨è¯ã€‚
- [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
- åœ¨æ ¸å¿ƒAPIç»„ä¸­å¯¹`users`ï¼Œ`groups`å’Œ`serviceaccounts`ä½¿ç”¨`impersonate`åŠ¨è¯ï¼Œå¹¶åœ¨`authentication.k8s.io` APIç»„ä¸­å¯¹`userextras`ä½¿ç”¨ã€‚

{% hint style="warning" %}
æ‚¨å¯ä»¥é€šè¿‡æ‰§è¡Œ`kubectl api-resources --sort-by name -o wide`æ‰¾åˆ°**æ¯ä¸ªèµ„æºæ”¯æŒçš„æ‰€æœ‰åŠ¨è¯**
{% endhint %}

### ç¤ºä¾‹

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨**ClusterRole**æ¥å…è®¸ç‰¹å®šç”¨æˆ·è¿è¡Œï¼š
```
kubectl get pods --all-namespaces
```
### **RoleBindingå’ŒClusterRoleBinding**

**[æ¥è‡ªæ–‡æ¡£ï¼š](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** ä¸€ä¸ª**role bindingæˆäºˆäº†åœ¨ä¸€ä¸ªè§’è‰²ä¸­å®šä¹‰çš„æƒé™ç»™ä¸€ä¸ªç”¨æˆ·æˆ–ä¸€ç»„ç”¨æˆ·**ã€‚å®ƒåŒ…å«äº†ä¸€ç»„ä¸»ä½“ï¼ˆç”¨æˆ·ã€ç»„æˆ–æœåŠ¡è´¦æˆ·ï¼‰ä»¥åŠè¢«æˆäºˆçš„è§’è‰²çš„å¼•ç”¨ã€‚**RoleBinding**åœ¨ç‰¹å®šçš„**å‘½åç©ºé—´**å†…æˆäºˆæƒé™ï¼Œè€Œ**ClusterRoleBinding**åˆ™åœ¨æ•´ä¸ª**é›†ç¾¤èŒƒå›´**å†…æˆäºˆæƒé™ã€‚

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**æƒé™æ˜¯å¯ç´¯åŠ çš„**ï¼Œå› æ­¤å¦‚æœæ‚¨æœ‰ä¸€ä¸ªå…·æœ‰â€œlistâ€å’Œâ€œdeleteâ€ secrets çš„ clusterRoleï¼Œæ‚¨å¯ä»¥å°†å…¶ä¸ä¸€ä¸ªå…·æœ‰â€œgetâ€çš„ Role ç»“åˆä½¿ç”¨ã€‚å› æ­¤ï¼Œè¯·æ³¨æ„å¹¶å§‹ç»ˆæµ‹è¯•æ‚¨çš„è§’è‰²å’Œæƒé™ï¼Œå¹¶**æŒ‡å®šå…è®¸çš„æ“ä½œï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ä¸€åˆ‡éƒ½è¢«æ‹’ç»ã€‚**

## **æšä¸¾ RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### æ»¥ç”¨è§’è‰²/ClusterRoles è¿›è¡Œç‰¹æƒå‡çº§

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
å­¦ä¹ å¹¶å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶å®è·µ GCP é»‘å®¢æŠ€æœ¯: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
