# Kubernetes Role-Based Access Control(RBAC)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Controle de Acesso Baseado em Fun√ß√µes (RBAC)

Kubernetes tem um **m√≥dulo de autoriza√ß√£o chamado Controle de Acesso Baseado em Fun√ß√µes** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) que ajuda a definir permiss√µes de utiliza√ß√£o para o servidor API.

O modelo de permiss√£o do RBAC √© constru√≠do a partir de **tr√™s partes individuais**:

1. **Role\ClusterRole ¬≠‚Äì** A permiss√£o real. Cont√©m _**regras**_ que representam um conjunto de permiss√µes. Cada regra cont√©m [recursos](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) e [verbos](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). O verbo √© a a√ß√£o que ser√° aplicada ao recurso.
2. **Subject (Usu√°rio, Grupo ou ServiceAccount) ‚Äì** O objeto que receber√° as permiss√µes.
3. **RoleBinding\ClusterRoleBinding ‚Äì** A conex√£o entre Role\ClusterRole e o sujeito.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

A diferen√ßa entre ‚Äú**Roles**‚Äù e ‚Äú**ClusterRoles**‚Äù √© apenas onde a fun√ß√£o ser√° aplicada ‚Äì uma ‚Äú**Role**‚Äù conceder√° acesso a apenas **um** **namespace** **espec√≠fico**, enquanto uma ‚Äú**ClusterRole**‚Äù pode ser usada em **todos os namespaces** no cluster. Al√©m disso, **ClusterRoles** tamb√©m podem conceder acesso a:

* recursos **escopados ao cluster** (como n√≥s).
* endpoints **n√£o-recurso** (como /healthz).
* recursos namespaced (como Pods), **em todos os namespaces**.

A partir do **Kubernetes** 1.6, as pol√≠ticas de **RBAC** est√£o **ativadas por padr√£o**. Mas para ativar o RBAC voc√™ pode usar algo como:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Templates

No template de um **Role** ou um **ClusterRole**, voc√™ precisar√° indicar o **nome do papel**, o **namespace** (em roles) e ent√£o os **apiGroups**, **resources** e **verbs** do papel:

* Os **apiGroups** s√£o um array que cont√©m os diferentes **namespaces de API** aos quais esta regra se aplica. Por exemplo, uma defini√ß√£o de Pod usa apiVersion: v1. _Pode ter valores como rbac.authorization.k8s.io ou \[\*]_.
* Os **resources** s√£o um array que define **quais recursos esta regra se aplica**. Voc√™ pode encontrar todos os recursos com: `kubectl api-resources --namespaced=true`
* Os **verbs** s√£o um array que cont√©m os **verbos permitidos**. O verbo no Kubernetes define o **tipo de a√ß√£o** que voc√™ precisa aplicar ao recurso. Por exemplo, o verbo list √© usado contra cole√ß√µes, enquanto "get" √© usado contra um √∫nico recurso.

### Rules Verbs

(_Esta informa√ß√£o foi retirada de_ [_**the docs**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| HTTP verb | request verb                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (para recursos individuais), list (para cole√ß√µes, incluindo conte√∫do completo do objeto), watch (para observar um recurso individual ou cole√ß√£o de recursos) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (para recursos individuais), deletecollection (para cole√ß√µes)                                                                                         |

O Kubernetes √†s vezes verifica a autoriza√ß√£o para permiss√µes adicionais usando verbos especializados. Por exemplo:

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* verbo `use` em recursos `podsecuritypolicies` no grupo de API `policy`.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* verbos `bind` e `escalate` em recursos `roles` e `clusterroles` no grupo de API `rbac.authorization.k8s.io`.
* [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* verbo `impersonate` em `users`, `groups` e `serviceaccounts` no grupo de API core, e o `userextras` no grupo de API `authentication.k8s.io`.

{% hint style="warning" %}
Voc√™ pode encontrar **todos os verbos que cada recurso suporta** executando `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Examples

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Por exemplo, voc√™ pode usar um **ClusterRole** para permitir que um usu√°rio espec√≠fico execute:
```
kubectl get pods --all-namespaces
```
### **RoleBinding e ClusterRoleBinding**

[**Da documenta√ß√£o:**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding) Um **role binding concede as permiss√µes definidas em um papel a um usu√°rio ou conjunto de usu√°rios**. Ele cont√©m uma lista de sujeitos (usu√°rios, grupos ou contas de servi√ßo) e uma refer√™ncia ao papel sendo concedido. Um **RoleBinding** concede permiss√µes dentro de um **namespace** espec√≠fico, enquanto um **ClusterRoleBinding** concede esse acesso **em todo o cluster**.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**As permiss√µes s√£o aditivas**, ent√£o se voc√™ tiver um clusterRole com ‚Äúlistar‚Äù e ‚Äúdeletar‚Äù segredos, voc√™ pode adicion√°-lo a um Role com ‚Äúobter‚Äù. Portanto, esteja ciente e sempre teste seus roles e permiss√µes e **especifique o que √© PERMITIDO, porque tudo √© NEGADO por padr√£o.**

## **Enumerando RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Abusar de Roles/ClusterRoles para Escala√ß√£o de Privil√©gios

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
