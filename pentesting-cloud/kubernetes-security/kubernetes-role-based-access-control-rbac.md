# Control de Acceso Basado en Roles (RBAC) de Kubernetes

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Control de Acceso Basado en Roles (RBAC)

Kubernetes tiene un **m√≥dulo de autorizaci√≥n llamado Control de Acceso Basado en Roles** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) que ayuda a establecer permisos de utilizaci√≥n para el servidor API.

El modelo de permisos de RBAC se construye a partir de **tres partes individuales**:

1. **Role\ClusterRole ¬≠‚Äì** El permiso real. Contiene _**reglas**_ que representan un conjunto de permisos. Cada regla contiene [recursos](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) y [verbos](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). El verbo es la acci√≥n que se aplicar√° al recurso.
2. **Sujeto (Usuario, Grupo o ServiceAccount) ‚Äì** El objeto que recibir√° los permisos.
3. **RoleBinding\ClusterRoleBinding ‚Äì** La conexi√≥n entre Role\ClusterRole y el sujeto.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

La diferencia entre ‚Äú**Roles**‚Äù y ‚Äú**ClusterRoles**‚Äù es solo d√≥nde se aplicar√° el rol ‚Äì un ‚Äú**Role**‚Äù otorgar√° acceso a **un** **namespace** **espec√≠fico**, mientras que un ‚Äú**ClusterRole**‚Äù puede ser utilizado en **todos los namespaces** en el cl√∫ster. Adem√°s, los **ClusterRoles** tambi√©n pueden otorgar acceso a:

* recursos **a nivel de cl√∫ster** (como nodos).
* puntos finales **no relacionados con recursos** (como /healthz).
* recursos con namespace (como Pods), **a trav√©s de todos los namespaces**.

Desde **Kubernetes** 1.6 en adelante, las pol√≠ticas de **RBAC** est√°n **habilitadas por defecto**. Pero para habilitar RBAC puedes usar algo como:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Plantillas

En la plantilla de un **Role** o un **ClusterRole** necesitar√°s indicar el **nombre del rol**, el **namespace** (en roles) y luego los **apiGroups**, **resources** y **verbs** del rol:

* Los **apiGroups** son un array que contiene los diferentes **namespaces de API** a los que se aplica esta regla. Por ejemplo, una definici√≥n de Pod utiliza apiVersion: v1. _Puede tener valores como rbac.authorization.k8s.io o \[\*]_.
* Los **resources** son un array que define **a qu√© recursos se aplica esta regla**. Puedes encontrar todos los recursos con: `kubectl api-resources --namespaced=true`
* Los **verbs** son un array que contiene los **verbos permitidos**. El verbo en Kubernetes define el **tipo de acci√≥n** que necesitas aplicar al recurso. Por ejemplo, el verbo list se usa contra colecciones mientras que "get" se usa contra un solo recurso.

### Verbos de Reglas

(_Esta informaci√≥n fue tomada de_ [_**los docs**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| Verbo HTTP | verbo de solicitud                                                                                                                                                  |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| POST       | crear                                                                                                                                                               |
| GET, HEAD  | obtener (para recursos individuales), listar (para colecciones, incluyendo el contenido completo del objeto), observar (para observar un recurso individual o colecci√≥n de recursos) |
| PUT        | actualizar                                                                                                                                                           |
| PATCH      | parchear                                                                                                                                                            |
| DELETE     | eliminar (para recursos individuales), eliminarcolecci√≥n (para colecciones)                                                                                       |

Kubernetes a veces verifica la autorizaci√≥n para permisos adicionales utilizando verbos especializados. Por ejemplo:

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* verbo `use` en recursos `podsecuritypolicies` en el grupo de API `policy`.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* verbos `bind` y `escalate` en recursos `roles` y `clusterroles` en el grupo de API `rbac.authorization.k8s.io`.
* [Autenticaci√≥n](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* verbo `impersonate` en `users`, `groups` y `serviceaccounts` en el grupo de API principal, y el `userextras` en el grupo de API `authentication.k8s.io`.

{% hint style="warning" %}
Puedes encontrar **todos los verbos que cada recurso soporta** ejecutando `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Ejemplos

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Por ejemplo, puedes usar un **ClusterRole** para permitir que un usuario en particular ejecute:
```
kubectl get pods --all-namespaces
```
### **RoleBinding y ClusterRoleBinding**

[**De la documentaci√≥n:**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding) Un **role binding otorga los permisos definidos en un rol a un usuario o conjunto de usuarios**. Contiene una lista de sujetos (usuarios, grupos o cuentas de servicio) y una referencia al rol que se est√° otorgando. Un **RoleBinding** otorga permisos dentro de un **namespace** espec√≠fico, mientras que un **ClusterRoleBinding** otorga ese acceso **a nivel de cl√∫ster**.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Los permisos son aditivos** as√≠ que si tienes un clusterRole con ‚Äúlist‚Äù y ‚Äúdelete‚Äù secretos, puedes agregarlo con un Role con ‚Äúget‚Äù. As√≠ que ten cuidado y prueba siempre tus roles y permisos y **especifica lo que est√° PERMITIDO, porque todo est√° DENEGADO por defecto.**

## **Enumerando RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Abuso de Roles/ClusterRoles para Escalaci√≥n de Privilegios

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
