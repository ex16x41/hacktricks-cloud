# Kubernetes Rolgebaseerde Toegangbeheer (RBAC)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Opleiding AWS Rooi Span Ekspert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Rooi Span Ekspert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Rolgebaseerde Toegangbeheer (RBAC)

Kubernetes het 'n **autorisatiemodule genaamd Rolgebaseerde Toegangbeheer** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) wat help om gebruiksregte aan die API-bediener toe te ken.

RBAC se toestemmingsmodel is gebou uit **drie individuele dele**:

1. **Rol\ClusterRol ‚Äì** Die werklike toestemming. Dit bevat _**re√´ls**_ wat 'n stel toestemmings verteenwoordig. Elke re√´l bevat [hulpbronne](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) en [werkwoorde](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Die werkwoord is die aksie wat op die hulpbron toegepas sal word.
2. **Onderwerp (Gebruiker, Groep of Diensrekening) ‚Äì** Die objek wat die toestemmings sal ontvang.
3. **Rolbinding\ClusterRolbinding ‚Äì** Die verbinding tussen Rol\ClusterRol en die onderwerp.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

Die verskil tussen ‚Äú**Rolle**‚Äù en ‚Äú**ClusterRolle**‚Äù is net waar die rol toegepas sal word ‚Äì 'n ‚Äú**Rol**‚Äù sal toegang tot slegs **een** **spesifieke** **naamruimte** verleen, terwyl 'n ‚Äú**ClusterRol**‚Äù in **alle naamruimtes** in die kluster gebruik kan word. Boonop kan **ClusterRolle** ook toegang verleen tot:

* **kluster-geskepte** hulpbronne (soos knope).
* **nie-hulpbron** eindpunte (soos /healthz).
* naamruimte hulpbronne (soos Pods), **oor alle naamruimtes**.

Vanaf **Kubernetes** 1.6 en verder, is **RBAC** beleide **standaard geaktiveer**. Maar om RBAC te aktiveer kan jy iets soos gebruik:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Templates

In die sjabloon van 'n **Rol** of 'n **ClusterRol** moet jy die **naam van die rol**, die **naamruimte** (in rolle) en dan die **apiGroups**, **hulpbronne** en **werkwoorde** van die rol aandui:

* Die **apiGroups** is 'n reeks wat die verskillende **API naamruimtes** bevat waartoe hierdie re√´l van toepassing is. Byvoorbeeld, 'n Pod-definisie gebruik apiVersion: v1. _Dit kan waardes h√™ soos rbac.authorization.k8s.io of \[\*]_.
* Die **hulpbronne** is 'n reeks wat definieer **watter hulpbronne hierdie re√´l van toepassing is**. Jy kan al die hulpbronne vind met: `kubectl api-resources --namespaced=true`
* Die **werkwoorde** is 'n reeks wat die **toegelate werkwoorde** bevat. Die werkwoord in Kubernetes definieer die **soort aksie** wat jy op die hulpbron moet toepas. Byvoorbeeld, die lys werkwoord word teen versamelings gebruik terwyl "get" teen 'n enkele hulpbron gebruik word.

### Rules Verbs

(_Hierdie inligting is geneem van_ [_**the docs**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| HTTP werkwoord | versoek werkwoord                                                                                                                                                  |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| POST           | skep                                                                                                                                                               |
| GET, HEAD      | kry (vir individuele hulpbronne), lys (vir versamelings, insluitend volle objekinhoud), kyk (vir die kyk na 'n individuele hulpbron of versameling hulpbronne) |
| PUT            | opdateer                                                                                                                                                           |
| PATCH          | patch                                                                                                                                                              |
| DELETE         | verwyder (vir individuele hulpbronne), verwyderversameling (vir versamelings)                                                                                     |

Kubernetes kontroleer soms magtiging vir addisionele toestemmings met behulp van gespesialiseerde werkwoorde. Byvoorbeeld:

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* `use` werkwoord op `podsecuritypolicies` hulpbronne in die `policy` API-groep.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* `bind` en `escalate` werkwoorde op `roles` en `clusterroles` hulpbronne in die `rbac.authorization.k8s.io` API-groep.
* [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* `impersonate` werkwoord op `users`, `groups`, en `serviceaccounts` in die kern API-groep, en die `userextras` in die `authentication.k8s.io` API-groep.

{% hint style="warning" %}
Jy kan **alle werkwoorde wat elke hulpbron ondersteun** vind deur `kubectl api-resources --sort-by name -o wide` uit te voer
{% endhint %}

### Examples

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Byvoorbeeld kan jy 'n **ClusterRole** gebruik om 'n spesifieke gebruiker toe te laat om te loop:
```
kubectl get pods --all-namespaces
```
### **RoleBinding en ClusterRoleBinding**

[**Uit die dokumentasie:**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding) 'n **rolbinding gee die toestemmings wat in 'n rol gedefinieer is aan 'n gebruiker of stel gebruikers**. Dit hou 'n lys van subjekte (gebruikers, groepe of diensrekeninge), en 'n verwysing na die rol wat toegeken word. 'n **RoleBinding** gee toestemmings binne 'n spesifieke **namespace** terwyl 'n **ClusterRoleBinding** daardie toegang **kluster-wyd** gee.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Toestemmings is additief** so as jy 'n clusterRole het met ‚Äúlys‚Äù en ‚Äúverwyder‚Äù geheime kan jy dit byvoeg met 'n Role met ‚Äúkry‚Äù. Wees dus bewus en toets altyd jou rolle en toestemmings en **specifiseer wat TOEGESTAAN is, want alles is standaard VERWEERD.**

## **Opname van RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Misbruik Rol/ClusterRoles vir Privilege Escalation

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
