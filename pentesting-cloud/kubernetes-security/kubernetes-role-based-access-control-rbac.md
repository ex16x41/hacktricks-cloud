# Kubernetes Role-Based Access Control(RBAC)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Role-Based Access Control (RBAC)

Kubernetes'in **API sunucusuna kullanÄ±m izinleri ayarlamaya yardÄ±mcÄ± olan Role-Based Access Control** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) adÄ±nda bir **yetkilendirme modÃ¼lÃ¼** vardÄ±r.

RBAC'nin izin modeli **Ã¼Ã§ ayrÄ± bÃ¶lÃ¼mden** oluÅŸmaktadÄ±r:

1. **Role\ClusterRole Â­â€“** GerÃ§ek izin. Bir dizi izni temsil eden _**kurallar**_ iÃ§erir. Her kural, [kaynaklar](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) ve [fiiller](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb) iÃ§erir. Fiil, kaynaÄŸa uygulanacak eylemdir.
2. **Subject (KullanÄ±cÄ±, Grup veya ServiceAccount) â€“** Ä°zinleri alacak nesne.
3. **RoleBinding\ClusterRoleBinding â€“** Role\ClusterRole ile konu arasÄ±ndaki baÄŸlantÄ±.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding_serviceaccount_and_role-1024x551.png)

â€œ**Roles**â€ ile â€œ**ClusterRoles**â€ arasÄ±ndaki fark, rolÃ¼n nerede uygulanacaÄŸÄ±dÄ±r â€“ bir â€œ**Role**â€ yalnÄ±zca **bir** **belirli** **namespace** iÃ§in eriÅŸim verirken, bir â€œ**ClusterRole**â€ **tÃ¼m namespace'lerde** kullanÄ±labilir. AyrÄ±ca, **ClusterRoles** ÅŸunlara eriÅŸim de verebilir:

* **kÃ¼me kapsamlÄ±** kaynaklar (Ã¶rneÄŸin dÃ¼ÄŸÃ¼mler).
* **kaynak dÄ±ÅŸÄ±** uÃ§ noktalar (Ã¶rneÄŸin /healthz).
* **tÃ¼m namespace'lerde** namespaced kaynaklar (Ã¶rneÄŸin Pod'lar).

**Kubernetes** 1.6'dan itibaren, **RBAC** politikalarÄ± **varsayÄ±lan olarak etkin** durumdadÄ±r. Ancak RBAC'yi etkinleÅŸtirmek iÃ§in ÅŸunu kullanabilirsiniz:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Åablonlar

Bir **Rol** veya **ClusterRole** ÅŸablonunda **rolÃ¼n adÄ±nÄ±**, **namespace**'i (rollerde) ve ardÄ±ndan rolÃ¼n **apiGroups**, **resources** ve **verbs**'lerini belirtmeniz gerekecek:

* **apiGroups**, bu kuralÄ±n uygulandÄ±ÄŸÄ± farklÄ± **API namespace'lerini** iÃ§eren bir dizidir. Ã–rneÄŸin, bir Pod tanÄ±mÄ± apiVersion: v1 kullanÄ±r. _rbac.authorization.k8s.io veya \[\*] gibi deÄŸerler alabilir_.
* **resources**, bu kuralÄ±n uygulandÄ±ÄŸÄ± **kaynaklarÄ± tanÄ±mlayan** bir dizidir. TÃ¼m kaynaklarÄ± ÅŸu komutla bulabilirsiniz: `kubectl api-resources --namespaced=true`
* **verbs**, **izin verilen fiilleri** iÃ§eren bir dizidir. Kubernetes'teki fiil, kaynaÄŸa uygulamanÄ±z gereken **hareket tÃ¼rÃ¼nÃ¼** tanÄ±mlar. Ã–rneÄŸin, liste fiili koleksiyonlar iÃ§in kullanÄ±lÄ±rken "get" tek bir kaynak iÃ§in kullanÄ±lÄ±r.

### Kurallar Fiilleri

(_Bu bilgi_ [_**belgelerden**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb) _alÄ±nmÄ±ÅŸtÄ±r_)

| HTTP fiili | istek fiili                                                                                                                                                  |
| ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | oluÅŸtur                                                                                              |
| GET, HEAD  | al (bireysel kaynaklar iÃ§in), listele (koleksiyonlar iÃ§in, tam nesne iÃ§eriÄŸi dahil), izle (bireysel bir kaynak veya kaynak koleksiyonunu izlemek iÃ§in) |
| PUT        | gÃ¼ncelle                                                                                             |
| PATCH      | yaman                                                                                               |
| DELETE     | sil (bireysel kaynaklar iÃ§in), koleksiyonsil (koleksiyonlar iÃ§in)                                                                                       |

Kubernetes bazen Ã¶zel fiiller kullanarak ek izinler iÃ§in yetkilendirmeyi kontrol eder. Ã–rneÄŸin:

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* `policy` API grubundaki `podsecuritypolicies` kaynaklarÄ±nda `use` fiili.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* `rbac.authorization.k8s.io` API grubundaki `roles` ve `clusterroles` kaynaklarÄ±nda `bind` ve `escalate` fiilleri.
* [Kimlik DoÄŸrulama](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* Temel API grubundaki `users`, `groups` ve `serviceaccounts` Ã¼zerinde `impersonate` fiili, ve `authentication.k8s.io` API grubundaki `userextras`.

{% hint style="warning" %}
Her kaynaÄŸÄ±n desteklediÄŸi **tÃ¼m fiilleri** bulmak iÃ§in `kubectl api-resources --sort-by name -o wide` komutunu Ã§alÄ±ÅŸtÄ±rabilirsiniz.
{% endhint %}

### Ã–rnekler

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Ã–rneÄŸin, belirli bir kullanÄ±cÄ±nÄ±n Ã§alÄ±ÅŸtÄ±rmasÄ±na izin vermek iÃ§in bir **ClusterRole** kullanabilirsiniz:
```
kubectl get pods --all-namespaces
```
### **RoleBinding ve ClusterRoleBinding**

[**Belgelerden:**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding) Bir **rol baÄŸlamasÄ±, bir rolde tanÄ±mlanan izinleri bir kullanÄ±cÄ±ya veya kullanÄ±cÄ± grubuna verir**. KullanÄ±cÄ±lar, gruplar veya hizmet hesaplarÄ± gibi bir konu listesi ve verilen role bir referans iÃ§erir. Bir **RoleBinding**, belirli bir **namespace** iÃ§inde izinler verirken, bir **ClusterRoleBinding** bu eriÅŸimi **kÃ¼me genelinde** saÄŸlar.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Ä°zinler toplamsaldÄ±r** bu nedenle â€œlisteleâ€ ve â€œsilâ€ gizliliklerine sahip bir clusterRole'Ã¼nÃ¼z varsa, bunu â€œalâ€ ile bir Role ile ekleyebilirsiniz. Bu yÃ¼zden her zaman rollerinizi ve izinlerinizi test edin ve **Ä°ZÄ°N VERÄ°LENÄ° belirtin, Ã§Ã¼nkÃ¼ varsayÄ±lan olarak her ÅŸey REDDEDÄ°LÄ°R.**

## **RBAC'Ä± Sayma**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Abuse Role/ClusterRoles for Privilege Escalation

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
