# Pentesting Kubernetes Services

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

Kubernetes, **bir podu ele geçirdiğinizde** **İnternete açık** veya **iç ağda** bulabileceğiniz birkaç **özel ağ hizmeti** kullanır.

## Açık podları OSINT ile bulma

Bir yol, kubernetes ile ilgili alt alanları bulmak için [crt.sh](https://crt.sh) üzerinde `Identity LIKE "k8s.%.com"` araması yapmaktır. Diğer bir yol ise github'da `"k8s.%.com"` araması yaparak **YAML dosyalarını** içeren stringleri aramaktır.

## Kubernetes'in Hizmetleri Nasıl Açtığı

Kubernetes'in hizmetleri **kamusal olarak nasıl açabileceğini** anlamak sizin için faydalı olabilir:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Port taraması ile Açık podları Bulma

Aşağıdaki portlar bir Kubernetes kümesinde açık olabilir:

| Port            | Süreç         | Açıklama                                                              |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API port                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Konteyner metrikleri                                                  |
| 6443/TCP        | kube-apiserver | Kubernetes API port                                                    |
| 8443/TCP        | kube-apiserver | Minikube API port                                                      |
| 8080/TCP        | kube-apiserver | Güvensiz API port                                                      |
| 10250/TCP       | kubelet        | Tam mod erişimine izin veren HTTPS API                                 |
| 10255/TCP       | kubelet        | Kimlik doğrulaması yapılmamış salt okunur HTTP portu: podlar, çalışan podlar ve düğüm durumu |
| 10256/TCP       | kube-proxy     | Kube Proxy sağlık kontrol sunucusu                                     |
| 9099/TCP        | calico-felix   | Calico için sağlık kontrol sunucusu                                   |
| 6782-4/TCP      | weave          | Metrikler ve uç noktalar                                              |
| 30000-32767/TCP | NodePort       | Hizmetlere proxy                                                      |
| 44134/TCP       | Tiller         | Helm hizmeti dinliyor                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Bu, yöneticilerin genellikle **`kubectl`** aracını kullanarak iletişim kurduğu **API Kubernetes servisi**dir.

**Yaygın portlar: 6443 ve 443**, ayrıca minikube'da 8443 ve güvensiz olarak 8080.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Hassas verileri elde etme ve bu hizmetle konuşarak hassas eylemler gerçekleştirme hakkında bilgi almak için aşağıdaki sayfayı kontrol edin:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Bu hizmet **kümenin her düğümünde çalışır**. **Düğüm** içindeki pod'ları **kontrol eden** hizmettir. **kube-apiserver** ile iletişim kurar.

Bu hizmetin açık olduğunu bulursanız, **kimlik doğrulaması yapılmamış RCE** bulmuş olabilirsiniz.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Eğer yanıt `Unauthorized` ise, kimlik doğrulama gerektirir.

Eğer düğümleri listeleyebiliyorsanız, kubelet uç noktalarının bir listesini şu şekilde alabilirsiniz:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Sadece okunur)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
Bu hizmeti Kubernetes içinde yetki yükseltmek için kötüye kullanabilirsiniz:

### cAdvisor

Metrikleri toplamak için yararlı bir hizmet.
```
curl -k https://<IP Address>:4194
```
### NodePort

Bir port **NodePort** aracılığıyla tüm düğümlerde açıldığında, aynı port tüm düğümlerde açılır ve trafiği belirtilen **Service**'e yönlendirir. Varsayılan olarak bu port **30000-32767** aralığında olacaktır. Bu nedenle, yeni kontrol edilmemiş hizmetler bu portlar üzerinden erişilebilir olabilir.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Güvenlik Açığı Olan Yanlış Yapılandırmalar

### Kube-apiserver Anonim Erişimi

**kube-apiserver API uç noktalarına anonim erişim izin verilmez**. Ancak bazı uç noktaları kontrol edebilirsiniz:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **ETCD Anonim Erişimini Kontrol Etme**

ETCD, küme gizli anahtarlarını, yapılandırma dosyalarını ve daha fazla **hassas veriyi** saklar. **Varsayılan olarak**, ETCD **anonim olarak** erişilemez, ancak kontrol etmek her zaman iyidir.

Eğer ETCD anonim olarak erişilebiliyorsa, **şu aracı kullanmanız** gerekebilir: [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). Aşağıdaki komut, saklanan tüm anahtarları alacaktır:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

The [**Kubelet belgeleri**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) **varsayılan olarak anonim erişime** hizmete **izin verildiğini** açıklar:

> Kubelet sunucusuna anonim istekleri etkinleştirir. Başka bir kimlik doğrulama yöntemi tarafından reddedilmeyen istekler anonim istekler olarak kabul edilir. Anonim isteklerin kullanıcı adı `system:anonymous` ve grup adı `system:unauthenticated`'dır.

**Kubelet API'sinin kimlik doğrulama ve yetkilendirme** işleminin nasıl çalıştığını daha iyi anlamak için bu sayfayı kontrol edin:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** hizmetinin **API'si belgelenmemiştir**, ancak kaynak kodu burada bulunabilir ve maruz kalan uç noktaları bulmak **çalıştırmak** kadar kolaydır:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Hepsi ilginç görünüyor.

Kubeletler ve onların uç noktaları ile etkileşimde bulunmak için [**Kubeletctl**](https://github.com/cyberark/kubeletctl) aracını kullanabilirsiniz.

#### /pods

Bu uç nokta pod'ları ve onların konteynerlerini listeler:
```bash
kubeletctl pods
```
#### /exec

Bu uç nokta, herhangi bir konteyner içinde kodu çok kolay bir şekilde çalıştırmaya olanak tanır:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Bu saldırıyı önlemek için _**kubelet**_ servisi `--anonymous-auth false` ile çalıştırılmalı ve servis ağ düzeyinde ayrılmalıdır.
{% endhint %}

### **Kubelet (Sadece Okuma Portu) Bilgi Açığının Kontrolü**

Bir **kubelet sadece okuma portu** açıldığında, yetkisiz taraflar tarafından API'den bilgi alınması mümkün hale gelir. Bu portun açılması, çeşitli **küme yapılandırma unsurlarının** ifşasına yol açabilir. **Pod adları, iç dosyaların konumları ve diğer yapılandırmalar** gibi bilgiler kritik olmasa da, açığa çıkması yine de bir güvenlik riski oluşturur ve kaçınılmalıdır.

Bu zafiyetin nasıl istismar edilebileceğine dair bir örnek, uzaktan bir saldırganın belirli bir URL'ye erişim sağlamasıdır. `http://<external-IP>:10255/pods` adresine giderek, saldırgan kubelet'ten hassas bilgileri potansiyel olarak alabilir:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referanslar

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
