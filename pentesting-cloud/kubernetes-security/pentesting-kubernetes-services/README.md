# Pentesting Kubernetes Services

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

KubernetesëŠ” **ì¸í„°ë„·ì— ë…¸ì¶œë˜ê±°ë‚˜** **í•˜ë‚˜ì˜ í¬ë“œë¥¼ ì¹¨í•´í•œ í›„ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ì„œ** ë°œê²¬í•  ìˆ˜ ìˆëŠ” ì—¬ëŸ¬ **íŠ¹ì • ë„¤íŠ¸ì›Œí¬ ì„œë¹„ìŠ¤**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

## OSINTë¥¼ í†µí•œ ë…¸ì¶œëœ í¬ë“œ ì°¾ê¸°

í•œ ê°€ì§€ ë°©ë²•ì€ [crt.sh](https://crt.sh)ì—ì„œ `Identity LIKE "k8s.%.com"`ì„ ê²€ìƒ‰í•˜ì—¬ kubernetesì™€ ê´€ë ¨ëœ ì„œë¸Œë„ë©”ì¸ì„ ì°¾ëŠ” ê²ƒì…ë‹ˆë‹¤. ë˜ ë‹¤ë¥¸ ë°©ë²•ì€ githubì—ì„œ `"k8s.%.com"`ì„ ê²€ìƒ‰í•˜ê³  í•´ë‹¹ ë¬¸ìì—´ì„ í¬í•¨í•˜ëŠ” **YAML íŒŒì¼**ì„ ì°¾ëŠ” ê²ƒì…ë‹ˆë‹¤.

## Kubernetesê°€ ì„œë¹„ìŠ¤ë¥¼ ë…¸ì¶œí•˜ëŠ” ë°©ë²•

Kubernetesê°€ **ì„œë¹„ìŠ¤ë¥¼ ê³µê°œì ìœ¼ë¡œ ë…¸ì¶œí•  ìˆ˜ ìˆëŠ” ë°©ë²•**ì„ ì´í•´í•˜ëŠ” ê²ƒì´ ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## í¬íŠ¸ ìŠ¤ìºë‹ì„ í†µí•œ ë…¸ì¶œëœ í¬ë“œ ì°¾ê¸°

ë‹¤ìŒ í¬íŠ¸ëŠ” Kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ ì—´ë ¤ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

| Port            | Process        | Description                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API port                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Container metrics                                                      |
| 6443/TCP        | kube-apiserver | Kubernetes API port                                                    |
| 8443/TCP        | kube-apiserver | Minikube API port                                                      |
| 8080/TCP        | kube-apiserver | Insecure API port                                                      |
| 10250/TCP       | kubelet        | HTTPS API which allows full mode access                                |
| 10255/TCP       | kubelet        | Unauthenticated read-only HTTP port: pods, running pods and node state |
| 10256/TCP       | kube-proxy     | Kube Proxy health check server                                         |
| 9099/TCP        | calico-felix   | Health check server for Calico                                         |
| 6782-4/TCP      | weave          | Metrics and endpoints                                                  |
| 30000-32767/TCP | NodePort       | Proxy to the services                                                  |
| 44134/TCP       | Tiller         | Helm service listening                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

ì´ê²ƒì€ ê´€ë¦¬ìê°€ ì¼ë°˜ì ìœ¼ë¡œ **`kubectl`** ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ í†µì‹ í•˜ëŠ” **API Kubernetes ì„œë¹„ìŠ¤**ì…ë‹ˆë‹¤.

**ì¼ë°˜ í¬íŠ¸: 6443 ë° 443**, í•˜ì§€ë§Œ minikubeì—ì„œëŠ” 8443, ë¹„ë³´ì•ˆìœ¼ë¡œëŠ” 8080ë„ ìˆìŠµë‹ˆë‹¤.
```bash
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì—¬ ì´ ì„œë¹„ìŠ¤ì™€ ëŒ€í™”í•˜ì—¬ ë¯¼ê°í•œ ë°ì´í„°ë¥¼ ì–»ê³  ë¯¼ê°í•œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì„¸ìš”:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

ì´ ì„œë¹„ìŠ¤ëŠ” **í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ë…¸ë“œì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤**. ì´ ì„œë¹„ìŠ¤ëŠ” **ë…¸ë“œ** ë‚´ì˜ íŒŒë“œë¥¼ **ì œì–´**í•©ë‹ˆë‹¤. **kube-apiserver**ì™€ í†µì‹ í•©ë‹ˆë‹¤.

ì´ ì„œë¹„ìŠ¤ê°€ ë…¸ì¶œëœ ê²½ìš° **ì¸ì¦ë˜ì§€ ì•Šì€ RCE**ë¥¼ ë°œê²¬í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### Kubelet API
```bash
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
If the response is `Unauthorized` then it requires authentication.

ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.

If you can list nodes you can get a list of kubelets endpoints with:

ë…¸ë“œë¥¼ ë‚˜ì—´í•  ìˆ˜ ìˆë‹¤ë©´, ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ kubelets ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (ì½ê¸° ì „ìš©)
```bash
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```bash
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```bash
helm --host tiller-deploy.kube-system:44134 version
```
You could abuse this service to escalate privileges inside Kubernetes:

### cAdvisor

ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ëŠ” ë° ìœ ìš©í•œ ì„œë¹„ìŠ¤.
```bash
curl -k https://<IP Address>:4194
```
### NodePort

ëª¨ë“  ë…¸ë“œì—ì„œ **NodePort**ë¥¼ í†µí•´ í¬íŠ¸ê°€ ë…¸ì¶œë˜ë©´, ë™ì¼í•œ í¬íŠ¸ê°€ ëª¨ë“  ë…¸ë“œì—ì„œ ì—´ë¦¬ë©° ì„ ì–¸ëœ **Service**ë¡œ íŠ¸ë˜í”½ì„ í”„ë¡ì‹œí•©ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ì´ í¬íŠ¸ëŠ” **30000-32767** ë²”ìœ„ì— ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ìƒˆë¡œìš´ í™•ì¸ë˜ì§€ ì•Šì€ ì„œë¹„ìŠ¤ëŠ” ì´ëŸ¬í•œ í¬íŠ¸ë¥¼ í†µí•´ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
sudo nmap -sS -p 30000-32767 <IP>
```
## ì·¨ì•½í•œ ì˜ëª»ëœ êµ¬ì„±

### Kube-apiserver ìµëª… ì ‘ê·¼

ìµëª… ì ‘ê·¼ì€ **kube-apiserver API ì—”ë“œí¬ì¸íŠ¸ì— í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. ê·¸ëŸ¬ë‚˜ ì¼ë¶€ ì—”ë“œí¬ì¸íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **ETCD ìµëª… ì ‘ê·¼ í™•ì¸**

ETCDëŠ” í´ëŸ¬ìŠ¤í„° ë¹„ë°€, êµ¬ì„± íŒŒì¼ ë° ê¸°íƒ€ **ë¯¼ê°í•œ ë°ì´í„°**ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. **ê¸°ë³¸ì ìœ¼ë¡œ** ETCDëŠ” **ìµëª…ìœ¼ë¡œ** ì ‘ê·¼í•  ìˆ˜ **ì—†ì§€ë§Œ**, í•­ìƒ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

ETCDì— ìµëª…ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤ë©´, **[**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **ë„êµ¬ë¥¼ ì‚¬ìš©í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì–´ëŠ” ì €ì¥ëœ ëª¨ë“  í‚¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤:
```bash
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

The [**Kubelet documentation**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) ì„¤ëª…í•©ë‹ˆë‹¤ ê¸°ë³¸ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ìµëª… ì•¡ì„¸ìŠ¤ê°€ í—ˆìš©ë©ë‹ˆë‹¤:

> Kubelet ì„œë²„ì— ëŒ€í•œ ìµëª… ìš”ì²­ì„ í™œì„±í™”í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ì¸ì¦ ë°©ë²•ì— ì˜í•´ ê±°ë¶€ë˜ì§€ ì•ŠëŠ” ìš”ì²­ì€ ìµëª… ìš”ì²­ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤. ìµëª… ìš”ì²­ì€ `system:anonymous`ë¼ëŠ” ì‚¬ìš©ì ì´ë¦„ê³¼ `system:unauthenticated`ë¼ëŠ” ê·¸ë£¹ ì´ë¦„ì„ ê°€ì§‘ë‹ˆë‹¤.

**Kubelet APIì˜ ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ê°€ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€** ë” ì˜ ì´í•´í•˜ë ¤ë©´ ì´ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** ì„œë¹„ìŠ¤ **APIëŠ” ë¬¸ì„œí™”ë˜ì–´ ìˆì§€ ì•Šì§€ë§Œ**, ì†ŒìŠ¤ ì½”ë“œëŠ” ì—¬ê¸°ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©° ë…¸ì¶œëœ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ëŠ” ê²ƒì€ **ì‹¤í–‰í•˜ëŠ” ê²ƒë§Œí¼ ì‰½ìŠµë‹ˆë‹¤**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
ëª¨ë‘ í¥ë¯¸ë¡­ê²Œ ë“¤ë¦½ë‹ˆë‹¤.

[Kubeletctl](https://github.com/cyberark/kubeletctl) ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ Kubelet ë° í•´ë‹¹ ì—”ë“œí¬ì¸íŠ¸ì™€ ìƒí˜¸ì‘ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### /pods

ì´ ì—”ë“œí¬ì¸íŠ¸ëŠ” íŒŒë“œì™€ ê·¸ ì»¨í…Œì´ë„ˆë¥¼ ë‚˜ì—´í•©ë‹ˆë‹¤:
```bash
kubeletctl pods
```
#### /exec

ì´ ì—”ë“œí¬ì¸íŠ¸ëŠ” ëª¨ë“  ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì½”ë“œë¥¼ ë§¤ìš° ì‰½ê²Œ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
ì´ ê³µê²©ì„ í”¼í•˜ê¸° ìœ„í•´ _**kubelet**_ ì„œë¹„ìŠ¤ëŠ” `--anonymous-auth false`ë¡œ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ë©°, ì„œë¹„ìŠ¤ëŠ” ë„¤íŠ¸ì›Œí¬ ìˆ˜ì¤€ì—ì„œ ë¶„ë¦¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}

### **Kubelet (ì½ê¸° ì „ìš© í¬íŠ¸) ì •ë³´ ë…¸ì¶œ í™•ì¸**

**kubelet ì½ê¸° ì „ìš© í¬íŠ¸**ê°€ ë…¸ì¶œë˜ë©´, ë¬´ë‹¨ ë‹¹ì‚¬ìê°€ APIì—ì„œ ì •ë³´ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤. ì´ í¬íŠ¸ì˜ ë…¸ì¶œì€ ë‹¤ì–‘í•œ **í´ëŸ¬ìŠ¤í„° êµ¬ì„± ìš”ì†Œ**ì˜ ê³µê°œë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. **í¬ë“œ ì´ë¦„, ë‚´ë¶€ íŒŒì¼ì˜ ìœ„ì¹˜ ë° ê¸°íƒ€ êµ¬ì„±**ì„ í¬í•¨í•œ ì •ë³´ëŠ” ì¤‘ìš”í•˜ì§€ ì•Šì„ ìˆ˜ ìˆì§€ë§Œ, ê·¸ ë…¸ì¶œì€ ì—¬ì „íˆ ë³´ì•ˆ ìœ„í—˜ì„ ì´ˆë˜í•˜ë©° í”¼í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ ì·¨ì•½ì ì´ ì–´ë–»ê²Œ ì•…ìš©ë  ìˆ˜ ìˆëŠ”ì§€ì— ëŒ€í•œ ì˜ˆëŠ” ì›ê²© ê³µê²©ìê°€ íŠ¹ì • URLì— ì ‘ê·¼í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. `http://<external-IP>:10255/pods`ë¡œ ì´ë™í•¨ìœ¼ë¡œì¨ ê³µê²©ìëŠ” kubeletì—ì„œ ë¯¼ê°í•œ ì •ë³´ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## References

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
