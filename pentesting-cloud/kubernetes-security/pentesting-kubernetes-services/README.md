# Pentesting Kubernetes Services

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Kubernetes koristi nekoliko **specifi캜nih mre쬹ih usluga** koje mo쬰te prona캖i **izlo쬰ne internetu** ili u **internoj mre쬴 kada kompromitujete jedan pod**.

## Finding exposed pods with OSINT

Jedan na캜in mo쬰 biti pretraga za `Identity LIKE "k8s.%.com"` na [crt.sh](https://crt.sh) kako biste prona코li poddomene povezane sa kubernetesom. Drugi na캜in mo쬰 biti pretraga `"k8s.%.com"` na github-u i pretraga za **YAML datotekama** koje sadr쬰 ovu string.

## How Kubernetes Exposes Services

Mo쬰 biti korisno da razumete kako Kubernetes mo쬰 **izlo쬴ti usluge javno** kako biste ih prona코li:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Finding Exposed pods via port scanning

Slede캖i portovi mogu biti otvoreni u Kubernetes klasteru:

| Port            | Process        | Description                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API port                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Metrika kontejnera                                                    |
| 6443/TCP        | kube-apiserver | Kubernetes API port                                                    |
| 8443/TCP        | kube-apiserver | Minikube API port                                                      |
| 8080/TCP        | kube-apiserver | Nesiguran API port                                                    |
| 10250/TCP       | kubelet        | HTTPS API koji omogu캖ava pristup u punom re쬴mu                       |
| 10255/TCP       | kubelet        | Neautentifikovani samo za 캜itanje HTTP port: podovi, aktivni podovi i stanje 캜vora |
| 10256/TCP       | kube-proxy     | Kube Proxy server za proveru zdravlja                                 |
| 9099/TCP        | calico-felix   | Server za proveru zdravlja za Calico                                  |
| 6782-4/TCP      | weave          | Metrike i krajnje ta캜ke                                              |
| 30000-32767/TCP | NodePort       | Proxy za usluge                                                      |
| 44134/TCP       | Tiller         | Helm usluga koja slu코a                                              |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Ovo je **API Kubernetes usluga** sa kojom administratori obi캜no komuniciraju koriste캖i alat **`kubectl`**.

**Uobi캜ajeni portovi: 6443 i 443**, ali tako캠e 8443 u minikube i 8080 kao nesiguran.
```bash
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Proverite slede캖u stranicu da biste saznali kako da dobijete osetljive podatke i izvr코ite osetljive radnje razgovaraju캖i sa ovom uslugom:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Ova usluga **radi na svakoj 캜voru klastera**. To je usluga koja 캖e **kontrolisati** podove unutar **캜vora**. Razgovara sa **kube-apiserver**.

Ako prona캠ete ovu uslugu izlo쬰nu, mo쬯a ste prona코li **neautentifikovani RCE**.

#### Kubelet API
```bash
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Ako je odgovor `Unauthorized`, to zahteva autentifikaciju.

Ako mo쬰te da nabrojite 캜vorove, mo쬰te dobiti listu kubelet krajnjih ta캜aka sa:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Samo za 캜itanje)
```bash
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```bash
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```bash
helm --host tiller-deploy.kube-system:44134 version
```
Mo쬰te zloupotrebiti ovu uslugu da eskalirate privilegije unutar Kubernetes-a:

### cAdvisor

Usluga korisna za prikupljanje metrika.
```bash
curl -k https://<IP Address>:4194
```
### NodePort

Kada je port izlo쬰n na svim 캜vorovima putem **NodePort**, isti port je otvoren na svim 캜vorovima proksifikuju캖i saobra캖aj u deklarisanu **Service**. Po defaultu, ovaj port 캖e biti u **opsegu 30000-32767**. Tako da nove neproverene usluge mogu biti dostupne putem tih portova.
```bash
sudo nmap -sS -p 30000-32767 <IP>
```
## Ranljive Konfiguracije

### Kube-apiserver Anonimni Pristup

Anonimni pristup **kube-apiserver API** krajnjim ta캜kama nije dozvoljen. Ali mo쬰te proveriti neke krajnje ta캜ke:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Proveravanje ETCD Anonimnog Pristupa**

ETCD 캜uva tajne klastera, konfiguracione datoteke i vi코e **osetljivih podataka**. Po **definiciji**, ETCD **ne mo쬰** biti pristupljen **anonimno**, ali uvek je dobro proveriti.

Ako se ETCD mo쬰 pristupiti anonimno, mo쬯a 캖ete morati da **koristite** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **alat**. Slede캖a komanda 캖e dobiti sve klju캜eve koji su sa캜uvani:
```bash
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

The [**Kubelet documentation**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) obja코njava da je **podrazumevano anonimni pristup** usluzi **dozvoljen:**

> Omogu캖ava anonimne zahteve serveru Kubelet. Zahtevi koji nisu odbijeni od strane druge metode autentifikacije tretiraju se kao anonimni zahtevi. Anonimni zahtevi imaju korisni캜ko ime `system:anonymous`, i naziv grupe `system:unauthenticated`

Da biste bolje razumeli kako **funkcioni코e autentifikacija i autorizacija Kubelet API-ja**, pogledajte ovu stranicu:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** usluga **API nije dokumentovana**, ali izvorni kod se mo쬰 prona캖i ovde, a pronala쬰nje izlo쬰nih krajnjih ta캜aka je lako kao **pokretanje**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Svi zvu캜e zanimljivo.

Mo쬰te koristiti alat [**Kubeletctl**](https://github.com/cyberark/kubeletctl) za interakciju sa Kubelet-ima i njihovim krajnjim ta캜kama.

#### /pods

Ova krajnja ta캜ka navodi podove i njihove kontejnere:
```bash
kubeletctl pods
```
#### /exec

Ova ta캜ka omogu캖ava lako izvr코avanje koda unutar bilo kog kontejnera:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Da bi se izbegao ovaj napad, _**kubelet**_ servis treba da se pokre캖e sa `--anonymous-auth false` i servis treba da bude segregiran na mre쬹om nivou.
{% endhint %}

### **Proveravanje izlaganja informacija Kubelet-a (samo za 캜itanje)**

Kada je **kubelet port za 캜itanje** izlo쬰n, postaje mogu캖e da neovla코캖ene strane dobiju informacije iz API-ja. Izlaganje ovog porta mo쬰 dovesti do otkrivanja razli캜itih **elemenata konfiguracije klastera**. Iako informacije, uklju캜uju캖i **imena podova, lokacije internih fajlova i druge konfiguracije**, mo쬯a nisu kriti캜ne, njihovo izlaganje i dalje predstavlja bezbednosni rizik i treba ga izbegavati.

Primer kako se ova ranjivost mo쬰 iskoristiti uklju캜uje udaljenog napada캜a koji pristupa odre캠enom URL-u. Navigacijom do `http://<external-IP>:10255/pods`, napada캜 mo쬰 potencijalno dobiti osetljive informacije iz kubelet-a:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Reference

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr코ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
