# Pentesting Kubernetes Services

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

Kubernetes ä½¿ç”¨å‡ ä¸ª **ç‰¹å®šçš„ç½‘ç»œæœåŠ¡**ï¼Œä½ å¯èƒ½ä¼šå‘ç°å®ƒä»¬ **æš´éœ²åœ¨äº’è”ç½‘ä¸Š** æˆ–åœ¨ **å†…éƒ¨ç½‘ç»œä¸­ï¼Œä¸€æ—¦ä½ æ”»ç ´ä¸€ä¸ª pod**ã€‚

## ä½¿ç”¨ OSINT æŸ¥æ‰¾æš´éœ²çš„ pods

ä¸€ç§æ–¹æ³•æ˜¯åœ¨ [crt.sh](https://crt.sh) ä¸­æœç´¢ `Identity LIKE "k8s.%.com"` æ¥æŸ¥æ‰¾ä¸ Kubernetes ç›¸å…³çš„å­åŸŸåã€‚å¦ä¸€ç§æ–¹æ³•å¯èƒ½æ˜¯åœ¨ GitHub ä¸­æœç´¢ `"k8s.%.com"` å¹¶æŸ¥æ‰¾åŒ…å«è¯¥å­—ç¬¦ä¸²çš„ **YAML æ–‡ä»¶**ã€‚

## Kubernetes å¦‚ä½•æš´éœ²æœåŠ¡

äº†è§£ Kubernetes å¦‚ä½• **å…¬å¼€æš´éœ²æœåŠ¡** å¯èƒ½å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä»¥ä¾¿æ‰¾åˆ°å®ƒä»¬ï¼š

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## é€šè¿‡ç«¯å£æ‰«ææŸ¥æ‰¾æš´éœ²çš„ pods

åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œä»¥ä¸‹ç«¯å£å¯èƒ½æ˜¯å¼€æ”¾çš„ï¼š

| ç«¯å£            | è¿›ç¨‹          | æè¿°                                                                  |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API ç«¯å£                                                  |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | å®¹å™¨æŒ‡æ ‡                                                              |
| 6443/TCP        | kube-apiserver | Kubernetes API ç«¯å£                                                  |
| 8443/TCP        | kube-apiserver | Minikube API ç«¯å£                                                    |
| 8080/TCP        | kube-apiserver | ä¸å®‰å…¨çš„ API ç«¯å£                                                    |
| 10250/TCP       | kubelet        | å…è®¸å®Œå…¨æ¨¡å¼è®¿é—®çš„ HTTPS API                                         |
| 10255/TCP       | kubelet        | æœªç»èº«ä»½éªŒè¯çš„åªè¯» HTTP ç«¯å£ï¼špodsã€è¿è¡Œä¸­çš„ pods å’ŒèŠ‚ç‚¹çŠ¶æ€      |
| 10256/TCP       | kube-proxy     | Kube Proxy å¥åº·æ£€æŸ¥æœåŠ¡å™¨                                            |
| 9099/TCP        | calico-felix   | Calico çš„å¥åº·æ£€æŸ¥æœåŠ¡å™¨                                              |
| 6782-4/TCP      | weave          | æŒ‡æ ‡å’Œç«¯ç‚¹                                                          |
| 30000-32767/TCP | NodePort       | æœåŠ¡çš„ä»£ç†                                                          |
| 44134/TCP       | Tiller         | ç›‘å¬çš„ Helm æœåŠ¡                                                     |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

è¿™æ˜¯ç®¡ç†å‘˜é€šå¸¸ä½¿ç”¨å·¥å…· **`kubectl`** ä¸ä¹‹äº¤äº’çš„ **Kubernetes API æœåŠ¡**ã€‚

**å¸¸ç”¨ç«¯å£ï¼š6443 å’Œ 443**ï¼Œä½†åœ¨ minikube ä¸­ä¹Ÿæœ‰ 8443 å’Œ 8080 ä½œä¸ºä¸å®‰å…¨ç«¯å£ã€‚
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ä»¥äº†è§£å¦‚ä½•è·å–æ•æ„Ÿæ•°æ®å¹¶æ‰§è¡Œä¸æ­¤æœåŠ¡äº¤äº’çš„æ•æ„Ÿæ“ä½œï¼š**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

æ­¤æœåŠ¡**åœ¨é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ**ã€‚å®ƒæ˜¯**æ§åˆ¶**èŠ‚ç‚¹å†…**pod**çš„æœåŠ¡ã€‚å®ƒä¸**kube-apiserver**è¿›è¡Œé€šä¿¡ã€‚

å¦‚æœæ‚¨å‘ç°æ­¤æœåŠ¡æš´éœ²ï¼Œæ‚¨å¯èƒ½å‘ç°äº†**æœªè®¤è¯çš„ RCE**ã€‚

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
å¦‚æœå“åº”æ˜¯ `Unauthorized`ï¼Œåˆ™éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯ã€‚

å¦‚æœæ‚¨å¯ä»¥åˆ—å‡ºèŠ‚ç‚¹ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·å– kubelets ç«¯ç‚¹åˆ—è¡¨ï¼š
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (åªè¯»)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
æ‚¨å¯ä»¥åˆ©ç”¨æ­¤æœåŠ¡åœ¨Kuberneteså†…éƒ¨æå‡æƒé™ï¼š

### cAdvisor

ç”¨äºæ”¶é›†æŒ‡æ ‡çš„æœåŠ¡ã€‚
```
curl -k https://<IP Address>:4194
```
### NodePort

å½“ä¸€ä¸ªç«¯å£é€šè¿‡ **NodePort** åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæš´éœ²æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„ç›¸åŒç«¯å£éƒ½ä¼šæ‰“å¼€ï¼Œå°†æµé‡ä»£ç†åˆ°å£°æ˜çš„ **Service**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªç«¯å£å°†åœ¨ **30000-32767** èŒƒå›´å†…ã€‚å› æ­¤ï¼Œæ–°çš„æœªæ£€æŸ¥æœåŠ¡å¯èƒ½ä¼šé€šè¿‡è¿™äº›ç«¯å£è®¿é—®ã€‚
```
sudo nmap -sS -p 30000-32767 <IP>
```
## æ¼æ´é…ç½®

### Kube-apiserver åŒ¿åè®¿é—®

ä¸å…è®¸å¯¹ **kube-apiserver API ç«¯ç‚¹è¿›è¡ŒåŒ¿åè®¿é—®**ã€‚ä½†æ‚¨å¯ä»¥æ£€æŸ¥ä¸€äº›ç«¯ç‚¹ï¼š

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **æ£€æŸ¥ ETCD åŒ¿åè®¿é—®**

ETCD å­˜å‚¨é›†ç¾¤çš„æœºå¯†ã€é…ç½®æ–‡ä»¶å’Œæ›´å¤š **æ•æ„Ÿæ•°æ®**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒETCD **ä¸èƒ½** è¢« **åŒ¿åè®¿é—®**ï¼Œä½†æ£€æŸ¥ä¸€ä¸‹æ€»æ˜¯å¥½çš„ã€‚

å¦‚æœ ETCD å¯ä»¥è¢«åŒ¿åè®¿é—®ï¼Œæ‚¨å¯èƒ½éœ€è¦ **ä½¿ç”¨** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **å·¥å…·**ã€‚ä»¥ä¸‹å‘½ä»¤å°†è·å–æ‰€æœ‰å­˜å‚¨çš„å¯†é’¥ï¼š
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[**Kubelet æ–‡æ¡£**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) è§£é‡Šè¯´ï¼Œ**é»˜è®¤æƒ…å†µä¸‹å…è®¸åŒ¿åè®¿é—®**è¯¥æœåŠ¡ï¼š

> å…è®¸å¯¹ Kubelet æœåŠ¡å™¨çš„åŒ¿åè¯·æ±‚ã€‚æœªè¢«å…¶ä»–èº«ä»½éªŒè¯æ–¹æ³•æ‹’ç»çš„è¯·æ±‚è¢«è§†ä¸ºåŒ¿åè¯·æ±‚ã€‚åŒ¿åè¯·æ±‚çš„ç”¨æˆ·åä¸º `system:anonymous`ï¼Œç»„åä¸º `system:unauthenticated`

è¦æ›´å¥½åœ°ç†è§£ **Kubelet API çš„èº«ä»½éªŒè¯å’Œæˆæƒå·¥ä½œåŸç†**ï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢ï¼š

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** æœåŠ¡ **API æ²¡æœ‰æ–‡æ¡£**ï¼Œä½†æºä»£ç å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼ŒæŸ¥æ‰¾æš´éœ²çš„ç«¯ç‚¹å°±åƒ**è¿è¡Œ**ä¸€æ ·ç®€å•ï¼š
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
æ‰€æœ‰è¿™äº›å¬èµ·æ¥éƒ½å¾ˆæœ‰è¶£ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ [**Kubeletctl**](https://github.com/cyberark/kubeletctl) å·¥å…·ä¸ Kubelets åŠå…¶ç«¯ç‚¹è¿›è¡Œäº¤äº’ã€‚

#### /pods

æ­¤ç«¯ç‚¹åˆ—å‡º pods åŠå…¶å®¹å™¨ï¼š
```bash
kubeletctl pods
```
#### /exec

æ­¤ç«¯ç‚¹å…è®¸éå¸¸è½»æ¾åœ°åœ¨ä»»ä½•å®¹å™¨å†…æ‰§è¡Œä»£ç ï¼š
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
ä¸ºäº†é¿å…æ­¤æ”»å‡»ï¼Œ_**kubelet**_ æœåŠ¡åº”ä»¥ `--anonymous-auth false` è¿è¡Œï¼Œå¹¶ä¸”è¯¥æœåŠ¡åº”åœ¨ç½‘ç»œå±‚é¢è¿›è¡Œéš”ç¦»ã€‚
{% endhint %}

### **æ£€æŸ¥ Kubeletï¼ˆåªè¯»ç«¯å£ï¼‰ä¿¡æ¯æ³„éœ²**

å½“ **kubelet åªè¯»ç«¯å£** è¢«æš´éœ²æ—¶ï¼Œæœªæˆæƒæ–¹å¯ä»¥ä» API ä¸­æ£€ç´¢ä¿¡æ¯ã€‚è¯¥ç«¯å£çš„æš´éœ²å¯èƒ½å¯¼è‡´å„ç§ **é›†ç¾¤é…ç½®å…ƒç´ ** çš„æ³„éœ²ã€‚å°½ç®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ **pod åç§°ã€å†…éƒ¨æ–‡ä»¶ä½ç½®å’Œå…¶ä»–é…ç½®**ï¼Œå¯èƒ½ä¸æ˜¯å…³é”®çš„ï¼Œä½†å…¶æš´éœ²ä»ç„¶æ„æˆå®‰å…¨é£é™©ï¼Œåº”äºˆä»¥é¿å…ã€‚

æ­¤æ¼æ´çš„ä¸€ä¸ªåˆ©ç”¨ç¤ºä¾‹æ¶‰åŠè¿œç¨‹æ”»å‡»è€…è®¿é—®ç‰¹å®š URLã€‚é€šè¿‡å¯¼èˆªåˆ° `http://<external-IP>:10255/pods`ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šä» kubelet ä¸­æ£€ç´¢æ•æ„Ÿä¿¡æ¯ï¼š

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## References

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
