# Pentesting Kubernetes Services

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Kubernetes utiliza varios **servicios de red espec칤ficos** que podr칤as encontrar **expuestos a Internet** o en una **red interna una vez que hayas comprometido un pod**.

## Finding exposed pods with OSINT

Una forma podr칤a ser buscar `Identity LIKE "k8s.%.com"` en [crt.sh](https://crt.sh) para encontrar subdominios relacionados con kubernetes. Otra forma podr칤a ser buscar `"k8s.%.com"` en github y buscar **archivos YAML** que contengan la cadena.

## How Kubernetes Exposes Services

Podr칤a ser 칰til para ti entender c칩mo Kubernetes puede **exponer servicios p칰blicamente** para poder encontrarlos:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Finding Exposed pods via port scanning

Los siguientes puertos podr칤an estar abiertos en un cl칰ster de Kubernetes:

| Port            | Process        | Description                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Puerto de la API de Kubernetes                                         |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | M칠tricas del contenedor                                               |
| 6443/TCP        | kube-apiserver | Puerto de la API de Kubernetes                                         |
| 8443/TCP        | kube-apiserver | Puerto de la API de Minikube                                          |
| 8080/TCP        | kube-apiserver | Puerto de API inseguro                                                |
| 10250/TCP       | kubelet        | API HTTPS que permite acceso en modo completo                         |
| 10255/TCP       | kubelet        | Puerto HTTP de solo lectura no autenticado: pods, pods en ejecuci칩n y estado del nodo |
| 10256/TCP       | kube-proxy     | Servidor de verificaci칩n de salud de Kube Proxy                      |
| 9099/TCP        | calico-felix   | Servidor de verificaci칩n de salud para Calico                        |
| 6782-4/TCP      | weave          | M칠tricas y puntos finales                                            |
| 30000-32767/TCP | NodePort       | Proxy a los servicios                                                |
| 44134/TCP       | Tiller         | Servicio Helm escuchando                                             |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Este es el **servicio API de Kubernetes** con el que los administradores suelen comunicarse utilizando la herramienta **`kubectl`**.

**Puertos comunes: 6443 y 443**, pero tambi칠n 8443 en minikube y 8080 como inseguro.
```bash
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Consulta la siguiente p치gina para aprender c칩mo obtener datos sensibles y realizar acciones sensibles hablando con este servicio:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### API de Kubelet

Este servicio **se ejecuta en cada nodo del cl칰ster**. Es el servicio que **controlar치** los pods dentro del **nodo**. Se comunica con el **kube-apiserver**.

Si encuentras este servicio expuesto, podr칤as haber encontrado un **RCE no autenticado**.

#### API de Kubelet
```bash
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Si la respuesta es `Unauthorized`, entonces se requiere autenticaci칩n.

Si puedes listar nodos, puedes obtener una lista de los endpoints de kubelets con:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Solo lectura)
```bash
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### API de etcd
```bash
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```bash
helm --host tiller-deploy.kube-system:44134 version
```
Podr칤as abusar de este servicio para escalar privilegios dentro de Kubernetes:

### cAdvisor

Servicio 칰til para recopilar m칠tricas.
```bash
curl -k https://<IP Address>:4194
```
### NodePort

Cuando un puerto se expone en todos los nodos a trav칠s de un **NodePort**, el mismo puerto se abre en todos los nodos proxificando el tr치fico hacia el **Service** declarado. Por defecto, este puerto estar치 en el **rango 30000-32767**. Por lo tanto, los nuevos servicios no verificados podr칤an ser accesibles a trav칠s de esos puertos.
```bash
sudo nmap -sS -p 30000-32767 <IP>
```
## Vulnerable Misconfigurations

### Kube-apiserver Acceso An칩nimo

El acceso an칩nimo a **kube-apiserver API endpoints no est치 permitido**. Pero puedes verificar algunos endpoints:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Verificando el Acceso An칩nimo a ETCD**

El ETCD almacena los secretos del cl칰ster, archivos de configuraci칩n y m치s **datos sensibles**. Por **defecto**, el ETCD **no puede** ser accedido **an칩nimamente**, pero siempre es bueno verificar.

Si el ETCD puede ser accedido an칩nimamente, es posible que necesites **usar el** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **herramienta**. El siguiente comando obtendr치 todas las claves almacenadas:
```bash
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

La [**documentaci칩n de Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) explica que por **defecto el acceso an칩nimo** al servicio est치 **permitido:**

> Permite solicitudes an칩nimas al servidor Kubelet. Las solicitudes que no son rechazadas por otro m칠todo de autenticaci칩n se tratan como solicitudes an칩nimas. Las solicitudes an칩nimas tienen un nombre de usuario de `system:anonymous`, y un nombre de grupo de `system:unauthenticated`

Para entender mejor c칩mo funciona la **autenticaci칩n y autorizaci칩n de la API de Kubelet**, consulta esta p치gina:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

La **API del servicio Kubelet no est치 documentada**, pero el c칩digo fuente se puede encontrar aqu칤 y encontrar los endpoints expuestos es tan f치cil como **ejecutar**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Todos ellos suenan interesantes.

Puedes usar la herramienta [**Kubeletctl**](https://github.com/cyberark/kubeletctl) para interactuar con Kubelets y sus endpoints.

#### /pods

Este endpoint lista los pods y sus contenedores:
```bash
kubeletctl pods
```
#### /exec

Este endpoint permite ejecutar c칩digo dentro de cualquier contenedor muy f치cilmente:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Para evitar este ataque, el servicio _**kubelet**_ debe ejecutarse con `--anonymous-auth false` y el servicio debe estar segregado a nivel de red.
{% endhint %}

### **Verificaci칩n de la Exposici칩n de Informaci칩n del Kubelet (Puerto Solo de Lectura)**

Cuando un **puerto de solo lectura del kubelet** est치 expuesto, se vuelve posible que partes no autorizadas recuperen informaci칩n de la API. La exposici칩n de este puerto puede llevar a la divulgaci칩n de varios **elementos de configuraci칩n del cl칰ster**. Aunque la informaci칩n, incluidos **nombres de pods, ubicaciones de archivos internos y otras configuraciones**, puede no ser cr칤tica, su exposici칩n sigue representando un riesgo de seguridad y debe ser evitada.

Un ejemplo de c칩mo se puede explotar esta vulnerabilidad implica a un atacante remoto accediendo a una URL espec칤fica. Al navegar a `http://<external-IP>:10255/pods`, el atacante puede potencialmente recuperar informaci칩n sensible del kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
