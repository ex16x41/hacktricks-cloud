# Pentesting Kubernetes Services

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

Kubernetes verwendet mehrere **spezifische Netzwerkdienste**, die du m√∂glicherweise **im Internet exponiert** oder in einem **internen Netzwerk findest, sobald du einen Pod kompromittiert hast**.

## Finden exponierter Pods mit OSINT

Eine M√∂glichkeit k√∂nnte sein, nach `Identity LIKE "k8s.%.com"` in [crt.sh](https://crt.sh) zu suchen, um Subdomains zu finden, die mit Kubernetes in Verbindung stehen. Eine andere M√∂glichkeit k√∂nnte sein, nach `"k8s.%.com"` in GitHub zu suchen und nach **YAML-Dateien** zu suchen, die die Zeichenfolge enthalten.

## Wie Kubernetes Dienste exponiert

Es k√∂nnte n√ºtzlich f√ºr dich sein, zu verstehen, wie Kubernetes **Dienste √∂ffentlich exponieren** kann, um sie zu finden:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Finden exponierter Pods durch Port-Scanning

Die folgenden Ports k√∂nnten in einem Kubernetes-Cluster offen sein:

| Port            | Prozess        | Beschreibung                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API-Port                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Container-Metriken                                                    |
| 6443/TCP        | kube-apiserver | Kubernetes API-Port                                                    |
| 8443/TCP        | kube-apiserver | Minikube API-Port                                                      |
| 8080/TCP        | kube-apiserver | Unsicherer API-Port                                                    |
| 10250/TCP       | kubelet        | HTTPS-API, die vollen Moduszugang erm√∂glicht                           |
| 10255/TCP       | kubelet        | Unauthentifizierter schreibgesch√ºtzter HTTP-Port: Pods, laufende Pods und Knotenstatus |
| 10256/TCP       | kube-proxy     | Kube Proxy-Health-Check-Server                                        |
| 9099/TCP        | calico-felix   | Health-Check-Server f√ºr Calico                                        |
| 6782-4/TCP      | weave          | Metriken und Endpunkte                                                |
| 30000-32767/TCP | NodePort       | Proxy zu den Diensten                                                 |
| 44134/TCP       | Tiller         | Helm-Dienst, der lauscht                                             |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Dies ist der **API Kubernetes-Dienst**, mit dem die Administratoren normalerweise √ºber das Tool **`kubectl`** kommunizieren.

**H√§ufige Ports: 6443 und 443**, aber auch 8443 in minikube und 8080 als unsicher.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**√úberpr√ºfen Sie die folgende Seite, um zu erfahren, wie Sie sensible Daten erhalten und sensible Aktionen durchf√ºhren k√∂nnen, indem Sie mit diesem Dienst sprechen:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Dieser Dienst **l√§uft auf jedem Knoten des Clusters**. Es ist der Dienst, der die **Pods** innerhalb des **Knotens** **steuert**. Er kommuniziert mit dem **kube-apiserver**.

Wenn Sie diesen Dienst exponiert finden, haben Sie m√∂glicherweise eine **unauthentifizierte RCE** gefunden.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Wenn die Antwort `Unauthorized` ist, erfordert dies eine Authentifizierung.

Wenn Sie Knoten auflisten k√∂nnen, k√∂nnen Sie eine Liste der Kubelet-Endpunkte mit folgendem Befehl erhalten:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Nur lesen)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
You k√∂nnten diesen Dienst missbrauchen, um Privilegien innerhalb von Kubernetes zu eskalieren:

### cAdvisor

Dienst, der n√ºtzlich ist, um Metriken zu sammeln.
```
curl -k https://<IP Address>:4194
```
### NodePort

Wenn ein Port in allen Knoten √ºber einen **NodePort** freigegeben wird, wird derselbe Port in allen Knoten ge√∂ffnet, um den Verkehr in den deklarierten **Service** zu proxifizieren. Standardm√§√üig liegt dieser Port im **Bereich 30000-32767**. Daher k√∂nnten neue, nicht √ºberpr√ºfte Dienste √ºber diese Ports zug√§nglich sein.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Verwundbare Fehlkonfigurationen

### Kube-apiserver Anonymer Zugriff

Anonymer Zugriff auf **kube-apiserver API-Endpunkte ist nicht erlaubt**. Aber Sie k√∂nnten einige Endpunkte √ºberpr√ºfen:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **√úberpr√ºfung auf ETCD Anonymen Zugriff**

Der ETCD speichert die Cluster-Geheimnisse, Konfigurationsdateien und weitere **sensible Daten**. Standardm√§√üig **kann** der ETCD **nicht** **anonym** zugegriffen werden, aber es ist immer gut, dies zu √ºberpr√ºfen.

Wenn der ETCD anonym zug√§nglich ist, m√ºssen Sie m√∂glicherweise das **[etcdctl](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md)** **Tool** verwenden. Der folgende Befehl wird alle gespeicherten Schl√ºssel abrufen:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

Die [**Kubelet-Dokumentation**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) erkl√§rt, dass **standardm√§√üig anonymer Zugriff** auf den Dienst **erlaubt ist:**

> Erm√∂glicht anonyme Anfragen an den Kubelet-Server. Anfragen, die von einer anderen Authentifizierungsmethode nicht abgelehnt werden, werden als anonyme Anfragen behandelt. Anonyme Anfragen haben einen Benutzernamen von `system:anonymous` und einen Gruppennamen von `system:unauthenticated`

Um besser zu verstehen, wie die **Authentifizierung und Autorisierung der Kubelet-API funktioniert**, besuche diese Seite:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Die **Kubelet**-Dienst-**API ist nicht dokumentiert**, aber der Quellcode kann hier gefunden werden und das Finden der exponierten Endpunkte ist so einfach wie **auszuf√ºhren**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Alle klingen interessant.

Sie k√∂nnen das [**Kubeletctl**](https://github.com/cyberark/kubeletctl) Tool verwenden, um mit Kubelets und ihren Endpunkten zu interagieren.

#### /pods

Dieser Endpunkt listet Pods und ihre Container auf:
```bash
kubeletctl pods
```
#### /exec

Dieser Endpunkt erm√∂glicht es, Code sehr einfach innerhalb eines Containers auszuf√ºhren:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Um diesen Angriff zu vermeiden, sollte der _**kubelet**_ Dienst mit `--anonymous-auth false` ausgef√ºhrt werden, und der Dienst sollte auf Netzwerkebene segregiert werden.
{% endhint %}

### **√úberpr√ºfung der Kubelet (Nur-Lese-Port) Informationsfreigabe**

Wenn ein **kubelet Nur-Lese-Port** freigegeben ist, wird es unbefugten Parteien m√∂glich, Informationen √ºber die API abzurufen. Die Freigabe dieses Ports kann zur Offenlegung verschiedener **Cluster-Konfigurationselemente** f√ºhren. Obwohl die Informationen, einschlie√ülich **Pod-Namen, Standorte interner Dateien und anderer Konfigurationen**, m√∂glicherweise nicht kritisch sind, stellt ihre Freigabe dennoch ein Sicherheitsrisiko dar und sollte vermieden werden.

Ein Beispiel daf√ºr, wie diese Schwachstelle ausgenutzt werden kann, besteht darin, dass ein Angreifer aus der Ferne auf eine bestimmte URL zugreift. Durch das Navigieren zu `http://<external-IP>:10255/pods` kann der Angreifer potenziell sensible Informationen vom kubelet abrufen:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referenzen

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
