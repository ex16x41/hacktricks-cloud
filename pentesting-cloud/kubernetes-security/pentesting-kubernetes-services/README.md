# Pentesting Kubernetes Services

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Kubernetes koristi nekoliko **specifičnih mrežnih usluga** koje možete pronaći **izložene internetu** ili u **internoj mreži kada kompromitujete jedan pod**.

## Finding exposed pods with OSINT

Jedan način može biti pretraga za `Identity LIKE "k8s.%.com"` na [crt.sh](https://crt.sh) kako biste pronašli poddomene povezane sa kubernetesom. Drugi način može biti pretraga `"k8s.%.com"` na github-u i pretraga za **YAML datotekama** koje sadrže ovu string.

## How Kubernetes Exposes Services

Može biti korisno da razumete kako Kubernetes može **izložiti usluge javno** kako biste ih pronašli:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Finding Exposed pods via port scanning

Sledeći portovi mogu biti otvoreni u Kubernetes klasteru:

| Port            | Process        | Description                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API port                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Metrika kontejnera                                                    |
| 6443/TCP        | kube-apiserver | Kubernetes API port                                                    |
| 8443/TCP        | kube-apiserver | Minikube API port                                                      |
| 8080/TCP        | kube-apiserver | Nesiguran API port                                                    |
| 10250/TCP       | kubelet        | HTTPS API koji omogućava pristup u punom režimu                       |
| 10255/TCP       | kubelet        | Neautentifikovani samo za čitanje HTTP port: podovi, aktivni podovi i stanje čvora |
| 10256/TCP       | kube-proxy     | Kube Proxy server za proveru zdravlja                                 |
| 9099/TCP        | calico-felix   | Server za proveru zdravlja za Calico                                  |
| 6782-4/TCP      | weave          | Metrike i krajnje tačke                                              |
| 30000-32767/TCP | NodePort       | Proxy za usluge                                                      |
| 44134/TCP       | Tiller         | Helm usluga koja sluša                                              |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Ovo je **API Kubernetes usluga** sa kojom administratori obično komuniciraju koristeći alat **`kubectl`**.

**Uobičajeni portovi: 6443 i 443**, ali takođe 8443 u minikube i 8080 kao nesiguran.
```bash
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Proverite sledeću stranicu da biste saznali kako da dobijete osetljive podatke i izvršite osetljive radnje razgovarajući sa ovom uslugom:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Ova usluga **radi na svakoj čvoru klastera**. To je usluga koja će **kontrolisati** podove unutar **čvora**. Razgovara sa **kube-apiserver**.

Ako pronađete ovu uslugu izloženu, možda ste pronašli **neautentifikovani RCE**.

#### Kubelet API
```bash
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Ako je odgovor `Unauthorized`, to zahteva autentifikaciju.

Ako možete da nabrojite čvorove, možete dobiti listu kubelet krajnjih tačaka sa:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Samo za čitanje)
```bash
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```bash
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```bash
helm --host tiller-deploy.kube-system:44134 version
```
Možete zloupotrebiti ovu uslugu da eskalirate privilegije unutar Kubernetes-a:

### cAdvisor

Usluga korisna za prikupljanje metrika.
```bash
curl -k https://<IP Address>:4194
```
### NodePort

Kada je port izložen na svim čvorovima putem **NodePort**, isti port je otvoren na svim čvorovima proksifikujući saobraćaj u deklarisanu **Service**. Po defaultu, ovaj port će biti u **opsegu 30000-32767**. Tako da nove neproverene usluge mogu biti dostupne putem tih portova.
```bash
sudo nmap -sS -p 30000-32767 <IP>
```
## Ranljive Konfiguracije

### Kube-apiserver Anonimni Pristup

Anonimni pristup **kube-apiserver API** krajnjim tačkama nije dozvoljen. Ali možete proveriti neke krajnje tačke:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Proveravanje ETCD Anonimnog Pristupa**

ETCD čuva tajne klastera, konfiguracione datoteke i više **osetljivih podataka**. Po **definiciji**, ETCD **ne može** biti pristupljen **anonimno**, ali uvek je dobro proveriti.

Ako se ETCD može pristupiti anonimno, možda ćete morati da **koristite** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **alat**. Sledeća komanda će dobiti sve ključeve koji su sačuvani:
```bash
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

The [**Kubelet documentation**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) objašnjava da je **podrazumevano anonimni pristup** usluzi **dozvoljen:**

> Omogućava anonimne zahteve serveru Kubelet. Zahtevi koji nisu odbijeni od strane druge metode autentifikacije tretiraju se kao anonimni zahtevi. Anonimni zahtevi imaju korisničko ime `system:anonymous`, i naziv grupe `system:unauthenticated`

Da biste bolje razumeli kako **funkcioniše autentifikacija i autorizacija Kubelet API-ja**, pogledajte ovu stranicu:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** usluga **API nije dokumentovana**, ali izvorni kod se može pronaći ovde, a pronalaženje izloženih krajnjih tačaka je lako kao **pokretanje**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Svi zvuče zanimljivo.

Možete koristiti alat [**Kubeletctl**](https://github.com/cyberark/kubeletctl) za interakciju sa Kubelet-ima i njihovim krajnjim tačkama.

#### /pods

Ova krajnja tačka navodi podove i njihove kontejnere:
```bash
kubeletctl pods
```
#### /exec

Ova tačka omogućava lako izvršavanje koda unutar bilo kog kontejnera:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Da bi se izbegao ovaj napad, _**kubelet**_ servis treba da se pokreće sa `--anonymous-auth false` i servis treba da bude segregiran na mrežnom nivou.
{% endhint %}

### **Proveravanje izlaganja informacija Kubelet-a (samo za čitanje)**

Kada je **kubelet port za čitanje** izložen, postaje moguće da neovlašćene strane dobiju informacije iz API-ja. Izlaganje ovog porta može dovesti do otkrivanja različitih **elemenata konfiguracije klastera**. Iako informacije, uključujući **imena podova, lokacije internih fajlova i druge konfiguracije**, možda nisu kritične, njihovo izlaganje i dalje predstavlja bezbednosni rizik i treba ga izbegavati.

Primer kako se ova ranjivost može iskoristiti uključuje udaljenog napadača koji pristupa određenom URL-u. Navigacijom do `http://<external-IP>:10255/pods`, napadač može potencijalno dobiti osetljive informacije iz kubelet-a:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Reference

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
Učite i vežbajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Učite i vežbajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podrška HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
