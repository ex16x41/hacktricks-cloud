# Pentesting Kubernetes Services

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Kubernetes inatumia huduma kadhaa **maalum za mtandao** ambazo unaweza kupata **zilizo wazi kwa Mtandao** au katika **mtandao wa ndani mara tu unaposhambulia pod moja**.

## Finding exposed pods with OSINT

Njia moja inaweza kuwa kutafuta `Identity LIKE "k8s.%.com"` katika [crt.sh](https://crt.sh) ili kupata subdomains zinazohusiana na kubernetes. Njia nyingine inaweza kuwa kutafuta `"k8s.%.com"` katika github na kutafuta **faili za YAML** zinazokuwa na string hiyo.

## How Kubernetes Exposes Services

Inaweza kuwa na manufaa kwako kuelewa jinsi Kubernetes inaweza **kufichua huduma hadharani** ili kuweza kuzitafuta:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Finding Exposed pods via port scanning

Port zifuatazo zinaweza kuwa wazi katika klasta ya Kubernetes:

| Port            | Process        | Description                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API port                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Container metrics                                                      |
| 6443/TCP        | kube-apiserver | Kubernetes API port                                                    |
| 8443/TCP        | kube-apiserver | Minikube API port                                                      |
| 8080/TCP        | kube-apiserver | Insecure API port                                                      |
| 10250/TCP       | kubelet        | HTTPS API which allows full mode access                                |
| 10255/TCP       | kubelet        | Unauthenticated read-only HTTP port: pods, running pods and node state |
| 10256/TCP       | kube-proxy     | Kube Proxy health check server                                         |
| 9099/TCP        | calico-felix   | Health check server for Calico                                         |
| 6782-4/TCP      | weave          | Metrics and endpoints                                                  |
| 30000-32767/TCP | NodePort       | Proxy to the services                                                  |
| 44134/TCP       | Tiller         | Helm service listening                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Hii ni **huduma ya API ya Kubernetes** ambayo wasimamizi huwasiliana nayo mara nyingi wakitumia chombo **`kubectl`**.

**Bandari za kawaida: 6443 na 443**, lakini pia 8443 katika minikube na 8080 kama isiyo salama.
```bash
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Angalia ukurasa ufuatao kujifunza jinsi ya kupata data nyeti na kutekeleza hatua nyeti ukizungumza na huduma hii:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Huduma hii **inafanya kazi katika kila node ya klasta**. Ni huduma ambayo itakuwa **na udhibiti** wa pods ndani ya **node**. Inazungumza na **kube-apiserver**.

Ikiwa utapata huduma hii imewekwa wazi unaweza kuwa umepata **RCE isiyo na uthibitisho**.

#### Kubelet API
```bash
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Ikiwa jibu ni `Unauthorized` basi inahitaji uthibitisho.

Ikiwa unaweza kuorodhesha nodi unaweza kupata orodha ya mwisho za kubelets kwa:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Soma tu)
```bash
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### et—Åd API
```bash
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```bash
helm --host tiller-deploy.kube-system:44134 version
```
You could abuse this service to escalate privileges inside Kubernetes:

### cAdvisor

Huduma inayofaa kukusanya metriki.
```bash
curl -k https://<IP Address>:4194
```
### NodePort

Wakati bandari inafichuliwa katika nodi zote kupitia **NodePort**, bandari hiyo hiyo inafunguliwa katika nodi zote ikipitia trafiki kwenye **Service** iliyotangazwa. Kwa kawaida, bandari hii itakuwa katika **range 30000-32767**. Hivyo, huduma mpya zisizokaguliwa zinaweza kupatikana kupitia bandari hizo.
```bash
sudo nmap -sS -p 30000-32767 <IP>
```
## Vulnerable Misconfigurations

### Kube-apiserver Anonymous Access

Upatikanaji wa bila jina kwa **kube-apiserver API endpoints haukubaliwi**. Lakini unaweza kuangalia baadhi ya endpoints:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Checking for ETCD Anonymous Access**

ETCD inahifadhi siri za klasta, faili za usanidi na data **nyeti zaidi**. Kwa **kawaida**, ETCD **haiwezi** kufikiwa **bila jina**, lakini kila wakati ni vizuri kuangalia.

Ikiwa ETCD inaweza kufikiwa bila jina, unaweza kuhitaji **kutumia** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **chombo**. Amri ifuatayo itapata funguo zote zilizohifadhiwa:
```bash
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

The [**Kubelet documentation**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) inaeleza kwamba kwa **default ufikiaji wa kutotambulika** kwa huduma unaruhusiwa:

> Inaruhusu maombi ya kutotambulika kwa seva ya Kubelet. Maombi ambayo hayakukataliwa na njia nyingine ya uthibitishaji yanachukuliwa kama maombi ya kutotambulika. Maombi ya kutotambulika yana jina la mtumiaji `system:anonymous`, na jina la kundi `system:unauthenticated`

Ili kuelewa vizuri jinsi **uthibitishaji na idhini ya Kubelet API inavyofanya kazi**, angalia ukurasa huu:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Huduma ya **Kubelet** **API haijandikwa**, lakini msimbo wa chanzo unaweza kupatikana hapa na kupata ncha zilizofichwa ni rahisi kama **kukimbia**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Yote yanaonekana kuwa ya kuvutia.

Unaweza kutumia chombo cha [**Kubeletctl**](https://github.com/cyberark/kubeletctl) kuingiliana na Kubelets na maeneo yao.

#### /pods

Huu ni mwisho unaoorodhesha pods na konteina zao:
```bash
kubeletctl pods
```
#### /exec

Hii endpoint inaruhusu kutekeleza msimbo ndani ya kontena yoyote kwa urahisi:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Ili kuepuka shambulio hili, huduma ya _**kubelet**_ inapaswa kuendeshwa na `--anonymous-auth false` na huduma hiyo inapaswa kutengwa katika kiwango cha mtandao.
{% endhint %}

### **Kuangalia Kuwekwa wazi kwa Taarifa za Kubelet (Bandari ya Kusoma Tu)**

Wakati **bandari ya kubelet ya kusoma tu** imewekwa wazi, inakuwa inawezekana kwa taarifa kutolewa kutoka kwa API na wahusika wasioidhinishwa. Kuwekwa wazi kwa bandari hii kunaweza kusababisha kufichuliwa kwa vipengele mbalimbali vya **mipangilio ya klasta**. Ingawa taarifa, ikiwa ni pamoja na **majina ya pod, maeneo ya faili za ndani, na mipangilio mingine**, inaweza isiwe muhimu, kuwekwa wazi kwake bado kunaweka hatari ya usalama na inapaswa kuepukwa.

Mfano wa jinsi udhaifu huu unaweza kutumika ni pamoja na mshambuliaji wa mbali kufikia URL maalum. Kwa kuingia kwenye `http://<external-IP>:10255/pods`, mshambuliaji anaweza kupata taarifa nyeti kutoka kwa kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Marejeleo

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **fuata** sisi kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
