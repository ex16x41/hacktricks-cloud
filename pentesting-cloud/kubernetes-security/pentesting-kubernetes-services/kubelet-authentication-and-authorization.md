# Kubelet Authentication & Authorization

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Kubelet Authentication <a href="#kubelet-authentication" id="kubelet-authentication"></a>

[**From the docss:**](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ä»–ã®è¨­å®šã•ã‚ŒãŸèªè¨¼æ–¹æ³•ã«ã‚ˆã£ã¦æ‹’å¦ã•ã‚Œãªã„kubeletã®HTTPSã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€åŒ¿åãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦æ‰±ã‚ã‚Œã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ `system:anonymous`**ã€**ã‚°ãƒ«ãƒ¼ãƒ—ã¯ `system:unauthenticated`**ãŒä¸ãˆã‚‰ã‚Œã¾ã™ã€‚

**3ã¤ã®** èªè¨¼ **æ–¹æ³•** ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

* **åŒ¿å**ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ **`--anonymous-auth=true`** ã¾ãŸã¯è¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ï¼š
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: ã“ã‚Œã«ã‚ˆã‚Šã€kubectl **APIãƒ™ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³**ãŒèªè¨¼ã¨ã—ã¦**æœ‰åŠ¹**ã«ãªã‚Šã¾ã™ï¼ˆæœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã¯ã™ã¹ã¦æœ‰åŠ¹ã§ã™ï¼‰ã€‚æ¬¡ã®ã‚ˆã†ã«è¨±å¯ã—ã¾ã™ï¼š
* APIã‚µãƒ¼ãƒãƒ¼ã§`authentication.k8s.io/v1beta1` APIã‚°ãƒ«ãƒ¼ãƒ—ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™
* **`--authentication-token-webhook`**ãŠã‚ˆã³**`--kubeconfig`**ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ã—ã¦kubeletã‚’èµ·å‹•ã™ã‚‹ã‹ã€æ¬¡ã®è¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ï¼š
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
kubeletã¯ã€è¨­å®šã•ã‚ŒãŸAPIã‚µãƒ¼ãƒãƒ¼ä¸Šã§**`TokenReview` API**ã‚’å‘¼ã³å‡ºã—ã¦ã€**ãƒ™ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç‰¹å®š**ã—ã¾ã™
{% endhint %}

* **X509ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸:** X509ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã‚’ä»‹ã—ã¦èªè¨¼ã‚’è¨±å¯ã—ã¾ã™
* è©³ç´°ã«ã¤ã„ã¦ã¯ã€[apiserverèªè¨¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs)ã‚’å‚ç…§ã—ã¦ãã ã•ã„
* `--client-ca-file`ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ã—ã¦kubeletã‚’èµ·å‹•ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®CAãƒãƒ³ãƒ‰ãƒ«ã‚’æä¾›ã—ã¾ã™ã€‚ã¾ãŸã¯ã€è¨­å®šã‚’ä½¿ç”¨ã—ã¦:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubelet Authorization <a href="#kubelet-authentication" id="kubelet-authentication"></a>

æˆåŠŸè£ã«èªè¨¼ã•ã‚ŒãŸï¼ˆåŒ¿åãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å«ã‚€ï¼‰**ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãã®å¾Œæ‰¿èªã•ã‚Œã¾ã™**ã€‚**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**ã®æ‰¿èªãƒ¢ãƒ¼ãƒ‰ã¯**`AlwaysAllow`**ã§ã€**ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã—ã¾ã™**ã€‚

ã—ã‹ã—ã€ä»–ã®å¯èƒ½ãªå€¤ã¯**`webhook`**ã§ã‚ã‚Šï¼ˆã“ã‚Œã¯**ä¸»ã«è¦‹ã¤ã‹ã‚‹ã‚‚ã®ã§ã™**ï¼‰ã€ã“ã®ãƒ¢ãƒ¼ãƒ‰ã¯**èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã‚’ç¢ºèªã—ã¦**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨±å¯ã¾ãŸã¯æ‹’å¦ã—ã¾ã™ã€‚

{% hint style="warning" %}
**åŒ¿åèªè¨¼ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã§ã‚‚**ã€**åŒ¿åã‚¢ã‚¯ã‚»ã‚¹**ã«ã¯**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
{% endhint %}

Webhookã«ã‚ˆã‚‹æ‰¿èªã¯ã€**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `--authorization-mode=Webhook`**ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§æ§‹æˆã§ãã¾ã™ï¼š
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
The kubeletã¯ã€è¨­å®šã•ã‚ŒãŸAPIã‚µãƒ¼ãƒãƒ¼ä¸Šã§**`SubjectAccessReview`** APIã‚’å‘¼ã³å‡ºã—ã¦ã€å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ**èªå¯ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’** **åˆ¤æ–­**ã—ã¾ã™ã€‚

kubeletã¯ã€apiserverã¨åŒã˜[ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±æ€§](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes)ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¦APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’èªå¯ã—ã¾ã™ï¼š

* **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**

| HTTPå‹•è© | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‹•è©                                                                                                                                                  |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST     | create                                                                                                                                                        |
| GET, HEAD| getï¼ˆå€‹ã€…ã®ãƒªã‚½ãƒ¼ã‚¹ç”¨ï¼‰ã€listï¼ˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã€å®Œå…¨ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å«ã‚€ï¼‰ã€watchï¼ˆå€‹ã€…ã®ãƒªã‚½ãƒ¼ã‚¹ã¾ãŸã¯ãƒªã‚½ãƒ¼ã‚¹ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç›£è¦–ã™ã‚‹ãŸã‚ï¼‰ |
| PUT      | update                                                                                                                                                        |
| PATCH    | patch                                                                                                                                                         |
| DELETE   | deleteï¼ˆå€‹ã€…ã®ãƒªã‚½ãƒ¼ã‚¹ç”¨ï¼‰ã€deletecollectionï¼ˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç”¨ï¼‰                                                                                         |

* Kubelet APIã¨é€šä¿¡ã™ã‚‹**ãƒªã‚½ãƒ¼ã‚¹**ã¯**å¸¸ã«** **nodes**ã§ã‚ã‚Šã€**ã‚µãƒ–ãƒªã‚½ãƒ¼ã‚¹**ã¯å—ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ã‚¹ã‹ã‚‰**æ±ºå®š**ã•ã‚Œã¾ã™ï¼š

| Kubelet API  | ãƒªã‚½ãƒ¼ã‚¹ | ã‚µãƒ–ãƒªã‚½ãƒ¼ã‚¹ |
| ------------ | -------- | ----------- |
| /stats/\*    | nodes    | stats       |
| /metrics/\*  | nodes    | metrics     |
| /logs/\*     | nodes    | log         |
| /spec/\*     | nodes    | spec        |
| _ãã®ä»–ã™ã¹ã¦_ | nodes    | proxy       |

ä¾‹ãˆã°ã€æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€æ¨©é™ãªã—ã§kubeletã®ãƒãƒƒãƒ‰æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸï¼š
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* **Forbidden**ã‚’å—ã‘å–ã£ãŸã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯**èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’é€šéã—ã¾ã—ãŸ**ã€‚ãã†ã§ãªã‘ã‚Œã°ã€å˜ã«`Unauthorized`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãŸã§ã—ã‚‡ã†ã€‚
* **ãƒ¦ãƒ¼ã‚¶ãƒ¼å**ï¼ˆã“ã®å ´åˆã¯ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ï¼‰ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* **ãƒªã‚½ãƒ¼ã‚¹**ãŒ**nodes**ã§ã€**ã‚µãƒ–ãƒªã‚½ãƒ¼ã‚¹**ãŒ**proxy**ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆã“ã‚Œã¯å‰ã®æƒ…å ±ã¨ä¸€è‡´ã—ã¾ã™ï¼‰ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
