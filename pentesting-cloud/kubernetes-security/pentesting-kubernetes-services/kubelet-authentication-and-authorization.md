# Kubelet Authentication & Authorization

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Kubelet Authentication <a href="#kubelet-authentication" id="kubelet-authentication"></a>

[**æ¥è‡ªæ–‡æ¡£ï¼š**](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

é»˜è®¤æƒ…å†µä¸‹ï¼Œæœªè¢«å…¶ä»–é…ç½®çš„èº«ä»½éªŒè¯æ–¹æ³•æ‹’ç»çš„å¯¹kubeletçš„HTTPSç«¯ç‚¹çš„è¯·æ±‚è¢«è§†ä¸ºåŒ¿åè¯·æ±‚ï¼Œå¹¶è¢«èµ‹äºˆ**ç”¨æˆ·å `system:anonymous`**å’Œ**ç»„ `system:unauthenticated`**ã€‚

**3**ç§èº«ä»½éªŒè¯**æ–¹æ³•**æ˜¯ï¼š

* **åŒ¿å**ï¼ˆé»˜è®¤ï¼‰ï¼šä½¿ç”¨è®¾ç½®å‚æ•°**`--anonymous-auth=true`æˆ–é…ç½®ï¼š**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: è¿™å°† **å¯ç”¨** kubectl **API bearer tokens** ä½œä¸ºæˆæƒï¼ˆä»»ä½•æœ‰æ•ˆçš„ä»¤ç‰Œéƒ½å°†æœ‰æ•ˆï¼‰ã€‚å…è®¸å®ƒï¼š
* ç¡®ä¿åœ¨ API æœåŠ¡å™¨ä¸­å¯ç”¨äº† `authentication.k8s.io/v1beta1` API ç»„
* ä½¿ç”¨ **`--authentication-token-webhook`** å’Œ **`--kubeconfig`** æ ‡å¿—å¯åŠ¨ kubeletï¼Œæˆ–ä½¿ç”¨ä»¥ä¸‹è®¾ç½®ï¼š
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
kubelet åœ¨é…ç½®çš„ API æœåŠ¡å™¨ä¸Šè°ƒç”¨ **`TokenReview` API** ä»¥ **ç¡®å®šç”¨æˆ·ä¿¡æ¯** ä»æ‰¿è½½ä»¤ç‰Œ
{% endhint %}

* **X509 å®¢æˆ·ç«¯è¯ä¹¦ï¼š** å…è®¸é€šè¿‡ X509 å®¢æˆ·ç«¯è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯
* æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ [apiserver èº«ä»½éªŒè¯æ–‡æ¡£](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs)
* ä½¿ç”¨ `--client-ca-file` æ ‡å¿—å¯åŠ¨ kubeletï¼Œæä¾›ä¸€ä¸ª CA åŒ…ä»¥éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚æˆ–è€…ä½¿ç”¨é…ç½®ï¼š
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubelet Authorization <a href="#kubelet-authentication" id="kubelet-authentication"></a>

ä»»ä½•æˆåŠŸè®¤è¯çš„è¯·æ±‚ï¼ˆåŒ…æ‹¬åŒ¿åè¯·æ±‚ï¼‰**éšåä¼šè¢«æˆæƒ**ã€‚**é»˜è®¤**çš„æˆæƒæ¨¡å¼æ˜¯**`AlwaysAllow`**ï¼Œè¿™**å…è®¸æ‰€æœ‰è¯·æ±‚**ã€‚

ç„¶è€Œï¼Œå¦ä¸€ä¸ªå¯èƒ½çš„å€¼æ˜¯**`webhook`**ï¼ˆè¿™å°±æ˜¯ä½ **å¤§å¤šæ•°æƒ…å†µä¸‹ä¼šå‘ç°çš„**ï¼‰ã€‚æ­¤æ¨¡å¼å°†**æ£€æŸ¥å·²è®¤è¯ç”¨æˆ·çš„æƒé™**ä»¥å…è®¸æˆ–æ‹’ç»æŸä¸ªæ“ä½œã€‚

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œå³ä½¿**å¯ç”¨äº†åŒ¿åè®¤è¯**ï¼Œ**åŒ¿åè®¿é—®**å¯èƒ½**æ²¡æœ‰æ‰§è¡Œä»»ä½•æ“ä½œçš„æƒé™**ã€‚
{% endhint %}

é€šè¿‡ webhook çš„æˆæƒå¯ä»¥ä½¿ç”¨**å‚æ•° `--authorization-mode=Webhook`**æˆ–é€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½®ï¼š
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
The kubelet calls the **`SubjectAccessReview`** API on the configured API server to **ç¡®å®š** whether each request is **æˆæƒ.**

The kubelet authorizes API requests using the same [request attributes](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) approach as the apiserver:

* **Action**

| HTTP verb | request verb                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (for individual resources), list (for collections, including full object content), watch (for watching an individual resource or collection of resources) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (for individual resources), deletecollection (for collections)                                                                                         |

* The **resource** talking to the Kubelet api is **å§‹ç»ˆ** **nodes** and **subresource** is **ä»** the incoming request's path **ç¡®å®š**:

| Kubelet API  | resource | subresource |
| ------------ | -------- | ----------- |
| /stats/\*    | nodes    | stats       |
| /metrics/\*  | nodes    | metrics     |
| /logs/\*     | nodes    | log         |
| /spec/\*     | nodes    | spec        |
| _all others_ | nodes    | proxy       |

For example, the following request tried to access the pods info of kubelet without permission:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª **Forbidden**ï¼Œæ‰€ä»¥è¯·æ±‚ **é€šè¿‡äº†èº«ä»½éªŒè¯æ£€æŸ¥**ã€‚å¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬åªä¼šæ”¶åˆ°ä¸€ä¸ª `Unauthorised` æ¶ˆæ¯ã€‚
* æˆ‘ä»¬å¯ä»¥çœ‹åˆ° **ç”¨æˆ·å**ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹æ¥è‡ªä»¤ç‰Œï¼‰
* æ£€æŸ¥ **èµ„æº** æ˜¯ **nodes**ï¼Œè€Œ **å­èµ„æº** æ˜¯ **proxy**ï¼ˆè¿™ä¸ä¹‹å‰çš„ä¿¡æ¯ç›¸ç¬¦ï¼‰

## References

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
