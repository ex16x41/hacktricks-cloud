# Kubelet Authentication & Authorization

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Kubelet Authentication <a href="#kubelet-authentication" id="kubelet-authentication"></a>

[**Da documenta√ß√£o:**](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

Por padr√£o, as solicita√ß√µes para o endpoint HTTPS do kubelet que n√£o s√£o rejeitadas por outros m√©todos de autentica√ß√£o configurados s√£o tratadas como solicita√ß√µes an√¥nimas, e recebem um **nome de usu√°rio de `system:anonymous`** e um **grupo de `system:unauthenticated`**.

Os **3** m√©todos de **autentica√ß√£o** s√£o:

* **An√¥nimo** (padr√£o): Use a configura√ß√£o definindo o par√¢metro **`--anonymous-auth=true` ou a configura√ß√£o:**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: Isso **habilitar√°** os **tokens portadores da API** do kubectl como autoriza√ß√£o (qualquer token v√°lido ser√° aceito). Permita com:
* assegure-se de que o grupo de API `authentication.k8s.io/v1beta1` esteja habilitado no servidor da API
* inicie o kubelet com as flags **`--authentication-token-webhook`** e **`--kubeconfig`** ou use a seguinte configura√ß√£o:
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
O kubelet chama a **`TokenReview` API** no servidor API configurado para **determinar informa√ß√µes do usu√°rio** a partir de tokens bearer
{% endhint %}

* **Certificados de cliente X509:** Permitem autenticar via certificados de cliente X509
* veja a [documenta√ß√£o de autentica√ß√£o do apiserver](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) para mais detalhes
* inicie o kubelet com a flag `--client-ca-file`, fornecendo um pacote CA para verificar os certificados de cliente. Ou com a configura√ß√£o:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubelet Authorization <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Qualquer solicita√ß√£o que seja autenticada com sucesso (incluindo uma solicita√ß√£o an√¥nima) **√© ent√£o autorizada**. O modo de autoriza√ß√£o **padr√£o** √© **`AlwaysAllow`**, que **permite todas as solicita√ß√µes**.

No entanto, o outro valor poss√≠vel √© **`webhook`** (que √© o que voc√™ encontrar√° **principalmente por a√≠**). Este modo **verificar√° as permiss√µes do usu√°rio autenticado** para permitir ou negar uma a√ß√£o.

{% hint style="warning" %}
Observe que mesmo se a **autentica√ß√£o an√¥nima estiver habilitada**, o **acesso an√¥nimo** pode **n√£o ter permiss√µes** para realizar qualquer a√ß√£o.
{% endhint %}

A autoriza√ß√£o via webhook pode ser configurada usando o **par√¢metro `--authorization-mode=Webhook`** ou via o arquivo de configura√ß√£o com:
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
O kubelet chama a **`SubjectAccessReview`** API no servidor API configurado para **determinar** se cada solicita√ß√£o est√° **autorizada.**

O kubelet autoriza solicita√ß√µes de API usando a mesma abordagem de [atributos de solicita√ß√£o](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) que o apiserver:

* **A√ß√£o**

| Verbo HTTP | verbo de solicita√ß√£o                                                                                                                                                  |
| ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | criar                                                                                                                                                                 |
| GET, HEAD  | obter (para recursos individuais), listar (para cole√ß√µes, incluindo conte√∫do completo do objeto), assistir (para assistir a um recurso individual ou cole√ß√£o de recursos) |
| PUT        | atualizar                                                                                                                                                             |
| PATCH      | patch                                                                                                                                                                  |
| DELETE     | deletar (para recursos individuais), deletecollection (para cole√ß√µes)                                                                                               |

* O **recurso** que se comunica com a API do Kubelet √© **sempre** **n√≥s** e o **subrecurso** √© **determinado** pelo caminho da solicita√ß√£o recebida:

| API do Kubelet | recurso | subrecurso |
| --------------- | ------- | ---------- |
| /stats/\*      | n√≥s     | stats      |
| /metrics/\*    | n√≥s     | metrics    |
| /logs/\*       | n√≥s     | log        |
| /spec/\*       | n√≥s     | spec       |
| _todos os outros_ | n√≥s   | proxy      |

Por exemplo, a seguinte solicita√ß√£o tentou acessar as informa√ß√µes dos pods do kubelet sem permiss√£o:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* Recebemos um **Proibido**, ent√£o a solicita√ß√£o **passou na verifica√ß√£o de Autentica√ß√£o**. Se n√£o, ter√≠amos recebido apenas uma mensagem de `N√£o Autorizado`.
* Podemos ver o **nome de usu√°rio** (neste caso, do token)
* Verifique como o **recurso** era **n√≥s** e o **sub-recurso** **proxy** (o que faz sentido com as informa√ß√µes anteriores)

## Refer√™ncias

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
