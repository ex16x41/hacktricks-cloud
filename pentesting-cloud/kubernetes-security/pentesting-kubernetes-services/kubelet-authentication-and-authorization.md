# Kubelet Authentication & Authorization

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Kubelet Authentication <a href="#kubelet-authentication" id="kubelet-authentication"></a>

[**D'apr√®s la documentation :**](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

Par d√©faut, les requ√™tes vers le point de terminaison HTTPS du kubelet qui ne sont pas rejet√©es par d'autres m√©thodes d'authentification configur√©es sont trait√©es comme des requ√™tes anonymes, et re√ßoivent un **nom d'utilisateur de `system:anonymous`** et un **groupe de `system:unauthenticated`**.

Les **3** m√©thodes d'**authentification** sont :

* **Anonyme** (par d√©faut) : Utilisez le param√®tre **`--anonymous-auth=true` ou la config :**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook** : Cela va **activer** les **tokens porteurs API** kubectl comme autorisation (tout token valide sera valide). Autorisez-le avec :
* assurez-vous que le groupe API `authentication.k8s.io/v1beta1` est activ√© dans le serveur API
* d√©marrez le kubelet avec les options **`--authentication-token-webhook`** et **`--kubeconfig`** ou utilisez le param√®tre suivant :
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
Le kubelet appelle l'**API `TokenReview`** sur le serveur API configur√© pour **d√©terminer les informations utilisateur** √† partir des jetons porteurs.
{% endhint %}

* **Certificats clients X509 :** Permettent de s'authentifier via des certificats clients X509.
* voir la [documentation d'authentification de l'apiserver](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) pour plus de d√©tails.
* d√©marrer le kubelet avec le drapeau `--client-ca-file`, en fournissant un bundle CA pour v√©rifier les certificats clients. Ou avec la configuration :
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubelet Authorization <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Toute demande qui est authentifi√©e avec succ√®s (y compris une demande anonyme) **est ensuite autoris√©e**. Le mode d'autorisation **par d√©faut** est **`AlwaysAllow`**, qui **permet toutes les demandes**.

Cependant, l'autre valeur possible est **`webhook`** (ce que vous trouverez **principalement l√†-bas**). Ce mode **v√©rifiera les permissions de l'utilisateur authentifi√©** pour autoriser ou interdire une action.

{% hint style="warning" %}
Notez que m√™me si **l'authentification anonyme est activ√©e**, l'**acc√®s anonyme** pourrait **ne pas avoir de permissions** pour effectuer une action.
{% endhint %}

L'autorisation via webhook peut √™tre configur√©e en utilisant le **param√®tre `--authorization-mode=Webhook`** ou via le fichier de configuration avec :
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
Le kubelet appelle l'API **`SubjectAccessReview`** sur le serveur API configur√© pour **d√©terminer** si chaque demande est **autoris√©e.**

Le kubelet autorise les demandes API en utilisant la m√™me approche [d'attributs de demande](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) que l'apiserver :

* **Action**

| Verbe HTTP | verbe de demande                                                                                                                                                  |
| ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | cr√©er                                                                                                                                                             |
| GET, HEAD  | obtenir (pour des ressources individuelles), lister (pour des collections, y compris le contenu complet de l'objet), surveiller (pour surveiller une ressource individuelle ou une collection de ressources) |
| PUT        | mettre √† jour                                                                                                                                                    |
| PATCH      | patch                                                                                                                                                             |
| DELETE     | supprimer (pour des ressources individuelles), deletecollection (pour des collections)                                                                           |

* La **ressource** communiquant avec l'API Kubelet est **toujours** **nodes** et le **sous-ressource** est **d√©termin√©** √† partir du chemin de la demande entrante :

| API Kubelet | ressource | sous-ressource |
| ----------- | --------- | -------------- |
| /stats/\*   | nodes     | stats          |
| /metrics/\* | nodes     | metrics        |
| /logs/\*    | nodes     | log            |
| /spec/\*    | nodes     | spec           |
| _toutes les autres_ | nodes | proxy       |

Par exemple, la demande suivante a essay√© d'acc√©der aux informations des pods de kubelet sans autorisation :
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* Nous avons obtenu un **Interdit**, donc la requ√™te **a pass√© la v√©rification d'authentification**. Sinon, nous aurions simplement re√ßu un message `Non autoris√©`.
* Nous pouvons voir le **nom d'utilisateur** (dans ce cas √† partir du jeton)
* V√©rifiez comment la **ressource** √©tait **n≈ìuds** et le **sous-ressource** **proxy** (ce qui a du sens avec les informations pr√©c√©dentes)

## R√©f√©rences

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
