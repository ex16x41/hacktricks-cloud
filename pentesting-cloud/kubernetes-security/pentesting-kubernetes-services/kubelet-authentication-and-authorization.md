# Kubelet Authentication & Authorization

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Kubelet Authentication <a href="#kubelet-authentication" id="kubelet-authentication"></a>

[**ë¬¸ì„œì—ì„œ:**](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

ê¸°ë³¸ì ìœ¼ë¡œ, ë‹¤ë¥¸ êµ¬ì„±ëœ ì¸ì¦ ë°©ë²•ì— ì˜í•´ ê±°ë¶€ë˜ì§€ ì•Šì€ kubeletì˜ HTTPS ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ ìš”ì²­ì€ ìµëª… ìš”ì²­ìœ¼ë¡œ ì²˜ë¦¬ë˜ë©°, **`system:anonymous`**ë¼ëŠ” **ì‚¬ìš©ì ì´ë¦„**ê³¼ **`system:unauthenticated`**ë¼ëŠ” **ê·¸ë£¹**ì´ ë¶€ì—¬ë©ë‹ˆë‹¤.

**3**ê°€ì§€ ì¸ì¦ **ë°©ë²•**ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* **ìµëª…** (ê¸°ë³¸ê°’): ë§¤ê°œë³€ìˆ˜ **`--anonymous-auth=true`** ë˜ëŠ” êµ¬ì„± ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: ì´ê²ƒì€ kubectl **API bearer tokens**ë¥¼ ì¸ì¦ìœ¼ë¡œ **í™œì„±í™”**í•©ë‹ˆë‹¤ (ìœ íš¨í•œ ëª¨ë“  í† í°ì´ ìœ íš¨í•©ë‹ˆë‹¤). ë‹¤ìŒê³¼ ê°™ì´ í—ˆìš©í•©ë‹ˆë‹¤:
* API ì„œë²„ì—ì„œ `authentication.k8s.io/v1beta1` API ê·¸ë£¹ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
* **`--authentication-token-webhook`** ë° **`--kubeconfig`** í”Œë˜ê·¸ë¡œ kubeletì„ ì‹œì‘í•˜ê±°ë‚˜ ë‹¤ìŒ ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
kubeletì€ **`TokenReview` API**ë¥¼ êµ¬ì„±ëœ API ì„œë²„ì—ì„œ í˜¸ì¶œí•˜ì—¬ **ì‚¬ìš©ì ì •ë³´ë¥¼** ë² ì–´ëŸ¬ í† í°ì—ì„œ ê²°ì •í•©ë‹ˆë‹¤.
{% endhint %}

* **X509 í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œ:** X509 í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œë¥¼ í†µí•´ ì¸ì¦ì„ í—ˆìš©í•©ë‹ˆë‹¤.
* ìì„¸í•œ ë‚´ìš©ì€ [apiserver ì¸ì¦ ë¬¸ì„œ](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs)ë¥¼ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.
* `--client-ca-file` í”Œë˜ê·¸ë¡œ kubeletì„ ì‹œì‘í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œë¥¼ ê²€ì¦í•  CA ë²ˆë“¤ì„ ì œê³µí•©ë‹ˆë‹¤. ë˜ëŠ” êµ¬ì„±ìœ¼ë¡œ:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubelet Authorization <a href="#kubelet-authentication" id="kubelet-authentication"></a>

ì„±ê³µì ìœ¼ë¡œ ì¸ì¦ëœ ëª¨ë“  ìš”ì²­(ìµëª… ìš”ì²­ í¬í•¨)ì€ **ê·¸ í›„ì— ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤**. **ê¸°ë³¸** ê¶Œí•œ ë¶€ì—¬ ëª¨ë“œëŠ” **`AlwaysAllow`**ë¡œ, **ëª¨ë“  ìš”ì²­ì„ í—ˆìš©í•©ë‹ˆë‹¤**.

ê·¸ëŸ¬ë‚˜ ë‹¤ë¥¸ ê°€ëŠ¥í•œ ê°’ì€ **`webhook`**ì…ë‹ˆë‹¤(ëŒ€ë¶€ë¶„ì˜ ê²½ìš° **ì—¬ê¸°ì„œ ì°¾ì„ ìˆ˜ ìˆëŠ” ê²ƒ**). ì´ ëª¨ë“œëŠ” **ì¸ì¦ëœ ì‚¬ìš©ìì˜ ê¶Œí•œì„ í™•ì¸**í•˜ì—¬ ì‘ì—…ì„ í—ˆìš©í•˜ê±°ë‚˜ ê±°ë¶€í•©ë‹ˆë‹¤.

{% hint style="warning" %}
**ìµëª… ì¸ì¦ì´ í™œì„±í™”ë˜ì–´ ìˆë”ë¼ë„** **ìµëª… ì•¡ì„¸ìŠ¤**ëŠ” **ì–´ë–¤ ì‘ì—…ë„ ìˆ˜í–‰í•  ê¶Œí•œì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.
{% endhint %}

ì›¹í›„í¬ë¥¼ í†µí•œ ê¶Œí•œ ë¶€ì—¬ëŠ” **íŒŒë¼ë¯¸í„° `--authorization-mode=Webhook`**ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ êµ¬ì„± íŒŒì¼ì„ í†µí•´ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
The kubeletì€ êµ¬ì„±ëœ API ì„œë²„ì—ì„œ **`SubjectAccessReview`** APIë¥¼ í˜¸ì¶œí•˜ì—¬ ê° ìš”ì²­ì´ **í—ˆê°€ë˜ì—ˆëŠ”ì§€** **ê²°ì •**í•©ë‹ˆë‹¤.

kubeletì€ apiserverì™€ ë™ì¼í•œ [ìš”ì²­ ì†ì„±](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) ì ‘ê·¼ ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ API ìš”ì²­ì„ í—ˆê°€í•©ë‹ˆë‹¤:

* **ì‘ì—…**

| HTTP ë™ì‚¬ | ìš”ì²­ ë™ì‚¬                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | ìƒì„±                                                                                                                                                        |
| GET, HEAD | ê°€ì ¸ì˜¤ê¸° (ê°œë³„ ë¦¬ì†ŒìŠ¤ì˜ ê²½ìš°), ëª©ë¡ (ì „ì²´ ê°ì²´ ë‚´ìš©ì„ í¬í•¨í•œ ì»¬ë ‰ì…˜ì˜ ê²½ìš°), ê°ì‹œ (ê°œë³„ ë¦¬ì†ŒìŠ¤ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ ì»¬ë ‰ì…˜ì„ ê°ì‹œí•˜ëŠ” ê²½ìš°) |
| PUT       | ì—…ë°ì´íŠ¸                                                                                                                                                    |
| PATCH     | íŒ¨ì¹˜                                                                                                                                                         |
| DELETE    | ì‚­ì œ (ê°œë³„ ë¦¬ì†ŒìŠ¤ì˜ ê²½ìš°), ì»¬ë ‰ì…˜ ì‚­ì œ (ì»¬ë ‰ì…˜ì˜ ê²½ìš°)                                                                                                     |

* Kubelet APIì™€ í†µì‹ í•˜ëŠ” **ë¦¬ì†ŒìŠ¤**ëŠ” **í•­ìƒ** **ë…¸ë“œ**ì´ë©°, **ì„œë¸Œë¦¬ì†ŒìŠ¤**ëŠ” ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì˜ ê²½ë¡œì—ì„œ **ê²°ì •**ë©ë‹ˆë‹¤:

| Kubelet API  | ë¦¬ì†ŒìŠ¤ | ì„œë¸Œë¦¬ì†ŒìŠ¤ |
| ------------ | -------- | ----------- |
| /stats/\*    | ë…¸ë“œ    | stats       |
| /metrics/\*  | ë…¸ë“œ    | metrics     |
| /logs/\*     | ë…¸ë“œ    | log         |
| /spec/\*     | ë…¸ë“œ    | spec        |
| _ëª¨ë“  ê¸°íƒ€_  | ë…¸ë“œ    | proxy       |

ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒ ìš”ì²­ì€ ê¶Œí•œ ì—†ì´ kubeletì˜ í¬ë“œ ì •ë³´ë¥¼ ì ‘ê·¼í•˜ë ¤ê³  í–ˆìŠµë‹ˆë‹¤:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* ìš°ë¦¬ëŠ” **ê¸ˆì§€ë¨**ì„ ë°›ì•˜ìœ¼ë¯€ë¡œ ìš”ì²­ì´ **ì¸ì¦ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤**. ê·¸ë ‡ì§€ ì•Šì•˜ë‹¤ë©´ ìš°ë¦¬ëŠ” ë‹¨ì§€ `ê¶Œí•œ ì—†ìŒ` ë©”ì‹œì§€ë¥¼ ë°›ì•˜ì„ ê²ƒì…ë‹ˆë‹¤.
* **ì‚¬ìš©ì ì´ë¦„**(ì´ ê²½ìš° í† í°ì—ì„œ)ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **ë¦¬ì†ŒìŠ¤**ê°€ **ë…¸ë“œ**ì˜€ê³  **ì„œë¸Œë¦¬ì†ŒìŠ¤**ê°€ **í”„ë¡ì‹œ**ì˜€ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤(ì´ì „ ì •ë³´ì™€ ì¼ì¹˜í•©ë‹ˆë‹¤).

## References

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
