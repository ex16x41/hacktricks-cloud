# Kubelet Authentication & Authorization

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Kubelet Authentication <a href="#kubelet-authentication" id="kubelet-authentication"></a>

[**–ó –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó:**](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∑–∞–ø–∏—Ç–∏ –¥–æ HTTPS-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É kubelet, —è–∫—ñ –Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω—ñ —ñ–Ω—à–∏–º–∏ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, —Ä–æ–∑–≥–ª—è–¥–∞—é—Ç—å—Å—è —è–∫ –∞–Ω–æ–Ω—ñ–º–Ω—ñ –∑–∞–ø–∏—Ç–∏ —ñ –æ—Ç—Ä–∏–º—É—é—Ç—å **—ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ `system:anonymous`** —Ç–∞ **–≥—Ä—É–ø—É `system:unauthenticated`**.

**3** –º–µ—Ç–æ–¥–∏ **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó**:

* **–ê–Ω–æ–Ω—ñ–º–Ω–∏–π** (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º): –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, –≤—Å—Ç–∞–Ω–æ–≤–∏–≤—à–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä **`--anonymous-auth=true` –∞–±–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é:**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: –¶–µ **–¥–æ–∑–≤–æ–ª–∏—Ç—å** —Ç–æ–∫–µ–Ω–∏ **API bearer** kubectl —è–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é (–±—É–¥—å-—è–∫–∏–π –¥—ñ–π—Å–Ω–∏–π —Ç–æ–∫–µ–Ω –±—É–¥–µ –¥—ñ–π—Å–Ω–∏–º). –î–æ–∑–≤–æ–ª—å—Ç–µ —Ü–µ –∑:
* –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≥—Ä—É–ø–∞ API `authentication.k8s.io/v1beta1` —É–≤—ñ–º–∫–Ω–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ API
* –∑–∞–ø—É—Å—Ç—ñ—Ç—å kubelet –∑ –ø—Ä–∞–ø–æ—Ä–∞–º–∏ **`--authentication-token-webhook`** —Ç–∞ **`--kubeconfig`** –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
Kubelet –≤–∏–∫–ª–∏–∫–∞—î **`TokenReview` API** –Ω–∞ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ–º—É API —Å–µ—Ä–≤–µ—Ä—ñ, —â–æ–± **–≤–∏–∑–Ω–∞—á–∏—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** –∑ —Ç–æ–∫–µ–Ω—ñ–≤ –¥–æ—Å—Ç—É–ø—É
{% endhint %}

* **X509 –∫–ª—ñ—î–Ω—Ç—Å—å–∫—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏:** –î–æ–∑–≤–æ–ª—è—é—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —á–µ—Ä–µ–∑ X509 –∫–ª—ñ—î–Ω—Ç—Å—å–∫—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏
* –¥–∏–≤—ñ—Ç—å—Å—è [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é –∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó apiserver](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
* –∑–∞–ø—É—Å—Ç—ñ—Ç—å kubelet –∑ –ø—Ä–∞–ø–æ—Ä–æ–º `--client-ca-file`, –Ω–∞–¥–∞—é—á–∏ –ø–∞–∫–µ—Ç CA –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤. –ê–±–æ –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—î—é:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubelet Authorization <a href="#kubelet-authentication" id="kubelet-authentication"></a>

–ë—É–¥—å-—è–∫–∏–π –∑–∞–ø–∏—Ç, —è–∫–∏–π —É—Å–ø—ñ—à–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π (–≤–∫–ª—é—á–∞—é—á–∏ –∞–Ω–æ–Ω—ñ–º–Ω–∏–π –∑–∞–ø–∏—Ç) **–ø–æ—Ç—ñ–º –∞–≤—Ç–æ—Ä–∏–∑—É—î—Ç—å—Å—è**. **–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º** —Ä–µ–∂–∏–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó - **`AlwaysAllow`**, —è–∫–∏–π **–¥–æ–∑–≤–æ–ª—è—î –≤—Å—ñ –∑–∞–ø–∏—Ç–∏**.

–û–¥–Ω–∞–∫ —ñ–Ω—à–µ –º–æ–∂–ª–∏–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è - **`webhook`** (—â–æ –≤–∏ **–≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –±—É–¥–µ—Ç–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏ —Ç–∞–º**). –¶–µ–π —Ä–µ–∂–∏–º **–ø–µ—Ä–µ–≤—ñ—Ä—è—î –¥–æ–∑–≤–æ–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** –¥–ª—è –¥–æ–∑–≤–æ–ª—É –∞–±–æ –∑–∞–±–æ—Ä–æ–Ω–∏ –¥—ñ—ó.

{% hint style="warning" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ **–∞–Ω–æ–Ω—ñ–º–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —É–≤—ñ–º–∫–Ω–µ–Ω–∞**, **–∞–Ω–æ–Ω—ñ–º–Ω–∏–π –¥–æ—Å—Ç—É–ø** –º–æ–∂–µ **–Ω–µ –º–∞—Ç–∏ –∂–æ–¥–Ω–∏—Ö –¥–æ–∑–≤–æ–ª—ñ–≤** –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—É–¥—å-—è–∫–æ—ó –¥—ñ—ó.
{% endhint %}

–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ webhook –º–æ–∂–µ –±—É—Ç–∏ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **–ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `--authorization-mode=Webhook`** –∞–±–æ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª –∑:
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
The kubelet –≤–∏–∫–ª–∏–∫–∞—î **`SubjectAccessReview`** API –Ω–∞ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ–º—É API —Å–µ—Ä–≤–µ—Ä—ñ, —â–æ–± **–≤–∏–∑–Ω–∞—á–∏—Ç–∏**, —á–∏ –∫–æ–∂–µ–Ω –∑–∞–ø–∏—Ç —î **–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–º.**

Kubelet –∞–≤—Ç–æ—Ä–∏–∑—É—î API –∑–∞–ø–∏—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ç–æ–π –∂–µ –ø—ñ–¥—Ö—ñ–¥ [–∞—Ç—Ä–∏–±—É—Ç—ñ–≤ –∑–∞–ø–∏—Ç—É](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes), —â–æ –π apiserver:

* **–î—ñ—è**

| HTTP verb | request verb                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (–¥–ª—è –æ–∫—Ä–µ–º–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤), list (–¥–ª—è –∫–æ–ª–µ–∫—Ü—ñ–π, –≤–∫–ª—é—á–∞—é—á–∏ –ø–æ–≤–Ω–∏–π –≤–º—ñ—Å—Ç –æ–±'—î–∫—Ç–∞), watch (–¥–ª—è —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞ –æ–∫—Ä–µ–º–∏–º —Ä–µ—Å—É—Ä—Å–æ–º –∞–±–æ –∫–æ–ª–µ–∫—Ü—ñ—î—é —Ä–µ—Å—É—Ä—Å—ñ–≤) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (–¥–ª—è –æ–∫—Ä–µ–º–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤), deletecollection (–¥–ª—è –∫–æ–ª–µ–∫—Ü—ñ–π)                                                                                         |

* **–†–µ—Å—É—Ä—Å**, —â–æ —Å–ø—ñ–ª–∫—É—î—Ç—å—Å—è –∑ Kubelet api, —î **–∑–∞–≤–∂–¥–∏** **–≤—É–∑–ª–∞–º–∏**, –∞ **–ø—ñ–¥—Ä–µ—Å—É—Ä—Å** **–≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è** –∑ —à–ª—è—Ö—É –≤—Ö—ñ–¥–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É:

| Kubelet API  | —Ä–µ—Å—É—Ä—Å | –ø—ñ–¥—Ä–µ—Å—É—Ä—Å |
| ------------ | -------- | ----------- |
| /stats/\*    | –≤—É–∑–ª–∏    | stats       |
| /metrics/\*  | –≤—É–∑–ª–∏    | metrics     |
| /logs/\*     | –≤—É–∑–ª–∏    | log         |
| /spec/\*     | –≤—É–∑–ª–∏    | spec        |
| _–≤—Å—ñ —ñ–Ω—à—ñ_   | –≤—É–∑–ª–∏    | proxy       |

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∑–∞–ø–∏—Ç –Ω–∞–º–∞–≥–∞–≤—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –ø–æ–¥–∏ kubelet –±–µ–∑ –¥–æ–∑–≤–æ–ª—É:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* –ú–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ **–ó–∞–±–æ—Ä–æ–Ω–µ–Ω–æ**, —Ç–æ–º—É –∑–∞–ø–∏—Ç **–ø—Ä–æ–π—à–æ–≤ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó**. –Ø–∫—â–æ –± –Ω—ñ, –º–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –± –ª–∏—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è `–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ`.
* –ú–∏ –º–æ–∂–µ–º–æ –±–∞—á–∏—Ç–∏ **—ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** (–≤ –¥–∞–Ω–æ–º—É –≤–∏–ø–∞–¥–∫—É –∑ —Ç–æ–∫–µ–Ω–∞)
* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —è–∫ **—Ä–µ—Å—É—Ä—Å** –±—É–≤ **–≤—É–∑–ª–∞–º–∏** —ñ **—Å—É–±—Ä–µ—Å—É—Ä—Å** **–ø—Ä–æ–∫—Å—ñ** (—â–æ –º–∞—î —Å–µ–Ω—Å –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é)

## References

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
