# Kubelet Authentication & Authorization

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Kubelet Authentication <a href="#kubelet-authentication" id="kubelet-authentication"></a>

[**Dalla documentazione:**](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

Per impostazione predefinita, le richieste all'endpoint HTTPS del kubelet che non vengono rifiutate da altri metodi di autenticazione configurati vengono trattate come richieste anonime, e viene assegnato un **nome utente di `system:anonymous`** e un **gruppo di `system:unauthenticated`**.

I **3** metodi di **autenticazione** sono:

* **Anonimo** (predefinito): Usa impostando il parametro **`--anonymous-auth=true` o la configurazione:**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: Questo **abiliter√†** i token **API bearer** di kubectl come autorizzazione (qualsiasi token valido sar√† valido). Abilitare con:
* assicurarsi che il gruppo API `authentication.k8s.io/v1beta1` sia abilitato nel server API
* avviare il kubelet con i flag **`--authentication-token-webhook`** e **`--kubeconfig`** oppure utilizzare la seguente impostazione:
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
Il kubelet chiama l'**`TokenReview` API** sul server API configurato per **determinare le informazioni dell'utente** dai token bearer
{% endhint %}

* **Certificati client X509:** Consentono di autenticarsi tramite certificati client X509
* consulta la [documentazione sull'autenticazione dell'apiserver](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) per ulteriori dettagli
* avvia il kubelet con il flag `--client-ca-file`, fornendo un bundle CA per verificare i certificati client. Oppure con la configurazione:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubelet Authorization <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Qualsiasi richiesta che √® stata autenticata con successo (inclusa una richiesta anonima) **√® quindi autorizzata**. La modalit√† di autorizzazione **predefinita** √® **`AlwaysAllow`**, che **consente tutte le richieste**.

Tuttavia, l'altro valore possibile √® **`webhook`** (che √® quello che troverai **principalmente l√† fuori**). Questa modalit√† **verificher√† i permessi dell'utente autenticato** per consentire o negare un'azione.

{% hint style="warning" %}
Nota che anche se l'**autenticazione anonima √® abilitata**, l'**accesso anonimo** potrebbe **non avere alcun permesso** per eseguire alcuna azione.
{% endhint %}

L'autorizzazione tramite webhook pu√≤ essere configurata utilizzando il **parametro `--authorization-mode=Webhook`** o tramite il file di configurazione con:
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
Il kubelet chiama l'API **`SubjectAccessReview`** sul server API configurato per **determinare** se ogni richiesta √® **autorizzata.**

Il kubelet autorizza le richieste API utilizzando lo stesso approccio degli [attributi di richiesta](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) come l'apiserver:

* **Azione**

| Verb HTTP  | verbo di richiesta                                                                                                                                                  |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | create                                                                                                                                                              |
| GET, HEAD  | get (per risorse individuali), list (per collezioni, incluso il contenuto completo dell'oggetto), watch (per monitorare una risorsa individuale o una collezione di risorse) |
| PUT        | update                                                                                                                                                              |
| PATCH      | patch                                                                                                                                                               |
| DELETE     | delete (per risorse individuali), deletecollection (per collezioni)                                                                                               |

* La **risorsa** che comunica con l'API Kubelet √® **sempre** **nodes** e il **subresource** √® **determinato** dal percorso della richiesta in arrivo:

| API Kubelet | risorsa | subresource |
| ----------- | ------- | ----------- |
| /stats/\*   | nodes   | stats       |
| /metrics/\* | nodes   | metrics     |
| /logs/\*    | nodes   | log         |
| /spec/\*    | nodes   | spec        |
| _tutte le altre_ | nodes   | proxy       |

Ad esempio, la seguente richiesta ha tentato di accedere alle informazioni sui pod di kubelet senza autorizzazione:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* Abbiamo ricevuto un **Forbidden**, quindi la richiesta **ha superato il controllo di autenticazione**. Altrimenti, avremmo ricevuto solo un messaggio `Unauthorised`.
* Possiamo vedere il **nome utente** (in questo caso dal token)
* Controlla come la **risorsa** fosse **nodes** e il **subresource** **proxy** (il che ha senso con le informazioni precedenti)

## Riferimenti

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos su github.

</details>
{% endhint %}
