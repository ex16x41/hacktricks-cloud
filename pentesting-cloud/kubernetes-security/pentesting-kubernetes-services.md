# Kubernetes Hizmetlerinin Pentesting'i

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

Kubernetes, **belirli aÄŸ hizmetlerini** kullanan ve muhtemelen Ä°nternete **aÃ§Ä±k veya bir pod'u ele geÃ§irdikten sonra iÃ§ aÄŸda bulabileceÄŸiniz** birkaÃ§ hizmet kullanÄ±r.

## OSINT ile AÃ§Ä±kta Bulunan Pod'larÄ± Bulma

Bir yol, `Identity LIKE "k8s.%.com"` ifadesini [crt.sh](https://crt.sh) sitesinde aramaktÄ±r ve kubernetes ile ilgili alt alanlarÄ± bulmaktÄ±r. BaÅŸka bir yol ise `"k8s.%.com"` ifadesini github'da aramak ve bu ifadeyi iÃ§eren **YAML dosyalarÄ±nÄ±** aramaktÄ±r.

## Kubernetes Hizmetlerini NasÄ±l AÃ§Ä±ÄŸa Ã‡Ä±karÄ±r

Hizmetleri **genel olarak aÃ§Ä±ÄŸa Ã§Ä±karabilen Kubernetes'in** nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamanÄ±z faydalÄ± olabilir:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Port TaramasÄ± ile AÃ§Ä±kta Bulunan Pod'larÄ± Bulma

AÅŸaÄŸÄ±daki portlar bir Kubernetes kÃ¼mesinde aÃ§Ä±k olabilir:

| Port            | Ä°ÅŸlem          | AÃ§Ä±klama                                                               |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API port                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Konteyner metrikleri                                                   |
| 6443/TCP        | kube-apiserver | Kubernetes API port                                                    |
| 8443/TCP        | kube-apiserver | Minikube API port                                                      |
| 8080/TCP        | kube-apiserver | GÃ¼vensiz API portu                                                     |
| 10250/TCP       | kubelet        | Tam eriÅŸim saÄŸlayan HTTPS API                                          |
| 10255/TCP       | kubelet        | Kimlik doÄŸrulamasÄ±z salt okunur HTTP portu: podlar, Ã§alÄ±ÅŸan podlar ve dÃ¼ÄŸÃ¼m durumu |
| 10256/TCP       | kube-proxy     | Kube Proxy saÄŸlÄ±k kontrol sunucusu                                     |
| 9099/TCP        | calico-felix   | Calico iÃ§in saÄŸlÄ±k kontrol sunucusu                                    |
| 6782-4/TCP      | weave          | Metrikler ve uÃ§ noktalar                                               |
| 30000-32767/TCP | NodePort       | Hizmetlere proxy yapar                                                 |
| 44134/TCP       | Tiller         | Helm hizmeti dinleme                                                   |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Bu genellikle yÃ¶neticilerin **`kubectl`** aracÄ±nÄ± kullanarak konuÅŸtuÄŸu **API Kubernetes servisi**'dir.

**YaygÄ±n portlar: 6443 ve 443**, ancak minikube'da 8443 ve gÃ¼vensiz olarak 8080 de kullanÄ±labilir.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**AÅŸaÄŸÄ±daki sayfayÄ± kontrol edin ve bu servisle iletiÅŸim kurarak hassas verileri nasÄ±l elde edeceÄŸinizi ve hassas iÅŸlemleri nasÄ±l gerÃ§ekleÅŸtireceÄŸinizi Ã¶ÄŸrenin:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Bu servis **kÃ¼menin her dÃ¼ÄŸÃ¼mÃ¼nde Ã§alÄ±ÅŸÄ±r**. Bu, dÃ¼ÄŸÃ¼m iÃ§indeki **pods'larÄ± kontrol edecek** olan servistir. **kube-apiserver** ile iletiÅŸim kurar.

Bu servisi aÃ§Ä±k bulursanÄ±z, **kimlik doÄŸrulamasÄ±z RCE** bulmuÅŸ olabilirsiniz.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
EÄŸer yanÄ±t `Yetkisiz` ise kimlik doÄŸrulamasÄ± gerektirir.

EÄŸer dÃ¼ÄŸÃ¼mleri listeleyebiliyorsanÄ±z, kubelet uÃ§ noktalarÄ±nÄ±n bir listesini alabilirsiniz:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Sadece Okuma)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller, Kubernetes'de kullanÄ±lan bir bileÅŸen olan Helm'in eski bir sÃ¼rÃ¼mÃ¼dÃ¼r. Kubernetes sÃ¼rÃ¼m 1.14'ten itibaren Tiller kullanÄ±mÄ± Ã¶nerilmemektedir. Tiller, Kubernetes kÃ¼mesindeki uygulamalarÄ± yÃ¶netmek iÃ§in kullanÄ±lan bir araÃ§tÄ±r. Ancak gÃ¼venlik endiÅŸeleri nedeniyle Helm v3'te Tiller kaldÄ±rÄ±lmÄ±ÅŸtÄ±r.
```
helm --host tiller-deploy.kube-system:44134 version
```
### cAdvisor

Metrikleri toplamak iÃ§in kullanÄ±ÅŸlÄ± bir hizmet.
```
curl -k https://<IP Address>:4194
```
### NodePort

Bir port **NodePort** aracÄ±lÄ±ÄŸÄ±yla tÃ¼m dÃ¼ÄŸÃ¼mlerde aÃ§Ä±ldÄ±ÄŸÄ±nda, aynÄ± port tÃ¼m dÃ¼ÄŸÃ¼mlerde aÃ§Ä±lÄ±r ve trafiÄŸi ilan edilen **Service**'e yÃ¶nlendirir. VarsayÄ±lan olarak bu port **30000-32767 aralÄ±ÄŸÄ±nda** olacaktÄ±r. Bu nedenle, kontrol edilmemiÅŸ yeni servislere bu portlar aracÄ±lÄ±ÄŸÄ±yla eriÅŸilebilir.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Hassas YanlÄ±ÅŸ YapÄ±landÄ±rmalar

### Kube-apiserver Anonim EriÅŸim

**kube-apiserver API uÃ§ noktalarÄ±na anonim eriÅŸim izin verilmez**. Ancak bazÄ± uÃ§ noktalarÄ± kontrol edebilirsiniz:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **ETCD Anonim EriÅŸim KontrolÃ¼**

ETCD, kÃ¼me sÄ±rlarÄ±nÄ±, yapÄ±landÄ±rma dosyalarÄ±nÄ± ve daha **hassas verileri** depolar. **VarsayÄ±lan olarak**, ETCD'ye **anonim olarak** eriÅŸilemez, ancak her zaman kontrol etmek iyidir.

ETCD'ye anonim eriÅŸim saÄŸlanabiliyorsa, [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **aracÄ±nÄ± kullanmanÄ±z gerekebilir**. AÅŸaÄŸÄ±daki komut tÃ¼m depolanan anahtarlarÄ± alacaktÄ±r:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[**Kubelet belgeleri**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) varsayÄ±lan olarak servise **anonim eriÅŸime izin verildiÄŸini** aÃ§Ä±klar:

> Kubelet sunucusuna anonim istekleri etkinleÅŸtirir. BaÅŸka bir kimlik doÄŸrulama yÃ¶ntemi tarafÄ±ndan reddedilmeyen istekler anonim istekler olarak kabul edilir. Anonim isteklerin bir kullanÄ±cÄ± adÄ± `system:anonymous` ve bir grup adÄ± `system:unauthenticated`'dir.

**Kubelet API'nin kimlik doÄŸrulama ve yetkilendirme** nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± daha iyi anlamak iÃ§in bu sayfaya bakÄ±n:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** servisinin **API'si belgelenmemiÅŸtir**, ancak kaynak kodu burada bulunabilir ve aÃ§Ä±k uÃ§ noktalarÄ±nÄ± bulmak **ÅŸu ÅŸekilde kolaydÄ±r**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
TÃ¼mÃ¼ ilginÃ§ gÃ¶rÃ¼nÃ¼yor.

Kubeletlerle ve uÃ§ noktalarÄ±yla etkileÅŸim kurmak iÃ§in [**Kubeletctl**](https://github.com/cyberark/kubeletctl) aracÄ±nÄ± kullanabilirsiniz.

#### /pods

Bu uÃ§ nokta, pod'larÄ± ve iÃ§erdikleri konteynerleri listeler:
```bash
kubeletctl pods
```
#### /exec

Bu uÃ§ nokta herhangi bir konteyner iÃ§inde kodu Ã§ok kolay bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rmaya olanak tanÄ±r:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Bu saldÄ±rÄ±yÄ± Ã¶nlemek iÃ§in _**kubelet**_ servisinin `--anonymous-auth false` parametresi ile Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± ve servisin aÄŸ dÃ¼zeyinde ayrÄ±lmasÄ± gerekmektedir.
{% endhint %}

### **Kubelet (Sadece Okuma Portu) Bilgi SÄ±zdÄ±rma KontrolÃ¼**

Bir **kubelet sadece okuma portu** aÃ§Ä±k olduÄŸunda, yetkisiz kiÅŸilerin API'den bilgi almasÄ± mÃ¼mkÃ¼n hale gelir. Bu portun aÃ§Ä±lmasÄ±, Ã§eÅŸitli **kÃ¼me yapÄ±landÄ±rma unsurlarÄ±nÄ±n** ifÅŸa edilmesine neden olabilir. Bilgiler, **pod isimleri, iÃ§ dosyalarÄ±n konumlarÄ± ve diÄŸer yapÄ±landÄ±rmalar** gibi kritik olmayabilir, ancak bu bilgilerin ifÅŸasÄ± hala bir gÃ¼venlik riski oluÅŸturur ve kaÃ§Ä±nÄ±lmalÄ±dÄ±r.

Bu zafiyetin nasÄ±l sÃ¶mÃ¼rÃ¼lebileceÄŸine dair bir Ã¶rnek, uzaktan bir saldÄ±rganÄ±n belirli bir URL'ye eriÅŸmesini iÃ§erir. `http://<external-IP>:10255/pods` adresine giderek, saldÄ±rgan kubeletten hassas bilgileri potansiyel olarak alabilir:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referanslar

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Destek HackTricks</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}
