# Kubelet èªè¨¼ & èªå¯

{% hint style="success" %}
AWS ãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP ãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discord ã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegram ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚**
* ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks) ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã« PR ã‚’æå‡ºã™ã‚‹ã€‚

</details>
{% endhint %}

## Kubelet èªè¨¼ <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰:](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ä»–ã®æ§‹æˆã•ã‚ŒãŸèªè¨¼æ–¹æ³•ã§æ‹’å¦ã•ã‚Œãªã„ kubelet ã® HTTPS ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯åŒ¿åãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦æ‰±ã‚ã‚Œã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒ `system:anonymous`** ã§ã€**ã‚°ãƒ«ãƒ¼ãƒ—ãŒ `system:unauthenticated`** ã¨ã—ã¦ä¸ãˆã‚‰ã‚Œã¾ã™ã€‚

èªè¨¼æ–¹æ³•ã¯ **3** ã¤ã‚ã‚Šã¾ã™:

* **åŒ¿å** (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ): ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ **`--anonymous-auth=true` ã‚’è¨­å®šã™ã‚‹ã‹ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™:
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: ã“ã‚Œã«ã‚ˆã‚Šã€kubectl **APIãƒ™ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³**ã‚’èªè¨¼ã¨ã—ã¦**æœ‰åŠ¹ã«**ã—ã¾ã™ï¼ˆæœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã¯ã™ã¹ã¦æœ‰åŠ¹ã§ã™ï¼‰ã€‚æ¬¡ã®ã‚ˆã†ã«è¨±å¯ã—ã¾ã™ï¼š
* APIã‚µãƒ¼ãƒãƒ¼ã§`authentication.k8s.io/v1beta1` APIã‚°ãƒ«ãƒ¼ãƒ—ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™
* kubeletã‚’**`--authentication-token-webhook`**ãŠã‚ˆã³**`--kubeconfig`**ãƒ•ãƒ©ã‚°ã§èµ·å‹•ã™ã‚‹ã‹ã€æ¬¡ã®è¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ï¼š
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
kubeletã¯ã€æ§‹æˆã•ã‚ŒãŸAPIã‚µãƒ¼ãƒãƒ¼ä¸Šã§**`TokenReview` API**ã‚’å‘¼ã³å‡ºã—ã¦ã€ãƒ™ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰**ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ±ºå®š**ã—ã¾ã™ã€‚
{% endhint %}

* **X509ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸:** X509ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã‚’ä½¿ç”¨ã—ã¦èªè¨¼ã‚’è¨±å¯ã—ã¾ã™
* è©³ç´°ã«ã¤ã„ã¦ã¯ã€[apiserverèªè¨¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs)ã‚’å‚ç…§ã—ã¦ãã ã•ã„
* `--client-ca-file`ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®CAãƒãƒ³ãƒ‰ãƒ«ã‚’æä¾›ã—ã¦kubeletã‚’èµ·å‹•ã—ã¾ã™ã€‚ã¾ãŸã¯ã€æ¬¡ã®æ§‹æˆã§é–‹å§‹ã—ã¾ã™:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubeletã®èªå¯ <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**æ­£å¸¸ã«èªè¨¼ã•ã‚ŒãŸ**ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆåŒ¿åãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å«ã‚€ï¼‰**ã¯ãã®å¾Œèªå¯ã•ã‚Œã¾ã™**ã€‚**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**ã®èªå¯ãƒ¢ãƒ¼ãƒ‰ã¯**`AlwaysAllow`**ã§ã€**ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯**ã—ã¾ã™ã€‚

ãŸã ã—ã€ä»–ã®å¯èƒ½ãªå€¤ã¯**`webhook`**ã§ã™ï¼ˆ**ã»ã¨ã‚“ã©ã®å ´æ‰€ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹**ã‚‚ã®ã§ã™ï¼‰ã€‚ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€**èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯**ã—ã¦ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨±å¯ã¾ãŸã¯æ‹’å¦ã—ã¾ã™ã€‚

{% hint style="warning" %}
**åŒ¿åèªè¨¼ãŒæœ‰åŠ¹**ã«ãªã£ã¦ã„ã¦ã‚‚ã€**åŒ¿åã‚¢ã‚¯ã‚»ã‚¹**ã¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®**æ¨©é™ã‚’æŒã£ã¦ã„ãªã„**å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

Webhookã‚’ä»‹ã—ãŸèªå¯ã¯ã€**`--authorization-mode=Webhook`**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€æ¬¡ã®ã‚ˆã†ã«æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»‹ã—ã¦è¡Œã†ã“ã¨ãŒã§ãã¾ã™ï¼š
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
kubeletã¯ã€å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ**èªå¯**ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’åˆ¤æ–­ã™ã‚‹ãŸã‚ã«ã€è¨­å®šã•ã‚ŒãŸAPIã‚µãƒ¼ãƒãƒ¼ä¸Šã§**`SubjectAccessReview`** APIã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

kubeletã¯ã€APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’èªå¯ã™ã‚‹éš›ã«ã€apiserverã¨åŒã˜[ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±æ€§](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes)ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¾ã™:

* **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**

| HTTPå‹•è© | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‹•è©                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (å€‹ã€…ã®ãƒªã‚½ãƒ¼ã‚¹ç”¨), list (ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã€å®Œå…¨ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å«ã‚€), watch (å€‹ã€…ã®ãƒªã‚½ãƒ¼ã‚¹ã¾ãŸã¯ãƒªã‚½ãƒ¼ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç›£è¦–ã™ã‚‹ãŸã‚) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (å€‹ã€…ã®ãƒªã‚½ãƒ¼ã‚¹ç”¨), deletecollection (ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç”¨)                                                                                         |

* Kubelet APIã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹**ãƒªã‚½ãƒ¼ã‚¹**ã¯å¸¸ã«**nodes**ã§ã‚ã‚Šã€**ã‚µãƒ–ãƒªã‚½ãƒ¼ã‚¹**ã¯ç€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ã‚¹ã‹ã‚‰**æ±ºå®š**ã•ã‚Œã¾ã™:

| Kubelet API  | ãƒªã‚½ãƒ¼ã‚¹ | ã‚µãƒ–ãƒªã‚½ãƒ¼ã‚¹ |
| ------------ | -------- | ----------- |
| /stats/\*    | nodes    | stats       |
| /metrics/\*  | nodes    | metrics     |
| /logs/\*     | nodes    | log         |
| /spec/\*     | nodes    | spec        |
| ãã®ä»–ã™ã¹ã¦ | nodes    | proxy       |

ãŸã¨ãˆã°ã€æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€è¨±å¯ãªãkubeletã®ãƒãƒƒãƒ‰æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸ:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* ç§ãŸã¡ã¯**Forbidden**ã‚’å—ã‘å–ã£ãŸã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯**èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸ**ã€‚ãã†ã§ãªã‘ã‚Œã°ã€å˜ã«`Unauthorised`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã£ã¦ã„ãŸã§ã—ã‚‡ã†ã€‚
* **ãƒ¦ãƒ¼ã‚¶ãƒ¼å**ï¼ˆã“ã®å ´åˆã¯ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ï¼‰
* **ãƒªã‚½ãƒ¼ã‚¹**ãŒ**nodes**ã§ã‚ã‚Šã€**ã‚µãƒ–ãƒªã‚½ãƒ¼ã‚¹**ãŒ**proxy**ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆå‰ã®æƒ…å ±ã¨ä¸€è‡´ã—ã¾ã™ï¼‰

## å‚è€ƒæ–‡çŒ®

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**è³¼èª­ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ **ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦**ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰**ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
