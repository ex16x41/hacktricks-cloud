# Az - Neautentifikovano Enumerisanje & PoÄetni pristup

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim StruÄnjak (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim StruÄnjak (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Azure Tenant

### Enumeracija Tenanta

Postoje neke **javne Azure API-je** za koje samo poznavanje **domena tenanta** omoguÄ‡ava napadaÄu da pretraÅ¾uje viÅ¡e informacija o njemu.\
MoÅ¾ete direktno pretraÅ¾ivati API ili koristiti PowerShell biblioteku [**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | Informacije                                                                                                                                                                                                                                           | Funkcija AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informacije za prijavljivanje**, ukljuÄujuÄ‡i ID tenanta                                                                                                                                                                                              | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Svi domeni** tenanta                                                                                                                                                                                                                               | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informacije za prijavljivanje</strong> tenanta, ukljuÄujuÄ‡i ime tenanta i domen <strong>tip autentifikacije.</strong><br>Ako je <code>NameSpaceType</code> <strong><code>Managed</code></strong>, to znaÄi da se koristi <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informacije za prijavljivanje, ukljuÄujuÄ‡i **informacije o Desktop SSO-u**                                                                                                                                                                             | `Get-AADIntLoginInformation -UserName <UserName>` |

MoÅ¾ete pretraÅ¾iti sve informacije o Azure tenantu sa **samo jednom komandom** [**AADInternals**](https://github.com/Gerenios) **biblioteke**:
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Primer izlaza informacija o Azure zakupcu:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
MoguÄ‡e je posmatrati detalje o imenu zakupca, ID-u i imenu "brenda". Dodatno, prikazan je status Desktop Single Sign-On (SSO), poznat i kao [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso). Kada je omoguÄ‡ena, ova funkcija olakÅ¡ava odreÄ‘ivanje prisustva (enumeracije) odreÄ‘enog korisnika unutar ciljne organizacije.

Osim toga, izlaz prikazuje imena svih verifikovanih domena povezanih sa ciljnim zakupcem, zajedno sa njihovim odgovarajuÄ‡im tipovima identiteta. U sluÄaju federiranih domena, potpuno kvalifikovano ime domena (FQDN) identitetskog provajdera u upotrebi, obiÄno ADFS servera, takoÄ‘e je otkriveno. Kolona "MX" specificira da li se e-poÅ¡ta usmerava ka Exchange Online-u, dok kolona "SPF" oznaÄava navoÄ‘enje Exchange Online-a kao poÅ¡iljaoca e-poÅ¡te. VaÅ¾no je napomenuti da trenutna funkcija izviÄ‘anja ne analizira "include" izjave unutar SPF zapisa, Å¡to moÅ¾e rezultirati laÅ¾nim negativima.

### Enumeracija Korisnika

MoguÄ‡e je **proveriti da li korisniÄko ime postoji** unutar zakupca. To ukljuÄuje i **gostujuÄ‡e korisnike**, Äije korisniÄko ime ima format:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
Email adresa je korisnikova email adresa gde je znak "@" zamenjen sa donjom crtom "\_".

Sa [**AADInternals**](https://github.com/Gerenios/AADInternals), moÅ¾ete lako proveriti da li korisnik postoji ili ne:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## Neautentifikovano nabrajanje i poÄetni ulaz

U ovom scenariju, napadaÄ Ä‡e koristiti neautentifikovane metode za nabrajanje resursa i pristup poÄetnom ulazu u Azure okruÅ¾enje.

### Nabrajanje resursa

Nabrajanje resursa moÅ¾e biti izvrÅ¡eno koriÅ¡Ä‡enjem razliÄitih tehnika kao Å¡to su pretraga javno dostupnih informacija, upotreba API-ja za nabrajanje resursa ili skeniranje IP adresa za identifikaciju dostupnih resursa.

### Pristup poÄetnom ulazu

Nakon Å¡to su resursi uspeÅ¡no nabrojani, napadaÄ moÅ¾e iskoristiti ove informacije za pronalaÅ¾enje poÄetnog ulaza u Azure okruÅ¾enje. To moÅ¾e ukljuÄivati pronalaÅ¾enje nezaÅ¡tiÄ‡enih servisa, slabe lozinke ili ranjivosti koje omoguÄ‡avaju pristup sistemu.
```
UserName         Exists
--------         ------
user@company.com True
```
MoÅ¾ete takoÄ‘e koristiti tekstualni fajl koji sadrÅ¾i jednu email adresu po redu:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Postoje **tri razliÄite metode enumeracije** koje moÅ¾ete odabrati:

| Metoda    | Opis                                                                                                                                                                                                   |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normalna  | Ovo se odnosi na GetCredentialType API pomenut gore. Podrazumevana metoda.                                                                                                                              |
| Prijava   | <p>Ova metoda pokuÅ¡ava da se prijavi kao korisnik.<br><strong>Napomena:</strong> upiti Ä‡e biti zabeleÅ¾eni u logovima prijava.</p>                                                                       |
| Autologon | <p>Ova metoda pokuÅ¡ava da se prijavi kao korisnik putem autologon endpointa.<br><strong>Upiti nisu zabeleÅ¾eni</strong> u logovima prijava! Stoga dobro funkcioniÅ¡e i za napade poput prskanja lozinki i napada grubom silom.</p> |

Nakon otkrivanja validnih korisniÄkih imena moÅ¾ete dobiti **informacije o korisniku** sa:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Skripta [**o365creeper**](https://github.com/LMGsec/o365creeper) takoÄ‘e vam omoguÄ‡ava da otkrijete **da li je e-poÅ¡ta validna**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Enumeracija korisnika putem Microsoft Teams-a**

JoÅ¡ jedan dobar izvor informacija je Microsoft Teams.

API Microsoft Teams-a omoguÄ‡ava pretragu korisnika. Konkretno, endpointovi "externalsearchv3" i "searchUsers" mogu se koristiti za zahtevanje opÅ¡tih informacija o korisniÄkim nalozima u Teams-u.

Na osnovu odgovora API-ja moguÄ‡e je razlikovati nepostojeÄ‡e korisnike od postojeÄ‡ih korisnika koji imaju vaÅ¾eÄ‡u pretplatu na Teams.

Skript [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) moÅ¾e se koristiti za proveru datog skupa korisniÄkih imena prema Teams API-ju.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## Neautentifikovano nabrajanje i poÄetni ulaz

U ovom scenariju, cilj je identifikovati i prikupiti informacije o Azure okruÅ¾enju bez potrebe za autentifikacijom. Ovo moÅ¾e ukljuÄivati otkrivanje javno dostupnih resursa, servisa, informacija o konfiguraciji i drugih korisnih detalja koji mogu pomoÄ‡i u kasnijim fazama testiranja penetracije. Ove informacije mogu biti korisne za identifikaciju potencijalnih taÄaka ulaza ili slabih mesta u sistemu.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
TakoÄ‘e je moguÄ‡e nabrojati informacije o dostupnosti postojeÄ‡ih korisnika kao Å¡to su:

- Dostupan
- Odsutan
- Ne uznemiravaj
- Zauzet
- Van mreÅ¾e

Ako je konfigurisana **poruka van kancelarije**, moguÄ‡e je povratiti poruku pomoÄ‡u TeamsEnum-a. Ako je navedena izlazna datoteka, poruke van kancelarije automatski se Äuvaju u JSON datoteci:
```
jq . teamsenum-output.json
```
## Neautentifikovano nabrajanje i poÄetni ulaz

U ovom scenariju, napadaÄ Ä‡e iskoristiti neautentifikovano nabrajanje resursa i ranjivost poÄetnog ulaza kako bi dobio pristup Azure okruÅ¾enju.

### Koraci napada:

1. **Nabrajanje resursa**: NapadaÄ Ä‡e koristiti alate poput `azuriraj` ili `azuriraj-cli` za nabrajanje resursa u Azure okruÅ¾enju bez potrebe za autentifikacijom.

2. **Identifikacija osetljivih informacija**: NapadaÄ Ä‡e identifikovati osetljive informacije kao Å¡to su lozinke, kljuÄevi ili druge kritiÄne informacije.

3. **Eksploatacija ranjivosti poÄetnog ulaza**: KoristeÄ‡i otkrivene osetljive informacije, napadaÄ Ä‡e iskoristiti ranjivost poÄetnog ulaza kako bi dobio pristup Azure okruÅ¾enju.

### Mere zaÅ¡tite:

- Redovno aÅ¾uriranje i praÄ‡enje Azure okruÅ¾enja radi otkrivanja neobiÄnih aktivnosti.
- KoriÅ¡Ä‡enje viÅ¡efaktorskog autentifikovanja radi dodatne sigurnosti.
- Implementacija principa najmanjih privilegija kako bi se smanjio rizik od zloupotrebe privilegija.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Azure Usluge

Sada kada znamo **domene koje Azure zakupac** koristi, vreme je da pokuÅ¡amo da pronaÄ‘emo **izloÅ¾ene Azure usluge**.

MoÅ¾ete koristiti metod iz [**MicroBurst**](https://github.com/NetSPI/MicroBurst) za ovaj cilj. Ova funkcija Ä‡e pretraÅ¾iti osnovno ime domena (i nekoliko permutacija) u nekoliko **domena Azure usluga:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Otvoreno skladiÅ¡tenje

MoÅ¾ete otkriti otvoreno skladiÅ¡tenje pomoÄ‡u alata poput [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) koji Ä‡e koristiti datoteku **`Microburst/Misc/permitations.txt`** za generisanje permutacija (vrlo jednostavno) kako bi pokuÅ¡ao **pronaÄ‡i otvorene skladiÅ¡ne naloge**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URL-ovi

_**URL sa deljenim pristupom**_ (SAS) je URL koji **omoguÄ‡ava pristup** odreÄ‘enom delu skladiÅ¡nog naloga (moÅ¾e biti cela kontejner, datoteka...) sa odreÄ‘enim dozvolama (Äitanje, pisanje...) nad resursima. Ako pronaÄ‘ete procureli URL, moÅ¾ete pristupiti osetljivim informacijama, izgledaju ovako (ovo je za pristup kontejneru, ako je samo davao pristup datoteci, putanja URL-a Ä‡e takoÄ‘e sadrÅ¾ati tu datoteku):

`https://<ime_skladiÅ¡nog_naloga>.blob.core.windows.net/novikontejner?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Koristite [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) za pristup podacima

## Kompromitovanje Poverljivih Podataka

### FiÅ¡ing

* [**UobiÄajeni FiÅ¡ing**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (poverljivi podaci ili OAuth aplikacija -[Napad na neovlaÅ¡Ä‡eno davanje saglasnosti](az-illicit-consent-grant.md)-)
* [**FiÅ¡ing za Autentifikaciju Koda ureÄ‘aja**](az-device-code-authentication-phishing.md)

### Prskanje Lozinki / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Reference

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim Ekspert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim Ekspert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
