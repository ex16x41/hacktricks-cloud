# Az - Kimlik DoÄŸrulamasÄ±z Enum ve BaÅŸlangÄ±Ã§ GiriÅŸi

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

## Azure KiracÄ±

### KiracÄ± NumaralandÄ±rma

Sadece **kiracÄ±nÄ±n alan adÄ±nÄ±** bilen bir saldÄ±rgan, daha fazla bilgi toplamak iÃ§in sorgulayabileceÄŸi **bazÄ±** **genel Azure API'leri** vardÄ±r.\
API'yi doÄŸrudan sorgulayabilir veya PowerShell kÃ¼tÃ¼phanesi [**AADInternals**](https://github.com/Gerenios)**'Ä± kullanabilirsiniz:**

| API                                                                  | Bilgi                                                                                                                                                                                                                                                | AADInternals iÅŸlevi                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **KiracÄ± kimlik bilgileri** dahil olmak Ã¼zere **GiriÅŸ bilgileri**                                                                                                                                                                                      | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | KiracÄ±nÄ±n **tÃ¼m alan adlarÄ±**                                                                                                                                                                                                                        | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p>KiracÄ±nÄ±n **GiriÅŸ bilgileri**, kiracÄ± AdÄ± ve alan adÄ± dahil olmak Ã¼zere **giriÅŸ bilgileri**, <strong>kimlik doÄŸrulama tÃ¼rÃ¼.</strong><br>EÄŸer <code>NameSpaceType</code> **YÃ¶netilen** ise, bu **AzureAD**'nin kullanÄ±ldÄ±ÄŸÄ± anlamÄ±na gelir.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | GiriÅŸ bilgileri, **MasaÃ¼stÃ¼ SSO bilgileri** dahil                                                                                                                                                                                                    | `Get-AADIntLoginInformation -UserName <UserName>` |

Azure kiracÄ±sÄ±nÄ±n tÃ¼m bilgilerini **yalnÄ±zca** [**AADInternals**](https://github.com/Gerenios) **kÃ¼tÃ¼phanesinin bir komutu ile** sorgulayabilirsiniz:
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Azure kiracÄ± bilgileri Ã§Ä±ktÄ± Ã¶rneÄŸi:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Tenant'Ä±n adÄ±, kimliÄŸi ve "marka" adÄ± hakkÄ±nda ayrÄ±ntÄ±larÄ± gÃ¶zlemlemek mÃ¼mkÃ¼ndÃ¼r. AyrÄ±ca, MasaÃ¼stÃ¼ Tek Oturum AÃ§ma (SSO) durumu, ayrÄ±ca [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso) olarak bilinir, gÃ¶rÃ¼ntÃ¼lenir. Bu Ã¶zellik etkinleÅŸtirildiÄŸinde, bu Ã¶zellik hedef organizasyondaki belirli bir kullanÄ±cÄ±nÄ±n varlÄ±ÄŸÄ±nÄ±n belirlenmesini kolaylaÅŸtÄ±rÄ±r (enumarasyon).

AyrÄ±ca, Ã§Ä±ktÄ± hedef kiracÄ±yla iliÅŸkilendirilmiÅŸ tÃ¼m doÄŸrulanmÄ±ÅŸ alanlarÄ±n adlarÄ±nÄ± ve bunlarÄ±n ilgili kimlik tÃ¼rlerini sunar. Federasyonlu alanlar durumunda, genellikle bir ADFS sunucusu olan kullanÄ±lan kimlik saÄŸlayÄ±cÄ±sÄ±nÄ±n Tam Nitelikli Alan AdÄ± (FQDN) de aÃ§Ä±klanÄ±r. "MX" sÃ¼tunu e-postalarÄ±n Exchange Online'a yÃ¶nlendirilip yÃ¶nlendirilmediÄŸini belirtirken, "SPF" sÃ¼tunu Exchange Online'Ä± bir e-posta gÃ¶nderici olarak listeler. Mevcut keÅŸif iÅŸlevinin SPF kayÄ±tlarÄ±ndaki "include" ifadelerini ayrÄ±ÅŸtÄ±rmadÄ±ÄŸÄ±, bu durumun yanlÄ±ÅŸ negatiflere neden olabileceÄŸi Ã¶nemlidir.

### KullanÄ±cÄ± Enumarasyonu

Tenant iÃ§inde bir kullanÄ±cÄ± adÄ±nÄ±n var olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek mÃ¼mkÃ¼ndÃ¼r. Bu aynÄ± zamanda **konuk kullanÄ±cÄ±larÄ±** da iÃ§erir, bunlarÄ±n kullanÄ±cÄ± adÄ± ÅŸu formatta olabilir:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
E-posta, kullanÄ±cÄ±nÄ±n e-posta adresidir ve "@" iÅŸareti alt tire "_" ile deÄŸiÅŸtirilmiÅŸtir.

[**AADInternals**](https://github.com/Gerenios/AADInternals) ile kullanÄ±cÄ±nÄ±n var olup olmadÄ±ÄŸÄ±nÄ± kolayca kontrol edebilirsiniz:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## Azure Unauthenticated Enumeration and Initial Entry

### Unauthenticated Enumeration

1. **Service Discovery**: Utilize tools like `nmap`, `masscan`, and `shodan` to discover exposed services and endpoints.
   
2. **Storage Accounts**: Enumerate storage accounts using tools like `azcopy` and `Azure Storage Explorer` to identify publicly accessible data.

3. **Blob Containers**: Enumerate blob containers within storage accounts to identify sensitive data or misconfigurations.

4. **Web Applications**: Use tools like `dirb` or `gobuster` to discover web applications and directories that may contain vulnerabilities.

### Initial Entry

1. **Weak Credentials**: Attempt default or weak credentials on exposed services like RDP, SSH, or web applications.

2. **Phishing Attacks**: Send phishing emails to Azure users to obtain credentials or deliver payloads for initial access.

3. **Exploiting Misconfigurations**: Exploit misconfigurations in services like storage accounts or web applications to gain unauthorized access.

4. **Brute Force Attacks**: Conduct brute force attacks against login portals or services with weak authentication mechanisms.

5. **Social Engineering**: Gather information about Azure users through social engineering tactics to craft targeted attacks.
```
UserName         Exists
--------         ------
user@company.com True
```
AyrÄ±ca, her satÄ±rda bir e-posta adresi iÃ§eren bir metin dosyasÄ± da kullanabilirsiniz:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
**ÃœÃ§ farklÄ± numaralandÄ±rma yÃ¶ntemi** arasÄ±ndan seÃ§im yapabilirsiniz:

| YÃ¶ntem    | AÃ§Ä±klama                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Bu yukarÄ±da bahsedilen GetCredentialType API'sine atÄ±fta bulunur. VarsayÄ±lan yÃ¶ntem.                                                                                                                           |
| GiriÅŸ     | <p>Bu yÃ¶ntem, kullanÄ±cÄ± olarak giriÅŸ yapmaya Ã§alÄ±ÅŸÄ±r.<br><strong>Not:</strong> sorgular oturum aÃ§ma kayÄ±tlarÄ±na kaydedilecektir.</p>                                                                                       |
| Otomatik GiriÅŸ | <p>Bu yÃ¶ntem, kullanÄ±cÄ± olarak otomatik giriÅŸ noktasÄ± aracÄ±lÄ±ÄŸÄ±yla giriÅŸ yapmaya Ã§alÄ±ÅŸÄ±r.<br><strong>Sorgular</strong> oturum aÃ§ma kayÄ±tlarÄ±na kaydedilmez! Bu nedenle, parola pÃ¼skÃ¼rtme ve kaba kuvvet saldÄ±rÄ±larÄ± iÃ§in de iyi Ã§alÄ±ÅŸÄ±r.</p> |

GeÃ§erli kullanÄ±cÄ± adlarÄ±nÄ± keÅŸfettikten sonra bir kullanÄ±cÄ± hakkÄ±nda **bilgi alabilirsiniz**.
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Betik [**o365creeper**](https://github.com/LMGsec/o365creeper) ayrÄ±ca **bir e-postanÄ±n geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± keÅŸfetmenize** olanak tanÄ±r.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Microsoft Teams Ãœzerinden KullanÄ±cÄ± NumaralandÄ±rma**

Bilgi iÃ§in baÅŸka bir iyi kaynak Microsoft Teams'tir.

Microsoft Teams'in API'si kullanÄ±cÄ± aramaya izin verir. Ã–zellikle "kullanÄ±cÄ± arama" uÃ§ noktalarÄ± **externalsearchv3** ve **searchUsers**, Teams'e kayÄ±tlÄ± kullanÄ±cÄ± hesaplarÄ± hakkÄ±nda genel bilgi talep etmek iÃ§in kullanÄ±labilir.

API yanÄ±tÄ±na baÄŸlÄ± olarak, mevcut olmayan kullanÄ±cÄ±lar ile geÃ§erli bir Teams aboneliÄŸi olan mevcut kullanÄ±cÄ±lar arasÄ±nda ayrÄ±m yapmak mÃ¼mkÃ¼ndÃ¼r.

[**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) betiÄŸi, belirli bir kullanÄ±cÄ± adÄ± kÃ¼mesini Teams API'sine karÅŸÄ± doÄŸrulamak iÃ§in kullanÄ±labilir.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## Az Unauthenticated Enumeration and Initial Entry

### Unauthenticated Enumeration

1. **Service Discovery**: Use tools like `nmap`, `masscan`, or `shodan` to discover exposed services and ports.
2. **Web Applications**: Look for web applications and APIs that might be exposed. Tools like `dirsearch`, `gobuster`, or `ffuf` can be helpful for this.
3. **Storage Accounts**: Identify exposed storage accounts using tools like `azurite`, `azcopy`, or `azdata`.
4. **Database Services**: Search for exposed database services like SQL databases or NoSQL databases.
5. **Other Services**: Check for any other exposed services like Redis, Elasticsearch, etc.

### Initial Entry

1. **Weak Credentials**: Try default or common credentials for services discovered during enumeration.
2. **Brute Force**: Use tools like `hydra`, `medusa`, or `patator` to brute force login pages or services.
3. **Exploitation**: Look for known vulnerabilities in the services or applications discovered during enumeration. Use tools like `searchsploit` or `exploitdb` to find exploits.
4. **Phishing**: Send phishing emails to gather credentials or perform social engineering attacks.
5. **Client-Side Attacks**: Exploit vulnerabilities in client applications or browsers to gain access to the system.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
AyrÄ±ca mevcut kullanÄ±cÄ±lar hakkÄ±nda kullanÄ±labilirlik bilgilerini ÅŸu ÅŸekilde sÄ±ralamak mÃ¼mkÃ¼ndÃ¼r:

- Uygun
- Uzakta
- RahatsÄ±z Etmeyin
- MeÅŸgul
- Ã‡evrimdÄ±ÅŸÄ±

EÄŸer bir **dÄ±ÅŸarÄ±da mesajÄ±** yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, TeamsEnum kullanÄ±larak mesaj alÄ±nabilir. Bir Ã§Ä±kÄ±ÅŸ dosyasÄ± belirtildiyse, dÄ±ÅŸarÄ±da mesajlarÄ± otomatik olarak JSON dosyasÄ±na kaydedilir:
```
jq . teamsenum-output.json
```
## Az Unauthenticated Enumeration and Initial Entry

### Unauthenticated Enumeration

1. **Service Discovery**: Utilize tools like `nmap`, `masscan`, and `shodan` to discover exposed services and endpoints.
   
2. **Storage Account Enumeration**: Enumerate storage accounts using tools like `azcopy` and `Azure Storage Explorer`.

3. **Blob Enumeration**: Enumerate blobs within storage accounts using tools like `azcopy` and `Azure Storage Explorer`.

4. **Cosmos DB Enumeration**: Enumerate Cosmos DB instances using tools like `Cosmos DB Explorer`.

5. **SQL Database Enumeration**: Enumerate SQL databases using tools like `mssql-cli` and `Azure Data Studio`.

### Initial Entry

1. **Weak Credentials**: Attempt to login using default or weak credentials for services like Azure Portal, Azure CLI, and Azure Management API.

2. **Brute Force**: Perform brute force attacks against login portals and services with weak authentication mechanisms.

3. **Phishing**: Conduct phishing campaigns to trick users into revealing their credentials or executing malicious actions.

4. **Exploiting Misconfigurations**: Exploit misconfigurations in services like Azure Blob Storage, Azure App Services, and Azure Functions to gain unauthorized access.

5. **Social Engineering**: Use social engineering techniques to manipulate individuals into providing access or sensitive information.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Azure Hizmetleri

Azure kiracÄ±sÄ±nÄ±n kullandÄ±ÄŸÄ± alan adlarÄ±nÄ± bildiÄŸimize gÃ¶re artÄ±k **aÃ§Ä±ÄŸa Ã§Ä±karÄ±lmÄ±ÅŸ Azure hizmetlerini bulmaya Ã§alÄ±ÅŸma zamanÄ±**.

Bu hedefe ulaÅŸmak iÃ§in [**MicroBust**](https://github.com/NetSPI/MicroBurst)'tan bir yÃ¶ntem kullanabilirsiniz. Bu iÅŸlev, temel alan adÄ± (ve birkaÃ§ tÃ¼revini) birkaÃ§ **Azure hizmet alanÄ±nda** arayacaktÄ±r:
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## AÃ§Ä±k Depolama

AÃ§Ä±k depolamayÄ± keÅŸfedebilirsiniz, [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) gibi bir araÃ§ kullanarak, bu araÃ§ **`Microburst/Misc/permitations.txt`** dosyasÄ±nÄ± kullanarak basit permutasyonlar oluÅŸturacak ve **aÃ§Ä±k depolama hesaplarÄ±nÄ± bulmaya Ã§alÄ±ÅŸacaktÄ±r**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URL'leri

Bir _**paylaÅŸÄ±lan eriÅŸim imzasÄ±**_ (SAS) URL'si, belirli bir Depolama hesabÄ±nÄ±n belirli bir bÃ¶lÃ¼mÃ¼ne (tam bir konteyner, bir dosya olabilir...) belirli izinlerle (okuma, yazma...) eriÅŸim saÄŸlayan bir URL'dir. EÄŸer sÄ±zdÄ±rÄ±lmÄ±ÅŸ bir tane bulursanÄ±z, hassas bilgilere eriÅŸebilirsiniz, ÅŸÃ¶yle gÃ¶rÃ¼nÃ¼rler (bu bir konteynere eriÅŸim saÄŸlamak iÃ§in, eÄŸer sadece bir dosyaya eriÅŸim saÄŸlÄ±yorsa URL'nin yolu aynÄ± zamanda o dosyayÄ± da iÃ§erecektir):

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Verilere eriÅŸmek iÃ§in [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) kullanÄ±n

## Kimlik Bilgilerinin Tehdit AltÄ±nda OlmasÄ±

### Sosyal MÃ¼hendislik

* [**YaygÄ±n Sosyal MÃ¼hendislik**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (kimlik bilgileri veya OAuth UygulamasÄ± -[YasadÄ±ÅŸÄ± Onay Hibe SaldÄ±rÄ±sÄ±](az-illicit-consent-grant.md)-)
* [**Cihaz Kodu Kimlik DoÄŸrulama** Sosyal MÃ¼hendislik](az-device-code-authentication-phishing.md)

### Parola SÄ±kmak / Kaba Kuvvet SaldÄ±rÄ±sÄ±

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Referanslar

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}
