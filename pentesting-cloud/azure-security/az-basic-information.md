# Az - Βασικές Πληροφορίες

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Ιεραρχία Οργάνωσης

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUchBvhjIdWWR2ldAkWiZMdmrcEYD9Ti5UAa3zAGr9YbAnx4Q_gZNp_zvOU429vgWZ_ixoYHQKdC8bGgkhWYCy591SRIFj6RKCj4BEpVQixAGsp3T3O5sS3k7x5CTaJ-SCBNC7i5KluLyxdiXoZsH1F0ko1Gv88=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption></figcaption></figure>

### Ομάδες Διαχείρισης

* Μπορεί να περιέχει **άλλες ομάδες διαχείρισης ή συνδρομές**.
* Αυτό επιτρέπει την **εφαρμογή ελέγχων διακυβέρνησης** όπως RBAC και Azure Policy μία φορά σε επίπεδο ομάδας διαχείρισης και να κληρονομούνται από όλες τις συνδρομές στην ομάδα.
* **10.000 ομάδες διαχείρισης** μπορούν να υποστηριχθούν σε έναν μόνο κατάλογο.
* Ένα δέντρο ομάδων διαχείρισης μπορεί να υποστηρίξει **έως έξι επίπεδα βάθους**. Αυτό το όριο δεν περιλαμβάνει το ριζικό επίπεδο ή το επίπεδο συνδρομής.
* Κάθε ομάδα διαχείρισης και συνδρομή μπορεί να υποστηρίξει **μόνο έναν γονέα**.
* Ακόμα και αν μπορούν να δημιουργηθούν πολλές ομάδες διαχείρισης, **υπάρχει μόνο 1 ριζική ομάδα διαχείρισης**.
* Η ριζική ομάδα διαχείρισης **περιέχει** όλες τις **άλλες ομάδες διαχείρισης και συνδρομές** και **δεν μπορεί να μετακινηθεί ή να διαγραφεί**.
* Όλες οι συνδρομές εντός μιας μόνο ομάδας διαχείρισης πρέπει να εμπιστεύονται τον **ίδιο ενοικιαστή Entra ID.**

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption><p><a href="https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png">https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png</a></p></figcaption></figure>

### Συνδρομές Azure

* Είναι ένα άλλο **λογικό δοχείο όπου μπορούν να εκτελούνται πόροι** (VMs, DBs…) και θα χρεώνονται.
* Ο **γονέας** του είναι πάντα μια **ομάδα διαχείρισης** (και μπορεί να είναι η ριζική ομάδα διαχείρισης) καθώς οι συνδρομές δεν μπορούν να περιέχουν άλλες συνδρομές.
* **Εμπιστεύεται μόνο έναν κατάλογο Entra ID**
* **Δικαιώματα** που εφαρμόζονται σε επίπεδο συνδρομής (ή οποιουδήποτε από τους γονείς της) **κληρονομούνται** σε όλους τους πόρους μέσα στη συνδρομή

### Ομάδες Πόρων

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Μια ομάδα πόρων είναι ένα **δοχείο** που περιέχει **σχετικούς πόρους** για μια λύση Azure. Η ομάδα πόρων μπορεί να περιλαμβάνει όλους τους πόρους για τη λύση ή μόνο εκείνους τους **πόρους που θέλετε να διαχειριστείτε ως ομάδα**. Γενικά, προσθέστε **πόρους** που μοιράζονται τον **ίδιο κύκλο ζωής** στην ίδια ομάδα πόρων ώστε να μπορείτε να τους αναπτύξετε, να τους ενημερώσετε και να τους διαγράψετε εύκολα ως ομάδα.

Όλοι οι **πόροι** πρέπει να είναι **μέσα σε μια ομάδα πόρων** και μπορούν να ανήκουν μόνο σε μια ομάδα και αν μια ομάδα πόρων διαγραφεί, όλοι οι πόροι μέσα σε αυτήν διαγράφονται επίσης.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfe8U30iP_vdZCvxX4g8nEPRLoo7v0kmCGkDn1frBPn3_GIoZ7VT2LkdsVQWCnrG_HSYNRRPM-1pSECUkbDAB-9YbUYLzpvKVLDETZS81CHWKYM4fDl3oMo5-yvTMnjdLTS2pz8U67xUTIzBhZ25MFMRkq5koKY=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption><p><a href="https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1">https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1</a></p></figcaption></figure>

### Αναγνωριστικά Πόρων Azure

Κάθε πόρος στο Azure έχει ένα Αναγνωριστικό Πόρου Azure που τον προσδιορίζει.

Η μορφή ενός Αναγνωριστικού Πόρου Azure είναι η εξής:

* `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderNamespace}/{resourceType}/{resourceName}`

Για μια εικονική μηχανή με όνομα myVM σε μια ομάδα πόρων `myResourceGroup` κάτω από το ID συνδρομής `12345678-1234-1234-1234-123456789012`, το Αναγνωριστικό Πόρου Azure φαίνεται έτσι:

* `/subscriptions/12345678-1234-1234-1234-123456789012/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM`

## Azure vs Entra ID vs Υπηρεσίες Τομέα Azure AD

### Azure

Το Azure είναι η ολοκληρωμένη **πλατφόρμα υπολογιστικού νέφους της Microsoft, προσφέροντας μια ευρεία γκάμα υπηρεσιών**, συμπεριλαμβανομένων εικονικών μηχανών, βάσεων δεδομένων, τεχνητής νοημοσύνης και αποθήκευσης. Λειτουργεί ως θεμέλιο για τη φιλοξενία και τη διαχείριση εφαρμογών, την κατασκευή κλιμακούμενων υποδομών και την εκτέλεση σύγχρονων φορτίων εργασίας στο νέφος. Το Azure παρέχει εργαλεία για προγραμματιστές και επαγγελματίες IT για να δημιουργούν, να αναπτύσσουν και να διαχειρίζονται εφαρμογές και υπηρεσίες χωρίς προβλήματα, καλύπτοντας μια ποικιλία αναγκών από νεοφυείς επιχειρήσεις έως μεγάλες επιχειρήσεις.

### Entra ID (πρώην Azure Active Directory)

Το Entra ID είναι μια υπηρεσία **διαχείρισης ταυτότητας και πρόσβασης** που βασίζεται στο νέφος, σχεδιασμένη να χειρίζεται την αυθεντικοποίηση, την εξουσιοδότηση και τον έλεγχο πρόσβασης χρηστών. Εξασφαλίζει ασφαλή πρόσβαση σε υπηρεσίες της Microsoft όπως το Office 365, το Azure και πολλές τρίτες SaaS εφαρμογές. Με δυνατότητες όπως η ενιαία είσοδος (SSO), η πολυπαραγοντική αυθεντικοποίηση (MFA) και οι πολιτικές πρόσβασης υπό προϋποθέσεις μεταξύ άλλων.

### Υπηρεσίες Τομέα Entra (πρώην Azure AD DS)

Οι Υπηρεσίες Τομέα Entra επεκτείνουν τις δυνατότητες του Entra ID προσφέροντας **διαχειριζόμενες υπηρεσίες τομέα συμβατές με παραδοσιακά περιβάλλοντα Windows Active Directory**. Υποστηρίζει παλαιές πρωτόκολλες όπως LDAP, Kerberos και NTLM, επιτρέποντας στις οργανώσεις να μεταναστεύσουν ή να εκτελούν παλαιότερες εφαρμογές στο νέφος χωρίς να αναπτύσσουν τοπικούς ελεγκτές τομέα. Αυτή η υπηρεσία υποστηρίζει επίσης την Πολιτική Ομάδας για κεντρική διαχείριση, καθιστώντας την κατάλληλη για σενάρια όπου τα φορτία εργασίας που βασίζονται σε AD ή κληρονομικά πρέπει να συνυπάρχουν με σύγχρονα περιβάλλοντα νέφους.

## Principals Entra ID

### Χρήστες

* **Νέοι χρήστες**
* Υποδείξτε το όνομα email και το τομέα από τον επιλεγμένο ενοικιαστή
* Υποδείξτε το όνομα εμφάνισης
* Υποδείξτε τον κωδικό πρόσβασης
* Υποδείξτε τις ιδιότητες (όνομα, τίτλος εργασίας, πληροφορίες επαφής…)
* Ο προεπιλεγμένος τύπος χρήστη είναι “**μέλος**”
* **Εξωτερικοί χρήστες**
* Υποδείξτε το email για πρόσκληση και το όνομα εμφάνισης (μπορεί να είναι ένα μη Microsoft email)
* Υποδείξτε τις ιδιότητες
* Ο προεπιλεγμένος τύπος χρήστη είναι “**Επισκέπτης**”

### Προεπιλεγμένα δικαιώματα χρηστών

* **Μέλη (**[**έγγραφα**](https://learn.microsoft.com/en-gb/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions)**)**
* Εγγραφή εφαρμογών: Προεπιλογή **Ναι**
* Περιορισμός μη διαχειριστικών χρηστών από τη δημιουργία ενοικιαστών: Προεπιλογή **Όχι**
* Δημιουργία ομάδων ασφαλείας: Προεπιλογή **Ναι**
* Περιορισμός πρόσβασης στην πύλη διαχείρισης Microsoft Entra: Προεπιλογή **Όχι**
* Αυτό δεν περιορίζει την πρόσβαση API στην πύλη (μόνο στο web)
* Επιτρέψτε στους χρήστες να συνδέουν τον λογαριασμό εργασίας ή σχολείου τους με το LinkedIn: Προεπιλογή **Ναι**
* Εμφάνιση διατήρησης του χρήστη συνδεδεμένου: Προεπιλογή **Ναι**
* Περιορισμός χρηστών από την ανάκτηση του BitLocker κλειδιού(ών) για τις συσκευές τους: Προεπιλογή Όχι (ελέγξτε στις Ρυθμίσεις Συσκευής)
* Ανάγνωση άλλων χρηστών: Προεπιλογή **Ναι** (μέσω Microsoft Graph)
* **Επισκέπτες**
* **Περιορισμοί πρόσβασης επισκεπτών**
* **Οι επισκέπτες έχουν την ίδια πρόσβαση με τα μέλη** παραχωρούν όλες τις άδειες χρηστών μελών στους επισκέπτες από προεπιλογή.
* **Οι επισκέπτες έχουν περιορισμένη πρόσβαση σε ιδιότητες και μέλη αντικειμένων καταλόγου (προεπιλογή)** περιορίζουν την πρόσβαση των επισκεπτών μόνο στο δικό τους προφίλ χρήστη από προεπιλογή. Η πρόσβαση σε άλλους χρήστες και πληροφορίες ομάδας δεν επιτρέπεται πλέον.
* **Η πρόσβαση των επισκεπτών περιορίζεται σε ιδιότητες και μέλη των δικών τους αντικειμένων καταλόγου** είναι η πιο περιοριστική.
* **Οι επισκέπτες μπορούν να προσκαλούν**
* **Οποιοσδήποτε στην οργάνωση μπορεί να προσκαλεί επισκέπτες, συμπεριλαμβανομένων των επισκεπτών και μη διαχειριστών (η πιο περιεκτική) - Προεπιλογή**
* **Χρήστες μέλη και χρήστες που έχουν ανατεθεί σε συγκεκριμένους ρόλους διαχειριστή μπορούν να προσκαλούν επισκέπτες, συμπεριλαμβανομένων των επισκεπτών με άδειες μέλους**
* **Μόνο χρήστες που έχουν ανατεθεί σε συγκεκριμένους ρόλους διαχειριστή μπορούν να προσκαλούν επισκέπτες**
* **Κανείς στην οργάνωση δεν μπορεί να προσκαλεί επισκέπτες, συμπεριλαμβανομένων των διαχειριστών (η πιο περιοριστική)**
* **Εξωτερικοί χρήστες μπορούν να αποχωρήσουν**: Προεπιλογή **Αληθές**
* Επιτρέψτε στους εξωτερικούς χρήστες να αποχωρούν από την οργάνωση

{% hint style="success" %}
Ακόμα και αν περιορίζονται από προεπιλογή, οι χρήστες (μέλη και επισκέπτες) με παραχωρημένα δικαιώματα θα μπορούσαν να εκτελούν τις προηγούμενες ενέργειες.
{% endhint %}

### **Service Principals**

Ένας **Service Principal** είναι μια **ταυτότητα** που δημιουργείται για **χρήση** με **εφαρμογές**, φιλοξενούμενες υπηρεσίες και αυτοματοποιημένα εργαλεία για πρόσβαση σε πόρους Azure. Αυτή η πρόσβαση είναι **περιορισμένη από τους ρόλους που έχουν ανατεθεί** στον service principal, δίνοντάς σας έλεγχο για **ποιοι πόροι μπορούν να προσπελαστούν** και σε ποιο επίπεδο. Για λόγους ασφαλείας, συνιστάται πάντα να **χρησιμοποιείτε service principals με αυτοματοποιημένα εργαλεία** αντί να τους επιτρέπετε να συνδέονται με μια ταυτότητα χρήστη.

Είναι δυνατόν να **συνδεθείτε απευθείας ως service principal** δημιουργώντας του ένα **μυστικό** (κωδικό πρόσβασης), ένα **πιστοποιητικό** ή παραχωρώντας **ομοσπονδία** πρόσβαση σε τρίτες πλατφόρμες (π.χ. Github Actions) πάνω σε αυτό.

* Αν επιλέξετε **αυθεντικοποίηση με κωδικό πρόσβασης** (κατά προεπιλογή), **αποθηκεύστε τον κωδικό πρόσβασης που δημιουργήθηκε** καθώς δεν θα μπορείτε να έχετε ξανά πρόσβαση σε αυτόν.
* Αν επιλέξετε αυθεντικοποίηση με πιστοποιητικό, βεβαιωθείτε ότι η **εφαρμογή θα έχει πρόσβαση στο ιδιωτικό κλειδί**.

### Εγγραφές Εφαρμογών

Μια **Εγγραφή Εφαρμογής** είναι μια ρύθμιση που επιτρέπει σε μια εφαρμογή να ενσωματωθεί με το Entra ID και να εκτελεί ενέργειες.

#### Κύρια Στοιχεία:

1. **Αναγνωριστικό Εφαρμογής (Client ID):** Ένας μοναδικός αναγνωριστής για την εφαρμογή σας στο Azure AD.
2. **Redirect URIs:** URLs όπου το Azure AD στέλνει τις απαντήσεις αυθεντικοποίησης.
3. **Πιστοποιητικά, Μυστικά & Ομοσπονδισμένα Διαπιστευτήρια:** Είναι δυνατόν να δημιουργηθεί ένα μυστικό ή ένα πιστοποιητικό για να συνδεθείτε ως service principal της εφαρμογής, ή να παραχωρήσετε ομοσπονδισμένη πρόσβαση σε αυτήν (π.χ. Github Actions).&#x20;
1. Αν δημιουργηθεί ένα **πιστοποιητικό** ή **μυστικό**, είναι δυνατόν σε ένα άτομο να **συνδεθεί ως service principal** με εργαλεία CLI γνωρίζοντας το **αναγνωριστικό εφαρμογής**, το **μυστικό** ή το **πιστοποιητικό** και τον **ενοικιαστή** (τομέας ή ID).
4. **Δικαιώματα API:** Προσδιορίζει ποιους πόρους ή APIs μπορεί να προσπελάσει η εφαρμογή.
5. **Ρυθμίσεις Αυθεντικοποίησης:** Ορίζει τις υποστηριζόμενες ροές αυθεντικοποίησης της εφαρμογής (π.χ., OAuth2, OpenID Connect).
6. **Service Principal**: Ένας service principal δημιουργείται όταν δημιουργείται μια εφαρμογή (αν γίνει από την ιστοσελίδα) ή όταν εγκαθίσταται σε έναν νέο ενοικιαστή.
1. Ο **service principal** θα αποκτήσει όλα τα ζητούμενα δικαιώματα με τα οποία έχει ρυθμιστεί.

### Επιχειρηματικές Εφαρμογές

Είναι απλώς μια **πίνακας στο Azure για φιλτράρισμα service principals** και έλεγχο των εφαρμογών που έχουν ανατεθεί σε αυτούς.

**Δεν είναι άλλος τύπος “εφαρμογής”,** δεν υπάρχει κανένα αντικείμενο στο Azure που να είναι “Επιχειρηματική Εφαρμογή”, είναι απλώς μια αφαίρεση για τον έλεγχο των Service principals, Εγγραφών εφαρμογών και διαχειριζόμενων ταυτοτήτων.

### **Διαχειριζόμενη Ταυτότητα (Μεταδεδομένα)**

Οι διαχειριζόμενες ταυτότητες στο Azure Active Directory προσφέρουν μια λύση για **αυτόματη διαχείριση της ταυτότητας** των εφαρμογών. Αυτές οι ταυτότητες χρησιμοποιούνται από τις εφαρμογές για τον σκοπό της **σύνδεσης** σε **πόρους** συμβατούς με την αυθεντικοποίηση Azure Active Directory (**Azure AD**). Αυτό επιτρέπει την **αφαίρεση της ανάγκης σκληρής κωδικοποίησης διαπιστευτηρίων νέφους** στον κώδικα καθώς η εφαρμογή θα είναι σε θέση να επικοινωνήσει με την υπηρεσία **μεταδεδομένων** για να αποκτήσει ένα έγκυρο διακριτικό για **να εκτελεί ενέργειες** ως η υποδεικνυόμενη διαχειριζόμενη ταυτότητα στο Azure.

Υπάρχουν δύο τύποι διαχειριζόμενων ταυτοτήτων:

* **Ανατεθειμένη από το σύστημα**. Ορισμένες υπηρεσίες Azure σας επιτρέπουν να **ενεργοποιήσετε μια διαχειριζόμενη ταυτότητα απευθείας σε μια υπηρεσία**. Όταν ενεργοποιείτε μια διαχειριζόμενη ταυτότητα ανατεθειμένη από το σύστημα, δημιουργείται ένας **service principal** στον ενοικιαστή Entra ID που εμπιστεύεται τη συνδρομή όπου βρίσκεται ο πόρος. Όταν ο **πόρος** διαγραφεί, το Azure αυτόματα **διαγράφει** την **ταυτότητα** για εσάς.
* **Ανατεθειμένη από τον χρήστη**. Είναι επίσης δυνατό για τους χρήστες να δημιουργούν διαχειριζόμενες ταυτότητες. Αυτές δημιουργούνται μέσα σε μια ομάδα πόρων σε μια συνδρομή και θα δημιουργηθεί ένας service principal στον EntraID που εμπιστεύεται τη συνδρομή. Στη συνέχεια, μπορείτε να αναθέσετε τη διαχειριζόμενη ταυτότητα σε μία ή **περισσότερες περιπτώσεις** μιας υπηρεσίας Azure (πολλοί πόροι). Για τις διαχειριζόμενες ταυτότητες ανατεθειμένες από τον χρήστη, η **ταυτότητα διαχειρίζεται ξεχωριστά από τους πόρους που τη χρησιμοποιούν**.

Οι Διαχειριζόμενες Ταυτότητες **δεν δημιουργούν αιώνια διαπιστευτήρια** (όπως κωδικούς πρόσβασης ή πιστοποιητικά) για πρόσβαση ως ο service principal που συνδέεται με αυτήν.

### Προεπιλεγμένες Άδειες Συγκατάθεσης

**Συγκατάθεση χρηστών για εφαρμογές**

* **Μην επιτρέπετε τη συγκατάθεση χρηστών**
* Ένας διαχειριστής θα απαιτείται για όλες τις εφαρμογές.
* **Επιτρέψτε τη συγκατάθεση χρηστών για εφαρμογές από επαληθευμένους εκδότες, για επιλεγμένα δικαιώματα (Συνιστάται)**
* Όλοι οι χρήστες μπορούν να συγκατατεθούν για δικαιώματα που ταξινομούνται ως "χαμηλής επίπτωσης", για εφαρμογές από επαληθευμένους εκδότες ή εφαρμογές που είναι εγγεγραμμένες σε αυτήν την οργάνωση.
* **Προεπιλογή** χαμηλής επίπτωσης δικαιώματα (αν και πρέπει να αποδεχθείτε να τα προσθέσετε ως χαμηλά):
* User.Read - σύνδεση και ανάγνωση προφίλ χρήστη
* offline\_access - διατήρηση πρόσβασης σε δεδομένα που οι χρήστες έχουν δώσει πρόσβαση
* openid - σύνδεση χρηστών
* profile - προβολή βασικού προφίλ χρήστη
* email - προβολή διεύθυνσης email χρήστη
* **Επιτρέψτε τη συγκατάθεση χρηστών για εφαρμογές (Προεπιλογή)**
* Όλοι οι χρήστες μπορούν να συγκατατεθούν για οποιαδήποτε εφαρμογή να έχει πρόσβαση στα δεδομένα της οργάνωσης.

**Αιτήματα συγκατάθεσης διαχειριστή**: Προεπιλογή **Όχι**

* Οι χρήστες μπορούν να ζητήσουν συγκατάθεση διαχειριστή για εφαρμογές για τις οποίες δεν μπορούν να συγκατατεθούν
* Αν **Ναι**: Είναι δυνατόν να υποδείξετε Χρήστες, Ομάδες και Ρόλους που μπορούν να συγκατατεθούν σε αιτήματα
* Ρυθμίστε επίσης αν οι χρήστες θα λαμβάνουν ειδοποιήσεις μέσω email και υπενθυμίσεις λήξης&#x20;

### Διοικητικές Μονάδες

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Οι διοικητικές μονάδες σας επιτρέπουν να **υποδιαιρείτε** την οργάνωσή σας σε **οποιαδήποτε μονάδα** θέλετε, και στη συνέχεια να **αναθέτετε συγκεκριμένους διαχειριστές** που μπορούν να **διαχειρίζονται μόνο τα μέλη** αυτής της μονάδας. Για παράδειγμα, θα μπορούσατε να χρησιμοποιήσετε διοικητικές μονάδες για να αναθέσετε δικαιώματα σε διαχειριστές κάθε σχολής σε ένα μεγάλο πανεπιστήμιο, ώστε να μπορούν να ελέγχουν την πρόσβαση, να διαχειρίζονται χρήστες και να θέτουν πολιτικές μόνο στη Σχολή Μηχανικών.

Μόνο **χρήστες**, **ομάδες** και **συσκευές** μπορούν να είναι **μέλη** μιας **διοικητικής μονάδας**.

Επομένως, μια **διοικητική μονάδα** θα **περιέχει** ορισμένα **μέλη** και άλλοι **principals** θα έχουν **ανατεθεί δικαιώματα πάνω σε αυτήν** τη διοικητική **μονάδα** που μπορούν να χρησιμοποιήσουν για **να διαχειρίζονται τα μέλη** της διοικητικής μονάδας.

## Ρόλοι & Δικαιώματα

**Ρόλοι** ανατίθενται σε **principals** σε ένα **πεδίο**: `principal -[HAS ROLE]->(scope)`

**Ρόλοι** που ανατίθενται σε **ομάδες** κληρονομούνται από όλα τα **μέλη** της ομάδας.

Ανάλογα με το πεδίο στο οποίο ανατέθηκε ο ρόλος, ο **ρόλος** μπορεί να **κληρονομηθεί** σε **άλλους πόρους** μέσα στο δοχείο πεδίου. Για παράδειγμα, αν ένας χρήστης A έχει έναν **ρόλο στη συνδρομή**, θα έχει αυτόν τον **ρόλο σε όλες τις ομάδες πόρων** μέσα στη συνδρομή και σε **όλους τους πόρους** μέσα στην ομάδα πόρων.

### **Κλασικοί Ρόλοι**

| **Ιδιοκτήτης**                     | <ul><li>Πλήρης πρόσβαση σε όλους τους πόρους</li><li>Μπορεί να διαχειρίζεται την πρόσβαση για άλλους χρήστες</li></ul> | Όλοι οι τύποι πόρων |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Συνεργάτης**               | <ul><li>Πλήρης πρόσβαση σε όλους τους πόρους</li><li>Δεν μπορεί να διαχειρίζεται την πρόσβαση</li></ul>              | Όλοι οι τύποι πόρων |
| **Αναγνώστης**                    | • Προβολή όλων των πόρων                                                                     | Όλοι οι τύποι πόρων |
| **Διαχειριστής Πρόσβασης Χρηστών** | <ul><li>Προβολή όλων των πόρων</li><li>Μπορεί να διαχειρίζεται την πρόσβαση για άλλους χρήστες</li></ul>           | Όλοι οι τύποι πόρων |

### Ενσωματωμένοι ρόλοι

[Από τα έγγραφα: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Ο έλεγχος πρόσβασης βάσει ρόλων Azure (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) έχει αρκετούς **ενσωματωμένους ρόλους** Azure που μπορείτε να **αναθέσετε** σε **χρήστες, ομάδες, service principals και διαχειριζόμενες ταυτότητες**. Οι αναθέσεις ρόλων είναι ο τρόπος που ελέγχετε **την πρόσβαση σε πόρους Azure**. Αν οι ενσωματωμένοι ρόλοι δεν καλύπτουν τις συγκεκριμένες ανάγκες της οργάνωσής σας, μπορείτε να δημιουργήσετε τους δικούς σας [**προσαρμοσμένους ρόλους Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

Οι **ενσωματωμένοι** ρόλοι ισχύουν μόνο για τους **πόρους** στους οποίους είναι **προορισμένοι**, για παράδειγμα ελέγξτε αυτά τα 2 παραδείγματα **ενσωματωμένων ρόλων πάνω σε πόρους Υπολογισμού**:

| [Disk Backup Reader](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Παρέχει άδεια στο backup vault να εκτελεί backup δίσκων.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Virtual Machine User Login](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Προβολή Εικονικών Μηχανών στην πύλη και σύνδεση ως κανονικός χρήστης. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Αυτοί οι ρόλοι μπορούν **επίσης να ανατεθούν πάνω σε λογικά δοχεία** (όπως ομάδες διαχείρισης, συνδρομές και ομάδες πόρων) και οι principals που επηρεάζονται θα τους έχουν **πάνω στους πόρους μέσα σε αυτά τα δοχεία**.

* Βρείτε εδώ μια λίστα με [**όλους τους ενσωματωμένους ρόλους Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Βρείτε εδώ μια λίστα με [**όλους τους ενσωματωμένους ρόλους Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Προσαρμοσμένοι Ρόλοι

Το Azure επιτρέπει επίσης τη δημιουργία [**προσαρμοσμένων ρόλων**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) με τα δικαιώματα που χρειάζεται ο χρήστης.

### Άρνηση Δικαιωμάτων

* Για να έχει ένας **principal πρόσβαση σε έναν πόρο**, χρειάζεται να του παραχωρηθεί ρητά ένας ρόλος (οποιοσδήποτε τρόπος) **παραχωρώντας του αυτήν την άδεια**.
* Μια ρητή **ανάθεση ρόλου άρνησης έχει προτεραιότητα** πάνω από τον ρόλο που παραχωρεί την άδεια.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Παγκόσμιος Διαχειριστής

Οι χρήστες με τον ρόλο Παγκόσμιου Διαχειριστή έχουν τη δυνατότητα να '**ανυψώνουν' τον ρόλο Διαχειριστή Πρόσβασης Χρηστών Azure στην ριζική ομάδα διαχείρισης**. Αυτό σημαίνει ότι ένας Παγκόσμιος Διαχειριστής θα μπορεί να διαχειρίζεται την πρόσβαση **σε όλες τις συνδρομές Azure και τις ομάδες διαχείρισης.**\
Αυτή η ανύψωση μπορεί να γίνει στο τέλος της σελίδας: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Πολιτικές Azure

Οι πολιτικές Azure είναι ένα σύνολο **κανόνων και κανονισμών στο Microsoft Azure**, μια υπηρεσία υπολογιστικού νέφους, που βοηθούν στη διαχείριση και την επιβολή οργανωτικών προτύπων και στην αξιολόγηση της συμμόρφωσης σε μεγάλη κλίμακα. Αυτές οι πολιτικές επιβάλλουν διάφορους κανόνες στους **πόρους Azure**, διασφαλίζοντας ότι αυτοί οι πόροι παραμένουν συμμορφωμένοι με τα εταιρικά πρότυπα και τις συμφωνίες επιπέδου υπηρεσιών.

Οι πολιτικές Azure είναι κρίσιμες για τη διακυβέρνηση και την ασφάλεια του νέφους, βοηθώντας να διασφαλιστεί ότι οι πόροι χρησιμοποιούνται σωστά και αποτελεσματικά, και ότι συμμορφώνονται με εξωτερικούς κανονισμούς και εσωτερικές πολιτικές.\
Ορισμένα παραδείγματα:

1. **Διασφάλιση Συμμόρφωσης με Συγκεκριμένες Περιοχές Azure**: Αυτή η πολιτική διασφαλίζει ότι όλοι οι πόροι αναπτύσσονται σε συγκεκριμένες περιοχές Azure. Για παράδειγμα, μια εταιρεία μπορεί να θέλει να διασφαλίσει ότι όλα τα δεδομένα της αποθηκεύονται στην Ευρώπη για συμμόρφωση με τον GDPR.
2. **Επιβολή Προτύπων Ονοματοδοσίας**: Οι πολιτικές μπορούν να επιβάλλουν συμβάσεις ονοματοδοσίας για τους πόρους Azure. Αυτό βοηθά στην οργάνωση και την εύκολη αναγνώριση των πόρων με βάση τα ονόματά τους, κάτι που είναι χρήσιμο σε μεγάλες περιβάλλοντα.
3. **Περιορισμός Ορισμένων Τύπων Πόρων**: Αυτή η πολιτική μπορεί να περιορίσει τη δημιουργία ορισμένων τύπων πόρων. Για παράδειγμα, μπορεί να οριστεί μια πολιτική για να αποτρέψει τη δημιουργία ακριβών τύπων πόρων, όπως ορισμένα μεγέθη VM, για τον έλεγχο του κόστους.
4. **Επιβολή Πολιτικών Ετικετών**: Οι ετικέτες είναι ζεύγη κλειδιού-τιμής που σχετίζονται με τους πόρους Azure και χρησιμοποιούνται για τη διαχείριση πόρων. Οι πολιτικές μπορούν να επιβάλλουν ότι ορισμένες ετικέτες πρέπει να είναι παρούσες ή να έχουν συγκεκριμένες τιμές για όλους τους πόρους. Αυτό είναι χρήσιμο για την παρακολούθηση κόστους, την ιδιοκτησία ή την κατηγοριοποίηση των πόρων.
5. **Περιορισμός Δημόσιας Πρόσβασης σε Πόρους**: Οι πολιτικές μπορούν να επιβάλλουν ότι ορισμένοι πόροι, όπως οι λογαριασμοί αποθήκευσης ή οι βάσεις δεδομένων, δεν έχουν δημόσιες τελικές σημεία, διασφαλίζοντας ότι είναι προσβάσιμοι μόνο εντός του δικτύου της οργάνωσης.
6. **Αυτόματη Εφαρμογή Ρυθμίσεων Ασφαλείας**: Οι πολιτικές μπορούν να χρησιμοποιηθούν για την αυτόματη εφαρμογή ρυθμίσεων ασφαλείας στους πόρους, όπως η εφαρμογή μιας συγκεκριμένης ομάδας ασφαλείας δικτύου σε όλες τις VM ή η διασφάλιση ότι όλοι οι λογαριασμοί αποθήκευσης χρησιμοποιούν κρυπτογράφηση.

Σημειώστε ότι οι Πολιτικές Azure μπορούν να προσαρτηθούν σε οποιοδήποτε επίπεδο της ιεραρχίας Azure, αλλά χρησιμοποιούνται **συνήθως στην ριζική ομάδα διαχείρισης** ή σε άλλες ομάδες διαχείρισης.

### Πεδίο Δικαιωμάτων

Στο Azure **τα δικαιώματα μπορούν να ανατεθούν σε οποιοδήποτε μέρος της ιεραρχίας**. Αυτό περιλαμβάνει ομάδες διαχείρισης, συνδρομές, ομάδες πόρων και μεμονωμένους πόρους. Τα δικαιώματα **κληρονομούνται** από τους περιεχόμενους **πόρους** της οντότητας όπου ανατέθηκαν.

Αυτή η ιεραρχική δομή επιτρέπει την αποτελεσματική και κλιμακούμενη διαχείριση των δικαιωμάτων πρόσβασης.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (έλεγχος πρόσβασης βάσει ρόλων) είναι αυτό που έχουμε δει ήδη στις προηγούμενες ενότητες: **Ανάθεση ενός ρόλου σε έναν principal για να του παραχωρήσει πρόσβαση** σε έναν πόρο.\
Ωστόσο, σε ορισμένες περιπτώσεις μπορεί να θέλετε να παρέχετε **πιο λεπτομερή διαχείριση πρόσβασης** ή να **απλοποιήσετε** τη διαχείριση **εκατοντάδων** αναθέσεων ρόλων.

Το Azure **ABAC** (έλεγχος πρόσβασης βάσει χαρακτηριστικών) βασίζεται στο Azure RBAC προσθέτοντας **συνθήκες ανάθεσης ρόλου βάσει χαρακτηριστικών** στο πλαίσιο συγκεκριμένων ενεργειών. Μια _συνθήκη ανάθεσης ρόλου_ είναι μια **επιπλέον έλεγχο που μπορείτε προαιρετικά να προσθέσετε στην ανάθεση ρόλου σας** για να παρέχετε πιο λεπτομερή έλεγχο πρόσβασης. Μια συνθήκη φιλτράρει τα δικαιώματα που παραχωρούνται ως μέρος του ορισμού ρόλου και της ανάθεσης ρόλου. Για παράδειγμα, μπορείτε να **προσθέσετε μια συνθήκη που απαιτεί ένα αντικείμενο να έχει μια συγκεκριμένη ετικέτα για να διαβάσει το αντικείμενο**.\
Δεν μπορείτε να **αρνηθείτε** ρητά **την πρόσβαση** σε συγκεκριμένους πόρους **χρησιμοποιώντας συνθήκες**.

### Προεπιλεγμένα Δικαιώματα Χρηστών

Ένας βασικός χρήστης θα έχει ορισμένα **προεπιλεγμένα δικαιώματα** για να απαριθμήσει ορισμένα μέρη του AzureAD:

* Ανάγνωση όλων των χρηστών, Ομάδων, Εφαρμογών, Συσκευών, Ρόλων, Συνδρομών και των δημόσιων ιδιοτήτων τους
* Πρόσκληση Επισκεπτών (_μπορεί να απενεργοποιηθεί_)
* Δημιουργία Ομάδων Ασφαλείας
* Ανάγνωση μη κρυφών μελών Ομάδας
* Προσθήκη επισκεπτών σε Ιδιοκτησίες ομάδων
* Δημιουργία νέας εφαρμογής (_μπορεί να απενεργοποιηθεί_)
* Προσθήκη έως 50 συσκευών στο Azure (_μπορεί να απενεργοποιηθεί_)

Μπορείτε να δείτε τη πλήρη [λίστα με τα **προεπιλεγμένα δικαιώματα χρηστών** στα έγγραφα](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Επιπλέον, σημειώστε ότι σε αυτή τη λίστα μπορείτε επίσης να δείτε τη **λίστα προεπιλεγμένων δικαιωμάτων επισκεπτών**.

{% hint style="info" %}
Θυμηθείτε ότι για να απαριθμήσετε τους πόρους Azure, ο χρήστης χρειάζεται μια ρητή παραχώρηση του δικαιώματος.
{% endhint %}

### Διαχείριση Προνομίων Ταυτότητας (PIM)

Η Διαχείριση Προνομίων Ταυτότητας (PIM) στο Azure είναι ένα εργαλείο που **διαχειρίζεται, ελέγχει και παρακολουθεί την προνομιακή πρόσβαση** στο Azure Active Directory και το Azure. Ενισχύει την ασφάλεια παρέχοντας **προνομιακή πρόσβαση κατά παραγγελία και περιορισμένης διάρκειας**, **επιβάλλοντας ροές έγκρισης και απαιτώντας επιπλέον αυθεντικοποίηση**. Αυτή η προσέγγιση ελαχιστοποιεί τον κίνδυνο μη εξουσιοδοτημένης πρόσβασης διασφαλίζοντας ότι οι ανυψωμένες άδειες παραχωρούνται μόνο όταν είναι απαραίτητο και για συγκεκριμένη διάρκεια.

## Διακριτικά Αυθεντικοποίησης

Υπάρχουν **τρία τύποι διακριτικών** που χρησιμοποιούνται στο OIDC:

* [**Διακριτικά Πρόσβασης**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Ο πελάτης παρουσιάζει αυτό το διακριτικό στον διακομιστή πόρων για **πρόσβαση σε πόρους**. Μπορεί να χρησιμοποιηθεί μόνο για μια συγκεκριμένη συνδυασμένη χρήση χρήστη, πελάτη και πόρου και **δεν μπορεί να ανακληθεί** μέχρι την λήξη του - που είναι 1 ώρα κατά προεπιλογή. Η ανίχνευση είναι χαμηλή χρησιμοποιώντας αυτό.
* **Διακριτικά ID**: Ο πελάτης λαμβάνει αυτό το **διακριτικό από τον διακομιστή εξουσιοδότησης**. Περιέχει βασικές πληροφορίες σχετικά με τον χρήστη. Είναι **δεσμευμένο σε μια συγκεκριμένη συνδυασμένη χρήση χρήστη και πελάτη**.
* **Διακριτικά Ανανέωσης**: Παρέχονται στον πελάτη με το διακριτικό πρόσβασης. Χρησιμοποιούνται για **να αποκτήσουν νέα διακριτικά πρόσβασης και ID**. Είναι δεσμευμένα σε μια συγκεκριμένη συνδυασμένη χρήση χρήστη και πελάτη και μπορούν να ανακληθούν. Η προεπιλεγμένη λήξη είναι **90 ημέρες** για ανενεργά διακριτικά ανανέωσης και **χωρίς λήξη για ενεργά διακριτικά**.

{% hint style="warning" %}
Οι πληροφορίες για **συνθήκες πρόσβασης** είναι **αποθηκευμένες** μέσα στο **JWT**. Έτσι, αν ζητήσετε το **διακριτικό από μια επιτρεπόμενη διεύθυνση IP**, αυτή η **IP** θα είναι **αποθηκευμένη** στο διακριτικό και στη συνέχεια μπορείτε να χρησιμοποιήσετε αυτό το διακριτικό από μια **μη επιτρεπόμενη IP για να αποκτήσετε πρόσβαση στους πόρους**.
{% endhint %}

Ελέγξτε την παρακάτω σελίδα για να μάθετε διαφορετικούς τρόπους για να **ζητήσετε διακριτικά πρόσβασης** και να συνδεθείτε με αυτά:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

Οι πιο κοινές API endpoints είναι:

* **Azure Resource Manager** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (Το Azure AD Graph που έχει αποσυρθεί είναι graph.windows.net)

## Αναφορές

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)
* [https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration](https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
