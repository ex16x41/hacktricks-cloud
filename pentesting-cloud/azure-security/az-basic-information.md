# Az - Basic Information

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Organization Hierarchy

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

### Management Groups

Si tu organizaci√≥n tiene **muchas suscripciones de Azure**, es posible que necesites una forma de **gestionar eficientemente el acceso**, pol√≠ticas y cumplimiento para esas **suscripciones**. Los **grupos de administraci√≥n** proporcionan un **√°mbito de gobernanza por encima de las suscripciones**.

Ten en cuenta que se pueden soportar **10,000 grupos de administraci√≥n** en un solo directorio y un √°rbol de grupos de administraci√≥n puede soportar **hasta seis niveles de profundidad**.

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

[De la documentaci√≥n](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): A cada directorio se le asigna un √∫nico **grupo de administraci√≥n de nivel superior llamado grupo de administraci√≥n ra√≠z**. El grupo de administraci√≥n ra√≠z est√° integrado en la jerarqu√≠a para que **todos los grupos de administraci√≥n y suscripciones se plieguen a √©l**. Este grupo de administraci√≥n ra√≠z permite que se apliquen **pol√≠ticas globales y asignaciones de roles de Azure** a nivel de directorio. El [**Administrador Global de Azure AD** necesita elevarse a s√≠ mismo](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) al **rol de Administrador de Acceso de Usuario de este grupo ra√≠z** inicialmente. Despu√©s de elevar el acceso, el administrador puede **asignar cualquier rol de Azure a otros usuarios o grupos del directorio para gestionar la jerarqu√≠a**. Como administrador, puedes asignar **tu propia cuenta como propietario del grupo de administraci√≥n ra√≠z**.

El grupo de administraci√≥n ra√≠z **no puede ser movido o eliminado**, a diferencia de otros grupos de administraci√≥n.

Los grupos de administraci√≥n te brindan una gesti√≥n a nivel empresarial a escala, sin importar el tipo de suscripciones que puedas tener. Sin embargo, **todas las suscripciones dentro de un solo grupo de administraci√≥n** deben confiar en el **mismo inquilino de Azure Active Directory (Azure AD)**.

<figure><img src="../../.gitbook/assets/image (157).png" alt=""><figcaption></figcaption></figure>

### Azure Subscriptions

En Azure, una suscripci√≥n sirve como un **contenedor l√≥gico** con el prop√≥sito de **provisionar** recursos **empresariales o t√©cnicos**. Este contenedor mantiene los **detalles de los recursos** como m√°quinas virtuales (VMs), bases de datos, entre otros. Al crear un recurso de Azure, como una VM, se especifica la **suscripci√≥n asociada con √©l**. Esta estructura facilita la delegaci√≥n de acceso, utilizando mecanismos de control de acceso basado en roles.

### Resource Groups

[De la documentaci√≥n:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Un grupo de recursos es un **contenedor** que contiene **recursos relacionados** para una soluci√≥n de Azure. El grupo de recursos puede incluir todos los recursos para la soluci√≥n, o solo aquellos **recursos que deseas gestionar como un grupo**. Generalmente, agrega **recursos** que comparten el **mismo ciclo de vida** al mismo grupo de recursos para que puedas desplegarlos, actualizarlos y eliminarlos f√°cilmente como un grupo.

Todos los **recursos** deben estar **dentro de un grupo de recursos** y solo pueden pertenecer a un grupo, y si se elimina un grupo de recursos, tambi√©n se eliminan todos los recursos dentro de √©l.

### Administrative Units

[De la documentaci√≥n:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Las unidades administrativas te permiten **subdividir** tu organizaci√≥n en **cualquier unidad** que desees, y luego **asignar administradores espec√≠ficos** que puedan **gestionar solo a los miembros** de esa unidad. Por ejemplo, podr√≠as usar unidades administrativas para delegar permisos a los administradores de cada escuela en una gran universidad, para que puedan controlar el acceso, gestionar usuarios y establecer pol√≠ticas solo en la Escuela de Ingenier√≠a.

Solo **usuarios**, **grupos** y **dispositivos** pueden ser **miembros** de una **unidad administrativa**.

Por lo tanto, una **unidad administrativa** contendr√° algunos **miembros** y otros **principales** se les asignar√°n **permisos sobre esa** unidad administrativa que pueden usar para **gestionar a los miembros** de la unidad administrativa.

## Azure vs Azure AD vs Azure AD Domain Services

Es importante notar que **Azure AD** es un servicio **dentro** de **Azure**. **Azure** es la **plataforma en la nube** de Microsoft, mientras que **Azure AD** es un servicio de **identidad empresarial** en Azure.\
Adem√°s, **Azure AD no es como Windows Active Directory**, es un servicio de identidad que funciona de una manera completamente diferente. Si deseas ejecutar un **Controlador de Dominio en Azure** para tu entorno de Windows Active Directory, necesitas usar **Azure AD Domain Services**.

## Principals

Azure soporta diferentes tipos de principales:

* **User**: Una **persona** regular con credenciales para acceder.
* **Group**: Un **grupo de principales** gestionados juntos. **Permisos** otorgados a grupos son **heredados** por sus **miembros**.
* **Service Principal/Enterprise Applications**: Es una **identidad** creada para **uso** con **aplicaciones**, servicios alojados y herramientas automatizadas para acceder a recursos de Azure. Este acceso est√° **restringido por los roles asignados** al principal de servicio, d√°ndote control sobre **qu√© recursos pueden ser accedidos** y a qu√© nivel. Por razones de seguridad, siempre se recomienda **usar principales de servicio con herramientas automatizadas** en lugar de permitirles iniciar sesi√≥n con una identidad de usuario.

Al crear un **principal de servicio** puedes elegir entre **autenticaci√≥n por contrase√±a** o **autenticaci√≥n por certificado**.

* Si eliges **autenticaci√≥n por contrase√±a** (por defecto), **guarda la contrase√±a generada** ya que no podr√°s acceder a ella nuevamente.
* Si eliges autenticaci√≥n por certificado, aseg√∫rate de que la **aplicaci√≥n tendr√° acceso a la clave privada**.
* **Managed Identity (Metadata Creds)**: Las identidades administradas en Azure Active Directory ofrecen una soluci√≥n para **gestionar autom√°ticamente la identidad** de las aplicaciones. Estas identidades son utilizadas por aplicaciones para **conectarse** a **recursos** compatibles con la autenticaci√≥n de Azure Active Directory (**Azure AD**). Al utilizar identidades administradas, las aplicaciones pueden **asegurar tokens de Azure AD** sin necesidad de manejar credenciales directamente. Hay dos tipos de identidades administradas:
* **Asignadas por el sistema**. Algunos servicios de Azure te permiten **habilitar una identidad administrada directamente en una instancia de servicio**. Cuando habilitas una identidad administrada asignada por el sistema, se crea una identidad en Azure AD. La identidad est√° vinculada al **ciclo de vida de esa instancia de servicio**. Cuando el **recurso** es **eliminado**, Azure **elimina autom√°ticamente** la **identidad** por ti. Por dise√±o, solo ese recurso de Azure puede usar esta identidad para solicitar tokens de Azure AD.
* **Asignadas por el usuario**. Tambi√©n puedes crear una identidad administrada como un recurso independiente de Azure. Puedes [crear una identidad administrada asignada por el usuario](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) y asignarla a una o **m√°s instancias** de un servicio de Azure (m√∫ltiples recursos). Para identidades administradas asignadas por el usuario, la **identidad se gestiona por separado de los recursos que la utilizan**.

## Roles & Permissions

**Roles** son **asignados** a **principales** en un **√°mbito**: `principal -[HAS ROLE]->(scope)`

**Roles** asignados a **grupos** son **heredados** por todos los **miembros** del grupo.

Dependiendo del √°mbito al que se asign√≥ el rol, el **rol** podr√≠a ser **heredado** a **otros recursos** dentro del contenedor del √°mbito. Por ejemplo, si un usuario A tiene un **rol en la suscripci√≥n**, tendr√° ese **rol en todos los grupos de recursos** dentro de la suscripci√≥n y en **todos los recursos** dentro del grupo de recursos.

### **Classic Roles**

| **Owner**                     | <ul><li>Acceso completo a todos los recursos</li><li>Puede gestionar el acceso para otros usuarios</li></ul> | Todos los tipos de recursos |
| ----------------------------- | ---------------------------------------------------------------------------------------------------------- | --------------------------- |
| **Contributor**               | <ul><li>Acceso completo a todos los recursos</li><li>No puede gestionar el acceso</li></ul>                 | Todos los tipos de recursos |
| **Reader**                    | ‚Ä¢ Ver todos los recursos                                                                                   | Todos los tipos de recursos |
| **User Access Administrator** | <ul><li>Ver todos los recursos</li><li>Puede gestionar el acceso para otros usuarios</li></ul>              | Todos los tipos de recursos |

### Built-In roles

[De la documentaci√≥n: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) tiene varios **roles integrados de Azure** que puedes **asignar** a **usuarios, grupos, principales de servicio e identidades administradas**. Las asignaciones de roles son la forma en que controlas el **acceso a los recursos de Azure**. Si los roles integrados no cumplen con las necesidades espec√≠ficas de tu organizaci√≥n, puedes crear tus propios [**roles personalizados de Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

Los roles **integrados** se aplican solo a los **recursos** para los que est√°n **destinados**, por ejemplo, revisa estos 2 ejemplos de **roles integrados sobre recursos de Compute**:

| [Disk Backup Reader](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Proporciona permiso al vault de backup para realizar copias de seguridad de discos. | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- | ------------------------------------ |
| [Virtual Machine User Login](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Ver M√°quinas Virtuales en el portal e iniciar sesi√≥n como un usuario regular.      | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Estos roles tambi√©n pueden **asignarse sobre contenedores l√≥gicos** (como grupos de administraci√≥n, suscripciones y grupos de recursos) y los principales afectados los tendr√°n **sobre los recursos dentro de esos contenedores**.

* Encuentra aqu√≠ una lista con [**todos los roles integrados de Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Encuentra aqu√≠ una lista con [**todos los roles integrados de Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Custom Roles

Azure tambi√©n permite crear [**roles personalizados**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) con los permisos que el usuario necesita.

### Permission Denied

* Para que un **principal tenga alg√∫n acceso sobre un recurso** necesita que se le otorgue expl√≠citamente un rol (de cualquier manera) **otorg√°ndole ese permiso**.
* Una **asignaci√≥n de rol de denegaci√≥n expl√≠cita tiene prioridad** sobre el rol que otorga el permiso.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Global Administrator

Los usuarios con el rol de Administrador Global tienen la capacidad de '**elevarse' al rol de Administrador de Acceso de Usuario de Azure en el grupo de administraci√≥n ra√≠z**. Esto significa que un Administrador Global podr√° gestionar el acceso **a todas las suscripciones y grupos de administraci√≥n de Azure.**\
Esta elevaci√≥n se puede hacer al final de la p√°gina: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Azure Policies

Las pol√≠ticas de Azure son un conjunto de **reglas y regulaciones en Microsoft Azure**, un servicio de computaci√≥n en la nube, que ayudan a gestionar y hacer cumplir los est√°ndares organizacionales y a evaluar el cumplimiento a gran escala. Estas pol√≠ticas imponen diferentes reglas sobre tus **recursos de Azure**, asegurando que esos recursos se mantengan en conformidad con los est√°ndares corporativos y los acuerdos de nivel de servicio.

Las pol√≠ticas de Azure son cruciales para la gobernanza y seguridad en la nube, ayudando a asegurar que los recursos se utilicen de manera adecuada y eficiente, y que cumplan con las regulaciones externas y pol√≠ticas internas.\
Algunos ejemplos:

1. **Asegurar el Cumplimiento con Regiones Espec√≠ficas de Azure**: Esta pol√≠tica asegura que todos los recursos se desplieguen en regiones espec√≠ficas de Azure. Por ejemplo, una empresa podr√≠a querer asegurar que todos sus datos se almacenen en Europa para cumplir con el GDPR.
2. **Imponer Est√°ndares de Nomenclatura**: Las pol√≠ticas pueden imponer convenciones de nomenclatura para los recursos de Azure. Esto ayuda a organizar e identificar f√°cilmente los recursos basados en sus nombres, lo cual es √∫til en entornos grandes.
3. **Restringir Ciertos Tipos de Recursos**: Esta pol√≠tica puede restringir la creaci√≥n de ciertos tipos de recursos. Por ejemplo, se podr√≠a establecer una pol√≠tica para prevenir la creaci√≥n de tipos de recursos costosos, como ciertos tama√±os de VM, para controlar los costos.
4. **Imponer Pol√≠ticas de Etiquetado**: Las etiquetas son pares clave-valor asociados con los recursos de Azure utilizados para la gesti√≥n de recursos. Las pol√≠ticas pueden imponer que ciertas etiquetas deben estar presentes, o tener valores espec√≠ficos, para todos los recursos. Esto es √∫til para el seguimiento de costos, propiedad o categorizaci√≥n de recursos.
5. **Limitar el Acceso P√∫blico a Recursos**: Las pol√≠ticas pueden asegurar que ciertos recursos, como cuentas de almacenamiento o bases de datos, no tengan puntos finales p√∫blicos, asegurando que solo sean accesibles dentro de la red de la organizaci√≥n.
6. **Aplicar Configuraciones de Seguridad Autom√°ticamente**: Las pol√≠ticas pueden usarse para aplicar configuraciones de seguridad autom√°ticamente a los recursos, como aplicar un grupo de seguridad de red espec√≠fico a todas las VMs o asegurar que todas las cuentas de almacenamiento usen cifrado.

Ten en cuenta que las Pol√≠ticas de Azure pueden adjuntarse a cualquier nivel de la jerarqu√≠a de Azure, pero **com√∫nmente se usan en el grupo de administraci√≥n ra√≠z** o en otros grupos de administraci√≥n.

### Permissions Scope

En Azure **los permisos pueden asignarse a cualquier parte de la jerarqu√≠a**. Eso incluye grupos de administraci√≥n, suscripciones, grupos de recursos y recursos individuales. Los permisos son **heredados** por los **recursos contenidos** de la entidad donde fueron asignados.

Esta estructura jer√°rquica permite una gesti√≥n eficiente y escalable de los permisos de acceso.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (control de acceso basado en roles) es lo que ya hemos visto en las secciones anteriores: **Asignar un rol a un principal para otorgarle acceso** sobre un recurso.\
Sin embargo, en algunos casos podr√≠as querer proporcionar una **gesti√≥n de acceso m√°s detallada** o **simplificar** la gesti√≥n de **cientos** de **asignaciones de roles**.

Azure **ABAC** (control de acceso basado en atributos) se basa en Azure RBAC a√±adiendo **condiciones de asignaci√≥n de roles basadas en atributos** en el contexto de acciones espec√≠ficas. Una _condici√≥n de asignaci√≥n de roles_ es una **verificaci√≥n adicional que puedes opcionalmente agregar a tu asignaci√≥n de roles** para proporcionar un control de acceso m√°s detallado. Una condici√≥n filtra los permisos otorgados como parte de la definici√≥n del rol y la asignaci√≥n del rol. Por ejemplo, puedes **agregar una condici√≥n que requiera que un objeto tenga una etiqueta espec√≠fica para leer el objeto**.\
No puedes **negar expl√≠citamente** **acceso** a recursos espec√≠ficos **usando condiciones**.

### Default User Permissions

Un usuario b√°sico tendr√° algunos **permisos predeterminados** para enumerar algunas partes de AzureAD:

* Leer todos los usuarios, Grupos, Aplicaciones, Dispositivos, Roles, Suscripciones y sus propiedades p√∫blicas
* Invitar a Invitados (_puede desactivarse_)
* Crear grupos de Seguridad
* Leer membres√≠as de Grupos no ocultas
* Agregar invitados a grupos Propios
* Crear nueva
