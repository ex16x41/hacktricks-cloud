# Az - Taarifa za Msingi

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **fuata** sisi kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}

## Hierarchi ya Shirika

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUchBvhjIdWWR2ldAkWiZMdmrcEYD9Ti5UAa3zAGr9YbAnx4Q_gZNp_zvOU429vgWZ_ixoYHQKdC8bGgkhWYCy591SRIFj6RKCj4BEpVQixAGsp3T3O5sS3k7x5CTaJ-SCBNC7i5KluLyxdiXoZsH1F0ko1Gv88=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption></figcaption></figure>

### Makundi ya Usimamizi

* Inaweza kuwa na **makundi mengine ya usimamizi au usajili**.
* Hii inaruhusu **kutekeleza udhibiti wa utawala** kama RBAC na Sera za Azure mara moja kwenye kiwango cha kundi la usimamizi na kuwa **na urithi** na usajili wote katika kundi hilo.
* **Makundi 10,000 ya usimamizi** yanaweza kuungwa mkono katika directory moja.
* Mti wa kundi la usimamizi unaweza kuunga mkono **hadi viwango sita vya kina**. Kiwango hiki hakijumuishi kiwango cha mzizi au kiwango cha usajili.
* Kila kundi la usimamizi na usajili linaweza kuunga mkono **mzazi mmoja tu**.
* Hata kama makundi kadhaa ya usimamizi yanaweza kuundwa **kuna kundi moja tu la usimamizi mzizi**.
* Kundi la usimamizi mzizi **linashikilia** makundi yote **mengine ya usimamizi na usajili** na **halitaweza kuhamishwa au kufutwa**.
* Usajili wote ndani ya kundi moja la usimamizi lazima uamini **tenant moja ya Entra ID.**

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption><p><a href="https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png">https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png</a></p></figcaption></figure>

### Usajili wa Azure

* Ni **chombo kingine cha mantiki ambacho rasilimali** (VMs, DBs‚Ä¶) zinaweza kuendeshwa na zitalipwa.
* **Mzazi** wake daima ni **kundi la usimamizi** (na inaweza kuwa kundi la usimamizi mzizi) kwani usajili hauwezi kuwa na usajili mwingine.
* Ina **aminika tu kwenye directory moja ya Entra ID**
* **Ruhusa** zilizotumika kwenye kiwango cha usajili (au yoyote ya wazazi wake) **zinarithiwa** kwa rasilimali zote ndani ya usajili

### Makundi ya Rasilimali

[Kutoka kwenye nyaraka:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Kundi la rasilimali ni **chombo** kinachoshikilia **rasilimali zinazohusiana** kwa suluhisho la Azure. Kundi la rasilimali linaweza kujumuisha rasilimali zote za suluhisho, au zile tu **rasilimali ambazo unataka kusimamia kama kundi**. Kwa ujumla, ongeza **rasilimali** zinazoshiriki **mzunguko sawa** kwenye kundi moja la rasilimali ili uweze kupeleka, kusasisha, na kufuta kwa urahisi kama kundi.

Rasilimali zote **lazima ziwe **ndani ya kundi la rasilimali** na zinaweza kumilikiwa tu na kundi moja na ikiwa kundi la rasilimali litafutwa, rasilimali zote ndani yake pia zitafutwa.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfe8U30iP_vdZCvxX4g8nEPRLoo7v0kmCGkDn1frBPn3_GIoZ7VT2LkdsVQWCnrG_HSYNRRPM-1pSECUkbDAB-9YbUYLzpvKVLDETZS81CHWKYM4fDl3oMo5-yvTMnjdLTS2pz8U67xUTIzBhZ25MFMRkq5koKY=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption><p><a href="https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1">https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1</a></p></figcaption></figure>

### Vitambulisho vya Rasilimali za Azure

Kila rasilimali katika Azure ina Vitambulisho vya Rasilimali za Azure vinavyoiweka.

Muundo wa Vitambulisho vya Rasilimali za Azure ni kama ifuatavyo:

* `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderNamespace}/{resourceType}/{resourceName}`

Kwa mashine ya virtual inayoitwa myVM katika kundi la rasilimali `myResourceGroup` chini ya ID ya usajili `12345678-1234-1234-1234-123456789012`, Vitambulisho vya Rasilimali za Azure vinaonekana kama ifuatavyo:

* `/subscriptions/12345678-1234-1234-1234-123456789012/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM`

## Azure vs Entra ID vs Huduma za Kikoa za Azure AD

### Azure

Azure ni jukwaa la **kumbukumbu la kompyuta la Microsoft, linalotoa huduma mbalimbali**, ikiwa ni pamoja na mashine za virtual, hifadhidata, akili bandia, na uhifadhi. Inafanya kazi kama msingi wa kuendesha na kusimamia programu, kujenga miundombinu inayoweza kupanuka, na kuendesha kazi za kisasa katika wingu. Azure inatoa zana kwa waendelezaji na wataalamu wa IT kuunda, kupeleka, na kusimamia programu na huduma kwa urahisi, ikihudumia mahitaji mbalimbali kutoka kwa biashara za kuanzishwa hadi makampuni makubwa.

### Entra ID (zamani Azure Active Directory)

Entra ID ni huduma ya **utambulisho na usimamizi wa ufikiaji** inayotegemea wingu iliyoundwa kushughulikia uthibitishaji, idhini, na udhibiti wa ufikiaji wa watumiaji. Inatoa ufikiaji salama kwa huduma za Microsoft kama Office 365, Azure, na programu nyingi za SaaS za wahusika wengine. Ikiwa na vipengele kama uthibitishaji wa moja kwa moja (SSO), uthibitishaji wa hatua nyingi (MFA), na sera za ufikiaji wa masharti miongoni mwa wengine.

### Huduma za Kikoa za Entra (zamani Azure AD DS)

Huduma za Kikoa za Entra zinaongeza uwezo wa Entra ID kwa kutoa **huduma za kikoa zinazoweza kusimamiwa zinazofaa na mazingira ya jadi ya Windows Active Directory**. Inasaidia protokali za zamani kama LDAP, Kerberos, na NTLM, ikiruhusu mashirika kuhamasisha au kuendesha programu za zamani katika wingu bila kupeleka wakala wa kikoa wa ndani. Huduma hii pia inasaidia Sera za Kundi kwa usimamizi wa kati, na kuifanya iweze kutumika katika hali ambapo kazi za zamani au zinazotegemea AD zinahitaji kuwepo pamoja na mazingira ya kisasa ya wingu.

## Misingi ya Entra ID

### Watumiaji

* **Watumiaji wapya**
* Onyesha jina la barua pepe na kikoa kutoka kwa tenant iliyochaguliwa
* Onyesha jina la kuonyesha
* Onyesha nenosiri
* Onyesha mali (jina la kwanza, cheo cha kazi, taarifa za mawasiliano‚Ä¶)
* Aina ya mtumiaji wa kawaida ni ‚Äú**mwanachama**‚Äù
* **Watumiaji wa nje**
* Onyesha barua pepe ya kuwalika na jina la kuonyesha (inaweza kuwa barua pepe isiyo ya Microsoft)
* Onyesha mali
* Aina ya mtumiaji wa kawaida ni ‚Äú**Mgeni**‚Äù

### Ruhusa za Kawaida za Watumiaji

* **Wajumbe (**[**nyaraka**](https://learn.microsoft.com/en-gb/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions)**)**
* Sajili Maombi: Kawaida **Ndio**
* Punguza watumiaji wasio wasimamizi kuunda tenants: Kawaida **Hapana**
* Unda makundi ya usalama: Kawaida **Ndio**
* Punguza ufikiaji wa lango la usimamizi wa Microsoft Entra: Kawaida **Hapana**
* Hii haipunguzi ufikiaji wa API kwa lango (tu wavuti)
* Ruhusu watumiaji kuunganisha akaunti za kazi au shule na LinkedIn: Kawaida **Ndio**
* Onyesha kuweka mtumiaji alisajiliwa: Kawaida **Ndio**
* Punguza watumiaji kutoka kupona funguo za BitLocker kwa vifaa vyao: Kawaida Hapana (angalia kwenye Mipangilio ya Kifaa)
* Soma watumiaji wengine: Kawaida **Ndio** (kupitia Microsoft Graph)
* **Wageni**
* **Vikwazo vya ufikiaji wa mtumiaji mgeni**
* **Watumiaji wageni wana ufikiaji sawa na wajumbe** wanatoa ruhusa zote za mtumiaji wa mwanachama kwa watumiaji wageni kwa default.
* **Watumiaji wageni wana ufikiaji mdogo kwa mali na uanachama wa vitu vya directory (kawaida)** hupunguza ufikiaji wa wageni kwa wasifu wao wenyewe wa mtumiaji kwa default. Ufikiaji wa watumiaji wengine na taarifa za kikundi haukubaliki tena.
* **Ufikiaji wa mtumiaji mgeni unakabiliwa na mali na uanachama wa vitu vyao vya directory** ni wa kikomo zaidi.
* **Wageni wanaweza kuwalika**
* **Mtu yeyote katika shirika anaweza kuwalika watumiaji wageni ikiwa ni pamoja na wageni na wasimamizi (inayojumuisha zaidi) - Kawaida**
* **Watumiaji wa mwanachama na watumiaji waliotolewa kwa majukumu maalum ya usimamizi wanaweza kuwalika watumiaji wageni ikiwa ni pamoja na wageni wenye ruhusa za mwanachama**
* **Ni watumiaji pekee waliotolewa kwa majukumu maalum ya usimamizi wanaweza kuwalika watumiaji wageni**
* **Hakuna mtu katika shirika anaweza kuwalika watumiaji wageni ikiwa ni pamoja na wasimamizi (inayokandamiza zaidi)**
* **Mtumiaji wa nje aondoke**: Kawaida **Kweli**
* Ruhusu watumiaji wa nje kuondoka katika shirika

{% hint style="success" %}
Hata kama imepunguzika kwa kawaida, watumiaji (wanachama na wageni) wenye ruhusa zilizotolewa wanaweza kufanya vitendo vya awali.
{% endhint %}

### **Misingi ya Huduma**

**Msingi wa Huduma** ni **utambulisho** ulioanzishwa kwa **matumizi** na **programu**, huduma zinazohudumiwa, na zana za kiotomatiki kufikia rasilimali za Azure. Ufikiaji huu **umepunguzika na majukumu yaliyotolewa** kwa msingi wa huduma, na kukupa udhibiti juu ya **rasilimali zipi zinaweza kufikiwa** na kwa kiwango gani. Kwa sababu za usalama, kila wakati inapendekezwa **kutumia misingi ya huduma na zana za kiotomatiki** badala ya kuruhusu kuingia kwa utambulisho wa mtumiaji.

Inawezekana **kuingia moja kwa moja kama msingi wa huduma** kwa kuunda **siri** (nenosiri), **cheti**, au kutoa **ufikiaji wa shirikisho** kwa majukwaa ya wahusika wengine (kwa mfano, Github Actions) juu yake.

* Ikiwa unachagua uthibitishaji wa **nenosiri** (kwa kawaida), **hifadhi nenosiri lililotengenezwa** kwani huwezi kulifikia tena.
* Ikiwa unachagua uthibitishaji wa cheti, hakikisha **programu itakuwa na ufikiaji wa funguo za faragha**.

### Usajili wa Programu

**Usajili wa Programu** ni usanidi unaoruhusu programu kuungana na Entra ID na kufanya vitendo.

#### Vipengele Muhimu:

1. **Kitambulisho cha Programu (Kitambulisho cha Mteja):** Kitambulisho cha kipekee kwa programu yako katika Azure AD.
2. **URIs za Kurudisha:** URLs ambapo Azure AD inatuma majibu ya uthibitishaji.
3. **Cheti, Siri & Hati za Shirikisho:** Inawezekana kuunda siri au cheti kuingia kama msingi wa huduma wa programu, au kutoa ufikiaji wa shirikisho kwake (kwa mfano, Github Actions).&#x20;
1. Ikiwa **cheti** au **siri** imeundwa, mtu anaweza **kuingia kama msingi wa huduma** kwa zana za CLI kwa kujua **kitambulisho cha programu**, **siri** au **cheti** na **tenant** (kikoa au ID).
4. **Ruhusa za API:** Inabainisha rasilimali au APIs ambazo programu inaweza kufikia.
5. **Mipangilio ya Uthibitishaji:** Inabainisha mchakato wa uthibitishaji unaounga mkono wa programu (kwa mfano, OAuth2, OpenID Connect).
6. **Msingi wa Huduma**: Msingi wa huduma huundwa wakati programu inaundwa (ikiwa inafanywa kutoka kwenye konsole ya wavuti) au wakati inasakinishwa katika tenant mpya.
1. **Msingi wa huduma** utapata ruhusa zote zilizohitajika alizopangwa nazo.

### Programu za Biashara

Ni **meza tu katika Azure kuchuja misingi ya huduma** na kuangalia programu ambazo zimepewa.

**Sio aina nyingine ya "programu",** hakuna kitu chochote katika Azure ambacho ni "Programu ya Biashara", ni tu abstractions ya kuangalia Misingi ya huduma, Usajili wa programu na utambulisho wa kusimamiwa.

### **Utambulisho wa Kusimamiwa (Metadata)**

Utambulisho wa kusimamiwa katika Azure Active Directory unatoa suluhisho la **kusimamia kiotomatiki utambulisho** wa programu. Utambulisho huu unatumika na programu kwa lengo la **kuunganisha** na **rasilimali** zinazofaa na uthibitishaji wa Azure Active Directory (**Azure AD**). Hii inaruhusu **kuondoa haja ya kuweka akiba ya akiba ya wingu** katika msimbo kwani programu itakuwa na uwezo wa kuwasiliana na huduma ya **metadata** ili kupata token halali ya **kufanya vitendo** kama utambulisho wa kusimamiwa ulioonyeshwa katika Azure.

Kuna aina mbili za utambulisho wa kusimamiwa:

* **Iliyotolewa na mfumo**. Huduma zingine za Azure zinakuruhusu **kuwezesha utambulisho wa kusimamiwa moja kwa moja kwenye mfano wa huduma**. Unapowezesha utambulisho wa kusimamiwa uliopewa mfumo, **misingi ya huduma** inaundwa katika tenant ya Entra ID inayotegemewa na usajili ambapo rasilimali iko. Wakati **rasilimali** inafutwa, Azure kiotomatiki **inafuta** **utambulisho** kwa ajili yako.
* **Iliyotolewa na mtumiaji**. Pia inawezekana kwa watumiaji kuunda utambulisho wa kusimamiwa. Hizi zinaundwa ndani ya kundi la rasilimali ndani ya usajili na msingi wa huduma utaundwa katika EntraID inayotegemewa na usajili. Kisha, unaweza kutoa utambulisho wa kusimamiwa kwa mfano mmoja au **zaidi** ya huduma ya Azure (rasilimali nyingi). Kwa utambulisho wa kusimamiwa wa mtumiaji, **utambulisho unasimamiwa tofauti na rasilimali zinazoutumia**.

Utambulisho wa Kusimamiwa **hauzali funguo za kudumu** (kama nenosiri au vyeti) kufikia kama msingi wa huduma ulioambatanishwa nayo.

### Ruhusa za Kawaida za Idhini

**Idhini ya mtumiaji kwa programu**

* **Usiruhusu idhini ya mtumiaji**
* Msimamizi atahitajika kwa programu zote.
* **Ruhusu idhini ya mtumiaji kwa programu kutoka kwa wachapishaji waliothibitishwa, kwa ruhusa zilizochaguliwa (Inapendekezwa)**
* Watumiaji wote wanaweza kutoa idhini kwa ruhusa zinazohesabiwa kama "athari ndogo", kwa programu kutoka kwa wachapishaji waliothibitishwa au programu zilizoorodheshwa katika shirika hili.
* **Kawaida** ruhusa za athari ndogo (ingawa unahitaji kukubali kuziweka kama ndogo):
* User.Read - ingia na soma wasifu wa mtumiaji
* offline\_access - kudumisha ufikiaji wa data ambayo watumiaji wameipa ufikiaji
* openid - ingiza watumiaji
* profile - ona wasifu wa msingi wa mtumiaji
* email - ona anwani ya barua pepe ya mtumiaji
* **Ruhusu idhini ya mtumiaji kwa programu (Kawaida)**
* Watumiaji wote wanaweza kutoa idhini kwa programu yoyote kufikia data ya shirika.

**Maombi ya idhini ya msimamizi**: Kawaida **Hapana**

* Watumiaji wanaweza kuomba idhini ya msimamizi kwa programu ambazo hawawezi kutoa idhini
* Ikiwa **Ndio**: Inawezekana kuonyesha Watumiaji, Makundi na Majukumu ambayo yanaweza kutoa maombi ya idhini
* Sanidi pia ikiwa watumiaji watapokea arifa za barua pepe na ukumbusho wa muda wa mwisho&#x20;

### Vitengo vya Utawala

[Kutoka kwenye nyaraka:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Vitengo vya utawala vinakuruhusu **kugawanya** shirika lako katika **kitengo chochote** unachotaka, na kisha **kutoa wasimamizi maalum** wanaoweza **kusimamia tu wanachama** wa kitengo hicho. Kwa mfano, unaweza kutumia vitengo vya utawala kutoa ruhusa kwa wasimamizi wa kila shule katika chuo kikuu kikubwa, ili waweze kudhibiti ufikiaji, kusimamia watumiaji, na kuweka sera tu katika Shule ya Uhandisi.

Ni **watumiaji**, **makundi** na **vifaa** pekee wanaweza kuwa **wanachama** wa **kitengo cha utawala**.

Kwa hivyo, **Kitengo cha Utawala** kitakuwa **na** baadhi ya **wanachama** na misingi mingine **itawekwa ruhusa juu ya** kitengo hicho cha utawala ambacho wanaweza kutumia kusimamia wanachama wa kitengo cha utawala.

## Majukumu & Ruhusa

**Majukumu** yanapewa **misingi** kwenye **kasi**: `principal -[HAS ROLE]->(scope)`

**Majukumu** yaliyotolewa kwa **makundi** yanarithiwa na **wanachama** wote wa kundi hilo.

Kulingana na kasi ambayo jukumu lilitolewa, **jukumu** linaweza **kurithiwa** kwa **rasilimali nyingine** ndani ya chombo cha kasi. Kwa mfano, ikiwa mtumiaji A ana **jukumu kwenye usajili**, atakuwa na **jukumu hilo kwenye makundi yote ya rasilimali** ndani ya usajili na kwenye **rasilimali zote** ndani ya kundi la rasilimali.

### **Majukumu ya K klasiki**

| **Mmiliki**                     | <ul><li>Ufikiaji kamili kwa rasilimali zote</li><li>Anaweza kusimamia ufikiaji kwa watumiaji wengine</li></ul> | Aina zote za rasilimali |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Mchangiaji**               | <ul><li>Ufikiaji kamili kwa rasilimali zote</li><li>Haiwezi kusimamia ufikiaji</li></ul>              | Aina zote za rasilimali |
| **Msomaji**                    | ‚Ä¢ Ona rasilimali zote                                                                     | Aina zote za rasilimali |
| **Msimamizi wa Ufikiaji wa Mtumiaji** | <ul><li>Ona rasilimali zote</li><li>Anaweza kusimamia ufikiaji kwa watumiaji wengine</li></ul>           | Aina zote za rasilimali |

### Majukumu Yaliyoundwa Ndani

[Kutoka kwenye nyaraka: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Udhibiti wa ufikiaji wa Azure (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ina majukumu kadhaa ya Azure **yaliyoundwa ndani** ambayo unaweza **kutoa** kwa **watumiaji, makundi, misingi ya huduma, na utambulisho wa kusimamiwa**. Ugawaji wa majukumu ndiyo njia unayodhibiti **ufikiaji wa rasilimali za Azure**. Ikiwa majukumu yaliyoundwa ndani hayakidhi mahitaji maalum ya shirika lako, unaweza kuunda [**majukumu ya kawaida ya Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

**Majukumu Yaliyoundwa Ndani** yanatumika tu kwa **rasilimali** ambazo zimewekwa, kwa mfano angalia mifano hii 2 ya **Majukumu Yaliyoundwa Ndani** juu ya rasilimali za **Kumbukumbu**:

| [Msomaji wa Nakala ya Disk](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Inatoa ruhusa kwa vault ya nakala kufanya nakala ya disk.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Mtumiaji wa Kuingia kwa Mashine ya Virtual](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Ona Mashine za Virtual kwenye lango na kuingia kama mtumiaji wa kawaida. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Majukumu haya yanaweza **pia kutolewa juu ya vyombo vya mantiki** (kama vile makundi ya usimamizi, usajili na makundi ya rasilimali) na misingi iliyoathiriwa itakuwa nayo **juu ya rasilimali ndani ya vyombo hivyo**.

* Pata hapa orodha ya [**majukumu yote ya Azure yaliyoundwa ndani**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Pata hapa orodha ya [**majukumu yote ya Azure AD yaliyoundwa ndani**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Majukumu ya Kawaida

Azure pia inaruhusu kuunda [**majukumu ya kawaida**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) yenye ruhusa ambazo mtumiaji anahitaji.

### Ruhusa Zimekataliwa

* Ili **misingi iwe na ufikiaji wa rasilimali** anahitaji jukumu wazi kupewa kwake (kwa namna yoyote) **kumruhusu hiyo ruhusa**.
* Ugawaji wa jukumu la wazi **unachukua kipaumbele** juu ya jukumu linalotoa ruhusa.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Msimamizi wa Kimataifa

Watumiaji wenye jukumu la Msimamizi wa Kimataifa wana uwezo wa '**kuinua' kuwa Msimamizi wa Ufikiaji wa Mtumiaji wa Azure kwa kundi la usimamizi mzizi**. Hii inamaanisha kwamba Msimamizi wa Kimataifa ataweza kusimamia ufikiaji **wa usajili wote wa Azure na makundi ya usimamizi.**\
Kuinua hii inaweza kufanywa mwishoni mwa ukurasa: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Sera za Azure

Sera za Azure ni seti ya **sheria na kanuni katika Microsoft Azure**, huduma ya kompyuta ya wingu, inayosaidia kusimamia na kutekeleza viwango vya shirika na kutathmini ufuatiliaji kwa kiwango. Sera hizi zinaweka sheria tofauti juu ya **rasilimali zako za Azure**, kuhakikisha kwamba rasilimali hizo zinabaki kufuata viwango vya kampuni na makubaliano ya kiwango cha huduma.

Sera za Azure ni muhimu kwa utawala wa wingu na usalama, kusaidia kuhakikisha kwamba rasilimali zinatumika ipasavyo na kwa ufanisi, na kwamba zinatii kanuni za nje na sera za ndani.\
Mfano kadhaa:

1. **Kuhakikisha Ufuatiliaji na Mikoa Maalum ya Azure**: Sera hii inahakikisha kwamba rasilimali zote zinapelekwa katika mikoa maalum ya Azure. Kwa mfano, kampuni inaweza kutaka kuhakikisha kwamba data yake yote inahifadhiwa barani Ulaya kwa ajili ya ufuatiliaji wa GDPR.
2. **Kutekeleza Viwango vya Ujazo**: Sera zinaweza kutekeleza kanuni za ujazo kwa rasilimali za Azure. Hii inasaidia katika kuandaa na kutambua rasilimali kwa urahisi kulingana na majina yao, ambayo ni muhimu katika mazingira makubwa.
3. **Kukataza Aina Fulani za Rasilimali**: Sera hii inaweza kukataza uundaji wa aina fulani za rasilimali. Kwa mfano, sera inaweza kuwekwa kuzuia uundaji wa aina za rasilimali ghali, kama vile ukubwa fulani wa VM, ili kudhibiti gharama.
4. **Kutekeleza Sera za Kuweka Alama**: Alama ni jozi za funguo-thamani zinazohusishwa na rasilimali za Azure zinazotumika kwa usimamizi wa rasilimali. Sera zinaweza kutekeleza kwamba alama fulani lazima ziwepo, au kuwa na thamani maalum, kwa rasilimali zote. Hii ni muhimu kwa ufuatiliaji wa gharama, umiliki, au uainishaji wa rasilimali.
5. **Kukataza Ufikiaji wa Umma kwa Rasilimali**: Sera zinaweza kutekeleza kwamba rasilimali fulani, kama vile akaunti za hifadhi au hifadhidata, hazina mwisho wa umma, kuhakikisha kwamba zinaweza kufikiwa tu ndani ya mtandao wa shirika.
6. **Kutekeleza Mipangilio ya Usalama Kiotomatiki**: Sera zinaweza kutumika kutekeleza mipangilio ya usalama kiotomatiki kwa rasilimali, kama vile kutekeleza kundi maalum la usalama wa mtandao kwa VMs zote au kuhakikisha kwamba akaunti zote za hifadhi zinatumia usimbaji.

Kumbuka kwamba Sera za Azure zinaweza kuunganishwa kwenye kiwango chochote cha hierarchi ya Azure, lakini mara nyingi hutumiwa katika kundi la usimamizi mzizi au katika makundi mengine ya usimamizi.

### Kiwango cha Ruhusa

Katika Azure **ruhusa zinaweza kutolewa kwa sehemu yoyote ya hierarchi**. Hii inajumuisha makundi ya usimamizi, usajili, makundi ya rasilimali, na rasilimali binafsi. Ruhusa **zinarithiwa** na **rasilimali** zilizomo katika chombo ambacho zilitolewa.

Muundo huu wa hierarchi unaruhusu usimamizi wa ufikiaji wa ruhusa kwa ufanisi na kwa kiwango.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (udhibiti wa ufikiaji kulingana na jukumu) ni kile tulichokiona tayari katika sehemu zilizopita: **Kutoa jukumu kwa msingi ili kumruhusu ufikiaji** juu ya rasilimali.\
Hata hivyo, katika baadhi ya matukio unaweza kutaka kutoa **usimamizi wa ufikiaji wa kina zaidi** au **rahisisha** usimamizi wa **mamia** ya **ugawaji wa majukumu**.

Azure **ABAC** (udhibiti wa ufikiaji kulingana na sifa) inajenga juu ya Azure RBAC kwa kuongeza **masharti ya ugawaji wa jukumu kulingana na sifa** katika muktadha wa vitendo maalum. Masharti ya _ugawaji wa jukumu_ ni **ukaguzi wa ziada ambao unaweza kuongezwa kwa hiari kwenye ugawaji wako wa jukumu** ili kutoa udhibiti wa ufikiaji wa kina zaidi. Masharti yanachuja ruhusa zinazotolewa kama sehemu ya ufafanuzi wa jukumu na ugawaji wa jukumu. Kwa mfano, unaweza **kuongeza sharti linalohitaji kitu kuwa na alama maalum ili kusoma kitu hicho**.\
Huwezi **kukataa** **ufikiaji** kwa rasilimali maalum **ukitumia masharti**.

### Ruhusa za Kawaida za Watumiaji

Mtumiaji wa msingi atakuwa na baadhi ya **ruhusa za kawaida** za kuorodhesha sehemu fulani za AzureAD:

* Soma watumiaji wote, Makundi, Programu, Vifaa, Majukumu, Usajili, na mali zao za umma
* Walike Wageni (_inaweza kuzuiwa_)
* Unda Makundi ya Usalama
* Soma uanachama wa Kundi usiofichika
* Ongeza wageni kwenye makundi yaliyomilikiwa
* Unda programu mpya (_inaweza kuzuiwa_)
* Ongeza hadi vifaa 50 kwenye Azure (_inaweza kuzuiwa_)

Unaweza kuona orodha kamili ya [**ruhusa za kawaida za watumiaji** katika nyaraka](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Aidha, kumbuka kwamba katika orodha hiyo unaweza pia kuona **orodha ya ruhusa za kawaida za wageni**.

{% hint style="info" %}
Kumbuka kwamba ili kuorodhesha rasilimali za Azure mtumiaji anahitaji ruhusa wazi ya idhini.
{% endhint %}

### Usimamizi wa Utambulisho wa Kipekee (PIM)

Usimamizi wa Utambulisho wa Kipekee (PIM) katika Azure ni zana inayosimamia, kudhibiti, na kufuatilia ufikiaji wa kipekee katika Azure Active Directory na Azure. Inaboresha usalama kwa kutoa **ufikiaji wa kipekee wa wakati na wa muda mfupi**, **kuweka mchakato wa idhini, na kuhitaji uthibitishaji wa ziada**. Njia hii inapunguza hatari ya ufikiaji usioidhinishwa kwa kuhakikisha kwamba ruhusa zilizoinuliwa zinatolewa tu wakati inahitajika na kwa muda maalum.

## Token za Uthibitishaji

Kuna **aina tatu za token** zinazotumika katika OIDC:

* [**Token za Ufikiaji**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Mteja anawasilisha token hii kwa seva ya rasilimali ili **kufikia rasilimali**. Inaweza kutumika tu kwa mchanganyiko maalum wa mtumiaji, mteja, na rasilimali na **haiwezi kufutwa** hadi ipite muda - hiyo ni saa 1 kwa kawaida. Ugunduzi ni mdogo kutumia hii.
* **Token za ID**: Mteja anapata token hii **kutoka kwa seva ya idhini**. Inajumuisha taarifa za msingi kuhusu mtumiaji. Inafungwa kwa mchanganyiko maalum wa mtumiaji na mteja.
* **Token za Kurefresh**: Zinapatikana kwa mteja pamoja na token za ufikiaji. Zinatumika **kupata token mpya za ufikiaji na ID**. Inafungwa kwa mchanganyiko maalum wa mtumiaji na mteja na inaweza kufutwa. Muda wa kawaida wa kumalizika ni **siku 90** kwa token za kurefresh zisizofanya kazi na **hakuna muda wa kumalizika kwa token za kazi**.

{% hint style="warning" %}
Taarifa za **ufikiaji wa masharti** zimehifadhiwa ndani ya **JWT**. Hivyo, ikiwa unahitaji **token kutoka anwani ya IP iliyoidhinishwa**, hiyo **IP** itahifadhiwa katika token na kisha unaweza kutumia token hiyo kutoka **IP isiyoidhinishwa kufikia rasilimali**.
{% endhint %}

Angalia ukurasa ufuatao kujifunza njia tofauti za **kuomba token za ufikiaji** na kuingia nazo:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

Sehemu maarufu za API ni:

* **Meneja wa Rasilimali za Azure** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (Azure AD Graph ambayo imeondolewa ni graph.windows.net)

## Marejeleo

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)
* [https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration](https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration)

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **fuata** sisi kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
