# Az - Informazioni di Base

{% hint style="success" %}
Impara e pratica il Hacking AWS:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Impara e pratica il Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}

## Gerarchia dell'Organizzazione

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

### Gruppi di Gestione

Se la tua organizzazione ha **molte sottoscrizioni Azure**, potresti aver bisogno di un modo per gestire in modo efficiente **l'accesso**, le politiche e la conformit√† per quelle **sottoscrizioni**. I **gruppi di gestione** forniscono un **ambito di governance sopra le sottoscrizioni**.

Nota che possono essere supportati **10.000 gruppi di gestione** in una singola directory e un albero di gruppi di gestione pu√≤ supportare **fino a sei livelli di profondit√†**.

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

[Da documentazione](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): Ogni directory riceve un singolo **gruppo di gestione di livello superiore chiamato gruppo di gestione radice**. Il gruppo di gestione radice √® integrato nella gerarchia per avere **tutti i gruppi di gestione e le sottoscrizioni che si uniscono ad esso**. Questo gruppo di gestione radice consente di applicare **politiche globali e assegnazioni di ruolo Azure** a livello di directory. L'[**Amministratore Globale di Azure AD** deve elevare se stesso](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) al **ruolo di Amministratore Accesso Utente di questo gruppo radice** inizialmente. Dopo aver elevato l'accesso, l'amministratore pu√≤ **assegnare qualsiasi ruolo Azure ad altri utenti o gruppi della directory per gestire la gerarchia**. Come amministratore, puoi assegnare **il tuo stesso account come proprietario del gruppo di gestione radice**.

Il gruppo di gestione radice **non pu√≤ essere spostato o eliminato**, a differenza degli altri gruppi di gestione.

I gruppi di gestione ti offrono una gestione di livello enterprise su larga scala, indipendentemente dal tipo di sottoscrizioni che potresti avere. Tuttavia, **tutte le sottoscrizioni all'interno di un singolo gruppo di gestione** devono fidarsi dello **stesso tenant di Azure Active Directory (Azure AD)**.

<figure><img src="../../.gitbook/assets/image (157).png" alt=""><figcaption></figcaption></figure>

### Sottoscrizioni Azure

In Azure, una sottoscrizione funge da **contenitore logico** per il **provisioning** di risorse **aziendali o tecniche**. Questo contenitore mantiene i **dettagli delle risorse** come macchine virtuali (VM), database, tra gli altri. Al momento della creazione di una risorsa Azure, come una VM, viene specificata la **sottoscrizione associata**. Questa struttura facilita la delega dell'accesso, utilizzando meccanismi di controllo degli accessi basati sui ruoli.

### Gruppi di Risorse

[Da documentazione:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Un gruppo di risorse √® un **contenitore** che contiene **risorse correlate** per una soluzione Azure. Il gruppo di risorse pu√≤ includere tutte le risorse per la soluzione, o solo quelle **risorse che desideri gestire come un gruppo**. In generale, aggiungi **risorse** che condividono il **stesso ciclo di vita** allo stesso gruppo di risorse in modo da poterle facilmente distribuire, aggiornare ed eliminare come un gruppo.

Tutte le **risorse** devono essere **all'interno di un gruppo di risorse** e possono appartenere solo a un gruppo e se un gruppo di risorse viene eliminato, tutte le risorse al suo interno vengono anch'esse eliminate.

### Unit√† Amministrative

[Da documentazione:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Le unit√† amministrative ti consentono di **suddividere** la tua organizzazione in **qualsiasi unit√†** che desideri, e poi **assegnare amministratori specifici** che possono **gestire solo i membri** di quell'unit√†. Ad esempio, potresti utilizzare le unit√† amministrative per delegare permessi agli amministratori di ciascuna scuola in una grande universit√†, in modo che possano controllare l'accesso, gestire gli utenti e impostare politiche solo nella Scuola di Ingegneria.

Solo **utenti**, **gruppi** e **dispositivi** possono essere **membri** di un'**unit√† amministrativa**.

Pertanto, un'**unit√† amministrativa** conterr√† alcuni **membri** e altri **principali** saranno **assegnati permessi su quell'**unit√† amministrativa** che possono utilizzare per **gestire i membri** dell'unit√† amministrativa.

## Azure vs Azure AD vs Azure AD Domain Services

√à importante notare che **Azure AD** √® un servizio **all'interno** di **Azure**. **Azure** √® la **piattaforma cloud** di Microsoft mentre **Azure AD** √® il servizio di **identit√†** **aziendale** in Azure.\
Inoltre, **Azure AD non √® come Windows Active Directory**, √® un servizio di identit√† che funziona in un modo completamente diverso. Se desideri eseguire un **Domain Controller in Azure** per il tuo ambiente Windows Active Directory, devi utilizzare **Azure AD Domain Services**.

## Principali

Azure supporta diversi tipi di principali:

* **Utente**: Una persona **normale** con credenziali per accedere.
* **Gruppo**: Un **gruppo di principali** gestiti insieme. I **permessi** concessi ai gruppi sono **ereditati** dai suoi **membri**.
* **Service Principal/Applicazioni Aziendali**: √à un'**identit√†** creata per **l'uso** con **applicazioni**, servizi ospitati e strumenti automatizzati per accedere alle risorse Azure. Questo accesso √® **ristretto dai ruoli assegnati** al service principal, dandoti il controllo su **quali risorse possono essere accessibili** e a quale livello. Per motivi di sicurezza, √® sempre consigliato **utilizzare service principal con strumenti automatizzati** piuttosto che consentire loro di accedere con un'identit√† utente.

Quando crei un **service principal** puoi scegliere tra **autenticazione con password** o **autenticazione con certificato**.

* Se scegli l'autenticazione **con password** (per impostazione predefinita), **salva la password generata** poich√© non potrai accedervi di nuovo.
* Se scegli l'autenticazione con certificato, assicurati che l'**applicazione avr√† accesso alla chiave privata**.
* **Identit√† Gestita (Credenziali Metadata)**: Le identit√† gestite in Azure Active Directory offrono una soluzione per **gestire automaticamente l'identit√†** delle applicazioni. Queste identit√† sono utilizzate dalle applicazioni per **connettersi** a **risorse** compatibili con l'autenticazione di Azure Active Directory (**Azure AD**). Utilizzando identit√† gestite, le applicazioni possono **proteggere i token Azure AD** eliminando la necessit√† di gestire direttamente le credenziali. Ci sono due tipi di identit√† gestite:
* **Assegnata dal sistema**. Alcuni servizi Azure ti consentono di **abilitare un'identit√† gestita direttamente su un'istanza di servizio**. Quando abiliti un'identit√† gestita assegnata dal sistema, un'identit√† viene creata in Azure AD. L'identit√† √® legata al **ciclo di vita di quell'istanza di servizio**. Quando la **risorsa** viene **eliminata**, Azure elimina automaticamente l'**identit√†** per te. Per design, solo quella risorsa Azure pu√≤ utilizzare questa identit√† per richiedere token da Azure AD.
* **Assegnata dall'utente**. Puoi anche creare un'identit√† gestita come risorsa Azure autonoma. Puoi [creare un'identit√† gestita assegnata dall'utente](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) e assegnarla a una o **pi√π istanze** di un servizio Azure (risorse multiple). Per le identit√† gestite assegnate dall'utente, l'**identit√† √® gestita separatamente dalle risorse che la utilizzano**.

## Ruoli e Permessi

I **ruoli** sono **assegnati** ai **principali** su un **ambito**: `principal -[HAS ROLE]->(scope)`

I **ruoli** assegnati ai **gruppi** sono **ereditati** da tutti i **membri** del gruppo.

A seconda dell'ambito a cui √® stato assegnato il ruolo, il **ruolo** potrebbe essere **ereditato** da **altre risorse** all'interno del contenitore dell'ambito. Ad esempio, se un utente A ha un **ruolo sulla sottoscrizione**, avr√† quel **ruolo su tutti i gruppi di risorse** all'interno della sottoscrizione e su **tutte le risorse** all'interno del gruppo di risorse.

### **Ruoli Classici**

| **Proprietario**                     | <ul><li>Accesso completo a tutte le risorse</li><li>Pu√≤ gestire l'accesso per altri utenti</li></ul> | Tutti i tipi di risorsa |
| ------------------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Collaboratore**                     | <ul><li>Accesso completo a tutte le risorse</li><li>Non pu√≤ gestire l'accesso</li></ul>              | Tutti i tipi di risorsa |
| **Lettore**                           | ‚Ä¢ Visualizza tutte le risorse                                                                     | Tutti i tipi di risorsa |
| **Amministratore Accesso Utente**    | <ul><li>Visualizza tutte le risorse</li><li>Pu√≤ gestire l'accesso per altri utenti</li></ul>           | Tutti i tipi di risorsa |

### Ruoli Integrati

[Da documentazione: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Il controllo degli accessi basato sui ruoli di Azure (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ha diversi **ruoli integrati** di Azure che puoi **assegnare** a **utenti, gruppi, service principal e identit√† gestite**. Le assegnazioni di ruolo sono il modo in cui controlli **l'accesso alle risorse Azure**. Se i ruoli integrati non soddisfano le esigenze specifiche della tua organizzazione, puoi creare i tuoi [**ruoli personalizzati di Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

I ruoli **integrati** si applicano solo alle **risorse** per cui sono **destinati**, ad esempio controlla questi 2 esempi di **ruoli integrati su risorse Compute**:

| [Lettore Backup Disco](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Fornisce permesso al vault di backup per eseguire il backup del disco.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Accesso Utente Macchina Virtuale](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Visualizza le Macchine Virtuali nel portale e accede come utente normale. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Questi ruoli possono **essere assegnati anche su contenitori logici** (come gruppi di gestione, sottoscrizioni e gruppi di risorse) e i principali interessati li avranno **sulle risorse all'interno di quei contenitori**.

* Trova qui un elenco con [**tutti i ruoli integrati di Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Trova qui un elenco con [**tutti i ruoli integrati di Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Ruoli Personalizzati

Azure consente anche di creare [**ruoli personalizzati**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) con i permessi di cui l'utente ha bisogno.

### Permesso Negato

* Affinch√© un **principale abbia accesso a una risorsa**, deve ricevere un ruolo esplicito che gli conceda (in qualsiasi modo) **quella autorizzazione**.
* Un'assegnazione di **ruolo di negazione esplicita ha la precedenza** sul ruolo che concede il permesso.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Amministratore Globale

Gli utenti con il ruolo di Amministratore Globale hanno la possibilit√† di '**elevare' al ruolo di Amministratore Accesso Utente di Azure per il gruppo di gestione radice**. Ci√≤ significa che un Amministratore Globale sar√† in grado di gestire l'accesso **a tutte le sottoscrizioni e i gruppi di gestione Azure.**\
Questa elevazione pu√≤ essere effettuata alla fine della pagina: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Politiche Azure

Le politiche Azure sono un insieme di **regole e regolamenti in Microsoft Azure**, un servizio di cloud computing, che aiutano a gestire e far rispettare gli standard organizzativi e a valutare la conformit√† su larga scala. Queste politiche applicano diverse regole sulle tue **risorse Azure**, assicurando che quelle risorse rimangano conformi agli standard aziendali e agli accordi di livello di servizio.

Le politiche Azure sono cruciali per la governance e la sicurezza del cloud, aiutando a garantire che le risorse siano utilizzate in modo appropriato ed efficiente, e che siano conformi a regolamenti esterni e politiche interne.\
Alcuni esempi:

1. **Garantire la Conformit√† con Specifiche Regioni Azure**: Questa politica garantisce che tutte le risorse siano distribuite in specifiche regioni Azure. Ad esempio, un'azienda potrebbe voler garantire che tutti i suoi dati siano archiviati in Europa per la conformit√† al GDPR.
2. **Imporre Standard di Nominazione**: Le politiche possono imporre convenzioni di denominazione per le risorse Azure. Questo aiuta a organizzare e identificare facilmente le risorse in base ai loro nomi, il che √® utile in ambienti grandi.
3. **Limitare Certi Tipi di Risorse**: Questa politica pu√≤ limitare la creazione di certi tipi di risorse. Ad esempio, una politica potrebbe essere impostata per prevenire la creazione di tipi di risorse costosi, come alcune dimensioni di VM, per controllare i costi.
4. **Imporre Politiche di Tagging**: I tag sono coppie chiave-valore associate alle risorse Azure utilizzate per la gestione delle risorse. Le politiche possono imporre che determinati tag debbano essere presenti, o avere valori specifici, per tutte le risorse. Questo √® utile per il monitoraggio dei costi, la propriet√† o la categorizzazione delle risorse.
5. **Limitare l'Accesso Pubblico alle Risorse**: Le politiche possono imporre che determinate risorse, come account di archiviazione o database, non abbiano endpoint pubblici, assicurando che siano accessibili solo all'interno della rete dell'organizzazione.
6. **Applicare Automaticamente Impostazioni di Sicurezza**: Le politiche possono essere utilizzate per applicare automaticamente impostazioni di sicurezza alle risorse, come applicare un gruppo di sicurezza di rete specifico a tutte le VM o garantire che tutti gli account di archiviazione utilizzino la crittografia.

Nota che le Politiche Azure possono essere collegate a qualsiasi livello della gerarchia Azure, ma sono **comunemente utilizzate nel gruppo di gestione radice** o in altri gruppi di gestione.

### Ambito dei Permessi

In Azure **i permessi possono essere assegnati a qualsiasi parte della gerarchia**. Ci√≤ include gruppi di gestione, sottoscrizioni, gruppi di risorse e risorse individuali. I permessi sono **ereditati** dalle **risorse** contenute dell'entit√† a cui sono stati assegnati.

Questa struttura gerarchica consente una gestione efficiente e scalabile dei permessi di accesso.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (controllo degli accessi basato sui ruoli) √® ci√≤ che abbiamo gi√† visto nelle sezioni precedenti: **Assegnare un ruolo a un principale per concedergli accesso** a una risorsa.\
Tuttavia, in alcuni casi potresti voler fornire una **gestione degli accessi pi√π dettagliata** o **semplificare** la gestione di **centinaia** di **assegnazioni di ruolo**.

Azure **ABAC** (controllo degli accessi basato sugli attributi) si basa su Azure RBAC aggiungendo **condizioni di assegnazione del ruolo basate su attributi** nel contesto di azioni specifiche. Una _condizione di assegnazione del ruolo_ √® un **controllo aggiuntivo che puoi opzionalmente aggiungere alla tua assegnazione di ruolo** per fornire un controllo degli accessi pi√π dettagliato. Una condizione filtra i permessi concessi come parte della definizione del ruolo e dell'assegnazione del ruolo. Ad esempio, puoi **aggiungere una condizione che richiede a un oggetto di avere un tag specifico per leggere l'oggetto**.\
Non puoi **negare esplicitamente** **l'accesso** a risorse specifiche **utilizzando condizioni**.

### Permessi Utente Predefiniti

Un utente di base avr√† alcuni **permessi predefiniti** per enumerare alcune parti di AzureAD:

* Leggere tutti gli utenti, gruppi, applicazioni, dispositivi, ruoli, sottoscrizioni e le loro propriet√† pubbliche
* Invitare ospiti (_pu√≤ essere disattivato_)
* Creare gruppi di sicurezza
* Leggere le appartenenze ai gruppi non nascoste
* Aggiungere ospiti ai gruppi di propriet√†
* Creare una nuova applicazione (_pu√≤ essere disattivato_)
* Aggiungere fino a 50 dispositivi ad Azure (_pu√≤ essere disattivato_)

Puoi vedere l'intero [elenco dei **permessi predefiniti degli utenti** nella documentazione](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Inoltre, nota che in quell'elenco puoi anche vedere l'**elenco dei permessi predefiniti per gli ospiti**.

{% hint style="info" %}
Ricorda che per enumerare le risorse Azure l'utente ha bisogno di una concessione esplicita del permesso.
{% endhint %}

### Gestione delle Identit√† Privilegiate (PIM)

La Gestione delle Identit√† Privilegiate (PIM) in Azure √® uno strumento che **gestisce, controlla e monitora l'accesso privilegiato** in Azure Active Directory e Azure. Migliora la sicurezza fornendo **accesso privilegiato giust-in-time e limitato nel tempo**, **imponendo flussi di approvazione e richiedendo autenticazione aggiuntiva**. Questo approccio riduce al minimo il rischio di accesso non autorizzato garantendo che i permessi elevati siano concessi solo quando necessario e per una durata specifica.

## Token di Autenticazione

Ci sono **tre tipi di token** utilizzati in OIDC:

* [**Token di Accesso**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Il client presenta questo token al server delle risorse per **accedere alle risorse**. Pu√≤ essere utilizzato solo per una specifica combinazione di utente, client e risorsa e **non pu√≤ essere revocato** fino alla scadenza - che √® di 1 ora per impostazione predefinita. La rilevazione √® bassa utilizzando questo.
* **Token ID**: Il client riceve questo **token dal server di autorizzazione**. Contiene informazioni di base sull'utente. √à **legato a una specifica combinazione di utente e client**.
* **Token di Aggiornamento**: Fornito al client con il token di accesso. Utilizzato per **ottenere nuovi token di accesso e ID**. √à legato a una specifica combinazione di utente e client e pu√≤ essere revocato. La scadenza predefinita √® **90 giorni** per i token di aggiornamento inattivi e **nessuna scadenza per i token attivi**.

{% hint style="warning" %}
Le informazioni per **l'accesso condizionale** sono **memorizzate** all'interno del **JWT**. Quindi, se richiedi il **token da un indirizzo IP consentito**, quell'**IP** sar√† **memorizzato** nel token e poi puoi utilizzare quel token da un **IP non consentito per accedere alle risorse**.
{% endhint %}

Controlla la seguente pagina per apprendere diversi modi per **richiedere token di accesso** e accedere con essi:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

I punti di accesso API pi√π comuni sono:

* **Azure Resource Manager** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (Azure AD Graph, che √® deprecato, √® graph.windows.net)

## Riferimenti

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

{% hint style="success" %}
Impara e pratica il Hacking AWS:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Impara e pratica il Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
