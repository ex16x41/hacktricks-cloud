# Az - 基本情報

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## 組織階層

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

### 管理グループ

組織に**多くのAzureサブスクリプション**がある場合、これらの**サブスクリプション**の**アクセス**、ポリシー、およびコンプライアンスを効率的に**管理**する方法が必要です。**管理グループ**は、**サブスクリプションの上にあるガバナンスの範囲**を提供します。

**10,000の管理グループ**が単一のディレクトリでサポートされ、管理グループツリーは**最大6レベルの深さ**をサポートできます。

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

[ドキュメントから](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): 各ディレクトリには、**ルート**管理グループと呼ばれる単一の**トップレベル管理グループ**が与えられます。ルート管理グループは、**すべての管理グループとサブスクリプションがそれに折りたたまれる**ように階層に組み込まれています。このルート管理グループにより、**グローバルポリシーとAzureロールの割り当て**がディレクトリレベルで適用されます。[Azure AD **グローバル管理者**は、最初にこのルートグループの**ユーザーアクセス管理者ロールに昇格する必要があります**](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin)。アクセスを昇格させた後、管理者は**階層を管理するために他のディレクトリユーザーやグループに任意のAzureロールを割り当てることができます**。管理者として、**自分のアカウントをルート**管理グループの所有者として割り当てることができます。

ルート管理グループは、他の管理グループとは異なり、**移動または削除することはできません**。

管理グループは、どのようなタイプのサブスクリプションを持っていても、エンタープライズグレードの管理を大規模に提供します。ただし、**単一の管理グループ内のすべてのサブスクリプション**は、**同じAzure Active Directory (Azure AD) テナント**を信頼する必要があります。

<figure><img src="../../.gitbook/assets/image (157).png" alt=""><figcaption></figcaption></figure>

### Azureサブスクリプション

Azureでは、サブスクリプションはビジネスまたは技術的な**リソース**を**プロビジョニング**するための**論理コンテナ**として機能します。このコンテナは、仮想マシン (VM)、データベースなどの**リソースの詳細**を保持します。VMのようなAzureリソースを作成するとき、**それに関連付けられたサブスクリプション**が指定されます。この構造は、ロールベースのアクセス制御メカニズムを利用してアクセスの委任を容易にします。

### リソースグループ

[ドキュメントから:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) リソースグループは、Azureソリューションのための**関連リソース**を保持する**コンテナ**です。リソースグループには、ソリューションのすべてのリソースを含めることも、**グループとして管理したいリソースのみを含めることもできます**。一般的に、**同じライフサイクル**を共有する**リソース**を同じリソースグループに追加することで、グループとして簡単にデプロイ、更新、削除できます。

すべての**リソース**は**リソースグループ内**に存在し、グループにのみ属し、リソースグループが削除されると、その中のすべてのリソースも削除されます。

### 管理単位

[ドキュメントから:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) 管理単位を使用すると、組織を**任意の単位**に**細分化**し、特定の管理者を**割り当てる**ことができます。たとえば、大規模な大学の各学校の管理者に権限を委任するために管理単位を使用し、彼らが工学部内でのみアクセスを制御し、ユーザーを管理し、ポリシーを設定できるようにすることができます。

**ユーザー**、**グループ**、および**デバイス**のみが**管理単位**の**メンバー**となることができます。

したがって、**管理単位**は**いくつかのメンバー**を**含み**、他の**プリンシパル**がその管理単位に対して**権限を割り当てられ**、管理単位のメンバーを**管理するために使用できます**。

## Azure vs Azure AD vs Azure AD Domain Services

**Azure AD**は**Azure**の**内部**にあるサービスであることに注意することが重要です。**Azure**はマイクロソフトの**クラウドプラットフォーム**であり、**Azure AD**はAzureのエンタープライズ**アイデンティティ**サービスです。\
さらに、**Azure ADはWindows Active Directoryのようなものではなく**、全く異なる方法で機能するアイデンティティサービスです。Windows Active Directory環境で**Azure**に**ドメインコントローラーを実行**する場合は、**Azure AD Domain Services**を使用する必要があります。

## プリンシパル

Azureは異なるタイプのプリンシパルをサポートしています：

* **ユーザー**: アクセスするための資格情報を持つ通常の**人**。
* **グループ**: 一緒に管理される**プリンシパルのグループ**。グループに付与された**権限**は、その**メンバー**によって**継承**されます。
* **サービスプリンシパル/エンタープライズアプリケーション**: **アプリケーション**、ホスティングサービス、および自動化ツールがAzureリソースにアクセスするために作成された**アイデンティティ**です。このアクセスは、サービスプリンシパルに割り当てられたロールによって**制限され**、**どのリソースにアクセスできるか**とそのレベルを制御します。セキュリティ上の理由から、ユーザーアイデンティティでログインさせるのではなく、**自動化ツールとともにサービスプリンシパルを使用することが常に推奨されます**。

**サービスプリンシパル**を作成する際には、**パスワード認証**または**証明書認証**のいずれかを選択できます。

* **パスワード**認証を選択した場合（デフォルト）、**生成されたパスワードを保存**してください。再度アクセスすることはできません。
* 証明書認証を選択した場合、**アプリケーションがプライベートキーにアクセスできることを確認**してください。
* **マネージドアイデンティティ（メタデータクレデンシャル）**: Azure Active Directoryのマネージドアイデンティティは、アプリケーションの**アイデンティティを自動的に管理**するためのソリューションを提供します。これらのアイデンティティは、Azure Active Directory（**Azure AD**）認証に対応する**リソース**に接続するためにアプリケーションによって使用されます。マネージドアイデンティティを利用することで、アプリケーションは**Azure ADトークンを安全に保ちながら**、資格情報を直接扱う必要がなくなります。マネージドアイデンティティには2種類あります：
* **システム割り当て**。一部のAzureサービスでは、**サービスインスタンスに直接マネージドアイデンティティを有効にする**ことができます。システム割り当てマネージドアイデンティティを有効にすると、Azure ADにアイデンティティが作成されます。このアイデンティティは、そのサービスインスタンスの**ライフサイクルに結び付けられています**。**リソース**が**削除されると**、Azureは自動的に**アイデンティティを削除**します。設計上、そのAzureリソースのみがこのアイデンティティを使用してAzure ADからトークンを要求できます。
* **ユーザー割り当て**。マネージドアイデンティティをスタンドアロンのAzureリソースとして作成することもできます。[ユーザー割り当てマネージドアイデンティティを作成する](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal)ことができ、Azureサービスの1つまたは**複数のインスタンス**に割り当てることができます（複数のリソース）。ユーザー割り当てマネージドアイデンティティの場合、**アイデンティティはそれを使用するリソースとは別に管理されます**。

## ロールと権限

**ロール**は**スコープ**に対して**プリンシパルに割り当てられます**: `principal -[HAS ROLE]->(scope)`

**グループに割り当てられたロール**は、グループのすべての**メンバー**によって**継承**されます。

ロールが割り当てられたスコープに応じて、**ロール**はスコープコンテナ内の**他のリソース**に**継承**される可能性があります。たとえば、ユーザーAが**サブスクリプションにロールを持っている場合**、彼はそのサブスクリプション内のすべてのリソースグループおよびリソースグループ内の**すべてのリソース**にその**ロールを持ちます**。

### **クラシックロール**

| **オーナー**                     | <ul><li>すべてのリソースへのフルアクセス</li><li>他のユーザーのアクセスを管理できる</li></ul> | すべてのリソースタイプ |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **寄稿者**               | <ul><li>すべてのリソースへのフルアクセス</li><li>アクセスを管理できない</li></ul>              | すべてのリソースタイプ |
| **リーダー**                    | • すべてのリソースを表示                                                                     | すべてのリソースタイプ |
| **ユーザーアクセス管理者** | <ul><li>すべてのリソースを表示</li><li>他のユーザーのアクセスを管理できる</li></ul>           | すべてのリソースタイプ |

### ビルトインロール

[ドキュメントから: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azureロールベースのアクセス制御 (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview)には、**ユーザー、グループ、サービスプリンシパル、およびマネージドアイデンティティ**に**割り当てることができる**いくつかのAzure **ビルトインロール**があります。ロールの割り当ては、**Azureリソースへのアクセスを制御する方法**です。ビルトインロールが組織の特定のニーズを満たさない場合は、独自の[**Azureカスタムロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**を作成できます**。

**ビルトイン**ロールは、**意図されたリソース**にのみ適用されます。たとえば、コンピュートリソースに対する**ビルトインロール**の2つの例を確認してください：

| [ディスクバックアップリーダー](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | ディスクバックアップを実行するためにバックアップボールトへの権限を提供します。      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [仮想マシンユーザーログイン](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | ポータルで仮想マシンを表示し、通常のユーザーとしてログインします。 | fb879df8-f326-4884-b1cf-06f3ad86be52 |

これらのロールは、**管理グループ、サブスクリプション、リソースグループ**などの論理コンテナに対しても**割り当てることができ**、影響を受けるプリンシパルは**それらのコンテナ内のリソースに対して持ちます**。

* ここに[**すべてのAzureビルトインロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)のリストがあります。
* ここに[**すべてのAzure ADビルトインロール**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference)のリストがあります。

### カスタムロール

Azureは、ユーザーが必要とする権限を持つ[**カスタムロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)を作成することも許可します。

### 権限拒否

* **プリンシパルがリソースに対してアクセスを持つためには**、明示的なロールが彼に付与される必要があります（いずれにせよ）**その権限を付与します**。
* 明示的な**拒否ロールの割り当ては**、権限を付与するロールよりも優先されます。

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### グローバル管理者

グローバル管理者ロールを持つユーザーは、**ルート管理グループに対してユーザーアクセス管理者Azureロールに昇格する**能力を持っています。これは、グローバル管理者が**すべてのAzureサブスクリプションおよび管理グループのアクセスを管理できる**ことを意味します。\
この昇格はページの下部で行うことができます: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Azureポリシー

Azureポリシーは、Microsoft Azureの**ルールと規制のセット**であり、組織の基準を管理および強制し、スケールでコンプライアンスを評価するのに役立ちます。これらのポリシーは、**Azureリソース**に対して異なるルールを強制し、これらのリソースが企業の基準やサービスレベル契約に準拠し続けることを保証します。

Azureポリシーは、クラウドガバナンスとセキュリティにとって重要であり、リソースが適切かつ効率的に使用され、外部規制や内部ポリシーに準拠していることを保証します。\
いくつかの例：

1. **特定のAzureリージョンへのコンプライアンスの確保**: このポリシーは、すべてのリソースが特定のAzureリージョンにデプロイされることを保証します。たとえば、企業はGDPRコンプライアンスのためにすべてのデータがヨーロッパに保存されることを望むかもしれません。
2. **命名基準の強制**: ポリシーはAzureリソースの命名規則を強制できます。これにより、大規模な環境でリソースを名前に基づいて整理し、簡単に識別するのに役立ちます。
3. **特定のリソースタイプの制限**: このポリシーは、特定のタイプのリソースの作成を制限できます。たとえば、コストを制御するために、特定のVMサイズのような高価なリソースタイプの作成を防ぐポリシーを設定できます。
4. **タグ付けポリシーの強制**: タグは、リソース管理に使用されるAzureリソースに関連付けられたキーと値のペアです。ポリシーは、すべてのリソースに特定のタグが存在する必要があるか、特定の値を持つ必要があることを強制できます。これは、コスト追跡、所有権、またはリソースの分類に役立ちます。
5. **リソースへの公共アクセスの制限**: ポリシーは、ストレージアカウントやデータベースのような特定のリソースに公共エンドポイントがないことを強制し、組織のネットワーク内でのみアクセスできるようにします。
6. **セキュリティ設定の自動適用**: ポリシーは、すべてのVMに特定のネットワークセキュリティグループを適用したり、すべてのストレージアカウントが暗号化を使用することを保証したりするなど、リソースにセキュリティ設定を自動的に適用するために使用できます。

Azureポリシーは、Azure階層の任意のレベルに添付できますが、**通常はルート管理グループ**または他の管理グループで使用されます。

### 権限スコープ

Azureでは、**権限は階層の任意の部分に割り当てることができます**。これには、管理グループ、サブスクリプション、リソースグループ、および個々のリソースが含まれます。権限は、割り当てられたエンティティの**含まれるリソース**によって**継承**されます。

この階層構造により、アクセス権限の効率的かつスケーラブルな管理が可能になります。

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC**（ロールベースのアクセス制御）は、前のセクションで見たものです：**リソースに対するアクセスを付与するためにプリンシパルにロールを割り当てる**。\
ただし、場合によっては、**より細かいアクセス管理**を提供したり、**数百の**ロール**割り当ての管理を簡素化**したいことがあります。

Azure **ABAC**（属性ベースのアクセス制御）は、特定のアクションのコンテキスト内での**属性に基づくロール割り当て条件**を追加することによってAzure RBACを拡張します。_ロール割り当て条件_は、**ロール割り当てにオプションで追加できる追加のチェック**であり、より細かいアクセス制御を提供します。条件は、ロール定義とロール割り当ての一部として付与された権限をフィルタリングします。たとえば、**オブジェクトを読み取るために特定のタグを持つ必要がある条件を追加できます**。\
条件を使用して特定のリソースへのアクセスを明示的に**拒否することはできません**。

### デフォルトユーザー権限

基本的なユーザーは、AzureADの一部を列挙するためのいくつかの**デフォルト権限**を持ちます：

* すべてのユーザー、グループ、アプリケーション、デバイス、ロール、サブスクリプション、およびその公開プロパティを読み取る
* ゲストを招待する（_オフにすることができます_）
* セキュリティグループを作成する
* 非表示でないグループメンバーシップを読み取る
* 所有グループにゲストを追加する
* 新しいアプリケーションを作成する（_オフにすることができます_）
* Azureに最大50のデバイスを追加する（_オフにすることができます_）

完全な[**ユーザーのデフォルト権限のリスト**](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions)をドキュメントで確認できます。さらに、そのリストには**ゲストのデフォルト権限リスト**も表示されます。

{% hint style="info" %}
Azureリソースを列挙するには、ユーザーが明示的に権限を付与される必要があることを忘れないでください。
{% endhint %}

### 特権アイデンティティ管理 (PIM)

Azureの特権アイデンティティ管理 (PIM) は、Azure Active DirectoryおよびAzureでの特権アクセスを**管理、制御、および監視**するツールです。これは、**必要なときに必要な期間だけ特権アクセスを提供し、承認ワークフローを強制し、追加の認証を要求することによって**セキュリティを強化します。このアプローチは、特権が必要なときにのみ付与され、特定の期間に制限されることを保証することによって、無許可のアクセスのリスクを最小限に抑えます。

## 認証トークン

OIDCで使用される**3種類のトークン**があります：

* [**アクセストークン**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** クライアントはこのトークンをリソースサーバーに提示して**リソースにアクセス**します。これは、特定のユーザー、クライアント、およびリソースの組み合わせにのみ使用でき、**期限切れまで取り消すことはできません** - デフォルトでは1時間です。これを使用する際の検出は低いです。
* **IDトークン**: クライアントはこの**トークンを認証サーバーから受け取ります**。これは、ユーザーに関する基本情報を含んでいます。これは、**特定のユーザーとクライアントの組み合わせに結び付けられています**。
* **リフレッシュトークン**: アクセストークンとともにクライアントに提供されます。新しいアクセストークンとIDトークンを**取得するために使用されます**。これは、特定のユーザーとクライアントの組み合わせに結び付けられ、取り消すことができます。デフォルトの有効期限は、非アクティブなリフレッシュトークンで**90日**、アクティブなトークンには**有効期限がありません**。

{% hint style="warning" %}
**条件付きアクセス**に関する情報は**JWT**内に**保存**されます。したがって、**許可されたIPアドレスからトークンを要求**すると、その**IP**がトークンに**保存**され、その後**許可されていないIPからリソースにアクセスするためにそのトークンを使用できます**。
{% endhint %}

以下のページを確認して、**アクセストークンを要求する**さまざまな方法とそれを使用してログインする方法を学んでください：

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

最も一般的なAPIエンドポイントは次のとおりです：

* **Azure Resource Manager** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (非推奨のAzure AD Graphはgraph.windows.net)

## 参考文献

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
