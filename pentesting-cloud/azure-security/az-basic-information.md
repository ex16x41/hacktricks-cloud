# Az - Informazioni di Base

{% hint style="success" %}
Impara e pratica il Hacking AWS:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Impara e pratica il Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}

## Gerarchia dell'Organizzazione

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUchBvhjIdWWR2ldAkWiZMdmrcEYD9Ti5UAa3zAGr9YbAnx4Q_gZNp_zvOU429vgWZ_ixoYHQKdC8bGgkhWYCy591SRIFj6RKCj4BEpVQixAGsp3T3O5sS3k7x5CTaJ-SCBNC7i5KluLyxdiXoZsH1F0ko1Gv88=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption></figcaption></figure>

### Gruppi di Gestione

* Pu√≤ contenere **altri gruppi di gestione o abbonamenti**.
* Questo consente di **applicare controlli di governance** come RBAC e Azure Policy una sola volta a livello di gruppo di gestione e farli **ereditarli** da tutti gli abbonamenti nel gruppo.
* Possono essere supportati **10.000 gruppi di gestione** in una singola directory.
* Un albero di gruppi di gestione pu√≤ supportare **fino a sei livelli di profondit√†**. Questo limite non include il livello radice o il livello di abbonamento.
* Ogni gruppo di gestione e abbonamento pu√≤ supportare **solo un genitore**.
* Anche se possono essere creati diversi gruppi di gestione, **c'√® solo 1 gruppo di gestione radice**.
* Il gruppo di gestione radice **contiene** tutti gli **altri gruppi di gestione e abbonamenti** e **non pu√≤ essere spostato o eliminato**.
* Tutti gli abbonamenti all'interno di un singolo gruppo di gestione devono fidarsi dello **stesso tenant Entra ID.**

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption><p><a href="https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png">https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png</a></p></figcaption></figure>

### Abbonamenti Azure

* √à un altro **contenitore logico in cui possono essere eseguite risorse** (VM, DB‚Ä¶) e verr√† fatturato.
* Il suo **genitore** √® sempre un **gruppo di gestione** (e pu√≤ essere il gruppo di gestione radice) poich√© gli abbonamenti non possono contenere altri abbonamenti.
* **Fiducia solo in un directory Entra ID**
* Le **autorizzazioni** applicate a livello di abbonamento (o a qualsiasi dei suoi genitori) sono **ereditarie** a tutte le risorse all'interno dell'abbonamento.

### Gruppi di Risorse

[Dal documento:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Un gruppo di risorse √® un **contenitore** che contiene **risorse correlate** per una soluzione Azure. Il gruppo di risorse pu√≤ includere tutte le risorse per la soluzione, o solo quelle **risorse che desideri gestire come un gruppo**. In generale, aggiungi **risorse** che condividono il **stesso ciclo di vita** allo stesso gruppo di risorse in modo da poterle facilmente distribuire, aggiornare ed eliminare come un gruppo.

Tutte le **risorse** devono essere **all'interno di un gruppo di risorse** e possono appartenere solo a un gruppo e se un gruppo di risorse viene eliminato, tutte le risorse al suo interno vengono anch'esse eliminate.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfe8U30iP_vdZCvxX4g8nEPRLoo7v0kmCGkDn1frBPn3_GIoZ7VT2LkdsVQWCnrG_HSYNRRPM-1pSECUkbDAB-9YbUYLzpvKVLDETZS81CHWKYM4fDl3oMo5-yvTMnjdLTS2pz8U67xUTIzBhZ25MFMRkq5koKY=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption><p><a href="https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1">https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1</a></p></figcaption></figure>

### ID Risorse Azure

Ogni risorsa in Azure ha un ID Risorsa Azure che la identifica.

Il formato di un ID Risorsa Azure √® il seguente:

* `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderNamespace}/{resourceType}/{resourceName}`

Per una macchina virtuale chiamata myVM in un gruppo di risorse `myResourceGroup` sotto l'ID di abbonamento `12345678-1234-1234-1234-123456789012`, l'ID Risorsa Azure appare cos√¨:

* `/subscriptions/12345678-1234-1234-1234-123456789012/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM`

## Azure vs Entra ID vs Servizi di Dominio Azure AD

### Azure

Azure √® la **piattaforma di cloud computing completa di Microsoft, che offre una vasta gamma di servizi**, tra cui macchine virtuali, database, intelligenza artificiale e archiviazione. Funziona come base per l'hosting e la gestione delle applicazioni, la costruzione di infrastrutture scalabili e l'esecuzione di carichi di lavoro moderni nel cloud. Azure fornisce strumenti per sviluppatori e professionisti IT per creare, distribuire e gestire applicazioni e servizi senza soluzione di continuit√†, soddisfacendo una variet√† di esigenze, dalle startup alle grandi imprese.

### Entra ID (precedentemente Azure Active Directory)

Entra ID √® un servizio di **gestione dell'identit√† e degli accessi basato su cloud** progettato per gestire l'autenticazione, l'autorizzazione e il controllo degli accessi degli utenti. Potenzia l'accesso sicuro ai servizi Microsoft come Office 365, Azure e molte applicazioni SaaS di terze parti. Con funzionalit√† come l'accesso single sign-on (SSO), l'autenticazione a pi√π fattori (MFA) e le politiche di accesso condizionale, tra le altre.

### Servizi di Dominio Entra (precedentemente Azure AD DS)

I Servizi di Dominio Entra estendono le capacit√† di Entra ID offrendo **servizi di dominio gestiti compatibili con gli ambienti tradizionali di Windows Active Directory**. Supporta protocolli legacy come LDAP, Kerberos e NTLM, consentendo alle organizzazioni di migrare o eseguire applicazioni pi√π vecchie nel cloud senza dover distribuire controller di dominio on-premises. Questo servizio supporta anche le Group Policy per la gestione centralizzata, rendendolo adatto a scenari in cui carichi di lavoro legacy o basati su AD devono coesistere con ambienti cloud moderni.

## Principali di Entra ID

### Utenti

* **Nuovi utenti**
* Indica il nome e il dominio dell'email dal tenant selezionato
* Indica il nome visualizzato
* Indica la password
* Indica le propriet√† (nome, titolo di lavoro, informazioni di contatto‚Ä¶)
* Il tipo di utente predefinito √® ‚Äú**membro**‚Äù
* **Utenti esterni**
* Indica l'email per invitare e il nome visualizzato (pu√≤ essere un'email non Microsoft)
* Indica le propriet√†
* Il tipo di utente predefinito √® ‚Äú**Ospite**‚Äù

### Permessi Predefiniti per Membri e Ospiti

Puoi controllarli in [https://learn.microsoft.com/en-us/entra/fundamentals/users-default-permissions](https://learn.microsoft.com/en-us/entra/fundamentals/users-default-permissions) ma tra le altre azioni un membro sar√† in grado di:

* Leggere tutti gli utenti, Gruppi, Applicazioni, Dispositivi, Ruoli, Abbonamenti e le loro propriet√† pubbliche
* Invitare Ospiti (_pu√≤ essere disattivato_)
* Creare gruppi di sicurezza
* Leggere le appartenenze ai gruppi non nascoste
* Aggiungere ospiti ai gruppi di propriet√†
* Creare una nuova applicazione (_pu√≤ essere disattivato_)
* Aggiungere fino a 50 dispositivi ad Azure (_pu√≤ essere disattivato_)

{% hint style="info" %}
Ricorda che per enumerare le risorse Azure l'utente ha bisogno di un'esplicita concessione del permesso.
{% endhint %}

### Permessi Configurabili Predefiniti per Utenti

* **Membri (**[**docs**](https://learn.microsoft.com/en-gb/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions)**)**
* Registrare Applicazioni: Predefinito **S√¨**
* Limitare gli utenti non amministratori dalla creazione di tenant: Predefinito **No**
* Creare gruppi di sicurezza: Predefinito **S√¨**
* Limitare l'accesso al portale di amministrazione di Microsoft Entra: Predefinito **No**
* Questo non limita l'accesso API al portale (solo web)
* Consentire agli utenti di collegare l'account di lavoro o scolastico con LinkedIn: Predefinito **S√¨**
* Mostra mantenere l'utente connesso: Predefinito **S√¨**
* Limitare gli utenti dal recuperare la chiave BitLocker per i loro dispositivi di propriet√†: Predefinito No (controlla nelle Impostazioni Dispositivo)
* Leggere altri utenti: Predefinito **S√¨** (tramite Microsoft Graph)
* **Ospiti**
* **Restrizioni di accesso per utenti ospiti**
* **Gli utenti ospiti hanno lo stesso accesso dei membri** concede a tutti gli utenti membri i permessi agli utenti ospiti per impostazione predefinita.
* **Gli utenti ospiti hanno accesso limitato alle propriet√† e alle appartenenze degli oggetti di directory (predefinito)** limita l'accesso degli ospiti solo al proprio profilo utente per impostazione predefinita. L'accesso ad altre informazioni sugli utenti e sui gruppi non √® pi√π consentito.
* **L'accesso degli utenti ospiti √® limitato alle propriet√† e alle appartenenze dei propri oggetti di directory** √® il pi√π restrittivo.
* **Gli ospiti possono invitare**
* **Chiunque nell'organizzazione pu√≤ invitare utenti ospiti, inclusi ospiti e non amministratori (il pi√π inclusivo) - Predefinito**
* **Gli utenti membri e gli utenti assegnati a ruoli amministrativi specifici possono invitare utenti ospiti, inclusi ospiti con permessi di membri**
* **Solo gli utenti assegnati a ruoli amministrativi specifici possono invitare utenti ospiti**
* **Nessuno nell'organizzazione pu√≤ invitare utenti ospiti, inclusi gli amministratori (il pi√π restrittivo)**
* **Uscita utente esterno**: Predefinito **Vero**
* Consenti agli utenti esterni di lasciare l'organizzazione

{% hint style="success" %}
Anche se limitati per impostazione predefinita, gli utenti (membri e ospiti) con permessi concessi potrebbero eseguire le azioni precedenti.
{% endhint %}

### **Gruppi**

Ci sono **2 tipi di gruppi**:

* **Sicurezza**: Questo tipo di gruppo √® utilizzato per dare accesso ai membri ad applicazioni, risorse e assegnare licenze. Gli utenti, i dispositivi, i principi di servizio e altri gruppi possono essere membri.
* **Microsoft 365**: Questo tipo di gruppo √® utilizzato per la collaborazione, dando accesso ai membri a una casella di posta condivisa, calendario, file, sito SharePoint, e cos√¨ via. I membri del gruppo possono essere solo utenti.
* Questo avr√† un **indirizzo email** con il dominio del tenant EntraID.

Ci sono **2 tipi di appartenenze**:

* **Assegnato**: Consente di aggiungere manualmente membri specifici a un gruppo.
* **Appartenenza dinamica**: Gestisce automaticamente l'appartenenza utilizzando regole, aggiornando l'inclusione del gruppo quando cambiano gli attributi dei membri.

### **Principi di Servizio**

Un **Principio di Servizio** √® un **identit√†** creata per **l'uso** con **applicazioni**, servizi ospitati e strumenti automatizzati per accedere alle risorse Azure. Questo accesso √® **ristretto dai ruoli assegnati** al principio di servizio, dandoti il controllo su **quali risorse possono essere accessibili** e a quale livello. Per motivi di sicurezza, √® sempre consigliato **utilizzare principi di servizio con strumenti automatizzati** piuttosto che consentire loro di accedere con un'identit√† utente.

√à possibile **accedere direttamente come un principio di servizio** generando un **segreto** (password), un **certificato**, o concedendo accesso **federato** a piattaforme di terze parti (ad es. Github Actions) su di esso.

* Se scegli l'autenticazione **password** (per impostazione predefinita), **salva la password generata** poich√© non potrai accedervi di nuovo.
* Se scegli l'autenticazione con certificato, assicurati che l'**applicazione avr√† accesso alla chiave privata**.

### Registrazioni App

Una **Registrazione App** √® una configurazione che consente a un'applicazione di integrarsi con Entra ID e di eseguire azioni.

#### Componenti Chiave:

1. **ID Applicazione (Client ID):** Un identificatore unico per la tua app in Azure AD.
2. **URI di reindirizzamento:** URL dove Azure AD invia le risposte di autenticazione.
3. **Certificati, Segreti e Credenziali Federate:** √à possibile generare un segreto o un certificato per accedere come il principio di servizio dell'applicazione, o per concedere accesso federato ad essa (ad es. Github Actions).&#x20;
1. Se viene generato un **certificato** o un **segreto**, √® possibile per una persona **accedere come il principio di servizio** con strumenti CLI conoscendo l'**ID applicazione**, il **segreto** o il **certificato** e il **tenant** (dominio o ID).
4. **Permessi API:** Specifica quali risorse o API l'app pu√≤ accedere.
5. **Impostazioni di Autenticazione:** Definisce i flussi di autenticazione supportati dall'app (ad es., OAuth2, OpenID Connect).
6. **Principio di Servizio**: Un principio di servizio viene creato quando viene creata un'App (se viene fatto dalla console web) o quando viene installata in un nuovo tenant.
1. Il **principio di servizio** otterr√† tutti i permessi richiesti con cui √® stato configurato.

### Permessi di Consenso Predefiniti

**Consenso dell'utente per le applicazioni**

* **Non consentire il consenso dell'utente**
* Sar√† richiesto un amministratore per tutte le app.
* **Consentire il consenso dell'utente per le app di editori verificati, per permessi selezionati (Consigliato)**
* Tutti gli utenti possono dare consenso per permessi classificati come "basso impatto", per app di editori verificati o app registrate in questa organizzazione.
* **Permessi a basso impatto predefiniti** (anche se √® necessario accettare per aggiungerli come bassi):
* User.Read - accedi e leggi il profilo utente
* offline\_access - mantieni l'accesso ai dati a cui gli utenti hanno dato accesso
* openid - accedi gli utenti
* profile - visualizza il profilo di base dell'utente
* email - visualizza l'indirizzo email dell'utente
* **Consentire il consenso dell'utente per le app (Predefinito)**
* Tutti gli utenti possono dare consenso per qualsiasi app per accedere ai dati dell'organizzazione.

**Richieste di consenso dell'amministratore**: Predefinito **No**

* Gli utenti possono richiedere il consenso dell'amministratore per le app a cui non possono dare consenso
* Se **S√¨**: √à possibile indicare Utenti, Gruppi e Ruoli che possono dare consenso alle richieste
* Configura anche se gli utenti riceveranno notifiche via email e promemoria di scadenza&#x20;

### **Identit√† Gestite (Metadati)**

Le identit√† gestite in Azure Active Directory offrono una soluzione per **gestire automaticamente l'identit√†** delle applicazioni. Queste identit√† sono utilizzate dalle applicazioni per **connettersi** a **risorse** compatibili con l'autenticazione di Azure Active Directory (**Azure AD**). Questo consente di **eliminare la necessit√† di codificare le credenziali cloud** nel codice poich√© l'applicazione sar√† in grado di contattare il **servizio di metadati** per ottenere un token valido per **eseguire azioni** come l'identit√† gestita indicata in Azure.

Ci sono due tipi di identit√† gestite:

* **Assegnata al sistema**. Alcuni servizi Azure consentono di **abilitare un'identit√† gestita direttamente su un'istanza di servizio**. Quando abiliti un'identit√† gestita assegnata al sistema, un **principio di servizio** viene creato nel tenant Entra ID fidato dall'abbonamento in cui si trova la risorsa. Quando la **risorsa** viene **eliminata**, Azure elimina automaticamente l'**identit√†** per te.
* **Assegnata dall'utente**. √à anche possibile per gli utenti generare identit√† gestite. Queste vengono create all'interno di un gruppo di risorse all'interno di un abbonamento e un principio di servizio verr√† creato nel EntraID fidato dall'abbonamento. Poi, puoi assegnare l'identit√† gestita a una o **pi√π istanze** di un servizio Azure (risorse multiple). Per le identit√† gestite assegnate dall'utente, l'**identit√† √® gestita separatamente dalle risorse che la utilizzano**.

Le Identit√† Gestite **non generano credenziali eterne** (come password o certificati) per accedere come il principio di servizio ad essa associato.

### Applicazioni Aziendali

√à solo un **tabella in Azure per filtrare i principi di servizio** e controllare le applicazioni a cui sono stati assegnati.

**Non √® un altro tipo di ‚Äúapplicazione‚Äù,** non c'√® alcun oggetto in Azure che sia un ‚ÄúApplicazione Aziendale‚Äù, √® solo un'astrazione per controllare i Principi di servizio, le Registrazioni App e le identit√† gestite.

### Unit√† Amministrative

Le unit√† amministrative consentono di **dare permessi da un ruolo su una specifica porzione di un'organizzazione**.

Esempio:

* Scenario: Un'azienda vuole che gli amministratori IT regionali gestiscano solo gli utenti nella propria regione.
* Implementazione:
* Crea Unit√† Amministrative per ogni regione (ad es., "AU Nord America", "AU Europa").
* Popola le AU con utenti delle rispettive regioni.
* Le AU possono **contenere utenti, gruppi o dispositivi**
* Le AU supportano **appartenenze dinamiche**
* Le AU **non possono contenere AU**
* Assegna Ruoli Amministrativi:
* Concedi il ruolo di "Amministratore Utenti" al personale IT regionale, limitato all'AU della loro regione.
* Risultato: Gli amministratori IT regionali possono gestire gli account utente all'interno della loro regione senza influenzare altre regioni.

### Ruoli Entra ID

* Per gestire Entra ID ci sono alcuni **ruoli predefiniti** che possono essere assegnati ai principi Entra ID per gestire Entra ID
* Controlla i ruoli in [https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/permissions-reference](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/permissions-reference)
* Il ruolo pi√π privilegiato √® **Amministratore Globale**
* Nella descrizione del ruolo √® possibile vedere i suoi **permessi granulari**

## Ruoli e Permessi

**Ruoli** sono **assegnati** ai **principi** su un **ambito**: `principle -[HAS ROLE]->(scope)`

**Ruoli** assegnati a **gruppi** sono **ereditati** da tutti i **membri** del gruppo.

A seconda dell'ambito a cui √® stato assegnato il ruolo, il **ruolo** potrebbe essere **ereditato** da **altre risorse** all'interno del contenitore di ambito. Ad esempio, se un utente A ha un **ruolo sull'abbonamento**, avr√† quel **ruolo su tutti i gruppi di risorse** all'interno dell'abbonamento e su **tutte le risorse** all'interno del gruppo di risorse.

### **Ruoli Classici**

| **Proprietario**                     | <ul><li>Accesso completo a tutte le risorse</li><li>Pu√≤ gestire l'accesso per altri utenti</li></ul> | Tutti i tipi di risorse |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Collaboratore**               | <ul><li>Accesso completo a tutte le risorse</li><li>Non pu√≤ gestire l'accesso</li></ul>              | Tutti i tipi di risorse |
| **Lettore**                    | ‚Ä¢ Visualizza tutte le risorse                                                                     | Tutti i tipi di risorse |
| **Amministratore Accesso Utente** | <ul><li>Visualizza tutte le risorse</li><li>Pu√≤ gestire l'accesso per altri utenti</li></ul>           | Tutti i tipi di risorse |

### Ruoli Predefiniti

[Dal documento: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Il controllo degli accessi basato sui ruoli di Azure (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ha diversi **ruoli predefiniti** di Azure che puoi **assegnare** a **utenti, gruppi, principi di servizio e identit√† gestite**. Le assegnazioni di ruolo sono il modo in cui controlli **l'accesso alle risorse Azure**. Se i ruoli predefiniti non soddisfano le esigenze specifiche della tua organizzazione, puoi creare i tuoi [**ruoli personalizzati di Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

I ruoli **predefiniti** si applicano solo alle **risorse** per cui sono **destinati**, ad esempio controlla questi 2 esempi di **ruoli predefiniti su risorse Compute**:

| [Lettore Backup Disco](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Fornisce permesso al vault di backup per eseguire il backup del disco.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Login Utente Macchina Virtuale](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Visualizza le Macchine Virtuali nel portale e accede come utente normale. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Questi ruoli possono **essere assegnati anche su contenitori logici** (come gruppi di gestione, abbonamenti e gruppi di risorse) e i principi interessati li avranno **sulle risorse all'interno di quei contenitori**.

* Trova qui un elenco con [**tutti i ruoli predefiniti di Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Trova qui un elenco con [**tutti i ruoli predefiniti di Entra ID**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Ruoli Personalizzati

* √à anche possibile creare [**ruoli personalizzati**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)
* Vengono creati all'interno di un ambito, anche se un ruolo pu√≤ essere in pi√π ambiti (gruppi di gestione, abbonamenti e gruppi di risorse)
* √à possibile configurare tutti i permessi granulari che avr√† il ruolo personalizzato
* √à possibile escludere permessi
* Un principio con un permesso escluso non potr√† utilizzarlo anche se il permesso viene concesso altrove
* √à possibile utilizzare caratteri jolly
* Il formato utilizzato √® un JSON
* `actions` sono per controllare le azioni sulle risorse
* `dataActions` sono permessi sui dati all'interno dell'oggetto

Esempio di JSON di permessi per un ruolo personalizzato:
```json
{
"properties": {
"roleName": "",
"description": "",
"assignableScopes": [
"/subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f"
],
"permissions": [
{
"actions": [
"Microsoft.DigitalTwins/register/action",
"Microsoft.DigitalTwins/unregister/action",
"Microsoft.DigitalTwins/operations/read",
"Microsoft.DigitalTwins/digitalTwinsInstances/read",
"Microsoft.DigitalTwins/digitalTwinsInstances/write",
"Microsoft.CostManagement/exports/*"
],
"notActions": [
"Astronomer.Astro/register/action",
"Astronomer.Astro/unregister/action",
"Astronomer.Astro/operations/read",
"Astronomer.Astro/organizations/read"
],
"dataActions": [],
"notDataActions": []
}
]
}
}
```
### Permessi ordine

* Affinch√© un **principale abbia accesso a una risorsa**, deve avere un ruolo esplicito assegnato a lui (in qualsiasi modo) **che gli conceda quel permesso**.
* Un'esplicita **assegnazione di ruolo di negazione ha la precedenza** sul ruolo che concede il permesso.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption><p><a href="https://link.springer.com/chapter/10.1007/978-1-4842-7325-8_10">https://link.springer.com/chapter/10.1007/978-1-4842-7325-8_10</a></p></figcaption></figure>

### Amministratore Globale

L'Amministratore Globale √® un ruolo di Entra ID che concede **controllo completo sul tenant di Entra ID**. Tuttavia, di default non concede alcun permesso sulle risorse di Azure.

Gli utenti con il ruolo di Amministratore Globale hanno la possibilit√† di '**elevare' al ruolo di Amministratore dell'Accesso Utente di Azure nel Gruppo di Gestione Radice**. Quindi, gli Amministratori Globali possono gestire l'accesso in **tutte le sottoscrizioni e i gruppi di gestione di Azure.**\
Questa elevazione pu√≤ essere effettuata alla fine della pagina: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/Properties)

<figure><img src="../../.gitbook/assets/image (349).png" alt=""><figcaption></figcaption></figure>

### Politiche di Azure

**Le Politiche di Azure** sono regole che aiutano le organizzazioni a garantire che le loro risorse soddisfino standard specifici e requisiti di conformit√†. Consentono di **applicare o auditare impostazioni sulle risorse in Azure**. Ad esempio, puoi impedire la creazione di macchine virtuali in una regione non autorizzata o garantire che tutte le risorse abbiano tag specifici per il tracciamento.

Le Politiche di Azure sono **proattive**: possono fermare la creazione o la modifica di risorse non conformi. Sono anche **reattive**, consentendo di trovare e correggere risorse non conformi esistenti.

#### **Concetti Chiave**

1. **Definizione della Politica**: Una regola, scritta in JSON, che specifica cosa √® consentito o richiesto.
2. **Assegnazione della Politica**: L'applicazione di una politica a un ambito specifico (ad es., sottoscrizione, gruppo di risorse).
3. **Iniziative**: Una raccolta di politiche raggruppate insieme per un'applicazione pi√π ampia.
4. **Effetto**: Specifica cosa succede quando la politica viene attivata (ad es., "Negare", "Auditare" o "Aggiungere").

**Alcuni esempi:**

1. **Garantire la Conformit√† con Regioni Azure Specifiche**: Questa politica garantisce che tutte le risorse siano distribuite in regioni Azure specifiche. Ad esempio, un'azienda potrebbe voler garantire che tutti i suoi dati siano archiviati in Europa per la conformit√† al GDPR.
2. **Applicare Standard di Nominazione**: Le politiche possono applicare convenzioni di denominazione per le risorse di Azure. Questo aiuta a organizzare e identificare facilmente le risorse in base ai loro nomi, il che √® utile in ambienti grandi.
3. **Limitare Certi Tipi di Risorse**: Questa politica pu√≤ limitare la creazione di certi tipi di risorse. Ad esempio, una politica potrebbe essere impostata per impedire la creazione di tipi di risorse costosi, come alcune dimensioni di VM, per controllare i costi.
4. **Applicare Politiche di Tagging**: I tag sono coppie chiave-valore associate alle risorse di Azure utilizzate per la gestione delle risorse. Le politiche possono imporre che determinati tag debbano essere presenti o avere valori specifici per tutte le risorse. Questo √® utile per il tracciamento dei costi, la propriet√† o la categorizzazione delle risorse.
5. **Limitare l'Accesso Pubblico alle Risorse**: Le politiche possono imporre che determinate risorse, come account di archiviazione o database, non abbiano endpoint pubblici, garantendo che siano accessibili solo all'interno della rete dell'organizzazione.
6. **Applicare Automaticamente Impostazioni di Sicurezza**: Le politiche possono essere utilizzate per applicare automaticamente impostazioni di sicurezza alle risorse, come applicare un gruppo di sicurezza di rete specifico a tutte le VM o garantire che tutti gli account di archiviazione utilizzino la crittografia.

Nota che le Politiche di Azure possono essere collegate a qualsiasi livello della gerarchia di Azure, ma sono **comunemente utilizzate nel gruppo di gestione radice** o in altri gruppi di gestione.

Esempio di politica Azure json:
```json
{
"policyRule": {
"if": {
"field": "location",
"notIn": [
"eastus",
"westus"
]
},
"then": {
"effect": "Deny"
}
},
"parameters": {},
"displayName": "Allow resources only in East US and West US",
"description": "This policy ensures that resources can only be created in East US or West US.",
"mode": "All"
}
```
### Permessi di Eredit√†

In Azure **i permessi possono essere assegnati a qualsiasi parte della gerarchia**. Questo include gruppi di gestione, sottoscrizioni, gruppi di risorse e risorse individuali. I permessi sono **ereditati** dalle **risorse** contenute nell'entit√† a cui sono stati assegnati.

Questa struttura gerarchica consente una gestione efficiente e scalabile dei permessi di accesso.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (controllo degli accessi basato sui ruoli) √® ci√≤ che abbiamo gi√† visto nelle sezioni precedenti: **Assegnare un ruolo a un principale per concedergli accesso** a una risorsa.\
Tuttavia, in alcuni casi potresti voler fornire una **gestione degli accessi pi√π dettagliata** o **semplificare** la gestione di **centinaia** di **assegnazioni** di ruolo.

Azure **ABAC** (controllo degli accessi basato sugli attributi) si basa su Azure RBAC aggiungendo **condizioni di assegnazione del ruolo basate su attributi** nel contesto di azioni specifiche. Una _condizione di assegnazione del ruolo_ √® un **controllo aggiuntivo che puoi opzionalmente aggiungere alla tua assegnazione di ruolo** per fornire un controllo degli accessi pi√π dettagliato. Una condizione filtra i permessi concessi come parte della definizione del ruolo e dell'assegnazione del ruolo. Ad esempio, puoi **aggiungere una condizione che richiede a un oggetto di avere un tag specifico per leggere l'oggetto**.\
Non puoi **negare esplicitamente** l'**accesso** a risorse specifiche **utilizzando condizioni**.

### Gestione delle Identit√† Privilegiate (PIM)

La Gestione delle Identit√† Privilegiate (PIM) in Azure √® uno strumento che **gestisce, controlla e monitora l'accesso privilegiato** in Azure Active Directory e Azure. Migliora la sicurezza fornendo **accesso privilegiato giust-in-time e limitato nel tempo**, **applicando flussi di approvazione e richiedendo autenticazione aggiuntiva**. Questo approccio riduce il rischio di accesso non autorizzato garantendo che i permessi elevati siano concessi solo quando necessario e per una durata specifica.

## Token di Autenticazione

Ci sono **tre tipi di token** utilizzati in OIDC:

* [**Token di Accesso**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Il client presenta questo token al server delle risorse per **accedere alle risorse**. Pu√≤ essere utilizzato solo per una specifica combinazione di utente, client e risorsa e **non pu√≤ essere revocato** fino alla scadenza - che √® di 1 ora per impostazione predefinita.
* **Token ID**: Il client riceve questo **token dal server di autorizzazione**. Contiene informazioni di base sull'utente. √à **legato a una specifica combinazione di utente e client**.
* **Token di Aggiornamento**: Fornito al client con il token di accesso. Utilizzato per **ottenere nuovi token di accesso e ID**. √à legato a una specifica combinazione di utente e client e pu√≤ essere revocato. La scadenza predefinita √® di **90 giorni** per i token di aggiornamento inattivi e **nessuna scadenza per i token attivi**.

{% hint style="warning" %}
Le informazioni per il **accesso condizionale** sono **memorizzate** all'interno del **JWT**. Quindi, se richiedi il **token da un indirizzo IP autorizzato**, quell'**IP** sar√† **memorizzato** nel token e poi puoi utilizzare quel token da un **IP non autorizzato per accedere alle risorse**.
{% endhint %}

### Token di Accesso "aud"

A seconda dell'azione che desideri eseguire, il "**aud**" del token di accesso deve essere autorizzato a contattare l'URL API che contatterai.

Il comando `az account get-access-token --resource-type [...]` supporta i seguenti tipi e ciascuno di essi aggiunger√† un "aud" specifico nel token di accesso risultante:

{% hint style="danger" %}
Nota che i seguenti sono solo le API supportate da `az account get-access-token`, ma ce ne sono di pi√π.
{% endhint %}

* **aad-graph (Azure Active Directory Graph API)**: Utilizzato per accedere all'API Azure AD Graph legacy (deprecata), che consente alle applicazioni di leggere e scrivere dati di directory in Azure Active Directory (Azure AD).
* `https://graph.windows.net/`
* **arm (Azure Resource Manager)**: Utilizzato per gestire le risorse Azure tramite l'API Azure Resource Manager. Questo include operazioni come la creazione, l'aggiornamento e la cancellazione di risorse come macchine virtuali, account di archiviazione e altro.
* `https://management.core.windows.net/ o https://management.azure.com/`
* **batch (Azure Batch Services)**: Utilizzato per accedere ad Azure Batch, un servizio che consente applicazioni di calcolo parallelo su larga scala e ad alte prestazioni in modo efficiente nel cloud.
* `https://batch.core.windows.net/`
* **data-lake (Azure Data Lake Storage)**: Utilizzato per interagire con Azure Data Lake Storage Gen1, che √® un servizio di archiviazione e analisi dei dati scalabile.
* `https://datalake.azure.net/`
* **media (Azure Media Services)**: Utilizzato per accedere ai servizi Azure Media, che forniscono servizi di elaborazione e distribuzione dei media basati sul cloud per contenuti video e audio.
* `https://rest.media.azure.net`
* **ms-graph (Microsoft Graph API)**: Utilizzato per accedere all'API Microsoft Graph, l'endpoint unificato per i dati dei servizi Microsoft 365. Ti consente di accedere a dati e informazioni da servizi come Azure AD, Office 365, Enterprise Mobility e servizi di sicurezza.
* `https://graph.microsoft.com`
* **oss-rdbms (Azure Open Source Relational Databases)**: Utilizzato per accedere ai servizi di database Azure per motori di database relazionali open-source come MySQL, PostgreSQL e MariaDB.
* `https://ossrdbms-aad.database.windows.net`

Controlla la seguente pagina per scoprire diversi modi per **richiedere token di accesso** e accedere con essi:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

## Riferimenti

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)
* [https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration](https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration)

{% hint style="success" %}
Impara e pratica il Hacking AWS:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Impara e pratica il Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
