# Az - Podstawowe informacje

{% hint style="success" %}
Ucz się i ćwicz Hacking AWS:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz się i ćwicz Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się sztuczkami hackingowymi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów github.

</details>
{% endhint %}

## Hierarchia organizacji

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUchBvhjIdWWR2ldAkWiZMdmrcEYD9Ti5UAa3zAGr9YbAnx4Q_gZNp_zvOU429vgWZ_ixoYHQKdC8bGgkhWYCy591SRIFj6RKCj4BEpVQixAGsp3T3O5sS3k7x5CTaJ-SCBNC7i5KluLyxdiXoZsH1F0ko1Gv88=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption></figcaption></figure>

### Grupy zarządzające

* Może zawierać **inne grupy zarządzające lub subskrypcje**.
* Umożliwia to **stosowanie kontroli zarządzających** takich jak RBAC i Azure Policy raz na poziomie grupy zarządzającej, a następnie **dziedziczenie** ich przez wszystkie subskrypcje w grupie.
* **10 000 grup** zarządzających może być obsługiwanych w jednym katalogu.
* Drzewo grup zarządzających może obsługiwać **do sześciu poziomów głębokości**. Ten limit nie obejmuje poziomu głównego ani poziomu subskrypcji.
* Każda grupa zarządzająca i subskrypcja mogą mieć **tylko jednego rodzica**.
* Nawet jeśli można utworzyć kilka grup zarządzających, **istnieje tylko 1 główna grupa zarządzająca**.
* Główna grupa zarządzająca **zawiera** wszystkie **inne grupy zarządzające i subskrypcje** i **nie może być przenoszona ani usuwana**.
* Wszystkie subskrypcje w ramach jednej grupy zarządzającej muszą ufać **temu samemu najemcy Entra ID.**

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption><p><a href="https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png">https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png</a></p></figcaption></figure>

### Subskrypcje Azure

* To kolejny **logiczny kontener, w którym mogą być uruchamiane zasoby** (VM, DB…) i za który będą naliczane opłaty.
* Jego **rodzicem** jest zawsze **grupa zarządzająca** (może to być główna grupa zarządzająca), ponieważ subskrypcje nie mogą zawierać innych subskrypcji.
* **Ufa tylko jednemu katalogowi Entra ID**
* **Uprawnienia** stosowane na poziomie subskrypcji (lub dowolnego z jej rodziców) są **dziedziczone** przez wszystkie zasoby wewnątrz subskrypcji

### Grupy zasobów

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Grupa zasobów to **kontener**, który przechowuje **powiązane zasoby** dla rozwiązania Azure. Grupa zasobów może zawierać wszystkie zasoby dla rozwiązania lub tylko te **zasoby, które chcesz zarządzać jako grupę**. Zazwyczaj dodawaj **zasoby**, które mają **ten sam cykl życia** do tej samej grupy zasobów, aby łatwo je wdrażać, aktualizować i usuwać jako grupę.

Wszystkie **zasoby** muszą być **w obrębie grupy zasobów** i mogą należeć tylko do jednej grupy, a jeśli grupa zasobów zostanie usunięta, wszystkie zasoby w niej również zostaną usunięte.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfe8U30iP_vdZCvxX4g8nEPRLoo7v0kmCGkDn1frBPn3_GIoZ7VT2LkdsVQWCnrG_HSYNRRPM-1pSECUkbDAB-9YbUYLzpvKVLDETZS81CHWKYM4fDl3oMo5-yvTMnjdLTS2pz8U67xUTIzBhZ25MFMRkq5koKY=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption><p><a href="https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1">https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1</a></p></figcaption></figure>

### Identyfikatory zasobów Azure

Każdy zasób w Azure ma identyfikator zasobu Azure, który go identyfikuje.

Format identyfikatora zasobu Azure jest następujący:

* `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderNamespace}/{resourceType}/{resourceName}`

Dla maszyny wirtualnej o nazwie myVM w grupie zasobów `myResourceGroup` pod subskrypcją ID `12345678-1234-1234-1234-123456789012`, identyfikator zasobu Azure wygląda następująco:

* `/subscriptions/12345678-1234-1234-1234-123456789012/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM`

## Azure vs Entra ID vs Usługi domenowe Azure AD

### Azure

Azure to kompleksowa **platforma chmurowa Microsoftu, oferująca szeroki zakres usług**, w tym maszyny wirtualne, bazy danych, sztuczną inteligencję i przechowywanie. Działa jako fundament do hostowania i zarządzania aplikacjami, budowania skalowalnych infrastruktur oraz uruchamiania nowoczesnych obciążeń w chmurze. Azure zapewnia narzędzia dla programistów i specjalistów IT do tworzenia, wdrażania i zarządzania aplikacjami i usługami w sposób bezproblemowy, dostosowując się do różnych potrzeb, od startupów po duże przedsiębiorstwa.

### Entra ID (dawniej Azure Active Directory)

Entra ID to chmurowa **usługa zarządzania tożsamością i dostępem**, zaprojektowana do obsługi uwierzytelniania, autoryzacji i kontroli dostępu użytkowników. Umożliwia bezpieczny dostęp do usług Microsoft, takich jak Office 365, Azure i wiele aplikacji SaaS innych firm. Oferuje funkcje takie jak jednolity dostęp (SSO), uwierzytelnianie wieloskładnikowe (MFA) i polityki dostępu warunkowego, między innymi.

### Usługi domenowe Entra (dawniej Azure AD DS)

Usługi domenowe Entra rozszerzają możliwości Entra ID, oferując **zarządzane usługi domenowe zgodne z tradycyjnymi środowiskami Windows Active Directory**. Obsługują starsze protokoły, takie jak LDAP, Kerberos i NTLM, umożliwiając organizacjom migrację lub uruchamianie starszych aplikacji w chmurze bez wdrażania lokalnych kontrolerów domeny. Usługa ta obsługuje również polityki grupowe do centralnego zarządzania, co czyni ją odpowiednią dla scenariuszy, w których obciążenia oparte na AD muszą współistnieć z nowoczesnymi środowiskami chmurowymi.

## Zasady Entra ID

### Użytkownicy

* **Nowi użytkownicy**
* Wskaźnik nazwy e-mail i domeny z wybranego najemcy
* Wskaźnik nazwy wyświetlanej
* Wskaźnik hasła
* Wskaźnik właściwości (imię, tytuł zawodowy, dane kontaktowe…)
* Domyślny typ użytkownika to “**członek**”
* **Użytkownicy zewnętrzni**
* Wskaźnik e-mail do zaproszenia i nazwy wyświetlanej (może być to e-mail nie-Microsoft)
* Wskaźnik właściwości
* Domyślny typ użytkownika to “**Gość**”

### Domyślne uprawnienia użytkowników

* **Członkowie (**[**dokumentacja**](https://learn.microsoft.com/en-gb/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions)**)**
* Rejestracja aplikacji: Domyślnie **Tak**
* Ograniczenie użytkowników niebędących administratorami w tworzeniu najemców: Domyślnie **Nie**
* Tworzenie grup zabezpieczeń: Domyślnie **Tak**
* Ograniczenie dostępu do portalu administracyjnego Microsoft Entra: Domyślnie **Nie**
* To nie ogranicza dostępu API do portalu (tylko web)
* Zezwolenie użytkownikom na połączenie konta roboczego lub szkolnego z LinkedIn: Domyślnie **Tak**
* Pokaż, aby użytkownik pozostał zalogowany: Domyślnie **Tak**
* Ograniczenie użytkowników w odzyskiwaniu klucza BitLocker dla ich posiadanych urządzeń: Domyślnie Nie (sprawdź w Ustawieniach urządzenia)
* Odczyt innych użytkowników: Domyślnie **Tak** (za pośrednictwem Microsoft Graph)
* **Goście**
* **Ograniczenia dostępu użytkowników gości**
* **Użytkownicy goście mają takie same uprawnienia jak członkowie** przyznaje domyślnie wszystkie uprawnienia użytkowników członków użytkownikom gości.
* **Użytkownicy goście mają ograniczony dostęp do właściwości i członkostw obiektów katalogowych (domyślnie)** ogranicza dostęp gości tylko do ich własnego profilu użytkownika. Dostęp do informacji o innych użytkownikach i grupach nie jest już dozwolony.
* **Dostęp użytkowników gości jest ograniczony do właściwości i członkostw ich własnych obiektów katalogowych** jest najbardziej restrykcyjny.
* **Goście mogą zapraszać**
* **Każdy w organizacji może zapraszać użytkowników gości, w tym gości i nie-administratorów (najbardziej inkluzywne) - Domyślnie**
* **Użytkownicy członkowie i użytkownicy przypisani do określonych ról administratorów mogą zapraszać użytkowników gości, w tym gości z uprawnieniami członkowskimi**
* **Tylko użytkownicy przypisani do określonych ról administratorów mogą zapraszać użytkowników gości**
* **Nikt w organizacji nie może zapraszać użytkowników gości, w tym administratorów (najbardziej restrykcyjne)**
* **Użytkownicy zewnętrzni mogą odejść**: Domyślnie **Prawda**
* Zezwolenie użytkownikom zewnętrznym na odejście z organizacji

{% hint style="success" %}
Nawet jeśli domyślnie ograniczeni, użytkownicy (członkowie i goście) z przyznanymi uprawnieniami mogą wykonywać powyższe działania.
{% endhint %}

### **Podmioty usługowe**

**Podmiot usługi** to **tożsamość** stworzona do **użytku** z **aplikacjami**, hostowanymi usługami i zautomatyzowanymi narzędziami do uzyskiwania dostępu do zasobów Azure. Ten dostęp jest **ograniczony przez przypisane role**, co daje ci kontrolę nad **które zasoby mogą być dostępne** i na jakim poziomie. Z powodów bezpieczeństwa zawsze zaleca się **używanie podmiotów usługowych z narzędziami zautomatyzowanymi** zamiast pozwalać im logować się za pomocą tożsamości użytkownika.

Możliwe jest **bezpośrednie logowanie jako podmiot usługi** poprzez wygenerowanie mu **sekretu** (hasła), **certyfikatu** lub przyznanie **federowanego** dostępu do platform trzecich (np. Github Actions).

* Jeśli wybierzesz uwierzytelnianie **hasłem** (domyślnie), **zapisz wygenerowane hasło**, ponieważ nie będziesz mógł uzyskać do niego ponownie dostępu.
* Jeśli wybierzesz uwierzytelnianie certyfikatem, upewnij się, że **aplikacja będzie miała dostęp do klucza prywatnego**.

### Rejestracje aplikacji

**Rejestracja aplikacji** to konfiguracja, która pozwala aplikacji integrować się z Entra ID i wykonywać działania.

#### Kluczowe komponenty:

1. **Identyfikator aplikacji (Client ID):** Unikalny identyfikator twojej aplikacji w Azure AD.
2. **URI przekierowania:** URL-e, do których Azure AD wysyła odpowiedzi uwierzytelniające.
3. **Certyfikaty, sekrety i federowane poświadczenia:** Możliwe jest wygenerowanie sekretu lub certyfikatu, aby zalogować się jako podmiot usługi aplikacji lub przyznać jej dostęp federowany (np. Github Actions).&#x20;
1. Jeśli **certyfikat** lub **sekret** zostanie wygenerowany, możliwe jest, aby osoba **zalogowała się jako podmiot usługi** za pomocą narzędzi CLI, znając **identyfikator aplikacji**, **sekret** lub **certyfikat** oraz **najemcę** (domenę lub ID).
4. **Uprawnienia API:** Określa, do jakich zasobów lub API aplikacja ma dostęp.
5. **Ustawienia uwierzytelniania:** Definiuje obsługiwane przez aplikację przepływy uwierzytelniania (np. OAuth2, OpenID Connect).
6. **Podmiot usługi**: Podmiot usługi jest tworzony, gdy aplikacja jest tworzona (jeśli jest to robione z konsoli internetowej) lub gdy jest instalowana w nowym najemcy.
1. **Podmiot usługi** otrzyma wszystkie żądane uprawnienia, z którymi został skonfigurowany.

### Aplikacje korporacyjne

To tylko **tabela w Azure do filtrowania podmiotów usługowych** i sprawdzania aplikacji, które zostały przypisane.

**Nie jest to inny typ "aplikacji",** nie ma żadnego obiektu w Azure, który jest "Aplikacją korporacyjną", to tylko abstrakcja do sprawdzania podmiotów usługowych, rejestracji aplikacji i zarządzanych tożsamości.

### **Zarządzana tożsamość (Metadane)**

Zarządzane tożsamości w Azure Active Directory oferują rozwiązanie do **automatycznego zarządzania tożsamością** aplikacji. Te tożsamości są używane przez aplikacje w celu **łączenia się** z **zasobami** zgodnymi z uwierzytelnianiem Azure Active Directory (**Azure AD**). Umożliwia to **usunięcie potrzeby twardego kodowania poświadczeń chmurowych** w kodzie, ponieważ aplikacja będzie mogła skontaktować się z **usługą metadanych**, aby uzyskać ważny token do **wykonywania działań** jako wskazana zarządzana tożsamość w Azure.

Istnieją dwa typy zarządzanych tożsamości:

* **Przypisana systemowo**. Niektóre usługi Azure pozwalają na **włączenie zarządzanej tożsamości bezpośrednio na instancji usługi**. Gdy włączysz zarządzaną tożsamość przypisaną systemowo, **podmiot usługi** jest tworzony w najemcy Entra ID zaufanym przez subskrypcję, w której znajduje się zasób. Gdy **zasób** jest **usuwany**, Azure automatycznie **usuwa** **tożsamość** za ciebie.
* **Przypisana przez użytkownika**. Użytkownicy mogą również generować zarządzane tożsamości. Są one tworzone wewnątrz grupy zasobów w ramach subskrypcji, a podmiot usługi zostanie utworzony w Entra ID zaufanym przez subskrypcję. Następnie możesz przypisać zarządzaną tożsamość do jednej lub **więcej instancji** usługi Azure (wiele zasobów). W przypadku zarządzanych tożsamości przypisanych przez użytkownika, **tożsamość jest zarządzana oddzielnie od zasobów, które jej używają**.

Zarządzane tożsamości **nie generują wiecznych poświadczeń** (jak hasła czy certyfikaty) do uzyskania dostępu jako podmiot usługi do niej przypisany.

### Domyślne uprawnienia zgody

**Zgoda użytkownika na aplikacje**

* **Nie zezwalaj na zgodę użytkownika**
* Administrator będzie wymagany dla wszystkich aplikacji.
* **Zezwól na zgodę użytkownika na aplikacje od zweryfikowanych wydawców, dla wybranych uprawnień (Zalecane)**
* Wszyscy użytkownicy mogą wyrażać zgodę na uprawnienia klasyfikowane jako "niski wpływ", dla aplikacji od zweryfikowanych wydawców lub aplikacji zarejestrowanych w tej organizacji.
* **Domyślne** uprawnienia o niskim wpływie (chociaż musisz zaakceptować, aby dodać je jako niskie):
* User.Read - zaloguj się i odczytaj profil użytkownika
* offline\_access - utrzymuj dostęp do danych, do których użytkownicy dali mu dostęp
* openid - loguj użytkowników
* profile - wyświetl podstawowy profil użytkownika
* email - wyświetl adres e-mail użytkownika
* **Zezwól na zgodę użytkownika na aplikacje (Domyślnie)**
* Wszyscy użytkownicy mogą wyrażać zgodę na dowolną aplikację, aby uzyskać dostęp do danych organizacji.

**Prośby o zgodę administratora**: Domyślnie **Nie**

* Użytkownicy mogą prosić o zgodę administratora na aplikacje, do których nie mogą wyrazić zgody
* Jeśli **Tak**: Możliwe jest wskazanie Użytkowników, Grup i Ról, które mogą wyrażać zgodę na prośby
* Skonfiguruj również, czy użytkownicy otrzymają powiadomienia e-mail i przypomnienia o wygaśnięciu&#x20;

### Jednostki administracyjne

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Jednostki administracyjne pozwalają na **podział** organizacji na **dowolne jednostki**, które chcesz, a następnie **przypisanie konkretnych administratorów**, którzy mogą **zarządzać tylko członkami** tej jednostki. Na przykład, możesz użyć jednostek administracyjnych do delegowania uprawnień administratorom każdej szkoły na dużym uniwersytecie, aby mogli kontrolować dostęp, zarządzać użytkownikami i ustalać polityki tylko w Szkole Inżynierii.

Tylko **użytkownicy**, **grupy** i **urządzenia** mogą być **członkami** **jednostki administracyjnej**.

Dlatego **jednostka administracyjna** będzie **zawierać** niektórych **członków**, a inne **podmioty** będą **przypisane uprawnienia do tej** jednostki administracyjnej, które mogą wykorzystać do **zarządzania członkami** jednostki administracyjnej.

## Role i uprawnienia

**Role** są **przypisywane** do **podmiotów** w ramach **zakresu**: `podmiot -[MA ROLĘ]->(zakres)`

**Role** przypisane do **grup** są **dziedziczone** przez wszystkich **członków** grupy.

W zależności od zakresu, do którego przypisano rolę, **rola** może być **dziedziczona** przez **inne zasoby** wewnątrz kontenera zakresu. Na przykład, jeśli użytkownik A ma **rolę w subskrypcji**, będzie miał tę **rolę we wszystkich grupach zasobów** w ramach subskrypcji i na **wszystkich zasobach** wewnątrz grupy zasobów.

### **Klasyczne role**

| **Właściciel**                     | <ul><li>Pełny dostęp do wszystkich zasobów</li><li>Może zarządzać dostępem dla innych użytkowników</li></ul> | Wszystkie typy zasobów |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Współtwórca**               | <ul><li>Pełny dostęp do wszystkich zasobów</li><li>Nie może zarządzać dostępem</li></ul>              | Wszystkie typy zasobów |
| **Czytelnik**                    | • Wyświetl wszystkie zasoby                                                                     | Wszystkie typy zasobów |
| **Administrator dostępu użytkowników** | <ul><li>Wyświetl wszystkie zasoby</li><li>Może zarządzać dostępem dla innych użytkowników</li></ul>           | Wszystkie typy zasobów |

### Wbudowane role

[Z dokumentacji: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ma kilka **wbudowanych ról Azure**, które możesz **przypisać** do **użytkowników, grup, podmiotów usługowych i zarządzanych tożsamości**. Przypisania ról to sposób, w jaki kontrolujesz **dostęp do zasobów Azure**. Jeśli wbudowane role nie spełniają specyficznych potrzeb twojej organizacji, możesz stworzyć własne [**niestandardowe role Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

**Wbudowane** role mają zastosowanie tylko do **zasobów**, do których są **przeznaczone**, na przykład sprawdź te 2 przykłady **wbudowanych ról dla zasobów obliczeniowych**:

| [Czytelnik kopii zapasowej dysku](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Umożliwia uprawnienie do kopii zapasowej, aby wykonać kopię zapasową dysku.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Użytkownik logowania do maszyny wirtualnej](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Wyświetl maszyny wirtualne w portalu i zaloguj się jako zwykły użytkownik. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Te role mogą **być również przypisane do kontenerów logicznych** (takich jak grupy zarządzające, subskrypcje i grupy zasobów), a podmioty, które są nimi objęte, będą miały je **w odniesieniu do zasobów wewnątrz tych kontenerów**.

* Znajdź tutaj listę z [**wszystkimi wbudowanymi rolami Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Znajdź tutaj listę z [**wszystkimi wbudowanymi rolami Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Niestandardowe role

Azure pozwala również na tworzenie [**niestandardowych ról**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) z uprawnieniami, których potrzebuje użytkownik.

### Odrzucone uprawnienia

* Aby **podmiot miał dostęp do zasobu**, musi mu zostać przyznana wyraźna rola (w jakikolwiek sposób) **przyznająca mu to uprawnienie**.
* Wyraźne **przypisanie roli odrzucającej ma pierwszeństwo** przed rolą przyznającą uprawnienie.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Globalny administrator

Użytkownicy z rolą Globalnego Administratora mają możliwość '**podniesienia' roli Administratora dostępu użytkowników do głównej grupy zarządzającej**. Oznacza to, że Globalny Administrator będzie mógł zarządzać dostępem **do wszystkich subskrypcji Azure i grup zarządzających.**\
To podniesienie można wykonać na końcu strony: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Polityki Azure

Polityki Azure to zestaw **reguł i regulacji w Microsoft Azure**, usłudze chmurowej, które pomagają zarządzać i egzekwować standardy organizacyjne oraz oceniać zgodność na dużą skalę. Te polityki egzekwują różne zasady dotyczące twoich **zasobów Azure**, zapewniając, że te zasoby pozostają zgodne z normami korporacyjnymi i umowami o poziomie usług.

Polityki Azure są kluczowe dla zarządzania chmurą i bezpieczeństwa, pomagając zapewnić, że zasoby są używane prawidłowo i efektywnie oraz że są zgodne z regulacjami zewnętrznymi i wewnętrznymi politykami.\
Oto kilka przykładów:

1. **Zapewnienie zgodności z określonymi regionami Azure**: Ta polityka zapewnia, że wszystkie zasoby są wdrażane w określonych regionach Azure. Na przykład firma może chcieć zapewnić, że wszystkie jej dane są przechowywane w Europie w celu zgodności z RODO.
2. **Egzekwowanie standardów nazewnictwa**: Polityki mogą egzekwować konwencje nazewnictwa dla zasobów Azure. Pomaga to w organizacji i łatwym identyfikowaniu zasobów na podstawie ich nazw, co jest pomocne w dużych środowiskach.
3. **Ograniczenie niektórych typów zasobów**: Ta polityka może ograniczyć tworzenie niektórych typów zasobów. Na przykład polityka może być ustawiona, aby zapobiec tworzeniu drogich typów zasobów, takich jak niektóre rozmiary VM, aby kontrolować koszty.
4. **Egzekwowanie polityk tagowania**: Tagi to pary klucz-wartość związane z zasobami Azure używane do zarządzania zasobami. Polityki mogą egzekwować, że określone tagi muszą być obecne lub mieć określone wartości dla wszystkich zasobów. Jest to przydatne do śledzenia kosztów, własności lub kategoryzacji zasobów.
5. **Ograniczenie publicznego dostępu do zasobów**: Polityki mogą egzekwować, że niektóre zasoby, takie jak konta magazynowe lub bazy danych, nie mają publicznych punktów końcowych, zapewniając, że są dostępne tylko w sieci organizacji.
6. **Automatyczne stosowanie ustawień zabezpieczeń**: Polityki mogą być używane do automatycznego stosowania ustawień zabezpieczeń do zasobów, takich jak stosowanie określonej grupy zabezpieczeń sieci do wszystkich VM lub zapewnienie, że wszystkie konta magazynowe używają szyfrowania.

Należy pamiętać, że polityki Azure mogą być przypisane do dowolnego poziomu hierarchii Azure, ale są **najczęściej używane w głównej grupie zarządzającej** lub w innych grupach zarządzających.

### Zakres uprawnień

W Azure **uprawnienia mogą być przypisane do dowolnej części hierarchii**. Obejmuje to grupy zarządzające, subskrypcje, grupy zasobów i poszczególne zasoby. Uprawnienia są **dziedziczone** przez zawarte **zasoby** podmiotu, w którym zostały przypisane.

Ta struktura hierarchiczna pozwala na efektywne i skalowalne zarządzanie uprawnieniami dostępu.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (kontrola dostępu oparta na rolach) to to, co już widzieliśmy w poprzednich sekcjach: **Przypisanie roli do podmiotu, aby przyznać mu dostęp** do zasobu.\
Jednak w niektórych przypadkach możesz chcieć zapewnić **bardziej szczegółowe zarządzanie dostępem** lub **uproszczenie** zarządzania **setkami** przypisań ról.

Azure **ABAC** (kontrola dostępu oparta na atrybutach) opiera się na Azure RBAC, dodając **warunki przypisania ról oparte na atrybutach** w kontekście określonych działań. Warunek _przypisania roli_ to **dodatkowa kontrola, którą możesz opcjonalnie dodać do przypisania roli**, aby zapewnić bardziej szczegółową kontrolę dostępu. Warunek filtruje uprawnienia przyznane jako część definicji roli i przypisania roli. Na przykład możesz **dodać warunek, który wymaga, aby obiekt miał określony tag, aby go odczytać**.\
Nie **możesz** wyraźnie **odrzucić** **dostępu** do określonych zasobów **za pomocą warunków**.

### Domyślne uprawnienia użytkowników

Podstawowy użytkownik będzie miał pewne **domyślne uprawnienia** do enumeracji niektórych części AzureAD:

* Odczyt wszystkich użytkowników, grup, aplikacji, urządzeń, ról, subskrypcji i ich publicznych właściwości
* Zapraszanie gości (_można wyłączyć_)
* Tworzenie grup zabezpieczeń
* Odczyt nieukrytych członkostw grup
* Dodawanie gości do posiadanych grup
* Tworzenie nowej aplikacji (_można wyłączyć_)
* Dodawanie do 50 urządzeń do Azure (_można wyłączyć_)

Możesz zobaczyć pełną [listę **domyślnych uprawnień użytkowników** w dokumentacji](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Ponadto pamiętaj, że na tej liście możesz również zobaczyć **listę domyślnych uprawnień gości**.

{% hint style="info" %}
Pamiętaj, że aby enumerować zasoby Azure, użytkownik potrzebuje wyraźnego przyznania uprawnienia.
{% endhint %}

### Zarządzanie tożsamościami uprzywilejowanymi (PIM)

Zarządzanie tożsamościami uprzywilejowanymi (PIM) w Azure to narzędzie, które **zarządza, kontroluje i monitoruje uprzywilejowany dostęp** w Azure Active Directory i Azure. Zwiększa bezpieczeństwo, zapewniając **dostęp uprzywilejowany na żądanie i ograniczony czasowo**, **egzekwując przepływy pracy zatwierdzania i wymagając dodatkowego uwierzytelnienia**. Takie podejście minimalizuje ryzyko nieautoryzowanego dostępu, zapewniając, że podwyższone uprawnienia są przyznawane tylko wtedy, gdy jest to konieczne i na określony czas.

## Tokeny uwierzytelniające

Istnieją **trzy typy tokenów** używanych w OIDC:

* [**Tokeny dostępu**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Klient przedstawia ten token serwerowi zasobów, aby **uzyskać dostęp do zasobów**. Może być używany tylko dla określonej kombinacji użytkownika, klienta i zasobu i **nie może być unieważniony** do momentu wygaśnięcia - co trwa 1 godzinę domyślnie. Wykrywalność jest niska przy użyciu tego.
* **Tokeny ID**: Klient otrzymuje ten **token od serwera autoryzacji**. Zawiera podstawowe informacje o użytkowniku. Jest **powiązany z określoną kombinacją użytkownika i klienta**.
* **Tokeny odświeżania**: Przyznawane klientowi wraz z tokenem dostępu. Używane do **uzyskiwania nowych tokenów dostępu i ID**. Jest powiązany z określoną kombinacją użytkownika i klienta i może być unieważniony. Domyślne wygaśnięcie wynosi **90 dni** dla nieaktywnych tokenów odświeżania i **brak wygaśnięcia dla aktywnych tokenów**.

{% hint style="warning" %}
Informacje o **dostępie warunkowym** są **przechowywane** wewnątrz **JWT**. Więc jeśli zażądajesz **tokena z dozwolonego adresu IP**, ten **adres IP** zostanie **przechowany** w tokenie, a następnie możesz użyć tego tokena z **niedozwolonego adresu IP, aby uzyskać dostęp do zasobów**.
{% endhint %}

Sprawdź następującą stronę, aby poznać różne sposoby **żądania tokenów dostępu** i logowania się z ich pomocą:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

Najczęstsze punkty końcowe API to:

* **Azure Resource Manager** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (Azure AD Graph, który jest przestarzały, to graph.windows.net)

## Odnośniki

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)
* [https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration](https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration)

{% hint style="success" %}
Ucz się i ćwicz Hacking AWS:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz się i ćwicz Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się sztuczkami hackingowymi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów github.

</details>
{% endhint %}
