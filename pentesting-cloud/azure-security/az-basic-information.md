# Az - Osnovne informacije

{% hint style="success" %}
Učite i vežbajte AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Učite i vežbajte GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podrška HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Hijerarhija organizacije

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

### Grupa za upravljanje

Ako vaša organizacija ima **mnogo Azure pretplata**, možda će vam biti potreban način da efikasno **upravljate pristupom**, politikama i usklađenošću za te **pretplate**. **Grupe za upravljanje** pružaju **opseg upravljanja iznad pretplata**.

Napomena: **10.000 grupa za upravljanje** može biti podržano u jednoj direktoriji, a stablo grupa za upravljanje može podržati **do šest nivoa dubine**.

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

[Iz dokumenata](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): Svakoj direktoriji dodeljuje se jedna **grupa za upravljanje na najvišem nivou koja se zove korenska** grupa za upravljanje. Korenska grupa za upravljanje je ugrađena u hijerarhiju da bi **sve grupe za upravljanje i pretplate bile povezane sa njom**. Ova korenska grupa za upravljanje omogućava **globalne politike i dodeljivanje Azure uloga** na nivou direktorije. [Azure AD **Global Administrator** treba da se unapredi](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) na **ulogu Administratora pristupa korisnicima ove korenske grupe** u početku. Nakon unapređenja pristupa, administrator može **dodeliti bilo koju Azure ulogu drugim korisnicima ili grupama direktorije da upravljaju hijerarhijom**. Kao administrator, možete dodeliti **svoj nalog kao vlasnika korenske** grupe za upravljanje.

Korenska grupa za upravljanje **ne može biti premestena ili obrisana**, za razliku od drugih grupa za upravljanje.

Grupe za upravljanje pružaju vam upravljanje na nivou preduzeća bez obzira na tip pretplata koje imate. Međutim, **sve pretplate unutar jedne grupe za upravljanje** moraju verovati **isti Azure Active Directory (Azure AD) tenant**.

<figure><img src="../../.gitbook/assets/image (157).png" alt=""><figcaption></figcaption></figure>

### Azure pretplate

U Azure, pretplata služi kao **logički kontejner** za svrhe **provisioning-a** poslovnih ili tehničkih **resursa**. Ovaj kontejner održava **detalje resursa** kao što su virtuelne mašine (VM), baze podataka, među ostalima. Prilikom kreiranja Azure resursa, kao što je VM, **pretplata povezana sa njim** se specificira. Ova struktura olakšava delegaciju pristupa, koristeći mehanizme kontrole pristupa zasnovane na ulogama.

### Grupe resursa

[Iz dokumenata:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Grupa resursa je **kontejner** koji sadrži **povezane resurse** za Azure rešenje. Grupa resursa može uključivati sve resurse za rešenje, ili samo one **resurse koje želite da upravljate kao grupu**. Generalno, dodajte **resurse** koji dele **isti životni ciklus** u istu grupu resursa kako biste ih lako implementirali, ažurirali i obrisali kao grupu.

Svi **resursi** moraju biti **unutar grupe resursa** i mogu pripadati samo jednoj grupi, a ako se grupa resursa obriše, svi resursi unutar nje se takođe brišu.

### Administrativne jedinice

[Iz dokumenata:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Administrativne jedinice vam omogućavaju da **podelite** svoju organizaciju na **bilo koju jedinicu** koju želite, a zatim **dodelite specifične administratore** koji mogu **upravljati samo članovima** te jedinice. Na primer, mogli biste koristiti administrativne jedinice da delegirate dozvole administratorima svake škole na velikom univerzitetu, tako da mogu kontrolisati pristup, upravljati korisnicima i postavljati politike samo u Školi inženjerstva.

Samo **korisnici**, **grupe** i **uređaji** mogu biti **članovi** **administrativne jedinice**.

Stoga, **administrativna jedinica** će **sadržati** neke **članove**, a drugi **principi** će imati **dodeljene dozvole** nad tom administrativnom **jedinicom** koje mogu koristiti za **upravljanje članovima** administrativne jedinice.

## Azure vs Azure AD vs Azure AD Domain Services

Važno je napomenuti da je **Azure AD** usluga **unutar** **Azure**. **Azure** je Microsoftova **cloud platforma**, dok je **Azure AD** preduzetni **identitet** **usluga** u Azure.\
Pored toga, **Azure AD nije kao Windows Active Directory**, to je identitetska usluga koja funkcioniše na potpuno drugačiji način. Ako želite da pokrenete **Domain Controller u Azure** za vaše Windows Active Directory okruženje, morate koristiti **Azure AD Domain Services**.

## Principi

Azure podržava različite tipove principa:

* **Korisnik**: Obična **osoba** sa kredencijalima za pristup.
* **Grupa**: **Grupa principa** koja se upravlja zajedno. **Dozvole** dodeljene grupama se **nasleđuju** od strane njenih **članova**.
* **Servisni princip/Preduzetničke aplikacije**: To je **identitet** kreiran za **korišćenje** sa **aplikacijama**, hostovanim uslugama i automatizovanim alatima za pristup Azure resursima. Ovaj pristup je **ograničen ulogama dodeljenim** servisnom principu, dajući vam kontrolu nad **koji resursi mogu biti pristupljeni** i na kojem nivou. Iz bezbednosnih razloga, uvek se preporučuje da **koristite servisne principe sa automatizovanim alatima** umesto da im dozvolite da se prijave sa identitetom korisnika.

Kada kreirate **servisni princip**, možete izabrati između **autentifikacije lozinkom** ili **autentifikacije sertifikatom**.

* Ako izaberete **lozinku** (podrazumevano), **sačuvajte generisanu lozinku** jer je nećete moći ponovo pristupiti.
* Ako izaberete autentifikaciju sertifikatom, uverite se da **aplikacija ima pristup privatnom ključu**.
* **Upravljani identitet (Metadata Creds)**: Upravljani identiteti u Azure Active Directory nude rešenje za **automatsko upravljanje identitetom** aplikacija. Ovi identiteti se koriste od strane aplikacija za svrhe **povezivanja** sa **resursima** kompatibilnim sa Azure Active Directory (**Azure AD**) autentifikacijom. Korišćenjem upravljanih identiteta, aplikacije mogu **osigurati Azure AD tokene** dok eliminišu potrebu za direktnim rukovanjem kredencijalima. Postoje dve vrste upravljanih identiteta:
* **Sistemom dodeljeni**. Neke Azure usluge vam omogućavaju da **omogućite upravljani identitet direktno na instanci usluge**. Kada omogućite sistemom dodeljeni upravljani identitet, identitet se kreira u Azure AD. Identitet je vezan za **životni ciklus te instance usluge**. Kada se **resurs** **obriše**, Azure automatski **briše** **identitet** za vas. Po dizajnu, samo taj Azure resurs može koristiti ovaj identitet za zahtevanje tokena od Azure AD.
* **Korisnikom dodeljeni**. Takođe možete kreirati upravljani identitet kao samostalan Azure resurs. Možete [kreirati korisnikom dodeljeni upravljani identitet](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) i dodeliti ga jednoj ili **više instanci** Azure usluge (više resursa). Za korisnikom dodeljene upravljane identitete, **identitet se upravlja odvojeno od resursa koji ga koriste**.

## Uloge i dozvole

**Uloge** se **dodeljuju** **principima** na **opsegu**: `principal -[HAS ROLE]->(scope)`

**Uloge** dodeljene **grupama** se **nasleđuju** od strane svih **članova** grupe.

U zavisnosti od opsega na koji je uloga dodeljena, **uloga** se može **naslediti** na **druge resurse** unutar kontejnera opsega. Na primer, ako korisnik A ima **ulogu na pretplati**, on će imati tu **ulogu na svim grupama resursa** unutar pretplate i na **svim resursima** unutar grupe resursa.

### **Klasične uloge**

| **Vlasnik**                     | <ul><li>Puni pristup svim resursima</li><li>Može upravljati pristupom za druge korisnike</li></ul> | Svi tipovi resursa |
| ------------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Doprinosilac**               | <ul><li>Puni pristup svim resursima</li><li>Ne može upravljati pristupom</li></ul>              | Svi tipovi resursa |
| **Čitalac**                    | • Pregled svih resursa                                                                     | Svi tipovi resursa |
| **Administrator pristupa korisnicima** | <ul><li>Pregled svih resursa</li><li>Može upravljati pristupom za druge korisnike</li></ul>           | Svi tipovi resursa |

### Ugrađene uloge

[Iz dokumenata: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure kontrola pristupa zasnovana na ulogama (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ima nekoliko **ugrađenih uloga** koje možete **dodeliti** **korisnicima, grupama, servisnim principima i upravljanim identitetima**. Dodeljivanje uloga je način na koji kontrolišete **pristup Azure resursima**. Ako ugrađene uloge ne zadovoljavaju specifične potrebe vaše organizacije, možete kreirati svoje [**Azure prilagođene uloge**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

**Ugrađene** uloge se primenjuju samo na **resurse** za koje su **namenjene**, na primer, proverite ova 2 primera **ugrađenih uloga** nad resursima za računanje:

| [Čitalac rezervi diska](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Pruža dozvolu za rezervu vault-a da izvrši rezervu diska.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Korisnik za prijavu na virtuelnu mašinu](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Pregled virtuelnih mašina u portalu i prijava kao običan korisnik. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Ove uloge se **takođe mogu dodeliti nad logičkim kontejnerima** (kao što su grupe za upravljanje, pretplate i grupe resursa) i principi na koje utiču će ih imati **nad resursima unutar tih kontejnera**.

* Pronađite ovde listu sa [**svim ugrađenim ulogama Azure-a**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Pronađite ovde listu sa [**svim ugrađenim ulogama Azure AD-a**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Prilagođene uloge

Azure takođe omogućava kreiranje [**prilagođenih uloga**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) sa dozvolama koje korisnik treba.

### Odbijena dozvola

* Da bi **princip imao neki pristup nad resursom**, potrebna mu je eksplicitna dodela uloge (na bilo koji način) **koja mu dodeljuje tu dozvolu**.
* Eksplicitna **dodela odbijene uloge ima prioritet** nad ulogom koja dodeljuje dozvolu.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Globalni administrator

Korisnici sa ulogom Globalnog administratora imaju mogućnost da '**unaprede' na ulogu Administratora pristupa korisnicima Azure-a za korensku grupu za upravljanje**. To znači da će Globalni administrator moći da upravlja pristupom **svim Azure pretplatama i grupama za upravljanje.**\
Ovo unapređenje može se izvršiti na kraju stranice: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Azure politike

Azure politike su skup **pravila i propisa u Microsoft Azure**, cloud computing usluzi, koji pomažu u upravljanju i sprovođenju organizacionih standarda i proceni usklađenosti na velikoj skali. Ove politike sprovode različita pravila nad vašim **Azure resursima**, osiguravajući da ti resursi ostanu usklađeni sa korporativnim standardima i ugovorima o nivou usluge.

Azure politike su ključne za upravljanje cloud-om i bezbednost, pomažući da se osigura da se resursi koriste pravilno i efikasno, i da se pridržavaju spoljašnjih propisa i unutrašnjih politika.\
Neki primeri:

1. **Osiguranje usklađenosti sa specifičnim Azure regionima**: Ova politika osigurava da se svi resursi implementiraju u specifičnim Azure regionima. Na primer, kompanija može želeti da osigura da su svi njeni podaci pohranjeni u Evropi radi usklađenosti sa GDPR-om.
2. **Sprovođenje standarda imenovanja**: Politike mogu sprovoditi konvencije imenovanja za Azure resurse. Ovo pomaže u organizaciji i lakom identifikovanju resursa na osnovu njihovih imena, što je korisno u velikim okruženjima.
3. **Ograničavanje određenih tipova resursa**: Ova politika može ograničiti kreiranje određenih tipova resursa. Na primer, politika može biti postavljena da spreči kreiranje skupih tipova resursa, kao što su određene veličine VM-a, kako bi se kontrolisali troškovi.
4. **Sprovođenje politika označavanja**: Oznake su parovi ključ-vrednost povezani sa Azure resursima koji se koriste za upravljanje resursima. Politike mogu sprovoditi da određene oznake moraju biti prisutne, ili imati specifične vrednosti, za sve resurse. Ovo je korisno za praćenje troškova, vlasništva ili kategorizaciju resursa.
5. **Ograničavanje javnog pristupa resursima**: Politike mogu sprovoditi da određeni resursi, kao što su skladišni nalozi ili baze podataka, nemaju javne krajnje tačke, osiguravajući da su dostupni samo unutar mreže organizacije.
6. **Automatsko primenjivanje bezbednosnih postavki**: Politike se mogu koristiti za automatsko primenjivanje bezbednosnih postavki na resurse, kao što je primena specifične grupe za bezbednost mreže na sve VM-ove ili osiguranje da svi skladišni nalozi koriste enkripciju.

Napomena: Azure politike se mogu prikačiti na bilo koji nivo Azure hijerarhije, ali se **najčešće koriste u korenskoj grupi za upravljanje** ili u drugim grupama za upravljanje.

### Opseg dozvola

U Azure **dozvole se mogu dodeliti bilo kojem delu hijerarhije**. To uključuje grupe za upravljanje, pretplate, grupe resursa i pojedinačne resurse. Dozvole se **nasleđuju** od strane sadržanih **resursa** entiteta gde su dodeljene.

Ova hijerarhijska struktura omogućava efikasno i skalabilno upravljanje dozvolama pristupa.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (kontrola pristupa zasnovana na ulogama) je ono što smo već videli u prethodnim odeljcima: **Dodeljivanje uloge principu kako bi mu se omogućio pristup** nad resursom.\
Međutim, u nekim slučajevima možda ćete želeti da obezbedite **fino podešavanje upravljanja pristupom** ili **pojednostavite** upravljanje **stotinama** dodela uloga.

Azure **ABAC** (kontrola pristupa zasnovana na atributima) se oslanja na Azure RBAC dodajući **uslove dodele uloga zasnovane na atributima** u kontekstu specifičnih akcija. _Uslov dodele uloge_ je **dodatna provera koju možete opcionalno dodati svojoj dodeli uloge** kako biste obezbedili finije upravljanje pristupom. Uslov filtrira dozvole dodeljene kao deo definicije uloge i dodele uloge. Na primer, možete **dodati uslov koji zahteva da objekat ima specifičnu oznaku da bi se pročitao objekat**.\
Ne možete eksplicitno **odbiti** **pristup** specifičnim resursima **korišćenjem uslova**.

### Podrazumevane dozvole korisnika

Osnovni korisnik će imati neke **podrazumevane dozvole** za enumeraciju nekih delova AzureAD:

* Čitanje svih korisnika, grupa, aplikacija, uređaja, uloga, pretplata i njihovih javnih svojstava
* Pozivanje gostiju (_može biti isključeno_)
* Kreiranje sigurnosnih grupa
* Čitanje ne-skrivenih članstava grupa
* Dodavanje gostiju u vlasničke grupe
* Kreiranje nove aplikacije (_može biti isključeno_)
* Dodavanje do 50 uređaja u Azure (_može biti isključeno_)

Možete videti punu [listu **podrazumevanih dozvola korisnika** u dokumentima](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Pored toga, napomenite da u toj listi možete takođe videti **listu podrazumevanih dozvola za goste**.

{% hint style="info" %}
Zapamtite da da bi se enumerisali Azure resursi, korisnik treba eksplicitnu dodelu dozvole.
{% endhint %}

### Upravljanje privilegovanim identitetom (PIM)

Upravljanje privilegovanim identitetom (PIM) u Azure je alat koji **upravlja, kontroliše i prati privilegovani pristup** u Azure Active Directory i Azure. Povećava bezbednost pružajući **privilegovani pristup na zahtev i vremenski ograničen**, **sprovodeći radne tokove odobravanja i zahtevajući dodatnu autentifikaciju**. Ovaj pristup minimizira rizik od neovlašćenog pristupa osiguravajući da se povišene dozvole dodeljuju samo kada je to neophodno i na određeni vremenski period.

## Autentifikacioni tokeni

Postoje **tri tipa tokena** koji se koriste u OIDC:

* [**Pristupni tokeni**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Klijent predstavlja ovaj token serveru resursa da bi **pristupio resursima**. Može se koristiti samo za specifičnu kombinaciju korisnika, klijenta i resursa i **ne može biti opozvan** do isteka - što je podrazumevano 1 sat. Detekcija je niska koristeći ovo.
* **ID tokeni**: Klijent prima ovaj **token od autorizacionog servera**. Sadrži osnovne informacije o korisniku. **Povezan je sa specifičnom kombinacijom korisnika i klijenta**.
* **Refresh tokeni**: Dodeljuju se klijentu zajedno sa pristupnim tokenom. Koriste se za **dobijanje novih pristupnih i ID tokena**. Povezani su sa specifičnom kombinacijom korisnika i klijenta i mogu biti opozvani. Podrazumevani rok važenja je **90 dana** za neaktivne refresh tokene i **nema isteka za aktivne tokene**.

{% hint style="warning" %}
Informacije za **uslovni pristup** su **smeštene** unutar **JWT**. Dakle, ako zatražite **token sa dozvoljene IP adrese**, ta **IP** će biti **smeštena** u tokenu i tada možete koristiti taj token sa **ne-dozvoljene IP adrese za pristup resursima**.
{% endhint %}

Proverite sledeću stranicu da biste saznali različite načine za **zahtev za pristupnim tokenima** i prijavu sa njima:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

Najčešći API krajnji tačke su:

* **Azure Resource Manager** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (Azure AD Graph koji je ukinut je graph.windows.net)

## Reference

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

{% hint style="success" %}
Učite i vežbajte AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Učite i vežbajte GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podrška HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
