# Az - Osnovne informacije

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Hijerarhija organizacije

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUchBvhjIdWWR2ldAkWiZMdmrcEYD9Ti5UAa3zAGr9YbAnx4Q_gZNp_zvOU429vgWZ_ixoYHQKdC8bGgkhWYCy591SRIFj6RKCj4BEpVQixAGsp3T3O5sS3k7x5CTaJ-SCBNC7i5KluLyxdiXoZsH1F0ko1Gv88=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption></figcaption></figure>

### Grupa za upravljanje

* MoÅ¾e sadrÅ¾ati **druge grupe za upravljanje ili pretplate**.
* Ovo omoguÄ‡ava **primenu kontrola upravljanja** kao Å¡to su RBAC i Azure Policy jednom na nivou grupe za upravljanje i da se one **naslede** od svih pretplata u grupi.
* **10.000 grupa za upravljanje** moÅ¾e biti podrÅ¾ano u jednoj direktoriji.
* Drvo grupa za upravljanje moÅ¾e podrÅ¾ati **do Å¡est nivoa dubine**. Ova granica ne ukljuÄuje nivo korena ili nivo pretplate.
* Svaka grupa za upravljanje i pretplata mogu podrÅ¾avati **samo jednog roditelja**.
* ÄŒak i ako se moÅ¾e kreirati nekoliko grupa za upravljanje, **postoji samo 1 grupa za upravljanje korenom**.
* Grupa za upravljanje korenom **sadrÅ¾i** sve **druge grupe za upravljanje i pretplate** i **ne moÅ¾e se premestiti ili obrisati**.
* Sve pretplate unutar jedne grupe za upravljanje moraju verovati **istom Entra ID tenant-u.**

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption><p><a href="https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png">https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png</a></p></figcaption></figure>

### Azure pretplate

* To je joÅ¡ jedan **logiÄki kontejner u kojem se mogu pokretati resursi** (VM-ovi, DB-oviâ€¦) i biÄ‡e naplaÄ‡eni.
* Njegov **roditelj** je uvek **grupa za upravljanje** (i moÅ¾e biti grupa za upravljanje korenom) jer pretplate ne mogu sadrÅ¾ati druge pretplate.
* **Veruje samo jednoj Entra ID** direktoriji
* **Dozvole** primenjene na nivou pretplate (ili bilo kojem od njegovih roditelja) se **nasleÄ‘uju** svim resursima unutar pretplate

### Grupe resursa

[Iz dokumenata:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Grupa resursa je **kontejner** koji sadrÅ¾i **povezane resurse** za Azure reÅ¡enje. Grupa resursa moÅ¾e ukljuÄivati sve resurse za reÅ¡enje, ili samo one **resurse koje Å¾elite da upravljate kao grupu**. Generalno, dodajte **resurse** koji dele **isti Å¾ivotni ciklus** u istu grupu resursa kako biste ih lako implementirali, aÅ¾urirali i obrisali kao grupu.

Svi **resursi** moraju biti **unutar grupe resursa** i mogu pripadati samo jednoj grupi, a ako se grupa resursa obriÅ¡e, svi resursi unutar nje se takoÄ‘e briÅ¡u.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfe8U30iP_vdZCvxX4g8nEPRLoo7v0kmCGkDn1frBPn3_GIoZ7VT2LkdsVQWCnrG_HSYNRRPM-1pSECUkbDAB-9YbUYLzpvKVLDETZS81CHWKYM4fDl3oMo5-yvTMnjdLTS2pz8U67xUTIzBhZ25MFMRkq5koKY=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption><p><a href="https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1">https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1</a></p></figcaption></figure>

### Azure Resource IDs

Svaki resurs u Azure-u ima Azure Resource ID koji ga identifikuje.

Format Azure Resource ID-a je sledeÄ‡i:

* `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderNamespace}/{resourceType}/{resourceName}`

Za virtuelnu maÅ¡inu nazvanu myVM u grupi resursa `myResourceGroup` pod ID-jem pretplate `12345678-1234-1234-1234-123456789012`, Azure Resource ID izgleda ovako:

* `/subscriptions/12345678-1234-1234-1234-123456789012/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM`

## Azure vs Entra ID vs Azure AD Domain Services

### Azure

Azure je Microsoftova sveobuhvatna **platforma za cloud raÄunarstvo, koja nudi Å¡irok spektar usluga**, ukljuÄujuÄ‡i virtuelne maÅ¡ine, baze podataka, veÅ¡taÄku inteligenciju i skladiÅ¡tenje. Deluje kao osnova za hostovanje i upravljanje aplikacijama, izgradnju skalabilnih infrastruktura i pokretanje modernih radnih optereÄ‡enja u oblaku. Azure pruÅ¾a alate za programere i IT profesionalce da kreiraju, implementiraju i upravljaju aplikacijama i uslugama bez problema, zadovoljavajuÄ‡i razne potrebe od startapa do velikih preduzeÄ‡a.

### Entra ID (ranije Azure Active Directory)

Entra ID je cloud-bazirana **usluga upravljanja identitetom i pristupom** dizajnirana da upravlja autentifikacijom, autorizacijom i kontrolom pristupa korisnika. OmoguÄ‡ava siguran pristup Microsoftovim uslugama kao Å¡to su Office 365, Azure i mnoge treÄ‡e strane SaaS aplikacije. Sa funkcijama kao Å¡to su jedinstveno prijavljivanje (SSO), viÅ¡efaktorska autentifikacija (MFA) i politike uslovnog pristupa, izmeÄ‘u ostalog.

### Entra Domain Services (ranije Azure AD DS)

Entra Domain Services proÅ¡iruje moguÄ‡nosti Entra ID-a nudeÄ‡i **upravljane usluge domena kompatibilne sa tradicionalnim Windows Active Directory okruÅ¾enjima**. PodrÅ¾ava nasleÄ‘ene protokole kao Å¡to su LDAP, Kerberos i NTLM, omoguÄ‡avajuÄ‡i organizacijama da migriraju ili pokreÄ‡u starije aplikacije u oblaku bez implementacije lokalnih kontrolera domena. Ova usluga takoÄ‘e podrÅ¾ava grupne politike za centralizovano upravljanje, Å¡to je Äini pogodnom za scenarije u kojima nasleÄ‘ena ili AD-bazirana radna optereÄ‡enja treba da koegzistiraju sa modernim cloud okruÅ¾enjima.

## Entra ID Principali

### Korisnici

* **Novi korisnici**
* NaznaÄite ime i domen e-poÅ¡te iz odabranog tenant-a
* NaznaÄite prikazano ime
* NaznaÄite lozinku
* NaznaÄite svojstva (ime, radno mesto, kontakt informacijeâ€¦)
* Podrazumevani tip korisnika je â€œ**Älan**â€
* **Spoljni korisnici**
* NaznaÄite e-poÅ¡tu za poziv i prikazano ime (moÅ¾e biti e-poÅ¡ta koja nije Microsoft)
* NaznaÄite svojstva
* Podrazumevani tip korisnika je â€œ**Gost**â€

### Podrazumevane dozvole Älanova i gostiju

MoÅ¾ete ih proveriti na [https://learn.microsoft.com/en-us/entra/fundamentals/users-default-permissions](https://learn.microsoft.com/en-us/entra/fundamentals/users-default-permissions) ali meÄ‘u ostalim radnjama Älan Ä‡e moÄ‡i da:

* ÄŒita sve korisnike, grupe, aplikacije, ureÄ‘aje, uloge, pretplate i njihove javne osobine
* Poziva goste (_moÅ¾e se iskljuÄiti_)
* Kreira sigurnosne grupe
* ÄŒita ne-skrivene Älanstva grupa
* Dodaje goste u vlasniÄke grupe
* Kreira nove aplikacije (_moÅ¾e se iskljuÄiti_)
* Dodaje do 50 ureÄ‘aja u Azure (_moÅ¾e se iskljuÄiti_)

{% hint style="info" %}
Zapamtite da da biste enumerisali Azure resurse, korisnik treba da ima eksplicitno odobrenje za dozvolu.
{% endhint %}

### Podrazumevane konfigurabilne dozvole korisnika

* **ÄŒlanovi (**[**dokumenti**](https://learn.microsoft.com/en-gb/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions)**)**
* Registracija aplikacija: Podrazumevano **Da**
* OgraniÄavanje ne-administrativnih korisnika od kreiranja tenant-a: Podrazumevano **Ne**
* Kreiranje sigurnosnih grupa: Podrazumevano **Da**
* OgraniÄavanje pristupa Microsoft Entra administrativnom portalu: Podrazumevano **Ne**
* Ovo ne ograniÄava API pristup portalu (samo web)
* Dozvolite korisnicima da poveÅ¾u radni ili Å¡kolski nalog sa LinkedIn-om: Podrazumevano **Da**
* PrikaÅ¾i zadrÅ¾i korisnika prijavljenim: Podrazumevano **Da**
* OgraniÄavanje korisnika od oporavka BitLocker kljuÄeva za njihove vlasniÄke ureÄ‘aje: Podrazumevano Ne (proverite u podeÅ¡avanjima ureÄ‘aja)
* ÄŒita druge korisnike: Podrazumevano **Da** (putem Microsoft Graph)
* **Gosti**
* **OgraniÄenja pristupa gostujuÄ‡im korisnicima**
* **Gosti imaju isti pristup kao Älanovi** dodeljuje sve dozvole korisnika Älanova gostujuÄ‡im korisnicima podrazumevano.
* **Gosti imaju ograniÄen pristup svojstvima i Älanstvima objekata direktorijuma (podrazumevano)** ograniÄava pristup gostiju samo na njihov vlastiti korisniÄki profil podrazumevano. Pristup informacijama o drugim korisnicima i grupama viÅ¡e nije dozvoljen.
* **Pristup gostujuÄ‡ih korisnika je ograniÄen na svojstva i Älanstva njihovih vlastitih objekata direktorijuma** je najrestriktivniji.
* **Gosti mogu pozivati**
* **Svako u organizaciji moÅ¾e pozvati gostujuÄ‡e korisnike ukljuÄujuÄ‡i goste i ne-administratore (najinkluzivnije) - Podrazumevano**
* **Korisnici Älanovi i korisnici dodeljeni specifiÄnim administrativnim ulogama mogu pozvati gostujuÄ‡e korisnike ukljuÄujuÄ‡i goste sa Älanovskim dozvolama**
* **Samo korisnici dodeljeni specifiÄnim administrativnim ulogama mogu pozvati gostujuÄ‡e korisnike**
* **Niko u organizaciji ne moÅ¾e pozvati gostujuÄ‡e korisnike ukljuÄujuÄ‡i administratore (najrestriktivnije)**
* **Spoljni korisnici mogu napustiti**: Podrazumevano **TaÄno**
* Dozvolite spoljnim korisnicima da napuste organizaciju

{% hint style="success" %}
ÄŒak i ako su podrazumevano ograniÄeni, korisnici (Älanovi i gosti) sa dodeljenim dozvolama mogli bi izvrÅ¡iti prethodne radnje.
{% endhint %}

### **Grupe**

Postoje **2 tipa grupa**:

* **Sigurnosne**: Ova vrsta grupe se koristi za davanje Älanovima pristupa aplikacijama, resursima i dodeljivanje licenci. Korisnici, ureÄ‘aji, servisni principi i druge grupe mogu biti Älanovi.
* **Microsoft 365**: Ova vrsta grupe se koristi za saradnju, dajuÄ‡i Älanovima pristup zajedniÄkoj poÅ¡ti, kalendaru, datotekama, SharePoint sajtu, itd. ÄŒlanovi grupe mogu biti samo korisnici.
* Ovo Ä‡e imati **adresu e-poÅ¡te** sa domenom EntraID tenant-a.

Postoje **2 tipa Älanstava**:

* **Dodeljeno**: OmoguÄ‡ava ruÄno dodavanje specifiÄnih Älanova u grupu.
* **DinamiÄko Älanstvo**: Automatski upravlja Älanstvom koristeÄ‡i pravila, aÅ¾urirajuÄ‡i ukljuÄivanje grupe kada se atributi Älanova promene.

### **Servisni principi**

**Servisni princip** je **identitet** kreiran za **upotrebu** sa **aplikacijama**, hostovanim uslugama i automatizovanim alatima za pristup Azure resursima. Ovaj pristup je **ograniÄen ulogama dodeljenim** servisnom principu, dajuÄ‡i vam kontrolu nad **koji resursi mogu biti pristupljeni** i na kojem nivou. Iz bezbednosnih razloga, uvek se preporuÄuje da **koristite servisne principe sa automatizovanim alatima** umesto da im dozvolite prijavu sa korisniÄkim identitetom.

MoguÄ‡e je **direktno se prijaviti kao servisni princip** generiÅ¡uÄ‡i mu **tajnu** (lozinku), **sertifikat**, ili dodeljujuÄ‡i **federisani** pristup treÄ‡im platformama (npr. Github Actions) preko njega.

* Ako izaberete **lozinku** kao autentifikaciju (podrazumevano), **saÄuvajte generisanu lozinku** jer je neÄ‡ete moÄ‡i ponovo pristupiti.
* Ako izaberete autentifikaciju sertifikatom, uverite se da **aplikacija ima pristup privatnom kljuÄu**.

### Registracije aplikacija

**Registracija aplikacije** je konfiguracija koja omoguÄ‡ava aplikaciji da se integriÅ¡e sa Entra ID i da izvrÅ¡ava radnje.

#### KljuÄne komponente:

1. **ID aplikacije (Client ID):** Jedinstveni identifikator za vaÅ¡u aplikaciju u Azure AD.
2. **Redirect URIs:** URL-ovi na koje Azure AD Å¡alje odgovore na autentifikaciju.
3. **Sertifikati, tajne i federisani kredencijali:** MoguÄ‡e je generisati tajnu ili sertifikat za prijavu kao servisni princip aplikacije, ili dodeliti federisani pristup (npr. Github Actions).&#x20;
1. Ako je **sertifikat** ili **tajna** generisana, moguÄ‡e je da osoba **prijavi kao servisni princip** koristeÄ‡i CLI alate znajuÄ‡i **ID aplikacije**, **tajnu** ili **sertifikat** i **tenant** (domen ili ID).
4. **API dozvole:** Specifikuje koje resurse ili API-je aplikacija moÅ¾e pristupiti.
5. **PodeÅ¡avanja autentifikacije:** DefiniÅ¡e podrÅ¾ane tokove autentifikacije aplikacije (npr., OAuth2, OpenID Connect).
6. **Servisni princip**: Servisni princip se kreira kada se aplikacija kreira (ako se to uradi iz web konzole) ili kada se instalira u novom tenant-u.
1. **Servisni princip** Ä‡e dobiti sve traÅ¾ene dozvole sa kojima je konfigurisan.

### Podrazumevane dozvole pristanka

**KorisniÄki pristanak za aplikacije**

* **Ne dozvoliti korisniÄki pristanak**
* Administrator Ä‡e biti potreban za sve aplikacije.
* **Dozvoliti korisniÄki pristanak za aplikacije od verifikovanih izdavaÄa, za odabrane dozvole (PreporuÄeno)**
* Svi korisnici mogu pristati na dozvole klasifikovane kao "niskog uticaja", za aplikacije od verifikovanih izdavaÄa ili aplikacije registrovane u ovoj organizaciji.
* **Podrazumevane** dozvole niskog uticaja (iako morate prihvatiti da ih dodate kao niske):
* User.Read - prijavite se i proÄitajte korisniÄki profil
* offline\_access - odrÅ¾ava pristup podacima kojima su korisnici dali pristup
* openid - prijavite korisnike
* profile - prikaÅ¾ite osnovni profil korisnika
* email - prikaÅ¾ite adresu e-poÅ¡te korisnika
* **Dozvoliti korisniÄki pristanak za aplikacije (Podrazumevano)**
* Svi korisnici mogu pristati na bilo koju aplikaciju da pristupi podacima organizacije.

**Zahtevi za pristanak administratora**: Podrazumevano **Ne**

* Korisnici mogu zatraÅ¾iti pristanak administratora za aplikacije na koje ne mogu pristati
* Ako je **Da**: MoguÄ‡e je naznaÄiti korisnike, grupe i uloge koje mogu pristati na zahteve
* TakoÄ‘e konfiguriÅ¡ite da li Ä‡e korisnici primati obaveÅ¡tenja putem e-poÅ¡te i podsetnike o isteku&#x20;

### **Upravljani identitet (metapodaci)**

Upravljani identiteti u Azure Active Directory nude reÅ¡enje za **automatsko upravljanje identitetom** aplikacija. Ovi identiteti se koriste od strane aplikacija u svrhu **povezivanja** sa **resursima** kompatibilnim sa autentifikacijom Azure Active Directory (**Azure AD**). Ovo omoguÄ‡ava **uklanjanje potrebe za hardkodiranjem cloud kredencijala** u kodu jer Ä‡e aplikacija moÄ‡i da kontaktira **metapodatkovnu** uslugu kako bi dobila vaÅ¾eÄ‡i token za **izvrÅ¡avanje radnji** kao naznaÄeni upravljani identitet u Azure-u.

Postoje dva tipa upravljanih identiteta:

* **Sistemom dodeljeni**. Neke Azure usluge omoguÄ‡avaju da **omoguÄ‡ite upravljani identitet direktno na instanci usluge**. Kada omoguÄ‡ite sistemom dodeljeni upravljani identitet, **servisni princip** se kreira u Entra ID tenant-u kojem veruje pretplata u kojoj se resurs nalazi. Kada se **resurs** **obriÅ¡e**, Azure automatski **briÅ¡e** **identitet** za vas.
* **Korisnikom dodeljeni**. TakoÄ‘e je moguÄ‡e da korisnici generiÅ¡u upravljane identitete. Ovi se kreiraju unutar grupe resursa unutar pretplate i servisni princip Ä‡e biti kreiran u EntraID kojem veruje pretplata. Zatim, moÅ¾ete dodeliti upravljani identitet jednoj ili **viÅ¡e instanci** Azure usluge (viÅ¡e resursa). Za korisnikom dodeljene upravljane identitete, **identitet se upravlja odvojeno od resursa koji ga koriste**.

Upravljani identiteti **ne generiÅ¡u veÄne kredencijale** (kao Å¡to su lozinke ili sertifikati) za pristup kao servisni princip koji je povezan sa njima.

### PreduzeÄ‡a aplikacije

To je samo **tabela u Azure-u za filtriranje servisnih principa** i proveru aplikacija koje su dodeljene.

**To nije joÅ¡ jedan tip "aplikacije",** ne postoji nijedan objekat u Azure-u koji je "PreduzeÄ‡e aplikacija", to je samo apstrakcija za proveru servisnih principa, registracija aplikacija i upravljanih identiteta.

### Administrativne jedinice

Administrativne jedinice omoguÄ‡avaju **dodeljivanje dozvola iz uloge nad specifiÄnim delom organizacije**.

Primer:

* Scenario: Kompanija Å¾eli da regionalni IT administratori upravljaju samo korisnicima u svojoj regiji.
* Implementacija:
* Kreirajte administrativne jedinice za svaku regiju (npr., "Severna Amerika AU", "Evropa AU").
* Popunite AU-ove korisnicima iz njihovih odgovarajuÄ‡ih regija.
* AU-ovi mogu **sadrÅ¾ati korisnike, grupe ili ureÄ‘aje**
* AU-ovi podrÅ¾avaju **dinamiÄka Älanstva**
* AU-ovi **ne mogu sadrÅ¾ati AU-ove**
* Dodelite administrativne uloge:
* Dodelite ulogu "Administrator korisnika" regionalnom IT osoblju, ograniÄenu na AU njihove regije.
* Ishod: Regionalni IT administratori mogu upravljati korisniÄkim nalozima unutar svoje regije bez uticaja na druge regije.

### Entra ID uloge

* Da bi upravljali Entra ID, postoje neke **ugraÄ‘ene uloge** koje se mogu dodeliti Entra ID principima za upravljanje Entra ID
* Proverite uloge na [https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/permissions-reference](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/permissions-reference)
* Najprivilegovanija uloga je **Globalni administrator**
* U opisu uloge moguÄ‡e je videti njene **granularne dozvole**

## Uloge i dozvole

**Uloge** se **dodeljuju** **principima** na **opsegu**: `principal -[HAS ROLE]->(scope)`

**Uloge** dodeljene **grupama** se **nasleÄ‘uju** od svih **Älanova** grupe.

U zavisnosti od opsega na koji je uloga dodeljena, **uloga** se moÅ¾e **naslediti** na **druge resurse** unutar kontejnera opsega. Na primer, ako korisnik A ima **ulogu na pretplati**, on Ä‡e imati tu **ulogu na svim grupama resursa** unutar pretplate i na **svim resursima** unutar grupe resursa.

### **KlasiÄne uloge**

| **Vlasnik**                  | <ul><li>Puni pristup svim resursima</li><li>MoÅ¾e upravljati pristupom za druge korisnike</li></ul> | Svi tipovi resursa |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Doprinosilac**             | <ul><li>Puni pristup svim resursima</li><li>Ne moÅ¾e upravljati pristupom</li></ul>              | Svi tipovi resursa |
| **ÄŒitaÄ**                    | â€¢ Prikaz svih resursa                                                                     | Svi tipovi resursa |
| **Administrator pristupa korisnicima** | <ul><li>Prikaz svih resursa</li><li>MoÅ¾e upravljati pristupom za druge korisnike</li></ul>           | Svi tipovi resursa |

### UgraÄ‘ene uloge

[Iz dokumenata: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ima nekoliko Azure **ugraÄ‘enih uloga** koje moÅ¾ete **dodeliti** **korisnicima, grupama, servisnim principima i upravljanim identitetima**. Dodeljivanje uloga je naÄin na koji kontroliÅ¡ete **pristup Azure resursima**. Ako ugraÄ‘ene uloge ne zadovoljavaju specifiÄne potrebe vaÅ¡e organizacije, moÅ¾ete kreirati svoje [**Azure prilagoÄ‘ene uloge**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

**UgraÄ‘ene** uloge se primenjuju samo na **resurse** za koje su **namenjene**, na primer proverite ova 2 primera **ugraÄ‘enih uloga** nad Compute resursima:

| [Disk Backup Reader](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | OmoguÄ‡ava dozvolu za backup vault za izvrÅ¡avanje backup-a diska.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Virtual Machine User Login](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Prikaz virtuelnih maÅ¡ina u portalu i prijava kao obiÄan korisnik. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Ove uloge se **takoÄ‘e mogu dodeliti nad logiÄkim kontejnerima** (kao Å¡to su grupe za upravljanje, pretplate i grupe resursa) i principi na koje se to odnosi Ä‡e ih imati **nad resursima unutar tih kontejnera**.

* PronaÄ‘ite ovde listu sa [**svim Azure ugraÄ‘enim ulogama**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* PronaÄ‘ite ovde listu sa [**svim Entra ID ugraÄ‘enim ulogama**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### PrilagoÄ‘ene uloge

* TakoÄ‘e je moguÄ‡e kreirati [**prilagoÄ‘ene uloge**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)
* One se kreiraju unutar opsega, iako uloga moÅ¾e biti u viÅ¡e opsega (grupe za upravljanje, pretplate i grupe resursa)
* MoguÄ‡e je konfigurisati sve granularne dozvole koje Ä‡e prilagoÄ‘ena uloga imati
* MoguÄ‡e je iskljuÄiti dozvole
* Princip sa iskljuÄenom dozvolom neÄ‡e moÄ‡i da je koristi Äak i ako se dozvola dodeljuje negde drugde
* MoguÄ‡e je koristiti dÅ¾oker znakove
* KoriÅ¡Ä‡eni format je JSON
* `actions` su za kontrolu radnji nad resursom
* `dataActions` su dozvole nad podacima unutar objekta

Primer dozvola JSON za prilagoÄ‘enu ulogu:
```json
{
"properties": {
"roleName": "",
"description": "",
"assignableScopes": [
"/subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f"
],
"permissions": [
{
"actions": [
"Microsoft.DigitalTwins/register/action",
"Microsoft.DigitalTwins/unregister/action",
"Microsoft.DigitalTwins/operations/read",
"Microsoft.DigitalTwins/digitalTwinsInstances/read",
"Microsoft.DigitalTwins/digitalTwinsInstances/write",
"Microsoft.CostManagement/exports/*"
],
"notActions": [
"Astronomer.Astro/register/action",
"Astronomer.Astro/unregister/action",
"Astronomer.Astro/operations/read",
"Astronomer.Astro/organizations/read"
],
"dataActions": [],
"notDataActions": []
}
]
}
}
```
### Permissions order

* Da bi **principal imao pristup resursu**, potrebno je da mu bude dodeljena eksplicitna uloga (na bilo koji naÄin) **koja mu daje tu dozvolu**.
* Eksplicitna **dodela uloge za odbijanje ima prioritet** nad ulogom koja dodeljuje dozvolu.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption><p><a href="https://link.springer.com/chapter/10.1007/978-1-4842-7325-8_10">https://link.springer.com/chapter/10.1007/978-1-4842-7325-8_10</a></p></figcaption></figure>

### Global Administrator

Global Administrator je uloga iz Entra ID koja dodeljuje **potpunu kontrolu nad Entra ID tenant-om**. MeÄ‘utim, po defaultu ne dodeljuje nikakve dozvole nad Azure resursima.

Korisnici sa ulogom Global Administrator imaju moguÄ‡nost da '**poveÄ‡aju' na User Access Administrator Azure ulogu u Root Management Group**. Tako Global Administratori mogu upravljati pristupom u **svim Azure pretplatama i upravljaÄkim grupama.**\
Ovo poveÄ‡anje moÅ¾e se izvrÅ¡iti na kraju stranice: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/Properties)

<figure><img src="../../.gitbook/assets/image (349).png" alt=""><figcaption></figcaption></figure>

### Azure Policies

**Azure Policies** su pravila koja pomaÅ¾u organizacijama da osiguraju da njihovi resursi ispunjavaju specifiÄne standarde i zahteve usklaÄ‘enosti. OmoguÄ‡avaju vam da **sprovodite ili proveravate podeÅ¡avanja na resursima u Azure-u**. Na primer, moÅ¾ete spreÄiti kreiranje virtuelnih maÅ¡ina u neovlaÅ¡Ä‡enoj regiji ili osigurati da svi resursi imaju specifiÄne oznake za praÄ‡enje.

Azure Policies su **proaktivne**: mogu spreÄiti kreiranje ili promenu neusklaÄ‘enih resursa. TakoÄ‘e su **reaktivne**, omoguÄ‡avajuÄ‡i vam da pronaÄ‘ete i ispravite postojeÄ‡e neusklaÄ‘ene resurse.

#### **Key Concepts**

1. **Policy Definition**: Pravilo, napisano u JSON-u, koje specificira Å¡ta je dozvoljeno ili zahtevano.
2. **Policy Assignment**: Primena politike na specifiÄan opseg (npr. pretplata, grupa resursa).
3. **Initiatives**: Skup politika grupisanih zajedno za Å¡iru primenu.
4. **Effect**: Specificira Å¡ta se deÅ¡ava kada se politika aktivira (npr. "Deny," "Audit," ili "Append").

**Neki primeri:**

1. **Osiguranje usklaÄ‘enosti sa specifiÄnim Azure regijama**: Ova politika osigurava da su svi resursi rasporeÄ‘eni u specifiÄnim Azure regijama. Na primer, kompanija moÅ¾e Å¾eleti da osigura da su svi njeni podaci smeÅ¡teni u Evropi radi usklaÄ‘enosti sa GDPR-om.
2. **SprovoÄ‘enje standarda imenovanja**: Politike mogu sprovoditi konvencije imenovanja za Azure resurse. Ovo pomaÅ¾e u organizaciji i lakom identifikovanju resursa na osnovu njihovih imena, Å¡to je korisno u velikim okruÅ¾enjima.
3. **OgraniÄavanje odreÄ‘enih tipova resursa**: Ova politika moÅ¾e ograniÄiti kreiranje odreÄ‘enih tipova resursa. Na primer, politika moÅ¾e biti postavljena da spreÄi kreiranje skupih tipova resursa, kao Å¡to su odreÄ‘ene veliÄine VM-a, kako bi se kontrolisali troÅ¡kovi.
4. **SprovoÄ‘enje politika oznaÄavanja**: Oznake su parovi kljuÄ-vrednost povezani sa Azure resursima koji se koriste za upravljanje resursima. Politike mogu sprovoditi da odreÄ‘ene oznake moraju biti prisutne, ili imati specifiÄne vrednosti, za sve resurse. Ovo je korisno za praÄ‡enje troÅ¡kova, vlasniÅ¡tvo ili kategorizaciju resursa.
5. **OgraniÄavanje javnog pristupa resursima**: Politike mogu sprovoditi da odreÄ‘eni resursi, kao Å¡to su skladiÅ¡ni nalozi ili baze podataka, nemaju javne krajnje taÄke, osiguravajuÄ‡i da su dostupni samo unutar mreÅ¾e organizacije.
6. **Automatsko primenjivanje bezbednosnih podeÅ¡avanja**: Politike se mogu koristiti za automatsko primenjivanje bezbednosnih podeÅ¡avanja na resurse, kao Å¡to je primena specifiÄne grupe bezbednosti mreÅ¾e na sve VM-ove ili osiguranje da svi skladiÅ¡ni nalozi koriste enkripciju.

Napomena da se Azure Policies mogu prikaÄiti na bilo koji nivo Azure hijerarhije, ali se **najÄeÅ¡Ä‡e koriste u root management group** ili u drugim upravljaÄkim grupama.

Azure policy json example:
```json
{
"policyRule": {
"if": {
"field": "location",
"notIn": [
"eastus",
"westus"
]
},
"then": {
"effect": "Deny"
}
},
"parameters": {},
"displayName": "Allow resources only in East US and West US",
"description": "This policy ensures that resources can only be created in East US or West US.",
"mode": "All"
}
```
### NasleÄ‘ivanje dozvola

U Azure **dozvole se mogu dodeliti bilo kojem delu hijerarhije**. To ukljuÄuje upravljaÄke grupe, pretplate, grupe resursa i pojedinaÄne resurse. Dozvole se **nasleÄ‘uju** od sadrÅ¾anih **resursa** entiteta gde su dodeljene.

Ova hijerarhijska struktura omoguÄ‡ava efikasno i skalabilno upravljanje pristupnim dozvolama.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (kontrola pristupa zasnovana na ulozi) je ono Å¡to smo veÄ‡ videli u prethodnim sekcijama: **Dodeljivanje uloge subjektu kako bi mu se omoguÄ‡io pristup** resursu.\
MeÄ‘utim, u nekim sluÄajevima moÅ¾da Ä‡ete Å¾eleti da obezbedite **fino podeÅ¡eno upravljanje pristupom** ili **pojednostavite** upravljanje **stotinama** dodela uloga.

Azure **ABAC** (kontrola pristupa zasnovana na atributima) se oslanja na Azure RBAC dodavanjem **uslova dodele uloga zasnovanih na atributima** u kontekstu specifiÄnih akcija. _Uslov dodele uloge_ je **dodatna provera koju moÅ¾ete opcionalno dodati svojoj dodeli uloge** kako biste obezbedili fino podeÅ¡eno upravljanje pristupom. Uslov filtrira dozvole dodeljene kao deo definicije uloge i dodele uloge. Na primer, moÅ¾ete **dodati uslov koji zahteva da objekat ima specifiÄnu oznaku da bi se proÄitao objekat**.\
Ne moÅ¾ete eksplicitno **odbiti** **pristup** specifiÄnim resursima **koriÅ¡Ä‡enjem uslova**.

### Upravljanje privilegovanim identitetetima (PIM)

Upravljanje privilegovanim identitetetima (PIM) u Azure je alat koji **upravlja, kontroliÅ¡e i prati privilegovani pristup** u Azure Active Directory i Azure. PoveÄ‡ava bezbednost pruÅ¾anjem **privilegovani pristup na zahtev i vremenski ograniÄen**, **sprovodeÄ‡i odobrenja radnih tokova i zahtevajuÄ‡i dodatnu autentifikaciju**. Ovaj pristup minimizira rizik od neovlaÅ¡Ä‡enog pristupa osiguravajuÄ‡i da se poviÅ¡ene dozvole dodeljuju samo kada je to neophodno i na odreÄ‘eni vremenski period.

## Autentifikacioni tokeni

Postoje **tri tipa tokena** koji se koriste u OIDC:

* [**Pristupni tokeni**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Klijent predstavlja ovaj token serveru resursa da bi **pristupio resursima**. MoÅ¾e se koristiti samo za specifiÄnu kombinaciju korisnika, klijenta i resursa i **ne moÅ¾e biti opozvan** do isteka - Å¡to je 1 sat po defaultu.
* **ID tokeni**: Klijent prima ovaj **token od autorizacionog servera**. SadrÅ¾i osnovne informacije o korisniku. **Povezan je sa specifiÄnom kombinacijom korisnika i klijenta**.
* **Refresh tokeni**: Dodeljuju se klijentu zajedno sa pristupnim tokenom. Koriste se za **dobijanje novih pristupnih i ID tokena**. Povezani su sa specifiÄnom kombinacijom korisnika i klijenta i mogu biti opozvani. Podrazumevani rok vaÅ¾enja je **90 dana** za neaktivne refresh tokene i **nema isteka za aktivne tokene**.

{% hint style="warning" %}
Informacije za **uslovni pristup** su **smeÅ¡tene** unutar **JWT**. Dakle, ako zatraÅ¾ite **token sa dozvoljene IP adrese**, ta **IP** Ä‡e biti **smeÅ¡tena** u tokenu i tada moÅ¾ete koristiti taj token sa **nedozvoljene IP adrese za pristup resursima**.
{% endhint %}

### Pristupni tokeni "aud"

U zavisnosti od akcije koju Å¾elite da izvrÅ¡ite, "**aud**" pristupnog tokena mora biti ovlaÅ¡Ä‡en da kontaktira API URL koji Ä‡ete kontaktirati.

Komanda `az account get-access-token --resource-type [...]` podrÅ¾ava sledeÄ‡e tipove i svaki od njih Ä‡e dodati specifiÄan "aud" u rezultantnom pristupnom tokenu:

{% hint style="danger" %}
Napomena da su sledeÄ‡i samo API-ji podrÅ¾ani od strane `az account get-access-token`, ali ih ima viÅ¡e.
{% endhint %}

* **aad-graph (Azure Active Directory Graph API)**: Koristi se za pristup starom Azure AD Graph API (ukinut), koji omoguÄ‡ava aplikacijama da Äitaju i piÅ¡u podatke direktorijuma u Azure Active Directory (Azure AD).
* `https://graph.windows.net/`
* **arm (Azure Resource Manager)**: Koristi se za upravljanje Azure resursima putem Azure Resource Manager API. Ovo ukljuÄuje operacije kao Å¡to su kreiranje, aÅ¾uriranje i brisanje resursa kao Å¡to su virtuelne maÅ¡ine, skladiÅ¡ni nalozi i joÅ¡ mnogo toga.
* `https://management.core.windows.net/ or https://management.azure.com/`
* **batch (Azure Batch Services)**: Koristi se za pristup Azure Batch, usluzi koja omoguÄ‡ava efikasne aplikacije za paralelno i visokoperformantno raÄunanje na velikim razmerama u oblaku.
* `https://batch.core.windows.net/`
* **data-lake (Azure Data Lake Storage)**: Koristi se za interakciju sa Azure Data Lake Storage Gen1, Å¡to je skalabilna usluga za skladiÅ¡tenje podataka i analitiku.
* `https://datalake.azure.net/`
* **media (Azure Media Services)**: Koristi se za pristup Azure Media Services, koje pruÅ¾aju usluge obrade i isporuke medija zasnovane na oblaku za video i audio sadrÅ¾aj.
* `https://rest.media.azure.net`
* **ms-graph (Microsoft Graph API)**: Koristi se za pristup Microsoft Graph API, jedinstvenom kraju za podatke usluga Microsoft 365. OmoguÄ‡ava vam pristup podacima i uvidima iz usluga kao Å¡to su Azure AD, Office 365, Enterprise Mobility i Security usluge.
* `https://graph.microsoft.com`
* **oss-rdbms (Azure Open Source Relational Databases)**: Koristi se za pristup Azure Database uslugama za open-source relacione baze podataka kao Å¡to su MySQL, PostgreSQL i MariaDB.
* `https://ossrdbms-aad.database.windows.net`

Proverite sledeÄ‡u stranicu da biste saznali razliÄite naÄine za **zahtev za pristupnim tokenima** i prijavu sa njima:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

## Reference

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)
* [https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration](https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
