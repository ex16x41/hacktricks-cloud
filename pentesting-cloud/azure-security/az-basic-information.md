# Az - Podstawowe informacje

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}

## Hierarchia organizacji

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUchBvhjIdWWR2ldAkWiZMdmrcEYD9Ti5UAa3zAGr9YbAnx4Q_gZNp_zvOU429vgWZ_ixoYHQKdC8bGgkhWYCy591SRIFj6RKCj4BEpVQixAGsp3T3O5sS3k7x5CTaJ-SCBNC7i5KluLyxdiXoZsH1F0ko1Gv88=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption></figcaption></figure>

### Grupy zarzÄ…dzajÄ…ce

* MoÅ¼e zawieraÄ‡ **inne grupy zarzÄ…dzajÄ…ce lub subskrypcje**.
* UmoÅ¼liwia to **stosowanie kontroli zarzÄ…dzajÄ…cych** takich jak RBAC i Azure Policy raz na poziomie grupy zarzÄ…dzajÄ…cej, a nastÄ™pnie **dziedziczenie** ich przez wszystkie subskrypcje w grupie.
* **10 000 grup** zarzÄ…dzajÄ…cych moÅ¼e byÄ‡ obsÅ‚ugiwanych w jednym katalogu.
* Drzewo grup zarzÄ…dzajÄ…cych moÅ¼e obsÅ‚ugiwaÄ‡ **do szeÅ›ciu poziomÃ³w gÅ‚Ä™bokoÅ›ci**. Ten limit nie obejmuje poziomu gÅ‚Ã³wnego ani poziomu subskrypcji.
* KaÅ¼da grupa zarzÄ…dzajÄ…ca i subskrypcja mogÄ… mieÄ‡ **tylko jednego rodzica**.
* Nawet jeÅ›li moÅ¼na utworzyÄ‡ kilka grup zarzÄ…dzajÄ…cych, **istnieje tylko 1 gÅ‚Ã³wna grupa zarzÄ…dzajÄ…ca**.
* GÅ‚Ã³wna grupa zarzÄ…dzajÄ…ca **zawiera** wszystkie **inne grupy zarzÄ…dzajÄ…ce i subskrypcje** i **nie moÅ¼e byÄ‡ przenoszona ani usuwana**.
* Wszystkie subskrypcje w ramach jednej grupy zarzÄ…dzajÄ…cej muszÄ… ufaÄ‡ **temu samemu najemcy Entra ID.**

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption><p><a href="https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png">https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png</a></p></figcaption></figure>

### Subskrypcje Azure

* To kolejny **logiczny kontener, w ktÃ³rym mogÄ… byÄ‡ uruchamiane zasoby** (VM, DBâ€¦) i za ktÃ³ry bÄ™dÄ… naliczane opÅ‚aty.
* Jego **rodzicem** jest zawsze **grupa zarzÄ…dzajÄ…ca** (moÅ¼e to byÄ‡ gÅ‚Ã³wna grupa zarzÄ…dzajÄ…ca), poniewaÅ¼ subskrypcje nie mogÄ… zawieraÄ‡ innych subskrypcji.
* **Ufa tylko jednemu katalogowi Entra ID**
* **Uprawnienia** stosowane na poziomie subskrypcji (lub dowolnego z jej rodzicÃ³w) sÄ… **dziedziczone** przez wszystkie zasoby wewnÄ…trz subskrypcji

### Grupy zasobÃ³w

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Grupa zasobÃ³w to **kontener**, ktÃ³ry przechowuje **powiÄ…zane zasoby** dla rozwiÄ…zania Azure. Grupa zasobÃ³w moÅ¼e zawieraÄ‡ wszystkie zasoby dla rozwiÄ…zania lub tylko te **zasoby, ktÃ³re chcesz zarzÄ…dzaÄ‡ jako grupÄ™**. Zazwyczaj dodawaj **zasoby**, ktÃ³re majÄ… **ten sam cykl Å¼ycia** do tej samej grupy zasobÃ³w, aby Å‚atwo je wdraÅ¼aÄ‡, aktualizowaÄ‡ i usuwaÄ‡ jako grupÄ™.

Wszystkie **zasoby** muszÄ… byÄ‡ **w obrÄ™bie grupy zasobÃ³w** i mogÄ… naleÅ¼eÄ‡ tylko do jednej grupy, a jeÅ›li grupa zasobÃ³w zostanie usuniÄ™ta, wszystkie zasoby w niej rÃ³wnieÅ¼ zostanÄ… usuniÄ™te.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfe8U30iP_vdZCvxX4g8nEPRLoo7v0kmCGkDn1frBPn3_GIoZ7VT2LkdsVQWCnrG_HSYNRRPM-1pSECUkbDAB-9YbUYLzpvKVLDETZS81CHWKYM4fDl3oMo5-yvTMnjdLTS2pz8U67xUTIzBhZ25MFMRkq5koKY=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption><p><a href="https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1">https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1</a></p></figcaption></figure>

### Identyfikatory zasobÃ³w Azure

KaÅ¼dy zasÃ³b w Azure ma identyfikator zasobu Azure, ktÃ³ry go identyfikuje.

Format identyfikatora zasobu Azure jest nastÄ™pujÄ…cy:

* `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderNamespace}/{resourceType}/{resourceName}`

Dla maszyny wirtualnej o nazwie myVM w grupie zasobÃ³w `myResourceGroup` pod subskrypcjÄ… ID `12345678-1234-1234-1234-123456789012`, identyfikator zasobu Azure wyglÄ…da nastÄ™pujÄ…co:

* `/subscriptions/12345678-1234-1234-1234-123456789012/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM`

## Azure vs Entra ID vs UsÅ‚ugi domenowe Azure AD

### Azure

Azure to kompleksowa **platforma chmurowa Microsoftu, oferujÄ…ca szeroki zakres usÅ‚ug**, w tym maszyny wirtualne, bazy danych, sztucznÄ… inteligencjÄ™ i przechowywanie. DziaÅ‚a jako fundament do hostowania i zarzÄ…dzania aplikacjami, budowania skalowalnych infrastruktur oraz uruchamiania nowoczesnych obciÄ…Å¼eÅ„ w chmurze. Azure zapewnia narzÄ™dzia dla programistÃ³w i specjalistÃ³w IT do tworzenia, wdraÅ¼ania i zarzÄ…dzania aplikacjami i usÅ‚ugami w sposÃ³b bezproblemowy, dostosowujÄ…c siÄ™ do rÃ³Å¼nych potrzeb, od startupÃ³w po duÅ¼e przedsiÄ™biorstwa.

### Entra ID (dawniej Azure Active Directory)

Entra ID to chmurowa **usÅ‚uga zarzÄ…dzania toÅ¼samoÅ›ciÄ… i dostÄ™pem**, zaprojektowana do obsÅ‚ugi uwierzytelniania, autoryzacji i kontroli dostÄ™pu uÅ¼ytkownikÃ³w. UmoÅ¼liwia bezpieczny dostÄ™p do usÅ‚ug Microsoft, takich jak Office 365, Azure i wiele aplikacji SaaS innych firm. Oferuje funkcje takie jak jednolity dostÄ™p (SSO), uwierzytelnianie wieloskÅ‚adnikowe (MFA) i polityki dostÄ™pu warunkowego, miÄ™dzy innymi.

### UsÅ‚ugi domenowe Entra (dawniej Azure AD DS)

UsÅ‚ugi domenowe Entra rozszerzajÄ… moÅ¼liwoÅ›ci Entra ID, oferujÄ…c **zarzÄ…dzane usÅ‚ugi domenowe zgodne z tradycyjnymi Å›rodowiskami Windows Active Directory**. ObsÅ‚ugujÄ… starsze protokoÅ‚y, takie jak LDAP, Kerberos i NTLM, umoÅ¼liwiajÄ…c organizacjom migracjÄ™ lub uruchamianie starszych aplikacji w chmurze bez wdraÅ¼ania lokalnych kontrolerÃ³w domeny. UsÅ‚uga ta obsÅ‚uguje rÃ³wnieÅ¼ polityki grupowe do centralnego zarzÄ…dzania, co czyni jÄ… odpowiedniÄ… dla scenariuszy, w ktÃ³rych obciÄ…Å¼enia oparte na AD muszÄ… wspÃ³Å‚istnieÄ‡ z nowoczesnymi Å›rodowiskami chmurowymi.

## Zasady Entra ID

### UÅ¼ytkownicy

* **Nowi uÅ¼ytkownicy**
* WskaÅºnik nazwy e-mail i domeny z wybranego najemcy
* WskaÅºnik nazwy wyÅ›wietlanej
* WskaÅºnik hasÅ‚a
* WskaÅºnik wÅ‚aÅ›ciwoÅ›ci (imiÄ™, tytuÅ‚ zawodowy, dane kontaktoweâ€¦)
* DomyÅ›lny typ uÅ¼ytkownika to â€œ**czÅ‚onek**â€
* **UÅ¼ytkownicy zewnÄ™trzni**
* WskaÅºnik e-mail do zaproszenia i nazwy wyÅ›wietlanej (moÅ¼e byÄ‡ to e-mail nie-Microsoft)
* WskaÅºnik wÅ‚aÅ›ciwoÅ›ci
* DomyÅ›lny typ uÅ¼ytkownika to â€œ**GoÅ›Ä‡**â€

### DomyÅ›lne uprawnienia uÅ¼ytkownikÃ³w

* **CzÅ‚onkowie (**[**dokumentacja**](https://learn.microsoft.com/en-gb/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions)**)**
* Rejestracja aplikacji: DomyÅ›lnie **Tak**
* Ograniczenie uÅ¼ytkownikÃ³w niebÄ™dÄ…cych administratorami w tworzeniu najemcÃ³w: DomyÅ›lnie **Nie**
* Tworzenie grup zabezpieczeÅ„: DomyÅ›lnie **Tak**
* Ograniczenie dostÄ™pu do portalu administracyjnego Microsoft Entra: DomyÅ›lnie **Nie**
* To nie ogranicza dostÄ™pu API do portalu (tylko web)
* Zezwolenie uÅ¼ytkownikom na poÅ‚Ä…czenie konta roboczego lub szkolnego z LinkedIn: DomyÅ›lnie **Tak**
* PokaÅ¼, aby uÅ¼ytkownik pozostaÅ‚ zalogowany: DomyÅ›lnie **Tak**
* Ograniczenie uÅ¼ytkownikÃ³w w odzyskiwaniu klucza BitLocker dla ich posiadanych urzÄ…dzeÅ„: DomyÅ›lnie Nie (sprawdÅº w Ustawieniach urzÄ…dzenia)
* Odczyt innych uÅ¼ytkownikÃ³w: DomyÅ›lnie **Tak** (za poÅ›rednictwem Microsoft Graph)
* **GoÅ›cie**
* **Ograniczenia dostÄ™pu uÅ¼ytkownikÃ³w goÅ›ci**
* **UÅ¼ytkownicy goÅ›cie majÄ… takie same uprawnienia jak czÅ‚onkowie** przyznaje domyÅ›lnie wszystkie uprawnienia uÅ¼ytkownikÃ³w czÅ‚onkÃ³w uÅ¼ytkownikom goÅ›ci.
* **UÅ¼ytkownicy goÅ›cie majÄ… ograniczony dostÄ™p do wÅ‚aÅ›ciwoÅ›ci i czÅ‚onkostw obiektÃ³w katalogowych (domyÅ›lnie)** ogranicza dostÄ™p goÅ›ci tylko do ich wÅ‚asnego profilu uÅ¼ytkownika. DostÄ™p do informacji o innych uÅ¼ytkownikach i grupach nie jest juÅ¼ dozwolony.
* **DostÄ™p uÅ¼ytkownikÃ³w goÅ›ci jest ograniczony do wÅ‚aÅ›ciwoÅ›ci i czÅ‚onkostw ich wÅ‚asnych obiektÃ³w katalogowych** jest najbardziej restrykcyjny.
* **GoÅ›cie mogÄ… zapraszaÄ‡**
* **KaÅ¼dy w organizacji moÅ¼e zapraszaÄ‡ uÅ¼ytkownikÃ³w goÅ›ci, w tym goÅ›ci i nie-administratorÃ³w (najbardziej inkluzywne) - DomyÅ›lnie**
* **UÅ¼ytkownicy czÅ‚onkowie i uÅ¼ytkownicy przypisani do okreÅ›lonych rÃ³l administratorÃ³w mogÄ… zapraszaÄ‡ uÅ¼ytkownikÃ³w goÅ›ci, w tym goÅ›ci z uprawnieniami czÅ‚onkowskimi**
* **Tylko uÅ¼ytkownicy przypisani do okreÅ›lonych rÃ³l administratorÃ³w mogÄ… zapraszaÄ‡ uÅ¼ytkownikÃ³w goÅ›ci**
* **Nikt w organizacji nie moÅ¼e zapraszaÄ‡ uÅ¼ytkownikÃ³w goÅ›ci, w tym administratorÃ³w (najbardziej restrykcyjne)**
* **UÅ¼ytkownicy zewnÄ™trzni mogÄ… odejÅ›Ä‡**: DomyÅ›lnie **Prawda**
* Zezwolenie uÅ¼ytkownikom zewnÄ™trznym na odejÅ›cie z organizacji

{% hint style="success" %}
Nawet jeÅ›li domyÅ›lnie ograniczeni, uÅ¼ytkownicy (czÅ‚onkowie i goÅ›cie) z przyznanymi uprawnieniami mogÄ… wykonywaÄ‡ powyÅ¼sze dziaÅ‚ania.
{% endhint %}

### **Podmioty usÅ‚ugowe**

**Podmiot usÅ‚ugi** to **toÅ¼samoÅ›Ä‡** stworzona do **uÅ¼ytku** z **aplikacjami**, hostowanymi usÅ‚ugami i zautomatyzowanymi narzÄ™dziami do uzyskiwania dostÄ™pu do zasobÃ³w Azure. Ten dostÄ™p jest **ograniczony przez przypisane role**, co daje ci kontrolÄ™ nad **ktÃ³re zasoby mogÄ… byÄ‡ dostÄ™pne** i na jakim poziomie. Z powodÃ³w bezpieczeÅ„stwa zawsze zaleca siÄ™ **uÅ¼ywanie podmiotÃ³w usÅ‚ugowych z narzÄ™dziami zautomatyzowanymi** zamiast pozwalaÄ‡ im logowaÄ‡ siÄ™ za pomocÄ… toÅ¼samoÅ›ci uÅ¼ytkownika.

MoÅ¼liwe jest **bezpoÅ›rednie logowanie jako podmiot usÅ‚ugi** poprzez wygenerowanie mu **sekretu** (hasÅ‚a), **certyfikatu** lub przyznanie **federowanego** dostÄ™pu do platform trzecich (np. Github Actions).

* JeÅ›li wybierzesz uwierzytelnianie **hasÅ‚em** (domyÅ›lnie), **zapisz wygenerowane hasÅ‚o**, poniewaÅ¼ nie bÄ™dziesz mÃ³gÅ‚ uzyskaÄ‡ do niego ponownie dostÄ™pu.
* JeÅ›li wybierzesz uwierzytelnianie certyfikatem, upewnij siÄ™, Å¼e **aplikacja bÄ™dzie miaÅ‚a dostÄ™p do klucza prywatnego**.

### Rejestracje aplikacji

**Rejestracja aplikacji** to konfiguracja, ktÃ³ra pozwala aplikacji integrowaÄ‡ siÄ™ z Entra ID i wykonywaÄ‡ dziaÅ‚ania.

#### Kluczowe komponenty:

1. **Identyfikator aplikacji (Client ID):** Unikalny identyfikator twojej aplikacji w Azure AD.
2. **URI przekierowania:** URL-e, do ktÃ³rych Azure AD wysyÅ‚a odpowiedzi uwierzytelniajÄ…ce.
3. **Certyfikaty, sekrety i federowane poÅ›wiadczenia:** MoÅ¼liwe jest wygenerowanie sekretu lub certyfikatu, aby zalogowaÄ‡ siÄ™ jako podmiot usÅ‚ugi aplikacji lub przyznaÄ‡ jej dostÄ™p federowany (np. Github Actions).&#x20;
1. JeÅ›li **certyfikat** lub **sekret** zostanie wygenerowany, moÅ¼liwe jest, aby osoba **zalogowaÅ‚a siÄ™ jako podmiot usÅ‚ugi** za pomocÄ… narzÄ™dzi CLI, znajÄ…c **identyfikator aplikacji**, **sekret** lub **certyfikat** oraz **najemcÄ™** (domenÄ™ lub ID).
4. **Uprawnienia API:** OkreÅ›la, do jakich zasobÃ³w lub API aplikacja ma dostÄ™p.
5. **Ustawienia uwierzytelniania:** Definiuje obsÅ‚ugiwane przez aplikacjÄ™ przepÅ‚ywy uwierzytelniania (np. OAuth2, OpenID Connect).
6. **Podmiot usÅ‚ugi**: Podmiot usÅ‚ugi jest tworzony, gdy aplikacja jest tworzona (jeÅ›li jest to robione z konsoli internetowej) lub gdy jest instalowana w nowym najemcy.
1. **Podmiot usÅ‚ugi** otrzyma wszystkie Å¼Ä…dane uprawnienia, z ktÃ³rymi zostaÅ‚ skonfigurowany.

### Aplikacje korporacyjne

To tylko **tabela w Azure do filtrowania podmiotÃ³w usÅ‚ugowych** i sprawdzania aplikacji, ktÃ³re zostaÅ‚y przypisane.

**Nie jest to inny typ "aplikacji",** nie ma Å¼adnego obiektu w Azure, ktÃ³ry jest "AplikacjÄ… korporacyjnÄ…", to tylko abstrakcja do sprawdzania podmiotÃ³w usÅ‚ugowych, rejestracji aplikacji i zarzÄ…dzanych toÅ¼samoÅ›ci.

### **ZarzÄ…dzana toÅ¼samoÅ›Ä‡ (Metadane)**

ZarzÄ…dzane toÅ¼samoÅ›ci w Azure Active Directory oferujÄ… rozwiÄ…zanie do **automatycznego zarzÄ…dzania toÅ¼samoÅ›ciÄ…** aplikacji. Te toÅ¼samoÅ›ci sÄ… uÅ¼ywane przez aplikacje w celu **Å‚Ä…czenia siÄ™** z **zasobami** zgodnymi z uwierzytelnianiem Azure Active Directory (**Azure AD**). UmoÅ¼liwia to **usuniÄ™cie potrzeby twardego kodowania poÅ›wiadczeÅ„ chmurowych** w kodzie, poniewaÅ¼ aplikacja bÄ™dzie mogÅ‚a skontaktowaÄ‡ siÄ™ z **usÅ‚ugÄ… metadanych**, aby uzyskaÄ‡ waÅ¼ny token do **wykonywania dziaÅ‚aÅ„** jako wskazana zarzÄ…dzana toÅ¼samoÅ›Ä‡ w Azure.

IstniejÄ… dwa typy zarzÄ…dzanych toÅ¼samoÅ›ci:

* **Przypisana systemowo**. NiektÃ³re usÅ‚ugi Azure pozwalajÄ… na **wÅ‚Ä…czenie zarzÄ…dzanej toÅ¼samoÅ›ci bezpoÅ›rednio na instancji usÅ‚ugi**. Gdy wÅ‚Ä…czysz zarzÄ…dzanÄ… toÅ¼samoÅ›Ä‡ przypisanÄ… systemowo, **podmiot usÅ‚ugi** jest tworzony w najemcy Entra ID zaufanym przez subskrypcjÄ™, w ktÃ³rej znajduje siÄ™ zasÃ³b. Gdy **zasÃ³b** jest **usuwany**, Azure automatycznie **usuwa** **toÅ¼samoÅ›Ä‡** za ciebie.
* **Przypisana przez uÅ¼ytkownika**. UÅ¼ytkownicy mogÄ… rÃ³wnieÅ¼ generowaÄ‡ zarzÄ…dzane toÅ¼samoÅ›ci. SÄ… one tworzone wewnÄ…trz grupy zasobÃ³w w ramach subskrypcji, a podmiot usÅ‚ugi zostanie utworzony w Entra ID zaufanym przez subskrypcjÄ™. NastÄ™pnie moÅ¼esz przypisaÄ‡ zarzÄ…dzanÄ… toÅ¼samoÅ›Ä‡ do jednej lub **wiÄ™cej instancji** usÅ‚ugi Azure (wiele zasobÃ³w). W przypadku zarzÄ…dzanych toÅ¼samoÅ›ci przypisanych przez uÅ¼ytkownika, **toÅ¼samoÅ›Ä‡ jest zarzÄ…dzana oddzielnie od zasobÃ³w, ktÃ³re jej uÅ¼ywajÄ…**.

ZarzÄ…dzane toÅ¼samoÅ›ci **nie generujÄ… wiecznych poÅ›wiadczeÅ„** (jak hasÅ‚a czy certyfikaty) do uzyskania dostÄ™pu jako podmiot usÅ‚ugi do niej przypisany.

### DomyÅ›lne uprawnienia zgody

**Zgoda uÅ¼ytkownika na aplikacje**

* **Nie zezwalaj na zgodÄ™ uÅ¼ytkownika**
* Administrator bÄ™dzie wymagany dla wszystkich aplikacji.
* **ZezwÃ³l na zgodÄ™ uÅ¼ytkownika na aplikacje od zweryfikowanych wydawcÃ³w, dla wybranych uprawnieÅ„ (Zalecane)**
* Wszyscy uÅ¼ytkownicy mogÄ… wyraÅ¼aÄ‡ zgodÄ™ na uprawnienia klasyfikowane jako "niski wpÅ‚yw", dla aplikacji od zweryfikowanych wydawcÃ³w lub aplikacji zarejestrowanych w tej organizacji.
* **DomyÅ›lne** uprawnienia o niskim wpÅ‚ywie (chociaÅ¼ musisz zaakceptowaÄ‡, aby dodaÄ‡ je jako niskie):
* User.Read - zaloguj siÄ™ i odczytaj profil uÅ¼ytkownika
* offline\_access - utrzymuj dostÄ™p do danych, do ktÃ³rych uÅ¼ytkownicy dali mu dostÄ™p
* openid - loguj uÅ¼ytkownikÃ³w
* profile - wyÅ›wietl podstawowy profil uÅ¼ytkownika
* email - wyÅ›wietl adres e-mail uÅ¼ytkownika
* **ZezwÃ³l na zgodÄ™ uÅ¼ytkownika na aplikacje (DomyÅ›lnie)**
* Wszyscy uÅ¼ytkownicy mogÄ… wyraÅ¼aÄ‡ zgodÄ™ na dowolnÄ… aplikacjÄ™, aby uzyskaÄ‡ dostÄ™p do danych organizacji.

**ProÅ›by o zgodÄ™ administratora**: DomyÅ›lnie **Nie**

* UÅ¼ytkownicy mogÄ… prosiÄ‡ o zgodÄ™ administratora na aplikacje, do ktÃ³rych nie mogÄ… wyraziÄ‡ zgody
* JeÅ›li **Tak**: MoÅ¼liwe jest wskazanie UÅ¼ytkownikÃ³w, Grup i RÃ³l, ktÃ³re mogÄ… wyraÅ¼aÄ‡ zgodÄ™ na proÅ›by
* Skonfiguruj rÃ³wnieÅ¼, czy uÅ¼ytkownicy otrzymajÄ… powiadomienia e-mail i przypomnienia o wygaÅ›niÄ™ciu&#x20;

### Jednostki administracyjne

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Jednostki administracyjne pozwalajÄ… na **podziaÅ‚** organizacji na **dowolne jednostki**, ktÃ³re chcesz, a nastÄ™pnie **przypisanie konkretnych administratorÃ³w**, ktÃ³rzy mogÄ… **zarzÄ…dzaÄ‡ tylko czÅ‚onkami** tej jednostki. Na przykÅ‚ad, moÅ¼esz uÅ¼yÄ‡ jednostek administracyjnych do delegowania uprawnieÅ„ administratorom kaÅ¼dej szkoÅ‚y na duÅ¼ym uniwersytecie, aby mogli kontrolowaÄ‡ dostÄ™p, zarzÄ…dzaÄ‡ uÅ¼ytkownikami i ustalaÄ‡ polityki tylko w Szkole InÅ¼ynierii.

Tylko **uÅ¼ytkownicy**, **grupy** i **urzÄ…dzenia** mogÄ… byÄ‡ **czÅ‚onkami** **jednostki administracyjnej**.

Dlatego **jednostka administracyjna** bÄ™dzie **zawieraÄ‡** niektÃ³rych **czÅ‚onkÃ³w**, a inne **podmioty** bÄ™dÄ… **przypisane uprawnienia do tej** jednostki administracyjnej, ktÃ³re mogÄ… wykorzystaÄ‡ do **zarzÄ…dzania czÅ‚onkami** jednostki administracyjnej.

## Role i uprawnienia

**Role** sÄ… **przypisywane** do **podmiotÃ³w** w ramach **zakresu**: `podmiot -[MA ROLÄ˜]->(zakres)`

**Role** przypisane do **grup** sÄ… **dziedziczone** przez wszystkich **czÅ‚onkÃ³w** grupy.

W zaleÅ¼noÅ›ci od zakresu, do ktÃ³rego przypisano rolÄ™, **rola** moÅ¼e byÄ‡ **dziedziczona** przez **inne zasoby** wewnÄ…trz kontenera zakresu. Na przykÅ‚ad, jeÅ›li uÅ¼ytkownik A ma **rolÄ™ w subskrypcji**, bÄ™dzie miaÅ‚ tÄ™ **rolÄ™ we wszystkich grupach zasobÃ³w** w ramach subskrypcji i na **wszystkich zasobach** wewnÄ…trz grupy zasobÃ³w.

### **Klasyczne role**

| **WÅ‚aÅ›ciciel**                     | <ul><li>PeÅ‚ny dostÄ™p do wszystkich zasobÃ³w</li><li>MoÅ¼e zarzÄ…dzaÄ‡ dostÄ™pem dla innych uÅ¼ytkownikÃ³w</li></ul> | Wszystkie typy zasobÃ³w |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **WspÃ³Å‚twÃ³rca**               | <ul><li>PeÅ‚ny dostÄ™p do wszystkich zasobÃ³w</li><li>Nie moÅ¼e zarzÄ…dzaÄ‡ dostÄ™pem</li></ul>              | Wszystkie typy zasobÃ³w |
| **Czytelnik**                    | â€¢ WyÅ›wietl wszystkie zasoby                                                                     | Wszystkie typy zasobÃ³w |
| **Administrator dostÄ™pu uÅ¼ytkownikÃ³w** | <ul><li>WyÅ›wietl wszystkie zasoby</li><li>MoÅ¼e zarzÄ…dzaÄ‡ dostÄ™pem dla innych uÅ¼ytkownikÃ³w</li></ul>           | Wszystkie typy zasobÃ³w |

### Wbudowane role

[Z dokumentacji: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ma kilka **wbudowanych rÃ³l Azure**, ktÃ³re moÅ¼esz **przypisaÄ‡** do **uÅ¼ytkownikÃ³w, grup, podmiotÃ³w usÅ‚ugowych i zarzÄ…dzanych toÅ¼samoÅ›ci**. Przypisania rÃ³l to sposÃ³b, w jaki kontrolujesz **dostÄ™p do zasobÃ³w Azure**. JeÅ›li wbudowane role nie speÅ‚niajÄ… specyficznych potrzeb twojej organizacji, moÅ¼esz stworzyÄ‡ wÅ‚asne [**niestandardowe role Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

**Wbudowane** role majÄ… zastosowanie tylko do **zasobÃ³w**, do ktÃ³rych sÄ… **przeznaczone**, na przykÅ‚ad sprawdÅº te 2 przykÅ‚ady **wbudowanych rÃ³l dla zasobÃ³w obliczeniowych**:

| [Czytelnik kopii zapasowej dysku](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | UmoÅ¼liwia uprawnienie do kopii zapasowej, aby wykonaÄ‡ kopiÄ™ zapasowÄ… dysku.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [UÅ¼ytkownik logowania do maszyny wirtualnej](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | WyÅ›wietl maszyny wirtualne w portalu i zaloguj siÄ™ jako zwykÅ‚y uÅ¼ytkownik. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Te role mogÄ… **byÄ‡ rÃ³wnieÅ¼ przypisane do kontenerÃ³w logicznych** (takich jak grupy zarzÄ…dzajÄ…ce, subskrypcje i grupy zasobÃ³w), a podmioty, ktÃ³re sÄ… nimi objÄ™te, bÄ™dÄ… miaÅ‚y je **w odniesieniu do zasobÃ³w wewnÄ…trz tych kontenerÃ³w**.

* ZnajdÅº tutaj listÄ™ z [**wszystkimi wbudowanymi rolami Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* ZnajdÅº tutaj listÄ™ z [**wszystkimi wbudowanymi rolami Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Niestandardowe role

Azure pozwala rÃ³wnieÅ¼ na tworzenie [**niestandardowych rÃ³l**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) z uprawnieniami, ktÃ³rych potrzebuje uÅ¼ytkownik.

### Odrzucone uprawnienia

* Aby **podmiot miaÅ‚ dostÄ™p do zasobu**, musi mu zostaÄ‡ przyznana wyraÅºna rola (w jakikolwiek sposÃ³b) **przyznajÄ…ca mu to uprawnienie**.
* WyraÅºne **przypisanie roli odrzucajÄ…cej ma pierwszeÅ„stwo** przed rolÄ… przyznajÄ…cÄ… uprawnienie.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Globalny administrator

UÅ¼ytkownicy z rolÄ… Globalnego Administratora majÄ… moÅ¼liwoÅ›Ä‡ '**podniesienia' roli Administratora dostÄ™pu uÅ¼ytkownikÃ³w do gÅ‚Ã³wnej grupy zarzÄ…dzajÄ…cej**. Oznacza to, Å¼e Globalny Administrator bÄ™dzie mÃ³gÅ‚ zarzÄ…dzaÄ‡ dostÄ™pem **do wszystkich subskrypcji Azure i grup zarzÄ…dzajÄ…cych.**\
To podniesienie moÅ¼na wykonaÄ‡ na koÅ„cu strony: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Polityki Azure

Polityki Azure to zestaw **reguÅ‚ i regulacji w Microsoft Azure**, usÅ‚udze chmurowej, ktÃ³re pomagajÄ… zarzÄ…dzaÄ‡ i egzekwowaÄ‡ standardy organizacyjne oraz oceniaÄ‡ zgodnoÅ›Ä‡ na duÅ¼Ä… skalÄ™. Te polityki egzekwujÄ… rÃ³Å¼ne zasady dotyczÄ…ce twoich **zasobÃ³w Azure**, zapewniajÄ…c, Å¼e te zasoby pozostajÄ… zgodne z normami korporacyjnymi i umowami o poziomie usÅ‚ug.

Polityki Azure sÄ… kluczowe dla zarzÄ…dzania chmurÄ… i bezpieczeÅ„stwa, pomagajÄ…c zapewniÄ‡, Å¼e zasoby sÄ… uÅ¼ywane prawidÅ‚owo i efektywnie oraz Å¼e sÄ… zgodne z regulacjami zewnÄ™trznymi i wewnÄ™trznymi politykami.\
Oto kilka przykÅ‚adÃ³w:

1. **Zapewnienie zgodnoÅ›ci z okreÅ›lonymi regionami Azure**: Ta polityka zapewnia, Å¼e wszystkie zasoby sÄ… wdraÅ¼ane w okreÅ›lonych regionach Azure. Na przykÅ‚ad firma moÅ¼e chcieÄ‡ zapewniÄ‡, Å¼e wszystkie jej dane sÄ… przechowywane w Europie w celu zgodnoÅ›ci z RODO.
2. **Egzekwowanie standardÃ³w nazewnictwa**: Polityki mogÄ… egzekwowaÄ‡ konwencje nazewnictwa dla zasobÃ³w Azure. Pomaga to w organizacji i Å‚atwym identyfikowaniu zasobÃ³w na podstawie ich nazw, co jest pomocne w duÅ¼ych Å›rodowiskach.
3. **Ograniczenie niektÃ³rych typÃ³w zasobÃ³w**: Ta polityka moÅ¼e ograniczyÄ‡ tworzenie niektÃ³rych typÃ³w zasobÃ³w. Na przykÅ‚ad polityka moÅ¼e byÄ‡ ustawiona, aby zapobiec tworzeniu drogich typÃ³w zasobÃ³w, takich jak niektÃ³re rozmiary VM, aby kontrolowaÄ‡ koszty.
4. **Egzekwowanie polityk tagowania**: Tagi to pary klucz-wartoÅ›Ä‡ zwiÄ…zane z zasobami Azure uÅ¼ywane do zarzÄ…dzania zasobami. Polityki mogÄ… egzekwowaÄ‡, Å¼e okreÅ›lone tagi muszÄ… byÄ‡ obecne lub mieÄ‡ okreÅ›lone wartoÅ›ci dla wszystkich zasobÃ³w. Jest to przydatne do Å›ledzenia kosztÃ³w, wÅ‚asnoÅ›ci lub kategoryzacji zasobÃ³w.
5. **Ograniczenie publicznego dostÄ™pu do zasobÃ³w**: Polityki mogÄ… egzekwowaÄ‡, Å¼e niektÃ³re zasoby, takie jak konta magazynowe lub bazy danych, nie majÄ… publicznych punktÃ³w koÅ„cowych, zapewniajÄ…c, Å¼e sÄ… dostÄ™pne tylko w sieci organizacji.
6. **Automatyczne stosowanie ustawieÅ„ zabezpieczeÅ„**: Polityki mogÄ… byÄ‡ uÅ¼ywane do automatycznego stosowania ustawieÅ„ zabezpieczeÅ„ do zasobÃ³w, takich jak stosowanie okreÅ›lonej grupy zabezpieczeÅ„ sieci do wszystkich VM lub zapewnienie, Å¼e wszystkie konta magazynowe uÅ¼ywajÄ… szyfrowania.

NaleÅ¼y pamiÄ™taÄ‡, Å¼e polityki Azure mogÄ… byÄ‡ przypisane do dowolnego poziomu hierarchii Azure, ale sÄ… **najczÄ™Å›ciej uÅ¼ywane w gÅ‚Ã³wnej grupie zarzÄ…dzajÄ…cej** lub w innych grupach zarzÄ…dzajÄ…cych.

### Zakres uprawnieÅ„

W Azure **uprawnienia mogÄ… byÄ‡ przypisane do dowolnej czÄ™Å›ci hierarchii**. Obejmuje to grupy zarzÄ…dzajÄ…ce, subskrypcje, grupy zasobÃ³w i poszczegÃ³lne zasoby. Uprawnienia sÄ… **dziedziczone** przez zawarte **zasoby** podmiotu, w ktÃ³rym zostaÅ‚y przypisane.

Ta struktura hierarchiczna pozwala na efektywne i skalowalne zarzÄ…dzanie uprawnieniami dostÄ™pu.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (kontrola dostÄ™pu oparta na rolach) to to, co juÅ¼ widzieliÅ›my w poprzednich sekcjach: **Przypisanie roli do podmiotu, aby przyznaÄ‡ mu dostÄ™p** do zasobu.\
Jednak w niektÃ³rych przypadkach moÅ¼esz chcieÄ‡ zapewniÄ‡ **bardziej szczegÃ³Å‚owe zarzÄ…dzanie dostÄ™pem** lub **uproszczenie** zarzÄ…dzania **setkami** przypisaÅ„ rÃ³l.

Azure **ABAC** (kontrola dostÄ™pu oparta na atrybutach) opiera siÄ™ na Azure RBAC, dodajÄ…c **warunki przypisania rÃ³l oparte na atrybutach** w kontekÅ›cie okreÅ›lonych dziaÅ‚aÅ„. Warunek _przypisania roli_ to **dodatkowa kontrola, ktÃ³rÄ… moÅ¼esz opcjonalnie dodaÄ‡ do przypisania roli**, aby zapewniÄ‡ bardziej szczegÃ³Å‚owÄ… kontrolÄ™ dostÄ™pu. Warunek filtruje uprawnienia przyznane jako czÄ™Å›Ä‡ definicji roli i przypisania roli. Na przykÅ‚ad moÅ¼esz **dodaÄ‡ warunek, ktÃ³ry wymaga, aby obiekt miaÅ‚ okreÅ›lony tag, aby go odczytaÄ‡**.\
Nie **moÅ¼esz** wyraÅºnie **odrzuciÄ‡** **dostÄ™pu** do okreÅ›lonych zasobÃ³w **za pomocÄ… warunkÃ³w**.

### DomyÅ›lne uprawnienia uÅ¼ytkownikÃ³w

Podstawowy uÅ¼ytkownik bÄ™dzie miaÅ‚ pewne **domyÅ›lne uprawnienia** do enumeracji niektÃ³rych czÄ™Å›ci AzureAD:

* Odczyt wszystkich uÅ¼ytkownikÃ³w, grup, aplikacji, urzÄ…dzeÅ„, rÃ³l, subskrypcji i ich publicznych wÅ‚aÅ›ciwoÅ›ci
* Zapraszanie goÅ›ci (_moÅ¼na wyÅ‚Ä…czyÄ‡_)
* Tworzenie grup zabezpieczeÅ„
* Odczyt nieukrytych czÅ‚onkostw grup
* Dodawanie goÅ›ci do posiadanych grup
* Tworzenie nowej aplikacji (_moÅ¼na wyÅ‚Ä…czyÄ‡_)
* Dodawanie do 50 urzÄ…dzeÅ„ do Azure (_moÅ¼na wyÅ‚Ä…czyÄ‡_)

MoÅ¼esz zobaczyÄ‡ peÅ‚nÄ… [listÄ™ **domyÅ›lnych uprawnieÅ„ uÅ¼ytkownikÃ³w** w dokumentacji](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Ponadto pamiÄ™taj, Å¼e na tej liÅ›cie moÅ¼esz rÃ³wnieÅ¼ zobaczyÄ‡ **listÄ™ domyÅ›lnych uprawnieÅ„ goÅ›ci**.

{% hint style="info" %}
PamiÄ™taj, Å¼e aby enumerowaÄ‡ zasoby Azure, uÅ¼ytkownik potrzebuje wyraÅºnego przyznania uprawnienia.
{% endhint %}

### ZarzÄ…dzanie toÅ¼samoÅ›ciami uprzywilejowanymi (PIM)

ZarzÄ…dzanie toÅ¼samoÅ›ciami uprzywilejowanymi (PIM) w Azure to narzÄ™dzie, ktÃ³re **zarzÄ…dza, kontroluje i monitoruje uprzywilejowany dostÄ™p** w Azure Active Directory i Azure. ZwiÄ™ksza bezpieczeÅ„stwo, zapewniajÄ…c **dostÄ™p uprzywilejowany na Å¼Ä…danie i ograniczony czasowo**, **egzekwujÄ…c przepÅ‚ywy pracy zatwierdzania i wymagajÄ…c dodatkowego uwierzytelnienia**. Takie podejÅ›cie minimalizuje ryzyko nieautoryzowanego dostÄ™pu, zapewniajÄ…c, Å¼e podwyÅ¼szone uprawnienia sÄ… przyznawane tylko wtedy, gdy jest to konieczne i na okreÅ›lony czas.

## Tokeny uwierzytelniajÄ…ce

IstniejÄ… **trzy typy tokenÃ³w** uÅ¼ywanych w OIDC:

* [**Tokeny dostÄ™pu**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Klient przedstawia ten token serwerowi zasobÃ³w, aby **uzyskaÄ‡ dostÄ™p do zasobÃ³w**. MoÅ¼e byÄ‡ uÅ¼ywany tylko dla okreÅ›lonej kombinacji uÅ¼ytkownika, klienta i zasobu i **nie moÅ¼e byÄ‡ uniewaÅ¼niony** do momentu wygaÅ›niÄ™cia - co trwa 1 godzinÄ™ domyÅ›lnie. WykrywalnoÅ›Ä‡ jest niska przy uÅ¼yciu tego.
* **Tokeny ID**: Klient otrzymuje ten **token od serwera autoryzacji**. Zawiera podstawowe informacje o uÅ¼ytkowniku. Jest **powiÄ…zany z okreÅ›lonÄ… kombinacjÄ… uÅ¼ytkownika i klienta**.
* **Tokeny odÅ›wieÅ¼ania**: Przyznawane klientowi wraz z tokenem dostÄ™pu. UÅ¼ywane do **uzyskiwania nowych tokenÃ³w dostÄ™pu i ID**. Jest powiÄ…zany z okreÅ›lonÄ… kombinacjÄ… uÅ¼ytkownika i klienta i moÅ¼e byÄ‡ uniewaÅ¼niony. DomyÅ›lne wygaÅ›niÄ™cie wynosi **90 dni** dla nieaktywnych tokenÃ³w odÅ›wieÅ¼ania i **brak wygaÅ›niÄ™cia dla aktywnych tokenÃ³w**.

{% hint style="warning" %}
Informacje o **dostÄ™pie warunkowym** sÄ… **przechowywane** wewnÄ…trz **JWT**. WiÄ™c jeÅ›li zaÅ¼Ä…dajesz **tokena z dozwolonego adresu IP**, ten **adres IP** zostanie **przechowany** w tokenie, a nastÄ™pnie moÅ¼esz uÅ¼yÄ‡ tego tokena z **niedozwolonego adresu IP, aby uzyskaÄ‡ dostÄ™p do zasobÃ³w**.
{% endhint %}

SprawdÅº nastÄ™pujÄ…cÄ… stronÄ™, aby poznaÄ‡ rÃ³Å¼ne sposoby **Å¼Ä…dania tokenÃ³w dostÄ™pu** i logowania siÄ™ z ich pomocÄ…:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

NajczÄ™stsze punkty koÅ„cowe API to:

* **Azure Resource Manager** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (Azure AD Graph, ktÃ³ry jest przestarzaÅ‚y, to graph.windows.net)

## OdnoÅ›niki

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)
* [https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration](https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
