# Az - Informations de base

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Formation AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Formation GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* V√©rifiez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Hi√©rarchie de l'organisation

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUchBvhjIdWWR2ldAkWiZMdmrcEYD9Ti5UAa3zAGr9YbAnx4Q_gZNp_zvOU429vgWZ_ixoYHQKdC8bGgkhWYCy591SRIFj6RKCj4BEpVQixAGsp3T3O5sS3k7x5CTaJ-SCBNC7i5KluLyxdiXoZsH1F0ko1Gv88=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption></figcaption></figure>

### Groupes de gestion

* Il peut contenir **d'autres groupes de gestion ou abonnements**.
* Cela permet d'**appliquer des contr√¥les de gouvernance** tels que RBAC et Azure Policy une fois au niveau du groupe de gestion et de les **h√©riter** par tous les abonnements dans le groupe.
* **10 000 groupes de gestion** peuvent √™tre pris en charge dans un seul annuaire.
* Un arbre de groupes de gestion peut prendre en charge **jusqu'√† six niveaux de profondeur**. Cette limite n'inclut pas le niveau racine ou le niveau d'abonnement.
* Chaque groupe de gestion et abonnement peut prendre en charge **un seul parent**.
* M√™me si plusieurs groupes de gestion peuvent √™tre cr√©√©s, **il n'y a qu'un seul groupe de gestion racine**.
* Le groupe de gestion racine **contient** tous les **autres groupes de gestion et abonnements** et **ne peut pas √™tre d√©plac√© ou supprim√©**.
* Tous les abonnements au sein d'un seul groupe de gestion doivent faire confiance au **m√™me locataire Entra ID.**

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption><p><a href="https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png">https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png</a></p></figcaption></figure>

### Abonnements Azure

* C'est un autre **conteneur logique o√π les ressources** (VMs, DBs‚Ä¶) peuvent √™tre ex√©cut√©es et seront factur√©es.
* Son **parent** est toujours un **groupe de gestion** (et cela peut √™tre le groupe de gestion racine) car les abonnements ne peuvent pas contenir d'autres abonnements.
* Il **fait confiance √† un seul r√©pertoire Entra ID**
* Les **permissions** appliqu√©es au niveau de l'abonnement (ou √† l'un de ses parents) sont **h√©rit√©es** par toutes les ressources √† l'int√©rieur de l'abonnement.

### Groupes de ressources

[Des docs :](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Un groupe de ressources est un **conteneur** qui contient des **ressources li√©es** pour une solution Azure. Le groupe de ressources peut inclure toutes les ressources de la solution, ou seulement celles **que vous souhaitez g√©rer en tant que groupe**. En g√©n√©ral, ajoutez des **ressources** qui partagent le **m√™me cycle de vie** au m√™me groupe de ressources afin que vous puissiez facilement les d√©ployer, les mettre √† jour et les supprimer en tant que groupe.

Toutes les **ressources** doivent √™tre **√† l'int√©rieur d'un groupe de ressources** et ne peuvent appartenir qu'√† un seul groupe et si un groupe de ressources est supprim√©, toutes les ressources √† l'int√©rieur sont √©galement supprim√©es.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfe8U30iP_vdZCvxX4g8nEPRLoo7v0kmCGkDn1frBPn3_GIoZ7VT2LkdsVQWCnrG_HSYNRRPM-1pSECUkbDAB-9YbUYLzpvKVLDETZS81CHWKYM4fDl3oMo5-yvTMnjdLTS2pz8U67xUTIzBhZ25MFMRkq5koKY=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption><p><a href="https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1">https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1</a></p></figcaption></figure>

### Identifiants de ressources Azure

Chaque ressource dans Azure a un identifiant de ressource Azure qui l'identifie.

Le format d'un identifiant de ressource Azure est le suivant :

* `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderNamespace}/{resourceType}/{resourceName}`

Pour une machine virtuelle nomm√©e myVM dans un groupe de ressources `myResourceGroup` sous l'ID d'abonnement `12345678-1234-1234-1234-123456789012`, l'identifiant de ressource Azure ressemble √† ceci :

* `/subscriptions/12345678-1234-1234-1234-123456789012/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM`

## Azure vs Entra ID vs Services de domaine Azure AD

### Azure

Azure est la **plateforme de cloud computing compl√®te de Microsoft, offrant une large gamme de services**, y compris des machines virtuelles, des bases de donn√©es, de l'intelligence artificielle et du stockage. Elle sert de fondation pour h√©berger et g√©rer des applications, construire des infrastructures √©volutives et ex√©cuter des charges de travail modernes dans le cloud. Azure fournit des outils pour les d√©veloppeurs et les professionnels de l'informatique afin de cr√©er, d√©ployer et g√©rer des applications et des services de mani√®re transparente, r√©pondant √† une vari√©t√© de besoins allant des startups aux grandes entreprises.

### Entra ID (anciennement Azure Active Directory)

Entra ID est un service de **gestion des identit√©s et des acc√®s bas√© sur le cloud** con√ßu pour g√©rer l'authentification, l'autorisation et le contr√¥le d'acc√®s des utilisateurs. Il permet un acc√®s s√©curis√© aux services Microsoft tels qu'Office 365, Azure et de nombreuses applications SaaS tierces. Avec des fonctionnalit√©s telles que l'authentification unique (SSO), l'authentification multi-facteurs (MFA) et des politiques d'acc√®s conditionnel, entre autres.

### Services de domaine Entra (anciennement Azure AD DS)

Les services de domaine Entra √©tendent les capacit√©s d'Entra ID en offrant des **services de domaine g√©r√©s compatibles avec les environnements traditionnels de Windows Active Directory**. Il prend en charge des protocoles h√©rit√©s tels que LDAP, Kerberos et NTLM, permettant aux organisations de migrer ou d'ex√©cuter des applications plus anciennes dans le cloud sans d√©ployer de contr√¥leurs de domaine sur site. Ce service prend √©galement en charge les strat√©gies de groupe pour une gestion centralis√©e, ce qui le rend adapt√© aux sc√©narios o√π des charges de travail h√©rit√©es ou bas√©es sur AD doivent coexister avec des environnements cloud modernes.

## Principaux Entra ID

### Utilisateurs

* **Nouveaux utilisateurs**
* Indiquer le nom et le domaine de l'email du locataire s√©lectionn√©
* Indiquer le nom affich√©
* Indiquer le mot de passe
* Indiquer les propri√©t√©s (pr√©nom, titre de poste, informations de contact‚Ä¶)
* Le type d'utilisateur par d√©faut est ‚Äú**membre**‚Äù
* **Utilisateurs externes**
* Indiquer l'email √† inviter et le nom affich√© (peut √™tre un email non Microsoft)
* Indiquer les propri√©t√©s
* Le type d'utilisateur par d√©faut est ‚Äú**Invit√©**‚Äù

### Permissions par d√©faut des membres et invit√©s

Vous pouvez les v√©rifier sur [https://learn.microsoft.com/en-us/entra/fundamentals/users-default-permissions](https://learn.microsoft.com/en-us/entra/fundamentals/users-default-permissions) mais parmi d'autres actions, un membre pourra :

* Lire tous les utilisateurs, groupes, applications, appareils, r√¥les, abonnements et leurs propri√©t√©s publiques
* Inviter des invit√©s (_peut √™tre d√©sactiv√©_)
* Cr√©er des groupes de s√©curit√©
* Lire les adh√©sions de groupe non cach√©es
* Ajouter des invit√©s aux groupes poss√©d√©s
* Cr√©er une nouvelle application (_peut √™tre d√©sactiv√©_)
* Ajouter jusqu'√† 50 appareils √† Azure (_peut √™tre d√©sactiv√©_)

{% hint style="info" %}
N'oubliez pas que pour √©num√©rer les ressources Azure, l'utilisateur a besoin d'une attribution explicite de la permission.
{% endhint %}

### Permissions configurables par d√©faut des utilisateurs

* **Membres (**[**docs**](https://learn.microsoft.com/en-gb/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions)**)**
* Enregistrer des applications : Par d√©faut **Oui**
* Restreindre les utilisateurs non administrateurs de cr√©er des locataires : Par d√©faut **Non**
* Cr√©er des groupes de s√©curit√© : Par d√©faut **Oui**
* Restreindre l'acc√®s au portail d'administration Microsoft Entra : Par d√©faut **Non**
* Cela ne restreint pas l'acc√®s API au portail (uniquement web)
* Autoriser les utilisateurs √† connecter un compte de travail ou d'√©cole avec LinkedIn : Par d√©faut **Oui**
* Afficher garder l'utilisateur connect√© : Par d√©faut **Oui**
* Restreindre les utilisateurs de r√©cup√©rer la ou les cl√©s BitLocker pour leurs appareils poss√©d√©s : Par d√©faut Non (v√©rifiez dans les param√®tres de l'appareil)
* Lire d'autres utilisateurs : Par d√©faut **Oui** (via Microsoft Graph)
* **Invit√©s**
* **Restrictions d'acc√®s des utilisateurs invit√©s**
* **Les utilisateurs invit√©s ont le m√™me acc√®s que les membres** accorde par d√©faut toutes les permissions des utilisateurs membres aux utilisateurs invit√©s.
* **Les utilisateurs invit√©s ont un acc√®s limit√© aux propri√©t√©s et adh√©sions des objets d'annuaire (par d√©faut)** restreint l'acc√®s des invit√©s uniquement √† leur propre profil utilisateur par d√©faut. L'acc√®s aux informations d'autres utilisateurs et groupes n'est plus autoris√©.
* **L'acc√®s des utilisateurs invit√©s est restreint aux propri√©t√©s et adh√©sions de leurs propres objets d'annuaire** est le plus restrictif.
* **Les invit√©s peuvent inviter**
* **Quiconque dans l'organisation peut inviter des utilisateurs invit√©s, y compris des invit√©s et des non-administrateurs (le plus inclusif) - Par d√©faut**
* **Les utilisateurs membres et les utilisateurs assign√©s √† des r√¥les administratifs sp√©cifiques peuvent inviter des utilisateurs invit√©s, y compris des invit√©s avec des permissions de membre**
* **Seuls les utilisateurs assign√©s √† des r√¥les administratifs sp√©cifiques peuvent inviter des utilisateurs invit√©s**
* **Personne dans l'organisation ne peut inviter des utilisateurs invit√©s, y compris les administrateurs (le plus restrictif)**
* **Les utilisateurs externes peuvent partir** : Par d√©faut **Vrai**
* Autoriser les utilisateurs externes √† quitter l'organisation

{% hint style="success" %}
M√™me s'ils sont restreints par d√©faut, les utilisateurs (membres et invit√©s) avec des permissions accord√©es pourraient effectuer les actions pr√©c√©dentes.
{% endhint %}

### **Groupes**

Il existe **2 types de groupes** :

* **S√©curit√©** : Ce type de groupe est utilis√© pour donner aux membres acc√®s aux applications, ressources et attribuer des licences. Les utilisateurs, appareils, principaux de service et autres groupes peuvent √™tre membres.
* **Microsoft 365** : Ce type de groupe est utilis√© pour la collaboration, donnant aux membres acc√®s √† une bo√Æte aux lettres partag√©e, un calendrier, des fichiers, un site SharePoint, etc. Les membres du groupe ne peuvent √™tre que des utilisateurs.
* Cela aura une **adresse email** avec le domaine du locataire EntraID.

Il existe **2 types d'adh√©sions** :

* **Assign√©** : Permet d'ajouter manuellement des membres sp√©cifiques √† un groupe.
* **Adh√©sion dynamique** : G√®re automatiquement l'adh√©sion en utilisant des r√®gles, mettant √† jour l'inclusion du groupe lorsque les attributs des membres changent.

### **Principaux de service**

Un **Principal de service** est une **identit√©** cr√©√©e pour **√™tre utilis√©e** avec des **applications**, des services h√©berg√©s et des outils automatis√©s pour acc√©der aux ressources Azure. Cet acc√®s est **restreint par les r√¥les assign√©s** au principal de service, vous donnant le contr√¥le sur **quelles ressources peuvent √™tre accessibles** et √† quel niveau. Pour des raisons de s√©curit√©, il est toujours recommand√© d'**utiliser des principaux de service avec des outils automatis√©s** plut√¥t que de leur permettre de se connecter avec une identit√© utilisateur.

Il est possible de **se connecter directement en tant que principal de service** en lui g√©n√©rant un **secret** (mot de passe), un **certificat**, ou en accordant un acc√®s **f√©d√©r√©** √† des plateformes tierces (par exemple, Github Actions) √† son sujet.

* Si vous choisissez l'authentification par **mot de passe** (par d√©faut), **enregistrez le mot de passe g√©n√©r√©** car vous ne pourrez plus y acc√©der.
* Si vous choisissez l'authentification par certificat, assurez-vous que l'**application aura acc√®s √† la cl√© priv√©e**.

### Enregistrements d'applications

Un **Enregistrement d'application** est une configuration qui permet √† une application de s'int√©grer avec Entra ID et d'effectuer des actions.

#### Composants cl√©s :

1. **ID d'application (Client ID)** : Un identifiant unique pour votre application dans Azure AD.
2. **URIs de redirection** : URLs o√π Azure AD envoie les r√©ponses d'authentification.
3. **Certificats, Secrets et Identifiants f√©d√©r√©s** : Il est possible de g√©n√©rer un secret ou un certificat pour se connecter en tant que principal de service de l'application, ou pour lui accorder un acc√®s f√©d√©r√© (par exemple, Github Actions).&#x20;
1. Si un **certificat** ou un **secret** est g√©n√©r√©, il est possible pour une personne de **se connecter en tant que principal de service** avec des outils CLI en connaissant l'**ID d'application**, le **secret** ou le **certificat** et le **locataire** (domaine ou ID).
4. **Permissions API** : Sp√©cifie quelles ressources ou API l'application peut acc√©der.
5. **Param√®tres d'authentification** : D√©finit les flux d'authentification pris en charge par l'application (par exemple, OAuth2, OpenID Connect).
6. **Principal de service** : Un principal de service est cr√©√© lorsqu'une application est cr√©√©e (si cela est fait depuis la console web) ou lorsqu'elle est install√©e dans un nouveau locataire.
1. Le **principal de service** obtiendra toutes les permissions demand√©es avec lesquelles il a √©t√© configur√©.

### Permissions de consentement par d√©faut

**Consentement des utilisateurs pour les applications**

* **Ne pas autoriser le consentement des utilisateurs**
* Un administrateur sera requis pour toutes les applications.
* **Autoriser le consentement des utilisateurs pour les applications de publishers v√©rifi√©s, pour des permissions s√©lectionn√©es (Recommand√©)**
* Tous les utilisateurs peuvent consentir pour des permissions class√©es comme "faible impact", pour des applications de publishers v√©rifi√©s ou des applications enregistr√©es dans cette organisation.
* **Permissions √† faible impact par d√©faut** (bien que vous deviez accepter de les ajouter comme faibles) :
* User.Read - se connecter et lire le profil utilisateur
* offline\_access - maintenir l'acc√®s aux donn√©es auxquelles les utilisateurs ont donn√© acc√®s
* openid - connecter les utilisateurs
* profile - voir le profil de base de l'utilisateur
* email - voir l'adresse email de l'utilisateur
* **Autoriser le consentement des utilisateurs pour les applications (Par d√©faut)**
* Tous les utilisateurs peuvent consentir pour toute application d'acc√©der aux donn√©es de l'organisation.

**Demandes de consentement administratives** : Par d√©faut **Non**

* Les utilisateurs peuvent demander le consentement administratif pour des applications auxquelles ils ne peuvent pas consentir
* Si **Oui** : Il est possible d'indiquer les utilisateurs, groupes et r√¥les qui peuvent consentir aux demandes
* Configurez √©galement si les utilisateurs recevront des notifications par email et des rappels d'expiration&#x20;

### **Identit√© g√©r√©e (M√©tadonn√©es)**

Les identit√©s g√©r√©es dans Azure Active Directory offrent une solution pour **g√©rer automatiquement l'identit√©** des applications. Ces identit√©s sont utilis√©es par les applications dans le but de **se connecter** aux **ressources** compatibles avec l'authentification Azure Active Directory (**Azure AD**). Cela permet de **supprimer le besoin de coder en dur les identifiants cloud** dans le code, car l'application pourra contacter le **service de m√©tadonn√©es** pour obtenir un jeton valide afin de **r√©aliser des actions** en tant qu'identit√© g√©r√©e indiqu√©e dans Azure.

Il existe deux types d'identit√©s g√©r√©es :

* **Assign√© au syst√®me**. Certains services Azure vous permettent d'**activer une identit√© g√©r√©e directement sur une instance de service**. Lorsque vous activez une identit√© g√©r√©e assign√©e au syst√®me, un **principal de service** est cr√©√© dans le locataire Entra ID de confiance par l'abonnement o√π la ressource est situ√©e. Lorsque la **ressource** est **supprim√©e**, Azure supprime automatiquement **l'identit√©** pour vous.
* **Assign√© par l'utilisateur**. Il est √©galement possible pour les utilisateurs de g√©n√©rer des identit√©s g√©r√©es. Celles-ci sont cr√©√©es √† l'int√©rieur d'un groupe de ressources dans un abonnement et un principal de service sera cr√©√© dans l'EntraID de confiance par l'abonnement. Ensuite, vous pouvez assigner l'identit√© g√©r√©e √† une ou **plusieurs instances** d'un service Azure (plusieurs ressources). Pour les identit√©s g√©r√©es assign√©es par l'utilisateur, **l'identit√© est g√©r√©e s√©par√©ment des ressources qui l'utilisent**.

Les identit√©s g√©r√©es **ne g√©n√®rent pas de credentials √©ternels** (comme des mots de passe ou des certificats) pour acc√©der en tant que principal de service qui y est attach√©.

### Applications d'entreprise

C'est juste une **table dans Azure pour filtrer les principaux de service** et v√©rifier les applications qui leur ont √©t√© assign√©es.

**Ce n'est pas un autre type d'‚Äúapplication‚Äù**, il n'y a aucun objet dans Azure qui soit une ‚ÄúApplication d'entreprise‚Äù, c'est juste une abstraction pour v√©rifier les Principaux de service, les Enregistrements d'applications et les identit√©s g√©r√©es.

### Unit√©s administratives

Les unit√©s administratives permettent de **donner des permissions d'un r√¥le sur une portion sp√©cifique d'une organisation**.

Exemple :

* Sc√©nario : Une entreprise souhaite que les administrateurs informatiques r√©gionaux g√®rent uniquement les utilisateurs de leur propre r√©gion.
* Mise en ≈ìuvre :
* Cr√©er des unit√©s administratives pour chaque r√©gion (par exemple, "AU Am√©rique du Nord", "AU Europe").
* Peupler les AU avec des utilisateurs de leurs r√©gions respectives.
* Les AU peuvent **contenir des utilisateurs, groupes ou appareils**
* Les AU prennent en charge **les adh√©sions dynamiques**
* Les AU **ne peuvent pas contenir d'AU**
* Attribuer des r√¥les administratifs :
* Accorder le r√¥le "Administrateur des utilisateurs" au personnel informatique r√©gional, limit√© √† l'AU de leur r√©gion.
* R√©sultat : Les administrateurs informatiques r√©gionaux peuvent g√©rer les comptes utilisateurs au sein de leur r√©gion sans affecter d'autres r√©gions.

### R√¥les Entra ID

* Afin de g√©rer Entra ID, il existe certains **r√¥les int√©gr√©s** qui peuvent √™tre assign√©s aux principaux Entra ID pour g√©rer Entra ID
* V√©rifiez les r√¥les sur [https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/permissions-reference](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/permissions-reference)
* Le r√¥le le plus privil√©gi√© est **Administrateur global**
* Dans la description du r√¥le, il est possible de voir ses **permissions granulaires**

## R√¥les et Permissions

**Les r√¥les** sont **assign√©s** aux **principaux** sur un **scope** : `principal -[HAS ROLE]->(scope)`

**Les r√¥les** assign√©s aux **groupes** sont **h√©rit√©s** par tous les **membres** du groupe.

Selon le scope auquel le r√¥le a √©t√© assign√©, le **r√¥le** peut √™tre **h√©rit√©** par **d'autres ressources** √† l'int√©rieur du conteneur de scope. Par exemple, si un utilisateur A a un **r√¥le sur l'abonnement**, il aura ce **r√¥le sur tous les groupes de ressources** √† l'int√©rieur de l'abonnement et sur **toutes les ressources** √† l'int√©rieur du groupe de ressources.

### **R√¥les classiques**

| **Propri√©taire**                     | <ul><li>Acc√®s complet √† toutes les ressources</li><li>Peut g√©rer l'acc√®s pour d'autres utilisateurs</li></ul> | Tous les types de ressources |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Contributeur**               | <ul><li>Acc√®s complet √† toutes les ressources</li><li>Ne peut pas g√©rer l'acc√®s</li></ul>              | Tous les types de ressources |
| **Lecteur**                    | ‚Ä¢ Voir toutes les ressources                                                                     | Tous les types de ressources |
| **Administrateur d'acc√®s utilisateur** | <ul><li>Voir toutes les ressources</li><li>Peut g√©rer l'acc√®s pour d'autres utilisateurs</li></ul>           | Tous les types de ressources |

### R√¥les int√©gr√©s

[Des docs : ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Le contr√¥le d'acc√®s bas√© sur les r√¥les Azure (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) a plusieurs **r√¥les int√©gr√©s Azure** que vous pouvez **assigner** √† **des utilisateurs, groupes, principaux de service et identit√©s g√©r√©es**. Les attributions de r√¥le sont la mani√®re dont vous contr√¥lez **l'acc√®s aux ressources Azure**. Si les r√¥les int√©gr√©s ne r√©pondent pas aux besoins sp√©cifiques de votre organisation, vous pouvez cr√©er vos propres [**r√¥les personnalis√©s Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

Les **r√¥les int√©gr√©s** s'appliquent uniquement aux **ressources** pour lesquelles ils sont **destin√©s**, par exemple, v√©rifiez ces 2 exemples de **r√¥les int√©gr√©s sur les ressources Compute** :

| [Lecteur de sauvegarde de disque](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Fournit la permission au coffre de sauvegarde pour effectuer une sauvegarde de disque.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Connexion utilisateur de machine virtuelle](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Voir les machines virtuelles dans le portail et se connecter en tant qu'utilisateur r√©gulier. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Ces r√¥les peuvent **√©galement √™tre assign√©s sur des conteneurs logiques** (tels que des groupes de gestion, des abonnements et des groupes de ressources) et les principaux affect√©s les auront **sur les ressources √† l'int√©rieur de ces conteneurs**.

* Trouvez ici une liste avec [**tous les r√¥les int√©gr√©s Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Trouvez ici une liste avec [**tous les r√¥les int√©gr√©s Entra ID**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### R√¥les personnalis√©s

* Il est √©galement possible de cr√©er [**r√¥les personnalis√©s**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)
* Ils sont cr√©√©s √† l'int√©rieur d'un scope, bien qu'un r√¥le puisse √™tre dans plusieurs scopes (groupes de gestion, abonnements et groupes de ressources)
* Il est possible de configurer toutes les permissions granulaires que le r√¥le personnalis√© aura
* Il est possible d'exclure des permissions
* Un principal avec une permission exclue ne pourra pas l'utiliser m√™me si la permission est accord√©e ailleurs
* Il est possible d'utiliser des jokers
* Le format utilis√© est un JSON
* `actions` sont pour contr√¥ler les actions sur la ressource
* `dataActions` sont des permissions sur les donn√©es √† l'int√©rieur de l'objet

Exemple de JSON de permissions pour un r√¥le personnalis√© :
```json
{
"properties": {
"roleName": "",
"description": "",
"assignableScopes": [
"/subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f"
],
"permissions": [
{
"actions": [
"Microsoft.DigitalTwins/register/action",
"Microsoft.DigitalTwins/unregister/action",
"Microsoft.DigitalTwins/operations/read",
"Microsoft.DigitalTwins/digitalTwinsInstances/read",
"Microsoft.DigitalTwins/digitalTwinsInstances/write",
"Microsoft.CostManagement/exports/*"
],
"notActions": [
"Astronomer.Astro/register/action",
"Astronomer.Astro/unregister/action",
"Astronomer.Astro/operations/read",
"Astronomer.Astro/organizations/read"
],
"dataActions": [],
"notDataActions": []
}
]
}
}
```
### Permissions order

* Afin qu'un **principal ait un acc√®s sur une ressource**, il a besoin d'un r√¥le explicite qui lui est accord√© (de quelque mani√®re que ce soit) **lui accordant cette permission**.
* Une affectation de r√¥le explicite **de refus a la priorit√©** sur le r√¥le accordant la permission.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption><p><a href="https://link.springer.com/chapter/10.1007/978-1-4842-7325-8_10">https://link.springer.com/chapter/10.1007/978-1-4842-7325-8_10</a></p></figcaption></figure>

### Global Administrator

Global Administrator est un r√¥le d'Entra ID qui accorde **un contr√¥le total sur le locataire Entra ID**. Cependant, il n'accorde par d√©faut aucune permission sur les ressources Azure.

Les utilisateurs ayant le r√¥le de Global Administrator ont la capacit√© de '**s'√©lever' au r√¥le d'Administrateur d'Acc√®s Utilisateur Azure dans le Groupe de Gestion Racine**. Ainsi, les Global Administrators peuvent g√©rer l'acc√®s dans **toutes les souscriptions Azure et groupes de gestion.**\
Cette √©l√©vation peut √™tre effectu√©e en bas de la page : [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/Properties)

<figure><img src="../../.gitbook/assets/image (349).png" alt=""><figcaption></figcaption></figure>

### Azure Policies

**Azure Policies** sont des r√®gles qui aident les organisations √† s'assurer que leurs ressources r√©pondent √† des normes sp√©cifiques et √† des exigences de conformit√©. Elles vous permettent de **faire respecter ou d'auditer les param√®tres sur les ressources dans Azure**. Par exemple, vous pouvez emp√™cher la cr√©ation de machines virtuelles dans une r√©gion non autoris√©e ou vous assurer que toutes les ressources ont des balises sp√©cifiques pour le suivi.

Les Azure Policies sont **proactives** : elles peuvent emp√™cher la cr√©ation ou la modification de ressources non conformes. Elles sont √©galement **r√©actives**, vous permettant de trouver et de corriger les ressources non conformes existantes.

#### **Key Concepts**

1. **D√©finition de la politique** : Une r√®gle, √©crite en JSON, qui sp√©cifie ce qui est autoris√© ou requis.
2. **Affectation de la politique** : L'application d'une politique √† un champ sp√©cifique (par exemple, souscription, groupe de ressources).
3. **Initiatives** : Une collection de politiques regroup√©es pour une application plus large.
4. **Effet** : Sp√©cifie ce qui se passe lorsque la politique est d√©clench√©e (par exemple, "Refuser", "Auditer" ou "Ajouter").

**Quelques exemples :**

1. **Assurer la conformit√© avec des r√©gions Azure sp√©cifiques** : Cette politique garantit que toutes les ressources sont d√©ploy√©es dans des r√©gions Azure sp√©cifiques. Par exemple, une entreprise pourrait vouloir s'assurer que toutes ses donn√©es sont stock√©es en Europe pour la conformit√© au RGPD.
2. **Faire respecter les normes de nommage** : Les politiques peuvent faire respecter des conventions de nommage pour les ressources Azure. Cela aide √† organiser et √† identifier facilement les ressources en fonction de leurs noms, ce qui est utile dans de grands environnements.
3. **Restreindre certains types de ressources** : Cette politique peut restreindre la cr√©ation de certains types de ressources. Par exemple, une politique pourrait √™tre d√©finie pour emp√™cher la cr√©ation de types de ressources co√ªteux, comme certaines tailles de VM, pour contr√¥ler les co√ªts.
4. **Faire respecter les politiques de balisage** : Les balises sont des paires cl√©-valeur associ√©es aux ressources Azure utilis√©es pour la gestion des ressources. Les politiques peuvent faire respecter la pr√©sence de certaines balises, ou avoir des valeurs sp√©cifiques, pour toutes les ressources. Cela est utile pour le suivi des co√ªts, la propri√©t√© ou la cat√©gorisation des ressources.
5. **Limiter l'acc√®s public aux ressources** : Les politiques peuvent faire respecter que certaines ressources, comme les comptes de stockage ou les bases de donn√©es, n'ont pas de points de terminaison publics, garantissant qu'elles ne sont accessibles que dans le r√©seau de l'organisation.
6. **Appliquer automatiquement les param√®tres de s√©curit√©** : Les politiques peuvent √™tre utilis√©es pour appliquer automatiquement des param√®tres de s√©curit√© aux ressources, comme appliquer un groupe de s√©curit√© r√©seau sp√©cifique √† toutes les VM ou s'assurer que tous les comptes de stockage utilisent le chiffrement.

Notez que les Azure Policies peuvent √™tre attach√©es √† n'importe quel niveau de la hi√©rarchie Azure, mais elles sont **g√©n√©ralement utilis√©es dans le groupe de gestion racine** ou dans d'autres groupes de gestion.

Exemple de politique Azure json :
```json
{
"policyRule": {
"if": {
"field": "location",
"notIn": [
"eastus",
"westus"
]
},
"then": {
"effect": "Deny"
}
},
"parameters": {},
"displayName": "Allow resources only in East US and West US",
"description": "This policy ensures that resources can only be created in East US or West US.",
"mode": "All"
}
```
### H√©ritage des autorisations

Dans Azure, **les autorisations peuvent √™tre attribu√©es √† n'importe quelle partie de la hi√©rarchie**. Cela inclut les groupes de gestion, les abonnements, les groupes de ressources et les ressources individuelles. Les autorisations sont **h√©rit√©es** par les **ressources** contenues de l'entit√© o√π elles ont √©t√© attribu√©es.

Cette structure hi√©rarchique permet une gestion efficace et √©volutive des autorisations d'acc√®s.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (contr√¥le d'acc√®s bas√© sur les r√¥les) est ce que nous avons d√©j√† vu dans les sections pr√©c√©dentes : **Attribuer un r√¥le √† un principal pour lui accorder l'acc√®s** √† une ressource.\
Cependant, dans certains cas, vous pourriez vouloir fournir une **gestion des acc√®s plus granulaire** ou **simplifier** la gestion de **centaines** d'**attributions de r√¥les**.

Azure **ABAC** (contr√¥le d'acc√®s bas√© sur les attributs) s'appuie sur Azure RBAC en ajoutant des **conditions d'attribution de r√¥le bas√©es sur des attributs** dans le contexte d'actions sp√©cifiques. Une _condition d'attribution de r√¥le_ est un **v√©rification suppl√©mentaire que vous pouvez ajouter en option √† votre attribution de r√¥le** pour fournir un contr√¥le d'acc√®s plus granulaire. Une condition filtre les autorisations accord√©es dans le cadre de la d√©finition de r√¥le et de l'attribution de r√¥le. Par exemple, vous pouvez **ajouter une condition qui exige qu'un objet ait une √©tiquette sp√©cifique pour lire l'objet**.\
Vous **ne pouvez pas** explicitement **refuser** l'**acc√®s** √† des ressources sp√©cifiques **en utilisant des conditions**.

### Gestion des identit√©s privil√©gi√©es (PIM)

La gestion des identit√©s privil√©gi√©es (PIM) dans Azure est un outil qui **g√®re, contr√¥le et surveille l'acc√®s privil√©gi√©** dans Azure Active Directory et Azure. Elle am√©liore la s√©curit√© en fournissant un **acc√®s privil√©gi√© juste √† temps et limit√© dans le temps**, **en imposant des flux de travail d'approbation et en exigeant une authentification suppl√©mentaire**. Cette approche minimise le risque d'acc√®s non autoris√© en s'assurant que les autorisations √©lev√©es ne sont accord√©es que lorsque cela est n√©cessaire et pour une dur√©e sp√©cifique.

## Jetons d'authentification

Il existe **trois types de jetons** utilis√©s dans OIDC :

* [**Jetons d'acc√®s**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Le client pr√©sente ce jeton au serveur de ressources pour **acc√©der aux ressources**. Il ne peut √™tre utilis√© que pour une combinaison sp√©cifique d'utilisateur, de client et de ressource et **ne peut pas √™tre r√©voqu√©** jusqu'√† son expiration - c'est-√†-dire 1 heure par d√©faut.
* **Jetons d'identit√©** : Le client re√ßoit ce **jeton du serveur d'autorisation**. Il contient des informations de base sur l'utilisateur. Il est **li√© √† une combinaison sp√©cifique d'utilisateur et de client**.
* **Jetons de rafra√Æchissement** : Fournis au client avec le jeton d'acc√®s. Utilis√©s pour **obtenir de nouveaux jetons d'acc√®s et d'identit√©**. Il est li√© √† une combinaison sp√©cifique d'utilisateur et de client et peut √™tre r√©voqu√©. L'expiration par d√©faut est de **90 jours** pour les jetons de rafra√Æchissement inactifs et **pas d'expiration pour les jetons actifs**.

{% hint style="warning" %}
Les informations pour **l'acc√®s conditionnel** sont **stock√©es** √† l'int√©rieur du **JWT**. Donc, si vous demandez le **jeton depuis une adresse IP autoris√©e**, cette **IP** sera **stock√©e** dans le jeton et vous pourrez ensuite utiliser ce jeton depuis une **IP non autoris√©e pour acc√©der aux ressources**.
{% endhint %}

### Jetons d'acc√®s "aud"

Selon l'action que vous souhaitez effectuer, le "**aud**" du jeton d'acc√®s doit √™tre autoris√© √† contacter l'URL de l'API que vous allez contacter.

La commande `az account get-access-token --resource-type [...]` prend en charge les types suivants et chacun d'eux ajoutera un "aud" sp√©cifique dans le jeton d'acc√®s r√©sultant :

{% hint style="danger" %}
Notez que les √©l√©ments suivants ne sont que les API prises en charge par `az account get-access-token`, mais il y en a d'autres.
{% endhint %}

* **aad-graph (API Graph d'Azure Active Directory)** : Utilis√© pour acc√©der √† l'API Graph Azure AD h√©rit√©e (d√©pr√©ci√©e), qui permet aux applications de lire et d'√©crire des donn√©es d'annuaire dans Azure Active Directory (Azure AD).
* `https://graph.windows.net/`
* **arm (Gestionnaire de ressources Azure)** : Utilis√© pour g√©rer les ressources Azure via l'API du Gestionnaire de ressources Azure. Cela inclut des op√©rations telles que la cr√©ation, la mise √† jour et la suppression de ressources telles que des machines virtuelles, des comptes de stockage, et plus encore.
* `https://management.core.windows.net/ ou https://management.azure.com/`
* **batch (Services Azure Batch)** : Utilis√© pour acc√©der √† Azure Batch, un service qui permet d'ex√©cuter efficacement des applications de calcul parall√®le √† grande √©chelle et haute performance dans le cloud.
* `https://batch.core.windows.net/`
* **data-lake (Stockage Azure Data Lake)** : Utilis√© pour interagir avec Azure Data Lake Storage Gen1, qui est un service de stockage et d'analyse de donn√©es √©volutif.
* `https://datalake.azure.net/`
* **media (Services Azure Media)** : Utilis√© pour acc√©der aux Services Azure Media, qui fournissent des services de traitement et de diffusion de m√©dias bas√©s sur le cloud pour le contenu vid√©o et audio.
* `https://rest.media.azure.net`
* **ms-graph (API Microsoft Graph)** : Utilis√© pour acc√©der √† l'API Microsoft Graph, le point de terminaison unifi√© pour les donn√©es des services Microsoft 365. Il vous permet d'acc√©der aux donn√©es et aux informations des services tels qu'Azure AD, Office 365, Enterprise Mobility et les services de s√©curit√©.
* `https://graph.microsoft.com`
* **oss-rdbms (Bases de donn√©es relationnelles open source Azure)** : Utilis√© pour acc√©der aux services de base de donn√©es Azure pour des moteurs de bases de donn√©es relationnelles open source comme MySQL, PostgreSQL et MariaDB.
* `https://ossrdbms-aad.database.windows.net`

Consultez la page suivante pour apprendre diff√©rentes fa√ßons de **demander des jetons d'acc√®s** et de vous connecter avec eux :

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

## R√©f√©rences

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)
* [https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration](https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
