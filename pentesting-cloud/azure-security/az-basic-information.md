# Az - 基本情報

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## 組織階層

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUchBvhjIdWWR2ldAkWiZMdmrcEYD9Ti5UAa3zAGr9YbAnx4Q_gZNp_zvOU429vgWZ_ixoYHQKdC8bGgkhWYCy591SRIFj6RKCj4BEpVQixAGsp3T3O5sS3k7x5CTaJ-SCBNC7i5KluLyxdiXoZsH1F0ko1Gv88=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption></figcaption></figure>

### 管理グループ

* **他の管理グループやサブスクリプション**を含むことができます。
* これにより、管理グループレベルでRBACやAzureポリシーなどの**ガバナンスコントロールを適用**し、グループ内のすべてのサブスクリプションに**継承**させることができます。
* **10,000の管理**グループが単一のディレクトリでサポートされます。
* 管理グループツリーは**最大6レベルの深さ**をサポートできます。この制限にはルートレベルやサブスクリプションレベルは含まれません。
* 各管理グループとサブスクリプションは**1つの親**のみをサポートできます。
* 複数の管理グループを作成できる場合でも、**ルート管理グループは1つだけ**です。
* ルート管理グループは**すべての他の管理グループとサブスクリプションを含み**、**移動または削除することはできません**。
* 単一の管理グループ内のすべてのサブスクリプションは、**同じEntra IDテナントを信頼**しなければなりません。

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption><p><a href="https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png">https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png</a></p></figcaption></figure>

### Azureサブスクリプション

* これは、リソース（VM、DBなど）を実行し、請求される**論理コンテナ**です。
* その**親**は常に**管理グループ**であり（ルート管理グループであることも可能）、サブスクリプションは他のサブスクリプションを含むことはできません。
* **1つのEntra ID**ディレクトリのみを信頼します。
* サブスクリプションレベル（またはその親のいずれか）で適用された**権限**は、サブスクリプション内のすべてのリソースに**継承**されます。

### リソースグループ

[ドキュメントから:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) リソースグループは、Azureソリューションのための**関連リソース**を保持する**コンテナ**です。リソースグループには、ソリューションのすべてのリソースを含めることも、管理したい**リソースのみ**を含めることもできます。一般的に、**同じライフサイクル**を共有する**リソース**を同じリソースグループに追加することで、グループとして簡単に展開、更新、削除できます。

すべての**リソース**は**リソースグループ内**に存在し、1つのグループにのみ属し、リソースグループが削除されると、その中のすべてのリソースも削除されます。

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfe8U30iP_vdZCvxX4g8nEPRLoo7v0kmCGkDn1frBPn3_GIoZ7VT2LkdsVQWCnrG_HSYNRRPM-1pSECUkbDAB-9YbUYLzpvKVLDETZS81CHWKYM4fDl3oMo5-yvTMnjdLTS2pz8U67xUTIzBhZ25MFMRkq5koKY=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption><p><a href="https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1">https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1</a></p></figcaption></figure>

### AzureリソースID

Azureのすべてのリソースには、それを識別するAzureリソースIDがあります。

AzureリソースIDの形式は次のとおりです：

* `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderNamespace}/{resourceType}/{resourceName}`

サブスクリプションID `12345678-1234-1234-1234-123456789012` のリソースグループ `myResourceGroup` にある仮想マシン `myVM` のAzureリソースIDは次のようになります：

* `/subscriptions/12345678-1234-1234-1234-123456789012/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM`

## Azure vs Entra ID vs Azure ADドメインサービス

### Azure

Azureは、Microsoftの包括的な**クラウドコンピューティングプラットフォームであり、幅広いサービスを提供**しています。これには、仮想マシン、データベース、人工知能、ストレージが含まれます。Azureは、アプリケーションのホスティングと管理、スケーラブルなインフラストラクチャの構築、クラウドでの最新のワークロードの実行の基盤として機能します。Azureは、開発者やIT専門家がアプリケーションやサービスをシームレスに作成、展開、管理できるツールを提供し、スタートアップから大企業までさまざまなニーズに対応します。

### Entra ID（旧Azure Active Directory）

Entra IDは、認証、承認、ユーザーアクセス制御を処理するために設計されたクラウドベースの**アイデンティティおよびアクセス管理サービス**です。これは、Office 365、Azure、および多くのサードパーティのSaaSアプリケーションへの安全なアクセスを提供します。シングルサインオン（SSO）、多要素認証（MFA）、条件付きアクセスポリシーなどの機能を備えています。

### Entraドメインサービス（旧Azure AD DS）

Entraドメインサービスは、従来のWindows Active Directory環境と互換性のある**管理されたドメインサービスを提供することにより、Entra IDの機能を拡張します**。LDAP、Kerberos、NTLMなどのレガシープロトコルをサポートし、組織がオンプレミスのドメインコントローラーを展開せずに、古いアプリケーションをクラウドで移行または実行できるようにします。このサービスは、集中管理のためのグループポリシーもサポートしており、レガシーまたはADベースのワークロードが最新のクラウド環境と共存する必要があるシナリオに適しています。

## Entra IDプリンシパル

### ユーザー

* **新しいユーザー**
* 選択したテナントからのメール名とドメインを示す
* 表示名を示す
* パスワードを示す
* プロパティ（名、職名、連絡先情報など）を示す
* デフォルトのユーザータイプは「**メンバー**」
* **外部ユーザー**
* 招待するメールと表示名を示す（Microsoft以外のメールも可能）
* プロパティを示す
* デフォルトのユーザータイプは「**ゲスト**」

### ユーザーのデフォルト権限

* **メンバー（**[**ドキュメント**](https://learn.microsoft.com/en-gb/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions)**）**
* アプリケーションの登録: デフォルトは**はい**
* 非管理者ユーザーによるテナントの作成を制限: デフォルトは**いいえ**
* セキュリティグループの作成: デフォルトは**はい**
* Microsoft Entra管理ポータルへのアクセスを制限: デフォルトは**いいえ**
* これはポータルへのAPIアクセスを制限しません（ウェブのみ）
* ユーザーがLinkedInと仕事または学校のアカウントを接続できるようにする: デフォルトは**はい**
* ユーザーをサインインしたままにする: デフォルトは**はい**
* ユーザーが所有するデバイスのBitLockerキーを回復することを制限: デフォルトはいいえ（デバイス設定で確認）
* 他のユーザーを読む: デフォルトは**はい**（Microsoft Graph経由）
* **ゲスト**
* **ゲストユーザーアクセス制限**
* **ゲストユーザーはメンバーと同じアクセス権を持つ**ため、デフォルトでゲストユーザーにすべてのメンバー権限が付与されます。
* **ゲストユーザーはディレクトリオブジェクトのプロパティとメンバーシップへのアクセスが制限される（デフォルト）**ため、デフォルトで自分のユーザープロファイルのみへのアクセスが許可されます。他のユーザーやグループ情報へのアクセスは許可されません。
* **ゲストユーザーアクセスは自分のディレクトリオブジェクトのプロパティとメンバーシップに制限される**のが最も制限的です。
* **ゲストは招待できる**
* **組織内の誰でもゲストユーザーを招待できる（ゲストや非管理者を含む、最も包括的） - デフォルト**
* **メンバーユーザーおよび特定の管理ロールに割り当てられたユーザーは、メンバー権限を持つゲストを含むゲストユーザーを招待できます**
* **特定の管理ロールに割り当てられたユーザーのみがゲストユーザーを招待できます**
* **組織内の誰もゲストユーザーを招待できない（管理者を含む、最も制限的）**
* **外部ユーザーの退会**: デフォルトは**はい**
* 外部ユーザーが組織を退会できるようにする

{% hint style="success" %}
デフォルトで制限されていても、権限が付与されたユーザー（メンバーおよびゲスト）は、前述のアクションを実行できます。
{% endhint %}

### **サービスプリンシパル**

**サービスプリンシパル**は、**アプリケーション**、ホスティングサービス、および自動化ツールがAzureリソースにアクセスするために作成された**アイデンティティ**です。このアクセスは、サービスプリンシパルに割り当てられたロールによって**制限され**、**どのリソースにアクセスできるか**とそのレベルを制御できます。セキュリティ上の理由から、**ユーザーアイデンティティでログインさせるのではなく、自動化ツールとともにサービスプリンシパルを使用することを常に推奨します**。

サービスプリンシパルとして直接ログインすることも可能で、**シークレット**（パスワード）、**証明書**を生成するか、第三者プラットフォーム（例：Github Actions）への**フェデレーテッド**アクセスを付与することができます。

* **パスワード**認証を選択した場合（デフォルト）、**生成されたパスワードを保存**してください。再度アクセスすることはできません。
* 証明書認証を選択した場合、**アプリケーションが秘密鍵にアクセスできることを確認してください**。

### アプリ登録

**アプリ登録**は、アプリケーションがEntra IDと統合し、アクションを実行できるようにするための構成です。

#### 主要コンポーネント：

1. **アプリケーションID（クライアントID）**: Azure AD内のアプリの一意の識別子。
2. **リダイレクトURI**: Azure ADが認証応答を送信するURL。
3. **証明書、シークレット、フェデレーテッド資格情報**: アプリケーションのサービスプリンシパルとしてログインするためにシークレットまたは証明書を生成することができ、またはそれにフェデレーテッドアクセスを付与することができます（例：Github Actions）。&#x20;
1. **証明書**または**シークレット**が生成された場合、**アプリケーションID**、**シークレット**または**証明書**、および**テナント**（ドメインまたはID）を知っている人が**サービスプリンシパルとしてログイン**することができます。
4. **API権限**: アプリがアクセスできるリソースまたはAPIを指定します。
5. **認証設定**: アプリのサポートされている認証フローを定義します（例：OAuth2、OpenID Connect）。
6. **サービスプリンシパル**: アプリが作成されると（ウェブコンソールから行われた場合）、サービスプリンシパルが作成されます。または新しいテナントにインストールされると作成されます。
1. **サービスプリンシパル**は、構成されたすべての要求された権限を取得します。

### エンタープライズアプリケーション

これは、サービスプリンシパルをフィルタリングし、割り当てられたアプリケーションを確認するための**Azure内のテーブル**です。

**「エンタープライズアプリケーション」という別のタイプの「アプリケーション」ではありません**。Azure内に「エンタープライズアプリケーション」というオブジェクトは存在せず、サービスプリンシパル、アプリ登録、および管理されたアイデンティティを確認するための抽象化に過ぎません。

### **管理されたアイデンティティ（メタデータ）**

Azure Active Directoryの管理されたアイデンティティは、アプリケーションの**アイデンティティを自動的に管理する**ためのソリューションを提供します。これらのアイデンティティは、Azure Active Directory（**Azure AD**）認証と互換性のある**リソース**に接続するためにアプリケーションによって使用されます。これにより、アプリケーションは**メタデータ**サービスに連絡して、Azure内の指定された管理されたアイデンティティとして**アクションを実行する**ための有効なトークンを取得できるため、クラウド資格情報をコードにハードコーディングする必要がなくなります。

管理されたアイデンティティには2つのタイプがあります：

* **システム割り当て**。一部のAzureサービスでは、**サービスインスタンスに直接管理されたアイデンティティを有効にする**ことができます。システム割り当ての管理されたアイデンティティを有効にすると、リソースが存在するサブスクリプションによって信頼されるEntra IDテナントに**サービスプリンシパル**が作成されます。**リソース**が**削除されると**、Azureは自動的に**アイデンティティ**を削除します。
* **ユーザー割り当て**。ユーザーが管理されたアイデンティティを生成することも可能です。これらは、サブスクリプション内のリソースグループ内に作成され、サブスクリプションによって信頼されるEntra IDにサービスプリンシパルが作成されます。その後、管理されたアイデンティティを1つまたは**複数のAzureサービスのインスタンス**（複数のリソース）に割り当てることができます。ユーザー割り当ての管理されたアイデンティティの場合、**アイデンティティはそれを使用するリソースとは別に管理されます**。

管理されたアイデンティティは、サービスプリンシパルに付随する**永続的な資格情報**（パスワードや証明書など）を生成しません。

### デフォルトの同意権限

**アプリケーションに対するユーザーの同意**

* **ユーザーの同意を許可しない**
* すべてのアプリに対して管理者が必要です。
* **確認された発行者からのアプリに対するユーザーの同意を許可し、選択された権限（推奨）**
* すべてのユーザーは、「低影響」と分類された権限に同意でき、確認された発行者からのアプリやこの組織に登録されたアプリに対して同意できます。
* **デフォルト**の低影響権限（ただし、低影響として追加するには同意が必要）：
* User.Read - サインインしてユーザープロファイルを読み取る
* offline\_access - ユーザーがアクセスを許可したデータへのアクセスを維持する
* openid - ユーザーをサインインさせる
* profile - ユーザーの基本プロファイルを表示する
* email - ユーザーのメールアドレスを表示する
* **アプリに対するユーザーの同意を許可する（デフォルト）**
* すべてのユーザーは、組織のデータにアクセスするために任意のアプリに同意できます。

**管理者の同意要求**: デフォルトは**いいえ**

* ユーザーは、同意できないアプリに対して管理者の同意を要求できます。
* **はい**の場合: 同意要求を行うことができるユーザー、グループ、ロールを指定できます。
* ユーザーがメール通知や期限切れのリマインダーを受け取るかどうかも設定します&#x20;

### 管理ユニット

[ドキュメントから:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) 管理ユニットを使用すると、組織を**任意のユニット**に**細分化**し、特定の管理者を**割り当てる**ことができます。これにより、そのユニットのメンバーのみを管理できます。たとえば、大規模な大学の各学校の管理者に権限を委任するために管理ユニットを使用し、彼らがアクセスを制御し、ユーザーを管理し、工学部内でのみポリシーを設定できるようにすることができます。

したがって、**管理ユニット**は**メンバー**を**含む**ことができ、他の**プリンシパル**はその管理ユニットに対して**権限を割り当てられ**、その権限を使用して管理ユニットのメンバーを**管理**できます。

## ロールと権限

**ロール**は、**プリンシパル**に**スコープ**で**割り当てられます**: `principal -[HAS ROLE]->(scope)`

**グループ**に割り当てられた**ロール**は、グループのすべての**メンバー**に**継承**されます。

ロールが割り当てられたスコープに応じて、**ロール**はスコープコンテナ内の**他のリソース**に**継承**される可能性があります。たとえば、ユーザーAが**サブスクリプション**にロールを持っている場合、彼はその**サブスクリプション内のすべてのリソースグループ**および**リソースグループ内のすべてのリソース**にその**ロール**を持ちます。

### **クラシックロール**

| **オーナー**                     | <ul><li>すべてのリソースへの完全なアクセス</li><li>他のユーザーのアクセスを管理できる</li></ul> | すべてのリソースタイプ |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **寄稿者**               | <ul><li>すべてのリソースへの完全なアクセス</li><li>アクセスを管理できない</li></ul>              | すべてのリソースタイプ |
| **リーダー**                    | • すべてのリソースを表示                                                                     | すべてのリソースタイプ |
| **ユーザーアクセス管理者** | <ul><li>すべてのリソースを表示</li><li>他のユーザーのアクセスを管理できる</li></ul>           | すべてのリソースタイプ |

### ビルトインロール

[ドキュメントから: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azureロールベースアクセス制御（Azure RBAC）](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview)には、**ユーザー、グループ、サービスプリンシパル、および管理されたアイデンティティ**に**割り当てることができる**いくつかのAzureの**ビルトインロール**があります。ロールの割り当ては、**Azureリソースへのアクセスを制御する方法**です。ビルトインロールが組織の特定のニーズを満たさない場合は、独自の[**Azureカスタムロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**を作成できます。**

**ビルトイン**ロールは、**意図されたリソース**にのみ適用されます。たとえば、次の2つの**ビルトインロール**の例を確認してください：

| [ディスクバックアップリーダー](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | ディスクバックアップを実行するためにバックアップボールトへの権限を提供します。      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [仮想マシンユーザーログイン](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | ポータルで仮想マシンを表示し、通常のユーザーとしてログインします。 | fb879df8-f326-4884-b1cf-06f3ad86be52 |

これらのロールは、**論理コンテナ**（管理グループ、サブスクリプション、リソースグループなど）にも**割り当てることができ**、影響を受けるプリンシパルは**それらのコンテナ内のリソースに対して**持ちます。

* ここに[**すべてのAzureビルトインロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)のリストがあります。
* ここに[**すべてのAzure ADビルトインロール**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference)のリストがあります。

### カスタムロール

Azureは、ユーザーが必要とする権限を持つ[**カスタムロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)を作成することも許可します。

### 権限拒否

* **プリンシパルがリソースに対してアクセス権を持つためには**、明示的なロールが付与される必要があります（いずれにせよ）**その権限を付与します**。
* 明示的な**拒否ロールの割り当ては**、権限を付与するロールよりも優先されます。

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### グローバル管理者

グローバル管理者ロールを持つユーザーは、**ルート管理グループに対してユーザーアクセス管理者Azureロールに「昇格」する能力**を持っています。これは、グローバル管理者が**すべてのAzureサブスクリプションと管理グループのアクセスを管理できる**ことを意味します。\
この昇格は、ページの下部で行うことができます: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Azureポリシー

Azureポリシーは、Microsoft Azureの**ルールと規制のセット**であり、組織の基準を管理および強制し、スケールでのコンプライアンスを評価するのに役立ちます。これらのポリシーは、**Azureリソース**に対してさまざまなルールを強制し、これらのリソースが企業の基準やサービスレベル契約に準拠し続けることを保証します。

Azureポリシーは、クラウドガバナンスとセキュリティにとって重要であり、リソースが適切かつ効率的に使用され、外部規制や内部ポリシーに準拠していることを保証するのに役立ちます。\
いくつかの例：

1. **特定のAzureリージョンへのコンプライアンスの確保**: このポリシーは、すべてのリソースが特定のAzureリージョンにデプロイされることを保証します。たとえば、企業はGDPRコンプライアンスのためにすべてのデータがヨーロッパに保存されることを望むかもしれません。
2. **命名基準の強制**: ポリシーは、Azureリソースの命名規則を強制できます。これにより、大規模な環境でリソースを整理し、名前に基づいて簡単に識別できるようになります。
3. **特定のリソースタイプの制限**: このポリシーは、特定のタイプのリソースの作成を制限できます。たとえば、コストを制御するために、特定のVMサイズのような高価なリソースタイプの作成を防ぐポリシーを設定できます。
4. **タグ付けポリシーの強制**: タグは、リソース管理に使用されるAzureリソースに関連付けられたキーと値のペアです。ポリシーは、特定のタグがすべてのリソースに存在する必要がある、または特定の値を持つ必要があることを強制できます。これは、コスト追跡、所有権、またはリソースの分類に役立ちます。
5. **リソースへのパブリックアクセスの制限**: ポリシーは、ストレージアカウントやデータベースなどの特定のリソースにパブリックエンドポイントがないことを強制し、組織のネットワーク内でのみアクセスできるようにします。
6. **セキュリティ設定の自動適用**: ポリシーは、すべてのVMに特定のネットワークセキュリティグループを適用したり、すべてのストレージアカウントが暗号化を使用することを保証したりするなど、リソースにセキュリティ設定を自動的に適用するために使用できます。

Azureポリシーは、Azure階層の任意のレベルに添付できますが、**通常はルート管理グループ**または他の管理グループで使用されます。

### 権限スコープ

Azureでは、**権限は階層の任意の部分に割り当てることができます**。これには、管理グループ、サブスクリプション、リソースグループ、個々のリソースが含まれます。権限は、割り当てられたエンティティの**含まれるリソース**によって**継承**されます。

この階層構造により、アクセス権限の効率的かつスケーラブルな管理が可能になります。

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC**（ロールベースアクセス制御）は、前のセクションで見たものです：**リソースに対するアクセスを付与するためにプリンシパルにロールを割り当てる**。\
ただし、場合によっては、**より細かいアクセス管理**を提供したり、**数百の**ロール**割り当ての管理を簡素化**したい場合があります。

Azure **ABAC**（属性ベースアクセス制御）は、特定のアクションのコンテキスト内での**属性に基づくロール割り当て条件**を追加することによってAzure RBACを拡張します。_ロール割り当て条件_は、**ロール割り当てにオプションで追加できる追加のチェック**であり、より細かいアクセス制御を提供します。条件は、ロール定義とロール割り当ての一部として付与される権限をフィルタリングします。たとえば、**オブジェクトを読み取るために特定のタグを持つ必要がある条件を追加できます**。\
条件を使用して特定のリソースへのアクセスを明示的に**拒否することはできません**。

### デフォルトのユーザー権限

基本的なユーザーは、AzureADの一部を列挙するためのいくつかの**デフォルト権限**を持ちます：

* すべてのユーザー、グループ、アプリケーション、デバイス、ロール、サブスクリプション、およびその公開プロパティを読み取る
* ゲストを招待する（_オフにすることができます_）
* セキュリティグループを作成する
* 非隠しグループメンバーシップを読み取る
* 所有するグループにゲストを追加する
* 新しいアプリケーションを作成する（_オフにすることができます_）
* Azureに最大50デバイスを追加する（_オフにすることができます_）

ユーザーの**デフォルト権限の完全なリスト**は[こちらのドキュメント](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions)で確認できます。さらに、そのリストには**ゲストのデフォルト権限リスト**も表示されます。

{% hint style="info" %}
Azureリソースを列挙するには、ユーザーが明示的にその権限を付与される必要があることを忘れないでください。
{% endhint %}

### 特権アイデンティティ管理（PIM）

Azureの特権アイデンティティ管理（PIM）は、Azure Active DirectoryおよびAzureにおける特権アクセスを**管理、制御、監視**するツールです。これは、**必要なときに必要な期間だけ特権アクセスを提供し、承認ワークフローを強制し、追加の認証を要求することによって**セキュリティを強化します。このアプローチは、特権が必要なときにのみ付与されることを保証することによって、無許可のアクセスのリスクを最小限に抑えます。

## 認証トークン

OIDCで使用される**3種類のトークン**があります：

* [**アクセストークン**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** クライアントはこのトークンをリソースサーバーに提示して**リソースにアクセス**します。これは、特定のユーザー、クライアント、およびリソースの組み合わせにのみ使用でき、**期限切れまで取り消すことはできません** - デフォルトでは1時間です。これを使用する検出は低いです。
* **IDトークン**: クライアントはこの**トークンを認証サーバーから受け取ります**。これは、ユーザーに関する基本情報を含みます。これは、**特定のユーザーとクライアントの組み合わせにバインドされています**。
* **リフレッシュトークン**: アクセストークンとともにクライアントに提供されます。新しいアクセストークンとIDトークンを取得するために使用されます。これは、特定のユーザーとクライアントの組み合わせにバインドされ、取り消すことができます。デフォルトの期限は、非アクティブなリフレッシュトークンで**90日**、アクティブなトークンには**期限がありません**。

{% hint style="warning" %}
**条件付きアクセス**に関する情報は**JWT**内に**保存**されます。したがって、**許可されたIPアドレスからトークンを要求**すると、その**IP**がトークンに**保存**され、その後、**許可されていないIPからリソースにアクセスするためにそのトークンを使用できます**。
{% endhint %}

以下のページを確認して、**アクセストークンを要求するさまざまな方法**とそれを使用してログインする方法を学んでください：

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

最も一般的なAPIエンドポイントは次のとおりです：

* **Azureリソースマネージャー**（ARM）: management.azure.com
* **Microsoft Graph**: graph.microsoft.com（非推奨のAzure AD Graphはgraph.windows.net）

## 参考文献

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)
* [https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration](https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
