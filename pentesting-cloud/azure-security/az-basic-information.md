# Az - Informaci√≥n B√°sica

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Jerarqu√≠a de Organizaci√≥n

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUchBvhjIdWWR2ldAkWiZMdmrcEYD9Ti5UAa3zAGr9YbAnx4Q_gZNp_zvOU429vgWZ_ixoYHQKdC8bGgkhWYCy591SRIFj6RKCj4BEpVQixAGsp3T3O5sS3k7x5CTaJ-SCBNC7i5KluLyxdiXoZsH1F0ko1Gv88=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption></figcaption></figure>

### Grupos de Gesti√≥n

* Puede contener **otros grupos de gesti√≥n o suscripciones**.
* Esto permite **aplicar controles de gobernanza** como RBAC y Azure Policy una vez a nivel de grupo de gesti√≥n y que sean **heredados** por todas las suscripciones en el grupo.
* Se pueden soportar **10,000 grupos de gesti√≥n** en un solo directorio.
* Un √°rbol de grupos de gesti√≥n puede soportar **hasta seis niveles de profundidad**. Este l√≠mite no incluye el nivel ra√≠z o el nivel de suscripci√≥n.
* Cada grupo de gesti√≥n y suscripci√≥n puede soportar **solo un padre**.
* Aunque se pueden crear varios grupos de gesti√≥n, **solo hay 1 grupo de gesti√≥n ra√≠z**.
* El grupo de gesti√≥n ra√≠z **contiene** todos los **otros grupos de gesti√≥n y suscripciones** y **no puede ser movido o eliminado**.
* Todas las suscripciones dentro de un solo grupo de gesti√≥n deben confiar en el **mismo inquilino de Entra ID.**

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption><p><a href="https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png">https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png</a></p></figcaption></figure>

### Suscripciones de Azure

* Es otro **contenedor l√≥gico donde se pueden ejecutar recursos** (VMs, DBs‚Ä¶) y se facturar√°.
* Su **padre** es siempre un **grupo de gesti√≥n** (y puede ser el grupo de gesti√≥n ra√≠z) ya que las suscripciones no pueden contener otras suscripciones.
* **Conf√≠a en un solo directorio de Entra ID**
* **Los permisos** aplicados a nivel de suscripci√≥n (o cualquiera de sus padres) son **heredados** a todos los recursos dentro de la suscripci√≥n.

### Grupos de Recursos

[De la documentaci√≥n:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Un grupo de recursos es un **contenedor** que alberga **recursos relacionados** para una soluci√≥n de Azure. El grupo de recursos puede incluir todos los recursos para la soluci√≥n, o solo aquellos **recursos que deseas gestionar como un grupo**. Generalmente, agrega **recursos** que comparten el **mismo ciclo de vida** al mismo grupo de recursos para que puedas desplegarlos, actualizarlos y eliminarlos f√°cilmente como un grupo.

Todos los **recursos** deben estar **dentro de un grupo de recursos** y solo pueden pertenecer a un grupo y si se elimina un grupo de recursos, todos los recursos dentro de √©l tambi√©n se eliminan.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfe8U30iP_vdZCvxX4g8nEPRLoo7v0kmCGkDn1frBPn3_GIoZ7VT2LkdsVQWCnrG_HSYNRRPM-1pSECUkbDAB-9YbUYLzpvKVLDETZS81CHWKYM4fDl3oMo5-yvTMnjdLTS2pz8U67xUTIzBhZ25MFMRkq5koKY=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption><p><a href="https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1">https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1</a></p></figcaption></figure>

### IDs de Recursos de Azure

Cada recurso en Azure tiene un ID de Recurso de Azure que lo identifica.

El formato de un ID de Recurso de Azure es el siguiente:

* `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderNamespace}/{resourceType}/{resourceName}`

Para una m√°quina virtual llamada myVM en un grupo de recursos `myResourceGroup` bajo el ID de suscripci√≥n `12345678-1234-1234-1234-123456789012`, el ID de Recurso de Azure se ve as√≠:

* `/subscriptions/12345678-1234-1234-1234-123456789012/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM`

## Azure vs Entra ID vs Servicios de Dominio de Azure AD

### Azure

Azure es la **plataforma de computaci√≥n en la nube integral de Microsoft, que ofrece una amplia gama de servicios**, incluyendo m√°quinas virtuales, bases de datos, inteligencia artificial y almacenamiento. Act√∫a como la base para alojar y gestionar aplicaciones, construir infraestructuras escalables y ejecutar cargas de trabajo modernas en la nube. Azure proporciona herramientas para desarrolladores y profesionales de TI para crear, desplegar y gestionar aplicaciones y servicios sin problemas, atendiendo a una variedad de necesidades desde startups hasta grandes empresas.

### Entra ID (anteriormente Azure Active Directory)

Entra ID es un servicio de **gesti√≥n de identidad y acceso basado en la nube** dise√±ado para manejar la autenticaci√≥n, autorizaci√≥n y control de acceso de usuarios. Permite el acceso seguro a servicios de Microsoft como Office 365, Azure y muchas aplicaciones SaaS de terceros. Con caracter√≠sticas como inicio de sesi√≥n √∫nico (SSO), autenticaci√≥n multifactor (MFA) y pol√≠ticas de acceso condicional, entre otras.

### Servicios de Dominio de Entra (anteriormente Azure AD DS)

Los Servicios de Dominio de Entra extienden las capacidades de Entra ID al ofrecer **servicios de dominio gestionados compatibles con entornos tradicionales de Windows Active Directory**. Soporta protocolos heredados como LDAP, Kerberos y NTLM, permitiendo a las organizaciones migrar o ejecutar aplicaciones m√°s antiguas en la nube sin desplegar controladores de dominio locales. Este servicio tambi√©n soporta Pol√≠ticas de Grupo para gesti√≥n centralizada, haci√©ndolo adecuado para escenarios donde cargas de trabajo heredadas o basadas en AD necesitan coexistir con entornos modernos en la nube.

## Principales de Entra ID

### Usuarios

* **Nuevos usuarios**
* Indicar nombre de correo y dominio del inquilino seleccionado
* Indicar nombre para mostrar
* Indicar contrase√±a
* Indicar propiedades (nombre, t√≠tulo del trabajo, informaci√≥n de contacto‚Ä¶)
* El tipo de usuario predeterminado es ‚Äú**miembro**‚Äù
* **Usuarios externos**
* Indicar correo para invitar y nombre para mostrar (puede ser un correo no Microsoft)
* Indicar propiedades
* El tipo de usuario predeterminado es ‚Äú**Invitado**‚Äù

### Permisos Predeterminados para Miembros e Invitados

Puedes consultarlos en [https://learn.microsoft.com/en-us/entra/fundamentals/users-default-permissions](https://learn.microsoft.com/en-us/entra/fundamentals/users-default-permissions) pero entre otras acciones, un miembro podr√°:

* Leer todos los usuarios, Grupos, Aplicaciones, Dispositivos, Roles, Suscripciones y sus propiedades p√∫blicas
* Invitar Invitados (_se puede desactivar_)
* Crear grupos de seguridad
* Leer membres√≠as de grupos no ocultos
* Agregar invitados a grupos de propiedad
* Crear nuevas aplicaciones (_se puede desactivar_)
* Agregar hasta 50 dispositivos a Azure (_se puede desactivar_)

{% hint style="info" %}
Recuerda que para enumerar recursos de Azure, el usuario necesita un otorgamiento expl√≠cito del permiso.
{% endhint %}

### Permisos Configurables Predeterminados para Usuarios

* **Miembros (**[**docs**](https://learn.microsoft.com/en-gb/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions)**)**
* Registrar Aplicaciones: Predeterminado **S√≠**
* Restringir a usuarios no administradores de crear inquilinos: Predeterminado **No**
* Crear grupos de seguridad: Predeterminado **S√≠**
* Restringir el acceso al portal de administraci√≥n de Microsoft Entra: Predeterminado **No**
* Esto no restringe el acceso a la API del portal (solo web)
* Permitir a los usuarios conectar cuentas de trabajo o escolares con LinkedIn: Predeterminado **S√≠**
* Mostrar mantener al usuario conectado: Predeterminado **S√≠**
* Restringir a los usuarios de recuperar la(s) clave(s) de BitLocker para sus dispositivos: Predeterminado No (ver en Configuraci√≥n del Dispositivo)
* Leer otros usuarios: Predeterminado **S√≠** (a trav√©s de Microsoft Graph)
* **Invitados**
* **Restricciones de acceso para usuarios invitados**
* **Los usuarios invitados tienen el mismo acceso que los miembros** otorga todos los permisos de usuario miembro a los usuarios invitados por defecto.
* **Los usuarios invitados tienen acceso limitado a propiedades y membres√≠as de objetos de directorio (predeterminado)** restringe el acceso de invitados solo a su propio perfil de usuario por defecto. El acceso a informaci√≥n de otros usuarios y grupos ya no est√° permitido.
* **El acceso de los usuarios invitados est√° restringido a propiedades y membres√≠as de sus propios objetos de directorio** es el m√°s restrictivo.
* **Los invitados pueden invitar**
* **Cualquiera en la organizaci√≥n puede invitar a usuarios invitados, incluidos invitados y no administradores (el m√°s inclusivo) - Predeterminado**
* **Los usuarios miembros y los usuarios asignados a roles de administrador espec√≠ficos pueden invitar a usuarios invitados, incluidos invitados con permisos de miembro**
* **Solo los usuarios asignados a roles de administrador espec√≠ficos pueden invitar a usuarios invitados**
* **Nadie en la organizaci√≥n puede invitar a usuarios invitados, incluidos administradores (el m√°s restrictivo)**
* **Los usuarios externos pueden salir**: Predeterminado **Verdadero**
* Permitir a los usuarios externos salir de la organizaci√≥n

{% hint style="success" %}
Incluso si est√°n restringidos por defecto, los usuarios (miembros e invitados) con permisos otorgados podr√≠an realizar las acciones anteriores.
{% endhint %}

### **Grupos**

Hay **2 tipos de grupos**:

* **Seguridad**: Este tipo de grupo se utiliza para dar acceso a los miembros a aplicaciones, recursos y asignar licencias. Los usuarios, dispositivos, principales de servicio y otros grupos pueden ser miembros.
* **Microsoft 365**: Este tipo de grupo se utiliza para la colaboraci√≥n, dando acceso a los miembros a un buz√≥n compartido, calendario, archivos, sitio de SharePoint, etc. Los miembros del grupo solo pueden ser usuarios.
* Esto tendr√° una **direcci√≥n de correo electr√≥nico** con el dominio del inquilino de EntraID.

Hay **2 tipos de membres√≠as**:

* **Asignada**: Permite agregar manualmente miembros espec√≠ficos a un grupo.
* **Membres√≠a din√°mica**: Gestiona autom√°ticamente la membres√≠a utilizando reglas, actualizando la inclusi√≥n del grupo cuando cambian los atributos de los miembros.

### **Principales de Servicio**

Un **Principal de Servicio** es una **identidad** creada para **uso** con **aplicaciones**, servicios alojados y herramientas automatizadas para acceder a recursos de Azure. Este acceso est√° **restringido por los roles asignados** al principal de servicio, d√°ndote control sobre **qu√© recursos pueden ser accedidos** y a qu√© nivel. Por razones de seguridad, siempre se recomienda **usar principales de servicio con herramientas automatizadas** en lugar de permitirles iniciar sesi√≥n con una identidad de usuario.

Es posible **iniciar sesi√≥n directamente como un principal de servicio** gener√°ndole un **secreto** (contrase√±a), un **certificado**, o otorgando acceso **federado** a plataformas de terceros (por ejemplo, Github Actions) sobre √©l.

* Si eliges la autenticaci√≥n por **contrase√±a** (por defecto), **guarda la contrase√±a generada** ya que no podr√°s acceder a ella nuevamente.
* Si eliges la autenticaci√≥n por certificado, aseg√∫rate de que la **aplicaci√≥n tenga acceso sobre la clave privada**.

### Registraciones de Aplicaciones

Una **Registraci√≥n de Aplicaci√≥n** es una configuraci√≥n que permite a una aplicaci√≥n integrarse con Entra ID y realizar acciones.

#### Componentes Clave:

1. **ID de Aplicaci√≥n (Client ID):** Un identificador √∫nico para tu aplicaci√≥n en Azure AD.
2. **URIs de Redirecci√≥n:** URLs donde Azure AD env√≠a respuestas de autenticaci√≥n.
3. **Certificados, Secretos y Credenciales Federadas:** Es posible generar un secreto o un certificado para iniciar sesi√≥n como el principal de servicio de la aplicaci√≥n, o para otorgar acceso federado a ella (por ejemplo, Github Actions).&#x20;
1. Si se genera un **certificado** o **secreto**, es posible que una persona **inicie sesi√≥n como el principal de servicio** con herramientas CLI al conocer el **ID de aplicaci√≥n**, el **secreto** o **certificado** y el **inquilino** (dominio o ID).
4. **Permisos de API:** Especifica qu√© recursos o APIs puede acceder la aplicaci√≥n.
5. **Configuraciones de Autenticaci√≥n:** Define los flujos de autenticaci√≥n soportados por la aplicaci√≥n (por ejemplo, OAuth2, OpenID Connect).
6. **Principal de Servicio**: Un principal de servicio se crea cuando se crea una Aplicaci√≥n (si se hace desde la consola web) o cuando se instala en un nuevo inquilino.
1. El **principal de servicio** obtendr√° todos los permisos solicitados con los que fue configurado.

### Permisos de Consentimiento Predeterminados

**Consentimiento del usuario para aplicaciones**

* **No permitir el consentimiento del usuario**
* Se requerir√° un administrador para todas las aplicaciones.
* **Permitir el consentimiento del usuario para aplicaciones de editores verificados, para permisos seleccionados (Recomendado)**
* Todos los usuarios pueden consentir permisos clasificados como "bajo impacto", para aplicaciones de editores verificados o aplicaciones registradas en esta organizaci√≥n.
* **Permisos de bajo impacto predeterminados** (aunque necesitas aceptar para agregarlos como bajos):
* User.Read - iniciar sesi√≥n y leer el perfil del usuario
* offline\_access - mantener acceso a datos a los que los usuarios le han dado acceso
* openid - iniciar sesi√≥n a los usuarios
* profile - ver el perfil b√°sico del usuario
* email - ver la direcci√≥n de correo electr√≥nico del usuario
* **Permitir el consentimiento del usuario para aplicaciones (Predeterminado)**
* Todos los usuarios pueden consentir que cualquier aplicaci√≥n acceda a los datos de la organizaci√≥n.

**Solicitudes de consentimiento de administrador**: Predeterminado **No**

* Los usuarios pueden solicitar consentimiento de administrador para aplicaciones a las que no pueden consentir
* Si **S√≠**: Es posible indicar Usuarios, Grupos y Roles que pueden consentir solicitudes
* Configura tambi√©n si los usuarios recibir√°n notificaciones por correo electr√≥nico y recordatorios de expiraci√≥n&#x20;

### **Identidad Administrada (Metadatos)**

Las identidades administradas en Azure Active Directory ofrecen una soluci√≥n para **gestionar autom√°ticamente la identidad** de las aplicaciones. Estas identidades son utilizadas por las aplicaciones con el prop√≥sito de **conectarse** a **recursos** compatibles con la autenticaci√≥n de Azure Active Directory (**Azure AD**). Esto permite **eliminar la necesidad de codificar credenciales en la nube** en el c√≥digo, ya que la aplicaci√≥n podr√° contactar el servicio de **metadatos** para obtener un token v√°lido para **realizar acciones** como la identidad administrada indicada en Azure.

Hay dos tipos de identidades administradas:

* **Asignada por el sistema**. Algunos servicios de Azure permiten **habilitar una identidad administrada directamente en una instancia de servicio**. Cuando habilitas una identidad administrada asignada por el sistema, se crea un **principal de servicio** en el inquilino de Entra ID confiado por la suscripci√≥n donde se encuentra el recurso. Cuando se **elimina el recurso**, Azure autom√°ticamente **elimina** la **identidad** por ti.
* **Asignada por el usuario**. Tambi√©n es posible que los usuarios generen identidades administradas. Estas se crean dentro de un grupo de recursos dentro de una suscripci√≥n y se crear√° un principal de servicio en el EntraID confiado por la suscripci√≥n. Luego, puedes asignar la identidad administrada a una o **m√°s instancias** de un servicio de Azure (m√∫ltiples recursos). Para identidades administradas asignadas por el usuario, la **identidad se gestiona por separado de los recursos que la utilizan**.

Las Identidades Administradas **no generan credenciales eternas** (como contrase√±as o certificados) para acceder como el principal de servicio adjunto a ella.

### Aplicaciones Empresariales

Es solo una **tabla en Azure para filtrar principales de servicio** y verificar las aplicaciones que se les han asignado.

**No es otro tipo de ‚Äúaplicaci√≥n‚Äù,** no hay ning√∫n objeto en Azure que sea una ‚ÄúAplicaci√≥n Empresarial‚Äù, es solo una abstracci√≥n para verificar los Principales de Servicio, Registraciones de Aplicaciones e identidades administradas.

### Unidades Administrativas

Las unidades administrativas permiten **dar permisos de un rol sobre una porci√≥n espec√≠fica de una organizaci√≥n**.

Ejemplo:

* Escenario: Una empresa quiere que los administradores de TI regionales gestionen solo a los usuarios en su propia regi√≥n.
* Implementaci√≥n:
* Crear Unidades Administrativas para cada regi√≥n (por ejemplo, "AU de Am√©rica del Norte", "AU de Europa").
* Poblaci√≥n de AUs con usuarios de sus respectivas regiones.
* Las AUs pueden **contener usuarios, grupos o dispositivos**
* Las AUs soportan **membres√≠as din√°micas**
* Las AUs **no pueden contener AUs**
* Asignar Roles de Administrador:
* Otorgar el rol de "Administrador de Usuarios" al personal de TI regional, limitado a la AU de su regi√≥n.
* Resultado: Los administradores de TI regionales pueden gestionar cuentas de usuario dentro de su regi√≥n sin afectar a otras regiones.

### Roles de Entra ID

* Para gestionar Entra ID hay algunos **roles integrados** que pueden ser asignados a principales de Entra ID para gestionar Entra ID
* Revisa los roles en [https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/permissions-reference](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/permissions-reference)
* El rol m√°s privilegiado es **Administrador Global**
* En la descripci√≥n del rol es posible ver sus **permisos granulares**

## Roles y Permisos

**Los roles** son **asignados** a **principales** en un **alcance**: `principal -[HAS ROLE]->(scope)`

**Los roles** asignados a **grupos** son **heredados** por todos los **miembros** del grupo.

Dependiendo del alcance al que se asign√≥ el rol, el **rol** podr√≠a ser **heredado** a **otros recursos** dentro del contenedor de alcance. Por ejemplo, si un usuario A tiene un **rol en la suscripci√≥n**, tendr√° ese **rol en todos los grupos de recursos** dentro de la suscripci√≥n y en **todos los recursos** dentro del grupo de recursos.

### **Roles Cl√°sicos**

| **Propietario**                     | <ul><li>Acceso total a todos los recursos</li><li>Puede gestionar el acceso para otros usuarios</li></ul> | Todos los tipos de recursos |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Colaborador**               | <ul><li>Acceso total a todos los recursos</li><li>No puede gestionar el acceso</li></ul>              | Todos los tipos de recursos |
| **Lector**                    | ‚Ä¢ Ver todos los recursos                                                                     | Todos los tipos de recursos |
| **Administrador de Acceso de Usuario** | <ul><li>Ver todos los recursos</li><li>Puede gestionar el acceso para otros usuarios</li></ul>           | Todos los tipos de recursos |

### Roles Integrados

[De la documentaci√≥n: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[El control de acceso basado en roles de Azure (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) tiene varios **roles integrados de Azure** que puedes **asignar** a **usuarios, grupos, principales de servicio e identidades administradas**. Las asignaciones de roles son la forma en que controlas **el acceso a los recursos de Azure**. Si los roles integrados no satisfacen las necesidades espec√≠ficas de tu organizaci√≥n, puedes crear tus propios [**roles personalizados de Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

Los roles **integrados** se aplican solo a los **recursos** para los que est√°n **destinados**, por ejemplo, revisa estos 2 ejemplos de **roles integrados sobre recursos de C√≥mputo**:

| [Lector de Copia de Seguridad de Disco](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Proporciona permiso al cofre de copia de seguridad para realizar copias de seguridad de disco.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Inicio de Sesi√≥n de Usuario de M√°quina Virtual](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Ver M√°quinas Virtuales en el portal e iniciar sesi√≥n como un usuario regular. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Estos roles tambi√©n pueden **ser asignados sobre contenedores l√≥gicos** (como grupos de gesti√≥n, suscripciones y grupos de recursos) y los principales afectados los tendr√°n **sobre los recursos dentro de esos contenedores**.

* Encuentra aqu√≠ una lista con [**todos los roles integrados de Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Encuentra aqu√≠ una lista con [**todos los roles integrados de Entra ID**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Roles Personalizados

* Tambi√©n es posible crear [**roles personalizados**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)
* Se crean dentro de un alcance, aunque un rol puede estar en varios alcances (grupos de gesti√≥n, suscripci√≥n y grupos de recursos)
* Es posible configurar todos los permisos granulares que tendr√° el rol personalizado
* Es posible excluir permisos
* Un principal con un permiso excluido no podr√° usarlo incluso si el permiso se otorga en otro lugar
* Es posible usar comodines
* El formato utilizado es un JSON
* `actions` son para controlar acciones sobre el recurso
* `dataActions` son permisos sobre los datos dentro del objeto

Ejemplo de JSON de permisos para un rol personalizado:
```json
{
"properties": {
"roleName": "",
"description": "",
"assignableScopes": [
"/subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f"
],
"permissions": [
{
"actions": [
"Microsoft.DigitalTwins/register/action",
"Microsoft.DigitalTwins/unregister/action",
"Microsoft.DigitalTwins/operations/read",
"Microsoft.DigitalTwins/digitalTwinsInstances/read",
"Microsoft.DigitalTwins/digitalTwinsInstances/write",
"Microsoft.CostManagement/exports/*"
],
"notActions": [
"Astronomer.Astro/register/action",
"Astronomer.Astro/unregister/action",
"Astronomer.Astro/operations/read",
"Astronomer.Astro/organizations/read"
],
"dataActions": [],
"notDataActions": []
}
]
}
}
```
### Orden de permisos

* Para que un **principal tenga acceso a un recurso**, necesita que se le otorgue un rol expl√≠cito (de cualquier manera) **que le otorgue ese permiso**.
* Una **asignaci√≥n de rol de denegaci√≥n expl√≠cita tiene prioridad** sobre el rol que otorga el permiso.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption><p><a href="https://link.springer.com/chapter/10.1007/978-1-4842-7325-8_10">https://link.springer.com/chapter/10.1007/978-1-4842-7325-8_10</a></p></figcaption></figure>

### Administrador Global

El Administrador Global es un rol de Entra ID que otorga **control total sobre el inquilino de Entra ID**. Sin embargo, no otorga permisos sobre los recursos de Azure por defecto.

Los usuarios con el rol de Administrador Global tienen la capacidad de '**elevar' a Administrador de Acceso de Usuario en el Grupo de Gesti√≥n Ra√≠z de Azure**. Por lo tanto, los Administradores Globales pueden gestionar el acceso en **todas las suscripciones y grupos de gesti√≥n de Azure.**\
Esta elevaci√≥n se puede hacer al final de la p√°gina: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/Properties)

<figure><img src="../../.gitbook/assets/image (349).png" alt=""><figcaption></figcaption></figure>

### Pol√≠ticas de Azure

**Las Pol√≠ticas de Azure** son reglas que ayudan a las organizaciones a garantizar que sus recursos cumplan con est√°ndares espec√≠ficos y requisitos de cumplimiento. Permiten **hacer cumplir o auditar configuraciones en recursos de Azure**. Por ejemplo, puedes prevenir la creaci√≥n de m√°quinas virtuales en una regi√≥n no autorizada o asegurarte de que todos los recursos tengan etiquetas espec√≠ficas para el seguimiento.

Las Pol√≠ticas de Azure son **proactivas**: pueden detener la creaci√≥n o modificaci√≥n de recursos no conformes. Tambi√©n son **reactivas**, permiti√©ndote encontrar y corregir recursos no conformes existentes.

#### **Conceptos Clave**

1. **Definici√≥n de Pol√≠tica**: Una regla, escrita en JSON, que especifica lo que est√° permitido o requerido.
2. **Asignaci√≥n de Pol√≠tica**: La aplicaci√≥n de una pol√≠tica a un alcance espec√≠fico (por ejemplo, suscripci√≥n, grupo de recursos).
3. **Iniciativas**: Una colecci√≥n de pol√≠ticas agrupadas para una aplicaci√≥n m√°s amplia.
4. **Efecto**: Especifica lo que sucede cuando se activa la pol√≠tica (por ejemplo, "Denegar", "Auditar" o "Agregar").

**Algunos ejemplos:**

1. **Asegurando el Cumplimiento con Regiones Espec√≠ficas de Azure**: Esta pol√≠tica asegura que todos los recursos se desplieguen en regiones espec√≠ficas de Azure. Por ejemplo, una empresa podr√≠a querer asegurarse de que todos sus datos se almacenen en Europa para cumplir con el GDPR.
2. **Haciendo Cumplir Normas de Nomenclatura**: Las pol√≠ticas pueden hacer cumplir convenciones de nomenclatura para los recursos de Azure. Esto ayuda a organizar e identificar f√°cilmente los recursos seg√∫n sus nombres, lo cual es √∫til en entornos grandes.
3. **Restringiendo Ciertos Tipos de Recursos**: Esta pol√≠tica puede restringir la creaci√≥n de ciertos tipos de recursos. Por ejemplo, se podr√≠a establecer una pol√≠tica para prevenir la creaci√≥n de tipos de recursos costosos, como ciertos tama√±os de VM, para controlar costos.
4. **Haciendo Cumplir Pol√≠ticas de Etiquetado**: Las etiquetas son pares clave-valor asociados con recursos de Azure utilizados para la gesti√≥n de recursos. Las pol√≠ticas pueden hacer cumplir que ciertas etiquetas deben estar presentes, o tener valores espec√≠ficos, para todos los recursos. Esto es √∫til para el seguimiento de costos, propiedad o categorizaci√≥n de recursos.
5. **Limitando el Acceso P√∫blico a Recursos**: Las pol√≠ticas pueden hacer cumplir que ciertos recursos, como cuentas de almacenamiento o bases de datos, no tengan puntos finales p√∫blicos, asegurando que solo sean accesibles dentro de la red de la organizaci√≥n.
6. **Aplicando Autom√°ticamente Configuraciones de Seguridad**: Las pol√≠ticas pueden usarse para aplicar autom√°ticamente configuraciones de seguridad a los recursos, como aplicar un grupo de seguridad de red espec√≠fico a todas las VMs o asegurarse de que todas las cuentas de almacenamiento utilicen cifrado.

Ten en cuenta que las Pol√≠ticas de Azure pueden adjuntarse a cualquier nivel de la jerarqu√≠a de Azure, pero se utilizan **com√∫nmente en el grupo de gesti√≥n ra√≠z** o en otros grupos de gesti√≥n.

Ejemplo de pol√≠tica de Azure en json:
```json
{
"policyRule": {
"if": {
"field": "location",
"notIn": [
"eastus",
"westus"
]
},
"then": {
"effect": "Deny"
}
},
"parameters": {},
"displayName": "Allow resources only in East US and West US",
"description": "This policy ensures that resources can only be created in East US or West US.",
"mode": "All"
}
```
### Herencia de Permisos

En Azure **los permisos pueden ser asignados a cualquier parte de la jerarqu√≠a**. Eso incluye grupos de gesti√≥n, suscripciones, grupos de recursos y recursos individuales. Los permisos son **heredados** por los **recursos** contenidos de la entidad donde fueron asignados.

Esta estructura jer√°rquica permite una gesti√≥n eficiente y escalable de los permisos de acceso.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (control de acceso basado en roles) es lo que ya hemos visto en las secciones anteriores: **Asignar un rol a un principal para otorgarle acceso** sobre un recurso.\
Sin embargo, en algunos casos puede que desees proporcionar **una gesti√≥n de acceso m√°s detallada** o **simplificar** la gesti√≥n de **cientos** de **asignaciones** de roles.

Azure **ABAC** (control de acceso basado en atributos) se basa en Azure RBAC al agregar **condiciones de asignaci√≥n de roles basadas en atributos** en el contexto de acciones espec√≠ficas. Una _condici√≥n de asignaci√≥n de rol_ es un **chequeo adicional que puedes agregar opcionalmente a tu asignaci√≥n de rol** para proporcionar un control de acceso m√°s detallado. Una condici√≥n filtra los permisos otorgados como parte de la definici√≥n de rol y la asignaci√≥n de rol. Por ejemplo, puedes **agregar una condici√≥n que requiera que un objeto tenga una etiqueta espec√≠fica para leer el objeto**.\
No **puedes** expl√≠citamente **negar** **acceso** a recursos espec√≠ficos **usando condiciones**.

### Gesti√≥n de Identidades Privilegiadas (PIM)

La Gesti√≥n de Identidades Privilegiadas (PIM) en Azure es una herramienta que **gestiona, controla y monitorea el acceso privilegiado** en Azure Active Directory y Azure. Mejora la seguridad al proporcionar **acceso privilegiado justo a tiempo y limitado en el tiempo**, **haciendo cumplir flujos de trabajo de aprobaci√≥n y requiriendo autenticaci√≥n adicional**. Este enfoque minimiza el riesgo de acceso no autorizado al asegurar que los permisos elevados se otorguen solo cuando sea necesario y por un per√≠odo espec√≠fico.

## Tokens de Autenticaci√≥n

Hay **tres tipos de tokens** utilizados en OIDC:

* [**Tokens de Acceso**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** El cliente presenta este token al servidor de recursos para **acceder a recursos**. Solo se puede usar para una combinaci√≥n espec√≠fica de usuario, cliente y recurso y **no puede ser revocado** hasta su expiraci√≥n, que es de 1 hora por defecto.
* **Tokens de ID**: El cliente recibe este **token del servidor de autorizaci√≥n**. Contiene informaci√≥n b√°sica sobre el usuario. Est√° **vinculado a una combinaci√≥n espec√≠fica de usuario y cliente**.
* **Tokens de Actualizaci√≥n**: Proporcionados al cliente con el token de acceso. Se utilizan para **obtener nuevos tokens de acceso e ID**. Est√° vinculado a una combinaci√≥n espec√≠fica de usuario y cliente y puede ser revocado. La expiraci√≥n por defecto es de **90 d√≠as** para tokens de actualizaci√≥n inactivos y **sin expiraci√≥n para tokens activos**.

{% hint style="warning" %}
La informaci√≥n para **acceso condicional** est√° **almacenada** dentro del **JWT**. As√≠ que, si solicitas el **token desde una direcci√≥n IP permitida**, esa **IP** ser√° **almacenada** en el token y luego puedes usar ese token desde una **IP no permitida para acceder a los recursos**.
{% endhint %}

### Tokens de Acceso "aud"

Dependiendo de la acci√≥n que desees realizar, el "**aud**" del token de acceso debe estar autorizado para contactar la URL de la API que vas a contactar.

El comando `az account get-access-token --resource-type [...]` soporta los siguientes tipos y cada uno de ellos a√±adir√° un "aud" espec√≠fico en el token de acceso resultante:

{% hint style="danger" %}
Ten en cuenta que los siguientes son solo las APIs soportadas por `az account get-access-token`, pero hay m√°s.
{% endhint %}

* **aad-graph (API de Gr√°fico de Azure Active Directory)**: Utilizado para acceder a la API de Gr√°fico de Azure AD (obsoleta), que permite a las aplicaciones leer y escribir datos de directorio en Azure Active Directory (Azure AD).
* `https://graph.windows.net/`
* **arm (Azure Resource Manager)**: Utilizado para gestionar recursos de Azure a trav√©s de la API de Azure Resource Manager. Esto incluye operaciones como crear, actualizar y eliminar recursos como m√°quinas virtuales, cuentas de almacenamiento, y m√°s.
* `https://management.core.windows.net/ o https://management.azure.com/`
* **batch (Servicios de Azure Batch)**: Utilizado para acceder a Azure Batch, un servicio que permite aplicaciones de computaci√≥n paralela y de alto rendimiento a gran escala de manera eficiente en la nube.
* `https://batch.core.windows.net/`
* **data-lake (Almacenamiento de Azure Data Lake)**: Utilizado para interactuar con Azure Data Lake Storage Gen1, que es un servicio de almacenamiento y an√°lisis de datos escalable.
* `https://datalake.azure.net/`
* **media (Servicios de Medios de Azure)**: Utilizado para acceder a los Servicios de Medios de Azure, que proporcionan servicios de procesamiento y entrega de medios basados en la nube para contenido de video y audio.
* `https://rest.media.azure.net`
* **ms-graph (API de Microsoft Graph)**: Utilizado para acceder a la API de Microsoft Graph, el punto de acceso unificado para los datos de servicios de Microsoft 365. Permite acceder a datos e informaci√≥n de servicios como Azure AD, Office 365, Movilidad Empresarial y servicios de Seguridad.
* `https://graph.microsoft.com`
* **oss-rdbms (Bases de Datos Relacionales de C√≥digo Abierto de Azure)**: Utilizado para acceder a los servicios de base de datos de Azure para motores de bases de datos relacionales de c√≥digo abierto como MySQL, PostgreSQL y MariaDB.
* `https://ossrdbms-aad.database.windows.net`

Consulta la siguiente p√°gina para aprender diferentes formas de **solicitar tokens de acceso** e iniciar sesi√≥n con ellos:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

## Referencias

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)
* [https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration](https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
