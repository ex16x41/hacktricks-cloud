# Az - Informa√ß√µes B√°sicas

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Treinamento AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Treinamento GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Hierarquia da Organiza√ß√£o

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUchBvhjIdWWR2ldAkWiZMdmrcEYD9Ti5UAa3zAGr9YbAnx4Q_gZNp_zvOU429vgWZ_ixoYHQKdC8bGgkhWYCy591SRIFj6RKCj4BEpVQixAGsp3T3O5sS3k7x5CTaJ-SCBNC7i5KluLyxdiXoZsH1F0ko1Gv88=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption></figcaption></figure>

### Grupos de Gerenciamento

* Pode conter **outros grupos de gerenciamento ou assinaturas**.
* Isso permite **aplicar controles de governan√ßa** como RBAC e Azure Policy uma vez no n√≠vel do grupo de gerenciamento e t√™-los **herdados** por todas as assinaturas no grupo.
* **10.000 grupos de gerenciamento** podem ser suportados em um √∫nico diret√≥rio.
* Uma √°rvore de grupos de gerenciamento pode suportar **at√© seis n√≠veis de profundidade**. Este limite n√£o inclui o n√≠vel raiz ou o n√≠vel de assinatura.
* Cada grupo de gerenciamento e assinatura pode suportar **apenas um pai**.
* Mesmo que v√°rios grupos de gerenciamento possam ser criados, **existe apenas 1 grupo de gerenciamento raiz**.
* O grupo de gerenciamento raiz **cont√©m** todos os **outros grupos de gerenciamento e assinaturas** e **n√£o pode ser movido ou exclu√≠do**.
* Todas as assinaturas dentro de um √∫nico grupo de gerenciamento devem confiar no **mesmo inquilino do Entra ID.**

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption><p><a href="https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png">https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png</a></p></figcaption></figure>

### Assinaturas do Azure

* √â outro **container l√≥gico onde recursos** (VMs, DBs‚Ä¶) podem ser executados e ser√£o cobrados.
* Seu **pai** √© sempre um **grupo de gerenciamento** (e pode ser o grupo de gerenciamento raiz), pois assinaturas n√£o podem conter outras assinaturas.
* **Confia apenas em um diret√≥rio do Entra ID**
* **Permiss√µes** aplicadas no n√≠vel da assinatura (ou em qualquer um de seus pais) s√£o **herdadas** para todos os recursos dentro da assinatura

### Grupos de Recursos

[Dos docs:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Um grupo de recursos √© um **container** que cont√©m **recursos relacionados** para uma solu√ß√£o do Azure. O grupo de recursos pode incluir todos os recursos para a solu√ß√£o, ou apenas aqueles **recursos que voc√™ deseja gerenciar como um grupo**. Geralmente, adicione **recursos** que compartilham o **mesmo ciclo de vida** ao mesmo grupo de recursos para que voc√™ possa facilmente implantar, atualizar e exclu√≠-los como um grupo.

Todos os **recursos** devem estar **dentro de um grupo de recursos** e podem pertencer apenas a um grupo e, se um grupo de recursos for exclu√≠do, todos os recursos dentro dele tamb√©m s√£o exclu√≠dos.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfe8U30iP_vdZCvxX4g8nEPRLoo7v0kmCGkDn1frBPn3_GIoZ7VT2LkdsVQWCnrG_HSYNRRPM-1pSECUkbDAB-9YbUYLzpvKVLDETZS81CHWKYM4fDl3oMo5-yvTMnjdLTS2pz8U67xUTIzBhZ25MFMRkq5koKY=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption><p><a href="https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1">https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1</a></p></figcaption></figure>

### IDs de Recursos do Azure

Cada recurso no Azure tem um ID de Recurso do Azure que o identifica.

O formato de um ID de Recurso do Azure √© o seguinte:

* `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderNamespace}/{resourceType}/{resourceName}`

Para uma m√°quina virtual chamada myVM em um grupo de recursos `myResourceGroup` sob o ID da assinatura `12345678-1234-1234-1234-123456789012`, o ID de Recurso do Azure se parece com isto:

* `/subscriptions/12345678-1234-1234-1234-123456789012/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM`

## Azure vs Entra ID vs Servi√ßos de Dom√≠nio do Azure AD

### Azure

Azure √© a abrangente **plataforma de computa√ß√£o em nuvem da Microsoft, oferecendo uma ampla gama de servi√ßos**, incluindo m√°quinas virtuais, bancos de dados, intelig√™ncia artificial e armazenamento. Ela atua como a base para hospedar e gerenciar aplicativos, construir infraestruturas escal√°veis e executar cargas de trabalho modernas na nuvem. O Azure fornece ferramentas para desenvolvedores e profissionais de TI criarem, implantarem e gerenciarem aplicativos e servi√ßos de forma cont√≠nua, atendendo a uma variedade de necessidades, desde startups at√© grandes empresas.

### Entra ID (anteriormente Azure Active Directory)

Entra ID √© um servi√ßo de **gerenciamento de identidade e acesso baseado em nuvem** projetado para lidar com autentica√ß√£o, autoriza√ß√£o e controle de acesso do usu√°rio. Ele fornece acesso seguro a servi√ßos da Microsoft, como Office 365, Azure e muitos aplicativos SaaS de terceiros. Com recursos como autentica√ß√£o √∫nica (SSO), autentica√ß√£o multifator (MFA) e pol√≠ticas de acesso condicional, entre outros.

### Servi√ßos de Dom√≠nio do Entra (anteriormente Azure AD DS)

Os Servi√ßos de Dom√≠nio do Entra estendem as capacidades do Entra ID, oferecendo **servi√ßos de dom√≠nio gerenciados compat√≠veis com ambientes tradicionais do Windows Active Directory**. Ele suporta protocolos legados como LDAP, Kerberos e NTLM, permitindo que as organiza√ß√µes migrem ou executem aplicativos mais antigos na nuvem sem implantar controladores de dom√≠nio locais. Este servi√ßo tamb√©m suporta Pol√≠tica de Grupo para gerenciamento centralizado, tornando-o adequado para cen√°rios onde cargas de trabalho legadas ou baseadas em AD precisam coexistir com ambientes modernos de nuvem.

## Principais do Entra ID

### Usu√°rios

* **Novos usu√°rios**
* Indicar nome de e-mail e dom√≠nio do inquilino selecionado
* Indicar nome de exibi√ß√£o
* Indicar senha
* Indicar propriedades (primeiro nome, cargo, informa√ß√µes de contato‚Ä¶)
* O tipo de usu√°rio padr√£o √© ‚Äú**membro**‚Äù
* **Usu√°rios externos**
* Indicar e-mail para convidar e nome de exibi√ß√£o (pode ser um e-mail n√£o Microsoft)
* Indicar propriedades
* O tipo de usu√°rio padr√£o √© ‚Äú**Convidado**‚Äù

### Permiss√µes Padr√£o de Membros e Convidados

Voc√™ pode verific√°-las em [https://learn.microsoft.com/en-us/entra/fundamentals/users-default-permissions](https://learn.microsoft.com/en-us/entra/fundamentals/users-default-permissions), mas entre outras a√ß√µes, um membro poder√°:

* Ler todos os usu√°rios, Grupos, Aplica√ß√µes, Dispositivos, Fun√ß√µes, Assinaturas e suas propriedades p√∫blicas
* Convidar Convidados (_pode ser desativado_)
* Criar Grupos de Seguran√ßa
* Ler associa√ß√µes de Grupos n√£o ocultos
* Adicionar convidados a Grupos de Propriedade
* Criar nova aplica√ß√£o (_pode ser desativado_)
* Adicionar at√© 50 dispositivos ao Azure (_pode ser desativado_)

{% hint style="info" %}
Lembre-se de que, para enumerar recursos do Azure, o usu√°rio precisa de uma concess√£o expl√≠cita da permiss√£o.
{% endhint %}

### Permiss√µes Configur√°veis Padr√£o de Usu√°rios

* **Membros (**[**docs**](https://learn.microsoft.com/en-gb/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions)**)**
* Registrar Aplica√ß√µes: Padr√£o **Sim**
* Restringir usu√°rios n√£o administradores de criar inquilinos: Padr√£o **N√£o**
* Criar grupos de seguran√ßa: Padr√£o **Sim**
* Restringir acesso ao portal de administra√ß√£o do Microsoft Entra: Padr√£o **N√£o**
* Isso n√£o restringe o acesso √† API do portal (apenas web)
* Permitir que os usu√°rios conectem contas de trabalho ou escolares com o LinkedIn: Padr√£o **Sim**
* Mostrar manter usu√°rio conectado: Padr√£o **Sim**
* Restringir usu√°rios de recuperar a(s) chave(s) do BitLocker para seus dispositivos de propriedade: Padr√£o N√£o (verifique nas Configura√ß√µes do Dispositivo)
* Ler outros usu√°rios: Padr√£o **Sim** (via Microsoft Graph)
* **Convidados**
* **Restri√ß√µes de acesso de usu√°rios convidados**
* **Usu√°rios convidados t√™m o mesmo acesso que membros** concede todas as permiss√µes de usu√°rios membros a usu√°rios convidados por padr√£o.
* **Usu√°rios convidados t√™m acesso limitado a propriedades e associa√ß√µes de objetos de diret√≥rio (padr√£o)** restringe o acesso de convidados apenas ao seu pr√≥prio perfil de usu√°rio por padr√£o. O acesso a outras informa√ß√µes de usu√°rios e grupos n√£o √© mais permitido.
* **O acesso de usu√°rios convidados √© restrito a propriedades e associa√ß√µes de seus pr√≥prios objetos de diret√≥rio** √© o mais restritivo.
* **Convidados podem convidar**
* **Qualquer pessoa na organiza√ß√£o pode convidar usu√°rios convidados, incluindo convidados e n√£o administradores (mais inclusivo) - Padr√£o**
* **Usu√°rios membros e usu√°rios atribu√≠dos a fun√ß√µes administrativas espec√≠ficas podem convidar usu√°rios convidados, incluindo convidados com permiss√µes de membro**
* **Apenas usu√°rios atribu√≠dos a fun√ß√µes administrativas espec√≠ficas podem convidar usu√°rios convidados**
* **Ningu√©m na organiza√ß√£o pode convidar usu√°rios convidados, incluindo administradores (mais restritivo)**
* **Usu√°rio externo sai**: Padr√£o **Verdadeiro**
* Permitir que usu√°rios externos deixem a organiza√ß√£o

{% hint style="success" %}
Mesmo que restritos por padr√£o, usu√°rios (membros e convidados) com permiss√µes concedidas poderiam realizar as a√ß√µes anteriores.
{% endhint %}

### **Grupos**

Existem **2 tipos de grupos**:

* **Seguran√ßa**: Este tipo de grupo √© usado para dar acesso a membros a aplica√ß√µes, recursos e atribuir licen√ßas. Usu√°rios, dispositivos, principais de servi√ßo e outros grupos podem ser membros.
* **Microsoft 365**: Este tipo de grupo √© usado para colabora√ß√£o, dando acesso a membros a uma caixa de correio compartilhada, calend√°rio, arquivos, site do SharePoint, e assim por diante. Os membros do grupo podem ser apenas usu√°rios.
* Isso ter√° um **endere√ßo de e-mail** com o dom√≠nio do inquilino do EntraID.

Existem **2 tipos de associa√ß√µes**:

* **Atribu√≠do**: Permite adicionar manualmente membros espec√≠ficos a um grupo.
* **Associa√ß√£o din√¢mica**: Gerencia automaticamente a associa√ß√£o usando regras, atualizando a inclus√£o do grupo quando os atributos dos membros mudam.

### **Principais de Servi√ßo**

Um **Principal de Servi√ßo** √© uma **identidade** criada para **uso** com **aplica√ß√µes**, servi√ßos hospedados e ferramentas automatizadas para acessar recursos do Azure. Esse acesso √© **restrito pelos pap√©is atribu√≠dos** ao principal de servi√ßo, dando controle sobre **quais recursos podem ser acessados** e em qual n√≠vel. Por raz√µes de seguran√ßa, √© sempre recomendado **usar principais de servi√ßo com ferramentas automatizadas** em vez de permitir que eles fa√ßam login com uma identidade de usu√°rio.

√â poss√≠vel **fazer login diretamente como um principal de servi√ßo** gerando um **segredo** (senha), um **certificado** ou concedendo acesso **federado** a plataformas de terceiros (por exemplo, Github Actions) sobre ele.

* Se voc√™ escolher a autentica√ß√£o por **senha** (por padr√£o), **salve a senha gerada** pois voc√™ n√£o poder√° acess√°-la novamente.
* Se voc√™ escolher a autentica√ß√£o por certificado, certifique-se de que a **aplica√ß√£o ter√° acesso √† chave privada**.

### Registros de Aplicativos

Um **Registro de Aplicativo** √© uma configura√ß√£o que permite que uma aplica√ß√£o se integre ao Entra ID e realize a√ß√µes.

#### Componentes Chave:

1. **ID da Aplica√ß√£o (Client ID):** Um identificador √∫nico para seu aplicativo no Azure AD.
2. **URIs de Redirecionamento:** URLs onde o Azure AD envia respostas de autentica√ß√£o.
3. **Certificados, Segredos e Credenciais Federadas:** √â poss√≠vel gerar um segredo ou um certificado para fazer login como o principal de servi√ßo da aplica√ß√£o, ou para conceder acesso federado a ele (por exemplo, Github Actions).&#x20;
1. Se um **certificado** ou **segredo** for gerado, √© poss√≠vel que uma pessoa **fa√ßa login como o principal de servi√ßo** com ferramentas CLI conhecendo o **ID da aplica√ß√£o**, o **segredo** ou **certificado** e o **inquilino** (dom√≠nio ou ID).
4. **Permiss√µes da API:** Especifica quais recursos ou APIs o aplicativo pode acessar.
5. **Configura√ß√µes de Autentica√ß√£o:** Define os fluxos de autentica√ß√£o suportados pelo aplicativo (por exemplo, OAuth2, OpenID Connect).
6. **Principal de Servi√ßo**: Um principal de servi√ßo √© criado quando um aplicativo √© criado (se for feito a partir do console da web) ou quando √© instalado em um novo inquilino.
1. O **principal de servi√ßo** receber√° todas as permiss√µes solicitadas com as quais foi configurado.

### Permiss√µes de Consentimento Padr√£o

**Consentimento do usu√°rio para aplicativos**

* **N√£o permitir consentimento do usu√°rio**
* Um administrador ser√° necess√°rio para todos os aplicativos.
* **Permitir consentimento do usu√°rio para aplicativos de editores verificados, para permiss√µes selecionadas (Recomendado)**
* Todos os usu√°rios podem consentir para permiss√µes classificadas como "baixo impacto", para aplicativos de editores verificados ou aplicativos registrados nesta organiza√ß√£o.
* **Permiss√µes de baixo impacto padr√£o** (embora voc√™ precise aceitar para adicion√°-las como baixo):
* User.Read - fazer login e ler o perfil do usu√°rio
* offline\_access - manter acesso aos dados que os usu√°rios deram acesso
* openid - fazer login dos usu√°rios
* profile - visualizar o perfil b√°sico do usu√°rio
* email - visualizar o endere√ßo de e-mail do usu√°rio
* **Permitir consentimento do usu√°rio para aplicativos (Padr√£o)**
* Todos os usu√°rios podem consentir para qualquer aplicativo acessar os dados da organiza√ß√£o.

**Solicita√ß√µes de consentimento do administrador**: Padr√£o **N√£o**

* Os usu√°rios podem solicitar consentimento do administrador para aplicativos aos quais n√£o conseguem consentir
* Se **Sim**: √â poss√≠vel indicar Usu√°rios, Grupos e Fun√ß√µes que podem consentir solicita√ß√µes
* Configure tamb√©m se os usu√°rios receber√£o notifica√ß√µes por e-mail e lembretes de expira√ß√£o&#x20;

### **Identidade Gerenciada (Metadados)**

Identidades gerenciadas no Azure Active Directory oferecem uma solu√ß√£o para **gerenciar automaticamente a identidade** de aplicativos. Essas identidades s√£o usadas por aplicativos para o prop√≥sito de **conectar-se** a **recursos** compat√≠veis com a autentica√ß√£o do Azure Active Directory (**Azure AD**). Isso permite **remover a necessidade de codificar credenciais de nuvem** no c√≥digo, pois o aplicativo poder√° contatar o servi√ßo de **metadados** para obter um token v√°lido para **realizar a√ß√µes** como a identidade gerenciada indicada no Azure.

Existem dois tipos de identidades gerenciadas:

* **Atribu√≠da ao sistema**. Alguns servi√ßos do Azure permitem que voc√™ **ative uma identidade gerenciada diretamente em uma inst√¢ncia de servi√ßo**. Quando voc√™ ativa uma identidade gerenciada atribu√≠da ao sistema, um **principal de servi√ßo** √© criado no inquilino do Entra ID confi√°vel pela assinatura onde o recurso est√° localizado. Quando o **recurso** √© **exclu√≠do**, o Azure automaticamente **exclui** a **identidade** para voc√™.
* **Atribu√≠da pelo usu√°rio**. Tamb√©m √© poss√≠vel que os usu√°rios gerem identidades gerenciadas. Essas s√£o criadas dentro de um grupo de recursos dentro de uma assinatura e um principal de servi√ßo ser√° criado no EntraID confi√°vel pela assinatura. Em seguida, voc√™ pode atribuir a identidade gerenciada a uma ou **mais inst√¢ncias** de um servi√ßo do Azure (m√∫ltiplos recursos). Para identidades gerenciadas atribu√≠das pelo usu√°rio, a **identidade √© gerenciada separadamente dos recursos que a utilizam**.

Identidades Gerenciadas **n√£o geram credenciais eternas** (como senhas ou certificados) para acessar como o principal de servi√ßo associado a ela.

### Aplica√ß√µes Empresariais

√â apenas uma **tabela no Azure para filtrar principais de servi√ßo** e verificar as aplica√ß√µes que foram atribu√≠das a.

**N√£o √© outro tipo de ‚Äúaplica√ß√£o‚Äù,** n√£o existe nenhum objeto no Azure que seja uma ‚ÄúAplica√ß√£o Empresarial‚Äù, √© apenas uma abstra√ß√£o para verificar os Principais de Servi√ßo, Registros de Aplicativos e Identidades Gerenciadas.

### Unidades Administrativas

Unidades administrativas permitem **dar permiss√µes de um papel sobre uma parte espec√≠fica de uma organiza√ß√£o**.

Exemplo:

* Cen√°rio: Uma empresa deseja que administradores de TI regionais gerenciem apenas os usu√°rios em sua pr√≥pria regi√£o.
* Implementa√ß√£o:
* Criar Unidades Administrativas para cada regi√£o (por exemplo, "AU Am√©rica do Norte", "AU Europa").
* Preencher AUs com usu√°rios de suas respectivas regi√µes.
* AUs podem **conter usu√°rios, grupos ou dispositivos**
* AUs suportam **associa√ß√µes din√¢micas**
* AUs **n√£o podem conter AUs**
* Atribuir Fun√ß√µes Administrativas:
* Conceder o papel de "Administrador de Usu√°rios" ao pessoal de TI regional, limitado √† AU de sua regi√£o.
* Resultado: Administradores de TI regionais podem gerenciar contas de usu√°rio dentro de sua regi√£o sem afetar outras regi√µes.

### Fun√ß√µes do Entra ID

* Para gerenciar o Entra ID, existem algumas **fun√ß√µes integradas** que podem ser atribu√≠das a principais do Entra ID para gerenciar o Entra ID
* Confira as fun√ß√µes em [https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/permissions-reference](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/permissions-reference)
* A fun√ß√£o mais privilegiada √© **Administrador Global**
* Na descri√ß√£o da fun√ß√£o, √© poss√≠vel ver suas **permiss√µes granulares**

## Fun√ß√µes e Permiss√µes

**Fun√ß√µes** s√£o **atribu√≠das** a **principais** em um **escopo**: `principal -[HAS ROLE]->(scope)`

**Fun√ß√µes** atribu√≠das a **grupos** s√£o **herdadas** por todos os **membros** do grupo.

Dependendo do escopo ao qual a fun√ß√£o foi atribu√≠da, a **fun√ß√£o** pode ser **herdada** para **outros recursos** dentro do cont√™iner de escopo. Por exemplo, se um usu√°rio A tem uma **fun√ß√£o na assinatura**, ele ter√° essa **fun√ß√£o em todos os grupos de recursos** dentro da assinatura e em **todos os recursos** dentro do grupo de recursos.

### **Fun√ß√µes Cl√°ssicas**

| **Propriet√°rio**                     | <ul><li>Acesso total a todos os recursos</li><li>Pode gerenciar acesso para outros usu√°rios</li></ul> | Todos os tipos de recurso |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Contribuidor**               | <ul><li>Acesso total a todos os recursos</li><li>N√£o pode gerenciar acesso</li></ul>              | Todos os tipos de recurso |
| **Leitor**                    | ‚Ä¢ Visualizar todos os recursos                                                                     | Todos os tipos de recurso |
| **Administrador de Acesso do Usu√°rio** | <ul><li>Visualizar todos os recursos</li><li>Pode gerenciar acesso para outros usu√°rios</li></ul>           | Todos os tipos de recurso |

### Fun√ß√µes Integradas

[Dos docs: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[O controle de acesso baseado em fun√ß√£o do Azure (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) tem v√°rias **fun√ß√µes integradas do Azure** que voc√™ pode **atribuir** a **usu√°rios, grupos, principais de servi√ßo e identidades gerenciadas**. As atribui√ß√µes de fun√ß√£o s√£o a maneira de controlar **o acesso aos recursos do Azure**. Se as fun√ß√µes integradas n√£o atenderem √†s necessidades espec√≠ficas de sua organiza√ß√£o, voc√™ pode criar suas pr√≥prias [**fun√ß√µes personalizadas do Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

As fun√ß√µes **Integradas** se aplicam apenas aos **recursos** para os quais s√£o **destinadas**, por exemplo, confira esses 2 exemplos de **Fun√ß√µes Integradas sobre recursos de Computa√ß√£o**:

| [Leitor de Backup de Disco](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Fornece permiss√£o ao cofre de backup para realizar backup de disco.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Login de Usu√°rio de M√°quina Virtual](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Visualizar M√°quinas Virtuais no portal e fazer login como um usu√°rio regular. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Essas fun√ß√µes tamb√©m podem **ser atribu√≠das sobre cont√™ineres l√≥gicos** (como grupos de gerenciamento, assinaturas e grupos de recursos) e os principais afetados as ter√£o **sobre os recursos dentro desses cont√™ineres**.

* Encontre aqui uma lista com [**todas as fun√ß√µes integradas do Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Encontre aqui uma lista com [**todas as fun√ß√µes integradas do Entra ID**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Fun√ß√µes Personalizadas

* Tamb√©m √© poss√≠vel criar [**fun√ß√µes personalizadas**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)
* Elas s√£o criadas dentro de um escopo, embora uma fun√ß√£o possa estar em v√°rios escopos (grupos de gerenciamento, assinatura e grupos de recursos)
* √â poss√≠vel configurar todas as permiss√µes granulares que a fun√ß√£o personalizada ter√°
* √â poss√≠vel excluir permiss√µes
* Um principal com uma permiss√£o exclu√≠da n√£o poder√° us√°-la, mesmo que a permiss√£o esteja sendo concedida em outro lugar
* √â poss√≠vel usar curingas
* O formato utilizado √© um JSON
* `actions` s√£o para controlar a√ß√µes sobre o recurso
* `dataActions` s√£o permiss√µes sobre os dados dentro do objeto

Exemplo de JSON de permiss√µes para uma fun√ß√£o personalizada:
```json
{
"properties": {
"roleName": "",
"description": "",
"assignableScopes": [
"/subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f"
],
"permissions": [
{
"actions": [
"Microsoft.DigitalTwins/register/action",
"Microsoft.DigitalTwins/unregister/action",
"Microsoft.DigitalTwins/operations/read",
"Microsoft.DigitalTwins/digitalTwinsInstances/read",
"Microsoft.DigitalTwins/digitalTwinsInstances/write",
"Microsoft.CostManagement/exports/*"
],
"notActions": [
"Astronomer.Astro/register/action",
"Astronomer.Astro/unregister/action",
"Astronomer.Astro/operations/read",
"Astronomer.Astro/organizations/read"
],
"dataActions": [],
"notDataActions": []
}
]
}
}
```
### Ordem de Permiss√µes

* Para que um **principal tenha algum acesso a um recurso**, ele precisa de um papel expl√≠cito sendo concedido a ele (de qualquer forma) **concedendo-lhe essa permiss√£o**.
* Uma atribui√ß√£o de **papel de nega√ß√£o expl√≠cita tem preced√™ncia** sobre o papel que concede a permiss√£o.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption><p><a href="https://link.springer.com/chapter/10.1007/978-1-4842-7325-8_10">https://link.springer.com/chapter/10.1007/978-1-4842-7325-8_10</a></p></figcaption></figure>

### Administrador Global

O Administrador Global √© um papel do Entra ID que concede **controle total sobre o locat√°rio do Entra ID**. No entanto, ele n√£o concede nenhuma permiss√£o sobre recursos do Azure por padr√£o.

Usu√°rios com o papel de Administrador Global t√™m a capacidade de '**elevar' para o papel de Administrador de Acesso do Usu√°rio no Grupo de Gerenciamento Raiz**. Assim, Administradores Globais podem gerenciar o acesso em **todas as assinaturas e grupos de gerenciamento do Azure.**\
Essa eleva√ß√£o pode ser feita no final da p√°gina: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/Properties)

<figure><img src="../../.gitbook/assets/image (349).png" alt=""><figcaption></figcaption></figure>

### Pol√≠ticas do Azure

**Pol√≠ticas do Azure** s√£o regras que ajudam as organiza√ß√µes a garantir que seus recursos atendam a padr√µes espec√≠ficos e requisitos de conformidade. Elas permitem que voc√™ **aplique ou audite configura√ß√µes em recursos no Azure**. Por exemplo, voc√™ pode impedir a cria√ß√£o de m√°quinas virtuais em uma regi√£o n√£o autorizada ou garantir que todos os recursos tenham tags espec√≠ficas para rastreamento.

As Pol√≠ticas do Azure s√£o **proativas**: elas podem impedir que recursos n√£o conformes sejam criados ou alterados. Elas tamb√©m s√£o **reativas**, permitindo que voc√™ encontre e corrija recursos n√£o conformes existentes.

#### **Conceitos Chave**

1. **Defini√ß√£o de Pol√≠tica**: Uma regra, escrita em JSON, que especifica o que √© permitido ou exigido.
2. **Atribui√ß√£o de Pol√≠tica**: A aplica√ß√£o de uma pol√≠tica a um escopo espec√≠fico (por exemplo, assinatura, grupo de recursos).
3. **Iniciativas**: Uma cole√ß√£o de pol√≠ticas agrupadas para uma aplica√ß√£o mais ampla.
4. **Efeito**: Especifica o que acontece quando a pol√≠tica √© acionada (por exemplo, "Negar", "Auditar" ou "Anexar").

**Alguns exemplos:**

1. **Garantindo Conformidade com Regi√µes Espec√≠ficas do Azure**: Esta pol√≠tica garante que todos os recursos sejam implantados em regi√µes espec√≠ficas do Azure. Por exemplo, uma empresa pode querer garantir que todos os seus dados sejam armazenados na Europa para conformidade com o GDPR.
2. **Impondo Padr√µes de Nomenclatura**: Pol√≠ticas podem impor conven√ß√µes de nomenclatura para recursos do Azure. Isso ajuda a organizar e identificar facilmente recursos com base em seus nomes, o que √© √∫til em ambientes grandes.
3. **Restringindo Certos Tipos de Recursos**: Esta pol√≠tica pode restringir a cria√ß√£o de certos tipos de recursos. Por exemplo, uma pol√≠tica pode ser configurada para impedir a cria√ß√£o de tipos de recursos caros, como certos tamanhos de VM, para controlar custos.
4. **Impondo Pol√≠ticas de Tagging**: Tags s√£o pares chave-valor associados a recursos do Azure usados para gerenciamento de recursos. Pol√≠ticas podem impor que certas tags devem estar presentes ou ter valores espec√≠ficos para todos os recursos. Isso √© √∫til para rastreamento de custos, propriedade ou categoriza√ß√£o de recursos.
5. **Limitando Acesso P√∫blico a Recursos**: Pol√≠ticas podem impor que certos recursos, como contas de armazenamento ou bancos de dados, n√£o tenham endpoints p√∫blicos, garantindo que sejam acess√≠veis apenas dentro da rede da organiza√ß√£o.
6. **Aplicando Configura√ß√µes de Seguran√ßa Automaticamente**: Pol√≠ticas podem ser usadas para aplicar automaticamente configura√ß√µes de seguran√ßa a recursos, como aplicar um grupo de seguran√ßa de rede espec√≠fico a todas as VMs ou garantir que todas as contas de armazenamento usem criptografia.

Observe que as Pol√≠ticas do Azure podem ser anexadas a qualquer n√≠vel da hierarquia do Azure, mas s√£o **comumente usadas no grupo de gerenciamento raiz** ou em outros grupos de gerenciamento.

Exemplo de pol√≠tica do Azure em json:
```json
{
"policyRule": {
"if": {
"field": "location",
"notIn": [
"eastus",
"westus"
]
},
"then": {
"effect": "Deny"
}
},
"parameters": {},
"displayName": "Allow resources only in East US and West US",
"description": "This policy ensures that resources can only be created in East US or West US.",
"mode": "All"
}
```
### Heran√ßa de Permiss√µes

No Azure, **as permiss√µes podem ser atribu√≠das a qualquer parte da hierarquia**. Isso inclui grupos de gerenciamento, assinaturas, grupos de recursos e recursos individuais. As permiss√µes s√£o **herdadas** pelos **recursos** contidos na entidade onde foram atribu√≠das.

Essa estrutura hier√°rquica permite uma gest√£o eficiente e escal√°vel das permiss√µes de acesso.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (controle de acesso baseado em fun√ß√£o) √© o que j√° vimos nas se√ß√µes anteriores: **Atribuir uma fun√ß√£o a um principal para conceder acesso** a um recurso.\
No entanto, em alguns casos, voc√™ pode querer fornecer **uma gest√£o de acesso mais granular** ou **simplificar** a gest√£o de **centenas** de **atribui√ß√µes** de fun√ß√£o.

O **ABAC** (controle de acesso baseado em atributos) do Azure se baseia no Azure RBAC, adicionando **condi√ß√µes de atribui√ß√£o de fun√ß√£o com base em atributos** no contexto de a√ß√µes espec√≠ficas. Uma _condi√ß√£o de atribui√ß√£o de fun√ß√£o_ √© uma **verifica√ß√£o adicional que voc√™ pode opcionalmente adicionar √† sua atribui√ß√£o de fun√ß√£o** para fornecer um controle de acesso mais granular. Uma condi√ß√£o filtra as permiss√µes concedidas como parte da defini√ß√£o de fun√ß√£o e da atribui√ß√£o de fun√ß√£o. Por exemplo, voc√™ pode **adicionar uma condi√ß√£o que exige que um objeto tenha uma tag espec√≠fica para ler o objeto**.\
Voc√™ **n√£o pode** explicitamente **negar** **acesso** a recursos espec√≠ficos **usando condi√ß√µes**.

### Gerenciamento de Identidade Privilegiada (PIM)

O Gerenciamento de Identidade Privilegiada (PIM) no Azure √© uma ferramenta que **gerencia, controla e monitora o acesso privilegiado** no Azure Active Directory e no Azure. Ele melhora a seguran√ßa ao fornecer **acesso privilegiado sob demanda e limitado no tempo**, **impondo fluxos de trabalho de aprova√ß√£o e exigindo autentica√ß√£o adicional**. Essa abordagem minimiza o risco de acesso n√£o autorizado, garantindo que permiss√µes elevadas sejam concedidas apenas quando necess√°rio e por um per√≠odo espec√≠fico.

## Tokens de Autentica√ß√£o

Existem **tr√™s tipos de tokens** usados no OIDC:

* [**Tokens de Acesso**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** O cliente apresenta este token ao servidor de recursos para **acessar recursos**. Ele pode ser usado apenas para uma combina√ß√£o espec√≠fica de usu√°rio, cliente e recurso e **n√£o pode ser revogado** at√© a expira√ß√£o - que √© de 1 hora por padr√£o.
* **Tokens de ID**: O cliente recebe este **token do servidor de autoriza√ß√£o**. Ele cont√©m informa√ß√µes b√°sicas sobre o usu√°rio. Ele √© **vinculado a uma combina√ß√£o espec√≠fica de usu√°rio e cliente**.
* **Tokens de Atualiza√ß√£o**: Fornecidos ao cliente com o token de acesso. Usados para **obter novos tokens de acesso e ID**. Ele √© vinculado a uma combina√ß√£o espec√≠fica de usu√°rio e cliente e pode ser revogado. A expira√ß√£o padr√£o √© de **90 dias** para tokens de atualiza√ß√£o inativos e **sem expira√ß√£o para tokens ativos**.

{% hint style="warning" %}
As informa√ß√µes para **acesso condicional** s√£o **armazenadas** dentro do **JWT**. Portanto, se voc√™ solicitar o **token de um endere√ßo IP permitido**, esse **IP** ser√° **armazenado** no token e, em seguida, voc√™ pode usar esse token de um **IP n√£o permitido para acessar os recursos**.
{% endhint %}

### Tokens de Acesso "aud"

Dependendo da a√ß√£o que voc√™ deseja realizar, o "**aud**" do token de acesso deve ser autorizado a contatar a URL da API que voc√™ ir√° contatar.

O comando `az account get-access-token --resource-type [...]` suporta os seguintes tipos e cada um deles adicionar√° um "aud" espec√≠fico no token de acesso resultante:

{% hint style="danger" %}
Observe que os seguintes s√£o apenas as APIs suportadas por `az account get-access-token`, mas h√° mais.
{% endhint %}

* **aad-graph (API do Azure Active Directory Graph)**: Usado para acessar a API do Azure AD Graph legada (obsoleta), que permite que aplicativos leiam e escrevam dados de diret√≥rio no Azure Active Directory (Azure AD).
* `https://graph.windows.net/`
* **arm (Azure Resource Manager)**: Usado para gerenciar recursos do Azure atrav√©s da API do Azure Resource Manager. Isso inclui opera√ß√µes como criar, atualizar e excluir recursos, como m√°quinas virtuais, contas de armazenamento e mais.
* `https://management.core.windows.net/ ou https://management.azure.com/`
* **batch (Servi√ßos Azure Batch)**: Usado para acessar o Azure Batch, um servi√ßo que permite aplica√ß√µes de computa√ß√£o paralela em larga escala e de alto desempenho de forma eficiente na nuvem.
* `https://batch.core.windows.net/`
* **data-lake (Armazenamento Azure Data Lake)**: Usado para interagir com o Azure Data Lake Storage Gen1, que √© um servi√ßo de armazenamento e an√°lise de dados escal√°vel.
* `https://datalake.azure.net/`
* **media (Servi√ßos Azure Media)**: Usado para acessar os Servi√ßos Azure Media, que fornecem servi√ßos de processamento e entrega de m√≠dia baseados em nuvem para conte√∫do de v√≠deo e √°udio.
* `https://rest.media.azure.net`
* **ms-graph (API Microsoft Graph)**: Usado para acessar a API Microsoft Graph, o ponto de extremidade unificado para dados dos servi√ßos Microsoft 365. Ele permite que voc√™ acesse dados e insights de servi√ßos como Azure AD, Office 365, Mobilidade Empresarial e servi√ßos de Seguran√ßa.
* `https://graph.microsoft.com`
* **oss-rdbms (Bancos de Dados Relacionais de C√≥digo Aberto do Azure)**: Usado para acessar servi√ßos de banco de dados do Azure para mecanismos de banco de dados relacionais de c√≥digo aberto, como MySQL, PostgreSQL e MariaDB.
* `https://ossrdbms-aad.database.windows.net`

Verifique a p√°gina a seguir para aprender diferentes maneiras de **solicitar tokens de acesso** e fazer login com eles:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

## Refer√™ncias

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)
* [https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration](https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos no** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
