# Az - Enumeration Tools

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åœ¨ Linux ä¸­å®‰è£… PowerShell

{% hint style="success" %}
åœ¨ Linux ä¸­ï¼Œæ‚¨éœ€è¦å®‰è£… PowerShell Coreï¼š
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

## åœ¨ MacOS ä¸Šå®‰è£… PowerShell

æ¥è‡ª [**æ–‡æ¡£**](https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-macos?view=powershell-7.4) çš„è¯´æ˜ï¼š

1. å¦‚æœå°šæœªå®‰è£…ï¼Œè¯·å®‰è£… `brew`ï¼š
```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```
2. å®‰è£…æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬çš„ PowerShellï¼š
```sh
brew install powershell/tap/powershell
```
3. è¿è¡Œ PowerShell:
```sh
pwsh
```
4. æ›´æ–°ï¼š
```sh
brew update
brew upgrade powershell
```
## ä¸»è¦æšä¸¾å·¥å…·

### az cli

[**Azure å‘½ä»¤è¡Œç•Œé¢ (CLI)**](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli) æ˜¯ä¸€ä¸ªè·¨å¹³å°å·¥å…·ï¼Œç”¨ Python ç¼–å†™ï¼Œç”¨äºç®¡ç†å’Œç®¡ç† (å¤§å¤šæ•°) Azure å’Œ Entra ID èµ„æºã€‚å®ƒè¿æ¥åˆ° Azure å¹¶é€šè¿‡å‘½ä»¤è¡Œæˆ–è„šæœ¬æ‰§è¡Œç®¡ç†å‘½ä»¤ã€‚

è¯·è®¿é—®æ­¤é“¾æ¥ä»¥è·å– [**å®‰è£…è¯´æ˜Â¡**](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli#install)ã€‚

Azure CLI ä¸­çš„å‘½ä»¤ä½¿ç”¨ä»¥ä¸‹æ¨¡å¼ç»“æ„ï¼š`az <service> <action> <parameters>`

#### è°ƒè¯• | MitM az cli

ä½¿ç”¨å‚æ•° **`--debug`** å¯ä»¥æŸ¥çœ‹å·¥å…· **`az`** å‘é€çš„æ‰€æœ‰è¯·æ±‚ï¼š
```bash
az account management-group list --output table --debug
```
ä¸ºäº†å¯¹å·¥å…·è¿›è¡Œ**MitM**å¹¶**æ‰‹åŠ¨æ£€æŸ¥æ‰€æœ‰å‘é€çš„è¯·æ±‚**ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œï¼š 

{% tabs %}
{% tab title="Bash" %}
```bash
export ADAL_PYTHON_SSL_NO_VERIFY=1
export AZURE_CLI_DISABLE_CONNECTION_VERIFICATION=1
export HTTPS_PROXY="http://127.0.0.1:8080"
export HTTP_PROXY="http://127.0.0.1:8080"

# If this is not enough
# Download the certificate from Burp and convert it into .pem format
# And export the following env variable
openssl x509 -in ~/Downloads/cacert.der -inform DER -out ~/Downloads/cacert.pem -outform PEM
export REQUESTS_CA_BUNDLE=/Users/user/Downloads/cacert.pem
```
{% endtab %}

{% tab title="PS" %}
```bash
$env:ADAL_PYTHON_SSL_NO_VERIFY=1
$env:AZURE_CLI_DISABLE_CONNECTION_VERIFICATION=1
$env:HTTPS_PROXY="http://127.0.0.1:8080"
$env:HTTP_PROXY="http://127.0.0.1:8080"
```
{% endtab %}
{% endtabs %}

### Az PowerShell

Azure PowerShell æ˜¯ä¸€ä¸ªæ¨¡å—ï¼ŒåŒ…å«ç”¨äºç›´æ¥ä» PowerShell å‘½ä»¤è¡Œç®¡ç† Azure èµ„æºçš„ cmdletsã€‚

è¯·è®¿é—®æ­¤é“¾æ¥ä»¥è·å– [**å®‰è£…è¯´æ˜**](https://learn.microsoft.com/en-us/powershell/azure/install-azure-powershell)ã€‚

Azure PowerShell AZ æ¨¡å—ä¸­çš„å‘½ä»¤ç»“æ„å¦‚ä¸‹ï¼š`<Action>-Az<Service> <parameters>`

#### Debug | MitM Az PowerShell

ä½¿ç”¨å‚æ•° **`-Debug`** å¯ä»¥æŸ¥çœ‹å·¥å…·å‘é€çš„æ‰€æœ‰è¯·æ±‚ï¼š
```bash
Get-AzResourceGroup -Debug
```
ä¸ºäº†å¯¹å·¥å…·è¿›è¡Œ**MitM**å¹¶**æ‰‹åŠ¨æ£€æŸ¥å®ƒå‘é€çš„æ‰€æœ‰è¯·æ±‚**ï¼Œæ‚¨å¯ä»¥æ ¹æ®[**æ–‡æ¡£**](https://learn.microsoft.com/en-us/powershell/azure/az-powershell-proxy)è®¾ç½®ç¯å¢ƒå˜é‡`HTTPS_PROXY`å’Œ`HTTP_PROXY`ã€‚

### Microsoft Graph PowerShell

Microsoft Graph PowerShellæ˜¯ä¸€ä¸ªè·¨å¹³å°SDKï¼Œèƒ½å¤Ÿè®¿é—®æ‰€æœ‰Microsoft Graph APIï¼ŒåŒ…æ‹¬SharePointã€Exchangeå’ŒOutlookç­‰æœåŠ¡ï¼Œä½¿ç”¨å•ä¸€ç«¯ç‚¹ã€‚å®ƒæ”¯æŒPowerShell 7+ã€é€šè¿‡MSALçš„ç°ä»£èº«ä»½éªŒè¯ã€å¤–éƒ¨èº«ä»½å’Œé«˜çº§æŸ¥è¯¢ã€‚ä¸“æ³¨äºæœ€å°æƒé™è®¿é—®ï¼Œç¡®ä¿å®‰å…¨æ“ä½œï¼Œå¹¶å®šæœŸæ›´æ–°ä»¥ä¸æœ€æ–°çš„Microsoft Graph APIåŠŸèƒ½ä¿æŒä¸€è‡´ã€‚

è¯·è®¿é—®æ­¤é“¾æ¥ä»¥è·å–[**å®‰è£…è¯´æ˜**](https://learn.microsoft.com/en-us/powershell/microsoftgraph/installation)ã€‚

Microsoft Graph PowerShellä¸­çš„å‘½ä»¤ç»“æ„å¦‚ä¸‹ï¼š`<Action>-Mg<Service> <parameters>`

#### è°ƒè¯•Microsoft Graph PowerShell

ä½¿ç”¨å‚æ•°**`-Debug`**å¯ä»¥æŸ¥çœ‹å·¥å…·å‘é€çš„æ‰€æœ‰è¯·æ±‚ï¼š
```bash
Get-MgUser -Debug
```
### ~~**AzureAD Powershell**~~

Azure Active Directory (AD) æ¨¡å—ç°åœ¨ **å·²å¼ƒç”¨**ï¼Œæ˜¯ Azure PowerShell çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºç®¡ç† Azure AD èµ„æºã€‚å®ƒæä¾›äº†ç”¨äºç®¡ç†ç”¨æˆ·ã€ç»„å’Œ Entra ID ä¸­çš„åº”ç”¨ç¨‹åºæ³¨å†Œçš„ cmdletã€‚

{% hint style="success" %}
è¿™å·²è¢« Microsoft Graph PowerShell æ›¿ä»£
{% endhint %}

è¯·æŒ‰ç…§æ­¤é“¾æ¥æŸ¥çœ‹ [**å®‰è£…è¯´æ˜**](https://www.powershellgallery.com/packages/AzureAD)ã€‚
