# Az - Dynamic Groups Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

**Dynamic groups** ã¯ã€**ãƒ«ãƒ¼ãƒ«** ãŒè¨­å®šã•ã‚Œã¦ãŠã‚Šã€ãã®ãƒ«ãƒ¼ãƒ«ã«ä¸€è‡´ã™ã‚‹ã™ã¹ã¦ã® **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ãƒ‡ãƒã‚¤ã‚¹** ãŒã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã•ã‚Œã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ãƒ‡ãƒã‚¤ã‚¹ã® **å±æ€§** ãŒ **å¤‰æ›´** ã•ã‚Œã‚‹ãŸã³ã«ã€å‹•çš„ãƒ«ãƒ¼ãƒ«ãŒ **å†ãƒã‚§ãƒƒã‚¯** ã•ã‚Œã¾ã™ã€‚ã¾ãŸã€**æ–°ã—ã„ãƒ«ãƒ¼ãƒ«** ãŒ **ä½œæˆ** ã•ã‚Œã‚‹ã¨ã€ã™ã¹ã¦ã®ãƒ‡ãƒã‚¤ã‚¹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ **ãƒã‚§ãƒƒã‚¯** ã•ã‚Œã¾ã™ã€‚

Dynamic groups ã«ã¯ **Azure RBAC roles** ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€Dynamic groups ã« **AzureAD roles** ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã¯ **ã§ãã¾ã›ã‚“**ã€‚

ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Azure AD premium P1 ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒå¿…è¦ã§ã™ã€‚

## Privesc

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Azure AD ã§ã¯ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚²ã‚¹ãƒˆã‚’æ‹›å¾…ã§ãã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã—ãŸãŒã£ã¦ã€Dynamic group ã® **ãƒ«ãƒ¼ãƒ«** ãŒ **å±æ€§** ã«åŸºã¥ã„ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã« **æ¨©é™** ã‚’ä¸ãˆã‚‹å ´åˆã€æ–°ã—ã„ **ã‚²ã‚¹ãƒˆ** ã«ã“ã‚Œã‚‰ã®å±æ€§ã‚’ **è¨­å®š** ã™ã‚‹ã“ã¨ã§ **æ¨©é™ã‚’æ˜‡æ ¼** ã•ã›ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã¾ãŸã€ã‚²ã‚¹ãƒˆã¯è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã—ã€ã“ã‚Œã‚‰ã®å±æ€§ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

Dynamic membership ã‚’è¨±å¯ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—ã™ã‚‹: `Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}`

### ä¾‹

* **ãƒ«ãƒ¼ãƒ«ã®ä¾‹**: `(user.otherMails -any (_ -contains "tester")) -and (user.userType -eq "guest")`
* **ãƒ«ãƒ¼ãƒ«ã®èª¬æ˜**: 'tester' ã¨ã„ã†æ–‡å­—åˆ—ã‚’å«ã‚€ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¡ãƒ¼ãƒ«ã‚’æŒã¤ä»»æ„ã®ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã•ã‚Œã¾ã™

1. **Azure Active Directory** -> **Users** ã«ç§»å‹•ã—ã€`Want to switch back to the legacy users list experience? Click here to leave the preview` ã‚’ **ã‚¯ãƒªãƒƒã‚¯**
2. **`New guest user`** ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ãƒ¡ãƒ¼ãƒ«ã‚’ **æ‹›å¾…**
3. æ‹›å¾…ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«** ãŒ Azure AD ã« **è¿½åŠ ** ã•ã‚Œã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã€**Invitation accepted ã®ä¸‹ã® (manage) ã‚’ã‚¯ãƒªãƒƒã‚¯**ã€‚
* ![](<../../../.gitbook/assets/image (281).png>)
4. **`Resend invite?`** ã‚’ **Yes** ã«å¤‰æ›´ã™ã‚‹ã¨ã€æ‹›å¾… URL ãŒè¡¨ç¤ºã•ã‚Œã¾ã™:
* ![](<../../../.gitbook/assets/image (205).png>)
5. **URL** ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ **é–‹ã**ã€æ‹›å¾…ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ **ãƒ­ã‚°ã‚¤ãƒ³** ã—ã€æ‹›å¾…ã‚’ **å—ã‘å…¥ã‚Œ**
6. cli ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ **ãƒ­ã‚°ã‚¤ãƒ³** ã—ã€ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¡ãƒ¼ãƒ«ã‚’è¨­å®š

{% code overflow="wrap" %}
```powershell
# Login
$password = ConvertTo-SecureString 'password' - AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('externaltester@somedomain.onmicrosoft.com', $Password)
Connect-AzureAD -Credential $creds -TenantId <tenant_id_of_attacked_domain>

# Chnage OtherMails setting
Set-AzureADUser -ObjectId <OBJECT-ID> -OtherMails <Username>@<TENANT_NAME>.onmicrosoft.com -Verbose
```
{% endcode %}

## å‚è€ƒæ–‡çŒ®

* [https://www.mnemonic.io/resources/blog/abusing-dynamic-groups-in-azure-ad-for-privilege-escalation/](https://www.mnemonic.io/resources/blog/abusing-dynamic-groups-in-azure-ad-for-privilege-escalation/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
