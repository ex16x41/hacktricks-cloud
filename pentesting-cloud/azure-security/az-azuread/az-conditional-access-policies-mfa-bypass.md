# Az - Πολιτικές Προσβάσεως με Όρους / Παράκαμψη MFA

{% hint style="success" %}
Μάθε & εξάσκησε το AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Μάθε & εξάσκησε το GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Έλεγξε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετοχή στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολούθησέ μας στο** **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιράσου κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Βασικές Πληροφορίες

Οι πολιτικές προσβάσεως με όρους Azure είναι κανόνες που έχουν ρυθμιστεί στο Microsoft Azure για την επιβολή ελέγχων πρόσβασης σε υπηρεσίες και εφαρμογές Azure με βάση ορισμένες **συνθήκες**. Αυτές οι πολιτικές βοηθούν τους οργανισμούς να ασφαλίσουν τους πόρους τους εφαρμόζοντας τους σωστούς ελέγχους πρόσβασης υπό τις σωστές συνθήκες.\
Οι πολιτικές προσβάσεως με όρους βασικά **καθορίζουν** **Ποιος** μπορεί να έχει πρόσβαση **Σε Τι** από **Που** και **Πως**.

Ακολουθούν μερικά παραδείγματα:

1. **Πολιτική Κινδύνου Σύνδεσης**: Αυτή η πολιτική θα μπορούσε να ρυθμιστεί ώστε να απαιτεί πολυπαραγοντική αυθεντικοποίηση (MFA) όταν ανιχνεύεται κίνδυνος σύνδεσης. Για παράδειγμα, αν η συμπεριφορά σύνδεσης ενός χρήστη είναι ασυνήθιστη σε σύγκριση με το κανονικό του μοτίβο, όπως η σύνδεση από μια διαφορετική χώρα, το σύστημα μπορεί να ζητήσει επιπλέον αυθεντικοποίηση.
2. **Πολιτική Συμμόρφωσης Συσκευών**: Αυτή η πολιτική μπορεί να περιορίσει την πρόσβαση σε υπηρεσίες Azure μόνο σε συσκευές που συμμορφώνονται με τα πρότυπα ασφαλείας του οργανισμού. Για παράδειγμα, η πρόσβαση θα μπορούσε να επιτρέπεται μόνο από συσκευές που διαθέτουν ενημερωμένο λογισμικό antivirus ή εκτελούν μια συγκεκριμένη έκδοση λειτουργικού συστήματος.

## Παράκαμψη Πολιτικών Προσβάσεως με Όρους

Είναι πιθανό μια πολιτική προσβάσεως με όρους να **ελέγχει κάποιες πληροφορίες που μπορούν να παραποιηθούν εύκολα επιτρέποντας μια παράκαμψη της πολιτικής**. Και αν για παράδειγμα η πολιτική ρύθμιζε MFA, ο επιτιθέμενος θα μπορεί να την παρακάμψει.

### Πλατφόρμες Συσκευών - Συνθήκη Συσκευής

Είναι δυνατόν να ρυθμιστεί μια συνθήκη με βάση την **πλατφόρμα συσκευής** (Android, iOS, Windows, macOS), ωστόσο, αυτό βασίζεται στον **user-agent** οπότε είναι αρκετά εύκολο να παρακαμφθεί. Ακόμα και **κάνοντας όλες τις επιλογές να επιβάλλουν MFA**, αν χρησιμοποιήσεις έναν **user-agent που δεν αναγνωρίζει** θα μπορέσεις να παρακάμψεις το MFA.

### Τοποθεσίες: Χώρες, IP ranges - Συνθήκη Συσκευής

Φυσικά, αν αυτό έχει ρυθμιστεί στην πολιτική προσβάσεως, ένας επιτιθέμενος θα μπορούσε απλά να χρησιμοποιήσει ένα **VPN** στη **επιτρεπόμενη χώρα** ή να προσπαθήσει να βρει έναν τρόπο να έχει πρόσβαση από μια **επιτρεπόμενη διεύθυνση IP** για να παρακάμψει αυτές τις συνθήκες.

### Εφαρμογές Πελάτη Office365

Μπορείς να υποδείξεις ότι αν οι πελάτες **πρόσβαση στις εφαρμογές Office 365 από τον περιηγητή χρειάζονται MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Για να παρακαμφθεί αυτό, είναι δυνατόν να προσποιηθείς ότι συνδέεσαι σε μια εφαρμογή από μια επιτραπέζια εφαρμογή (όπως το Microsoft Teams στο παρακάτω παράδειγμα) που θα παρακάμψει την προστασία:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Καθώς η εφαρμογή Microsoft Teams έχει πολλές άδειες, θα μπορείτε να χρησιμοποιήσετε αυτήν την πρόσβαση.

{% hint style="success" %}
Μπορείτε να βρείτε το I**D περισσότερων δημόσιων εφαρμογών** με προκαθορισμένες άδειες Office365 στη βάση δεδομένων του roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Αυτή η επίθεση είναι ιδιαίτερα ενδιαφέρουσα επειδή από προεπιλογή οι δημόσιες εφαρμογές Office365 θα έχουν άδειες πρόσβασης σε ορισμένα δεδομένα.

### Άλλες εφαρμογές

Από προεπιλογή, άλλες εφαρμογές που δημιουργούνται από χρήστες δεν θα έχουν άδειες και θα μπορούσαν να είναι ιδιωτικές.\
Ωστόσο, οι χρήστες θα μπορούσαν επίσης να δημιουργήσουν **δημόσιες** **εφαρμογές** δίνοντάς τους κάποιες **άδειες**.

Ένα πιθανό σενάριο όπου μια πολιτική έχει ρυθμιστεί να **απαιτεί MFA για την πρόσβαση σε μια εφαρμογή** όταν ο χρήστης χρησιμοποιεί έναν **περιηγητή** (ίσως επειδή είναι μια διαδικτυακή εφαρμογή και επομένως θα είναι ο μόνος τρόπος), αν υπάρχει μια **εφαρμογή proxy** -μια εφαρμογή που επιτρέπεται να **αλληλεπιδρά με άλλες εφαρμογές εκ μέρους των χρηστών**-, ο χρήστης θα μπορούσε να **συνδεθεί στην εφαρμογή proxy** και στη συνέχεια μέσω αυτής της εφαρμογής proxy να **συνδεθεί στην αρχικά προστατευμένη από MFA εφαρμογή**.

Ελέγξτε τις τεχνικές [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) και [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Άλλες παρακάμψεις Az MFA

### Ήχος κλήσης

Μια επιλογή Azure MFA είναι να **λάβει μια κλήση στον ρυθμισμένο αριθμό τηλεφώνου** όπου θα ζητηθεί από τον χρήστη να **στείλει τον χαρακτήρα `#`**.

{% hint style="danger" %}
Καθώς οι χαρακτήρες είναι απλώς **τόνοι**, ένας επιτιθέμενος θα μπορούσε να **παραβιάσει** το **μήνυμα φωνητικού ταχυδρομείου** του αριθμού τηλεφώνου, να ρυθμίσει ως μήνυμα τον **τόνο του `#`** και στη συνέχεια, όταν ζητείται το MFA, να διασφαλίσει ότι το **τηλέφωνο του θύματος είναι απασχολημένο** (καλώντας το) ώστε η κλήση του Azure να ανακατευθυνθεί στο φωνητικό ταχυδρομείο.
{% endhint %}

### Συμβατές Συσκευές

Οι πολιτικές συχνά ζητούν μια συμβατή συσκευή ή MFA, έτσι ένας **επιτιθέμενος θα μπορούσε να καταχωρίσει μια συμβατή συσκευή**, να αποκτήσει ένα **PRT** token και να **παρακάμψει με αυτόν τον τρόπο το MFA**.

Ξεκινήστε καταχωρίζοντας μια **συμβατή συσκευή στο Intune**, στη συνέχεια **αποκτήστε το PRT** με:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Βρείτε περισσότερες πληροφορίες σχετικά με αυτόν τον τύπο επίθεσης στην παρακάτω σελίδα:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Εργαλεία

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Αποκτήστε όλες τις πολιτικές
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

Το MFASweep είναι ένα σενάριο PowerShell που προσπαθεί να **συνδεθεί σε διάφορες υπηρεσίες της Microsoft χρησιμοποιώντας ένα παρεχόμενο σύνολο διαπιστευτηρίων και θα προσπαθήσει να προσδιορίσει αν είναι ενεργοποιημένο το MFA**. Ανάλογα με το πώς είναι διαμορφωμένες οι πολιτικές πρόσβασης και άλλες ρυθμίσεις πολλαπλής αυθεντικοποίησης, ορισμένα πρωτόκολλα μπορεί να καταλήξουν να παραμείνουν σε μία μόνο παράγοντα. Έχει επίσης μια επιπλέον έλεγχο για τις ρυθμίσεις ADFS και μπορεί να προσπαθήσει να συνδεθεί στον τοπικό διακομιστή ADFS αν ανιχνευθεί.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Το Donkey token είναι ένα σύνολο λειτουργιών που στοχεύουν να βοηθήσουν τους συμβούλους ασφαλείας που χρειάζονται να επικυρώσουν τις Πολιτικές Προσβάσεως με Όρους, δοκιμές για πύλες Microsoft με ενεργοποιημένο 2FA κ.λπ..
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Δοκιμάστε κάθε πύλη** αν είναι δυνατόν να **συνδεθείτε χωρίς MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Επειδή το **Azure** **portal** **δεν είναι περιορισμένο**, είναι δυνατόν να **συλλεχθεί ένα token από το endpoint του portal για να αποκτηθεί πρόσβαση σε οποιαδήποτε υπηρεσία ανιχνεύθηκε** από την προηγούμενη εκτέλεση. Σε αυτή την περίπτωση, το Sharepoint αναγνωρίστηκε και ζητείται ένα token για την πρόσβαση σε αυτό:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Υποθέτοντας ότι το token έχει την άδεια Sites.Read.All (από το Sharepoint), ακόμη και αν δεν μπορείτε να αποκτήσετε πρόσβαση στο Sharepoint από το διαδίκτυο λόγω MFA, είναι δυνατόν να χρησιμοποιήσετε το token για να αποκτήσετε πρόσβαση στα αρχεία με το παραγόμενο token:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Αναφορές

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
