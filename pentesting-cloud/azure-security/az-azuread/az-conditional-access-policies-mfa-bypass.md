# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Azure Conditional Access ì •ì±…ì€ íŠ¹ì • **ì¡°ê±´**ì— ë”°ë¼ Azure ì„œë¹„ìŠ¤ ë° ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ì‹œí–‰í•˜ê¸° ìœ„í•´ Microsoft Azureì—ì„œ ì„¤ì •ëœ ê·œì¹™ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ì •ì±…ì€ ì¡°ì§ì´ ì ì ˆí•œ ìƒí™©ì—ì„œ ì˜¬ë°”ë¥¸ ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ì ìš©í•˜ì—¬ ìì›ì„ ë³´í˜¸í•˜ëŠ” ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.\
Conditional access ì •ì±…ì€ ê¸°ë³¸ì ìœ¼ë¡œ **ëˆ„ê°€** **ì–´ë””ì„œ** **ë¬´ì—‡ì„** **ì–´ë–»ê²Œ** ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ì§€ë¥¼ **ì •ì˜**í•©ë‹ˆë‹¤.

ì—¬ê¸° ëª‡ ê°€ì§€ ì˜ˆê°€ ìˆìŠµë‹ˆë‹¤:

1. **ë¡œê·¸ì¸ ìœ„í—˜ ì •ì±…**: ì´ ì •ì±…ì€ ë¡œê·¸ì¸ ìœ„í—˜ì´ ê°ì§€ë  ë•Œ ë‹¤ë‹¨ê³„ ì¸ì¦(MFA)ì„ ìš”êµ¬í•˜ë„ë¡ ì„¤ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ í–‰ë™ì´ ì •ê¸°ì ì¸ íŒ¨í„´ê³¼ ë¹„êµí•˜ì—¬ ë¹„ì •ìƒì ì¼ ê²½ìš°, ì˜ˆë¥¼ ë“¤ì–´ ë‹¤ë¥¸ êµ­ê°€ì—ì„œ ë¡œê·¸ì¸í•˜ëŠ” ê²½ìš°, ì‹œìŠ¤í…œì€ ì¶”ê°€ ì¸ì¦ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. **ì¥ì¹˜ ì¤€ìˆ˜ ì •ì±…**: ì´ ì •ì±…ì€ ì¡°ì§ì˜ ë³´ì•ˆ ê¸°ì¤€ì„ ì¤€ìˆ˜í•˜ëŠ” ì¥ì¹˜ì—ë§Œ Azure ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ìµœì‹  ë°”ì´ëŸ¬ìŠ¤ ë°±ì‹  ì†Œí”„íŠ¸ì›¨ì–´ê°€ ì„¤ì¹˜ëœ ì¥ì¹˜ë‚˜ íŠ¹ì • ìš´ì˜ ì²´ì œ ë²„ì „ì„ ì‹¤í–‰í•˜ëŠ” ì¥ì¹˜ì—ì„œë§Œ ì•¡ì„¸ìŠ¤ë¥¼ í—ˆìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## Conditional Access Policies Bypasses

ì¡°ê±´ë¶€ ì•¡ì„¸ìŠ¤ ì •ì±…ì´ **ìš°íšŒí•  ìˆ˜ ìˆëŠ” ì •ë³´ë¥¼ ì‰½ê²Œ ì¡°ì‘í•˜ê³  ìˆì„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤**. ì˜ˆë¥¼ ë“¤ì–´, ì •ì±…ì´ MFAë¥¼ êµ¬ì„±í•˜ê³  ìˆë‹¤ë©´ ê³µê²©ìëŠ” ì´ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì¥ì¹˜ í”Œë«í¼ - ì¥ì¹˜ ì¡°ê±´

**ì¥ì¹˜ í”Œë«í¼**(Android, iOS, Windows, macOS)ì„ ê¸°ë°˜ìœ¼ë¡œ ì¡°ê±´ì„ ì„¤ì •í•  ìˆ˜ ìˆì§€ë§Œ, ì´ëŠ” **ì‚¬ìš©ì ì—ì´ì „íŠ¸**ì— ê¸°ë°˜í•˜ë¯€ë¡œ ìš°íšŒí•˜ê¸°ê°€ ë§¤ìš° ì‰½ìŠµë‹ˆë‹¤. ëª¨ë“  ì˜µì…˜ì—ì„œ MFAë¥¼ ê°•ì œí•˜ë”ë¼ë„, **ì¸ì‹í•˜ì§€ ëª»í•˜ëŠ” ì‚¬ìš©ì ì—ì´ì „íŠ¸**ë¥¼ ì‚¬ìš©í•˜ë©´ MFAë¥¼ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ìœ„ì¹˜: êµ­ê°€, IP ë²”ìœ„ - ì¥ì¹˜ ì¡°ê±´

ë¬¼ë¡  ì´ê²ƒì´ ì¡°ê±´ë¶€ ì •ì±…ì— ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´, ê³µê²©ìëŠ” **í—ˆìš©ëœ êµ­ê°€**ì—ì„œ **VPN**ì„ ì‚¬ìš©í•˜ê±°ë‚˜ **í—ˆìš©ëœ IP ì£¼ì†Œ**ì—ì„œ ì ‘ê·¼í•  ë°©ë²•ì„ ì°¾ì•„ ì´ëŸ¬í•œ ì¡°ê±´ì„ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Office365 í´ë¼ì´ì–¸íŠ¸ ì•±

í´ë¼ì´ì–¸íŠ¸ê°€ **ë¸Œë¼ìš°ì €ì—ì„œ Office 365 ì•±ì— ì ‘ê·¼í•  ê²½ìš° MFAê°€ í•„ìš”í•˜ë‹¤ê³  ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

ì´ë¥¼ ìš°íšŒí•˜ê¸° ìœ„í•´, ë°ìŠ¤í¬í†± ì• í”Œë¦¬ì¼€ì´ì…˜(ì˜ˆ: ë‹¤ìŒ ì˜ˆì˜ Microsoft Teams)ì—ì„œ ì•±ì— ë¡œê·¸ì¸í•˜ëŠ” ì²™í•˜ì—¬ ë³´í˜¸ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Microsoft Teams ì•±ì€ ë§ì€ ê¶Œí•œì„ ê°€ì§€ê³  ìˆìœ¼ë¯€ë¡œ, í•´ë‹¹ ì ‘ê·¼ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="success" %}
ë¯¸ë¦¬ ì •ì˜ëœ Office365 ê¶Œí•œì„ ê°€ì§„ ë” ë§ì€ ê³µê°œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ I**Dë¥¼ roadtools ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:**

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

ì´ ê³µê²©ì€ ê¸°ë³¸ì ìœ¼ë¡œ ê³µê°œ Office365 ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¼ë¶€ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ê°€ì§€ê¸° ë•Œë¬¸ì— íŠ¹íˆ í¥ë¯¸ë¡­ìŠµë‹ˆë‹¤.

### ë‹¤ë¥¸ ì•±ë“¤

ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©ìê°€ ë§Œë“  ë‹¤ë¥¸ ì•±ì€ ê¶Œí•œì´ ì—†ìœ¼ë©° ë¹„ê³µê°œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê·¸ëŸ¬ë‚˜ ì‚¬ìš©ìëŠ” **ê³µê°œ** **ì•±**ì„ ìƒì„±í•˜ì—¬ ì¼ë¶€ **ê¶Œí•œ**ì„ ë¶€ì—¬í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ì •ì±…ì´ **ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ MFAë¥¼ ìš”êµ¬í•˜ë„ë¡ ì„¤ì •ëœ** ì ì¬ì ì¸ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ì‚¬ìš©ìê°€ **ë¸Œë¼ìš°ì €**ë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤ë©´(ì•„ë§ˆë„ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ê¸° ë•Œë¬¸ì— ìœ ì¼í•œ ë°©ë²•ì¼ ê²ƒì…ë‹ˆë‹¤), **í”„ë¡ì‹œ ì• í”Œë¦¬ì¼€ì´ì…˜**ì´ ìˆì„ ê²½ìš° -ì‚¬ìš©ìë¥¼ ëŒ€ì‹ í•˜ì—¬ **ë‹¤ë¥¸ ì•±ê³¼ ìƒí˜¸ì‘ìš©í•  ìˆ˜ ìˆëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜**-, ì‚¬ìš©ìëŠ” **í”„ë¡ì‹œ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë¡œê·¸ì¸**í•œ ë‹¤ìŒ ì´ í”„ë¡ì‹œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í†µí•´ **ì²˜ìŒì— MFAë¡œ ë³´í˜¸ëœ ì•±ì— ë¡œê·¸ì¸**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) ë° [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) ê¸°ìˆ ì„ í™•ì¸í•˜ì„¸ìš”.

## ë‹¤ë¥¸ Az MFA ìš°íšŒ ë°©ë²•

### ë§í†¤

Azure MFA ì˜µì…˜ ì¤‘ í•˜ë‚˜ëŠ” **êµ¬ì„±ëœ ì „í™”ë²ˆí˜¸ë¡œ ì „í™”ë¥¼ ë°›ëŠ” ê²ƒ**ì´ë©°, ì—¬ê¸°ì„œ ì‚¬ìš©ìì—ê²Œ **ë¬¸ì `#`ì„ ë³´ë‚´ë„ë¡ ìš”ì²­**í•©ë‹ˆë‹¤.

{% hint style="danger" %}
ë¬¸ìëŠ” ë‹¨ì§€ **í†¤**ì´ê¸° ë•Œë¬¸ì—, ê³µê²©ìëŠ” ì „í™”ë²ˆí˜¸ì˜ **ìŒì„± ë©”ì¼** ë©”ì‹œì§€ë¥¼ **íƒ€í˜‘**í•˜ê³  ë©”ì‹œì§€ë¡œ **`#`ì˜ í†¤**ì„ ì„¤ì •í•œ ë‹¤ìŒ, MFA ìš”ì²­ ì‹œ **í”¼í•´ìì˜ ì „í™”ê°€ í†µí™” ì¤‘**ì¸ì§€ í™•ì¸í•˜ì—¬ Azure ì „í™”ë¥¼ ìŒì„± ë©”ì¼ë¡œ ë¦¬ë””ë ‰ì…˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### ì¤€ìˆ˜ ì¥ì¹˜

ì •ì±…ì€ ì¢…ì¢… ì¤€ìˆ˜ ì¥ì¹˜ ë˜ëŠ” MFAë¥¼ ìš”êµ¬í•˜ë¯€ë¡œ, **ê³µê²©ìëŠ” ì¤€ìˆ˜ ì¥ì¹˜ë¥¼ ë“±ë¡**í•˜ê³  **PRT** í† í°ì„ ì–»ì–´ **ì´ ë°©ë²•ìœ¼ë¡œ MFAë¥¼ ìš°íšŒ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¨¼ì € **Intuneì— ì¤€ìˆ˜ ì¥ì¹˜ë¥¼ ë“±ë¡**í•œ ë‹¤ìŒ, **PRTë¥¼ ì–»ìœ¼ì„¸ìš”**:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
ë‹¤ìŒ í˜ì´ì§€ì—ì„œ ì´ëŸ¬í•œ ì¢…ë¥˜ì˜ ê³µê²©ì— ëŒ€í•œ ì¶”ê°€ ì •ë³´ë¥¼ ì°¾ìœ¼ì‹­ì‹œì˜¤:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## ë„êµ¬

### [roadrecon](https://github.com/dirkjanm/ROADtools)

ëª¨ë“  ì •ì±… ê°€ì ¸ì˜¤ê¸°
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweepëŠ” ì œê³µëœ ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ì—¬ **ë‹¤ì–‘í•œ Microsoft ì„œë¹„ìŠ¤ì— ë¡œê·¸ì¸í•˜ë ¤ê³  ì‹œë„í•˜ê³  MFAê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ ì‹ë³„í•˜ë ¤ê³  ì‹œë„í•˜ëŠ” PowerShell ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤**. ì¡°ê±´ë¶€ ì•¡ì„¸ìŠ¤ ì •ì±… ë° ê¸°íƒ€ ë‹¤ë‹¨ê³„ ì¸ì¦ ì„¤ì •ì´ êµ¬ì„±ë˜ëŠ” ë°©ì‹ì— ë”°ë¼ ì¼ë¶€ í”„ë¡œí† ì½œì€ ë‹¨ì¼ ìš”ì†Œë¡œ ë‚¨ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ ADFS êµ¬ì„±ì— ëŒ€í•œ ì¶”ê°€ ê²€ì‚¬ê°€ ìˆìœ¼ë©°, ê°ì§€ëœ ê²½ìš° ì˜¨í”„ë ˆë¯¸ìŠ¤ ADFS ì„œë²„ì— ë¡œê·¸ì¸í•˜ë ¤ê³  ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey tokenì€ Conditional Access Policiesë¥¼ ê²€ì¦í•´ì•¼ í•˜ëŠ” ë³´ì•ˆ ì»¨ì„¤í„´íŠ¸ë¥¼ ë•ê¸° ìœ„í•œ ê¸°ëŠ¥ ì§‘í•©ì…ë‹ˆë‹¤. 2FAê°€ í™œì„±í™”ëœ Microsoft í¬í„¸ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ë“±ì„ í¬í•¨í•©ë‹ˆë‹¤.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**ê° í¬í„¸ì„ í…ŒìŠ¤íŠ¸**í•˜ì—¬ **MFA ì—†ì´ ë¡œê·¸ì¸í•  ìˆ˜ ìˆëŠ”ì§€** í™•ì¸í•˜ì‹­ì‹œì˜¤:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Because the **Azure** **portal** is **not constrained** it's possible to **gather a token from the portal endpoint to access any service detected** by the previous execution. In this case Sharepoint was identified, and a token to access it is requested:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

í† í°ì´ Sites.Read.All (Sharepointì—ì„œ) ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ê³  ê°€ì •í•  ë•Œ, MFA ë•Œë¬¸ì— ì›¹ì—ì„œ Sharepointì— ì ‘ê·¼í•  ìˆ˜ ì—†ë”ë¼ë„, ìƒì„±ëœ í† í°ì„ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ì— ì ‘ê·¼í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## References

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
