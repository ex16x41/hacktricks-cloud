# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne Informacije

Azure Conditional Access politike su pravila postavljena u Microsoft Azure-u za sprovoÄ‘enje kontrola pristupa Azure uslugama i aplikacijama na osnovu odreÄ‘enih **uslova**. Ove politike pomaÅ¾u organizacijama da osiguraju svoje resurse primenom pravih kontrola pristupa u pravim okolnostima.\
Conditional access politike u osnovi **definiÅ¡u** **Ko** moÅ¾e pristupiti **ÄŒemu** sa **Gde** i **Kako**.

Evo nekoliko primera:

1. **Sign-In Risk Policy**: Ova politika moÅ¾e biti postavljena da zahteva multi-factor authentication (MFA) kada se otkrije rizik pri prijavljivanju. Na primer, ako je ponaÅ¡anje korisnika pri prijavljivanju neobiÄno u poreÄ‘enju sa njihovim redovnim obrascem, kao Å¡to je prijavljivanje iz druge zemlje, sistem moÅ¾e zatraÅ¾iti dodatnu autentifikaciju.
2. **Device Compliance Policy**: Ova politika moÅ¾e ograniÄiti pristup Azure uslugama samo na ureÄ‘aje koji su u skladu sa sigurnosnim standardima organizacije. Na primer, pristup moÅ¾e biti dozvoljen samo sa ureÄ‘aja koji imaju aÅ¾uriran antivirusni softver ili koriste odreÄ‘enu verziju operativnog sistema.

## ZaobilaÅ¾enje Conditional Access Politika

MoguÄ‡e je da conditional access politika **proverava neke informacije koje se lako mogu izmeniti omoguÄ‡avajuÄ‡i zaobilaÅ¾enje politike**. I ako je, na primer, politika konfigurisala MFA, napadaÄ Ä‡e moÄ‡i da je zaobiÄ‘e.

### Device Platforms - Uslov UreÄ‘aja

MoguÄ‡e je postaviti uslov na osnovu **platforme ureÄ‘aja** (Android, iOS, Windows, macOS), meÄ‘utim, ovo se zasniva na **user-agent** pa je priliÄno lako zaobiÄ‡i. ÄŒak i **ako sve opcije primenjuju MFA**, ako koristite **user-agent koji ne prepoznaje** moÄ‡i Ä‡ete da zaobiÄ‘ete MFA.

### Lokacije: Zemlje, IP opsezi - Uslov UreÄ‘aja

Naravno, ako je ovo postavljeno u conditional politici, napadaÄ moÅ¾e jednostavno koristiti **VPN** u **dozvoljenoj zemlji** ili pokuÅ¡ati pronaÄ‡i naÄin da pristupi sa **dozvoljene IP adrese** kako bi zaobiÅ¡ao ove uslove.

### Office365 Klijent Aplikacije

MoÅ¾ete naznaÄiti da ako klijenti **pristupaju Office 365 aplikacijama iz pretraÅ¾ivaÄa, potrebna je MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Da biste ovo zaobiÅ¡li, moguÄ‡e je pretvarati se da se prijavljujete u aplikaciju sa desktop aplikacije (kao Å¡to je Microsoft Teams u sledeÄ‡em primeru) Å¡to Ä‡e zaobiÄ‡i zaÅ¡titu:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Kao Å¡to Microsoft Teams aplikacija ima mnogo dozvola, moÄ‡i Ä‡ete da koristite taj pristup.

{% hint style="success" %}
MoÅ¾ete pronaÄ‡i I**D viÅ¡e javnih aplikacija** sa unapred definisanim Office365 dozvolama u bazi podataka roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Ovaj napad je posebno interesantan jer Ä‡e po defaultu javne Office365 aplikacije imati dozvole za pristup nekim podacima.

### Druge aplikacije

Po defaultu, druge aplikacije koje kreiraju korisnici neÄ‡e imati dozvole i mogu biti privatne.\
MeÄ‘utim, korisnici takoÄ‘e mogu kreirati **javne** **aplikacije** dajuÄ‡i im neke **dozvole.**

Potencijalni scenario gde je politika postavljena da **zahteva MFA za pristup aplikaciji** kada korisnik koristi **pregledaÄ** (moÅ¾da zato Å¡to je to web aplikacija i stoga Ä‡e to biti jedini naÄin), ako postoji **proxy aplikacija** - aplikacija kojoj je dozvoljeno da **interaguje sa drugim aplikacijama u ime korisnika** - korisnik moÅ¾e **prijaviti se u proxy aplikaciju** i zatim kroz ovu proxy aplikaciju **prijaviti se u prvobitno MFA zaÅ¡tiÄ‡enu aplikaciju**.

Proverite tehnike [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) i [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Drugi Az MFA zaobilasci

### Ring tone

Jedna od opcija za Azure MFA je da **primite poziv na konfigurisan broj telefona** gde Ä‡e se od korisnika traÅ¾iti da **poÅ¡alje karakter `#`**.

{% hint style="danger" %}
PoÅ¡to su karakteri samo **tonovi**, napadaÄ moÅ¾e **kompromitovati** **glasovnu poÅ¡tu** broja telefona, konfigurisati kao poruku **ton `#`** i zatim, kada zatraÅ¾i MFA, osigurati da je **telefon Å¾rtve zauzet** (pozivajuÄ‡i ga) tako da se Azure poziv preusmeri na glasovnu poÅ¡tu.
{% endhint %}

### UsklaÄ‘eni ureÄ‘aji

Politike Äesto zahtevaju usklaÄ‘eni ureÄ‘aj ili MFA, tako da **napadaÄ moÅ¾e registrovati usklaÄ‘eni ureÄ‘aj**, dobiti **PRT** token i **zaobiÄ‡i MFA na ovaj naÄin**.

PoÄnite registracijom **usklaÄ‘enog ureÄ‘aja u Intune**, zatim **dobijte PRT** sa:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
PronaÄ‘ite viÅ¡e informacija o ovoj vrsti napada na sledeÄ‡oj stranici:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Alati

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Preuzmite sve politike
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep je PowerShell skripta koja pokuÅ¡ava da **se prijavi na razne Microsoft servise koristeÄ‡i dati set kredencijala i pokuÅ¡a da identifikuje da li je MFA omoguÄ‡en**. U zavisnosti od toga kako su konfigurisane politike uslovnog pristupa i druga podeÅ¡avanja za viÅ¡efaktorsku autentifikaciju, neki protokoli mogu ostati sa jednim faktorom. TakoÄ‘e ima dodatnu proveru za ADFS konfiguracije i moÅ¾e pokuÅ¡ati da se prijavi na on-prem ADFS server ako je detektovan.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token je skup funkcija koje imaju za cilj da pomognu bezbednosnim konsultantima koji treba da validiraju Conditional Access Policies, testiraju Microsoft portale sa omoguÄ‡enim 2FA, itd.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Testirajte svaki portal** da li je moguÄ‡e **prijaviti se bez MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Zato Å¡to **Azure** **portal** nije ograniÄen, moguÄ‡e je prikupiti token sa portal endpoint-a za pristup bilo kojoj usluzi otkrivenoj prethodnim izvrÅ¡enjem. U ovom sluÄaju je identifikovan Sharepoint, i zatraÅ¾en je token za pristup:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

PretpostavljajuÄ‡i da token ima dozvolu Sites.Read.All (iz Sharepoint-a), Äak i ako ne moÅ¾ete pristupiti Sharepoint-u sa web-a zbog MFA, moguÄ‡e je koristiti token za pristup fajlovima sa generisanim tokenom:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Reference

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
