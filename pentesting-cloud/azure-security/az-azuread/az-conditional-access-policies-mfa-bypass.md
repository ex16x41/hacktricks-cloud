# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

Azure æ¡ä»¶è®¿é—®ç­–ç•¥æ˜¯ Microsoft Azure ä¸­è®¾ç½®çš„è§„åˆ™ï¼Œç”¨äºæ ¹æ®æŸäº›**æ¡ä»¶**å¯¹ Azure æœåŠ¡å’Œåº”ç”¨ç¨‹åºå®æ–½è®¿é—®æ§åˆ¶ã€‚è¿™äº›ç­–ç•¥å¸®åŠ©ç»„ç»‡åœ¨é€‚å½“çš„æƒ…å†µä¸‹åº”ç”¨æ­£ç¡®çš„è®¿é—®æ§åˆ¶ï¼Œä»è€Œä¿æŠ¤å…¶èµ„æºã€‚\
æ¡ä»¶è®¿é—®ç­–ç•¥åŸºæœ¬ä¸Š**å®šä¹‰**äº†**è°**å¯ä»¥ä»**å“ªé‡Œ**ä»¥åŠ**å¦‚ä½•**è®¿é—®**ä»€ä¹ˆ**ã€‚

ä»¥ä¸‹æ˜¯å‡ ä¸ªç¤ºä¾‹ï¼š

1. **ç™»å½•é£é™©ç­–ç•¥**ï¼šæ­¤ç­–ç•¥å¯ä»¥è®¾ç½®ä¸ºåœ¨æ£€æµ‹åˆ°ç™»å½•é£é™©æ—¶è¦æ±‚å¤šå› ç´ è®¤è¯ (MFA)ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·çš„ç™»å½•è¡Œä¸ºä¸å…¶å¸¸è§„æ¨¡å¼ä¸åŒï¼Œå¦‚ä»ä¸åŒå›½å®¶ç™»å½•ï¼Œç³»ç»Ÿå¯ä»¥æç¤ºè¿›è¡Œé¢å¤–çš„è®¤è¯ã€‚
2. **è®¾å¤‡åˆè§„æ€§ç­–ç•¥**ï¼šæ­¤ç­–ç•¥å¯ä»¥é™åˆ¶åªæœ‰ç¬¦åˆç»„ç»‡å®‰å…¨æ ‡å‡†çš„è®¾å¤‡æ‰èƒ½è®¿é—® Azure æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œåªå…è®¸å…·æœ‰æœ€æ–°é˜²ç—…æ¯’è½¯ä»¶æˆ–è¿è¡Œç‰¹å®šæ“ä½œç³»ç»Ÿç‰ˆæœ¬çš„è®¾å¤‡è®¿é—®ã€‚

## æ¡ä»¶è®¿é—®ç­–ç•¥ç»•è¿‡

æœ‰å¯èƒ½æ¡ä»¶è®¿é—®ç­–ç•¥**æ£€æŸ¥ä¸€äº›å¯ä»¥è½»æ˜“ç¯¡æ”¹çš„ä¿¡æ¯ï¼Œä»è€Œå…è®¸ç»•è¿‡ç­–ç•¥**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç­–ç•¥é…ç½®äº† MFAï¼Œæ”»å‡»è€…å°†èƒ½å¤Ÿç»•è¿‡å®ƒã€‚

### è®¾å¤‡å¹³å° - è®¾å¤‡æ¡ä»¶

å¯ä»¥æ ¹æ®**è®¾å¤‡å¹³å°**ï¼ˆAndroidã€iOSã€Windowsã€macOSï¼‰è®¾ç½®æ¡ä»¶ï¼Œä½†è¿™æ˜¯åŸºäº**ç”¨æˆ·ä»£ç†**ï¼Œå› æ­¤å¾ˆå®¹æ˜“ç»•è¿‡ã€‚å³ä½¿**æ‰€æœ‰é€‰é¡¹éƒ½å¼ºåˆ¶æ‰§è¡Œ MFA**ï¼Œå¦‚æœä½¿ç”¨**æœªè¯†åˆ«çš„ç”¨æˆ·ä»£ç†**ï¼Œä¹Ÿå¯ä»¥ç»•è¿‡ MFAã€‚

### ä½ç½®ï¼šå›½å®¶ã€IP èŒƒå›´ - è®¾å¤‡æ¡ä»¶

å½“ç„¶ï¼Œå¦‚æœåœ¨æ¡ä»¶ç­–ç•¥ä¸­è®¾ç½®äº†è¿™ä¸€ç‚¹ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨**VPN**è¿æ¥åˆ°**å…è®¸çš„å›½å®¶**æˆ–å°è¯•æ‰¾åˆ°ä»**å…è®¸çš„ IP åœ°å€**è®¿é—®çš„æ–¹æ³•æ¥ç»•è¿‡è¿™äº›æ¡ä»¶ã€‚

### Office365 å®¢æˆ·ç«¯åº”ç”¨

å¯ä»¥æŒ‡ç¤ºå¦‚æœå®¢æˆ·ç«¯**ä»æµè§ˆå™¨è®¿é—® Office 365 åº”ç”¨éœ€è¦ MFA**ï¼š

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

è¦ç»•è¿‡è¿™ä¸€ç‚¹ï¼Œå¯ä»¥å‡è£…ä»æ¡Œé¢åº”ç”¨ç¨‹åºï¼ˆä¾‹å¦‚ Microsoft Teamsï¼‰ç™»å½•åº”ç”¨ç¨‹åºï¼Œè¿™å°†ç»•è¿‡ä¿æŠ¤ï¼š
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
ç”±äº Microsoft Teams åº”ç”¨å…·æœ‰å¤§é‡æƒé™ï¼Œæ‚¨å°†èƒ½å¤Ÿä½¿ç”¨è¯¥è®¿é—®æƒé™ã€‚

{% hint style="success" %}
æ‚¨å¯ä»¥åœ¨ roadtools çš„æ•°æ®åº“ä¸­æ‰¾åˆ°å…·æœ‰é¢„å®šä¹‰ Office365 æƒé™çš„**æ›´å¤šå…¬å…±åº”ç”¨ç¨‹åºçš„ ID**ï¼š

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

è¿™ç§æ”»å‡»ç‰¹åˆ«æœ‰è¶£ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼Œå…¬å…±Office365åº”ç”¨ç¨‹åºå°†æœ‰æƒé™è®¿é—®æŸäº›æ•°æ®ã€‚

### å…¶ä»–åº”ç”¨ç¨‹åº

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·åˆ›å»ºçš„å…¶ä»–åº”ç”¨ç¨‹åºå°†æ²¡æœ‰æƒé™å¹¶ä¸”å¯èƒ½æ˜¯ç§æœ‰çš„ã€‚\
ç„¶è€Œï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥åˆ›å»º**å…¬å…±** **åº”ç”¨ç¨‹åº**ï¼Œæˆäºˆå®ƒä»¬ä¸€äº›**æƒé™**ã€‚

ä¸€ä¸ªæ½œåœ¨çš„åœºæ™¯æ˜¯ï¼Œå½“ç”¨æˆ·ä½¿ç”¨**æµè§ˆå™¨**è®¿é—®åº”ç”¨ç¨‹åºæ—¶ï¼Œç­–ç•¥è®¾ç½®ä¸º**éœ€è¦MFA**ï¼ˆå¯èƒ½å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªWebåº”ç”¨ç¨‹åºï¼Œå› æ­¤è¿™æ˜¯å”¯ä¸€çš„æ–¹å¼ï¼‰ï¼Œå¦‚æœæœ‰ä¸€ä¸ª**ä»£ç†åº”ç”¨ç¨‹åº**â€”â€”ä¸€ä¸ªå…è®¸**ä»£è¡¨ç”¨æˆ·ä¸å…¶ä»–åº”ç”¨ç¨‹åºäº¤äº’**çš„åº”ç”¨ç¨‹åºï¼Œç”¨æˆ·å¯ä»¥**ç™»å½•ä»£ç†åº”ç”¨ç¨‹åº**ï¼Œç„¶åé€šè¿‡è¿™ä¸ªä»£ç†åº”ç”¨ç¨‹åº**ç™»å½•åˆ°æœ€åˆå—MFAä¿æŠ¤çš„åº”ç”¨ç¨‹åº**ã€‚

æŸ¥çœ‹[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep)å’Œ[**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken)æŠ€æœ¯ã€‚

## å…¶ä»–Az MFAç»•è¿‡

### é“ƒå£°

ä¸€ç§Azure MFAé€‰é¡¹æ˜¯**åœ¨é…ç½®çš„ç”µè¯å·ç ä¸Šæ¥æ”¶ä¸€ä¸ªç”µè¯**ï¼Œè¦æ±‚ç”¨æˆ·**å‘é€å­—ç¬¦`#`**ã€‚

{% hint style="danger" %}
ç”±äºå­—ç¬¦åªæ˜¯**éŸ³è°ƒ**ï¼Œæ”»å‡»è€…å¯ä»¥**æ”»ç ´**ç”µè¯å·ç çš„**è¯­éŸ³ä¿¡ç®±**æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯é…ç½®ä¸º**`#`çš„éŸ³è°ƒ**ï¼Œç„¶ååœ¨è¯·æ±‚MFAæ—¶ç¡®ä¿**å—å®³è€…çš„ç”µè¯å¿™çº¿**ï¼ˆæ‹¨æ‰“å®ƒï¼‰ï¼Œè¿™æ ·Azureçš„ç”µè¯å°±ä¼šè¢«è½¬æ¥åˆ°è¯­éŸ³ä¿¡ç®±ã€‚
{% endhint %}

### åˆè§„è®¾å¤‡

ç­–ç•¥é€šå¸¸è¦æ±‚åˆè§„è®¾å¤‡æˆ–MFAï¼Œå› æ­¤**æ”»å‡»è€…å¯ä»¥æ³¨å†Œä¸€ä¸ªåˆè§„è®¾å¤‡**ï¼Œè·å–ä¸€ä¸ª**PRT**ä»¤ç‰Œå¹¶**ä»¥æ­¤æ–¹å¼ç»•è¿‡MFA**ã€‚

é¦–å…ˆåœ¨Intuneä¸­æ³¨å†Œä¸€ä¸ª**åˆè§„è®¾å¤‡**ï¼Œç„¶åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤**è·å–PRT**ï¼š
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
åœ¨ä»¥ä¸‹é¡µé¢ä¸­æŸ¥æ‰¾æœ‰å…³æ­¤ç±»æ”»å‡»çš„æ›´å¤šä¿¡æ¯ï¼š

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## å·¥å…·

### [roadrecon](https://github.com/dirkjanm/ROADtools)

è·å–æ‰€æœ‰ç­–ç•¥
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep æ˜¯ä¸€ä¸ª PowerShell è„šæœ¬ï¼Œå°è¯•ä½¿ç”¨æä¾›çš„ä¸€ç»„å‡­æ®**ç™»å½•åˆ°å„ç§ Microsoft æœåŠ¡ï¼Œå¹¶å°è¯•è¯†åˆ«æ˜¯å¦å¯ç”¨äº† MFA**ã€‚æ ¹æ®æ¡ä»¶è®¿é—®ç­–ç•¥å’Œå…¶ä»–å¤šå› ç´ èº«ä»½éªŒè¯è®¾ç½®çš„é…ç½®æ–¹å¼ï¼Œä¸€äº›åè®®å¯èƒ½æœ€ç»ˆä¼šè¢«ç•™ä½œå•å› ç´ ã€‚å®ƒè¿˜å…·æœ‰å¯¹ ADFS é…ç½®çš„é¢å¤–æ£€æŸ¥ï¼Œå¦‚æœæ£€æµ‹åˆ°ï¼Œå¯ä»¥å°è¯•ç™»å½•åˆ°æœ¬åœ° ADFS æœåŠ¡å™¨ã€‚
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token æ˜¯ä¸€ç»„åŠŸèƒ½ï¼Œæ—¨åœ¨å¸®åŠ©éœ€è¦éªŒè¯æ¡ä»¶è®¿é—®ç­–ç•¥ã€å®‰å…¨é¡¾é—®ã€æµ‹è¯•å¯ç”¨2FAçš„Microsofté—¨æˆ·ç­‰ã€‚
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**æµ‹è¯•æ¯ä¸ªé—¨æˆ·**æ˜¯å¦å¯ä»¥**åœ¨æ²¡æœ‰ MFA çš„æƒ…å†µä¸‹ç™»å½•**ï¼š
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
å› ä¸º **Azure** **portal** **æ²¡æœ‰å—åˆ°é™åˆ¶**ï¼Œå¯ä»¥**ä»é—¨æˆ·ç«¯ç‚¹æ”¶é›†ä»¤ç‰Œä»¥è®¿é—®ä¹‹å‰æ‰§è¡Œæ£€æµ‹åˆ°çš„ä»»ä½•æœåŠ¡**ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ£€æµ‹åˆ° Sharepointï¼Œå¹¶è¯·æ±‚è®¿é—®å®ƒçš„ä»¤ç‰Œï¼š

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

å‡è®¾ä»¤ç‰Œå…·æœ‰ Sites.Read.All æƒé™ï¼ˆæ¥è‡ª Sharepointï¼‰ï¼Œå³ä½¿ç”±äº MFA æ— æ³•ä»ç½‘é¡µè®¿é—® Sharepointï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç”Ÿæˆçš„ä»¤ç‰Œè®¿é—®æ–‡ä»¶ï¼š
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## å‚è€ƒèµ„æ–™

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº« hacking æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“.

</details>
{% endhint %}
