# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Azure Conditional Access policies are rules set up in Microsoft Azure to enforce access controls to Azure services and applications based on certain **conditions**. These policies help organizations secure their resources by applying the right access controls under the right circumstances.\
Conditional access policies basically **defines** **Who** can access **What** from **Where** and **How**.

ì—¬ê¸° ëª‡ ê°€ì§€ ì˜ˆê°€ ìˆìŠµë‹ˆë‹¤:

1. **Sign-In Risk Policy**: ì´ ì •ì±…ì€ ë¡œê·¸ì¸ ìœ„í—˜ì´ ê°ì§€ë  ë•Œ ë‹¤ì¤‘ ìš”ì†Œ ì¸ì¦(MFA)ì„ ìš”êµ¬í•˜ë„ë¡ ì„¤ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ í–‰ë™ì´ í‰ì†Œì™€ ë‹¤ë¥´ê²Œ ë‹¤ë¥¸ êµ­ê°€ì—ì„œ ë¡œê·¸ì¸í•˜ëŠ” ê²½ìš° ì‹œìŠ¤í…œì€ ì¶”ê°€ ì¸ì¦ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. **Device Compliance Policy**: ì´ ì •ì±…ì€ ì¡°ì§ì˜ ë³´ì•ˆ í‘œì¤€ì„ ì¤€ìˆ˜í•˜ëŠ” ì¥ì¹˜ì—ì„œë§Œ Azure ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ìµœì‹  ì•ˆí‹°ë°”ì´ëŸ¬ìŠ¤ ì†Œí”„íŠ¸ì›¨ì–´ê°€ ì„¤ì¹˜ëœ ì¥ì¹˜ë‚˜ íŠ¹ì • ìš´ì˜ ì²´ì œ ë²„ì „ì„ ì‹¤í–‰í•˜ëŠ” ì¥ì¹˜ì—ì„œë§Œ ì ‘ê·¼ì„ í—ˆìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## Conditional Access Policies Bypasses

ì¡°ê±´ë¶€ ì•¡ì„¸ìŠ¤ ì •ì±…ì´ **ì‰½ê²Œ ì¡°ì‘í•  ìˆ˜ ìˆëŠ” ì •ë³´ë¥¼ í™•ì¸í•˜ì—¬ ì •ì±…ì„ ìš°íšŒí•  ìˆ˜ ìˆëŠ” ê²½ìš°**ê°€ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì •ì±…ì´ MFAë¥¼ êµ¬ì„±í•˜ê³  ìˆì—ˆë‹¤ë©´ ê³µê²©ìëŠ” ì´ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Device Platforms - Device Condition

**ë””ë°”ì´ìŠ¤ í”Œë«í¼**(Android, iOS, Windows, macOS)ì„ ê¸°ë°˜ìœ¼ë¡œ ì¡°ê±´ì„ ì„¤ì •í•  ìˆ˜ ìˆì§€ë§Œ, ì´ëŠ” **user-agent**ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ê¸° ë•Œë¬¸ì— ìš°íšŒí•˜ê¸° ë§¤ìš° ì‰½ìŠµë‹ˆë‹¤. ëª¨ë“  ì˜µì…˜ì— MFAë¥¼ ê°•ì œí•˜ë”ë¼ë„ **ì¸ì‹í•˜ì§€ ëª»í•˜ëŠ” user-agentë¥¼ ì‚¬ìš©í•˜ë©´** MFAë¥¼ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Locations: Countries, IP ranges - Device Condition

ë¬¼ë¡  ì¡°ê±´ë¶€ ì •ì±…ì— ì´ê²ƒì´ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´, ê³µê²©ìëŠ” **í—ˆìš©ëœ êµ­ê°€**ì—ì„œ **VPN**ì„ ì‚¬ìš©í•˜ê±°ë‚˜ **í—ˆìš©ëœ IP ì£¼ì†Œ**ì—ì„œ ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì„ ì°¾ì•„ ì´ëŸ¬í•œ ì¡°ê±´ì„ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Office365 Client Apps

í´ë¼ì´ì–¸íŠ¸ê°€ **ë¸Œë¼ìš°ì €ì—ì„œ Office 365 ì•±ì— ì ‘ê·¼í•  ë•Œ MFAê°€ í•„ìš”í•˜ë„ë¡** ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

ì´ë¥¼ ìš°íšŒí•˜ê¸° ìœ„í•´, ë°ìŠ¤í¬íƒ‘ ì• í”Œë¦¬ì¼€ì´ì…˜(ë‹¤ìŒ ì˜ˆì œì—ì„œ Microsoft Teamsì™€ ê°™ì€)ì—ì„œ ì•±ì— ë¡œê·¸ì¸í•˜ëŠ” ì²™í•˜ì—¬ ë³´í˜¸ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Microsoft Teams ì•±ì—ëŠ” ë§ì€ ê¶Œí•œì´ ìˆìœ¼ë¯€ë¡œ í•´ë‹¹ ì•¡ì„¸ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="success" %}
ì‚¬ì „ ì •ì˜ëœ Office365 ê¶Œí•œì´ ìˆëŠ” **ë” ë§ì€ ê³µê°œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ID**ëŠ” roadtoolsì˜ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

ì´ ê³µê²©ì€ ê¸°ë³¸ì ìœ¼ë¡œ ê³µìš© Office365 ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¼ë¶€ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ê°€ì§€ê¸° ë•Œë¬¸ì— íŠ¹íˆ í¥ë¯¸ë¡­ìŠµë‹ˆë‹¤.

### ë‹¤ë¥¸ ì•±ë“¤

ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©ìê°€ ìƒì„±í•œ ë‹¤ë¥¸ ì•±ë“¤ì€ ê¶Œí•œì´ ì—†ê³  ë¹„ê³µê°œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê·¸ëŸ¬ë‚˜ ì‚¬ìš©ìëŠ” ì¼ë¶€ **ê¶Œí•œì„ ë¶€ì—¬**í•˜ì—¬ **ê³µìš©** **ì•±**ì„ ìƒì„±í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ì‚¬ìš©ìê°€ **ë¸Œë¼ìš°ì €**ë¥¼ ì‚¬ìš©í•  ë•Œ **ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ MFAë¥¼ ìš”êµ¬í•˜ëŠ” ì •ì±…**ì´ ì„¤ì •ëœ ì ì¬ì  ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ (ì•„ë§ˆë„ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ê¸° ë•Œë¬¸ì— ìœ ì¼í•œ ë°©ë²•ì¼ ê²ƒì…ë‹ˆë‹¤), **í”„ë¡ì‹œ ì• í”Œë¦¬ì¼€ì´ì…˜** -ì‚¬ìš©ìë¥¼ ëŒ€ì‹ í•˜ì—¬ ë‹¤ë¥¸ ì•±ê³¼ ìƒí˜¸ì‘ìš©í•  ìˆ˜ ìˆëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜-ì´ ìˆë‹¤ë©´, ì‚¬ìš©ìëŠ” **í”„ë¡ì‹œ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë¡œê·¸ì¸**í•œ ë‹¤ìŒ ì´ í”„ë¡ì‹œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í†µí•´ **ì´ˆê¸° MFAë¡œ ë³´í˜¸ëœ ì•±ì— ë¡œê·¸ì¸**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) ë° [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) ê¸°ìˆ ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤.

## ë‹¤ë¥¸ Az MFA ìš°íšŒ ë°©ë²•

### ë²¨ì†Œë¦¬

í•˜ë‚˜ì˜ Azure MFA ì˜µì…˜ì€ **ì„¤ì •ëœ ì „í™”ë²ˆí˜¸ë¡œ ì „í™”ë¥¼ ë°›ì•„** ì‚¬ìš©ìê°€ **`#` ë¬¸ìë¥¼ ë³´ë‚´ë„ë¡ ìš”ì²­**í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

{% hint style="danger" %}
ë¬¸ìëŠ” ë‹¨ì§€ **ìŒì¡°**ì´ê¸° ë•Œë¬¸ì—, ê³µê²©ìëŠ” ì „í™”ë²ˆí˜¸ì˜ **ìŒì„±ì‚¬ì„œí•¨** ë©”ì‹œì§€ë¥¼ **`#` ìŒì¡°**ë¡œ ì„¤ì •í•˜ì—¬ **íƒ€í˜‘**í•  ìˆ˜ ìˆìœ¼ë©°, MFAë¥¼ ìš”ì²­í•  ë•Œ **í”¼í•´ìì˜ ì „í™”ê°€ í†µí™” ì¤‘**(ì „í™”ë¥¼ ê±¸ì–´)ì¸ ìƒíƒœì—ì„œ Azure ì „í™”ê°€ ìŒì„±ì‚¬ì„œí•¨ìœ¼ë¡œ ì „í™˜ë˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### ì¤€ìˆ˜ ì¥ì¹˜

ì •ì±…ì€ ì¢…ì¢… ì¤€ìˆ˜ ì¥ì¹˜ ë˜ëŠ” MFAë¥¼ ìš”êµ¬í•˜ë¯€ë¡œ, **ê³µê²©ìëŠ” ì¤€ìˆ˜ ì¥ì¹˜ë¥¼ ë“±ë¡**í•˜ê³  **PRT** í† í°ì„ ë°›ì•„ **ì´ ë°©ë²•ìœ¼ë¡œ MFAë¥¼ ìš°íšŒ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¨¼ì € **Intuneì—ì„œ ì¤€ìˆ˜ ì¥ì¹˜ë¥¼ ë“±ë¡**í•œ ë‹¤ìŒ **PRTë¥¼ ì–»ìœ¼ì‹­ì‹œì˜¤**:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
ì´ëŸ¬í•œ ì¢…ë¥˜ì˜ ê³µê²©ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒ í˜ì´ì§€ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## ë„êµ¬

### [roadrecon](https://github.com/dirkjanm/ROADtools)

ëª¨ë“  ì •ì±… ê°€ì ¸ì˜¤ê¸°
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweepì€ ì œê³µëœ ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ì–‘í•œ Microsoft ì„œë¹„ìŠ¤ì— **ë¡œê·¸ì¸í•˜ê³  MFAê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ ì‹ë³„í•˜ë ¤ê³  ì‹œë„í•˜ëŠ”** PowerShell ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤. ì¡°ê±´ë¶€ ì•¡ì„¸ìŠ¤ ì •ì±… ë° ê¸°íƒ€ ë‹¤ì¤‘ ìš”ì†Œ ì¸ì¦ ì„¤ì •ì´ êµ¬ì„±ëœ ë°©ì‹ì— ë”°ë¼ ì¼ë¶€ í”„ë¡œí† ì½œì€ ë‹¨ì¼ ìš”ì†Œë¡œ ë‚¨ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ ADFS êµ¬ì„±ì— ëŒ€í•œ ì¶”ê°€ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ë©°, ê°ì§€ë˜ë©´ ì˜¨í”„ë ˆë¯¸ìŠ¤ ADFS ì„œë²„ì— ë¡œê·¸ì¸í•˜ë ¤ê³  ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey tokenì€ Conditional Access Policiesë¥¼ ê²€ì¦í•˜ê³ , 2FAê°€ í™œì„±í™”ëœ Microsoft í¬í„¸ì„ í…ŒìŠ¤íŠ¸í•´ì•¼ í•˜ëŠ” ë³´ì•ˆ ì»¨ì„¤í„´íŠ¸ë¥¼ ë•ê¸° ìœ„í•œ í•¨ìˆ˜ ì„¸íŠ¸ì…ë‹ˆë‹¤.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**ê° í¬í„¸ì„ í…ŒìŠ¤íŠ¸**í•˜ì—¬ **MFA ì—†ì´ ë¡œê·¸ì¸**ì´ ê°€ëŠ¥í•œì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
**Azure** **í¬í„¸**ì´ **ì œí•œë˜ì§€ ì•Šê¸°** ë•Œë¬¸ì— **ì´ì „ ì‹¤í–‰ì—ì„œ ê°ì§€ëœ ëª¨ë“  ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ í¬í„¸ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ í† í°ì„ ìˆ˜ì§‘í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤**. ì´ ê²½ìš° Sharepointê°€ ì‹ë³„ë˜ì—ˆê³ , ì ‘ê·¼í•˜ê¸° ìœ„í•œ í† í°ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

í† í°ì´ Sites.Read.All (Sharepointì—ì„œ)ì˜ ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ê³  ê°€ì •í•˜ë©´, ì›¹ì—ì„œ MFA ë•Œë¬¸ì— Sharepointì— ì ‘ê·¼í•  ìˆ˜ ì—†ë”ë¼ë„ ìƒì„±ëœ í† í°ì„ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ì— ì ‘ê·¼í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## ì°¸ê³  ìë£Œ

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWS Hacking ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
