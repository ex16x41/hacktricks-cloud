# Az - Pol칤ticas de Acceso Condicional / Bypass de MFA

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Informaci칩n B치sica

Las pol칤ticas de acceso condicional de Azure son reglas establecidas en Microsoft Azure para hacer cumplir controles de acceso a servicios y aplicaciones de Azure basados en ciertas **condiciones**. Estas pol칤ticas ayudan a las organizaciones a asegurar sus recursos aplicando los controles de acceso correctos bajo las circunstancias adecuadas.\
Las pol칤ticas de acceso condicional **definen** **Qui칠n** puede acceder a **Qu칠** desde **D칩nde** y **C칩mo**.

Aqu칤 hay un par de ejemplos:

1. **Pol칤tica de Riesgo de Inicio de Sesi칩n**: Esta pol칤tica podr칤a configurarse para requerir autenticaci칩n multifactor (MFA) cuando se detecta un riesgo de inicio de sesi칩n. Por ejemplo, si el comportamiento de inicio de sesi칩n de un usuario es inusual en comparaci칩n con su patr칩n regular, como iniciar sesi칩n desde un pa칤s diferente, el sistema puede solicitar autenticaci칩n adicional.
2. **Pol칤tica de Cumplimiento de Dispositivos**: Esta pol칤tica puede restringir el acceso a los servicios de Azure solo a dispositivos que cumplan con los est치ndares de seguridad de la organizaci칩n. Por ejemplo, el acceso podr칤a permitirse solo desde dispositivos que tengan software antivirus actualizado o que est칠n ejecutando una cierta versi칩n del sistema operativo.

## Bypasses de Pol칤ticas de Acceso Condicional

Es posible que una pol칤tica de acceso condicional est칠 **verificando alguna informaci칩n que puede ser f치cilmente manipulada, permitiendo un bypass de la pol칤tica**. Y si, por ejemplo, la pol칤tica estaba configurando MFA, el atacante podr치 eludirla.

### Plataformas de Dispositivos - Condici칩n de Dispositivo

Es posible establecer una condici칩n basada en la **plataforma del dispositivo** (Android, iOS, Windows, macOS), sin embargo, esto se basa en el **user-agent**, por lo que es bastante f치cil de eludir. Incluso **haciendo que todas las opciones exijan MFA**, si usas un **user-agent que no reconoce**, podr치s eludir el MFA.

### Ubicaciones: Pa칤ses, rangos de IP - Condici칩n de Dispositivo

Por supuesto, si esto est치 configurado en la pol칤tica condicional, un atacante podr칤a simplemente usar una **VPN** en el **pa칤s permitido** o intentar encontrar una manera de acceder desde una **direcci칩n IP permitida** para eludir estas condiciones.

### Aplicaciones Cliente de Office365

Podr칤as indicar que si los clientes **acceden a las aplicaciones de Office 365 desde el navegador necesitan MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Para eludir esto, es posible pretender que inicias sesi칩n en una aplicaci칩n desde una aplicaci칩n de escritorio (como Microsoft Teams en el siguiente ejemplo) lo que eludir치 la protecci칩n:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Como la aplicaci칩n de Microsoft Teams tiene muchos permisos, podr치s utilizar ese acceso.

{% hint style="success" %}
Puedes encontrar el I**D de m치s aplicaciones p칰blicas** con permisos predefinidos de Office365 en la base de datos de roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Este ataque es especialmente interesante porque, por defecto, las aplicaciones p칰blicas de Office365 tendr치n permisos para acceder a algunos datos.

### Otras aplicaciones

Por defecto, otras aplicaciones creadas por los usuarios no tendr치n permisos y podr칤an ser privadas.\
Sin embargo, los usuarios tambi칠n podr칤an crear **aplicaciones** **p칰blicas** otorg치ndoles algunos **permisos.**

Un escenario potencial donde se establece una pol칤tica para **requerir MFA para acceder a una aplicaci칩n** cuando el usuario est치 utilizando un **navegador** (quiz치s porque es una aplicaci칩n web y, por lo tanto, ser치 la 칰nica forma), si hay una **aplicaci칩n proxy** -una aplicaci칩n permitida para **interactuar con otras aplicaciones en nombre de los usuarios**-, el usuario podr칤a **iniciar sesi칩n en la aplicaci칩n proxy** y luego, a trav칠s de esta aplicaci칩n proxy, **iniciar sesi칩n en la aplicaci칩n inicialmente protegida por MFA**.

Consulta las t칠cnicas de [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) y [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Otros Bypass de MFA de Az

### Tono de llamada

Una opci칩n de Azure MFA es **recibir una llamada en el n칰mero de tel칠fono configurado** donde se le pedir치 al usuario que **env칤e el car치cter `#`**.

{% hint style="danger" %}
Como los caracteres son solo **tonos**, un atacante podr칤a **comprometer** el mensaje de **buz칩n de voz** del n칰mero de tel칠fono, configurar como mensaje el **tono de `#`** y luego, al solicitar el MFA, asegurarse de que el **tel칠fono de la v칤ctima est칠 ocupado** (llam치ndolo) para que la llamada de Azure se redirija al buz칩n de voz.
{% endhint %}

### Dispositivos compatibles

Las pol칤ticas a menudo piden un dispositivo compatible o MFA, por lo que un **atacante podr칤a registrar un dispositivo compatible**, obtener un **token PRT** y **eludir de esta manera el MFA**.

Comienza registrando un **dispositivo compatible en Intune**, luego **obt칠n el PRT** con:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Encuentra m치s informaci칩n sobre este tipo de ataque en la siguiente p치gina:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Herramientas

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Obt칠n todas las pol칤ticas
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep es un script de PowerShell que intenta **iniciar sesi칩n en varios servicios de Microsoft utilizando un conjunto de credenciales proporcionado y tratar치 de identificar si MFA est치 habilitado**. Dependiendo de c칩mo est칠n configuradas las pol칤ticas de acceso condicional y otros ajustes de autenticaci칩n multifactor, algunos protocolos pueden terminar siendo de un solo factor. Tambi칠n tiene una verificaci칩n adicional para configuraciones de ADFS y puede intentar iniciar sesi칩n en el servidor ADFS local si se detecta.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token es un conjunto de funciones que tienen como objetivo ayudar a los consultores de seguridad que necesitan validar las Pol칤ticas de Acceso Condicional, pruebas para portales de Microsoft habilitados para 2FA, etc.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Prueba cada portal** si es posible **iniciar sesi칩n sin MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Porque el **portal** de **Azure** **no est치 restringido**, es posible **recolectar un token del endpoint del portal para acceder a cualquier servicio detectado** por la ejecuci칩n anterior. En este caso, se identific칩 Sharepoint, y se solicita un token para acceder a 칠l:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Suponiendo que el token tiene el permiso Sites.Read.All (de Sharepoint), incluso si no puedes acceder a Sharepoint desde la web debido a MFA, es posible usar el token para acceder a los archivos con el token generado:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Referencias

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
