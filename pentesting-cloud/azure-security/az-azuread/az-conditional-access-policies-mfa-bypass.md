# Az - Politike uslovnog pristupa / MFA zaobilaÅ¾enje

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

Azure politike uslovnog pristupa su pravila postavljena u Microsoft Azure-u za sprovoÄ‘enje kontrola pristupa uslugama i aplikacijama Azure na osnovu odreÄ‘enih **uslova**. Ove politike pomaÅ¾u organizacijama da osiguraju svoje resurse primenom pravih kontrola pristupa pod pravim okolnostima.\
Politike uslovnog pristupa u osnovi **definiÅ¡u** **Ko** moÅ¾e pristupiti **ÄŒemu** iz **Gde** i **Kako**.

Evo nekoliko primera:

1. **Politika rizika prijavljivanja**: Ova politika moÅ¾e biti postavljena da zahteva viÅ¡efaktorsku autentifikaciju (MFA) kada se otkrije rizik prijavljivanja. Na primer, ako je ponaÅ¡anje korisnika prilikom prijavljivanja neobiÄno u poreÄ‘enju sa njihovim redovnim obrascem, kao Å¡to je prijavljivanje iz druge zemlje, sistem moÅ¾e zatraÅ¾iti dodatnu autentifikaciju.
2. **Politika usklaÄ‘enosti ureÄ‘aja**: Ova politika moÅ¾e ograniÄiti pristup uslugama Azure samo na ureÄ‘aje koji su usklaÄ‘eni sa bezbednosnim standardima organizacije. Na primer, pristup moÅ¾e biti dozvoljen samo sa ureÄ‘aja koji imaju aÅ¾uriran antivirusni softver ili koji koriste odreÄ‘enu verziju operativnog sistema.

## ZaobilaÅ¾enje politika uslovnog pristupa

MoguÄ‡e je da politika uslovnog pristupa **proverava neke informacije koje se lako mogu izmeniti, Å¡to omoguÄ‡ava zaobilaÅ¾enje politike**. I ako je, na primer, politika konfigurisala MFA, napadaÄ Ä‡e moÄ‡i da je zaobiÄ‘e.

### Platforme ureÄ‘aja - Uslov ureÄ‘aja

MoguÄ‡e je postaviti uslov na osnovu **platforme ureÄ‘aja** (Android, iOS, Windows, macOS), meÄ‘utim, ovo se zasniva na **user-agent-u**, tako da je priliÄno lako zaobiÄ‡i. ÄŒak i **ako se sve opcije primenjuju na MFA**, ako koristite **user-agent koji ne prepoznaje**, moÄ‡i Ä‡ete da zaobiÄ‘ete MFA.

### Lokacije: DrÅ¾ave, IP opsezi - Uslov ureÄ‘aja

Naravno, ako je ovo postavljeno u uslovnoj politici, napadaÄ bi mogao jednostavno da koristi **VPN** u **dozvoljenoj zemlji** ili pokuÅ¡ati da pronaÄ‘e naÄin da pristupi sa **dozvoljene IP adrese** kako bi zaobiÅ¡ao ove uslove.

### Office365 Klijentske aplikacije

MoÅ¾ete naznaÄiti da ako klijenti **pristupaju Office 365 aplikacijama putem pregledaÄa, potrebna im je MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Da biste to zaobiÅ¡li, moguÄ‡e je pretvarati se da se prijavljujete u aplikaciju iz desktop aplikacije (kao Å¡to je Microsoft Teams u sledeÄ‡em primeru) Å¡to Ä‡e zaobiÄ‡i zaÅ¡titu:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Kao Å¡to aplikacija Microsoft Teams ima mnogo dozvola, moÄ‡i Ä‡ete da iskoristite taj pristup.

{% hint style="success" %}
MoÅ¾ete pronaÄ‡i I**D viÅ¡e javnih aplikacija** sa unapred definisanim Office365 dozvolama u bazi podataka roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Ovaj napad je posebno zanimljiv jer Ä‡e po defaultu javne Office365 aplikacije imati dozvole za pristup nekim podacima.

### Druge aplikacije

Po defaultu, druge aplikacije koje kreiraju korisnici neÄ‡e imati dozvole i mogle bi biti privatne.\
MeÄ‘utim, korisnici takoÄ‘e mogu kreirati **javne** **aplikacije** koje im dodeljuju neke **dozvole.**

Potencijalni scenario gde je politika postavljena da **zahteva MFA za pristup aplikaciji** kada korisnik koristi **pregledaÄ** (moÅ¾da zato Å¡to je to web aplikacija i stoga Ä‡e to biti jedini naÄin), ako postoji **proxy aplikacija** - aplikacija koja je dozvoljena da **interaguje sa drugim aplikacijama u ime korisnika** - korisnik bi mogao **da se prijavi u proxy aplikaciju** i zatim kroz ovu proxy aplikaciju **da se prijavi u prvobitno MFA zaÅ¡tiÄ‡enu aplikaciju**.

Proverite [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) i [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) tehnike.

## Ostali Az MFA zaobilaÅ¾enja

### Ton zvona

Jedna od Azure MFA opcija je da **primi poziv na konfigurisanom broju telefona** gde Ä‡e biti zatraÅ¾eno od korisnika da **poÅ¡alje znak `#`**.

{% hint style="danger" %}
PoÅ¡to su znakovi samo **tonovi**, napadaÄ bi mogao **kompromitovati** **poruku govora** na broju telefona, konfiguriÅ¡uÄ‡i kao poruku **ton `#`** i zatim, kada se zahteva MFA, osigurati da je **telefon Å¾rtve zauzet** (pozivajuÄ‡i ga) tako da se Azure poziv preusmeri na govornu poÅ¡tu.
{% endhint %}

### UsklaÄ‘eni ureÄ‘aji

Politike Äesto zahtevaju usklaÄ‘eni ureÄ‘aj ili MFA, tako da bi **napadaÄ mogao registrovati usklaÄ‘eni ureÄ‘aj**, dobiti **PRT** token i **na ovaj naÄin zaobiÄ‡i MFA**.

ZapoÄnite registracijom **usklaÄ‘enog ureÄ‘aja u Intune**, zatim **dobijte PRT** sa:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
PronaÄ‘ite viÅ¡e informacija o ovoj vrsti napada na sledeÄ‡oj stranici:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Alati

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Dobijte sve politike
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep je PowerShell skripta koja pokuÅ¡ava da **prijavi na razne Microsoft usluge koristeÄ‡i dati skup kredencijala i pokuÅ¡aÄ‡e da identifikuje da li je MFA omoguÄ‡ena**. U zavisnosti od toga kako su konfigurirane politike uslovnog pristupa i druge postavke viÅ¡efaktorske autentifikacije, neki protokoli mogu ostati sa jednim faktorom. TakoÄ‘e ima dodatnu proveru za ADFS konfiguracije i moÅ¾e pokuÅ¡ati da se prijavi na lokalni ADFS server ako je otkriven.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token je skup funkcija koje imaju za cilj da pomognu bezbednosnim konsultantima koji treba da validiraju politike uslovnog pristupa, testove za Microsoft portale sa 2FA, itd.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Testirajte svaki portal** da li je moguÄ‡e **prijaviti se bez MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Zato Å¡to **Azure** **portal** **nije ograniÄen**, moguÄ‡e je **prikupiti token sa krajnje taÄke portala za pristup bilo kojoj usluzi koja je otkrivena** prethodnom izvrÅ¡avanjem. U ovom sluÄaju, Sharepoint je identifikovan, i traÅ¾i se token za pristup:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

PretpostavljajuÄ‡i da token ima dozvolu Sites.Read.All (iz Sharepoint-a), Äak i ako ne moÅ¾ete da pristupite Sharepoint-u putem veba zbog MFA, moguÄ‡e je koristiti token za pristup datotekama sa generisanim tokenom:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Reference

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
