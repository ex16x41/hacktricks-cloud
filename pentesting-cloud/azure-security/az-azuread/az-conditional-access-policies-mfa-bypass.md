# Az - Bedingte Zugriffsrichtlinien / MFA-Umgehung

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Grundinformationen

Azure-Bedingte Zugriffsrichtlinien sind Regeln, die in Microsoft Azure eingerichtet sind, um den Zugriff auf Azure-Dienste und -Anwendungen basierend auf bestimmten **Bedingungen** durchzusetzen. Diese Richtlinien helfen Organisationen, ihre Ressourcen zu sichern, indem sie die richtigen Zugriffskontrollen unter den richtigen Umst√§nden anwenden.\
Bedingte Zugriffsrichtlinien **definieren** im Wesentlichen **Wer** auf **Was** von **Wo** und **Wie** zugreifen kann.

Hier sind ein paar Beispiele:

1. **Anmelderisiko-Richtlinie**: Diese Richtlinie k√∂nnte so eingestellt werden, dass sie eine Multi-Faktor-Authentifizierung (MFA) erfordert, wenn ein Anmelderisiko erkannt wird. Wenn das Anmeldeverhalten eines Benutzers beispielsweise im Vergleich zu seinem regul√§ren Muster ungew√∂hnlich ist, wie z. B. das Anmelden aus einem anderen Land, kann das System zus√§tzliche Authentifizierung anfordern.
2. **Ger√§te-Compliance-Richtlinie**: Diese Richtlinie kann den Zugriff auf Azure-Dienste nur auf Ger√§te beschr√§nken, die den Sicherheitsstandards der Organisation entsprechen. Beispielsweise k√∂nnte der Zugriff nur von Ger√§ten erlaubt werden, die √ºber aktuelle Antivirensoftware verf√ºgen oder eine bestimmte Version des Betriebssystems ausf√ºhren.

## Umgehungen der bedingten Zugriffsrichtlinien

Es ist m√∂glich, dass eine bedingte Zugriffsrichtlinie **einige Informationen √ºberpr√ºft, die leicht manipuliert werden k√∂nnen, was eine Umgehung der Richtlinie erm√∂glicht**. Und wenn beispielsweise die Richtlinie MFA konfiguriert hat, kann der Angreifer sie umgehen.

### Ger√§teplattformen - Ger√§tebedingung

Es ist m√∂glich, eine Bedingung basierend auf der **Ger√§teplattform** (Android, iOS, Windows, macOS) festzulegen, jedoch basiert dies auf dem **User-Agent**, sodass es ziemlich einfach ist, dies zu umgehen. Selbst wenn **alle Optionen MFA erzwingen**, k√∂nnen Sie mit einem **User-Agent, den es nicht erkennt**, die MFA umgehen.

### Standorte: L√§nder, IP-Bereiche - Ger√§tebedingung

Nat√ºrlich, wenn dies in der bedingten Richtlinie festgelegt ist, k√∂nnte ein Angreifer einfach ein **VPN** im **erlaubten Land** verwenden oder versuchen, einen Weg zu finden, um von einer **erlaubten IP-Adresse** aus auf diese Bedingungen zuzugreifen.

### Office365-Client-Apps

Sie k√∂nnten angeben, dass, wenn Clients **auf Office 365-Apps √ºber den Browser zugreifen, sie MFA ben√∂tigen**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Um dies zu umgehen, ist es m√∂glich, vorzut√§uschen, dass Sie sich √ºber eine Desktop-Anwendung (wie Microsoft Teams im folgenden Beispiel) in eine App einloggen, was den Schutz umgeht:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Da die Microsoft Teams-App viele Berechtigungen hat, k√∂nnen Sie diesen Zugriff nutzen.

{% hint style="success" %}
Sie k√∂nnen die I**D von weiteren √∂ffentlichen Anwendungen** mit vordefinierten Office365-Berechtigungen in der Datenbank von roadtools finden:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Dieser Angriff ist besonders interessant, da standardm√§√üig √∂ffentliche Office365-Anwendungen Berechtigungen zum Zugriff auf einige Daten haben.

### Andere Apps

Standardm√§√üig haben andere von Benutzern erstellte Apps keine Berechtigungen und k√∂nnten privat sein.\
Benutzer k√∂nnten jedoch auch **√∂ffentliche** **Apps** erstellen, die ihnen einige **Berechtigungen** gew√§hren.

Ein potenzielles Szenario, in dem eine Richtlinie **MFA f√ºr den Zugriff auf eine Anwendung** erfordert, wenn der Benutzer einen **Browser** verwendet (vielleicht, weil es sich um eine Webanwendung handelt und dies daher der einzige Weg sein wird), k√∂nnte sein, dass es eine **Proxy-Anwendung** gibt - eine Anwendung, die **im Auftrag von Benutzern mit anderen Apps interagieren darf**. Der Benutzer k√∂nnte sich **in der Proxy-Anwendung anmelden** und dann √ºber diese Proxy-Anwendung **in die urspr√ºnglich MFA-gesch√ºtzte App einloggen**.

√úberpr√ºfen Sie die [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) und die [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) Techniken.

## Andere Az MFA Umgehungen

### Klingelton

Eine Azure MFA-Option besteht darin, **einen Anruf an die konfigurierte Telefonnummer zu erhalten**, bei dem der Benutzer gebeten wird, das Zeichen `#` **zu senden**.

{% hint style="danger" %}
Da Zeichen nur **T√∂ne** sind, k√∂nnte ein Angreifer die **Voicemail**-Nachricht der Telefonnummer kompromittieren, die Nachricht so konfigurieren, dass der **Ton von `#`** wiedergegeben wird, und dann, wenn die MFA angefordert wird, sicherstellen, dass das **Telefon des Opfers besetzt ist** (indem er anruft), sodass der Azure-Anruf an die Voicemail umgeleitet wird.
{% endhint %}

### Konforme Ger√§te

Richtlinien verlangen oft ein konformes Ger√§t oder MFA, sodass ein **Angreifer ein konformes Ger√§t registrieren** und ein **PRT**-Token erhalten k√∂nnte, um auf diese Weise die MFA **zu umgehen**.

Beginnen Sie mit der Registrierung eines **konformen Ger√§ts in Intune**, und holen Sie dann den **PRT** mit:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Finden Sie weitere Informationen zu dieser Art von Angriff auf der folgenden Seite:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Tooling

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Holen Sie sich alle Richtlinien
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep ist ein PowerShell-Skript, das versucht, **sich mit einem bereitgestellten Satz von Anmeldeinformationen bei verschiedenen Microsoft-Diensten anzumelden und zu identifizieren, ob MFA aktiviert ist**. Je nachdem, wie die bedingten Zugriffsrichtlinien und andere Einstellungen zur Multi-Faktor-Authentifizierung konfiguriert sind, k√∂nnen einige Protokolle als Einzel-Faktor verbleiben. Es gibt auch eine zus√§tzliche √úberpr√ºfung der ADFS-Konfigurationen und kann versuchen, sich beim lokalen ADFS-Server anzumelden, wenn dieser erkannt wird.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token ist eine Reihe von Funktionen, die darauf abzielen, Sicherheitsberatern zu helfen, die Conditional Access Policies validieren, Tests f√ºr 2FA-aktivierte Microsoft-Portale usw. durchf√ºhren m√ºssen.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Testen Sie jedes Portal**, ob es m√∂glich ist, sich **ohne MFA** anzumelden:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Weil das **Azure** **Portal** **nicht eingeschr√§nkt** ist, ist es m√∂glich, ein **Token vom Portal-Endpunkt zu sammeln, um auf jeden Dienst zuzugreifen, der durch die vorherige Ausf√ºhrung erkannt wurde**. In diesem Fall wurde Sharepoint identifiziert, und ein Token zum Zugriff darauf wird angefordert:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Angenommen, das Token hat die Berechtigung Sites.Read.All (von Sharepoint), selbst wenn Sie aufgrund von MFA nicht auf Sharepoint √ºber das Web zugreifen k√∂nnen, ist es m√∂glich, das Token zu verwenden, um auf die Dateien mit dem generierten Token zuzugreifen:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Referenzen

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
