# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## 基本情報

Azure Conditional Accessポリシーは、特定の**条件**に基づいてAzureサービスおよびアプリケーションへのアクセス制御を強制するためにMicrosoft Azureで設定されたルールです。これらのポリシーは、適切な状況下で適切なアクセス制御を適用することにより、組織がリソースを保護するのに役立ちます。\
Conditional accessポリシーは基本的に**誰が**どこから**何に**どのようにアクセスできるかを**定義**します。

いくつかの例を挙げます：

1. **サインインリスクポリシー**：このポリシーは、サインインリスクが検出された場合に多要素認証（MFA）を要求するように設定できます。たとえば、ユーザーのログイン行動が通常のパターンと異なる場合、たとえば異なる国からログインしている場合、システムは追加の認証を促すことができます。
2. **デバイスコンプライアンスポリシー**：このポリシーは、組織のセキュリティ基準に準拠しているデバイスのみがAzureサービスにアクセスできるように制限できます。たとえば、最新のウイルス対策ソフトウェアがインストールされているデバイスや特定のオペレーティングシステムバージョンを実行しているデバイスからのみアクセスを許可することができます。

## Conditional Accessポリシーのバイパス

Conditional accessポリシーが**簡単に改ざんできる情報をチェックしている可能性があり、ポリシーのバイパスを許可することがあります**。たとえば、ポリシーがMFAを設定している場合、攻撃者はそれをバイパスできるでしょう。

### デバイスプラットフォーム - デバイス条件

**デバイスプラットフォーム**（Android、iOS、Windows、macOS）に基づいて条件を設定することが可能ですが、これは**ユーザーエージェント**に基づいているため、バイパスは非常に簡単です。すべてのオプションでMFAを強制しても、**認識されないユーザーエージェントを使用すれば**、MFAをバイパスできます。

### ロケーション：国、IP範囲 - デバイス条件

もちろん、これが条件付きポリシーに設定されている場合、攻撃者は**許可された国**で**VPN**を使用するか、**許可されたIPアドレス**からアクセスする方法を見つけてこれらの条件をバイパスすることができます。

### Office365クライアントアプリ

クライアントが**ブラウザからOffice 365アプリにアクセスする場合、MFAが必要**であることを示すことができます：

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

これをバイパスするために、デスクトップアプリケーションからアプリにログインしているふりをすることが可能です（以下の例ではMicrosoft Teams）これにより保護をバイパスできます：
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Microsoft Teamsアプリには多くの権限があるため、そのアクセスを利用することができます。

{% hint style="success" %}
あらかじめ定義されたOffice365権限を持つ**より多くの公開アプリケーションのI**Dをroadtoolsのデータベースで見つけることができます：

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

この攻撃は特に興味深いです。なぜなら、デフォルトではパブリックなOffice365アプリケーションがいくつかのデータにアクセスする権限を持つからです。

### その他のアプリ

デフォルトでは、ユーザーが作成した他のアプリには権限がなく、プライベートである可能性があります。\
しかし、ユーザーは**パブリック**な**アプリ**を作成し、いくつかの**権限**を付与することもできます。

ポリシーが**アプリケーションにアクセスするためにMFAを要求する**ように設定されている潜在的なシナリオでは、ユーザーが**ブラウザ**を使用している場合（おそらくそれがウェブアプリケーションであり、したがって唯一の方法であるため）、**プロキシアプリケーション** -ユーザーの代理で他のアプリと**対話することを許可されたアプリ**- がある場合、ユーザーは**プロキシアプリケーションにログイン**し、その後このプロキシアプリケーションを通じて**最初にMFAで保護されたアプリにログイン**することができます。

[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep)と[**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken)の技術を確認してください。

## その他のAz MFAバイパス

### 着信音

Azure MFAのオプションの一つは、**設定された電話番号に電話を受け取る**ことで、ユーザーに**`#`の文字を送信するように求められます**。

{% hint style="danger" %}
文字は単なる**トーン**であるため、攻撃者は電話番号の**ボイスメール**メッセージを**妨害**し、メッセージとして**`#`のトーン**を設定し、その後MFAを要求する際に**被害者の電話が通話中であることを確認**することで、Azureの電話がボイスメールにリダイレクトされるようにします。
{% endhint %}

### 準拠デバイス

ポリシーはしばしば準拠デバイスまたはMFAを要求するため、**攻撃者は準拠デバイスを登録**し、**PRT**トークンを取得し、**この方法でMFAをバイパス**することができます。

まず、**Intuneに準拠デバイスを登録**し、その後**PRTを取得**します：
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
以下のページでこの種の攻撃に関する詳細情報を見つけてください：

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## ツール

### [roadrecon](https://github.com/dirkjanm/ROADtools)

すべてのポリシーを取得する
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweepは、**提供された資格情報を使用してさまざまなMicrosoftサービスにログインし、MFAが有効かどうかを特定しようとするPowerShellスクリプトです**。条件付きアクセス ポリシーやその他の多要素認証設定がどのように構成されているかによって、一部のプロトコルは単一要素のままになる可能性があります。また、ADFS構成の追加チェックがあり、検出された場合はオンプレミスのADFSサーバーにログインしようとすることもできます。
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey tokenは、Conditional Access Policiesを検証する必要があるセキュリティコンサルタントを支援することを目的とした一連の機能です。2FAが有効なMicrosoftポータルのテストなど。
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**各ポータルをテスト**して、**MFAなしでログインできるか**確認します:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
**Azure** **ポータル**は**制約されていない**ため、**前回の実行で検出された任意のサービスにアクセスするためにポータルエンドポイントからトークンを収集することが可能です**。この場合、Sharepointが特定され、アクセスするためのトークンが要求されます：

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

トークンが Sites.Read.All (Sharepoint から) の権限を持っていると仮定すると、MFA のためにウェブから Sharepoint にアクセスできなくても、生成されたトークンを使用してファイルにアクセスすることが可能です:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## 参考文献

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWSハッキングを学び、練習する：<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCPハッキングを学び、練習する：<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを送信してください。**

</details>
{% endhint %}
