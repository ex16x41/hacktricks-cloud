# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

Azure Conditional Access politikalarÄ±, Microsoft Azure'da belirli **koÅŸullara** dayalÄ± olarak Azure hizmetlerine ve uygulamalarÄ±na eriÅŸim kontrollerini uygulamak iÃ§in oluÅŸturulan kurallardÄ±r. Bu politikalar, kuruluÅŸlarÄ±n kaynaklarÄ±nÄ± doÄŸru koÅŸullar altÄ±nda doÄŸru eriÅŸim kontrollerini uygulayarak gÃ¼vence altÄ±na almalarÄ±na yardÄ±mcÄ± olur.\
Conditional access politikalarÄ± temel olarak **Kim**'in **Neye** **Nereden** ve **NasÄ±l** eriÅŸebileceÄŸini **tanÄ±mlar**.

Ä°ÅŸte birkaÃ§ Ã¶rnek:

1. **Sign-In Risk Policy**: Bu politika, bir oturum aÃ§ma riski tespit edildiÄŸinde Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama (MFA) gerektirecek ÅŸekilde ayarlanabilir. Ã–rneÄŸin, bir kullanÄ±cÄ±nÄ±n oturum aÃ§ma davranÄ±ÅŸÄ±, dÃ¼zenli modeline kÄ±yasla alÄ±ÅŸÄ±lmadÄ±k olduÄŸunda, Ã¶rneÄŸin farklÄ± bir Ã¼lkeden oturum aÃ§Ä±yorsa, sistem ek kimlik doÄŸrulama isteyebilir.
2. **Device Compliance Policy**: Bu politika, yalnÄ±zca kuruluÅŸun gÃ¼venlik standartlarÄ±na uygun cihazlarÄ±n Azure hizmetlerine eriÅŸimini kÄ±sÄ±tlayabilir. Ã–rneÄŸin, yalnÄ±zca gÃ¼ncel antivirÃ¼s yazÄ±lÄ±mÄ±na sahip veya belirli bir iÅŸletim sistemi sÃ¼rÃ¼mÃ¼nÃ¼ Ã§alÄ±ÅŸtÄ±ran cihazlardan eriÅŸime izin verilebilir.

## Conditional Access PolitikalarÄ±nÄ± Atlatma

Bir conditional access politikasÄ±nÄ±n **kolayca deÄŸiÅŸtirilebilecek bazÄ± bilgileri kontrol etmesi ve bu politikanÄ±n atlatÄ±lmasÄ±na izin vermesi** mÃ¼mkÃ¼ndÃ¼r. Ve Ã¶rneÄŸin politika MFA'yÄ± yapÄ±landÄ±rÄ±yorsa, saldÄ±rgan bunu atlatabilir.

### Cihaz PlatformlarÄ± - Cihaz KoÅŸulu

**Cihaz platformuna** (Android, iOS, Windows, macOS) dayalÄ± bir koÅŸul ayarlamak mÃ¼mkÃ¼ndÃ¼r, ancak bu **user-agent**'a dayalÄ±dÄ±r, bu yÃ¼zden atlatmak oldukÃ§a kolaydÄ±r. TÃ¼m seÃ§enekler MFA'yÄ± zorunlu kÄ±lsa bile, **tanÄ±madÄ±ÄŸÄ± bir user-agent kullanÄ±rsanÄ±z** MFA'yÄ± atlatabilirsiniz.

### Konumlar: Ãœlkeler, IP aralÄ±klarÄ± - Cihaz KoÅŸulu

Elbette bu conditional policy'de ayarlanmÄ±ÅŸsa, bir saldÄ±rgan **izin verilen Ã¼lkede** bir **VPN** kullanabilir veya bu koÅŸullarÄ± atlatmak iÃ§in **izin verilen bir IP adresinden** eriÅŸim saÄŸlamanÄ±n bir yolunu bulabilir.

### Office365 Ä°stemci UygulamalarÄ±

Ä°stemcilerin **tarayÄ±cÄ±dan Office 365 uygulamalarÄ±na eriÅŸtiklerinde MFA gerektirdiÄŸini** belirtebilirsiniz:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Bunu atlatmak iÃ§in, bir masaÃ¼stÃ¼ uygulamasÄ±ndan (aÅŸaÄŸÄ±daki Ã¶rnekte Microsoft Teams gibi) bir uygulamaya giriÅŸ yapÄ±yormuÅŸ gibi davranmak mÃ¼mkÃ¼ndÃ¼r, bu da korumayÄ± atlatacaktÄ±r:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Microsoft Teams uygulamasÄ±nÄ±n birÃ§ok izni olduÄŸundan, bu eriÅŸimi kullanabileceksiniz.

{% hint style="success" %}
**Daha fazla genel uygulamanÄ±n** kimliÄŸini, Ã¶nceden tanÄ±mlanmÄ±ÅŸ Office365 izinleriyle birlikte roadtools veritabanÄ±nda bulabilirsiniz:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Bu saldÄ±rÄ± Ã¶zellikle ilginÃ§tir Ã§Ã¼nkÃ¼ varsayÄ±lan olarak public Office365 uygulamalarÄ± bazÄ± verilere eriÅŸim izinlerine sahip olacaktÄ±r.

### DiÄŸer uygulamalar

VarsayÄ±lan olarak, kullanÄ±cÄ±lar tarafÄ±ndan oluÅŸturulan diÄŸer uygulamalar izinlere sahip olmayacak ve Ã¶zel olabilir.\
Ancak, kullanÄ±cÄ±lar **public** **uygulamalar** oluÅŸturarak onlara bazÄ± **izinler** verebilirler.

Bir politikanÄ±n, kullanÄ±cÄ±nÄ±n bir **tarayÄ±cÄ±** kullanÄ±rken bir **uygulamaya eriÅŸmek iÃ§in MFA gerektirmesi** gerektiÄŸi bir senaryoda (belki bu bir web uygulamasÄ± olduÄŸu iÃ§in ve bu nedenle tek yol olacaktÄ±r), eÄŸer bir **proxy uygulamasÄ±** -kullanÄ±cÄ±lar adÄ±na diÄŸer uygulamalarla **etkileÅŸime girmesine izin verilen bir uygulama**- varsa, kullanÄ±cÄ± **proxy uygulamasÄ±na giriÅŸ yapabilir** ve ardÄ±ndan bu proxy uygulamasÄ± aracÄ±lÄ±ÄŸÄ±yla **baÅŸlangÄ±Ã§ta MFA korumalÄ± uygulamaya giriÅŸ yapabilir**.

[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) ve [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) tekniklerini kontrol edin.

## DiÄŸer Az MFA AtlatmalarÄ±

### Zil sesi

Bir Azure MFA seÃ§eneÄŸi, **kullanÄ±cÄ±nÄ±n yapÄ±landÄ±rÄ±lmÄ±ÅŸ telefon numarasÄ±na bir Ã§aÄŸrÄ± almasÄ±** ve kullanÄ±cÄ±dan **`#` karakterini gÃ¶ndermesinin istenmesidir**.

{% hint style="danger" %}
Karakterler sadece **tonlar** olduÄŸundan, bir saldÄ±rgan telefon numarasÄ±nÄ±n **sesli mesajÄ±nÄ±** **ele geÃ§irebilir**, mesaj olarak **`#` tonunu** yapÄ±landÄ±rabilir ve ardÄ±ndan MFA talep edildiÄŸinde **kurbanÄ±n telefonunun meÅŸgul olduÄŸundan** emin olabilir (onu arayarak) bÃ¶ylece Azure Ã§aÄŸrÄ±sÄ± sesli mesaja yÃ¶nlendirilir.
{% endhint %}

### Uyumluluk CihazlarÄ±

Politikalar genellikle uyumlu bir cihaz veya MFA ister, bu nedenle bir **saldÄ±rgan uyumlu bir cihaz kaydedebilir**, bir **PRT** token alabilir ve **bu ÅŸekilde MFA'yÄ± atlatabilir**.

Ã–ncelikle **Intune'da uyumlu bir cihaz kaydedin**, ardÄ±ndan **PRT'yi alÄ±n**:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Bu tÃ¼r saldÄ±rÄ±lar hakkÄ±nda daha fazla bilgi iÃ§in aÅŸaÄŸÄ±daki sayfaya bakÄ±n:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## AraÃ§lar

### [roadrecon](https://github.com/dirkjanm/ROADtools)

TÃ¼m politikalarÄ± alÄ±n
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep, saÄŸlanan kimlik bilgileri kÃ¼mesini kullanarak Ã§eÅŸitli Microsoft hizmetlerine **giriÅŸ yapmaya Ã§alÄ±ÅŸan ve MFA'nÄ±n etkin olup olmadÄ±ÄŸÄ±nÄ± belirlemeye Ã§alÄ±ÅŸan** bir PowerShell betiÄŸidir. KoÅŸullu eriÅŸim politikalarÄ±nÄ±n ve diÄŸer Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama ayarlarÄ±nÄ±n nasÄ±l yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±na baÄŸlÄ± olarak bazÄ± protokoller tek faktÃ¶rlÃ¼ olarak kalabilir. AyrÄ±ca ADFS yapÄ±landÄ±rmalarÄ± iÃ§in ek bir kontrolÃ¼ vardÄ±r ve tespit edilirse yerel ADFS sunucusuna giriÅŸ yapmayÄ± deneyebilir.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token, KoÅŸullu EriÅŸim PolitikalarÄ±nÄ± doÄŸrulamasÄ± gereken gÃ¼venlik danÄ±ÅŸmanlarÄ±na, 2FA etkin Microsoft portallarÄ±nÄ± test etmelerine vb. yardÄ±mcÄ± olmayÄ± amaÃ§layan bir dizi iÅŸlevdir.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Her portalÄ± test edin** eÄŸer **MFA olmadan giriÅŸ yapmak** mÃ¼mkÃ¼nse:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Ã‡Ã¼nkÃ¼ **Azure** **portalÄ±** **kÄ±sÄ±tlanmamÄ±ÅŸ**, **Ã¶nceki yÃ¼rÃ¼tme tarafÄ±ndan tespit edilen herhangi bir hizmete eriÅŸmek iÃ§in portal uÃ§ noktasÄ±ndan bir token toplamak mÃ¼mkÃ¼ndÃ¼r**. Bu durumda Sharepoint tespit edildi ve ona eriÅŸmek iÃ§in bir token talep edildi:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Tokenun Sites.Read.All (Sharepoint'tan) iznine sahip olduÄŸunu varsayarsak, web Ã¼zerinden MFA nedeniyle Sharepoint'e eriÅŸemeseniz bile, oluÅŸturulan token ile dosyalara eriÅŸmek mÃ¼mkÃ¼ndÃ¼r:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Referanslar

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸren & pratik yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸren & pratik yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.

</details>
{% endhint %}
