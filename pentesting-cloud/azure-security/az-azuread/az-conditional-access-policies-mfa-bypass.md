# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Le politiche di accesso condizionale di Azure sono regole impostate in Microsoft Azure per applicare controlli di accesso ai servizi e alle applicazioni di Azure in base a determinate **condizioni**. Queste politiche aiutano le organizzazioni a proteggere le proprie risorse applicando i giusti controlli di accesso nelle giuste circostanze.\
Le politiche di accesso condizionale **definiscono** **Chi** pu√≤ accedere a **Cosa** da **Dove** e **Come**.

Ecco un paio di esempi:

1. **Politica di rischio di accesso**: Questa politica potrebbe essere impostata per richiedere l'autenticazione a pi√π fattori (MFA) quando viene rilevato un rischio di accesso. Ad esempio, se il comportamento di accesso di un utente √® insolito rispetto al suo modello regolare, come accedere da un paese diverso, il sistema pu√≤ richiedere un'autenticazione aggiuntiva.
2. **Politica di conformit√† del dispositivo**: Questa politica pu√≤ limitare l'accesso ai servizi di Azure solo ai dispositivi che sono conformi agli standard di sicurezza dell'organizzazione. Ad esempio, l'accesso potrebbe essere consentito solo da dispositivi che hanno software antivirus aggiornato o che eseguono una certa versione del sistema operativo.

## Conditional Access Policies Bypasses

√à possibile che una politica di accesso condizionale **stia controllando alcune informazioni che possono essere facilmente manomesse, consentendo un bypass della politica**. E se ad esempio la politica fosse configurata per MFA, l'attaccante sar√† in grado di bypassarla.

### Device Platforms - Device Condition

√à possibile impostare una condizione basata sulla **piattaforma del dispositivo** (Android, iOS, Windows, macOS), tuttavia, questo si basa sul **user-agent**, quindi √® abbastanza facile da bypassare. Anche **imponendo tutte le opzioni di MFA**, se utilizzi un **user-agent che non riconosce**, sarai in grado di bypassare la MFA.

### Locations: Countries, IP ranges - Device Condition

Certo, se questo √® impostato nella politica condizionale, un attaccante potrebbe semplicemente utilizzare una **VPN** nel **paese consentito** o cercare di trovare un modo per accedere da un **indirizzo IP consentito** per bypassare queste condizioni.

### Office365 Client Apps

Potresti indicare che se i client **accedono alle app di Office 365 dal browser, hanno bisogno di MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Per bypassare questo, √® possibile fingere di accedere a un'app da un'applicazione desktop (come Microsoft Teams nell'esempio seguente) che bypasser√† la protezione:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Poich√© l'app Microsoft Teams ha molti permessi, sarai in grado di utilizzare quell'accesso.

{% hint style="success" %}
Puoi trovare l'I**D di pi√π applicazioni pubbliche** con permessi Office365 predefiniti nel database di roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Questo attacco √® particolarmente interessante perch√© per impostazione predefinita le applicazioni pubbliche di Office365 avranno permessi per accedere ad alcuni dati.

### Altre app

Per impostazione predefinita, altre app create dagli utenti non avranno permessi e potrebbero essere private.\
Tuttavia, gli utenti potrebbero anche creare **app** **pubbliche** concedendo loro alcuni **permessi.**

Uno scenario potenziale in cui una politica √® impostata per **richiedere MFA per accedere a un'applicazione** quando l'utente sta utilizzando un **browser** (forse perch√© √® un'applicazione web e quindi sar√† l'unico modo), se c'√® un **applicazione proxy** -un'applicazione autorizzata a **interagire con altre app per conto degli utenti**-, l'utente potrebbe **accedere all'applicazione proxy** e poi attraverso questa applicazione proxy **accedere all'app inizialmente protetta da MFA**.

Controlla le tecniche [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) e [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Altri bypass MFA di Az

### Suoneria

Una delle opzioni Azure MFA √® **ricevere una chiamata al numero di telefono configurato** dove verr√† chiesto all'utente di **inviare il carattere `#`**.

{% hint style="danger" %}
Poich√© i caratteri sono solo **toni**, un attaccante potrebbe **compromettere** il messaggio della **segreteria telefonica** del numero di telefono, configurare come messaggio il **tono di `#`** e poi, quando richiede l'MFA, assicurarsi che il **telefono della vittima sia occupato** (chiamandolo) in modo che la chiamata di Azure venga reindirizzata alla segreteria telefonica.
{% endhint %}

### Dispositivi conformi

Le politiche spesso richiedono un dispositivo conforme o MFA, quindi un **attaccante potrebbe registrare un dispositivo conforme**, ottenere un **token PRT** e **bypassare in questo modo l'MFA**.

Inizia registrando un **dispositivo conforme in Intune**, poi **ottieni il PRT** con:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Trova ulteriori informazioni su questo tipo di attacco nella seguente pagina:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Strumenti

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Ottieni tutte le politiche
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep √® uno script PowerShell che tenta di **accedere a vari servizi Microsoft utilizzando un set di credenziali fornito e cercher√† di identificare se MFA √® abilitato**. A seconda di come sono configurate le politiche di accesso condizionale e altre impostazioni di autenticazione multi-fattore, alcuni protocolli potrebbero finire per essere lasciati a fattore singolo. Ha anche un controllo aggiuntivo per le configurazioni ADFS e pu√≤ tentare di accedere al server ADFS on-prem se rilevato.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token √® un insieme di funzioni che mirano ad aiutare i consulenti di sicurezza che devono convalidare le Politiche di Accesso Condizionale, test per portali Microsoft abilitati 2FA, ecc..
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Testa ogni portale** se √® possibile **accedere senza MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Perch√© il **portale** **Azure** **non √® vincolato**, √® possibile **raccogliere un token dall'endpoint del portale per accedere a qualsiasi servizio rilevato** dall'esecuzione precedente. In questo caso √® stato identificato Sharepoint, e viene richiesto un token per accedervi:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Supponendo che il token abbia il permesso Sites.Read.All (da Sharepoint), anche se non puoi accedere a Sharepoint dal web a causa di MFA, √® possibile utilizzare il token per accedere ai file con il token generato:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Riferimenti

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Impara e pratica il hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Impara e pratica il hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos su github.

</details>
{% endhint %}
