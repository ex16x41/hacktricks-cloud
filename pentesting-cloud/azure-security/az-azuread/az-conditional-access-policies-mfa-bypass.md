# Az - Koşullu Erişim Politikaları / MFA Atlatma

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Bize katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi** **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

## Temel Bilgiler

Azure Koşullu Erişim politikaları, belirli **koşullara** dayalı olarak Azure hizmetlerine ve uygulamalarına erişim kontrollerini uygulamak için Microsoft Azure'da kurulan kurallardır. Bu politikalar, organizasyonların doğru koşullar altında doğru erişim kontrollerini uygulayarak kaynaklarını güvence altına almasına yardımcı olur.\
Koşullu erişim politikaları temelde **Kim**'in **Neyi** **Nereden** ve **Nasıl** erişebileceğini **tanımlar**.

İşte birkaç örnek:

1. **Oturum Açma Risk Politikası**: Bu politika, bir oturum açma riski tespit edildiğinde çok faktörlü kimlik doğrulama (MFA) gerektirecek şekilde ayarlanabilir. Örneğin, bir kullanıcının oturum açma davranışı, farklı bir ülkeden oturum açmak gibi, normal desenine kıyasla alışılmadıksa, sistem ek kimlik doğrulama talep edebilir.
2. **Cihaz Uygunluk Politikası**: Bu politika, yalnızca organizasyonun güvenlik standartlarına uygun cihazların Azure hizmetlerine erişimini kısıtlayabilir. Örneğin, yalnızca güncel antivirüs yazılımına sahip veya belirli bir işletim sistemi sürümünü çalıştıran cihazlardan erişime izin verilebilir.

## Koşullu Erişim Politikası Atlatmaları

Bir koşullu erişim politikasının **kolayca manipüle edilebilecek bazı bilgileri kontrol etmesi mümkündür, bu da politikanın atlatılmasına olanak tanır**. Örneğin, politika MFA'yı yapılandırıyorsa, saldırgan bunu atlatabilecektir.

### Cihaz Platformları - Cihaz Koşulu

**Cihaz platformuna** (Android, iOS, Windows, macOS) dayalı bir koşul ayarlamak mümkündür, ancak bu **kullanıcı aracısı** (user-agent) temelinde olduğu için atlatılması oldukça kolaydır. Tüm seçenekleri MFA'yı zorunlu kılacak şekilde ayarlasanız bile, **tanımadığı bir kullanıcı aracısı** kullanırsanız MFA'yı atlatabilirsiniz.

### Lokasyonlar: Ülkeler, IP aralıkları - Cihaz Koşulu

Elbette, bu koşullu politikada ayarlanmışsa, bir saldırgan sadece **izin verilen ülkede** bir **VPN** kullanabilir veya bu koşulları atlatmak için **izin verilen bir IP adresinden** erişim sağlamanın bir yolunu bulmaya çalışabilir.

### Office365 İstemci Uygulamaları

Eğer istemcilerin **Office 365 uygulamalarına tarayıcıdan erişim sağlarken MFA'ya ihtiyaç duyduğunu** belirtebilirsiniz:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Bunu atlatmak için, bir masaüstü uygulamasından (aşağıdaki örnekte Microsoft Teams gibi) bir uygulamaya giriş yapıyormuş gibi davranmak mümkündür; bu da korumayı atlatacaktır:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Microsoft Teams uygulaması birçok izne sahip olduğundan, bu erişimi kullanabileceksiniz.

{% hint style="success" %}
Önceden tanımlanmış Office365 izinlerine sahip daha fazla genel uygulamanın I**D'sini** roadtools veritabanında bulabilirsiniz:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Bu saldırı özellikle ilginçtir çünkü varsayılan olarak, kamuya açık Office365 uygulamaları bazı verilere erişim iznine sahip olacaktır.

### Diğer uygulamalar

Varsayılan olarak, kullanıcılar tarafından oluşturulan diğer uygulamalar izinlere sahip olmayacak ve özel olabilir.\
Ancak, kullanıcılar ayrıca bazı **izinler** veren **kamuya açık** **uygulamalar** oluşturabilirler.

Bir politikanın **bir uygulamaya erişim için MFA gerektirecek şekilde ayarlandığı** potansiyel bir senaryo, kullanıcı bir **tarayıcı** kullanıyorsa (belki de bir web uygulaması olduğu için ve dolayısıyla tek yol bu olacaktır), eğer bir **proxy uygulama** -kullanıcılar adına diğer uygulamalarla **etkileşimde bulunmasına izin verilen bir uygulama**- varsa, kullanıcı **proxy uygulamasında oturum açabilir** ve ardından bu proxy uygulaması aracılığıyla **ilk başta MFA korumalı uygulamaya oturum açabilir**.

[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) ve [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) tekniklerini kontrol edin.

## Diğer Az MFA Atlatmaları

### Zil sesi

Bir Azure MFA seçeneği, **yapılandırılmış telefon numarasına bir çağrı almak** ve kullanıcıdan **`#` karakterini göndermesini istemektir**.

{% hint style="danger" %}
Karakterler sadece **tonlar** olduğundan, bir saldırgan **sesli mesaj** ile telefon numarasının **sesli mesaj** kaydını ele geçirebilir, mesaj olarak **`#` tonunu** ayarlayabilir ve ardından MFA talep edildiğinde **kurbanın telefonunun meşgul olduğundan emin olabilir** (aramak suretiyle) böylece Azure çağrısı sesli mesaja yönlendirilir.
{% endhint %}

### Uyumlu Cihazlar

Politikalar genellikle uyumlu bir cihaz veya MFA talep eder, bu nedenle bir **saldırgan uyumlu bir cihaz kaydedebilir**, bir **PRT** token alabilir ve **bu şekilde MFA'yı atlayabilir**.

Öncelikle **Intune'da uyumlu bir cihaz kaydederek** başlayın, ardından **PRT'yi** almak için:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Aşağıdaki sayfada bu tür bir saldırı hakkında daha fazla bilgi bulabilirsiniz:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Araçlar

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Tüm politikaları alın
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep, sağlanan bir kimlik bilgileri setini kullanarak **çeşitli Microsoft hizmetlerine giriş yapmayı deneyen ve MFA'nın etkin olup olmadığını belirlemeye çalışan bir PowerShell betiğidir**. Koşullu erişim politikaları ve diğer çok faktörlü kimlik doğrulama ayarlarının nasıl yapılandırıldığına bağlı olarak bazı protokoller tek faktörlü kalabilir. Ayrıca, ADFS yapılandırmaları için ek bir kontrol içerir ve tespit edilirse yerel ADFS sunucusuna giriş yapmayı deneyebilir.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token, Koşullu Erişim Politikalarını doğrulamak, 2FA etkinleştirilmiş Microsoft portalları için testler yapmak gibi ihtiyaçları olan güvenlik danışmanlarına yardımcı olmayı amaçlayan bir dizi işlevdir.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Her bir portalı test edin** eğer **MFA olmadan giriş yapmak mümkünse**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Çünkü **Azure** **portalı** **kısıtlanmamıştır**, önceki yürütme tarafından tespit edilen herhangi bir hizmete erişmek için portal uç noktasından **bir token toplamak** mümkündür. Bu durumda Sharepoint tanımlandı ve ona erişmek için bir token talep edildi:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Diyelim ki token, Sites.Read.All (Sharepoint'tan) iznine sahip. MFA nedeniyle web üzerinden Sharepoint'a erişemeseniz bile, oluşturulan token ile dosyalara erişmek için token'ı kullanmak mümkündür:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Referanslar

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter**'da **bizi takip edin** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
