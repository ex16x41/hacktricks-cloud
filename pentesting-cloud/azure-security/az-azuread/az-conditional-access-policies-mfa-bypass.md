# Az - Polityki dostpu warunkowego / Ominicie MFA

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Podstawowe informacje

Polityki dostpu warunkowego Azure to zasady ustalone w Microsoft Azure, aby egzekwowa kontrole dostpu do usug i aplikacji Azure na podstawie okrelonych **warunk贸w**. Polityki te pomagaj organizacjom zabezpieczy swoje zasoby, stosujc odpowiednie kontrole dostpu w odpowiednich okolicznociach.\
Polityki dostpu warunkowego zasadniczo **okrelaj** **Kto** mo偶e uzyska dostp do **Czego** z **Gdzie** i **Jak**.

Oto kilka przykad贸w:

1. **Polityka ryzyka logowania**: Ta polityka mo偶e by ustawiona na wymaganie uwierzytelnienia wieloskadnikowego (MFA), gdy wykryto ryzyko logowania. Na przykad, jeli zachowanie logowania u偶ytkownika jest nietypowe w por贸wnaniu do jego regularnego wzorca, na przykad logujc si z innego kraju, system mo偶e poprosi o dodatkowe uwierzytelnienie.
2. **Polityka zgodnoci urzdze**: Ta polityka mo偶e ograniczy dostp do usug Azure tylko do urzdze, kt贸re s zgodne z normami bezpieczestwa organizacji. Na przykad, dostp mo偶e by dozwolony tylko z urzdze, kt贸re maj aktualne oprogramowanie antywirusowe lub dziaaj na okrelonej wersji systemu operacyjnego.

## Ominicia polityk dostpu warunkowego

Mo偶liwe jest, 偶e polityka dostpu warunkowego **sprawdza pewne informacje, kt贸re mo偶na atwo zmanipulowa, co pozwala na ominicie polityki**. A jeli na przykad polityka konfigurowaa MFA, atakujcy bdzie m贸g j obej.

### Platformy urzdze - Warunek urzdzenia

Mo偶liwe jest ustawienie warunku na podstawie **platformy urzdzenia** (Android, iOS, Windows, macOS), jednak opiera si to na **user-agencie**, wic jest to do atwe do ominicia. Nawet **wymuszajc wszystkie opcje MFA**, jeli u偶yjesz **user-agenta, kt贸rego nie rozpoznaje**, bdziesz m贸g obej MFA.

### Lokalizacje: Kraje, zakresy IP - Warunek urzdzenia

Oczywicie, jeli to jest ustawione w polityce warunkowej, atakujcy mo偶e po prostu u偶y **VPN** w **dozwolonym kraju** lub spr贸bowa znale藕 spos贸b na dostp z **dozwolonego adresu IP**, aby obej te warunki.

### Aplikacje klienckie Office365

Mo偶esz wskaza, 偶e jeli klienci **uzyskuj dostp do aplikacji Office 365 z przegldarki, potrzebuj MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Aby to obej, mo偶liwe jest udawanie, 偶e logujesz si do aplikacji z aplikacji desktopowej (jak w przypadku Microsoft Teams w poni偶szym przykadzie), co obejdzie ochron:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Jako 偶e aplikacja Microsoft Teams ma wiele uprawnie, bdziesz m贸g wykorzysta ten dostp.

{% hint style="success" %}
Mo偶esz znale藕 I**D bardziej publicznych aplikacji** z predefiniowanymi uprawnieniami Office365 w bazie danych roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Ten atak jest szczeg贸lnie interesujcy, poniewa偶 domylnie publiczne aplikacje Office365 bd miay uprawnienia do dostpu do niekt贸rych danych.

### Inne aplikacje

Domylnie inne aplikacje tworzone przez u偶ytkownik贸w nie bd miay uprawnie i mog by prywatne.\
Jednak u偶ytkownicy mog r贸wnie偶 tworzy **publiczne** **aplikacje**, przyznajc im pewne **uprawnienia.**

Potencjalny scenariusz, w kt贸rym polityka jest ustawiona na **wymaganie MFA do uzyskania dostpu do aplikacji**, gdy u偶ytkownik korzysta z **przegldarki** (mo偶e dlatego, 偶e jest to aplikacja internetowa i dlatego bdzie to jedyny spos贸b), jeli istnieje **aplikacja proxy** - aplikacja dozwolona do **interakcji z innymi aplikacjami w imieniu u偶ytkownik贸w** - u偶ytkownik m贸gby **zalogowa si do aplikacji proxy**, a nastpnie przez t aplikacj proxy **zalogowa si do pocztkowo chronionej aplikacji MFA**.

Sprawd藕 techniki [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) i [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Inne obejcia MFA Az

### Dzwonek

Jedn z opcji Azure MFA jest **otrzymanie poczenia na skonfigurowany numer telefonu**, gdzie u偶ytkownik zostanie poproszony o **wysanie znaku `#`**.

{% hint style="danger" %}
Poniewa偶 znaki to tylko **tony**, atakujcy m贸gby **skomprymowa** wiadomo **poczty gosowej** na numerze telefonu, skonfigurowa jako wiadomo **ton `#`** i nastpnie, gdy bdzie 偶dane MFA, upewni si, 偶e **telefon ofiary jest zajty** (dzwonic do niego), aby poczenie Azure zostao przekierowane do poczty gosowej.
{% endhint %}

### Zgodne urzdzenia

Polityki czsto wymagaj zgodnego urzdzenia lub MFA, wic **atakujcy m贸gby zarejestrowa zgodne urzdzenie**, uzyska token **PRT** i **w ten spos贸b obej MFA**.

Zacznij od zarejestrowania **zgodnego urzdzenia w Intune**, a nastpnie **uzyskaj PRT** za pomoc:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Znajd藕 wicej informacji na temat tego rodzaju ataku na nastpujcej stronie:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Narzdzia

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Pobierz wszystkie polityki
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep to skrypt PowerShell, kt贸ry pr贸buje **zalogowa si do r贸偶nych usug Microsoftu, u偶ywajc podanego zestawu powiadcze i spr贸buje zidentyfikowa, czy MFA jest wczone**. W zale偶noci od tego, jak skonfigurowane s zasady dostpu warunkowego i inne ustawienia uwierzytelniania wieloskadnikowego, niekt贸re protokoy mog pozosta jako jednoskadnikowe. Posiada r贸wnie偶 dodatkowe sprawdzenie konfiguracji ADFS i mo偶e pr贸bowa zalogowa si do lokalnego serwera ADFS, jeli zostanie wykryty.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token to zestaw funkcji, kt贸re maj na celu pomoc konsultantom ds. bezpieczestwa, kt贸rzy musz weryfikowa Polityki Dostpu Warunkowego, testy dla portali Microsoft z wczonym 2FA itp.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Przetestuj ka偶dy portal**, czy mo偶liwe jest **zalogowanie si bez MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Poniewa偶 **portal** **Azure** **nie jest ograniczony**, mo偶liwe jest **zdobycie tokena z punktu kocowego portalu, aby uzyska dostp do dowolnej usugi wykrytej** w poprzednim wykonaniu. W tym przypadku zidentyfikowano Sharepoint, a token do uzyskania dostpu do niego jest 偶dany:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Zakadajc, 偶e token ma uprawnienia Sites.Read.All (z Sharepoint), nawet jeli nie mo偶esz uzyska dostpu do Sharepoint z sieci z powodu MFA, mo偶liwe jest u偶ycie tokena do uzyskania dostpu do plik贸w za pomoc wygenerowanego tokena:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## References

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
