# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Azure Conditional Access рдиреАрддрд┐рдпрд╛рдБ Microsoft Azure рдореЗрдВ рдирд┐рдпрдо рд╣реИрдВ рдЬреЛ Azure рд╕реЗрд╡рд╛рдУрдВ рдФрд░ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рдирд┐рдпрдВрддреНрд░рдг рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХреА рдЬрд╛рддреА рд╣реИрдВ, рдЬреЛ рдХреБрдЫ **рд╢рд░реНрддреЛрдВ** рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд╣реЛрддреА рд╣реИрдВред рдпреЗ рдиреАрддрд┐рдпрд╛рдБ рд╕рдВрдЧрдардиреЛрдВ рдХреЛ рд╕рд╣реА рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рд╕рд╣реА рдкрд╣реБрдБрдЪ рдирд┐рдпрдВрддреНрд░рдг рд▓рд╛рдЧреВ рдХрд░рдХреЗ рдЕрдкрдиреЗ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦрдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддреА рд╣реИрдВред\
Conditional access рдиреАрддрд┐рдпрд╛рдБ рдореВрд▓ рд░реВрдк рд╕реЗ **рдпрд╣ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреА рд╣реИрдВ** **рдХреМрди** **рдХреНрдпрд╛** **рдХрд╣рд╛рдБ** рдФрд░ **рдХреИрд╕реЗ** рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИред

рдпрд╣рд╛рдБ рдХреБрдЫ рдЙрджрд╛рд╣рд░рдг рджрд┐рдП рдЧрдП рд╣реИрдВ:

1. **рд╕рд╛рдЗрди-рдЗрди рдЬреЛрдЦрд┐рдо рдиреАрддрд┐**: рдпрд╣ рдиреАрддрд┐ рддрдм рд▓рд╛рдЧреВ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ рдЬрдм рд╕рд╛рдЗрди-рдЗрди рдЬреЛрдЦрд┐рдо рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдмрд╣реБ-рдХрд╛рд░рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг (MFA) рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рдХрд┐рд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рд▓реЙрдЧрд┐рди рд╡реНрдпрд╡рд╣рд╛рд░ рдЙрдирдХреЗ рдирд┐рдпрдорд┐рдд рдкреИрдЯрд░реНрди рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдЕрд╕рд╛рдорд╛рдиреНрдп рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдХрд┐рд╕реА рдЕрдиреНрдп рджреЗрд╢ рд╕реЗ рд▓реЙрдЧрд┐рди рдХрд░рдирд╛, рддреЛ рд╕рд┐рд╕реНрдЯрдо рдЕрддрд┐рд░рд┐рдХреНрдд рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рд╕рдВрдХреЗрдд рджреЗ рд╕рдХрддрд╛ рд╣реИред
2. **рдбрд┐рд╡рд╛рдЗрд╕ рдЕрдиреБрдкрд╛рд▓рди рдиреАрддрд┐**: рдпрд╣ рдиреАрддрд┐ рдХреЗрд╡рд▓ рдЙрди рдЙрдкрдХрд░рдгреЛрдВ рддрдХ Azure рд╕реЗрд╡рд╛рдУрдВ рдХреА рдкрд╣реБрдБрдЪ рдХреЛ рд╕реАрдорд┐рдд рдХрд░ рд╕рдХрддреА рд╣реИ рдЬреЛ рд╕рдВрдЧрдарди рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рдорд╛рдирдХреЛрдВ рдХреЗ рдЕрдиреБрдкрд╛рд▓рди рдореЗрдВ рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдХреЗрд╡рд▓ рдЙрди рдЙрдкрдХрд░рдгреЛрдВ рд╕реЗ рдкрд╣реБрдБрдЪ рдХреА рдЕрдиреБрдорддрд┐ рджреА рдЬрд╛ рд╕рдХрддреА рд╣реИ рдЬрд┐рдирдореЗрдВ рдЕрджреНрдпрддрди рдПрдВрдЯреАрд╡рд╛рдпрд░рд╕ рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╣реИ рдпрд╛ рдЬреЛ рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рд╕рдВрд╕реНрдХрд░рдг рдЪрд▓рд╛ рд░рд╣реЗ рд╣реИрдВред

## Conditional Access Policies Bypasses

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдПрдХ conditional access рдиреАрддрд┐ **рдХреБрдЫ рдЬрд╛рдирдХрд╛рд░реА рдХреА рдЬрд╛рдБрдЪ рдХрд░ рд░рд╣реА рд╣реЛ рдЬрд┐рд╕реЗ рдЖрд╕рд╛рдиреА рд╕реЗ рдЫреЗрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ рдиреАрддрд┐ рдХрд╛ рдмрд╛рдпрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ**ред рдФрд░ рдпрджрд┐ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдиреАрддрд┐ MFA рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд░рд╣реА рдереА, рддреЛ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕реЗ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ред

### Device Platforms - Device Condition

рдпрд╣ **рдбрд┐рд╡рд╛рдЗрд╕ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо** (Android, iOS, Windows, macOS) рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдПрдХ рд╢рд░реНрдд рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрд╣ **рдпреВрдЬрд░-рдПрдЬреЗрдВрдЯ** рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИ рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ рдХрд╛рдлреА рдЖрд╕рд╛рди рд╣реИред рдпрд╣рд╛рдБ рддрдХ рдХрд┐ **рд╕рднреА рд╡рд┐рдХрд▓реНрдкреЛрдВ рдХреЛ MFA рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдирд╛**, рдпрджрд┐ рдЖрдк рдПрдХ **рдпреВрдЬрд░-рдПрдЬреЗрдВрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рдпрд╣ рдкрд╣рдЪрд╛рдирддрд╛ рдирд╣реАрдВ рд╣реИ** рддреЛ рдЖрдк MFA рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдВрдЧреЗред

### Locations: Countries, IP ranges - Device Condition

рдмрд┐рд▓реНрдХреБрд▓, рдпрджрд┐ рдпрд╣ conditional policy рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдмрд╕ рдПрдХ **VPN** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ **рдЕрдиреБрдордд рджреЗрд╢** рдореЗрдВ рдпрд╛ рдЗрди рд╢рд░реНрддреЛрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ **рдЕрдиреБрдордд IP рдкрддреЗ** рд╕реЗ рдкрд╣реБрдБрдЪрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

### Office365 Client Apps

рдЖрдк рдпрд╣ рд╕рдВрдХреЗрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпрджрд┐ рдЧреНрд░рд╛рд╣рдХ **рдмреНрд░рд╛рдЙрдЬрд╝рд░ рд╕реЗ Office 365 рдРрдкреНрд╕ рддрдХ рдкрд╣реБрдБрдЪрддреЗ рд╣реИрдВ рддреЛ рдЙрдиреНрд╣реЗрдВ MFA рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

рдЗрд╕реЗ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЖрдк рдПрдХ рдбреЗрд╕реНрдХрдЯреЙрдк рдПрдкреНрд▓рд┐рдХреЗрд╢рди (рдЬреИрд╕реЗ рдХрд┐ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ Microsoft Teams) рд╕реЗ рдПрдХ рдРрдк рдореЗрдВ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рдХрд╛ рдирд╛рдЯрдХ рдХрд░реЗрдВ, рдЬреЛ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░реЗрдЧрд╛:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
рдЬреИрд╕реЗ рдХрд┐ Microsoft Teams рдРрдк рдХреЗ рдкрд╛рд╕ рдмрд╣реБрдд рд╕рд╛рд░реА рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рдЖрдк рдЙрд╕ рдкрд╣реБрдБрдЪ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХреЗрдВрдЧреЗред

{% hint style="success" %}
рдЖрдк рдкреВрд░реНрд╡рдирд┐рд░реНрдзрд╛рд░рд┐рдд Office365 рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдЕрдзрд┐рдХ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХрд╛ I**D рд░реЛрдбрдЯреВрд▓реНрд╕ рдХреЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

рдпрд╣ рд╣рдорд▓рд╛ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ Office365 рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЛ рдХреБрдЫ рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрдЧреАред

### рдЕрдиреНрдп рдРрдкреНрд╕

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдП рдЧрдП рдЕрдиреНрдп рдРрдкреНрд╕ рдХреЛ рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реЛрдЧреА рдФрд░ рд╡реЗ рдирд┐рдЬреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ** **рдРрдкреНрд╕** рднреА рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдЙрдиреНрд╣реЗрдВ рдХреБрдЫ **рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВред

рдПрдХ рд╕рдВрднрд╛рд╡рд┐рдд рдкрд░рд┐рджреГрд╢реНрдп рдЬрд╣рд╛рдВ рдПрдХ рдиреАрддрд┐ **рдЕрдиреБрдкреНрд░рдпреЛрдЧ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП MFA рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛** рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддреА рд╣реИ рдЬрдм рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдХ **рдмреНрд░рд╛рдЙрдЬрд╝рд░** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИ (рд╢рд╛рдпрдж рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдПрдХ рд╡реЗрдм рдЕрдиреБрдкреНрд░рдпреЛрдЧ рд╣реИ рдФрд░ рдЗрд╕рд▓рд┐рдП рдпрд╣ рдПрдХрдорд╛рддреНрд░ рддрд░реАрдХрд╛ рд╣реЛрдЧрд╛), рдпрджрд┐ рдПрдХ **рдкреНрд░реЙрдХреНрд╕реА рдЕрдиреБрдкреНрд░рдпреЛрдЧ** рд╣реИ -рдПрдХ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдЬреЛ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА рдУрд░ рд╕реЗ рдЕрдиреНрдп рдРрдкреНрд╕ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ**-, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдкреНрд░реЙрдХреНрд╕реА рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдореЗрдВ рд▓реЙрдЧрд┐рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рдФрд░ рдлрд┐рд░ рдЗрд╕ рдкреНрд░реЙрдХреНрд╕реА рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рдкреНрд░рд╛рд░рдВрднрд┐рдХ MFA-рд╕рдВрд░рдХреНрд╖рд┐рдд рдРрдк рдореЗрдВ рд▓реЙрдЧрд┐рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) рдФрд░ [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) рддрдХрдиреАрдХреЛрдВ рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВред

## рдЕрдиреНрдп Az MFA рдмрд╛рдпрдкрд╛рд╕

### рд░рд┐рдВрдЧ рдЯреЛрди

рдПрдХ Azure MFA рд╡рд┐рдХрд▓реНрдк рд╣реИ **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдлреЛрди рдирдВрдмрд░ рдкрд░ рдХреЙрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛** рдЬрд╣рд╛рдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ **рдЪрд░ `#` рднреЗрдЬрдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛рдПрдЧрд╛ред

{% hint style="danger" %}
рдЪреВрдВрдХрд┐ рдЪрд░ рдХреЗрд╡рд▓ **рд╕реНрд╡рд░** рд╣реИрдВ, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рдлреЛрди рдирдВрдмрд░ рдХреЗ рд╡реЙрдпрд╕рдореЗрд▓** рд╕рдВрджреЗрд╢ рдХреЛ **рд╕рдордЭреМрддрд╛** рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рд╕рдВрджреЗрд╢ рдХреЗ рд░реВрдк рдореЗрдВ **`#` рдХрд╛ рд╕реНрд╡рд░** рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░, рдЬрдм MFA рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ **рд╢рд┐рдХрд╛рд░ рдХрд╛ рдлреЛрди рд╡реНрдпрд╕реНрдд рд╣реИ** (рдЗрд╕реЗ рдХреЙрд▓ рдХрд░рдХреЗ) рддрд╛рдХрд┐ Azure рдХреЙрд▓ рд╡реЙрдпрд╕ рдореЗрд▓ рдкрд░ рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рд╣реЛ рдЬрд╛рдПред
{% endhint %}

### рдЕрдиреБрдкрд╛рд▓рди рдЙрдкрдХрд░рдг

рдиреАрддрд┐рдпрд╛рдБ рдЕрдХреНрд╕рд░ рдПрдХ рдЕрдиреБрдкрд╛рд▓рди рдЙрдкрдХрд░рдг рдпрд╛ MFA рдХреА рдорд╛рдВрдЧ рдХрд░рддреА рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдПрдХ **рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рдЕрдиреБрдкрд╛рд▓рди рдЙрдкрдХрд░рдг рдкрдВрдЬреАрдХреГрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ**, рдПрдХ **PRT** рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рдЗрд╕ рддрд░рд╣ MFA рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

рдПрдХ **рдЕрдиреБрдкрд╛рд▓рди рдЙрдкрдХрд░рдг рдХреЛ Intune рдореЗрдВ рдкрдВрдЬреАрдХреГрдд рдХрд░рдиреЗ** рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВ, рдлрд┐рд░ **PRT рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рд╣рдорд▓реЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рдкрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## рдЙрдкрдХрд░рдг

### [roadrecon](https://github.com/dirkjanm/ROADtools)

рд╕рднреА рдиреАрддрд┐рдпреЛрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep рдПрдХ PowerShell рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╣реИ рдЬреЛ **рдкреНрд░рджрд╛рди рдХрд┐рдП рдЧрдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд┐рднрд┐рдиреНрди Microsoft рд╕реЗрд╡рд╛рдУрдВ рдореЗрдВ рд▓реЙрдЧ рдЗрди рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреА рд╣реИ рдФрд░ рдпрд╣ рдкрд╣рдЪрд╛рдирдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреА рд╣реИ рдХрд┐ рдХреНрдпрд╛ MFA рд╕рдХреНрд╖рдо рд╣реИ**ред рдпрд╣ рдЗрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХрдВрдбреАрд╢рдирд▓ рдПрдХреНрд╕реЗрд╕ рдиреАрддрд┐рдпрд╛рдБ рдФрд░ рдЕрдиреНрдп рдорд▓реНрдЯреА-рдлреИрдХреНрдЯрд░ рдСрдереЗрдВрдЯрд┐рдХреЗрд╢рди рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреИрд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХреА рдЧрдИ рд╣реИрдВ, рдХреБрдЫ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдЕрдВрддрддрдГ рд╕рд┐рдВрдЧрд▓ рдлреИрдХреНрдЯрд░ рд░рд╣ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рдореЗрдВ ADFS рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рдЬрд╛рдВрдЪ рднреА рд╣реИ рдФрд░ рдпрджрд┐ рдкрддрд╛ рд▓рдЧрд╛рдпрд╛ рдЧрдпрд╛ рддреЛ рдпрд╣ рдСрди-рдкреНрд░рд┐рдо ADFS рд╕рд░реНрд╡рд░ рдореЗрдВ рд▓реЙрдЧ рдЗрди рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token рдПрдХ рд╕реЗрдЯ рдлрд╝рдВрдХреНрд╢рдВрд╕ рдХрд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рд╕реБрд░рдХреНрд╖рд╛ рд╕рд▓рд╛рд╣рдХрд╛рд░реЛрдВ рдХреА рдорджрдж рдХрд░рдирд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ Conditional Access Policies рдХреЛ рдорд╛рдиреНрдп рдХрд░рдиреЗ, 2FA-рд╕рдХреНрд╖рдо Microsoft рдкреЛрд░реНрдЯрд▓реЛрдВ рдХреЗ рд▓рд┐рдП рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдЖрджрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**рдкреНрд░рддреНрдпреЗрдХ рдкреЛрд░реНрдЯрд▓ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░реЗрдВ** рдХрд┐ рдХреНрдпрд╛ **MFA рдХреЗ рдмрд┐рдирд╛ рд▓реЙрдЧрд┐рди рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
рдХреНрдпреЛрдВрдХрд┐ **Azure** **рдкреЛрд░реНрдЯрд▓** **рд╕реАрдорд┐рдд рдирд╣реАрдВ рд╣реИ**, рдЗрд╕рд▓рд┐рдП **рдкреЛрд░реНрдЯрд▓ рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рдХрд┐рд╕реА рднреА рд╕реЗрд╡рд╛ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЯреЛрдХрди рдЗрдХрдЯреНрдард╛ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреЛ рдкрд┐рдЫрд▓реЗ рдирд┐рд╖реНрдкрд╛рджрди рджреНрд╡рд╛рд░рд╛ рдкрддрд╛ рд▓рдЧрд╛рдпрд╛ рдЧрдпрд╛ рдерд╛**ред рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ Sharepoint рдХреА рдкрд╣рдЪрд╛рди рдХреА рдЧрдИ, рдФрд░ рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЯреЛрдХрди рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЧрдпрд╛:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

рдорд╛рди рд▓реАрдЬрд┐рдП рдХрд┐ рдЯреЛрдХрди рдХреЗ рдкрд╛рд╕ Sites.Read.All (Sharepoint рд╕реЗ) рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, рднрд▓реЗ рд╣реА рдЖрдк MFA рдХреЗ рдХрд╛рд░рдг рд╡реЗрдм рд╕реЗ Sharepoint рддрдХ рдкрд╣реБрдБрдЪ рдирд╣реАрдВ рдкрд╛ рд░рд╣реЗ рд╣реИрдВ, рдлрд┐рд░ рднреА рдЖрдк рдЙрддреНрдкрдиреНрди рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## рд╕рдВрджрд░реНрдн

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
