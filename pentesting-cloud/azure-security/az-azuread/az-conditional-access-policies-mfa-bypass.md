# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Naucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

## Podstawowe Informacje

Azure Conditional Access policies to zasady ustanowione w Microsoft Azure w celu egzekwowania kontroli dostpu do usug i aplikacji Azure na podstawie okrelonych **warunk贸w**. Te zasady pomagaj organizacjom zabezpiecza swoje zasoby, stosujc odpowiednie kontrole dostpu w odpowiednich okolicznociach.\
Conditional access policies zasadniczo **definiuj** **Kto** mo偶e uzyska dostp do **Czego** z **Gdzie** i **Jak**.

Oto kilka przykad贸w:

1. **Sign-In Risk Policy**: Ta zasada mo偶e wymaga uwierzytelniania wieloskadnikowego (MFA) w przypadku wykrycia ryzyka logowania. Na przykad, jeli zachowanie logowania u偶ytkownika jest nietypowe w por贸wnaniu do jego regularnego wzorca, takie jak logowanie z innego kraju, system mo偶e poprosi o dodatkowe uwierzytelnienie.
2. **Device Compliance Policy**: Ta zasada mo偶e ogranicza dostp do usug Azure tylko do urzdze zgodnych ze standardami bezpieczestwa organizacji. Na przykad, dostp mo偶e by dozwolony tylko z urzdze, kt贸re maj aktualne oprogramowanie antywirusowe lub dziaaj na okrelonej wersji systemu operacyjnego.

## Omijanie Conditional Access Policies

Mo偶liwe jest, 偶e zasada conditional access **sprawdza pewne informacje, kt贸re mo偶na atwo zmanipulowa, umo偶liwiajc obejcie zasady**. A jeli na przykad zasada konfigurowaa MFA, atakujcy bdzie m贸g j omin.

### Platformy Urzdze - Warunek Urzdzenia

Mo偶liwe jest ustawienie warunku na podstawie **platformy urzdzenia** (Android, iOS, Windows, macOS), jednak jest to oparte na **user-agent**, wic jest to do atwe do obejcia. Nawet **wymuszajc MFA dla wszystkich opcji**, jeli u偶yjesz **user-agent, kt贸rego nie rozpoznaje**, bdziesz m贸g omin MFA.

### Lokalizacje: Kraje, Zakresy IP - Warunek Urzdzenia

Oczywicie, jeli jest to ustawione w zasadzie conditional, atakujcy mo偶e po prostu u偶y **VPN** w **dozwolonym kraju** lub spr贸bowa znale藕 spos贸b na dostp z **dozwolonego adresu IP**, aby omin te warunki.

### Office365 Client Apps

Mo偶esz wskaza, 偶e jeli klienci **uzyskuj dostp do aplikacji Office 365 z przegldarki, potrzebuj MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Aby to omin, mo偶na udawa, 偶e logujesz si do aplikacji z aplikacji desktopowej (jak Microsoft Teams w poni偶szym przykadzie), co pozwoli omin ochron:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Poniewa偶 aplikacja Microsoft Teams ma wiele uprawnie, bdziesz m贸g wykorzysta ten dostp.

{% hint style="success" %}
Mo偶esz znale藕 **ID bardziej publicznych aplikacji** z predefiniowanymi uprawnieniami Office365 w bazie danych roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Ten atak jest szczeg贸lnie interesujcy, poniewa偶 domylnie publiczne aplikacje Office365 bd miay uprawnienia do dostpu do niekt贸rych danych.

### Inne aplikacje

Domylnie inne aplikacje tworzone przez u偶ytkownik贸w nie bd miay uprawnie i mog by prywatne.\
Jednak u偶ytkownicy mog r贸wnie偶 tworzy **publiczne** **aplikacje**, nadajc im pewne **uprawnienia.**

Potencjalny scenariusz, w kt贸rym polityka jest ustawiona na **wymaganie MFA do uzyskania dostpu do aplikacji** podczas korzystania z **przegldarki** (mo偶e dlatego, 偶e jest to aplikacja webowa i bdzie to jedyny spos贸b), jeli istnieje **aplikacja proxy** - aplikacja, kt贸ra ma pozwolenie na **interakcj z innymi aplikacjami w imieniu u偶ytkownik贸w** - u偶ytkownik mo偶e **zalogowa si do aplikacji proxy**, a nastpnie przez t aplikacj proxy **zalogowa si do pocztkowo chronionej MFA aplikacji**.

Sprawd藕 techniki [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) i [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Inne obejcia MFA w Az

### Dzwonek

Jedn z opcji Azure MFA jest **otrzymanie poczenia na skonfigurowany numer telefonu**, gdzie u偶ytkownik zostanie poproszony o **wysanie znaku `#`**.

{% hint style="danger" %}
Poniewa偶 znaki to tylko **tony**, atakujcy mo偶e **przej** **wiadomo gosow** numeru telefonu, skonfigurowa jako wiadomo **ton `#`**, a nastpnie, podczas 偶dania MFA, upewni si, 偶e **telefon ofiary jest zajty** (dzwonic na niego), aby poczenie Azure zostao przekierowane na poczt gosow.
{% endhint %}

### Zgodne urzdzenia

Polityki czsto wymagaj zgodnego urzdzenia lub MFA, wic **atakujcy mo偶e zarejestrowa zgodne urzdzenie**, uzyska **token PRT** i **obej w ten spos贸b MFA**.

Zacznij od zarejestrowania **zgodnego urzdzenia w Intune**, a nastpnie **uzyskaj PRT** za pomoc:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Znajd藕 wicej informacji na temat tego rodzaju ataku na nastpujcej stronie:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Narzdzia

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Pobierz wszystkie polityki
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep to skrypt PowerShell, kt贸ry pr贸buje **zalogowa si do r贸偶nych usug Microsoft przy u偶yciu podanego zestawu powiadcze i pr贸buje zidentyfikowa, czy MFA jest wczone**. W zale偶noci od tego, jak skonfigurowane s polityki dostpu warunkowego i inne ustawienia uwierzytelniania wieloskadnikowego, niekt贸re protokoy mog pozosta jednoskadnikowe. Ma r贸wnie偶 dodatkow kontrol konfiguracji ADFS i mo偶e pr贸bowa zalogowa si do lokalnego serwera ADFS, jeli zostanie wykryty.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token to zestaw funkcji, kt贸re maj na celu pom贸c konsultantom ds. bezpieczestwa, kt贸rzy musz weryfikowa Conditional Access Policies, testowa portale Microsoft z wczonym 2FA, itp.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Przetestuj ka偶dy portal**, czy mo偶liwe jest **logowanie bez MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Poniewa偶 **Azure** **portal** nie jest **ograniczony**, mo偶liwe jest **uzyskanie tokena z punktu kocowego portalu, aby uzyska dostp do dowolnej usugi wykrytej** przez poprzednie wykonanie. W tym przypadku zidentyfikowano Sharepoint i 偶dany jest token do uzyskania do niego dostpu:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Zakadajc, 偶e token ma uprawnienie Sites.Read.All (z Sharepoint), nawet jeli nie mo偶esz uzyska dostpu do Sharepoint z sieci z powodu MFA, mo偶liwe jest u偶ycie tokena do uzyskania dostpu do plik贸w za pomoc wygenerowanego tokena:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Referencje

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Ucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
