# Az - Sera za Ufikiaji wa Masharti & MFA Bypass

{% hint style="success" %}
Jifunze & fanya mazoezi ya AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **fuata** sisi kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu za hacking kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}

## Taarifa za Msingi

Sera za Ufikiaji wa Masharti za Azure ni sheria zilizowekwa katika Microsoft Azure ili kutekeleza udhibiti wa ufikiaji kwa huduma na programu za Azure kulingana na **masharti** fulani. Sera hizi husaidia mashirika kulinda rasilimali zao kwa kutumia udhibiti sahihi wa ufikiaji chini ya hali sahihi.\
Sera za ufikiaji wa masharti kimsingi **zinaelezea** **Nani** anaweza kufikia **Nini** kutoka **Wapi** na **Jinsi**.

Hapa kuna mifano kadhaa:

1. **Sera ya Hatari ya Kuingia**: Sera hii inaweza kuwekwa ili kuhitaji uthibitisho wa hatua nyingi (MFA) wakati hatari ya kuingia inagundulika. Kwa mfano, ikiwa tabia ya kuingia ya mtumiaji ni ya kawaida ikilinganishwa na muundo wao wa kawaida, kama kuingia kutoka nchi tofauti, mfumo unaweza kuomba uthibitisho wa ziada.
2. **Sera ya Uzingatiaji wa Kifaa**: Sera hii inaweza kuzuia ufikiaji wa huduma za Azure tu kwa vifaa ambavyo vinakidhi viwango vya usalama vya shirika. Kwa mfano, ufikiaji unaweza kuruhusiwa tu kutoka kwa vifaa ambavyo vina programu ya antivirus iliyo na sasisho au vinatumia toleo fulani la mfumo wa uendeshaji.

## Mipango ya Ufikiaji wa Masharti Bypass

Inawezekana kwamba sera ya ufikiaji wa masharti **inaangalia taarifa fulani ambazo zinaweza kubadilishwa kwa urahisi kuruhusu bypass ya sera**. Na ikiwa kwa mfano sera ilikuwa inakamilisha MFA, mshambuliaji ataweza kuipita.

Wakati wa kuunda sera ya ufikiaji wa masharti, inahitajika kuonyesha **watumiaji** walioathiriwa na **rasilimali za lengo** (kama programu zote za wingu).

Inahitajika pia kuunda **masharti** ambayo yatakuwa **yanasababisha** sera:

* **Mtandao**: Ip, anuwai za IP na maeneo ya kijiografia
* Inaweza kupitishwa kwa kutumia VPN au Proxy kuungana na nchi au kufanikiwa kuingia kutoka anwani ya IP iliyoruhusiwa
* **Hatari za Microsoft**: Hatari ya mtumiaji, hatari ya kuingia, hatari ya ndani
* **Majukwaa ya vifaa**: Kifaa chochote au chagua Android, iOS, Windows phone, Windows, macOS, Linux
* Ikiwa "Kifaa chochote" hakijachaguliwa lakini chaguo zingine zote zimechaguliwa, inawezekana kupita kwa kutumia user-agent wa nasibu usiohusiana na majukwaa hayo
* **Programu za mteja**: Chaguo ni "Kivinjari", "Programu za simu na wateja wa desktop", "Wateja wa Exchange ActiveSync" na Wateja Wengine"
* Ili kupita kuingia na chaguo kisichochaguliwa
* **Chuja kwa vifaa**: Inawezekana kuunda sheria inayohusiana na kifaa kilichotumika
* **Mchakato wa uthibitishaji**: Chaguo ni "Mchakato wa nambari ya kifaa" na "Uhamisho wa uthibitishaji"
* Hii haitamathirisha mshambuliaji isipokuwa anajaribu kutumia mojawapo ya protokali hizo katika jaribio la phishing kuingia kwenye akaunti ya mwathirika

Matokeo yanayoweza kutokea ni: Zuia au Ruhusu ufikiaji na masharti yanayoweza kama kuhitaji MFA, kifaa kuwa na uzingatiaji...

### Majukwaa ya Vifaa - Hali ya Kifaa

Inawezekana kuweka hali kulingana na **jukwaa la kifaa** (Android, iOS, Windows, macOS...), hata hivyo, hii inategemea **user-agent** hivyo ni rahisi kupita. Hata **kufanya chaguo zote zitekeleze MFA**, ikiwa utatumia **user-agent ambayo haitambuliwi,** utaweza kupita MFA au kuzuia:

<figure><img src="../../../.gitbook/assets/image (352).png" alt=""><figcaption></figcaption></figure>

Kufanya kivinjari **kitume user-agent isiyojulikana** (kama `Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 920) UCBrowser/10.1.0.563 Mobile`) inatosha kutosababisha hali hii.\
Unaweza kubadilisha user agent **kwa mikono** katika zana za maendeleo:

<figure><img src="../../../.gitbook/assets/image (351).png" alt="" width="375"><figcaption></figcaption></figure>

&#x20;Au tumia [nyongeza ya kivinjari kama hii](https://chromewebstore.google.com/detail/user-agent-switcher-and-m/bhchdcejhohfmigjafbampogmaanbfkg?hl=en).

### Mikoa: Nchi, anuwai za IP - Hali ya Kifaa

Ikiwa hii imewekwa katika sera ya masharti, mshambuliaji anaweza tu kutumia **VPN** katika **nchi iliyoruhusiwa** au kujaribu kupata njia ya kufikia kutoka **anwani ya IP iliyoruhusiwa** ili kupita masharti haya.

### Programu za Wingu

Inawezekana kuunda **sera za ufikiaji wa masharti kuzuia au kulazimisha** kwa mfano MFA wakati mtumiaji anajaribu kufikia **programu maalum**:

<figure><img src="../../../.gitbook/assets/image (353).png" alt=""><figcaption></figcaption></figure>

Ili kujaribu kupita ulinzi huu unapaswa kuona ikiwa unaweza **kuingia tu kwenye programu yoyote**.\
Zana [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep) ina **IDs za programu kumi** zilizowekwa na itajaribu kuingia ndani yao na kukujulisha na hata kukupa token ikiwa itafanikiwa.

Ili **kujaribu IDs za programu maalum katika rasilimali maalum** unaweza pia kutumia zana kama: 

{% code overflow="wrap" %}
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokens-stdout

<token>
```
{% endcode %}

Zaidi ya hayo, inawezekana pia kulinda njia ya kuingia (mfano, ikiwa unajaribu kuingia kutoka kwa kivinjari au kutoka kwa programu ya desktop). Chombo [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) hufanya baadhi ya ukaguzi ili kujaribu kupita hizi ulinzi pia.

Chombo [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) kinaweza pia kutumika kwa madhumuni sawa ingawa kinaonekana hakijatunzwa.

Chombo [**ROPCI**](https://github.com/wunderwuzzi23/ropci) kinaweza pia kutumika kujaribu hizi ulinzi na kuona ikiwa inawezekana kupita MFAs au vizuizi, lakini chombo hiki kinatumika kutoka kwa mtazamo wa **whitebox**. Kwanza unahitaji kupakua orodha ya Programu zilizoruhusiwa katika mpangilio na kisha itajaribu kuingia ndani yao.

## Mipango Mingine ya Az MFA

### Sauti ya Kengele

Chaguo moja la Azure MFA ni **kupokea simu katika nambari ya simu iliyowekwa** ambapo itamwuliza mtumiaji **kutuma herufi `#`**.

{% hint style="danger" %}
Kama herufi ni tu **sauti**, mshambuliaji anaweza **kuathiri** ujumbe wa **voicemail** wa nambari ya simu, kuweka kama ujumbe **sauti ya `#`** na kisha, wakati wa kuomba MFA hakikisha kwamba **simu ya waathiriwa inashughulika** (ikiitafuta) ili simu ya Azure irejeleze kwenye voicemail.
{% endhint %}

### Vifaa Vinavyokubalika

Sera mara nyingi zinahitaji kifaa kinachokubalika au MFA, hivyo **mshambuliaji anaweza kujiandikisha kifaa kinachokubalika**, kupata token ya **PRT** na **kupita hivi hivyo MFA**.

Anza kwa kujiandikisha kifaa **kinachokubalika katika Intune**, kisha **pata PRT** na:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Find more information about this kind of attack in the following page:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Tooling

### [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep)

Hii script inapata baadhi ya akidi za mtumiaji na kuangalia kama inaweza kuingia katika baadhi ya programu.

Hii ni muhimu kuona kama **huhitajiki MFA kuingia katika baadhi ya programu** ambazo unaweza baadaye kutumia vibaya ili **kuinua mamlaka**.

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Pata sera zote
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep ni script ya PowerShell inayojaribu **kuingia kwenye huduma mbalimbali za Microsoft kwa kutumia seti ya akauti zilizotolewa na itajaribu kubaini kama MFA imewezeshwa**. Kulingana na jinsi sera za ufikiaji wa masharti na mipangilio mingine ya uthibitishaji wa hatua nyingi zilivyowekwa, baadhi ya itifaki zinaweza kuishia kuwa na hatua moja tu. Pia ina ukaguzi wa ziada kwa mipangilio ya ADFS na inaweza kujaribu kuingia kwenye seva ya ADFS ya ndani ikiwa itagundulika.
```bash
Invoke-Expression (Invoke-WebRequest -Uri "https://raw.githubusercontent.com/dafthack/MFASweep/master/MFASweep.ps1").Content
Invoke-MFASweep -Username <username> -Password <pass>
```
### [ROPCI](https://github.com/wunderwuzzi23/ropci)

Chombo hiki kimeweza kusaidia kubaini njia za kupita MFA na kisha kutumia APIs katika wapangaji wengi wa uzalishaji wa AAD, ambapo wateja wa AAD walidhani walikuwa na MFA iliyotekelezwa, lakini uthibitishaji wa msingi wa ROPC ulifanikiwa.

{% hint style="success" %}
Unahitaji kuwa na ruhusa za kuorodhesha programu zote ili uweze kuunda orodha ya programu za kushambulia kwa nguvu.
{% endhint %}
```bash
./ropci configure
./ropci apps list --all --format json -o apps.json
./ropci apps list --all --format json | jq -r '.value[] | [.displayName,.appId] | @csv' > apps.csv
./ropci auth bulk -i apps.csv -o results.json
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token ni seti ya kazi ambazo zina lengo la kusaidia washauri wa usalama wanaohitaji kuthibitisha Sera za Ufikiaji wa Masharti, majaribio ya portali za Microsoft zenye 2FA, n.k.

<pre class="language-powershell"><code class="lang-powershell"><strong>git clone https://github.com/silverhack/donkeytoken.git
</strong><strong>Import-Module '.\donkeytoken' -Force
</strong></code></pre>

**Jaribu kila portali** ikiwa inawezekana **kuingia bila MFA**:
```powershell
$username = "conditional-access-app-user@azure.training.hacktricks.xyz"
$password = ConvertTo-SecureString "Poehurgi78633" -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential($username, $password)
Invoke-MFATest -credential $cred -Verbose -Debug -InformationAction Continue
```
Kwa sababu **Azure** **portal** **haijakandamizwa**, inawezekana **kukusanya token kutoka kwa kiunganishi cha portal ili kufikia huduma yoyote iliyogunduliwa** na utekelezaji wa awali. Katika kesi hii, Sharepoint ilitambuliwa, na token ya kuifikia inahitajika:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Ikiwa token ina ruhusa Sites.Read.All (kutoka Sharepoint), hata kama huwezi kufikia Sharepoint kutoka mtandao kwa sababu ya MFA, inawezekana kutumia token hiyo kufikia faili kwa kutumia token iliyozalishwa:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## References

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **fuata** sisi kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu za hacking kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
