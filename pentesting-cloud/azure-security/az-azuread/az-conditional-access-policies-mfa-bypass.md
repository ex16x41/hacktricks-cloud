# Az - KoÅŸullu EriÅŸim PolitikalarÄ± / MFA Atlatma

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Bize katÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi** **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

Azure KoÅŸullu EriÅŸim politikalarÄ±, belirli **koÅŸullara** dayalÄ± olarak Azure hizmetlerine ve uygulamalarÄ±na eriÅŸim kontrollerini uygulamak iÃ§in Microsoft Azure'da kurulan kurallardÄ±r. Bu politikalar, organizasyonlarÄ±n doÄŸru koÅŸullar altÄ±nda doÄŸru eriÅŸim kontrollerini uygulayarak kaynaklarÄ±nÄ± gÃ¼vence altÄ±na almasÄ±na yardÄ±mcÄ± olur.\
KoÅŸullu eriÅŸim politikalarÄ± temelde **Kim**'in **Neyi** **Nereden** ve **NasÄ±l** eriÅŸebileceÄŸini **tanÄ±mlar**.

Ä°ÅŸte birkaÃ§ Ã¶rnek:

1. **Oturum AÃ§ma Risk PolitikasÄ±**: Bu politika, bir oturum aÃ§ma riski tespit edildiÄŸinde Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama (MFA) gerektirecek ÅŸekilde ayarlanabilir. Ã–rneÄŸin, bir kullanÄ±cÄ±nÄ±n oturum aÃ§ma davranÄ±ÅŸÄ±, farklÄ± bir Ã¼lkeden oturum aÃ§mak gibi, normal desenine kÄ±yasla alÄ±ÅŸÄ±lmadÄ±ksa, sistem ek kimlik doÄŸrulama talep edebilir.
2. **Cihaz Uygunluk PolitikasÄ±**: Bu politika, yalnÄ±zca organizasyonun gÃ¼venlik standartlarÄ±na uygun cihazlarÄ±n Azure hizmetlerine eriÅŸimini kÄ±sÄ±tlayabilir. Ã–rneÄŸin, yalnÄ±zca gÃ¼ncel antivirÃ¼s yazÄ±lÄ±mÄ±na sahip veya belirli bir iÅŸletim sistemi sÃ¼rÃ¼mÃ¼nÃ¼ Ã§alÄ±ÅŸtÄ±ran cihazlardan eriÅŸime izin verilebilir.

## KoÅŸullu EriÅŸim PolitikasÄ± AtlatmalarÄ±

Bir koÅŸullu eriÅŸim politikasÄ±nÄ±n **kolayca manipÃ¼le edilebilecek bazÄ± bilgileri kontrol etmesi mÃ¼mkÃ¼ndÃ¼r, bu da politikanÄ±n atlatÄ±lmasÄ±na olanak tanÄ±r**. Ã–rneÄŸin, politika MFA'yÄ± yapÄ±landÄ±rÄ±yorsa, saldÄ±rgan bunu atlatabilecektir.

### Cihaz PlatformlarÄ± - Cihaz KoÅŸulu

**Cihaz platformuna** (Android, iOS, Windows, macOS) dayalÄ± bir koÅŸul ayarlamak mÃ¼mkÃ¼ndÃ¼r, ancak bu **kullanÄ±cÄ± aracÄ±sÄ±** (user-agent) temelinde olduÄŸu iÃ§in atlatÄ±lmasÄ± oldukÃ§a kolaydÄ±r. TÃ¼m seÃ§enekleri MFA'yÄ± zorunlu kÄ±lacak ÅŸekilde ayarlasanÄ±z bile, **tanÄ±madÄ±ÄŸÄ± bir kullanÄ±cÄ± aracÄ±sÄ±** kullanÄ±rsanÄ±z MFA'yÄ± atlatabilirsiniz.

### Lokasyonlar: Ãœlkeler, IP aralÄ±klarÄ± - Cihaz KoÅŸulu

Elbette, bu koÅŸullu politikada ayarlanmÄ±ÅŸsa, bir saldÄ±rgan sadece **izin verilen Ã¼lkede** bir **VPN** kullanabilir veya bu koÅŸullarÄ± atlatmak iÃ§in **izin verilen bir IP adresinden** eriÅŸim saÄŸlamanÄ±n bir yolunu bulmaya Ã§alÄ±ÅŸabilir.

### Office365 Ä°stemci UygulamalarÄ±

EÄŸer istemcilerin **Office 365 uygulamalarÄ±na tarayÄ±cÄ±dan eriÅŸim saÄŸlarken MFA'ya ihtiyaÃ§ duyduÄŸunu** belirtebilirsiniz:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Bunu atlatmak iÃ§in, bir masaÃ¼stÃ¼ uygulamasÄ±ndan (aÅŸaÄŸÄ±daki Ã¶rnekte Microsoft Teams gibi) bir uygulamaya giriÅŸ yapÄ±yormuÅŸ gibi davranmak mÃ¼mkÃ¼ndÃ¼r; bu da korumayÄ± atlatacaktÄ±r:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Microsoft Teams uygulamasÄ± birÃ§ok izne sahip olduÄŸundan, bu eriÅŸimi kullanabileceksiniz.

{% hint style="success" %}
Ã–nceden tanÄ±mlanmÄ±ÅŸ Office365 izinlerine sahip daha fazla genel uygulamanÄ±n I**D'sini** roadtools veritabanÄ±nda bulabilirsiniz:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Bu saldÄ±rÄ± Ã¶zellikle ilginÃ§tir Ã§Ã¼nkÃ¼ varsayÄ±lan olarak, kamuya aÃ§Ä±k Office365 uygulamalarÄ± bazÄ± verilere eriÅŸim iznine sahip olacaktÄ±r.

### DiÄŸer uygulamalar

VarsayÄ±lan olarak, kullanÄ±cÄ±lar tarafÄ±ndan oluÅŸturulan diÄŸer uygulamalar izinlere sahip olmayacak ve Ã¶zel olabilir.\
Ancak, kullanÄ±cÄ±lar ayrÄ±ca bazÄ± **izinler** veren **kamuya aÃ§Ä±k** **uygulamalar** oluÅŸturabilirler.

Bir politikanÄ±n **bir uygulamaya eriÅŸim iÃ§in MFA gerektirecek ÅŸekilde ayarlandÄ±ÄŸÄ±** potansiyel bir senaryo, kullanÄ±cÄ± bir **tarayÄ±cÄ±** kullanÄ±yorsa (belki de bir web uygulamasÄ± olduÄŸu iÃ§in ve dolayÄ±sÄ±yla tek yol bu olacaktÄ±r), eÄŸer bir **proxy uygulama** -kullanÄ±cÄ±lar adÄ±na diÄŸer uygulamalarla **etkileÅŸimde bulunmasÄ±na izin verilen bir uygulama**- varsa, kullanÄ±cÄ± **proxy uygulamasÄ±nda oturum aÃ§abilir** ve ardÄ±ndan bu proxy uygulamasÄ± aracÄ±lÄ±ÄŸÄ±yla **ilk baÅŸta MFA korumalÄ± uygulamaya oturum aÃ§abilir**.

[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) ve [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) tekniklerini kontrol edin.

## DiÄŸer Az MFA AtlatmalarÄ±

### Zil sesi

Bir Azure MFA seÃ§eneÄŸi, **yapÄ±landÄ±rÄ±lmÄ±ÅŸ telefon numarasÄ±na bir Ã§aÄŸrÄ± almak** ve kullanÄ±cÄ±dan **`#` karakterini gÃ¶ndermesini istemektir**.

{% hint style="danger" %}
Karakterler sadece **tonlar** olduÄŸundan, bir saldÄ±rgan **sesli mesaj** ile telefon numarasÄ±nÄ±n **sesli mesaj** kaydÄ±nÄ± ele geÃ§irebilir, mesaj olarak **`#` tonunu** ayarlayabilir ve ardÄ±ndan MFA talep edildiÄŸinde **kurbanÄ±n telefonunun meÅŸgul olduÄŸundan emin olabilir** (aramak suretiyle) bÃ¶ylece Azure Ã§aÄŸrÄ±sÄ± sesli mesaja yÃ¶nlendirilir.
{% endhint %}

### Uyumlu Cihazlar

Politikalar genellikle uyumlu bir cihaz veya MFA talep eder, bu nedenle bir **saldÄ±rgan uyumlu bir cihaz kaydedebilir**, bir **PRT** token alabilir ve **bu ÅŸekilde MFA'yÄ± atlayabilir**.

Ã–ncelikle **Intune'da uyumlu bir cihaz kaydederek** baÅŸlayÄ±n, ardÄ±ndan **PRT'yi** almak iÃ§in:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
AÅŸaÄŸÄ±daki sayfada bu tÃ¼r bir saldÄ±rÄ± hakkÄ±nda daha fazla bilgi bulabilirsiniz:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## AraÃ§lar

### [roadrecon](https://github.com/dirkjanm/ROADtools)

TÃ¼m politikalarÄ± alÄ±n
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep, saÄŸlanan bir kimlik bilgileri setini kullanarak **Ã§eÅŸitli Microsoft hizmetlerine giriÅŸ yapmayÄ± deneyen ve MFA'nÄ±n etkin olup olmadÄ±ÄŸÄ±nÄ± belirlemeye Ã§alÄ±ÅŸan bir PowerShell betiÄŸidir**. KoÅŸullu eriÅŸim politikalarÄ± ve diÄŸer Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama ayarlarÄ±nÄ±n nasÄ±l yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±na baÄŸlÄ± olarak bazÄ± protokoller tek faktÃ¶rlÃ¼ kalabilir. AyrÄ±ca, ADFS yapÄ±landÄ±rmalarÄ± iÃ§in ek bir kontrol iÃ§erir ve tespit edilirse yerel ADFS sunucusuna giriÅŸ yapmayÄ± deneyebilir.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token, KoÅŸullu EriÅŸim PolitikalarÄ±nÄ± doÄŸrulamak, 2FA etkinleÅŸtirilmiÅŸ Microsoft portallarÄ± iÃ§in testler yapmak gibi ihtiyaÃ§larÄ± olan gÃ¼venlik danÄ±ÅŸmanlarÄ±na yardÄ±mcÄ± olmayÄ± amaÃ§layan bir dizi iÅŸlevdir.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Her bir portalÄ± test edin** eÄŸer **MFA olmadan giriÅŸ yapmak mÃ¼mkÃ¼nse**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Ã‡Ã¼nkÃ¼ **Azure** **portalÄ±** **kÄ±sÄ±tlanmamÄ±ÅŸtÄ±r**, Ã¶nceki yÃ¼rÃ¼tme tarafÄ±ndan tespit edilen herhangi bir hizmete eriÅŸmek iÃ§in portal uÃ§ noktasÄ±ndan **bir token toplamak** mÃ¼mkÃ¼ndÃ¼r. Bu durumda Sharepoint tanÄ±mlandÄ± ve ona eriÅŸmek iÃ§in bir token talep edildi:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Diyelim ki token, Sites.Read.All (Sharepoint'tan) iznine sahip. MFA nedeniyle web Ã¼zerinden Sharepoint'a eriÅŸemeseniz bile, oluÅŸturulan token ile dosyalara eriÅŸmek iÃ§in token'Ä± kullanmak mÃ¼mkÃ¼ndÃ¼r:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Referanslar

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
