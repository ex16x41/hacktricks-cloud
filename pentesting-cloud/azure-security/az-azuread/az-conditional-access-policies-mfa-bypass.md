# Az - æ¡ä»¶è®¿é—®ç­–ç•¥ / MFA ç»•è¿‡

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

Azure æ¡ä»¶è®¿é—®ç­–ç•¥æ˜¯åœ¨ Microsoft Azure ä¸­è®¾ç½®çš„è§„åˆ™ï¼Œç”¨äºæ ¹æ®æŸäº› **æ¡ä»¶** å¼ºåˆ¶æ‰§è¡Œå¯¹ Azure æœåŠ¡å’Œåº”ç”¨ç¨‹åºçš„è®¿é—®æ§åˆ¶ã€‚è¿™äº›ç­–ç•¥å¸®åŠ©ç»„ç»‡é€šè¿‡åœ¨é€‚å½“çš„æƒ…å†µä¸‹åº”ç”¨æ­£ç¡®çš„è®¿é—®æ§åˆ¶æ¥ä¿æŠ¤å…¶èµ„æºã€‚\
æ¡ä»¶è®¿é—®ç­–ç•¥åŸºæœ¬ä¸Š **å®šä¹‰** **è°** å¯ä»¥ä» **å“ªé‡Œ** å’Œ **å¦‚ä½•** è®¿é—® **ä»€ä¹ˆ**ã€‚

ä»¥ä¸‹æ˜¯å‡ ä¸ªç¤ºä¾‹ï¼š

1. **ç™»å½•é£é™©ç­–ç•¥**ï¼šæ­¤ç­–ç•¥å¯ä»¥è®¾ç½®ä¸ºåœ¨æ£€æµ‹åˆ°ç™»å½•é£é™©æ—¶è¦æ±‚å¤šå› ç´ èº«ä»½éªŒè¯ (MFA)ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·çš„ç™»å½•è¡Œä¸ºä¸å…¶å¸¸è§„æ¨¡å¼ç›¸æ¯”ä¸å¯»å¸¸ï¼Œä¾‹å¦‚ä»ä¸åŒå›½å®¶ç™»å½•ï¼Œç³»ç»Ÿå¯ä»¥æç¤ºè¿›è¡Œé¢å¤–çš„èº«ä»½éªŒè¯ã€‚
2. **è®¾å¤‡åˆè§„æ€§ç­–ç•¥**ï¼šæ­¤ç­–ç•¥å¯ä»¥é™åˆ¶å¯¹ Azure æœåŠ¡çš„è®¿é—®ï¼Œä»…é™äºç¬¦åˆç»„ç»‡å®‰å…¨æ ‡å‡†çš„è®¾å¤‡ã€‚ä¾‹å¦‚ï¼Œåªæœ‰åœ¨è®¾å¤‡ä¸Šå®‰è£…äº†æœ€æ–°çš„é˜²ç—…æ¯’è½¯ä»¶æˆ–è¿è¡Œç‰¹å®šæ“ä½œç³»ç»Ÿç‰ˆæœ¬çš„æƒ…å†µä¸‹ï¼Œæ‰å…è®¸è®¿é—®ã€‚

## æ¡ä»¶è®¿é—®ç­–ç•¥ç»•è¿‡

æ¡ä»¶è®¿é—®ç­–ç•¥ **æ£€æŸ¥ä¸€äº›å¯ä»¥è½»æ˜“ç¯¡æ”¹çš„ä¿¡æ¯ï¼Œä»è€Œå…è®¸ç»•è¿‡è¯¥ç­–ç•¥**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¯¥ç­–ç•¥é…ç½®äº† MFAï¼Œæ”»å‡»è€…å°†èƒ½å¤Ÿç»•è¿‡å®ƒã€‚

### è®¾å¤‡å¹³å° - è®¾å¤‡æ¡ä»¶

å¯ä»¥åŸºäº **è®¾å¤‡å¹³å°**ï¼ˆAndroidã€iOSã€Windowsã€macOSï¼‰è®¾ç½®æ¡ä»¶ï¼Œä½†è¿™åŸºäº **ç”¨æˆ·ä»£ç†**ï¼Œå› æ­¤å¾ˆå®¹æ˜“ç»•è¿‡ã€‚å³ä½¿ **å¼ºåˆ¶æ‰€æœ‰é€‰é¡¹å¯ç”¨ MFA**ï¼Œå¦‚æœä½¿ç”¨ **æœªè¢«è¯†åˆ«çš„ç”¨æˆ·ä»£ç†**ï¼Œä¹Ÿå°†èƒ½å¤Ÿç»•è¿‡ MFAã€‚

### ä½ç½®ï¼šå›½å®¶ã€IP èŒƒå›´ - è®¾å¤‡æ¡ä»¶

å½“ç„¶ï¼Œå¦‚æœåœ¨æ¡ä»¶ç­–ç•¥ä¸­è®¾ç½®äº†è¿™ä¸€ç‚¹ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨ **VPN** åœ¨ **å…è®¸çš„å›½å®¶** ä¸­ï¼Œæˆ–å°è¯•æ‰¾åˆ°ä» **å…è®¸çš„ IP åœ°å€** è®¿é—®çš„æ–¹æ³•æ¥ç»•è¿‡è¿™äº›æ¡ä»¶ã€‚

### Office365 å®¢æˆ·ç«¯åº”ç”¨

æ‚¨å¯ä»¥æŒ‡ç¤ºå¦‚æœå®¢æˆ·ç«¯ **ä»æµè§ˆå™¨è®¿é—® Office 365 åº”ç”¨ï¼Œåˆ™éœ€è¦ MFA**ï¼š

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

è¦ç»•è¿‡æ­¤é™åˆ¶ï¼Œå¯ä»¥å‡è£…æ‚¨æ˜¯ä»æ¡Œé¢åº”ç”¨ç¨‹åºï¼ˆä¾‹å¦‚ä»¥ä¸‹ç¤ºä¾‹ä¸­çš„ Microsoft Teamsï¼‰ç™»å½•åº”ç”¨ï¼Œè¿™å°†ç»•è¿‡ä¿æŠ¤ï¼š
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
ç”±äº Microsoft Teams åº”ç”¨ç¨‹åºå…·æœ‰å¾ˆå¤šæƒé™ï¼Œæ‚¨å°†èƒ½å¤Ÿä½¿ç”¨è¯¥è®¿é—®æƒé™ã€‚

{% hint style="success" %}
æ‚¨å¯ä»¥åœ¨ roadtools æ•°æ®åº“ä¸­æ‰¾åˆ°å…·æœ‰é¢„å®šä¹‰ Office365 æƒé™çš„æ›´å¤šå…¬å…±åº”ç”¨ç¨‹åºçš„ I**D**ï¼š

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

è¿™ä¸ªæ”»å‡»ç‰¹åˆ«æœ‰è¶£ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼Œå…¬å…± Office365 åº”ç”¨ç¨‹åºå°†å…·æœ‰è®¿é—®æŸäº›æ•°æ®çš„æƒé™ã€‚

### å…¶ä»–åº”ç”¨

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·åˆ›å»ºçš„å…¶ä»–åº”ç”¨å°†æ²¡æœ‰æƒé™ï¼Œå¹¶ä¸”å¯èƒ½æ˜¯ç§æœ‰çš„ã€‚\
ç„¶è€Œï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥åˆ›å»º **å…¬å…±** **åº”ç”¨** æˆäºˆå®ƒä»¬ä¸€äº› **æƒé™**ã€‚

ä¸€ä¸ªæ½œåœ¨çš„åœºæ™¯æ˜¯ï¼Œå½“ç”¨æˆ·ä½¿ç”¨ **æµè§ˆå™¨** è®¿é—®ä¸€ä¸ª **åº”ç”¨** æ—¶ï¼Œç­–ç•¥è¢«è®¾ç½®ä¸º **è¦æ±‚ MFA**ï¼ˆä¹Ÿè®¸å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªç½‘ç»œåº”ç”¨ï¼Œå› æ­¤è¿™æ˜¯å”¯ä¸€çš„æ–¹å¼ï¼‰ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ª **ä»£ç†åº”ç”¨** - ä¸€ä¸ªè¢«å…è®¸ **ä»£è¡¨ç”¨æˆ·ä¸å…¶ä»–åº”ç”¨äº¤äº’çš„åº”ç”¨** - ç”¨æˆ·å¯ä»¥ **ç™»å½•ä»£ç†åº”ç”¨**ï¼Œç„¶åé€šè¿‡è¿™ä¸ªä»£ç†åº”ç”¨ **ç™»å½•åˆ°æœ€åˆå— MFA ä¿æŠ¤çš„åº”ç”¨**ã€‚

æŸ¥çœ‹ [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) å’Œ [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) æŠ€æœ¯ã€‚

## å…¶ä»– Az MFA ç»•è¿‡

### æŒ¯é“ƒ

ä¸€ä¸ª Azure MFA é€‰é¡¹æ˜¯ **æ¥æ”¶åœ¨é…ç½®çš„ç”µè¯å·ç ä¸Šçš„ç”µè¯**ï¼Œåœ¨ç”µè¯ä¸­ä¼šè¦æ±‚ç”¨æˆ· **å‘é€å­—ç¬¦ `#`**ã€‚

{% hint style="danger" %}
ç”±äºå­—ç¬¦åªæ˜¯ **éŸ³è°ƒ**ï¼Œæ”»å‡»è€…å¯ä»¥ **ç ´å** è¯¥ç”µè¯å·ç çš„ **è¯­éŸ³é‚®ä»¶** æ¶ˆæ¯ï¼Œå°† **éŸ³è°ƒ `#`** é…ç½®ä¸ºæ¶ˆæ¯ï¼Œç„¶ååœ¨è¯·æ±‚ MFA æ—¶ç¡®ä¿ **å—å®³è€…çš„ç”µè¯æ­£åœ¨å¿™**ï¼ˆæ‹¨æ‰“å®ƒï¼‰ï¼Œè¿™æ · Azure çš„ç”µè¯å°±ä¼šè¢«é‡å®šå‘åˆ°è¯­éŸ³é‚®ä»¶ã€‚
{% endhint %}

### åˆè§„è®¾å¤‡

ç­–ç•¥é€šå¸¸è¦æ±‚åˆè§„è®¾å¤‡æˆ– MFAï¼Œå› æ­¤ **æ”»å‡»è€…å¯ä»¥æ³¨å†Œä¸€ä¸ªåˆè§„è®¾å¤‡**ï¼Œè·å– **PRT** ä»¤ç‰Œå¹¶ **ä»¥æ­¤æ–¹å¼ç»•è¿‡ MFA**ã€‚

é¦–å…ˆåœ¨ Intune ä¸­æ³¨å†Œä¸€ä¸ª **åˆè§„è®¾å¤‡**ï¼Œç„¶åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ **è·å– PRT**ï¼š
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
åœ¨ä»¥ä¸‹é¡µé¢ä¸­æ‰¾åˆ°æœ‰å…³æ­¤ç±»æ”»å‡»çš„æ›´å¤šä¿¡æ¯ï¼š

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## å·¥å…·

### [roadrecon](https://github.com/dirkjanm/ROADtools)

è·å–æ‰€æœ‰ç­–ç•¥
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep æ˜¯ä¸€ä¸ª PowerShell è„šæœ¬ï¼Œå°è¯•ä½¿ç”¨æä¾›çš„å‡­æ® **ç™»å½•åˆ°å„ç§ Microsoft æœåŠ¡ï¼Œå¹¶å°è¯•è¯†åˆ« MFA æ˜¯å¦å·²å¯ç”¨**ã€‚æ ¹æ®æ¡ä»¶è®¿é—®ç­–ç•¥å’Œå…¶ä»–å¤šå› ç´ èº«ä»½éªŒè¯è®¾ç½®çš„é…ç½®ï¼ŒæŸäº›åè®®å¯èƒ½æœ€ç»ˆåªä½¿ç”¨å•å› ç´ èº«ä»½éªŒè¯ã€‚å®ƒè¿˜å¯¹ ADFS é…ç½®è¿›è¡Œäº†é¢å¤–æ£€æŸ¥ï¼Œå¹¶å¯ä»¥å°è¯•ç™»å½•åˆ°æ£€æµ‹åˆ°çš„æœ¬åœ° ADFS æœåŠ¡å™¨ã€‚
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token æ˜¯ä¸€ç»„æ—¨åœ¨å¸®åŠ©å®‰å…¨é¡¾é—®éªŒè¯æ¡ä»¶è®¿é—®ç­–ç•¥ã€æµ‹è¯•å¯ç”¨ 2FA çš„ Microsoft é—¨æˆ·ç­‰çš„åŠŸèƒ½ã€‚
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**æµ‹è¯•æ¯ä¸ªé—¨æˆ·**ï¼Œä»¥ç¡®å®šæ˜¯å¦å¯ä»¥**åœ¨æ²¡æœ‰ MFA çš„æƒ…å†µä¸‹ç™»å½•**ï¼š
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
å› ä¸º**Azure** **é—¨æˆ·**æ˜¯**ä¸å—é™åˆ¶**çš„ï¼Œå› æ­¤å¯ä»¥**ä»é—¨æˆ·ç«¯ç‚¹æ”¶é›†ä»¤ç‰Œä»¥è®¿é—®ä¹‹å‰æ‰§è¡Œæ£€æµ‹åˆ°çš„ä»»ä½•æœåŠ¡**ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯†åˆ«å‡ºäº†Sharepointï¼Œå¹¶è¯·æ±‚è®¿é—®å®ƒçš„ä»¤ç‰Œï¼š

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

å‡è®¾ä»¤ç‰Œå…·æœ‰ Sites.Read.Allï¼ˆæ¥è‡ª Sharepointï¼‰çš„æƒé™ï¼Œå³ä½¿ç”±äº MFA æ‚¨æ— æ³•é€šè¿‡ç½‘ç»œè®¿é—® Sharepointï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨è¯¥ä»¤ç‰Œè®¿é—®ä½¿ç”¨ç”Ÿæˆçš„ä»¤ç‰Œçš„æ–‡ä»¶ï¼š
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## å‚è€ƒ

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
