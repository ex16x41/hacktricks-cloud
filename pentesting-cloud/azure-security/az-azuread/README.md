# Az - AzureAD (AAD)

{% hint style="success" %}
AWS Hacking'Ä± Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'Ä± Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

## Temel Bilgiler

Azure Active Directory (Azure AD), Microsoft'un kimlik ve eriÅŸim yÃ¶netimi iÃ§in bulut tabanlÄ± hizmeti olarak hizmet vermektedir. Ã‡alÄ±ÅŸanlarÄ±n Microsoft 365, Azure portalÄ± ve birÃ§ok diÄŸer SaaS uygulamasÄ± dahil olmak Ã¼zere, kuruluÅŸ iÃ§inde ve dÄ±ÅŸÄ±nda kaynaklara eriÅŸim saÄŸlamalarÄ±nÄ± saÄŸlamak iÃ§in Ã¶nemli bir rol oynamaktadÄ±r. Azure AD'nin tasarÄ±mÄ±, **kimlik doÄŸrulama, yetkilendirme ve kullanÄ±cÄ± yÃ¶netimi** gibi temel kimlik hizmetlerini sunmaya odaklanmaktadÄ±r.

Azure AD'nin temel Ã¶zellikleri arasÄ±nda **Ã§oklu faktÃ¶rlÃ¼ kimlik doÄŸrulama** ve **koÅŸullu eriÅŸim** bulunmaktadÄ±r ve diÄŸer Microsoft gÃ¼venlik hizmetleriyle sorunsuz entegrasyon saÄŸlar. Bu Ã¶zellikler, kullanÄ±cÄ± kimliklerinin gÃ¼venliÄŸini Ã¶nemli Ã¶lÃ§Ã¼de artÄ±rÄ±r ve organizasyonlara eriÅŸim politikalarÄ±nÄ± etkili bir ÅŸekilde uygulamalarÄ±nÄ± ve zorlamalarÄ±nÄ± saÄŸlar. Microsoft'un bulut hizmetleri ekosisteminin temel bir bileÅŸeni olarak, Azure AD, kullanÄ±cÄ± kimliklerinin bulut tabanlÄ± yÃ¶netimi iÃ§in kilit bir rol oynamaktadÄ±r.

## VarlÄ±klar

### NumaralandÄ±rma

Bu numaralandÄ±rma iÃ§in [**az cli aracÄ±nÄ±**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)**,** **PowerShell modÃ¼lÃ¼** [**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/) (veya [**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)) ve [**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps) modÃ¼lÃ¼nÃ¼ kullanabilirsiniz.

{% hint style="success" %}
Linux'ta PowerShell Core'u yÃ¼klemeniz gerekecektir:
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

#### **ModÃ¼l farklarÄ±**

* **AzureAD**, Azure AD nesnelerinin tÃ¼m Ã¶zelliklerini gÃ¶stermeyen ve Azure kaynaklarÄ± bilgilerine eriÅŸmek iÃ§in kullanÄ±lamayan Microsoft'a ait bir PowerShell modÃ¼lÃ¼dÃ¼r.
* **Az PowerShell**, PowerShell komut satÄ±rÄ±ndan Azure kaynaklarÄ±nÄ± yÃ¶netmek iÃ§in bir modÃ¼ldÃ¼r.

### **BaÄŸlantÄ±**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %} 

## Azure AD

Azure Active Directory (Azure AD) is Microsoft's cloud-based identity and access management service. It helps your employees sign in and access resources.

### Enumeration

1. **User Enumeration**: Enumerate valid usernames using methods like the Azure AD login page, OAuth endpoints, or the Graph API.
2. **Group Enumeration**: Enumerate Azure AD groups to understand the organization's structure and potential attack surface.
3. **Application Enumeration**: Identify applications registered in Azure AD to find potential entry points for attacks.

### Brute Force Attacks

1. **Password Spraying**: Attempting to authenticate using common passwords across multiple accounts.
2. **Credential Stuffing**: Using known username and password combinations to gain unauthorized access.

### Password Attacks

1. **Password Policies**: Check Azure AD password policies to identify weak configurations.
2. **Password Hashes**: Extract password hashes to attempt offline cracking.

### Account Takeover

1. **Phishing**: Use phishing attacks to steal user credentials and gain unauthorized access.
2. **Password Reset**: Exploit weak password reset mechanisms to take over user accounts.

### Privilege Escalation

1. **Role Escalation**: Expjsonit misconfigured roles to gain higher privileges within Azure AD.
2. **Application Permissions**: Expjsonit applications with excessive permissions to escalate privileges.

### Persistence

1. **Backdoors**: Create backdoors in Azure AD configurations to maintain access even after remediation.
2. **Service Principals**: Expjsonit service principals to maintain persistence in Azure AD.

### Data Exfiltration

1. **Export Data**: Extract sensitive data from Azure AD using techniques like OAuth abuse or exploiting misconfigured permissions.
2. **Logs**: Clear logs to cover tracks after exfiltrating data from Azure AD.

### Remediation

1. **Monitor Logs**: Regularly monitor Azure AD logs for suspicious activities.
2. **Security Awareness**: Educate users about phishing attacks and the importance of strong passwords.
3. **Multi-Factor Authentication**: Enforce MFA to add an extra layer of security to user accounts.

{% endcode %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
{% endtab %}

{% tab title="Ham PS" %}
{% code overflow="wrap" %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="Ham OS" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% endcode %}
{% endtab %}
{% endtabs %}

Herhangi bir program aracÄ±lÄ±ÄŸÄ±yla Azure'a **CLI** ile giriÅŸ yaptÄ±ÄŸÄ±nÄ±zda, **Microsoft**'a ait bir **kiracÄ±ya** ait bir **Azure UygulamasÄ±** kullanÄ±yorsunuz. Bu Uygulamalar, hesabÄ±nÄ±zda oluÅŸturabileceÄŸiniz uygulamalar gibi, **bir istemci kimliÄŸine sahiptir**. Konsolda gÃ¶rebileceÄŸiniz **izin verilen uygulamalar listelerinde** hepsini **gÃ¶remeyeceksiniz**, **ancak varsayÄ±lan olarak izin verilirler**.

Ã–rneÄŸin, bir **powershell betiÄŸi** kimlik doÄŸrulamasÄ± yaparken, **`1950a258-227b-4e31-a9cf-717495945fc2`** istemci kimliÄŸine sahip bir uygulama kullanÄ±r. Uygulama konsolda gÃ¶rÃ¼nmese bile, bir sistem yÃ¶neticisi bu uygulamayÄ± **engelleyebilir** ve kullanÄ±cÄ±larÄ±n bu Uygulama aracÄ±lÄ±ÄŸÄ±yla baÄŸlanan araÃ§larÄ± kullanmasÄ±nÄ± engelleyebilir.

Ancak, Azure'a baÄŸlanmanÄ±za izin verecek **diÄŸer istemci kimlikleri** de bulunmaktadÄ±r:
```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```
### KullanÄ±cÄ±lar

{% tabs %}
{% tab title="az cli" %}
```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

Azure AD, Microsoft'un kimlik ve eriÅŸim yÃ¶netimi bulut hizmetidir. Azure AD, kullanÄ±cÄ± kimliklerini yÃ¶netmek, eriÅŸim denetimlerini uygulamak ve uygulamalara tek oturum aÃ§ma saÄŸlamak iÃ§in kullanÄ±lÄ±r.

Azure AD'nin gÃ¼venliÄŸini deÄŸerlendirirken, aÅŸaÄŸÄ±daki konulara odaklanabilirsiniz:

- KullanÄ±cÄ± hesaplarÄ±nÄ±n gÃ¼venliÄŸi
- EriÅŸim denetimleri ve roller
- Uygulama entegrasyonu gÃ¼venliÄŸi
- GÃ¼nlÃ¼k izleme ve olay yÃ¶netimi

Azure AD'nin gÃ¼venliÄŸini test etmek iÃ§in farklÄ± teknikler ve araÃ§lar kullanÄ±labilir. Bu testler, kullanÄ±cÄ± hesaplarÄ±nÄ±n zayÄ±f ÅŸifrelerini tespit etmek, Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulamasÄ±nÄ± atlamak veya uygulama entegrasyonu zafiyetlerini keÅŸfetmek gibi senaryolarÄ± iÃ§erebilir.

{% endtab %}
```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```
{% endtab %}

{% tab title="Az PowerShell" %} 

## Az PowerShell

Azure Active Directory (Azure AD) PowerShell module allows you to manage Azure AD users, groups, and licenses. You can use this module to perform various administrative tasks related to Azure AD.

### Installation

To install the Azure AD PowerShell module, you can use the following command:

```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

### Connecting to Azure AD

You can connect to Azure AD using the following command:

```powershell
Connect-AzAccount
```

### Managing Azure AD Users

You can get Azure AD users using the following command:

```powershell
Get-AzADUser
```

### Managing Azure AD Groups

You can get Azure AD groups using the following command:

```powershell
Get-AzADGroup
```

### Managing Azure AD Licenses

You can get Azure AD licenses using the following command:

```powershell
Get-AzureADUserLicenseDetail
```

For more information on how to use the Azure AD PowerShell module, you can refer to the official [Microsoft documentation](https://docs.microsoft.com/en-us/powershell/azure/active-directory/overview).

{% endtab %}
```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```
{% endtab %}
{% endtabs %}

#### KullanÄ±cÄ± Åifresini DeÄŸiÅŸtirme

{% code overflow="wrap" %}
```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText â€“Force

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password â€“Verbose
```
### MFA ve KoÅŸullu EriÅŸim PolitikalarÄ±

Her kullanÄ±cÄ±ya MFA eklemek kesinlikle Ã¶nerilir, ancak bazÄ± ÅŸirketler bunu ayarlamayabilir veya belirli bir konumdan, tarayÄ±cÄ±dan veya belirli bir koÅŸuldan giriÅŸ yapÄ±lÄ±yorsa MFA'yÄ± ayarlayabilir: KullanÄ±cÄ±, **belirli bir konumdan, tarayÄ±cÄ±dan veya bazÄ± koÅŸullardan** giriÅŸ yaparsa MFA **gereklidir**. Bu politikalar, doÄŸru bir ÅŸekilde yapÄ±landÄ±rÄ±lmazsa **atlatmalara** aÃ§Ä±k olabilir. Kontrol edin:

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

### Gruplar

{% tabs %}
{% tab title="az cli" %}
```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```
{% endtab %}

{% tab title="Azure AD" %}

Azure AD, Microsoft'un kimlik ve eriÅŸim yÃ¶netimi bulut hizmetidir. Azure AD, kullanÄ±cÄ± kimliklerini ve eriÅŸim haklarÄ±nÄ± yÃ¶netmek iÃ§in kullanÄ±lÄ±r. Bu hizmet, kimlik doÄŸrulama, eriÅŸim denetimi ve gÃ¼venlik politikalarÄ±nÄ± uygulamayÄ± saÄŸlar.

Azure AD, bulut tabanlÄ± uygulamalar ve hizmetlere tek oturum aÃ§ma (SSO) deneyimi sunar. AyrÄ±ca Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama gibi gÃ¼venlik Ã¶zelliklerini destekler.

Azure AD'nin gÃ¼venliÄŸini artÄ±rmak iÃ§in, gÃ¼Ã§lÃ¼ parolalarÄ±n yanÄ± sÄ±ra Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama gibi ek gÃ¼venlik Ã¶nlemlerini etkinleÅŸtirmek Ã¶nemlidir. Bu sayede hesaplarÄ±n kÃ¶tÃ¼ niyetli kullanÄ±mlara karÅŸÄ± daha iyi korunmasÄ± saÄŸlanabilir.

Azure AD'nin gÃ¼venliÄŸini deÄŸerlendirmek iÃ§in, zayÄ±f parolalarÄ±, aÅŸÄ±rÄ± eriÅŸim haklarÄ±nÄ± veya yanlÄ±ÅŸ yapÄ±landÄ±rÄ±lmÄ±ÅŸ gÃ¼venlik politikalarÄ±nÄ± araÅŸtÄ±rmak gibi yÃ¶ntemler kullanÄ±labilir.

{% endtab %}
```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```
{% endtab %}

{% tab title="Az PowerShell" %} 

Azure AD ile Ã§alÄ±ÅŸÄ±rken, Azure PowerShell modÃ¼lÃ¼nÃ¼ kullanarak bir dizi iÅŸlem gerÃ§ekleÅŸtirebilirsiniz. Ä°ÅŸte bazÄ± temel iÅŸlemler:

- Yeni bir Azure AD kullanÄ±cÄ±sÄ± oluÅŸturma
- Varolan bir kullanÄ±cÄ±nÄ±n bilgilerini gÃ¼ncelleme
- KullanÄ±cÄ± hesaplarÄ±nÄ± listeleme ve filtreleme
- KullanÄ±cÄ± hesaplarÄ±nÄ± etkinleÅŸtirme veya devre dÄ±ÅŸÄ± bÄ±rakma
- KullanÄ±cÄ± hesaplarÄ±nÄ± silme

Azure PowerShell modÃ¼lÃ¼, Azure AD ile etkileÅŸimde bulunmak iÃ§in gÃ¼Ã§lÃ¼ bir araÃ§tÄ±r ve birÃ§ok yÃ¶netim gÃ¶revini otomatikleÅŸtirmenize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak Azure AD gÃ¼venliÄŸini gÃ¼Ã§lendirebilir ve yÃ¶netim sÃ¼reÃ§lerinizi kolaylaÅŸtÄ±rabilirsiniz.

{% endtab %}
```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
```
#### KullanÄ±cÄ±yÄ± gruba ekle

Grubun sahipleri yeni kullanÄ±cÄ±larÄ± gruba ekleyebilir.
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

{% hint style="warning" %}
Gruplar dinamik olabilir, bu temelde **bir kullanÄ±cÄ± belirli koÅŸullarÄ± karÅŸÄ±larsa bir gruba ekleneceÄŸi anlamÄ±na gelir**. Tabii ki, koÅŸullar **Ã¶zelliklere** dayanÄ±yorsa ve bir **kullanÄ±cÄ±** bunu **kontrol edebiliyorsa**, bu Ã¶zelliÄŸi **baÅŸka gruplara girmek iÃ§in kÃ¶tÃ¼ye kullanabilir**.\
Dinamik gruplarÄ± nasÄ±l kÃ¶tÃ¼ye kullanabileceÄŸinizi kontrol edin:
{% endhint %}

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

### Hizmet Ä°lkeleri / Kurumsal Uygulamalar

{% hint style="info" %}
**PowerShell** terimlerinde **Hizmet Ä°lkesi**nin Azure portalÄ±nda (web) **Kurumsal Uygulamalar** olarak adlandÄ±rÄ±ldÄ±ÄŸÄ±nÄ± unutmayÄ±n.
{% endhint %}

{% tabs %}
{% tab title="az cli" %}
```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

Azure AD, Microsoft'un kimlik ve eriÅŸim yÃ¶netimi bulut hizmetidir. Azure AD, kullanÄ±cÄ± kimliklerini ve eriÅŸim haklarÄ±nÄ± yÃ¶netmek iÃ§in kullanÄ±lÄ±r. Bu hizmet, kimlik doÄŸrulama, eriÅŸim denetimi ve gÃ¼venlik politikalarÄ±nÄ± uygulamayÄ± saÄŸlar.

Azure AD, Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama, tek oturum aÃ§ma ve eriÅŸim denetimi gibi gÃ¼venlik Ã¶zelliklerini destekler. AyrÄ±ca, uygulamalarÄ±n ve hizmetlerin kimlik doÄŸrulama sÃ¼reÃ§lerini yÃ¶netmek iÃ§in entegrasyon seÃ§enekleri sunar.

Bu Ã¶zellikler, Azure AD'nin gÃ¼venliÄŸini artÄ±rmak ve kimlik hÄ±rsÄ±zlÄ±ÄŸÄ± gibi saldÄ±rÄ±lara karÅŸÄ± koruma saÄŸlamak iÃ§in kullanÄ±labilir.

{% endtab %}
```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %} 

Azure AD ile Ã§alÄ±ÅŸÄ±rken, Azure PowerShell modÃ¼lÃ¼nÃ¼ kullanarak bir dizi iÅŸlem gerÃ§ekleÅŸtirebilirsiniz. Ä°ÅŸte bazÄ± temel iÅŸlemler:

- Yeni bir Azure AD kullanÄ±cÄ±sÄ± oluÅŸturma
- Varolan bir kullanÄ±cÄ±yÄ± gÃ¼ncelleme
- KullanÄ±cÄ± hesabÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakma veya silme
- Grup oluÅŸturma, gÃ¼ncelleme veya silme
- KullanÄ±cÄ±yÄ± bir gruba ekleme veya gruptan Ã§Ä±karma

Azure PowerShell modÃ¼lÃ¼, Azure AD ile etkileÅŸimde bulunmak iÃ§in gÃ¼Ã§lÃ¼ bir araÃ§tÄ±r ve birÃ§ok yÃ¶netim gÃ¶revini otomatikleÅŸtirmenize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak Azure AD ortamÄ±nÄ±zÄ± daha verimli bir ÅŸekilde yÃ¶netebilirsiniz.

{% endtab %}
```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```
{% endtab %}

{% tab title="Ham" %}Dosya adÄ±: `az-azuread.py`

Bu araÃ§, Azure AD kiracÄ±nÄ±zda kullanÄ±cÄ±lar, gruplar ve uygulamalar hakkÄ±nda bilgi toplamak iÃ§in kullanÄ±lÄ±r. AyrÄ±ca, bu araÃ§, kullanÄ±cÄ±larÄ±n parolalarÄ±nÄ± sÄ±fÄ±rlamak, kullanÄ±cÄ± hesaplarÄ±nÄ± kilitlemek ve kullanÄ±cÄ±larÄ±n oturum aÃ§ma etkinliÄŸini kontrol etmek gibi bazÄ± iÅŸlevleri de gerÃ§ekleÅŸtirebilir.

### KullanÄ±m

```bash
python3 az-azuread.py -t <tenant_id> -c <client_id> -s <client_secret> -u <username> -p <password> -m <mode>
```

- `tenant_id`: Azure AD kiracÄ± kimliÄŸi
- `client_id`: Azure AD uygulama istemci kimliÄŸi
- `client_secret`: Azure AD uygulama istemci sÄ±rrÄ±
- `username`: YÃ¶netici kullanÄ±cÄ± adÄ±
- `password`: YÃ¶netici parolasÄ±
- `mode`: Toplama veya saldÄ±rÄ± modu (collect/attack)

### Ã–rnekler

Azure AD kiracÄ± kimliÄŸi `12345678-90ab-cdef-ghij-klmnopqrstuv` olan, Azure AD uygulama istemci kimliÄŸi `abcdefgh-ijkl-mnop-qrst-uvwxyz123456`, Azure AD uygulama istemci sÄ±rrÄ± `s3cr3t`, yÃ¶netici kullanÄ±cÄ± adÄ± `admin@domain.com` ve yÃ¶netici parolasÄ± `P@ssw0rd!` ile Ã§alÄ±ÅŸtÄ±rma Ã¶rneÄŸi:

```bash
python3 az-azuread.py -t 12345678-90ab-cdef-ghij-klmnopqrstuv -c abcdefgh-ijkl-mnop-qrst-uvwxyz123456 -s s3cr3t -u admin@domain.com -p P@ssw0rd! -m collect
```
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Bir Hizmet Temsilcisinin Sahibi, ÅŸifresini deÄŸiÅŸtirebilir.
{% endhint %}

<details>

<summary>Her Kurumsal Uygulamada bir istemci sÄ±rrÄ± eklemeyi deneyin ve listeyin</summary>
```powershell
# Just call Add-AzADAppSecret
Function Add-AzADAppSecret
{
<#
.SYNOPSIS
Add client secret to the applications.

.PARAMETER GraphToken
Pass the Graph API Token

.EXAMPLE
PS C:\> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK
https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0&tabs=http
https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0&tabs=http
#>

[CmdletBinding()]
param(
[Parameter(Mandatory=$True)]
[String]
$GraphToken = $null
)

$AppList = $null
$AppPassword = $null

# List All the Applications

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications"
"Method"  = "GET"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

try
{
$AppList = Invoke-RestMethod @Params -UseBasicParsing
}
catch
{
}

# Add Password in the Application

if($AppList -ne $null)
{
[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value)
{
$ID = $App.ID
$psobj = New-Object PSObject

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword"
"Method"  = "POST"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

$Body = @{
"passwordCredential"= @{
"displayName" = "Password"
}
}

try
{
$AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json)
Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID
Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId
Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName
Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId
Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText
$Details.Add($psobj) | Out-Null
}
catch
{
Write-Output "Failed to add new client secret to '$($App.displayName)' Application."
}
}
if($Details -ne $null)
{
Write-Output ""
Write-Output "Client secret added to : "
Write-Output $Details | fl *
}
}
else
{
Write-Output "Failed to Enumerate the Applications."
}
}
```
</details>

### Roller

{% tabs %}
{% tab title="az cli" %}
```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %}

Azure AD, Microsoft'un kimlik ve eriÅŸim yÃ¶netimi bulut hizmetidir. Azure AD, kullanÄ±cÄ± kimliklerini ve eriÅŸim haklarÄ±nÄ± yÃ¶netmek iÃ§in kullanÄ±lÄ±r. Azure AD'nin gÃ¼venliÄŸini deÄŸerlendirmek iÃ§in Ã§eÅŸitli teknikler ve araÃ§lar kullanÄ±labilir. Bu deÄŸerlendirme sÄ±rasÄ±nda, kullanÄ±cÄ± hesaplarÄ±nÄ±n gÃ¼Ã§lÃ¼ parolalarla korunduÄŸundan, Ã§oklu faktÃ¶rlÃ¼ kimlik doÄŸrulamanÄ±n etkinleÅŸtirildiÄŸinden ve gereksiz ayrÄ±calÄ±klarÄ±n atandÄ±ÄŸÄ±ndan emin olunmalÄ±dÄ±r.

{% endtab %}
```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% endtab %}

{% tab title="Az PowerShell" %} 

Azure AD ile Ã§alÄ±ÅŸÄ±rken, Azure PowerShell modÃ¼lÃ¼nÃ¼ kullanarak bir dizi iÅŸlem gerÃ§ekleÅŸtirebilirsiniz. Bu modÃ¼l, Azure AD'deki nesneleri yÃ¶netmek iÃ§in kullanÄ±ÅŸlÄ± cmdlet'ler saÄŸlar. Ä°ÅŸte bazÄ± temel iÅŸlemler:

- KullanÄ±cÄ± hesaplarÄ±nÄ± yÃ¶netme
- Gruplar oluÅŸturma ve yÃ¶netme
- UygulamalarÄ± yapÄ±landÄ±rma ve yÃ¶netme
- PolitikalarÄ± yapÄ±landÄ±rma ve yÃ¶netme

Azure PowerShell modÃ¼lÃ¼nÃ¼ kullanarak Azure AD Ã¼zerinde birÃ§ok farklÄ± gÃ¶revi otomatikleÅŸtirebilir ve yÃ¶netebilirsiniz. Bu, bÃ¼yÃ¼k Ã¶lÃ§ekli ortamlarda zaman kazanmanÄ±za ve iÅŸlerinizi daha verimli bir ÅŸekilde yapmanÄ±za yardÄ±mcÄ± olabilir. 

{% endtab %}
```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
{% endtab %}

{% tab title="Ham" %}Bu belge, Azure Active Directory (Azure AD) hedeflerine yÃ¶nelik saldÄ±rÄ± vektÃ¶rlerini ve saldÄ±rÄ± tekniklerini aÃ§Ä±klar. Azure AD'nin gÃ¼venliÄŸini deÄŸerlendirmek ve zayÄ±f noktalarÄ± tespit etmek iÃ§in bu bilgileri kullanabilirsiniz.{% endtab %}
```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
### Cihazlar

{% tabs %}
{% tab title="az cli" %}
```bash
# If you know how to do this send a PR!
```
{% endtab %}

{% tab title="Azure AD" %}

Azure AD, Microsoft'un kimlik ve eriÅŸim yÃ¶netimi bulut hizmetidir. Azure AD, kullanÄ±cÄ± kimliklerini ve eriÅŸim haklarÄ±nÄ± yÃ¶netmek iÃ§in kullanÄ±lÄ±r. Bu hizmet, kimlik doÄŸrulama, eriÅŸim denetimi ve gÃ¼venlik politikalarÄ±nÄ± uygulamak iÃ§in kullanÄ±lÄ±r.

Azure AD, bulut uygulamalarÄ±na ve diÄŸer Microsoft bulut hizmetlerine tek oturum aÃ§ma (SSO) saÄŸlar. AyrÄ±ca Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama, rol tabanlÄ± eriÅŸim denetimi ve diÄŸer gÃ¼venlik Ã¶zelliklerini destekler.

Azure AD, kuruluÅŸlarÄ±n bulut kaynaklarÄ±na gÃ¼venli bir ÅŸekilde eriÅŸmelerine yardÄ±mcÄ± olur ve kimlik avÄ± gibi saldÄ±rÄ±lara karÅŸÄ± koruma saÄŸlar.

{% endtab %}
```powershell
# Enumerate Devices
Get-AzureADDevice -All $true | fl *
# List all the active devices (and not the stale devices)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Get owners of all devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Registred users of all the devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Get dives managed using Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get Administrative Units of a device
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Bir cihaz (VM) **AzureAD'e katÄ±ldÄ±ÄŸÄ±nda**, AzureAD'den kullanÄ±cÄ±lar **giriÅŸ yapabilecek**.\
AyrÄ±ca, giriÅŸ yapan kullanÄ±cÄ± cihazÄ±n **Sahibi** ise, o kullanÄ±cÄ± **yerel yÃ¶netici** olacaktÄ±r.
{% endhint %}

### Uygulamalar

{% hint style="info" %}
**Uygulamalar**, portalda **Uygulama KayÄ±tlarÄ±**dÄ±r (Kurumsal Uygulamalar deÄŸil).\
Ancak her Uygulama KaydÄ± aynÄ± isimle bir **Kurumsal Uygulama** (**Hizmet Ä°lkesi**) oluÅŸturacaktÄ±r.\
AyrÄ±ca, Uygulama Ã§ok kiracÄ±lÄ± bir Uygulama ise, **baÅŸka** bir Kurumsal Uygulama (**Hizmet Ä°lkesi**) aynÄ± isimle **o kiracÄ±da** oluÅŸturulacaktÄ±r.
{% endhint %}

Bir Uygulama oluÅŸturulduÄŸunda 2 tÃ¼r izin verilir:

* **Hizmet Ä°lkesine** verilen **Ä°zinler**
* **UygulamanÄ±n** kullanÄ±cÄ± **adÄ±na sahip olabileceÄŸi ve kullanabileceÄŸi Ä°zinler**.
```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

Azure Active Directory (Azure AD) is Microsoft's cloud-based identity and access management service. It allows organizations to manage user identities and create access policies to secure their resources.

### Security Best Practices

- Enable Multi-Factor Authentication (MFA) for all users to add an extra layer of security.
- Regularly review and audit user permissions to ensure least privilege access.
- Monitor sign-in logs and set up alerts for any suspicious activities.
- Implement Conditional Access policies to control access based on specific conditions.
- Enable password protection and smart lockout to prevent password attacks.

### Common Security Issues

- Weak or reused passwords leading to credential stuffing attacks.
- Lack of MFA allowing unauthorized access in case of password compromise.
- Overly permissive user permissions leading to data breaches.
- Lack of monitoring and alerting allowing malicious activities to go unnoticed.

### Tools and Techniques

- Azure AD Identity Protection for detecting potential vulnerabilities and risky accounts.
- Azure AD Privileged Identity Management for managing, controlling, and monitoring privileged identities.
- Azure AD Conditional Access for setting policies to grant or block access based on specific conditions.

{% endtab %}
```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %} 

Azure AD ile Ã§alÄ±ÅŸÄ±rken, Azure PowerShell modÃ¼lÃ¼nÃ¼ kullanarak bir dizi iÅŸlem gerÃ§ekleÅŸtirebilirsiniz. Ä°ÅŸte bazÄ± temel iÅŸlemler:

- Yeni bir Azure AD kullanÄ±cÄ±sÄ± oluÅŸturma
- Varolan bir kullanÄ±cÄ±nÄ±n bilgilerini gÃ¼ncelleme
- KullanÄ±cÄ± hesaplarÄ±nÄ± listeleme ve filtreleme
- KullanÄ±cÄ± hesaplarÄ±nÄ± etkinleÅŸtirme veya devre dÄ±ÅŸÄ± bÄ±rakma
- KullanÄ±cÄ± hesaplarÄ±nÄ± silme

Azure PowerShell modÃ¼lÃ¼, Azure AD ile etkileÅŸimde bulunmak iÃ§in gÃ¼Ã§lÃ¼ bir araÃ§tÄ±r ve birÃ§ok yÃ¶netim gÃ¶revini otomatikleÅŸtirmenize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak Azure AD gÃ¼venliÄŸini gÃ¼Ã§lendirebilir ve yÃ¶netim sÃ¼reÃ§lerinizi kolaylaÅŸtÄ±rabilirsiniz.

{% endtab %}
```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
**`AppRoleAssignment.ReadWrite`** izni olan bir uygulama, kendisine rol vererek **Global YÃ¶netici** seviyesine **yÃ¼kselme** yeteneÄŸine sahiptir.\
Daha fazla bilgi iÃ§in [**burayÄ± kontrol edin**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48).
{% endhint %}

{% hint style="info" %}
Bir uygulamanÄ±n bir belirteÃ§ istediÄŸinde kimliÄŸini kanÄ±tlamak iÃ§in kullandÄ±ÄŸÄ± gizli dizedir.\
Bu **ÅŸifreyi** bulursanÄ±z, **kiracÄ±** iÃ§inde **hizmet baÅŸkanÄ±** olarak eriÅŸebilirsiniz.\
Bu ÅŸifre yalnÄ±zca oluÅŸturulduÄŸunda gÃ¶rÃ¼nÃ¼rdÃ¼r (deÄŸiÅŸtirebilirsiniz ancak tekrar alamazsÄ±nÄ±z).\
UygulamanÄ±n **sahibi** buna bir **ÅŸifre ekleyebilir** (bÃ¶ylece onu taklit edebilir).\
Bu hizmet baÅŸkanlarÄ± olarak giriÅŸ yapmak **riskli olarak iÅŸaretlenmez** ve **MFA'ya sahip olmazlar**.
{% endhint %}

### Uygulamalar ve (Kurumsal Uygulamalar veya Hizmet BaÅŸkanlarÄ±) ArasÄ±ndaki Fark

Azure'da bir uygulama ile bir Hizmet BaÅŸkanÄ± arasÄ±ndaki fark:

* **Uygulama/Uygulama KayÄ±tlarÄ±**: Azure AD'nizde var olan uygulamalardÄ±r
* `(Get-AzureADApplication -filter "DisplayName eq 'testapp'")`
* **Hizmet BaÅŸkanÄ±/Kurumsal Uygulamalar**: Azure AD'nizdeki gÃ¼venlik nesneleridir ve Azure Dizininde **ayrÄ±calÄ±klara** sahip olabilirler ve uygulamanÄ±za veya Ã¼Ã§Ã¼ncÃ¼ taraf uygulamaya baÄŸlÄ±dÄ±rlar
* `Get-AzureADServicePrincipal -filter "DisplayName eq 'testapp'")`
* Bir yÃ¶netici, verilen izinler Ã§ok hassassa onaylamasÄ± gerekebilir.

Bir uygulama **ÃœÃ§Ã¼ncÃ¼ taraf kiracÄ±sÄ±nÄ±** Ã§alÄ±ÅŸtÄ±rabilir ve onu kullanmaya baÅŸladÄ±ÄŸÄ±nÄ±zda ve eriÅŸim verdiÄŸinizde, ihtiyaÃ§ duyduÄŸu bilgilere eriÅŸim saÄŸlamak iÃ§in **Kurumsal Uygulama/Hizmet BaÅŸkanÄ± kiracÄ±nÄ±zda oluÅŸturulur**:

### YÃ¶netim Birimleri

KullanÄ±cÄ±larÄ±n daha iyi yÃ¶netimi iÃ§in kullanÄ±lÄ±r.

YÃ¶netim birimleri, bir roldeki izinleri tanÄ±mladÄ±ÄŸÄ±nÄ±z kuruluÅŸunuzun herhangi bir bÃ¶lÃ¼mÃ¼ne **izinleri kÄ±sÄ±tlar**. Ã–rneÄŸin, [YardÄ±m MasasÄ± YÃ¶neticisi](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator) rolÃ¼nÃ¼ bÃ¶lgesel destek uzmanlarÄ±na devretmek iÃ§in yÃ¶netim birimlerini kullanabilirsiniz, bÃ¶ylece yalnÄ±zca destek verdikleri bÃ¶lgedeki kullanÄ±cÄ±larÄ± yÃ¶netebilirler.

Bu nedenle, yÃ¶netici birimine roller atayabilir ve Ã¼yeleri bu rolleri alacaktÄ±r.
```
```
{% endtab %}

{% tab title="AzureAD" %}

## Azure Active Directory (AzureAD)

Azure Active Directory (AzureAD) is Microsoft's cloud-based identity and access management service. It allows organizations to manage user identities and create access policies to secure their resources.

### Enumeration

When conducting a penetration test on AzureAD, enumeration is a crucial phase. Enumerating users, groups, roles, and permissions can provide valuable information for further attacks.

#### Tools

There are various tools available for enumerating AzureAD, such as:

- [Azure AD Recon](https://github.com/NetSPI/AzureADRecon)
- [Azure AD Connect Configuration Documenter](https://github.com/Microsoft/AADConnectConfigDocumenter)

### Exploitation

After enumeration, the next step is exploitation. Exploiting misconfigurations, weak permissions, or vulnerabilities in AzureAD can lead to unauthorized access or privilege escalation.

#### Techniques

Common exploitation techniques in AzureAD include password spraying, phishing attacks, and exploiting OAuth vulnerabilities.

### Post-Exploitation

Once access is gained, post-exploitation activities can include data exfiltration, lateral movement, and maintaining persistence within the AzureAD environment.

#### Recommendations

To secure AzureAD, it is essential to follow security best practices such as enforcing strong passwords, enabling multi-factor authentication, monitoring for suspicious activities, and regularly reviewing and updating access controls.

{% endtab %}
```powershell
# Get Administrative Units
Get-AzureADMSAdministrativeUnit
Get-AzureADMSAdministrativeUnit -Id <id>
# Get ID of admin unit by string
$adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'"
# List the users, groups, and devices affected by the administrative unit
Get-AzureADMSAdministrativeUnitMember -Id <id>
# Get the roles users have over the members of the AU
Get-AzureADMSScopedRoleMembership -Id <id> | fl #Get role ID and role members
```
{% endtab %}
{% endtabs %}

## Azure AD Kimlik Koruma (AIP) <a href="#title-text" id="title-text"></a>

Azure AD Kimlik Koruma (AIP), Azure Active Directory'deki kullanÄ±cÄ± kimliklerini tehlikeye atÄ±lmaktan korumaya yardÄ±mcÄ± olmak iÃ§in **otomatik tespit ve iyileÅŸtirme kullanan bir gÃ¼venlik hizmetidir**. AIP sÃ¼rekli olarak kullanÄ±cÄ± oturum aÃ§malarÄ±nÄ± ve kimlik yapÄ±landÄ±rmalarÄ±nÄ± izler ve riskleri deÄŸerlendirir, **uygun gÃ¼venlik Ã¶nlemlerini otomatik olarak uygular**, Ã¶rneÄŸin Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama gerektirme veya potansiyel olarak tehlikeli faaliyetleri engelleme. Bu, organizasyonlarÄ±n kimlik tabanlÄ± gÃ¼venlik ihlallerini Ã¶nlemesine yardÄ±mcÄ± olur.

AkÄ±ÅŸ:

1. Azure AD Kimlik Koruma, kullanÄ±cÄ± etkinliklerini izler ve kullanÄ±cÄ± **oturum aÃ§malarÄ±nÄ±, kimlik doÄŸrulama** olaylarÄ±nÄ± ve diÄŸer ilgili etkinlikleri veri toplar.
2. Hizmet, bu verileri analiz etmek ve potansiyel gÃ¼venlik tehditlerini tespit etmek iÃ§in **makine Ã¶ÄŸrenimi** algoritmalarÄ±nÄ± kullanÄ±r.
3. Azure AD Kimlik Koruma, tehdide (Ã¶rneÄŸin oturum aÃ§ma) bir risk seviyesi atar ve gerektiÄŸinde otomatik bir eylem gerÃ§ekleÅŸtirmek iÃ§in bir uyarÄ± oluÅŸturur.

## Azure AD Åifre Koruma (APP)

Azure AD Åifre Koruma (APP), Azure Active Directory'deki zayÄ±f ÅŸifreleri engelleyerek gÃ¼Ã§lÃ¼ ÅŸifre politikalarÄ±nÄ± zorlayarak **yardÄ±mcÄ± olan bir gÃ¼venlik Ã¶zelliÄŸidir**. APP, **sÄ±kÃ§a kullanÄ±lan zayÄ±f ÅŸifreleri** ve bunlarÄ±n varyasyonlarÄ±nÄ± engeller, ÅŸifreyle ilgili ihlallerin riskini azaltÄ±r. Hem bulutta hem de yerindeki Active Directory'de uygulanabilir ve organizasyon genelinde ÅŸifre gÃ¼venliÄŸini artÄ±rÄ±r.

### Referanslar

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Destek HackTricks</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}
