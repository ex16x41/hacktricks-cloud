# Az - AzureAD (AAD)

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

Azure Active Directory (Azure AD) æ˜¯å¾®è½¯åŸºäºäº‘çš„èº«ä»½å’Œè®¿é—®ç®¡ç†æœåŠ¡ã€‚å®ƒåœ¨ä½¿å‘˜å·¥èƒ½å¤Ÿç™»å½•å¹¶è®¿é—®èµ„æºæ–¹é¢å‘æŒ¥ç€é‡è¦ä½œç”¨ï¼Œæ— è®ºæ˜¯åœ¨ç»„ç»‡å†…éƒ¨è¿˜æ˜¯è¶…å‡ºç»„ç»‡èŒƒå›´ï¼ŒåŒ…æ‹¬ Microsoft 365ã€Azure é—¨æˆ·å’Œä¼—å¤šå…¶ä»– SaaS åº”ç”¨ç¨‹åºã€‚Azure AD çš„è®¾è®¡ä¾§é‡äºæä¾›åŸºæœ¬çš„èº«ä»½æœåŠ¡ï¼Œä¸»è¦åŒ…æ‹¬**èº«ä»½éªŒè¯ã€æˆæƒå’Œç”¨æˆ·ç®¡ç†**ã€‚

Azure AD çš„å…³é”®åŠŸèƒ½åŒ…æ‹¬**å¤šå› ç´ èº«ä»½éªŒè¯**å’Œ**æœ‰æ¡ä»¶è®¿é—®**ï¼Œä»¥åŠä¸å…¶ä»– Microsoft å®‰å…¨æœåŠ¡çš„æ— ç¼é›†æˆã€‚è¿™äº›åŠŸèƒ½æ˜¾è‘—æå‡äº†ç”¨æˆ·èº«ä»½çš„å®‰å…¨æ€§ï¼Œå¹¶èµ‹äºˆç»„ç»‡æœ‰æ•ˆå®æ–½å’Œæ‰§è¡Œå…¶è®¿é—®ç­–ç•¥çš„èƒ½åŠ›ã€‚ä½œä¸ºå¾®è½¯äº‘æœåŠ¡ç”Ÿæ€ç³»ç»Ÿçš„åŸºæœ¬ç»„æˆéƒ¨åˆ†ï¼ŒAzure AD å¯¹äºç”¨æˆ·èº«ä»½çš„åŸºäºäº‘çš„ç®¡ç†è‡³å…³é‡è¦ã€‚

## å®ä½“

### æšä¸¾

æ‚¨å¯ä»¥ä½¿ç”¨ [**az cli å·¥å…·**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)**ï¼Œ** **PowerShell æ¨¡å—** [**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/)ï¼ˆæˆ– [**AzureAD é¢„è§ˆ**](https://www.powershellgallery.com/packages/AzureADPreview)ï¼‰å’Œ [**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps) æ¨¡å—è¿›è¡Œæ­¤æšä¸¾ã€‚

{% hint style="success" %}
åœ¨ Linux ä¸­ï¼Œæ‚¨éœ€è¦å®‰è£… PowerShell Core:
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

#### **æ¨¡å—å·®å¼‚**

* **AzureAD** æ˜¯å¾®è½¯çš„ PowerShell æ¨¡å—ï¼Œç”¨äº**ç®¡ç† Azure ADã€‚å®ƒä¸æ˜¾ç¤º Azure AD å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œä¹Ÿä¸èƒ½ç”¨äºè®¿é—® Azure èµ„æºä¿¡æ¯**ã€‚
* **Az PowerShell** æ˜¯ä¸€ä¸ªç”¨äº**ç®¡ç† Azure èµ„æº**çš„æ¨¡å—ï¼Œå¯é€šè¿‡ PowerShell å‘½ä»¤è¡Œä½¿ç”¨ã€‚

### **è¿æ¥**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
{% endtab %}

{% tab title="åŸå§‹ PowerShell" %}
{% code overflow="wrap" %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="åŸå§‹æ“ä½œç³»ç»Ÿ" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% endcode %}
{% endtab %}
{% endtabs %}

å½“æ‚¨é€šè¿‡CLIç™»å½•åˆ°Azureæ—¶ï¼Œæ‚¨æ­£åœ¨ä½¿ç”¨å±äºMicrosoftçš„ç§Ÿæˆ·ä¸­çš„Azureåº”ç”¨ç¨‹åºã€‚è¿™äº›åº”ç”¨ç¨‹åºï¼Œå°±åƒæ‚¨å¯ä»¥åœ¨æ‚¨çš„å¸æˆ·ä¸­åˆ›å»ºçš„åº”ç”¨ç¨‹åºä¸€æ ·ï¼Œéƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯IDã€‚æ‚¨åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°çš„**å…è®¸åº”ç”¨ç¨‹åºåˆ—è¡¨**ä¸­å¯èƒ½**çœ‹ä¸åˆ°æ‰€æœ‰è¿™äº›åº”ç”¨ç¨‹åº**ï¼Œä½†å®ƒä»¬é»˜è®¤æ˜¯**å…è®¸çš„**ã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ª**PowerShellè„šæœ¬**è¿›è¡Œ**èº«ä»½éªŒè¯**æ—¶ä½¿ç”¨çš„åº”ç”¨ç¨‹åºå…·æœ‰å®¢æˆ·ç«¯ID **`1950a258-227b-4e31-a9cf-717495945fc2`**ã€‚å³ä½¿è¯¥åº”ç”¨ç¨‹åºä¸åœ¨æ§åˆ¶å°ä¸­æ˜¾ç¤ºï¼Œç³»ç»Ÿç®¡ç†å‘˜ä¹Ÿå¯ä»¥**é˜»æ­¢è¯¥åº”ç”¨ç¨‹åº**ï¼Œä»¥ä¾¿ç”¨æˆ·æ— æ³•ä½¿ç”¨é€šè¿‡è¯¥åº”ç”¨ç¨‹åºè¿æ¥çš„å·¥å…·è¿›è¡Œè®¿é—®ã€‚

ç„¶è€Œï¼Œè¿˜æœ‰**å…¶ä»–å®¢æˆ·ç«¯ID**çš„åº”ç”¨ç¨‹åºå°†å…è®¸æ‚¨è¿æ¥åˆ°Azureï¼š
```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```
### ç”¨æˆ·

{% tabs %}
{% tab title="az cli" %}
```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

### Enumeration

Azure AD enumeration can be performed using tools like `Azure AD Recon` or `Azure AD Exploitation Framework`. These tools can help in gathering information about users, groups, applications, and service principals in the Azure AD environment.

### Password Spraying

Password spraying attacks can be conducted against Azure AD using tools like `Spray` or `AzureSpray`. These tools allow an attacker to attempt a few common passwords against many user accounts to avoid account lockouts and detection.

### Phishing

Phishing attacks targeting Azure AD users can be executed to steal credentials or deliver malware. Attackers can create fake login pages or emails that mimic Azure AD login prompts to trick users into giving away their credentials.

### Brute Force

BrHound is a tool that can be used to perform brute force attacks against Azure AD accounts. It can help in guessing weak passwords by trying different combinations until the correct one is found.

### Token Manipulation

Attackers can manipulate tokens in Azure AD to escalate privileges or access resources they are not authorized to. Tools like `Rubeus` can be used to perform Kerberos ticket attacks and manipulate tokens to achieve persistence in the Azure AD environment.

### Account Takeover

Once an attacker has valid credentials, they can perform an account takeover in Azure AD. Attackers can change account settings, access sensitive information, or perform unauthorized actions using the compromised account.

### Data Exfiltration

Attackers can exfiltrate sensitive data from Azure AD using techniques like `OAuth abuse` or `Application token extraction`. By abusing OAuth tokens or extracting application tokens, attackers can steal valuable information stored in Azure AD.

### Persistence

To maintain access in Azure AD, attackers can establish persistence using methods like `backdoors`, `malicious apps`, or `OAuth backdoors`. These techniques allow attackers to maintain access even after remediation efforts are made by the defenders.

{% endtab %}
```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```
{% endtab %}

{% tab title="Az PowerShell" %} 

## Az PowerShell

### Enumerate Azure AD roles

1. **Description**: Enumerate Azure AD roles assigned to users or groups.

2. **Usage**: 
    ```powershell
    Get-AzureADUserAppRoleAssignment -ObjectId <UserOrGroupId>
    ```

3. **Example**:
    ```powershell
    Get-AzureADUserAppRoleAssignment -ObjectId john.doe@contoso.com
    ```

4. **Output**:
    ```plaintext
    ObjectId                             DisplayName    ResourceDisplayName    Id                             PrincipalDisplayName
    --------                             -----------    -------------------    --                             --------------------
    12345678-1234-1234-1234-1234567890ab  MyRole        MyService             98765432-9876-9876-9876-9876543210ab  john.doe@contoso.com
    ```

{% endtab %}
```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```
{% endtab %}
{% endtabs %}

#### æ›´æ”¹ç”¨æˆ·å¯†ç 

{% code overflow="wrap" %}
```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText â€“Force

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password â€“Verbose
```
{% endcode %}

### å¤šé‡èº«ä»½éªŒè¯ï¼ˆMFAï¼‰å’Œæ¡ä»¶è®¿é—®ç­–ç•¥

å¼ºçƒˆå»ºè®®ä¸ºæ¯ä¸ªç”¨æˆ·æ·»åŠ MFAï¼Œä½†æ˜¯æœ‰äº›å…¬å¸å¯èƒ½ä¸ä¼šè®¾ç½®å®ƒï¼Œæˆ–è€…å¯èƒ½ä¼šé€šè¿‡æ¡ä»¶è®¿é—®è®¾ç½®å®ƒï¼šå¦‚æœç”¨æˆ·ä»ç‰¹å®šä½ç½®ã€æµè§ˆå™¨æˆ–æŸäº›æ¡ä»¶ç™»å½•ï¼Œåˆ™å°†**éœ€è¦MFA**ã€‚å¦‚æœè¿™äº›ç­–ç•¥æœªæ­£ç¡®é…ç½®ï¼Œå¯èƒ½å®¹æ˜“å—åˆ°**ç»•è¿‡**æ”»å‡»ã€‚æ£€æŸ¥ï¼š

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

### ç»„

{% tabs %}
{% tab title="az cli" %}
```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

### Enumeration

Azure AD enumeration can be performed using various techniques such as:

- **User Enumeration**: Enumerating valid usernames through methods like user enumeration APIs, password reset functionality, or by analyzing error messages.
- **Group Enumeration**: Identifying Azure AD groups and their members to understand the organization's structure.
- **Application Enumeration**: Discovering applications registered in Azure AD to identify potential targets for attacks.
- **Device Enumeration**: Enumerating devices registered in Azure AD to assess the device landscape within the organization.

### Exploitation

Exploiting Azure AD involves techniques like:

- **Password Spraying**: Attempting to authenticate using common passwords across multiple accounts to avoid account lockouts.
- **Brute Force Attacks**: Trying various password combinations to gain unauthorized access to Azure AD accounts.
- **Phishing Attacks**: Using deceptive emails or websites to trick users into revealing their credentials, which can then be used to compromise Azure AD accounts.
- **Token Impersonation**: Exploiting weaknesses in token handling to impersonate users or gain unauthorized access to resources.

### Post-Exploitation

After gaining access to Azure AD, an attacker can perform various post-exploitation activities such as:

- **Privilege Escalation**: Elevating privileges within Azure AD to gain access to more sensitive information or perform administrative actions.
- **Data Exfiltration**: Stealing data from Azure AD, suchjson web tokens (JWTs), user information, or sensitive documents.
- **Persistence**: Establishing persistence within Azure AD to maintain access even after being detected and removed.
- **Account Takeover**: Taking control of user accounts to perform unauthorized actions or access confidential data.

{% endtab %}
```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```
{% endtab %}

{% tab title="Az PowerShell" %} 

## Az PowerShell

### Connect to Azure AD

To connect to Azure AD using Az PowerShell, you can use the following command:

```powershell
Connect-AzAccount
```

This command will open a dialog box for you to enter your Azure AD credentials.

### List Azure AD Users

To list all Azure AD users using Az PowerShell, you can use the following command:

```powershell
Get-AzADUser
```

This command will retrieve a list of all Azure AD users in your tenant.

### Get Azure AD User

To get information about a specific Azure AD user, you can use the following command:

```powershell
Get-AzADUser -UserPrincipalName user@example.com
```

Replace `user@example.com` with the user's actual UPN.

### Create Azure AD User

To create a new Azure AD user using Az PowerShell, you can use the following command:

```powershell
New-AzADUser -DisplayName "John Doe" -UserPrincipalName john.doe@example.com -Password "P@ssw0rd"
```

Replace the values with the user's desired display name, UPN, and password.

### Remove Azure AD User

To remove an Azure AD user using Az PowerShell, you can use the following command:

```powershell
Remove-AzADUser -UserPrincipalName user@example.com
```

Replace `user@example.com` with the user's actual UPN.

{% endtab %}
```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
```
#### å°†ç”¨æˆ·æ·»åŠ åˆ°ç»„

ç»„çš„æ‰€æœ‰è€…å¯ä»¥å°†æ–°ç”¨æˆ·æ·»åŠ åˆ°ç»„ä¸­

{% code overflow="wrap" %}
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

{% hint style="warning" %}
ç»„å¯ä»¥æ˜¯åŠ¨æ€çš„ï¼Œè¿™åŸºæœ¬ä¸Šæ„å‘³ç€**å¦‚æœç”¨æˆ·æ»¡è¶³æŸäº›æ¡ä»¶ï¼Œä»–å°†è¢«æ·»åŠ åˆ°ä¸€ä¸ªç»„ä¸­**ã€‚å½“ç„¶ï¼Œå¦‚æœæ¡ä»¶æ˜¯åŸºäº**å±æ€§**ï¼Œ**ç”¨æˆ·**å¯ä»¥**æ§åˆ¶**ï¼Œä»–å¯èƒ½ä¼šæ»¥ç”¨è¿™ä¸ªåŠŸèƒ½æ¥**è¿›å…¥å…¶ä»–ç»„**ã€‚\
æŸ¥çœ‹å¦‚ä½•æ»¥ç”¨åŠ¨æ€ç»„åœ¨ä»¥ä¸‹é¡µé¢ï¼š
{% endhint %}

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

### æœåŠ¡ä¸»ä½“ / ä¼ä¸šåº”ç”¨ç¨‹åº

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œåœ¨ PowerShell æœ¯è¯­ä¸­**Service Principal**è¢«ç§°ä¸º**Azure é—¨æˆ·ï¼ˆwebï¼‰**ä¸­çš„**Enterprise Applications**ã€‚
{% endhint %}

{% tabs %}
{% tab title="az cli" %}
```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

### Enumeration

Azure AD enumeration can be performed using various techniques such as:

- **User Enumeration**: Enumerating valid usernames through the login interface or other means.
- **Group Enumeration**: Identifying Azure AD groups and their members.
- **Application Enumeration**: Discovering registered applications in Azure AD.
- **Service Principal Enumeration**: Identifying service principals and their permissions.
- **Device Enumeration**: Enumerating devices registered in Azure AD.

### Exploitation

Exploitation of Azure AD may involve techniques like:

- **Password Spraying**: Attempting to authenticate using common passwords across multiple accounts.
- **Phishing Attacks**: Tricking users into providing their credentials through fake login pages.
- **Brute Force Attacks**: Trying various password combinations to gain unauthorized access.
- **Token Impersonation**: Stealing or forging tokens to impersonate users or applications.
- **OAuth Abuse**: Exploiting misconfigurations in OAuth implementations for unauthorized access.

### Post-Exploitation

After gaining access to Azure AD, an attacker may perform actions like:

- **Data Exfiltration**: Stealing sensitive data stored in Azure AD.
- **Privilege Escalation**: Elevating privileges to gain more control over Azure AD resources.
- **Persistence**: Maintaining access to Azure AD even after being detected.
- **Account Takeover**: Taking control of user accounts for malicious purposes.

{% endtab %}
```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}åœ¨ Azure AD ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ Az PowerShell æ¨¡å—æ¥æ‰§è¡Œå„ç§ç®¡ç†ä»»åŠ¡ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ç¤ºä¾‹ï¼š

- å®‰è£… Az PowerShell æ¨¡å—ï¼š
```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

- è¿æ¥åˆ° Azure ADï¼š
```powershell
Connect-AzAccount
```

- è·å– Azure AD ç”¨æˆ·ï¼š
```powershell
Get-AzADUser
```

- åˆ›å»ºæ–°ç”¨æˆ·ï¼š
```powershell
New-AzADUser -DisplayName "John Doe" -UserPrincipalName "john.doe@contoso.com"
```

- åˆ é™¤ç”¨æˆ·ï¼š
```powershell
Remove-AzADUser -UserPrincipalName "john.doe@contoso.com"
```
```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```
{% endtab %}

{% tab title="åŸå§‹" %}
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
æœåŠ¡ä¸»ä½“çš„æ‰€æœ‰è€…å¯ä»¥æ›´æ”¹å…¶å¯†ç ã€‚
{% endhint %}

<details>

<summary>åˆ—å‡ºå¹¶å°è¯•åœ¨æ¯ä¸ªä¼ä¸šåº”ç”¨ç¨‹åºä¸Šæ·»åŠ å®¢æˆ·ç«¯å¯†ç </summary>
```powershell
# Just call Add-AzADAppSecret
Function Add-AzADAppSecret
{
<#
.SYNOPSIS
Add client secret to the applications.

.PARAMETER GraphToken
Pass the Graph API Token

.EXAMPLE
PS C:\> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK
https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0&tabs=http
https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0&tabs=http
#>

[CmdletBinding()]
param(
[Parameter(Mandatory=$True)]
[String]
$GraphToken = $null
)

$AppList = $null
$AppPassword = $null

# List All the Applications

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications"
"Method"  = "GET"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

try
{
$AppList = Invoke-RestMethod @Params -UseBasicParsing
}
catch
{
}

# Add Password in the Application

if($AppList -ne $null)
{
[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value)
{
$ID = $App.ID
$psobj = New-Object PSObject

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword"
"Method"  = "POST"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

$Body = @{
"passwordCredential"= @{
"displayName" = "Password"
}
}

try
{
$AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json)
Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID
Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId
Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName
Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId
Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText
$Details.Add($psobj) | Out-Null
}
catch
{
Write-Output "Failed to add new client secret to '$($App.displayName)' Application."
}
}
if($Details -ne $null)
{
Write-Output ""
Write-Output "Client secret added to : "
Write-Output $Details | fl *
}
}
else
{
Write-Output "Failed to Enumerate the Applications."
}
}
```
</details>

### è§’è‰²

{% tabs %}
{% tab title="az cli" %}
```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

### Enumeration

Azure AD enumeration can be performed using various techniques such as:

- **User Enumeration**: Enumerating valid usernames through the login interface or other means.
- **Group Enumeration**: Identifying Azure AD groups and their members.
- **Application Enumeration**: Discovering registered applications in Azure AD.
- **Device Enumeration**: Identifying devices registered in Azure AD.

### Exploitation

Common exploitation techniques in Azure AD include:

- **Password Spraying**: Attempting to authenticate using common passwords across multiple accounts.
- **Phishing Attacks**: Sending fraudulent emails to trick users into providing their credentials.
- **Brute Force Attacks**: Trying multiple password combinations to gain unauthorized access.
- **Token Impersonation**: Stealing or forging tokens to impersonate users or applications.

### Post-Exploitation

After gaining access to Azure AD, an attacker may perform actions like:

- **User Account Takeover**: Taking control of user accounts to access resources.
- **Data Exfiltration**: Stealing sensitive data stored in Azure AD.
- **Privilege Escalation**: Elevating privileges to gain more control over Azure AD resources.
- **Persistence**: Maintaining access to Azure AD by creating backdoors or other means.

{% endtab %}
```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}åœ¨ Azure AD ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ Az PowerShell æ¨¡å—æ‰§è¡Œå„ç§æ“ä½œï¼ŒåŒ…æ‹¬ç®¡ç†ç”¨æˆ·ã€ç»„ã€åº”ç”¨ç¨‹åºç­‰ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ Az PowerShell å‘½ä»¤ç¤ºä¾‹ï¼š

### è¿æ¥åˆ° Azure AD
```powershell
Connect-AzAccount
```

### è·å–æ‰€æœ‰ç”¨æˆ·
```powershell
Get-AzureADUser
```

### åˆ›å»ºæ–°ç”¨æˆ·
```powershell
New-AzureADUser -DisplayName "John Doe" -UserPrincipalName "john.doe@contoso.com"
```

### è·å–æ‰€æœ‰ç»„
```powershell
Get-AzureADGroup
```

### åˆ›å»ºæ–°ç»„
```powershell
New-AzureADGroup -DisplayName "Engineering Team" -MailEnabled $false -SecurityEnabled $true
```

### è·å–æ‰€æœ‰åº”ç”¨ç¨‹åº
```powershell
Get-AzureADApplication
```

### åˆ›å»ºæ–°åº”ç”¨ç¨‹åº
```powershell
New-AzureADApplication -DisplayName "MyApp" -IdentifierUris "https://myapp"
```
```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
{% endtab %}

{% tab title="åŸå§‹" %}Translate the relevant English text to Chinese and return the translation keeping excatly the same markdown and html syntax. Do not translate things like code, hacking technique names, hacking word, cloud/SaaS platform names (like Workspace, aws, gcp...), the word 'leak', pentesting, and markdown tags. Also don't add any extra stuff apart from the translation and markdown syntax.
```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
### è®¾å¤‡

{% tabs %}
{% tab title="az cli" %}
```bash
# If you know how to do this send a PR!
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

### Enumeration

Azure AD enumeration can be performed using a variety of techniques, including:

- **User Enumeration**: Enumerating valid usernames through the login interface or other means.
- **Group Enumeration**: Identifying Azure AD groups and their members.
- **Application Enumeration**: Discovering registered applications within Azure AD.

### Password Spraying

Password spraying attacks against Azure AD involve attempting a small number of commonly used passwords against many accounts to avoid account lockouts and detection.

### Brute Force Attacks

Brute force attacks against Azure AD involve systematically checking all possible passwords until the correct one is found.

### Phishing

Phishing attacks targeting Azure AD users can be used to steal credentials or deliver malware.

### Token Manipulation

Manipulating tokens issued by Azure AD can allow an attacker to escalate privileges or maintain persistence within the environment.

### Password Policies

Understanding and bypassing Azure AD password policies can help in conducting successful password-based attacks.

### Multi-Factor Authentication (MFA) Bypass

Finding ways to bypass or circumvent MFA in Azure AD can provide unauthorized access to accounts.

### Password Hashes

Obtaining and cracking password hashes from Azure AD can lead to the disclosure of plaintext passwords.

### Account Lockout Policies

Understanding and potentially bypassing account lockout policies in Azure AD can help in conducting brute force attacks without getting locked out.

### OAuth Abuse

Abusing OAuth functionality in Azure AD can lead to unauthorized access to resources and sensitive data.

### Federation Trusts

Exploiting misconfigurations in federation trusts can allow an attacker to gain unauthorized access to Azure AD resources.

### Privilege Escalation

Identifying and exploiting privilege escalation vulnerabilities in Azure AD can lead to increased access and control over the environment.

### Data Exfiltration

Exfiltrating sensitive data from Azure AD can result in the exposure of confidential information to unauthorized individuals.

### Logging and Monitoring

Monitoring Azure AD logs and activities can help in detecting and responding to security incidents in a timely manner.

### Security Best Practices

Following security best practices for Azure AD can help in mitigating common security risks and protecting the environment from potential threats.

{% endtab %}
```powershell
# Enumerate Devices
Get-AzureADDevice -All $true | fl *
# List all the active devices (and not the stale devices)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Get owners of all devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Registred users of all the devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Get dives managed using Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get Administrative Units of a device
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
å¦‚æœè®¾å¤‡ï¼ˆVMï¼‰åŠ å…¥äº†**AzureAD**ï¼Œåˆ™æ¥è‡ªAzureADçš„ç”¨æˆ·å°†èƒ½å¤Ÿ**ç™»å½•**ã€‚\
æ­¤å¤–ï¼Œå¦‚æœç™»å½•ç”¨æˆ·æ˜¯è®¾å¤‡çš„**æ‰€æœ‰è€…**ï¼Œä»–å°†æˆä¸º**æœ¬åœ°ç®¡ç†å‘˜**ã€‚
{% endhint %}

### åº”ç”¨ç¨‹åº

{% hint style="info" %}
**åº”ç”¨ç¨‹åº**æ˜¯é—¨æˆ·ä¸­çš„**åº”ç”¨æ³¨å†Œ**ï¼ˆè€Œä¸æ˜¯ä¼ä¸šåº”ç”¨ç¨‹åºï¼‰ã€‚\
ä½†æ˜¯ï¼Œæ¯ä¸ªåº”ç”¨æ³¨å†Œå°†åˆ›å»ºä¸€ä¸ªå…·æœ‰ç›¸åŒåç§°çš„**ä¼ä¸šåº”ç”¨ç¨‹åº**ï¼ˆ**æœåŠ¡ä¸»ä½“**ï¼‰ã€‚\
æ­¤å¤–ï¼Œå¦‚æœåº”ç”¨æ˜¯**å¤šç§Ÿæˆ·åº”ç”¨ç¨‹åº**ï¼Œå°†åœ¨**è¯¥ç§Ÿæˆ·**ä¸­åˆ›å»ºå¦ä¸€ä¸ª**ä¼ä¸šåº”ç”¨ç¨‹åº**ï¼ˆ**æœåŠ¡ä¸»ä½“**ï¼‰å¹¶å…·æœ‰ç›¸åŒçš„åç§°ã€‚
{% endhint %}

å½“ç”Ÿæˆä¸€ä¸ªåº”ç”¨ç¨‹åºæ—¶ï¼Œä¼šèµ‹äºˆä¸¤ç§ç±»å‹çš„æƒé™ï¼š

- èµ‹äºˆ**æœåŠ¡ä¸»ä½“**çš„**æƒé™**
- **åº”ç”¨ç¨‹åº**å¯ä»¥æ‹¥æœ‰å¹¶ä»£è¡¨**ç”¨æˆ·**ä½¿ç”¨çš„**æƒé™**ã€‚
```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD Enumeration

### User Enumeration

- **Description**: User enumeration can be performed through the Azure AD login interface by entering a valid username and observing the response.
  
- **Impact**: User enumeration can help an attacker identify valid usernames in the Azure AD environment, which can be used in further attacks such as password spraying.

- **Recommendation**: Implement account lockout policies to prevent brute force attacks and monitor failed login attempts for unusual patterns.

### Group Enumeration

- **Description**: Group enumeration can be done by querying the Azure AD Graph API to retrieve information about existing groups.

- **Impact**: Knowledge of existing groups can help an attacker understand the organization's structure and potentially identify high-value targets.

- **Recommendation**: Regularly review and update group memberships to ensure least privilege access.

### Application Enumeration

- **Description**: Application enumeration involves identifying applications registered in Azure AD.

- **Impact**: Attackers can target specific applications with known vulnerabilities or misconfigurations to gain access to sensitive data.

- **Recommendation**: Regularly review and audit registered applications, removing any unused or unnecessary ones.

### Device Enumeration

- **Description**: Device enumeration allows an attacker to gather information about devices registered in Azure AD.

- **Impact**: Knowledge of registered devices can help attackers target specific devices for further exploitation.

- **Recommendation**: Enforce device registration controls and regularly review registered devices for any anomalies.

### Service Principal Enumeration

- **Description**: Service principals represent applications or services in Azure AD, and enumeration involves identifying these principals.

- **Impact**: Attackers can abuse misconfigured service principals to gain unauthorized access to resources.

- **Recommendation**: Regularly review and update service principals, ensuring they have the least privileges necessary.

{% endtab %}
```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}åœ¨ Azure AD ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Az PowerShell æ¨¡å—æ¥æ‰§è¡Œå„ç§æ“ä½œã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ç¤ºä¾‹ï¼š

### è¿æ¥åˆ° Azure AD
```powershell
Connect-AzAccount
```

### è·å– Azure AD ç”¨æˆ·
```powershell
Get-AzADUser
```

### åˆ›å»ºæ–°ç”¨æˆ·
```powershell
New-AzADUser -DisplayName "John Doe" -UserPrincipalName "john.doe@contoso.com"
```

### åˆ é™¤ç”¨æˆ·
```powershell
Remove-AzADUser -UserPrincipalName "john.doe@contoso.com"
```

### æ›´æ–°ç”¨æˆ·
```powershell
Set-AzADUser -UserPrincipalName "john.doe@contoso.com" -DisplayName "Jane Smith"
```

### è·å– Azure AD ç»„
```powershell
Get-AzADGroup
```

### åˆ›å»ºæ–°ç»„
```powershell
New-AzADGroup -DisplayName "Developers" -MailEnabled $false -SecurityEnabled $true
```

### åˆ é™¤ç»„
```powershell
Remove-AzADGroup -DisplayName "Developers"
```

### æ›´æ–°ç»„
```powershell
Set-AzADGroup -DisplayName "Developers" -Description "Group for developers"
```
{% endtab %}
```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
å…·æœ‰æƒé™ **`AppRoleAssignment.ReadWrite`** çš„åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡æˆäºˆè‡ªèº«è§’è‰²æ¥**å‡çº§ä¸ºå…¨å±€ç®¡ç†å‘˜**ã€‚\
æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[**æ­¤å¤„**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48)ã€‚
{% endhint %}

{% hint style="info" %}
åº”ç”¨ç¨‹åºç”¨äºåœ¨è¯·æ±‚ä»¤ç‰Œæ—¶è¯æ˜å…¶èº«ä»½çš„ç§˜å¯†å­—ç¬¦ä¸²æ˜¯åº”ç”¨ç¨‹åºå¯†ç ã€‚\
å› æ­¤ï¼Œå¦‚æœæ‰¾åˆ°æ­¤**å¯†ç **ï¼Œæ‚¨å¯ä»¥ä½œä¸º**æœåŠ¡ä¸»ä½“** **åœ¨** **ç§Ÿæˆ·** ä¸­è®¿é—®ã€‚\
è¯·æ³¨æ„ï¼Œæ­¤å¯†ç ä»…åœ¨ç”Ÿæˆæ—¶å¯è§ï¼ˆæ‚¨å¯ä»¥æ›´æ”¹å®ƒï¼Œä½†æ— æ³•å†æ¬¡è·å–å®ƒï¼‰ã€‚\
**åº”ç”¨ç¨‹åº**çš„**æ‰€æœ‰è€…**å¯ä»¥ä¸ºå…¶**æ·»åŠ å¯†ç **ï¼ˆä»¥ä¾¿å†’å……å®ƒï¼‰ã€‚\
ä»¥è¿™äº›æœåŠ¡ä¸»ä½“çš„èº«ä»½ç™»å½•**ä¸ä¼šè¢«æ ‡è®°ä¸ºé£é™©**ï¼Œä¹Ÿ**ä¸ä¼šæœ‰å¤šé‡èº«ä»½éªŒè¯**ã€‚
{% endhint %}

### åº”ç”¨ç¨‹åºå’Œï¼ˆä¼ä¸šåº”ç”¨ç¨‹åºæˆ–æœåŠ¡ä¸»ä½“ï¼‰ä¹‹é—´çš„åŒºåˆ«

Azure ä¸­åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ä¸»ä½“ä¹‹é—´çš„åŒºåˆ«ï¼š

* **åº”ç”¨ç¨‹åº/åº”ç”¨æ³¨å†Œ**ï¼šå­˜åœ¨äºæ‚¨çš„ Azure AD ä¸­çš„åº”ç”¨ç¨‹åº
* `(Get-AzureADApplication -filter "DisplayName eq 'testapp'")`
* **æœåŠ¡ä¸»ä½“/ä¼ä¸šåº”ç”¨ç¨‹åº**ï¼šAzure AD ä¸­çš„å®‰å…¨å¯¹è±¡ï¼Œå¯ä»¥åœ¨ Azure ç›®å½•ä¸­æ‹¥æœ‰**ç‰¹æƒ**ï¼Œå¹¶ä¸æ‚¨çš„åº”ç”¨ç¨‹åºæˆ–ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºå…³è”
* `Get-AzureADServicePrincipal -filter "DisplayName eq 'testapp'")`
* å¦‚æœæƒé™éå¸¸æ•æ„Ÿï¼Œç®¡ç†å‘˜å¯èƒ½éœ€è¦æ‰¹å‡†ç»™å®šçš„æƒé™ã€‚

ä¸€ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥åœ¨**ç¬¬ä¸‰æ–¹ç§Ÿæˆ·**ä¸­è¿è¡Œï¼Œä¸€æ—¦å¼€å§‹ä½¿ç”¨å®ƒå¹¶æˆäºˆè®¿é—®æƒé™ï¼Œ**åœ¨æ‚¨çš„ç§Ÿæˆ·ä¸­å°†åˆ›å»ºä¸€ä¸ªä¼ä¸šåº”ç”¨ç¨‹åº/æœåŠ¡ä¸»ä½“**ï¼Œä»¥ä¾¿ä¸ºå…¶æä¾›æ‰€éœ€çš„ä¿¡æ¯è®¿é—®æƒé™ï¼š

### ç®¡ç†å•å…ƒ

ç”¨äºæ›´å¥½åœ°ç®¡ç†ç”¨æˆ·ã€‚

ç®¡ç†å•å…ƒ**å°†è§’è‰²çš„æƒé™é™åˆ¶ä¸ºæ‚¨å®šä¹‰çš„ç»„ç»‡çš„ä»»ä½•éƒ¨åˆ†**ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç®¡ç†å•å…ƒå°†[Helpdesk Administrator](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator) è§’è‰²å§”æ´¾ç»™åŒºåŸŸæ”¯æŒä¸“å‘˜ï¼Œä»¥ä¾¿ä»–ä»¬ä»…èƒ½ç®¡ç†å…¶æ”¯æŒçš„åŒºåŸŸä¸­çš„ç”¨æˆ·ã€‚

å› æ­¤ï¼Œæ‚¨å¯ä»¥å°†è§’è‰²åˆ†é…ç»™ç®¡ç†å‘˜å•å…ƒï¼Œå…¶æˆå‘˜å°†æ‹¥æœ‰è¿™äº›è§’è‰²ã€‚
```
```
{% endtab %}

{% tab title="AzureAD" %}

## AzureAD

### Enumeration

1. **User Enumeration**: Attackers can use methods like user enumeration through the Forgot Password feature or the OAuth token endpoint to gather valid usernames.

2. **Group Enumeration**: Attackers can also enumerate groups within the Azure AD tenant to understand the organization's structure and potentially identify high-value targets.

### Brute Force Attacks

1. **Password Spraying**: Attackers can perform password spraying attacks against Azure AD accounts to avoid account lockouts and detection.

2. **Credential Stuffing**: Attackers can use previously leaked credentials to perform credential stuffing attacks against Azure AD accounts.

### Phishing

1. **OAuth Token Phishing**: Attackers can phish for OAuth tokens to gain unauthorized access to Azure AD resources.

2. **Credential Phishing**: Attackers can conduct credential phishing campaigns to trick users into revealing their Azure AD credentials.

### Exploiting Misconfigurations

1. **Application Misconfigurations**: Attackers can exploit misconfigured Azure AD applications to gain unauthorized access or escalate privileges within the tenant.

2. **Permissions Misconfigurations**: Attackers can abuse misconfigured permissions to perform lateral movement or access sensitive information.

### Account Takeover

1. **Password Spraying for Account Takeover**: Attackers can use password spraying techniques to take over Azure AD accounts with weak passwords.

2. **Brute Force for Account Takeover**: Attackers can launch brute force attacks to gain unauthorized access to Azure AD accounts.

### Insider Threats

1. **Insider Account Compromise**: Insiders with legitimate access can abuse their privileges to exfiltrate data or perform unauthorized actions within Azure AD.

2. **Data Exfiltration**: Insiders can exfiltrate sensitive data from Azure AD using their legitimate access.

### Monitoring and Detection

1. **Anomaly Detection**: Implement anomaly detection mechanisms to identify unusual activities that could indicate a security breach.

2. **Logging and Alerting**: Ensure proper logging and alerting mechanisms are in place to detect and respond to suspicious activities in Azure AD.

### Recommendations

1. **Multi-Factor Authentication (MFA)**: Enforce MFA for all Azure AD accounts to add an extra layer of security.

2. **Regular Security Training**: Provide regular security awareness training to educate users about common attack techniques and how to avoid falling victim to them.

3. **Least Privilege Access**: Follow the principle of least privilege to restrict users' access rights within Azure AD to only what is necessary for their roles.

{% endtab %}
```powershell
# Get Administrative Units
Get-AzureADMSAdministrativeUnit
Get-AzureADMSAdministrativeUnit -Id <id>
# Get ID of admin unit by string
$adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'"
# List the users, groups, and devices affected by the administrative unit
Get-AzureADMSAdministrativeUnitMember -Id <id>
# Get the roles users have over the members of the AU
Get-AzureADMSScopedRoleMembership -Id <id> | fl #Get role ID and role members
```
{% endtab %}
{% endtabs %}

## Azure AD Identity Protection (AIP) <a href="#title-text" id="title-text"></a>

Azure AD Identity Protection (AIP)æ˜¯ä¸€é¡¹å®‰å…¨æœåŠ¡ï¼Œåˆ©ç”¨**è‡ªåŠ¨æ£€æµ‹å’Œçº æ­£æ¥å¸®åŠ©ä¿æŠ¤Azure Active Directoryä¸­ç”¨æˆ·èº«ä»½**å…å— compromiseã€‚AIPæŒç»­ç›‘è§†å’Œè¯„ä¼°ç”¨æˆ·ç™»å½•å’Œèº«ä»½é…ç½®çš„é£é™©ï¼Œ**è‡ªåŠ¨åº”ç”¨é€‚å½“çš„å®‰å…¨æªæ–½**ï¼Œä¾‹å¦‚è¦æ±‚å¤šé‡èº«ä»½éªŒè¯æˆ–é˜»æ­¢æ½œåœ¨å±é™©æ´»åŠ¨ã€‚è¿™æœ‰åŠ©äºç»„ç»‡é¢„é˜²åŸºäºèº«ä»½çš„å®‰å…¨æ¼æ´ã€‚

æµç¨‹ï¼š

1. Azure AD Identity Protection **ç›‘è§†ç”¨æˆ·æ´»åŠ¨**ï¼Œæ”¶é›†ç”¨æˆ·**ç™»å½•ã€è®¤è¯**äº‹ä»¶å’Œå…¶ä»–ç›¸å…³æ´»åŠ¨çš„æ•°æ®ã€‚
2. è¯¥æœåŠ¡ä½¿ç”¨**æœºå™¨å­¦ä¹ **ç®—æ³•åˆ†æè¿™äº›æ•°æ®ï¼Œæ£€æµ‹æ½œåœ¨çš„å®‰å…¨å¨èƒã€‚
3. Azure AD Identity Protection **ä¸ºå¨èƒåˆ†é…é£é™©çº§åˆ«**ï¼ˆä¾‹å¦‚ç™»å½•ï¼‰ï¼Œå¹¶åœ¨éœ€è¦æ—¶ç”Ÿæˆè­¦æŠ¥ä»¥æ‰§è¡Œä¸€äº›è‡ªåŠ¨æ“ä½œã€‚

## Azure AD Password Protection (APP)

Azure AD Password Protection (APP)æ˜¯ä¸€é¡¹å®‰å…¨åŠŸèƒ½ï¼Œ**é€šè¿‡å¼ºåˆ¶æ‰§è¡Œå¼ºå¯†ç ç­–ç•¥**ï¼Œå¸®åŠ©é˜²æ­¢Azure Active Directoryä¸­çš„å¼±å¯†ç ã€‚APPé˜»æ­¢**å¸¸ç”¨çš„å¼±å¯†ç **åŠå…¶å˜ä½“ï¼Œé™ä½ä¸å¯†ç ç›¸å…³çš„é£é™©ã€‚å®ƒå¯ä»¥åœ¨äº‘çº§åˆ«å’Œæœ¬åœ°Active Directoryä¸Šéƒ½åº”ç”¨ï¼Œå¢å¼ºç»„ç»‡æ•´ä½“çš„å¯†ç å®‰å…¨æ€§ã€‚

### å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
