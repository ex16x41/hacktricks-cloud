# Az - Tokens & Public Applications

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Entra ID √© a plataforma de gerenciamento de identidade e acesso (IAM) baseada em nuvem da Microsoft, servindo como o sistema fundamental de autentica√ß√£o e autoriza√ß√£o para servi√ßos como Microsoft 365 e Azure Resource Manager. O Azure AD implementa o framework de autoriza√ß√£o OAuth 2.0 e o protocolo de autentica√ß√£o OpenID Connect (OIDC) para gerenciar o acesso a recursos.

### OAuth

**Principais Participantes no OAuth 2.0:**

1. **Servidor de Recursos (RS):** Protege recursos pertencentes ao propriet√°rio do recurso.
2. **Propriet√°rio do Recurso (RO):** Normalmente um usu√°rio final que possui os recursos protegidos.
3. **Aplica√ß√£o Cliente (CA):** Uma aplica√ß√£o que busca acesso a recursos em nome do propriet√°rio do recurso.
4. **Servidor de Autoriza√ß√£o (AS):** Emite tokens de acesso para aplica√ß√µes clientes ap√≥s autenticar e autorizar.

**Escopos e Consentimento:**

* **Escopos:** Permiss√µes granulares definidas no servidor de recursos que especificam n√≠veis de acesso.
* **Consentimento:** O processo pelo qual um propriet√°rio de recurso concede a uma aplica√ß√£o cliente permiss√£o para acessar recursos com escopos espec√≠ficos.

**Integra√ß√£o com Microsoft 365:**

* O Microsoft 365 utiliza o Azure AD para IAM e √© composto por v√°rias aplica√ß√µes OAuth "de primeira parte".
* Essas aplica√ß√µes est√£o profundamente integradas e frequentemente t√™m rela√ß√µes de servi√ßo interdependentes.
* Para simplificar a experi√™ncia do usu√°rio e manter a funcionalidade, a Microsoft concede "consentimento impl√≠cito" ou "pr√©-consentimento" a essas aplica√ß√µes de primeira parte.
* **Consentimento Impl√≠cito:** Certas aplica√ß√µes s√£o automaticamente **concedidas acesso a escopos espec√≠ficos sem aprova√ß√£o expl√≠cita do usu√°rio ou administrador**.
* Esses escopos pr√©-consentidos geralmente est√£o ocultos tanto para usu√°rios quanto para administradores, tornando-os menos vis√≠veis nas interfaces de gerenciamento padr√£o.

**Tipos de Aplica√ß√µes Cliente:**

1. **Clientes Confidenciais:**
* Possuem suas pr√≥prias credenciais (por exemplo, senhas ou certificados).
* Podem **se autenticar de forma segura** no servidor de autoriza√ß√£o.
2. **Clientes P√∫blicos:**
* N√£o possuem credenciais √∫nicas.
* N√£o podem se autenticar de forma segura no servidor de autoriza√ß√£o.
* **Implica√ß√£o de Seguran√ßa:** Um atacante pode se passar por uma aplica√ß√£o cliente p√∫blica ao solicitar tokens, pois n√£o h√° mecanismo para o servidor de autoriza√ß√£o verificar a legitimidade da aplica√ß√£o.

## Authentication Tokens

Existem **tr√™s tipos de tokens** usados no OIDC:

* [**Tokens de Acesso**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** O cliente apresenta este token ao servidor de recursos para **acessar recursos**. Ele pode ser usado apenas para uma combina√ß√£o espec√≠fica de usu√°rio, cliente e recurso e **n√£o pode ser revogado** at√© a expira√ß√£o - que √© de 1 hora por padr√£o.
* **Tokens de ID**: O cliente recebe este **token do servidor de autoriza√ß√£o**. Ele cont√©m informa√ß√µes b√°sicas sobre o usu√°rio. Ele √© **vinculado a uma combina√ß√£o espec√≠fica de usu√°rio e cliente**.
* **Tokens de Atualiza√ß√£o**: Fornecidos ao cliente com o token de acesso. Usados para **obter novos tokens de acesso e ID**. Ele √© vinculado a uma combina√ß√£o espec√≠fica de usu√°rio e cliente e pode ser revogado. A expira√ß√£o padr√£o √© **90 dias** para tokens de atualiza√ß√£o inativos e **sem expira√ß√£o para tokens ativos** (√© poss√≠vel obter novos tokens de atualiza√ß√£o a partir de um token de atualiza√ß√£o).
* Um token de atualiza√ß√£o deve estar vinculado a um **`aud`**, a alguns **escopos**, e a um **inquilino** e deve ser capaz de gerar tokens de acesso apenas para esse aud, escopos (e nada mais) e inquilino. No entanto, este n√£o √© o caso com **tokens de aplica√ß√µes FOCI**.
* Um token de atualiza√ß√£o √© criptografado e apenas a Microsoft pode descriptograf√°-lo.
* Obter um novo token de atualiza√ß√£o n√£o revoga o token de atualiza√ß√£o anterior.

{% hint style="warning" %}
Informa√ß√µes para **acesso condicional** s√£o **armazenadas** dentro do **JWT**. Portanto, se voc√™ solicitar o **token de um endere√ßo IP permitido**, esse **IP** ser√° **armazenado** no token e ent√£o voc√™ pode usar esse token de um **IP n√£o permitido para acessar os recursos**.
{% endhint %}

### Access Tokens "aud"

O campo indicado no campo "aud" √© o **servidor de recursos** (a aplica√ß√£o) usado para realizar o login.

O comando `az account get-access-token --resource-type [...]` suporta os seguintes tipos e cada um deles adicionar√° um "aud" espec√≠fico no token de acesso resultante:

{% hint style="danger" %}
Note que os seguintes s√£o apenas as APIs suportadas por `az account get-access-token`, mas h√° mais.
{% endhint %}

<details>

<summary>exemplos de aud</summary>

* **aad-graph (Azure Active Directory Graph API)**: Usado para acessar a API Graph do Azure AD legada (descontinuada), que permite que aplica√ß√µes leiam e escrevam dados de diret√≥rio no Azure Active Directory (Azure AD).
* `https://graph.windows.net/`

- **arm (Azure Resource Manager)**: Usado para gerenciar recursos do Azure atrav√©s da API do Azure Resource Manager. Isso inclui opera√ß√µes como criar, atualizar e excluir recursos como m√°quinas virtuais, contas de armazenamento e mais.
* `https://management.core.windows.net/ ou https://management.azure.com/`

* **batch (Azure Batch Services)**: Usado para acessar o Azure Batch, um servi√ßo que permite aplica√ß√µes de computa√ß√£o paralela em larga escala e de alto desempenho de forma eficiente na nuvem.
* `https://batch.core.windows.net/`

- **data-lake (Azure Data Lake Storage)**: Usado para interagir com o Azure Data Lake Storage Gen1, que √© um servi√ßo de armazenamento e an√°lise de dados escal√°vel.
* `https://datalake.azure.net/`

* **media (Azure Media Services)**: Usado para acessar os Servi√ßos de M√≠dia do Azure, que fornecem servi√ßos de processamento e entrega de m√≠dia baseados em nuvem para conte√∫do de v√≠deo e √°udio.
* `https://rest.media.azure.net`

- **ms-graph (Microsoft Graph API)**: Usado para acessar a API Microsoft Graph, o ponto de extremidade unificado para dados de servi√ßos do Microsoft 365. Permite acessar dados e insights de servi√ßos como Azure AD, Office 365, Mobilidade Empresarial e servi√ßos de Seguran√ßa.
* `https://graph.microsoft.com`

* **oss-rdbms (Azure Open Source Relational Databases)**: Usado para acessar servi√ßos de banco de dados do Azure para mecanismos de banco de dados relacionais de c√≥digo aberto como MySQL, PostgreSQL e MariaDB.
* `https://ossrdbms-aad.database.windows.net`

</details>

### Access Tokens Scopes "scp"

O escopo de um token de acesso √© armazenado dentro da chave scp dentro do JWT do token de acesso. Esses escopos definem a que o token de acesso tem acesso.

Se um JWT tiver permiss√£o para contatar uma API espec√≠fica, mas **n√£o tiver o escopo** para realizar a a√ß√£o solicitada, ele **n√£o poder√° realizar a a√ß√£o** com esse JWT.

### Get refresh & access token example
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"04b07795-8ddb-461a-bbee-02f9e1bf7b46" # ID for Azure CLI client
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)



# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
## Escala√ß√£o de Privil√©gios de Tokens FOCI

Anteriormente, foi mencionado que os tokens de atualiza√ß√£o devem estar vinculados aos **escopos** com os quais foram gerados, √† **aplica√ß√£o** e ao **inquilino** para os quais foram gerados. Se qualquer um desses limites for quebrado, √© poss√≠vel escalar privil√©gios, pois ser√° poss√≠vel gerar tokens de acesso para outros recursos e inquilinos aos quais o usu√°rio tem acesso e com mais escopos do que originalmente pretendido.

Al√©m disso, **isso √© poss√≠vel com todos os tokens de atualiza√ß√£o** na [plataforma de identidade da Microsoft](https://learn.microsoft.com/en-us/entra/identity-platform/) (contas Microsoft Entra, contas pessoais da Microsoft e contas sociais como Facebook e Google) porque, como mencionam os [**docs**](https://learn.microsoft.com/en-us/entra/identity-platform/refresh-tokens): "Os tokens de atualiza√ß√£o est√£o vinculados a uma combina√ß√£o de usu√°rio e cliente, mas **n√£o est√£o vinculados a um recurso ou inquilino**. Um cliente pode usar um token de atualiza√ß√£o para adquirir tokens de acesso **em qualquer combina√ß√£o de recurso e inquilino** onde tenha permiss√£o para faz√™-lo. Os tokens de atualiza√ß√£o s√£o criptografados e apenas a plataforma de identidade da Microsoft pode l√™-los."

Al√©m disso, observe que as aplica√ß√µes FOCI s√£o aplica√ß√µes p√∫blicas, portanto **nenhum segredo √© necess√°rio** para autenticar no servidor.

Ent√£o, os clientes FOCI conhecidos relatados na [**pesquisa original**](https://github.com/secureworks/family-of-client-ids-research/tree/main) podem ser [**encontrados aqui**](https://github.com/secureworks/family-of-client-ids-research/blob/main/known-foci-clients.csv).

### Obter escopo diferente

Seguindo com o c√≥digo de exemplo anterior, neste c√≥digo √© solicitado um novo token para um escopo diferente:
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### Obter diferentes clientes e escopos
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## Refer√™ncias

* [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
