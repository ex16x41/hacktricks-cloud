# Az - Tokens & Public Applications

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundinformationen

Entra ID ist die cloudbasierte Identit√§ts- und Zugriffsmanagement (IAM) Plattform von Microsoft, die als grundlegendes Authentifizierungs- und Autorisierungssystem f√ºr Dienste wie Microsoft 365 und Azure Resource Manager dient. Azure AD implementiert das OAuth 2.0 Autorisierungsframework und das OpenID Connect (OIDC) Authentifizierungsprotokoll zur Verwaltung des Zugriffs auf Ressourcen.

### OAuth

**Wichtige Teilnehmer in OAuth 2.0:**

1. **Ressourcenserver (RS):** Sch√ºtzt Ressourcen, die dem Ressourcenbesitzer geh√∂ren.
2. **Ressourcenbesitzer (RO):** Typischerweise ein Endbenutzer, der die gesch√ºtzten Ressourcen besitzt.
3. **Client-Anwendung (CA):** Eine Anwendung, die im Namen des Ressourcenbesitzers Zugriff auf Ressourcen anfordert.
4. **Autorisierungsserver (AS):** Gibt Zugriffstoken an Client-Anwendungen aus, nachdem diese authentifiziert und autorisiert wurden.

**Scopes und Zustimmung:**

* **Scopes:** Granulare Berechtigungen, die auf dem Ressourcenserver definiert sind und Zugriffslevel spezifizieren.
* **Zustimmung:** Der Prozess, durch den ein Ressourcenbesitzer einer Client-Anwendung die Erlaubnis erteilt, auf Ressourcen mit bestimmten Scopes zuzugreifen.

**Microsoft 365 Integration:**

* Microsoft 365 nutzt Azure AD f√ºr IAM und besteht aus mehreren "First-Party" OAuth-Anwendungen.
* Diese Anwendungen sind tief integriert und haben oft voneinander abh√§ngige Dienstbeziehungen.
* Um die Benutzererfahrung zu vereinfachen und die Funktionalit√§t aufrechtzuerhalten, gew√§hrt Microsoft diesen First-Party-Anwendungen "implizite Zustimmung" oder "Vorab-Zustimmung".
* **Implizite Zustimmung:** Bestimmte Anwendungen erhalten automatisch **Zugriff auf spezifische Scopes ohne ausdr√ºckliche Genehmigung des Benutzers oder Administrators**.
* Diese vorab genehmigten Scopes sind typischerweise sowohl f√ºr Benutzer als auch f√ºr Administratoren verborgen, was sie in den Standardverwaltungsoberfl√§chen weniger sichtbar macht.

**Typen von Client-Anwendungen:**

1. **Vertrauliche Clients:**
* Besitzen eigene Anmeldeinformationen (z. B. Passw√∂rter oder Zertifikate).
* K√∂nnen sich **sicher beim Autorisierungsserver authentifizieren**.
2. **√ñffentliche Clients:**
* Haben keine einzigartigen Anmeldeinformationen.
* K√∂nnen sich nicht sicher beim Autorisierungsserver authentifizieren.
* **Sicherheitsimplikation:** Ein Angreifer kann eine √∂ffentliche Client-Anwendung nachahmen, wenn er Tokens anfordert, da es keinen Mechanismus gibt, mit dem der Autorisierungsserver die Legitimit√§t der Anwendung √ºberpr√ºfen kann.

## Authentifizierungstoken

Es gibt **drei Arten von Tokens**, die in OIDC verwendet werden:

* [**Zugriffstoken**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Der Client pr√§sentiert dieses Token dem Ressourcenserver, um **auf Ressourcen zuzugreifen**. Es kann nur f√ºr eine spezifische Kombination aus Benutzer, Client und Ressource verwendet werden und **kann nicht widerrufen** werden, bis es abl√§uft - das ist standardm√§√üig 1 Stunde.
* **ID-Tokens**: Der Client erh√§lt dieses **Token vom Autorisierungsserver**. Es enth√§lt grundlegende Informationen √ºber den Benutzer. Es ist **an eine spezifische Kombination aus Benutzer und Client gebunden**.
* **Aktualisierungstoken**: Werden dem Client mit dem Zugriffstoken bereitgestellt. Wird verwendet, um **neue Zugriffs- und ID-Tokens zu erhalten**. Es ist an eine spezifische Kombination aus Benutzer und Client gebunden und kann widerrufen werden. Die Standardablaufzeit betr√§gt **90 Tage** f√ºr inaktive Aktualisierungstoken und **keine Ablaufzeit f√ºr aktive Tokens** (es ist m√∂glich, aus einem Aktualisierungstoken neue Aktualisierungstoken zu erhalten).
* Ein Aktualisierungstoken sollte an ein **`aud`**, an einige **Scopes** und an einen **Mandanten** gebunden sein und sollte nur in der Lage sein, Zugriffstoken f√ºr dieses aud, diese Scopes (und nicht mehr) und diesen Mandanten zu generieren. Dies ist jedoch nicht der Fall bei **FOCI-Anwendungstoken**.
* Ein Aktualisierungstoken ist verschl√ºsselt und nur Microsoft kann es entschl√ºsseln.
* Das Erhalten eines neuen Aktualisierungstokens widerruft das vorherige Aktualisierungstoken nicht.

{% hint style="warning" %}
Informationen f√ºr **bedingten Zugriff** sind **innerhalb des JWT gespeichert**. Wenn du also das **Token von einer erlaubten IP-Adresse anforderst**, wird diese **IP** im Token **gespeichert** und du kannst dieses Token von einer **nicht erlaubten IP verwenden, um auf die Ressourcen zuzugreifen**.
{% endhint %}

### Zugriffstoken "aud"

Das im "aud"-Feld angegebene Feld ist der **Ressourcenserver** (die Anwendung), die zum Anmelden verwendet wird.

Der Befehl `az account get-access-token --resource-type [...]` unterst√ºtzt die folgenden Typen, und jeder von ihnen wird ein spezifisches "aud" im resultierenden Zugriffstoken hinzuf√ºgen:

{% hint style="danger" %}
Beachte, dass die folgenden nur die von `az account get-access-token` unterst√ºtzten APIs sind, es gibt jedoch mehr.
{% endhint %}

<details>

<summary>aud Beispiele</summary>

* **aad-graph (Azure Active Directory Graph API)**: Wird verwendet, um auf die veraltete Azure AD Graph API (abgek√ºndigt) zuzugreifen, die Anwendungen das Lesen und Schreiben von Verzeichnisdaten in Azure Active Directory (Azure AD) erm√∂glicht.
* `https://graph.windows.net/`

- **arm (Azure Resource Manager)**: Wird verwendet, um Azure-Ressourcen √ºber die Azure Resource Manager API zu verwalten. Dazu geh√∂ren Operationen wie das Erstellen, Aktualisieren und L√∂schen von Ressourcen wie virtuellen Maschinen, Speicherkonten und mehr.
* `https://management.core.windows.net/ oder https://management.azure.com/`

* **batch (Azure Batch Services)**: Wird verwendet, um auf Azure Batch zuzugreifen, einen Dienst, der gro√ü angelegte parallele und hochleistungsf√§hige Rechenanwendungen effizient in der Cloud erm√∂glicht.
* `https://batch.core.windows.net/`

- **data-lake (Azure Data Lake Storage)**: Wird verwendet, um mit Azure Data Lake Storage Gen1 zu interagieren, einem skalierbaren Datenlager- und Analysedienst.
* `https://datalake.azure.net/`

* **media (Azure Media Services)**: Wird verwendet, um auf Azure Media Services zuzugreifen, die cloudbasierte Medienverarbeitungs- und Bereitstellungsdienste f√ºr Video- und Audioinhalte bereitstellen.
* `https://rest.media.azure.net`

- **ms-graph (Microsoft Graph API)**: Wird verwendet, um auf die Microsoft Graph API zuzugreifen, den einheitlichen Endpunkt f√ºr Microsoft 365-Daten. Es erm√∂glicht den Zugriff auf Daten und Einblicke aus Diensten wie Azure AD, Office 365, Enterprise Mobility und Sicherheitsdiensten.
* `https://graph.microsoft.com`

* **oss-rdbms (Azure Open Source Relational Databases)**: Wird verwendet, um auf Azure-Datenbankdienste f√ºr Open-Source-Relationale Datenbank-Engines wie MySQL, PostgreSQL und MariaDB zuzugreifen.
* `https://ossrdbms-aad.database.windows.net`

</details>

### Zugriffstoken Scopes "scp"

Der Scope eines Zugriffstokens wird im scp-Schl√ºssel innerhalb des Zugriffstoken-JWT gespeichert. Diese Scopes definieren, auf was das Zugriffstoken Zugriff hat.

Wenn ein JWT berechtigt ist, eine bestimmte API zu kontaktieren, aber **nicht den Scope** hat, um die angeforderte Aktion auszuf√ºhren, **wird es nicht in der Lage sein, die Aktion** mit diesem JWT auszuf√ºhren.

### Beispiel zum Abrufen von Aktualisierungs- und Zugriffstoken
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"04b07795-8ddb-461a-bbee-02f9e1bf7b46" # ID for Azure CLI client
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)



# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
## FOCI Tokens Privilegieneskalation

Zuvor wurde erw√§hnt, dass Refresh-Tokens an die **Scopes** gebunden sein sollten, mit denen sie generiert wurden, an die **Anwendung** und den **Mandanten**, f√ºr die sie generiert wurden. Wenn eine dieser Grenzen √ºberschritten wird, ist es m√∂glich, Privilegien zu eskalieren, da es m√∂glich sein wird, Zugriffstokens f√ºr andere Ressourcen und Mandanten zu generieren, auf die der Benutzer Zugriff hat, und mit mehr Scopes, als urspr√ºnglich vorgesehen.

Dar√ºber hinaus **ist dies mit allen Refresh-Tokens** in der [Microsoft-Identit√§tsplattform](https://learn.microsoft.com/en-us/entra/identity-platform/) (Microsoft Entra-Konten, Microsoft-Pers√∂nliche Konten und soziale Konten wie Facebook und Google) m√∂glich, da die [**Dokumentation**](https://learn.microsoft.com/en-us/entra/identity-platform/refresh-tokens) erw√§hnt: "Refresh-Tokens sind an eine Kombination aus Benutzer und Client gebunden, aber **nicht an eine Ressource oder einen Mandanten gebunden**. Ein Client kann ein Refresh-Token verwenden, um Zugriffstokens **√ºber jede Kombination von Ressource und Mandant** zu erwerben, f√ºr die er die Berechtigung hat. Refresh-Tokens sind verschl√ºsselt und nur die Microsoft-Identit√§tsplattform kann sie lesen."

Dar√ºber hinaus beachten Sie, dass die FOCI-Anwendungen √∂ffentliche Anwendungen sind, sodass **kein Geheimnis erforderlich ist**, um sich beim Server zu authentifizieren.

Dann bekannte FOCI-Clients, die in der [**urspr√ºnglichen Forschung**](https://github.com/secureworks/family-of-client-ids-research/tree/main) gemeldet wurden, k√∂nnen [**hier gefunden werden**](https://github.com/secureworks/family-of-client-ids-research/blob/main/known-foci-clients.csv).

### Anderen Scope erhalten

Folgend mit dem vorherigen Beispielcode wird in diesem Code ein neues Token f√ºr einen anderen Scope angefordert:
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### Verschiedene Clients und Scopes abrufen
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## Referenzen

* [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
