# Az - Tokenlar & Kamu UygulamalarÄ±

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

Entra ID, Microsoft'un bulut tabanlÄ± kimlik ve eriÅŸim yÃ¶netimi (IAM) platformudur ve Microsoft 365 ve Azure Resource Manager gibi hizmetler iÃ§in temel kimlik doÄŸrulama ve yetkilendirme sistemi olarak hizmet vermektedir. Azure AD, kaynaklara eriÅŸimi yÃ¶netmek iÃ§in OAuth 2.0 yetkilendirme Ã§erÃ§evesini ve OpenID Connect (OIDC) kimlik doÄŸrulama protokolÃ¼nÃ¼ uygular.

### OAuth

**OAuth 2.0'da Anahtar KatÄ±lÄ±mcÄ±lar:**

1. **Kaynak Sunucusu (RS):** Kaynak sahibine ait kaynaklarÄ± korur.
2. **Kaynak Sahibi (RO):** Genellikle korunan kaynaklara sahip olan son kullanÄ±cÄ±dÄ±r.
3. **Ä°stemci UygulamasÄ± (CA):** Kaynak sahibinin adÄ±na kaynaklara eriÅŸim talep eden bir uygulamadÄ±r.
4. **Yetkilendirme Sunucusu (AS):** Ä°stemci uygulamalarÄ±na eriÅŸim tokenlarÄ± verir, bunlarÄ± kimlik doÄŸrulama ve yetkilendirme iÅŸlemlerinden sonra.

**Kapsamlar ve Onay:**

* **Kapsamlar:** EriÅŸim seviyelerini belirten, kaynak sunucusunda tanÄ±mlanan ayrÄ±ntÄ±lÄ± izinlerdir.
* **Onay:** Bir kaynak sahibinin, belirli kapsamlarla kaynaklara eriÅŸim izni verdiÄŸi sÃ¼reÃ§tir.

**Microsoft 365 Entegrasyonu:**

* Microsoft 365, IAM iÃ§in Azure AD'yi kullanÄ±r ve birden fazla "birinci taraf" OAuth uygulamasÄ±ndan oluÅŸur.
* Bu uygulamalar derinlemesine entegre edilmiÅŸtir ve genellikle karÅŸÄ±lÄ±klÄ± hizmet iliÅŸkilerine sahiptir.
* KullanÄ±cÄ± deneyimini basitleÅŸtirmek ve iÅŸlevselliÄŸi korumak iÃ§in Microsoft, bu birinci taraf uygulamalarÄ±na "ima edilen onay" veya "Ã¶n onay" verir.
* **Ä°ma Edilen Onay:** Belirli uygulamalar, aÃ§Ä±k kullanÄ±cÄ± veya yÃ¶netici onayÄ± olmadan **belirli kapsamlar iÃ§in otomatik olarak eriÅŸim izni alÄ±r**.
* Bu Ã¶n onaylÄ± kapsamlar genellikle hem kullanÄ±cÄ±lar hem de yÃ¶neticiler iÃ§in gizlidir, bu da standart yÃ¶netim arayÃ¼zlerinde daha az gÃ¶rÃ¼nÃ¼r hale getirir.

**Ä°stemci Uygulama TÃ¼rleri:**

1. **Gizli Ä°stemciler:**
* Kendi kimlik bilgilerine (Ã¶rneÄŸin, ÅŸifreler veya sertifikalar) sahiptir.
* Yetkilendirme sunucusuna **gÃ¼venli bir ÅŸekilde kimlik doÄŸrulamasÄ± yapabilirler**.
2. **AÃ§Ä±k Ä°stemciler:**
* Benzersiz kimlik bilgilerine sahip deÄŸildir.
* Yetkilendirme sunucusuna gÃ¼venli bir ÅŸekilde kimlik doÄŸrulamasÄ± yapamazlar.
* **GÃ¼venlik Etkisi:** Bir saldÄ±rgan, token talep ederken bir aÃ§Ä±k istemci uygulamasÄ±nÄ± taklit edebilir, Ã§Ã¼nkÃ¼ yetkilendirme sunucusunun uygulamanÄ±n meÅŸruiyetini doÄŸrulamak iÃ§in bir mekanizmasÄ± yoktur.

## Kimlik DoÄŸrulama TokenlarÄ±

OIDC'de kullanÄ±lan **Ã¼Ã§ tÃ¼r token** vardÄ±r:

* [**EriÅŸim TokenlarÄ±**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Ä°stemci, bu tokenÄ± kaynak sunucusuna **kaynaklara eriÅŸim** iÃ§in sunar. Sadece belirli bir kullanÄ±cÄ±, istemci ve kaynak kombinasyonu iÃ§in kullanÄ±labilir ve **iptal edilemez**; sÃ¼resi dolana kadar - bu varsayÄ±lan olarak 1 saattir.
* **ID TokenlarÄ±**: Ä°stemci, bu **tokenÄ± yetkilendirme sunucusundan** alÄ±r. KullanÄ±cÄ± hakkÄ±nda temel bilgileri iÃ§erir. **Belirli bir kullanÄ±cÄ± ve istemci kombinasyonuna baÄŸlÄ±dÄ±r**.
* **Yenileme TokenlarÄ±**: EriÅŸim tokenÄ± ile birlikte istemciye verilir. **Yeni eriÅŸim ve ID tokenlarÄ± almak iÃ§in** kullanÄ±lÄ±r. Belirli bir kullanÄ±cÄ± ve istemci kombinasyonuna baÄŸlÄ±dÄ±r ve iptal edilebilir. VarsayÄ±lan sÃ¼resi, **hareketsiz yenileme tokenlarÄ± iÃ§in 90 gÃ¼ndÃ¼r** ve **aktif tokenlar iÃ§in sÃ¼resi yoktur** (bir yenileme tokenÄ±ndan yeni yenileme tokenlarÄ± almak mÃ¼mkÃ¼ndÃ¼r).
* Bir yenileme tokenÄ±, bir **`aud`** ile, bazÄ± **kapsamlarla** ve bir **kiracÄ±yla** iliÅŸkilendirilmelidir ve yalnÄ±zca o aud, kapsamlar (ve daha fazlasÄ± deÄŸil) ve kiracÄ± iÃ§in eriÅŸim tokenlarÄ± Ã¼retebilmelidir. Ancak, bu **FOCI uygulama tokenlarÄ±** iÃ§in geÃ§erli deÄŸildir.
* Bir yenileme tokenÄ± ÅŸifrelenmiÅŸtir ve yalnÄ±zca Microsoft bunu Ã§Ã¶zebilir.
* Yeni bir yenileme tokenÄ± almak, Ã¶nceki yenileme tokenÄ±nÄ± iptal etmez.

{% hint style="warning" %}
**KoÅŸullu eriÅŸim** bilgileri **JWT** iÃ§inde **saklanÄ±r**. Yani, **izin verilen bir IP adresinden token talep ederseniz**, o **IP** token iÃ§inde **saklanÄ±r** ve ardÄ±ndan o tokenÄ± **izin verilmeyen bir IP'den kaynaklara eriÅŸmek iÃ§in** kullanabilirsiniz.
{% endhint %}

### EriÅŸim TokenlarÄ± "aud"

"aud" alanÄ±nda belirtilen alan, **giriÅŸ yapmak iÃ§in kullanÄ±lan kaynak sunucusudur** (uygulama).

`az account get-access-token --resource-type [...]` komutu, aÅŸaÄŸÄ±daki tÃ¼rleri destekler ve her biri sonuÃ§lanan eriÅŸim tokenÄ±nda belirli bir "aud" ekleyecektir:

{% hint style="danger" %}
AÅŸaÄŸÄ±dakilerin yalnÄ±zca `az account get-access-token` tarafÄ±ndan desteklenen API'ler olduÄŸunu unutmayÄ±n, ancak daha fazlasÄ± vardÄ±r.
{% endhint %}

<details>

<summary>aud Ã¶rnekleri</summary>

* **aad-graph (Azure Active Directory Graph API)**: UygulamalarÄ±n Azure Active Directory (Azure AD) iÃ§indeki dizin verilerini okumasÄ±na ve yazmasÄ±na olanak tanÄ±yan eski Azure AD Graph API'ye (kaldÄ±rÄ±lmÄ±ÅŸ) eriÅŸmek iÃ§in kullanÄ±lÄ±r.
* `https://graph.windows.net/`

- **arm (Azure Resource Manager)**: Azure kaynaklarÄ±nÄ± Azure Resource Manager API'si aracÄ±lÄ±ÄŸÄ±yla yÃ¶netmek iÃ§in kullanÄ±lÄ±r. Bu, sanal makineler, depolama hesaplarÄ± ve daha fazlasÄ± gibi kaynaklarÄ± oluÅŸturma, gÃ¼ncelleme ve silme gibi iÅŸlemleri iÃ§erir.
* `https://management.core.windows.net/ or https://management.azure.com/`

* **batch (Azure Batch Services)**: Bulutta bÃ¼yÃ¼k Ã¶lÃ§ekli paralel ve yÃ¼ksek performanslÄ± hesaplama uygulamalarÄ±nÄ± verimli bir ÅŸekilde etkinleÅŸtiren Azure Batch'e eriÅŸmek iÃ§in kullanÄ±lÄ±r.
* `https://batch.core.windows.net/`

- **data-lake (Azure Data Lake Storage)**: Azure Data Lake Storage Gen1 ile etkileÅŸimde bulunmak iÃ§in kullanÄ±lÄ±r; bu, Ã¶lÃ§eklenebilir bir veri depolama ve analiz hizmetidir.
* `https://datalake.azure.net/`

* **media (Azure Media Services)**: Video ve ses iÃ§eriÄŸi iÃ§in bulut tabanlÄ± medya iÅŸleme ve daÄŸÄ±tÄ±m hizmetleri saÄŸlayan Azure Media Services'e eriÅŸmek iÃ§in kullanÄ±lÄ±r.
* `https://rest.media.azure.net`

- **ms-graph (Microsoft Graph API)**: Microsoft 365 hizmetleri verilerine eriÅŸmek iÃ§in kullanÄ±lan Microsoft Graph API'ye eriÅŸmek iÃ§in kullanÄ±lÄ±r. Azure AD, Office 365, Kurumsal Mobilite ve GÃ¼venlik hizmetleri gibi hizmetlerden veri ve iÃ§gÃ¶rÃ¼lere eriÅŸmenizi saÄŸlar.
* `https://graph.microsoft.com`

* **oss-rdbms (Azure AÃ§Ä±k Kaynak Ä°liÅŸkisel VeritabanlarÄ±)**: MySQL, PostgreSQL ve MariaDB gibi aÃ§Ä±k kaynak iliÅŸkisel veritabanÄ± motorlarÄ± iÃ§in Azure VeritabanÄ± hizmetlerine eriÅŸmek iÃ§in kullanÄ±lÄ±r.
* `https://ossrdbms-aad.database.windows.net`

</details>

### EriÅŸim TokenlarÄ± KapsamlarÄ± "scp"

Bir eriÅŸim tokenÄ±nÄ±n kapsamÄ±, eriÅŸim tokenÄ± JWT'si iÃ§indeki scp anahtarÄ±nda saklanÄ±r. Bu kapsamlar, eriÅŸim tokenÄ±nÄ±n eriÅŸim saÄŸladÄ±ÄŸÄ± alanlarÄ± tanÄ±mlar.

EÄŸer bir JWT belirli bir API ile iletiÅŸim kurmasÄ±na izin verilirse ancak **istenen eylemi gerÃ§ekleÅŸtirmek iÃ§in kapsamÄ± yoksa**, o **eylemi gerÃ§ekleÅŸtiremeyecektir**. 

### Yenileme ve eriÅŸim tokenÄ± alma Ã¶rneÄŸi
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"04b07795-8ddb-461a-bbee-02f9e1bf7b46" # ID for Azure CLI client
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)



# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
## FOCI TokenlarÄ± Yetki YÃ¼kseltme

Daha Ã¶nce, yenileme tokenlarÄ±nÄ±n oluÅŸturulduÄŸu **kapsamlar**, **uygulama** ve **kiracÄ±** ile iliÅŸkilendirilmesi gerektiÄŸi belirtilmiÅŸti. Bu sÄ±nÄ±rlardan herhangi biri ihlal edilirse, kullanÄ±cÄ±nÄ±n eriÅŸim saÄŸladÄ±ÄŸÄ± diÄŸer kaynaklar ve kiracÄ±lar iÃ§in eriÅŸim tokenlarÄ± oluÅŸturmak mÃ¼mkÃ¼n olacaÄŸÄ±ndan yetki yÃ¼kseltmek mÃ¼mkÃ¼ndÃ¼r ve bu, baÅŸlangÄ±Ã§ta amaÃ§landÄ±ÄŸÄ±ndan daha fazla kapsam ile yapÄ±labilir.

AyrÄ±ca, **bu, [Microsoft kimlik platformu](https://learn.microsoft.com/en-us/entra/identity-platform/) (Microsoft Entra hesaplarÄ±, Microsoft kiÅŸisel hesaplarÄ± ve Facebook ve Google gibi sosyal hesaplar) ile tÃ¼m yenileme tokenlarÄ± iÃ§in mÃ¼mkÃ¼ndÃ¼r** Ã§Ã¼nkÃ¼ [**belgelerde**](https://learn.microsoft.com/en-us/entra/identity-platform/refresh-tokens) belirtildiÄŸi gibi: "Yenileme tokenlarÄ±, kullanÄ±cÄ± ve istemci kombinasyonuna baÄŸlÄ±dÄ±r, ancak **bir kaynak veya kiracÄ±ya baÄŸlÄ± deÄŸildir**. Bir istemci, izin verildiÄŸi herhangi bir kaynak ve kiracÄ± kombinasyonu Ã¼zerinden eriÅŸim tokenlarÄ± almak iÃ§in bir yenileme tokenÄ± kullanabilir. Yenileme tokenlarÄ± ÅŸifrelenmiÅŸtir ve yalnÄ±zca Microsoft kimlik platformu bunlarÄ± okuyabilir."

AyrÄ±ca, FOCI uygulamalarÄ±nÄ±n kamuya aÃ§Ä±k uygulamalar olduÄŸunu ve bu nedenle sunucuya kimlik doÄŸrulamak iÃ§in **hiÃ§bir sÄ±r gerekmediÄŸini** unutmayÄ±n.

Daha sonra, [**orijinal araÅŸtÄ±rmada**](https://github.com/secureworks/family-of-client-ids-research/tree/main) bildirilen bilinen FOCI istemcileri [**burada**](https://github.com/secureworks/family-of-client-ids-research/blob/main/known-foci-clients.csv) bulunabilir.

### FarklÄ± kapsam al

Ã–nceki Ã¶rnek koduna devam ederek, bu kodda farklÄ± bir kapsam iÃ§in yeni bir token talep edilmektedir:
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### FarklÄ± istemci ve kapsamlar al
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## Referanslar

* [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
