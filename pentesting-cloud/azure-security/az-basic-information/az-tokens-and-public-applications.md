# Az - Tokens & Public Applications

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Entra IDëŠ” Microsoftì˜ í´ë¼ìš°ë“œ ê¸°ë°˜ ì•„ì´ë´í‹°í‹° ë° ì•¡ì„¸ìŠ¤ ê´€ë¦¬(IAM) í”Œë«í¼ìœ¼ë¡œ, Microsoft 365 ë° Azure Resource Managerì™€ ê°™ì€ ì„œë¹„ìŠ¤ì˜ ê¸°ë³¸ ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ ì‹œìŠ¤í…œ ì—­í• ì„ í•©ë‹ˆë‹¤. Azure ADëŠ” OAuth 2.0 ê¶Œí•œ ë¶€ì—¬ í”„ë ˆì„ì›Œí¬ì™€ OpenID Connect (OIDC) ì¸ì¦ í”„ë¡œí† ì½œì„ êµ¬í˜„í•˜ì—¬ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

### OAuth

**OAuth 2.0ì˜ ì£¼ìš” ì°¸ì—¬ì:**

1. **ë¦¬ì†ŒìŠ¤ ì„œë²„ (RS):** ë¦¬ì†ŒìŠ¤ ì†Œìœ ìê°€ ì†Œìœ í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ë³´í˜¸í•©ë‹ˆë‹¤.
2. **ë¦¬ì†ŒìŠ¤ ì†Œìœ ì (RO):** ì¼ë°˜ì ìœ¼ë¡œ ë³´í˜¸ëœ ë¦¬ì†ŒìŠ¤ë¥¼ ì†Œìœ í•œ ìµœì¢… ì‚¬ìš©ìì…ë‹ˆë‹¤.
3. **í´ë¼ì´ì–¸íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ (CA):** ë¦¬ì†ŒìŠ¤ ì†Œìœ ìë¥¼ ëŒ€ì‹ í•˜ì—¬ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ìš”ì²­í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤.
4. **ê¶Œí•œ ë¶€ì—¬ ì„œë²„ (AS):** í´ë¼ì´ì–¸íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¸ì¦í•˜ê³  ê¶Œí•œì„ ë¶€ì—¬í•œ í›„ ì•¡ì„¸ìŠ¤ í† í°ì„ ë°œê¸‰í•©ë‹ˆë‹¤.

**ë²”ìœ„ ë° ë™ì˜:**

* **ë²”ìœ„:** ì•¡ì„¸ìŠ¤ ìˆ˜ì¤€ì„ ì§€ì •í•˜ëŠ” ë¦¬ì†ŒìŠ¤ ì„œë²„ì—ì„œ ì •ì˜ëœ ì„¸ë¶„í™”ëœ ê¶Œí•œì…ë‹ˆë‹¤.
* **ë™ì˜:** ë¦¬ì†ŒìŠ¤ ì†Œìœ ìê°€ íŠ¹ì • ë²”ìœ„ë¡œ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í´ë¼ì´ì–¸íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤.

**Microsoft 365 í†µí•©:**

* Microsoft 365ëŠ” IAMì„ ìœ„í•´ Azure ADë¥¼ ì‚¬ìš©í•˜ë©° ì—¬ëŸ¬ ê°œì˜ "1ì°¨" OAuth ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.
* ì´ëŸ¬í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ê¹Šì´ í†µí•©ë˜ì–´ ìˆìœ¼ë©° ì¢…ì¢… ìƒí˜¸ ì˜ì¡´ì ì¸ ì„œë¹„ìŠ¤ ê´€ê³„ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
* ì‚¬ìš©ì ê²½í—˜ì„ ë‹¨ìˆœí™”í•˜ê³  ê¸°ëŠ¥ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ MicrosoftëŠ” ì´ëŸ¬í•œ 1ì°¨ ì• í”Œë¦¬ì¼€ì´ì…˜ì— "ì•”ë¬µì  ë™ì˜" ë˜ëŠ” "ì‚¬ì „ ë™ì˜"ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
* **ì•”ë¬µì  ë™ì˜:** íŠ¹ì • ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ëª…ì‹œì ì¸ ì‚¬ìš©ì ë˜ëŠ” ê´€ë¦¬ì ìŠ¹ì¸ ì—†ì´ íŠ¹ì • ë²”ìœ„ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ìë™ìœ¼ë¡œ **ë¶€ì—¬ë°›ìŠµë‹ˆë‹¤**.
* ì´ëŸ¬í•œ ì‚¬ì „ ë™ì˜ëœ ë²”ìœ„ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ìì™€ ê´€ë¦¬ì ëª¨ë‘ì—ê²Œ ìˆ¨ê²¨ì ¸ ìˆì–´ í‘œì¤€ ê´€ë¦¬ ì¸í„°í˜ì´ìŠ¤ì—ì„œ ëœ ë³´ì…ë‹ˆë‹¤.

**í´ë¼ì´ì–¸íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ìœ í˜•:**

1. **ê¸°ë°€ í´ë¼ì´ì–¸íŠ¸:**
* ìì²´ ìê²© ì¦ëª…(ì˜ˆ: ë¹„ë°€ë²ˆí˜¸ ë˜ëŠ” ì¸ì¦ì„œ)ì„ ë³´ìœ í•©ë‹ˆë‹¤.
* ê¶Œí•œ ë¶€ì—¬ ì„œë²„ì— **ì•ˆì „í•˜ê²Œ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.
2. **ê³µê°œ í´ë¼ì´ì–¸íŠ¸:**
* ê³ ìœ í•œ ìê²© ì¦ëª…ì´ ì—†ìŠµë‹ˆë‹¤.
* ê¶Œí•œ ë¶€ì—¬ ì„œë²„ì— ì•ˆì „í•˜ê²Œ ì¸ì¦í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
* **ë³´ì•ˆ ì˜ë¯¸:** ê³µê²©ìëŠ” í† í°ì„ ìš”ì²­í•  ë•Œ ê³µê°œ í´ë¼ì´ì–¸íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê°€ì¥í•  ìˆ˜ ìˆìœ¼ë©°, ê¶Œí•œ ë¶€ì—¬ ì„œë²„ê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì •ë‹¹ì„±ì„ í™•ì¸í•  ìˆ˜ ìˆëŠ” ë©”ì»¤ë‹ˆì¦˜ì´ ì—†ìŠµë‹ˆë‹¤.

## Authentication Tokens

OIDCì—ì„œ ì‚¬ìš©ë˜ëŠ” **ì„¸ ê°€ì§€ ìœ í˜•ì˜ í† í°**ì´ ìˆìŠµë‹ˆë‹¤:

* [**ì•¡ì„¸ìŠ¤ í† í°**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** í´ë¼ì´ì–¸íŠ¸ê°€ ë¦¬ì†ŒìŠ¤ ì„œë²„ì— ì´ í† í°ì„ ì œì‹œí•˜ì—¬ **ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼**í•©ë‹ˆë‹¤. íŠ¹ì • ì‚¬ìš©ì, í´ë¼ì´ì–¸íŠ¸ ë° ë¦¬ì†ŒìŠ¤ì˜ ì¡°í•©ì— ëŒ€í•´ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©° **ë§Œë£Œë  ë•Œê¹Œì§€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤** - ê¸°ë³¸ì ìœ¼ë¡œ 1ì‹œê°„ì…ë‹ˆë‹¤.
* **ID í† í°**: í´ë¼ì´ì–¸íŠ¸ê°€ **ê¶Œí•œ ë¶€ì—¬ ì„œë²„ë¡œë¶€í„° ì´ í† í°ì„ ë°›ìŠµë‹ˆë‹¤**. ì‚¬ìš©ìì— ëŒ€í•œ ê¸°ë³¸ ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. íŠ¹ì • ì‚¬ìš©ìì™€ í´ë¼ì´ì–¸íŠ¸ì˜ ì¡°í•©ì— **ë°”ì¸ë”©ë˜ì–´ ìˆìŠµë‹ˆë‹¤**.
* **ë¦¬í”„ë ˆì‹œ í† í°**: ì•¡ì„¸ìŠ¤ í† í°ê³¼ í•¨ê»˜ í´ë¼ì´ì–¸íŠ¸ì— ì œê³µë©ë‹ˆë‹¤. **ìƒˆ ì•¡ì„¸ìŠ¤ ë° ID í† í°ì„ ì–»ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤**. íŠ¹ì • ì‚¬ìš©ìì™€ í´ë¼ì´ì–¸íŠ¸ì˜ ì¡°í•©ì— ë°”ì¸ë”©ë˜ì–´ ìˆìœ¼ë©° ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ë§Œë£ŒëŠ” ë¹„í™œì„± ë¦¬í”„ë ˆì‹œ í† í°ì˜ ê²½ìš° **90ì¼**ì´ë©° í™œì„± í† í°ì˜ ê²½ìš° **ë§Œë£Œê°€ ì—†ìŠµë‹ˆë‹¤** (ë¦¬í”„ë ˆì‹œ í† í°ì—ì„œ ìƒˆ ë¦¬í”„ë ˆì‹œ í† í°ì„ ì–»ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤).
* ë¦¬í”„ë ˆì‹œ í† í°ì€ **`aud`**, ì¼ë¶€ **ë²”ìœ„**, ë° **í…Œë„ŒíŠ¸**ì— ì—°ê²°ë˜ì–´ì•¼ í•˜ë©°, í•´ë‹¹ aud, ë²”ìœ„(ê·¸ë¦¬ê³  ê·¸ ì´ìƒ) ë° í…Œë„ŒíŠ¸ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ í† í°ë§Œ ìƒì„±í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **FOCI ì• í”Œë¦¬ì¼€ì´ì…˜ í† í°**ì˜ ê²½ìš° ì´ëŠ” í•´ë‹¹ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
* ë¦¬í”„ë ˆì‹œ í† í°ì€ ì•”í˜¸í™”ë˜ì–´ ìˆìœ¼ë©° Microsoftë§Œ ì´ë¥¼ ë³µí˜¸í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ìƒˆ ë¦¬í”„ë ˆì‹œ í† í°ì„ ì–»ëŠ” ê²ƒì€ ì´ì „ ë¦¬í”„ë ˆì‹œ í† í°ì„ ì·¨ì†Œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

{% hint style="warning" %}
**ì¡°ê±´ë¶€ ì•¡ì„¸ìŠ¤**ì— ëŒ€í•œ ì •ë³´ëŠ” **JWT** ë‚´ë¶€ì— **ì €ì¥ë©ë‹ˆë‹¤**. ë”°ë¼ì„œ **í—ˆìš©ëœ IP ì£¼ì†Œ**ì—ì„œ **í† í°ì„ ìš”ì²­**í•˜ë©´ í•´ë‹¹ **IP**ê°€ í† í°ì— **ì €ì¥ë˜ë©°**, ì´í›„ **í—ˆìš©ë˜ì§€ ì•Šì€ IPì—ì„œ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´** í•´ë‹¹ í† í°ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### Access Tokens "aud"

"aud" í•„ë“œì— í‘œì‹œëœ í•„ë“œëŠ” **ë¦¬ì†ŒìŠ¤ ì„œë²„**(ì• í”Œë¦¬ì¼€ì´ì…˜)ë¡œ, ë¡œê·¸ì¸ ìˆ˜í–‰ì— ì‚¬ìš©ë©ë‹ˆë‹¤.

ëª…ë ¹ì–´ `az account get-access-token --resource-type [...]`ëŠ” ë‹¤ìŒ ìœ í˜•ì„ ì§€ì›í•˜ë©°, ê° ìœ í˜•ì€ ê²°ê³¼ ì•¡ì„¸ìŠ¤ í† í°ì— íŠ¹ì • "aud"ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤:

{% hint style="danger" %}
ë‹¤ìŒì€ `az account get-access-token`ì—ì„œ ì§€ì›í•˜ëŠ” APIì¼ ë¿ì´ë©°, ë” ë§ì€ APIê°€ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

<details>

<summary>aud ì˜ˆì‹œ</summary>

* **aad-graph (Azure Active Directory Graph API)**: ë ˆê±°ì‹œ Azure AD Graph API(ì‚¬ìš© ì¤‘ë‹¨ë¨)ì— ì ‘ê·¼í•˜ëŠ” ë° ì‚¬ìš©ë˜ë©°, ì• í”Œë¦¬ì¼€ì´ì…˜ì´ Azure Active Directory(Azure AD)ì—ì„œ ë””ë ‰í„°ë¦¬ ë°ì´í„°ë¥¼ ì½ê³  ì“¸ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
* `https://graph.windows.net/`

- **arm (Azure Resource Manager)**: Azure Resource Manager APIë¥¼ í†µí•´ Azure ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì—¬ê¸°ì—ëŠ” ê°€ìƒ ë¨¸ì‹ , ìŠ¤í† ë¦¬ì§€ ê³„ì • ë“±ê³¼ ê°™ì€ ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±, ì—…ë°ì´íŠ¸ ë° ì‚­ì œí•˜ëŠ” ì‘ì—…ì´ í¬í•¨ë©ë‹ˆë‹¤.
* `https://management.core.windows.net/ or https://management.azure.com/`

* **batch (Azure Batch Services)**: í´ë¼ìš°ë“œì—ì„œ ëŒ€ê·œëª¨ ë³‘ë ¬ ë° ê³ ì„±ëŠ¥ ì»´í“¨íŒ… ì• í”Œë¦¬ì¼€ì´ì…˜ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” Azure Batchì— ì ‘ê·¼í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
* `https://batch.core.windows.net/`

- **data-lake (Azure Data Lake Storage)**: Azure Data Lake Storage Gen1ê³¼ ìƒí˜¸ì‘ìš©í•˜ëŠ” ë° ì‚¬ìš©ë˜ë©°, ì´ëŠ” í™•ì¥ ê°€ëŠ¥í•œ ë°ì´í„° ì €ì¥ ë° ë¶„ì„ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.
* `https://datalake.azure.net/`

* **media (Azure Media Services)**: ë¹„ë””ì˜¤ ë° ì˜¤ë””ì˜¤ ì½˜í…ì¸ ë¥¼ ìœ„í•œ í´ë¼ìš°ë“œ ê¸°ë°˜ ë¯¸ë””ì–´ ì²˜ë¦¬ ë° ì „ë‹¬ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” Azure Media Servicesì— ì ‘ê·¼í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
* `https://rest.media.azure.net`

- **ms-graph (Microsoft Graph API)**: Microsoft 365 ì„œë¹„ìŠ¤ ë°ì´í„°ì— ëŒ€í•œ í†µí•© ì—”ë“œí¬ì¸íŠ¸ì¸ Microsoft Graph APIì— ì ‘ê·¼í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. Azure AD, Office 365, Enterprise Mobility ë° Security ì„œë¹„ìŠ¤ì™€ ê°™ì€ ì„œë¹„ìŠ¤ì—ì„œ ë°ì´í„° ë° í†µì°°ë ¥ì„ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* `https://graph.microsoft.com`

* **oss-rdbms (Azure Open Source Relational Databases)**: MySQL, PostgreSQL ë° MariaDBì™€ ê°™ì€ ì˜¤í”ˆ ì†ŒìŠ¤ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ì—”ì§„ì„ ìœ„í•œ Azure Database ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
* `https://ossrdbms-aad.database.windows.net`

</details>

### Access Tokens Scopes "scp"

ì•¡ì„¸ìŠ¤ í† í°ì˜ ë²”ìœ„ëŠ” ì•¡ì„¸ìŠ¤ í† í° JWT ë‚´ë¶€ì˜ scp í‚¤ì— ì €ì¥ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ë²”ìœ„ëŠ” ì•¡ì„¸ìŠ¤ í† í°ì´ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë‚´ìš©ì„ ì •ì˜í•©ë‹ˆë‹¤.

JWTê°€ íŠ¹ì • APIì— ì—°ë½í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©ë˜ì§€ë§Œ **ìš”ì²­ëœ ì‘ì—…ì„ ìˆ˜í–‰í•  ë²”ìœ„ê°€ ì—†ëŠ” ê²½ìš°**, í•´ë‹¹ JWTë¡œëŠ” **ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.

### Get refresh & access token example
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"04b07795-8ddb-461a-bbee-02f9e1bf7b46" # ID for Azure CLI client
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)



# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
## FOCI í† í° ê¶Œí•œ ìƒìŠ¹

ì´ì „ì— ì–¸ê¸‰í–ˆë“¯ì´, ë¦¬í”„ë ˆì‹œ í† í°ì€ ìƒì„±ëœ **ë²”ìœ„**ì™€ **ì• í”Œë¦¬ì¼€ì´ì…˜** ë° **í…Œë„ŒíŠ¸**ì— ì—°ê²°ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê²½ê³„ ì¤‘ í•˜ë‚˜ë¼ë„ ê¹¨ì§€ë©´, ì‚¬ìš©ìê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ì™€ í…Œë„ŒíŠ¸ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ í† í°ì„ ìƒì„±í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì›ë˜ ì˜ë„í•œ ê²ƒë³´ë‹¤ ë” ë§ì€ ë²”ìœ„ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê²Œë‹¤ê°€, **ì´ëŠ” ëª¨ë“  ë¦¬í”„ë ˆì‹œ í† í°ì— ëŒ€í•´ ê°€ëŠ¥í•©ë‹ˆë‹¤** [Microsoft identity platform](https://learn.microsoft.com/en-us/entra/identity-platform/) (Microsoft Entra ê³„ì •, Microsoft ê°œì¸ ê³„ì •, Facebook ë° Googleê³¼ ê°™ì€ ì†Œì…œ ê³„ì •)ì—ì„œ, ì™œëƒí•˜ë©´ [**ë¬¸ì„œ**](https://learn.microsoft.com/en-us/entra/identity-platform/refresh-tokens)ì—ì„œ ì–¸ê¸‰í•˜ë“¯ì´: "ë¦¬í”„ë ˆì‹œ í† í°ì€ ì‚¬ìš©ìì™€ í´ë¼ì´ì–¸íŠ¸ì˜ ì¡°í•©ì— ë°”ì¸ë”©ë˜ì§€ë§Œ, **ë¦¬ì†ŒìŠ¤ë‚˜ í…Œë„ŒíŠ¸ì— ë¬¶ì—¬ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤**. í´ë¼ì´ì–¸íŠ¸ëŠ” ë¦¬í”„ë ˆì‹œ í† í°ì„ ì‚¬ìš©í•˜ì—¬ **ë¦¬ì†ŒìŠ¤ì™€ í…Œë„ŒíŠ¸ì˜ ì¡°í•©ì— ê´€ê³„ì—†ì´** ì•¡ì„¸ìŠ¤ í† í°ì„ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¦¬í”„ë ˆì‹œ í† í°ì€ ì•”í˜¸í™”ë˜ì–´ ìˆìœ¼ë©° Microsoft identity platformë§Œ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."

ë˜í•œ, FOCI ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ê³µê°œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ë¯€ë¡œ **ì„œë²„ì— ì¸ì¦í•˜ê¸° ìœ„í•´ ë¹„ë°€ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.

ê·¸ëŸ° ë‹¤ìŒ [**ì›ë³¸ ì—°êµ¬**](https://github.com/secureworks/family-of-client-ids-research/tree/main)ì—ì„œ ë³´ê³ ëœ ì•Œë ¤ì§„ FOCI í´ë¼ì´ì–¸íŠ¸ëŠ” [**ì—¬ê¸°ì„œ**](https://github.com/secureworks/family-of-client-ids-research/blob/main/known-foci-clients.csv) ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë‹¤ë¥¸ ë²”ìœ„ ê°€ì ¸ì˜¤ê¸°

ì´ì „ ì˜ˆì œ ì½”ë“œë¥¼ ë”°ë¼, ì´ ì½”ë“œì—ì„œëŠ” ë‹¤ë¥¸ ë²”ìœ„ì— ëŒ€í•œ ìƒˆ í† í°ì„ ìš”ì²­í•©ë‹ˆë‹¤:
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### ë‹¤ì–‘í•œ í´ë¼ì´ì–¸íŠ¸ ë° ë²”ìœ„ ê°€ì ¸ì˜¤ê¸°
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## References

* [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
