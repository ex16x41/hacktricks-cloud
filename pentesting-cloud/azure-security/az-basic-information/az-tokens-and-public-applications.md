# Az - Tokens & Public Applications

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Entra ID je Microsoftova platforma za upravljanje identitetima i pristupom (IAM) zasnovana na oblaku, koja slu쬴 kao osnovni sistem za autentifikaciju i autorizaciju za usluge kao 코to su Microsoft 365 i Azure Resource Manager. Azure AD implementira OAuth 2.0 okvir autorizacije i OpenID Connect (OIDC) protokol autentifikacije za upravljanje pristupom resursima.

### OAuth

**Klju캜ni u캜esnici u OAuth 2.0:**

1. **Server resursa (RS):** 맚iti resurse koje poseduje vlasnik resursa.
2. **Vlasnik resursa (RO):** Obi캜no krajnji korisnik koji poseduje za코ti캖ene resurse.
3. **Klijentska aplikacija (CA):** Aplikacija koja tra쬴 pristup resursima u ime vlasnika resursa.
4. **Server autorizacije (AS):** Izdaje pristupne tokene klijentskim aplikacijama nakon autentifikacije i autorizacije.

**Opsezi i saglasnost:**

* **Opsezi:** Granularne dozvole definisane na serveru resursa koje specificiraju nivoe pristupa.
* **Saglasnost:** Proces kojim vlasnik resursa daje klijentskoj aplikaciji dozvolu za pristup resursima sa specifi캜nim opsezima.

**Integracija sa Microsoft 365:**

* Microsoft 365 koristi Azure AD za IAM i sastoji se od vi코e "prvih strana" OAuth aplikacija.
* Ove aplikacije su duboko integrisane i 캜esto imaju me캠uzavisne odnose usluga.
* Da bi se pojednostavilo korisni캜ko iskustvo i odr쬬la funkcionalnost, Microsoft daje "implicitnu saglasnost" ili "pre-saglasnost" ovim aplikacijama prve strane.
* **Implicitna saglasnost:** Odre캠ene aplikacije automatski **dobijaju pristup specifi캜nim opsezima bez eksplicitne saglasnosti korisnika ili administratora**.
* Ovi pre-sagla코eni opsezi su obi캜no skriveni i od korisnika i od administratora, 캜ine캖i ih manje vidljivim u standardnim upravlja캜kim interfejsima.

**Tipovi klijentskih aplikacija:**

1. **Poverljivi klijenti:**
* Imaju svoje sopstvene akreditive (npr. lozinke ili sertifikate).
* Mogu **sigurno da se autentifikuju** na serveru autorizacije.
2. **Javni klijenti:**
* Nemaju jedinstvene akreditive.
* Ne mogu sigurno da se autentifikuju na serveru autorizacije.
* **Bezbednosna implikacija:** Napada캜 mo쬰 da se pretvara da je javna klijentska aplikacija prilikom tra쬰nja tokena, jer ne postoji mehanizam za server autorizacije da verifikuje legitimnost aplikacije.

## Authentication Tokens

Postoje **tri tipa tokena** koji se koriste u OIDC:

* [**Pristupni tokeni**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Klijent predstavlja ovaj token serveru resursa da bi **pristupio resursima**. Mo쬰 se koristiti samo za specifi캜nu kombinaciju korisnika, klijenta i resursa i **ne mo쬰 biti opozvan** do isteka - 코to je 1 sat po defaultu.
* **ID tokeni**: Klijent prima ovaj **token od servera autorizacije**. Sadr쬴 osnovne informacije o korisniku. **Povezan je sa specifi캜nom kombinacijom korisnika i klijenta**.
* **Refresh tokeni**: Dodeljuju se klijentu zajedno sa pristupnim tokenom. Koriste se za **dobijanje novih pristupnih i ID tokena**. Povezani su sa specifi캜nom kombinacijom korisnika i klijenta i mogu biti opozvani. Podrazumevano vreme isteka je **90 dana** za neaktivne refresh tokene i **nema isteka za aktivne tokene** (mogu캖e je dobiti nove refresh tokene iz refresh tokena).
* Refresh token bi trebao biti vezan za **`aud`**, za neke **opsege**, i za **tenanta** i trebao bi mo캖i da generi코e pristupne tokene samo za taj aud, opsege (i ni코ta vi코e) i tenant. Me캠utim, to nije slu캜aj sa **FOCI aplikacijama**.
* Refresh token je enkriptovan i samo Microsoft mo쬰 da ga dekriptuje.
* Dobijanje novog refresh tokena ne opoziva prethodni refresh token.

{% hint style="warning" %}
Informacije za **uslovni pristup** su **sme코tene** unutar **JWT**. Dakle, ako zatra쬴te **token sa dozvoljene IP adrese**, ta **IP** 캖e biti **sme코tena** u tokenu i tada mo쬰te koristiti taj token sa **nedozvoljene IP adrese za pristup resursima**.
{% endhint %}

### Access Tokens "aud"

Polje ozna캜eno u "aud" polju je **server resursa** (aplikacija) koji se koristi za obavljanje prijave.

Komanda `az account get-access-token --resource-type [...]` podr쬬va slede캖e tipove i svaki od njih 캖e dodati specifi캜an "aud" u rezultantnom pristupnom tokenu:

{% hint style="danger" %}
Napomena da su slede캖e samo API-jevi podr쬬ni od strane `az account get-access-token`, ali ih ima vi코e.
{% endhint %}

<details>

<summary>aud primeri</summary>

* **aad-graph (Azure Active Directory Graph API)**: Koristi se za pristup starom Azure AD Graph API (ukinut), koji omogu캖ava aplikacijama da 캜itaju i pi코u podatke direktorijuma u Azure Active Directory (Azure AD).
* `https://graph.windows.net/`

- **arm (Azure Resource Manager)**: Koristi se za upravljanje Azure resursima putem Azure Resource Manager API-ja. Ovo uklju캜uje operacije kao 코to su kreiranje, a쬿riranje i brisanje resursa kao 코to su virtuelne ma코ine, skladi코ni nalozi i jo코 mnogo toga.
* `https://management.core.windows.net/ or https://management.azure.com/`

* **batch (Azure Batch Services)**: Koristi se za pristup Azure Batch, usluzi koja omogu캖ava efikasno izvo캠enje aplikacija za paralelno i visokoperformantno ra캜unanje u oblaku.
* `https://batch.core.windows.net/`

- **data-lake (Azure Data Lake Storage)**: Koristi se za interakciju sa Azure Data Lake Storage Gen1, koja je skalabilna usluga za skladi코tenje podataka i analitiku.
* `https://datalake.azure.net/`

* **media (Azure Media Services)**: Koristi se za pristup Azure Media Services, koje pru쬬ju usluge obrade i isporuke medija zasnovane na oblaku za video i audio sadr쬬j.
* `https://rest.media.azure.net`

- **ms-graph (Microsoft Graph API)**: Koristi se za pristup Microsoft Graph API-ju, jedinstvenom kraju za podatke usluga Microsoft 365. Omogu캖ava pristup podacima i uvidima iz usluga kao 코to su Azure AD, Office 365, Enterprise Mobility i Security usluge.
* `https://graph.microsoft.com`

* **oss-rdbms (Azure Open Source Relational Databases)**: Koristi se za pristup Azure Database uslugama za open-source relacione baze podataka kao 코to su MySQL, PostgreSQL i MariaDB.
* `https://ossrdbms-aad.database.windows.net`

</details>

### Access Tokens Scopes "scp"

Opseg pristupnog tokena se 캜uva unutar scp klju캜a unutar JWT pristupnog tokena. Ovi opsezi defini코u 코ta pristupni token mo쬰 da pristupi.

Ako je JWT dozvoljeno da kontaktira odre캠eni API, ali **nema opseg** za izvr코enje tra쬰ne radnje, **ne캖e mo캖i da izvr코i radnju** sa tim JWT-om.

### Get refresh & access token example
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"04b07795-8ddb-461a-bbee-02f9e1bf7b46" # ID for Azure CLI client
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)



# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
## FOCI Tokens Privilege Escalation

Prethodno je pomenuto da bi refresh tokeni trebali biti vezani za **scopes** sa kojima su generisani, za **aplikaciju** i **tenant** za koji su generisani. Ako se bilo koja od ovih granica prekine, mogu캖e je eskalirati privilegije jer 캖e biti mogu캖e generisati access tokene za druge resurse i tenante kojima korisnik ima pristup i sa vi코e scopes nego 코to je prvobitno predvi캠eno.

맚avi코e, **to je mogu캖e sa svim refresh tokenima** u [Microsoft identity platform](https://learn.microsoft.com/en-us/entra/identity-platform/) (Microsoft Entra ra캜uni, Microsoft li캜ni ra캜uni i dru코tveni ra캜uni kao 코to su Facebook i Google) jer, kao 코to [**dokumentacija**](https://learn.microsoft.com/en-us/entra/identity-platform/refresh-tokens) pominje: "Refresh tokeni su vezani za kombinaciju korisnika i klijenta, ali **nisu vezani za resurs ili tenant**. Klijent mo쬰 koristiti refresh token da dobije access tokene **kroz bilo koju kombinaciju resursa i tenanta** gde ima dozvolu da to uradi. Refresh tokeni su enkriptovani i samo Microsoft identity platform mo쬰 da ih pro캜ita."

Tako캠e, imajte na umu da su FOCI aplikacije javne aplikacije, tako da **nije potreban nikakav tajni klju캜** za autentifikaciju na serveru.

Poznati FOCI klijenti prijavljeni u [**originalnom istra쬴vanju**](https://github.com/secureworks/family-of-client-ids-research/tree/main) mogu se [**prona캖i ovde**](https://github.com/secureworks/family-of-client-ids-research/blob/main/known-foci-clients.csv).

### Get different scope

U skladu sa prethodnim primerom koda, u ovom kodu se tra쬴 novi token za razli캜iti scope:
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### Dobijanje razli캜itih klijenata i opsega
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## References

* [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
