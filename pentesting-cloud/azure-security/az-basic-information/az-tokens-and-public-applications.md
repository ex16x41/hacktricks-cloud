# Az - Tokens & Public Applications

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Entra ID рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдХрд╛ рдХреНрд▓рд╛рдЙрдб-рдЖрдзрд╛рд░рд┐рдд рдкрд╣рдЪрд╛рди рдФрд░ рдкрд╣реБрдВрдЪ рдкреНрд░рдмрдВрдзрди (IAM) рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рд╣реИ, рдЬреЛ Microsoft 365 рдФрд░ Azure Resource Manager рдЬреИрд╕реА рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдореМрд▓рд┐рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдФрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдкреНрд░рдгрд╛рд▓реА рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИред Azure AD OAuth 2.0 рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдврд╛рдВрдЪреЗ рдФрд░ OpenID Connect (OIDC) рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЛ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИред

### OAuth

**OAuth 2.0 рдореЗрдВ рдореБрдЦреНрдп рдкреНрд░рддрд┐рднрд╛рдЧреА:**

1. **Resource Server (RS):** рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреА рд░рдХреНрд╖рд╛ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╕рдВрд╕рд╛рдзрди рдорд╛рд▓рд┐рдХ рдХреЗ рдкрд╛рд╕ рд╣реИрдВред
2. **Resource Owner (RO):** рдЖрдорддреМрд░ рдкрд░ рдПрдХ рдЕрдВрддрд┐рдо рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬреЛ рд╕рдВрд░рдХреНрд╖рд┐рдд рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХрд╛ рдорд╛рд▓рд┐рдХ рд╣реЛрддрд╛ рд╣реИред
3. **Client Application (CA):** рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЬреЛ рд╕рдВрд╕рд╛рдзрди рдорд╛рд▓рд┐рдХ рдХреА рдУрд░ рд╕реЗ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддрд╛ рд╣реИред
4. **Authorization Server (AS):** рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдФрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЗ рдмрд╛рдж рдХреНрд▓рд╛рдЗрдВрдЯ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдХреЛ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдЬрд╛рд░реА рдХрд░рддрд╛ рд╣реИред

**Scopes рдФрд░ Consent:**

* **Scopes:** рд╕рдВрд╕рд╛рдзрди рд╕рд░реНрд╡рд░ рдкрд░ рдкрд░рд┐рднрд╛рд╖рд┐рдд рд╕реВрдХреНрд╖реНрдо рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдЬреЛ рдкрд╣реБрдБрдЪ рд╕реНрддрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддреА рд╣реИрдВред
* **Consent:** рд╡рд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЬрд┐рд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ рдПрдХ рд╕рдВрд╕рд╛рдзрди рдорд╛рд▓рд┐рдХ рдПрдХ рдХреНрд▓рд╛рдЗрдВрдЯ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕реНрдХреЛрдк рдХреЗ рд╕рд╛рде рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

**Microsoft 365 рдПрдХреАрдХрд░рдг:**

* Microsoft 365 IAM рдХреЗ рд▓рд┐рдП Azure AD рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдореЗрдВ рдХрдИ "рдкрд╣рд▓реА-рдкрд╛рд░реНрдЯреА" OAuth рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╢рд╛рдорд┐рд▓ рд╣реИрдВред
* рдпреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЧрд╣рд░рд╛рдИ рд╕реЗ рдПрдХреАрдХреГрдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдЕрдХреНрд╕рд░ рдЖрдкрд╕ рдореЗрдВ рдирд┐рд░реНрднрд░ рд╕реЗрд╡рд╛ рд╕рдВрдмрдВрдз рд╣реЛрддреЗ рд╣реИрдВред
* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдиреБрднрд╡ рдХреЛ рд╕рд░рд▓ рдмрдирд╛рдиреЗ рдФрд░ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдмрдирд╛рдП рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП, Microsoft рдЗрди рдкрд╣рд▓реА-рдкрд╛рд░реНрдЯреА рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдХреЛ "рдЕрд░реНрдерд┐рдд рд╕рд╣рдорддрд┐" рдпрд╛ "рдкреВрд░реНрд╡-рд╕рд╣рдорддрд┐" рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
* **Implied Consent:** рдХреБрдЫ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдХреЛ рд╕реНрдкрд╖реНрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рдкреНрд░рд╢рд╛рд╕рдХ рдЕрдиреБрдореЛрджрди рдХреЗ рдмрд┐рдирд╛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕реНрдХреЛрдк рддрдХ рдкрд╣реБрдБрдЪ **рд╕реНрд╡рддрдГ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рддреА рд╣реИ**ред
* рдпреЗ рдкреВрд░реНрд╡-рд╕рд╣рдорддрд┐ рд╡рд╛рд▓реЗ рд╕реНрдХреЛрдк рдЖрдорддреМрд░ рдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдФрд░ рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рджреЛрдиреЛрдВ рд╕реЗ рдЫрд┐рдкреЗ рд╣реЛрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рд╡реЗ рдорд╛рдирдХ рдкреНрд░рдмрдВрдзрди рдЗрдВрдЯрд░рдлреЗрд╕ рдореЗрдВ рдХрдо рджрд┐рдЦрд╛рдИ рджреЗрддреЗ рд╣реИрдВред

**Client Application Types:**

1. **Confidential Clients:**
* рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ (рдЬреИрд╕реЗ, рдкрд╛рд╕рд╡рд░реНрдб рдпрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░) рд░рдЦрддреЗ рд╣реИрдВред
* рдкреНрд░рд╛рдзрд┐рдХрд░рдг рд╕рд░реНрд╡рд░ рдХреЗ рд▓рд┐рдП **рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
2. **Public Clients:**
* рдЕрджреНрд╡рд┐рддреАрдп рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВред
* рдкреНрд░рд╛рдзрд┐рдХрд░рдг рд╕рд░реНрд╡рд░ рдХреЗ рд▓рд┐рдП рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
* **рд╕реБрд░рдХреНрд╖рд╛ рдирд┐рд╣рд┐рддрд╛рд░реНрде:** рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЯреЛрдХрди рдорд╛рдВрдЧрддреЗ рд╕рдордп рдПрдХ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреНрд▓рд╛рдЗрдВрдЯ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рд╕рд░реНрд╡рд░ рдХреЗ рд▓рд┐рдП рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреА рд╡реИрдзрддрд╛ рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдиреЗ рдХрд╛ рдХреЛрдИ рддрдВрддреНрд░ рдирд╣реАрдВ рд╣реИред

## Authentication Tokens

OIDC рдореЗрдВ **рддреАрди рдкреНрд░рдХрд╛рд░ рдХреЗ рдЯреЛрдХрди** рд╣реЛрддреЗ рд╣реИрдВ:

* [**Access Tokens**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** рдХреНрд▓рд╛рдЗрдВрдЯ рдЗрд╕ рдЯреЛрдХрди рдХреЛ рд╕рдВрд╕рд╛рдзрди рд╕рд░реНрд╡рд░ рдХреЛ **рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ** рдХреЗ рд▓рд┐рдП рдкреНрд░рд╕реНрддреБрдд рдХрд░рддрд╛ рд╣реИред рдЗрд╕реЗ рдХреЗрд╡рд▓ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛, рдХреНрд▓рд╛рдЗрдВрдЯ рдФрд░ рд╕рдВрд╕рд╛рдзрди рдХреЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рдВрдпреЛрдЬрди рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рд╕рдорд╛рдкреНрддрд┐ рддрдХ рд░рджреНрдж рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛** - рдЬреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ 1 рдШрдВрдЯрд╛ рд╣реИред
* **ID Tokens**: рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдпрд╣ **рдЯреЛрдХрди рдкреНрд░рд╛рдзрд┐рдХрд░рдг рд╕рд░реНрд╡рд░ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ**ред рдЗрд╕рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмреБрдирд┐рдпрд╛рджреА рдЬрд╛рдирдХрд╛рд░реА рд╣реЛрддреА рд╣реИред рдпрд╣ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рдВрдпреЛрдЬрди рд╕реЗ рдмрдВрдзрд╛ рд╣реЛрддрд╛ рд╣реИ**ред
* **Refresh Tokens**: рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдХреЗ рд╕рд╛рде рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **рдирдП рдПрдХреНрд╕реЗрд╕ рдФрд░ ID рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рдВрдпреЛрдЬрди рд╕реЗ рдмрдВрдзрд╛ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рд░рджреНрдж рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдорд╛рдкреНрддрд┐ **90 рджрд┐рди** рд╣реИ рдирд┐рд╖реНрдХреНрд░рд┐рдп рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХреЗ рд▓рд┐рдП рдФрд░ **рд╕рдХреНрд░рд┐рдп рдЯреЛрдХрди рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╕рдорд╛рдкреНрддрд┐ рдирд╣реАрдВ** (рдПрдХ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рд╕реЗ рдирдП рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ)ред
* рдПрдХ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХреЛ рдПрдХ **`aud`**, рдХреБрдЫ **scopes**, рдФрд░ рдПрдХ **tenant** рд╕реЗ рдЬреЛрдбрд╝рд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рдЗрд╕реЗ рдХреЗрд╡рд▓ рдЙрд╕ aud, scopes (рдФрд░ рдЕрдзрд┐рдХ рдирд╣реАрдВ) рдФрд░ tenant рдХреЗ рд▓рд┐рдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрд╣ **FOCI рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЯреЛрдХрди** рдХреЗ рд╕рд╛рде рдРрд╕рд╛ рдирд╣реАрдВ рд╣реИред
* рдПрдХ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдХреЗрд╡рд▓ рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдЗрд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
* рдирдпрд╛ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рд╕реЗ рдкрд┐рдЫрд▓реЗ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХреЛ рд░рджреНрдж рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

{% hint style="warning" %}
**Conditional access** рдХреЗ рд▓рд┐рдП рдЬрд╛рдирдХрд╛рд░реА **JWT** рдХреЗ рдЕрдВрджрд░ **рд╕реНрдЯреЛрд░** рдХреА рдЬрд╛рддреА рд╣реИред рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЖрдк **рдЕрдиреБрдордд IP рдкрддреЗ** рд╕реЗ **рдЯреЛрдХрди** рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╡рд╣ **IP** рдЯреЛрдХрди рдореЗрдВ **рд╕реНрдЯреЛрд░** рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдлрд┐рд░ рдЖрдк рдЙрд╕ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ **рдЧреИрд░-рдЕрдиреБрдордд IP рд╕реЗ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

### Access Tokens "aud"

"aud" рдлрд╝реАрд▓реНрдб рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдлрд╝реАрд▓реНрдб **resource server** (рдПрдкреНрд▓рд┐рдХреЗрд╢рди) рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдХрдорд╛рдВрдб `az account get-access-token --resource-type [...]` рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреНрд░рдХрд╛рд░реЛрдВ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрдирдореЗрдВ рд╕реЗ рдкреНрд░рддреНрдпреЗрдХ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдореЗрдВ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ "aud" рдЬреЛрдбрд╝реЗрдЧрд╛:

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗрд╡рд▓ `az account get-access-token` рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд APIs рд╣реИрдВ рд▓реЗрдХрд┐рди рдФрд░ рднреА рд╣реИрдВред
{% endhint %}

<details>

<summary>aud examples</summary>

* **aad-graph (Azure Active Directory Graph API)**: рдкреБрд░рд╛рдиреЗ Azure AD Graph API (deprecated) рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдХреЛ Azure Active Directory (Azure AD) рдореЗрдВ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдбреЗрдЯрд╛ рдкрдврд╝рдиреЗ рдФрд░ рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
* `https://graph.windows.net/`

- **arm (Azure Resource Manager)**: Azure Resource Manager API рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ Azure рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдореЗрдВ рд╡рд░реНрдЪреБрдЕрд▓ рдорд╢реАрдиреЛрдВ, рд╕реНрдЯреЛрд░реЗрдЬ рдЦрд╛рддреЛрдВ, рдФрд░ рдЕрдзрд┐рдХ рдЬреИрд╕реЗ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рдмрдирд╛рдиреЗ, рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдФрд░ рд╣рдЯрд╛рдиреЗ рдЬреИрд╕реА рдХреНрд░рд┐рдпрд╛рдПрдБ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред
* `https://management.core.windows.net/ or https://management.azure.com/`

* **batch (Azure Batch Services)**: Azure Batch рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдХреНрд▓рд╛рдЙрдб рдореЗрдВ рдмрдбрд╝реЗ рдкреИрдорд╛рдиреЗ рдкрд░ рд╕рдорд╛рдирд╛рдВрддрд░ рдФрд░ рдЙрдЪреНрдЪ-рдкреНрд░рджрд░реНрд╢рди рдХрдВрдкреНрдпреВрдЯрд┐рдВрдЧ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдХреЛ рдХреБрд╢рд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕рдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИред
* `https://batch.core.windows.net/`

- **data-lake (Azure Data Lake Storage)**: Azure Data Lake Storage Gen1 рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдПрдХ рд╕реНрдХреЗрд▓реЗрдмрд▓ рдбреЗрдЯрд╛ рд╕реНрдЯреЛрд░реЗрдЬ рдФрд░ рдПрдирд╛рд▓рд┐рдЯрд┐рдХреНрд╕ рд╕реЗрд╡рд╛ рд╣реИред
* `https://datalake.azure.net/`

* **media (Azure Media Services)**: Azure Media Services рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рд╡реАрдбрд┐рдпреЛ рдФрд░ рдСрдбрд┐рдпреЛ рд╕рд╛рдордЧреНрд░реА рдХреЗ рд▓рд┐рдП рдХреНрд▓рд╛рдЙрдб-рдЖрдзрд╛рд░рд┐рдд рдореАрдбрд┐рдпрд╛ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ рдФрд░ рд╡рд┐рддрд░рдг рд╕реЗрд╡рд╛рдПрдБ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
* `https://rest.media.azure.net`

- **ms-graph (Microsoft Graph API)**: Microsoft Graph API, Microsoft 365 рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рдбреЗрдЯрд╛ рдХреЗ рд▓рд┐рдП рдПрдХреАрдХреГрдд рдПрдВрдбрдкреЙрдЗрдВрдЯ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ Azure AD, Office 365, Enterprise Mobility, рдФрд░ Security рд╕реЗрд╡рд╛рдУрдВ рдЬреИрд╕реА рд╕реЗрд╡рд╛рдУрдВ рд╕реЗ рдбреЗрдЯрд╛ рдФрд░ рдЕрдВрддрд░реНрджреГрд╖реНрдЯрд┐ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
* `https://graph.microsoft.com`

* **oss-rdbms (Azure Open Source Relational Databases)**: MySQL, PostgreSQL, рдФрд░ MariaDB рдЬреИрд╕реЗ рдУрдкрди-рд╕реЛрд░реНрд╕ рд░рд┐рд▓реЗрд╢рдирд▓ рдбреЗрдЯрд╛рдмреЗрд╕ рдЗрдВрдЬрдиреЛрдВ рдХреЗ рд▓рд┐рдП Azure Database рд╕реЗрд╡рд╛рдУрдВ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* `https://ossrdbms-aad.database.windows.net`

</details>

### Access Tokens Scopes "scp"

рдПрдХ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдХрд╛ рд╕реНрдХреЛрдк рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди JWT рдХреЗ рдЕрдВрджрд░ scp рдХреБрдВрдЬреА рдХреЗ рдЕрдВрджрд░ рд╕реНрдЯреЛрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпреЗ рд╕реНрдХреЛрдк рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдХреЛ рдХреНрдпрд╛ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рд╣реИред

рдпрджрд┐ рдПрдХ JWT рдХреЛ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ API рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ рд▓реЗрдХрд┐рди **рдЕрдиреБрд░реЛрдзрд┐рдд рдХреНрд░рд┐рдпрд╛** рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рд╕реНрдХреЛрдк рдирд╣реАрдВ рд╣реИ**, рддреЛ рдпрд╣ рдЙрд╕ JWT рдХреЗ рд╕рд╛рде **рдХреНрд░рд┐рдпрд╛ рдХрд░рдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрде рд╣реЛрдЧрд╛**ред

### Get refresh & access token example
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"04b07795-8ddb-461a-bbee-02f9e1bf7b46" # ID for Azure CLI client
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)



# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
## FOCI Tokens Privilege Escalation

рдкрд╣рд▓реЗ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдХрд┐ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХреЛ **рд╕реНрдХреЛрдк** рд╕реЗ рдЬреЛрдбрд╝рд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬрд┐рд╕рдХреЗ рд╕рд╛рде рдЗрд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, **рдРрдкреНрд▓рд┐рдХреЗрд╢рди** рдФрд░ **рдЯреЗрдиреЗрдВрдЯ** рд╕реЗ рдЬрд┐рд╕реЗ рдпрд╣ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред рдпрджрд┐ рдЗрдирдореЗрдВ рд╕реЗ рдХреЛрдИ рднреА рд╕реАрдорд╛ рдЯреВрдЯрддреА рд╣реИ, рддреЛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЕрдиреНрдп рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдФрд░ рдЯреЗрдиреЗрдВрдЯ рдХреЗ рд▓рд┐рдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ рдЬрд┐рди рддрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкрд╣реБрдВрдЪ рд╣реИ рдФрд░ рдЕрдзрд┐рдХ рд╕реНрдХреЛрдк рдХреЗ рд╕рд╛рде рдЬрд┐рддрдирд╛ рдХрд┐ рдЗрд╕реЗ рдореВрд▓ рд░реВрдк рд╕реЗ рдЗрд░рд╛рджрд╛ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **рдпрд╣ рд╕рднреА рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХреЗ рд╕рд╛рде рд╕рдВрднрд╡ рд╣реИ** [Microsoft identity platform](https://learn.microsoft.com/en-us/entra/identity-platform/) (Microsoft Entra рдЦрд╛рддреЗ, Microsoft рд╡реНрдпрдХреНрддрд┐рдЧрдд рдЦрд╛рддреЗ, рдФрд░ рдлреЗрд╕рдмреБрдХ рдФрд░ рдЧреВрдЧрд▓ рдЬреИрд╕реЗ рд╕рд╛рдорд╛рдЬрд┐рдХ рдЦрд╛рддреЗ) рдХреНрдпреЛрдВрдХрд┐ [**рджрд╕реНрддрд╛рд╡реЗрдЬрд╝**](https://learn.microsoft.com/en-us/entra/identity-platform/refresh-tokens) рдореЗрдВ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: "рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рд╕рдВрдпреЛрдЬрди рд╕реЗ рдмрдВрдзреЗ рд╣реЛрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди **рдХрд┐рд╕реА рд╕рдВрд╕рд╛рдзрди рдпрд╛ рдЯреЗрдиреЗрдВрдЯ рд╕реЗ рдмрдВрдзреЗ рдирд╣реАрдВ рд╣реЛрддреЗ**ред рдПрдХ рдХреНрд▓рд╛рдЗрдВрдЯ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ **рдХрд┐рд╕реА рднреА рд╕рдВрд╕рд╛рдзрди рдФрд░ рдЯреЗрдиреЗрдВрдЯ рдХреЗ рд╕рдВрдпреЛрдЬрди рдореЗрдВ** рдЬрд╣рд╛рдВ рдЗрд╕реЗ рдРрд╕рд╛ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИред рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдХреЗрд╡рд▓ Microsoft identity platform рдЙрдиреНрд╣реЗрдВ рдкрдврд╝ рд╕рдХрддрд╛ рд╣реИред"

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ FOCI рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП **рд╕рд░реНрд╡рд░ рдкрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд░рд╣рд╕реНрдп рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИ**ред

рдлрд┐рд░ рдЬреНрдЮрд╛рдд FOCI рдХреНрд▓рд╛рдЗрдВрдЯреНрд╕ рдХреА рд░рд┐рдкреЛрд░реНрдЯ [**рдореВрд▓ рд╢реЛрдз**](https://github.com/secureworks/family-of-client-ids-research/tree/main) рдореЗрдВ рдХреА рдЧрдИ рд╣реИ, рдЬрд┐рд╕реЗ [**рдпрд╣рд╛рдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**](https://github.com/secureworks/family-of-client-ids-research/blob/main/known-foci-clients.csv)ред

### Get different scope

рдкрд┐рдЫрд▓реЗ рдЙрджрд╛рд╣рд░рдг рдХреЛрдб рдХреЗ рд╕рд╛рде рдЖрдЧреЗ рдмрдврд╝рддреЗ рд╣реБрдП, рдЗрд╕ рдХреЛрдб рдореЗрдВ рдПрдХ рдЕрд▓рдЧ рд╕реНрдХреЛрдк рдХреЗ рд▓рд┐рдП рдПрдХ рдирдпрд╛ рдЯреЛрдХрди рдорд╛рдВрдЧрд╛ рдЧрдпрд╛ рд╣реИ:
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### рд╡рд┐рднрд┐рдиреНрди рдХреНрд▓рд╛рдЗрдВрдЯ рдФрд░ рд╕реНрдХреЛрдк рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## рд╕рдВрджрд░реНрдн

* [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
