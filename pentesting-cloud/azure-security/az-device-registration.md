# Az - Device Registration

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

ì¥ì¹˜ê°€ AzureADì— ê°€ì…í•  ë•Œ AzureADì— ìƒˆë¡œìš´ ê°ì²´ê°€ ìƒì„±ë©ë‹ˆë‹¤.

ì¥ì¹˜ë¥¼ ë“±ë¡í•  ë•Œ, **ì‚¬ìš©ìëŠ” ìì‹ ì˜ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë¼ëŠ” ìš”ì²­ì„ ë°›ìŠµë‹ˆë‹¤** (í•„ìš”í•œ ê²½ìš° MFA ìš”ì²­), ê·¸ëŸ° ë‹¤ìŒ ì¥ì¹˜ ë“±ë¡ ì„œë¹„ìŠ¤ì— ëŒ€í•œ í† í°ì„ ìš”ì²­í•˜ê³  ë§ˆì§€ë§‰ í™•ì¸ í”„ë¡¬í”„íŠ¸ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ, ì¥ì¹˜ì—ì„œ ë‘ ê°œì˜ RSA í‚¤ ìŒì´ ìƒì„±ë©ë‹ˆë‹¤: **ì¥ì¹˜ í‚¤** (**ê³µê°œ** í‚¤)ëŠ” **AzureAD**ì— ì „ì†¡ë˜ê³  **ì „ì†¡** í‚¤ (**ê°œì¸** í‚¤)ëŠ” ê°€ëŠ¥í•˜ë©´ TPMì— ì €ì¥ë©ë‹ˆë‹¤.

ê·¸ í›„, **ê°ì²´**ê°€ **AzureAD**ì—ì„œ ìƒì„±ë˜ê³  (Intuneì´ ì•„ë‹˜) AzureADëŠ” ì¥ì¹˜ì— ì„œëª…ëœ **ì¸ì¦ì„œ**ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. **ì¥ì¹˜ê°€ AzureADì— ê°€ì…ë˜ì–´ ìˆëŠ”ì§€** ë° **ì¸ì¦ì„œ**ì— ëŒ€í•œ ì •ë³´(ì˜ˆ: TPMìœ¼ë¡œ ë³´í˜¸ë˜ëŠ”ì§€ ì—¬ë¶€)ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
dsregcmd /status
```
ì¥ì¹˜ ë“±ë¡ í›„ **Primary Refresh Token**ì´ LSASS CloudAP ëª¨ë“ˆì— ì˜í•´ ìš”ì²­ë˜ê³  ì¥ì¹˜ì— ì œê³µë©ë‹ˆë‹¤. PRTì™€ í•¨ê»˜ **ì¥ì¹˜ë§Œ ë³µí˜¸í™”í•  ìˆ˜ ìˆë„ë¡ ì•”í˜¸í™”ëœ ì„¸ì…˜ í‚¤**ë„ ì œê³µë˜ë©°, ì´ëŠ” **PRTë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.**

PRTê°€ ë¬´ì—‡ì¸ì§€ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” í”Œë«í¼ ëª¨ë“ˆ

**TPM**ì€ ì „ì›ì´ êº¼ì§„ ì¥ì¹˜ì—ì„œ í‚¤ **ì¶”ì¶œ**ì„ ë°©ì§€í•˜ê³  (PINìœ¼ë¡œ ë³´í˜¸ëœ ê²½ìš°) OS ê³„ì¸µì—ì„œ ê°œì¸ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” ê²ƒì„ **ë³´í˜¸**í•©ë‹ˆë‹¤.\
í•˜ì§€ë§Œ **TPMê³¼ CPU ê°„ì˜ ë¬¼ë¦¬ì  ì—°ê²°ì„ ìŠ¤ë‹ˆí•‘**í•˜ê±°ë‚˜ ì‹œìŠ¤í…œì´ ì‹¤í–‰ ì¤‘ì¼ ë•Œ **SYSTEM** ê¶Œí•œì„ ê°€ì§„ í”„ë¡œì„¸ìŠ¤ì—ì„œ TPMì˜ **ì•”í˜¸í™” ìë£Œ**ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì— ëŒ€í•´ì„œëŠ” **ë³´í˜¸í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**

ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ë©´ **PRTë¥¼ í›”ì¹˜ëŠ” ê²ƒ**ì´ **ì‚¬ìš©ì**ì²˜ëŸ¼ ì ‘ê·¼í•˜ëŠ” ë° ì‚¬ìš©ë  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **PRTê°€ ì¥ì¹˜ì— ìœ„ì¹˜**í•˜ë¯€ë¡œ ì¥ì¹˜ì—ì„œ í›”ì¹  ìˆ˜ ìˆê±°ë‚˜ (í›”ì¹˜ì§€ ì•Šë”ë¼ë„ ìƒˆë¡œìš´ ì„œëª… í‚¤ë¥¼ ìƒì„±í•˜ëŠ” ë° ì•…ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## SSO í† í°ìœ¼ë¡œ ì¥ì¹˜ ë“±ë¡í•˜ê¸°

ê³µê²©ìê°€ ì†ìƒëœ ì¥ì¹˜ì—ì„œ Microsoft ì¥ì¹˜ ë“±ë¡ ì„œë¹„ìŠ¤ì— ëŒ€í•œ í† í°ì„ ìš”ì²­í•˜ê³  ë“±ë¡í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•  ê²ƒì…ë‹ˆë‹¤:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
ì–´ë–¤ ê²ƒì´ **ë¯¸ë˜ì— PRTë¥¼ ìš”ì²­í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì¸ì¦ì„œë¥¼ ì œê³µí•©ë‹ˆë‹¤**. ë”°ë¼ì„œ ì§€ì†ì„±ì„ ìœ ì§€í•˜ê³  **MFAë¥¼ ìš°íšŒ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì™œëƒí•˜ë©´ ìƒˆ ì¥ì¹˜ë¥¼ ë“±ë¡í•˜ëŠ” ë° ì‚¬ìš©ëœ ì›ë˜ PRT í† í°ì´ **ì´ë¯¸ MFA ê¶Œí•œì´ ë¶€ì—¬ë˜ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤**.

{% hint style="success" %}
ì´ ê³µê²©ì„ ìˆ˜í–‰í•˜ë ¤ë©´ **ìƒˆ ì¥ì¹˜ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ**ì´ í•„ìš”í•©ë‹ˆë‹¤. ë˜í•œ, ì¥ì¹˜ë¥¼ ë“±ë¡í•œë‹¤ê³  í•´ì„œ í•´ë‹¹ ì¥ì¹˜ê°€ **Intuneì— ë“±ë¡ë  ìˆ˜ ìˆëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤**.
{% endhint %}

{% hint style="danger" %}
ì´ ê³µê²©ì€ 2021ë…„ 9ì›”ì— ìˆ˜ì •ë˜ì—ˆìœ¼ë©°, ë” ì´ìƒ SSO í† í°ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆ ì¥ì¹˜ë¥¼ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì—¬ì „íˆ ì •ë‹¹í•œ ë°©ë²•ìœ¼ë¡œ ì¥ì¹˜ë¥¼ ë“±ë¡í•˜ëŠ” ê²ƒì€ ê°€ëŠ¥í•©ë‹ˆë‹¤(í•„ìš”í•œ ê²½ìš° ì‚¬ìš©ì ì´ë¦„, ë¹„ë°€ë²ˆí˜¸ ë° MFAê°€ í•„ìš”). í™•ì¸í•˜ì„¸ìš”: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## ì¥ì¹˜ í‹°ì¼“ ë®ì–´ì“°ê¸°

**ì¥ì¹˜ í‹°ì¼“ì„ ìš”ì²­í•˜ê³ **, ì¥ì¹˜ì˜ í˜„ì¬ í‹°ì¼“ì„ **ë®ì–´ì“°ê³ **, íë¦„ ì¤‘ì— **PRTë¥¼ í›”ì¹˜ëŠ”** ê²ƒì´ ê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤(ë”°ë¼ì„œ TPMì—ì„œ í›”ì¹  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ìì„¸í•œ ì •ë³´ëŠ” [**ì´ ê°•ì—°ì„ í™•ì¸í•˜ì„¸ìš”**](https://youtu.be/BduCn8cLV1A)).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
ê·¸ëŸ¬ë‚˜, ì´ê²ƒì€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
{% endhint %}

## WHFB í‚¤ ë®ì–´ì“°ê¸°

[**ì›ë³¸ ìŠ¬ë¼ì´ë“œë¥¼ ì—¬ê¸°ì„œ í™•ì¸í•˜ì„¸ìš”**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)

ê³µê²© ìš”ì•½:

* **SSOë¥¼ í†µí•´** **ë“±ë¡ëœ WHFB** í‚¤ë¥¼ **ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤**
* ì´ëŠ” **TPM ë³´í˜¸ë¥¼ ë¬´ë ¥í™”**í•˜ë©°, í‚¤ê°€ **ìƒˆ í‚¤ ìƒì„± ì¤‘ì— ìŠ¤ë‹ˆí•‘ë©ë‹ˆë‹¤**
* ì´ê²ƒì€ ë˜í•œ **ì§€ì†ì„±**ì„ ì œê³µí•©ë‹ˆë‹¤

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

ì‚¬ìš©ìëŠ” Azure AD Graphë¥¼ í†µí•´ ìì‹ ì˜ searchableDeviceKey ì†ì„±ì„ ìˆ˜ì •í•  ìˆ˜ ìˆì§€ë§Œ, ê³µê²©ìëŠ” í…Œë„ŒíŠ¸ì— ì¥ì¹˜ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤(ì¦‰ì„ì—ì„œ ë“±ë¡ë˜ê±°ë‚˜ ì •ë‹¹í•œ ì¥ì¹˜ì—ì„œ ì¸ì¦ì„œ + í‚¤ë¥¼ í›”ì¹œ ê²½ìš°) ë° AAD Graphì— ëŒ€í•œ ìœ íš¨í•œ ì•¡ì„¸ìŠ¤ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ, ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ ìƒˆ í‚¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
ê·¸ë¦¬ê³  ê²€ìƒ‰ ê°€ëŠ¥í•œ DeviceKeyì˜ ì •ë³´ë¥¼ PATCHí•©ë‹ˆë‹¤:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

**ë””ë°”ì´ìŠ¤ ì½”ë“œ í”¼ì‹±**ì„ í†µí•´ ì‚¬ìš©ìë¡œë¶€í„° ì•¡ì„¸ìŠ¤ í† í°ì„ ì–»ê³  ì´ì „ ë‹¨ê³„ë¥¼ ì•…ìš©í•˜ì—¬ **ê·¸ì˜ ì•¡ì„¸ìŠ¤ë¥¼ í›”ì¹ ** ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## ì°¸ê³ ë¬¸í—Œ

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay_58QubY)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
