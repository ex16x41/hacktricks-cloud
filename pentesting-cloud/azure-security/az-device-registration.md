# Az - Cihaz KaydÄ±

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</details>
{% endhint %}

## Temel Bilgiler

Bir cihaz AzureAD'ye katÄ±ldÄ±ÄŸÄ±nda AzureAD'de yeni bir nesne oluÅŸturulur.

Bir cihaz kaydedilirken, **kullanÄ±cÄ± hesabÄ±yla giriÅŸ yapmasÄ± istenir** (gerekirse MFA isteyerek), ardÄ±ndan cihaz kayÄ±t hizmeti iÃ§in tokenlar talep edilir ve son bir onay istemi istenir.

Daha sonra, cihazda iki RSA anahtar Ã§ifti oluÅŸturulur: **Cihaz anahtarÄ±** (**aÃ§Ä±k** anahtar) AzureAD'ye gÃ¶nderilir ve **taÅŸÄ±ma** anahtarÄ± (**Ã¶zel** anahtar) mÃ¼mkÃ¼nse TPM'de saklanÄ±r.

Daha sonra, **nesne** **AzureAD**'de (Intune'da deÄŸil) oluÅŸturulur ve AzureAD cihazÄ±na tarafÄ±ndan imzalanmÄ±ÅŸ bir **sertifika** geri verir. **CihazÄ±n AzureAD'ye katÄ±ldÄ±ÄŸÄ±nÄ±** ve **sertifika** hakkÄ±nda bilgileri (Ã¶rneÄŸin TPM ile korunup korunmadÄ±ÄŸÄ±nÄ±) kontrol edebilirsiniz.:
```bash
dsregcmd /status
```
Cihaz kaydÄ±ndan sonra, **Primary Refresh Token** LSASS CloudAP modÃ¼lÃ¼ tarafÄ±ndan istenir ve cihaza verilir. PRT ile birlikte, **sadece cihazÄ±n ÅŸifreyi Ã§Ã¶zebileceÄŸi ÅŸekilde ÅŸifrelenmiÅŸ oturum anahtarÄ±** (taÅŸÄ±ma anahtarÄ±nÄ±n genel anahtarÄ± kullanÄ±larak) teslim edilir ve **PRT'yi kullanmak iÃ§in gereklidir.**

PRT'nin ne olduÄŸu hakkÄ±nda daha fazla bilgi iÃ§in:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

**TPM**, PIN ile korunduÄŸunda kapalÄ± bir cihazdan anahtar **Ã§Ä±karÄ±lmasÄ±na** ve Ã¶zel materyalin iÅŸletim sistemi katmanÄ±ndan Ã§Ä±karÄ±lmasÄ±na karÅŸÄ± **koruma saÄŸlar**.\
Ancak, TPM ile CPU arasÄ±ndaki fiziksel baÄŸlantÄ±nÄ±n **dinlenmesine** veya sistem Ã§alÄ±ÅŸÄ±rken **SYSTEM** haklarÄ±na sahip bir iÅŸlem tarafÄ±ndan TPM'deki kriptografik materyalin **kullanÄ±lmasÄ±na** karÅŸÄ± **koruma saÄŸlamaz**.

AÅŸaÄŸÄ±daki sayfayÄ± kontrol ederseniz, **PRT'nin Ã§alÄ±nmasÄ±nÄ±n** bir **kullanÄ±cÄ±** gibi eriÅŸim saÄŸlamak iÃ§in kullanÄ±labileceÄŸini gÃ¶receksiniz, bu harika Ã§Ã¼nkÃ¼ **PRT cihazlarda bulunur**, bu yÃ¼zden onlardan Ã§alÄ±nabilir (veya Ã§alÄ±nmasa bile yeni imzalama anahtarlarÄ± oluÅŸturmak iÃ§in kÃ¶tÃ¼ye kullanÄ±labilir):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## SSO tokenlarÄ± ile cihaz kaydÄ±

Bir saldÄ±rganÄ±n, ele geÃ§irilmiÅŸ cihazdan Microsoft cihaz kayÄ±t hizmeti iÃ§in bir token talep etmesi ve cihazÄ± kaydetmesi mÃ¼mkÃ¼n olabilir:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Which will give you a **certificate you can use to ask for PRTs in the future**. Bu nedenle kalÄ±cÄ±lÄ±ÄŸÄ± sÃ¼rdÃ¼rmek ve **MFA'yÄ± atlamak** Ã§Ã¼nkÃ¼ yeni cihazÄ± kaydetmek iÃ§in kullanÄ±lan orijinal PRT tokeni **zaten MFA izinleri verilmiÅŸti**.

{% hint style="success" %}
Bu saldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirmek iÃ§in **yeni cihazlar kaydetme** izinlerine sahip olmanÄ±z gerektiÄŸini unutmayÄ±n. AyrÄ±ca, bir cihazÄ± kaydetmek, cihazÄ±n **Intune'a kaydolmasÄ±na izin verileceÄŸi anlamÄ±na gelmez**.
{% endhint %}

{% hint style="danger" %}
Bu saldÄ±rÄ± EylÃ¼l 2021'de dÃ¼zeltildi Ã§Ã¼nkÃ¼ artÄ±k SSO tokenleri kullanarak yeni cihazlar kaydedemezsiniz. Ancak, cihazlarÄ± yasal bir ÅŸekilde kaydetmek hala mÃ¼mkÃ¼ndÃ¼r (gerekirse kullanÄ±cÄ± adÄ±, ÅŸifre ve MFA ile). Kontrol edin: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Bir cihaz biletini Ã¼zerine yazma

**Bir cihaz bileti talep etmek**, cihazÄ±n mevcut olanÄ±nÄ± **Ã¼zerine yazmak** ve akÄ±ÅŸ sÄ±rasÄ±nda **PRT'yi Ã§almak** mÃ¼mkÃ¼ndÃ¼ (bu nedenle TPM'den Ã§almaya gerek yok. Daha fazla bilgi iÃ§in [**bu konuÅŸmayÄ± kontrol edin**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Ancak, bu dÃ¼zeltildi.
{% endhint %}

## WHFB anahtarÄ±nÄ± Ã¼zerine yazma

[**Orijinal slaytlarÄ± buradan kontrol edin**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

SaldÄ±rÄ± Ã¶zeti:

* SSO aracÄ±lÄ±ÄŸÄ±yla bir **cihazdan** **kayÄ±tlÄ± WHFB** anahtarÄ±nÄ± **Ã¼zerine yazmak** mÃ¼mkÃ¼ndÃ¼r
* Yeni anahtarÄ±n **oluÅŸturulmasÄ± sÄ±rasÄ±nda** anahtar **koklanarak** TPM korumasÄ±nÄ± **bozar**
* Bu aynÄ± zamanda **kalÄ±cÄ±lÄ±k saÄŸlar**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

KullanÄ±cÄ±lar, Azure AD Graph aracÄ±lÄ±ÄŸÄ±yla kendi searchableDeviceKey Ã¶zelliklerini deÄŸiÅŸtirebilirler, ancak saldÄ±rganÄ±n kiracÄ±da bir cihaza sahip olmasÄ± (anÄ±nda kaydedilmiÅŸ veya yasal bir cihazdan Ã§alÄ±nmÄ±ÅŸ sertifika + anahtar) ve AAD Graph iÃ§in geÃ§erli bir eriÅŸim tokenine sahip olmasÄ± gerekir.

Daha sonra, yeni bir anahtar oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
ve ardÄ±ndan searchableDeviceKey bilgisini PATCH edin:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

Bir kullanÄ±cÄ±dan **device code phishing** yoluyla bir eriÅŸim token'Ä± almak ve Ã¶nceki adÄ±mlarÄ± kÃ¶tÃ¼ye kullanarak **eriÅŸimini Ã§almak** mÃ¼mkÃ¼ndÃ¼r. Daha fazla bilgi iÃ§in:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Referanslar

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks'e** [**PR gÃ¶ndererek**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunarak **hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.**

</details>
{% endhint %}
