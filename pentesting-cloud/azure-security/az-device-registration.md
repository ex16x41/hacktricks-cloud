# Az - Registro de Dispositivos

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informaci칩n B치sica

Cuando un dispositivo se une a AzureAD, se crea un nuevo objeto en AzureAD.

Al registrar un dispositivo, **se le pide al usuario que inicie sesi칩n con su cuenta** (solicitando MFA si es necesario), luego solicita tokens para el servicio de registro de dispositivos y luego pide una confirmaci칩n final.

Luego, se generan dos pares de claves RSA en el dispositivo: La **clave del dispositivo** (**clave** p칰blica) que se env칤a a **AzureAD** y la **clave de transporte** (**clave** privada) que se almacena en TPM si es posible.

Luego, se genera el **objeto** en **AzureAD** (no en Intune) y AzureAD devuelve al dispositivo un **certificado** firmado por 칠l. Puedes verificar que el **dispositivo est치 unido a AzureAD** y la informaci칩n sobre el **certificado** (como si est치 protegido por TPM).
```bash
dsregcmd /status
```
Despu칠s del registro del dispositivo, se solicita un **Token de Actualizaci칩n Primario** por el m칩dulo LSASS CloudAP y se entrega al dispositivo. Con el PRT tambi칠n se entrega la **clave de sesi칩n cifrada para que solo el dispositivo pueda descifrarla** (usando la clave p칰blica de la clave de transporte) y es **necesaria para usar el PRT.**

Para m치s informaci칩n sobre qu칠 es un PRT, consulta:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - M칩dulo de Plataforma de Confianza

El **TPM** **protege** contra la **extracci칩n** de claves de un dispositivo apagado (si est치 protegido por PIN) y de la extracci칩n del material privado de la capa del sistema operativo.\
Pero **no protege** contra el **sniffing** de la conexi칩n f칤sica entre el TPM y la CPU o **el uso del material criptogr치fico** en el TPM mientras el sistema est치 en funcionamiento desde un proceso con derechos de **SYSTEM**.

Si revisas la siguiente p치gina, ver치s que **robar el PRT** puede ser utilizado para acceder como el **usuario**, lo cual es excelente porque el **PRT se encuentra en los dispositivos**, por lo que puede ser robado de ellos (o si no es robado, abusado para generar nuevas claves de firma):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registrando un dispositivo con tokens SSO

Ser칤a posible que un atacante solicitara un token para el servicio de registro de dispositivos de Microsoft desde el dispositivo comprometido y lo registrara:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Lo que te dar치 un **certificado que puedes usar para solicitar PRTs en el futuro**. Por lo tanto, manteniendo la persistencia y **eludiendo MFA** porque el token PRT original utilizado para registrar el nuevo dispositivo **ya ten칤a permisos de MFA otorgados**.

{% hint style="success" %}
Ten en cuenta que para realizar este ataque necesitar치s permisos para **registrar nuevos dispositivos**. Adem치s, registrar un dispositivo no significa que el dispositivo ser치 **autorizado para inscribirse en Intune**.
{% endhint %}

{% hint style="danger" %}
Este ataque fue corregido en septiembre de 2021, ya que ya no puedes registrar nuevos dispositivos utilizando tokens SSO. Sin embargo, a칰n es posible registrar dispositivos de manera leg칤tima (teniendo nombre de usuario, contrase침a y MFA si es necesario). Consulta: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Sobrescribiendo un ticket de dispositivo

Era posible **solicitar un ticket de dispositivo**, **sobrescribir** el actual del dispositivo y durante el flujo **robar el PRT** (por lo que no es necesario robarlo del TPM. Para m치s informaci칩n [**consulta esta charla**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Sin embargo, esto fue corregido.
{% endhint %}

## Sobrescribir la clave WHFB

[**Consulta las diapositivas originales aqu칤**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

Resumen del ataque:

* Es posible **sobrescribir** la clave **WHFB registrada** de un **dispositivo** a trav칠s de SSO
* **Elude la protecci칩n TPM** ya que la clave es **capturada durante la generaci칩n** de la nueva clave
* Esto tambi칠n proporciona **persistencia**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Los usuarios pueden modificar su propia propiedad searchableDeviceKey a trav칠s del Azure AD Graph, sin embargo, el atacante necesita tener un dispositivo en el inquilino (registrado sobre la marcha o habiendo robado el certificado + clave de un dispositivo leg칤timo) y un token de acceso v치lido para el AAD Graph.

Luego, es posible generar una nueva clave con:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
y luego PATCH la informaci칩n del searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

Es posible obtener un token de acceso de un usuario a trav칠s de **phishing de c칩digo de dispositivo** y abusar de los pasos anteriores para **robar su acceso**. Para m치s informaci칩n, consulta:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Referencias

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**repos de HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
