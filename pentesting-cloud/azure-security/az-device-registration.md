# Az - Registro de Dispositivo

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

Quando um dispositivo se junta ao AzureAD, um novo objeto √© criado no AzureAD.

Ao registrar um dispositivo, o **usu√°rio √© solicitado a fazer login com sua conta** (solicitando MFA se necess√°rio), em seguida, solicita tokens para o servi√ßo de registro de dispositivo e, por fim, pede uma confirma√ß√£o final.

Ent√£o, dois pares de chaves RSA s√£o gerados no dispositivo: A **chave do dispositivo** (**chave** p√∫blica) que √© enviada para o **AzureAD** e a **chave de transporte** (**chave** privada) que √© armazenada no TPM, se poss√≠vel.

Ent√£o, o **objeto** √© gerado no **AzureAD** (n√£o no Intune) e o AzureAD devolve ao dispositivo um **certificado** assinado por ele. Voc√™ pode verificar se o **dispositivo est√° associado ao AzureAD** e informa√ß√µes sobre o **certificado** (como se est√° protegido por TPM).
```bash
dsregcmd /status
```
Ap√≥s o registro do dispositivo, um **Primary Refresh Token** √© solicitado pelo m√≥dulo LSASS CloudAP e entregue ao dispositivo. Com o PRT tamb√©m √© entregue a **chave de sess√£o criptografada para que apenas o dispositivo possa descriptograf√°-la** (usando a chave p√∫blica da chave de transporte) e √© **necess√°ria para usar o PRT.**

Para mais informa√ß√µes sobre o que √© um PRT, consulte:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

O **TPM** **protege** contra a **extra√ß√£o** de chaves de um dispositivo desligado (se protegido por PIN) e contra a extra√ß√£o do material privado da camada do SO.\
Mas ele **n√£o protege** contra **sniffing** da conex√£o f√≠sica entre o TPM e a CPU ou **usando o material criptogr√°fico** no TPM enquanto o sistema est√° em execu√ß√£o a partir de um processo com direitos **SYSTEM**.

Se voc√™ verificar a p√°gina a seguir, ver√° que **roubar o PRT** pode ser usado para acessar como um **usu√°rio**, o que √© √≥timo porque o **PRT est√° localizado nos dispositivos**, ent√£o pode ser roubado deles (ou se n√£o for roubado, abusado para gerar novas chaves de assinatura):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registrando um dispositivo com tokens SSO

Seria poss√≠vel para um atacante solicitar um token para o servi√ßo de registro de dispositivos da Microsoft a partir do dispositivo comprometido e registr√°-lo:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Qual fornecer√° um **certificado que voc√™ pode usar para solicitar PRTs no futuro**. Portanto, mantendo a persist√™ncia e **contornando o MFA** porque o token PRT original usado para registrar o novo dispositivo **j√° tinha permiss√µes de MFA concedidas**.

{% hint style="success" %}
Observe que, para realizar este ataque, voc√™ precisar√° de permiss√µes para **registrar novos dispositivos**. Al√©m disso, registrar um dispositivo n√£o significa que o dispositivo ser√° **permitido para se inscrever no Intune**.
{% endhint %}

{% hint style="danger" %}
Este ataque foi corrigido em setembro de 2021, pois voc√™ n√£o pode mais registrar novos dispositivos usando tokens SSO. No entanto, ainda √© poss√≠vel registrar dispositivos de maneira leg√≠tima (tendo nome de usu√°rio, senha e MFA, se necess√°rio). Confira: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Sobrescrevendo um ticket de dispositivo

Era poss√≠vel **solicitar um ticket de dispositivo**, **sobrescrever** o atual do dispositivo e, durante o fluxo, **roubar o PRT** (portanto, n√£o h√° necessidade de roub√°-lo do TPM. Para mais informa√ß√µes, [**verifique esta palestra**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
No entanto, isso foi corrigido.
{% endhint %}

## Sobrescrever chave WHFB

[**Verifique os slides originais aqui**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

Resumo do ataque:

* √â poss√≠vel **sobrescrever** a chave **WHFB registrada** de um **dispositivo** via SSO
* Isso **derrota a prote√ß√£o do TPM**, pois a chave √© **capturada durante a gera√ß√£o** da nova chave
* Isso tamb√©m fornece **persist√™ncia**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Os usu√°rios podem modificar sua pr√≥pria propriedade searchableDeviceKey via Azure AD Graph, no entanto, o atacante precisa ter um dispositivo no locat√°rio (registrado rapidamente ou tendo roubado o cert + chave de um dispositivo leg√≠timo) e um token de acesso v√°lido para o AAD Graph.

Ent√£o, √© poss√≠vel gerar uma nova chave com:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
e ent√£o PATCH as informa√ß√µes do searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

√â poss√≠vel obter um token de acesso de um usu√°rio via **device code phishing** e abusar das etapas anteriores para **roubar seu acesso**. Para mais informa√ß√µes, consulte:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Refer√™ncias

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
