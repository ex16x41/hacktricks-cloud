# Az - è®¾å¤‡æ³¨å†Œ

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

å½“è®¾å¤‡åŠ å…¥ AzureAD æ—¶ï¼Œä¼šåœ¨ AzureAD ä¸­åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ã€‚

åœ¨æ³¨å†Œè®¾å¤‡æ—¶ï¼Œ**ç”¨æˆ·éœ€è¦ä½¿ç”¨ä»–çš„è´¦æˆ·ç™»å½•**ï¼ˆå¦‚æœ‰éœ€è¦ä¼šè¦æ±‚ MFAï¼‰ï¼Œç„¶åè¯·æ±‚è®¾å¤‡æ³¨å†ŒæœåŠ¡çš„ä»¤ç‰Œï¼Œæœ€åè¯¢é—®æœ€ç»ˆç¡®è®¤æç¤ºã€‚

ç„¶åï¼Œåœ¨è®¾å¤‡ä¸­ç”Ÿæˆä¸¤ä¸ª RSA å¯†é’¥å¯¹ï¼š**è®¾å¤‡å¯†é’¥**ï¼ˆ**å…¬**é’¥ï¼‰å‘é€åˆ° **AzureAD**ï¼Œ**ä¼ è¾“**å¯†é’¥ï¼ˆ**ç§**é’¥ï¼‰å¦‚æœå¯èƒ½åˆ™å­˜å‚¨åœ¨ TPM ä¸­ã€‚

æ¥ç€ï¼Œåœ¨ **AzureAD** ä¸­ç”Ÿæˆ **å¯¹è±¡**ï¼ˆè€Œä¸æ˜¯åœ¨ Intune ä¸­ï¼‰ï¼ŒAzureAD ä¼šå‘è®¾å¤‡è¿”å›ä¸€ä¸ªç”±å…¶ç­¾åçš„ **è¯ä¹¦**ã€‚æ‚¨å¯ä»¥æ£€æŸ¥ **è®¾å¤‡æ˜¯å¦å·²åŠ å…¥ AzureAD** ä»¥åŠæœ‰å…³ **è¯ä¹¦** çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚æ˜¯å¦ç”± TPM ä¿æŠ¤ï¼‰ã€‚
```bash
dsregcmd /status
```
åœ¨è®¾å¤‡æ³¨å†Œåï¼Œ**LSASS CloudAP**æ¨¡å—è¯·æ±‚ä¸€ä¸ª**ä¸»åˆ·æ–°ä»¤ç‰Œ**å¹¶å°†å…¶æä¾›ç»™è®¾å¤‡ã€‚ä¸PRTä¸€èµ·äº¤ä»˜çš„è¿˜æœ‰**ä¼šè¯å¯†é’¥ï¼Œåªæœ‰è®¾å¤‡å¯ä»¥è§£å¯†**ï¼ˆä½¿ç”¨ä¼ è¾“å¯†é’¥çš„å…¬é’¥ï¼‰ï¼Œå¹¶ä¸”**ä½¿ç”¨PRTæ˜¯å¿…éœ€çš„ã€‚**

æœ‰å…³PRTçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - å—ä¿¡ä»»çš„å¹³å°æ¨¡å—

**TPM** **ä¿æŠ¤**é˜²æ­¢ä»å…³é—­çš„è®¾å¤‡ä¸­**æå–**å¯†é’¥ï¼ˆå¦‚æœç”±PINä¿æŠ¤ï¼‰ä»¥åŠä»æ“ä½œç³»ç»Ÿå±‚æå–ç§æœ‰ææ–™ã€‚\
ä½†å®ƒ**ä¸ä¿æŠ¤**é˜²æ­¢**å—…æ¢**TPMä¸CPUä¹‹é—´çš„ç‰©ç†è¿æ¥æˆ–**åœ¨ç³»ç»Ÿè¿è¡Œæ—¶ä½¿ç”¨TPMä¸­çš„åŠ å¯†ææ–™**ï¼Œè¿™å¯èƒ½æ¥è‡ªå…·æœ‰**SYSTEM**æƒé™çš„è¿›ç¨‹ã€‚

å¦‚æœæ‚¨æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼Œæ‚¨å°†çœ‹åˆ°**çªƒå–PRT**å¯ä»¥ç”¨äºåƒ**ç”¨æˆ·**ä¸€æ ·è®¿é—®ï¼Œè¿™å¾ˆå¥½ï¼Œå› ä¸º**PRTä½äºè®¾å¤‡ä¸Š**ï¼Œå› æ­¤å¯ä»¥ä»å®ƒä»¬ä¸­çªƒå–ï¼ˆæˆ–è€…å¦‚æœæ²¡æœ‰è¢«çªƒå–ï¼Œåˆ™è¢«æ»¥ç”¨ä»¥ç”Ÿæˆæ–°çš„ç­¾åå¯†é’¥ï¼‰ï¼š

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## ä½¿ç”¨SSOä»¤ç‰Œæ³¨å†Œè®¾å¤‡

æ”»å‡»è€…å¯ä»¥ä»è¢«æ”»é™·çš„è®¾å¤‡è¯·æ±‚Microsoftè®¾å¤‡æ³¨å†ŒæœåŠ¡çš„ä»¤ç‰Œå¹¶æ³¨å†Œå®ƒã€‚
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
å°†ä¸ºæ‚¨æä¾›ä¸€ä¸ª**å¯ä»¥ç”¨äºå°†æ¥è¯·æ±‚PRTçš„è¯ä¹¦**ã€‚å› æ­¤ï¼Œä¿æŒæŒä¹…æ€§å¹¶**ç»•è¿‡MFA**ï¼Œå› ä¸ºç”¨äºæ³¨å†Œæ–°è®¾å¤‡çš„åŸå§‹PRTä»¤ç‰Œ**å·²ç»è·å¾—äº†MFAæƒé™**ã€‚

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œè¦æ‰§è¡Œæ­¤æ”»å‡»ï¼Œæ‚¨éœ€è¦æœ‰**æ³¨å†Œæ–°è®¾å¤‡**çš„æƒé™ã€‚æ­¤å¤–ï¼Œæ³¨å†Œè®¾å¤‡å¹¶ä¸æ„å‘³ç€è¯¥è®¾å¤‡å°†è¢«**å…è®¸æ³¨å†Œåˆ°Intune**ã€‚
{% endhint %}

{% hint style="danger" %}
æ­¤æ”»å‡»åœ¨2021å¹´9æœˆå·²è¢«ä¿®å¤ï¼Œå› ä¸ºæ‚¨æ— æ³•å†ä½¿ç”¨SSOä»¤ç‰Œæ³¨å†Œæ–°è®¾å¤‡ã€‚ç„¶è€Œï¼Œä»ç„¶å¯ä»¥ä»¥åˆæ³•æ–¹å¼æ³¨å†Œè®¾å¤‡ï¼ˆå¦‚æœéœ€è¦ï¼Œæä¾›ç”¨æˆ·åã€å¯†ç å’ŒMFAï¼‰ã€‚è¯·æŸ¥çœ‹ï¼š[**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md)ã€‚
{% endhint %}

## è¦†ç›–è®¾å¤‡ç¥¨è¯

å¯ä»¥**è¯·æ±‚è®¾å¤‡ç¥¨è¯**ï¼Œ**è¦†ç›–**è®¾å¤‡çš„å½“å‰ç¥¨è¯ï¼Œå¹¶åœ¨æµç¨‹ä¸­**çªƒå–PRT**ï¼ˆå› æ­¤æ— éœ€ä»TPMçªƒå–å®ƒã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·[**æŸ¥çœ‹æ­¤æ¼”è®²**](https://youtu.be/BduCn8cLV1A)ã€‚

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
ç„¶è€Œï¼Œè¿™å·²è¢«ä¿®å¤ã€‚
{% endhint %}

## è¦†ç›–WHFBå¯†é’¥

[**åœ¨è¿™é‡ŒæŸ¥çœ‹åŸå§‹å¹»ç¯ç‰‡**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

æ”»å‡»æ‘˜è¦ï¼š

* å¯ä»¥é€šè¿‡SSO**è¦†ç›–**æ¥è‡ª**è®¾å¤‡**çš„**æ³¨å†ŒWHFB**å¯†é’¥
* å®ƒ**å‡»è´¥TPMä¿æŠ¤**ï¼Œå› ä¸ºå¯†é’¥åœ¨æ–°å¯†é’¥ç”Ÿæˆè¿‡ç¨‹ä¸­è¢«**å—…æ¢**
* è¿™ä¹Ÿæä¾›äº†**æŒä¹…æ€§**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

ç”¨æˆ·å¯ä»¥é€šè¿‡Azure AD Graphä¿®æ”¹è‡ªå·±çš„searchableDeviceKeyå±æ€§ï¼Œä½†æ˜¯ï¼Œæ”»å‡»è€…éœ€è¦åœ¨ç§Ÿæˆ·ä¸­æ‹¥æœ‰ä¸€ä¸ªè®¾å¤‡ï¼ˆåŠ¨æ€æ³¨å†Œæˆ–ä»åˆæ³•è®¾å¤‡çªƒå–è¯ä¹¦å’Œå¯†é’¥ï¼‰ä»¥åŠæœ‰æ•ˆçš„AAD Graphè®¿é—®ä»¤ç‰Œã€‚

ç„¶åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ç”Ÿæˆæ–°å¯†é’¥ï¼š
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
ç„¶åPATCHå¯æœç´¢çš„DeviceKeyçš„ä¿¡æ¯ï¼š

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

å¯ä»¥é€šè¿‡**è®¾å¤‡ä»£ç é’“é±¼**ä»ç”¨æˆ·é‚£é‡Œè·å–è®¿é—®ä»¤ç‰Œï¼Œå¹¶åˆ©ç”¨ä¹‹å‰çš„æ­¥éª¤**çªƒå–ä»–çš„è®¿é—®æƒé™**ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## å‚è€ƒæ–‡çŒ®

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æ”»å‡»ï¼š<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶(ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æ”»å‡»ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶(GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
