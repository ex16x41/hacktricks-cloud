# Az - Enregistrement de l'appareil

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informations de base

Lorsqu'un appareil rejoint AzureAD, un nouvel objet est cr√©√© dans AzureAD.

Lors de l'enregistrement d'un appareil, **l'utilisateur est invit√© √† se connecter avec son compte** (demandant une MFA si n√©cessaire), puis il demande des jetons pour le service d'enregistrement de l'appareil et demande ensuite une confirmation finale.

Ensuite, deux paires de cl√©s RSA sont g√©n√©r√©es dans l'appareil : La **cl√© de l'appareil** (**cl√© publique**) qui est envoy√©e √† **AzureAD** et la **cl√© de transport** (**cl√© priv√©e**) qui est stock√©e dans le TPM si possible.

Ensuite, l'**objet** est g√©n√©r√© dans **AzureAD** (pas dans Intune) et AzureAD renvoie √† l'appareil un **certificat** sign√© par lui. Vous pouvez v√©rifier que l'**appareil est joint √† AzureAD** et obtenir des informations sur le **certificat** (comme s'il est prot√©g√© par TPM).
```bash
dsregcmd /status
```
Apr√®s l'enregistrement de l'appareil, un **Primary Refresh Token** est demand√© par le module LSASS CloudAP et donn√© √† l'appareil. Avec le PRT est √©galement livr√© la **cl√© de session chiffr√©e afin que seul l'appareil puisse la d√©chiffrer** (en utilisant la cl√© publique de la cl√© de transport) et elle est **n√©cessaire pour utiliser le PRT.**

Pour plus d'informations sur ce qu'est un PRT, consultez :

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

Le **TPM** **prot√®ge** contre l'**extraction** de cl√©s d'un appareil √©teint (s'il est prot√©g√© par un code PIN) et contre l'extraction du mat√©riel priv√© de la couche OS.\
Mais il **ne prot√®ge pas** contre le **sniffing** de la connexion physique entre le TPM et le CPU ou **l'utilisation du mat√©riel cryptographique** dans le TPM pendant que le syst√®me fonctionne √† partir d'un processus avec des droits **SYSTEM**.

Si vous consultez la page suivante, vous verrez que **voler le PRT** peut √™tre utilis√© pour acc√©der comme un **utilisateur**, ce qui est g√©nial car le **PRT est situ√© sur les appareils**, donc il peut √™tre vol√© √† partir d'eux (ou s'il n'est pas vol√©, abus√© pour g√©n√©rer de nouvelles cl√©s de signature) :

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Enregistrement d'un appareil avec des jetons SSO

Il serait possible pour un attaquant de demander un jeton pour le service d'enregistrement des appareils Microsoft depuis l'appareil compromis et de l'enregistrer :
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Ce qui vous donnera un **certificat que vous pouvez utiliser pour demander des PRT √† l'avenir**. Par cons√©quent, maintenir la persistance et **contourner MFA** car le jeton PRT original utilis√© pour enregistrer le nouvel appareil **avait d√©j√† des autorisations MFA accord√©es**.

{% hint style="success" %}
Notez que pour effectuer cette attaque, vous aurez besoin d'autorisations pour **enregistrer de nouveaux appareils**. De plus, enregistrer un appareil ne signifie pas que l'appareil sera **autoris√© √† s'inscrire dans Intune**.
{% endhint %}

{% hint style="danger" %}
Cette attaque a √©t√© corrig√©e en septembre 2021 car vous ne pouvez plus enregistrer de nouveaux appareils en utilisant des jetons SSO. Cependant, il est toujours possible d'enregistrer des appareils de mani√®re l√©gitime (en ayant un nom d'utilisateur, un mot de passe et MFA si n√©cessaire). V√©rifiez : [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## √âcraser un ticket d'appareil

Il √©tait possible de **demander un ticket d'appareil**, **√©craser** l'actuel de l'appareil, et pendant le flux **voler le PRT** (donc pas besoin de le voler depuis le TPM. Pour plus d'infos [**v√©rifiez cette pr√©sentation**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Cependant, cela a √©t√© corrig√©.
{% endhint %}

## √âcraser la cl√© WHFB

[**V√©rifiez les diapositives originales ici**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)

R√©sum√© de l'attaque :

* Il est possible d'**√©craser** la cl√© **WHFB enregistr√©e** d'un **appareil** via SSO
* Cela **contourne la protection TPM** car la cl√© est **intercept√©e lors de la g√©n√©ration** de la nouvelle cl√©
* Cela fournit √©galement **de la persistance**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Les utilisateurs peuvent modifier leur propre propri√©t√© searchableDeviceKey via l'Azure AD Graph, cependant, l'attaquant doit avoir un appareil dans le locataire (enregistr√© √† la vol√©e ou ayant vol√© un cert + cl√© d'un appareil l√©gitime) et un jeton d'acc√®s valide pour l'AAD Graph.

Ensuite, il est possible de g√©n√©rer une nouvelle cl√© avec :
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
et ensuite PATCH les informations de searchableDeviceKey :

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

Il est possible d'obtenir un jeton d'acc√®s d'un utilisateur via **device code phishing** et d'abuser des √©tapes pr√©c√©dentes pour **voler son acc√®s**. Pour plus d'informations, consultez :

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## R√©f√©rences

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay_58QubY)

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
