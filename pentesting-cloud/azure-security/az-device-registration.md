# Az - Device Registration

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

å½“è®¾å¤‡åŠ å…¥ AzureAD æ—¶ï¼Œä¼šåœ¨ AzureAD ä¸­åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ã€‚

æ³¨å†Œè®¾å¤‡æ—¶ï¼Œ**ç”¨æˆ·éœ€è¦ä½¿ç”¨å…¶è´¦æˆ·ç™»å½•**ï¼ˆå¦‚æœ‰éœ€è¦ä¼šè¦æ±‚ MFAï¼‰ï¼Œç„¶åè¯·æ±‚è®¾å¤‡æ³¨å†ŒæœåŠ¡çš„ä»¤ç‰Œï¼Œæœ€åä¼šå¼¹å‡ºä¸€ä¸ªç¡®è®¤æç¤ºã€‚

ç„¶åï¼Œåœ¨è®¾å¤‡ä¸­ç”Ÿæˆä¸¤ä¸ª RSA å¯†é’¥å¯¹ï¼š**è®¾å¤‡å¯†é’¥**ï¼ˆ**å…¬é’¥**ï¼‰ï¼Œå‘é€åˆ° **AzureAD**ï¼Œä»¥åŠ **ä¼ è¾“å¯†é’¥**ï¼ˆ**ç§é’¥**ï¼‰ï¼Œå¦‚æœå¯èƒ½çš„è¯å­˜å‚¨åœ¨ TPM ä¸­ã€‚

ç„¶åï¼Œåœ¨ **AzureAD**ï¼ˆè€Œä¸æ˜¯ Intuneï¼‰ä¸­ç”Ÿæˆ **å¯¹è±¡**ï¼ŒAzureAD ä¼šè¿”å›ç»™è®¾å¤‡ä¸€ä¸ªç”±å…¶ç­¾åçš„ **è¯ä¹¦**ã€‚ä½ å¯ä»¥æ£€æŸ¥ **è®¾å¤‡æ˜¯å¦å·²åŠ å…¥ AzureAD** ä»¥åŠå…³äº **è¯ä¹¦** çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚æ˜¯å¦å— TPM ä¿æŠ¤ï¼‰ã€‚
```bash
dsregcmd /status
```
è®¾å¤‡æ³¨å†Œåï¼Œ**Primary Refresh Token** ç”± LSASS CloudAP æ¨¡å—è¯·æ±‚å¹¶äº¤ä»˜ç»™è®¾å¤‡ã€‚PRT è¿˜ä¼šäº¤ä»˜**ä¼šè¯å¯†é’¥ï¼Œè¯¥å¯†é’¥åŠ å¯†ååªæœ‰è®¾å¤‡å¯ä»¥è§£å¯†**ï¼ˆä½¿ç”¨ä¼ è¾“å¯†é’¥çš„å…¬é’¥ï¼‰ï¼Œå¹¶ä¸”**éœ€è¦ä½¿ç”¨ PRTã€‚**

æœ‰å…³ PRT çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

**TPM** **ä¿æŠ¤**è®¾å¤‡åœ¨æ–­ç”µçŠ¶æ€ä¸‹ï¼ˆå¦‚æœå— PIN ä¿æŠ¤ï¼‰å…å—å¯†é’¥**æå–**ï¼Œä»¥åŠé˜²æ­¢ä»æ“ä½œç³»ç»Ÿå±‚æå–ç§æœ‰ææ–™ã€‚\
ä½†å®ƒ**ä¸èƒ½ä¿æŠ¤**å…å—**å—…æ¢** TPM å’Œ CPU ä¹‹é—´çš„ç‰©ç†è¿æ¥ï¼Œæˆ–åœ¨ç³»ç»Ÿè¿è¡Œæ—¶ä»å…·æœ‰**SYSTEM** æƒé™çš„è¿›ç¨‹ä¸­**ä½¿ç”¨ TPM ä¸­çš„åŠ å¯†ææ–™**ã€‚

å¦‚æœæŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼Œæ‚¨ä¼šå‘ç°**çªƒå– PRT** å¯ä»¥åƒç”¨æˆ·ä¸€æ ·è®¿é—®ï¼Œè¿™å¾ˆæ£’ï¼Œå› ä¸º**PRT ä½äºè®¾å¤‡ä¸Š**ï¼Œå› æ­¤å¯ä»¥ä»è®¾å¤‡ä¸­çªƒå–ï¼ˆæˆ–è€…å¦‚æœæ²¡æœ‰è¢«çªƒå–ï¼Œå¯ä»¥æ»¥ç”¨å®ƒæ¥ç”Ÿæˆæ–°çš„ç­¾åå¯†é’¥ï¼‰ï¼š

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## ä½¿ç”¨ SSO ä»¤ç‰Œæ³¨å†Œè®¾å¤‡

æ”»å‡»è€…å¯ä»¥ä»è¢«æ”»é™·çš„è®¾å¤‡è¯·æ±‚ Microsoft è®¾å¤‡æ³¨å†ŒæœåŠ¡çš„ä»¤ç‰Œå¹¶æ³¨å†Œå®ƒï¼š
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
è¿™å°†ç»™ä½ ä¸€ä¸ª**å¯ä»¥ç”¨æ¥è¯·æ±‚æœªæ¥PRTsçš„è¯ä¹¦**ã€‚å› æ­¤ï¼Œä¿æŒæŒä¹…æ€§å¹¶**ç»•è¿‡MFA**ï¼Œå› ä¸ºç”¨äºæ³¨å†Œæ–°è®¾å¤‡çš„åŸå§‹PRTä»¤ç‰Œ**å·²ç»æˆäºˆäº†MFAæƒé™**ã€‚

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œæ‰§è¡Œæ­¤æ”»å‡»éœ€è¦**æ³¨å†Œæ–°è®¾å¤‡çš„æƒé™**ã€‚æ­¤å¤–ï¼Œæ³¨å†Œè®¾å¤‡å¹¶ä¸æ„å‘³ç€è®¾å¤‡å°†è¢«**å…è®¸æ³¨å†Œåˆ°Intune**ã€‚
{% endhint %}

{% hint style="danger" %}
æ­¤æ”»å‡»åœ¨2021å¹´9æœˆå·²è¢«ä¿®å¤ï¼Œå› ä¸ºä½ ä¸èƒ½å†ä½¿ç”¨SSOä»¤ç‰Œæ³¨å†Œæ–°è®¾å¤‡ã€‚ç„¶è€Œï¼Œä»ç„¶å¯ä»¥é€šè¿‡åˆæ³•æ–¹å¼æ³¨å†Œè®¾å¤‡ï¼ˆéœ€è¦ç”¨æˆ·åã€å¯†ç å’ŒMFAï¼‰ã€‚æŸ¥çœ‹ï¼š[**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md)ã€‚
{% endhint %}

## è¦†ç›–è®¾å¤‡ç¥¨è¯

æ›¾ç»å¯ä»¥**è¯·æ±‚è®¾å¤‡ç¥¨è¯**ï¼Œ**è¦†ç›–**è®¾å¤‡çš„å½“å‰ç¥¨è¯ï¼Œå¹¶åœ¨æµç¨‹ä¸­**çªƒå–PRT**ï¼ˆå› æ­¤ä¸éœ€è¦ä»TPMä¸­çªƒå–ï¼‰ã€‚æ›´å¤šä¿¡æ¯è¯·[**æŸ¥çœ‹æ­¤æ¼”è®²**](https://youtu.be/BduCn8cLV1A)ã€‚

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
ç„¶è€Œï¼Œè¿™ä¸ªé—®é¢˜å·²è¢«ä¿®å¤ã€‚
{% endhint %}

## è¦†ç›–WHFBå¯†é’¥

[**æŸ¥çœ‹åŸå§‹å¹»ç¯ç‰‡**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

æ”»å‡»æ‘˜è¦ï¼š

* å¯ä»¥é€šè¿‡SSO**è¦†ç›–**è®¾å¤‡ä¸Š**æ³¨å†Œçš„WHFB**å¯†é’¥
* å®ƒ**å‡»è´¥äº†TPMä¿æŠ¤**ï¼Œå› ä¸ºå¯†é’¥åœ¨ç”Ÿæˆæ–°å¯†é’¥æ—¶**è¢«å—…æ¢**
* è¿™ä¹Ÿæä¾›äº†**æŒä¹…æ€§**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

ç”¨æˆ·å¯ä»¥é€šè¿‡Azure AD Graphä¿®æ”¹è‡ªå·±çš„searchableDeviceKeyå±æ€§ï¼Œç„¶è€Œï¼Œæ”»å‡»è€…éœ€è¦åœ¨ç§Ÿæˆ·ä¸­æœ‰ä¸€ä¸ªè®¾å¤‡ï¼ˆå³æ—¶æ³¨å†Œæˆ–ä»åˆæ³•è®¾å¤‡çªƒå–è¯ä¹¦+å¯†é’¥ï¼‰å’Œä¸€ä¸ªæœ‰æ•ˆçš„AAD Graphè®¿é—®ä»¤ç‰Œã€‚

ç„¶åï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°å¯†é’¥ï¼š
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
ç„¶å PATCH å¯æœç´¢è®¾å¤‡å¯†é’¥çš„ä¿¡æ¯ï¼š

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

å¯ä»¥é€šè¿‡ **device code phishing** ä»ç”¨æˆ·é‚£é‡Œè·å–è®¿é—®ä»¤ç‰Œï¼Œå¹¶æ»¥ç”¨å‰é¢çš„æ­¥éª¤æ¥ **çªƒå–ä»–çš„è®¿é—®æƒé™**ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## å‚è€ƒèµ„æ–™

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
