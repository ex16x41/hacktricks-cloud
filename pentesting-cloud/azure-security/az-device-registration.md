# Az - Cihaz Kaydı

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

## Temel Bilgiler

Bir cihaz AzureAD'ye katıldığında, AzureAD'de yeni bir nesne oluşturulur.

Bir cihaz kaydedilirken, **kullanıcıdan hesabıyla giriş yapması istenir** (gerekirse MFA istenir), ardından cihaz kaydı hizmeti için token'lar talep edilir ve son bir onay istemi sorulur.

Sonra, cihazda iki RSA anahtar çifti oluşturulur: **cihaz anahtarı** (**açık** anahtar) AzureAD'ye gönderilir ve **taşıma** anahtarı (**özel** anahtar) mümkünse TPM'de saklanır.

Ardından, **nesne** **AzureAD**'de (Intune'da değil) oluşturulur ve AzureAD, cihaza imzalı bir **sertifika** geri verir. **Cihazın AzureAD'ye katıldığını** ve **sertifika** hakkında (örneğin, TPM ile korunup korunmadığı) bilgi kontrol edebilirsiniz.
```bash
dsregcmd /status
```
Cihaz kaydı sonrasında **Primary Refresh Token** LSASS CloudAP modülü tarafından talep edilir ve cihaza verilir. PRT ile birlikte **sadece cihazın şifreleyebileceği şekilde şifrelenmiş oturum anahtarı** da teslim edilir (taşıma anahtarının açık anahtarını kullanarak) ve **PRT'yi kullanmak için gereklidir.**

PRT'nin ne olduğu hakkında daha fazla bilgi için kontrol edin:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Güvenilir Platform Modülü

**TPM**, kapalı bir cihazdan anahtar **çıkarma** ve OS katmanından özel materyali çıkarmaya karşı **korur** (PIN ile korunuyorsa).\
Ancak, **TPM ile CPU arasındaki fiziksel bağlantıyı dinlemek** veya sistem çalışırken **SYSTEM** haklarına sahip bir süreçten TPM'deki kriptografik materyali **kullanmak** karşısında **koruma sağlamaz.**

Aşağıdaki sayfayı kontrol ederseniz, **PRT'yi çalmanın** kullanıcı gibi erişim sağlamak için kullanılabileceğini göreceksiniz, bu harika çünkü **PRT cihazlarda bulunur**, bu nedenle onlardan çalınabilir (veya çalınmazsa yeni imza anahtarları oluşturmak için kötüye kullanılabilir):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## SSO jetonları ile bir cihaz kaydetme

Bir saldırganın, ele geçirilmiş bir cihazdan Microsoft cihaz kayıt hizmeti için bir jeton talep etmesi ve kaydetmesi mümkün olacaktır:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Hangi, **gelecekte PRT'ler talep etmek için kullanabileceğiniz bir sertifika** verecektir. Bu nedenle kalıcılığı sağlamakta ve **MFA'yı atlatmakta** çünkü yeni cihazı kaydetmek için kullanılan orijinal PRT token'ı **zaten MFA izinlerine sahipti**.

{% hint style="success" %}
Bu saldırıyı gerçekleştirmek için **yeni cihazlar kaydetme** izinlerine ihtiyacınız olacağını unutmayın. Ayrıca, bir cihaz kaydetmek, cihazın **Intune'a kaydolmasına izin verileceği** anlamına gelmez.
{% endhint %}

{% hint style="danger" %}
Bu saldırı Eylül 2021'de düzeltildi çünkü artık SSO token'ları kullanarak yeni cihazlar kaydedemezsiniz. Ancak, cihazları meşru bir şekilde (kullanıcı adı, şifre ve gerekirse MFA ile) kaydetmek hala mümkündür. Kontrol edin: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Bir cihaz biletini geçersiz kılma

**Bir cihaz bileti talep etmek**, cihazın mevcut biletini **geçersiz kılmak** ve akış sırasında **PRT'yi çalmak** mümkündü (bu nedenle TPM'den çalmaya gerek yok. Daha fazla bilgi için [**bu konuşmaya bakın**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Ancak, bu düzeltildi.
{% endhint %}

## WHFB anahtarını geçersiz kılma

[**Orijinal slaytlara buradan bakın**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)

Saldırı özeti:

* **SSO** aracılığıyla bir **cihazdan** **kayıtlı WHFB** anahtarını **geçersiz kılmak** mümkündür
* Anahtar, yeni anahtarın **üretimi sırasında** **sniff** edildiği için **TPM korumasını aşar**
* Bu ayrıca **kalıcılık** sağlar

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Kullanıcılar, Azure AD Graph aracılığıyla kendi searchableDeviceKey özelliklerini değiştirebilir, ancak saldırganın kiracıda bir cihaza (anlık olarak kaydedilmiş veya meşru bir cihazdan çalınmış sertifika + anahtar) ve AAD Graph için geçerli bir erişim token'ına sahip olması gerekir.

Sonra, yeni bir anahtar oluşturmak mümkündür:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
ve ardından searchableDeviceKey'in bilgilerini PATCH yapın:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

**Cihaz kodu phishing** ile bir kullanıcıdan erişim token'ı almak ve önceki adımları **kullanarak erişimini çalmak** mümkündür. Daha fazla bilgi için kontrol edin:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Referanslar

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
