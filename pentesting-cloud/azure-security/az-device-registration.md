# Az - Device Registration

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## ê¸°ë³¸ ì •ë³´

ì¥ì¹˜ê°€ AzureADì— ê°€ì…ë˜ë©´ AzureADì— ìƒˆ ê°ì²´ê°€ ìƒì„±ë©ë‹ˆë‹¤.

ì¥ì¹˜ë¥¼ ë“±ë¡í•  ë•Œ, **ì‚¬ìš©ìëŠ” ìì‹ ì˜ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë¼ëŠ” ìš”ì²­ì„ ë°›ìŠµë‹ˆë‹¤** (í•„ìš”í•œ ê²½ìš° MFA ìš”ì²­), ê·¸ëŸ° ë‹¤ìŒ ì¥ì¹˜ ë“±ë¡ ì„œë¹„ìŠ¤ì— ëŒ€í•œ í† í°ì„ ìš”ì²­í•˜ê³  ë§ˆì§€ë§‰ í™•ì¸ í”„ë¡¬í”„íŠ¸ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ, ì¥ì¹˜ì—ì„œ ë‘ ê°œì˜ RSA í‚¤ ìŒì´ ìƒì„±ë©ë‹ˆë‹¤: **ì¥ì¹˜ í‚¤** (**ê³µê°œ** í‚¤)ëŠ” **AzureAD**ë¡œ ì „ì†¡ë˜ê³  **ì „ì†¡** í‚¤ (**ê°œì¸** í‚¤)ëŠ” ê°€ëŠ¥í•˜ë©´ TPMì— ì €ì¥ë©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ, **ê°ì²´**ê°€ **AzureAD** (Intuneì´ ì•„ë‹˜)ì—ì„œ ìƒì„±ë˜ê³  AzureADëŠ” ì¥ì¹˜ì— ì˜í•´ ì„œëª…ëœ **ì¸ì¦ì„œ**ë¥¼ ì¥ì¹˜ì— ë°˜í™˜í•©ë‹ˆë‹¤. **ì¥ì¹˜ê°€ AzureADì— ê°€ì…ë˜ì—ˆëŠ”ì§€**ì™€ **ì¸ì¦ì„œ**ì— ëŒ€í•œ ì •ë³´ (ì˜ˆ: TPMìœ¼ë¡œ ë³´í˜¸ë˜ëŠ”ì§€ ì—¬ë¶€)ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.:
```bash
dsregcmd /status
```
ê¸°ê¸° ë“±ë¡ í›„ **Primary Refresh Token**ì´ LSASS CloudAP ëª¨ë“ˆì— ì˜í•´ ìš”ì²­ë˜ê³  ê¸°ê¸°ì— ì œê³µë©ë‹ˆë‹¤. PRTì™€ í•¨ê»˜ **ì„¸ì…˜ í‚¤ê°€ ì•”í˜¸í™”ë˜ì–´ ê¸°ê¸°ë§Œì´ ì´ë¥¼ í•´ë…í•  ìˆ˜ ìˆë„ë¡** (ì „ì†¡ í‚¤ì˜ ê³µê°œ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬) ì „ë‹¬ë˜ë©°, ì´ëŠ” **PRTë¥¼ ì‚¬ìš©í•˜ëŠ” ë° í•„ìš”í•©ë‹ˆë‹¤.**

PRTì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” í”Œë«í¼ ëª¨ë“ˆ

**TPM**ì€ PINìœ¼ë¡œ ë³´í˜¸ëœ ê²½ìš° ì „ì›ì´ êº¼ì§„ ê¸°ê¸°ì—ì„œ í‚¤ **ì¶”ì¶œ**ì„ ë°©ì§€í•˜ê³ , OS ê³„ì¸µì—ì„œ ê°œì¸ ìë£Œë¥¼ ì¶”ì¶œí•˜ëŠ” ê²ƒì„ **ë³´í˜¸**í•©ë‹ˆë‹¤.\
í•˜ì§€ë§Œ **TPMê³¼ CPU ê°„ì˜ ë¬¼ë¦¬ì  ì—°ê²°ì„ ìŠ¤ë‹ˆí•‘**í•˜ê±°ë‚˜ ì‹œìŠ¤í…œì´ ì‹¤í–‰ ì¤‘ì¼ ë•Œ **SYSTEM ê¶Œí•œì„ ê°€ì§„ í”„ë¡œì„¸ìŠ¤ì—ì„œ TPMì˜ ì•”í˜¸í™” ìë£Œë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒ**ì„ **ë³´í˜¸í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.**

ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ë©´ **PRTë¥¼ í›”ì¹˜ëŠ” ê²ƒ**ì´ **ì‚¬ìš©ì**ì²˜ëŸ¼ ì ‘ê·¼í•˜ëŠ” ë° ì‚¬ìš©ë  ìˆ˜ ìˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **PRTê°€ ê¸°ê¸°ì— ìœ„ì¹˜**í•˜ë¯€ë¡œ ê¸°ê¸°ì—ì„œ ì´ë¥¼ í›”ì¹  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤ (ë˜ëŠ” í›”ì¹˜ì§€ ì•Šë”ë¼ë„ ìƒˆë¡œìš´ ì„œëª… í‚¤ë¥¼ ìƒì„±í•˜ëŠ” ë° ì•…ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## SSO í† í°ì„ ì‚¬ìš©í•˜ì—¬ ê¸°ê¸° ë“±ë¡

ê³µê²©ìê°€ ì†ìƒëœ ê¸°ê¸°ì—ì„œ Microsoft ê¸°ê¸° ë“±ë¡ ì„œë¹„ìŠ¤ì— ëŒ€í•œ í† í°ì„ ìš”ì²­í•˜ê³  ì´ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Which will give you a **certificate you can use to ask for PRTs in the future**. Therefore maintaining persistence and **bypassing MFA** because the original PRT token used to register the new device **already had MFA permissions granted**.

{% hint style="success" %}
ì´ ê³µê²©ì„ ìˆ˜í–‰í•˜ë ¤ë©´ **ìƒˆ ì¥ì¹˜ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ**ì´ í•„ìš”í•©ë‹ˆë‹¤. ë˜í•œ, ì¥ì¹˜ë¥¼ ë“±ë¡í•œë‹¤ê³  í•´ì„œ ê·¸ ì¥ì¹˜ê°€ **Intuneì— ë“±ë¡ë  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤**.
{% endhint %}

{% hint style="danger" %}
ì´ ê³µê²©ì€ 2021ë…„ 9ì›”ì— ìˆ˜ì •ë˜ì—ˆìœ¼ë©°, ì´ì œ SSO í† í°ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆ ì¥ì¹˜ë¥¼ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì—¬ì „íˆ í•©ë²•ì ì¸ ë°©ë²•ìœ¼ë¡œ ì¥ì¹˜ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì‚¬ìš©ì ì´ë¦„, ë¹„ë°€ë²ˆí˜¸ ë° í•„ìš”í•œ ê²½ìš° MFA í¬í•¨). í™•ì¸: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Overwriting a device ticket

**ì¥ì¹˜ í‹°ì¼“ì„ ìš”ì²­**í•˜ê³ , í˜„ì¬ ì¥ì¹˜ì˜ í‹°ì¼“ì„ **ë®ì–´ì“°ë©°**, ì´ ê³¼ì •ì—ì„œ **PRTë¥¼ íƒˆì·¨**í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤ (ë”°ë¼ì„œ TPMì—ì„œ íƒˆì·¨í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [**ì´ ê°•ì—°**](https://youtu.be/BduCn8cLV1A)ì„ ì°¸ì¡°í•˜ì„¸ìš”).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
ê·¸ëŸ¬ë‚˜, ì´ê²ƒì€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
{% endhint %}

## Overwrite WHFB key

[**ì›ë³¸ ìŠ¬ë¼ì´ë“œë¥¼ ì—¬ê¸°ì—ì„œ í™•ì¸í•˜ì„¸ìš”**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

ê³µê²© ìš”ì•½:

* SSOë¥¼ í†µí•´ **ì¥ì¹˜**ì˜ **ë“±ë¡ëœ WHFB** í‚¤ë¥¼ **ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤**
* ìƒˆë¡œìš´ í‚¤ ìƒì„± ì¤‘ **í‚¤ë¥¼ ìŠ¤ë‹ˆí•‘**í•˜ì—¬ **TPM ë³´í˜¸ë¥¼ ë¬´ë ¥í™”**í•©ë‹ˆë‹¤
* ì´ëŠ” ë˜í•œ **ì§€ì†ì„±ì„ ì œê³µí•©ë‹ˆë‹¤**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

ì‚¬ìš©ìëŠ” Azure AD Graphë¥¼ í†µí•´ ìì‹ ì˜ searchableDeviceKey ì†ì„±ì„ ìˆ˜ì •í•  ìˆ˜ ìˆì§€ë§Œ, ê³µê²©ìëŠ” í…Œë„ŒíŠ¸ì— ì¥ì¹˜ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤ (ì¦‰ì„ì—ì„œ ë“±ë¡í•˜ê±°ë‚˜ í•©ë²•ì ì¸ ì¥ì¹˜ì—ì„œ ì¸ì¦ì„œ + í‚¤ë¥¼ íƒˆì·¨). ê·¸ë¦¬ê³  AAD Graphì— ëŒ€í•œ ìœ íš¨í•œ ì•¡ì„¸ìŠ¤ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ, ë‹¤ìŒì„ í†µí•´ ìƒˆ í‚¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
ê·¸ë¦¬ê³  ë‚˜ì„œ searchableDeviceKeyì˜ ì •ë³´ë¥¼ PATCHí•©ë‹ˆë‹¤:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

**device code phishing**ì„ í†µí•´ ì‚¬ìš©ìë¡œë¶€í„° ì•¡ì„¸ìŠ¤ í† í°ì„ ì–»ê³  ì´ì „ ë‹¨ê³„ë¥¼ ì•…ìš©í•˜ì—¬ **ì•¡ì„¸ìŠ¤ë¥¼ íƒˆì·¨**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒì„ ì°¸ì¡°í•˜ì„¸ìš”:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## ì°¸ê³  ìë£Œ

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
AWS Hacking í•™ìŠµ ë° ì—°ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking í•™ìŠµ ë° ì—°ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* **PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
