# Az - Cihaz KaydÄ±

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

Bir cihaz AzureAD'ye katÄ±ldÄ±ÄŸÄ±nda, AzureAD'de yeni bir nesne oluÅŸturulur.

Bir cihaz kaydedilirken, **kullanÄ±cÄ±dan hesabÄ±yla giriÅŸ yapmasÄ± istenir** (gerekirse MFA istenir), ardÄ±ndan cihaz kaydÄ± hizmeti iÃ§in token'lar talep edilir ve son bir onay istemi sorulur.

Sonra, cihazda iki RSA anahtar Ã§ifti oluÅŸturulur: **cihaz anahtarÄ±** (**aÃ§Ä±k** anahtar) AzureAD'ye gÃ¶nderilir ve **taÅŸÄ±ma** anahtarÄ± (**Ã¶zel** anahtar) mÃ¼mkÃ¼nse TPM'de saklanÄ±r.

ArdÄ±ndan, **nesne** **AzureAD**'de (Intune'da deÄŸil) oluÅŸturulur ve AzureAD, cihaza imzalÄ± bir **sertifika** geri verir. **CihazÄ±n AzureAD'ye katÄ±ldÄ±ÄŸÄ±nÄ±** ve **sertifika** hakkÄ±nda (Ã¶rneÄŸin, TPM ile korunup korunmadÄ±ÄŸÄ±) bilgi kontrol edebilirsiniz.
```bash
dsregcmd /status
```
Cihaz kaydÄ± sonrasÄ±nda **Primary Refresh Token** LSASS CloudAP modÃ¼lÃ¼ tarafÄ±ndan talep edilir ve cihaza verilir. PRT ile birlikte **sadece cihazÄ±n ÅŸifreleyebileceÄŸi ÅŸekilde ÅŸifrelenmiÅŸ oturum anahtarÄ±** da teslim edilir (taÅŸÄ±ma anahtarÄ±nÄ±n aÃ§Ä±k anahtarÄ±nÄ± kullanarak) ve **PRT'yi kullanmak iÃ§in gereklidir.**

PRT'nin ne olduÄŸu hakkÄ±nda daha fazla bilgi iÃ§in kontrol edin:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - GÃ¼venilir Platform ModÃ¼lÃ¼

**TPM**, kapalÄ± bir cihazdan anahtar **Ã§Ä±karma** ve OS katmanÄ±ndan Ã¶zel materyali Ã§Ä±karmaya karÅŸÄ± **korur** (PIN ile korunuyorsa).\
Ancak, **TPM ile CPU arasÄ±ndaki fiziksel baÄŸlantÄ±yÄ± dinlemek** veya sistem Ã§alÄ±ÅŸÄ±rken **SYSTEM** haklarÄ±na sahip bir sÃ¼reÃ§ten TPM'deki kriptografik materyali **kullanmak** karÅŸÄ±sÄ±nda **koruma saÄŸlamaz.**

AÅŸaÄŸÄ±daki sayfayÄ± kontrol ederseniz, **PRT'yi Ã§almanÄ±n** kullanÄ±cÄ± gibi eriÅŸim saÄŸlamak iÃ§in kullanÄ±labileceÄŸini gÃ¶receksiniz, bu harika Ã§Ã¼nkÃ¼ **PRT cihazlarda bulunur**, bu nedenle onlardan Ã§alÄ±nabilir (veya Ã§alÄ±nmazsa yeni imza anahtarlarÄ± oluÅŸturmak iÃ§in kÃ¶tÃ¼ye kullanÄ±labilir):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## SSO jetonlarÄ± ile bir cihaz kaydetme

Bir saldÄ±rganÄ±n, ele geÃ§irilmiÅŸ bir cihazdan Microsoft cihaz kayÄ±t hizmeti iÃ§in bir jeton talep etmesi ve kaydetmesi mÃ¼mkÃ¼n olacaktÄ±r:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Hangi, **gelecekte PRT'ler talep etmek iÃ§in kullanabileceÄŸiniz bir sertifika** verecektir. Bu nedenle kalÄ±cÄ±lÄ±ÄŸÄ± saÄŸlamakta ve **MFA'yÄ± atlatmakta** Ã§Ã¼nkÃ¼ yeni cihazÄ± kaydetmek iÃ§in kullanÄ±lan orijinal PRT token'Ä± **zaten MFA izinlerine sahipti**.

{% hint style="success" %}
Bu saldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirmek iÃ§in **yeni cihazlar kaydetme** izinlerine ihtiyacÄ±nÄ±z olacaÄŸÄ±nÄ± unutmayÄ±n. AyrÄ±ca, bir cihaz kaydetmek, cihazÄ±n **Intune'a kaydolmasÄ±na izin verileceÄŸi** anlamÄ±na gelmez.
{% endhint %}

{% hint style="danger" %}
Bu saldÄ±rÄ± EylÃ¼l 2021'de dÃ¼zeltildi Ã§Ã¼nkÃ¼ artÄ±k SSO token'larÄ± kullanarak yeni cihazlar kaydedemezsiniz. Ancak, cihazlarÄ± meÅŸru bir ÅŸekilde (kullanÄ±cÄ± adÄ±, ÅŸifre ve gerekirse MFA ile) kaydetmek hala mÃ¼mkÃ¼ndÃ¼r. Kontrol edin: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Bir cihaz biletini geÃ§ersiz kÄ±lma

**Bir cihaz bileti talep etmek**, cihazÄ±n mevcut biletini **geÃ§ersiz kÄ±lmak** ve akÄ±ÅŸ sÄ±rasÄ±nda **PRT'yi Ã§almak** mÃ¼mkÃ¼ndÃ¼ (bu nedenle TPM'den Ã§almaya gerek yok. Daha fazla bilgi iÃ§in [**bu konuÅŸmaya bakÄ±n**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Ancak, bu dÃ¼zeltildi.
{% endhint %}

## WHFB anahtarÄ±nÄ± geÃ§ersiz kÄ±lma

[**Orijinal slaytlara buradan bakÄ±n**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)

SaldÄ±rÄ± Ã¶zeti:

* **SSO** aracÄ±lÄ±ÄŸÄ±yla bir **cihazdan** **kayÄ±tlÄ± WHFB** anahtarÄ±nÄ± **geÃ§ersiz kÄ±lmak** mÃ¼mkÃ¼ndÃ¼r
* Anahtar, yeni anahtarÄ±n **Ã¼retimi sÄ±rasÄ±nda** **sniff** edildiÄŸi iÃ§in **TPM korumasÄ±nÄ± aÅŸar**
* Bu ayrÄ±ca **kalÄ±cÄ±lÄ±k** saÄŸlar

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

KullanÄ±cÄ±lar, Azure AD Graph aracÄ±lÄ±ÄŸÄ±yla kendi searchableDeviceKey Ã¶zelliklerini deÄŸiÅŸtirebilir, ancak saldÄ±rganÄ±n kiracÄ±da bir cihaza (anlÄ±k olarak kaydedilmiÅŸ veya meÅŸru bir cihazdan Ã§alÄ±nmÄ±ÅŸ sertifika + anahtar) ve AAD Graph iÃ§in geÃ§erli bir eriÅŸim token'Ä±na sahip olmasÄ± gerekir.

Sonra, yeni bir anahtar oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
ve ardÄ±ndan searchableDeviceKey'in bilgilerini PATCH yapÄ±n:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

**Cihaz kodu phishing** ile bir kullanÄ±cÄ±dan eriÅŸim token'Ä± almak ve Ã¶nceki adÄ±mlarÄ± **kullanarak eriÅŸimini Ã§almak** mÃ¼mkÃ¼ndÃ¼r. Daha fazla bilgi iÃ§in kontrol edin:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Referanslar

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
