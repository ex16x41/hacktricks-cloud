# Az - Lateral Movement (Cloud - On-Prem)

## Az - Lateral Movement (Cloud - On-Prem)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

### On-Prem Maschinen, die mit der Cloud verbunden sind

Es gibt verschiedene M√∂glichkeiten, wie eine Maschine mit der Cloud verbunden sein kann:

#### Azure AD verbunden

<figure><img src="../../../.gitbook/assets/image (259).png" alt=""><figcaption></figcaption></figure>

#### Arbeitsplatz verbunden

<figure><img src="../../../.gitbook/assets/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Hybrid verbunden

<figure><img src="../../../.gitbook/assets/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Arbeitsplatz verbunden auf AADJ oder Hybrid

<figure><img src="../../../.gitbook/assets/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### Tokens und Einschr√§nkungen <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

In Azure AD gibt es verschiedene Arten von Tokens mit spezifischen Einschr√§nkungen:

* **Zugriffstokens**: Werden verwendet, um auf APIs und Ressourcen wie Microsoft Graph zuzugreifen. Sie sind an einen bestimmten Client und eine Ressource gebunden.
* **Aktualisierungstokens**: Werden an Anwendungen ausgegeben, um neue Zugriffstokens zu erhalten. Sie k√∂nnen nur von der Anwendung verwendet werden, an die sie ausgegeben wurden, oder von einer Gruppe von Anwendungen.
* **Prim√§re Aktualisierungstokens (PRT)**: Werden f√ºr die Single Sign-On-Authentifizierung auf Azure AD verbundenen, registrierten oder hybrid verbundenen Ger√§ten verwendet. Sie k√∂nnen in Anmeldefl√ºssen im Browser und f√ºr die Anmeldung bei mobilen und Desktop-Anwendungen auf dem Ger√§t verwendet werden.
* **Windows Hello for Business-Schl√ºssel (WHFB)**: Werden f√ºr passwortlose Authentifizierung verwendet. Sie werden verwendet, um prim√§re Aktualisierungstokens zu erhalten.

Die interessanteste Art von Token ist das prim√§re Aktualisierungstoken (PRT).

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### Pivoting-Techniken

Vom **kompromittierten Ger√§t zur Cloud**:

* [**Pass the Cookie**](az-pass-the-cookie.md): Stehle Azure-Cookies aus dem Browser und verwende sie, um dich anzumelden.
* [**Dump processes access tokens**](az-processes-memory-access-token.md): Dump die Speicher lokaler Prozesse, die mit der Cloud synchronisiert sind (wie Excel, Teams...) und finde Zugriffstokens im Klartext.
* [**Phishing Primary Refresh Token**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** Phishing des PRT, um es auszunutzen.
* [**Pass the PRT**](pass-the-prt.md): Stehle das Ger√§te-PRT, um Azure zuzugreifen und es zu impersonieren.
* [**Pass the Certificate**](az-pass-the-certificate.md)**:** Generiere ein Zertifikat basierend auf dem PRT, um von einem Ger√§t auf ein anderes zuzugreifen.

Vom Kompromittieren **AD** zum Kompromittieren der **Cloud** und vom Kompromittieren der **Cloud** zum Kompromittieren **AD**:

* [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
* **Ein weiterer Weg, um von der Cloud zu On-Prem zu pivotieren, ist** [**Intune auszunutzen**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

Dieses Tool erm√∂glicht es, mehrere Aktionen durchzuf√ºhren, wie z.B. eine Maschine in Azure AD zu registrieren, um ein PRT zu erhalten, und PRTs (legitim oder gestohlen) zu verwenden, um auf Ressourcen auf verschiedene Weise zuzugreifen. Dies sind keine direkten Angriffe, aber es erleichtert die Verwendung von PRTs, um auf Ressourcen auf verschiedene Weise zuzugreifen. Weitere Informationen findest du unter [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Referenzen

* [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
