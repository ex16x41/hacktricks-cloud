# Az AD Connect - Hybrid Identity

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

L'integrazione tra **Active Directory (AD) on-premises** e **Azure AD** √® facilitata da **Azure AD Connect**, che offre vari metodi che supportano **Single Sign-on (SSO)**. Ogni metodo, sebbene utile, presenta potenziali vulnerabilit√† di sicurezza che potrebbero essere sfruttate per compromettere gli ambienti cloud o on-premises:

* **Pass-Through Authentication (PTA)**:
* Possibile compromissione dell'agente sull'AD on-prem, che consente la convalida delle password degli utenti per le connessioni Azure (da on-prem a Cloud).
* Fattibilit√† di registrare un nuovo agente per convalidare le autenticazioni in una nuova posizione (da Cloud a on-prem).

{% content-ref url="pta-pass-through-authentication.md" %}
[pta-pass-through-authentication.md](pta-pass-through-authentication.md)
{% endcontent-ref %}

* **Password Hash Sync (PHS)**:
* Potenziale estrazione delle password in chiaro degli utenti privilegiati dall'AD, comprese le credenziali di un utente AzureAD auto-generato ad alta privilegio.

{% content-ref url="phs-password-hash-sync.md" %}
[phs-password-hash-sync.md](phs-password-hash-sync.md)
{% endcontent-ref %}

* **Federation**:
* Furto della chiave privata utilizzata per la firma SAML, che consente l'impersonificazione delle identit√† on-prem e cloud.

{% content-ref url="federation.md" %}
[federation.md](federation.md)
{% endcontent-ref %}

* **Seamless SSO:**
* Furto della password dell'utente `AZUREADSSOACC`, utilizzata per firmare i biglietti Kerberos silver, che consente l'impersonificazione di qualsiasi utente cloud.

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

* **Cloud Kerberos Trust**:
* Possibilit√† di escalation da Global Admin a Domain Admin on-prem manipolando i nomi utente e gli SID degli utenti AzureAD e richiedendo TGT da AzureAD.

{% content-ref url="az-cloud-kerberos-trust.md" %}
[az-cloud-kerberos-trust.md](az-cloud-kerberos-trust.md)
{% endcontent-ref %}

* **Default Applications**:
* Compromissione di un account di Amministratore dell'Applicazione o dell'Account di Sync on-prem consente la modifica delle impostazioni della directory, delle appartenenze ai gruppi, degli account utente, dei siti SharePoint e dei file OneDrive.

{% content-ref url="az-default-applications.md" %}
[az-default-applications.md](az-default-applications.md)
{% endcontent-ref %}

Per ogni metodo di integrazione, viene condotta la sincronizzazione degli utenti e viene creato un account `MSOL_<installationidentifier>` nell'AD on-prem. √à importante notare che sia i metodi **PHS** che **PTA** facilitano il **Seamless SSO**, consentendo l'accesso automatico per i computer Azure AD uniti al dominio on-prem.

Per verificare l'installazione di **Azure AD Connect**, √® possibile utilizzare il seguente comando PowerShell, che utilizza il modulo **AzureADConnectHealthSync** (installato per impostazione predefinita con Azure AD Connect):
```powershell
Get-ADSyncConnector
```
{% hint style="success" %}
Impara e pratica il hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Impara e pratica il hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos su github.

</details>
{% endhint %}
