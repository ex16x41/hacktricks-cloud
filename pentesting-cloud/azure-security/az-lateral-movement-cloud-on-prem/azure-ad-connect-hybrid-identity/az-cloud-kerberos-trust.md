# Az - Cloud Kerberos Trust

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Ten post jest podsumowaniem** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **kt贸ry mo偶na sprawdzi w celu uzyskania dalszych informacji na temat ataku. Ta technika jest r贸wnie偶 om贸wiona w** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Podstawowe informacje

### Zaufanie

Gdy zaufanie jest ustanowione z Azure AD, **tworzony jest Read Only Domain Controller (RODC) w AD.** **Konto komputera RODC** nosi nazw **`AzureADKerberos$`**. Ponadto, istnieje drugie konto `krbtgt` o nazwie **`krbtgt_AzureAD`**. To konto zawiera **klucze Kerberos** u偶ywane do bilet贸w, kt贸re tworzy Azure AD.

Dlatego, jeli to konto zostanie skompromitowane, mo偶liwe byoby podszywanie si pod dowolnego u偶ytkownika... chocia偶 to nie jest prawda, poniewa偶 to konto jest zapobiegane w tworzeniu bilet贸w dla jakiejkolwiek wsp贸lnej grupy uprzywilejowanej AD, takiej jak Domain Admins, Enterprise Admins, Administrators...

{% hint style="danger" %}
Jednak w rzeczywistym scenariuszu bd uprzywilejowani u偶ytkownicy, kt贸rzy nie s w tych grupach. Tak wic **nowe konto krbtgt, jeli zostanie skompromitowane, mogoby by u偶yte do podszywania si pod nich.**
{% endhint %}

### Kerberos TGT

Ponadto, gdy u偶ytkownik uwierzytelnia si w systemie Windows, u偶ywajc to偶samoci hybrydowej, **Azure AD wyda czciowy bilet Kerberos wraz z PRT.** TGT jest czciowy, poniewa偶 **AzureAD ma ograniczone informacje** o u偶ytkowniku w lokalnym AD (takie jak identyfikator zabezpiecze (SID) i nazwa).\
Windows mo偶e nastpnie **wymieni ten czciowy TGT na pene TGT**, 偶dajc biletu usugi dla usugi `krbtgt`.

### NTLM

Poniewa偶 mog istnie usugi, kt贸re nie obsuguj uwierzytelniania Kerberos, ale NTLM, mo偶liwe jest za偶danie **czciowego TGT podpisanego przy u偶yciu drugiego klucza `krbtgt`**, w tym pola **`KERB-KEY-LIST-REQ`** w czci **PADATA** 偶dania, a nastpnie uzyskanie penego TGT podpisanego kluczem g贸wnym `krbtgt`, **w tym hasz NT w odpowiedzi**.

## Wykorzystywanie zaufania Cloud Kerberos do uzyskania uprawnie Domain Admin <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Gdy AzureAD generuje **czciowe TGT**, bdzie u偶ywa szczeg贸贸w, kt贸re ma o u偶ytkowniku. Dlatego, jeli Global Admin m贸gby zmodyfikowa dane, takie jak **identyfikator zabezpiecze i nazwa u偶ytkownika w AzureAD**, podczas 偶dania TGT dla tego u偶ytkownika **identyfikator zabezpiecze byby inny**.

Nie jest mo偶liwe zrobienie tego przez Microsoft Graph lub Azure AD Graph, ale mo偶liwe jest u偶ycie **API, kt贸re u偶ywa Active Directory Connect** do tworzenia i aktualizowania synchronizowanych u偶ytkownik贸w, co mo偶e by u偶yte przez Global Admin贸w do **zmiany nazwy SAM i SID dowolnego u偶ytkownika hybrydowego**, a nastpnie, jeli si uwierzytelniamy, otrzymujemy czciowe TGT zawierajce zmodyfikowany SID.

Zauwa偶, 偶e mo偶emy to zrobi z AADInternals i zaktualizowa synchronizowanych u偶ytkownik贸w za pomoc polecenia [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Wymagania wstpne ataku <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Sukces ataku i uzyskanie uprawnie Domain Admin zale偶y od spenienia pewnych wymaga wstpnych:

* Zdolno do zmiany kont za pomoc API Synchronizacji jest kluczowa. Mo偶na to osign, majc rol Global Admin lub posiadajc konto synchronizacji AD Connect. Alternatywnie, rola Administratora To偶samoci Hybrydowej byaby wystarczajca, poniewa偶 daje mo偶liwo zarzdzania AD Connect i tworzenia nowych kont synchronizacji.
* Obecno **konta hybrydowego** jest niezbdna. To konto musi by podatne na modyfikacj danymi ofiary i powinno by r贸wnie偶 dostpne do uwierzytelnienia.
* Identyfikacja **docelowego konta ofiary** w Active Directory jest koniecznoci. Chocia偶 atak mo偶na przeprowadzi na dowolnym koncie ju偶 zsynchronizowanym, tenant Azure AD nie mo偶e mie zreplikowanych identyfikator贸w zabezpiecze lokalnych, co wymaga modyfikacji konta niesynchronizowanego, aby uzyska bilet.
* Dodatkowo, to konto powinno posiada uprawnienia r贸wnowa偶ne uprawnieniom administratora domeny, ale nie powinno by czonkiem typowych grup administrator贸w AD, aby unikn generowania nieprawidowych TGT przez RODC AzureAD.
* Najlepszym celem jest **konto Active Directory u偶ywane przez usug synchronizacji AD Connect**. To konto nie jest synchronizowane z Azure AD, co czyni jego SID odpowiednim celem, a z racji swojej roli w synchronizacji skr贸t贸w hase (zakadajc, 偶e synchronizacja skr贸t贸w hase jest aktywna) ma z natury uprawnienia r贸wnowa偶ne uprawnieniom Domain Admin. W przypadku domen z ekspresow instalacj, to konto jest poprzedzone **MSOL\_**. W innych przypadkach konto mo偶na zidentyfikowa, enumerujc wszystkie konta obdarzone uprawnieniami replikacji katalogu na obiekcie domeny.

### Peny atak <a href="#the-full-attack" id="the-full-attack"></a>

Sprawd藕 to w oryginalnym pocie: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
