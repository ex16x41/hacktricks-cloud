# Az - Cloud Kerberos Trust

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Ten post jest podsumowaniem** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **ktÃ³ry moÅ¼na sprawdziÄ‡ w celu uzyskania dalszych informacji na temat ataku. Ta technika jest rÃ³wnieÅ¼ omÃ³wiona w** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Podstawowe informacje

### Zaufanie

Gdy zaufanie jest ustanowione z Azure AD, **tworzony jest kontroler domeny tylko do odczytu (RODC) w AD.** **Konto komputera RODC**, nazwane **`AzureADKerberos$`**. Ponadto, drugie konto `krbtgt` nazwane **`krbtgt_AzureAD`**. To konto zawiera **klucze Kerberos** uÅ¼ywane do biletÃ³w, ktÃ³re tworzy Azure AD.

Dlatego, jeÅ›li to konto zostanie skompromitowane, moÅ¼liwe byÅ‚oby podszywanie siÄ™ pod dowolnego uÅ¼ytkownika... chociaÅ¼ to nie jest prawda, poniewaÅ¼ to konto jest zapobiegane w tworzeniu biletÃ³w dla jakiejkolwiek wspÃ³lnej uprzywilejowanej grupy AD, takiej jak Administratorzy Domeny, Administratorzy Enterprise, Administratorzy...

{% hint style="danger" %}
Jednak w rzeczywistym scenariuszu bÄ™dÄ… uprzywilejowani uÅ¼ytkownicy, ktÃ³rzy nie sÄ… w tych grupach. Tak wiÄ™c **nowe konto krbtgt, jeÅ›li zostanie skompromitowane, mogÅ‚oby byÄ‡ uÅ¼yte do podszywania siÄ™ pod nich.**
{% endhint %}

### Kerberos TGT

Ponadto, gdy uÅ¼ytkownik uwierzytelnia siÄ™ w systemie Windows, uÅ¼ywajÄ…c toÅ¼samoÅ›ci hybrydowej, **Azure AD wyda czÄ™Å›ciowy bilet Kerberos wraz z PRT.** TGT jest czÄ™Å›ciowy, poniewaÅ¼ **AzureAD ma ograniczone informacje** o uÅ¼ytkowniku w lokalnym AD (takie jak identyfikator zabezpieczeÅ„ (SID) i nazwa).\
Windows moÅ¼e nastÄ™pnie **wymieniÄ‡ ten czÄ™Å›ciowy TGT na peÅ‚ne TGT**, Å¼Ä…dajÄ…c biletu usÅ‚ugi dla usÅ‚ugi `krbtgt`.

### NTLM

PoniewaÅ¼ mogÄ… istnieÄ‡ usÅ‚ugi, ktÃ³re nie obsÅ‚ugujÄ… uwierzytelniania Kerberos, ale NTLM, moÅ¼liwe jest zaÅ¼Ä…danie **czÄ™Å›ciowego TGT podpisanego przy uÅ¼yciu drugiego klucza `krbtgt`**, w tym pola **`KERB-KEY-LIST-REQ`** w czÄ™Å›ci **PADATA** Å¼Ä…dania, a nastÄ™pnie uzyskanie peÅ‚nego TGT podpisanego kluczem gÅ‚Ã³wnym `krbtgt`, **w tym hasz NT w odpowiedzi**.

## Wykorzystywanie zaufania Cloud Kerberos do uzyskania uprawnieÅ„ administratora domeny <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Gdy AzureAD generuje **czÄ™Å›ciowe TGT**, bÄ™dzie uÅ¼ywaÄ‡ szczegÃ³Å‚Ã³w, ktÃ³re ma o uÅ¼ytkowniku. Dlatego, jeÅ›li Globalny Administrator mÃ³gÅ‚by zmodyfikowaÄ‡ dane, takie jak **identyfikator zabezpieczeÅ„ i nazwa uÅ¼ytkownika w AzureAD**, podczas Å¼Ä…dania TGT dla tego uÅ¼ytkownika **identyfikator zabezpieczeÅ„ byÅ‚by inny**.

Nie jest moÅ¼liwe zrobienie tego przez Microsoft Graph lub Azure AD Graph, ale moÅ¼liwe jest uÅ¼ycie **API, ktÃ³re uÅ¼ywa Active Directory Connect** do tworzenia i aktualizowania synchronizowanych uÅ¼ytkownikÃ³w, co moÅ¼e byÄ‡ uÅ¼yte przez Globalnych AdministratorÃ³w do **zmiany nazwy SAM i SID dowolnego uÅ¼ytkownika hybrydowego**, a nastÄ™pnie, jeÅ›li siÄ™ uwierzytelniamy, otrzymujemy czÄ™Å›ciowe TGT zawierajÄ…ce zmodyfikowany SID.

ZauwaÅ¼, Å¼e moÅ¼emy to zrobiÄ‡ z AADInternals i zaktualizowaÄ‡ synchronizowanych uÅ¼ytkownikÃ³w za pomocÄ… polecenia [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Wymagania wstÄ™pne ataku <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Sukces ataku i uzyskanie uprawnieÅ„ administratora domeny zaleÅ¼y od speÅ‚nienia okreÅ›lonych wymagaÅ„ wstÄ™pnych:

* ZdolnoÅ›Ä‡ do zmiany kont za pomocÄ… API Synchronizacji jest kluczowa. MoÅ¼na to osiÄ…gnÄ…Ä‡, majÄ…c rolÄ™ Globalnego Administratora lub posiadajÄ…c konto synchronizacji AD Connect. Alternatywnie, rola Administratora ToÅ¼samoÅ›ci Hybrydowej byÅ‚aby wystarczajÄ…ca, poniewaÅ¼ daje moÅ¼liwoÅ›Ä‡ zarzÄ…dzania AD Connect i tworzenia nowych kont synchronizacji.
* ObecnoÅ›Ä‡ **konta hybrydowego** jest niezbÄ™dna. To konto musi byÄ‡ podatne na modyfikacjÄ™ danymi ofiary i powinno byÄ‡ rÃ³wnieÅ¼ dostÄ™pne do uwierzytelnienia.
* Identyfikacja **docelowego konta ofiary** w Active Directory jest koniecznoÅ›ciÄ…. ChociaÅ¼ atak moÅ¼na przeprowadziÄ‡ na dowolnym koncie juÅ¼ zsynchronizowanym, tenant Azure AD nie moÅ¼e mieÄ‡ zreplikowanych identyfikatorÃ³w zabezpieczeÅ„ lokalnych, co wymaga modyfikacji konta niesynchronizowanego, aby uzyskaÄ‡ bilet.
* Dodatkowo, to konto powinno posiadaÄ‡ uprawnienia rÃ³wnowaÅ¼ne administratorowi domeny, ale nie powinno byÄ‡ czÅ‚onkiem typowych grup administratorÃ³w AD, aby uniknÄ…Ä‡ generowania nieprawidÅ‚owych TGT przez RODC AzureAD.
* Najlepszym celem jest **konto Active Directory uÅ¼ywane przez usÅ‚ugÄ™ synchronizacji AD Connect**. To konto nie jest synchronizowane z Azure AD, co czyni jego SID odpowiednim celem, a z racji swojej roli w synchronizacji haszy haseÅ‚ (zakÅ‚adajÄ…c, Å¼e synchronizacja haszy haseÅ‚ jest aktywna) ma z natury uprawnienia rÃ³wnowaÅ¼ne administratorowi domeny. W przypadku domen z ekspresowÄ… instalacjÄ…, to konto jest poprzedzone **MSOL\_**. W innych przypadkach konto moÅ¼na zidentyfikowaÄ‡, enumerujÄ…c wszystkie konta obdarzone uprawnieniami replikacji katalogu na obiekcie domeny.

### PeÅ‚ny atak <a href="#the-full-attack" id="the-full-attack"></a>

SprawdÅº to w oryginalnym poÅ›cie: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
