# Az - Cloud Kerberos Trust

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Este post √© um resumo de** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **que pode ser consultado para mais informa√ß√µes sobre o ataque. Esta t√©cnica tamb√©m √© comentada em** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Basic Information

### Trust

Quando uma confian√ßa √© estabelecida com o Azure AD, um **Controlador de Dom√≠nio Somente Leitura (RODC) √© criado no AD.** A **conta de computador RODC**, chamada **`AzureADKerberos$`**. Al√©m disso, uma conta secund√°ria `krbtgt` chamada **`krbtgt_AzureAD`**. Esta conta cont√©m as **chaves Kerberos** usadas para os tickets que o Azure AD cria.

Portanto, se esta conta for comprometida, pode ser poss√≠vel se passar por qualquer usu√°rio... embora isso n√£o seja verdade porque esta conta √© impedida de criar tickets para qualquer grupo privilegiado comum do AD, como Administradores de Dom√≠nio, Administradores Empresariais, Administradores...

{% hint style="danger" %}
No entanto, em um cen√°rio real, haver√° usu√°rios privilegiados que n√£o est√£o nesses grupos. Portanto, a **nova conta krbtgt, se comprometida, poderia ser usada para se passar por eles.**
{% endhint %}

### Kerberos TGT

Al√©m disso, quando um usu√°rio se autentica no Windows usando uma identidade h√≠brida, **o Azure AD emitir√° um **ticket Kerberos parcial junto com o PRT.** O TGT √© parcial porque **o AzureAD tem informa√ß√µes limitadas** do usu√°rio no AD local (como o identificador de seguran√ßa (SID) e o nome).\
O Windows pode ent√£o **trocar este TGT parcial por um TGT completo** solicitando um ticket de servi√ßo para o servi√ßo `krbtgt`.

### NTLM

Como pode haver servi√ßos que n√£o suportam autentica√ß√£o kerberos, mas NTLM, √© poss√≠vel solicitar um **TGT parcial assinado usando uma chave secund√°ria `krbtgt`** incluindo o campo **`KERB-KEY-LIST-REQ`** na parte **PADATA** da solicita√ß√£o e, em seguida, obter um TGT completo assinado com a chave prim√°ria `krbtgt` **incluindo o hash NT na resposta**.

## Abusing Cloud Kerberos Trust to obtain Domain Admin <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Quando o AzureAD gera um **TGT parcial**, ele usar√° os detalhes que possui sobre o usu√°rio. Portanto, se um Administrador Global puder modificar dados como o **identificador de seguran√ßa e o nome do usu√°rio no AzureAD**, ao solicitar um TGT para esse usu√°rio, o **identificador de seguran√ßa seria um diferente**.

N√£o √© poss√≠vel fazer isso atrav√©s do Microsoft Graph ou do Azure AD Graph, mas √© poss√≠vel usar a **API que o Active Directory Connect** usa para criar e atualizar usu√°rios sincronizados, que pode ser usada pelos Administradores Globais para **modificar o nome SAM e o SID de qualquer usu√°rio h√≠brido**, e ent√£o, se nos autenticarmos, obtemos um TGT parcial contendo o SID modificado.

Observe que podemos fazer isso com AADInternals e atualizar usu√°rios sincronizados via o cmdlet [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Attack prerequisites <a href="#attack-prerequisites" id="attack-prerequisites"></a>

O sucesso do ataque e a obten√ß√£o de privil√©gios de Administrador de Dom√≠nio dependem do cumprimento de certos pr√©-requisitos:

* A capacidade de alterar contas atrav√©s da API de Sincroniza√ß√£o √© crucial. Isso pode ser alcan√ßado tendo o papel de Administrador Global ou possuindo uma conta de sincroniza√ß√£o do AD Connect. Alternativamente, o papel de Administrador de Identidade H√≠brida seria suficiente, pois concede a capacidade de gerenciar o AD Connect e estabelecer novas contas de sincroniza√ß√£o.
* A presen√ßa de uma **conta h√≠brida** √© essencial. Esta conta deve ser pass√≠vel de modifica√ß√£o com os detalhes da conta da v√≠tima e tamb√©m deve ser acess√≠vel para autentica√ß√£o.
* A identifica√ß√£o de uma **conta de v√≠tima alvo** dentro do Active Directory √© uma necessidade. Embora o ataque possa ser executado em qualquer conta j√° sincronizada, o locat√°rio do Azure AD n√£o deve ter replicado identificadores de seguran√ßa locais, necessitando da modifica√ß√£o de uma conta n√£o sincronizada para obter o ticket.
* Al√©m disso, esta conta deve possuir privil√©gios equivalentes a administrador de dom√≠nio, mas n√£o deve ser membro de grupos t√≠picos de administradores do AD para evitar a gera√ß√£o de TGTs inv√°lidos pelo RODC do AzureAD.
* O alvo mais adequado √© a **conta do Active Directory utilizada pelo servi√ßo de Sincroniza√ß√£o do AD Connect**. Esta conta n√£o √© sincronizada com o Azure AD, deixando seu SID como um alvo vi√°vel, e possui inherentemente privil√©gios equivalentes a Administrador de Dom√≠nio devido ao seu papel na sincroniza√ß√£o de hashes de senha (assumindo que a Sincroniza√ß√£o de Hash de Senha esteja ativa). Para dom√≠nios com instala√ß√£o expressa, esta conta √© prefixada com **MSOL\_**. Para outras inst√¢ncias, a conta pode ser identificada enumerando todas as contas dotadas de privil√©gios de Replica√ß√£o de Diret√≥rio no objeto de dom√≠nio.

### The full attack <a href="#the-full-attack" id="the-full-attack"></a>

Check it in the original post: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
