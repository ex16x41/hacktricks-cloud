# Az - Cloud Kerberos Trust

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Ce post est un r√©sum√© de** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **qui peut √™tre consult√© pour plus d'informations sur l'attaque. Cette technique est √©galement comment√©e dans** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Basic Information

### Trust

Lorsqu'une relation de confiance est √©tablie avec Azure AD, un **Read Only Domain Controller (RODC) est cr√©√© dans l'AD.** Le **compte d'ordinateur RODC**, nomm√© **`AzureADKerberos$`**. De plus, un compte `krbtgt` secondaire nomm√© **`krbtgt_AzureAD`**. Ce compte contient les **cl√©s Kerberos** utilis√©es pour les tickets que cr√©e Azure AD.

Par cons√©quent, si ce compte est compromis, il pourrait √™tre possible d'usurper l'identit√© de n'importe quel utilisateur... bien que cela ne soit pas vrai car ce compte est emp√™ch√© de cr√©er des tickets pour tout groupe AD privil√©gi√© commun comme Domain Admins, Enterprise Admins, Administrators...

{% hint style="danger" %}
Cependant, dans un sc√©nario r√©el, il y aura des utilisateurs privil√©gi√©s qui ne sont pas dans ces groupes. Donc le **nouveau compte krbtgt, s'il est compromis, pourrait √™tre utilis√© pour les usurper.**
{% endhint %}

### Kerberos TGT

De plus, lorsqu'un utilisateur s'authentifie sur Windows en utilisant une identit√© hybride, **Azure AD** d√©livrera un **ticket Kerberos partiel avec le PRT.** Le TGT est partiel car **AzureAD a des informations limit√©es** sur l'utilisateur dans l'AD sur site (comme l'identifiant de s√©curit√© (SID) et le nom).\
Windows peut alors **√©changer ce TGT partiel contre un TGT complet** en demandant un ticket de service pour le service `krbtgt`.

### NTLM

Comme il pourrait y avoir des services qui ne prennent pas en charge l'authentification Kerberos mais NTLM, il est possible de demander un **TGT partiel sign√© avec une cl√© `krbtgt` secondaire** en incluant le champ **`KERB-KEY-LIST-REQ`** dans la partie **PADATA** de la demande, puis d'obtenir un TGT complet sign√© avec la cl√© `krbtgt` principale **y compris le hachage NT dans la r√©ponse**.

## Abusing Cloud Kerberos Trust to obtain Domain Admin <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Lorsque AzureAD g√©n√®re un **TGT partiel**, il utilisera les d√©tails qu'il a sur l'utilisateur. Par cons√©quent, si un Global Admin pouvait modifier des donn√©es comme l'**identifiant de s√©curit√© et le nom de l'utilisateur dans AzureAD**, lors de la demande d'un TGT pour cet utilisateur, l'**identifiant de s√©curit√© serait diff√©rent**.

Il n'est pas possible de faire cela via Microsoft Graph ou Azure AD Graph, mais il est possible d'utiliser l'**API que Active Directory Connect** utilise pour cr√©er et mettre √† jour les utilisateurs synchronis√©s, ce qui peut √™tre utilis√© par les Global Admins pour **modifier le nom SAM et le SID de tout utilisateur hybride**, et ensuite, si nous nous authentifions, nous obtenons un TGT partiel contenant le SID modifi√©.

Notez que nous pouvons faire cela avec AADInternals et mettre √† jour les utilisateurs synchronis√©s via la cmdlet [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Attack prerequisites <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Le succ√®s de l'attaque et l'obtention des privil√®ges de Domain Admin d√©pendent de la satisfaction de certaines conditions pr√©alables :

* La capacit√© √† modifier des comptes via l'API de Synchronisation est cruciale. Cela peut √™tre r√©alis√© en ayant le r√¥le de Global Admin ou en poss√©dant un compte de synchronisation AD Connect. Alternativement, le r√¥le d'Administrateur d'Identit√© Hybride suffirait, car il accorde la capacit√© de g√©rer AD Connect et d'√©tablir de nouveaux comptes de synchronisation.
* La pr√©sence d'un **compte hybride** est essentielle. Ce compte doit √™tre susceptible d'√™tre modifi√© avec les d√©tails du compte de la victime et doit √©galement √™tre accessible pour l'authentification.
* L'identification d'un **compte victime cible** au sein d'Active Directory est une n√©cessit√©. Bien que l'attaque puisse √™tre ex√©cut√©e sur n'importe quel compte d√©j√† synchronis√©, le locataire Azure AD ne doit pas avoir r√©pliqu√© les identifiants de s√©curit√© sur site, n√©cessitant la modification d'un compte non synchronis√© pour obtenir le ticket.
* De plus, ce compte doit poss√©der des privil√®ges √©quivalents √† ceux d'un administrateur de domaine mais ne doit pas √™tre membre des groupes d'administrateurs AD typiques pour √©viter la g√©n√©ration de TGT invalides par le RODC AzureAD.
* La cible la plus appropri√©e est le **compte Active Directory utilis√© par le service de synchronisation AD Connect**. Ce compte n'est pas synchronis√© avec Azure AD, laissant son SID comme une cible viable, et il d√©tient intrins√®quement des privil√®ges √©quivalents √† ceux d'un Domain Admin en raison de son r√¥le dans la synchronisation des hachages de mots de passe (en supposant que la synchronisation des hachages de mots de passe est active). Pour les domaines avec installation express, ce compte est pr√©fix√© par **MSOL\_**. Pour d'autres cas, le compte peut √™tre identifi√© en √©num√©rant tous les comptes dot√©s de privil√®ges de r√©plication d'annuaire sur l'objet de domaine.

### The full attack <a href="#the-full-attack" id="the-full-attack"></a>

Check it in the original post: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
