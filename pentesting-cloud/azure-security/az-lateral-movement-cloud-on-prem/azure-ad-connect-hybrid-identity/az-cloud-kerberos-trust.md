# Az - Zaufanie Kerberos w Chmurze

{% hint style="success" %}
Ucz si i praktykuj Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i praktykuj Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}

**Ten post jest podsumowaniem** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/), **kt贸ry mo偶na sprawdzi, aby uzyska wicej informacji na temat ataku. Ta technika jest r贸wnie偶 om贸wiona w** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Podstawowe informacje

### Zaufanie

Kiedy nawizywane jest zaufanie z Azure AD, w AD tworzony jest **Read Only Domain Controller (RODC)**. Konto komputera **RODC** nosi nazw **`AzureADKerberos$`**. Dodatkowo tworzone jest drugorzdne konto `krbtgt` o nazwie **`krbtgt_AzureAD`**. To konto zawiera **klucze Kerberos** u偶ywane do bilet贸w, kt贸re tworzy Azure AD.

Dlatego jeli to konto zostanie skompromitowane, mo偶liwe byoby podszywanie si pod dowolnego u偶ytkownika... chocia偶 nie jest to prawd, poniewa偶 to konto jest zabezpieczone przed tworzeniem bilet贸w dla jakiejkolwiek powszechnej uprzywilejowanej grupy AD, takiej jak Administratorzy domeny, Administratorzy przedsibiorstwa, Administratorzy...

{% hint style="danger" %}
Jednak偶e, w rzeczywistym scenariuszu bd uprzywilejowani u偶ytkownicy, kt贸rzy nie nale偶 do tych grup. Dlatego **nowe konto krbtgt, jeli zostanie skompromitowane, mo偶e by u偶yte do podszywania si pod nich.**
{% endhint %}

### Kerberos TGT

Ponadto, gdy u偶ytkownik uwierzytelnia si w systemie Windows przy u偶yciu hybrydowej to偶samoci **Azure AD**, Azure AD wyda **czciowy bilet Kerberos wraz z PRT**. TGT jest czciowy, poniewa偶 **AzureAD ma ograniczon wiedz** o u偶ytkowniku w lokalnym AD (tak jak identyfikator zabezpiecze (SID) i nazwa).\
System Windows mo偶e nastpnie **wymieni ten czciowy TGT na peny TGT**, 偶dajc biletu usugi dla usugi `krbtgt`.&#x20;

### NTLM

Poniewa偶 mog istnie usugi, kt贸re nie obsuguj uwierzytelniania Kerberos, ale NTLM, mo偶liwe jest 偶danie **czciowego TGT podpisanego za pomoc drugorzdnego `krbtgt`** klucza, wczajc **pole `KERB-KEY-LIST-REQ`** w **czci PADATA** 偶dania, a nastpnie uzyskanie penego TGT podpisanego kluczem g贸wnym `krbtgt` **zawierajcego skr贸t NT w odpowiedzi**.

## Nadu偶ywanie Zaufania Kerberos w Chmurze w celu uzyskania Administratora domeny <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Kiedy AzureAD generuje **czciowy TGT**, u偶ywa szczeg贸贸w, jakie posiada o u偶ytkowniku. Dlatego jeli Globalny Administrator m贸gby zmodyfikowa dane takie jak **identyfikator zabezpiecze i nazwa u偶ytkownika w AzureAD**, podczas 偶dania TGT dla tego u偶ytkownika **identyfikator zabezpiecze byby inny**.

Nie jest to mo偶liwe za pomoc Microsoft Graph ani Azure AD Graph, ale mo偶na u偶y **API, kt贸rego u偶ywa Active Directory Connect** do tworzenia i aktualizacji zsynchronizowanych u偶ytkownik贸w, co mo偶e by wykorzystane przez Globalnych Administrator贸w do **modyfikacji nazwy SAM i SID dowolnego hybrydowego u偶ytkownika**, a nastpnie, jeli si uwierzytelni, otrzymaj czciowy TGT zawierajcy zmodyfikowany SID.

Zauwa偶, 偶e mo偶na to zrobi za pomoc AADInternals i zaktualizowa zsynchronizowanych u偶ytkownik贸w za pomoc polecenia [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Wymagania ataku <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Sukces ataku i uzyskanie uprawnie Administratora domeny zale偶y od spenienia okrelonych wymaga wstpnych:

* Istotne jest posiadanie zdolnoci modyfikowania kont za pomoc interfejsu API synchronizacji. Mo偶na to osign, majc rol Globalnego Administratora lub posiadajc konto synchronizacji AD Connect. Alternatywnie wystarczyaby rola Administratora Hybrydowej To偶samoci, poniewa偶 umo偶liwia zarzdzanie AD Connect i tworzenie nowych kont synchronizacji.
* Istnienie **konta hybrydowego** jest niezbdne. To konto musi by podatne na modyfikacj z danymi konta ofiary i powinno by dostpne do uwierzytelniania.
* Konieczne jest zidentyfikowanie **konta ofiary docelowej** w Active Directory. Chocia偶 atak mo偶na przeprowadzi na dowolnym ju偶 zsynchronizowanym koncie, najemnik Azure AD nie mo偶e mie zreplikowanych identyfikator贸w zabezpiecze z lokalnych system贸w, co wymaga modyfikacji niesynchronizowanego konta w celu uzyskania biletu.
* Ponadto, to konto powinno posiada uprawnienia r贸wnowa偶ne Administratorowi domeny, ale nie powinno by czonkiem typowych grup administrator贸w AD, aby unikn generowania nieprawidowych TGT przez AzureAD RODC.
* Najbardziej odpowiednim celem jest **konto Active Directory u偶ywane przez usug synchronizacji AD Connect**. To konto nie jest zsynchronizowane z Azure AD, co pozostawia jego SID jako cel, a z natury posiada uprawnienia r贸wnowa偶ne Administratorowi domeny ze wzgldu na rol w synchronizacji skr贸t贸w hase (przy zao偶eniu, 偶e synchronizacja skr贸t贸w hase jest aktywna). Dla domen z instalacj express, to konto jest poprzedzone **MSOL\_**. W innych przypadkach konto mo偶na zlokalizowa, wyliczajc wszystkie konta obdarzone uprawnieniami replikacji katalogowej na obiekcie domeny.

### Peny atak <a href="#the-full-attack" id="the-full-attack"></a>

Sprawd藕 to w oryginalnym pocie: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Ucz si i praktykuj Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i praktykuj Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}
