# Az - Bulut Kerberos GÃ¼veni

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶nderin.

</details>
{% endhint %}

**Bu yazÄ±,** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **adresindeki saldÄ±rÄ± hakkÄ±nda daha fazla bilgi iÃ§in kontrol edilebilir. Bu teknik ayrÄ±ca** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)** adresinde de yorumlanmÄ±ÅŸtÄ±r.**

## Temel Bilgiler

### GÃ¼ven

Azure AD ile bir gÃ¼ven iliÅŸkisi kurulduÄŸunda, AD'de bir **Salt Okunur Etki AlanÄ± Denetleyicisi (RODC)** oluÅŸturulur. **RODC bilgisayar hesabÄ±**, **`AzureADKerberos$`** adÄ±nda. AyrÄ±ca, ikincil bir `krbtgt` hesabÄ± olan **`krbtgt_AzureAD`** adÄ±nda. Bu hesap, Azure AD'nin oluÅŸturduÄŸu biletler iÃ§in kullanÄ±lan **Kerberos anahtarlarÄ±nÄ±** iÃ§erir.

Bu nedenle, bu hesap ele geÃ§irilirse herhangi bir kullanÄ±cÄ±yÄ± taklit etmek mÃ¼mkÃ¼n olabilir... ancak bu doÄŸru deÄŸildir Ã§Ã¼nkÃ¼ bu hesap, Etki AlanÄ± YÃ¶neticileri, Kurumsal YÃ¶neticiler, YÃ¶neticiler gibi yaygÄ±n ayrÄ±calÄ±klÄ± AD gruplarÄ± iÃ§in bilet oluÅŸturmasÄ±nÄ±n Ã¶nÃ¼ne geÃ§ilmiÅŸtir...

{% hint style="danger" %}
Ancak, gerÃ§ek bir senaryoda bu gruplarda olmayan ayrÄ±calÄ±klÄ± kullanÄ±cÄ±lar olacaktÄ±r. Bu nedenle, **yeni krbtgt hesabÄ± ele geÃ§irilirse, onlarÄ± taklit etmek iÃ§in kullanÄ±labilir.**
{% endhint %}

### Kerberos TGT

DahasÄ±, bir kullanÄ±cÄ± Windows'ta **Azure AD** kullanarak kimlik doÄŸruladÄ±ÄŸÄ±nda, **Azure AD** kÄ±smi bir Kerberos biletini **PRT ile birlikte verecektir.** TGT, **AzureAD'nin on-prem AD'deki kullanÄ±cÄ± hakkÄ±nda sÄ±nÄ±rlÄ± bilgiye sahip olmasÄ± nedeniyle kÄ±smidir (gÃ¼venlik tanÄ±mlayÄ±cÄ± (SID) ve ad gibi).**\
Windows daha sonra, bu kÄ±smi TGT'yi bir `krbtgt` hizmeti iÃ§in bir hizmet bileti isteyerek tam bir TGT ile deÄŸiÅŸtirebilir.&#x20;

### NTLM

Kerberos kimlik doÄŸrulamasÄ±nÄ± desteklemeyen hizmetler olabileceÄŸinden, bir **ikincil `krbtgt`** anahtarÄ±nÄ± kullanarak imzalanmÄ±ÅŸ bir kÄ±smi TGT istemek ve isteÄŸin **PADATA** kÄ±smÄ±nda **`KERB-KEY-LIST-REQ`** alanÄ±nÄ± iÃ§eren bir yanÄ±tta **NT hash** iÃ§eren tam bir TGT almak mÃ¼mkÃ¼ndÃ¼r.

## Bulut Kerberos GÃ¼venini KÃ¶tÃ¼ye Kullanarak Etki AlanÄ± YÃ¶neticisi Elde Etme <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

AzureAD bir **kÄ±smi TGT** oluÅŸturduÄŸunda, kullanÄ±cÄ± hakkÄ±nda sahip olduÄŸu ayrÄ±ntÄ±larÄ± kullanacaktÄ±r. Bu nedenle, bir Global YÃ¶netici, AzureAD'deki kullanÄ±cÄ±nÄ±n **gÃ¼venlik tanÄ±mlayÄ±cÄ±sÄ±nÄ± ve adÄ±nÄ± deÄŸiÅŸtirebilirse**, o kullanÄ±cÄ± iÃ§in TGT istendiÄŸinde **gÃ¼venlik tanÄ±mlayÄ±cÄ±sÄ± farklÄ± olacaktÄ±r**.

Bu, Microsoft Graph veya Azure AD Graph Ã¼zerinden yapÄ±lamaz, ancak Global YÃ¶neticilerin kullanabileceÄŸi **API Active Directory Connect** kullanÄ±labilir. Bu API, Global YÃ¶neticilerin **hibrit kullanÄ±cÄ±larÄ±n SAM adÄ±nÄ± ve SID'sini deÄŸiÅŸtirmelerine izin verir** ve ardÄ±ndan kimlik doÄŸrulama yaparsak, deÄŸiÅŸtirilmiÅŸ SID iÃ§eren bir kÄ±smi TGT alÄ±rÄ±z.

Bu iÅŸlemi AADInternals ile yapabilir ve senkronize edilen kullanÄ±cÄ±lara [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdlet'i aracÄ±lÄ±ÄŸÄ±yla gÃ¼ncelleme yapabilirsiniz.

### SaldÄ±rÄ± Ã–nkoÅŸullarÄ± <a href="#attack-prerequisites" id="attack-prerequisites"></a>

SaldÄ±rÄ±nÄ±n baÅŸarÄ±sÄ± ve Etki AlanÄ± YÃ¶neticisi ayrÄ±calÄ±klarÄ±nÄ±n elde edilmesi belirli Ã¶nkoÅŸullarÄ±n karÅŸÄ±lanmasÄ±na baÄŸlÄ±dÄ±r:

* HesaplarÄ± Senkronizasyon API'si aracÄ±lÄ±ÄŸÄ±yla deÄŸiÅŸtirme yeteneÄŸi Ã¶nemlidir. Bu, Global YÃ¶netici rolÃ¼ne sahip olmak veya bir AD Connect senkronizasyon hesabÄ±na sahip olmakla elde edilebilir. AyrÄ±ca, Hibrit Kimlik YÃ¶neticisi rolÃ¼ de yeterlidir, Ã§Ã¼nkÃ¼ AD Connect'i yÃ¶netme ve yeni senkronizasyon hesaplarÄ± oluÅŸturma yetkisini verir.
* Bir **hibrit hesabÄ±n** varlÄ±ÄŸÄ± Ã¶nemlidir. Bu hesap, kurban hesabÄ±nÄ±n ayrÄ±ntÄ±larÄ± ile deÄŸiÅŸtirilebilir olmalÄ± ve kimlik doÄŸrulama iÃ§in eriÅŸilebilir olmalÄ±dÄ±r.
* Active Directory iÃ§inde bir **hedef kurban hesabÄ±nÄ±n** tanÄ±mlanmasÄ± gereklidir. SaldÄ±rÄ± senkronize edilmiÅŸ herhangi bir hesap Ã¼zerinde gerÃ§ekleÅŸtirilebilir olsa da, Azure AD kiracÄ±sÄ±nÄ±n yerinde oluÅŸturulmuÅŸ gÃ¼venlik tanÄ±mlayÄ±cÄ±larÄ±na sahip olmamasÄ±, senkronize edilmemiÅŸ bir hesabÄ±n deÄŸiÅŸtirilmesini gerektirir.
* AyrÄ±ca, bu hesabÄ±n etki alanÄ± yÃ¶neticisi eÅŸdeÄŸer ayrÄ±calÄ±klara sahip olmasÄ± gerekmektedir ancak tipik AD yÃ¶netici gruplarÄ±nÄ±n Ã¼yesi olmamalÄ±dÄ±r, AzureAD RODC tarafÄ±ndan geÃ§ersiz TGT'lerin oluÅŸturulmasÄ±nÄ± Ã¶nlemek iÃ§in.
* En uygun hedef, **AD Connect Senkronizasyon hizmeti tarafÄ±ndan kullanÄ±lan Active Directory hesabÄ±dÄ±r**. Bu hesap Azure AD ile senkronize edilmediÄŸi iÃ§in, SID'si hedeflenebilir durumdadÄ±r ve Parola Hash Senkronizasyonu etkinse, doÄŸal olarak Etki AlanÄ± YÃ¶neticisi eÅŸdeÄŸer ayrÄ±calÄ±klara sahiptir. HÄ±zlÄ± kurulumlar iÃ§in bu hesap **MSOL\_** ile baÅŸlar. DiÄŸer durumlarda, hesap, etki alanÄ± nesnesine verilen Dizin Ã‡oÄŸaltma ayrÄ±calÄ±klarÄ±na sahip tÃ¼m hesaplarÄ±n listelenmesiyle belirlenebilir.

### Tam saldÄ±rÄ± <a href="#the-full-attack" id="the-full-attack"></a>

Orijinal yazÄ±da kontrol edin: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶nderin.

</details>
{% endhint %}
