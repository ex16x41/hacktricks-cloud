# Az - Cloud Kerberos Trust

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

**Bu gÃ¶nderi, saldÄ±rÄ± hakkÄ±nda daha fazla bilgi iÃ§in kontrol edilebilecek** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **adresinin bir Ã¶zetidir. Bu teknik ayrÄ±ca** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)** adresinde yorumlanmÄ±ÅŸtÄ±r.**

## Temel Bilgiler

### GÃ¼ven

Azure AD ile bir gÃ¼ven iliÅŸkisi kurulduÄŸunda, **AD'de bir Okuma YalnÄ±zca Alan Denetleyicisi (RODC) oluÅŸturulur.** **RODC bilgisayar hesabÄ±**, **`AzureADKerberos$`** olarak adlandÄ±rÄ±lÄ±r. AyrÄ±ca, **`krbtgt_AzureAD`** adÄ±nda bir ikincil `krbtgt` hesabÄ± oluÅŸturulur. Bu hesap, Azure AD'nin oluÅŸturduÄŸu biletler iÃ§in kullanÄ±lan **Kerberos anahtarlarÄ±nÄ±** iÃ§erir.

Bu nedenle, bu hesap ele geÃ§irilirse, herhangi bir kullanÄ±cÄ±yÄ± taklit etmek mÃ¼mkÃ¼n olabilir... ancak bu doÄŸru deÄŸildir Ã§Ã¼nkÃ¼ bu hesap, Alan YÃ¶neticileri, Kurumsal YÃ¶neticiler, YÃ¶neticiler gibi herhangi bir yaygÄ±n ayrÄ±calÄ±klÄ± AD grubuna bilet oluÅŸturmasÄ±nÄ± engeller.

{% hint style="danger" %}
Ancak, gerÃ§ek bir senaryoda, bu gruplarda yer almayan ayrÄ±calÄ±klÄ± kullanÄ±cÄ±lar olacaktÄ±r. Bu nedenle, **yeni krbtgt hesabÄ±, ele geÃ§irilirse, onlarÄ± taklit etmek iÃ§in kullanÄ±labilir.**
{% endhint %}

### Kerberos TGT

AyrÄ±ca, bir kullanÄ±cÄ± Windows'ta hibrit kimlik kullanarak kimlik doÄŸruladÄ±ÄŸÄ±nda, **Azure AD, PRT ile birlikte kÄ±smi Kerberos bileti verir.** TGT kÄ±smi olarak adlandÄ±rÄ±lÄ±r Ã§Ã¼nkÃ¼ **AzureAD'nin on-prem AD'deki kullanÄ±cÄ± hakkÄ±nda sÄ±nÄ±rlÄ± bilgisi** vardÄ±r (gÃ¼venlik tanÄ±mlayÄ±cÄ±sÄ± (SID) ve isim gibi).\
Windows, ardÄ±ndan `krbtgt` hizmeti iÃ§in bir hizmet bileti talep ederek **bu kÄ±smi TGT'yi tam TGT ile deÄŸiÅŸtirebilir.**

### NTLM

Kerberos kimlik doÄŸrulamasÄ±nÄ± desteklemeyen ancak NTLM'yi destekleyen hizmetler olabileceÄŸinden, **PADATA** talebinin **PADATA** kÄ±smÄ±nda **`KERB-KEY-LIST-REQ`** alanÄ±nÄ± dahil ederek **ikincil `krbtgt`** anahtarÄ± ile imzalanmÄ±ÅŸ bir **kÄ±smi TGT** talep etmek ve ardÄ±ndan birincil `krbtgt` anahtarÄ± ile imzalanmÄ±ÅŸ tam bir TGT almak mÃ¼mkÃ¼ndÃ¼r **NT hash yanÄ±tÄ±nda dahil edilmiÅŸtir.**

## Alan YÃ¶neticisi Elde Etmek Ä°Ã§in Cloud Kerberos Trust'Ä± KÃ¶tÃ¼ye Kullanma <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

AzureAD bir **kÄ±smi TGT** oluÅŸturduÄŸunda, kullanÄ±cÄ± hakkÄ±nda sahip olduÄŸu ayrÄ±ntÄ±larÄ± kullanacaktÄ±r. Bu nedenle, bir Global Admin, **AzureAD'deki kullanÄ±cÄ±nÄ±n gÃ¼venlik tanÄ±mlayÄ±cÄ±sÄ±nÄ± ve adÄ±nÄ±** deÄŸiÅŸtirebilirse, o kullanÄ±cÄ± iÃ§in bir TGT talep ettiÄŸinde **gÃ¼venlik tanÄ±mlayÄ±cÄ±sÄ± farklÄ± olacaktÄ±r.**

Bunu Microsoft Graph veya Azure AD Graph aracÄ±lÄ±ÄŸÄ±yla yapmak mÃ¼mkÃ¼n deÄŸildir, ancak Global Admin'lerin **senkronize kullanÄ±cÄ±larÄ± oluÅŸturmak ve gÃ¼ncellemek iÃ§in kullandÄ±ÄŸÄ± API'yi** kullanmak mÃ¼mkÃ¼ndÃ¼r; bu, Global Admin'lerin **herhangi bir hibrit kullanÄ±cÄ±nÄ±n SAM adÄ±nÄ± ve SID'sini deÄŸiÅŸtirmesine** olanak tanÄ±r ve ardÄ±ndan kimlik doÄŸruladÄ±ÄŸÄ±mÄ±zda, deÄŸiÅŸtirilmiÅŸ SID'yi iÃ§eren bir kÄ±smi TGT alÄ±rÄ±z.

Bunu AADInternals ile yapabileceÄŸimizi ve senkronize kullanÄ±cÄ±lara [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdlet'i aracÄ±lÄ±ÄŸÄ±yla gÃ¼ncelleyebileceÄŸimizi unutmayÄ±n.

### SaldÄ±rÄ± Ã–n KoÅŸullarÄ± <a href="#attack-prerequisites" id="attack-prerequisites"></a>

SaldÄ±rÄ±nÄ±n baÅŸarÄ±sÄ± ve Alan YÃ¶neticisi ayrÄ±calÄ±klarÄ±nÄ±n elde edilmesi, belirli Ã¶n koÅŸullarÄ±n karÅŸÄ±lanmasÄ±na baÄŸlÄ±dÄ±r:

* HesaplarÄ± Senkronizasyon API'si aracÄ±lÄ±ÄŸÄ±yla deÄŸiÅŸtirme yeteneÄŸi Ã§ok Ã¶nemlidir. Bu, Global Admin rolÃ¼ne sahip olmak veya bir AD Connect senkronizasyon hesabÄ±na sahip olmakla saÄŸlanabilir. Alternatif olarak, Hibrit Kimlik YÃ¶neticisi rolÃ¼ yeterli olacaktÄ±r, Ã§Ã¼nkÃ¼ AD Connect'i yÃ¶netme ve yeni senkronizasyon hesaplarÄ± oluÅŸturma yetkisi verir.
* **Hibrit bir hesabÄ±n** varlÄ±ÄŸÄ± gereklidir. Bu hesap, kurban hesabÄ±nÄ±n ayrÄ±ntÄ±larÄ±yla deÄŸiÅŸtirilmek Ã¼zere uygun olmalÄ± ve kimlik doÄŸrulama iÃ§in de eriÅŸilebilir olmalÄ±dÄ±r.
* Active Directory iÃ§inde bir **hedef kurban hesabÄ±nÄ±n** tanÄ±mlanmasÄ± gereklidir. SaldÄ±rÄ±, zaten senkronize edilmiÅŸ herhangi bir hesap Ã¼zerinde gerÃ§ekleÅŸtirilebilir, ancak Azure AD kiracÄ±sÄ±nÄ±n on-prem gÃ¼venlik tanÄ±mlayÄ±cÄ±larÄ±nÄ± Ã§oÄŸaltmamÄ±ÅŸ olmasÄ± gerekir; bu, bileti elde etmek iÃ§in senkronize edilmemiÅŸ bir hesabÄ±n deÄŸiÅŸtirilmesini gerektirir.
* AyrÄ±ca, bu hesabÄ±n alan yÃ¶neticisi eÅŸdeÄŸer ayrÄ±calÄ±klara sahip olmasÄ± gerekir, ancak AzureAD RODC tarafÄ±ndan geÃ§ersiz TGT'lerin Ã¼retilmesini Ã¶nlemek iÃ§in tipik AD yÃ¶netici gruplarÄ±nÄ±n bir Ã¼yesi olmamalÄ±dÄ±r.
* En uygun hedef, **AD Connect Senkronizasyon hizmeti tarafÄ±ndan kullanÄ±lan Active Directory hesabÄ±dÄ±r.** Bu hesap Azure AD ile senkronize edilmez, bu da SID'sinin geÃ§erli bir hedef olmasÄ±nÄ± saÄŸlar ve ÅŸifre karmaÅŸalarÄ±nÄ± senkronize etme rolÃ¼ nedeniyle doÄŸasÄ± gereÄŸi Alan YÃ¶neticisi eÅŸdeÄŸer ayrÄ±calÄ±klara sahiptir (Åifre Karma Senkronizasyonu aktif varsayÄ±larak). HÄ±zlÄ± kurulum olan alanlar iÃ§in bu hesap **MSOL\_** ile baÅŸlar. DiÄŸer durumlarda, hesap, alan nesnesi Ã¼zerindeki Dizin Ã‡oÄŸaltma ayrÄ±calÄ±klarÄ±na sahip tÃ¼m hesaplarÄ± listeleyerek belirlenebilir.

### Tam SaldÄ±rÄ± <a href="#the-full-attack" id="the-full-attack"></a>

Bunu orijinal gÃ¶nderide kontrol edin: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
