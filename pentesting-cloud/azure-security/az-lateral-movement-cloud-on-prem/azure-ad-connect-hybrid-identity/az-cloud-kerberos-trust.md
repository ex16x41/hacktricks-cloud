# Az - Poverenje Kerbera u oblaku

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

**Ovaj post je saÅ¾etak** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **koji se moÅ¾e proveriti za dodatne informacije o napadu. Ova tehnika je takoÄ‘e komentarisana u** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Osnovne informacije

### Poverenje

Kada se uspostavi poverenje sa Azure AD, u AD-u se kreira **Read Only Domain Controller (RODC)**. Nalog raÄunara **RODC-a** nazvan je **`AzureADKerberos$`**. TakoÄ‘e, postoji sekundarni `krbtgt` nalog nazvan **`krbtgt_AzureAD`**. Ovaj nalog sadrÅ¾i **Kerberos kljuÄeve** koji se koriste za tikete koje kreira Azure AD.

Stoga, ako je ovaj nalog kompromitovan, moguÄ‡e je preuzeti identitet bilo kog korisnika... iako to nije taÄno jer je ovom nalogu onemoguÄ‡eno kreiranje tiketa za bilo koju uobiÄajenu privilegovanu AD grupu poput Domain Admins, Enterprise Admins, Administrators...

{% hint style="danger" %}
MeÄ‘utim, u stvarnom scenariju postojaÄ‡e privilegovani korisnici koji nisu u tim grupama. Dakle, **novi krbtgt nalog, ako je kompromitovan, moÅ¾e se koristiti za preuzimanje njihovog identiteta.**
{% endhint %}

### Kerberos TGT

Osim toga, kada se korisnik autentifikuje na Windowsu koristeÄ‡i hibridni identitet **Azure AD** izdaÄ‡e **delimiÄan Kerberos tiket zajedno sa PRT-om**. TGT je delimiÄan jer **AzureAD ima ograniÄene informacije** o korisniku u on-prem AD-u (kao Å¡to su sigurnosni identifikator (SID) i ime).\
Windows moÅ¾e zatim **zameniti ovaj delimiÄan TGT za pun TGT** zahtevajuÄ‡i servisni tiket za uslugu `krbtgt`.&#x20;

### NTLM

Kako mogu postojati servisi koji ne podrÅ¾avaju Kerberos autentifikaciju veÄ‡ NTLM, moguÄ‡e je zatraÅ¾iti **delimiÄan TGT potpisan koriÅ¡Ä‡enjem sekundarnog `krbtgt`** kljuÄa ukljuÄujuÄ‡i **`KERB-KEY-LIST-REQ`** polje u **PADATA** delu zahteva, a zatim dobiti pun TGT potpisan primarnim `krbtgt` kljuÄem **ukljuÄujuÄ‡i NT hash u odgovoru**.

## Zloupotreba Poverenja Kerbera u oblaku radi dobijanja Domain Admin-a <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Kada AzureAD generiÅ¡e **delimiÄan TGT** koristiÄ‡e detalje koje ima o korisniku. Dakle, ako Globalni Admin moÅ¾e da izmeni podatke poput **sigurnosnog identifikatora i imena korisnika u AzureAD-u**, prilikom zahteva za TGT za tog korisnika **sigurnosni identifikator biÄ‡e drugaÄiji**.

To nije moguÄ‡e uraditi putem Microsoft Graph-a ili Azure AD Graph-a, ali je moguÄ‡e koristiti **API Active Directory Connect** koji koriste Globalni Admini da bi **izmenili SAM ime i SID bilo kog hibridnog korisnika**, a zatim ako se autentiÄujemo, dobijamo delimiÄan TGT koji sadrÅ¾i izmenjeni SID.

Imajte na umu da to moÅ¾emo uraditi sa AADInternals i aÅ¾urirati sinhronizovane korisnike putem [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdleta.

### Preduslovi napada <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Uspeh napada i sticanje privilegija Domain Admin-a zavise od ispunjenja odreÄ‘enih preduslova:

* MoguÄ‡nost izmene naloga putem Synchronization API-ja je kljuÄna. To se moÅ¾e postiÄ‡i imajuÄ‡i ulogu Globalnog Admina ili posedovanjem naloga za sinhronizaciju AD Connect-a. Alternativno, uloga Administratora hibridnog identiteta bi bila dovoljna, jer omoguÄ‡ava upravljanje AD Connect-om i uspostavljanje novih naloga za sinhronizaciju.
* Prisustvo **hibridnog naloga** je neophodno. Ovaj nalog mora biti podloÅ¾an izmenama sa detaljima Å¾rtvinog naloga i takoÄ‘e mora biti dostupan za autentifikaciju.
* Identifikacija **ciljnog Å¾rtvenog naloga** u Active Directory-u je neophodna. Iako se napad moÅ¾e izvrÅ¡iti na bilo koji veÄ‡ sinhronizovan nalog, Azure AD zakupac ne sme imati replikovane sigurnosne identifikatore sa lokacije, Å¡to zahteva izmenu neusklaÄ‘enog naloga radi dobijanja tiketa.
* Osim toga, ovaj nalog treba da ima privilegije ekvivalentne Domain Admin-u, ali ne sme biti Älan tipiÄnih AD administratorskih grupa kako bi se izbeglo generisanje nevaÅ¾eÄ‡ih TGT-ova od strane AzureAD RODC-a.
* Najpogodnija meta je **Active Directory nalog koji koristi AD Connect Sync servis**. Ovaj nalog nije sinhronizovan sa Azure AD-om, ostavljajuÄ‡i njegov SID kao moguÄ‡u metu, a inherentno poseduje privilegije ekvivalentne Domain Admin-u zbog svoje uloge u sinhronizaciji heÅ¡eva lozinki (ukoliko je aktivno sinhronizovanje heÅ¡eva lozinki). Za domene sa ekspres instalacijom, ovaj nalog ima prefiks **MSOL\_**. Za druge instance, nalog se moÅ¾e locirati enumeracijom svih naloga kojima su dodeljene privilegije Repliciranja direktorijuma na objektu domene.

### Potpuni napad <a href="#the-full-attack" id="the-full-attack"></a>

Proverite u originalnom postu: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
