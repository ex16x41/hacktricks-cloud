# Az - Cloud Kerberos Trust

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Esta publicaci칩n es un resumen de** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **que se puede consultar para obtener m치s informaci칩n sobre el ataque. Esta t칠cnica tambi칠n se comenta en** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Informaci칩n B치sica

### Confianza

Cuando se establece una confianza con Azure AD, se crea un **Controlador de Dominio de Solo Lectura (RODC) en el AD.** La **cuenta de computadora RODC**, llamada **`AzureADKerberos$`**. Adem치s, una cuenta secundaria `krbtgt` llamada **`krbtgt_AzureAD`**. Esta cuenta contiene las **claves de Kerberos** utilizadas para los tickets que crea Azure AD.

Por lo tanto, si esta cuenta se ve comprometida, podr칤a ser posible suplantar a cualquier usuario... aunque esto no es cierto porque se impide que esta cuenta cree tickets para cualquier grupo privilegiado com칰n de AD como Administradores de Dominio, Administradores Empresariales, Administradores...

{% hint style="danger" %}
Sin embargo, en un escenario real habr치 usuarios privilegiados que no est치n en esos grupos. As칤 que la **nueva cuenta krbtgt, si se ve comprometida, podr칤a usarse para suplantarlos.**
{% endhint %}

### Kerberos TGT

Adem치s, cuando un usuario se autentica en Windows utilizando una identidad h칤brida, **Azure AD** emitir치 un **ticket Kerberos parcial junto con el PRT.** El TGT es parcial porque **AzureAD tiene informaci칩n limitada** del usuario en el AD local (como el identificador de seguridad (SID) y el nombre).\
Windows puede entonces **intercambiar este TGT parcial por un TGT completo** solicitando un ticket de servicio para el servicio `krbtgt`.

### NTLM

Dado que podr칤a haber servicios que no admiten autenticaci칩n kerberos sino NTLM, es posible solicitar un **TGT parcial firmado utilizando una clave secundaria `krbtgt`** incluyendo el campo **`KERB-KEY-LIST-REQ`** en la parte **PADATA** de la solicitud y luego obtener un TGT completo firmado con la clave primaria `krbtgt` **incluyendo el hash NT en la respuesta**.

## Abusando de la Confianza de Kerberos en la Nube para obtener Administrador de Dominio <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Cuando AzureAD genera un **TGT parcial**, lo har치 utilizando los detalles que tiene sobre el usuario. Por lo tanto, si un Administrador Global pudiera modificar datos como el **identificador de seguridad y el nombre del usuario en AzureAD**, al solicitar un TGT para ese usuario, el **identificador de seguridad ser칤a uno diferente**.

No es posible hacer eso a trav칠s de Microsoft Graph o Azure AD Graph, pero es posible utilizar la **API que utiliza Active Directory Connect** para crear y actualizar usuarios sincronizados, que pueden ser utilizados por los Administradores Globales para **modificar el nombre SAM y el SID de cualquier usuario h칤brido**, y luego, si nos autenticamos, obtenemos un TGT parcial que contiene el SID modificado.

Tenga en cuenta que podemos hacer esto con AADInternals y actualizar a usuarios sincronizados a trav칠s del cmdlet [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Prerrequisitos del ataque <a href="#attack-prerequisites" id="attack-prerequisites"></a>

El 칠xito del ataque y la obtenci칩n de privilegios de Administrador de Dominio dependen de cumplir ciertos prerrequisitos:

* La capacidad de alterar cuentas a trav칠s de la API de Sincronizaci칩n es crucial. Esto se puede lograr teniendo el rol de Administrador Global o poseyendo una cuenta de sincronizaci칩n de AD Connect. Alternativamente, el rol de Administrador de Identidad H칤brida ser칤a suficiente, ya que otorga la capacidad de gestionar AD Connect y establecer nuevas cuentas de sincronizaci칩n.
* La presencia de una **cuenta h칤brida** es esencial. Esta cuenta debe ser susceptible a modificaci칩n con los detalles de la cuenta de la v칤ctima y tambi칠n debe ser accesible para la autenticaci칩n.
* La identificaci칩n de una **cuenta de v칤ctima objetivo** dentro de Active Directory es una necesidad. Aunque el ataque se puede ejecutar en cualquier cuenta ya sincronizada, el inquilino de Azure AD no debe haber replicado identificadores de seguridad locales, lo que requiere la modificaci칩n de una cuenta no sincronizada para obtener el ticket.
* Adem치s, esta cuenta debe poseer privilegios equivalentes a administrador de dominio, pero no debe ser miembro de grupos t칤picos de administradores de AD para evitar la generaci칩n de TGTs inv치lidos por el RODC de AzureAD.
* El objetivo m치s adecuado es la **cuenta de Active Directory utilizada por el servicio de sincronizaci칩n de AD Connect**. Esta cuenta no est치 sincronizada con Azure AD, dejando su SID como un objetivo viable, y tiene inherentemente privilegios equivalentes a Administrador de Dominio debido a su papel en la sincronizaci칩n de hashes de contrase침as (suponiendo que la Sincronizaci칩n de Hash de Contrase침a est칠 activa). Para dominios con instalaci칩n expresa, esta cuenta est치 prefijada con **MSOL\_**. Para otros casos, la cuenta se puede identificar enumerando todas las cuentas dotadas de privilegios de Replicaci칩n de Directorio en el objeto de dominio.

### El ataque completo <a href="#the-full-attack" id="the-full-attack"></a>

Cons칰ltalo en la publicaci칩n original: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
