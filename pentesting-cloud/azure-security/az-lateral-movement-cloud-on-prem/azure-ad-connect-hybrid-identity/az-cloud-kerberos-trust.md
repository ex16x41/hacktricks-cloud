# Az - Cloud Kerberos Trust

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Ovaj post je saÅ¾etak** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **koji se moÅ¾e proveriti za dodatne informacije o napadu. Ova tehnika je takoÄ‘e komentarisana u** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Osnovne informacije

### Povjerenje

Kada se uspostavi poverenje sa Azure AD, **stvara se Read Only Domain Controller (RODC) u AD-u.** **RODC korisniÄki nalog**, nazvan **`AzureADKerberos$`**. TakoÄ‘e, sekundarni `krbtgt` nalog nazvan **`krbtgt_AzureAD`**. Ovaj nalog sadrÅ¾i **Kerberos kljuÄeve** koji se koriste za karte koje Azure AD kreira.

Dakle, ako je ovaj nalog kompromitovan, moglo bi biti moguÄ‡e imitirati bilo kog korisnika... iako to nije taÄno jer je ovom nalogu onemoguÄ‡eno da kreira karte za bilo koju zajedniÄku privilegovanu AD grupu kao Å¡to su Domain Admins, Enterprise Admins, Administrators...

{% hint style="danger" %}
MeÄ‘utim, u stvarnom scenariju biÄ‡e privilegovanih korisnika koji nisu u tim grupama. Tako da bi **novi krbtgt nalog, ako bude kompromitovan, mogao biti koriÅ¡Ä‡en za imitaciju njih.**
{% endhint %}

### Kerberos TGT

Å taviÅ¡e, kada se korisnik autentifikuje na Windows-u koristeÄ‡i hibridni identitet, **Azure AD Ä‡e izdati delimiÄnu Kerberos kartu zajedno sa PRT-om.** TGT je delimiÄan jer **AzureAD ima ograniÄene informacije** o korisniku u on-prem AD-u (kao Å¡to su identifikator bezbednosti (SID) i ime).\
Windows moÅ¾e zatim **razmeniti ovu delimiÄnu TGT za punu TGT** traÅ¾eÄ‡i servisnu kartu za `krbtgt` servis.

### NTLM

Kako moÅ¾e biti usluga koja ne podrÅ¾ava Kerberos autentifikaciju, veÄ‡ NTLM, moguÄ‡e je zatraÅ¾iti **delimiÄnu TGT potpisanu koristeÄ‡i sekundarni `krbtgt`** kljuÄ ukljuÄujuÄ‡i **`KERB-KEY-LIST-REQ`** polje u **PADATA** delu zahteva i zatim dobiti punu TGT potpisanu primarnim `krbtgt` kljuÄem **ukljuÄujuÄ‡i NT hash u odgovoru**.

## Zloupotreba Cloud Kerberos Trust za dobijanje Domain Admin <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Kada AzureAD generiÅ¡e **delimiÄnu TGT**, koristiÄ‡e detalje koje ima o korisniku. Dakle, ako bi Global Admin mogao da izmeni podatke kao Å¡to su **identifikator bezbednosti i ime korisnika u AzureAD**, kada zatraÅ¾i TGT za tog korisnika, **identifikator bezbednosti bi bio drugaÄiji**.

Nije moguÄ‡e to uÄiniti putem Microsoft Graph-a ili Azure AD Graph-a, ali je moguÄ‡e koristiti **API koji Active Directory Connect** koristi za kreiranje i aÅ¾uriranje sinhronizovanih korisnika, Å¡to mogu koristiti Global Admini da **izmene SAM ime i SID bilo kog hibridnog korisnika**, a zatim, ako se autentifikujemo, dobijamo delimiÄnu TGT koja sadrÅ¾i izmenjeni SID.

Napomena da ovo moÅ¾emo uÄiniti sa AADInternals i aÅ¾urirati sinhronizovane korisnike putem [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdlet-a.

### Preduslovi za napad <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Uspeh napada i sticanje privilegija Domain Admin zavise od ispunjavanja odreÄ‘enih preduslova:

* Sposobnost da se menjaju nalozi putem Synchronization API je kljuÄna. To se moÅ¾e postiÄ‡i imajuÄ‡i ulogu Global Admin ili posedujuÄ‡i AD Connect sinhronizovani nalog. Alternativno, uloga Hybrid Identity Administrator bi bila dovoljna, jer omoguÄ‡ava upravljanje AD Connect-om i uspostavljanje novih sinhronizovanih naloga.
* Prisutnost **hibridnog naloga** je neophodna. Ovaj nalog mora biti podloÅ¾an izmeni sa podacima Å¾rtvovanog naloga i takoÄ‘e bi trebao biti dostupan za autentifikaciju.
* Identifikacija **ciljnog naloga Å¾rtve** unutar Active Directory je neophodna. Iako se napad moÅ¾e izvrÅ¡iti na bilo kom nalogu koji je veÄ‡ sinhronizovan, Azure AD tenant ne sme imati replicirane on-premises identifikatore bezbednosti, Å¡to zahteva izmenu nesinhronizovanog naloga kako bi se dobila karta.
* Pored toga, ovaj nalog bi trebao imati privilegije jednake privilegijama domain admin-a, ali ne sme biti Älan tipiÄnih AD administrator grupa kako bi se izbegla generacija nevaÅ¾eÄ‡ih TGT-ova od strane AzureAD RODC-a.
* Najpogodniji cilj je **Active Directory nalog koji koristi AD Connect Sync servis**. Ovaj nalog nije sinhronizovan sa Azure AD, ostavljajuÄ‡i njegov SID kao moguÄ‡i cilj, i inherentno ima privilegije jednake privilegijama domain admin-a zbog svoje uloge u sinhronizaciji heÅ¡ova lozinki (pod pretpostavkom da je Password Hash Sync aktivan). Za domene sa ekspresnom instalacijom, ovaj nalog je prefiksiran sa **MSOL\_**. Za druge instance, nalog se moÅ¾e identifikovati prebrojavanjem svih naloga koji imaju privilegije replikacije direktorijuma na objektu domena.

### Potpuni napad <a href="#the-full-attack" id="the-full-attack"></a>

Proverite u originalnom postu: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
