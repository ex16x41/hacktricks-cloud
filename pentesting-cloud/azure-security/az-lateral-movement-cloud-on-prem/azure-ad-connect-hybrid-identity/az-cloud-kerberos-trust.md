# Az - Cloud Kerberos Trust

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

**Dieser Beitrag ist eine Zusammenfassung von** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **die f√ºr weitere Informationen √ºber den Angriff √ºberpr√ºft werden kann. Diese Technik wird auch in** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)** kommentiert.**

## Grundinformationen

### Vertrauen

Wenn ein Vertrauen mit Azure AD hergestellt wird, wird ein **Read Only Domain Controller (RODC) im AD erstellt.** Das **RODC-Computer-Konto** hei√üt **`AzureADKerberos$`**. Au√üerdem gibt es ein sekund√§res `krbtgt`-Konto mit dem Namen **`krbtgt_AzureAD`**. Dieses Konto enth√§lt die **Kerberos-Schl√ºssel**, die f√ºr Tickets verwendet werden, die Azure AD erstellt.

Daher, wenn dieses Konto kompromittiert wird, k√∂nnte es m√∂glich sein, sich als jeder Benutzer auszugeben... obwohl dies nicht zutrifft, da dieses Konto daran gehindert wird, Tickets f√ºr g√§ngige privilegierte AD-Gruppen wie Domain Admins, Enterprise Admins, Administrators... zu erstellen.

{% hint style="danger" %}
In einem realen Szenario wird es jedoch privilegierte Benutzer geben, die nicht in diesen Gruppen sind. Daher k√∂nnte das **neue krbtgt-Konto, wenn es kompromittiert wird, verwendet werden, um sich als sie auszugeben.**
{% endhint %}

### Kerberos TGT

Dar√ºber hinaus, wenn sich ein Benutzer unter Windows mit einer hybriden Identit√§t authentifiziert, wird **Azure AD ein partielles Kerberos-Ticket zusammen mit dem PRT ausstellen.** Das TGT ist partiell, weil **AzureAD nur begrenzte Informationen** √ºber den Benutzer im lokalen AD hat (wie die Sicherheitskennung (SID) und den Namen).\
Windows kann dann **dieses partielle TGT gegen ein vollst√§ndiges TGT eintauschen**, indem es ein Serviceticket f√ºr den `krbtgt`-Dienst anfordert.

### NTLM

Da es Dienste geben k√∂nnte, die keine Kerberos-Authentifizierung, sondern NTLM unterst√ºtzen, ist es m√∂glich, ein **partielles TGT zu beantragen, das mit einem sekund√§ren `krbtgt`**-Schl√ºssel signiert ist, indem das **`KERB-KEY-LIST-REQ`**-Feld im **PADATA**-Teil der Anfrage enthalten ist, und dann ein vollst√§ndiges TGT zu erhalten, das mit dem prim√§ren `krbtgt`-Schl√ºssel **einschlie√ülich des NT-Hashes in der Antwort** signiert ist.

## Missbrauch von Cloud Kerberos Trust, um Domain Admin zu erhalten <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Wenn AzureAD ein **partielles TGT** generiert, verwendet es die Details, die es √ºber den Benutzer hat. Daher, wenn ein Global Admin Daten wie die **Sicherheitskennung und den Namen des Benutzers in AzureAD** √§ndern k√∂nnte, w√§re die **Sicherheitskennung bei der Anforderung eines TGT f√ºr diesen Benutzer eine andere**.

Es ist nicht m√∂glich, dies √ºber die Microsoft Graph oder die Azure AD Graph zu tun, aber es ist m√∂glich, die **API zu verwenden, die Active Directory Connect** verwendet, um synchronisierte Benutzer zu erstellen und zu aktualisieren, was von den Global Admins verwendet werden kann, um **den SAM-Namen und die SID eines hybriden Benutzers zu √§ndern**, und dann, wenn wir uns authentifizieren, erhalten wir ein partielles TGT, das die ge√§nderte SID enth√§lt.

Beachten Sie, dass wir dies mit AADInternals tun k√∂nnen und die synchronisierten Benutzer √ºber das [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) Cmdlet aktualisieren k√∂nnen.

### Angriffsvoraussetzungen <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Der Erfolg des Angriffs und der Erwerb von Domain Admin-Rechten h√§ngen von der Erf√ºllung bestimmter Voraussetzungen ab:

* Die F√§higkeit, Konten √ºber die Synchronisierungs-API zu √§ndern, ist entscheidend. Dies kann erreicht werden, indem man die Rolle des Global Admin hat oder ein AD Connect-Synchronisierungskonto besitzt. Alternativ w√ºrde die Rolle des Hybrid Identity Administrators ausreichen, da sie die F√§higkeit verleiht, AD Connect zu verwalten und neue Synchronisierungskonten zu erstellen.
* Das Vorhandensein eines **hybriden Kontos** ist unerl√§sslich. Dieses Konto muss f√ºr die √Ñnderung mit den Details des Opferkontos geeignet sein und sollte auch f√ºr die Authentifizierung zug√§nglich sein.
* Die Identifizierung eines **Zielopferkontos** innerhalb des Active Directory ist notwendig. Obwohl der Angriff auf jedes bereits synchronisierte Konto ausgef√ºhrt werden kann, darf der Azure AD-Mandant keine replizierten lokalen Sicherheitskennungen haben, was die √Ñnderung eines nicht synchronisierten Kontos erforderlich macht, um das Ticket zu beschaffen.
* Dar√ºber hinaus sollte dieses Konto √ºber gleichwertige Domain-Admin-Rechte verf√ºgen, darf jedoch kein Mitglied typischer AD-Administratorgruppen sein, um die Generierung ung√ºltiger TGTs durch den AzureAD RODC zu vermeiden.
* Das am besten geeignete Ziel ist das **Active Directory-Konto, das vom AD Connect Sync-Dienst verwendet wird**. Dieses Konto wird nicht mit Azure AD synchronisiert, wodurch seine SID ein viables Ziel bleibt, und es hat aufgrund seiner Rolle bei der Synchronisierung von Passwort-Hashes (vorausgesetzt, die Passwort-Hash-Synchronisierung ist aktiv) von Natur aus gleichwertige Domain-Admin-Rechte. F√ºr Dom√§nen mit Express-Installation wird dieses Konto mit **MSOL\_** vorangestellt. In anderen F√§llen kann das Konto identifiziert werden, indem alle Konten aufgelistet werden, die √ºber Verzeichnisreplikationsrechte auf dem Dom√§nenobjekt verf√ºgen.

### Der vollst√§ndige Angriff <a href="#the-full-attack" id="the-full-attack"></a>

√úberpr√ºfen Sie es im Originalbeitrag: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
