# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

[Belgelerden:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication, kullanÄ±cÄ±larÄ±nÄ±zÄ±n **hem yerel hem de bulut tabanlÄ± uygulamalara aynÄ± ÅŸifreleri kullanarak giriÅŸ yapmalarÄ±nÄ±** saÄŸlar. Bu Ã¶zellik, kullanÄ±cÄ±larÄ±nÄ±za daha iyi bir deneyim sunar - hatÄ±rlanacak bir ÅŸifre daha az ve IT yardÄ±m masasÄ± maliyetlerini azaltÄ±r Ã§Ã¼nkÃ¼ kullanÄ±cÄ±larÄ±nÄ±zÄ±n giriÅŸ yapmayÄ± unutma olasÄ±lÄ±ÄŸÄ± daha dÃ¼ÅŸÃ¼ktÃ¼r. KullanÄ±cÄ±lar Azure AD kullanarak giriÅŸ yaptÄ±ÄŸÄ±nda, bu Ã¶zellik **kullanÄ±cÄ±larÄ±n ÅŸifrelerini doÄŸrudan yerel Active Directory'nizle doÄŸrular**.

PTA'da **kimlikler** **senkronize** edilir ancak **ÅŸifreler** **senkronize edilmez**; bu PHS'de olduÄŸu gibi.

Kimlik doÄŸrulama yerel AD'de doÄŸrulanÄ±r ve bulutla iletiÅŸim, **yerel bir sunucuda** Ã§alÄ±ÅŸan bir **kimlik doÄŸrulama ajanÄ±** tarafÄ±ndan gerÃ§ekleÅŸtirilir (bu, yerel DC'de olmak zorunda deÄŸildir).

### Kimlik DoÄŸrulama AkÄ±ÅŸÄ±

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. KullanÄ±cÄ± **giriÅŸ yapmak** iÃ§in **Azure AD'ye** yÃ¶nlendirilir, burada **kullanÄ±cÄ± adÄ±** ve **ÅŸifre** gÃ¶nderir.
2. **Kimlik bilgileri** **ÅŸifrelenir** ve Azure AD'de bir **kuvvet** iÃ§ine yerleÅŸtirilir.
3. **Yerel kimlik doÄŸrulama ajanÄ±**, kuyruktan **kimlik bilgilerini** toplar ve **ÅŸifreler**. Bu ajana **"Pass-through authentication agent"** veya **PTA ajanÄ±** denir.
4. **Ajan**, kimlik bilgilerini **yerel AD** ile doÄŸrular ve **yanÄ±tÄ±** **geri** Azure AD'ye gÃ¶nderir; eÄŸer yanÄ±t olumluysa, **kullanÄ±cÄ±nÄ±n giriÅŸini tamamlar**.

{% hint style="warning" %}
EÄŸer bir saldÄ±rgan **PTA'yÄ± ele geÃ§irirse**, kuyruktaki tÃ¼m **kimlik bilgilerini** (ÅŸifrelenmemiÅŸ olarak) **gÃ¶rebilir**.\
AyrÄ±ca AzureAD'ye **herhangi bir kimlik bilgisini doÄŸrulayabilir** (Skeleton key'e benzer bir saldÄ±rÄ±).
{% endhint %}

### Yerel -> bulut

EÄŸer **PTA** **ajanÄ±** Ã§alÄ±ÅŸan **Azure AD Connect sunucusuna** **yÃ¶netici** eriÅŸiminiz varsa, **TÃ¼m ÅŸifreleri** doÄŸrulayacak bir **arka kapÄ±** **eklemek iÃ§in** **AADInternals** modÃ¼lÃ¼nÃ¼ kullanabilirsiniz:
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
EÄŸer **kurulum baÅŸarÄ±sÄ±z olursa**, bu muhtemelen eksik [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe) nedeniyle olabilir.
{% endhint %}

AyrÄ±ca, Ã¶nceki arka kapÄ±nÄ±n kurulu olduÄŸu makinede aÅŸaÄŸÄ±daki cmdlet'i kullanarak **PTA ajanÄ±na gÃ¶nderilen dÃ¼z metin ÅŸifrelerini gÃ¶rmek** de mÃ¼mkÃ¼ndÃ¼r:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
This backdoor will:

* Gizli bir klasÃ¶r oluÅŸturur `C:\PTASpy`
* `PTASpy.dll` dosyasÄ±nÄ± `C:\PTASpy`'ye kopyalar
* `PTASpy.dll` dosyasÄ±nÄ± `AzureADConnectAuthenticationAgentService` sÃ¼recine enjekte eder

{% hint style="info" %}
AzureADConnectAuthenticationAgent servisi yeniden baÅŸlatÄ±ldÄ±ÄŸÄ±nda, PTASpy "boÅŸaltÄ±lÄ±r" ve yeniden yÃ¼klenmesi gerekir.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Bulutta **GA ayrÄ±calÄ±klarÄ±** alÄ±ndÄ±ktan sonra, **saldÄ±rgan kontrolÃ¼ndeki bir makinede** yeni bir PTA ajanÄ± **kaydetmek** mÃ¼mkÃ¼ndÃ¼r. Ajan **kurulduktan** sonra, **herhangi bir ÅŸifre** kullanarak **kimlik doÄŸrulama** yapmak ve ayrÄ±ca, **ÅŸifreleri dÃ¼z metin olarak almak** iÃ§in **Ã¶nceki** adÄ±mlarÄ± **tekrarlayabiliriz.**
{% endhint %}

### Seamless SSO

PTA ile Seamless SSO kullanmak mÃ¼mkÃ¼ndÃ¼r, bu da diÄŸer kÃ¶tÃ¼ye kullanÄ±mlara aÃ§Ä±ktÄ±r. Bunu kontrol edin:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
