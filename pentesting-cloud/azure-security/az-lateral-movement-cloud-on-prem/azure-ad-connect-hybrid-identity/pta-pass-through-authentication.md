# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication allows your users to **sign in to both on-premises and cloud-based applications using the same passwords**. This feature provides your users a better experience - one less password to remember, and reduces IT helpdesk costs because your users are less likely to forget how to sign in. When users sign in using Azure AD, this feature **validates users' passwords directly against your on-premises Active Directory**.

PTAì—ì„œ **ì•„ì´ë´í‹°í‹°**ëŠ” **ë™ê¸°í™”**ë˜ì§€ë§Œ **ë¹„ë°€ë²ˆí˜¸**ëŠ” PHSì²˜ëŸ¼ **ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.

ì¸ì¦ì€ ì˜¨í”„ë ˆë¯¸ìŠ¤ ADì—ì„œ ê²€ì¦ë˜ë©°, í´ë¼ìš°ë“œì™€ì˜ í†µì‹ ì€ **ì˜¨í”„ë ˆë¯¸ìŠ¤ ì„œë²„**ì—ì„œ ì‹¤í–‰ë˜ëŠ” **ì¸ì¦ ì—ì´ì „íŠ¸**ì— ì˜í•´ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤ (ì˜¨í”„ë ˆë¯¸ìŠ¤ DCì— ìˆì„ í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤).

### Authentication flow

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. **ë¡œê·¸ì¸**ì„ ìœ„í•´ ì‚¬ìš©ìëŠ” **Azure AD**ë¡œ ë¦¬ë””ë ‰ì…˜ë˜ë©°, ì—¬ê¸°ì„œ **ì‚¬ìš©ì ì´ë¦„**ê³¼ **ë¹„ë°€ë²ˆí˜¸**ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
2. **ìê²© ì¦ëª…**ì€ **ì•”í˜¸í™”**ë˜ì–´ Azure ADì˜ **í**ì— ì„¤ì •ë©ë‹ˆë‹¤.
3. **ì˜¨í”„ë ˆë¯¸ìŠ¤ ì¸ì¦ ì—ì´ì „íŠ¸**ê°€ íì—ì„œ **ìê²© ì¦ëª…**ì„ ìˆ˜ì§‘í•˜ê³  **ë³µí˜¸í™”**í•©ë‹ˆë‹¤. ì´ ì—ì´ì „íŠ¸ëŠ” **"Pass-through authentication agent"** ë˜ëŠ” **PTA agent**ë¼ê³  ë¶ˆë¦½ë‹ˆë‹¤.
4. **ì—ì´ì „íŠ¸**ëŠ” **ì˜¨í”„ë ˆë¯¸ìŠ¤ AD**ì—ì„œ ìê²© ì¦ëª…ì„ **ê²€ì¦**í•˜ê³  **ì‘ë‹µ**ì„ Azure ADë¡œ **ì „ì†¡**í•©ë‹ˆë‹¤. ì‘ë‹µì´ ê¸ì •ì ì´ë©´ ì‚¬ìš©ìì˜ **ë¡œê·¸ì¸ì´ ì™„ë£Œ**ë©ë‹ˆë‹¤.

{% hint style="warning" %}
ê³µê²©ìê°€ **PTA**ë¥¼ **ì¹¨í•´**í•˜ë©´ íì— ìˆëŠ” ëª¨ë“  **ìê²© ì¦ëª…**ì„ **ëª…í™•í•œ í…ìŠ¤íŠ¸**ë¡œ **ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.\
ë˜í•œ **ëª¨ë“  ìê²© ì¦ëª…**ì„ AzureADì— **ê²€ì¦**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (Skeleton keyì™€ ìœ ì‚¬í•œ ê³µê²©).
{% endhint %}

### On-Prem -> cloud

**PTA** **ì—ì´ì „íŠ¸**ê°€ ì‹¤í–‰ ì¤‘ì¸ **Azure AD Connect ì„œë²„**ì— **ê´€ë¦¬ì** ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” ê²½ìš°, **AADInternals** ëª¨ë“ˆì„ ì‚¬ìš©í•˜ì—¬ **ëª¨ë“  ë¹„ë°€ë²ˆí˜¸**ë¥¼ **ê²€ì¦**í•˜ëŠ” **ë°±ë„ì–´**ë¥¼ **ì‚½ì…**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ë”°ë¼ì„œ ëª¨ë“  ë¹„ë°€ë²ˆí˜¸ê°€ ì¸ì¦ì— ìœ íš¨í•˜ê²Œ ë©ë‹ˆë‹¤):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
**ì„¤ì¹˜ê°€ ì‹¤íŒ¨**í•˜ëŠ” ê²½ìš°, ì´ëŠ” [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe)ê°€ ëˆ„ë½ë˜ì—ˆê¸° ë•Œë¬¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ì´ì „ ë°±ë„ì–´ê°€ ì„¤ì¹˜ëœ ë¨¸ì‹ ì—ì„œ ë‹¤ìŒ cmdletì„ ì‚¬ìš©í•˜ì—¬ **PTA ì—ì´ì „íŠ¸ë¡œ ì „ì†¡ëœ í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤**:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
ì´ ë°±ë„ì–´ëŠ” ë‹¤ìŒì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

* ìˆ¨ê²¨ì§„ í´ë” `C:\PTASpy` ìƒì„±
* `PTASpy.dll`ì„ `C:\PTASpy`ì— ë³µì‚¬
* `PTASpy.dll`ì„ `AzureADConnectAuthenticationAgentService` í”„ë¡œì„¸ìŠ¤ì— ì£¼ì…

{% hint style="info" %}
AzureADConnectAuthenticationAgent ì„œë¹„ìŠ¤ê°€ ì¬ì‹œì‘ë˜ë©´, PTASpyëŠ” "ì–¸ë¡œë“œ"ë˜ê³  ë‹¤ì‹œ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
í´ë¼ìš°ë“œì—ì„œ **GA ê¶Œí•œ**ì„ ì–»ì€ í›„, **ê³µê²©ìê°€ ì œì–´í•˜ëŠ” ë¨¸ì‹ **ì— **ìƒˆë¡œìš´ PTA ì—ì´ì „íŠ¸**ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—ì´ì „íŠ¸ê°€ **ì„¤ì¹˜**ë˜ë©´, **ì´ì „** ë‹¨ê³„ë¥¼ **ë°˜ë³µ**í•˜ì—¬ **ì–´ë–¤ ë¹„ë°€ë²ˆí˜¸ë¡œë„ ì¸ì¦**í•  ìˆ˜ ìˆìœ¼ë©°, **í‰ë¬¸ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**
{% endhint %}

### Seamless SSO

PTAì™€ í•¨ê»˜ Seamless SSOë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ë‹¤ë¥¸ ì•…ìš©ì— ì·¨ì•½í•©ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒì„ ì°¸ì¡°í•˜ì„¸ìš”:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
AWS Hacking í•™ìŠµ ë° ì—°ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking í•™ìŠµ ë° ì—°ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* **PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
