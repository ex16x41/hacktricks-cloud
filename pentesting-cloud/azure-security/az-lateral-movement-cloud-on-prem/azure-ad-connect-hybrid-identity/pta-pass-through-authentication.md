# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basiese Inligting

[Uit die dokumentasie:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication laat jou gebruikers toe om **in te teken op beide plaaslike en wolk-gebaseerde toepassings met dieselfde wagwoorde**. Hierdie funksie bied jou gebruikers 'n beter ervaring - een minder wagwoord om te onthou, en verminder IT helpdesk koste omdat jou gebruikers minder geneig is om te vergeet hoe om in te teken. Wanneer gebruikers in teken met Azure AD, **valideer hierdie funksie gebruikers se wagwoorde direk teen jou plaaslike Active Directory**.

In PTA **identiteite** is **gesinchroniseer** maar **wagwoorde** **is nie** soos in PHS nie.

Die verifikasie word in die plaaslike AD gevalideer en die kommunikasie met die wolk word gedoen deur 'n **verifikasie agent** wat op 'n **plaaslike bediener** loop (dit hoef nie op die plaaslike DC te wees nie).

### Verifikasie vloei

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. Om te **log in** word die gebruiker na **Azure AD** herlei, waar hy die **gebruikersnaam** en **wagwoord** stuur.
2. Die **bewyse** word **ge√´nkripteer** en in 'n **ry** in Azure AD gestel.
3. Die **plaaslike verifikasie agent** versamel die **bewyse** uit die ry en **dekripteer** dit. Hierdie agent word **"Pass-through authentication agent"** of **PTA agent** genoem.
4. Die **agent** **valideer** die bewys teen die **plaaslike AD** en stuur die **antwoord** **terug** na Azure AD wat, indien die antwoord positief is, die **inlog van die gebruiker voltooi**.

{% hint style="warning" %}
As 'n aanvaller die **PTA** **kompromitteer**, kan hy die alle **bewyse** uit die ry **sien** (in **duidelike teks**).\
Hy kan ook **enige bewys** na die AzureAD **valideer** (soortgelyke aanval as Skeleton key).
{% endhint %}

### Plaaslik -> wolk

As jy **admin** toegang het tot die **Azure AD Connect bediener** met die **PTA** **agent** wat loop, kan jy die **AADInternals** module gebruik om 'n **terugdeur** te **invoeg** wat **AL die wagwoorde** wat ingevoer word, **sal valideer** (sodat al die wagwoorde geldig sal wees vir verifikasie):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
As die **installasie misluk**, is dit waarskynlik as gevolg van ontbrekende [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

Dit is ook moontlik om **die duidelike teks wagwoorde wat na die PTA-agent gestuur is** te sien deur die volgende cmdlet op die masjien waar die vorige agterdeur ge√Ønstalleer is:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
This backdoor will:

* Create a hidden folder `C:\PTASpy`
* Copy a `PTASpy.dll` to `C:\PTASpy`
* Injects `PTASpy.dll` to `AzureADConnectAuthenticationAgentService` process

{% hint style="info" %}
Wanneer die AzureADConnectAuthenticationAgent diens herbegin word, word PTASpy ‚Äúontlaai‚Äù en moet dit weer ge√Ønstalleer word.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Nadat **GA bevoegdhede** op die wolk verkry is, is dit moontlik om 'n **nuwe PTA-agent** te **registreer** deur dit op 'n **aanvaller beheerde masjien** in te stel. Sodra die agent **opgestel** is, kan ons die **vorige** stappe **herhaal** om **te autentiseer met enige wagwoord** en ook, **die wagwoorde in duidelike teks te verkry.**
{% endhint %}

### Seamless SSO

Dit is moontlik om Seamless SSO met PTA te gebruik, wat kwesbaar is vir ander misbruik. Kontroleer dit in:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
