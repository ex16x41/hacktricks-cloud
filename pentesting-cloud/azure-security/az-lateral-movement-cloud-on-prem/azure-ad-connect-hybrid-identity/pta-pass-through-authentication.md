# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication은 사용자가 **온프레미스 및 클라우드 기반 애플리케이션에 동일한 비밀번호를 사용하여 로그인할 수 있도록** 합니다. 이 기능은 사용자가 기억해야 할 비밀번호를 줄여 더 나은 경험을 제공하며, 사용자가 로그인 방법을 잊어버릴 가능성이 줄어들어 IT 헬프데스크 비용을 절감합니다. 사용자가 Azure AD를 사용하여 로그인할 때, 이 기능은 **온프레미스 Active Directory에 대해 사용자의 비밀번호를 직접 검증**합니다.

PTA에서는 **아이덴티티**가 **동기화**되지만 **비밀번호**는 PHS와 달리 **동기화되지 않습니다**.

인증은 온프레미스 AD에서 검증되며, 클라우드와의 통신은 **온프레미스 서버**에서 실행되는 **인증 에이전트**에 의해 이루어집니다(온프레미스 DC에 있을 필요는 없습니다).

### Authentication flow

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. 사용자는 **로그인**을 위해 **Azure AD**로 리디렉션되며, 여기서 **사용자 이름**과 **비밀번호**를 보냅니다.
2. **자격 증명**은 **암호화**되어 Azure AD의 **큐**에 설정됩니다.
3. **온프레미스 인증 에이전트**가 큐에서 **자격 증명**을 수집하고 **복호화**합니다. 이 에이전트를 **"Pass-through authentication agent"** 또는 **PTA agent**라고 합니다.
4. **에이전트**가 **온프레미스 AD**에 대해 자격 증명을 **검증**하고, **응답**을 Azure AD로 **전송**합니다. 응답이 긍정적일 경우, 사용자의 **로그인을 완료**합니다.

{% hint style="warning" %}
공격자가 **PTA**를 **타협**하면 큐에서 모든 **자격 증명**을 **평문**으로 **볼 수 있습니다**.\
그는 또한 AzureAD에 대해 **모든 자격 증명**을 **검증**할 수 있습니다(스켈레톤 키와 유사한 공격).
{% endhint %}

### On-Prem -> cloud

**Azure AD Connect 서버**에 **PTA** **에이전트**가 실행 중인 **관리자** 액세스가 있는 경우, **AADInternals** 모듈을 사용하여 **모든 비밀번호**가 **유효한 인증**을 위해 **검증**되도록 **백도어**를 **삽입**할 수 있습니다:
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
설치가 **실패하는 경우**, 이는 아마도 [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe)가 누락되었기 때문입니다.
{% endhint %}

이전 백도어가 설치된 머신에서 다음 cmdlet을 사용하여 **PTA 에이전트에 전송된 평문 비밀번호를 볼 수 있습니다**:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
이 백도어는 다음을 수행합니다:

* 숨겨진 폴더 `C:\PTASpy`를 생성합니다.
* `PTASpy.dll`을 `C:\PTASpy`에 복사합니다.
* `PTASpy.dll`을 `AzureADConnectAuthenticationAgentService` 프로세스에 주입합니다.

{% hint style="info" %}
AzureADConnectAuthenticationAgent 서비스가 재시작되면 PTASpy가 “언로드”되며 다시 설치해야 합니다.
{% endhint %}

### 클라우드 -> 온프레미스

{% hint style="danger" %}
클라우드에서 **GA 권한**을 얻은 후, **공격자가 제어하는 머신**에 설정하여 **새 PTA 에이전트**를 **등록**할 수 있습니다. 에이전트가 **설정**되면, **이전** 단계를 **반복**하여 **모든 비밀번호를 사용하여 인증**하고, **비밀번호를 평문으로 가져올** 수 있습니다.
{% endhint %}

### 원활한 SSO

PTA와 함께 원활한 SSO를 사용할 수 있으며, 이는 다른 남용에 취약합니다. 확인해 보세요:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## 참고자료

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem_admin/#pass-through-authentication)

{% hint style="success" %}
AWS 해킹 배우고 연습하기:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP 해킹 배우고 연습하기: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원하기</summary>

* [**구독 계획**](https://github.com/sponsors/carlospolop) 확인하기!
* **💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 참여하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**를 팔로우하세요.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) 깃허브 리포지토리에 PR을 제출하여 해킹 팁을 공유하세요.**

</details>
{% endhint %}
