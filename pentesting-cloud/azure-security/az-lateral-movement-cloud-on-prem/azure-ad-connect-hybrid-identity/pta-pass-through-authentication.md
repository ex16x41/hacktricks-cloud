# Az - PTA - Pass-through Authentication

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication å…è®¸ç”¨æˆ·ä½¿ç”¨ç›¸åŒçš„å¯†ç ç™»å½•æœ¬åœ°å’ŒåŸºäºäº‘çš„åº”ç”¨ç¨‹åºã€‚æ­¤åŠŸèƒ½ä¸ºç”¨æˆ·æä¾›äº†æ›´å¥½çš„ä½“éªŒâ€”â€”å°‘è®°ä¸€ä¸ªå¯†ç ï¼Œå¹¶å‡å°‘äº† IT å¸®åŠ©å°çš„æˆæœ¬ï¼Œå› ä¸ºç”¨æˆ·ä¸å¤ªå¯èƒ½å¿˜è®°å¦‚ä½•ç™»å½•ã€‚å½“ç”¨æˆ·ä½¿ç”¨ Azure AD ç™»å½•æ—¶ï¼Œæ­¤åŠŸèƒ½ç›´æ¥é’ˆå¯¹æœ¬åœ° Active Directory éªŒè¯ç”¨æˆ·çš„å¯†ç ã€‚

åœ¨ PTA ä¸­ï¼Œèº«ä»½æ˜¯åŒæ­¥çš„ï¼Œä½†å¯†ç ä¸åƒåœ¨ PHS ä¸­é‚£æ ·åŒæ­¥ã€‚

èº«ä»½éªŒè¯åœ¨æœ¬åœ° AD ä¸­éªŒè¯ï¼Œä¸äº‘çš„é€šä¿¡ç”±è¿è¡Œåœ¨æœ¬åœ°æœåŠ¡å™¨ä¸Šçš„èº«ä»½éªŒè¯ä»£ç†å®Œæˆï¼ˆä¸éœ€è¦åœ¨æœ¬åœ° DC ä¸Šï¼‰ã€‚

### èº«ä»½éªŒè¯æµç¨‹

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. ä¸ºäº†ç™»å½•ï¼Œç”¨æˆ·è¢«é‡å®šå‘åˆ° Azure ADï¼Œåœ¨é‚£é‡Œä»–å‘é€ç”¨æˆ·åå’Œå¯†ç 
2. å‡­æ®è¢«åŠ å¯†å¹¶è®¾ç½®åœ¨ Azure AD çš„é˜Ÿåˆ—ä¸­
3. æœ¬åœ°èº«ä»½éªŒè¯ä»£ç†ä»é˜Ÿåˆ—ä¸­æ”¶é›†å‡­æ®å¹¶è§£å¯†å®ƒä»¬ã€‚æ­¤ä»£ç†ç§°ä¸ºâ€œPass-through authentication agentâ€æˆ– PTA ä»£ç†ã€‚
4. ä»£ç†åœ¨æœ¬åœ° AD ä¸­éªŒè¯å‡­æ®ï¼Œå¹¶å°†å“åº”å‘é€å› Azure ADï¼Œå¦‚æœå“åº”æ˜¯æ­£é¢çš„ï¼Œåˆ™å®Œæˆç”¨æˆ·çš„ç™»å½•ã€‚

{% hint style="warning" %}
å¦‚æœæ”»å‡»è€…æ”»é™·äº† PTAï¼Œä»–å¯ä»¥çœ‹åˆ°é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‡­æ®ï¼ˆæ˜æ–‡ï¼‰ã€‚\
ä»–è¿˜å¯ä»¥éªŒè¯ä»»ä½•å‡­æ®åˆ° AzureADï¼ˆç±»ä¼¼äº Skeleton key çš„æ”»å‡»ï¼‰ã€‚
{% endhint %}

### æœ¬åœ° -> äº‘

å¦‚æœä½ æ‹¥æœ‰è¿è¡Œ PTA ä»£ç†çš„ Azure AD Connect æœåŠ¡å™¨çš„ç®¡ç†å‘˜è®¿é—®æƒé™ï¼Œä½ å¯ä»¥ä½¿ç”¨ AADInternals æ¨¡å—æ’å…¥ä¸€ä¸ªåé—¨ï¼Œè¯¥åé—¨å°†éªŒè¯æ‰€æœ‰è¾“å…¥çš„å¯†ç ï¼ˆå› æ­¤æ‰€æœ‰å¯†ç éƒ½å°†æœ‰æ•ˆè¿›è¡Œèº«ä»½éªŒè¯ï¼‰ï¼š
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
å¦‚æœ**å®‰è£…å¤±è´¥**ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºç¼ºå°‘[Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe)ã€‚
{% endhint %}

è¿˜å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ cmdlet åœ¨å®‰è£…äº†å…ˆå‰åé—¨çš„æœºå™¨ä¸Š**æŸ¥çœ‹å‘é€åˆ° PTA agent çš„æ˜æ–‡å¯†ç **ï¼š
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
This backdoor will:

* Create a hidden folder `C:\PTASpy`
* Copy a `PTASpy.dll` to `C:\PTASpy`
* Injects `PTASpy.dll` to `AzureADConnectAuthenticationAgentService` process

{% hint style="info" %}
å½“ AzureADConnectAuthenticationAgent æœåŠ¡é‡æ–°å¯åŠ¨æ—¶ï¼ŒPTASpy ä¼šè¢«â€œå¸è½½â€ï¼Œå¿…é¡»é‡æ–°å®‰è£…ã€‚
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
åœ¨äº‘ç«¯è·å¾— **GA æƒé™** åï¼Œå¯ä»¥é€šè¿‡åœ¨ **æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨** ä¸Šè®¾ç½®æ¥ **æ³¨å†Œä¸€ä¸ªæ–°çš„ PTA ä»£ç†**ã€‚ä»£ç† **è®¾ç½®** å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥ **é‡å¤** **ä¹‹å‰** çš„æ­¥éª¤æ¥ **ä½¿ç”¨ä»»ä½•å¯†ç è¿›è¡Œèº«ä»½éªŒè¯**ï¼Œå¹¶ä¸” **è·å–æ˜æ–‡å¯†ç ã€‚**
{% endhint %}

### Seamless SSO

å¯ä»¥å°† Seamless SSO ä¸ PTA ä¸€èµ·ä½¿ç”¨ï¼Œè¿™å®¹æ˜“å—åˆ°å…¶ä»–æ»¥ç”¨ã€‚è¯·æŸ¥çœ‹ï¼š

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
