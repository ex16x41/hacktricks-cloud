# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authenticationã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ**åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ãŠã‚ˆã³ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™**ã€‚ã“ã®æ©Ÿèƒ½ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã‚ˆã‚Šè‰¯ã„ä½“é¨“ã‚’æä¾›ã—ã€ITãƒ˜ãƒ«ãƒ—ãƒ‡ã‚¹ã‚¯ã®ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAzure ADã‚’ä½¿ç”¨ã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã¨ã€ã“ã®æ©Ÿèƒ½ã¯**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®Active Directoryã«å¯¾ã—ã¦ç›´æ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ã—ã¾ã™**ã€‚

PTAã§ã¯ã€**ID**ã¯**åŒæœŸ**ã•ã‚Œã¾ã™ãŒã€**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã¯PHSã®ã‚ˆã†ã«ã¯**åŒæœŸã•ã‚Œã¾ã›ã‚“**ã€‚

èªè¨¼ã¯ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ADã§æ¤œè¨¼ã•ã‚Œã€ã‚¯ãƒ©ã‚¦ãƒ‰ã¨ã®é€šä¿¡ã¯**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼**ã§å®Ÿè¡Œã•ã‚Œã‚‹**èªè¨¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ã«ã‚ˆã£ã¦è¡Œã‚ã‚Œã¾ã™ï¼ˆã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®DCã§ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚

### èªè¨¼ãƒ•ãƒ­ãƒ¼

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. **ãƒ­ã‚°ã‚¤ãƒ³**ã™ã‚‹ãŸã‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**Azure AD**ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼å**ã¨**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã‚’é€ä¿¡ã—ã¾ã™
2. **è³‡æ ¼æƒ…å ±**ã¯**æš—å·åŒ–**ã•ã‚Œã€Azure ADã®**ã‚­ãƒ¥ãƒ¼**ã«è¨­å®šã•ã‚Œã¾ã™
3. **ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹èªè¨¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ãŒã‚­ãƒ¥ãƒ¼ã‹ã‚‰**è³‡æ ¼æƒ…å ±**ã‚’åé›†ã—ã€**å¾©å·åŒ–**ã—ã¾ã™ã€‚ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯**"Pass-through authentication agent"**ã¾ãŸã¯**PTAã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ã¨å‘¼ã°ã‚Œã¾ã™ã€‚
4. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ã¯è³‡æ ¼æƒ…å ±ã‚’**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹AD**ã«å¯¾ã—ã¦**æ¤œè¨¼**ã—ã€Azure ADã«**å¿œç­”**ã‚’é€ä¿¡ã—ã¾ã™ã€‚å¿œç­”ãŒè‚¯å®šçš„ã§ã‚ã‚Œã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†**ã—ã¾ã™ã€‚

{% hint style="warning" %}
æ”»æ’ƒè€…ãŒ**PTA**ã‚’**ä¾µå®³**ã—ãŸå ´åˆã€ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ã™ã¹ã¦ã®**è³‡æ ¼æƒ…å ±**ã‚’**ã‚¯ãƒªã‚¢ãƒ†ã‚­ã‚¹ãƒˆ**ã§**è¦‹ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã¾ãŸã€AzureADã«å¯¾ã—ã¦**ä»»æ„ã®è³‡æ ¼æƒ…å ±ã‚’æ¤œè¨¼**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼ˆSkeleton keyã«ä¼¼ãŸæ”»æ’ƒï¼‰ã€‚
{% endhint %}

### ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ -> ã‚¯ãƒ©ã‚¦ãƒ‰

**PTA**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹**Azure AD Connectã‚µãƒ¼ãƒãƒ¼**ã«**ç®¡ç†è€…**ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã‚‹å ´åˆã€**AADInternals**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦**ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’æŒ¿å…¥**ã—ã€**ã™ã¹ã¦ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã‚’**æ¤œè¨¼**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆã™ã¹ã¦ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒèªè¨¼ã«æœ‰åŠ¹ã«ãªã‚Šã¾ã™ï¼‰ï¼š
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¤±æ•—**ã™ã‚‹å ´åˆã€ã“ã‚Œã¯ãŠãã‚‰ã[Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe)ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚
{% endhint %}

ä»¥å‰ã®ãƒãƒƒã‚¯ãƒ‰ã‚¢ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒã‚·ãƒ³ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦**PTAã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«é€ä¿¡ã•ã‚ŒãŸå¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹**ã“ã¨ã‚‚å¯èƒ½ã§ã™:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
ã“ã®ãƒãƒƒã‚¯ãƒ‰ã‚¢ã¯ä»¥ä¸‹ã‚’è¡Œã„ã¾ã™:

* éš ã—ãƒ•ã‚©ãƒ«ãƒ€ `C:\PTASpy` ã‚’ä½œæˆ
* `PTASpy.dll` ã‚’ `C:\PTASpy` ã«ã‚³ãƒ”ãƒ¼
* `PTASpy.dll` ã‚’ `AzureADConnectAuthenticationAgentService` ãƒ—ãƒ­ã‚»ã‚¹ã«æ³¨å…¥

{% hint style="info" %}
AzureADConnectAuthenticationAgent ã‚µãƒ¼ãƒ“ã‚¹ãŒå†èµ·å‹•ã•ã‚Œã‚‹ã¨ã€PTASpy ã¯ã€Œã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã•ã‚Œã€å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã§ã™ã€‚
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
ã‚¯ãƒ©ã‚¦ãƒ‰ã§ **GA ç‰¹æ¨©** ã‚’å–å¾—ã—ãŸå¾Œã€**æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ãƒã‚·ãƒ³** ã« **æ–°ã—ã„ PTA ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç™»éŒ²** ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ **ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—** ã•ã‚Œã‚‹ã¨ã€**å‰è¿°ã®æ‰‹é †** ã‚’ç¹°ã‚Šè¿”ã—ã¦ **ä»»æ„ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦èªè¨¼** ã—ã€**å¹³æ–‡ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—** ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
{% endhint %}

### Seamless SSO

PTA ã¨ Seamless SSO ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã€ã“ã‚Œã¯ä»–ã®æ‚ªç”¨ã«å¯¾ã—ã¦è„†å¼±ã§ã™ã€‚è©³ç´°ã¯ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
AWS Hacking ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop) ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discord ã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã¾ãŸã¯ [**telegram ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€** [**HackTricks**](https://github.com/carlospolop/hacktricks) ãŠã‚ˆã³ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã« PR ã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
