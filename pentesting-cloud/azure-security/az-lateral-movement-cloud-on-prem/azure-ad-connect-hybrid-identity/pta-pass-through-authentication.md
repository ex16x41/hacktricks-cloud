# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication inaruhusu watumiaji wako **kuingia kwenye programu za ndani na za wingu wakitumia nywila sawa**. Kipengele hiki kinawapa watumiaji wako uzoefu bora - nywila moja kidogo ya kukumbuka, na hupunguza gharama za msaada wa IT kwa sababu watumiaji wako wana uwezekano mdogo wa kusahau jinsi ya kuingia. Wakati watumiaji wanaingia wakitumia Azure AD, kipengele hiki **kinathibitisha nywila za watumiaji moja kwa moja dhidi ya Active Directory yako ya ndani**.

Katika PTA **identities** zinahusishwa lakini **nywila** **hazihusishwi** kama katika PHS.

Uthibitishaji unathibitishwa katika AD ya ndani na mawasiliano na wingu yanafanywa na **wakala wa uthibitishaji** anayekimbia katika **seva ya ndani** (haipaswi kuwa kwenye DC ya ndani).

### Authentication flow

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. Ili **kuingia** mtumiaji anapelekwa kwenye **Azure AD**, ambapo anatumia **jina la mtumiaji** na **nywila**
2. **Taarifa za kuingia** zinahifadhiwa **kwa siri** na kuwekwa kwenye **foleni** katika Azure AD
3. **Wakala wa uthibitishaji wa ndani** anakusanya **taarifa za kuingia** kutoka kwenye foleni na **kuzifungua**. Wakala huyu anaitwa **"Pass-through authentication agent"** au **PTA agent.**
4. **Wakala** **anathibitisha** taarifa dhidi ya **AD ya ndani** na anatumia **jibu** **kurudi** kwa Azure AD ambayo, ikiwa jibu ni chanya, **inakamilisha kuingia** kwa mtumiaji.

{% hint style="warning" %}
Ikiwa mshambuliaji **anashambulia** **PTA** anaweza **kuona** taarifa zote **za kuingia** kutoka kwenye foleni (katika **maandishi wazi**).\
Anaweza pia **kuhakiki taarifa zozote** kwa AzureAD (shambulio linalofanana na Skeleton key).
{% endhint %}

### On-Prem -> cloud

Ikiwa una **ufikiaji wa admin** kwa **seva ya Azure AD Connect** yenye **wakala wa PTA** akifanya kazi, unaweza kutumia moduli ya **AADInternals** ku **ingiza nyuma ya mlango** ambayo it **hakiki NYWILA ZOTE** zilizowekwa (hivyo nywila zote zitakuwa halali kwa uthibitishaji):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Ikiwa **ufungaji unashindwa**, hii inaweza kuwa kutokana na kukosekana kwa [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe).
{% endhint %}

Pia inawezekana **kuona nywila za wazi zinazotumwa kwa wakala wa PTA** kwa kutumia cmdlet ifuatayo kwenye mashine ambapo nyuma ya mlango wa awali ilipowekwa:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
This backdoor will:

* Create a hidden folder `C:\PTASpy`
* Copy a `PTASpy.dll` to `C:\PTASpy`
* Injects `PTASpy.dll` to `AzureADConnectAuthenticationAgentService` process

{% hint style="info" %}
When the AzureADConnectAuthenticationAgent service is restarted, PTASpy is ‚Äúunloaded‚Äù and must be re-installed.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
After getting **GA privileges** on the cloud, it's possible to **register a new PTA agent** by setting it on an **attacker controlled machine**. Once the agent is **setup**, we can **repeat** the **previous** steps to **authenticate using any password** and also, **get the passwords in clear-text.**
{% endhint %}

### Seamless SSO

It's possible to use Seamless SSO with PTA, which is vulnerable to other abuses. Check it in:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem_admin/#pass-through-authentication)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
