# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication å…è®¸æ‚¨çš„ç”¨æˆ·ä½¿ç”¨ç›¸åŒçš„å¯†ç **ç™»å½•æœ¬åœ°å’ŒåŸºäºäº‘çš„åº”ç”¨ç¨‹åº**ã€‚æ­¤åŠŸèƒ½ä¸ºæ‚¨çš„ç”¨æˆ·æä¾›äº†æ›´å¥½çš„ä½“éªŒâ€”â€”è®°ä½çš„å¯†ç å°‘äº†ä¸€æ¬¡ï¼Œå¹¶ä¸”å‡å°‘äº†ITå¸®åŠ©å°çš„æˆæœ¬ï¼Œå› ä¸ºæ‚¨çš„ç”¨æˆ·ä¸å¤ªå¯èƒ½å¿˜è®°å¦‚ä½•ç™»å½•ã€‚å½“ç”¨æˆ·ä½¿ç”¨Azure ADç™»å½•æ—¶ï¼Œæ­¤åŠŸèƒ½**ç›´æ¥éªŒè¯ç”¨æˆ·çš„å¯†ç ä¸æ‚¨çš„æœ¬åœ°Active Directory**ã€‚

åœ¨PTAä¸­ï¼Œ**èº«ä»½**æ˜¯**åŒæ­¥**çš„ï¼Œä½†**å¯†ç ****ä¸æ˜¯**ï¼Œå°±åƒåœ¨PHSä¸­ä¸€æ ·ã€‚

èº«ä»½éªŒè¯åœ¨æœ¬åœ°ADä¸­è¿›è¡ŒéªŒè¯ï¼Œä¸äº‘çš„é€šä¿¡ç”±åœ¨**æœ¬åœ°æœåŠ¡å™¨**ä¸Šè¿è¡Œçš„**èº«ä»½éªŒè¯ä»£ç†**å®Œæˆï¼ˆå®ƒä¸éœ€è¦åœ¨æœ¬åœ°DCä¸Šï¼‰ã€‚

### Authentication flow

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. è¦**ç™»å½•**ï¼Œç”¨æˆ·è¢«é‡å®šå‘åˆ°**Azure AD**ï¼Œåœ¨è¿™é‡Œä»–å‘é€**ç”¨æˆ·å**å’Œ**å¯†ç **
2. **å‡­æ®**è¢«**åŠ å¯†**å¹¶è®¾ç½®åœ¨Azure ADä¸­çš„**é˜Ÿåˆ—**ä¸­
3. **æœ¬åœ°èº«ä»½éªŒè¯ä»£ç†**ä»é˜Ÿåˆ—ä¸­æ”¶é›†**å‡­æ®**å¹¶**è§£å¯†**å®ƒä»¬ã€‚è¿™ä¸ªä»£ç†è¢«ç§°ä¸º**â€œé€šè¡Œèº«ä»½éªŒè¯ä»£ç†â€**æˆ–**PTAä»£ç†**ã€‚
4. **ä»£ç†**å°†å‡­æ®ä¸**æœ¬åœ°AD**è¿›è¡Œ**éªŒè¯**ï¼Œå¹¶å°†**å“åº”****è¿”å›**ç»™Azure ADï¼Œå¦‚æœå“åº”æ˜¯ç§¯æçš„ï¼Œ**å®Œæˆç”¨æˆ·çš„ç™»å½•**ã€‚

{% hint style="warning" %}
å¦‚æœæ”»å‡»è€…**ç ´å**äº†**PTA**ï¼Œä»–å¯ä»¥**æŸ¥çœ‹**é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰**å‡­æ®**ï¼ˆä»¥**æ˜æ–‡**å½¢å¼ï¼‰ã€‚\
ä»–è¿˜å¯ä»¥**éªŒè¯ä»»ä½•å‡­æ®**åˆ°AzureADï¼ˆç±»ä¼¼äºSkeleton keyçš„æ”»å‡»ï¼‰ã€‚
{% endhint %}

### On-Prem -> cloud

å¦‚æœæ‚¨å¯¹è¿è¡Œ**PTA** **ä»£ç†**çš„**Azure AD ConnectæœåŠ¡å™¨**å…·æœ‰**ç®¡ç†å‘˜**è®¿é—®æƒé™ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨**AADInternals**æ¨¡å—**æ’å…¥åé—¨**ï¼Œè¿™å°†**éªŒè¯æ‰€æœ‰è¾“å…¥çš„å¯†ç **ï¼ˆå› æ­¤æ‰€æœ‰å¯†ç éƒ½å°†æœ‰æ•ˆè¿›è¡Œèº«ä»½éªŒè¯ï¼‰ï¼š
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
å¦‚æœ**å®‰è£…å¤±è´¥**ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºç¼ºå°‘ [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe)ã€‚
{% endhint %}

è¿˜å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ cmdlet åœ¨å®‰è£…äº†ä¹‹å‰åé—¨çš„æœºå™¨ä¸Š**æŸ¥çœ‹å‘é€åˆ° PTA ä»£ç†çš„æ˜æ–‡å¯†ç **ï¼š
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
This backdoor will:

* åˆ›å»ºä¸€ä¸ªéšè—æ–‡ä»¶å¤¹ `C:\PTASpy`
* å¤åˆ¶ `PTASpy.dll` åˆ° `C:\PTASpy`
* å°† `PTASpy.dll` æ³¨å…¥åˆ° `AzureADConnectAuthenticationAgentService` è¿›ç¨‹ä¸­

{% hint style="info" %}
å½“ AzureADConnectAuthenticationAgent æœåŠ¡è¢«é‡å¯æ—¶ï¼ŒPTASpy ä¼šè¢«â€œå¸è½½â€ï¼Œå¿…é¡»é‡æ–°å®‰è£…ã€‚
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
åœ¨äº‘ç«¯è·å¾— **GA æƒé™** åï¼Œå¯ä»¥é€šè¿‡åœ¨ **æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨** ä¸Šè®¾ç½® **æ³¨å†Œä¸€ä¸ªæ–°çš„ PTA ä»£ç†**ã€‚ä¸€æ—¦ä»£ç† **è®¾ç½®å®Œæˆ**ï¼Œæˆ‘ä»¬å¯ä»¥ **é‡å¤** **ä¹‹å‰** çš„æ­¥éª¤æ¥ **ä½¿ç”¨ä»»ä½•å¯†ç è¿›è¡Œèº«ä»½éªŒè¯**ï¼Œå¹¶ä¸” **è·å–æ˜æ–‡å¯†ç **ã€‚
{% endhint %}

### Seamless SSO

å¯ä»¥ä½¿ç”¨ PTA çš„æ— ç¼ SSOï¼Œè¿™å¯¹å…¶ä»–æ»¥ç”¨è¡Œä¸ºæ˜¯è„†å¼±çš„ã€‚è¯·æŸ¥çœ‹ï¼š

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem_admin/#pass-through-authentication)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
