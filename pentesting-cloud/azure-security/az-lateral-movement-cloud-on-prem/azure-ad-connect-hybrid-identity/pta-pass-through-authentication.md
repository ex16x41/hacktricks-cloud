# Az - PTA - ãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼èªè¨¼

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) ãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼èªè¨¼ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ãŠã‚ˆã³ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³**ã§ãã¾ã™ã€‚ã“ã®æ©Ÿèƒ½ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã‚ˆã‚Šè‰¯ã„ä½“é¨“ã‚’æä¾›ã—ã€è¦šãˆã‚‹ã¹ããƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒ1ã¤æ¸›ã‚‹ãŸã‚ã€ITãƒ˜ãƒ«ãƒ—ãƒ‡ã‚¹ã‚¯ã®ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAzure ADã‚’ä½¿ç”¨ã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã¨ã€ã“ã®æ©Ÿèƒ½ã¯**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®Active Directoryã«å¯¾ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç›´æ¥æ¤œè¨¼**ã—ã¾ã™ã€‚

PTAã§ã¯**ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£**ã¯**åŒæœŸ**ã•ã‚Œã¾ã™ãŒã€**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã¯PHSã®ã‚ˆã†ã«**åŒæœŸ**ã•ã‚Œã¾ã›ã‚“ã€‚

èªè¨¼ã¯ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ADã§æ¤œè¨¼ã•ã‚Œã€ã‚¯ãƒ©ã‚¦ãƒ‰ã¨ã®é€šä¿¡ã¯**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼**ã§å®Ÿè¡Œã•ã‚Œã‚‹**èªè¨¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ã«ã‚ˆã£ã¦è¡Œã‚ã‚Œã¾ã™ï¼ˆã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®DCä¸Šã§ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚

### èªè¨¼ãƒ•ãƒ­ãƒ¼

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. **ãƒ­ã‚°ã‚¤ãƒ³**ã™ã‚‹ãŸã‚ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**Azure AD**ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼å**ã¨**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã‚’é€ä¿¡ã—ã¾ã™ã€‚
2. **è³‡æ ¼æƒ…å ±**ã¯**æš—å·åŒ–**ã•ã‚Œã€Azure ADã®**ã‚­ãƒ¥ãƒ¼**ã«è¨­å®šã•ã‚Œã¾ã™ã€‚
3. **ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹èªè¨¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ãŒã‚­ãƒ¥ãƒ¼ã‹ã‚‰**è³‡æ ¼æƒ…å ±**ã‚’åé›†ã—ã€**å¾©å·åŒ–**ã—ã¾ã™ã€‚ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯**ã€Œãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼èªè¨¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€**ã¾ãŸã¯**PTAã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ã¨å‘¼ã°ã‚Œã¾ã™ã€‚
4. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ã¯**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹AD**ã«å¯¾ã—ã¦è³‡æ ¼æƒ…å ±ã‚’**æ¤œè¨¼**ã—ã€**å¿œç­”**ã‚’Azure ADã«**è¿”ã—ã¾ã™**ã€‚å¿œç­”ãŒè‚¯å®šçš„ã§ã‚ã‚Œã°ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Œäº†**ã—ã¾ã™ã€‚

{% hint style="warning" %}
If an attacker **compromises** the **PTA** he can **see** the all **credentials** from the queue (in **clear-text**).\
He can also **validate any credentials** to the AzureAD (similar attack to Skeleton key).
{% endhint %}

### ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ -> ã‚¯ãƒ©ã‚¦ãƒ‰

**Azure AD Connectã‚µãƒ¼ãƒãƒ¼**ã«**PTA** **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã§**ç®¡ç†è€…**ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã‚‹å ´åˆã€**AADInternals**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦**ã™ã¹ã¦ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã‚’**æ¤œè¨¼ã™ã‚‹ãƒãƒƒã‚¯ãƒ‰ã‚¢**ã‚’**æŒ¿å…¥**ã§ãã¾ã™ï¼ˆã™ã¹ã¦ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒèªè¨¼ã«å¯¾ã—ã¦æœ‰åŠ¹ã«ãªã‚Šã¾ã™ï¼‰ï¼š
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒ**å¤±æ•—ã—ãŸå ´åˆ**ã€ã“ã‚Œã¯ãŠãã‚‰ã[Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe)ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚
{% endhint %}

æ¬¡ã®cmdletã‚’ä½¿ç”¨ã—ã¦ã€å‰ã®ãƒãƒƒã‚¯ãƒ‰ã‚¢ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒã‚·ãƒ³ã§**PTAã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«é€ä¿¡ã•ã‚ŒãŸå¹³æ–‡ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã‚’è¦‹ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼š
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
ã“ã®ãƒãƒƒã‚¯ãƒ‰ã‚¢ã¯ä»¥ä¸‹ã‚’è¡Œã„ã¾ã™ï¼š

* éš ã—ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ `C:\PTASpy` ã‚’ä½œæˆã—ã¾ã™
* `PTASpy.dll` ã‚’ `C:\PTASpy` ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™
* `PTASpy.dll` ã‚’ `AzureADConnectAuthenticationAgentService` ãƒ—ãƒ­ã‚»ã‚¹ã«æ³¨å…¥ã—ã¾ã™

{% hint style="info" %}
AzureADConnectAuthenticationAgent ã‚µãƒ¼ãƒ“ã‚¹ãŒå†èµ·å‹•ã•ã‚Œã‚‹ã¨ã€PTASpy ã¯ã€Œã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã•ã‚Œã€å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

### ã‚¯ãƒ©ã‚¦ãƒ‰ -> ã‚ªãƒ³ãƒ—ãƒ¬

{% hint style="danger" %}
ã‚¯ãƒ©ã‚¦ãƒ‰ã§ **GA æ¨©é™** ã‚’å–å¾—ã—ãŸå¾Œã€**æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ãƒã‚·ãƒ³** ã«è¨­å®šã™ã‚‹ã“ã¨ã§ **æ–°ã—ã„ PTA ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç™»éŒ²** ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ **è¨­å®š** ã•ã‚Œã‚‹ã¨ã€**ä»¥å‰ã®** æ‰‹é †ã‚’ **ç¹°ã‚Šè¿”ã—ã¦** **ä»»æ„ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦èªè¨¼** ã—ã€ã•ã‚‰ã« **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¹³æ–‡ã§å–å¾—** ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
{% endhint %}

### ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ SSO

PTA ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ SSO ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ãŒã€ä»–ã®æ‚ªç”¨ã«å¯¾ã—ã¦è„†å¼±ã§ã™ã€‚è©³ç´°ã¯ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
AWS ãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP ãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã¾ãŸã¯ [**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks) ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã« PR ã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
