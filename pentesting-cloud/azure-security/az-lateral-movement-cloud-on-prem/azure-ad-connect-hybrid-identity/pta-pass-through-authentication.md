# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication рдЖрдкрдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ **рдПрдХ рд╣реА рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдСрди-рдкреНрд░рд┐рдорд╛рдЗрд╕реЗрд╕ рдФрд░ рдХреНрд▓рд╛рдЙрдб-рдЖрдзрд╛рд░рд┐рдд рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдореЗрдВ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ**ред рдпрд╣ рд╕реБрд╡рд┐рдзрд╛ рдЖрдкрдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдПрдХ рдмреЗрд╣рддрд░ рдЕрдиреБрднрд╡ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ - рдПрдХ рдХрдо рдкрд╛рд╕рд╡рд░реНрдб рдпрд╛рдж рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП, рдФрд░ рдЖрдИрдЯреА рд╣реЗрд▓реНрдкрдбреЗрд╕реНрдХ рд▓рд╛рдЧрдд рдХреЛ рдХрдо рдХрд░рддреА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЖрдкрдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рд╛рдЗрди рдЗрди рдХрд░рдирд╛ рднреВрд▓рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдХрдо рд╣реЛрддреА рд╣реИред рдЬрдм рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ Azure AD рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рд╛рдЗрди рдЗрди рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рд╕реБрд╡рд┐рдзрд╛ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рд╕реАрдзреЗ рдЖрдкрдХреЗ рдСрди-рдкреНрд░рд┐рдорд╛рдЗрд╕реЗрд╕ рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЗ рдЦрд┐рд▓рд╛рдл рдорд╛рдиреНрдп рдХрд░рддреА рд╣реИ**ред

PTA рдореЗрдВ **рдкрд╣рдЪрд╛рдиреЗрдВ** **рд╕рд┐рдВрдХреНрд░рдирд╛рдЗрдЬрд╝** рд╣реЛрддреА рд╣реИрдВ рд▓реЗрдХрд┐рди **рдкрд╛рд╕рд╡рд░реНрдб** **рдирд╣реАрдВ** рд╣реЛрддреЗ рдЬреИрд╕реЗ рдХрд┐ PHS рдореЗрдВред

рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдСрди-рдкреНрд░рд┐рдо AD рдореЗрдВ рдорд╛рдиреНрдп рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдХреНрд▓рд╛рдЙрдб рдХреЗ рд╕рд╛рде рд╕рдВрдЪрд╛рд░ рдПрдХ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдПрдЬреЗрдВрдЯ** рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдПрдХ **рдСрди-рдкреНрд░рд┐рдо рд╕рд░реНрд╡рд░** рдкрд░ рдЪрд▓ рд░рд╣рд╛ рд╣реИ (рдпрд╣ рдСрди-рдкреНрд░рд┐рдо DC рдкрд░ рд╣реЛрдирд╛ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИ)ред

### Authentication flow

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. **рд▓реЙрдЧрд┐рди** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **Azure AD** рдкрд░ рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рд╡рд╣ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо** рдФрд░ **рдкрд╛рд╕рд╡рд░реНрдб** рднреЗрдЬрддрд╛ рд╣реИ
2. **рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ** рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ Azure AD рдореЗрдВ рдПрдХ **рдХреНрдпреВ** рдореЗрдВ рд╕реЗрдЯ рд╣реЛрддреЗ рд╣реИрдВ
3. **рдСрди-рдкреНрд░рд┐рдо рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдПрдЬреЗрдВрдЯ** рдХреНрдпреВ рд╕реЗ **рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** рдЗрдХрдЯреНрдард╛ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЙрдиреНрд╣реЗрдВ **рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рдПрдЬреЗрдВрдЯ рдХреЛ **"рдкрд╛рд╕-рдереНрд░реВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдПрдЬреЗрдВрдЯ"** рдпрд╛ **PTA рдПрдЬреЗрдВрдЯ** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред
4. **рдПрдЬреЗрдВрдЯ** **рдХреНрд░реЗрдбреНрд╕** рдХреЛ **рдСрди-рдкреНрд░рд┐рдо AD** рдХреЗ рдЦрд┐рд▓рд╛рдл **рдорд╛рдиреНрдп** рдХрд░рддрд╛ рд╣реИ рдФрд░ **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** **рд╡рд╛рдкрд╕** Azure AD рдХреЛ рднреЗрдЬрддрд╛ рд╣реИ рдЬреЛ, рдпрджрд┐ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕рдХрд╛рд░рд╛рддреНрдордХ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ **рд▓реЙрдЧрд┐рди рдкреВрд░рд╛ рдХрд░рддрд╛ рд╣реИ**ред

{% hint style="warning" %}
рдпрджрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **PTA** рдХреЛ **рд╕рдордЭреМрддрд╛** рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рдХреНрдпреВ рд╕реЗ рд╕рднреА **рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** ( **рд╕реНрдкрд╖реНрдЯ-рдЯреЗрдХреНрд╕реНрдЯ** рдореЗрдВ) **рджреЗрдЦ** рд╕рдХрддрд╛ рд╣реИред\
рд╡рд╣ AzureAD рдХреЗ рд▓рд┐рдП **рдХрд┐рд╕реА рднреА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** рдХреЛ рднреА **рдорд╛рдиреНрдп** рдХрд░ рд╕рдХрддрд╛ рд╣реИ (Skeleton key рдХреЗ рд╕рдорд╛рди рд╣рдорд▓рд╛)ред
{% endhint %}

### On-Prem -> cloud

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **Azure AD Connect рд╕рд░реНрд╡рд░** рдкрд░ **рдПрдбрдорд┐рди** рдПрдХреНрд╕реЗрд╕ рд╣реИ рдЬрд┐рд╕рдореЗрдВ **PTA** **рдПрдЬреЗрдВрдЯ** рдЪрд▓ рд░рд╣рд╛ рд╣реИ, рддреЛ рдЖрдк **AADInternals** рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдПрдХ рдмреИрдХрдбреЛрд░** **рдбрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ** рдЬреЛ **рд╕рднреА рдкрд╛рд╕рд╡рд░реНрдб** рдХреЛ **рдорд╛рдиреНрдп** рдХрд░реЗрдЧрд╛ (рддреЛ рд╕рднреА рдкрд╛рд╕рд╡рд░реНрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдорд╛рдиреНрдп рд╣реЛрдВрдЧреЗ):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
рдпрджрд┐ **рд╕реНрдерд╛рдкрдирд╛ рд╡рд┐рдлрд▓ рд╣реЛрддреА рд╣реИ**, рддреЛ рдпрд╣ рд╕рдВрднрд╡рддрдГ [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe) рдХреА рдХрдореА рдХреЗ рдХрд╛рд░рдг рд╣реИред
{% endhint %}

рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **PTA рдПрдЬреЗрдВрдЯ рдХреЛ рднреЗрдЬреЗ рдЧрдП рд╕реНрдкрд╖реНрдЯ-рдкрд╛рда рдкрд╛рд╕рд╡рд░реНрдб рджреЗрдЦреЗрдВ** рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд cmdlet рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрд╕ рдорд╢реАрди рдкрд░ рдЬрд╣рд╛рдВ рдкрд┐рдЫрд▓рд╛ рдмреИрдХрдбреЛрд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
This backdoor will:

* Create a hidden folder `C:\PTASpy`
* Copy a `PTASpy.dll` to `C:\PTASpy`
* Injects `PTASpy.dll` to `AzureADConnectAuthenticationAgentService` process

{% hint style="info" %}
рдЬрдм AzureADConnectAuthenticationAgent рд╕реЗрд╡рд╛ рдХреЛ рдкреБрдирдГ рдкреНрд░рд╛рд░рдВрдн рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, PTASpy "рдЕрдирд▓реЛрдб" рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдлрд┐рд░ рд╕реЗ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
рдХреНрд▓рд╛рдЙрдб рдкрд░ **GA рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЗрд╕реЗ **рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдорд╢реАрди** рдкрд░ рд╕реЗрдЯ рдХрд░рдХреЗ **рдирдпрд╛ PTA рдПрдЬреЗрдВрдЯ** **рдкрдВрдЬреАрдХреГрдд** рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред рдПрдХ рдмрд╛рд░ рдЬрдм рдПрдЬреЗрдВрдЯ **рд╕реЗрдЯрдЕрдк** рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╣рдо **рдХрд┐рд╕реА рднреА рдкрд╛рд╕рд╡рд░реНрдб** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдкреНрд░рдорд╛рдгрд┐рдд** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдкрд┐рдЫрд▓реЗ** рдЪрд░рдгреЛрдВ рдХреЛ **рджреЛрд╣рд░рд╛** рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рд╛рде рд╣реА, **рд╕реНрдкрд╖реНрдЯ-рдЯреЗрдХреНрд╕реНрдЯ рдореЗрдВ рдкрд╛рд╕рд╡рд░реНрдб рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред**
{% endhint %}

### Seamless SSO

PTA рдХреЗ рд╕рд╛рде Seamless SSO рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдЬреЛ рдЕрдиреНрдп рджреБрд░реБрдкрдпреЛрдЧреЛрдВ рдХреЗ рдкреНрд░рддрд┐ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реИред рдЗрд╕реЗ рдЬрд╛рдВрдЪреЗрдВ:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
