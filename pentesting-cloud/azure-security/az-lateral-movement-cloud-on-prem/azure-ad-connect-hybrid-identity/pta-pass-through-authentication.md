# Az - PTA - パススルー認証

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## 基本情報

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) パススルー認証を使用すると、ユーザーは**オンプレミスおよびクラウドベースのアプリケーションに同じパスワードでサインイン**できます。この機能は、ユーザーにとってより良い体験を提供し、覚えるべきパスワードが1つ減るため、ITヘルプデスクのコストを削減します。ユーザーがAzure ADを使用してサインインすると、この機能は**オンプレミスのActive Directoryに対してユーザーのパスワードを直接検証**します。

PTAでは**アイデンティティ**は**同期**されますが、**パスワード**はPHSのように**同期**されません。

認証はオンプレミスのADで検証され、クラウドとの通信は**オンプレミスサーバー**で実行される**認証エージェント**によって行われます（オンプレミスのDC上である必要はありません）。

### 認証フロー

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. **ログイン**するために、ユーザーは**Azure AD**にリダイレクトされ、**ユーザー名**と**パスワード**を送信します。
2. **資格情報**は**暗号化**され、Azure ADの**キュー**に設定されます。
3. **オンプレミス認証エージェント**がキューから**資格情報**を収集し、**復号化**します。このエージェントは**「パススルー認証エージェント」**または**PTAエージェント**と呼ばれます。
4. **エージェント**は**オンプレミスAD**に対して資格情報を**検証**し、**応答**をAzure ADに**返します**。応答が肯定的であれば、**ユーザーのログインを完了**します。

{% hint style="warning" %}
If an attacker **compromises** the **PTA** he can **see** the all **credentials** from the queue (in **clear-text**).\
He can also **validate any credentials** to the AzureAD (similar attack to Skeleton key).
{% endhint %}

### オンプレミス -> クラウド

**Azure AD Connectサーバー**に**PTA** **エージェント**が実行されている状態で**管理者**アクセスがある場合、**AADInternals**モジュールを使用して**すべてのパスワード**を**検証するバックドア**を**挿入**できます（すべてのパスワードが認証に対して有効になります）：
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
インストールが**失敗した場合**、これはおそらく[Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe)が不足しているためです。
{% endhint %}

次のcmdletを使用して、前のバックドアがインストールされたマシンで**PTAエージェントに送信された平文のパスワード**を見ることも可能です：
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
このバックドアは以下を行います：

* 隠しフォルダー `C:\PTASpy` を作成します
* `PTASpy.dll` を `C:\PTASpy` にコピーします
* `PTASpy.dll` を `AzureADConnectAuthenticationAgentService` プロセスに注入します

{% hint style="info" %}
AzureADConnectAuthenticationAgent サービスが再起動されると、PTASpy は「アンロード」され、再インストールする必要があります。
{% endhint %}

### クラウド -> オンプレ

{% hint style="danger" %}
クラウドで **GA 権限** を取得した後、**攻撃者が制御するマシン** に設定することで **新しい PTA エージェントを登録** することが可能です。エージェントが **設定** されると、**以前の** 手順を **繰り返して** **任意のパスワードを使用して認証** し、さらに **パスワードを平文で取得** することができます。
{% endhint %}

### シームレス SSO

PTA を使用してシームレス SSO を利用することが可能ですが、他の悪用に対して脆弱です。詳細は以下を確認してください：

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## 参考文献

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
AWS ハッキングを学び、実践する：<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP ハッキングを学び、実践する：<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) または [**Telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出してください。**

</details>
{% endhint %}
