# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authenticationì€ ì‚¬ìš©ìê°€ **ì˜¨í”„ë ˆë¯¸ìŠ¤ ë° í´ë¼ìš°ë“œ ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë™ì¼í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸í•  ìˆ˜ ìˆë„ë¡** í•©ë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì€ ì‚¬ìš©ìê°€ ê¸°ì–µí•´ì•¼ í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¤„ì—¬ ë” ë‚˜ì€ ê²½í—˜ì„ ì œê³µí•˜ë©°, ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ë°©ë²•ì„ ìŠì–´ë²„ë¦´ ê°€ëŠ¥ì„±ì´ ì¤„ì–´ë“¤ì–´ IT í—¬í”„ë°ìŠ¤í¬ ë¹„ìš©ì„ ì ˆê°í•©ë‹ˆë‹¤. ì‚¬ìš©ìê°€ Azure ADë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸í•  ë•Œ, ì´ ê¸°ëŠ¥ì€ **ì˜¨í”„ë ˆë¯¸ìŠ¤ Active Directoryì— ëŒ€í•´ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì§ì ‘ ê²€ì¦**í•©ë‹ˆë‹¤.

PTAì—ì„œëŠ” **ì•„ì´ë´í‹°í‹°**ê°€ **ë™ê¸°í™”**ë˜ì§€ë§Œ **ë¹„ë°€ë²ˆí˜¸**ëŠ” PHSì™€ ë‹¬ë¦¬ **ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.

ì¸ì¦ì€ ì˜¨í”„ë ˆë¯¸ìŠ¤ ADì—ì„œ ê²€ì¦ë˜ë©°, í´ë¼ìš°ë“œì™€ì˜ í†µì‹ ì€ **ì˜¨í”„ë ˆë¯¸ìŠ¤ ì„œë²„**ì—ì„œ ì‹¤í–‰ë˜ëŠ” **ì¸ì¦ ì—ì´ì „íŠ¸**ì— ì˜í•´ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤(ì˜¨í”„ë ˆë¯¸ìŠ¤ DCì— ìˆì„ í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤).

### Authentication flow

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. ì‚¬ìš©ìëŠ” **ë¡œê·¸ì¸**ì„ ìœ„í•´ **Azure AD**ë¡œ ë¦¬ë””ë ‰ì…˜ë˜ë©°, ì—¬ê¸°ì„œ **ì‚¬ìš©ì ì´ë¦„**ê³¼ **ë¹„ë°€ë²ˆí˜¸**ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
2. **ìê²© ì¦ëª…**ì€ **ì•”í˜¸í™”**ë˜ì–´ Azure ADì˜ **í**ì— ì„¤ì •ë©ë‹ˆë‹¤.
3. **ì˜¨í”„ë ˆë¯¸ìŠ¤ ì¸ì¦ ì—ì´ì „íŠ¸**ê°€ íì—ì„œ **ìê²© ì¦ëª…**ì„ ìˆ˜ì§‘í•˜ê³  **ë³µí˜¸í™”**í•©ë‹ˆë‹¤. ì´ ì—ì´ì „íŠ¸ë¥¼ **"Pass-through authentication agent"** ë˜ëŠ” **PTA agent**ë¼ê³  í•©ë‹ˆë‹¤.
4. **ì—ì´ì „íŠ¸**ê°€ **ì˜¨í”„ë ˆë¯¸ìŠ¤ AD**ì— ëŒ€í•´ ìê²© ì¦ëª…ì„ **ê²€ì¦**í•˜ê³ , **ì‘ë‹µ**ì„ Azure ADë¡œ **ì „ì†¡**í•©ë‹ˆë‹¤. ì‘ë‹µì´ ê¸ì •ì ì¼ ê²½ìš°, ì‚¬ìš©ìì˜ **ë¡œê·¸ì¸ì„ ì™„ë£Œ**í•©ë‹ˆë‹¤.

{% hint style="warning" %}
ê³µê²©ìê°€ **PTA**ë¥¼ **íƒ€í˜‘**í•˜ë©´ íì—ì„œ ëª¨ë“  **ìê²© ì¦ëª…**ì„ **í‰ë¬¸**ìœ¼ë¡œ **ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.\
ê·¸ëŠ” ë˜í•œ AzureADì— ëŒ€í•´ **ëª¨ë“  ìê²© ì¦ëª…**ì„ **ê²€ì¦**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ìŠ¤ì¼ˆë ˆí†¤ í‚¤ì™€ ìœ ì‚¬í•œ ê³µê²©).
{% endhint %}

### On-Prem -> cloud

**Azure AD Connect ì„œë²„**ì— **PTA** **ì—ì´ì „íŠ¸**ê°€ ì‹¤í–‰ ì¤‘ì¸ **ê´€ë¦¬ì** ì•¡ì„¸ìŠ¤ê°€ ìˆëŠ” ê²½ìš°, **AADInternals** ëª¨ë“ˆì„ ì‚¬ìš©í•˜ì—¬ **ëª¨ë“  ë¹„ë°€ë²ˆí˜¸**ê°€ **ìœ íš¨í•œ ì¸ì¦**ì„ ìœ„í•´ **ê²€ì¦**ë˜ë„ë¡ **ë°±ë„ì–´**ë¥¼ **ì‚½ì…**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
ì„¤ì¹˜ê°€ **ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°**, ì´ëŠ” ì•„ë§ˆë„ [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe)ê°€ ëˆ„ë½ë˜ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
{% endhint %}

ì´ì „ ë°±ë„ì–´ê°€ ì„¤ì¹˜ëœ ë¨¸ì‹ ì—ì„œ ë‹¤ìŒ cmdletì„ ì‚¬ìš©í•˜ì—¬ **PTA ì—ì´ì „íŠ¸ì— ì „ì†¡ëœ í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤**:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
ì´ ë°±ë„ì–´ëŠ” ë‹¤ìŒì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

* ìˆ¨ê²¨ì§„ í´ë” `C:\PTASpy`ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
* `PTASpy.dll`ì„ `C:\PTASpy`ì— ë³µì‚¬í•©ë‹ˆë‹¤.
* `PTASpy.dll`ì„ `AzureADConnectAuthenticationAgentService` í”„ë¡œì„¸ìŠ¤ì— ì£¼ì…í•©ë‹ˆë‹¤.

{% hint style="info" %}
AzureADConnectAuthenticationAgent ì„œë¹„ìŠ¤ê°€ ì¬ì‹œì‘ë˜ë©´ PTASpyê°€ â€œì–¸ë¡œë“œâ€ë˜ë©° ë‹¤ì‹œ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}

### í´ë¼ìš°ë“œ -> ì˜¨í”„ë ˆë¯¸ìŠ¤

{% hint style="danger" %}
í´ë¼ìš°ë“œì—ì„œ **GA ê¶Œí•œ**ì„ ì–»ì€ í›„, **ê³µê²©ìê°€ ì œì–´í•˜ëŠ” ë¨¸ì‹ **ì— ì„¤ì •í•˜ì—¬ **ìƒˆ PTA ì—ì´ì „íŠ¸**ë¥¼ **ë“±ë¡**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—ì´ì „íŠ¸ê°€ **ì„¤ì •**ë˜ë©´, **ì´ì „** ë‹¨ê³„ë¥¼ **ë°˜ë³µ**í•˜ì—¬ **ëª¨ë“  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦**í•˜ê³ , **ë¹„ë°€ë²ˆí˜¸ë¥¼ í‰ë¬¸ìœ¼ë¡œ ê°€ì ¸ì˜¬** ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### ì›í™œí•œ SSO

PTAì™€ í•¨ê»˜ ì›í™œí•œ SSOë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ë‹¤ë¥¸ ë‚¨ìš©ì— ì·¨ì•½í•©ë‹ˆë‹¤. í™•ì¸í•´ ë³´ì„¸ìš”:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## ì°¸ê³ ìë£Œ

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem_admin/#pass-through-authentication)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
