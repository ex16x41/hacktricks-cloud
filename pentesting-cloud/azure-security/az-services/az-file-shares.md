# Az - File Shares

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Azure Files** √© um servi√ßo de armazenamento de arquivos em nuvem totalmente gerenciado que fornece armazenamento de arquivos compartilhados acess√≠vel via protocolos padr√£o **SMB (Server Message Block)** e **NFS (Network File System)**. Embora o protocolo principal utilizado seja o SMB, os compartilhamentos de arquivos NFS do Azure n√£o s√£o suportados para Windows (de acordo com a [**docs**](https://learn.microsoft.com/en-us/azure/storage/files/files-nfs-protocol)). Ele permite criar compartilhamentos de arquivos em rede altamente dispon√≠veis que podem ser acessados simultaneamente por v√°rias m√°quinas virtuais (VMs) ou sistemas locais, permitindo o compartilhamento de arquivos sem interrup√ß√µes entre ambientes.

### Access Tiers

* **Transaction Optimized**: Otimizado para opera√ß√µes com alta carga de transa√ß√µes.
* **Hot**: Equilibrado entre transa√ß√µes e armazenamento.
* **Cool**: Custo-efetivo para armazenamento.
* **Premium:** Armazenamento de arquivos de alto desempenho otimizado para cargas de trabalho com baixa lat√™ncia e IOPS intensivos.

### Backups

* **Daily backup**: Um ponto de backup √© criado a cada dia em um hor√°rio indicado (por exemplo, 19.30 UTC) e armazenado de 1 a 200 dias.
* **Weekly backup**: Um ponto de backup √© criado a cada semana em um dia e hor√°rio indicados (domingo √†s 19.30) e armazenado de 1 a 200 semanas.
* **Monthly backup**: Um ponto de backup √© criado a cada m√™s em um dia e hor√°rio indicados (por exemplo, primeiro domingo √†s 19.30) e armazenado de 1 a 120 meses.
* **Yearly backup**: Um ponto de backup √© criado a cada ano em um dia e hor√°rio indicados (por exemplo, primeiro domingo de janeiro √†s 19.30) e armazenado de 1 a 10 anos.
* Tamb√©m √© poss√≠vel realizar **backups manuais e snapshots a qualquer momento**. Backups e snapshots s√£o, na verdade, a mesma coisa neste contexto.

### Supported Authentications via SMB

* **On-premises AD DS Authentication**: Usa credenciais do Active Directory local sincronizadas com o Microsoft Entra ID para acesso baseado em identidade. Requer conectividade de rede com o AD DS local.
* **Microsoft Entra Domain Services Authentication**: Aproveita os Servi√ßos de Dom√≠nio do Microsoft Entra (AD baseado em nuvem) para fornecer acesso usando credenciais do Microsoft Entra.
* **Microsoft Entra Kerberos for Hybrid Identities**: Permite que usu√°rios do Microsoft Entra autentiquem compartilhamentos de arquivos do Azure pela internet usando Kerberos. Suporta VMs unidas ao Microsoft Entra h√≠brido ou unidas ao Microsoft Entra sem exigir conectividade com controladores de dom√≠nio locais. Mas n√£o suporta identidades apenas em nuvem.
* **AD Kerberos Authentication for Linux Clients**: Permite que clientes Linux usem Kerberos para autentica√ß√£o SMB via AD DS local ou Servi√ßos de Dom√≠nio do Microsoft Entra.

## Enumeration

{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# List file shares
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# Get snapshots/backups
az storage share list --account-name <name> --include-snapshots --query "[?snapshot != null]"
# List contents of a snapshot/backup
az storage file list --account-name <name> --share-name <share-name> --snapshot <snapshot-version> #e.g. "2024-11-25T11:26:59.0000000Z"
# Download snapshot/backup
az storage file download-batch -d . --account-name <name> --source <share-name> --snapshot <snapshot-version>
```
{% endcode %}

{% hint style="info" %}
Por padr√£o, o `az` cli usar√° uma chave de conta para assinar uma chave e realizar a a√ß√£o. Para usar os privil√©gios do principal do Entra ID, use os par√¢metros `--auth-mode login --enable-file-backup-request-intent`.
{% endhint %}

{% hint style="success" %}
Use o par√¢metro `--account-key` para indicar a chave da conta a ser usada\
Use o par√¢metro `--sas-token` com o token SAS para acessar via um token SAS
{% endhint %}

### Conex√£o

Estes s√£o os scripts propostos pelo Azure no momento da escrita para conectar um File Share:

Voc√™ precisa substituir os espa√ßos reservados `<STORAGE-ACCOUNT>`, `<ACCESS-KEY>` e `<FILE-SHARE-NAME>`.

{% tabs %}
{% tab title="Windows" %}
{% code overflow="wrap" %}
```powershell
$connectTestResult = Test-NetConnection -ComputerName filescontainersrdtfgvhb.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded) {
# Save the password so the drive will persist on reboot
cmd.exe /C "cmdkey /add:`"<STORAGE-ACCOUNT>.file.core.windows.net`" /user:`"localhost\<STORAGE-ACCOUNT>`" /pass:`"<ACCESS-KEY>`""
# Mount the drive
New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<STORAGE-ACCOUNT>.file.core.windows.net\<FILE-SHARE-NAME>" -Persist
} else {
Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
}
```
{% endcode %}
{% endtab %}

{% tab title="Linux" %}
{% code overflow="wrap" %}
```bash
sudo mkdir /mnt/disk-shareeifrube
if [ ! -d "/etc/smbcredentials" ]; then
sudo mkdir /etc/smbcredentials
fi
if [ ! -f "/etc/smbcredentials/<STORAGE-ACCOUNT>.cred" ]; then
sudo bash -c 'echo "username=<STORAGE-ACCOUNT>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
sudo bash -c 'echo "password=<ACCESS-KEY>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
fi
sudo chmod 600 /etc/smbcredentials/<STORAGE-ACCOUNT>.cred

sudo bash -c 'echo "//<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> cifs nofail,credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30" >> /etc/fstab'
sudo mount -t cifs //<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> -o credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30
```
{% endcode %}
{% endtab %}

{% tab title="macOS" %}
{% code overflow="wrap" %}
```bash
open smb://<STORAGE-ACCOUNT>:<ACCESS-KEY>@<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME>
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Enumera√ß√£o de armazenamento regular (chaves de acesso, SAS...)

{% content-ref url="az-storage.md" %}
[az-storage.md](az-storage.md)
{% endcontent-ref %}

## Escala√ß√£o de Privil√©gios

Mesma coisa que privesc de armazenamento:

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## P√≥s Explora√ß√£o

{% content-ref url="../az-post-exploitation/az-file-share-post-exploitation.md" %}
[az-file-share-post-exploitation.md](../az-post-exploitation/az-file-share-post-exploitation.md)
{% endcontent-ref %}

## Persist√™ncia

Mesma coisa que persist√™ncia de armazenamento:

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
