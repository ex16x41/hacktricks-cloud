# Az - æ–‡ä»¶å…±äº«

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

**Azure æ–‡ä»¶** æ˜¯ä¸€ç§å®Œå…¨æ‰˜ç®¡çš„äº‘æ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼Œæä¾›é€šè¿‡æ ‡å‡† **SMB (æœåŠ¡å™¨æ¶ˆæ¯å—)** å’Œ **NFS (ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ)** åè®®è®¿é—®çš„å…±äº«æ–‡ä»¶å­˜å‚¨ã€‚å°½ç®¡ä¸»è¦ä½¿ç”¨çš„åè®®æ˜¯ SMBï¼Œä½† NFS Azure æ–‡ä»¶å…±äº«ä¸æ”¯æŒ Windowsï¼ˆæ ¹æ® [**æ–‡æ¡£**](https://learn.microsoft.com/en-us/azure/storage/files/files-nfs-protocol)ï¼‰ã€‚å®ƒå…è®¸æ‚¨åˆ›å»ºé«˜åº¦å¯ç”¨çš„ç½‘ç»œæ–‡ä»¶å…±äº«ï¼Œå¯ä»¥è¢«å¤šä¸ªè™šæ‹Ÿæœº (VM) æˆ–æœ¬åœ°ç³»ç»ŸåŒæ—¶è®¿é—®ï¼Œä»è€Œå®ç°è·¨ç¯å¢ƒçš„æ— ç¼æ–‡ä»¶å…±äº«ã€‚

### è®¿é—®å±‚çº§

* **äº‹åŠ¡ä¼˜åŒ–**ï¼šé’ˆå¯¹äº‹åŠ¡å¯†é›†å‹æ“ä½œè¿›è¡Œäº†ä¼˜åŒ–ã€‚
* **çƒ­å­˜å‚¨**ï¼šåœ¨äº‹åŠ¡å’Œå­˜å‚¨ä¹‹é—´ä¿æŒå¹³è¡¡ã€‚
* **å†·å­˜å‚¨**ï¼šåœ¨å­˜å‚¨ä¸Šå…·æœ‰æˆæœ¬æ•ˆç›Šã€‚
* **é«˜çº§å­˜å‚¨**ï¼šé’ˆå¯¹ä½å»¶è¿Ÿå’Œ IOPS å¯†é›†å‹å·¥ä½œè´Ÿè½½è¿›è¡Œäº†ä¼˜åŒ–çš„é«˜æ€§èƒ½æ–‡ä»¶å­˜å‚¨ã€‚

### å¤‡ä»½

* **æ¯æ—¥å¤‡ä»½**ï¼šæ¯å¤©åœ¨æŒ‡å®šæ—¶é—´ï¼ˆä¾‹å¦‚ UTC 19:30ï¼‰åˆ›å»ºä¸€ä¸ªå¤‡ä»½ç‚¹ï¼Œå¹¶å­˜å‚¨ 1 åˆ° 200 å¤©ã€‚
* **æ¯å‘¨å¤‡ä»½**ï¼šæ¯å‘¨åœ¨æŒ‡å®šçš„æ—¥æœŸå’Œæ—¶é—´ï¼ˆæ˜ŸæœŸæ—¥ 19:30ï¼‰åˆ›å»ºä¸€ä¸ªå¤‡ä»½ç‚¹ï¼Œå¹¶å­˜å‚¨ 1 åˆ° 200 å‘¨ã€‚
* **æ¯æœˆå¤‡ä»½**ï¼šæ¯æœˆåœ¨æŒ‡å®šçš„æ—¥æœŸå’Œæ—¶é—´ï¼ˆä¾‹å¦‚ç¬¬ä¸€ä¸ªæ˜ŸæœŸæ—¥ 19:30ï¼‰åˆ›å»ºä¸€ä¸ªå¤‡ä»½ç‚¹ï¼Œå¹¶å­˜å‚¨ 1 åˆ° 120 ä¸ªæœˆã€‚
* **æ¯å¹´å¤‡ä»½**ï¼šæ¯å¹´åœ¨æŒ‡å®šçš„æ—¥æœŸå’Œæ—¶é—´ï¼ˆä¾‹å¦‚ä¸€æœˆç¬¬ä¸€ä¸ªæ˜ŸæœŸæ—¥ 19:30ï¼‰åˆ›å»ºä¸€ä¸ªå¤‡ä»½ç‚¹ï¼Œå¹¶å­˜å‚¨ 1 åˆ° 10 å¹´ã€‚
* ä¹Ÿå¯ä»¥éšæ—¶è¿›è¡Œ **æ‰‹åŠ¨å¤‡ä»½å’Œå¿«ç…§**ã€‚åœ¨æ­¤ä¸Šä¸‹æ–‡ä¸­ï¼Œå¤‡ä»½å’Œå¿«ç…§å®é™…ä¸Šæ˜¯ç›¸åŒçš„ã€‚

### é€šè¿‡ SMB æ”¯æŒçš„èº«ä»½éªŒè¯

* **æœ¬åœ° AD DS èº«ä»½éªŒè¯**ï¼šä½¿ç”¨ä¸ Microsoft Entra ID åŒæ­¥çš„æœ¬åœ° Active Directory å‡­æ®è¿›è¡ŒåŸºäºèº«ä»½çš„è®¿é—®ã€‚éœ€è¦ä¸æœ¬åœ° AD DS çš„ç½‘ç»œè¿æ¥ã€‚
* **Microsoft Entra åŸŸæœåŠ¡èº«ä»½éªŒè¯**ï¼šåˆ©ç”¨ Microsoft Entra åŸŸæœåŠ¡ï¼ˆåŸºäºäº‘çš„ ADï¼‰ä½¿ç”¨ Microsoft Entra å‡­æ®æä¾›è®¿é—®ã€‚
* **Microsoft Entra Kerberos æ··åˆèº«ä»½éªŒè¯**ï¼šä½¿ Microsoft Entra ç”¨æˆ·èƒ½å¤Ÿé€šè¿‡äº’è”ç½‘ä½¿ç”¨ Kerberos è¿›è¡Œ Azure æ–‡ä»¶å…±äº«çš„èº«ä»½éªŒè¯ã€‚æ”¯æŒæ··åˆçš„ Microsoft Entra åŠ å…¥æˆ– Microsoft Entra åŠ å…¥çš„ VMï¼Œè€Œæ— éœ€ä¸æœ¬åœ°åŸŸæ§åˆ¶å™¨çš„è¿æ¥ã€‚ä½†ä¸æ”¯æŒä»…äº‘èº«ä»½ã€‚
* **Linux å®¢æˆ·ç«¯çš„ AD Kerberos èº«ä»½éªŒè¯**ï¼šå…è®¸ Linux å®¢æˆ·ç«¯é€šè¿‡æœ¬åœ° AD DS æˆ– Microsoft Entra åŸŸæœåŠ¡ä½¿ç”¨ Kerberos è¿›è¡Œ SMB èº«ä»½éªŒè¯ã€‚

## æšä¸¾

{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# List file shares
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# Get snapshots/backups
az storage share list --account-name <name> --include-snapshots --query "[?snapshot != null]"
# List contents of a snapshot/backup
az storage file list --account-name <name> --share-name <share-name> --snapshot <snapshot-version> #e.g. "2024-11-25T11:26:59.0000000Z"
# Download snapshot/backup
az storage file download-batch -d . --account-name <name> --source <share-name> --snapshot <snapshot-version>
```
{% endcode %}

{% hint style="info" %}
é»˜è®¤æƒ…å†µä¸‹ï¼Œ`az` cli å°†ä½¿ç”¨å¸æˆ·å¯†é’¥æ¥ç­¾åå¯†é’¥å¹¶æ‰§è¡Œæ“ä½œã€‚è¦ä½¿ç”¨ Entra ID ä¸»ä½“æƒé™ï¼Œè¯·ä½¿ç”¨å‚æ•° `--auth-mode login --enable-file-backup-request-intent`ã€‚
{% endhint %}

{% hint style="success" %}
ä½¿ç”¨å‚æ•° `--account-key` æŒ‡å®šè¦ä½¿ç”¨çš„å¸æˆ·å¯†é’¥\
ä½¿ç”¨å‚æ•° `--sas-token` ä¸ SAS ä»¤ç‰Œä¸€èµ·è®¿é—®
{% endhint %}

### è¿æ¥

è¿™äº›æ˜¯ Azure åœ¨æ’°å†™æ—¶å»ºè®®çš„è¿æ¥æ–‡ä»¶å…±äº«çš„è„šæœ¬ï¼š

æ‚¨éœ€è¦æ›¿æ¢ `<STORAGE-ACCOUNT>`ã€`<ACCESS-KEY>` å’Œ `<FILE-SHARE-NAME>` å ä½ç¬¦ã€‚

{% tabs %}
{% tab title="Windows" %}
{% code overflow="wrap" %}
```powershell
$connectTestResult = Test-NetConnection -ComputerName filescontainersrdtfgvhb.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded) {
# Save the password so the drive will persist on reboot
cmd.exe /C "cmdkey /add:`"<STORAGE-ACCOUNT>.file.core.windows.net`" /user:`"localhost\<STORAGE-ACCOUNT>`" /pass:`"<ACCESS-KEY>`""
# Mount the drive
New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<STORAGE-ACCOUNT>.file.core.windows.net\<FILE-SHARE-NAME>" -Persist
} else {
Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
}
```
{% endcode %}
{% endtab %}

{% tab title="Linux" %}
{% code overflow="wrap" %}
```bash
sudo mkdir /mnt/disk-shareeifrube
if [ ! -d "/etc/smbcredentials" ]; then
sudo mkdir /etc/smbcredentials
fi
if [ ! -f "/etc/smbcredentials/<STORAGE-ACCOUNT>.cred" ]; then
sudo bash -c 'echo "username=<STORAGE-ACCOUNT>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
sudo bash -c 'echo "password=<ACCESS-KEY>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
fi
sudo chmod 600 /etc/smbcredentials/<STORAGE-ACCOUNT>.cred

sudo bash -c 'echo "//<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> cifs nofail,credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30" >> /etc/fstab'
sudo mount -t cifs //<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> -o credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30
```
{% endcode %}
{% endtab %}

{% tab title="macOS" %}
{% code overflow="wrap" %}
```bash
open smb://<STORAGE-ACCOUNT>:<ACCESS-KEY>@<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME>
```
{% endcode %}
{% endtab %}
{% endtabs %}

### å¸¸è§„å­˜å‚¨æšä¸¾ï¼ˆè®¿é—®å¯†é’¥ï¼ŒSAS...ï¼‰

{% content-ref url="az-storage.md" %}
[az-storage.md](az-storage.md)
{% endcontent-ref %}

## æƒé™æå‡

ä¸å­˜å‚¨æƒé™æå‡ç›¸åŒï¼š

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## åˆ©ç”¨å

{% content-ref url="../az-post-exploitation/az-file-share-post-exploitation.md" %}
[az-file-share-post-exploitation.md](../az-post-exploitation/az-file-share-post-exploitation.md)
{% endcontent-ref %}

## æŒä¹…æ€§

ä¸å­˜å‚¨æŒä¹…æ€§ç›¸åŒï¼š

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
