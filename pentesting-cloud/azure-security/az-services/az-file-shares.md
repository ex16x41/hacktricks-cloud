# Az - File Shares

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Azure Files** je potpuno upravljana usluga skladi코tenja datoteka u oblaku koja pru쬬 deljeno skladi코tenje datoteka dostupno putem standardnih **SMB (Server Message Block)** i **NFS (Network File System)** protokola. Iako je glavni kori코캖eni protokol SMB, NFS Azure deljenja datoteka nisu podr쬬na za Windows (prema [**docs**](https://learn.microsoft.com/en-us/azure/storage/files/files-nfs-protocol)). Omogu캖ava vam da kreirate visoko dostupna mre쬹a deljenja datoteka koja mogu biti istovremeno dostupna vi코e virtuelnim ma코inama (VM) ili lokalnim sistemima, omogu캖avaju캖i besprekornu deljenje datoteka izme캠u okru쬰nja.

### Access Tiers

* **Transaction Optimized**: Optimizovano za operacije sa velikim brojem transakcija.
* **Hot**: Izbalansirano izme캠u transakcija i skladi코tenja.
* **Cool**: Ekonomi캜no za skladi코tenje.
* **Premium:** Skladi코tenje datoteka visokih performansi optimizovano za radne optere캖enja sa niskom latencijom i intenzivnim IOPS.

### Backups

* **Daily backup**: Ta캜ka rezervne kopije se kreira svakog dana u nazna캜eno vreme (npr. 19.30 UTC) i 캜uva se od 1 do 200 dana.
* **Weekly backup**: Ta캜ka rezervne kopije se kreira svake nedelje u nazna캜en dan i vreme (nedelja u 19.30) i 캜uva se od 1 do 200 nedelja.
* **Monthly backup**: Ta캜ka rezervne kopije se kreira svakog meseca u nazna캜en dan i vreme (npr. prva nedelja u mesecu u 19.30) i 캜uva se od 1 do 120 meseci.
* **Yearly backup**: Ta캜ka rezervne kopije se kreira svake godine u nazna캜en dan i vreme (npr. prva nedelja u januaru u 19.30) i 캜uva se od 1 do 10 godina.
* Tako캠e je mogu캖e izvr코iti **ru캜ne rezervne kopije i snimke u bilo kojem trenutku**. Rezervne kopije i snimci su zapravo isto u ovom kontekstu.

### Supported Authentications via SMB

* **On-premises AD DS Authentication**: Koristi lokalne Active Directory akreditive sinhronizovane sa Microsoft Entra ID za pristup zasnovan na identitetu. Zahteva mre쬹u povezanost sa lokalnim AD DS.
* **Microsoft Entra Domain Services Authentication**: Koristi Microsoft Entra Domain Services (oblaku zasnovan AD) za pru쬬nje pristupa koriste캖i Microsoft Entra akreditive.
* **Microsoft Entra Kerberos for Hybrid Identities**: Omogu캖ava Microsoft Entra korisnicima da autentifikuju Azure deljenja datoteka putem interneta koriste캖i Kerberos. Podr쬬va hibridne Microsoft Entra pridru쬰ne ili Microsoft Entra pridru쬰ne VM bez zahteva za povezivanjem sa lokalnim kontrolerima domena. Ali ne podr쬬va identitete koji su samo u oblaku.
* **AD Kerberos Authentication for Linux Clients**: Omogu캖ava Linux klijentima da koriste Kerberos za SMB autentifikaciju putem lokalnog AD DS ili Microsoft Entra Domain Services.

## Enumeration

{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# List file shares
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# Get snapshots/backups
az storage share list --account-name <name> --include-snapshots --query "[?snapshot != null]"
# List contents of a snapshot/backup
az storage file list --account-name <name> --share-name <share-name> --snapshot <snapshot-version> #e.g. "2024-11-25T11:26:59.0000000Z"
# Download snapshot/backup
az storage file download-batch -d . --account-name <name> --source <share-name> --snapshot <snapshot-version>
```
{% endcode %}

{% hint style="info" %}
Podrazumevano `az` cli 캖e koristiti klju캜 naloga za potpisivanje klju캜a i izvr코avanje akcije. Da biste koristili privilegije Entra ID glavnog korisnika, koristite parametre `--auth-mode login --enable-file-backup-request-intent`.
{% endhint %}

{% hint style="success" %}
Koristite parametar `--account-key` da nazna캜ite klju캜 naloga koji 캖e se koristiti\
Koristite parametar `--sas-token` sa SAS tokenom za pristup putem SAS tokena
{% endhint %}

### Povezivanje

Ovo su skripte koje je predlo쬴o Azure u vreme pisanja za povezivanje sa File Share:

Morate zameniti `<STORAGE-ACCOUNT>`, `<ACCESS-KEY>` i `<FILE-SHARE-NAME>` mesta za zamenu.

{% tabs %}
{% tab title="Windows" %}
{% code overflow="wrap" %}
```powershell
$connectTestResult = Test-NetConnection -ComputerName filescontainersrdtfgvhb.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded) {
# Save the password so the drive will persist on reboot
cmd.exe /C "cmdkey /add:`"<STORAGE-ACCOUNT>.file.core.windows.net`" /user:`"localhost\<STORAGE-ACCOUNT>`" /pass:`"<ACCESS-KEY>`""
# Mount the drive
New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<STORAGE-ACCOUNT>.file.core.windows.net\<FILE-SHARE-NAME>" -Persist
} else {
Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
}
```
{% endcode %}
{% endtab %}

{% tab title="Linux" %}
{% code overflow="wrap" %}
```bash
sudo mkdir /mnt/disk-shareeifrube
if [ ! -d "/etc/smbcredentials" ]; then
sudo mkdir /etc/smbcredentials
fi
if [ ! -f "/etc/smbcredentials/<STORAGE-ACCOUNT>.cred" ]; then
sudo bash -c 'echo "username=<STORAGE-ACCOUNT>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
sudo bash -c 'echo "password=<ACCESS-KEY>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
fi
sudo chmod 600 /etc/smbcredentials/<STORAGE-ACCOUNT>.cred

sudo bash -c 'echo "//<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> cifs nofail,credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30" >> /etc/fstab'
sudo mount -t cifs //<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> -o credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30
```
{% endcode %}
{% endtab %}

{% tab title="macOS" %}
{% code overflow="wrap" %}
```bash
open smb://<STORAGE-ACCOUNT>:<ACCESS-KEY>@<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME>
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Redovno enumerisanje skladi코ta (pristupni klju캜evi, SAS...)

{% content-ref url="az-storage.md" %}
[az-storage.md](az-storage.md)
{% endcontent-ref %}

## Eskalacija privilegija

Isto kao skladi코na eskalacija privilegija:

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## Post eksploatacija

{% content-ref url="../az-post-exploitation/az-file-share-post-exploitation.md" %}
[az-file-share-post-exploitation.md](../az-post-exploitation/az-file-share-post-exploitation.md)
{% endcontent-ref %}

## Postojanost

Isto kao skladi코na eskalacija privilegija:

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr코ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
