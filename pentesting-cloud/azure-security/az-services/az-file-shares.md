# Az - File Shares

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Azure Files**ëŠ” í‘œì¤€ **SMB (Server Message Block)** ë° **NFS (Network File System)** í”„ë¡œí† ì½œì„ í†µí•´ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê³µìœ  íŒŒì¼ ì €ì¥ì†Œë¥¼ ì œê³µí•˜ëŠ” ì™„ì „ ê´€ë¦¬í˜• í´ë¼ìš°ë“œ íŒŒì¼ ì €ì¥ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ì£¼ í”„ë¡œí† ì½œì€ SMBì´ì§€ë§Œ NFS Azure íŒŒì¼ ê³µìœ ëŠ” Windowsì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤(ìì„¸í•œ ë‚´ìš©ì€ [**docs**](https://learn.microsoft.com/en-us/azure/storage/files/files-nfs-protocol) ì°¸ì¡°). ì—¬ëŸ¬ ê°€ìƒ ë¨¸ì‹ (VM) ë˜ëŠ” ì˜¨í”„ë ˆë¯¸ìŠ¤ ì‹œìŠ¤í…œì—ì„œ ë™ì‹œì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê³ ê°€ìš©ì„± ë„¤íŠ¸ì›Œí¬ íŒŒì¼ ê³µìœ ë¥¼ ìƒì„±í•  ìˆ˜ ìˆì–´ í™˜ê²½ ê°„ ì›í™œí•œ íŒŒì¼ ê³µìœ ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### Access Tiers

* **Transaction Optimized**: íŠ¸ëœì­ì…˜ì´ ë§ì€ ì‘ì—…ì— ìµœì í™”ë¨.
* **Hot**: íŠ¸ëœì­ì…˜ê³¼ ì €ì¥ì†Œ ê°„ ê· í˜•.
* **Cool**: ì €ì¥ì†Œì— ë¹„ìš© íš¨ìœ¨ì .
* **Premium:** ì €ì§€ì—° ë° IOPS ì§‘ì•½ì ì¸ ì‘ì—…ì— ìµœì í™”ëœ ê³ ì„±ëŠ¥ íŒŒì¼ ì €ì¥ì†Œ.

### Backups

* **Daily backup**: ë§¤ì¼ ì§€ì •ëœ ì‹œê°„(ì˜ˆ: 19.30 UTC)ì— ë°±ì—… ì§€ì ì´ ìƒì„±ë˜ë©° 1ì¼ì—ì„œ 200ì¼ ë™ì•ˆ ì €ì¥ë©ë‹ˆë‹¤.
* **Weekly backup**: ë§¤ì£¼ ì§€ì •ëœ ë‚ ê³¼ ì‹œê°„(ì¼ìš”ì¼ 19.30)ì— ë°±ì—… ì§€ì ì´ ìƒì„±ë˜ë©° 1ì£¼ì—ì„œ 200ì£¼ ë™ì•ˆ ì €ì¥ë©ë‹ˆë‹¤.
* **Monthly backup**: ë§¤ì›” ì§€ì •ëœ ë‚ ê³¼ ì‹œê°„(ì˜ˆ: ì²« ë²ˆì§¸ ì¼ìš”ì¼ 19.30)ì— ë°±ì—… ì§€ì ì´ ìƒì„±ë˜ë©° 1ê°œì›”ì—ì„œ 120ê°œì›” ë™ì•ˆ ì €ì¥ë©ë‹ˆë‹¤.
* **Yearly backup**: ë§¤ë…„ ì§€ì •ëœ ë‚ ê³¼ ì‹œê°„(ì˜ˆ: 1ì›” ì²« ë²ˆì§¸ ì¼ìš”ì¼ 19.30)ì— ë°±ì—… ì§€ì ì´ ìƒì„±ë˜ë©° 1ë…„ì—ì„œ 10ë…„ ë™ì•ˆ ì €ì¥ë©ë‹ˆë‹¤.
* **ìˆ˜ë™ ë°±ì—… ë° ìŠ¤ëƒ…ìƒ·ì„ ì–¸ì œë“ ì§€ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.** ì´ ë§¥ë½ì—ì„œ ë°±ì—…ê³¼ ìŠ¤ëƒ…ìƒ·ì€ ì‹¤ì œë¡œ ë™ì¼í•©ë‹ˆë‹¤.

### Supported Authentications via SMB

* **On-premises AD DS Authentication**: ì˜¨í”„ë ˆë¯¸ìŠ¤ Active Directory ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ì—¬ Microsoft Entra IDì™€ ë™ê¸°í™”ëœ ì‹ ì› ê¸°ë°˜ ì ‘ê·¼ì„ ì œê³µí•©ë‹ˆë‹¤. ì˜¨í”„ë ˆë¯¸ìŠ¤ AD DSì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.
* **Microsoft Entra Domain Services Authentication**: Microsoft Entra ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ì—¬ ì ‘ê·¼ì„ ì œê³µí•˜ê¸° ìœ„í•´ Microsoft Entra Domain Services(í´ë¼ìš°ë“œ ê¸°ë°˜ AD)ë¥¼ í™œìš©í•©ë‹ˆë‹¤.
* **Microsoft Entra Kerberos for Hybrid Identities**: Microsoft Entra ì‚¬ìš©ìê°€ Kerberosë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸í„°ë„·ì„ í†µí•´ Azure íŒŒì¼ ê³µìœ ë¥¼ ì¸ì¦í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. ì˜¨í”„ë ˆë¯¸ìŠ¤ ë„ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ì— ëŒ€í•œ ì—°ê²° ì—†ì´ í•˜ì´ë¸Œë¦¬ë“œ Microsoft Entra ê°€ì… ë˜ëŠ” Microsoft Entra ê°€ì… VMì„ ì§€ì›í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ í´ë¼ìš°ë“œ ì „ìš© ì‹ ì›ì€ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
* **AD Kerberos Authentication for Linux Clients**: ì˜¨í”„ë ˆë¯¸ìŠ¤ AD DS ë˜ëŠ” Microsoft Entra Domain Servicesë¥¼ í†µí•´ Linux í´ë¼ì´ì–¸íŠ¸ê°€ SMB ì¸ì¦ì„ ìœ„í•´ Kerberosë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

## Enumeration

{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# List file shares
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# Get snapshots/backups
az storage share list --account-name <name> --include-snapshots --query "[?snapshot != null]"
# List contents of a snapshot/backup
az storage file list --account-name <name> --share-name <share-name> --snapshot <snapshot-version> #e.g. "2024-11-25T11:26:59.0000000Z"
# Download snapshot/backup
az storage file download-batch -d . --account-name <name> --source <share-name> --snapshot <snapshot-version>
```
{% endcode %}

{% hint style="info" %}
ê¸°ë³¸ì ìœ¼ë¡œ `az` cliëŠ” ê³„ì • í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ í‚¤ì— ì„œëª…í•˜ê³  ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. Entra ID ì£¼ì²´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë ¤ë©´ `--auth-mode login --enable-file-backup-request-intent` ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
{% endhint %}

{% hint style="success" %}
ì‚¬ìš©í•  ê³„ì • í‚¤ë¥¼ ì§€ì •í•˜ë ¤ë©´ `--account-key` ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.\
SAS í† í°ì„ í†µí•´ ì•¡ì„¸ìŠ¤í•˜ë ¤ë©´ SAS í† í°ê³¼ í•¨ê»˜ `--sas-token` ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
{% endhint %}

### ì—°ê²°

ë‹¤ìŒì€ íŒŒì¼ ê³µìœ ì— ì—°ê²°í•˜ê¸° ìœ„í•´ ì‘ì„± ì‹œì ì— Azureì—ì„œ ì œì•ˆí•œ ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤:

`<STORAGE-ACCOUNT>`, `<ACCESS-KEY>` ë° `<FILE-SHARE-NAME>` ìë¦¬ í‘œì‹œìë¥¼ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.

{% tabs %}
{% tab title="Windows" %}
{% code overflow="wrap" %}
```powershell
$connectTestResult = Test-NetConnection -ComputerName filescontainersrdtfgvhb.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded) {
# Save the password so the drive will persist on reboot
cmd.exe /C "cmdkey /add:`"<STORAGE-ACCOUNT>.file.core.windows.net`" /user:`"localhost\<STORAGE-ACCOUNT>`" /pass:`"<ACCESS-KEY>`""
# Mount the drive
New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<STORAGE-ACCOUNT>.file.core.windows.net\<FILE-SHARE-NAME>" -Persist
} else {
Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
}
```
{% endcode %}
{% endtab %}

{% tab title="ë¦¬ëˆ…ìŠ¤" %}
{% code overflow="wrap" %}
```bash
sudo mkdir /mnt/disk-shareeifrube
if [ ! -d "/etc/smbcredentials" ]; then
sudo mkdir /etc/smbcredentials
fi
if [ ! -f "/etc/smbcredentials/<STORAGE-ACCOUNT>.cred" ]; then
sudo bash -c 'echo "username=<STORAGE-ACCOUNT>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
sudo bash -c 'echo "password=<ACCESS-KEY>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
fi
sudo chmod 600 /etc/smbcredentials/<STORAGE-ACCOUNT>.cred

sudo bash -c 'echo "//<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> cifs nofail,credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30" >> /etc/fstab'
sudo mount -t cifs //<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> -o credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30
```
{% endcode %}
{% endtab %}

{% tab title="macOS" %}
{% code overflow="wrap" %}
```bash
open smb://<STORAGE-ACCOUNT>:<ACCESS-KEY>@<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME>
```
{% endcode %}
{% endtab %}
{% endtabs %}

### ì •ê¸°ì ì¸ ìŠ¤í† ë¦¬ì§€ ì—´ê±° (ì•¡ì„¸ìŠ¤ í‚¤, SAS...)

{% content-ref url="az-storage.md" %}
[az-storage.md](az-storage.md)
{% endcontent-ref %}

## ê¶Œí•œ ìƒìŠ¹

ìŠ¤í† ë¦¬ì§€ ê¶Œí•œ ìƒìŠ¹ê³¼ ë™ì¼í•©ë‹ˆë‹¤:

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## í¬ìŠ¤íŠ¸ ìµìŠ¤í”Œë¡œì‡

{% content-ref url="../az-post-exploitation/az-file-share-post-exploitation.md" %}
[az-file-share-post-exploitation.md](../az-post-exploitation/az-file-share-post-exploitation.md)
{% endcontent-ref %}

## ì§€ì†ì„±

ìŠ¤í† ë¦¬ì§€ ê¶Œí•œ ìƒìŠ¹ê³¼ ë™ì¼í•©ë‹ˆë‹¤:

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
