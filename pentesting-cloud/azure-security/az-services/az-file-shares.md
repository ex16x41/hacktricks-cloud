# Az - File Shares

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

**Azure Files** ã¯ã€æ¨™æº–ã® **SMB (Server Message Block)** ãŠã‚ˆã³ **NFS (Network File System)** ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä»‹ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªå…±æœ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æä¾›ã™ã‚‹å®Œå…¨ç®¡ç†å‹ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ä¸»ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¯SMBã§ã™ãŒã€NFS Azureãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã¯Windowsã§ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆ[**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**](https://learn.microsoft.com/en-us/azure/storage/files/files-nfs-protocol)ã«ã‚ˆã‚‹ï¼‰ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€è¤‡æ•°ã®ä»®æƒ³ãƒã‚·ãƒ³ (VM) ã¾ãŸã¯ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦åŒæ™‚ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªé«˜å¯ç”¨æ€§ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã‚’ä½œæˆã§ãã€ç’°å¢ƒé–“ã§ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### ã‚¢ã‚¯ã‚»ã‚¹éšå±¤

* **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æœ€é©åŒ–**: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå¤šã„æ“ä½œã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚
* **ãƒ›ãƒƒãƒˆ**: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚Œã¦ã„ã¾ã™ã€‚
* **ã‚¯ãƒ¼ãƒ«**: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚³ã‚¹ãƒˆåŠ¹æœçš„ã§ã™ã€‚
* **ãƒ—ãƒ¬ãƒŸã‚¢ãƒ :** ä½é…å»¶ãŠã‚ˆã³IOPSé›†ä¸­çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã«æœ€é©åŒ–ã•ã‚ŒãŸé«˜æ€§èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã€‚

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

* **æ—¥æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: æŒ‡å®šã•ã‚ŒãŸæ™‚é–“ï¼ˆä¾‹ï¼š19.30 UTCï¼‰ã«æ¯æ—¥ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒã‚¤ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã€1æ—¥ã‹ã‚‰200æ—¥é–“ä¿å­˜ã•ã‚Œã¾ã™ã€‚
* **é€±æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: æŒ‡å®šã•ã‚ŒãŸæ›œæ—¥ã¨æ™‚é–“ï¼ˆæ¯é€±æ—¥æ›œæ—¥ã®19.30ï¼‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒã‚¤ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã€1é€±é–“ã‹ã‚‰200é€±é–“ä¿å­˜ã•ã‚Œã¾ã™ã€‚
* **æœˆæ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: æŒ‡å®šã•ã‚ŒãŸæ—¥ã¨æ™‚é–“ï¼ˆä¾‹ï¼šæ¯æœˆã®æœ€åˆã®æ—¥æ›œæ—¥ã®19.30ï¼‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒã‚¤ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã€1ãƒ¶æœˆã‹ã‚‰120ãƒ¶æœˆä¿å­˜ã•ã‚Œã¾ã™ã€‚
* **å¹´æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: æŒ‡å®šã•ã‚ŒãŸæ—¥ã¨æ™‚é–“ï¼ˆä¾‹ï¼š1æœˆã®æœ€åˆã®æ—¥æ›œæ—¥ã®19.30ï¼‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒã‚¤ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã€1å¹´ã‹ã‚‰10å¹´ä¿å­˜ã•ã‚Œã¾ã™ã€‚
* **æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŠã‚ˆã³ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ã„ã¤ã§ã‚‚å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™**ã€‚ã“ã®æ–‡è„ˆã§ã¯ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¯å®Ÿéš›ã«ã¯åŒã˜ã§ã™ã€‚

### SMBçµŒç”±ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹èªè¨¼

* **ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹AD DSèªè¨¼**: ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®Active Directoryè³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã€Microsoft Entra IDã¨åŒæœŸã•ã‚Œã¦ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹AD DSã¸ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå¿…è¦ã§ã™ã€‚
* **Microsoft Entraãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹èªè¨¼**: Microsoft Entraè³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ã€Microsoft Entraãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ADï¼‰ã‚’æ´»ç”¨ã—ã¾ã™ã€‚
* **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”¨ã®Microsoft Entra Kerberos**: Microsoft Entraãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§Azureãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã‚’Kerberosã‚’ä½¿ç”¨ã—ã¦èªè¨¼ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¸ã®æ¥ç¶šã‚’å¿…è¦ã¨ã›ãšã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰Microsoft Entraå‚åŠ ã¾ãŸã¯Microsoft Entraå‚åŠ ã®VMã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ãŸã ã—ã€ã‚¯ãƒ©ã‚¦ãƒ‰å°‚ç”¨ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
* **Linuxã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã®AD Kerberosèªè¨¼**: Linuxã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹AD DSã¾ãŸã¯Microsoft Entraãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä»‹ã—ã¦SMBèªè¨¼ã«Kerberosã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

## åˆ—æŒ™

{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# List file shares
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# Get snapshots/backups
az storage share list --account-name <name> --include-snapshots --query "[?snapshot != null]"
# List contents of a snapshot/backup
az storage file list --account-name <name> --share-name <share-name> --snapshot <snapshot-version> #e.g. "2024-11-25T11:26:59.0000000Z"
# Download snapshot/backup
az storage file download-batch -d . --account-name <name> --source <share-name> --snapshot <snapshot-version>
```
{% endcode %}

{% hint style="info" %}
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€`az` cliã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã‚­ãƒ¼ã«ç½²åã—ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚Entra IDã®ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«æ¨©é™ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€`--auth-mode login --enable-file-backup-request-intent`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
{% endhint %}

{% hint style="success" %}
`--account-key`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’æŒ‡å®šã—ã¾ã™\
`--sas-token`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦SASãƒˆãƒ¼ã‚¯ãƒ³çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™
{% endhint %}

### æ¥ç¶š

ã“ã‚Œã‚‰ã¯ã€åŸ·ç­†æ™‚ã«AzureãŒææ¡ˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã«æ¥ç¶šã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ï¼š

`<STORAGE-ACCOUNT>`ã€`<ACCESS-KEY>`ã€ãŠã‚ˆã³`<FILE-SHARE-NAME>`ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

{% tabs %}
{% tab title="Windows" %}
{% code overflow="wrap" %}
```powershell
$connectTestResult = Test-NetConnection -ComputerName filescontainersrdtfgvhb.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded) {
# Save the password so the drive will persist on reboot
cmd.exe /C "cmdkey /add:`"<STORAGE-ACCOUNT>.file.core.windows.net`" /user:`"localhost\<STORAGE-ACCOUNT>`" /pass:`"<ACCESS-KEY>`""
# Mount the drive
New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<STORAGE-ACCOUNT>.file.core.windows.net\<FILE-SHARE-NAME>" -Persist
} else {
Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
}
```
{% endcode %}
{% endtab %}

{% tab title="Linux" %}
{% code overflow="wrap" %}
```bash
sudo mkdir /mnt/disk-shareeifrube
if [ ! -d "/etc/smbcredentials" ]; then
sudo mkdir /etc/smbcredentials
fi
if [ ! -f "/etc/smbcredentials/<STORAGE-ACCOUNT>.cred" ]; then
sudo bash -c 'echo "username=<STORAGE-ACCOUNT>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
sudo bash -c 'echo "password=<ACCESS-KEY>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
fi
sudo chmod 600 /etc/smbcredentials/<STORAGE-ACCOUNT>.cred

sudo bash -c 'echo "//<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> cifs nofail,credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30" >> /etc/fstab'
sudo mount -t cifs //<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> -o credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30
```
{% endcode %}
{% endtab %}

{% tab title="macOS" %}
{% code overflow="wrap" %}
```bash
open smb://<STORAGE-ACCOUNT>:<ACCESS-KEY>@<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME>
```
{% endcode %}
{% endtab %}
{% endtabs %}

### å®šæœŸã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆ—æŒ™ (ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã€SAS...)

{% content-ref url="az-storage.md" %}
[az-storage.md](az-storage.md)
{% endcontent-ref %}

## æ¨©é™æ˜‡æ ¼

ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®æ¨©é™æ˜‡æ ¼ã¨åŒã˜ã§ã™ï¼š

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ

{% content-ref url="../az-post-exploitation/az-file-share-post-exploitation.md" %}
[az-file-share-post-exploitation.md](../az-post-exploitation/az-file-share-post-exploitation.md)
{% endcontent-ref %}

## æ°¸ç¶šæ€§

ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®æ°¸ç¶šæ€§ã¨åŒã˜ã§ã™ï¼š

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
