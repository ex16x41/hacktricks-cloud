# Az - Partages de fichiers

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informations de base

**Azure Files** est un service de stockage de fichiers cloud enti√®rement g√©r√© qui fournit un stockage de fichiers partag√© accessible via les protocoles standard **SMB (Server Message Block)** et **NFS (Network File System)**. Bien que le protocole principal utilis√© soit SMB, les partages de fichiers NFS Azure ne sont pas pris en charge pour Windows (selon la [**documentation**](https://learn.microsoft.com/en-us/azure/storage/files/files-nfs-protocol)). Il vous permet de cr√©er des partages de fichiers r√©seau hautement disponibles qui peuvent √™tre accessibles simultan√©ment par plusieurs machines virtuelles (VM) ou syst√®mes sur site, permettant un partage de fichiers fluide entre les environnements.

### Niveaux d'acc√®s

* **Optimis√© pour les transactions** : Optimis√© pour les op√©rations lourdes en transactions.
* **Chaud** : √âquilibr√© entre transactions et stockage.
* **Froid** : Rentable pour le stockage.
* **Premium :** Stockage de fichiers haute performance optimis√© pour des charges de travail √† faible latence et intensives en IOPS.

### Sauvegardes

* **Sauvegarde quotidienne** : Un point de sauvegarde est cr√©√© chaque jour √† une heure indiqu√©e (par exemple, 19h30 UTC) et stock√© pendant 1 √† 200 jours.
* **Sauvegarde hebdomadaire** : Un point de sauvegarde est cr√©√© chaque semaine √† un jour et une heure indiqu√©s (dimanche √† 19h30) et stock√© pendant 1 √† 200 semaines.
* **Sauvegarde mensuelle** : Un point de sauvegarde est cr√©√© chaque mois √† un jour et une heure indiqu√©s (par exemple, le premier dimanche √† 19h30) et stock√© pendant 1 √† 120 mois.
* **Sauvegarde annuelle** : Un point de sauvegarde est cr√©√© chaque ann√©e √† un jour et une heure indiqu√©s (par exemple, le premier dimanche de janvier √† 19h30) et stock√© pendant 1 √† 10 ans.
* Il est √©galement possible d'effectuer des **sauvegardes manuelles et des instantan√©s √† tout moment**. Les sauvegardes et les instantan√©s sont en fait les m√™mes dans ce contexte.

### Authentifications prises en charge via SMB

* **Authentification AD DS sur site** : Elle utilise des identifiants Active Directory sur site synchronis√©s avec Microsoft Entra ID pour un acc√®s bas√© sur l'identit√©. Elle n√©cessite une connectivit√© r√©seau avec AD DS sur site.
* **Authentification des services de domaine Microsoft Entra** : Elle utilise les services de domaine Microsoft Entra (AD bas√© sur le cloud) pour fournir un acc√®s en utilisant des identifiants Microsoft Entra.
* **Kerberos Microsoft Entra pour identit√©s hybrides** : Il permet aux utilisateurs de Microsoft Entra d'authentifier les partages de fichiers Azure via Internet en utilisant Kerberos. Il prend en charge les VM jointes √† Microsoft Entra hybrides ou jointes √† Microsoft Entra sans n√©cessiter de connectivit√© avec les contr√¥leurs de domaine sur site. Mais il ne prend pas en charge les identit√©s uniquement cloud.
* **Authentification Kerberos AD pour clients Linux** : Elle permet aux clients Linux d'utiliser Kerberos pour l'authentification SMB via AD DS sur site ou les services de domaine Microsoft Entra.

## √ânum√©ration

{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# List file shares
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# Get snapshots/backups
az storage share list --account-name <name> --include-snapshots --query "[?snapshot != null]"
# List contents of a snapshot/backup
az storage file list --account-name <name> --share-name <share-name> --snapshot <snapshot-version> #e.g. "2024-11-25T11:26:59.0000000Z"
# Download snapshot/backup
az storage file download-batch -d . --account-name <name> --source <share-name> --snapshot <snapshot-version>
```
{% endcode %}

{% hint style="info" %}
Par d√©faut, `az` cli utilisera une cl√© de compte pour signer une cl√© et effectuer l'action. Pour utiliser les privil√®ges du principal Entra ID, utilisez les param√®tres `--auth-mode login --enable-file-backup-request-intent`.
{% endhint %}

{% hint style="success" %}
Utilisez le param√®tre `--account-key` pour indiquer la cl√© de compte √† utiliser\
Utilisez le param√®tre `--sas-token` avec le token SAS pour acc√©der via un token SAS
{% endhint %}

### Connexion

Voici les scripts propos√©s par Azure au moment de l'√©criture pour se connecter √† un partage de fichiers :

Vous devez remplacer les espaces r√©serv√©s `<STORAGE-ACCOUNT>`, `<ACCESS-KEY>` et `<FILE-SHARE-NAME>`. 

{% tabs %}
{% tab title="Windows" %}
{% code overflow="wrap" %}
```powershell
$connectTestResult = Test-NetConnection -ComputerName filescontainersrdtfgvhb.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded) {
# Save the password so the drive will persist on reboot
cmd.exe /C "cmdkey /add:`"<STORAGE-ACCOUNT>.file.core.windows.net`" /user:`"localhost\<STORAGE-ACCOUNT>`" /pass:`"<ACCESS-KEY>`""
# Mount the drive
New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<STORAGE-ACCOUNT>.file.core.windows.net\<FILE-SHARE-NAME>" -Persist
} else {
Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
}
```
{% endcode %}
{% endtab %}

{% tab title="Linux" %}
{% code overflow="wrap" %}
```bash
sudo mkdir /mnt/disk-shareeifrube
if [ ! -d "/etc/smbcredentials" ]; then
sudo mkdir /etc/smbcredentials
fi
if [ ! -f "/etc/smbcredentials/<STORAGE-ACCOUNT>.cred" ]; then
sudo bash -c 'echo "username=<STORAGE-ACCOUNT>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
sudo bash -c 'echo "password=<ACCESS-KEY>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
fi
sudo chmod 600 /etc/smbcredentials/<STORAGE-ACCOUNT>.cred

sudo bash -c 'echo "//<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> cifs nofail,credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30" >> /etc/fstab'
sudo mount -t cifs //<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> -o credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30
```
{% endcode %}
{% endtab %}

{% tab title="macOS" %}
{% code overflow="wrap" %}
```bash
open smb://<STORAGE-ACCOUNT>:<ACCESS-KEY>@<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME>
```
{% endcode %}
{% endtab %}
{% endtabs %}

### √ânum√©ration de stockage r√©guli√®re (cl√©s d'acc√®s, SAS...)

{% content-ref url="az-storage.md" %}
[az-storage.md](az-storage.md)
{% endcontent-ref %}

## Escalade de privil√®ges

Identique √† la privesc de stockage :

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## Post-exploitation

{% content-ref url="../az-post-exploitation/az-file-share-post-exploitation.md" %}
[az-file-share-post-exploitation.md](../az-post-exploitation/az-file-share-post-exploitation.md)
{% endcontent-ref %}

## Persistance

Identique √† la privesc de stockage :

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
