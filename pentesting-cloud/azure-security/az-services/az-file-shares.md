# Az - File Shares

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Grundinformationen

**Azure Files** ist ein vollst√§ndig verwalteter Cloud-Dateispeicherdienst, der gemeinsamen Dateispeicher bereitstellt, der √ºber die Standardprotokolle **SMB (Server Message Block)** und **NFS (Network File System)** zug√§nglich ist. Obwohl das Hauptprotokoll SMB ist, werden NFS Azure-Dateifreigaben f√ºr Windows nicht unterst√ºtzt (laut den [**Docs**](https://learn.microsoft.com/en-us/azure/storage/files/files-nfs-protocol)). Es erm√∂glicht Ihnen, hochverf√ºgbare Netzwerkdateifreigaben zu erstellen, die gleichzeitig von mehreren virtuellen Maschinen (VMs) oder lokalen Systemen zugegriffen werden k√∂nnen, was nahtloses Dateifreigeben √ºber verschiedene Umgebungen hinweg erm√∂glicht.

### Zugriffsebenen

* **Transaktionsoptimiert**: Optimiert f√ºr transaktionsintensive Operationen.
* **Hot**: Ausgewogen zwischen Transaktionen und Speicherung.
* **Cool**: Kostenwirksam f√ºr Speicherung.
* **Premium:** Hochleistungs-Dateispeicher, optimiert f√ºr latenzarme und IOPS-intensive Workloads.

### Backups

* **T√§gliches Backup**: Ein Backup-Punkt wird jeden Tag zu einer angegebenen Zeit (z.B. 19.30 UTC) erstellt und f√ºr 1 bis 200 Tage gespeichert.
* **W√∂chentliches Backup**: Ein Backup-Punkt wird jede Woche an einem angegebenen Tag und zu einer angegebenen Zeit (Sonntag um 19.30) erstellt und f√ºr 1 bis 200 Wochen gespeichert.
* **Monatliches Backup**: Ein Backup-Punkt wird jeden Monat an einem angegebenen Tag und zu einer angegebenen Zeit (z.B. erster Sonntag um 19.30) erstellt und f√ºr 1 bis 120 Monate gespeichert.
* **J√§hrliches Backup**: Ein Backup-Punkt wird jedes Jahr an einem angegebenen Tag und zu einer angegebenen Zeit (z.B. erster Sonntag im Januar um 19.30) erstellt und f√ºr 1 bis 10 Jahre gespeichert.
* Es ist auch m√∂glich, **manuelle Backups und Snapshots jederzeit** durchzuf√ºhren. Backups und Snapshots sind in diesem Kontext tats√§chlich dasselbe.

### Unterst√ºtzte Authentifizierungen √ºber SMB

* **On-premises AD DS-Authentifizierung**: Es verwendet lokale Active Directory-Anmeldeinformationen, die mit Microsoft Entra ID f√ºr identit√§tsbasierten Zugriff synchronisiert sind. Es erfordert eine Netzwerkverbindung zu on-premises AD DS.
* **Microsoft Entra Domain Services-Authentifizierung**: Es nutzt Microsoft Entra Domain Services (cloudbasiertes AD), um den Zugriff mit Microsoft Entra-Anmeldeinformationen bereitzustellen.
* **Microsoft Entra Kerberos f√ºr hybride Identit√§ten**: Es erm√∂glicht Microsoft Entra-Benutzern, Azure-Dateifreigaben √ºber das Internet mit Kerberos zu authentifizieren. Es unterst√ºtzt hybride Microsoft Entra-verbundene oder Microsoft Entra-verbundene VMs, ohne dass eine Verbindung zu lokalen Dom√§nencontrollern erforderlich ist. Es unterst√ºtzt jedoch keine cloud-only Identit√§ten.
* **AD Kerberos-Authentifizierung f√ºr Linux-Clients**: Es erm√∂glicht Linux-Clients, Kerberos f√ºr die SMB-Authentifizierung √ºber on-premises AD DS oder Microsoft Entra Domain Services zu verwenden.

## Enumeration

{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# List file shares
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# Get snapshots/backups
az storage share list --account-name <name> --include-snapshots --query "[?snapshot != null]"
# List contents of a snapshot/backup
az storage file list --account-name <name> --share-name <share-name> --snapshot <snapshot-version> #e.g. "2024-11-25T11:26:59.0000000Z"
# Download snapshot/backup
az storage file download-batch -d . --account-name <name> --source <share-name> --snapshot <snapshot-version>
```
{% endcode %}

{% hint style="info" %}
Standardm√§√üig verwendet die `az` CLI einen Kontoschl√ºssel, um einen Schl√ºssel zu signieren und die Aktion auszuf√ºhren. Um die Berechtigungen des Entra ID-Prinzipals zu verwenden, verwenden Sie die Parameter `--auth-mode login --enable-file-backup-request-intent`.
{% endhint %}

{% hint style="success" %}
Verwenden Sie den Parameter `--account-key`, um den zu verwendenden Kontoschl√ºssel anzugeben\
Verwenden Sie den Parameter `--sas-token` mit dem SAS-Token, um √ºber ein SAS-Token zuzugreifen
{% endhint %}

### Verbindung

Dies sind die von Azure zum Zeitpunkt des Schreibens vorgeschlagenen Skripte, um eine File Share zu verbinden:

Sie m√ºssen die Platzhalter `<STORAGE-ACCOUNT>`, `<ACCESS-KEY>` und `<FILE-SHARE-NAME>` ersetzen.

{% tabs %}
{% tab title="Windows" %}
{% code overflow="wrap" %}
```powershell
$connectTestResult = Test-NetConnection -ComputerName filescontainersrdtfgvhb.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded) {
# Save the password so the drive will persist on reboot
cmd.exe /C "cmdkey /add:`"<STORAGE-ACCOUNT>.file.core.windows.net`" /user:`"localhost\<STORAGE-ACCOUNT>`" /pass:`"<ACCESS-KEY>`""
# Mount the drive
New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<STORAGE-ACCOUNT>.file.core.windows.net\<FILE-SHARE-NAME>" -Persist
} else {
Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
}
```
{% endcode %}
{% endtab %}

{% tab title="Linux" %}
{% code overflow="wrap" %}
```bash
sudo mkdir /mnt/disk-shareeifrube
if [ ! -d "/etc/smbcredentials" ]; then
sudo mkdir /etc/smbcredentials
fi
if [ ! -f "/etc/smbcredentials/<STORAGE-ACCOUNT>.cred" ]; then
sudo bash -c 'echo "username=<STORAGE-ACCOUNT>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
sudo bash -c 'echo "password=<ACCESS-KEY>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
fi
sudo chmod 600 /etc/smbcredentials/<STORAGE-ACCOUNT>.cred

sudo bash -c 'echo "//<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> cifs nofail,credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30" >> /etc/fstab'
sudo mount -t cifs //<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> -o credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30
```
{% endcode %}
{% endtab %}

{% tab title="macOS" %}
{% code overflow="wrap" %}
```bash
open smb://<STORAGE-ACCOUNT>:<ACCESS-KEY>@<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME>
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Regelm√§√üige Speicherenumeration (Zugriffsschl√ºssel, SAS...)

{% content-ref url="az-storage.md" %}
[az-storage.md](az-storage.md)
{% endcontent-ref %}

## Privilegieneskalation

Gleich wie Speicher privesc:

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## Post-Exploitation

{% content-ref url="../az-post-exploitation/az-file-share-post-exploitation.md" %}
[az-file-share-post-exploitation.md](../az-post-exploitation/az-file-share-post-exploitation.md)
{% endcontent-ref %}

## Persistenz

Gleich wie Speicher privesc:

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
