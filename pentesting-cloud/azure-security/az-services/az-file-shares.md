# Az - File Shares

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Azure Files**, standart **SMB (Server Message Block)** ve **NFS (Network File System)** protokolleri aracÄ±lÄ±ÄŸÄ±yla eriÅŸilebilen paylaÅŸÄ±mlÄ± dosya depolama saÄŸlayan tamamen yÃ¶netilen bir bulut dosya depolama hizmetidir. KullanÄ±lan ana protokol SMB olmasÄ±na raÄŸmen, NFS Azure dosya paylaÅŸÄ±mlarÄ± Windows iÃ§in desteklenmemektedir ( [**belgelere**](https://learn.microsoft.com/en-us/azure/storage/files/files-nfs-protocol) gÃ¶re). Birden fazla sanal makine (VM) veya yerel sistemler tarafÄ±ndan aynÄ± anda eriÅŸilebilen yÃ¼ksek kullanÄ±labilirlikte aÄŸ dosya paylaÅŸÄ±mlarÄ± oluÅŸturmanÄ±za olanak tanÄ±r ve ortamlar arasÄ±nda kesintisiz dosya paylaÅŸÄ±mÄ±nÄ± saÄŸlar.

### Access Tiers

* **Transaction Optimized**: Ä°ÅŸlem yoÄŸun operasyonlar iÃ§in optimize edilmiÅŸtir.
* **Hot**: Ä°ÅŸlemler ve depolama arasÄ±nda dengelidir.
* **Cool**: Depolama iÃ§in maliyet etkin.
* **Premium:** DÃ¼ÅŸÃ¼k gecikme sÃ¼resi ve IOPS yoÄŸun iÅŸ yÃ¼kleri iÃ§in optimize edilmiÅŸ yÃ¼ksek performanslÄ± dosya depolama.

### Backups

* **Daily backup**: Her gÃ¼n belirli bir saatte (Ã¶rneÄŸin, 19.30 UTC) bir yedekleme noktasÄ± oluÅŸturulur ve 1 ila 200 gÃ¼n arasÄ±nda saklanÄ±r.
* **Weekly backup**: Her hafta belirli bir gÃ¼n ve saatte (Pazar gÃ¼nÃ¼ 19.30) bir yedekleme noktasÄ± oluÅŸturulur ve 1 ila 200 hafta arasÄ±nda saklanÄ±r.
* **Monthly backup**: Her ay belirli bir gÃ¼n ve saatte (Ã¶rneÄŸin, ilk Pazar gÃ¼nÃ¼ 19.30) bir yedekleme noktasÄ± oluÅŸturulur ve 1 ila 120 ay arasÄ±nda saklanÄ±r.
* **Yearly backup**: Her yÄ±l belirli bir gÃ¼n ve saatte (Ã¶rneÄŸin, Ocak ayÄ±nÄ±n ilk Pazar gÃ¼nÃ¼ 19.30) bir yedekleme noktasÄ± oluÅŸturulur ve 1 ila 10 yÄ±l arasÄ±nda saklanÄ±r.
* AyrÄ±ca, **herhangi bir zamanda manuel yedeklemeler ve anlÄ±k gÃ¶rÃ¼ntÃ¼ler** almak da mÃ¼mkÃ¼ndÃ¼r. Yedeklemeler ve anlÄ±k gÃ¶rÃ¼ntÃ¼ler aslÄ±nda bu baÄŸlamda aynÄ±dÄ±r.

### Supported Authentications via SMB

* **On-premises AD DS Authentication**: Kimlik tabanlÄ± eriÅŸim iÃ§in Microsoft Entra ID ile senkronize edilmiÅŸ yerel Active Directory kimlik bilgilerini kullanÄ±r. Yerel AD DS'ye aÄŸ baÄŸlantÄ±sÄ± gerektirir.
* **Microsoft Entra Domain Services Authentication**: Microsoft Entra kimlik bilgilerini kullanarak eriÅŸim saÄŸlamak iÃ§in Microsoft Entra Domain Services (bulut tabanlÄ± AD) kullanÄ±r.
* **Microsoft Entra Kerberos for Hybrid Identities**: Microsoft Entra kullanÄ±cÄ±larÄ±nÄ±n Kerberos kullanarak Azure dosya paylaÅŸÄ±mlarÄ±nÄ± internet Ã¼zerinden kimlik doÄŸrulamasÄ±na olanak tanÄ±r. Yerel etki alanÄ± denetleyicilerine baÄŸlantÄ± gerektirmeden hibrit Microsoft Entra katÄ±lÄ±mlÄ± veya Microsoft Entra katÄ±lÄ±mlÄ± VM'leri destekler. Ancak yalnÄ±zca bulut kimliklerini desteklemez.
* **AD Kerberos Authentication for Linux Clients**: Yerel AD DS veya Microsoft Entra Domain Services aracÄ±lÄ±ÄŸÄ±yla SMB kimlik doÄŸrulamasÄ± iÃ§in Linux istemcilerinin Kerberos kullanmasÄ±na olanak tanÄ±r.

## Enumeration

{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# List file shares
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# Get snapshots/backups
az storage share list --account-name <name> --include-snapshots --query "[?snapshot != null]"
# List contents of a snapshot/backup
az storage file list --account-name <name> --share-name <share-name> --snapshot <snapshot-version> #e.g. "2024-11-25T11:26:59.0000000Z"
# Download snapshot/backup
az storage file download-batch -d . --account-name <name> --source <share-name> --snapshot <snapshot-version>
```
{% endcode %}

{% hint style="info" %}
VarsayÄ±lan olarak `az` cli, bir anahtarÄ± imzalamak ve iÅŸlemi gerÃ§ekleÅŸtirmek iÃ§in bir hesap anahtarÄ± kullanacaktÄ±r. Entra ID anahtar ayrÄ±calÄ±klarÄ±nÄ± kullanmak iÃ§in `--auth-mode login --enable-file-backup-request-intent` parametrelerini kullanÄ±n.
{% endhint %}

{% hint style="success" %}
KullanÄ±lacak hesap anahtarÄ±nÄ± belirtmek iÃ§in `--account-key` parametresini kullanÄ±n\
SAS token ile eriÅŸmek iÃ§in `--sas-token` parametresini SAS token ile kullanÄ±n
{% endhint %}

### BaÄŸlantÄ±

Bunlar, yazÄ±m sÄ±rasÄ±nda Azure tarafÄ±ndan bir Dosya PaylaÅŸÄ±mÄ±na baÄŸlanmak iÃ§in Ã¶nerilen betiklerdir:

`<STORAGE-ACCOUNT>`, `<ACCESS-KEY>` ve `<FILE-SHARE-NAME>` yer tutucularÄ±nÄ± deÄŸiÅŸtirmeniz gerekiyor.

{% tabs %}
{% tab title="Windows" %}
{% code overflow="wrap" %}
```powershell
$connectTestResult = Test-NetConnection -ComputerName filescontainersrdtfgvhb.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded) {
# Save the password so the drive will persist on reboot
cmd.exe /C "cmdkey /add:`"<STORAGE-ACCOUNT>.file.core.windows.net`" /user:`"localhost\<STORAGE-ACCOUNT>`" /pass:`"<ACCESS-KEY>`""
# Mount the drive
New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<STORAGE-ACCOUNT>.file.core.windows.net\<FILE-SHARE-NAME>" -Persist
} else {
Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
}
```
{% endcode %}
{% endtab %}

{% tab title="Linux" %}
{% code overflow="wrap" %}
```bash
sudo mkdir /mnt/disk-shareeifrube
if [ ! -d "/etc/smbcredentials" ]; then
sudo mkdir /etc/smbcredentials
fi
if [ ! -f "/etc/smbcredentials/<STORAGE-ACCOUNT>.cred" ]; then
sudo bash -c 'echo "username=<STORAGE-ACCOUNT>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
sudo bash -c 'echo "password=<ACCESS-KEY>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
fi
sudo chmod 600 /etc/smbcredentials/<STORAGE-ACCOUNT>.cred

sudo bash -c 'echo "//<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> cifs nofail,credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30" >> /etc/fstab'
sudo mount -t cifs //<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> -o credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30
```
{% endcode %}
{% endtab %}

{% tab title="macOS" %}
{% code overflow="wrap" %}
```bash
open smb://<STORAGE-ACCOUNT>:<ACCESS-KEY>@<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME>
```
{% endcode %}
{% endtab %}
{% endtabs %}

### DÃ¼zenli depolama numaralandÄ±rmasÄ± (eriÅŸim anahtarlarÄ±, SAS...)

{% content-ref url="az-storage.md" %}
[az-storage.md](az-storage.md)
{% endcontent-ref %}

## Yetki YÃ¼kseltme

Depolama yetki yÃ¼kseltmesi ile aynÄ±:

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## Ä°stismar SonrasÄ±

{% content-ref url="../az-post-exploitation/az-file-share-post-exploitation.md" %}
[az-file-share-post-exploitation.md](../az-post-exploitation/az-file-share-post-exploitation.md)
{% endcontent-ref %}

## SÃ¼reklilik

Depolama sÃ¼rekliliÄŸi ile aynÄ±:

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek paylaÅŸÄ±n.**

</details>
{% endhint %}
