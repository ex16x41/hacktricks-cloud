# Az - Udostpnianie plik贸w

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Podstawowe informacje

**Azure Files** to w peni zarzdzana usuga przechowywania plik贸w w chmurze, kt贸ra zapewnia wsp贸dzielone przechowywanie plik贸w dostpne za porednictwem standardowych protoko贸w **SMB (Server Message Block)** i **NFS (Network File System)**. Chocia偶 g贸wnym protokoem u偶ywanym jest SMB, udostpnianie plik贸w NFS w Azure nie jest obsugiwane dla system贸w Windows (zgodnie z [**dokumentacj**](https://learn.microsoft.com/en-us/azure/storage/files/files-nfs-protocol)). Umo偶liwia tworzenie wysoko dostpnych wsp贸dzielonych zasob贸w plikowych, kt贸re mog by jednoczenie dostpne przez wiele maszyn wirtualnych (VM) lub system贸w lokalnych, co umo偶liwia bezproblemowe udostpnianie plik贸w w r贸偶nych rodowiskach.

### Poziomy dostpu

* **Optymalizacja transakcji**: Optymalizowane dla operacji intensywnych w transakcje.
* **Gorcy**: Zr贸wnowa偶one midzy transakcjami a przechowywaniem.
* **Chodny**: Ekonomiczne dla przechowywania.
* **Premium:** Wysokowydajne przechowywanie plik贸w zoptymalizowane pod ktem niskiej latencji i obci偶e intensywnych w IOPS.

### Kopie zapasowe

* **Codzienna kopia zapasowa**: Punkt kopii zapasowej jest tworzony ka偶dego dnia o wskazanej porze (np. 19.30 UTC) i przechowywany przez od 1 do 200 dni.
* **Tygodniowa kopia zapasowa**: Punkt kopii zapasowej jest tworzony co tydzie w wskazanym dniu i godzinie (niedziela o 19.30) i przechowywany przez od 1 do 200 tygodni.
* **Miesiczna kopia zapasowa**: Punkt kopii zapasowej jest tworzony co miesic w wskazanym dniu i godzinie (np. pierwsza niedziela o 19.30) i przechowywany przez od 1 do 120 miesicy.
* **Roczna kopia zapasowa**: Punkt kopii zapasowej jest tworzony co roku w wskazanym dniu i godzinie (np. pierwsza niedziela stycznia o 19.30) i przechowywany przez od 1 do 10 lat.
* Mo偶liwe jest r贸wnie偶 wykonanie **rcznych kopii zapasowych i zrzut贸w w dowolnym momencie**. Kopie zapasowe i zrzuty s w rzeczywistoci tym samym w tym kontekcie.

### Obsugiwane uwierzytelnienia przez SMB

* **Uwierzytelnianie AD DS w lokalizacji**: U偶ywa lokalnych powiadcze Active Directory synchronizowanych z Microsoft Entra ID do dostpu opartego na to偶samoci. Wymaga cznoci sieciowej z lokalnym AD DS.
* **Uwierzytelnianie Microsoft Entra Domain Services**: Wykorzystuje Microsoft Entra Domain Services (chmurowy AD) do zapewnienia dostpu przy u偶yciu powiadcze Microsoft Entra.
* **Microsoft Entra Kerberos dla hybrydowych to偶samoci**: Umo偶liwia u偶ytkownikom Microsoft Entra uwierzytelnianie udostpnie plik贸w Azure przez internet przy u偶yciu Kerberos. Obsuguje hybrydowe maszyny wirtualne doczone do Microsoft Entra lub doczone do Microsoft Entra bez wymagania cznoci z lokalnymi kontrolerami domeny. Nie obsuguje jednak to偶samoci wycznie chmurowych.
* **Uwierzytelnianie Kerberos AD dla klient贸w Linux**: Umo偶liwia klientom Linux korzystanie z Kerberos do uwierzytelniania SMB za porednictwem lokalnego AD DS lub Microsoft Entra Domain Services.

## Enumeracja

{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# List file shares
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# Get snapshots/backups
az storage share list --account-name <name> --include-snapshots --query "[?snapshot != null]"
# List contents of a snapshot/backup
az storage file list --account-name <name> --share-name <share-name> --snapshot <snapshot-version> #e.g. "2024-11-25T11:26:59.0000000Z"
# Download snapshot/backup
az storage file download-batch -d . --account-name <name> --source <share-name> --snapshot <snapshot-version>
```
{% endcode %}

{% hint style="info" %}
Domylnie `az` cli u偶yje klucza konta do podpisania klucza i wykonania akcji. Aby u偶y uprawnie g贸wnego u偶ytkownika Entra ID, u偶yj parametr贸w `--auth-mode login --enable-file-backup-request-intent`.
{% endhint %}

{% hint style="success" %}
U偶yj parametru `--account-key`, aby wskaza klucz konta do u偶ycia\
U偶yj parametru `--sas-token` z tokenem SAS, aby uzyska dostp za pomoc tokena SAS
{% endhint %}

### Poczenie

Oto skrypty zaproponowane przez Azure w momencie pisania, aby poczy si z File Share:

Musisz zastpi miejsca `<STORAGE-ACCOUNT>`, `<ACCESS-KEY>` i `<FILE-SHARE-NAME>`.

{% tabs %}
{% tab title="Windows" %}
{% code overflow="wrap" %}
```powershell
$connectTestResult = Test-NetConnection -ComputerName filescontainersrdtfgvhb.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded) {
# Save the password so the drive will persist on reboot
cmd.exe /C "cmdkey /add:`"<STORAGE-ACCOUNT>.file.core.windows.net`" /user:`"localhost\<STORAGE-ACCOUNT>`" /pass:`"<ACCESS-KEY>`""
# Mount the drive
New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<STORAGE-ACCOUNT>.file.core.windows.net\<FILE-SHARE-NAME>" -Persist
} else {
Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
}
```
{% endcode %}
{% endtab %}

{% tab title="Linux" %}
{% code overflow="wrap" %}
```bash
sudo mkdir /mnt/disk-shareeifrube
if [ ! -d "/etc/smbcredentials" ]; then
sudo mkdir /etc/smbcredentials
fi
if [ ! -f "/etc/smbcredentials/<STORAGE-ACCOUNT>.cred" ]; then
sudo bash -c 'echo "username=<STORAGE-ACCOUNT>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
sudo bash -c 'echo "password=<ACCESS-KEY>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
fi
sudo chmod 600 /etc/smbcredentials/<STORAGE-ACCOUNT>.cred

sudo bash -c 'echo "//<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> cifs nofail,credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30" >> /etc/fstab'
sudo mount -t cifs //<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> -o credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30
```
{% endcode %}
{% endtab %}

{% tab title="macOS" %}
{% code overflow="wrap" %}
```bash
open smb://<STORAGE-ACCOUNT>:<ACCESS-KEY>@<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME>
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Regular storage enumeration (access keys, SAS...)

{% content-ref url="az-storage.md" %}
[az-storage.md](az-storage.md)
{% endcontent-ref %}

## Privilege Escalation

Tak samo jak privesc magazynu:

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../az-post-exploitation/az-file-share-post-exploitation.md" %}
[az-file-share-post-exploitation.md](../az-post-exploitation/az-file-share-post-exploitation.md)
{% endcontent-ref %}

## Persistence

Tak samo jak trwao magazynu:

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
