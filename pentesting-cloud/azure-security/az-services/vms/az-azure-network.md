# Az - Azure Network

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

As redes dentro do Azure funcionam como uma parte integral de sua plataforma de computa√ß√£o em nuvem, permitindo a **conex√£o e comunica√ß√£o entre v√°rios servi√ßos e recursos do Azure**. A arquitetura de rede no Azure √© projetada para ser altamente escal√°vel, segura e personaliz√°vel.

No seu n√∫cleo, o Azure fornece uma **rede virtual (VNet)** que permite aos usu√°rios criar **redes isoladas** dentro da nuvem Azure. Dentro dessas VNets, recursos como m√°quinas virtuais, aplicativos e bancos de dados podem ser hospedados e gerenciados com seguran√ßa. A rede no Azure suporta tanto a comunica√ß√£o dentro da nuvem (entre servi√ßos do Azure) quanto a conex√£o com redes externas e a internet.

**Seguran√ßa** √© um aspecto cr√≠tico da rede do Azure, com v√°rias ferramentas e servi√ßos dispon√≠veis para proteger dados, gerenciar acesso e garantir conformidade. Essas medidas de seguran√ßa incluem **firewalls**, **grupos de seguran√ßa de rede** e capacidades de **criptografia**, permitindo um alto n√≠vel de controle sobre o tr√°fego e o acesso.

No geral, as capacidades de rede do Azure s√£o projetadas para oferecer flexibilidade, permitindo que os usu√°rios criem um ambiente de rede que atenda √†s suas necessidades espec√≠ficas de aplica√ß√£o e carga de trabalho, mantendo um forte √™nfase na seguran√ßa e confiabilidade.

## Rede Virtual (VNET) & Sub-redes

Uma VNet no Azure √© essencialmente uma representa√ß√£o da sua pr√≥pria rede na nuvem. √â um **isolamento l√≥gico da nuvem Azure dedicado √† sua assinatura**. Uma VNet permite que voc√™ provisionar e gerenciar redes privadas virtuais (VPNs) no Azure e pode ser usada para hospedar e **gerenciar v√°rios tipos de recursos do Azure**, como M√°quinas Virtuais (VMs), bancos de dados e servi√ßos de aplicativos.

As VNets fornecem a voc√™ **controle total sobre suas configura√ß√µes de rede**, incluindo intervalos de **endere√ßos IP**, cria√ß√£o de sub-redes, tabelas de rotas e gateways de rede.

Uma **sub-rede** √© um **intervalo de endere√ßos IP na sua VNet**. Voc√™ pode dividir uma VNet em v√°rias sub-redes para organiza√ß√£o e seguran√ßa. Cada sub-rede em uma VNet pode ser usada para isolar e agrupar recursos de acordo com sua arquitetura de rede e aplica√ß√£o.

Al√©m disso, as sub-redes permitem que voc√™ **segmente sua VNet em uma ou mais sub-redes**, fornecendo um intervalo de endere√ßos IP que os recursos podem usar.

### **Exemplo**

* Suponha que voc√™ tenha uma VNet chamada `MyVNet` com um intervalo de endere√ßos IP de `10.0.0.0/16`. Voc√™ pode criar uma sub-rede dentro dessa VNet, digamos `Subnet-1`, com um intervalo de endere√ßos IP de `10.0.0.0/24` para hospedar seus servidores web. Outra sub-rede, `Subnet-2` com um intervalo de `10.0.1.0/24`, poderia ser usada para seus servidores de banco de dados. Essa segmenta√ß√£o permite um gerenciamento eficiente e controles de seguran√ßa dentro da rede.

### Enumera√ß√£o

Para listar todas as VNets e sub-redes em uma conta Azure, voc√™ pode usar a Interface de Linha de Comando (CLI) do Azure. Aqui est√£o os passos:

{% code overflow="wrap" %}
```bash
# List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table
```
{% endcode %}

## Network Security Groups (NSG)

No Azure, um **Network Security Group (NSG)** tem a fun√ß√£o principal de filtrar o tr√°fego de rede tanto para os recursos do Azure quanto a partir deles dentro de uma Azure Virtual Network (VNet). Ele cont√©m um conjunto de **regras de seguran√ßa** que ditam meticulosamente o fluxo do tr√°fego de rede.

Aspectos chave do NSG incluem:

* **Controle de Tr√°fego**: Cada NSG cont√©m regras que s√£o instrumentais em permitir ou obstruir o tr√°fego de rede de entrada e sa√≠da associado a v√°rios recursos do Azure.
* **Componentes da Regra**: As regras dentro de um NSG s√£o altamente espec√≠ficas, filtrando o tr√°fego com base em crit√©rios como endere√ßo IP de origem/destino, porta e protocolo. Essa especificidade permite uma gest√£o granular do tr√°fego de rede.
* **Aprimoramento de Seguran√ßa**: Ao garantir que apenas o tr√°fego autorizado possa entrar ou sair dos seus recursos do Azure, os NSGs desempenham um papel crucial no fortalecimento da postura de seguran√ßa da sua infraestrutura de rede.

### **Exemplo**

* Imagine que voc√™ tem um NSG chamado `MyNSG` aplicado a uma sub-rede ou a uma m√°quina virtual espec√≠fica dentro da sua VNet. Voc√™ pode criar regras como:
* Uma regra de entrada permitindo tr√°fego HTTP (porta 80) de qualquer origem para seus servidores web.
* Uma regra de sa√≠da permitindo apenas tr√°fego SQL (porta 1433) para um intervalo espec√≠fico de endere√ßos IP de destino.

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List NSGs
az network nsg list --query "[].{name:name, location:location}" -o table

# Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table
```
{% endcode %}

## Azure Firewall

Azure Firewall √© um **servi√ßo de seguran√ßa de rede gerenciado e baseado em nuvem que protege seus recursos do Azure Virtual Network**. √â um firewall totalmente stateful como servi√ßo com recursos integrados de alta disponibilidade e escalabilidade.

Azure Firewall fornece recursos **mais avan√ßados** do que **NSGs**, incluindo **filtragem em n√≠vel de aplica√ß√£o**, filtragem em n√≠vel de rede, filtragem baseada em intelig√™ncia contra amea√ßas e integra√ß√£o com Azure Monitor para registro e an√°lise.\
Ele pode filtrar tr√°fego de sa√≠da, entrada, spoke-to-spoke, VPN e ExpressRoute. **Regras de firewall podem ser criadas com base em FQDN (Fully Qualified Domain Name), endere√ßos IP e portas**.

### Diferen√ßas entre Azure Firewall e NSGs

1. **Escopo:**
* **NSG:** Funciona no n√≠vel de sub-rede ou interface de rede. Destina-se a fornecer filtragem b√°sica de tr√°fego de entrada e sa√≠da de interfaces de rede (NIC), VMs ou sub-redes.
* **Azure Firewall:** Opera no n√≠vel do VNet, proporcionando um escopo mais amplo de prote√ß√£o. √â projetado para proteger seus recursos de rede virtual e gerenciar o tr√°fego que entra e sai do VNet.
2. **Capacidades:**
* **NSG:** Fornece capacidades b√°sicas de filtragem com base em endere√ßo IP, porta e protocolo. N√£o suporta recursos avan√ßados como inspe√ß√£o em n√≠vel de aplica√ß√£o ou intelig√™ncia contra amea√ßas.
* **Azure Firewall:** Oferece recursos avan√ßados como filtragem de tr√°fego em n√≠vel de aplica√ß√£o (Camada 7), filtragem baseada em intelig√™ncia contra amea√ßas, filtragem de tr√°fego de rede e mais. Tamb√©m suporta m√∫ltiplos endere√ßos IP p√∫blicos.
3. **Casos de Uso:**
* **NSG:** Ideal para filtragem b√°sica de tr√°fego em n√≠vel de rede.
* **Azure Firewall:** Adequado para cen√°rios de filtragem mais complexos onde controle em n√≠vel de aplica√ß√£o, registro e intelig√™ncia contra amea√ßas s√£o necess√°rios.
4. **Gerenciamento e Monitoramento:**
* **NSG:** Oferece registro b√°sico e integra√ß√£o com Azure Monitor.
* **Azure Firewall:** Fornece capacidades avan√ßadas de registro e an√°lise atrav√©s do Azure Monitor, o que √© essencial para entender a natureza e o padr√£o do tr√°fego.

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

# Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table
```
{% endcode %}

## Network Virtual Appliance (NVA)

Um Network Virtual Appliance (**NVA**) no Azure √© um appliance virtual que **executa fun√ß√µes de rede dentro de uma rede virtual**. NVAs s√£o tipicamente usados para fun√ß√µes de rede que **n√£o est√£o dispon√≠veis nativamente** no Azure ou quando √© necess√°ria mais personaliza√ß√£o. Eles s√£o essencialmente **VMs que executam aplicativos ou servi√ßos de rede**, como firewalls, otimizadores de WAN ou balanceadores de carga.

NVAs s√£o usados para tarefas complexas de roteamento, **seguran√ßa** e **gerenciamento de tr√°fego de rede**. Eles podem ser implantados a partir do **Marketplace** do Azure, onde muitos fornecedores terceiros oferecem seus appliances prontos para integra√ß√£o em ambientes Azure.

### **Exemplo**

* Uma organiza√ß√£o pode implantar um NVA no Azure para criar uma **solu√ß√£o de firewall personalizada**. Este NVA poderia executar um **software de firewall de terceiros**, fornecendo recursos avan√ßados como detec√ß√£o de intrus√£o, inspe√ß√£o de pacotes ou conectividade VPN. O NVA pode ser configurado para inspecionar e filtrar o tr√°fego que passa por ele, garantindo que medidas de seguran√ßa aprimoradas estejam em vigor conforme as pol√≠ticas da organiza√ß√£o.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# Usually NVAs are named or tagged in a way to distinguish them from other VMs
az vm list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# For a specific VM identified as an NVA, list its network interfaces
az vm nic list --vm-name <VMName> --resource-group <ResourceGroupName> --query "[].{id:id}" -o table
```
{% endcode %}

## Azure Route Tables & User Defined Routes (UDR)

**Azure Route Tables** s√£o um recurso dentro do Microsoft Azure que permite o **controle do roteamento de tr√°fego de rede dentro das Azure Virtual Networks (VNets)**. Essencialmente, elas definem como os **pacotes** s√£o **encaminhados** entre sub-redes dentro das VNets, entre VNets, ou para redes externas. Cada tabela de rotas cont√©m um conjunto de regras, conhecidas como rotas, que especificam como os pacotes devem ser roteados com base em seus endere√ßos IP de destino.

**User Defined Routes (UDR)** no Azure s√£o **rotas personalizadas que voc√™ cria dentro das Azure Route Tables** para controlar o **fluxo de tr√°fego de rede** dentro e entre as Azure Virtual Networks (VNets), e para conex√µes externas. UDRs d√£o a voc√™ a flexibilidade de direcionar o tr√°fego de rede conforme suas necessidades espec√≠ficas, substituindo as decis√µes de roteamento padr√£o do Azure.

Essas rotas s√£o particularmente √∫teis para cen√°rios onde voc√™ precisa **rotear o tr√°fego atrav√©s de um appliance virtual**, impor um caminho espec√≠fico para conformidade de seguran√ßa ou pol√≠tica, ou integrar com redes on-premises.

### **Exemplo**

* Suponha que voc√™ tenha implantado um Network Virtual Appliance (NVA) para inspecionar o tr√°fego entre sub-redes dentro de uma VNet. Voc√™ pode criar um UDR que direciona todo o tr√°fego de uma sub-rede para outra sub-rede passando pelo NVA. Este UDR garante que o NVA inspecione o tr√°fego para fins de seguran√ßa antes que ele chegue ao seu destino.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List UDRs for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table
```
{% endcode %}

## Azure Private Link

Azure Private Link √© um servi√ßo no Azure que **permite acesso privado a servi√ßos do Azure** garantindo que **o tr√°fego entre sua rede virtual (VNet) do Azure e o servi√ßo viaje inteiramente dentro da rede backbone do Azure da Microsoft**. Ele efetivamente traz o servi√ßo para dentro da sua VNet. Esta configura√ß√£o aumenta a seguran√ßa ao n√£o expor os dados √† internet p√∫blica.

Private Link pode ser usado com v√°rios servi√ßos do Azure, como Azure Storage, Azure SQL Database e servi√ßos personalizados compartilhados via Private Link. Ele fornece uma maneira segura de consumir servi√ßos de dentro da sua pr√≥pria VNet ou at√© mesmo de diferentes assinaturas do Azure.

{% hint style="danger" %}
NSGs n√£o se aplicam a endpoints privados, o que claramente significa que associar um NSG a uma sub-rede que cont√©m o Private Link n√£o ter√° efeito.
{% endhint %}

### **Exemplo**

* Considere um cen√°rio onde voc√™ tem um **Azure SQL Database que deseja acessar de forma segura a partir da sua VNet**. Normalmente, isso pode envolver atravessar a internet p√∫blica. Com o Private Link, voc√™ pode criar um **endpoint privado na sua VNet** que se conecta diretamente ao servi√ßo Azure SQL Database. Este endpoint faz com que o banco de dados pare√ßa como se fosse parte da sua pr√≥pria VNet, acess√≠vel via um endere√ßo IP privado, garantindo assim um acesso seguro e privado.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List Private Link Services
z network private-link-service list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List Private Endpoints
az network private-endpoint list --query "[].{name:name, location:location, resourceGroup:resourceGroup, privateLinkServiceConnections:privateLinkServiceConnections}" -o table
```
{% endcode %}

## Azure Service Endpoints

Azure Service Endpoints estendem o espa√ßo de endere√ßo privado da sua rede virtual e a identidade do seu VNet para servi√ßos Azure atrav√©s de uma conex√£o direta. Ao habilitar endpoints de servi√ßo, **recursos no seu VNet podem se conectar com seguran√ßa aos servi√ßos Azure**, como Azure Storage e Azure SQL Database, usando a rede backbone do Azure. Isso garante que o **tr√°fego do VNet para o servi√ßo Azure permane√ßa dentro da rede Azure**, proporcionando um caminho mais seguro e confi√°vel.

### **Exemplo**

* Por exemplo, uma conta de **Azure Storage** por padr√£o √© acess√≠vel pela internet p√∫blica. Ao habilitar um **endpoint de servi√ßo para Azure Storage dentro do seu VNet**, voc√™ pode garantir que apenas o tr√°fego do seu VNet possa acessar a conta de armazenamento. O firewall da conta de armazenamento pode ent√£o ser configurado para aceitar tr√°fego apenas do seu VNet.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List Virtual Networks with Service Endpoints
az network vnet list --query "[].{name:name, location:location, serviceEndpoints:serviceEndpoints}" -o table

# List Subnets with Service Endpoints
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, serviceEndpoints:serviceEndpoints}" -o table
```
{% endcode %}

### Diferen√ßas Entre Service Endpoints e Private Links

A Microsoft recomenda o uso de Private Links na [**documenta√ß√£o**](https://learn.microsoft.com/en-us/azure/virtual-network/vnet-integration-for-azure-services#compare-private-endpoints-and-service-endpoints):\\

<figure><img src="../../../../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>

**Service Endpoints:**

* O tr√°fego do seu VNet para o servi√ßo Azure viaja pela rede backbone da Microsoft Azure, ignorando a internet p√∫blica.
* O endpoint √© uma conex√£o direta com o servi√ßo Azure e n√£o fornece um IP privado para o servi√ßo dentro do VNet.
* O servi√ßo em si ainda √© acess√≠vel via seu endpoint p√∫blico de fora do seu VNet, a menos que voc√™ configure o firewall do servi√ßo para bloquear tal tr√°fego.
* √â uma rela√ß√£o um-para-um entre a sub-rede e o servi√ßo Azure.
* Menos caro do que Private Links.

**Private Links:**

* Private Link mapeia servi√ßos Azure no seu VNet via um endpoint privado, que √© uma interface de rede com um endere√ßo IP privado dentro do seu VNet.
* O servi√ßo Azure √© acessado usando este endere√ßo IP privado, fazendo parecer que faz parte da sua rede.
* Servi√ßos conectados via Private Link podem ser acessados apenas do seu VNet ou redes conectadas; n√£o h√° acesso √† internet p√∫blica para o servi√ßo.
* Permite uma conex√£o segura com servi√ßos Azure ou seus pr√≥prios servi√ßos hospedados no Azure, bem como uma conex√£o com servi√ßos compartilhados por outros.
* Fornece controle de acesso mais granular via um endpoint privado no seu VNet, em oposi√ß√£o ao controle de acesso mais amplo no n√≠vel da sub-rede com service endpoints.

Em resumo, enquanto ambos Service Endpoints e Private Links fornecem conectividade segura para servi√ßos Azure, **Private Links oferecem um n√≠vel mais alto de isolamento e seguran√ßa ao garantir que os servi√ßos sejam acessados de forma privada sem exp√¥-los √† internet p√∫blica**. Service Endpoints, por outro lado, s√£o mais f√°ceis de configurar para casos gerais onde √© necess√°rio acesso simples e seguro aos servi√ßos Azure sem a necessidade de um IP privado no VNet.

## Azure Front Door (AFD) & AFD WAF

**Azure Front Door** √© um ponto de entrada escal√°vel e seguro para **entrega r√°pida** de suas aplica√ß√µes web globais. Ele **combina** v√°rios servi√ßos como **balanceamento de carga global, acelera√ß√£o de site, descarregamento de SSL e capacidades de Web Application Firewall (WAF)** em um √∫nico servi√ßo. Azure Front Door fornece roteamento inteligente baseado na **localiza√ß√£o de borda mais pr√≥xima do usu√°rio**, garantindo desempenho e confiabilidade √≥timos. Al√©m disso, oferece roteamento baseado em URL, hospedagem de m√∫ltiplos sites, afinidade de sess√£o e seguran√ßa na camada de aplica√ß√£o.

**Azure Front Door WAF** √© projetado para **proteger aplica√ß√µes web contra ataques baseados na web** sem modifica√ß√£o no c√≥digo de back-end. Inclui regras personalizadas e conjuntos de regras gerenciadas para proteger contra amea√ßas como inje√ß√£o de SQL, cross-site scripting e outros ataques comuns.

### **Exemplo**

* Imagine que voc√™ tem uma aplica√ß√£o distribu√≠da globalmente com usu√°rios ao redor do mundo. Voc√™ pode usar Azure Front Door para **rotear solicita√ß√µes de usu√°rios para o data center regional mais pr√≥ximo** que hospeda sua aplica√ß√£o, reduzindo assim a lat√™ncia, melhorando a experi√™ncia do usu√°rio e **defendendo-a de ataques web com as capacidades do WAF**. Se uma determinada regi√£o experimentar tempo de inatividade, Azure Front Door pode automaticamente redirecionar o tr√°fego para a pr√≥xima melhor localiza√ß√£o, garantindo alta disponibilidade.

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List Azure Front Door Instances
az network front-door list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List Front Door WAF Policies
az network front-door waf-policy list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table
```
{% endcode %}

## Azure Application Gateway e Azure Application Gateway WAF

Azure Application Gateway √© um **balanceador de carga de tr√°fego web** que permite gerenciar o tr√°fego para suas **aplica√ß√µes web**. Ele oferece **balanceamento de carga na Camada 7, termina√ß√£o SSL e capacidades de firewall de aplica√ß√£o web (WAF)** no Application Delivery Controller (ADC) como um servi√ßo. As principais caracter√≠sticas incluem roteamento baseado em URL, afinidade de sess√£o baseada em cookies e descarregamento de camada de soquetes seguros (SSL), que s√£o cruciais para aplica√ß√µes que requerem capacidades complexas de balanceamento de carga, como roteamento global e roteamento baseado em caminho.

### Exemplo

* Considere um cen√°rio onde voc√™ tem um site de e-commerce que inclui m√∫ltiplos subdom√≠nios para diferentes fun√ß√µes, como contas de usu√°rio e processamento de pagamentos. Azure Application Gateway pode **rotear o tr√°fego para os servidores web apropriados com base no caminho do URL**. Por exemplo, o tr√°fego para `example.com/accounts` poderia ser direcionado para o servi√ßo de contas de usu√°rio, e o tr√°fego para `example.com/pay` poderia ser direcionado para o servi√ßo de processamento de pagamentos.\
E **proteger seu site contra ataques usando as capacidades do WAF.**

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List the Web Application Firewall configurations for your Application Gateways
az network application-gateway waf-config list --gateway-name <AppGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, firewallMode:firewallMode, ruleSetType:ruleSetType, ruleSetVersion:ruleSetVersion}" -o table
```
{% endcode %}

## Azure Hub, Spoke & VNet Peering

**VNet Peering** √© um recurso de rede no Azure que **permite que diferentes Redes Virtuais (VNets) sejam conectadas diretamente e de forma transparente**. Atrav√©s do VNet peering, recursos em uma VNet podem se comunicar com recursos em outra VNet usando endere√ßos IP privados, **como se estivessem na mesma rede**.\
**O VNet Peering tamb√©m pode ser usado com redes on-prem** configurando uma VPN site-to-site ou Azure ExpressRoute.

**Azure Hub and Spoke** √© uma topologia de rede usada no Azure para gerenciar e organizar o tr√°fego de rede. **O "hub" √© um ponto central que controla e roteia o tr√°fego entre diferentes "spokes"**. O hub normalmente cont√©m servi√ßos compartilhados, como appliances virtuais de rede (NVAs), Azure VPN Gateway, Azure Firewall ou Azure Bastion. Os **"spokes" s√£o VNets que hospedam cargas de trabalho e se conectam ao hub usando VNet peering**, permitindo que aproveitem os servi√ßos compartilhados dentro do hub. Este modelo promove um layout de rede limpo, reduzindo a complexidade ao centralizar servi√ßos comuns que v√°rias cargas de trabalho em diferentes VNets podem usar.

{% hint style="danger" %}
**O VNET pairing n√£o √© transitivo no Azure**, o que significa que se o spoke 1 est√° conectado ao spoke 2 e o spoke 2 est√° conectado ao spoke 3, ent√£o o spoke 1 n√£o pode se comunicar diretamente com o spoke 3.
{% endhint %}

### Exemplos

* Imagine uma empresa com departamentos separados como Vendas, RH e Desenvolvimento, **cada um com sua pr√≥pria VNet (os spokes)**. Essas VNets **necessitam de acesso a recursos compartilhados** como um banco de dados central, um firewall e um gateway de internet, que est√£o todos localizados em **outra VNet (o hub)**. Usando o modelo Hub and Spoke, cada departamento pode **se conectar de forma segura aos recursos compartilhados atrav√©s da VNet do hub sem expor esses recursos √† internet p√∫blica** ou criar uma estrutura de rede complexa com in√∫meras conex√µes.

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List all VNets in your subscription
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List VNet peering connections for a given VNet
az network vnet peering list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, peeringState:peeringState, remoteVnetId:remoteVnetId}" -o table

# List Shared Resources (e.g., Azure Firewall) in the Hub
az network firewall list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table
```
{% endcode %}

## Site-to-Site VPN

Um Site-to-Site VPN no Azure permite que voc√™ **conecte sua rede local √† sua Azure Virtual Network (VNet)**, possibilitando que recursos como VMs dentro do Azure apare√ßam como se estivessem na sua rede local. Esta conex√£o √© estabelecida atrav√©s de um **gateway VPN que criptografa o tr√°fego** entre as duas redes.

### **Exemplo**

* Uma empresa com seu escrit√≥rio principal localizado em Nova York possui um data center local que precisa se conectar de forma segura √† sua VNet no Azure, que hospeda suas cargas de trabalho virtualizadas. Ao configurar um **Site-to-Site VPN, a empresa pode garantir conectividade criptografada entre os servidores locais e as VMs do Azure**, permitindo que os recursos sejam acessados de forma segura em ambos os ambientes como se estivessem na mesma rede local.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List VPN Gateways
az network vnet-gateway list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List VPN Connections
az network vpn-connection list --gateway-name <VpnGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, connectionType:connectionType, connectionStatus:connectionStatus}" -o table
```
{% endcode %}

## Azure ExpressRoute

Azure ExpressRoute √© um servi√ßo que fornece uma **conex√£o privada, dedicada e de alta velocidade entre sua infraestrutura local e os data centers do Azure**. Esta conex√£o √© feita atrav√©s de um provedor de conectividade, contornando a internet p√∫blica e oferecendo mais confiabilidade, velocidades mais r√°pidas, lat√™ncias mais baixas e maior seguran√ßa do que as conex√µes t√≠picas da internet.

### **Exemplo**

* Uma corpora√ß√£o multinacional requer uma **conex√£o consistente e confi√°vel com seus servi√ßos Azure devido ao alto volume de dados** e √† necessidade de alta taxa de transfer√™ncia. A empresa opta pelo Azure ExpressRoute para conectar diretamente seu data center local ao Azure, facilitando transfer√™ncias de dados em grande escala, como backups di√°rios e an√°lises de dados em tempo real, com maior privacidade e velocidade.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List ExpressRoute Circuits
az network express-route list --query "[].{name:name, location:location, resourceGroup:resourceGroup, serviceProviderName:serviceProviderName, peeringLocation:peeringLocation}" -o table
```
{% endcode %}

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
