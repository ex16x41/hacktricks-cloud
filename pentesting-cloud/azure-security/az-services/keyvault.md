# Az - Key Vault

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

[Belgelerden:](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts) Azure Key Vault, **gizli bilgileri güvenli bir şekilde saklamak ve erişmek için** bir bulut hizmetidir. Gizli bilgi, **erişimi sıkı bir şekilde kontrol etmek istediğiniz** her şeydir; örneğin API anahtarları, şifreler, sertifikalar veya kriptografik anahtarlar. Key Vault hizmeti, iki tür konteyneri destekler: kasalar ve yönetilen donanım güvenlik modülü (HSM) havuzları. Kasa, yazılım ve HSM destekli anahtarlar, gizli bilgiler ve sertifikalar saklamayı destekler. Yönetilen HSM havuzları yalnızca HSM destekli anahtarları destekler. Tam detaylar için [Azure Key Vault REST API genel bakışına](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) bakın.

**URL formatı** `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` şeklindedir. Burada:

* `vault-name`, anahtar kasasının küresel olarak **benzersiz** adıdır.
* `object-type`, "keys", "secrets" veya "certificates" olabilir.
* `object-name`, anahtar kasası içindeki nesnenin **benzersiz** adıdır.
* `object-version`, sistem tarafından üretilir ve isteğe bağlı olarak **bir nesnenin benzersiz versiyonuna** erişmek için kullanılır.

Kasada saklanan gizli bilgilere erişmek için 2 izin modeli kullanılabilir:

* **Kasa erişim politikası**
* **Azure RBAC**

### Erişim Kontrolü <a href="#access-control" id="access-control"></a>

Key Vault kaynağına erişim, iki düzlemle kontrol edilir:

* **yönetim düzlemi**, hedefi [management.azure.com](http://management.azure.com/) olan.
* Anahtar kasasını ve **erişim politikalarını** yönetmek için kullanılır. Sadece Azure rol tabanlı erişim kontrolü (**RBAC**) desteklenir.
* **veri düzlemi**, hedefi **`<vault-name>.vault.azure.com`** olan.
* Anahtar kasasındaki **verileri** (anahtarlar, gizli bilgiler ve sertifikalar) yönetmek ve erişmek için kullanılır. Bu, **kasa erişim politikalarını** veya Azure **RBAC**'yi destekler.

Erişim politikalarını yönetmek için yönetim düzleminde izinlere sahip bir **Katkıda Bulunan** rolü, erişim politikalarını değiştirerek gizli bilgilere erişim elde edebilir.

### Key Vault RBAC Yerleşik Rolleri <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

### Ağ Erişimi

Azure Key Vault'ta, **veri düzlemi işlemlerine yalnızca belirli sanal ağlardan veya IPv4 adres aralıklarından izin vermek için** güvenlik duvarı kuralları ayarlanabilir. Bu kısıtlama, Azure yönetim portalı üzerinden erişimi de etkiler; kullanıcılar, giriş IP adresleri yetkilendirilmiş aralıkta değilse bir anahtar kasasındaki anahtarları, gizli bilgileri veya sertifikaları listeleyemezler.

Bu ayarları analiz etmek ve yönetmek için **Azure CLI**'yi kullanabilirsiniz:
```bash
az keyvault show --name name-vault --query networkAcls
```
Önceki komut, `name-vault`**'ın f**irewall ayarlarını**, etkin IP aralıkları ve reddedilen trafik için politikalar dahil olmak üzere görüntüleyecektir.

## Sayım

{% tabs %}
{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> –AsPlainText
```
{% endcode %}
{% endtab %}

{% tab title="az" %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
