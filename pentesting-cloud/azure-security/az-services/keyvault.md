# Az - Key Vault

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Azure Key Vault** je cloud usluga koju pruža Microsoft Azure za sigurno čuvanje i upravljanje osetljivim informacijama kao što su **tajne, ključevi, sertifikati i lozinke**. Deluje kao centralizovani repozitorijum, nudeći siguran pristup i preciznu kontrolu koristeći Azure Active Directory (Azure AD). Sa bezbednosnog aspekta, Key Vault pruža **zaštitu hardverskog sigurnosnog modula (HSM)** za kriptografske ključeve, osigurava da su tajne šifrovane kako u mirovanju, tako i u prenosu, i nudi robusno upravljanje pristupom putem **kontrole pristupa zasnovane na ulogama (RBAC)** i politika. Takođe sadrži **evidenciju revizije**, integraciju sa Azure Monitor za praćenje pristupa, i automatsku rotaciju ključeva kako bi se smanjio rizik od dugotrajne izloženosti ključeva.

Pogledajte [Azure Key Vault REST API overview](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) za potpune detalje.

Prema [**docs**](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts), Vaults podržavaju čuvanje softverskih i HSM-podržanih ključeva, tajni i sertifikata. Upravljani HSM bazeni podržavaju samo HSM-podržane ključeve.

**URL format** za **vaults** je `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` a za upravljane HSM bazene je: `https://{hsm-name}.managedhsm.azure.net/{object-type}/{object-name}/{object-version}`

Gde:

* `vault-name` je globalno **jedinstveno** ime ključnog trezora
* `object-type` može biti "keys", "secrets" ili "certificates"
* `object-name` je **jedinstveno** ime objekta unutar ključnog trezora
* `object-version` je sistemski generisan i opcionalno se koristi za adresiranje **jedinstvene verzije objekta**.

Da bi se pristupilo tajnama pohranjenim u trezoru, moguće je odabrati između 2 modela dozvola prilikom kreiranja trezora:

* **Politika pristupa trezoru**
* **Azure RBAC** (najčešći i preporučen)
* Sve granularne dozvole podržane možete pronaći na [https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/security#microsoftkeyvault](https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/security#microsoftkeyvault)

### Access Control <a href="#access-control" id="access-control"></a>

Pristup resursu Key Vault kontroliše se kroz dva plana:

* **plan upravljanja**, čija je meta [management.azure.com](http://management.azure.com/).
* Koristi se za upravljanje ključnim trezorom i **politikama pristupa**. Samo Azure kontrola pristupa zasnovana na ulogama (**RBAC**) je podržana.
* **plan podataka**, čija je meta **`<vault-name>.vault.azure.com`**.
* Koristi se za upravljanje i pristup **podacima** (ključevi, tajne i sertifikati) **u ključnom trezoru**. Ovo podržava **politike pristupa ključnom trezoru** ili Azure **RBAC**.

Uloga kao što je **Contributor** koja ima dozvole u planu upravljanja za upravljanje politikama pristupa može dobiti pristup tajnama modifikovanjem politika pristupa.

### Key Vault RBAC Built-In Roles <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

### Network Access

U Azure Key Vault, **firewall** pravila mogu se postaviti da **dozvole operacije u planu podataka samo sa određenih virtuelnih mreža ili IPv4 opsega adresa**. Ova ograničenja takođe utiču na pristup putem Azure administrativnog portala; korisnici neće moći da listaju ključeve, tajne ili sertifikate u ključnom trezoru ako njihova IP adresa nije unutar autorizovanog opsega.

Za analizu i upravljanje ovim podešavanjima, možete koristiti **Azure CLI**:
```bash
az keyvault show --name name-vault --query networkAcls
```
Prethodna komanda će prikazati f**irewall podešavanja `name-vault`**, uključujući omogućene IP opsege i politike za odbijeni saobraćaj.

Pored toga, moguće je kreirati **privatni endpoint** kako bi se omogućila privatna konekcija ka vault-u.

### Zaštita od brisanja

Kada se kreira key vault, minimalan broj dana koji se dozvoljava za brisanje je 7. Što znači da kada god pokušate da obrišete taj key vault, biće potrebno **najmanje 7 dana da bude obrisan**.

Međutim, moguće je kreirati vault sa **onemogućenim zaštitom od brisanja** koja omogućava brisanje key vault-a i objekata tokom perioda zadržavanja. Iako, kada se ova zaštita omogući za vault, ne može se onemogućiti.

## Enumeracija

{% tabs %}
{% tab title="az" %}
{% code overflow="wrap" %}
```bash
# List all Key Vaults in the subscription
az keyvault list
# List Key Vaults in a specific Resource Group
az keyvault list --resource-group <ResourceGroupName>
# Show details of a specific Key Vault
az keyvault show --name <KeyVaultName> # If accessPolicies, you can see them here
# List all keys in a Key Vault
az keyvault key list --vault-name <KeyVaultName>
# List all secrets in a Key Vault
az keyvault secret list --vault-name <KeyVaultName>
# Get versions of a secret
az keyvault secret list-versions --vault-name <KeyVaultName> --name <SecretName>
# List all certificates in a Key Vault
az keyvault certificate list --vault-name <KeyVaultName>
# List all deleted Key Vaults in the subscription
az keyvault list-deleted
# Get properties of a deleted Key Vault
az keyvault show-deleted --name <KeyVaultName>
# Get assigned roles
az role assignment list --include-inherited --scope "/subscriptions/<subscription-uuid>/resourceGroups/<resource-group>/providers/Microsoft.KeyVault/vaults/<vault-name>"

# Get secret value
az keyvault secret show --vault-name <KeyVaultName> --name <SecretName>
# Get old versions secret value
az keyvault secret show --id https://<KeyVaultName>.vault.azure.net/secrets/<KeyVaultName>/<idOldVersion>
```
{% endcode %}
{% endtab %}

{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# Get details of a specific Key Vault
Get-AzKeyVault -VaultName <KeyVaultName>
# List all keys in a Key Vault
Get-AzKeyVaultKey -VaultName <KeyVaultName>
# List all secrets in a Key Vault
Get-AzKeyVaultSecret -VaultName <KeyVaultName>
# List all certificates in a Key Vault
Get-AzKeyVaultCertificate -VaultName <KeyVaultName>
# List all deleted Key Vaults in the subscription
Get-AzKeyVault -InRemovedState
# Get properties of a deleted Key Vault
Get-AzKeyVault -VaultName <KeyVaultName> -InRemovedState
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> -AsPlainText
```
{% endcode %}
{% endtab %}

{% tab title="az skripta" %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

## Eskalacija privilegija

{% content-ref url="../az-privilege-escalation/az-key-vault-privesc.md" %}
[az-key-vault-privesc.md](../az-privilege-escalation/az-key-vault-privesc.md)
{% endcontent-ref %}

## Post eksploatacija

{% content-ref url="../az-post-exploitation/az-key-vault-post-exploitation.md" %}
[az-key-vault-post-exploitation.md](../az-post-exploitation/az-key-vault-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
Učite i vežbajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Učite i vežbajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
