# Az - Key Vault

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts) Το Azure Key Vault είναι μια υπηρεσία cloud για **ασφαλή αποθήκευση και πρόσβαση σε μυστικά**. Ένα μυστικό είναι οτιδήποτε θέλετε να **ελέγχετε αυστηρά την πρόσβαση σε**, όπως κλειδιά API, κωδικούς πρόσβασης, πιστοποιητικά ή κρυπτογραφικά κλειδιά. Η υπηρεσία Key Vault υποστηρίζει δύο τύπους κοντέινερ: θησαυρούς και διαχειριζόμενες πιστοποιημένες μονάδες ασφαλείας (HSM). Οι θησαυροί υποστηρίζουν την αποθήκευση λογισμικού και κλειδιών που υποστηρίζονται από HSM, μυστικών και πιστοποιητικών. Οι διαχειριζόμενες πιστοποιημένες μονάδες HSM υποστηρίζουν μόνο κλειδιά που υποστηρίζονται από HSM. Δείτε την [επισκόπηση του Azure Key Vault REST API](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) για πλήρεις λεπτομέρειες.

Η **μορφή URL** είναι `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` Όπου:

* `vault-name` είναι το παγκοσμίως **μοναδικό** όνομα του θησαυρού
* `object-type` μπορεί να είναι "keys", "secrets" ή "certificates"
* `object-name` είναι το **μοναδικό** όνομα του αντικειμένου εντός του θησαυρού
* `object-version` είναι αυτόματα παραγόμενο και χρησιμοποιείται προαιρετικά για να αναφέρεται σε μια **μοναδική έκδοση ενός αντικειμένου**.

Για να αποκτήσετε πρόσβαση στα μυστικά που αποθηκεύονται στον θησαυρό, μπορούν να χρησιμοποιηθούν 2 μοντέλα δικαιωμάτων:

* **Πολιτική πρόσβασης θησαυρού**
* **Azure RBAC**

### Access Control <a href="#access-control" id="access-control"></a>

Η πρόσβαση σε έναν πόρο Key Vault ελέγχεται από δύο επίπεδα:

* Το **επίπεδο διαχείρισης**, του οποίου ο στόχος είναι το [management.azure.com](http://management.azure.com/).
* Χρησιμοποιείται για τη διαχείριση του θησαυρού και των **πολιτικών πρόσβασης**. Υποστηρίζεται μόνο ο έλεγχος πρόσβασης με βάση ρόλους Azure (**RBAC**).
* Το **επίπεδο δεδομένων**, του οποίου ο στόχος είναι **`<vault-name>.vault.azure.com`**.
* Χρησιμοποιείται για τη διαχείριση και την πρόσβαση στα **δεδομένα** (κλειδιά, μυστικά και πιστοποιητικά) **στον θησαυρό**. Αυτό υποστηρίζει **πολιτικές πρόσβασης θησαυρού** ή Azure **RBAC**.

Ένας ρόλος όπως **Contributor** που έχει δικαιώματα στο επίπεδο διαχείρισης για τη διαχείριση πολιτικών πρόσβασης μπορεί να αποκτήσει πρόσβαση στα μυστικά τροποποιώντας τις πολιτικές πρόσβασης.

### Key Vault RBAC Built-In Roles <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

### Network Access

Στο Azure Key Vault, οι κανόνες **firewall** μπορούν να ρυθμιστούν για να **επιτρέπουν τις λειτουργίες του επιπέδου δεδομένων μόνο από καθορισμένα εικονικά δίκτυα ή περιοχές διευθύνσεων IPv4**. Αυτή η περιοριστική πολιτική επηρεάζει επίσης την πρόσβαση μέσω της πύλης διαχείρισης Azure. Οι χρήστες δεν θα μπορούν να καταγράψουν κλειδιά, μυστικά ή πιστοποιητικά σε έναν θησαυρό αν η διεύθυνση IP σύνδεσής τους δεν είναι εντός της εξουσιοδοτημένης περιοχής.

Για την ανάλυση και τη διαχείριση αυτών των ρυθμίσεων, μπορείτε να χρησιμοποιήσετε το **Azure CLI**:
```bash
az keyvault show --name name-vault --query networkAcls
```
Η προηγούμενη εντολή θα εμφανίσει τις ρυθμίσεις του f**irewall του `name-vault`**, συμπεριλαμβανομένων των ενεργοποιημένων εύρους IP και πολιτικών για απορριπτόμενη κίνηση.

## Enumeration

{% tabs %}
{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> –AsPlainText
```
{% endcode %}
{% endtab %}

{% tab title="az" %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
