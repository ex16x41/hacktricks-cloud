# Az - Key Vault

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£:](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts) Azure Key Vault æ˜¯ä¸€ä¸ªç”¨äº**å®‰å…¨å­˜å‚¨å’Œè®¿é—®æœºå¯†**çš„äº‘æœåŠ¡ã€‚æœºå¯†æ˜¯æ‚¨å¸Œæœ›**ä¸¥æ ¼æ§åˆ¶è®¿é—®**çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚ API å¯†é’¥ã€å¯†ç ã€è¯ä¹¦æˆ–åŠ å¯†å¯†é’¥ã€‚Key Vault æœåŠ¡æ”¯æŒä¸¤ç§ç±»å‹çš„å®¹å™¨ï¼šä¿é™©åº“å’Œæ‰˜ç®¡ç¡¬ä»¶å®‰å…¨æ¨¡å—ï¼ˆHSMï¼‰æ± ã€‚ä¿é™©åº“æ”¯æŒå­˜å‚¨è½¯ä»¶å’Œ HSM æ”¯æŒçš„å¯†é’¥ã€æœºå¯†å’Œè¯ä¹¦ã€‚æ‰˜ç®¡ HSM æ± ä»…æ”¯æŒ HSM æ”¯æŒçš„å¯†é’¥ã€‚æœ‰å…³å®Œæ•´è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ [Azure Key Vault REST API æ¦‚è¿°](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates)ã€‚

**URL æ ¼å¼**ä¸º `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` å…¶ä¸­ï¼š

* `vault-name` æ˜¯å¯†é’¥ä¿ç®¡åº“çš„å…¨çƒ**å”¯ä¸€**åç§°
* `object-type` å¯ä»¥æ˜¯ "keys"ã€"secrets" æˆ– "certificates"
* `object-name` æ˜¯å¯†é’¥ä¿ç®¡åº“ä¸­å¯¹è±¡çš„**å”¯ä¸€**åç§°
* `object-version` æ˜¯ç³»ç»Ÿç”Ÿæˆçš„ï¼Œå¯é€‰ç”¨äºæŒ‡å®š**å¯¹è±¡çš„å”¯ä¸€ç‰ˆæœ¬**ã€‚

ä¸ºäº†è®¿é—®å­˜å‚¨åœ¨ä¿é™©åº“ä¸­çš„æœºå¯†ï¼Œå¯ä»¥ä½¿ç”¨ä¸¤ç§æƒé™æ¨¡å‹ï¼š

* **ä¿é™©åº“è®¿é—®ç­–ç•¥**
* **Azure RBAC**

### è®¿é—®æ§åˆ¶ <a href="#access-control" id="access-control"></a>

å¯¹ Key Vault èµ„æºçš„è®¿é—®ç”±ä¸¤ä¸ªå¹³é¢æ§åˆ¶ï¼š

* **ç®¡ç†å¹³é¢**ï¼Œå…¶ç›®æ ‡æ˜¯ [management.azure.com](http://management.azure.com/)ã€‚
* å®ƒç”¨äºç®¡ç†å¯†é’¥ä¿ç®¡åº“å’Œ**è®¿é—®ç­–ç•¥**ã€‚ä»…æ”¯æŒ Azure åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆ**RBAC**ï¼‰ã€‚
* **æ•°æ®å¹³é¢**ï¼Œå…¶ç›®æ ‡æ˜¯ **`<vault-name>.vault.azure.com`**ã€‚
* å®ƒç”¨äºç®¡ç†å’Œè®¿é—®**å¯†é’¥ä¿ç®¡åº“ä¸­çš„æ•°æ®**ï¼ˆå¯†é’¥ã€æœºå¯†å’Œè¯ä¹¦ï¼‰ã€‚è¿™æ”¯æŒ**å¯†é’¥ä¿ç®¡åº“è®¿é—®ç­–ç•¥**æˆ– Azure **RBAC**ã€‚

åƒ**Contributor**è¿™æ ·çš„è§’è‰²åœ¨ç®¡ç†å¹³é¢ä¸­å…·æœ‰ç®¡ç†è®¿é—®ç­–ç•¥çš„æƒé™ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹è®¿é—®ç­–ç•¥æ¥è®¿é—®æœºå¯†ã€‚

### Key Vault RBAC å†…ç½®è§’è‰² <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

### ç½‘ç»œè®¿é—®

åœ¨ Azure Key Vault ä¸­ï¼Œå¯ä»¥è®¾ç½®**é˜²ç«å¢™**è§„åˆ™ï¼Œä»¥**ä»…å…è®¸æ¥è‡ªæŒ‡å®šè™šæ‹Ÿç½‘ç»œæˆ– IPv4 åœ°å€èŒƒå›´çš„æ•°æ®å¹³é¢æ“ä½œ**ã€‚æ­¤é™åˆ¶ä¹Ÿä¼šå½±å“é€šè¿‡ Azure ç®¡ç†é—¨æˆ·çš„è®¿é—®ï¼›å¦‚æœç”¨æˆ·çš„ç™»å½• IP åœ°å€ä¸åœ¨æˆæƒèŒƒå›´å†…ï¼Œåˆ™æ— æ³•åˆ—å‡ºå¯†é’¥ã€æœºå¯†æˆ–è¯ä¹¦ã€‚

è¦åˆ†æå’Œç®¡ç†è¿™äº›è®¾ç½®ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨**Azure CLI**ï¼š
```bash
az keyvault show --name name-vault --query networkAcls
```
è¯¥å‘½ä»¤å°†æ˜¾ç¤º`name-vault`çš„**é˜²ç«å¢™è®¾ç½®**ï¼ŒåŒ…æ‹¬å¯ç”¨çš„IPèŒƒå›´å’Œæ‹’ç»æµé‡çš„ç­–ç•¥ã€‚

## æšä¸¾

{% tabs %}
{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> â€“AsPlainText
```
{% endcode %}
{% endtab %}

{% tab title="az" %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
