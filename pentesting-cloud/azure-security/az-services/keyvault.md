# Az - Key Vault

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£:](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts) Azure Key Vault æ˜¯ä¸€ä¸ªç”¨äº**å®‰å…¨å­˜å‚¨å’Œè®¿é—®æœºå¯†**çš„äº‘æœåŠ¡ã€‚æœºå¯†æ˜¯æ‚¨å¸Œæœ›**ä¸¥æ ¼æ§åˆ¶è®¿é—®**çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚ API å¯†é’¥ã€å¯†ç ã€è¯ä¹¦æˆ–åŠ å¯†å¯†é’¥ã€‚Key Vault æœåŠ¡æ”¯æŒä¸¤ç§ç±»å‹çš„å®¹å™¨ï¼švaults å’Œ managed hardware security module(HSM) poolsã€‚Vaults æ”¯æŒå­˜å‚¨è½¯ä»¶å’Œ HSM æ”¯æŒçš„å¯†é’¥ã€æœºå¯†å’Œè¯ä¹¦ã€‚Managed HSM pools ä»…æ”¯æŒ HSM æ”¯æŒçš„å¯†é’¥ã€‚æœ‰å…³å®Œæ•´è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [Azure Key Vault REST API æ¦‚è¿°](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates)ã€‚

**URL æ ¼å¼**ä¸º `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` å…¶ä¸­ï¼š

* `vault-name` æ˜¯ key vault çš„å…¨å±€**å”¯ä¸€**åç§°
* `object-type` å¯ä»¥æ˜¯ "keys", "secrets" æˆ– "certificates"
* `object-name` æ˜¯ key vault ä¸­å¯¹è±¡çš„**å”¯ä¸€**åç§°
* `object-version` æ˜¯ç³»ç»Ÿç”Ÿæˆçš„ï¼Œå¯é€‰ç”¨äºæŒ‡å®šå¯¹è±¡çš„**å”¯ä¸€ç‰ˆæœ¬**ã€‚

ä¸ºäº†è®¿é—®å­˜å‚¨åœ¨ vault ä¸­çš„æœºå¯†ï¼Œå¯ä»¥ä½¿ç”¨ä¸¤ç§æƒé™æ¨¡å‹ï¼š

* **Vault access policy**
* **Azure RBAC**

### è®¿é—®æ§åˆ¶ <a href="#access-control" id="access-control"></a>

å¯¹ Key Vault èµ„æºçš„è®¿é—®ç”±ä¸¤ä¸ªå¹³é¢æ§åˆ¶ï¼š

* **ç®¡ç†å¹³é¢**ï¼Œå…¶ç›®æ ‡æ˜¯ [management.azure.com](http://management.azure.com/)ã€‚
* ç”¨äºç®¡ç† key vault å’Œ**è®¿é—®ç­–ç•¥**ã€‚ä»…æ”¯æŒ Azure åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆ**RBAC**ï¼‰ã€‚
* **æ•°æ®å¹³é¢**ï¼Œå…¶ç›®æ ‡æ˜¯ **`<vault-name>.vault.azure.com`**ã€‚
* ç”¨äºç®¡ç†å’Œè®¿é—® key vault ä¸­çš„**æ•°æ®**ï¼ˆå¯†é’¥ã€æœºå¯†å’Œè¯ä¹¦ï¼‰ã€‚è¿™æ”¯æŒ**key vault è®¿é—®ç­–ç•¥**æˆ– Azure **RBAC**ã€‚

åƒ **Contributor** è¿™æ ·çš„è§’è‰²åœ¨ç®¡ç†å¹³é¢ä¸Šæœ‰æƒé™ç®¡ç†è®¿é—®ç­–ç•¥ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹è®¿é—®ç­–ç•¥æ¥è·å–æœºå¯†çš„è®¿é—®æƒé™ã€‚

### Key Vault RBAC å†…ç½®è§’è‰² <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

### ç½‘ç»œè®¿é—®

åœ¨ Azure Key Vault ä¸­ï¼Œå¯ä»¥è®¾ç½®**é˜²ç«å¢™**è§„åˆ™ä»¥**ä»…å…è®¸æ¥è‡ªæŒ‡å®šè™šæ‹Ÿç½‘ç»œæˆ– IPv4 åœ°å€èŒƒå›´çš„æ•°æ®å¹³é¢æ“ä½œ**ã€‚æ­¤é™åˆ¶ä¹Ÿä¼šå½±å“é€šè¿‡ Azure ç®¡ç†é—¨æˆ·çš„è®¿é—®ï¼›å¦‚æœç”¨æˆ·çš„ç™»å½• IP åœ°å€ä¸åœ¨æˆæƒèŒƒå›´å†…ï¼Œä»–ä»¬å°†æ— æ³•åˆ—å‡º key vault ä¸­çš„å¯†é’¥ã€æœºå¯†æˆ–è¯ä¹¦ã€‚

è¦åˆ†æå’Œç®¡ç†è¿™äº›è®¾ç½®ï¼Œå¯ä»¥ä½¿ç”¨ **Azure CLI**:
```bash
az keyvault show --name name-vault --query networkAcls
```
å‰é¢çš„å‘½ä»¤å°†æ˜¾ç¤º `name-vault` çš„é˜²ç«å¢™è®¾ç½®ï¼ŒåŒ…æ‹¬å¯ç”¨çš„ IP èŒƒå›´å’Œæ‹’ç»æµé‡çš„ç­–ç•¥ã€‚

## æšä¸¾

{% tabs %}
{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> â€“AsPlainText
```
{% endcode %}
{% endtab %}

{% tab title="az" %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
