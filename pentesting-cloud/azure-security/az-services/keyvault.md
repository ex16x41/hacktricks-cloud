# Az - Key Vault

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

**Azure Key Vault** æ˜¯å¾®è½¯ Azure æä¾›çš„äº‘æœåŠ¡ï¼Œç”¨äºå®‰å…¨å­˜å‚¨å’Œç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ **æœºå¯†ã€å¯†é’¥ã€è¯ä¹¦å’Œå¯†ç **ã€‚å®ƒå……å½“ä¸€ä¸ªé›†ä¸­å¼å­˜å‚¨åº“ï¼Œæä¾›å®‰å…¨è®¿é—®å’Œç»†ç²’åº¦æ§åˆ¶ï¼Œä½¿ç”¨ Azure Active Directory (Azure AD)ã€‚ä»å®‰å…¨çš„è§’åº¦æ¥çœ‹ï¼ŒKey Vault ä¸ºåŠ å¯†å¯†é’¥æä¾› **ç¡¬ä»¶å®‰å…¨æ¨¡å— (HSM) ä¿æŠ¤**ï¼Œç¡®ä¿æœºå¯†åœ¨é™æ€å’Œä¼ è¾“è¿‡ç¨‹ä¸­å‡è¢«åŠ å¯†ï¼Œå¹¶é€šè¿‡ **åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC)** å’Œç­–ç•¥æä¾›å¼ºå¤§çš„è®¿é—®ç®¡ç†ã€‚å®ƒè¿˜å…·æœ‰ **å®¡è®¡æ—¥å¿—**ã€ä¸ Azure Monitor é›†æˆä»¥è·Ÿè¸ªè®¿é—®ï¼Œä»¥åŠè‡ªåŠ¨å¯†é’¥è½®æ¢ä»¥å‡å°‘é•¿æœŸå¯†é’¥æš´éœ²çš„é£é™©ã€‚

æœ‰å…³å®Œæ•´ç»†èŠ‚ï¼Œè¯·å‚è§ [Azure Key Vault REST API æ¦‚è¿°](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates)ã€‚

æ ¹æ® [**æ–‡æ¡£**](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts)ï¼ŒVault æ”¯æŒå­˜å‚¨è½¯ä»¶å’Œ HSM æ”¯æŒçš„å¯†é’¥ã€æœºå¯†å’Œè¯ä¹¦ã€‚æ‰˜ç®¡ HSM æ± ä»…æ”¯æŒ HSM æ”¯æŒçš„å¯†é’¥ã€‚

**Vaults** çš„ **URL æ ¼å¼** ä¸º `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}`ï¼Œè€Œæ‰˜ç®¡ HSM æ± çš„æ ¼å¼ä¸ºï¼š`https://{hsm-name}.managedhsm.azure.net/{object-type}/{object-name}/{object-version}`

å…¶ä¸­ï¼š

* `vault-name` æ˜¯å¯†é’¥ä¿ç®¡åº“çš„å…¨çƒ **å”¯ä¸€** åç§°
* `object-type` å¯ä»¥æ˜¯ "keys"ã€"secrets" æˆ– "certificates"
* `object-name` æ˜¯å¯†é’¥ä¿ç®¡åº“å†…å¯¹è±¡çš„ **å”¯ä¸€** åç§°
* `object-version` æ˜¯ç³»ç»Ÿç”Ÿæˆçš„ï¼Œå¯é€‰ç”¨äºæŒ‡å®š **å¯¹è±¡çš„å”¯ä¸€ç‰ˆæœ¬**ã€‚

ä¸ºäº†è®¿é—®å­˜å‚¨åœ¨ä¿ç®¡åº“ä¸­çš„æœºå¯†ï¼Œåœ¨åˆ›å»ºä¿ç®¡åº“æ—¶å¯ä»¥é€‰æ‹©ä¸¤ç§æƒé™æ¨¡å‹ï¼š

* **ä¿ç®¡åº“è®¿é—®ç­–ç•¥**
* **Azure RBAC**ï¼ˆæœ€å¸¸è§å’Œæ¨èï¼‰
* æ‚¨å¯ä»¥åœ¨ [https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/security#microsoftkeyvault](https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/security#microsoftkeyvault) æ‰¾åˆ°æ‰€æœ‰æ”¯æŒçš„ç»†ç²’åº¦æƒé™ã€‚

### è®¿é—®æ§åˆ¶ <a href="#access-control" id="access-control"></a>

å¯¹ Key Vault èµ„æºçš„è®¿é—®ç”±ä¸¤ä¸ªå¹³é¢æ§åˆ¶ï¼š

* **ç®¡ç†å¹³é¢**ï¼Œå…¶ç›®æ ‡æ˜¯ [management.azure.com](http://management.azure.com/)ã€‚
* ç”¨äºç®¡ç†å¯†é’¥ä¿ç®¡åº“å’Œ **è®¿é—®ç­–ç•¥**ã€‚ä»…æ”¯æŒ Azure åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (**RBAC**)ã€‚
* **æ•°æ®å¹³é¢**ï¼Œå…¶ç›®æ ‡æ˜¯ **`<vault-name>.vault.azure.com`**ã€‚
* ç”¨äºç®¡ç†å’Œè®¿é—® **å¯†é’¥ä¿ç®¡åº“ä¸­çš„æ•°æ®**ï¼ˆå¯†é’¥ã€æœºå¯†å’Œè¯ä¹¦ï¼‰ã€‚è¿™æ”¯æŒ **å¯†é’¥ä¿ç®¡åº“è®¿é—®ç­–ç•¥** æˆ– Azure **RBAC**ã€‚

åƒ **Contributor** è¿™æ ·çš„è§’è‰²åœ¨ç®¡ç†å¹³é¢ä¸­å…·æœ‰ç®¡ç†è®¿é—®ç­–ç•¥çš„æƒé™ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹è®¿é—®ç­–ç•¥æ¥è®¿é—®æœºå¯†ã€‚

### Key Vault RBAC å†…ç½®è§’è‰² <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

### ç½‘ç»œè®¿é—®

åœ¨ Azure Key Vault ä¸­ï¼Œå¯ä»¥è®¾ç½® **é˜²ç«å¢™** è§„åˆ™ï¼Œä»¥ **ä»…å…è®¸æ¥è‡ªæŒ‡å®šè™šæ‹Ÿç½‘ç»œæˆ– IPv4 åœ°å€èŒƒå›´çš„æ•°æ®å¹³é¢æ“ä½œ**ã€‚æ­¤é™åˆ¶ä¹Ÿä¼šå½±å“é€šè¿‡ Azure ç®¡ç†é—¨æˆ·çš„è®¿é—®ï¼›å¦‚æœç”¨æˆ·çš„ç™»å½• IP åœ°å€ä¸åœ¨æˆæƒèŒƒå›´å†…ï¼Œåˆ™æ— æ³•åˆ—å‡ºå¯†é’¥ã€æœºå¯†æˆ–è¯ä¹¦ã€‚

è¦åˆ†æå’Œç®¡ç†è¿™äº›è®¾ç½®ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ **Azure CLI**ï¼š
```bash
az keyvault show --name name-vault --query networkAcls
```
The previous command will display the f**irewall settings of `name-vault`**, including enabled IP ranges and policies for denied traffic.

æ­¤å¤–ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª **ç§æœ‰ç«¯ç‚¹** ä»¥å…è®¸ä¸ä¿ç®¡åº“çš„ç§æœ‰è¿æ¥ã€‚

### åˆ é™¤ä¿æŠ¤

å½“åˆ›å»ºä¸€ä¸ªå¯†é’¥ä¿ç®¡åº“æ—¶ï¼Œå…è®¸åˆ é™¤çš„æœ€å°å¤©æ•°ä¸º 7ã€‚è¿™æ„å‘³ç€æ¯å½“æ‚¨å°è¯•åˆ é™¤è¯¥å¯†é’¥ä¿ç®¡åº“æ—¶ï¼Œå®ƒéœ€è¦ **è‡³å°‘ 7 å¤©æ‰èƒ½è¢«åˆ é™¤**ã€‚

ç„¶è€Œï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª **ç¦ç”¨æ¸…é™¤ä¿æŠ¤** çš„ä¿ç®¡åº“ï¼Œè¿™å…è®¸åœ¨ä¿ç•™æœŸå†…æ¸…é™¤å¯†é’¥ä¿ç®¡åº“å’Œå¯¹è±¡ã€‚å°½ç®¡ä¸€æ—¦ä¸ºä¿ç®¡åº“å¯ç”¨æ­¤ä¿æŠ¤ï¼Œå°±æ— æ³•ç¦ç”¨ã€‚

## æšä¸¾

{% tabs %}
{% tab title="az" %}
{% code overflow="wrap" %}
```bash
# List all Key Vaults in the subscription
az keyvault list
# List Key Vaults in a specific Resource Group
az keyvault list --resource-group <ResourceGroupName>
# Show details of a specific Key Vault
az keyvault show --name <KeyVaultName> # If accessPolicies, you can see them here
# List all keys in a Key Vault
az keyvault key list --vault-name <KeyVaultName>
# List all secrets in a Key Vault
az keyvault secret list --vault-name <KeyVaultName>
# Get versions of a secret
az keyvault secret list-versions --vault-name <KeyVaultName> --name <SecretName>
# List all certificates in a Key Vault
az keyvault certificate list --vault-name <KeyVaultName>
# List all deleted Key Vaults in the subscription
az keyvault list-deleted
# Get properties of a deleted Key Vault
az keyvault show-deleted --name <KeyVaultName>
# Get assigned roles
az role assignment list --include-inherited --scope "/subscriptions/<subscription-uuid>/resourceGroups/<resource-group>/providers/Microsoft.KeyVault/vaults/<vault-name>"

# Get secret value
az keyvault secret show --vault-name <KeyVaultName> --name <SecretName>
# Get old versions secret value
az keyvault secret show --id https://<KeyVaultName>.vault.azure.net/secrets/<KeyVaultName>/<idOldVersion>
```
{% endcode %}
{% endtab %}

{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# Get details of a specific Key Vault
Get-AzKeyVault -VaultName <KeyVaultName>
# List all keys in a Key Vault
Get-AzKeyVaultKey -VaultName <KeyVaultName>
# List all secrets in a Key Vault
Get-AzKeyVaultSecret -VaultName <KeyVaultName>
# List all certificates in a Key Vault
Get-AzKeyVaultCertificate -VaultName <KeyVaultName>
# List all deleted Key Vaults in the subscription
Get-AzKeyVault -InRemovedState
# Get properties of a deleted Key Vault
Get-AzKeyVault -VaultName <KeyVaultName> -InRemovedState
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> -AsPlainText
```
{% endcode %}
{% endtab %}

{% tab title="az è„šæœ¬" %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

## æƒé™æå‡

{% content-ref url="../az-privilege-escalation/az-key-vault-privesc.md" %}
[az-key-vault-privesc.md](../az-privilege-escalation/az-key-vault-privesc.md)
{% endcontent-ref %}

## åˆ©ç”¨å

{% content-ref url="../az-post-exploitation/az-key-vault-post-exploitation.md" %}
[az-key-vault-post-exploitation.md](../az-post-exploitation/az-key-vault-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
