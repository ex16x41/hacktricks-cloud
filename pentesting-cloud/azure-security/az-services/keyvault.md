# Az - Key Vault

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts) Azure Key Vault ni huduma ya wingu kwa **hifadhi salama na ufikiaji wa siri**. Siri ni chochote ambacho unataka **kudhibiti kwa karibu ufikiaji wake**, kama funguo za API, nywila, vyeti, au funguo za kificho. Huduma ya Key Vault inasaidia aina mbili za vyombo: vaults na pools za usalama wa vifaa vilivyodhibitiwa (HSM). Vaults zinasaidia kuhifadhi funguo za programu na funguo za HSM. Pools za HSM zinazodhibitiwa zinasaidia tu funguo za HSM. Tazama [Muhtasari wa Azure Key Vault REST API](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) kwa maelezo kamili.

**Muundo wa URL** ni `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` Ambapo:

* `vault-name` ni jina la kipekee **duniani** la vault ya funguo
* `object-type` inaweza kuwa "funguo", "siri" au "vyeti"
* `object-name` ni jina la kipekee la kitu ndani ya vault ya funguo
* `object-version` inatengenezwa na mfumo na inaweza kutumika kwa hiari kuashiria **toleo la kipekee la kitu**.

Ili kupata ufikiaji wa siri zilizohifadhiwa katika vault, mifano miwili ya ruhusa inaweza kutumika:

* **Sera ya ufikiaji wa vault**
* **Azure RBAC**

### Access Control <a href="#access-control" id="access-control"></a>

Ufikiaji wa rasilimali ya Key Vault unadhibitiwa na ndege mbili:

* **ndege ya usimamizi**, ambayo lengo lake ni [management.azure.com](http://management.azure.com/).
* Inatumika kusimamia vault ya funguo na **sera za ufikiaji**. Ni Azure role based access control (**RBAC**) pekee inayoungwa mkono.
* **ndege ya data**, ambayo lengo lake ni **`<vault-name>.vault.azure.com`**.
* Inatumika kusimamia na kupata **data** (funguo, siri na vyeti) **katika vault ya funguo**. Hii inasaidia **sera za ufikiaji wa vault** au Azure **RBAC**.

Jukumu kama **Mchangiaji** ambalo lina ruhusa katika eneo la usimamizi kusimamia sera za ufikiaji linaweza kupata ufikiaji wa siri kwa kubadilisha sera za ufikiaji.

### Key Vault RBAC Built-In Roles <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

### Network Access

Katika Azure Key Vault, **sheria za moto** zinaweza kuwekwa ili **kuruhusu operesheni za ndege ya data tu kutoka mitandao halisi au anwani za IPv4 zilizotajwa**. Kikomo hiki pia kinaathiri ufikiaji kupitia lango la usimamizi la Azure; watumiaji hawataweza kuorodhesha funguo, siri, au vyeti katika vault ya funguo ikiwa anwani yao ya IP ya kuingia haiko ndani ya anuwai iliyoidhinishwa.

Kwa kuchambua na kusimamia mipangilio hii, unaweza kutumia **Azure CLI**:
```bash
az keyvault show --name name-vault --query networkAcls
```
Amri ya awali itaonyesha mipangilio ya f**irewall ya `name-vault`**, ikiwa ni pamoja na anuwai za IP zilizowekwa na sera za trafiki iliyokataliwa.

## Uhesabu

{% tabs %}
{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> ‚ÄìAsPlainText
```
{% endcode %}
{% endtab %}

{% tab title="az" %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuatilie** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za hacking kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
