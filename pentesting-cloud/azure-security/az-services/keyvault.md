# Az - Key Vault

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Azure Key Vault** es un servicio en la nube proporcionado por Microsoft Azure para almacenar y gestionar de forma segura informaci칩n sensible como **secretos, claves, certificados y contrase침as**. Act칰a como un repositorio centralizado, ofreciendo acceso seguro y control detallado utilizando Azure Active Directory (Azure AD). Desde una perspectiva de seguridad, Key Vault proporciona **protecci칩n de m칩dulo de seguridad de hardware (HSM)** para claves criptogr치ficas, asegura que los secretos est칠n cifrados tanto en reposo como en tr치nsito, y ofrece una gesti칩n de acceso robusta a trav칠s de **control de acceso basado en roles (RBAC)** y pol칤ticas. Tambi칠n cuenta con **registro de auditor칤a**, integraci칩n con Azure Monitor para rastrear el acceso, y rotaci칩n autom치tica de claves para reducir el riesgo de exposici칩n prolongada de claves.

Consulta [Azure Key Vault REST API overview](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) para obtener detalles completos.

Seg칰n la [**documentaci칩n**](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts), los Vaults admiten el almacenamiento de claves, secretos y certificados respaldados por HSM. Los grupos de HSM administrados solo admiten claves respaldadas por HSM.

El **formato de URL** para **vaults** es `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` y para grupos de HSM administrados es: `https://{hsm-name}.managedhsm.azure.net/{object-type}/{object-name}/{object-version}`

Donde:

* `vault-name` es el nombre **칰nico** global del key vault
* `object-type` puede ser "keys", "secrets" o "certificates"
* `object-name` es el nombre **칰nico** del objeto dentro del key vault
* `object-version` es generado por el sistema y se utiliza opcionalmente para dirigirse a una **versi칩n 칰nica de un objeto**.

Para acceder a los secretos almacenados en el vault, es posible seleccionar entre 2 modelos de permisos al crear el vault:

* **Pol칤tica de acceso al vault**
* **Azure RBAC** (el m치s com칰n y recomendado)
* Puedes encontrar todos los permisos granulares admitidos en [https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/security#microsoftkeyvault](https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/security#microsoftkeyvault)

### Access Control <a href="#access-control" id="access-control"></a>

El acceso a un recurso de Key Vault se controla mediante dos planos:

* El **plano de gesti칩n**, cuyo objetivo es [management.azure.com](http://management.azure.com/).
* Se utiliza para gestionar el key vault y las **pol칤ticas de acceso**. Solo se admite el control de acceso basado en roles de Azure (**RBAC**).
* El **plano de datos**, cuyo objetivo es **`<vault-name>.vault.azure.com`**.
* Se utiliza para gestionar y acceder a los **datos** (claves, secretos y certificados) **en el key vault**. Esto admite **pol칤ticas de acceso al vault** o Azure **RBAC**.

Un rol como **Contributor** que tiene permisos en el plano de gesti칩n para gestionar pol칤ticas de acceso puede acceder a los secretos modificando las pol칤ticas de acceso.

### Key Vault RBAC Built-In Roles <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

### Network Access

En Azure Key Vault, se pueden establecer reglas de **firewall** para **permitir operaciones del plano de datos solo desde redes virtuales o rangos de direcciones IPv4 especificados**. Esta restricci칩n tambi칠n afecta el acceso a trav칠s del portal de administraci칩n de Azure; los usuarios no podr치n listar claves, secretos o certificados en un key vault si su direcci칩n IP de inicio de sesi칩n no est치 dentro del rango autorizado.

Para analizar y gestionar estas configuraciones, puedes usar el **Azure CLI**:
```bash
az keyvault show --name name-vault --query networkAcls
```
El comando anterior mostrar치 la configuraci칩n del **firewall de `name-vault`**, incluyendo rangos de IP habilitados y pol칤ticas para el tr치fico denegado.

Adem치s, es posible crear un **punto final privado** para permitir una conexi칩n privada a un vault.

### Protecci칩n contra Eliminaci칩n

Cuando se crea un key vault, el n칰mero m칤nimo de d칤as para permitir la eliminaci칩n es 7. Lo que significa que cada vez que intentes eliminar ese key vault, necesitar치 **al menos 7 d칤as para ser eliminado**.

Sin embargo, es posible crear un vault con **protecci칩n contra purga deshabilitada**, lo que permite que el key vault y los objetos sean purgados durante el per칤odo de retenci칩n. Aunque, una vez que esta protecci칩n est치 habilitada para un vault, no se puede deshabilitar.

## Enumeraci칩n

{% tabs %}
{% tab title="az" %}
{% code overflow="wrap" %}
```bash
# List all Key Vaults in the subscription
az keyvault list
# List Key Vaults in a specific Resource Group
az keyvault list --resource-group <ResourceGroupName>
# Show details of a specific Key Vault
az keyvault show --name <KeyVaultName> # If accessPolicies, you can see them here
# List all keys in a Key Vault
az keyvault key list --vault-name <KeyVaultName>
# List all secrets in a Key Vault
az keyvault secret list --vault-name <KeyVaultName>
# Get versions of a secret
az keyvault secret list-versions --vault-name <KeyVaultName> --name <SecretName>
# List all certificates in a Key Vault
az keyvault certificate list --vault-name <KeyVaultName>
# List all deleted Key Vaults in the subscription
az keyvault list-deleted
# Get properties of a deleted Key Vault
az keyvault show-deleted --name <KeyVaultName>
# Get assigned roles
az role assignment list --include-inherited --scope "/subscriptions/<subscription-uuid>/resourceGroups/<resource-group>/providers/Microsoft.KeyVault/vaults/<vault-name>"

# Get secret value
az keyvault secret show --vault-name <KeyVaultName> --name <SecretName>
# Get old versions secret value
az keyvault secret show --id https://<KeyVaultName>.vault.azure.net/secrets/<KeyVaultName>/<idOldVersion>
```
{% endcode %}
{% endtab %}

{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# Get details of a specific Key Vault
Get-AzKeyVault -VaultName <KeyVaultName>
# List all keys in a Key Vault
Get-AzKeyVaultKey -VaultName <KeyVaultName>
# List all secrets in a Key Vault
Get-AzKeyVaultSecret -VaultName <KeyVaultName>
# List all certificates in a Key Vault
Get-AzKeyVaultCertificate -VaultName <KeyVaultName>
# List all deleted Key Vaults in the subscription
Get-AzKeyVault -InRemovedState
# Get properties of a deleted Key Vault
Get-AzKeyVault -VaultName <KeyVaultName> -InRemovedState
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> -AsPlainText
```
{% endcode %}
{% endtab %}

{% tab title="az script" %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

## Escalaci칩n de Privilegios

{% content-ref url="../az-privilege-escalation/az-key-vault-privesc.md" %}
[az-key-vault-privesc.md](../az-privilege-escalation/az-key-vault-privesc.md)
{% endcontent-ref %}

## Post Explotaci칩n

{% content-ref url="../az-post-exploitation/az-key-vault-post-exploitation.md" %}
[az-key-vault-post-exploitation.md](../az-post-exploitation/az-key-vault-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
