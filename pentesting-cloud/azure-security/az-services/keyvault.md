# Az - Key Vault

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Azure Key Vault** to usuga chmurowa oferowana przez Microsoft Azure do bezpiecznego przechowywania i zarzdzania wra偶liwymi informacjami, takimi jak **sekrety, klucze, certyfikaty i hasa**. Dziaa jako scentralizowane repozytorium, oferujc bezpieczny dostp i precyzyjn kontrol za pomoc Azure Active Directory (Azure AD). Z perspektywy bezpieczestwa, Key Vault zapewnia **ochron moduu bezpieczestwa sprztowego (HSM)** dla kluczy kryptograficznych, zapewnia, 偶e sekrety s szyfrowane zar贸wno w spoczynku, jak i w tranzycie, oraz oferuje solidne zarzdzanie dostpem poprzez **kontrol dostpu opart na rolach (RBAC)** i polityki. Oferuje r贸wnie偶 **logi audytowe**, integracj z Azure Monitor do ledzenia dostpu oraz automatyczn rotacj kluczy w celu zmniejszenia ryzyka zwizanego z dugotrwaym nara偶eniem kluczy.

Zobacz [Azure Key Vault REST API overview](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) po pene szczeg贸y.

Zgodnie z [**dokumentacj**](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts), Skarbce wspieraj przechowywanie kluczy oprogramowania i kluczy wspieranych przez HSM, sekret贸w i certyfikat贸w. Zarzdzane pule HSM wspieraj tylko klucze wspierane przez HSM.

**Format URL** dla **skarbc贸w** to `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}`, a dla zarzdzanych pul HSM to: `https://{hsm-name}.managedhsm.azure.net/{object-type}/{object-name}/{object-version}`

Gdzie:

* `vault-name` to globalnie **unikalna** nazwa skarbca
* `object-type` mo偶e by "keys", "secrets" lub "certificates"
* `object-name` to **unikalna** nazwa obiektu w obrbie skarbca
* `object-version` jest generowane przez system i opcjonalnie u偶ywane do adresowania **unikalnej wersji obiektu**.

Aby uzyska dostp do sekret贸w przechowywanych w skarbcu, mo偶na wybra midzy 2 modelami uprawnie podczas tworzenia skarbca:

* **Polityka dostpu do skarbca**
* **Azure RBAC** (najczciej stosowane i zalecane)
* Mo偶esz znale藕 wszystkie szczeg贸owe uprawnienia wspierane w [https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/security#microsoftkeyvault](https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/security#microsoftkeyvault)

### Access Control <a href="#access-control" id="access-control"></a>

Dostp do zasobu Key Vault jest kontrolowany przez dwa paszczyzny:

* **paszczyzna zarzdzania**, kt贸rej celem jest [management.azure.com](http://management.azure.com/).
* U偶ywana jest do zarzdzania skarbcem i **politykami dostpu**. Wspierana jest tylko kontrola dostpu oparta na rolach Azure (**RBAC**).
* **paszczyzna danych**, kt贸rej celem jest **`<vault-name>.vault.azure.com`**.
* U偶ywana jest do zarzdzania i dostpu do **danych** (kluczy, sekret贸w i certyfikat贸w) **w skarbcu**. Wspiera to **polityki dostpu do skarbca** lub Azure **RBAC**.

Rola taka jak **Contributor**, kt贸ra ma uprawnienia w paszczy藕nie zarzdzania do zarzdzania politykami dostpu, mo偶e uzyska dostp do sekret贸w, modyfikujc polityki dostpu.

### Key Vault RBAC Built-In Roles <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

### Network Access

W Azure Key Vault mo偶na ustawi zasady **zapory**, aby **zezwoli na operacje w paszczy藕nie danych tylko z okrelonych sieci wirtualnych lub zakres贸w adres贸w IPv4**. To ograniczenie wpywa r贸wnie偶 na dostp przez portal administracyjny Azure; u偶ytkownicy nie bd mogli wywietla kluczy, sekret贸w ani certyfikat贸w w skarbcu, jeli ich adres IP logowania nie znajduje si w autoryzowanym zakresie.

Aby analizowa i zarzdza tymi ustawieniami, mo偶esz u偶y **Azure CLI**:
```bash
az keyvault show --name name-vault --query networkAcls
```
Poprzednie polecenie wywietli **ustawienia zapory `name-vault`**, w tym wczone zakresy IP i zasady dotyczce zablokowanego ruchu.

Co wicej, mo偶liwe jest utworzenie **prywatnego punktu kocowego**, aby umo偶liwi prywatne poczenie z sejfem.

### Ochrona przed usuniciem

Gdy sejf kluczy jest tworzony, minimalna liczba dni do zezwolenia na usunicie wynosi 7. Oznacza to, 偶e za ka偶dym razem, gdy spr贸bujesz usun ten sejf kluczy, bdzie potrzebne **co najmniej 7 dni na jego usunicie**.

Jednak mo偶liwe jest utworzenie sejfu z **wyczon ochron przed usuniciem**, co pozwala na usunicie sejfu kluczy i obiekt贸w w trakcie okresu przechowywania. Chocia偶, gdy ta ochrona jest wczona dla sejfu, nie mo偶na jej wyczy.

## Enumeracja

{% tabs %}
{% tab title="az" %}
{% code overflow="wrap" %}
```bash
# List all Key Vaults in the subscription
az keyvault list
# List Key Vaults in a specific Resource Group
az keyvault list --resource-group <ResourceGroupName>
# Show details of a specific Key Vault
az keyvault show --name <KeyVaultName> # If accessPolicies, you can see them here
# List all keys in a Key Vault
az keyvault key list --vault-name <KeyVaultName>
# List all secrets in a Key Vault
az keyvault secret list --vault-name <KeyVaultName>
# Get versions of a secret
az keyvault secret list-versions --vault-name <KeyVaultName> --name <SecretName>
# List all certificates in a Key Vault
az keyvault certificate list --vault-name <KeyVaultName>
# List all deleted Key Vaults in the subscription
az keyvault list-deleted
# Get properties of a deleted Key Vault
az keyvault show-deleted --name <KeyVaultName>
# Get assigned roles
az role assignment list --include-inherited --scope "/subscriptions/<subscription-uuid>/resourceGroups/<resource-group>/providers/Microsoft.KeyVault/vaults/<vault-name>"

# Get secret value
az keyvault secret show --vault-name <KeyVaultName> --name <SecretName>
# Get old versions secret value
az keyvault secret show --id https://<KeyVaultName>.vault.azure.net/secrets/<KeyVaultName>/<idOldVersion>
```
{% endcode %}
{% endtab %}

{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# Get details of a specific Key Vault
Get-AzKeyVault -VaultName <KeyVaultName>
# List all keys in a Key Vault
Get-AzKeyVaultKey -VaultName <KeyVaultName>
# List all secrets in a Key Vault
Get-AzKeyVaultSecret -VaultName <KeyVaultName>
# List all certificates in a Key Vault
Get-AzKeyVaultCertificate -VaultName <KeyVaultName>
# List all deleted Key Vaults in the subscription
Get-AzKeyVault -InRemovedState
# Get properties of a deleted Key Vault
Get-AzKeyVault -VaultName <KeyVaultName> -InRemovedState
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> -AsPlainText
```
{% endcode %}
{% endtab %}

{% tab title="az skrypt" %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

## Eskalacja Uprawnie

{% content-ref url="../az-privilege-escalation/az-key-vault-privesc.md" %}
[az-key-vault-privesc.md](../az-privilege-escalation/az-key-vault-privesc.md)
{% endcontent-ref %}

## Po Eksploatacji

{% content-ref url="../az-post-exploitation/az-key-vault-post-exploitation.md" %}
[az-key-vault-post-exploitation.md](../az-post-exploitation/az-key-vault-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
