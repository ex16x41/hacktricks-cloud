# Az - Storage

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

Azure å­˜å‚¨å¸æˆ·æ˜¯ Microsoft Azure ä¸­çš„åŸºæœ¬æœåŠ¡ï¼Œæä¾›å¯æ‰©å±•ã€å®‰å…¨å’Œé«˜å¯ç”¨çš„äº‘ **å­˜å‚¨å„ç§æ•°æ®ç±»å‹**ï¼ŒåŒ…æ‹¬ Blobï¼ˆå¤§äºŒè¿›åˆ¶å¯¹è±¡ï¼‰ã€æ–‡ä»¶ã€é˜Ÿåˆ—å’Œè¡¨ã€‚å®ƒä»¬ä½œä¸ºå®¹å™¨ï¼Œå°†è¿™äº›ä¸åŒçš„å­˜å‚¨æœåŠ¡ç»„åˆåœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸‹ï¼Œä¾¿äºç®¡ç†ã€‚

**ä¸»è¦é…ç½®é€‰é¡¹**ï¼š

* æ¯ä¸ªå­˜å‚¨å¸æˆ·å¿…é¡»åœ¨æ‰€æœ‰ Azure ä¸­å…·æœ‰ **å”¯ä¸€åç§°**ã€‚
* æ¯ä¸ªå­˜å‚¨å¸æˆ·éƒ¨ç½²åœ¨ **åŒºåŸŸ** æˆ– Azure æ‰©å±•åŒºä¸­ã€‚
* å¯ä»¥é€‰æ‹©å­˜å‚¨å¸æˆ·çš„ **é«˜çº§** ç‰ˆæœ¬ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚
* å¯ä»¥é€‰æ‹© **4 ç§å†—ä½™ç±»å‹ä»¥ä¿æŠ¤** å…å—æœºæ¶ã€é©±åŠ¨å™¨å’Œæ•°æ®ä¸­å¿ƒ **æ•…éšœ**ã€‚

**å®‰å…¨é…ç½®é€‰é¡¹**ï¼š

* **è¦æ±‚ REST API æ“ä½œçš„å®‰å…¨ä¼ è¾“**ï¼šè¦æ±‚åœ¨ä¸å­˜å‚¨çš„ä»»ä½•é€šä¿¡ä¸­ä½¿ç”¨ TLSã€‚
* **å…è®¸åœ¨å•ä¸ªå®¹å™¨ä¸Šå¯ç”¨åŒ¿åè®¿é—®**ï¼šå¦‚æœä¸å…è®¸ï¼Œå°†æ¥å°†æ— æ³•å¯ç”¨åŒ¿åè®¿é—®ã€‚
* **å¯ç”¨å­˜å‚¨å¸æˆ·å¯†é’¥è®¿é—®**ï¼šå¦‚æœä¸å…è®¸ï¼Œå°†ç¦æ­¢ä½¿ç”¨å…±äº«å¯†é’¥è®¿é—®ã€‚
* **æœ€ä½ TLS ç‰ˆæœ¬**ã€‚
* **å¤åˆ¶æ“ä½œçš„å…è®¸èŒƒå›´**ï¼šå…è®¸æ¥è‡ªä»»ä½•å­˜å‚¨å¸æˆ·ã€æ¥è‡ªåŒä¸€ Entra ç§Ÿæˆ·çš„ä»»ä½•å­˜å‚¨å¸æˆ·æˆ–æ¥è‡ªåŒä¸€è™šæ‹Ÿç½‘ç»œä¸­å…·æœ‰ç§æœ‰ç«¯ç‚¹çš„å­˜å‚¨å¸æˆ·ã€‚

**Blob å­˜å‚¨é€‰é¡¹**ï¼š

* **å…è®¸è·¨ç§Ÿæˆ·å¤åˆ¶**ã€‚
* **è®¿é—®å±‚**ï¼šçƒ­ï¼ˆé¢‘ç¹è®¿é—®æ•°æ®ï¼‰ã€å†·å’Œå†·ï¼ˆå¾ˆå°‘è®¿é—®çš„æ•°æ®ï¼‰ã€‚

**ç½‘ç»œé€‰é¡¹**ï¼š

* **ç½‘ç»œè®¿é—®**ï¼š
* å…è®¸æ¥è‡ªæ‰€æœ‰ç½‘ç»œã€‚
* å…è®¸æ¥è‡ªé€‰å®šçš„è™šæ‹Ÿç½‘ç»œå’Œ IP åœ°å€ã€‚
* ç¦ç”¨å…¬å…±è®¿é—®å¹¶ä½¿ç”¨ç§æœ‰è®¿é—®ã€‚
* **ç§æœ‰ç«¯ç‚¹**ï¼šå…è®¸ä»è™šæ‹Ÿç½‘ç»œåˆ°å­˜å‚¨å¸æˆ·çš„ç§æœ‰è¿æ¥ã€‚

**æ•°æ®ä¿æŠ¤é€‰é¡¹**ï¼š

* **å®¹å™¨çš„æ—¶é—´ç‚¹æ¢å¤**ï¼šå…è®¸å°†å®¹å™¨æ¢å¤åˆ°æ—©æœŸçŠ¶æ€ã€‚
* éœ€è¦å¯ç”¨ç‰ˆæœ¬æ§åˆ¶ã€å˜æ›´è·Ÿè¸ªå’Œ Blob è½¯åˆ é™¤ã€‚
* **å¯ç”¨ Blob çš„è½¯åˆ é™¤**ï¼šä¸ºå·²åˆ é™¤çš„ Blobï¼ˆå³ä½¿è¢«è¦†ç›–ï¼‰å¯ç”¨ä¿ç•™æœŸï¼ˆå¤©æ•°ï¼‰ã€‚
* **å¯ç”¨å®¹å™¨çš„è½¯åˆ é™¤**ï¼šä¸ºå·²åˆ é™¤çš„å®¹å™¨å¯ç”¨ä¿ç•™æœŸï¼ˆå¤©æ•°ï¼‰ã€‚
* **å¯ç”¨æ–‡ä»¶å…±äº«çš„è½¯åˆ é™¤**ï¼šä¸ºå·²åˆ é™¤çš„æ–‡ä»¶å…±äº«å¯ç”¨ä¿ç•™æœŸï¼ˆå¤©æ•°ï¼‰ã€‚
* **å¯ç”¨ Blob çš„ç‰ˆæœ¬æ§åˆ¶**ï¼šç»´æŠ¤ Blob çš„å…ˆå‰ç‰ˆæœ¬ã€‚
* **å¯ç”¨ Blob å˜æ›´è·Ÿè¸ª**ï¼šè®°å½•å¯¹ Blob çš„åˆ›å»ºã€ä¿®æ”¹å’Œåˆ é™¤æ›´æ”¹çš„æ—¥å¿—ã€‚
* **å¯ç”¨ç‰ˆæœ¬çº§ä¸å¯å˜æ€§æ”¯æŒ**ï¼šå…è®¸æ‚¨åœ¨å¸æˆ·çº§åˆ«è®¾ç½®åŸºäºæ—¶é—´çš„ä¿ç•™ç­–ç•¥ï¼Œè¯¥ç­–ç•¥å°†é€‚ç”¨äºæ‰€æœ‰ Blob ç‰ˆæœ¬ã€‚
* ç‰ˆæœ¬çº§ä¸å¯å˜æ€§æ”¯æŒå’Œå®¹å™¨çš„æ—¶é—´ç‚¹æ¢å¤ä¸èƒ½åŒæ—¶å¯ç”¨ã€‚

**åŠ å¯†é…ç½®é€‰é¡¹**ï¼š

* **åŠ å¯†ç±»å‹**ï¼šå¯ä»¥ä½¿ç”¨ Microsoft ç®¡ç†çš„å¯†é’¥ï¼ˆMMKï¼‰æˆ–å®¢æˆ·ç®¡ç†çš„å¯†é’¥ï¼ˆCMKï¼‰ã€‚
* **å¯ç”¨åŸºç¡€è®¾æ–½åŠ å¯†**ï¼šå…è®¸å¯¹æ•°æ®è¿›è¡ŒåŒé‡åŠ å¯†ä»¥â€œæé«˜å®‰å…¨æ€§â€ã€‚

### å­˜å‚¨ç«¯ç‚¹

<table data-header-hidden><thead><tr><th width="197">å­˜å‚¨æœåŠ¡</th><th>ç«¯ç‚¹</th></tr></thead><tbody><tr><td><strong>Blob å­˜å‚¨</strong></td><td><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></td></tr><tr><td><strong>æ•°æ®æ¹–å­˜å‚¨</strong></td><td><code>https://&#x3C;storage-account>.dfs.core.windows.net</code></td></tr><tr><td><strong>Azure æ–‡ä»¶</strong></td><td><code>https://&#x3C;storage-account>.file.core.windows.net</code></td></tr><tr><td><strong>é˜Ÿåˆ—å­˜å‚¨</strong></td><td><code>https://&#x3C;storage-account>.queue.core.windows.net</code></td></tr><tr><td><strong>è¡¨å­˜å‚¨</strong></td><td><code>https://&#x3C;storage-account>.table.core.windows.net</code></td></tr></tbody></table>

### å…¬å¼€æš´éœ²

å¦‚æœâ€œå…è®¸ Blob å…¬å…±è®¿é—®â€ **å·²å¯ç”¨**ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰ï¼Œåœ¨åˆ›å»ºå®¹å™¨æ—¶å¯ä»¥ï¼š

* ç»™äºˆ **å…¬å…±è®¿é—®ä»¥è¯»å– Blob**ï¼ˆéœ€è¦çŸ¥é“åç§°ï¼‰ã€‚
* **åˆ—å‡ºå®¹å™¨ Blob** å¹¶ **è¯»å–** å®ƒä»¬ã€‚
* ä½¿å…¶å®Œå…¨ **ç§æœ‰**ã€‚

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

### è¿æ¥åˆ°å­˜å‚¨

å¦‚æœæ‚¨æ‰¾åˆ°ä»»ä½•å¯ä»¥è¿æ¥çš„ **å­˜å‚¨**ï¼Œå¯ä»¥ä½¿ç”¨å·¥å…· [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) æ¥è¿æ¥ã€‚

## è®¿é—®å­˜å‚¨ <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

å¯ä»¥ä½¿ç”¨ Entra ID ä¸»ä½“ä¸ **RBAC è§’è‰²** è®¿é—®å­˜å‚¨å¸æˆ·ï¼Œè¿™æ˜¯æ¨èçš„æ–¹å¼ã€‚

### è®¿é—®å¯†é’¥

å­˜å‚¨å¸æˆ·å…·æœ‰å¯ä»¥ç”¨äºè®¿é—®çš„è®¿é—®å¯†é’¥ã€‚è¿™æä¾›äº†å¯¹å­˜å‚¨å¸æˆ·çš„ **å®Œå…¨è®¿é—®**ã€‚

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### **å…±äº«å¯†é’¥å’Œè½»é‡çº§å…±äº«å¯†é’¥**

å¯ä»¥ [**ç”Ÿæˆå…±äº«å¯†é’¥**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key)ï¼Œä½¿ç”¨è®¿é—®å¯†é’¥ç­¾åä»¥é€šè¿‡ç­¾å URL æˆæƒè®¿é—®æŸäº›èµ„æºã€‚

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œ`CanonicalizedResource` éƒ¨åˆ†è¡¨ç¤ºå­˜å‚¨æœåŠ¡èµ„æºï¼ˆURIï¼‰ã€‚å¦‚æœ URL ä¸­çš„ä»»ä½•éƒ¨åˆ†è¢«ç¼–ç ï¼Œåˆ™å®ƒä¹Ÿåº”åœ¨ `CanonicalizedResource` ä¸­ç¼–ç ã€‚
{% endhint %}

{% hint style="info" %}
è¿™ **æ˜¯ `az` cli é»˜è®¤ä½¿ç”¨çš„** è¿›è¡Œè¯·æ±‚èº«ä»½éªŒè¯çš„æ–¹å¼ã€‚è¦ä½¿å…¶ä½¿ç”¨ Entra ID ä¸»ä½“å‡­æ®ï¼Œè¯·æŒ‡ç¤ºå‚æ•° `--auth-mode login`ã€‚
{% endhint %}

* å¯ä»¥ç”Ÿæˆ **Blobã€é˜Ÿåˆ—å’Œæ–‡ä»¶æœåŠ¡çš„å…±äº«å¯†é’¥**ï¼Œç­¾åä»¥ä¸‹ä¿¡æ¯ï¼š
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* å¯ä»¥é€šè¿‡ç­¾ç½²ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆ **è¡¨æœåŠ¡çš„å…±äº«å¯†é’¥**ï¼š
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
* å¯ä»¥ç”Ÿæˆä¸€ä¸ª **è½»é‡çº§å…±äº«å¯†é’¥ï¼Œç”¨äº blobã€é˜Ÿåˆ—å’Œæ–‡ä»¶æœåŠ¡**ï¼Œé€šè¿‡ç­¾ç½²ä»¥ä¸‹ä¿¡æ¯ï¼š
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* å¯ä»¥é€šè¿‡ç­¾ç½²ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆ **è¡¨æœåŠ¡çš„è½»é‡å…±äº«å¯†é’¥**ï¼š
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
ç„¶åï¼Œè¦ä½¿ç”¨å¯†é’¥ï¼Œå¯ä»¥åœ¨æˆæƒå¤´ä¸­æŒ‰ç…§ä»¥ä¸‹è¯­æ³•è¿›è¡Œæ“ä½œï¼š
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **å…±äº«è®¿é—®ç­¾å** (SAS)

å…±äº«è®¿é—®ç­¾å (SAS) æ˜¯å®‰å…¨çš„ã€æ—¶é—´é™åˆ¶çš„ URLï¼Œ**æˆäºˆç‰¹å®šæƒé™ä»¥è®¿é—®** Azure å­˜å‚¨å¸æˆ·ä¸­çš„èµ„æºï¼Œè€Œä¸æš´éœ²å¸æˆ·çš„è®¿é—®å¯†é’¥ã€‚è™½ç„¶è®¿é—®å¯†é’¥æä¾›å¯¹æ‰€æœ‰èµ„æºçš„å®Œå…¨ç®¡ç†è®¿é—®ï¼Œä½† SAS é€šè¿‡æŒ‡å®šæƒé™ï¼ˆå¦‚è¯»å–æˆ–å†™å…¥ï¼‰å’Œå®šä¹‰è¿‡æœŸæ—¶é—´æ¥å®ç°ç»†ç²’åº¦æ§åˆ¶ã€‚

#### SAS ç±»å‹

* **ç”¨æˆ·å§”æ‰˜ SAS**ï¼šè¿™æ˜¯ä» **Entra ID ä¸»ä½“** åˆ›å»ºçš„ï¼Œå®ƒå°†ç­¾ç½² SAS å¹¶å°†æƒé™ä»ç”¨æˆ·å§”æ‰˜ç»™ SASã€‚å®ƒåªèƒ½ä¸ **Blob å’Œæ•°æ®æ¹–å­˜å‚¨** ä¸€èµ·ä½¿ç”¨ ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas))ã€‚å¯ä»¥**æ’¤é”€**æ‰€æœ‰ç”Ÿæˆçš„ç”¨æˆ·å§”æ‰˜ SASã€‚
* å³ä½¿å¯ä»¥ç”Ÿæˆå…·æœ‰â€œæ›´å¤šâ€æƒé™çš„å§”æ‰˜ SASï¼Œä½†å¦‚æœä¸»ä½“æ²¡æœ‰è¿™äº›æƒé™ï¼Œå®ƒå°†æ— æ³•å·¥ä½œï¼ˆæ²¡æœ‰æƒé™æå‡ï¼‰ã€‚
* **æœåŠ¡ SAS**ï¼šè¿™æ˜¯ä½¿ç”¨å­˜å‚¨å¸æˆ·çš„ **è®¿é—®å¯†é’¥** ç­¾ç½²çš„ã€‚å®ƒå¯ä»¥ç”¨äºæˆäºˆå¯¹å•ä¸ªå­˜å‚¨æœåŠ¡ä¸­ç‰¹å®šèµ„æºçš„è®¿é—®ã€‚å¦‚æœå¯†é’¥è¢«æ›´æ–°ï¼ŒSAS å°†åœæ­¢å·¥ä½œã€‚
* **å¸æˆ· SAS**ï¼šå®ƒä¹Ÿæ˜¯ä½¿ç”¨å­˜å‚¨å¸æˆ·çš„ **è®¿é—®å¯†é’¥** ç­¾ç½²çš„ã€‚å®ƒæˆäºˆå¯¹å­˜å‚¨å¸æˆ·æœåŠ¡ï¼ˆBlobã€é˜Ÿåˆ—ã€è¡¨ã€æ–‡ä»¶ï¼‰ä¸­çš„èµ„æºçš„è®¿é—®ï¼Œå¹¶å¯ä»¥åŒ…æ‹¬æœåŠ¡çº§æ“ä½œã€‚

ç”± **è®¿é—®å¯†é’¥** ç­¾ç½²çš„ SAS URL çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

* `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

ä½œä¸º **ç”¨æˆ·å§”æ‰˜** ç­¾ç½²çš„ SAS URL çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

* `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

æ³¨æ„ä¸€äº› **http å‚æ•°**ï¼š

* **`se`** å‚æ•°è¡¨ç¤º SAS çš„ **è¿‡æœŸæ—¥æœŸ**
* **`sp`** å‚æ•°è¡¨ç¤º SAS çš„ **æƒé™**
* **`sig`** æ˜¯éªŒè¯ SAS çš„ **ç­¾å**

#### SAS æƒé™

ç”Ÿæˆ SAS æ—¶ï¼Œéœ€è¦æŒ‡æ˜å®ƒåº”æˆäºˆçš„æƒé™ã€‚æ ¹æ®ç”Ÿæˆ SAS çš„å¯¹è±¡ï¼Œå¯èƒ½ä¼šåŒ…å«ä¸åŒçš„æƒé™ã€‚ä¾‹å¦‚ï¼š

* (a)dd, (c)reate, (d)elete, (e)xecute, (f)ilter\_by\_tags, (i)set\_immutability\_policy, (l)ist, (m)ove, (r)ead, (t)ag, (w)rite, (x)delete\_previous\_version, (y)permanent\_delete

## æšä¸¾

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# TABLES
az storage table list --account-name <name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

### æ–‡ä»¶å…±äº«

{% content-ref url="az-file-shares.md" %}
[az-file-shares.md](az-file-shares.md)
{% endcontent-ref %}

## æƒé™æå‡

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## åˆ©ç”¨å

{% content-ref url="../az-post-exploitation/az-blob-storage-post-exploitation.md" %}
[az-blob-storage-post-exploitation.md](../az-post-exploitation/az-blob-storage-post-exploitation.md)
{% endcontent-ref %}

## æŒä¹…æ€§

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
