# Az - Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Azure Storage Accounts ni huduma muhimu katika Microsoft Azure zinazotoa **hifadhi ya wingu inayoweza kupanuka, salama, na inayopatikana sana kwa aina mbalimbali za data**, ikiwa ni pamoja na blobs (vitu vikubwa vya binary), faili, foleni, na meza. Zinatumika kama vyombo vinavyounganisha huduma hizi tofauti za hifadhi chini ya jina moja kwa usimamizi rahisi.

**Mchoro wa msingi wa usanidi**:

* Kila akaunti ya hifadhi lazima iwe na **jina la kipekee katika Azure yote**.
* Kila akaunti ya hifadhi inapelekwa katika **eneo** au katika eneo la kupanua la Azure
* Inawezekana kuchagua toleo la **premium** la akaunti ya hifadhi kwa utendaji bora
* Inawezekana kuchagua kati ya **aina 4 za upungufu wa hatari ili kulinda** dhidi ya kushindwa kwa rack, diski na kituo cha data **.

**Mchoro wa usanidi wa usalama**:

* **Hitaji usafirishaji salama kwa shughuli za REST API**: Hitaji TLS katika mawasiliano yoyote na hifadhi
* **Inaruhusu kuwezesha ufikiaji wa siri kwenye vyombo vya kibinafsi**: Ikiwa sivyo, haitakuwa na uwezo wa kuwezesha ufikiaji wa siri katika siku zijazo
* **Washa ufikiaji wa funguo za akaunti ya hifadhi**: Ikiwa sivyo, ufikiaji wa Funguo za Kushiriki utafungiwa
* **Tofauti ya chini ya TLS**
* **Muktadha unaoruhusiwa kwa shughuli za nakala**: Ruhusu kutoka kwa akaunti yoyote ya hifadhi, kutoka kwa akaunti yoyote ya hifadhi kutoka kwa mpangilio sawa wa Entra au kutoka kwa akaunti ya hifadhi yenye ncha za kibinafsi katika mtandao huo wa virtual.

**Chaguo za Hifadhi za Blob**:

* **Ruhusu upatanishi wa mpangilio tofauti**
* **Kiwango cha ufikiaji**: Moto (data inayofikiwa mara kwa mara), Baridi na Baridi (data inayofikiwa mara chache)

**Chaguo za Mtandao**:

* **Ufikiaji wa Mtandao**:
* Ruhusu kutoka mitandao yote
* Ruhusu kutoka mitandao maalum ya virtual na anwani za IP
* Zima ufikiaji wa umma na tumia ufikiaji wa kibinafsi
* **Ncha za kibinafsi**: Inaruhusu muunganisho wa kibinafsi kwa akaunti ya hifadhi kutoka mtandao wa virtual

**Chaguo za Ulinzi wa Data**:

* **Kurejesha wakati wa pointi kwa vyombo**: Inaruhusu kurejesha vyombo katika hali ya awali
* Inahitaji toleo, mabadiliko ya chakula, na kufutwa kwa blob kuwawezesha.
* **Washa kufutwa kwa blob**: Inaruhusu kipindi cha uhifadhi kwa siku kwa blobs zilizofutwa (hata zilizofutwa)
* **Washa kufutwa kwa vyombo**: Inaruhusu kipindi cha uhifadhi kwa siku kwa vyombo vilivyofutwa
* **Washa kufutwa kwa sehemu za faili**: Inaruhusu kipindi cha uhifadhi kwa siku kwa sehemu za faili zilizofutwa
* **Washa toleo kwa blobs**: Hifadhi toleo za awali za blobs zako
* **Washa mabadiliko ya blob**: Hifadhi kumbukumbu za kuunda, kubadilisha, na kufuta mabadiliko kwa blobs
* **Washa msaada wa kutokuweza kubadilika kwa kiwango cha toleo**: Inaruhusu kuweka sera ya uhifadhi kulingana na muda kwenye kiwango cha akaunti ambayo itatumika kwa toleo zote za blob.
* Msaada wa kutokuweza kubadilika kwa kiwango cha toleo na kurejesha wakati wa pointi kwa vyombo haiwezi kuwezeshwa kwa wakati mmoja.

**Chaguo za Usimbaji**:

* **Aina ya usimbaji**: Inawezekana kutumia funguo zinazodhibitiwa na Microsoft (MMK) au funguo zinazodhibitiwa na Mteja (CMK)
* **Washa usimbaji wa miundombinu**: Inaruhusu kusimbwa mara mbili kwa data "kwa usalama zaidi"

### Ncha za Hifadhi

<table data-header-hidden><thead><tr><th width="197">Huduma ya Hifadhi</th><th>Ncha</th></tr></thead><tbody><tr><td><strong>Hifadhi ya Blob</strong></td><td><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></td></tr><tr><td><strong>Hifadhi ya Ziwa la Data</strong></td><td><code>https://&#x3C;storage-account>.dfs.core.windows.net</code></td></tr><tr><td><strong>Faili za Azure</strong></td><td><code>https://&#x3C;storage-account>.file.core.windows.net</code></td></tr><tr><td><strong>Hifadhi ya Foleni</strong></td><td><code>https://&#x3C;storage-account>.queue.core.windows.net</code></td></tr><tr><td><strong>Hifadhi ya Meza</strong></td><td><code>https://&#x3C;storage-account>.table.core.windows.net</code></td></tr></tbody></table>

### Ufunuo wa Umma

Ikiwa "Ruhusu ufikiaji wa umma wa Blob" ime **wezeshwa** (imezimwa kwa default), wakati wa kuunda chombo inawezekana:

* Kutoa **ufikiaji wa umma kusoma blobs** (unahitaji kujua jina).
* **Orodhesha blobs za chombo** na **zisome**.
* Kufanya iwe **binafsi kabisa**

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

### Kuungana na Hifadhi

Ikiwa unapata **hifadhi** yoyote unayoweza kuungana nayo unaweza kutumia chombo [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) kufanya hivyo.

## Ufikiaji wa Hifadhi <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

Inawezekana kutumia wahusika wa Entra ID na **majukumu ya RBAC** kufikia akaunti za hifadhi na ni njia inayopendekezwa.

### Funguo za Ufikiaji

Akaunti za hifadhi zina funguo za ufikiaji ambazo zinaweza kutumika kuziunganisha. Hii inatoa **ufikiaji kamili kwa akaunti ya hifadhi.**

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### **Funguo za Kushiriki & Funguo za Kushiriki za Lite**

Inawezekana [**kuunda Funguo za Kushiriki**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key) zilizotiwa saini na funguo za ufikiaji ili kuidhinisha ufikiaji wa rasilimali fulani kupitia URL iliyotiwa saini.

{% hint style="info" %}
Note that the `CanonicalizedResource` part represents the storage services resource (URI). And if any part in the URL is encoded, it should also be encoded inside the `CanonicalizedResource`.
{% endhint %}

{% hint style="info" %}
This is **used by default by `az` cli** to authenticate requests. To make it use the Entra ID principal credentials indicate the param `--auth-mode login`.
{% endhint %}

* Inawezekana kuunda **funguo za kushiriki kwa huduma za blob, foleni na faili** kwa kusaini taarifa zifuatazo:
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* Inawezekana kuunda **funguo ya pamoja kwa huduma za meza** kwa kusaini taarifa zifuatazo:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
* Inawezekana kuunda **lite shared key kwa huduma za blob, queue na file** kwa kusaini taarifa zifuatazo:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* Inawezekana kuunda **lite shared key for table services** kwa kusaini taarifa zifuatazo:
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
Kisha, ili kutumia funguo, inaweza kufanywa katika kichwa cha Uidhinishaji ikifuatana na sintaksia:
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **Shared Access Signature** (SAS)

Shared Access Signatures (SAS) ni URL salama, zenye muda wa kikomo ambazo **zinatoa ruhusa maalum za kufikia rasilimali** katika akaunti ya Azure Storage bila kufichua funguo za ufikiaji za akaunti. Wakati funguo za ufikiaji zinatoa ufikiaji kamili wa kiutawala kwa rasilimali zote, SAS inaruhusu udhibiti wa kina kwa kubainisha ruhusa (kama kusoma au kuandika) na kufafanua muda wa kumalizika.

#### Aina za SAS

* **User delegation SAS**: Hii inaundwa kutoka kwa **Entra ID principal** ambayo itatia saini SAS na kuhamasisha ruhusa kutoka kwa mtumiaji hadi SAS. Inaweza kutumika tu na **blob na data lake storage** ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas)). Inawezekana **kufuta** SAS zote zilizozalishwa za mtumiaji.
* Hata kama inawezekana kuzalisha delegation SAS yenye ruhusa "zaidi" kuliko zile ambazo mtumiaji ana. Hata hivyo, ikiwa principal hana hizo, haitafanya kazi (hakuna privesc).
* **Service SAS**: Hii inatiwa saini kwa kutumia moja ya **access keys** za akaunti ya storage. Inaweza kutumika kutoa ufikiaji kwa rasilimali maalum katika huduma moja ya storage. Ikiwa funguo itarejeshwa, SAS itakoma kufanya kazi.
* **Account SAS**: Pia inatiwa saini kwa moja ya **access keys** za akaunti ya storage. Inatoa ufikiaji kwa rasilimali katika huduma za akaunti ya storage (Blob, Queue, Table, File) na inaweza kujumuisha operesheni za kiwango cha huduma.

URL ya SAS iliyotiwa saini na **access key** inaonekana kama hii:

* `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

URL ya SAS iliyotiwa saini kama **user delegation** inaonekana kama hii:

* `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

Kumbuka baadhi ya **http params**:

* Param **`se`** inaonyesha **tarehe ya kumalizika** ya SAS
* Param **`sp`** inaonyesha **ruhusa** za SAS
* **`sig`** ni **saini** inayothibitisha SAS

#### Ruhusa za SAS

Ruhusa ambazo SAS inatoa. Thamani zinazoruhusiwa:

* (a)ongeza
* (c)unda
* (d)elea
* (e)tekeleza
* (f)ilita\_kwa\_lebo
* (i)weka\_sera\_ya\_kutokuweza\_kubadilishwa
* (l)oridha
* (m)hamasisha
* (r)soma
* (t)ag
* (w)andika
* (x)futa\_toleo\_la\_zamani
* (y)futa\_kibinafsi\_milele

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# FILE SHARES
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# TABLES
az storage table list --account-name <name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Kuinua Mamlaka

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## Baada ya Kutekeleza

{% content-ref url="../az-post-exploitation-1/az-storage-post-exploitation.md" %}
[az-storage-post-exploitation.md](../az-post-exploitation-1/az-storage-post-exploitation.md)
{% endcontent-ref %}

## Kudumu

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

## Marejeo

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Jifunze & fanya mazoezi ya AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **fuata** sisi kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu za hacking kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
