# Az - Storage

{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
学习和实践 GCP 黑客技术：<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **在 Twitter 上关注** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 分享黑客技巧。

</details>
{% endhint %}

## 基本信息

Azure 存储帐户是 Microsoft Azure 中的基本服务，提供可扩展、安全和高可用的云 **存储各种数据类型**，包括 Blob（大二进制对象）、文件、队列和表。它们作为容器，将这些不同的存储服务组合在一个命名空间下，便于管理。

**主要配置选项**：

* 每个存储帐户必须在所有 Azure 中具有 **唯一名称**。
* 每个存储帐户部署在 **区域** 或 Azure 扩展区中。
* 可以选择存储帐户的 **高级** 版本以获得更好的性能。
* 可以选择 **4 种冗余类型以保护** 免受机架、驱动器和数据中心 **故障**。

**安全配置选项**：

* **要求 REST API 操作的安全传输**：要求在与存储的任何通信中使用 TLS。
* **允许在单个容器上启用匿名访问**：如果不允许，将来将无法启用匿名访问。
* **启用存储帐户密钥访问**：如果不允许，将禁止使用共享密钥访问。
* **最低 TLS 版本**。
* **复制操作的允许范围**：允许来自任何存储帐户、来自同一 Entra 租户的任何存储帐户或来自同一虚拟网络中具有私有端点的存储帐户。

**Blob 存储选项**：

* **允许跨租户复制**。
* **访问层**：热（频繁访问数据）、冷和冷（很少访问的数据）。

**网络选项**：

* **网络访问**：
* 允许来自所有网络。
* 允许来自选定的虚拟网络和 IP 地址。
* 禁用公共访问并使用私有访问。
* **私有端点**：允许从虚拟网络到存储帐户的私有连接。

**数据保护选项**：

* **容器的时间点恢复**：允许将容器恢复到早期状态。
* 需要启用版本控制、变更跟踪和 Blob 软删除。
* **启用 Blob 的软删除**：为已删除的 Blob（即使被覆盖）启用保留期（天数）。
* **启用容器的软删除**：为已删除的容器启用保留期（天数）。
* **启用文件共享的软删除**：为已删除的文件共享启用保留期（天数）。
* **启用 Blob 的版本控制**：维护 Blob 的先前版本。
* **启用 Blob 变更跟踪**：记录对 Blob 的创建、修改和删除更改的日志。
* **启用版本级不可变性支持**：允许您在帐户级别设置基于时间的保留策略，该策略将适用于所有 Blob 版本。
* 版本级不可变性支持和容器的时间点恢复不能同时启用。

**加密配置选项**：

* **加密类型**：可以使用 Microsoft 管理的密钥（MMK）或客户管理的密钥（CMK）。
* **启用基础设施加密**：允许对数据进行双重加密以“提高安全性”。

### 存储端点

<table data-header-hidden><thead><tr><th width="197">存储服务</th><th>端点</th></tr></thead><tbody><tr><td><strong>Blob 存储</strong></td><td><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></td></tr><tr><td><strong>数据湖存储</strong></td><td><code>https://&#x3C;storage-account>.dfs.core.windows.net</code></td></tr><tr><td><strong>Azure 文件</strong></td><td><code>https://&#x3C;storage-account>.file.core.windows.net</code></td></tr><tr><td><strong>队列存储</strong></td><td><code>https://&#x3C;storage-account>.queue.core.windows.net</code></td></tr><tr><td><strong>表存储</strong></td><td><code>https://&#x3C;storage-account>.table.core.windows.net</code></td></tr></tbody></table>

### 公开暴露

如果“允许 Blob 公共访问” **已启用**（默认禁用），在创建容器时可以：

* 给予 **公共访问以读取 Blob**（需要知道名称）。
* **列出容器 Blob** 并 **读取** 它们。
* 使其完全 **私有**。

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

### 连接到存储

如果您找到任何可以连接的 **存储**，可以使用工具 [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) 来连接。

## 访问存储 <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

可以使用 Entra ID 主体与 **RBAC 角色** 访问存储帐户，这是推荐的方式。

### 访问密钥

存储帐户具有可以用于访问的访问密钥。这提供了对存储帐户的 **完全访问**。

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### **共享密钥和轻量级共享密钥**

可以 [**生成共享密钥**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key)，使用访问密钥签名以通过签名 URL 授权访问某些资源。

{% hint style="info" %}
请注意，`CanonicalizedResource` 部分表示存储服务资源（URI）。如果 URL 中的任何部分被编码，则它也应在 `CanonicalizedResource` 中编码。
{% endhint %}

{% hint style="info" %}
这 **是 `az` cli 默认使用的** 进行请求身份验证的方式。要使其使用 Entra ID 主体凭据，请指示参数 `--auth-mode login`。
{% endhint %}

* 可以生成 **Blob、队列和文件服务的共享密钥**，签名以下信息：
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* 可以通过签署以下信息生成 **表服务的共享密钥**：
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
* 可以生成一个 **轻量级共享密钥，用于 blob、队列和文件服务**，通过签署以下信息：
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* 可以通过签署以下信息生成 **表服务的轻量共享密钥**：
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
然后，要使用密钥，可以在授权头中按照以下语法进行操作：
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **共享访问签名** (SAS)

共享访问签名 (SAS) 是安全的、时间限制的 URL，**授予特定权限以访问** Azure 存储帐户中的资源，而不暴露帐户的访问密钥。虽然访问密钥提供对所有资源的完全管理访问，但 SAS 通过指定权限（如读取或写入）和定义过期时间来实现细粒度控制。

#### SAS 类型

* **用户委托 SAS**：这是从 **Entra ID 主体** 创建的，它将签署 SAS 并将权限从用户委托给 SAS。它只能与 **Blob 和数据湖存储** 一起使用 ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas))。可以**撤销**所有生成的用户委托 SAS。
* 即使可以生成具有“更多”权限的委托 SAS，但如果主体没有这些权限，它将无法工作（没有权限提升）。
* **服务 SAS**：这是使用存储帐户的 **访问密钥** 签署的。它可以用于授予对单个存储服务中特定资源的访问。如果密钥被更新，SAS 将停止工作。
* **帐户 SAS**：它也是使用存储帐户的 **访问密钥** 签署的。它授予对存储帐户服务（Blob、队列、表、文件）中的资源的访问，并可以包括服务级操作。

由 **访问密钥** 签署的 SAS URL 看起来像这样：

* `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

作为 **用户委托** 签署的 SAS URL 看起来像这样：

* `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

注意一些 **http 参数**：

* **`se`** 参数表示 SAS 的 **过期日期**
* **`sp`** 参数表示 SAS 的 **权限**
* **`sig`** 是验证 SAS 的 **签名**

#### SAS 权限

生成 SAS 时，需要指明它应授予的权限。根据生成 SAS 的对象，可能会包含不同的权限。例如：

* (a)dd, (c)reate, (d)elete, (e)xecute, (f)ilter\_by\_tags, (i)set\_immutability\_policy, (l)ist, (m)ove, (r)ead, (t)ag, (w)rite, (x)delete\_previous\_version, (y)permanent\_delete

## 枚举

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# TABLES
az storage table list --account-name <name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

### 文件共享

{% content-ref url="az-file-shares.md" %}
[az-file-shares.md](az-file-shares.md)
{% endcontent-ref %}

## 权限提升

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## 利用后

{% content-ref url="../az-post-exploitation/az-blob-storage-post-exploitation.md" %}
[az-blob-storage-post-exploitation.md](../az-post-exploitation/az-blob-storage-post-exploitation.md)
{% endcontent-ref %}

## 持久性

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

## 参考资料

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
学习与实践 GCP 黑客技术：<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **在 Twitter 上关注** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 分享黑客技巧。

</details>
{% endhint %}
