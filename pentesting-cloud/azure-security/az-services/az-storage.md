# Az - Konta magazynowe i Bloby

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Podstawowe informacje

Konta magazynowe Azure to podstawowe usugi w Microsoft Azure, kt贸re zapewniaj skalowaln, bezpieczn i wysoko dostpn chmur **do przechowywania r贸偶nych typ贸w danych**, w tym blob贸w (du偶ych obiekt贸w binarnych), plik贸w, kolejek i tabel. Su偶 jako kontenery, kt贸re grupuj te r贸偶ne usugi magazynowe pod jednym przestrzeni nazw dla atwego zarzdzania.

**G贸wne opcje konfiguracji**:

* Ka偶de konto magazynowe musi mie **unikaln nazw w caym Azure**.
* Ka偶de konto magazynowe jest wdra偶ane w **regionie** lub w rozszerzonej strefie Azure.
* Mo偶na wybra wersj **premium** konta magazynowego dla lepszej wydajnoci.
* Mo偶na wybra spor贸d **4 typ贸w redundancji, aby chroni** przed awariami szafek, dysk贸w i centr贸w danych.

**Opcje konfiguracji bezpieczestwa**:

* **Wymagaj bezpiecznego transferu dla operacji REST API**: Wymagaj TLS w ka偶dej komunikacji z magazynem.
* **Zezwalaj na wczenie dostpu anonimowego do poszczeg贸lnych kontener贸w**: Jeli nie, nie bdzie mo偶liwe wczenie dostpu anonimowego w przyszoci.
* **Wcz dostp do klucza konta magazynowego**: Jeli nie, dostp za pomoc kluczy wsp贸dzielonych bdzie zabroniony.
* **Minimalna wersja TLS**.
* **Dozwolony zakres dla operacji kopiowania**: Zezw贸l z dowolnego konta magazynowego, z dowolnego konta magazynowego z tego samego najemcy Entra lub z konta magazynowego z prywatnymi punktami kocowymi w tej samej sieci wirtualnej.

**Opcje przechowywania blob贸w**:

* **Zezwalaj na replikacj midzy najemcami**.
* **Poziom dostpu**: Gorcy (czsto dostpne dane), Chodny i Zimny (rzadko dostpne dane).

**Opcje sieciowe**:

* **Dostp do sieci**:
* Zezw贸l z wszystkich sieci.
* Zezw贸l z wybranych sieci wirtualnych i adres贸w IP.
* Wycz dostp publiczny i u偶yj dostpu prywatnego.
* **Prywatne punkty kocowe**: Umo偶liwia prywatne poczenie z kontem magazynowym z sieci wirtualnej.

**Opcje ochrony danych**:

* **Przywracanie w punkcie w czasie dla kontener贸w**: Umo偶liwia przywr贸cenie kontener贸w do wczeniejszego stanu.
* Wymaga wczenia wersjonowania, zmiany feedu i mikkiego usuwania blob贸w.
* **Wcz mikkie usuwanie dla blob贸w**: Umo偶liwia okres przechowywania w dniach dla usunitych blob贸w (nawet nadpisanych).
* **Wcz mikkie usuwanie dla kontener贸w**: Umo偶liwia okres przechowywania w dniach dla usunitych kontener贸w.
* **Wcz mikkie usuwanie dla udostpnionych plik贸w**: Umo偶liwia okres przechowywania w dniach dla usunitych udostpnionych plik贸w.
* **Wcz wersjonowanie dla blob贸w**: Utrzymuj poprzednie wersje swoich blob贸w.
* **Wcz feed zmian blob贸w**: Zachowuj logi tworzenia, modyfikacji i usuwania zmian w blobach.
* **Wcz wsparcie dla niezmiennoci na poziomie wersji**: Umo偶liwia ustawienie polityki przechowywania opartej na czasie na poziomie konta, kt贸ra bdzie miaa zastosowanie do wszystkich wersji blob贸w.
* Wsparcie dla niezmiennoci na poziomie wersji i przywracanie w punkcie w czasie dla kontener贸w nie mog by wczone jednoczenie.

**Opcje konfiguracji szyfrowania**:

* **Typ szyfrowania**: Mo偶na u偶ywa kluczy zarzdzanych przez Microsoft (MMK) lub kluczy zarzdzanych przez klienta (CMK).
* **Wcz szyfrowanie infrastruktury**: Umo偶liwia podw贸jne szyfrowanie danych "dla wikszego bezpieczestwa".

### Punkty kocowe magazynu

<table data-header-hidden><thead><tr><th width="197">Usuga magazynowa</th><th>Punkt kocowy</th></tr></thead><tbody><tr><td><strong>Magazyn blob贸w</strong></td><td><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></td></tr><tr><td><strong>Magazyn Data Lake</strong></td><td><code>https://&#x3C;storage-account>.dfs.core.windows.net</code></td></tr><tr><td><strong>Azure Files</strong></td><td><code>https://&#x3C;storage-account>.file.core.windows.net</code></td></tr><tr><td><strong>Magazyn kolejek</strong></td><td><code>https://&#x3C;storage-account>.queue.core.windows.net</code></td></tr><tr><td><strong>Magazyn tabel</strong></td><td><code>https://&#x3C;storage-account>.table.core.windows.net</code></td></tr></tbody></table>

### Publiczna ekspozycja

Jeli "Zezwalaj na publiczny dostp do blob贸w" jest **wczone** (domylnie wyczone), podczas tworzenia kontenera mo偶na:

* Umo偶liwi **publiczny dostp do odczytu blob贸w** (musisz zna nazw).
* **Wylistowa bloby kontenera** i **odczyta** je.
* Uczyni go cakowicie **prywatnym**.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

### Poczenie z magazynem

Jeli znajdziesz jakikolwiek **magazyn**, z kt贸rym mo偶esz si poczy, mo偶esz u偶y narzdzia [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/), aby to zrobi.

## Dostp do magazynu <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

Mo偶na u偶ywa zasad Entra ID z **rolami RBAC** do uzyskania dostpu do kont magazynowych i jest to zalecany spos贸b.

### Klucze dostpu

Konta magazynowe maj klucze dostpu, kt贸re mo偶na wykorzysta do uzyskania dostpu. To zapewnia **peny dostp do konta magazynowego.**

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### **Klucze wsp贸dzielone i lekkie klucze wsp贸dzielone**

Mo偶na [**generowa klucze wsp贸dzielone**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key) podpisane kluczami dostpu, aby autoryzowa dostp do okrelonych zasob贸w za pomoc podpisanego URL.

{% hint style="info" %}
Zauwa偶, 偶e cz `CanonicalizedResource` reprezentuje zas贸b usugi magazynowej (URI). A jeli jakakolwiek cz w URL jest zakodowana, powinna by r贸wnie偶 zakodowana w `CanonicalizedResource`.
{% endhint %}

{% hint style="info" %}
To jest **domylnie u偶ywane przez `az` cli** do uwierzytelniania 偶da. Aby u偶y powiadcze g贸wnych Entra ID, wska偶 parametr `--auth-mode login`.
{% endhint %}

* Mo偶na wygenerowa **klucz wsp贸dzielony dla usug blob贸w, kolejek i plik贸w**, podpisujc nastpujce informacje:
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* Mo偶liwe jest wygenerowanie **klucza wsp贸dzielonego dla usug tabel** podpisujc nastpujce informacje:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
* Mo偶liwe jest wygenerowanie **lite shared key dla usug blob, queue i file**, podpisujc nastpujce informacje:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* Mo偶liwe jest wygenerowanie **lite shared key dla usug tabelowych** podpisujc nastpujce informacje:
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
Nastpnie, aby u偶y klucza, mo偶na to zrobi w nag贸wku Authorization, stosujc nastpujc skadni:
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **Shared Access Signature** (SAS)

Shared Access Signatures (SAS) to bezpieczne, ograniczone czasowo adresy URL, kt贸re **przyznaj okrelone uprawnienia do dostpu do zasob贸w** w koncie Azure Storage bez ujawniania kluczy dostpu do konta. Podczas gdy klucze dostpu zapewniaj peny dostp administracyjny do wszystkich zasob贸w, SAS pozwala na szczeg贸ow kontrol poprzez okrelenie uprawnie (takich jak odczyt lub zapis) i zdefiniowanie czasu wyganicia.

#### Typy SAS

* **User delegation SAS**: Jest tworzony z **Entra ID principal**, kt贸ry podpisuje SAS i deleguje uprawnienia od u偶ytkownika do SAS. Mo偶e by u偶ywany tylko z **blob i data lake storage** ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas)). Mo偶liwe jest **cofnicie** wszystkich wygenerowanych SAS delegowanych przez u偶ytkownika.
* Nawet jeli mo偶liwe jest wygenerowanie SAS delegacji z "wikszymi" uprawnieniami ni偶 te, kt贸re ma u偶ytkownik. Jednak jeli principal ich nie ma, nie zadziaa (brak privesc).
* **Service SAS**: Jest podpisywany za pomoc jednego z **kluczy dostpu** do konta storage. Mo偶e by u偶ywany do przyznawania dostpu do okrelonych zasob贸w w pojedynczej usudze storage. Jeli klucz zostanie odnowiony, SAS przestanie dziaa.
* **Account SAS**: Jest r贸wnie偶 podpisywany jednym z **kluczy dostpu** do konta storage. Przyznaje dostp do zasob贸w w usugach konta storage (Blob, Queue, Table, File) i mo偶e obejmowa operacje na poziomie usugi.

Adres URL SAS podpisany przez **klucz dostpu** wyglda tak:

* `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Adres URL SAS podpisany jako **user delegation** wyglda tak:

* `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

Zauwa偶 niekt贸re **parametry http**:

* Parametr **`se`** wskazuje na **dat wyganicia** SAS
* Parametr **`sp`** wskazuje na **uprawnienia** SAS
* **`sig`** to **podpis** weryfikujcy SAS

#### Uprawnienia SAS

Podczas generowania SAS nale偶y wskaza uprawnienia, kt贸re powinny by przyznawane. W zale偶noci od obiektu, na kt贸rym generowany jest SAS, mog by uwzgldnione r贸偶ne uprawnienia. Na przykad:

* (a)dd, (c)reate, (d)elete, (e)xecute, (f)ilter\_by\_tags, (i)set\_immutability\_policy, (l)ist, (m)ove, (r)ead, (t)ag, (w)rite, (x)delete\_previous\_version, (y)permanent\_delete

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Udostpnianie plik贸w

{% content-ref url="az-file-shares.md" %}
[az-file-shares.md](az-file-shares.md)
{% endcontent-ref %}

## Eskalacja uprawnie

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## Po wykorzystaniu

{% content-ref url="../az-post-exploitation/az-blob-storage-post-exploitation.md" %}
[az-blob-storage-post-exploitation.md](../az-post-exploitation/az-blob-storage-post-exploitation.md)
{% endcontent-ref %}

## Utrzymywanie dostpu

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

## Odniesienia

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}
