# Az - Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

As Contas de Armazenamento do Azure s√£o servi√ßos fundamentais no Microsoft Azure que fornecem armazenamento em nuvem **escal√°vel, seguro e altamente dispon√≠vel para v√°rios tipos de dados**, incluindo blobs (objetos bin√°rios grandes), arquivos, filas e tabelas. Elas servem como cont√™ineres que agrupam esses diferentes servi√ßos de armazenamento sob um √∫nico namespace para f√°cil gerenciamento.

**Principais op√ß√µes de configura√ß√£o**:

* Cada conta de armazenamento deve ter um **nome √∫nico em todo o Azure**.
* Cada conta de armazenamento √© implantada em uma **regi√£o** ou em uma zona estendida do Azure.
* √â poss√≠vel selecionar a vers√£o **premium** da conta de armazenamento para melhor desempenho.
* √â poss√≠vel escolher entre **4 tipos de redund√¢ncia para proteger** contra falhas de rack, disco e datacenter.

**Op√ß√µes de configura√ß√£o de seguran√ßa**:

* **Exigir transfer√™ncia segura para opera√ß√µes da API REST**: Exigir TLS em qualquer comunica√ß√£o com o armazenamento.
* **Permite habilitar acesso an√¥nimo em cont√™ineres individuais**: Caso contr√°rio, n√£o ser√° poss√≠vel habilitar o acesso an√¥nimo no futuro.
* **Habilitar acesso √† chave da conta de armazenamento**: Caso contr√°rio, o acesso com Chaves Compartilhadas ser√° proibido.
* **Vers√£o m√≠nima do TLS**.
* **Escopo permitido para opera√ß√µes de c√≥pia**: Permitir de qualquer conta de armazenamento, de qualquer conta de armazenamento do mesmo inquilino Entra ou de conta de armazenamento com endpoints privados na mesma rede virtual.

**Op√ß√µes de Armazenamento de Blobs**:

* **Permitir replica√ß√£o entre inquilinos**.
* **Camada de acesso**: Quente (dados acessados com frequ√™ncia), Frio e Frio (dados acessados raramente).

**Op√ß√µes de Rede**:

* **Acesso √† rede**:
* Permitir de todas as redes.
* Permitir de redes virtuais e endere√ßos IP selecionados.
* Desativar acesso p√∫blico e usar acesso privado.
* **Endpoints privados**: Permite uma conex√£o privada √† conta de armazenamento a partir de uma rede virtual.

**Op√ß√µes de prote√ß√£o de dados**:

* **Restaura√ß√£o ponto a ponto para cont√™ineres**: Permite restaurar cont√™ineres para um estado anterior.
* Requer versionamento, feed de altera√ß√µes e exclus√£o suave de blobs para ser habilitado.
* **Habilitar exclus√£o suave para blobs**: Habilita um per√≠odo de reten√ß√£o em dias para blobs exclu√≠dos (mesmo sobrescritos).
* **Habilitar exclus√£o suave para cont√™ineres**: Habilita um per√≠odo de reten√ß√£o em dias para cont√™ineres exclu√≠dos.
* **Habilitar exclus√£o suave para compartilhamentos de arquivos**: Habilita um per√≠odo de reten√ß√£o em dias para compartilhamentos de arquivos exclu√≠dos.
* **Habilitar versionamento para blobs**: Manter vers√µes anteriores dos seus blobs.
* **Habilitar feed de altera√ß√µes de blobs**: Manter registros de cria√ß√£o, modifica√ß√£o e exclus√£o de altera√ß√µes em blobs.
* **Habilitar suporte √† imutabilidade em n√≠vel de vers√£o**: Permite definir uma pol√≠tica de reten√ß√£o baseada em tempo no n√≠vel da conta que se aplicar√° a todas as vers√µes de blobs.
* O suporte √† imutabilidade em n√≠vel de vers√£o e a restaura√ß√£o ponto a ponto para cont√™ineres n√£o podem ser habilitados simultaneamente.

**Op√ß√µes de configura√ß√£o de criptografia**:

* **Tipo de criptografia**: √â poss√≠vel usar chaves gerenciadas pela Microsoft (MMK) ou chaves gerenciadas pelo cliente (CMK).
* **Habilitar criptografia de infraestrutura**: Permite criptografar os dados duas vezes "para mais seguran√ßa".

### Storage endpoints

<table data-header-hidden><thead><tr><th width="197">Servi√ßo de Armazenamento</th><th>Endpoint</th></tr></thead><tbody><tr><td><strong>Armazenamento de Blobs</strong></td><td><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></td></tr><tr><td><strong>Armazenamento de Data Lake</strong></td><td><code>https://&#x3C;storage-account>.dfs.core.windows.net</code></td></tr><tr><td><strong>Azure Files</strong></td><td><code>https://&#x3C;storage-account>.file.core.windows.net</code></td></tr><tr><td><strong>Armazenamento de Filas</strong></td><td><code>https://&#x3C;storage-account>.queue.core.windows.net</code></td></tr><tr><td><strong>Armazenamento de Tabelas</strong></td><td><code>https://&#x3C;storage-account>.table.core.windows.net</code></td></tr></tbody></table>

### Public Exposure

Se "Permitir acesso p√∫blico a Blobs" estiver **habilitado** (desabilitado por padr√£o), ao criar um cont√™iner √© poss√≠vel:

* Dar **acesso p√∫blico para ler blobs** (voc√™ precisa saber o nome).
* **Listar blobs do cont√™iner** e **l√™-los**.
* Torn√°-lo totalmente **privado**.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

### Connect to Storage

Se voc√™ encontrar algum **armazenamento** ao qual pode se conectar, voc√™ pode usar a ferramenta [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) para faz√™-lo.

## Access to Storage <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

√â poss√≠vel usar princ√≠pios do Entra ID com **fun√ß√µes RBAC** para acessar contas de armazenamento e √© o m√©todo recomendado.

### Access Keys

As contas de armazenamento t√™m chaves de acesso que podem ser usadas para acess√°-las. Isso fornece **acesso total √† conta de armazenamento.**

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### **Chaves Compartilhadas & Chaves Compartilhadas Lite**

√â poss√≠vel [**gerar Chaves Compartilhadas**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key) assinadas com as chaves de acesso para autorizar o acesso a certos recursos via uma URL assinada.

{% hint style="info" %}
Note que a parte `CanonicalizedResource` representa o recurso dos servi√ßos de armazenamento (URI). E se qualquer parte da URL estiver codificada, ela tamb√©m deve ser codificada dentro do `CanonicalizedResource`.
{% endhint %}

{% hint style="info" %}
Isso √© **usado por padr√£o pelo `az` cli** para autenticar solicita√ß√µes. Para fazer com que use as credenciais do principal do Entra ID, indique o par√¢metro `--auth-mode login`.
{% endhint %}

* √â poss√≠vel gerar uma **chave compartilhada para servi√ßos de blob, fila e arquivo** assinando as seguintes informa√ß√µes:
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* √â poss√≠vel gerar uma **chave compartilhada para servi√ßos de tabela** assinando as seguintes informa√ß√µes:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
* √â poss√≠vel gerar uma **chave compartilhada lite para servi√ßos de blob, fila e arquivo** assinando as seguintes informa√ß√µes:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* √â poss√≠vel gerar uma **chave compartilhada lite para servi√ßos de tabela** assinando as seguintes informa√ß√µes:
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
Ent√£o, para usar a chave, pode ser feito no cabe√ßalho de Autoriza√ß√£o seguindo a sintaxe:
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **Shared Access Signature** (SAS)

As Signaturas de Acesso Compartilhado (SAS) s√£o URLs seguras e limitadas no tempo que **concedem permiss√µes espec√≠ficas para acessar recursos** em uma conta de Armazenamento do Azure sem expor as chaves de acesso da conta. Enquanto as chaves de acesso fornecem acesso administrativo total a todos os recursos, a SAS permite um controle granular ao especificar permiss√µes (como leitura ou escrita) e definir um tempo de expira√ß√£o.

#### Tipos de SAS

* **SAS de delega√ß√£o de usu√°rio**: Isso √© criado a partir de um **principal do Entra ID** que assinar√° a SAS e delegar√° as permiss√µes do usu√°rio para a SAS. Pode ser usado apenas com **blob e armazenamento de data lake** ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas)). √â poss√≠vel **revogar** todas as SAS de delega√ß√£o de usu√°rio geradas.
* Mesmo que seja poss√≠vel gerar uma SAS de delega√ß√£o com "mais" permiss√µes do que as que o usu√°rio possui. No entanto, se o principal n√£o as tiver, n√£o funcionar√° (sem privesc).
* **SAS de servi√ßo**: Isso √© assinado usando uma das **chaves de acesso** da conta de armazenamento. Pode ser usado para conceder acesso a recursos espec√≠ficos em um √∫nico servi√ßo de armazenamento. Se a chave for renovada, a SAS deixar√° de funcionar.
* **SAS de conta**: Tamb√©m √© assinado com uma das **chaves de acesso** da conta de armazenamento. Concede acesso a recursos em servi√ßos de conta de armazenamento (Blob, Queue, Table, File) e pode incluir opera√ß√µes em n√≠vel de servi√ßo.

Uma URL SAS assinada por uma **chave de acesso** se parece com isto:

* `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Uma URL SAS assinada como uma **delega√ß√£o de usu√°rio** se parece com isto:

* `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

Note alguns **http params**:

* O **`se`** param indica a **data de expira√ß√£o** da SAS
* O **`sp`** param indica as **permiss√µes** da SAS
* O **`sig`** √© a **assinatura** que valida a SAS

#### Permiss√µes SAS

As permiss√µes que a SAS concede. Valores permitidos:

* (a)dd
* (c)reate
* (d)elete
* (e)xecute
* (f)ilter\_by\_tags
* (i)set\_immutability\_policy
* (l)ist
* (m)ove
* (r)ead
* (t)ag
* (w)rite
* (x)delete\_previous\_version
* (y)permanent\_delete

## Enumera√ß√£o

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# FILE SHARES
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# TABLES
az storage table list --account-name <name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Escala√ß√£o de Privil√©gios

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## P√≥s Explora√ß√£o

{% content-ref url="../az-post-exploitation-1/az-storage-post-exploitation.md" %}
[az-storage-post-exploitation.md](../az-post-exploitation-1/az-storage-post-exploitation.md)
{% endcontent-ref %}

## Persist√™ncia

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
