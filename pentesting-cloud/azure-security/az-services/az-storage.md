# Az - Storage

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basiese Inligting

Azure Storage Accounts is fundamentele dienste in Microsoft Azure wat skaalbare, veilige, en hoogs beskikbare wolk **berging vir verskeie datatipes** bied, insluitend blobs (binaries groot voorwerpe), l√™ers, rye, en tabelle. Hulle dien as houers wat hierdie verskillende bergingsdienste saamgroepeer onder 'n enkele naamruimte vir maklike bestuur.

**Hoof konfigurasie opsies**:

* Elke berging rekening moet 'n **unieke naam oor alle Azure** h√™.
* Elke berging rekening word in 'n **streek** of in 'n Azure uitgebreide sone ontplooi.
* Dit is moontlik om die **premium** weergawe van die berging rekening te kies vir beter prestasie.
* Dit is moontlik om onder **4 tipes redundans te kies om** teen rak, skyf en datacentrum **foute** te beskerm.

**Sekuriteit konfigurasie opsies**:

* **Vereis veilige oordrag vir REST API operasies**: Vereis TLS in enige kommunikasie met die berging.
* **Laat anonieme toegang op individuele houers toe**: As nie, sal dit nie moontlik wees om anonieme toegang in die toekoms toe te laat nie.
* **Aktiveer berging rekening sleutel toegang**: As nie, sal toegang met Gedeelde Sleutels verbied word.
* **Minimum TLS weergawe**.
* **Toegelate omvang vir kopie operasies**: Laat toe vanaf enige berging rekening, vanaf enige berging rekening van dieselfde Entra tenant of vanaf berging rekening met private eindpunte in dieselfde virtuele netwerk.

**Blob Berging opsies**:

* **Laat kruis-tenant replikaasies toe**.
* **Toegangsgraad**: Warm (gereeld toeganklike data), Koel en Koud (selde toeganklike data).

**Netwerk opsies**:

* **Netwerk toegang**:
* Laat toe vanaf alle netwerke.
* Laat toe vanaf geselekteerde virtuele netwerke en IP adresse.
* Deaktiveer publieke toegang en gebruik private toegang.
* **Private eindpunte**: Dit laat 'n private verbinding met die berging rekening vanaf 'n virtuele netwerk toe.

**Data beskerming opsies**:

* **Punt-in-tyd herstel vir houers**: Laat toe om houers na 'n vroe√´re toestand te herstel.
* Dit vereis weergawe, verandering voer, en blob sagte verwydering om geaktiveer te wees.
* **Aktiveer sagte verwydering vir blobs**: Dit aktiveer 'n behoud tydperk in dae vir verwyderde blobs (selfs oorgeskryf).
* **Aktiveer sagte verwydering vir houers**: Dit aktiveer 'n behoud tydperk in dae vir verwyderde houers.
* **Aktiveer sagte verwydering vir l√™er gedeeltes**: Dit aktiveer 'n behoud tydperk in dae vir verwyderde l√™er gedeeltes.
* **Aktiveer weergawe vir blobs**: Handhaaf vorige weergawes van jou blobs.
* **Aktiveer blob verandering voer**: Hou logs van skep, wysiging, en verwydering veranderinge aan blobs.
* **Aktiveer weergawe-vlak onveranderlikheid ondersteuning**: Laat jou toe om 'n tyd-gebaseerde behoud beleid op rekening-vlak in te stel wat op alle blob weergawes van toepassing sal wees.
* Weergave-vlak onveranderlikheid ondersteuning en punt-in-tyd herstel vir houers kan nie gelyktydig geaktiveer word nie.

**Enkripsie konfigurasie opsies**:

* **Enkripsie tipe**: Dit is moontlik om Microsoft-beheerde sleutels (MMK) of Kli√´nt-beheerde sleutels (CMK) te gebruik.
* **Aktiveer infrastruktuur enkripsie**: Laat toe om die data dubbel te enkripteer "vir meer sekuriteit".

### Berging eindpunte

<table data-header-hidden><thead><tr><th width="197">Berging Diens</th><th>Eindpunt</th></tr></thead><tbody><tr><td><strong>Blob berging</strong></td><td><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></td></tr><tr><td><strong>Data Lake Berging</strong></td><td><code>https://&#x3C;storage-account>.dfs.core.windows.net</code></td></tr><tr><td><strong>Azure L√™ers</strong></td><td><code>https://&#x3C;storage-account>.file.core.windows.net</code></td></tr><tr><td><strong>Rye berging</strong></td><td><code>https://&#x3C;storage-account>.queue.core.windows.net</code></td></tr><tr><td><strong>Tabel berging</strong></td><td><code>https://&#x3C;storage-account>.table.core.windows.net</code></td></tr></tbody></table>

### Publieke Blootstelling

As "Laat Blob publieke toegang toe" **geaktiveer** is (standaard gedeaktiveer), wanneer 'n houer geskep word, is dit moontlik om:

* **Publieke toegang te gee om blobs te lees** (jy moet die naam weet).
* **Lys houer blobs** en **lees** hulle.
* Maak dit heeltemal **privaat**.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

### Verbind met Berging

As jy enige **berging** vind waarmee jy kan verbind, kan jy die hulpmiddel [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) gebruik om dit te doen.

## Toegang tot Berging <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

Dit is moontlik om Entra ID beginsels met **RBAC rolle** te gebruik om toegang tot berging rekeninge te verkry en dit is die aanbevole manier.

### Toegang Sleutels

Die berging rekeninge het toegang sleutels wat gebruik kan word om toegang te verkry. Dit bied **volledige toegang tot die berging rekening.**

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### **Gedeelde Sleutels & Lite Gedeelde Sleutels**

Dit is moontlik om [**Gedeelde Sleutels te genereer**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key) wat met die toegang sleutels onderteken is om toegang tot sekere hulpbronne via 'n ondertekende URL te autoriseer.

{% hint style="info" %}
Let daarop dat die `CanonicalizedResource` deel die berging dienste hulpbron (URI) verteenwoordig. En as enige deel in die URL ge√´nkodeer is, moet dit ook binne die `CanonicalizedResource` ge√´nkodeer wees.
{% endhint %}

{% hint style="info" %}
Dit is **standaard gebruik deur `az` cli** om versoeke te autentiseer. Om dit te laat gebruik van die Entra ID beginsel akrediteer, dui die param `--auth-mode login` aan.
{% endhint %}

* Dit is moontlik om 'n **gedeelde sleutel vir blob, rye en l√™er dienste** te genereer deur die volgende inligting te onderteken:
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* Dit is moontlik om 'n **gedeelde sleutel vir tabel dienste** te genereer deur die volgende inligting te teken:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
* Dit is moontlik om 'n **lite gedeelde sleutel vir blob, wagqueue en l√™er dienste** te genereer deur die volgende inligting te teken:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* Dit is moontlik om 'n **lite gedeelde sleutel vir tabel dienste** te genereer deur die volgende inligting te teken:
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
Dan, om die sleutel te gebruik, kan dit in die Outeurskap-header gedoen word volgens die sintaksis:
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **Gedeelde Toegang Handtekening** (SAS)

Gedeelde Toegang Handtekeninge (SAS) is veilige, tyd-beperkte URL's wat **spesifieke toestemmings gee om hulpbronne** in 'n Azure Storage rekening te benader sonder om die rekening se toegang sleutels bloot te stel. Terwyl toegang sleutels volle administratiewe toegang tot alle hulpbronne bied, laat SAS granular beheer toe deur toestemmings (soos lees of skryf) te spesifiseer en 'n vervaldatum te definieer.

#### SAS Tipes

* **Gebruiker delegasie SAS**: Dit word geskep vanaf 'n **Entra ID prinsiep** wat die SAS sal onderteken en die toestemmings van die gebruiker na die SAS sal delegeren. Dit kan slegs gebruik word met **blob en data lake storage** ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas)). Dit is moontlik om alle gegenereerde gebruiker gedelegeerde SAS te **herroep**.
* Alhoewel dit moontlik is om 'n delegasie SAS te genereer met "meer" toestemmings as wat die gebruiker het. As die prinsiep egter nie hulle het nie, sal dit nie werk (geen privesc).
* **Diens SAS**: Dit word onderteken met een van die opslag rekening **toegang sleutels**. Dit kan gebruik word om toegang tot spesifieke hulpbronne in 'n enkele opslag diens te gee. As die sleutel hernu word, sal die SAS ophou werk.
* **Rekening SAS**: Dit is ook onderteken met een van die opslag rekening **toegang sleutels**. Dit gee toegang tot hulpbronne oor 'n opslag rekening dienste (Blob, Queue, Table, File) en kan diensvlak operasies insluit.

'n SAS URL onderteken deur 'n **toegang sleutel** lyk soos volg:

* `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

'n SAS URL onderteken as 'n **gebruiker delegasie** lyk soos volg:

* `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

Let op sommige **http params**:

* Die **`se`** param dui die **vervaldatum** van die SAS aan
* Die **`sp`** param dui die **toestemmings** van die SAS aan
* Die **`sig`** is die **handtekening** wat die SAS valideer

#### SAS toestemmings

Die toestemmings wat die SAS gee. Toegestane waardes:

* (a)dd
* (c)reate
* (d)elete
* (e)xecute
* (f)ilter\_by\_tags
* (i)set\_immutability\_policy
* (l)ist
* (m)ove
* (r)ead
* (t)ag
* (w)rite
* (x)delete\_previous\_version
* (y)permanent\_delete

## Opsporing

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# FILE SHARES
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# TABLES
az storage table list --account-name <name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Privilege Escalation

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../az-post-exploitation-1/az-storage-post-exploitation.md" %}
[az-storage-post-exploitation.md](../az-post-exploitation-1/az-storage-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Kyk na die [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) of die [**telegram group**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
