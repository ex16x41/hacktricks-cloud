# Az - Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Les comptes de stockage Azure sont des services fondamentaux dans Microsoft Azure qui fournissent un **stockage cloud √©volutif, s√©curis√© et hautement disponible pour divers types de donn√©es**, y compris les blobs (objets binaires volumineux), les fichiers, les files d'attente et les tables. Ils servent de conteneurs qui regroupent ces diff√©rents services de stockage sous un seul espace de noms pour une gestion facile.

**Options de configuration principales** :

* Chaque compte de stockage doit avoir un **nom unique dans tous Azure**.
* Chaque compte de stockage est d√©ploy√© dans une **r√©gion** ou dans une zone √©tendue Azure.
* Il est possible de s√©lectionner la version **premium** du compte de stockage pour de meilleures performances.
* Il est possible de choisir parmi **4 types de redondance pour se prot√©ger** contre les pannes de rack, de disque et de centre de donn√©es.

**Options de configuration de s√©curit√©** :

* **Exiger un transfert s√©curis√© pour les op√©rations de l'API REST** : Exiger TLS dans toute communication avec le stockage.
* **Permettre l'acc√®s anonyme sur des conteneurs individuels** : Sinon, il ne sera pas possible d'activer l'acc√®s anonyme √† l'avenir.
* **Activer l'acc√®s par cl√© de compte de stockage** : Sinon, l'acc√®s avec des cl√©s partag√©es sera interdit.
* **Version TLS minimale**.
* **Port√©e autoris√©e pour les op√©rations de copie** : Autoriser depuis n'importe quel compte de stockage, depuis n'importe quel compte de stockage du m√™me locataire Entra ou depuis un compte de stockage avec des points de terminaison priv√©s dans le m√™me r√©seau virtuel.

**Options de stockage de blobs** :

* **Autoriser la r√©plication inter-locataires**.
* **Niveau d'acc√®s** : Chaud (donn√©es fr√©quemment accessibles), Froid et Glacial (donn√©es rarement accessibles).

**Options de mise en r√©seau** :

* **Acc√®s r√©seau** :
* Autoriser depuis tous les r√©seaux.
* Autoriser depuis des r√©seaux virtuels et des adresses IP s√©lectionn√©s.
* D√©sactiver l'acc√®s public et utiliser l'acc√®s priv√©.
* **Points de terminaison priv√©s** : Cela permet une connexion priv√©e au compte de stockage depuis un r√©seau virtuel.

**Options de protection des donn√©es** :

* **Restauration √† un instant donn√© pour les conteneurs** : Permet de restaurer les conteneurs √† un √©tat ant√©rieur.
* Cela n√©cessite que la version, le flux de modifications et la suppression douce des blobs soient activ√©s.
* **Activer la suppression douce pour les blobs** : Cela active une p√©riode de conservation en jours pour les blobs supprim√©s (m√™me √©cras√©s).
* **Activer la suppression douce pour les conteneurs** : Cela active une p√©riode de conservation en jours pour les conteneurs supprim√©s.
* **Activer la suppression douce pour les partages de fichiers** : Cela active une p√©riode de conservation en jours pour les fichiers partag√©s supprim√©s.
* **Activer la version pour les blobs** : Maintenir les versions pr√©c√©dentes de vos blobs.
* **Activer le flux de modifications des blobs** : Conserver des journaux des cr√©ations, modifications et suppressions des blobs.
* **Activer le support d'immuabilit√© au niveau de la version** : Vous permet de d√©finir une politique de conservation bas√©e sur le temps au niveau du compte qui s'appliquera √† toutes les versions de blobs.
* Le support d'immuabilit√© au niveau de la version et la restauration √† un instant donn√© pour les conteneurs ne peuvent pas √™tre activ√©s simultan√©ment.

**Options de configuration de chiffrement** :

* **Type de chiffrement** : Il est possible d'utiliser des cl√©s g√©r√©es par Microsoft (MMK) ou des cl√©s g√©r√©es par le client (CMK).
* **Activer le chiffrement de l'infrastructure** : Permet de chiffrer les donn√©es deux fois "pour plus de s√©curit√©".

### Storage endpoints

<table data-header-hidden><thead><tr><th width="197">Service de stockage</th><th>Point de terminaison</th></tr></thead><tbody><tr><td><strong>Stockage de blobs</strong></td><td><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></td></tr><tr><td><strong>Stockage Data Lake</strong></td><td><code>https://&#x3C;storage-account>.dfs.core.windows.net</code></td></tr><tr><td><strong>Azure Files</strong></td><td><code>https://&#x3C;storage-account>.file.core.windows.net</code></td></tr><tr><td><strong>Stockage de files d'attente</strong></td><td><code>https://&#x3C;storage-account>.queue.core.windows.net</code></td></tr><tr><td><strong>Stockage de tables</strong></td><td><code>https://&#x3C;storage-account>.table.core.windows.net</code></td></tr></tbody></table>

### Public Exposure

Si "Autoriser l'acc√®s public aux blobs" est **activ√©** (d√©sactiv√© par d√©faut), lors de la cr√©ation d'un conteneur, il est possible de :

* Donner **un acc√®s public pour lire les blobs** (vous devez conna√Ætre le nom).
* **Lister les blobs du conteneur** et **les lire**.
* Le rendre enti√®rement **priv√©**.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

### Connect to Storage

Si vous trouvez un **stockage** auquel vous pouvez vous connecter, vous pouvez utiliser l'outil [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) pour le faire.

## Access to Storage <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

Il est possible d'utiliser des principes Entra ID avec des **r√¥les RBAC** pour acc√©der aux comptes de stockage et c'est la m√©thode recommand√©e.

### Access Keys

Les comptes de stockage ont des cl√©s d'acc√®s qui peuvent √™tre utilis√©es pour y acc√©der. Cela fournit un **acc√®s complet au compte de stockage.**

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### **Shared Keys & Lite Shared Keys**

Il est possible de [**g√©n√©rer des cl√©s partag√©es**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key) sign√©es avec les cl√©s d'acc√®s pour autoriser l'acc√®s √† certaines ressources via une URL sign√©e.

{% hint style="info" %}
Notez que la partie `CanonicalizedResource` repr√©sente la ressource des services de stockage (URI). Et si une partie de l'URL est encod√©e, elle doit √©galement √™tre encod√©e √† l'int√©rieur de `CanonicalizedResource`.
{% endhint %}

{% hint style="info" %}
Ceci est **utilis√© par d√©faut par `az` cli** pour authentifier les demandes. Pour qu'il utilise les identifiants du principal Entra ID, indiquez le param√®tre `--auth-mode login`.
{% endhint %}

* Il est possible de g√©n√©rer une **cl√© partag√©e pour les services de blobs, de files d'attente et de fichiers** en signant les informations suivantes :
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* Il est possible de g√©n√©rer une **cl√© partag√©e pour les services de table** en signant les informations suivantes :
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
* Il est possible de g√©n√©rer une **cl√© partag√©e l√©g√®re pour les services blob, queue et file** en signant les informations suivantes :
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* Il est possible de g√©n√©rer une **cl√© partag√©e l√©g√®re pour les services de table** en signant les informations suivantes :
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
Alors, pour utiliser la cl√©, cela peut se faire dans l'en-t√™te Authorization suivant la syntaxe :
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **Signature d'acc√®s partag√©** (SAS)

Les signatures d'acc√®s partag√© (SAS) sont des URL s√©curis√©es et temporis√©es qui **accordent des autorisations sp√©cifiques pour acc√©der aux ressources** dans un compte de stockage Azure sans exposer les cl√©s d'acc√®s du compte. Alors que les cl√©s d'acc√®s fournissent un acc√®s administratif complet √† toutes les ressources, le SAS permet un contr√¥le granulaire en sp√©cifiant des autorisations (comme lire ou √©crire) et en d√©finissant une dur√©e d'expiration.

#### Types de SAS

* **SAS de d√©l√©gation utilisateur** : Cela est cr√©√© √† partir d'un **principal Entra ID** qui signera le SAS et d√©l√®guera les autorisations de l'utilisateur au SAS. Il ne peut √™tre utilis√© qu'avec **blob et stockage de lac de donn√©es** ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas)). Il est possible de **r√©voquer** tous les SAS d√©l√©gu√©s par l'utilisateur g√©n√©r√©s.
* M√™me s'il est possible de g√©n√©rer un SAS de d√©l√©gation avec "plus" d'autorisations que celles dont dispose l'utilisateur. Cependant, si le principal ne les a pas, cela ne fonctionnera pas (pas de privesc).
* **SAS de service** : Cela est sign√© en utilisant l'une des **cl√©s d'acc√®s** du compte de stockage. Il peut √™tre utilis√© pour accorder l'acc√®s √† des ressources sp√©cifiques dans un seul service de stockage. Si la cl√© est renouvel√©e, le SAS cessera de fonctionner.
* **SAS de compte** : Il est √©galement sign√© avec l'une des **cl√©s d'acc√®s** du compte de stockage. Il accorde l'acc√®s aux ressources √† travers les services d'un compte de stockage (Blob, Queue, Table, File) et peut inclure des op√©rations au niveau du service.

Une URL SAS sign√©e par une **cl√© d'acc√®s** ressemble √† ceci :

* `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Une URL SAS sign√©e en tant que **d√©l√©gation utilisateur** ressemble √† ceci :

* `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

Notez quelques **params http** :

* Le param√®tre **`se`** indique la **date d'expiration** du SAS
* Le param√®tre **`sp`** indique les **autorisations** du SAS
* Le **`sig`** est la **signature** validant le SAS

#### Autorisations SAS

Les autorisations accord√©es par le SAS. Valeurs autoris√©es :

* (a)jouter
* (c)r√©er
* (d)√©lete
* (e)x√©cuter
* (f)iltrer\_par\_tags
* (i)ndiquer\_politique\_d'immuabilit√©
* (l)ister
* (m)ouvoir
* (r)ead
* (t)ag
* (w)riter
* (x)delete\_previous\_version
* (y)delete\_permanent

## √ânum√©ration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# FILE SHARES
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# TABLES
az storage table list --account-name <name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Escalade de privil√®ges

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## Post-exploitation

{% content-ref url="../az-post-exploitation-1/az-storage-post-exploitation.md" %}
[az-storage-post-exploitation.md](../az-post-exploitation-1/az-storage-post-exploitation.md)
{% endcontent-ref %}

## Persistance

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
