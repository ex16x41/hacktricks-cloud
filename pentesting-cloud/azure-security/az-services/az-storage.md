# Az - Speicherkonten & Blobs

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Grundinformationen

Azure-Speicherkonten sind grundlegende Dienste in Microsoft Azure, die skalierbaren, sicheren und hochverf√ºgbaren Cloud-**Speicher f√ºr verschiedene Datentypen** bereitstellen, einschlie√ülich Blobs (Binary Large Objects), Dateien, Warteschlangen und Tabellen. Sie dienen als Container, die diese verschiedenen Speicher Dienste unter einem einzigen Namensraum zur einfachen Verwaltung gruppieren.

**Hauptkonfigurationsoptionen**:

* Jedes Speicherkonto muss einen **eindeutigen Namen in ganz Azure** haben.
* Jedes Speicherkonto wird in einer **Region** oder in einer erweiterten Azure-Zone bereitgestellt.
* Es ist m√∂glich, die **Premium**-Version des Speicherkontos f√ºr bessere Leistung auszuw√§hlen.
* Es ist m√∂glich, zwischen **4 Arten von Redundanz zum Schutz** vor Rack-, Laufwerks- und Rechenzentrums-**Ausf√§llen** zu w√§hlen.

**Sicherheitskonfigurationsoptionen**:

* **Sicheren Transfer f√ºr REST-API-Operationen erforderlich**: TLS in jeder Kommunikation mit dem Speicher erforderlich.
* **Erm√∂glicht anonymen Zugriff auf einzelne Container**: Andernfalls ist es nicht m√∂glich, in Zukunft anonymen Zugriff zu aktivieren.
* **Aktivieren Sie den Zugriff auf den Schl√ºssel des Speicherkontos**: Andernfalls wird der Zugriff mit Shared Keys verboten.
* **Minimale TLS-Version**
* **Erlaubter Geltungsbereich f√ºr Kopieroperationen**: Erlauben von jedem Speicherkonto, von jedem Speicherkonto aus demselben Entra-Mandanten oder von Speicherkonten mit privaten Endpunkten im selben virtuellen Netzwerk.

**Blob-Speicheroptionen**:

* **Erlaube die Replikation √ºber Mandanten hinweg**
* **Zugriffsebene**: Hot (h√§ufig auf Daten zugreifen), Cool und Cold (selten auf Daten zugreifen)

**Netzwerkoptionen**:

* **Netzwerkzugriff**:
* Erlauben von allen Netzwerken
* Erlauben von ausgew√§hlten virtuellen Netzwerken und IP-Adressen
* √ñffentlichen Zugriff deaktivieren und privaten Zugriff verwenden
* **Private Endpunkte**: Erm√∂glicht eine private Verbindung zum Speicherkonto von einem virtuellen Netzwerk

**Datenschutzoptionen**:

* **Wiederherstellung zu einem bestimmten Zeitpunkt f√ºr Container**: Erm√∂glicht die Wiederherstellung von Containern in einen fr√ºheren Zustand.
* Es erfordert, dass Versionierung, √Ñnderungsprotokoll und Blob-Weichl√∂schung aktiviert sind.
* **Aktivieren Sie die Weichl√∂schung f√ºr Blobs**: Es erm√∂glicht einen Aufbewahrungszeitraum in Tagen f√ºr gel√∂schte Blobs (auch √ºberschrieben).
* **Aktivieren Sie die Weichl√∂schung f√ºr Container**: Es erm√∂glicht einen Aufbewahrungszeitraum in Tagen f√ºr gel√∂schte Container.
* **Aktivieren Sie die Weichl√∂schung f√ºr Dateifreigaben**: Es erm√∂glicht einen Aufbewahrungszeitraum in Tagen f√ºr gel√∂schte Dateifreigaben.
* **Aktivieren Sie die Versionierung f√ºr Blobs**: Behalten Sie fr√ºhere Versionen Ihrer Blobs.
* **Aktivieren Sie das √Ñnderungsprotokoll f√ºr Blobs**: F√ºhren Sie Protokolle √ºber Erstellungs-, √Ñnderungs- und L√∂schvorg√§nge an Blobs.
* **Aktivieren Sie die Unterst√ºtzung f√ºr die Unver√§nderlichkeit auf Versionsebene**: Erm√∂glicht es Ihnen, eine zeitbasierte Aufbewahrungsrichtlinie auf Kontoebene festzulegen, die f√ºr alle Blob-Versionen gilt.
* Unterst√ºtzung f√ºr die Unver√§nderlichkeit auf Versionsebene und Wiederherstellung zu einem bestimmten Zeitpunkt f√ºr Container k√∂nnen nicht gleichzeitig aktiviert werden.

**Verschl√ºsselungskonfigurationsoptionen**:

* **Verschl√ºsselungstyp**: Es ist m√∂glich, von Microsoft verwaltete Schl√ºssel (MMK) oder vom Kunden verwaltete Schl√ºssel (CMK) zu verwenden.
* **Aktivieren Sie die Infrastrukturverschl√ºsselung**: Erm√∂glicht die doppelte Verschl√ºsselung der Daten "f√ºr mehr Sicherheit".

### Speicherendpunkte

<table data-header-hidden><thead><tr><th width="197">Speicherdienst</th><th>Endpunkt</th></tr></thead><tbody><tr><td><strong>Blob-Speicher</strong></td><td><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></td></tr><tr><td><strong>Data Lake Storage</strong></td><td><code>https://&#x3C;storage-account>.dfs.core.windows.net</code></td></tr><tr><td><strong>Azure Files</strong></td><td><code>https://&#x3C;storage-account>.file.core.windows.net</code></td></tr><tr><td><strong>Warteschlangen-Speicher</strong></td><td><code>https://&#x3C;storage-account>.queue.core.windows.net</code></td></tr><tr><td><strong>Tabellen-Speicher</strong></td><td><code>https://&#x3C;storage-account>.table.core.windows.net</code></td></tr></tbody></table>

### √ñffentliche Exposition

Wenn "√ñffentlichen Zugriff auf Blobs erlauben" **aktiviert** ist (standardm√§√üig deaktiviert), ist es beim Erstellen eines Containers m√∂glich:

* **√ñffentlichen Zugriff zum Lesen von Blobs** zu gew√§hren (Sie m√ºssen den Namen kennen).
* **Container-Blobs aufzulisten** und **sie zu lesen**.
* Es vollst√§ndig **privat** zu machen.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

### Verbindung zum Speicher

Wenn Sie einen **Speicher** finden, zu dem Sie eine Verbindung herstellen k√∂nnen, k√∂nnen Sie das Tool [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) verwenden, um dies zu tun.

## Zugriff auf Speicher <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

Es ist m√∂glich, Entra ID-Prinzipien mit **RBAC-Rollen** zu verwenden, um auf Speicherkonten zuzugreifen, und es ist der empfohlene Weg.

### Zugriffsschl√ºssel

Die Speicherkonten haben Zugriffsschl√ºssel, die verwendet werden k√∂nnen, um darauf zuzugreifen. Dies bietet **vollen Zugriff auf das Speicherkonto.**

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### **Geteilte Schl√ºssel & Lite Geteilte Schl√ºssel**

Es ist m√∂glich, [**geteilte Schl√ºssel zu generieren**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key), die mit den Zugriffsschl√ºsseln signiert sind, um den Zugriff auf bestimmte Ressourcen √ºber eine signierte URL zu autorisieren.

{% hint style="info" %}
Beachten Sie, dass der Teil `CanonicalizedResource` die Ressource der Speicher Dienste (URI) darstellt. Und wenn ein Teil der URL codiert ist, sollte er auch im `CanonicalizedResource` codiert sein.
{% endhint %}

{% hint style="info" %}
Dies wird **standardm√§√üig von `az` cli** verwendet, um Anfragen zu authentifizieren. Um die Anmeldeinformationen des Entra ID-Prinzips zu verwenden, geben Sie den Parameter `--auth-mode login` an.
{% endhint %}

* Es ist m√∂glich, einen **geteilten Schl√ºssel f√ºr Blob-, Warteschlangen- und Dateidienste** zu generieren, indem die folgenden Informationen signiert werden:
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* Es ist m√∂glich, einen **gemeinsamen Schl√ºssel f√ºr Tabellendienste** zu generieren, indem die folgenden Informationen signiert werden:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
* Es ist m√∂glich, einen **lite shared key f√ºr Blob-, Queue- und Dateidienste** zu generieren, indem die folgenden Informationen signiert werden:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
* Es ist m√∂glich, einen **lite shared key f√ºr Tabellenservices** zu generieren, indem die folgenden Informationen signiert werden:
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
Dann kann der Schl√ºssel im Authorization-Header gem√§√ü der Syntax verwendet werden:
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **Shared Access Signature** (SAS)

Shared Access Signatures (SAS) sind sichere, zeitlich begrenzte URLs, die **spezifische Berechtigungen zum Zugriff auf Ressourcen** in einem Azure Storage-Konto gew√§hren, ohne die Zugriffsschl√ºssel des Kontos offenzulegen. W√§hrend Zugriffsschl√ºssel vollst√§ndigen administrativen Zugriff auf alle Ressourcen bieten, erm√∂glicht SAS eine granulare Kontrolle, indem Berechtigungen (wie Lesen oder Schreiben) festgelegt und eine Ablaufzeit definiert werden.

#### SAS-Typen

* **Benutzerdelegation SAS**: Dies wird von einem **Entra ID-Prinzipal** erstellt, der die SAS signiert und die Berechtigungen vom Benutzer an die SAS delegiert. Es kann nur mit **Blob- und Data Lake-Speicher** verwendet werden ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas)). Es ist m√∂glich, alle generierten benutzergest√ºtzten SAS zu **widerrufen**.
* Auch wenn es m√∂glich ist, eine Delegation SAS mit "mehr" Berechtigungen zu generieren, als der Benutzer hat. Wenn der Prinzipal diese jedoch nicht hat, funktioniert es nicht (kein Privesc).
* **Service SAS**: Dies wird mit einem der **Zugriffsschl√ºssel** des Speicherkontos signiert. Es kann verwendet werden, um den Zugriff auf spezifische Ressourcen in einem einzelnen Speicherdienst zu gew√§hren. Wenn der Schl√ºssel erneuert wird, funktioniert die SAS nicht mehr.
* **Konto SAS**: Es wird ebenfalls mit einem der **Zugriffsschl√ºssel** des Speicherkontos signiert. Es gew√§hrt Zugriff auf Ressourcen √ºber die Dienste eines Speicherkontos (Blob, Warteschlange, Tabelle, Datei) und kann dienstebezogene Operationen umfassen.

Eine SAS-URL, die mit einem **Zugriffsschl√ºssel** signiert ist, sieht so aus:

* `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Eine SAS-URL, die als **Benutzerdelegation** signiert ist, sieht so aus:

* `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

Beachten Sie einige **HTTP-Parameter**:

* Der **`se`**-Parameter gibt das **Ablaufdatum** der SAS an
* Der **`sp`**-Parameter gibt die **Berechtigungen** der SAS an
* Der **`sig`** ist die **Signatur**, die die SAS validiert

#### SAS-Berechtigungen

Beim Generieren einer SAS ist es erforderlich, die Berechtigungen anzugeben, die sie gew√§hren soll. Abh√§ngig vom Objekt, √ºber das die SAS generiert wird, k√∂nnen unterschiedliche Berechtigungen enthalten sein. Zum Beispiel:

* (a)dd, (c)reate, (d)elete, (e)xecute, (f)ilter\_by\_tags, (i)set\_immutability\_policy, (l)ist, (m)ove, (r)ead, (t)ag, (w)rite, (x)delete\_previous\_version, (y)permanent\_delete

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Dateifreigaben

{% content-ref url="az-file-shares.md" %}
[az-file-shares.md](az-file-shares.md)
{% endcontent-ref %}

## Privilegieneskalation

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## Nach der Ausnutzung

{% content-ref url="../az-post-exploitation/az-blob-storage-post-exploitation.md" %}
[az-blob-storage-post-exploitation.md](../az-post-exploitation/az-blob-storage-post-exploitation.md)
{% endcontent-ref %}

## Persistenz

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

## Referenzen

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
