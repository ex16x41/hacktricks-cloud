# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe Informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage to rozwizanie firmy Microsoft do **przechowywania obiekt贸w w chmurze**. Blob storage jest zoptymalizowane do przechowywania ogromnych iloci niestrukturalnych danych. Niestrukturalne dane to dane, kt贸re nie s zgodne z okrelonym modelem danych lub definicj, takie jak tekst lub dane binarne.

Blob storage oferuje trzy typy zasob贸w:

* **Konto magazynu** (unikalna nazwa)
* **Kontener** w koncie magazynu (folder)
* **Blob** w kontenerze

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### R贸偶ne typy magazynu

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Dostp do magazynu <a href="#about-blob-storage" id="about-blob-storage"></a>

* U偶yj Azure AD principals za pomoc **r贸l RBAC**.
* **Access Keys**: U偶yj kluczy dostpu do konta magazynu. To zapewnia **peny dostp do konta magazynu.**
* **Shared Access Signature** (SAS): **Ograniczony czasowo** i specyficzne uprawnienia.
* Mo偶esz wygenerowa URL SAS za pomoc **klucza dostpu** (trudniejsze do wykrycia).
* Poniewa偶 SAS jest generowany z klucza dostpu, jeli zostanie odnowiony, SAS przestaje dziaa.

### Publiczna ekspozycja

Jeli "Allow Blob public access" jest **wczone** (domylnie wyczone), mo偶liwe jest:

* Udzielenie **publicznego dostpu do odczytu blob贸w** (musisz zna nazw).
* **Lista blob贸w w kontenerze** i **odczyt** ich.

### Poczenie z magazynem

Jeli znajdziesz jakikolwiek **magazyn**, do kt贸rego mo偶esz si poczy, mo偶esz u偶y narzdzia [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/), aby to zrobi.

## SAS URLs

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Shared Access Signature (SAS) zapewnia bezpieczny delegowany dostp do zasob贸w w Twoim koncie magazynu. Dziki SAS masz szczeg贸ow kontrol nad tym, jak klient mo偶e uzyska dostp do Twoich danych. Na przykad:

* Jakie zasoby klient mo偶e uzyska.
* Jakie uprawnienia maj do tych zasob贸w.
* Jak dugo SAS jest wa偶ny.

URL SAS wyglda tak: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

U偶yj [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) do uzyskania dostpu do danych lub python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Mo偶esz **zabezpieczy token shared access signature (SAS)** do dostpu do kontenera, katalogu lub blobu, u偶ywajc powiadcze Azure Active Directory (Azure AD) **lub klucza konta**. Aby utworzy user delegation SAS, musisz najpierw za偶da **klucza delegacji u偶ytkownika**, kt贸rego nastpnie u偶ywasz do podpisania SAS.

Obsuga jest zapewniona dla **User Delegation Shared Access Signature (SAS)** zar贸wno w **Azure Blob Storage**, jak i **Azure Data Lake Storage Gen2**. Jednak偶e, nale偶y zauwa偶y, 偶e **Stored Access Policies** nie s kompatybilne z User Delegation SAS.

Nale偶y zauwa偶y, 偶e user delegation SAS jest **zabezpieczony powiadczeniami Azure AD zamiast kluczami konta storage**. To zapobiega przechowywaniu/pobieraniu kluczy storage przez klient贸w/aplikacje w celu tworzenia SAS.

### Service SAS

Service SAS jest zabezpieczony **kluczem konta storage**. Service SAS **deleguje dostp do zasobu tylko w jednej** z usug Azure Storage: Blob storage, Queue storage, Table storage lub Azure Files. URI dla service-level SAS skada si z URI do zasobu, do kt贸rego SAS bdzie delegowa dostp, a nastpnie tokenu SAS.

Aby u偶y powiadcze Azure Active Directory (Azure AD) do zabezpieczenia SAS dla **kontenera** lub **blobu**, u偶yj **user delegation SAS**.

### Account SAS

Account SAS jest zabezpieczony jednym z **kluczy konta storage** (s 2). Account SAS deleguje dostp do zasob贸w w jednej lub wicej usugach storage. Wszystkie operacje dostpne za pomoc service lub user delegation SAS s r贸wnie偶 dostpne za pomoc account SAS.

[z dokumentacji:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Tworzc account SAS, mo偶esz:

* Delegowa dostp do operacji na poziomie usugi, kt贸re nie s obecnie dostpne za pomoc service-specific SAS, takich jak operacje `Get/Set Service Properties` i `Get Service Stats`.
* Delegowa dostp do wicej ni偶 jednej usugi w koncie storage jednoczenie. Na przykad, mo偶esz delegowa dostp do zasob贸w zar贸wno w Azure Blob Storage, jak i Azure Files, u偶ywajc account SAS.
* Delegowa dostp do operacji zapisu i usuwania dla kontener贸w, kolejek, tabel i udzia贸w plik贸w, kt贸re nie s dostpne za pomoc object-specific SAS.
* Okreli adres IP lub zakres adres贸w IP, z kt贸rych bd akceptowane 偶dania.
* Okreli protok贸 HTTP, z kt贸rego bd akceptowane 偶dania (HTTPS lub HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Referencje

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Ucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
