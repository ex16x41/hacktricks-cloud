# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage ni suluhisho la **hifadhi ya vitu kwa wingu** kutoka Microsoft. Hifadhi ya blob imeandaliwa kwa ajili ya kuhifadhi kiasi kikubwa cha data zisizo na muundo. Data zisizo na muundo ni data ambayo haiwezi kufuata mfano maalum wa data au ufafanuzi, kama vile maandiko au data ya binary.

Hifadhi ya blob inatoa aina tatu za rasilimali:

* **akaunti ya hifadhi** (jina la kipekee)
* **konteina** katika akaunti ya hifadhi (folda)
* **blob** katika konteina

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Different types of storage

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Access to Storage <a href="#about-blob-storage" id="about-blob-storage"></a>

* Tumia wahusika wa Azure AD kupitia **RBAC roles** zinazoungwa mkono.
* **Funguo za Ufikiaji**: Tumia funguo za ufikiaji za akaunti ya hifadhi. Hii inatoa **ufikiaji kamili kwa akaunti ya hifadhi.**
* **Saini ya Ufikiaji Iliyojumuishwa** (SAS): **Muda** **uliowekwa** na ruhusa maalum.
* Unaweza kuunda url ya SAS kwa kutumia **funguo za ufikiaji** (ngumu zaidi kugundua).
* Kadri SAS inavyoundwa kutoka kwa funguo za ufikiaji, ikiwa itarejelewa SAS inakoma kufanya kazi.

### Public Exposure

Ikiwa "Ruhusu ufikiaji wa umma wa blob" ime **wezeshwa** (imezimwa kwa chaguo-msingi), inawezekana:

* Kutoa **ufikiaji wa umma kusoma blobs** (unahitaji kujua jina).
* **Orodhesha blobs za konteina** na **uzisome**.

### Connect to Storage

Ikiwa unapata **hifadhi** yoyote unayoweza kuunganishwa nayo unaweza kutumia chombo [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) kufanya hivyo.

## SAS URLs

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Saini ya ufikiaji iliyoshirikiwa (SAS) inatoa ufikiaji salama wa rasilimali katika akaunti yako ya hifadhi. Kwa SAS, una udhibiti wa kina juu ya jinsi mteja anaweza kufikia data yako. Kwa mfano:

* Rasilimali zipi mteja anaweza kufikia.
* Ni ruhusa zipi walizonazo kwa rasilimali hizo.
* SAS itakuwa halali kwa muda gani.

URL ya SAS inaonekana kama hii: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Tumia [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) kufikia data au python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Unaweza **kulinda saini ya ufikiaji wa pamoja (SAS)** kwa ajili ya ufikiaji wa kontena, saraka, au blob kwa kutumia **akili za Azure Active Directory (Azure AD) au ufunguo wa akaunti**. Ili kuunda user delegation SAS, lazima kwanza uombe **ufunguo wa uwakilishi wa mtumiaji**, ambao kisha utatumika kusaini SAS.

Msaada unapatikana kwa **User Delegation Shared Access Signature (SAS)** katika **Azure Blob Storage** na **Azure Data Lake Storage Gen2**. Hata hivyo, ni muhimu kutambua kwamba **Sera za Ufikiaji Zilizohifadhiwa** hazifai na User Delegation SAS.

Kumbuka kwamba user delegation SAS **imehifadhiwa kwa akili za Azure AD badala ya ufunguo wa akaunti ya hifadhi**. Hii inazuia wateja/programu kuhifadhi/kupata ufunguo wa hifadhi ili kuunda SAS.

### Service SAS

Service SAS imehifadhiwa kwa **ufunguo wa akaunti ya hifadhi**. Service SAS **inasimamia ufikiaji wa rasilimali katika moja tu** ya huduma za Azure Storage: Hifadhi ya Blob, Hifadhi ya Queue, Hifadhi ya Jedwali, au Faili za Azure. URI ya service-level SAS inajumuisha URI ya rasilimali ambayo SAS itasimamia ufikiaji, ikifuatiwa na token ya SAS.

Ili kutumia akili za Azure Active Directory (Azure AD) kulinda SAS kwa **kontena** au **blob**, tumia **user delegation SAS**.

### Account SAS

Account SAS imehifadhiwa kwa mmoja wa **ufunguo wa akaunti ya hifadhi** (kuna 2). Account SAS inasimamia ufikiaji wa rasilimali katika moja au zaidi ya huduma za hifadhi. Operesheni zote zinazopatikana kupitia service au user delegation SAS pia zinapatikana kupitia account SAS.

[from the docs:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Kwa kuunda account SAS, unaweza:

* Kuweka ufikiaji wa operesheni za kiwango cha huduma ambazo hazipatikani kwa sasa na service-specific SAS, kama vile `Get/Set Service Properties` na `Get Service Stats` operesheni.
* Kuweka ufikiaji wa huduma zaidi ya moja katika akaunti ya hifadhi kwa wakati mmoja. Kwa mfano, unaweza kuweka ufikiaji wa rasilimali katika Azure Blob Storage na Azure Files kwa kutumia account SAS.
* Kuweka ufikiaji wa operesheni za kuandika na kufuta kwa kontena, foleni, jedwali, na sehemu za faili, ambazo hazipatikani na object-specific SAS.
* Kuweka anwani ya IP au anuwai ya anwani za IP ambazo zitakubali maombi.
* Kuweka itifaki ya HTTP ambayo itakubali maombi (iwe HTTPS au HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## References

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **fuata** sisi kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za hacking kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
