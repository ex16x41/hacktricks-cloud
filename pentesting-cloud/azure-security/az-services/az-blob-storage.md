# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) O Azure Blob storage √© a solu√ß√£o de **armazenamento de objetos da Microsoft para a nuvem**. O armazenamento de blobs √© otimizado para armazenar grandes quantidades de dados n√£o estruturados. Dados n√£o estruturados s√£o dados que n√£o seguem um modelo ou defini√ß√£o de dados espec√≠ficos, como texto ou dados bin√°rios.

O armazenamento de blobs oferece tr√™s tipos de recursos:

* A **conta de armazenamento** (nome √∫nico)
* Um **container** na conta de armazenamento (pasta)
* Um **blob** em um container

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Different types of storage

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Access to Storage <a href="#about-blob-storage" id="about-blob-storage"></a>

* Use princ√≠pios do Azure AD via **fun√ß√µes RBAC** suportadas.
* **Chaves de Acesso**: Use chaves de acesso da conta de armazenamento. Isso fornece **acesso total √† conta de armazenamento.**
* **Assinatura de Acesso Compartilhado** (SAS): **Tempo** **limitado** e permiss√µes espec√≠ficas.
* Voc√™ pode gerar uma URL SAS com uma **chave de acesso** (mais complicado de detectar).
* Como a SAS √© gerada a partir da chave de acesso, se ela for renovada, a SAS para de funcionar.

### Public Exposure

Se "Permitir acesso p√∫blico a blobs" estiver **ativado** (desativado por padr√£o), √© poss√≠vel:

* Dar **acesso p√∫blico para ler blobs** (voc√™ precisa saber o nome).
* **Listar blobs do container** e **l√™-los**.

### Connect to Storage

Se voc√™ encontrar algum **armazenamento** ao qual possa se conectar, pode usar a ferramenta [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) para isso.

## SAS URLs

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Uma assinatura de acesso compartilhado (SAS) fornece acesso delegado seguro a recursos em sua conta de armazenamento. Com uma SAS, voc√™ tem controle granular sobre como um cliente pode acessar seus dados. Por exemplo:

* Quais recursos o cliente pode acessar.
* Quais permiss√µes eles t√™m sobre esses recursos.
* Quanto tempo a SAS √© v√°lida.

Uma URL SAS se parece com isso: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Use [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acessar os dados ou python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Voc√™ pode **proteger um token de assinatura de acesso compartilhado (SAS)** para acesso a um cont√™iner, diret√≥rio ou blob usando credenciais do Azure Active Directory (Azure AD) **ou uma chave de conta**. Para criar um SAS de delega√ß√£o de usu√°rio, voc√™ deve primeiro solicitar uma **chave de delega√ß√£o de usu√°rio**, que voc√™ usar√° para assinar o SAS.

O suporte √© fornecido para uma **Assinatura de Acesso Compartilhado de Delega√ß√£o de Usu√°rio (SAS)** tanto no **Azure Blob Storage** quanto no **Azure Data Lake Storage Gen2**. No entanto, √© importante notar que **Pol√≠ticas de Acesso Armazenadas** n√£o s√£o compat√≠veis com um SAS de Delega√ß√£o de Usu√°rio.

Observe que o SAS de delega√ß√£o de usu√°rio √© **protegido com credenciais do Azure AD em vez de chaves de conta de armazenamento**. Isso impede que clientes/aplica√ß√µes armazenem/recuperem chaves de armazenamento para criar SAS.

### Service SAS

Um service SAS √© protegido com a **chave da conta de armazenamento**. Um service SAS **delegates acesso a um recurso em apenas um** dos servi√ßos de Armazenamento do Azure: Armazenamento de Blobs, Armazenamento de Filas, Armazenamento de Tabelas ou Azure Files. O URI para um SAS de n√≠vel de servi√ßo consiste no URI do recurso para o qual o SAS delegar√° acesso, seguido pelo token SAS.

Para usar credenciais do Azure Active Directory (Azure AD) para proteger um SAS para um **cont√™iner** ou **blob**, use um **SAS de delega√ß√£o de usu√°rio**.

### Account SAS

Um account SAS √© protegido com uma das **chaves da conta de armazenamento** (existem 2). Um account SAS delega acesso a recursos em um ou mais dos servi√ßos de armazenamento. Todas as opera√ß√µes dispon√≠veis via um service ou user delegation SAS tamb√©m est√£o dispon√≠veis via um account SAS.

[from the docs:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Ao criar um account SAS, voc√™ pode:

* Delegar acesso a opera√ß√µes de n√≠vel de servi√ßo que n√£o est√£o atualmente dispon√≠veis com um SAS espec√≠fico de servi√ßo, como as opera√ß√µes `Get/Set Service Properties` e `Get Service Stats`.
* Delegar acesso a mais de um servi√ßo em uma conta de armazenamento ao mesmo tempo. Por exemplo, voc√™ pode delegar acesso a recursos tanto no Azure Blob Storage quanto no Azure Files usando um account SAS.
* Delegar acesso a opera√ß√µes de escrita e exclus√£o para cont√™ineres, filas, tabelas e compartilhamentos de arquivos, que n√£o est√£o dispon√≠veis com um SAS espec√≠fico de objeto.
* Especificar um endere√ßo IP ou um intervalo de endere√ßos IP dos quais aceitar solicita√ß√µes.
* Especificar o protocolo HTTP do qual aceitar solicita√ß√µes (seja HTTPS ou HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Refer√™ncias

* [https://learn.microsoft.com/pt-br/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/pt-br/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/pt-br/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/pt-br/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
