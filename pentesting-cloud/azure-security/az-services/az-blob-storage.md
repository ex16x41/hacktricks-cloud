# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage je Microsoftovo re≈°enje za **storage** u oblaku. Blob storage je optimizovan za skladi≈°tenje ogromnih koliƒçina nestrukturiranih podataka. Nestrukturirani podaci su podaci koji se ne pridr≈æavaju odreƒëenog modela podataka ili definicije, kao ≈°to su tekst ili binarni podaci.

Blob storage nudi tri vrste resursa:

* **storage account** (jedinstveno ime)
* **container** u storage account-u (folder)
* **blob** u container-u

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Different types of storage

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Access to Storage <a href="#about-blob-storage" id="about-blob-storage"></a>

* Koristite Azure AD principe putem **RBAC uloga** koje su podr≈æane.
* **Access Keys**: Koristite pristupne kljuƒçeve storage account-a. Ovo pru≈æa **potpun pristup storage account-u.**
* **Shared Access Signature** (SAS): **Vremenski** **ograniƒçene** i specifiƒçne dozvole.
* Mo≈æete generisati SAS URL sa **pristupnim kljuƒçem** (komplikovanije za otkrivanje).
* Kako se SAS generi≈°e iz pristupnog kljuƒça, ako se obnovi, SAS prestaje da funkcioni≈°e.

### Public Exposure

Ako je "Allow Blob public access" **omoguƒáeno** (podrazumevano je onemoguƒáeno), moguƒáe je:

* Dati **javne pristupe za ƒçitanje blob-ova** (morate znati ime).
* **Lista blob-ova u container-u** i **ƒçitati** ih.

### Connect to Storage

Ako pronaƒëete bilo koji **storage** na koji mo≈æete da se pove≈æete, mo≈æete koristiti alat [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) za to.

## SAS URLs

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Shared access signature (SAS) pru≈æa siguran delegirani pristup resursima u va≈°em storage account-u. Sa SAS-om, imate granularnu kontrolu nad tim kako klijent mo≈æe pristupiti va≈°im podacima. Na primer:

* Koje resurse klijent mo≈æe da pristupi.
* Koje dozvole imaju za te resurse.
* Koliko dugo je SAS va≈æeƒái.

SAS URL izgleda ovako: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Koristite [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) za pristup podacima ili python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Mo≈æete **osigurati token za deljenu pristupnu potpis (SAS)** za pristup kontejneru, direktorijumu ili blobu koristeƒái ili Azure Active Directory (Azure AD) **akreditive ili kljuƒç naloga**. Da biste kreirali user delegation SAS, prvo morate zatra≈æiti **kljuƒç za delegaciju korisnika**, koji zatim koristite za potpisivanje SAS-a.

Podr≈°ka je obezbeƒëena za **User Delegation Shared Access Signature (SAS)** u **Azure Blob Storage** i **Azure Data Lake Storage Gen2**. Meƒëutim, va≈æno je napomenuti da **Stored Access Policies** nisu kompatibilne sa User Delegation SAS.

Napomena da je user delegation SAS **osiguran sa Azure AD akreditivima umesto kljuƒçeva za skladi≈°ni nalog**. Ovo spreƒçava klijente/aplikacije da ƒçuvaju/izvode kljuƒçeve za skladi≈°tenje kako bi kreirali SAS.

### Service SAS

Service SAS je osiguran sa **kljuƒçem skladi≈°nog naloga**. Service SAS **delegira pristup resursu samo u jednom** od Azure Storage servisa: Blob storage, Queue storage, Table storage ili Azure Files. URI za service-level SAS se sastoji od URI-ja resursa za koji ƒáe SAS delegirati pristup, praƒáenog SAS tokenom.

Da biste koristili Azure Active Directory (Azure AD) akreditive za osiguranje SAS-a za **kontejner** ili **blob**, koristite **user delegation SAS**.

### Account SAS

Account SAS je osiguran sa jednim od **kljuƒçeva skladi≈°nog naloga** (ima ih 2). Account SAS delegira pristup resursima u jednom ili vi≈°e skladi≈°nih servisa. Sve operacije dostupne putem service ili user delegation SAS su takoƒëe dostupne putem account SAS.

[from the docs:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Kreiranjem account SAS, mo≈æete:

* Delegirati pristup operacijama na nivou servisa koje trenutno nisu dostupne sa service-specific SAS, kao ≈°to su `Get/Set Service Properties` i `Get Service Stats` operacije.
* Delegirati pristup vi≈°e od jednog servisa u skladi≈°nom nalogu u isto vreme. Na primer, mo≈æete delegirati pristup resursima u Azure Blob Storage i Azure Files koristeƒái account SAS.
* Delegirati pristup operacijama pisanja i brisanja za kontejnere, redove, tabele i deljene datoteke, koje nisu dostupne sa object-specific SAS.
* Odrediti IP adresu ili opseg IP adresa sa kojih ƒáe se prihvatati zahtevi.
* Odrediti HTTP protokol sa kojeg ƒáe se prihvatati zahtevi (bilo HTTPS ili HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Reference

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Uƒçite i ve≈æbajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Uƒçite i ve≈æbajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
