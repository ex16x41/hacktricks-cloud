# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

[Belgelerden:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob depolama, Microsoft'un **bulut için nesne depolama çözümüdür**. Blob depolama, büyük miktarda yapılandırılmamış veriyi depolamak için optimize edilmiştir. Yapılandırılmamış veri, belirli bir veri modeline veya tanımına uymayan veridir; örneğin metin veya ikili veri.

Blob depolama üç tür kaynak sunar:

* **Depolama hesabı** (benzersiz ad)
* Depolama hesabındaki bir **kapsayıcı** (klasör)
* Bir kapsayıcıdaki bir **blob**

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Farklı depolama türleri

| **Blob depolama**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Depolama Erişimi <a href="#about-blob-storage" id="about-blob-storage"></a>

* **RBAC rolleri** aracılığıyla Azure AD ilkelerini kullanın.
* **Erişim Anahtarları**: Depolama hesabının erişim anahtarlarını kullanın. Bu, **depolama hesabına tam erişim sağlar.**
* **Paylaşılan Erişim İmzası** (SAS): **Zaman** **sınırlı** ve belirli izinler.
* Bir **erişim anahtarı** ile bir SAS URL'si oluşturabilirsiniz (tespit edilmesi daha karmaşık).
* SAS, erişim anahtarından oluşturulduğundan, eğer yenilenirse SAS çalışmayı durdurur.

### Kamuya Açıklık

"Blob kamu erişimini izin ver" **etkinleştirildiğinde** (varsayılan olarak devre dışı), aşağıdakiler mümkündür:

* **Blob'ları okumak için kamu erişimi vermek** (adını bilmeniz gerekir).
* **Kapsayıcı blob'larını listelemek** ve **okumak**.

### Depolamaya Bağlanma

Herhangi bir **depolama** bulursanız, bunu yapmak için [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) aracını kullanabilirsiniz.

## SAS URL'leri

[Belgelerden:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Paylaşılan erişim imzası (SAS), depolama hesabınızdaki kaynaklara güvenli bir şekilde yetkilendirilmiş erişim sağlar. Bir SAS ile, bir istemcinin verilerinize nasıl erişebileceği üzerinde ayrıntılı kontrol sahibi olursunuz. Örneğin:

* İstemcinin erişebileceği kaynaklar.
* Bu kaynaklara sahip oldukları izinler.
* SAS'ın ne kadar süre geçerli olduğu.

Bir SAS URL'si şu şekilde görünür: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Verilere erişmek için [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) veya python kullanın:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### Kullanıcı Delegasyonu SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Bir konteynere, dizine veya blob'a erişim için **paylaşılan erişim imzası (SAS)** token'ını, Azure Active Directory (Azure AD) **kimlik bilgileri veya bir hesap anahtarı** kullanarak **güvence altına alabilirsiniz**. Bir kullanıcı delegasyonu SAS oluşturmak için önce bir **kullanıcı delegasyonu anahtarı** talep etmelisiniz, ardından bu anahtarı SAS'ı imzalamak için kullanmalısınız.

**Azure Blob Storage** ve **Azure Data Lake Storage Gen2**'de **Kullanıcı Delegasyonu Paylaşılan Erişim İmzası (SAS)** desteği sağlanmaktadır. Ancak, **Saklanan Erişim Politikaları**nın bir Kullanıcı Delegasyonu SAS ile uyumlu olmadığını belirtmek önemlidir.

Kullanıcı delegasyonu SAS'ın **depolama hesap anahtarları yerine Azure AD kimlik bilgileri ile güvence altına alındığını** unutmayın. Bu, istemcilerin/uygulamaların SAS oluşturmak için depolama anahtarlarını saklamasını/almalarını engeller.

### Servis SAS

Bir servis SAS, **depolama hesap anahtarı** ile güvence altına alınır. Bir servis SAS, Azure Depolama hizmetlerinden yalnızca birine ait bir kaynağa erişimi **delege eder**: Blob depolama, Kuyruk depolama, Tablo depolama veya Azure Dosyaları. Bir servis düzeyindeki SAS için URI, SAS'ın erişimi delege edeceği kaynağın URI'sini ve ardından SAS token'ını içerir.

Bir **konteyner** veya **blob** için SAS'ı güvence altına almak üzere Azure Active Directory (Azure AD) kimlik bilgilerini kullanmak için bir **kullanıcı delegasyonu SAS** kullanın.

### Hesap SAS

Bir hesap SAS, **depolama hesap anahtarlarından** biri ile güvence altına alınır (2 tane vardır). Bir hesap SAS, bir veya daha fazla depolama hizmetindeki kaynaklara erişimi delege eder. Bir servis veya kullanıcı delegasyonu SAS aracılığıyla mevcut olan tüm işlemler, bir hesap SAS aracılığıyla da mevcuttur.

[dokümanlardan:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Bir hesap SAS oluşturarak şunları yapabilirsiniz:

* `Get/Set Service Properties` ve `Get Service Stats` işlemleri gibi şu anda bir servis özel SAS ile mevcut olmayan servis düzeyindeki işlemlere erişimi delege edin.
* Bir depolama hesabındaki birden fazla servise aynı anda erişimi delege edin. Örneğin, bir hesap SAS kullanarak hem Azure Blob Storage hem de Azure Dosyaları'ndaki kaynaklara erişimi delege edebilirsiniz.
* Nesneye özel bir SAS ile mevcut olmayan konteynerler, kuyruklar, tablolar ve dosya paylaşımları için yazma ve silme işlemlerine erişimi delege edin.
* Talepleri kabul etmek için bir IP adresi veya IP adresleri aralığı belirtin.
* Talepleri kabul etmek için HTTP protokolünü belirtin (ya HTTPS ya da HTTP/HTTPS).

## Sayım

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Referanslar

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter**'da **bizi takip edin** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
