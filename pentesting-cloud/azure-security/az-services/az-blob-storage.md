# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage æ˜¯å¾®è½¯çš„äº‘å¯¹è±¡**å­˜å‚¨è§£å†³æ–¹æ¡ˆ**ã€‚Blob å­˜å‚¨é’ˆå¯¹å­˜å‚¨å¤§é‡éç»“æ„åŒ–æ•°æ®è¿›è¡Œäº†ä¼˜åŒ–ã€‚éç»“æ„åŒ–æ•°æ®æ˜¯æŒ‡ä¸éµå¾ªç‰¹å®šæ•°æ®æ¨¡å‹æˆ–å®šä¹‰çš„æ•°æ®ï¼Œä¾‹å¦‚æ–‡æœ¬æˆ–äºŒè¿›åˆ¶æ•°æ®ã€‚

Blob å­˜å‚¨æä¾›ä¸‰ç§ç±»å‹çš„èµ„æºï¼š

* **å­˜å‚¨è´¦æˆ·**ï¼ˆå”¯ä¸€åç§°ï¼‰
* å­˜å‚¨è´¦æˆ·ä¸­çš„**å®¹å™¨**ï¼ˆæ–‡ä»¶å¤¹ï¼‰
* å®¹å™¨ä¸­çš„**Blob**

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### ä¸åŒç±»å‹çš„å­˜å‚¨

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### è®¿é—®å­˜å‚¨ <a href="#about-blob-storage" id="about-blob-storage"></a>

* ä½¿ç”¨ Azure AD ä¸»ä½“é€šè¿‡æ”¯æŒçš„**RBAC è§’è‰²**ã€‚
* **è®¿é—®å¯†é’¥**ï¼šä½¿ç”¨å­˜å‚¨è´¦æˆ·çš„è®¿é—®å¯†é’¥ã€‚è¿™æä¾›äº†å¯¹å­˜å‚¨è´¦æˆ·çš„**å®Œå…¨è®¿é—®**ã€‚
* **å…±äº«è®¿é—®ç­¾å**ï¼ˆSASï¼‰ï¼š**æ—¶é—´****æœ‰é™**å’Œç‰¹å®šæƒé™ã€‚
* æ‚¨å¯ä»¥ä½¿ç”¨**è®¿é—®å¯†é’¥**ç”Ÿæˆ SAS URLï¼ˆæ›´éš¾æ£€æµ‹ï¼‰ã€‚
* ç”±äº SAS æ˜¯ä»è®¿é—®å¯†é’¥ç”Ÿæˆçš„ï¼Œå¦‚æœå®ƒè¢«æ›´æ–°ï¼ŒSAS å°†åœæ­¢å·¥ä½œã€‚

### å…¬å¼€æš´éœ²

å¦‚æœâ€œå…è®¸ Blob å…¬å¼€è®¿é—®â€**å¯ç”¨**ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰ï¼Œåˆ™å¯ä»¥ï¼š

* ç»™äºˆ**è¯»å– Blob çš„å…¬å…±è®¿é—®æƒé™**ï¼ˆæ‚¨éœ€è¦çŸ¥é“åç§°ï¼‰ã€‚
* **åˆ—å‡ºå®¹å™¨ Blob**å¹¶**è¯»å–**å®ƒä»¬ã€‚

### è¿æ¥åˆ°å­˜å‚¨

å¦‚æœæ‚¨æ‰¾åˆ°ä»»ä½•å¯ä»¥è¿æ¥çš„**å­˜å‚¨**ï¼Œå¯ä»¥ä½¿ç”¨å·¥å…· [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) è¿›è¡Œè¿æ¥ã€‚

## SAS URLs

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) å…±äº«è®¿é—®ç­¾åï¼ˆSASï¼‰ä¸ºå­˜å‚¨è´¦æˆ·ä¸­çš„èµ„æºæä¾›å®‰å…¨çš„å§”æ‰˜è®¿é—®ã€‚ä½¿ç”¨ SASï¼Œæ‚¨å¯ä»¥å¯¹å®¢æˆ·ç«¯å¦‚ä½•è®¿é—®æ‚¨çš„æ•°æ®è¿›è¡Œç»†ç²’åº¦æ§åˆ¶ã€‚ä¾‹å¦‚ï¼š

* å®¢æˆ·ç«¯å¯ä»¥è®¿é—®å“ªäº›èµ„æºã€‚
* ä»–ä»¬å¯¹è¿™äº›èµ„æºæœ‰ä»€ä¹ˆæƒé™ã€‚
* SAS æœ‰æ•ˆçš„æ—¶é—´ã€‚

ä¸€ä¸ª SAS URL çœ‹èµ·æ¥åƒè¿™æ ·ï¼š**`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

ä½¿ç”¨ [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) è®¿é—®æ•°æ®æˆ–ä½¿ç”¨ python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

ä½ å¯ä»¥ä½¿ç”¨ Azure Active Directory (Azure AD) **å‡­è¯æˆ–è´¦æˆ·å¯†é’¥**æ¥**ä¿æŠ¤å…±äº«è®¿é—®ç­¾å (SAS)** ä»¤ç‰Œï¼Œä»¥è®¿é—®å®¹å™¨ã€ç›®å½•æˆ– blobã€‚è¦åˆ›å»ºç”¨æˆ·å§”æ‰˜ SASï¼Œå¿…é¡»é¦–å…ˆè¯·æ±‚**ç”¨æˆ·å§”æ‰˜å¯†é’¥**ï¼Œç„¶åä½¿ç”¨è¯¥å¯†é’¥ç­¾ç½² SASã€‚

åœ¨ **Azure Blob Storage** å’Œ **Azure Data Lake Storage Gen2** ä¸­å‡æ”¯æŒ**ç”¨æˆ·å§”æ‰˜å…±äº«è®¿é—®ç­¾å (SAS)**ã€‚ç„¶è€Œï¼Œé‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œ**å­˜å‚¨è®¿é—®ç­–ç•¥**ä¸ç”¨æˆ·å§”æ‰˜ SAS ä¸å…¼å®¹ã€‚

è¯·æ³¨æ„ï¼Œç”¨æˆ·å§”æ‰˜ SAS æ˜¯**ä½¿ç”¨ Azure AD å‡­è¯è€Œä¸æ˜¯å­˜å‚¨è´¦æˆ·å¯†é’¥**æ¥ä¿æŠ¤çš„ã€‚è¿™é˜²æ­¢äº†å®¢æˆ·ç«¯/åº”ç”¨ç¨‹åºå­˜å‚¨/æ£€ç´¢å­˜å‚¨å¯†é’¥ä»¥åˆ›å»º SASã€‚

### Service SAS

æœåŠ¡ SAS æ˜¯ç”¨**å­˜å‚¨è´¦æˆ·å¯†é’¥**ä¿æŠ¤çš„ã€‚æœåŠ¡ SAS **ä»…å§”æ‰˜å¯¹ Azure å­˜å‚¨æœåŠ¡ä¹‹ä¸€çš„èµ„æºçš„è®¿é—®**ï¼šBlob å­˜å‚¨ã€é˜Ÿåˆ—å­˜å‚¨ã€è¡¨å­˜å‚¨æˆ– Azure æ–‡ä»¶ã€‚æœåŠ¡çº§åˆ« SAS çš„ URI ç”±å°†å§”æ‰˜è®¿é—®çš„èµ„æºçš„ URI ä»¥åŠ SAS ä»¤ç‰Œç»„æˆã€‚

è¦ä½¿ç”¨ Azure Active Directory (Azure AD) å‡­è¯æ¥ä¿æŠ¤**å®¹å™¨**æˆ–**blob**çš„ SASï¼Œè¯·ä½¿ç”¨**ç”¨æˆ·å§”æ‰˜ SAS**ã€‚

### Account SAS

è´¦æˆ· SAS æ˜¯ç”¨ä¸¤ä¸ª**å­˜å‚¨è´¦æˆ·å¯†é’¥**ä¸­çš„ä¸€ä¸ªä¿æŠ¤çš„ã€‚è´¦æˆ· SAS å§”æ‰˜å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªå­˜å‚¨æœåŠ¡ä¸­çš„èµ„æºçš„è®¿é—®ã€‚é€šè¿‡æœåŠ¡æˆ–ç”¨æˆ·å§”æ‰˜ SAS å¯ç”¨çš„æ‰€æœ‰æ“ä½œä¹Ÿå¯ä»¥é€šè¿‡è´¦æˆ· SAS è¿›è¡Œã€‚

[æ¥è‡ªæ–‡æ¡£ï¼š](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) é€šè¿‡åˆ›å»ºè´¦æˆ· SASï¼Œä½ å¯ä»¥ï¼š

* å§”æ‰˜å¯¹å½“å‰æ— æ³•é€šè¿‡ç‰¹å®šæœåŠ¡ SAS è¿›è¡Œçš„æœåŠ¡çº§æ“ä½œçš„è®¿é—®ï¼Œä¾‹å¦‚ `Get/Set Service Properties` å’Œ `Get Service Stats` æ“ä½œã€‚
* åŒæ—¶å§”æ‰˜å¯¹å­˜å‚¨è´¦æˆ·ä¸­å¤šä¸ªæœåŠ¡çš„è®¿é—®ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨è´¦æˆ· SAS å§”æ‰˜å¯¹ Azure Blob Storage å’Œ Azure Files ä¸­èµ„æºçš„è®¿é—®ã€‚
* å§”æ‰˜å¯¹å®¹å™¨ã€é˜Ÿåˆ—ã€è¡¨å’Œæ–‡ä»¶å…±äº«çš„å†™å…¥å’Œåˆ é™¤æ“ä½œçš„è®¿é—®ï¼Œè¿™äº›æ“ä½œæ— æ³•é€šè¿‡ç‰¹å®šå¯¹è±¡ SAS è¿›è¡Œã€‚
* æŒ‡å®šæ¥å—è¯·æ±‚çš„ IP åœ°å€æˆ– IP åœ°å€èŒƒå›´ã€‚
* æŒ‡å®šæ¥å—è¯·æ±‚çš„ HTTP åè®®ï¼ˆHTTPS æˆ– HTTP/HTTPSï¼‰ã€‚

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº« hacking æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
