# Az - Blob Storage

{% hint style="success" %}
Nau캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne Informacije

[Iz dokumentacije:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage je Microsoftovo re코enje za **skladi코tenje objekata u oblaku**. Blob storage je optimizovan za 캜uvanje ogromnih koli캜ina nestrukturiranih podataka. Nestrukturirani podaci su podaci koji ne prate odre캠eni model podataka ili definiciju, kao 코to su tekstualni ili binarni podaci.

Blob storage nudi tri tipa resursa:

* **Skladi코ni nalog** (jedinstveno ime)
* **Kontejner** u skladi코nom nalogu (folder)
* **Blob** u kontejneru

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Razli캜iti tipovi skladi코ta

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Pristup Skladi코tu <a href="#about-blob-storage" id="about-blob-storage"></a>

* Koristite Azure AD entitete putem **RBAC uloga** koje su podr쬬ne.
* **Klju캜evi za pristup**: Koristite klju캜eve za pristup skladi코nom nalogu. Ovo omogu캖ava **potpun pristup skladi코nom nalogu.**
* **Shared Access Signature** (SAS): **Vremenski** **ograni캜en** i specifi캜ne dozvole.
* Mo쬰te generisati SAS url sa **klju캜em za pristup** (te쬰 za detekciju).
* Po코to se SAS generi코e iz klju캜a za pristup, ako se on obnovi, SAS prestaje da radi.

### Javno Izlaganje

Ako je "Dozvoli javni pristup Blob-u" **omogu캖eno** (onemogu캖eno po defaultu), mogu캖e je:

* Dati **javni pristup za 캜itanje blob-ova** (potrebno je znati ime).
* **Listati blob-ove u kontejneru** i **캜itati** ih.

### Povezivanje sa Skladi코tem

Ako prona캠ete bilo koje **skladi코te** na koje mo쬰te da se pove쬰te, mo쬰te koristiti alat [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) za to.

## SAS URL-ovi

[Iz dokumentacije:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Shared access signature (SAS) pru쬬 siguran delegirani pristup resursima u va코em skladi코nom nalogu. Sa SAS-om, imate granularnu kontrolu nad time kako klijent mo쬰 pristupiti va코im podacima. Na primer:

* Koje resurse klijent mo쬰 da pristupi.
* Koje dozvole imaju za te resurse.
* Koliko dugo je SAS va쬰캖i.

SAS URL izgleda ovako: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Koristite [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) za pristup podacima ili python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Mo쬰te **osigurati token za deljeni pristup (SAS)** za pristup kontejneru, direktorijumu ili blob-u koriste캖i ili Azure Active Directory (Azure AD) **akreditive ili klju캜 naloga**. Da biste kreirali SAS za delegaciju korisnika, prvo morate zatra쬴ti **klju캜 za delegaciju korisnika**, koji zatim koristite za potpisivanje SAS-a.

Podr코ka je obezbe캠ena za **User Delegation Shared Access Signature (SAS)** u oba **Azure Blob Storage** i **Azure Data Lake Storage Gen2**. Me캠utim, va쬹o je napomenuti da **Stored Access Policies** nisu kompatibilne sa SAS-om za delegaciju korisnika.

Napomena da je SAS za delegaciju korisnika **osiguran sa Azure AD akreditivima umesto klju캜eva skladi코nog naloga**. Ovo spre캜ava klijente/aplikacije da skladi코te/preuzimaju klju캜eve skladi코ta za kreiranje SAS-a.

### Service SAS

Service SAS je osiguran sa **klju캜em skladi코nog naloga**. Service SAS **delegira pristup resursu u samo jednoj** od Azure Storage usluga: Blob storage, Queue storage, Table storage, ili Azure Files. URI za service-level SAS se sastoji od URI-ja do resursa za koji 캖e SAS delegirati pristup, pra캖en SAS tokenom.

Da biste koristili Azure Active Directory (Azure AD) akreditive za osiguranje SAS-a za **kontejner** ili **blob**, koristite **user delegation SAS**.

### Account SAS

Account SAS je osiguran sa jednim od **klju캜eva skladi코nog naloga** (postoje 2). Account SAS delegira pristup resursima u jednoj ili vi코e skladi코nih usluga. Sve operacije dostupne putem service ili user delegation SAS-a su tako캠e dostupne putem account SAS-a.

[iz dokumenata:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Kreiranjem account SAS-a, mo쬰te:

* Delegirati pristup operacijama na nivou usluge koje trenutno nisu dostupne sa specifi캜nim SAS-om za uslugu, kao 코to su `Get/Set Service Properties` i `Get Service Stats` operacije.
* Delegirati pristup vi코e od jedne usluge u skladi코nom nalogu istovremeno. Na primer, mo쬰te delegirati pristup resursima u oba Azure Blob Storage i Azure Files koriste캖i account SAS.
* Delegirati pristup operacijama pisanja i brisanja za kontejnere, redove, tabele i deljene datoteke, koje nisu dostupne sa SAS-om specifi캜nim za objekat.
* Specifikovati IP adresu ili opseg IP adresa sa kojih 캖e se prihvatati zahtevi.
* Specifikovati HTTP protokol sa kojeg 캖e se prihvatati zahtevi (bilo HTTPS ili HTTP/HTTPS).

## Enumeracija

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Reference

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Nau캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
