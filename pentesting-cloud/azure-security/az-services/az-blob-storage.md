# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Το Azure Blob storage είναι η λύση **αποθήκευσης αντικειμένων της Microsoft για το cloud**. Η αποθήκευση Blob είναι βελτιστοποιημένη για την αποθήκευση τεράστιων ποσοτήτων μη δομημένων δεδομένων. Τα μη δομημένα δεδομένα είναι δεδομένα που δεν ακολουθούν ένα συγκεκριμένο μοντέλο ή ορισμό δεδομένων, όπως κείμενο ή δυαδικά δεδομένα.

Η αποθήκευση Blob προσφέρει τρεις τύπους πόρων:

* Ο **λογαριασμός αποθήκευσης** (μοναδικό όνομα)
* Ένα **δοχείο** στον λογαριασμό αποθήκευσης (φάκελος)
* Ένα **blob** σε ένα δοχείο

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Different types of storage

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Access to Storage <a href="#about-blob-storage" id="about-blob-storage"></a>

* Χρησιμοποιήστε τους κύριους Azure AD μέσω **ρόλων RBAC** που υποστηρίζονται.
* **Access Keys**: Χρησιμοποιήστε τα κλειδιά πρόσβασης του λογαριασμού αποθήκευσης. Αυτό παρέχει **πλήρη πρόσβαση στον λογαριασμό αποθήκευσης.**
* **Shared Access Signature** (SAS): **Περιορισμένος** **χρόνος** και συγκεκριμένες άδειες.
* Μπορείτε να δημιουργήσετε ένα URL SAS με ένα **access key** (πιο περίπλοκο να ανιχνευθεί).
* Καθώς το SAS δημιουργείται από το access key, αν ανανεωθεί, το SAS σταματά να λειτουργεί.

### Public Exposure

Εάν η "Επιτρέψτε δημόσια πρόσβαση σε Blob" είναι **ενεργοποιημένη** (απενεργοποιημένη από προεπιλογή), είναι δυνατόν να:

* Δώσετε **δημόσια πρόσβαση για ανάγνωση blobs** (πρέπει να γνωρίζετε το όνομα).
* **Λίστα blobs δοχείου** και **να τα διαβάσετε**.

### Connect to Storage

Εάν βρείτε οποιαδήποτε **αποθήκευση** στην οποία μπορείτε να συνδεθείτε, μπορείτε να χρησιμοποιήσετε το εργαλείο [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) για να το κάνετε αυτό.

## SAS URLs

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Μια υπογραφή κοινής πρόσβασης (SAS) παρέχει ασφαλή εξουσιοδοτημένη πρόσβαση σε πόρους στον λογαριασμό αποθήκευσής σας. Με ένα SAS, έχετε λεπτομερή έλεγχο σχετικά με το πώς μπορεί ένας πελάτης να έχει πρόσβαση στα δεδομένα σας. Για παράδειγμα:

* Ποιοι πόροι μπορεί να έχει πρόσβαση ο πελάτης.
* Ποιες άδειες έχει σε αυτούς τους πόρους.
* Πόσο καιρό είναι έγκυρο το SAS.

Ένα URL SAS μοιάζει με αυτό: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Χρησιμοποιήστε [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) για να αποκτήσετε πρόσβαση στα δεδομένα ή python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Μπορείτε να **ασφαλίσετε ένα κοινόχρηστο υπογραφή πρόσβασης (SAS)** για πρόσβαση σε ένα κοντέινερ, κατάλογο ή blob χρησιμοποιώντας είτε τα **διαπιστευτήρια Azure Active Directory (Azure AD)** είτε ένα **κλειδί λογαριασμού**. Για να δημιουργήσετε ένα user delegation SAS, πρέπει πρώτα να ζητήσετε ένα **κλειδί εξουσιοδότησης χρήστη**, το οποίο στη συνέχεια χρησιμοποιείτε για να υπογράψετε το SAS.

Υποστηρίζεται ένα **User Delegation Shared Access Signature (SAS)** τόσο στο **Azure Blob Storage** όσο και στο **Azure Data Lake Storage Gen2**. Ωστόσο, είναι σημαντικό να σημειωθεί ότι οι **Αποθηκευμένες Πολιτικές Πρόσβασης** δεν είναι συμβατές με ένα User Delegation SAS.

Σημειώστε ότι το user delegation SAS είναι **ασφαλισμένο με διαπιστευτήρια Azure AD αντί για κλειδιά λογαριασμού αποθήκευσης**. Αυτό αποτρέπει τους πελάτες/εφαρμογές από το να αποθηκεύουν/ανακτούν κλειδιά αποθήκευσης για να δημιουργήσουν SAS.

### Service SAS

Ένα service SAS είναι ασφαλισμένο με το **κλειδί λογαριασμού αποθήκευσης**. Ένα service SAS **εξουσιοδοτεί πρόσβαση σε έναν πόρο μόνο σε μία** από τις υπηρεσίες Azure Storage: Blob storage, Queue storage, Table storage ή Azure Files. Το URI για ένα service-level SAS αποτελείται από το URI του πόρου για τον οποίο το SAS θα εξουσιοδοτήσει πρόσβαση, ακολουθούμενο από το SAS token.

Για να χρησιμοποιήσετε τα διαπιστευτήρια Azure Active Directory (Azure AD) για να ασφαλίσετε ένα SAS για ένα **κοντέινερ** ή **blob**, χρησιμοποιήστε ένα **user delegation SAS**.

### Account SAS

Ένα account SAS είναι ασφαλισμένο με ένα από τα **κλειδιά λογαριασμού αποθήκευσης** (υπάρχουν 2). Ένα account SAS εξουσιοδοτεί πρόσβαση σε πόρους σε μία ή περισσότερες από τις υπηρεσίες αποθήκευσης. Όλες οι λειτουργίες που είναι διαθέσιμες μέσω ενός service ή user delegation SAS είναι επίσης διαθέσιμες μέσω ενός account SAS.

[from the docs:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Δημιουργώντας ένα account SAS, μπορείτε να:

* Εξουσιοδοτήσετε πρόσβαση σε λειτουργίες επιπέδου υπηρεσίας που δεν είναι διαθέσιμες αυτή τη στιγμή με ένα service-specific SAS, όπως οι λειτουργίες `Get/Set Service Properties` και `Get Service Stats`.
* Εξουσιοδοτήσετε πρόσβαση σε περισσότερες από μία υπηρεσίες σε έναν λογαριασμό αποθήκευσης ταυτόχρονα. Για παράδειγμα, μπορείτε να εξουσιοδοτήσετε πρόσβαση σε πόρους τόσο στο Azure Blob Storage όσο και στο Azure Files χρησιμοποιώντας ένα account SAS.
* Εξουσιοδοτήσετε πρόσβαση σε λειτουργίες εγγραφής και διαγραφής για κοντέινερ, ουρές, πίνακες και κοινές χρήσεις αρχείων, οι οποίες δεν είναι διαθέσιμες με ένα object-specific SAS.
* Προσδιορίσετε μια διεύθυνση IP ή μια σειρά διευθύνσεων IP από τις οποίες να γίνονται αποδεκτά τα αιτήματα.
* Προσδιορίσετε το πρωτόκολλο HTTP από το οποίο να γίνονται αποδεκτά τα αιτήματα (είτε HTTPS είτε HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Αναφορές

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
