# Az - Blob Storage

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage to rozwizanie **przechowywania obiekt贸w firmy Microsoft dla chmury**. Blob storage jest zoptymalizowany do przechowywania ogromnych iloci danych niestrukturyzowanych. Dane niestrukturyzowane to dane, kt贸re nie podlegaj okrelonemu modelowi danych ani definicji, takie jak dane tekstowe lub binarne.

Blob storage oferuje trzy rodzaje zasob贸w:

* **Konto przechowywania** (unikalna nazwa)
* **Kontener** w koncie przechowywania (folder)
* **Blob** w kontenerze

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### R贸偶ne rodzaje przechowywania

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Dostp do przechowywania <a href="#about-blob-storage" id="about-blob-storage"></a>

* U偶yj podmiot贸w Azure AD za pomoc obsugiwanych r贸l **RBAC**.
* **Klucze dostpu**: U偶yj kluczy dostpu do konta przechowywania. Zapewnia to **peny dostp do konta przechowywania**.
* **Wsp贸lny podpis dostpu** (SAS): **Ograniczony czasowo** i okrelone uprawnienia.
* Mo偶esz wygenerowa adres URL SAS z **kluczem dostpu** (trudniejszy do wykrycia).
* Poniewa偶 SAS jest generowany z klucza dostpu, jeli zostanie odnowiony, SAS przestaje dziaa.

### Publiczne wystawienie

Jeli opcja "Zezwalaj na publiczny dostp do blob贸w" jest **wczona** (domylnie wyczona), mo偶na:

* Udzieli **publicznego dostpu do odczytu blob贸w** (musisz zna nazw).
* **Wywietli bloby kontenera** i **odczyta** je.

### Poczenie z przechowywaniem

Jeli znajdziesz jakie **przechowywanie**, do kt贸rego mo偶esz si podczy, mo偶esz u偶y narzdzia [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) do tego celu.

## Adresy URL SAS

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Wsp贸lny podpis dostpu (SAS) zapewnia bezpieczny udzielony dostp do zasob贸w w twoim koncie przechowywania. Dziki SAS masz szczeg贸ow kontrol nad tym, w jaki spos贸b klient mo偶e uzyska dostp do Twoich danych. Na przykad:

* Do jakich zasob贸w klient mo偶e uzyska dostp.
* Jakie uprawnienia maj do tych zasob贸w.
* Jak dugo jest wa偶ny SAS.

Adres URL SAS wyglda tak: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

U偶yj [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) do dostpu do danych lub python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### Delegacja SAS u偶ytkownika <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Mo偶esz **zabezpieczy token udostpnionego podpisu dostpu (SAS)** do kontenera, katalogu lub bloba, korzystajc zar贸wno z **powiadcze Azure Active Directory (Azure AD), jak i klucza konta**. Aby utworzy delegowanego SAS u偶ytkownika, musisz najpierw poprosi o **klucz delegacji u偶ytkownika**, kt贸ry nastpnie u偶ywasz do podpisania SAS.

Obsuga **Delegowanego Udostpnionego Podpisu Dostpu (SAS)** jest dostpna zar贸wno w **Azure Blob Storage**, jak i w **Azure Data Lake Storage Gen2**. Jednak wa偶ne jest zauwa偶enie, 偶e **Zachowane Polityki Dostpu** nie s kompatybilne z Delegowanym SAS u偶ytkownika.

Nale偶y zauwa偶y, 偶e delegowany SAS u偶ytkownika jest **zabezpieczony za pomoc powiadcze Azure AD zamiast kluczy konta magazynu**. Zapobiega to klientom/aplikacjom przechowywanie/pobieranie kluczy magazynu w celu utworzenia SAS.

### SAS usugi

SAS usugi jest zabezpieczony za pomoc **klucza konta magazynu**. SAS usugi **deleguje dostp do zasobu tylko w jednej** z usug Azure Storage: magazyn Blob, magazyn kolejek, magazyn tabel lub pliki Azure. Adres URI dla SAS na poziomie usugi skada si z adresu URI do zasobu, dla kt贸rego SAS bdzie delegowa dostp, a nastpnie z tokena SAS.

Aby u偶y powiadcze Azure Active Directory (Azure AD) do zabezpieczenia SAS dla **kontenera** lub **bloba**, u偶yj **delegowanego SAS u偶ytkownika**.

### SAS konta

SAS konta jest zabezpieczony za pomoc jednego z **kluczy konta magazynu** (jest ich 2). SAS konta deleguje dostp do zasob贸w w jednej lub kilku usugach magazynowych. Wszystkie operacje dostpne za pomoc SAS na poziomie usugi lub delegowanego u偶ytkownika s r贸wnie偶 dostpne za pomoc SAS konta.

[z dokumentacji:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Tworzc SAS konta, mo偶esz:

* Delegowa dostp do operacji na poziomie usugi, kt贸re nie s obecnie dostpne za pomoc SAS specyficznego dla usugi, takich jak operacje `Get/Set Service Properties` i `Get Service Stats`.
* Delegowa dostp do wicej ni偶 jednej usugi w koncie magazynowym jednoczenie. Na przykad mo偶esz delegowa dostp do zasob贸w zar贸wno w Azure Blob Storage, jak i w plikach Azure, korzystajc z SAS konta.
* Delegowa dostp do operacji zapisu i usuwania dla kontener贸w, kolejek, tabel i udzia贸w plik贸w, kt贸re nie s dostpne za pomoc SAS specyficznego dla obiektu.
* Okreli adres IP lub zakres adres贸w IP, z kt贸rych bd akceptowane 偶dania.
* Okreli protok贸 HTTP, z kt贸rego bd akceptowane 偶dania (HTTPS lub HTTP/HTTPS).

## Wyliczanie

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Odnoniki

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
