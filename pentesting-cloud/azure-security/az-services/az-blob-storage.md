# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage es la soluci칩n de **almacenamiento de objetos de Microsoft para la nube**. El almacenamiento de blobs est치 optimizado para almacenar grandes cantidades de datos no estructurados. Los datos no estructurados son datos que no se adhieren a un modelo o definici칩n de datos particular, como texto o datos binarios.

El almacenamiento de blobs ofrece tres tipos de recursos:

* La **cuenta de almacenamiento** (nombre 칰nico)
* Un **contenedor** en la cuenta de almacenamiento (carpeta)
* Un **blob** en un contenedor

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Different types of storage

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Access to Storage <a href="#about-blob-storage" id="about-blob-storage"></a>

* Use Azure AD principals via **RBAC roles** supported.
* **Access Keys**: Use access keys of the storage account. This provides f**ull access to the storage account.**
* **Shared Access Signature** (SAS): **Time** **limited** and specific permissions.
* You can generate a SAS url with an **access key** (more complicated to detect).
* As the SAS is generated from the access key, if it gets renewed the SAS stops working.

### Public Exposure

If "Allow Blob public access" is **enabled** (disabled by default), it's possible to:

* Give **public access to read blobs** (you need to know the name).
* **List container blobs** and **read** them.

### Connect to Storage

If you find any **storage** you can connect to you could use the tool [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) to do so.

## SAS URLs

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Una firma de acceso compartido (SAS) proporciona acceso delegado seguro a los recursos en su cuenta de almacenamiento. Con un SAS, tiene control granular sobre c칩mo un cliente puede acceder a sus datos. Por ejemplo:

* Qu칠 recursos puede acceder el cliente.
* Qu칠 permisos tiene sobre esos recursos.
* Cu치nto tiempo es v치lido el SAS.

Una URL SAS se ve as칤: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Use [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acceder a los datos o python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Puedes **asegurar un token de firma de acceso compartido (SAS)** para acceder a un contenedor, directorio o blob utilizando **credenciales de Azure Active Directory (Azure AD) o una clave de cuenta**. Para crear un SAS de delegaci칩n de usuario, primero debes solicitar una **clave de delegaci칩n de usuario**, que luego usar치s para firmar el SAS.

Se proporciona soporte para una **Firma de Acceso Compartido de Delegaci칩n de Usuario (SAS)** tanto en **Azure Blob Storage** como en **Azure Data Lake Storage Gen2**. Sin embargo, es importante tener en cuenta que las **Pol칤ticas de Acceso Almacenadas** no son compatibles con un SAS de Delegaci칩n de Usuario.

Ten en cuenta que el SAS de delegaci칩n de usuario est치 **asegurado con credenciales de Azure AD en lugar de claves de cuenta de almacenamiento**. Esto evita que los clientes/aplicaciones almacenen/recuperen claves de almacenamiento para crear SAS.

### Service SAS

Un service SAS est치 asegurado con la **clave de cuenta de almacenamiento**. Un service SAS **delegar치 acceso a un recurso en solo uno** de los servicios de almacenamiento de Azure: Blob storage, Queue storage, Table storage o Azure Files. La URI para un SAS a nivel de servicio consiste en la URI del recurso para el cual el SAS delegar치 acceso, seguida del token SAS.

Para usar credenciales de Azure Active Directory (Azure AD) para asegurar un SAS para un **contenedor** o **blob**, utiliza un **SAS de delegaci칩n de usuario**.

### Account SAS

Un account SAS est치 asegurado con una de las **claves de cuenta de almacenamiento** (hay 2). Un account SAS delega acceso a recursos en uno o m치s de los servicios de almacenamiento. Todas las operaciones disponibles a trav칠s de un SAS de servicio o de delegaci칩n de usuario tambi칠n est치n disponibles a trav칠s de un account SAS.

[from the docs:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Al crear un account SAS, puedes:

* Delegar acceso a operaciones a nivel de servicio que no est치n actualmente disponibles con un SAS espec칤fico de servicio, como las operaciones `Get/Set Service Properties` y `Get Service Stats`.
* Delegar acceso a m치s de un servicio en una cuenta de almacenamiento a la vez. Por ejemplo, puedes delegar acceso a recursos tanto en Azure Blob Storage como en Azure Files utilizando un account SAS.
* Delegar acceso a operaciones de escritura y eliminaci칩n para contenedores, colas, tablas y comparticiones de archivos, que no est치n disponibles con un SAS espec칤fico de objeto.
* Especificar una direcci칩n IP o un rango de direcciones IP desde las cuales aceptar solicitudes.
* Especificar el protocolo HTTP desde el cual aceptar solicitudes (ya sea HTTPS o HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Referencias

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
