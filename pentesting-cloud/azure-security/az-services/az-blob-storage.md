# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage √® la soluzione di **storage** di Microsoft per il **cloud**. Blob storage √® ottimizzato per memorizzare enormi quantit√† di dati non strutturati. I dati non strutturati sono dati che non aderiscono a un particolare modello o definizione di dati, come testo o dati binari.

Blob storage offre tre tipi di risorse:

* L'**account di storage** (nome unico)
* Un **contenitore** nell'account di storage (cartella)
* Un **blob** in un contenitore

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Different types of storage

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Access to Storage <a href="#about-blob-storage" id="about-blob-storage"></a>

* Usa i principi di Azure AD tramite **ruoli RBAC** supportati.
* **Chiavi di accesso**: Usa le chiavi di accesso dell'account di storage. Questo fornisce **accesso completo all'account di storage.**
* **Firma di accesso condiviso** (SAS): **Limitata nel tempo** e permessi specifici.
* Puoi generare un URL SAS con una **chiave di accesso** (pi√π complicato da rilevare).
* Poich√© il SAS √® generato dalla chiave di accesso, se viene rinnovato, il SAS smette di funzionare.

### Public Exposure

Se "Consenti accesso pubblico ai blob" √® **abilitato** (disabilitato per impostazione predefinita), √® possibile:

* Dare **accesso pubblico per leggere i blob** (devi conoscere il nome).
* **Elencare i blob del contenitore** e **leggerli**.

### Connect to Storage

Se trovi qualche **storage** a cui puoi connetterti, puoi usare lo strumento [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) per farlo.

## SAS URLs

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Una firma di accesso condiviso (SAS) fornisce accesso delegato sicuro alle risorse nel tuo account di storage. Con un SAS, hai un controllo granulare su come un client pu√≤ accedere ai tuoi dati. Ad esempio:

* Quali risorse il client pu√≤ accedere.
* Quali permessi ha su quelle risorse.
* Quanto tempo √® valido il SAS.

Un URL SAS appare cos√¨: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Usa [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) per accedere ai dati o python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Puoi **proteggere un token di firma di accesso condiviso (SAS)** per l'accesso a un contenitore, directory o blob utilizzando le **credenziali di Azure Active Directory (Azure AD) o una chiave dell'account**. Per creare un user delegation SAS, devi prima richiedere una **chiave di delega utente**, che poi utilizzi per firmare il SAS.

Il supporto √® fornito per un **User Delegation Shared Access Signature (SAS)** sia in **Azure Blob Storage** che in **Azure Data Lake Storage Gen2**. Tuttavia, √® importante notare che le **Stored Access Policies** non sono compatibili con un User Delegation SAS.

Nota che l'user delegation SAS √® **protetto con le credenziali di Azure AD invece delle chiavi dell'account di archiviazione**. Questo impedisce ai client/applicazioni di memorizzare/recuperare le chiavi di archiviazione per creare SAS.

### Service SAS

Un service SAS √® protetto con la **chiave dell'account di archiviazione**. Un service SAS **delega l'accesso a una risorsa in solo uno** dei servizi di archiviazione di Azure: Blob storage, Queue storage, Table storage o Azure Files. L'URI per un SAS a livello di servizio consiste nell'URI della risorsa per la quale il SAS delega l'accesso, seguito dal token SAS.

Per utilizzare le credenziali di Azure Active Directory (Azure AD) per proteggere un SAS per un **contenitore** o **blob**, utilizza un **user delegation SAS**.

### Account SAS

Un account SAS √® protetto con una delle **chiavi dell'account di archiviazione** (ce ne sono 2). Un account SAS delega l'accesso alle risorse in uno o pi√π dei servizi di archiviazione. Tutte le operazioni disponibili tramite un service o user delegation SAS sono disponibili anche tramite un account SAS.

[from the docs:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Creando un account SAS, puoi:

* Delegare l'accesso a operazioni a livello di servizio che non sono attualmente disponibili con un SAS specifico per il servizio, come le operazioni `Get/Set Service Properties` e `Get Service Stats`.
* Delegare l'accesso a pi√π di un servizio in un account di archiviazione alla volta. Ad esempio, puoi delegare l'accesso a risorse sia in Azure Blob Storage che in Azure Files utilizzando un account SAS.
* Delegare l'accesso a operazioni di scrittura e cancellazione per contenitori, code, tabelle e condivisioni di file, che non sono disponibili con un SAS specifico per l'oggetto.
* Specificare un indirizzo IP o un intervallo di indirizzi IP da cui accettare richieste.
* Specificare il protocollo HTTP da cui accettare richieste (sia HTTPS che HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Riferimenti

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Impara e pratica il hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Impara e pratica il hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos su github.

</details>
{% endhint %}
