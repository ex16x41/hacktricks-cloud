# Az - Blob Storage

{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
学习与实践 GCP 黑客技术： <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 分享黑客技巧。

</details>
{% endhint %}

## 基本信息

[来自文档：](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob 存储是微软的对象 **云存储解决方案**。Blob 存储针对存储大量非结构化数据进行了优化。非结构化数据是指不遵循特定数据模型或定义的数据，例如文本或二进制数据。

Blob 存储提供三种类型的资源：

* **存储帐户**（唯一名称）
* 存储帐户中的 **容器**（文件夹）
* 容器中的 **Blob**

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### 不同类型的存储

| **Blob 存储**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **队列存储**                    | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **表存储**                      | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### 存储访问 <a href="#about-blob-storage" id="about-blob-storage"></a>

* 通过 **RBAC 角色** 使用 Azure AD 主体。
* **访问密钥**：使用存储帐户的访问密钥。这提供了对存储帐户的**完全访问**。
* **共享访问签名**（SAS）：**时间** **限制**和特定权限。
* 您可以使用 **访问密钥** 生成 SAS URL（更难检测）。
* 由于 SAS 是从访问密钥生成的，如果它被更新，SAS 将停止工作。

### 公开暴露

如果“允许 Blob 公开访问”**启用**（默认禁用），则可以：

* 给予 **公共访问以读取 Blob**（您需要知道名称）。
* **列出容器 Blob** 并 **读取** 它们。

### 连接到存储

如果您发现任何可以连接的 **存储**，可以使用工具 [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) 来连接。

## SAS URLs

[来自文档：](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) 共享访问签名（SAS）为您存储帐户中的资源提供安全的委托访问。使用 SAS，您可以对客户端如何访问数据进行细粒度控制。例如：

* 客户端可以访问哪些资源。
* 他们对这些资源的权限。
* SAS 有效的时间。

SAS URL 看起来像这样：**`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

使用 [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) 访问数据或使用 Python：

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### 用户委托 SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

您可以通过使用 Azure Active Directory (Azure AD) **凭据或帐户密钥** 来**保护对容器、目录或 Blob 的共享访问签名 (SAS)** 令牌。要创建用户委托 SAS，您必须首先请求一个**用户委托密钥**，然后使用该密钥来签署 SAS。

在 **Azure Blob Storage** 和 **Azure Data Lake Storage Gen2** 中都支持**用户委托共享访问签名 (SAS)**。但是，重要的是要注意**存储访问策略**与用户委托 SAS 不兼容。

请注意，用户委托 SAS 是**使用 Azure AD 凭据而不是存储帐户密钥进行保护**。这防止客户端/应用程序存储/检索存储密钥以创建 SAS。

### 服务 SAS

服务 SAS 是使用**存储帐户密钥**进行保护的。服务 SAS **仅将访问委托给 Azure 存储服务中的一个**资源：Blob 存储、队列存储、表存储或 Azure 文件。服务级 SAS 的 URI 由将委托访问的资源的 URI 组成，后跟 SAS 令牌。

要使用 Azure Active Directory (Azure AD) 凭据来保护**容器**或**Blob**的 SAS，请使用**用户委托 SAS**。

### 帐户 SAS

帐户 SAS 是使用其中一个**存储帐户密钥**（有 2 个）进行保护的。帐户 SAS 将访问委托给一个或多个存储服务中的资源。通过服务或用户委托 SAS 可用的所有操作也可以通过帐户 SAS 使用。

[来自文档：](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) 通过创建帐户 SAS，您可以：

* 委托对当前不通过服务特定 SAS 可用的服务级操作的访问，例如 `Get/Set Service Properties` 和 `Get Service Stats` 操作。
* 委托对存储帐户中多个服务的访问。例如，您可以通过使用帐户 SAS 委托对 Azure Blob Storage 和 Azure Files 中资源的访问。
* 委托对容器、队列、表和文件共享的写入和删除操作的访问，这些操作在对象特定 SAS 中不可用。
* 指定接受请求的 IP 地址或 IP 地址范围。
* 指定接受请求的 HTTP 协议（HTTPS 或 HTTP/HTTPS）。

## 枚举

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## 参考文献

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
学习与实践 GCP 黑客技术：<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
