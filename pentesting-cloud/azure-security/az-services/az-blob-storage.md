# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## 基本情報

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storageは、Microsoftの**クラウド用オブジェクトストレージソリューション**です。Blobストレージは、大量の非構造化データを保存するために最適化されています。非構造化データとは、テキストやバイナリデータなど、特定のデータモデルや定義に従わないデータのことです。

Blobストレージは、3種類のリソースを提供します：

* **ストレージアカウント**（ユニークな名前）
* ストレージアカウント内の**コンテナ**（フォルダ）
* コンテナ内の**Blob**

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### 異なる種類のストレージ

| **Blobストレージ**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queueストレージ**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Tableストレージ**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### ストレージへのアクセス <a href="#about-blob-storage" id="about-blob-storage"></a>

* **RBACロール**を介してAzure ADプリンシパルを使用します。
* **アクセスキー**：ストレージアカウントのアクセスキーを使用します。これにより、**ストレージアカウントへの完全なアクセス**が提供されます。
* **共有アクセス署名**（SAS）：**時間制限**と特定の権限。
* **アクセスキー**を使用してSAS URLを生成できます（検出が難しい）。
* SASはアクセスキーから生成されるため、アクセスキーが更新されるとSASは機能しなくなります。

### 公開露出

「Blobの公開アクセスを許可する」が**有効**になっている場合（デフォルトでは無効）、次のことが可能です：

* **Blobを読むための公開アクセスを提供する**（名前を知っている必要があります）。
* **コンテナのBlobをリスト**し、**それらを読む**。

### ストレージへの接続

接続できる**ストレージ**を見つけた場合は、[**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/)ツールを使用して接続できます。

## SAS URLs

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) 共有アクセス署名（SAS）は、ストレージアカウント内のリソースへの安全な委任アクセスを提供します。SASを使用すると、クライアントがデータにアクセスする方法を詳細に制御できます。たとえば：

* クライアントがアクセスできるリソース。
* それらのリソースに対する権限。
* SASが有効な期間。

SAS URLは次のようになります：**`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

[**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/)を使用してデータにアクセスするか、Pythonを使用します：

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### ユーザー委任SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

**共有アクセス署名（SAS）**トークンを使用して、コンテナ、ディレクトリ、またはBlobへのアクセスを**Azure Active Directory（Azure AD）** **資格情報またはアカウントキー**を使用して保護できます。ユーザー委任SASを作成するには、まず**ユーザー委任キー**を要求し、それを使用してSASに署名します。

**Azure Blob Storage**と**Azure Data Lake Storage Gen2**の両方で**ユーザー委任共有アクセス署名（SAS）**がサポートされています。ただし、**保存されたアクセスポリシー**はユーザー委任SASと互換性がないことに注意してください。

ユーザー委任SASは**ストレージアカウントキーの代わりにAzure AD資格情報で保護されている**ことに注意してください。これにより、クライアント/アプリケーションがSASを作成するためにストレージキーを保存/取得することが防止されます。

### サービスSAS

サービスSASは**ストレージアカウントキー**で保護されています。サービスSASは、Azure Storageサービスの**1つのリソースへのアクセスを委任**します：Blobストレージ、キューストレージ、テーブルストレージ、またはAzure Files。サービスレベルのSASのURIは、SASがアクセスを委任するリソースのURIに続いてSASトークンが続きます。

**コンテナ**または**Blob**のSASを保護するためにAzure Active Directory（Azure AD）資格情報を使用するには、**ユーザー委任SAS**を使用します。

### アカウントSAS

アカウントSASは、**ストレージアカウントキー**の1つで保護されています（2つあります）。アカウントSASは、1つ以上のストレージサービス内のリソースへのアクセスを委任します。サービスまたはユーザー委任SASを介して利用可能なすべての操作は、アカウントSASを介しても利用可能です。

[from the docs:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) アカウントSASを作成することで、次のことができます：

* `Get/Set Service Properties`や`Get Service Stats`操作など、サービス固有のSASでは現在利用できないサービスレベルの操作へのアクセスを委任します。
* ストレージアカウント内の複数のサービスへのアクセスを同時に委任します。たとえば、アカウントSASを使用して、Azure Blob StorageとAzure Filesの両方のリソースへのアクセスを委任できます。
* オブジェクト固有のSASでは利用できないコンテナ、キュー、テーブル、およびファイル共有の書き込みおよび削除操作へのアクセスを委任します。
* リクエストを受け入れるIPアドレスまたはIPアドレスの範囲を指定します。
* リクエストを受け入れるHTTPプロトコルを指定します（HTTPSまたはHTTP/HTTPSのいずれか）。

## 列挙

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## 参考文献

* [https://learn.microsoft.com/ja-jp/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/ja-jp/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/ja-jp/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/ja-jp/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してハッキングトリックを共有してください。**

</details>
{% endhint %}
