# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Grundinformationen

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob Storage ist Microsofts Objekt **Speicherl√∂sung f√ºr die Cloud**. Blob-Speicher ist optimiert f√ºr die Speicherung massiver Mengen unstrukturierter Daten. Unstrukturierte Daten sind Daten, die sich nicht an ein bestimmtes Datenmodell oder eine Definition halten, wie z.B. Text- oder Bin√§rdaten.

Blob-Speicher bietet drei Arten von Ressourcen:

* Das **Speicherkonto** (einzigartiger Name)
* Ein **Container** im Speicherkonto (Ordner)
* Ein **Blob** in einem Container

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Verschiedene Arten von Speicher

| **Blob-Speicher**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue-Speicher**               | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Tabellen-Speicher**            | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Zugriff auf Speicher <a href="#about-blob-storage" id="about-blob-storage"></a>

* Verwenden Sie Azure AD-Prinzipien √ºber **RBAC-Rollen**.
* **Zugriffsschl√ºssel**: Verwenden Sie die Zugriffsschl√ºssel des Speicherkontos. Dies bietet **vollen Zugriff auf das Speicherkonto.**
* **Shared Access Signature** (SAS): **Zeitlich** **begrenzt** und spezifische Berechtigungen.
* Sie k√∂nnen eine SAS-URL mit einem **Zugriffsschl√ºssel** generieren (schwieriger zu erkennen).
* Da die SAS aus dem Zugriffsschl√ºssel generiert wird, funktioniert die SAS nicht mehr, wenn der Schl√ºssel erneuert wird.

### √ñffentliche Exposition

Wenn "√ñffentlichen Zugriff auf Blobs erlauben" **aktiviert** ist (standardm√§√üig deaktiviert), ist es m√∂glich:

* **√ñffentlichen Zugriff zum Lesen von Blobs** zu gew√§hren (Sie m√ºssen den Namen kennen).
* **Container-Blobs aufzulisten** und **sie zu lesen**.

### Verbindung zum Speicher

Wenn Sie einen **Speicher** finden, zu dem Sie eine Verbindung herstellen k√∂nnen, k√∂nnen Sie das Tool [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) verwenden.

## SAS-URLs

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Eine Shared Access Signature (SAS) bietet sicheren delegierten Zugriff auf Ressourcen in Ihrem Speicherkonto. Mit einer SAS haben Sie granularen Zugriff darauf, wie ein Client auf Ihre Daten zugreifen kann. Zum Beispiel:

* Auf welche Ressourcen der Client zugreifen kann.
* Welche Berechtigungen er f√ºr diese Ressourcen hat.
* Wie lange die SAS g√ºltig ist.

Eine SAS-URL sieht so aus: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Verwenden Sie [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/), um auf die Daten zuzugreifen oder Python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### Benutzerdelegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Sie k√∂nnen ein **Shared Access Signature (SAS)**-Token f√ºr den Zugriff auf einen Container, ein Verzeichnis oder ein Blob sichern, indem Sie entweder Azure Active Directory (Azure AD) **Anmeldeinformationen oder einen Kontoschl√ºssel** verwenden. Um eine Benutzerdelegation SAS zu erstellen, m√ºssen Sie zun√§chst einen **Benutzerdelegationsschl√ºssel** anfordern, den Sie dann verwenden, um die SAS zu signieren.

Unterst√ºtzung wird f√ºr eine **User Delegation Shared Access Signature (SAS)** sowohl in **Azure Blob Storage** als auch in **Azure Data Lake Storage Gen2** bereitgestellt. Es ist jedoch wichtig zu beachten, dass **Stored Access Policies** nicht mit einer Benutzerdelegation SAS kompatibel sind.

Beachten Sie, dass die Benutzerdelegation SAS **mit Azure AD-Anmeldeinformationen anstelle von Speicherkontenschl√ºsseln gesichert ist**. Dies verhindert, dass Clients/Anwendungen Speicherschl√ºssel speichern/abrufen, um SAS zu erstellen.

### Service SAS

Eine Service SAS ist mit dem **Speicherkontenschl√ºssel** gesichert. Eine Service SAS **delegiert den Zugriff auf eine Ressource nur in einem** der Azure Storage-Dienste: Blob-Speicher, Warteschlangen-Speicher, Tabellen-Speicher oder Azure Files. Die URI f√ºr eine servicelevel SAS besteht aus der URI zur Ressource, f√ºr die die SAS den Zugriff delegiert, gefolgt vom SAS-Token.

Um Azure Active Directory (Azure AD)-Anmeldeinformationen zu verwenden, um eine SAS f√ºr einen **Container** oder ein **Blob** zu sichern, verwenden Sie eine **Benutzerdelegation SAS**.

### Konto SAS

Eine Konto SAS ist mit einem der **Speicherkontenschl√ºssel** (es gibt 2) gesichert. Eine Konto SAS delegiert den Zugriff auf Ressourcen in einem oder mehreren der Speicherdienste. Alle Operationen, die √ºber eine Service- oder Benutzerdelegation SAS verf√ºgbar sind, sind auch √ºber eine Konto SAS verf√ºgbar.

[from the docs:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Durch die Erstellung einer Konto SAS k√∂nnen Sie:

* Den Zugriff auf servicelevel Operationen delegieren, die derzeit nicht mit einer service-spezifischen SAS verf√ºgbar sind, wie die `Get/Set Service Properties` und `Get Service Stats` Operationen.
* Den Zugriff auf mehr als einen Dienst in einem Speicherkonto gleichzeitig delegieren. Zum Beispiel k√∂nnen Sie den Zugriff auf Ressourcen sowohl in Azure Blob Storage als auch in Azure Files mit einer Konto SAS delegieren.
* Den Zugriff auf Schreib- und L√∂schoperationen f√ºr Container, Warteschlangen, Tabellen und Dateifreigaben delegieren, die mit einer objekt-spezifischen SAS nicht verf√ºgbar sind.
* Eine IP-Adresse oder einen Bereich von IP-Adressen angeben, von denen Anfragen akzeptiert werden.
* Das HTTP-Protokoll angeben, von dem Anfragen akzeptiert werden (entweder HTTPS oder HTTP/HTTPS).

## Aufz√§hlung

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Referenzen

* [https://learn.microsoft.com/de-de/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/de-de/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/de-de/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/de-de/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
