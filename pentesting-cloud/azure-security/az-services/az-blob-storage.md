# Az - Blob Storage

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basiese Inligting

[Uit die dokumentasie:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob opslag is Microsoft se objek **opslagoplossing vir die wolk**. Blob opslag is geoptimaliseer vir die stoor van massiewe hoeveelhede ongestructureerde data. Ongestructureerde data is data wat nie aan 'n spesifieke datamodel of definisie voldoen nie, soos teks of bin√™re data.

Blob opslag bied drie tipes hulpbronne:

* Die **opslagrekening** (unieke naam)
* 'n **houer** in die opslagrekening (map)
* 'n **blob** in 'n houer

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Verskillende tipes opslag

| **Blob opslag**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue opslag**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Tabel opslag**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Toegang tot Opslag <a href="#about-blob-storage" id="about-blob-storage"></a>

* Gebruik Azure AD beginsels via **RBAC rolle** wat ondersteun word.
* **Toegang Sleutels**: Gebruik toegang sleutels van die opslagrekening. Dit bied **volledige toegang tot die opslagrekening.**
* **Gedeelde Toegang Handtekening** (SAS): **Tyd** **beperk** en spesifieke toestemmings.
* Jy kan 'n SAS url genereer met 'n **toegang sleutel** (meer ingewikkeld om te ontdek).
* Aangesien die SAS gegenereer word vanaf die toegang sleutel, as dit hernu word, stop die SAS om te werk.

### Publieke Blootstelling

As "Laat Blob publieke toegang toe" **geaktiveer** is (standaard gedeaktiveer), is dit moontlik om:

* **Publieke toegang te gee om blobs te lees** (jy moet die naam weet).
* **Lys houer blobs** en **lees** hulle.

### Verbind met Opslag

As jy enige **opslag** vind waarmee jy kan verbind, kan jy die hulpmiddel [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) gebruik om dit te doen.

## SAS URL's

[Uit die dokumentasie:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) 'n Gedeelde toegang handtekening (SAS) bied veilige gedelegeerde toegang tot hulpbronne in jou opslagrekening. Met 'n SAS het jy fyn beheer oor hoe 'n kli√´nt toegang tot jou data kan verkry. Byvoorbeeld:

* Watter hulpbronne die kli√´nt mag toegang.
* Watter toestemmings hulle het tot daardie hulpbronne.
* Hoe lank die SAS geldig is.

'n SAS URL lyk soos volg: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Gebruik [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) om toegang tot die data te verkry of python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Jy kan 'n **gedeelde toegang handtekening (SAS)** token beveilig vir toegang tot 'n houer, gids of blob deur of Azure Active Directory (Azure AD) **akkrediteer of 'n rekening sleutel** te gebruik. Om 'n gebruikersdelegasie SAS te skep, moet jy eers 'n **gebruikersdelegasiesleutel** aan vra, wat jy dan gebruik om die SAS te teken.

Ondersteuning word verskaf vir 'n **Gebruikersdelegasie Gedeelde Toegang Handtekening (SAS)** in beide **Azure Blob Storage** en **Azure Data Lake Storage Gen2**. Dit is egter belangrik om te noem dat **Gestoor Toegang Beleid** nie versoenbaar is met 'n Gebruikersdelegasie SAS nie.

Let daarop dat gebruikersdelegasie SAS **beveilig is met Azure AD akkrediteer in plaas van stoor rekening sleutels**. Dit voorkom dat kli√´nte/toepassings stoor sleutels stoor/onttrek om SAS te skep.

### Service SAS

'n Diens SAS is beveilig met die **stoor rekening sleutel**. 'n Diens SAS **delegeer toegang tot 'n hulpbron in slegs een** van die Azure Stoor dienste: Blob stoor, Queues stoor, Tabel stoor, of Azure Files. Die URI vir 'n diensvlak SAS bestaan uit die URI na die hulpbron waarvoor die SAS toegang sal delegeer, gevolg deur die SAS token.

Om Azure Active Directory (Azure AD) akkrediteer te gebruik om 'n SAS vir 'n **houer** of **blob** te beveilig, gebruik 'n **gebruikersdelegasie SAS**.

### Account SAS

'n Rekening SAS is beveilig met een van die **stoor rekening sleutels** (daar is 2). 'n Rekening SAS delegeer toegang tot hulpbronne in een of meer van die stoor dienste. Al die operasies wat beskikbaar is via 'n diens of gebruikersdelegasie SAS is ook beskikbaar via 'n rekening SAS.

[from the docs:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Deur 'n rekening SAS te skep, kan jy:

* Toegang delegeer tot diensvlak operasies wat tans nie beskikbaar is met 'n diens-spesifieke SAS nie, soos die `Get/Set Service Properties` en `Get Service Stats` operasies.
* Toegang delegeer tot meer as een diens in 'n stoor rekening op 'n slag. Byvoorbeeld, jy kan toegang delegeer tot hulpbronne in beide Azure Blob Storage en Azure Files deur 'n rekening SAS te gebruik.
* Toegang delegeer tot skryf- en verwyder operasies vir houers, queues, tabelle, en l√™er deel, wat nie beskikbaar is met 'n objek-spesifieke SAS nie.
* 'n IP adres of 'n reeks IP adresse spesifiseer waarvan om versoeke te aanvaar.
* Die HTTP protokol spesifiseer waarvan om versoeke te aanvaar (of HTTPS of HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Verwysings

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
