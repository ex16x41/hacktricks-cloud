# Az - Queue Storage Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Queue

ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../az-services/az-queue-enum.md" %}
[az-queue-enum.md](../az-services/az-queue-enum.md)
{% endcontent-ref %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/read`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” Azure Storage Queueì—ì„œ ë©”ì‹œì§€ë¥¼ ì—¿ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê³µê²©ìëŠ” ë©”ì‹œì§€ì˜ ë‚´ìš©ì„ ì²˜ë¦¬ëœ ê²ƒìœ¼ë¡œ í‘œì‹œí•˜ê±°ë‚˜ ìƒíƒœë¥¼ ë³€ê²½í•˜ì§€ ì•Šê³ ë„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë¯¼ê°í•œ ì •ë³´ì— ëŒ€í•œ ë¬´ë‹¨ ì ‘ê·¼ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë©°, ë°ì´í„° ìœ ì¶œì´ë‚˜ ì¶”ê°€ ê³µê²©ì„ ìœ„í•œ ì •ë³´ ìˆ˜ì§‘ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az storage message peek --queue-name <queue_name> --account-name <storage_account>
```
{% endcode %}

**ì ì¬ì  ì˜í–¥**: íì— ëŒ€í•œ ë¬´ë‹¨ ì ‘ê·¼, ë©”ì‹œì§€ ë…¸ì¶œ ë˜ëŠ” ë¬´ë‹¨ ì‚¬ìš©ì ë˜ëŠ” ì„œë¹„ìŠ¤ì— ì˜í•œ í ì¡°ì‘.

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/process/action`

ì´ ê¶Œí•œì„ í†µí•´ ê³µê²©ìëŠ” Azure Storage Queueì—ì„œ ë©”ì‹œì§€ë¥¼ ê²€ìƒ‰í•˜ê³  ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ê·¸ë“¤ì´ ë©”ì‹œì§€ ë‚´ìš©ì„ ì½ê³  ì´ë¥¼ ì²˜ë¦¬ëœ ê²ƒìœ¼ë¡œ í‘œì‹œí•˜ì—¬ í•©ë²•ì ì¸ ì‹œìŠ¤í…œì—ì„œ ìˆ¨ê¸¸ ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ë¯¼ê°í•œ ë°ì´í„°ê°€ ë…¸ì¶œë˜ê±°ë‚˜ ë©”ì‹œì§€ ì²˜ë¦¬ ë°©ì‹ì— ì¤‘ë‹¨ì´ ë°œìƒí•˜ê±°ë‚˜, ë©”ì‹œì§€ë¥¼ ì˜ë„ëœ ì‚¬ìš©ìì—ê²Œ ì‚¬ìš©í•  ìˆ˜ ì—†ê²Œ ë§Œë“¤ì–´ ì¤‘ìš”í•œ ì›Œí¬í”Œë¡œê°€ ì¤‘ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az storage message get --queue-name <queue_name> --account-name <storage_account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/add/action`

ì´ ê¶Œí•œì„ í†µí•´ ê³µê²©ìëŠ” Azure Storage Queueì— ìƒˆë¡œìš´ ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì•…ì˜ì ì´ê±°ë‚˜ ìŠ¹ì¸ë˜ì§€ ì•Šì€ ë°ì´í„°ë¥¼ íì— ì£¼ì…í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì˜ë„í•˜ì§€ ì•Šì€ ì‘ì—…ì„ ìœ ë°œí•˜ê±°ë‚˜ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•˜ìœ„ ì„œë¹„ìŠ¤ì— ë°©í•´ë¥¼ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/write`

ì´ ê¶Œí•œì€ ê³µê²©ìê°€ Azure Storage Queueì— ìƒˆë¡œìš´ ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ê¸°ì¡´ ë©”ì‹œì§€ë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ë¡œìš´ ì½˜í…ì¸ ë¥¼ ì‚½ì…í•˜ê±°ë‚˜ ê¸°ì¡´ ë©”ì‹œì§€ë¥¼ ë³€ê²½í•¨ìœ¼ë¡œì¨, íì— ì˜ì¡´í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì˜¤ë„í•˜ê±°ë‚˜ ì‹œìŠ¤í…œì—ì„œ ì›ì¹˜ ì•ŠëŠ” ë™ì‘ì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>

#Update the message
az storage message update --queue-name <queue-name> \
--id <message-id> \
--pop-receipt <pop-receipt> \
--content "Updated message content" \
--visibility-timeout <timeout-in-seconds> \
--account-name <storage-account>
```
{% endcode %}

### Actions: `Microsoft.Storage/storageAccounts/queueServices/queues/delete`

ì´ ê¶Œí•œì€ ê³µê²©ìê°€ ìŠ¤í† ë¦¬ì§€ ê³„ì • ë‚´ì˜ íë¥¼ ì‚­ì œí•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì„ í™œìš©í•¨ìœ¼ë¡œì¨ ê³µê²©ìëŠ” íì™€ ê·¸ì— ì—°ê²°ëœ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì œê±°í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì›Œí¬í”Œë¡œìš°ì— ì‹¬ê°í•œ ì¤‘ë‹¨ì„ ì´ˆë˜í•˜ê³  ì˜í–¥ì„ ë°›ëŠ” íì— ì˜ì¡´í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì¤‘ìš”í•œ ë°ì´í„° ì†ì‹¤ì„ ì´ˆë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì‘ì—…ì€ ì‹œìŠ¤í…œì˜ í•„ìˆ˜ êµ¬ì„± ìš”ì†Œë¥¼ ì œê±°í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ë°©í•´í•˜ëŠ” ë°ì—ë„ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az storage queue delete --name <queue-name> --account-name <storage-account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/delete`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” Azure Storage Queueì—ì„œ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì‘ì—…ì€ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì œê±°í•˜ì—¬ ì›Œí¬í”Œë¡œë¥¼ ë°©í•´í•˜ê³  íì— ì˜ì¡´í•˜ëŠ” ì‹œìŠ¤í…œì˜ ë°ì´í„° ì†ì‹¤ì„ ì´ˆë˜í•©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az storage message clear --queue-name <queue-name> --account-name <storage-account>
```
{% endcode %}

### Actions: `Microsoft.Storage/storageAccounts/queueServices/queues/write`

ì´ ê¶Œí•œì€ ê³µê²©ìê°€ ìŠ¤í† ë¦¬ì§€ ê³„ì • ë‚´ì—ì„œ í ë° í•´ë‹¹ ì†ì„±ì„ ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë¬´ë‹¨ íë¥¼ ìƒì„±í•˜ê±°ë‚˜ ë©”íƒ€ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì ‘ê·¼ ì œì–´ ëª©ë¡(ACL)ì„ ë³€ê²½í•˜ì—¬ ì ‘ê·¼ì„ í—ˆìš©í•˜ê±°ë‚˜ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì€ ì›Œí¬í”Œë¡œë¥¼ ë°©í•´í•˜ê±°ë‚˜ ì•…ì„± ë°ì´í„°ë¥¼ ì£¼ì…í•˜ê±°ë‚˜ ë¯¼ê°í•œ ì •ë³´ë¥¼ ìœ ì¶œí•˜ê±°ë‚˜ í ì„¤ì •ì„ ì¡°ì‘í•˜ì—¬ ì¶”ê°€ ê³µê²©ì„ ê°€ëŠ¥í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az storage queue create --name <new-queue-name> --account-name <storage-account>

az storage queue metadata update --name <queue-name> --metadata key1=value1 key2=value2 --account-name <storage-account>

az storage queue policy set --name <queue-name> --permissions rwd --expiry 2024-12-31T23:59:59Z --account-name <storage-account>
```
{% endcode %}

## References

* https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
* https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
* https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
