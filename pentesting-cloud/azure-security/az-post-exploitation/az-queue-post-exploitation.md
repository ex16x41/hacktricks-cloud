# Az - Queue Post Explotaci贸n

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## Cola

Para m谩s informaci贸n consulta:

{% content-ref url="../az-services/az-queue-enum.md" %}
[az-queue-enum.md](../az-services/az-queue-enum.md)
{% endcontent-ref %}

### DataActions:  `Microsoft.Storage/storageAccounts/queueServices/queues/messages/read`

Un atacante con este permiso puede ver mensajes de una Cola de Almacenamiento de Azure. Esto permite al atacante ver el contenido de los mensajes sin marcarlos como procesados o alterar su estado. Esto podr铆a llevar a un acceso no autorizado a informaci贸n sensible, permitiendo la exfiltraci贸n de datos o la recopilaci贸n de inteligencia para futuros ataques.

{% code overflow="wrap" %}
```bash
az storage message peek --queue-name <queue_name> --account-name <storage_account>
```
{% endcode %}

**Impacto Potencial**: Acceso no autorizado a la cola, exposici贸n de mensajes o manipulaci贸n de la cola por usuarios o servicios no autorizados.

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/process/action`

Con este permiso, un atacante puede recuperar y procesar mensajes de una Cola de Almacenamiento de Azure. Esto significa que pueden leer el contenido del mensaje y marcarlo como procesado, ocult谩ndolo efectivamente de los sistemas leg铆timos. Esto podr铆a llevar a la exposici贸n de datos sensibles, interrupciones en la forma en que se manejan los mensajes, o incluso detener flujos de trabajo importantes al hacer que los mensajes no est茅n disponibles para sus usuarios previstos.

{% code overflow="wrap" %}
```bash
az storage message get --queue-name <queue_name> --account-name <storage_account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/add/action`

Con este permiso, un atacante puede agregar nuevos mensajes a una Cola de Almacenamiento de Azure. Esto les permite inyectar datos maliciosos o no autorizados en la cola, lo que podr铆a desencadenar acciones no deseadas o interrumpir servicios posteriores que procesan los mensajes.

{% code overflow="wrap" %}
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/write`

Este permiso permite a un atacante agregar nuevos mensajes o actualizar los existentes en una Azure Storage Queue. Al usar esto, podr铆an insertar contenido da帽ino o alterar mensajes existentes, potencialmente enga帽ando a las aplicaciones o causando comportamientos no deseados en los sistemas que dependen de la cola.

{% code overflow="wrap" %}
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>

#Update the message
az storage message update --queue-name <queue-name> \
--id <message-id> \
--pop-receipt <pop-receipt> \
--content "Updated message content" \
--visibility-timeout <timeout-in-seconds> \
--account-name <storage-account>
```
{% endcode %}

### Acciones: `Microsoft.Storage/storageAccounts/queueServices/queues/delete`

Este permiso permite a un atacante eliminar colas dentro de la cuenta de almacenamiento. Al aprovechar esta capacidad, un atacante puede eliminar permanentemente colas y todos sus mensajes asociados, causando una interrupci贸n significativa en los flujos de trabajo y resultando en una p茅rdida cr铆tica de datos para las aplicaciones que dependen de las colas afectadas. Esta acci贸n tambi茅n se puede utilizar para sabotear servicios al eliminar componentes esenciales del sistema.

{% code overflow="wrap" %}
```bash
az storage queue delete --name <queue-name> --account-name <storage-account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/delete`

Con este permiso, un atacante puede eliminar todos los mensajes de una Azure Storage Queue. Esta acci贸n elimina todos los mensajes, interrumpiendo flujos de trabajo y causando p茅rdida de datos para los sistemas dependientes de la cola.

{% code overflow="wrap" %}
```bash
az storage message clear --queue-name <queue-name> --account-name <storage-account>
```
{% endcode %}

### Acciones: `Microsoft.Storage/storageAccounts/queueServices/queues/write`

Este permiso permite a un atacante crear o modificar colas y sus propiedades dentro de la cuenta de almacenamiento. Se puede utilizar para crear colas no autorizadas, modificar metadatos o cambiar listas de control de acceso (ACLs) para otorgar o restringir el acceso. Esta capacidad podr铆a interrumpir flujos de trabajo, inyectar datos maliciosos, exfiltrar informaci贸n sensible o manipular configuraciones de colas para habilitar ataques adicionales.

{% code overflow="wrap" %}
```bash
az storage queue create --name <new-queue-name> --account-name <storage-account>

az storage queue metadata update --name <queue-name> --metadata key1=value1 key2=value2 --account-name <storage-account>

az storage queue policy set --name <queue-name> --permissions rwd --expiry 2024-12-31T23:59:59Z --account-name <storage-account>
```
{% endcode %}

## Referencias

* https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
* https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
* https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes

* 隆Consulta los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}
