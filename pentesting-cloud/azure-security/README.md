# Azure Pentesting

{% hint style="success" %}
Naucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **UdostÄ™pniaj triki hakerskie, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}

## NADAL BUDUJÄ˜ METODOLOGIÄ˜ AZURE

## Podstawowe Informacje

{% content-ref url="az-basic-information.md" %}
[az-basic-information.md](az-basic-information.md)
{% endcontent-ref %}

## Metodologia Azure Pentester/Red Team

Aby przeprowadziÄ‡ audyt Å›rodowiska AZURE, bardzo waÅ¼ne jest, aby wiedzieÄ‡: ktÃ³re **usÅ‚ugi sÄ… uÅ¼ywane**, co jest **eksponowane**, kto ma **dostÄ™p** do czego i jak sÄ… poÅ‚Ä…czone wewnÄ™trzne usÅ‚ugi Azure oraz **usÅ‚ugi zewnÄ™trzne**.

Z punktu widzenia Red Team, **pierwszym krokiem do kompromitacji Å›rodowiska Azure** jest uzyskanie **poÅ›wiadczeÅ„** do Azure AD. Oto kilka pomysÅ‚Ã³w, jak to zrobiÄ‡:

* **Leaks** w github (lub podobnych) - OSINT
* **InÅ¼ynieria spoÅ‚eczna**
* **Ponowne uÅ¼ycie haseÅ‚** (wycieki haseÅ‚)
* Luki w zabezpieczeniach aplikacji hostowanych w Azure
* [**Server Side Request Forgery**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) z dostÄ™pem do punktu koÅ„cowego metadanych
* **Lokalne odczytywanie plikÃ³w**
* `/home/USERNAME/.azure`
* `C:\Users\USERNAME\.azure`
* Plik **`accessTokens.json`** w `az cli` przed wersjÄ… 2.30 - styczeÅ„ 2022 - przechowywaÅ‚ **tokeny dostÄ™pu w postaci jawnej**
* Plik **`azureProfile.json`** zawiera **informacje** o zalogowanym uÅ¼ytkowniku.
* **`az logout`** usuwa token.
* Starsze wersje **`Az PowerShell`** przechowywaÅ‚y **tokeny dostÄ™pu** w **postaci jawnej** w **`TokenCache.dat`**. Przechowuje rÃ³wnieÅ¼ **ServicePrincipalSecret** w **postaci jawnej** w **`AzureRmContext.json`**. Cmdlet **`Save-AzContext`** moÅ¼e byÄ‡ uÅ¼yty do **przechowywania** **tokenÃ³w**.\
UÅ¼yj `Disconnect-AzAccount`, aby je usunÄ…Ä‡.
* Naruszenia bezpieczeÅ„stwa stron trzecich
* **WewnÄ™trzny** pracownik
* [**Typowe phishing**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (poÅ›wiadczenia lub aplikacja Oauth)
* [Device Code Authentication Phishing](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
* [Azure **Password Spraying**](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

Nawet jeÅ›li **nie skompromitowaÅ‚eÅ› Å¼adnego uÅ¼ytkownika** w atakowanym tenantcie Azure, moÅ¼esz **zebraÄ‡ pewne informacje** na jego temat:

{% content-ref url="az-unauthenticated-enum-and-initial-entry/" %}
[az-unauthenticated-enum-and-initial-entry](az-unauthenticated-enum-and-initial-entry/)
{% endcontent-ref %}

{% hint style="info" %}
Po uzyskaniu poÅ›wiadczeÅ„, musisz wiedzieÄ‡ **do kogo naleÅ¼Ä… te poÅ›wiadczenia** i **do czego majÄ… dostÄ™p**, wiÄ™c musisz przeprowadziÄ‡ podstawowÄ… enumeracjÄ™:
{% endhint %}

## Podstawowa Enumeracja

{% hint style="info" %}
PamiÄ™taj, Å¼e **najgÅ‚oÅ›niejszÄ…** czÄ™Å›ciÄ… enumeracji jest **logowanie**, a nie sama enumeracja.
{% endhint %}

### SSRF

JeÅ›li znalazÅ‚eÅ› SSRF na maszynie w Azure, sprawdÅº tÄ™ stronÄ™, aby uzyskaÄ‡ triki:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Omijanie WarunkÃ³w Logowania

<figure><img src="../../.gitbook/assets/image (268).png" alt=""><figcaption></figcaption></figure>

W przypadkach, gdy masz waÅ¼ne poÅ›wiadczenia, ale nie moÅ¼esz siÄ™ zalogowaÄ‡, oto kilka typowych zabezpieczeÅ„, ktÃ³re mogÄ… byÄ‡ wprowadzone:

* **BiaÅ‚a lista IP** -- Musisz skompromitowaÄ‡ waÅ¼ne IP
* **Ograniczenia geograficzne** -- Dowiedz siÄ™, gdzie mieszka uÅ¼ytkownik lub gdzie znajdujÄ… siÄ™ biura firmy i uzyskaj IP z tego samego miasta (lub przynajmniej kraju)
* **PrzeglÄ…darka** -- MoÅ¼e byÄ‡ dozwolona tylko przeglÄ…darka z okreÅ›lonego systemu operacyjnego (Windows, Linux, Mac, Android, iOS). Dowiedz siÄ™, jakiego systemu operacyjnego uÅ¼ywa ofiara/firma.
* MoÅ¼esz rÃ³wnieÅ¼ sprÃ³bowaÄ‡ **skompromitowaÄ‡ poÅ›wiadczenia Service Principal**, poniewaÅ¼ zazwyczaj sÄ… one mniej ograniczone, a ich logowanie jest mniej monitorowane

Po obejÅ›ciu zabezpieczeÅ„, moÅ¼esz byÄ‡ w stanie wrÃ³ciÄ‡ do swojego poczÄ…tkowego ustawienia i nadal mieÄ‡ dostÄ™p.

### PrzejÄ™cie Subdomeny

* [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Whoami

{% hint style="danger" %}
Naucz siÄ™ **jak zainstalowaÄ‡** az cli, AzureAD i Az PowerShell w sekcji [**Az - AzureAD**](az-azuread/).
{% endhint %}

JednÄ… z pierwszych rzeczy, ktÃ³re musisz wiedzieÄ‡, jest **kim jesteÅ›** (w jakim Å›rodowisku siÄ™ znajdujesz):

{% tabs %}
{% tab title="az cli" %}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{% endtab %}

{% tab title="AzureAD" %}
```powershell
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Jednym z najwaÅ¼niejszych poleceÅ„ do enumeracji Azure jest **`Get-AzResource`** z Az PowerShell, poniewaÅ¼ pozwala **poznaÄ‡ zasoby, do ktÃ³rych obecny uÅ¼ytkownik ma dostÄ™p**.

MoÅ¼esz uzyskaÄ‡ te same informacje w **konsoli webowej**, przechodzÄ…c do [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) lub wyszukujÄ…c "All resources".
{% endhint %}

### AzureAD Enumeration

DomyÅ›lnie kaÅ¼dy uÅ¼ytkownik powinien mieÄ‡ **wystarczajÄ…ce uprawnienia do enumeracji** takich rzeczy jak uÅ¼ytkownicy, grupy, role, service principals... (sprawdÅº [domyÅ›lne uprawnienia AzureAD](az-basic-information.md#default-user-permissions)).\
Tutaj znajdziesz przewodnik:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

{% hint style="info" %}
Teraz, gdy **masz juÅ¼ pewne informacje o swoich poÅ›wiadczeniach** (a jeÅ›li jesteÅ› red teamem, miejmy nadziejÄ™, Å¼e **nie zostaÅ‚eÅ› wykryty**). Czas dowiedzieÄ‡ siÄ™, ktÃ³re usÅ‚ugi sÄ… uÅ¼ywane w Å›rodowisku.\
W poniÅ¼szej sekcji moÅ¼esz sprawdziÄ‡ kilka sposobÃ³w na **enumeracjÄ™ niektÃ³rych powszechnych usÅ‚ug.**
{% endhint %}

## Service Principal and Access Policy

UsÅ‚uga Azure moÅ¼e mieÄ‡ System Identity (samej usÅ‚ugi) lub uÅ¼ywaÄ‡ User Assigned Managed Identity. Ta toÅ¼samoÅ›Ä‡ moÅ¼e mieÄ‡ Access Policy do, na przykÅ‚ad, KeyVault, aby odczytywaÄ‡ sekrety. Te Access Policies powinny byÄ‡ ograniczone (zasada najmniejszych uprawnieÅ„), ale mogÄ… mieÄ‡ wiÄ™cej uprawnieÅ„ niÅ¼ wymagane. Typowo App Service uÅ¼ywa KeyVault do pobierania sekretÃ³w i certyfikatÃ³w.

Dlatego warto zbadaÄ‡ te toÅ¼samoÅ›ci.

## App Service SCM

Kudu console do logowania siÄ™ do 'container' App Service.

## Webshell

UÅ¼yj portal.azure.com i wybierz shell, lub uÅ¼yj shell.azure.com, dla bash lub powershell. 'Dysk' tego shell jest przechowywany jako plik obrazu w storage-account.

## Azure DevOps

Azure DevOps jest oddzielony od Azure. Ma repozytoria, pipelines (yaml lub release), boards, wiki i wiÄ™cej. Variable Groups sÄ… uÅ¼ywane do przechowywania wartoÅ›ci zmiennych i sekretÃ³w.

## Automated Recon Tools

### [**ROADRecon**](https://github.com/dirkjanm/ROADtools)
```powershell
cd ROADTools
pipenv shell
roadrecon auth -u test@corp.onmicrosoft.com -p "Welcome2022!"
roadrecon gather
roadrecon gui
```
### [Monkey365](https://github.com/silverhack/monkey365)

{% code overflow="wrap" %}
```powershell
Import-Module monkey365
Get-Help Invoke-Monkey365
Get-Help Invoke-Monkey365 -Detailed
Invoke-Monkey365 -IncludeAzureActiveDirectory -ExportTo HTML -Verbose -Debug -InformationAction Continue
Invoke-Monkey365 - Instance Azure -Analysis All -ExportTo HTML
```
{% endcode %}

### [**Stormspotter**](https://github.com/Azure/Stormspotter)
```powershell
# Start Backend
cd stormspotter\backend\
pipenv shell
python ssbackend.pyz

# Start Front-end
cd stormspotter\frontend\dist\spa\
quasar.cmd serve -p 9091 --history

# Run Stormcollector
cd stormspotter\stormcollector\
pipenv shell
az login -u test@corp.onmicrosoft.com -p Welcome2022!
python stormspotter\stormcollector\sscollector.pyz cli
# This will generate a .zip file to upload in the frontend (127.0.0.1:9091)
```
### [**AzureHound**](https://github.com/BloodHoundAD/AzureHound)

AzureHound to narzÄ™dzie do zbierania danych z subskrypcji Azure, ktÃ³re mogÄ… byÄ‡ nastÄ™pnie analizowane za pomocÄ… BloodHound. BloodHound jest szeroko stosowanym narzÄ™dziem do analizy i wizualizacji relacji w Å›rodowiskach Active Directory. AzureHound rozszerza te moÅ¼liwoÅ›ci na Å›rodowiska Azure, umoÅ¼liwiajÄ…c identyfikacjÄ™ potencjalnych Å›cieÅ¼ek ataku i sÅ‚abych punktÃ³w w konfiguracji chmury.

#### Funkcje AzureHound:
- Zbieranie danych o uÅ¼ytkownikach, grupach, rolach i uprawnieniach w subskrypcji Azure.
- Analiza relacji miÄ™dzy zasobami w Azure.
- Identyfikacja potencjalnych Å›cieÅ¼ek ataku w Å›rodowisku Azure.

#### Instalacja i uÅ¼ycie:
1. Sklonuj repozytorium AzureHound:
   ```bash
   git clone https://github.com/BloodHoundAD/AzureHound.git
   ```
2. PrzejdÅº do katalogu AzureHound:
   ```bash
   cd AzureHound
   ```
3. Zainstaluj wymagane zaleÅ¼noÅ›ci:
   ```bash
   pip install -r requirements.txt
   ```
4. Uruchom AzureHound, aby zebraÄ‡ dane z subskrypcji Azure:
   ```bash
   python AzureHound.py
   ```

Zebrane dane moÅ¼na nastÄ™pnie zaimportowaÄ‡ do BloodHound w celu dalszej analizy i wizualizacji.
```powershell
# You need to use the Az PowerShell and Azure AD modules:
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

Import-Module AzureAD\AzureAD.psd1
Connect-AzureAD -Credential $creds

# Launch AzureHound
. AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose

# Simple queries
## All Azure Users
MATCH (n:AZUser) return n.name
## All Azure Applications
MATCH (n:AZApp) return n.objectid
## All Azure Devices
MATCH (n:AZDevice) return n.name
## All Azure Groups
MATCH (n:AZGroup) return n.name
## All Azure Key Vaults
MATCH (n:AZKeyVault) return n.name
## All Azure Resource Groups
MATCH (n:AZResourceGroup) return n.name
## All Azure Service Principals
MATCH (n:AZServicePrincipal) return n.objectid
## All Azure Virtual Machines
MATCH (n:AZVM) return n.name
## All Principals with the â€˜Contributorâ€™ role
MATCH p = (n)-[r:AZContributor]->(g) RETURN p

# Advanced queries
## Get Global Admins
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
## Owners of Azure Groups
MATCH p = (n)-[r:AZOwns]->(g:AZGroup) RETURN p
## All Azure Users and their Groups
MATCH p=(m:AZUser)-[r:MemberOf]->(n) WHERE NOT m.objectid CONTAINS 'S-1-5' RETURN p
## Privileged Service Principals
MATCH p = (g:AZServicePrincipal)-[r]->(n) RETURN p
## Owners of Azure Applications
MATCH p = (n)-[r:AZOwns]->(g:AZApp) RETURN p
## Paths to VMs
MATCH p = (n)-[r]->(g: AZVM) RETURN p
## Paths to KeyVault
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
## Paths to Azure Resource Group
MATCH p = (n)-[r]->(g:AZResourceGroup) RETURN p
## On-Prem users with edges to Azure
MATCH  p=(m:User)-[r:AZResetPassword|AZOwns|AZUserAccessAdministrator|AZContributor|AZAddMembers|AZGlobalAdmin|AZVMContributor|AZOwnsAZAvereContributor]->(n) WHERE m.objectid CONTAINS 'S-1-5-21' RETURN p
## All Azure AD Groups that are synchronized with On-Premise AD
MATCH (n:Group) WHERE n.objectid CONTAINS 'S-1-5' AND n.azsyncid IS NOT NULL RETURN n
```
### [Azucar](https://github.com/nccgroup/azucar)

NarzÄ™dzie do oceny bezpieczeÅ„stwa dla Microsoft Azure. Azucar automatyzuje gromadzenie informacji i ocenÄ™ konfiguracji bezpieczeÅ„stwa w Å›rodowiskach Azure.
```bash
# You should use an account with at least read-permission on the assets you want to access
git clone https://github.com/nccgroup/azucar.git
PS> Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File

PS> .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000

# resolve the TenantID for an specific username
PS> .\Azucar.ps1 -ResolveTenantUserName user@company.com
```
### [**MicroBurst**](https://github.com/NetSPI/MicroBurst)
```
Import-Module .\MicroBurst.psm1
Import-Module .\Get-AzureDomainInfo.ps1
Get-AzureDomainInfo -folder MicroBurst -Verbose
```
### [**PowerZure**](https://github.com/hausec/PowerZure)
```powershell
Connect-AzAccount
ipmo C:\Path\To\Powerzure.psd1
Get-AzureTarget

# Reader
$ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails

# Contributor
$ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command "whoami"
$ Execute-MSBuild -VM Win10Test  -ResourceGroup Test-RG -File "build.xml"
$ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents
$ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine's disk

# Owner
$ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest

# Administrator
$ Create-Backdoor, Execute-Backdoor
```
{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do repozytoriÃ³w** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
{% endhint %}
