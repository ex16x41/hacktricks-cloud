# Az - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage Privesc

ì €ì¥ì†Œì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../az-services/az-storage.md" %}
[az-storage.md](../az-services/az-storage.md)
{% endcontent-ref %}

### Microsoft.Storage/storageAccounts/listkeys/action

ì´ ê¶Œí•œì„ ê°€ì§„ ì£¼ì²´ëŠ” ì €ì¥ì†Œ ê³„ì •ì˜ **ì•¡ì„¸ìŠ¤ í‚¤** ëª©ë¡(ë° ë¹„ë°€ ê°’)ì„ ë‚˜ì—´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì£¼ì²´ê°€ ì €ì¥ì†Œ ê³„ì •ì— ëŒ€í•œ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤.
```bash
az storage account keys list --account-name <acc-name>
```
### Microsoft.Storage/storageAccounts/regenerateKey/action

ì´ ê¶Œí•œì„ ê°€ì§„ ì£¼ì²´ëŠ” ìŠ¤í† ë¦¬ì§€ ê³„ì •ì˜ **ì•¡ì„¸ìŠ¤ í‚¤**ì˜ ìƒˆ ë¹„ë°€ ê°’ì„ ê°±ì‹ í•˜ê³  ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì£¼ì²´ê°€ ìŠ¤í† ë¦¬ì§€ ê³„ì •ì— ëŒ€í•œ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

ë˜í•œ, ì‘ë‹µì—ì„œ ì‚¬ìš©ìëŠ” ê°±ì‹ ëœ í‚¤ì˜ ê°’ê³¼ ê°±ì‹ ë˜ì§€ ì•Šì€ í‚¤ì˜ ê°’ë„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
az storage account keys renew --account-name <acc-name> --key key2
```
### Microsoft.Storage/storageAccounts/write

ì´ ê¶Œí•œì„ ê°€ì§„ ì£¼ì²´ëŠ” ë„¤íŠ¸ì›Œí¬ ê·œì¹™ì´ë‚˜ ì •ì±…ê³¼ ê°™ì€ ì„¤ì •ì„ ì—…ë°ì´íŠ¸í•˜ì—¬ ê¸°ì¡´ ìŠ¤í† ë¦¬ì§€ ê³„ì •ì„ ìƒì„±í•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# e.g. set default action to allow so network restrictions are avoided
az storage account update --name <acc-name> --default-action Allow

# e.g. allow an IP address
az storage account update --name <acc-name> --add networkRuleSet.ipRules value=<ip-address>
```
{% endcode %}

## Blob íŠ¹ì • ê¶Œí•œ ìƒìŠ¹

### Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/write | Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/delete

ì²« ë²ˆì§¸ ê¶Œí•œì€ **ì»¨í…Œì´ë„ˆì˜ ë¶ˆë³€ì„± ì •ì±…ì„ ìˆ˜ì •**í•  ìˆ˜ ìˆê²Œ í•´ì£¼ê³ , ë‘ ë²ˆì§¸ëŠ” ì´ë¥¼ ì‚­ì œí•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

{% hint style="info" %}
ë¶ˆë³€ì„± ì •ì±…ì´ ì ê¸ˆ ìƒíƒœì— ìˆìœ¼ë©´ ë‘ ê°€ì§€ ëª¨ë‘ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŒì„ ìœ ì˜í•˜ì„¸ìš”.
{% endhint %}
```bash
az storage container immutability-policy delete \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--resource-group <RESOURCE_GROUP>

az storage container immutability-policy update \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--resource-group <RESOURCE_GROUP> \
--period <NEW_RETENTION_PERIOD_IN_DAYS>
```
## íŒŒì¼ ê³µìœ  íŠ¹ì • ê¶Œí•œ ìƒìŠ¹

### Microsoft.Storage/storageAccounts/fileServices/takeOwnership/action

ì´ ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìëŠ” ê³µìœ  íŒŒì¼ ì‹œìŠ¤í…œ ë‚´ì˜ íŒŒì¼ ì†Œìœ ê¶Œì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

### Microsoft.Storage/storageAccounts/fileServices/fileshares/files/modifypermissions/action

ì´ ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìëŠ” ê³µìœ  íŒŒì¼ ì‹œìŠ¤í…œ ë‚´ì˜ íŒŒì¼ ê¶Œí•œì„ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

### Microsoft.Storage/storageAccounts/fileServices/fileshares/files/actassuperuser/action

ì´ ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìëŠ” íŒŒì¼ ì‹œìŠ¤í…œ ë‚´ì—ì„œ ìŠˆí¼ìœ ì €ë¡œì„œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

## ë‹¤ë¥¸ í¥ë¯¸ë¡œìš´ ê¶Œí•œ (TODO)

* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/manageOwnership/action: ë¸”ë¡­ì˜ ì†Œìœ ê¶Œì„ ë³€ê²½í•©ë‹ˆë‹¤.
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/modifyPermissions/action: ë¸”ë¡­ì˜ ê¶Œí•œì„ ìˆ˜ì •í•©ë‹ˆë‹¤.
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/runAsSuperUser/action: ë¸”ë¡­ ëª…ë ¹ì˜ ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/immutableStorage/runAsSuperUser/action

## ì°¸ê³ ìë£Œ

* [https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/storage#microsoftstorage](https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/storage#microsoftstorage)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
