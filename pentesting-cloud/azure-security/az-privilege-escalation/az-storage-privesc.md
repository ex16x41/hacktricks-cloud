# Az - Storage Privesc

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Storage Privesc

æœ‰å…³å­˜å‚¨çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../az-services/az-storage.md" %}
[az-storage.md](../az-services/az-storage.md)
{% endcontent-ref %}

### Microsoft.Storage/storageAccounts/listkeys/action

å…·æœ‰æ­¤æƒé™çš„ä¸»ä½“å°†èƒ½å¤Ÿåˆ—å‡ºï¼ˆä»¥åŠç§˜å¯†å€¼ï¼‰å­˜å‚¨å¸æˆ·çš„ **è®¿é—®å¯†é’¥**ã€‚è¿™å…è®¸ä¸»ä½“æå‡å…¶åœ¨å­˜å‚¨å¸æˆ·ä¸Šçš„æƒé™ã€‚
```bash
az storage account keys list --account-name <acc-name>
```
### Microsoft.Storage/storageAccounts/regenerateKey/action

å…·æœ‰æ­¤æƒé™çš„ä¸»ä½“å°†èƒ½å¤Ÿæ›´æ–°å¹¶è·å–å­˜å‚¨å¸æˆ·çš„**è®¿é—®å¯†é’¥**çš„æ–°ç§˜å¯†å€¼ã€‚è¿™å…è®¸ä¸»ä½“æå‡å…¶åœ¨å­˜å‚¨å¸æˆ·ä¸Šçš„æƒé™ã€‚

æ­¤å¤–ï¼Œåœ¨å“åº”ä¸­ï¼Œç”¨æˆ·å°†è·å¾—æ›´æ–°å¯†é’¥çš„å€¼ä»¥åŠæœªæ›´æ–°å¯†é’¥çš„å€¼ï¼š
```bash
az storage account keys renew --account-name <acc-name> --key key2
```
### Microsoft.Storage/storageAccounts/write

å…·æœ‰æ­¤æƒé™çš„ä¸»ä½“å°†èƒ½å¤Ÿåˆ›å»ºæˆ–æ›´æ–°ç°æœ‰çš„å­˜å‚¨å¸æˆ·ï¼Œæ›´æ–°ä»»ä½•è®¾ç½®ï¼Œä¾‹å¦‚ç½‘ç»œè§„åˆ™æˆ–ç­–ç•¥ã€‚

{% code overflow="wrap" %}
```bash
# e.g. set default action to allow so network restrictions are avoided
az storage account update --name <acc-name> --default-action Allow

# e.g. allow an IP address
az storage account update --name <acc-name> --add networkRuleSet.ipRules value=<ip-address>
```
{% endcode %}

## Blobç‰¹å®šæƒé™æå‡

### Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/write | Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/delete

ç¬¬ä¸€ä¸ªæƒé™å…è®¸**ä¿®æ”¹å®¹å™¨ä¸­çš„ä¸å¯å˜æ€§ç­–ç•¥**ï¼Œç¬¬äºŒä¸ªæƒé™å…è®¸åˆ é™¤å®ƒä»¬ã€‚

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå¦‚æœä¸å¯å˜æ€§ç­–ç•¥å¤„äºé”å®šçŠ¶æ€ï¼Œæ‚¨å°†æ— æ³•æ‰§è¡Œè¿™ä¸¤é¡¹æ“ä½œ
{% endhint %}
```bash
az storage container immutability-policy delete \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--resource-group <RESOURCE_GROUP>

az storage container immutability-policy update \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--resource-group <RESOURCE_GROUP> \
--period <NEW_RETENTION_PERIOD_IN_DAYS>
```
## æ–‡ä»¶å…±äº«ç‰¹å®šæƒé™æå‡

### Microsoft.Storage/storageAccounts/fileServices/takeOwnership/action

è¿™åº”è¯¥å…è®¸æ‹¥æœ‰æ­¤æƒé™çš„ç”¨æˆ·èƒ½å¤Ÿè·å–å…±äº«æ–‡ä»¶ç³»ç»Ÿå†…æ–‡ä»¶çš„æ‰€æœ‰æƒã€‚

### Microsoft.Storage/storageAccounts/fileServices/fileshares/files/modifypermissions/action

è¿™åº”è¯¥å…è®¸æ‹¥æœ‰æ­¤æƒé™çš„ç”¨æˆ·èƒ½å¤Ÿä¿®æ”¹å…±äº«æ–‡ä»¶ç³»ç»Ÿå†…æ–‡ä»¶çš„æƒé™ã€‚

### Microsoft.Storage/storageAccounts/fileServices/fileshares/files/actassuperuser/action

è¿™åº”è¯¥å…è®¸æ‹¥æœ‰æ­¤æƒé™çš„ç”¨æˆ·èƒ½å¤Ÿä»¥è¶…çº§ç”¨æˆ·èº«ä»½åœ¨æ–‡ä»¶ç³»ç»Ÿå†…æ‰§è¡Œæ“ä½œã€‚

## å…¶ä»–æœ‰è¶£çš„æƒé™ (TODO)

* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/manageOwnership/action: æ›´æ”¹ blob çš„æ‰€æœ‰æƒ
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/modifyPermissions/action: ä¿®æ”¹ blob çš„æƒé™
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/runAsSuperUser/action: è¿”å› blob å‘½ä»¤çš„ç»“æœ
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/immutableStorage/runAsSuperUser/action

## å‚è€ƒ

* [https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/storage#microsoftstorage](https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/storage#microsoftstorage)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
