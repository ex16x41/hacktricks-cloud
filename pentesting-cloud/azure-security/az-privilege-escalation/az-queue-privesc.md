# Az - Queue Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Kolejka

For more information check:

{% content-ref url="../az-services/az-queue-enum.md" %}
[az-queue-enum.md](../az-services/az-queue-enum.md)
{% endcontent-ref %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/read`

An attacker with this permission can peek messages from an Azure Storage Queue. This allows the attacker to view the content of messages without marking them as processed or altering their state. This could lead to unauthorized access to sensitive information, enabling data exfiltration or gathering intelligence for further attacks.
```bash
az storage message peek --queue-name <queue_name> --account-name <storage_account>
```
{% endcode %}

**Potencjalny wpÅ‚yw**: Nieautoryzowany dostÄ™p do kolejki, ujawnienie wiadomoÅ›ci lub manipulacja kolejkÄ… przez nieautoryzowanych uÅ¼ytkownikÃ³w lub usÅ‚ugi.

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/process/action`

DziÄ™ki temu uprawnieniu, atakujÄ…cy moÅ¼e pobieraÄ‡ i przetwarzaÄ‡ wiadomoÅ›ci z Azure Storage Queue. Oznacza to, Å¼e mogÄ… odczytaÄ‡ zawartoÅ›Ä‡ wiadomoÅ›ci i oznaczyÄ‡ jÄ… jako przetworzonÄ…, skutecznie ukrywajÄ…c jÄ… przed legalnymi systemami. MoÅ¼e to prowadziÄ‡ do ujawnienia wraÅ¼liwych danych, zakÅ‚Ã³ceÅ„ w sposobie obsÅ‚ugi wiadomoÅ›ci, a nawet zatrzymania waÅ¼nych procesÃ³w, czyniÄ…c wiadomoÅ›ci niedostÄ™pnymi dla ich zamierzonych uÅ¼ytkownikÃ³w.

{% code overflow="wrap" %}
```bash
az storage message get --queue-name <queue_name> --account-name <storage_account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/add/action`

DziÄ™ki temu uprawnieniu, atakujÄ…cy moÅ¼e dodaÄ‡ nowe wiadomoÅ›ci do kolejki Azure Storage. UmoÅ¼liwia to wstrzykiwanie zÅ‚oÅ›liwych lub nieautoryzowanych danych do kolejki, co moÅ¼e prowadziÄ‡ do wywoÅ‚ania niezamierzonych dziaÅ‚aÅ„ lub zakÅ‚Ã³cenia dziaÅ‚ania usÅ‚ug przetwarzajÄ…cych wiadomoÅ›ci.

{% code overflow="wrap" %}
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/write`

To uprawnienie pozwala atakujÄ…cemu na dodawanie nowych wiadomoÅ›ci lub aktualizowanie istniejÄ…cych w Azure Storage Queue. UÅ¼ywajÄ…c tego, mogÄ… wprowadzaÄ‡ szkodliwe treÅ›ci lub zmieniaÄ‡ istniejÄ…ce wiadomoÅ›ci, co moÅ¼e wprowadzaÄ‡ w bÅ‚Ä…d aplikacje lub powodowaÄ‡ niepoÅ¼Ä…dane zachowania w systemach, ktÃ³re polegajÄ… na kolejce.

{% code overflow="wrap" %}
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>

#Update the message
az storage message update --queue-name <queue-name> \
--id <message-id> \
--pop-receipt <pop-receipt> \
--content "Updated message content" \
--visibility-timeout <timeout-in-seconds> \
--account-name <storage-account>
```
{% endcode %}

### Akcja: `Microsoft.Storage/storageAccounts/queueServices/queues/write`

To uprawnienie pozwala atakujÄ…cemu na tworzenie lub modyfikowanie kolejek i ich wÅ‚aÅ›ciwoÅ›ci w ramach konta magazynu. MoÅ¼e byÄ‡ uÅ¼ywane do tworzenia nieautoryzowanych kolejek, modyfikowania metadanych lub zmiany list kontroli dostÄ™pu (ACL), aby przyznaÄ‡ lub ograniczyÄ‡ dostÄ™p. Ta zdolnoÅ›Ä‡ moÅ¼e zakÅ‚Ã³caÄ‡ przepÅ‚ywy pracy, wstrzykiwaÄ‡ zÅ‚oÅ›liwe dane, eksfiltrujÄ…c wraÅ¼liwe informacje lub manipulowaÄ‡ ustawieniami kolejek, aby umoÅ¼liwiÄ‡ dalsze ataki.

{% code overflow="wrap" %}
```bash
az storage queue create --name <new-queue-name> --account-name <storage-account>

az storage queue metadata update --name <queue-name> --metadata key1=value1 key2=value2 --account-name <storage-account>

az storage queue policy set --name <queue-name> --permissions rwd --expiry 2024-12-31T23:59:59Z --account-name <storage-account>
```
{% endcode %}

## Odniesienia

* https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
* https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
* https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
