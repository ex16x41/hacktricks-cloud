# Az - Queue Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Queue

Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº:

{% content-ref url="../az-services/az-queue-enum.md" %}
[az-queue-enum.md](../az-services/az-queue-enum.md)
{% endcontent-ref %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/read`

AtakujÄ…cy z tym uprawnieniem moÅ¼e podglÄ…daÄ‡ wiadomoÅ›ci z Azure Storage Queue. UmoÅ¼liwia to atakujÄ…cemu przeglÄ…danie treÅ›ci wiadomoÅ›ci bez oznaczania ich jako przetworzonych lub zmieniania ich stanu. MoÅ¼e to prowadziÄ‡ do nieautoryzowanego dostÄ™pu do wraÅ¼liwych informacji, umoÅ¼liwiajÄ…c eksfiltracjÄ™ danych lub zbieranie informacji wywiadowczych do dalszych atakÃ³w.

{% code overflow="wrap" %}
```bash
az storage message peek --queue-name <queue_name> --account-name <storage_account>
```
{% endcode %}

**Potencjalny wpÅ‚yw**: Nieautoryzowany dostÄ™p do kolejki, ujawnienie wiadomoÅ›ci lub manipulacja kolejkÄ… przez nieautoryzowanych uÅ¼ytkownikÃ³w lub usÅ‚ugi.

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/process/action`

DziÄ™ki temu uprawnieniu, atakujÄ…cy moÅ¼e pobieraÄ‡ i przetwarzaÄ‡ wiadomoÅ›ci z Azure Storage Queue. Oznacza to, Å¼e mogÄ… odczytaÄ‡ zawartoÅ›Ä‡ wiadomoÅ›ci i oznaczyÄ‡ jÄ… jako przetworzonÄ…, skutecznie ukrywajÄ…c jÄ… przed legalnymi systemami. MoÅ¼e to prowadziÄ‡ do ujawnienia wraÅ¼liwych danych, zakÅ‚Ã³ceÅ„ w sposobie obsÅ‚ugi wiadomoÅ›ci, a nawet zatrzymania waÅ¼nych procesÃ³w, czyniÄ…c wiadomoÅ›ci niedostÄ™pnymi dla ich zamierzonych uÅ¼ytkownikÃ³w.

{% code overflow="wrap" %}
```bash
az storage message get --queue-name <queue_name> --account-name <storage_account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/add/action`

DziÄ™ki temu uprawnieniu, atakujÄ…cy moÅ¼e dodaÄ‡ nowe wiadomoÅ›ci do kolejki Azure Storage. UmoÅ¼liwia to wstrzykiwanie zÅ‚oÅ›liwych lub nieautoryzowanych danych do kolejki, co moÅ¼e prowadziÄ‡ do wywoÅ‚ania niezamierzonych dziaÅ‚aÅ„ lub zakÅ‚Ã³cenia dziaÅ‚ania usÅ‚ug przetwarzajÄ…cych wiadomoÅ›ci.

{% code overflow="wrap" %}
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/write`

To uprawnienie pozwala atakujÄ…cemu na dodawanie nowych wiadomoÅ›ci lub aktualizowanie istniejÄ…cych w Azure Storage Queue. WykorzystujÄ…c to, mogÄ… wprowadzaÄ‡ szkodliwÄ… treÅ›Ä‡ lub zmieniaÄ‡ istniejÄ…ce wiadomoÅ›ci, co moÅ¼e wprowadzaÄ‡ w bÅ‚Ä…d aplikacje lub powodowaÄ‡ niepoÅ¼Ä…dane zachowania w systemach, ktÃ³re polegajÄ… na kolejce.

{% code overflow="wrap" %}
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>

#Update the message
az storage message update --queue-name <queue-name> \
--id <message-id> \
--pop-receipt <pop-receipt> \
--content "Updated message content" \
--visibility-timeout <timeout-in-seconds> \
--account-name <storage-account>
```
{% endcode %}

### Akcja: `Microsoft.Storage/storageAccounts/queueServices/queues/write`

To uprawnienie pozwala atakujÄ…cemu na tworzenie lub modyfikowanie kolejek i ich wÅ‚aÅ›ciwoÅ›ci w ramach konta magazynu. MoÅ¼e byÄ‡ uÅ¼ywane do tworzenia nieautoryzowanych kolejek, modyfikowania metadanych lub zmiany list kontroli dostÄ™pu (ACL), aby przyznaÄ‡ lub ograniczyÄ‡ dostÄ™p. Ta zdolnoÅ›Ä‡ moÅ¼e zakÅ‚Ã³caÄ‡ przepÅ‚ywy pracy, wstrzykiwaÄ‡ zÅ‚oÅ›liwe dane, eksfiltrujÄ…c wraÅ¼liwe informacje lub manipulowaÄ‡ ustawieniami kolejek, aby umoÅ¼liwiÄ‡ dalsze ataki.

{% code overflow="wrap" %}
```bash
az storage queue create --name <new-queue-name> --account-name <storage-account>

az storage queue metadata update --name <queue-name> --metadata key1=value1 key2=value2 --account-name <storage-account>

az storage queue policy set --name <queue-name> --permissions rwd --expiry 2024-12-31T23:59:59Z --account-name <storage-account>
```
{% endcode %}

### Actions: `Microsoft.Storage/storageAccounts/queueServices/queues/setAcl/action`

DziÄ™ki temu uprawnieniu, atakujÄ…cy moÅ¼e modyfikowaÄ‡ listÄ™ kontroli dostÄ™pu (ACL) Azure Storage Queue, ktÃ³ra moÅ¼e byÄ‡ uÅ¼ywana z podpisami dostÄ™pu wspÃ³Å‚dzielonego. Pozwala to na przyznawanie lub cofanie uprawnieÅ„ dla innych uÅ¼ytkownikÃ³w lub usÅ‚ug, co potencjalnie umoÅ¼liwia nieautoryzowany dostÄ™p lub blokowanie legalnego dostÄ™pu do kolejki. Takie dziaÅ‚ania mogÄ… zakÅ‚Ã³caÄ‡ przepÅ‚ywy pracy, prowadziÄ‡ do nieautoryzowanego ujawnienia danych lub pozwalaÄ‡ zÅ‚oÅ›liwym aktorom na niewÅ‚aÅ›ciwe wykorzystanie kolejki.

{% code overflow="wrap" %}
```bash
az storage queue policy create \
--queue-name <QUEUE_NAME> \
--account-name <STORAGE_ACCOUNT_NAME> \
--account-key <STORAGE_ACCOUNT_KEY> \
--name <POLICY_NAME> \
--permission <PERMISSIONS> \
--start <START_TIME> \
--expiry <EXPIRY_TIME>
```
{% endcode %}

## Odniesienia

* https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
* https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
* https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
