# Az - Queue Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Queue

Para m치s informaci칩n, consulta:

{% content-ref url="../az-services/az-queue-enum.md" %}
[az-queue-enum.md](../az-services/az-queue-enum.md)
{% endcontent-ref %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/read`

Un atacante con este permiso puede ver mensajes de una Cola de Almacenamiento de Azure. Esto permite al atacante ver el contenido de los mensajes sin marcarlos como procesados o alterar su estado. Esto podr칤a llevar a un acceso no autorizado a informaci칩n sensible, permitiendo la exfiltraci칩n de datos o la recopilaci칩n de inteligencia para ataques posteriores.

{% code overflow="wrap" %}
```bash
az storage message peek --queue-name <queue_name> --account-name <storage_account>
```
{% endcode %}

**Impacto Potencial**: Acceso no autorizado a la cola, exposici칩n de mensajes o manipulaci칩n de la cola por usuarios o servicios no autorizados.

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/process/action`

Con este permiso, un atacante puede recuperar y procesar mensajes de una Cola de Almacenamiento de Azure. Esto significa que pueden leer el contenido del mensaje y marcarlo como procesado, ocult치ndolo efectivamente de los sistemas leg칤timos. Esto podr칤a llevar a la exposici칩n de datos sensibles, interrupciones en la forma en que se manejan los mensajes, o incluso detener flujos de trabajo importantes al hacer que los mensajes no est칠n disponibles para sus usuarios previstos.

{% code overflow="wrap" %}
```bash
az storage message get --queue-name <queue_name> --account-name <storage_account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/add/action`

Con este permiso, un atacante puede agregar nuevos mensajes a una Cola de Almacenamiento de Azure. Esto les permite inyectar datos maliciosos o no autorizados en la cola, lo que podr칤a desencadenar acciones no deseadas o interrumpir servicios posteriores que procesan los mensajes.

{% code overflow="wrap" %}
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/write`

Este permiso permite a un atacante agregar nuevos mensajes o actualizar los existentes en una Azure Storage Queue. Al usar esto, podr칤an insertar contenido da침ino o alterar mensajes existentes, potencialmente enga침ando a las aplicaciones o causando comportamientos no deseados en los sistemas que dependen de la cola.

{% code overflow="wrap" %}
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>

#Update the message
az storage message update --queue-name <queue-name> \
--id <message-id> \
--pop-receipt <pop-receipt> \
--content "Updated message content" \
--visibility-timeout <timeout-in-seconds> \
--account-name <storage-account>
```
{% endcode %}

### Acci칩n: `Microsoft.Storage/storageAccounts/queueServices/queues/write`

Este permiso permite a un atacante crear o modificar colas y sus propiedades dentro de la cuenta de almacenamiento. Se puede utilizar para crear colas no autorizadas, modificar metadatos o cambiar listas de control de acceso (ACLs) para otorgar o restringir acceso. Esta capacidad podr칤a interrumpir flujos de trabajo, inyectar datos maliciosos, exfiltrar informaci칩n sensible o manipular configuraciones de colas para habilitar ataques adicionales.

{% code overflow="wrap" %}
```bash
az storage queue create --name <new-queue-name> --account-name <storage-account>

az storage queue metadata update --name <queue-name> --metadata key1=value1 key2=value2 --account-name <storage-account>

az storage queue policy set --name <queue-name> --permissions rwd --expiry 2024-12-31T23:59:59Z --account-name <storage-account>
```
{% endcode %}

### Acciones: `Microsoft.Storage/storageAccounts/queueServices/queues/setAcl/action`

Con este permiso, un atacante puede modificar la lista de control de acceso (ACL) de una Cola de Almacenamiento de Azure, que se puede usar con firmas de acceso compartido. Esto les permite otorgar o revocar permisos para otros usuarios o servicios, lo que potencialmente habilita el acceso no autorizado o bloquea el acceso leg칤timo a la cola. Tales acciones podr칤an interrumpir flujos de trabajo, llevar a la exposici칩n no autorizada de datos o permitir que actores maliciosos malutilicen la cola.

{% code overflow="wrap" %}
```bash
az storage queue policy create \
--queue-name <QUEUE_NAME> \
--account-name <STORAGE_ACCOUNT_NAME> \
--account-key <STORAGE_ACCOUNT_KEY> \
--name <POLICY_NAME> \
--permission <PERMISSIONS> \
--start <START_TIME> \
--expiry <EXPIRY_TIME>
```
{% endcode %}

## Referencias

* https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
* https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
* https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes

* 춰Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
