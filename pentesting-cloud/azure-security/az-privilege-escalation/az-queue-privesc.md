# Az - Queue Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Queue

Za više informacija proverite:

{% content-ref url="../az-services/az-queue-enum.md" %}
[az-queue-enum.md](../az-services/az-queue-enum.md)
{% endcontent-ref %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/read`

Napadač sa ovom dozvolom može da pogleda poruke iz Azure Storage Queue. Ovo omogućava napadaču da vidi sadržaj poruka bez označavanja kao obrađenih ili menjanja njihovog stanja. To može dovesti do neovlašćenog pristupa osetljivim informacijama, omogućavajući eksfiltraciju podataka ili prikupljanje obaveštajnih podataka za dalja napada. 

{% code overflow="wrap" %}
```bash
az storage message peek --queue-name <queue_name> --account-name <storage_account>
```
{% endcode %}

**Potencijalni uticaj**: Neovlašćen pristup redu, izlaganje poruka ili manipulacija redom od strane neovlašćenih korisnika ili servisa.

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/process/action`

Sa ovom dozvolom, napadač može da preuzme i obradi poruke iz Azure Storage Queue. To znači da mogu da pročitaju sadržaj poruke i označe je kao obrađenu, efikasno je skrivajući od legitimnih sistema. To može dovesti do izlaganja osetljivih podataka, prekida u načinu na koji se poruke obrađuju, ili čak zaustavljanja važnih radnih tokova čineći poruke nedostupnim njihovim predviđenim korisnicima.

{% code overflow="wrap" %}
```bash
az storage message get --queue-name <queue_name> --account-name <storage_account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/add/action`

Sa ovom dozvolom, napadač može dodati nove poruke u Azure Storage Queue. To im omogućava da ubace zlonamerne ili neovlašćene podatke u red, potencijalno pokrećući nepredviđene akcije ili ometajući usluge koje obrađuju poruke.

{% code overflow="wrap" %}
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>
```
{% endcode %}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/write`

Ova dozvola omogućava napadaču da doda nove poruke ili ažurira postojeće u Azure Storage Queue. Korišćenjem ove dozvole, mogli bi umetnuti štetan sadržaj ili izmeniti postojeće poruke, potencijalno obmanjujući aplikacije ili uzrokujući neželjeno ponašanje u sistemima koji se oslanjaju na red. 

{% code overflow="wrap" %}
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>

#Update the message
az storage message update --queue-name <queue-name> \
--id <message-id> \
--pop-receipt <pop-receipt> \
--content "Updated message content" \
--visibility-timeout <timeout-in-seconds> \
--account-name <storage-account>
```
{% endcode %}

### Akcija: `Microsoft.Storage/storageAccounts/queueServices/queues/write`

Ova dozvola omogućava napadaču da kreira ili menja redove i njihove osobine unutar skladišnog naloga. Može se koristiti za kreiranje neovlašćenih redova, modifikovanje metapodataka ili promenu lista kontrole pristupa (ACL) kako bi se omogućio ili ograničio pristup. Ova sposobnost može ometati radne tokove, ubrizgati zlonamerne podatke, eksfiltrirati osetljive informacije ili manipulisati podešavanjima reda kako bi se omogućili dalji napadi.

{% code overflow="wrap" %}
```bash
az storage queue create --name <new-queue-name> --account-name <storage-account>

az storage queue metadata update --name <queue-name> --metadata key1=value1 key2=value2 --account-name <storage-account>

az storage queue policy set --name <queue-name> --permissions rwd --expiry 2024-12-31T23:59:59Z --account-name <storage-account>
```
{% endcode %}

### Actions: `Microsoft.Storage/storageAccounts/queueServices/queues/setAcl/action`

Sa ovom dozvolom, napadač može da izmeni listu kontrole pristupa (ACL) Azure Storage Queue, koja se može koristiti sa potpisima za deljenje pristupa. To im omogućava da dodele ili opozovu dozvole za druge korisnike ili usluge, potencijalno omogućavajući neovlašćen pristup ili blokirajući legitimni pristup ka redu. Takve akcije mogu ometati radne tokove, dovesti do neovlašćenog izlaganja podataka ili omogućiti zlonamernim akterima da zloupotrebe red.

{% code overflow="wrap" %}
```bash
az storage queue policy create \
--queue-name <QUEUE_NAME> \
--account-name <STORAGE_ACCOUNT_NAME> \
--account-key <STORAGE_ACCOUNT_KEY> \
--name <POLICY_NAME> \
--permission <PERMISSIONS> \
--start <START_TIME> \
--expiry <EXPIRY_TIME>
```
{% endcode %}

## Reference

* https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
* https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
* https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
