# GCP - VPC & Networking

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## **GCP Compute Networking in K√ºrze**

**VPCs** enthalten **Firewall**-Regeln, um eingehenden Verkehr zur VPC zuzulassen. VPCs enthalten auch **Subnetze**, in denen **virtuelle Maschinen** **verbunden** werden.\
Im Vergleich zu AWS w√§re **Firewall** das **n√§chste** zu **AWS** **Security Groups und NACLs**, aber in diesem Fall sind diese **in der VPC definiert** und nicht in jeder Instanz.

## **VPC, Subnetze & Firewalls in GCP**

Compute Instances sind mit **Subnetzen** verbunden, die Teil von **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)) sind. In GCP gibt es keine Security Groups, es gibt [**VPC Firewalls**](https://cloud.google.com/vpc/docs/firewalls) mit Regeln, die auf dieser Netzwerkebene definiert, aber auf jede VM-Instanz angewendet werden.

### Subnetze

Eine **VPC** kann **mehrere Subnetze** haben. Jedes **Subnetz befindet sich in einer Region**.

### Firewalls

Standardm√§√üig hat jedes Netzwerk zwei [**implizite Firewall-Regeln**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **ausgehenden Verkehr zulassen** und **eingehenden Verkehr verweigern**.

Wenn ein GCP-Projekt erstellt wird, wird auch eine VPC namens **`default`** erstellt, mit den folgenden Firewall-Regeln:

* **default-allow-internal:** erlaubt allen Verkehr von anderen Instanzen im `default`-Netzwerk
* **default-allow-ssh:** erlaubt 22 von √ºberall
* **default-allow-rdp:** erlaubt 3389 von √ºberall
* **default-allow-icmp:** erlaubt Ping von √ºberall

{% hint style="warning" %}
Wie Sie sehen k√∂nnen, neigen **Firewall-Regeln** dazu, **internen IP-Adressen** gegen√ºber **permissiver** zu sein. Die Standard-VPC erlaubt allen Verkehr zwischen Compute Instances.
{% endhint %}

Weitere **Firewall-Regeln** k√∂nnen f√ºr die Standard-VPC oder f√ºr neue VPCs erstellt werden. [**Firewall-Regeln**](https://cloud.google.com/vpc/docs/firewalls) k√∂nnen auf Instanzen √ºber die folgenden **Methoden** angewendet werden:

* [**Netzwerk-Tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Servicekonten**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Alle Instanzen innerhalb einer VPC**

Leider gibt es keinen einfachen `gcloud`-Befehl, um alle Compute Instances mit offenen Ports im Internet auszugeben. Sie m√ºssen die Punkte zwischen Firewall-Regeln, Netzwerk-Tags, Servicekonten und Instanzen verbinden.

Dieser Prozess wurde mit [diesem Python-Skript](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) automatisiert, das Folgendes exportiert:

* CSV-Datei, die Instanz, √∂ffentliche IP, erlaubtes TCP, erlaubtes UDP zeigt
* nmap-Scan, um alle Instanzen auf Ports zu zielen, die vom √∂ffentlichen Internet (0.0.0.0/0) aus zugelassen sind
* masscan, um den gesamten TCP-Bereich derjenigen Instanzen zu zielen, die ALLE TCP-Ports vom √∂ffentlichen Internet (0.0.0.0/0) zulassen

### Hierarchische Firewall-Richtlinien <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hierarchische Firewall-Richtlinien_ erm√∂glichen es Ihnen, eine **konsistente Firewall-Richtlinie in Ihrer Organisation zu erstellen und durchzusetzen**. Sie k√∂nnen **hierarchische Firewall-Richtlinien der gesamten Organisation** oder einzelnen **Ordnern** zuweisen. Diese Richtlinien enthalten Regeln, die Verbindungen explizit verweigern oder zulassen k√∂nnen.

Sie erstellen und wenden Firewall-Richtlinien in separaten Schritten an. Sie k√∂nnen Firewall-Richtlinien auf den **Organisation- oder Ordnerebenen der** [**Ressourcenhierarchie**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) erstellen und anwenden. Eine Firewall-Richtlinienregel kann **Verbindungen blockieren, Verbindungen zulassen oder die Bewertung der Firewall-Regel** an untergeordnete Ordner oder in VPC-Netzwerken definierte VPC-Firewall-Regeln weiterleiten.

Standardm√§√üig gelten alle hierarchischen Firewall-Richtlinienregeln f√ºr alle VMs in allen Projekten unter der Organisation oder dem Ordner, dem die Richtlinie zugeordnet ist. Sie k√∂nnen jedoch **einschr√§nken, welche VMs eine bestimmte Regel erhalten**, indem Sie [Zielnetzwerke oder Zielservicekonten](https://cloud.google.com/vpc/docs/firewall-policies#targets) angeben.

Hier k√∂nnen Sie nachlesen, wie Sie [**eine hierarchische Firewall-Richtlinie erstellen**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Bewertung der Firewall-Regeln

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: Firewall-Richtlinien, die der Organisation zugewiesen sind
2. Ordner: Firewall-Richtlinien, die dem Ordner zugewiesen sind
3. VPC: Firewall-Regeln, die der VPC zugewiesen sind
4. Global: Eine andere Art von Firewall-Regeln, die VPCs zugewiesen werden k√∂nnen
5. Regional: Firewall-Regeln, die dem VPC-Netzwerk der NIC und der Region der VM zugeordnet sind.

## VPC-Netzwerk-Peering

Erm√∂glicht die Verbindung von zwei Virtual Private Cloud (VPC)-Netzwerken, sodass **Ressourcen in jedem Netzwerk miteinander kommunizieren** k√∂nnen.\
Gekoppelte VPC-Netzwerke k√∂nnen sich im selben Projekt, in verschiedenen Projekten derselben Organisation oder **in verschiedenen Projekten verschiedener Organisationen** befinden.

Dies sind die ben√∂tigten Berechtigungen:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Mehr in den Dokumenten**](https://cloud.google.com/vpc/docs/vpc-peering).

## Referenzen

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
