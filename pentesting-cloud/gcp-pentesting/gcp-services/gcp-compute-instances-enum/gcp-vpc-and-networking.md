# GCP - VPC & Networking

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## **GCP Compute Networking ç®€ä»‹**

**VPCs** åŒ…å« **Firewall** è§„åˆ™ä»¥å…è®¸è¿›å…¥ VPC çš„æµé‡ã€‚VPCs è¿˜åŒ…å« **subnetworks**ï¼Œè™šæ‹Ÿæœºå°†è¿æ¥åˆ°è¿™äº›å­ç½‘ã€‚\
ä¸ AWS ç›¸æ¯”ï¼Œ**Firewall** æœ€æ¥è¿‘ **AWS** çš„ **Security Groups å’Œ NACLs**ï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™äº›è§„åˆ™æ˜¯åœ¨ **VPC** ä¸­å®šä¹‰çš„ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ªå®ä¾‹ä¸­ã€‚

## **GCP ä¸­çš„ VPCã€å­ç½‘å’Œé˜²ç«å¢™**

Compute Instances è¿æ¥åˆ°å±äº **VPCs** çš„ **subnetworks** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc))ã€‚åœ¨ GCP ä¸­æ²¡æœ‰å®‰å…¨ç»„ï¼Œæœ‰ [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls)ï¼Œè¿™äº›è§„åˆ™åœ¨ç½‘ç»œçº§åˆ«å®šä¹‰ï¼Œä½†åº”ç”¨äºæ¯ä¸ª VM å®ä¾‹ã€‚

### å­ç½‘

ä¸€ä¸ª **VPC** å¯ä»¥æœ‰ **å¤šä¸ªå­ç½‘**ã€‚æ¯ä¸ª **å­ç½‘åœ¨ä¸€ä¸ªåŒºåŸŸ**ã€‚

### é˜²ç«å¢™

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªç½‘ç»œæœ‰ä¸¤ä¸ª [**éšå«é˜²ç«å¢™è§„åˆ™**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules)ï¼š**å…è®¸å‡ºç«™** å’Œ **æ‹’ç»å…¥ç«™**ã€‚

å½“åˆ›å»ºä¸€ä¸ª GCP é¡¹ç›®æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸º **`default`** çš„ VPCï¼Œå¹¶å…·æœ‰ä»¥ä¸‹é˜²ç«å¢™è§„åˆ™ï¼š

* **default-allow-internal:** å…è®¸æ¥è‡ª `default` ç½‘ç»œä¸Šå…¶ä»–å®ä¾‹çš„æ‰€æœ‰æµé‡
* **default-allow-ssh:** å…è®¸æ¥è‡ªä»»ä½•åœ°æ–¹çš„ 22 ç«¯å£
* **default-allow-rdp:** å…è®¸æ¥è‡ªä»»ä½•åœ°æ–¹çš„ 3389 ç«¯å£
* **default-allow-icmp:** å…è®¸æ¥è‡ªä»»ä½•åœ°æ–¹çš„ ping

{% hint style="warning" %}
å¦‚ä½ æ‰€è§ï¼Œ**é˜²ç«å¢™è§„åˆ™** å¯¹ **å†…éƒ¨ IP åœ°å€** æ›´åŠ å®½æ¾ã€‚é»˜è®¤ VPC å…è®¸ Compute Instances ä¹‹é—´çš„æ‰€æœ‰æµé‡ã€‚
{% endhint %}

å¯ä»¥ä¸ºé»˜è®¤ VPC æˆ–æ–° VPC åˆ›å»ºæ›´å¤š **é˜²ç«å¢™è§„åˆ™**ã€‚ [**é˜²ç«å¢™è§„åˆ™**](https://cloud.google.com/vpc/docs/firewalls) å¯ä»¥é€šè¿‡ä»¥ä¸‹ **æ–¹æ³•** åº”ç”¨äºå®ä¾‹ï¼š

* [**ç½‘ç»œæ ‡ç­¾**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**æœåŠ¡è´¦æˆ·**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **VPC å†…çš„æ‰€æœ‰å®ä¾‹**

ä¸å¹¸çš„æ˜¯ï¼Œæ²¡æœ‰ä¸€ä¸ªç®€å•çš„ `gcloud` å‘½ä»¤å¯ä»¥åˆ—å‡ºæ‰€æœ‰åœ¨äº’è”ç½‘ä¸Šå¼€æ”¾ç«¯å£çš„ Compute Instancesã€‚ä½ å¿…é¡»å°†é˜²ç«å¢™è§„åˆ™ã€ç½‘ç»œæ ‡ç­¾ã€æœåŠ¡è´¦æˆ·å’Œå®ä¾‹è”ç³»èµ·æ¥ã€‚

è¿™ä¸ªè¿‡ç¨‹å·²ä½¿ç”¨ [è¿™ä¸ª python è„šæœ¬](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) è‡ªåŠ¨åŒ–ï¼Œè¯¥è„šæœ¬å°†å¯¼å‡ºä»¥ä¸‹å†…å®¹ï¼š

* æ˜¾ç¤ºå®ä¾‹ã€å…¬å…± IPã€å…è®¸çš„ TCPã€å…è®¸çš„ UDP çš„ CSV æ–‡ä»¶
* é’ˆå¯¹æ‰€æœ‰ä»å…¬å…±äº’è”ç½‘ï¼ˆ0.0.0.0/0ï¼‰å…è®¸å…¥ç«™ç«¯å£çš„å®ä¾‹è¿›è¡Œ nmap æ‰«æ
* é’ˆå¯¹å…è®¸æ‰€æœ‰ TCP ç«¯å£ä»å…¬å…±äº’è”ç½‘ï¼ˆ0.0.0.0/0ï¼‰è®¿é—®çš„å®ä¾‹è¿›è¡Œ masscan æ‰«æ

### åˆ†å±‚é˜²ç«å¢™ç­–ç•¥ <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_åˆ†å±‚é˜²ç«å¢™ç­–ç•¥_ å…è®¸ä½ åˆ›å»ºå¹¶ **åœ¨æ•´ä¸ªç»„ç»‡ä¸­å®æ–½ä¸€è‡´çš„é˜²ç«å¢™ç­–ç•¥**ã€‚ä½ å¯ä»¥å°† **åˆ†å±‚é˜²ç«å¢™ç­–ç•¥åˆ†é…ç»™æ•´ä¸ªç»„ç»‡** æˆ–å•ä¸ª **æ–‡ä»¶å¤¹**ã€‚è¿™äº›ç­–ç•¥åŒ…å«å¯ä»¥æ˜ç¡®æ‹’ç»æˆ–å…è®¸è¿æ¥çš„è§„åˆ™ã€‚

ä½ å¯ä»¥åˆ†æ­¥éª¤åˆ›å»ºå’Œåº”ç”¨é˜²ç«å¢™ç­–ç•¥ã€‚ä½ å¯ä»¥åœ¨ [**èµ„æºå±‚æ¬¡ç»“æ„**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) çš„ **ç»„ç»‡æˆ–æ–‡ä»¶å¤¹èŠ‚ç‚¹** åˆ›å»ºå’Œåº”ç”¨é˜²ç«å¢™ç­–ç•¥ã€‚é˜²ç«å¢™ç­–ç•¥è§„åˆ™å¯ä»¥ **é˜»æ­¢è¿æ¥ã€å…è®¸è¿æ¥æˆ–å°†é˜²ç«å¢™è§„åˆ™è¯„ä¼°** æ¨è¿Ÿåˆ°è¾ƒä½çº§åˆ«çš„æ–‡ä»¶å¤¹æˆ– VPC ç½‘ç»œä¸­å®šä¹‰çš„ VPC é˜²ç«å¢™è§„åˆ™ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰åˆ†å±‚é˜²ç«å¢™ç­–ç•¥è§„åˆ™é€‚ç”¨äºä¸ç­–ç•¥å…³è”çš„ç»„ç»‡æˆ–æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰é¡¹ç›®ä¸­çš„æ‰€æœ‰ VMã€‚ä½†æ˜¯ï¼Œä½ å¯ä»¥é€šè¿‡æŒ‡å®š [ç›®æ ‡ç½‘ç»œæˆ–ç›®æ ‡æœåŠ¡è´¦æˆ·](https://cloud.google.com/vpc/docs/firewall-policies#targets) æ¥ **é™åˆ¶å“ªäº› VM è·å¾—ç‰¹å®šè§„åˆ™**ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»å¦‚ä½• [**åˆ›å»ºåˆ†å±‚é˜²ç«å¢™ç­–ç•¥**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)ã€‚

### é˜²ç«å¢™è§„åˆ™è¯„ä¼°

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. ç»„ç»‡ï¼šåˆ†é…ç»™ç»„ç»‡çš„é˜²ç«å¢™ç­–ç•¥
2. æ–‡ä»¶å¤¹ï¼šåˆ†é…ç»™æ–‡ä»¶å¤¹çš„é˜²ç«å¢™ç­–ç•¥
3. VPCï¼šåˆ†é…ç»™ VPC çš„é˜²ç«å¢™è§„åˆ™
4. å…¨å±€ï¼šå¦ä¸€ç§å¯ä»¥åˆ†é…ç»™ VPC çš„é˜²ç«å¢™è§„åˆ™
5. åŒºåŸŸï¼šä¸ VM çš„ NIC å’Œ VM åŒºåŸŸçš„ VPC ç½‘ç»œç›¸å…³çš„é˜²ç«å¢™è§„åˆ™

## VPC ç½‘ç»œå¯¹ç­‰

å…è®¸è¿æ¥ä¸¤ä¸ªè™šæ‹Ÿç§æœ‰äº‘ (VPC) ç½‘ç»œï¼Œä»¥ä¾¿ **æ¯ä¸ªç½‘ç»œä¸­çš„èµ„æºå¯ä»¥ç›¸äº’é€šä¿¡**ã€‚\
å¯¹ç­‰ VPC ç½‘ç»œå¯ä»¥åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­ã€åŒä¸€ç»„ç»‡çš„ä¸åŒé¡¹ç›®ä¸­ï¼Œæˆ– **ä¸åŒç»„ç»‡çš„ä¸åŒé¡¹ç›®ä¸­**ã€‚

è¿™äº›æ˜¯æ‰€éœ€çš„æƒé™ï¼š

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**æ›´å¤šæ–‡æ¡£**](https://cloud.google.com/vpc/docs/vpc-peering)ã€‚

## å‚è€ƒèµ„æ–™

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
