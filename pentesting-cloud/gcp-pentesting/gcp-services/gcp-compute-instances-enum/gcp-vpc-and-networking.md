# GCP - VPC & Networking

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da bizi **Twitter**'da takip edin ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.**

</details>
{% endhint %}

## **GCP Compute Networking KÄ±saca**

**VPC'ler**, VPC'ye gelen trafiÄŸe izin vermek iÃ§in **Firewall** kurallarÄ± iÃ§erir. VPC'ler ayrÄ±ca **sanallaÅŸtÄ±rÄ±lmÄ±ÅŸ makinelerin** **baÄŸlanacaÄŸÄ±** **alt aÄŸlarÄ±** iÃ§erir.\
AWS ile karÅŸÄ±laÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, **Firewall**, **AWS** **Security Groups ve NACL'lere** en yakÄ±n ÅŸey olacaktÄ±r, ancak bu durumda bunlar **her bir instance'da deÄŸil, VPC'de tanÄ±mlanÄ±r**.

## **GCP'de VPC, Alt AÄŸlar ve Firewalls**

Compute Instances, **VPC'lerin** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)) bir parÃ§asÄ± olan **alt aÄŸlara** baÄŸlanÄ±r. GCP'de gÃ¼venlik gruplarÄ± yoktur, [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls) vardÄ±r ve bu kurallar aÄŸ seviyesinde tanÄ±mlanÄ±r ancak her VM Instance'a uygulanÄ±r.

### Alt AÄŸlar

Bir **VPC**'nin **birden fazla alt aÄŸÄ±** olabilir. Her **alt aÄŸ 1 bÃ¶lgede** bulunur.

### Firewalls

VarsayÄ±lan olarak, her aÄŸda iki [**Ã¶rtÃ¼k firewall kuralÄ±**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules) vardÄ±r: **giden trafiÄŸe izin ver** ve **gelen trafiÄŸi reddet**.

Bir GCP projesi oluÅŸturulduÄŸunda, **`default`** adlÄ± bir VPC de oluÅŸturulur ve aÅŸaÄŸÄ±daki firewall kurallarÄ± ile birlikte gelir:

* **default-allow-internal:** `default` aÄŸÄ±ndaki diÄŸer instance'lardan gelen tÃ¼m trafiÄŸe izin ver
* **default-allow-ssh:** her yerden 22'ye izin ver
* **default-allow-rdp:** her yerden 3389'a izin ver
* **default-allow-icmp:** her yerden ping'e izin ver

{% hint style="warning" %}
GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, **firewall kurallarÄ±** **iÃ§ IP adresleri** iÃ§in **daha izin verici** olma eÄŸilimindedir. VarsayÄ±lan VPC, Compute Instances arasÄ±nda tÃ¼m trafiÄŸe izin verir.
{% endhint %}

VarsayÄ±lan VPC veya yeni VPC'ler iÃ§in daha fazla **Firewall kuralÄ±** oluÅŸturulabilir. [**Firewall kurallarÄ±**](https://cloud.google.com/vpc/docs/firewalls) aÅŸaÄŸÄ±daki **yÃ¶ntemlerle** instance'lara uygulanabilir:

* [**AÄŸ etiketleri**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Servis hesaplarÄ±**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Bir VPC iÃ§indeki tÃ¼m instance'lar**

Ne yazÄ±k ki, internette aÃ§Ä±k portlara sahip tÃ¼m Compute Instances'Ä± listeleyen basit bir `gcloud` komutu yoktur. Firewall kurallarÄ±, aÄŸ etiketleri, servis hesaplarÄ± ve instance'lar arasÄ±nda baÄŸlantÄ± kurmanÄ±z gerekir.

Bu sÃ¼reÃ§, [bu python scripti](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) kullanÄ±larak otomatikleÅŸtirildi ve aÅŸaÄŸÄ±dakileri dÄ±ÅŸa aktaracaktÄ±r:

* Instance, public IP, izin verilen TCP, izin verilen UDP gÃ¶steren CSV dosyasÄ±
* Public internetten (0.0.0.0/0) gelen trafiÄŸe izin verilen portlarda tÃ¼m instance'larÄ± hedefleyen nmap taramasÄ±
* Public internetten (0.0.0.0/0) TÃœM TCP portlarÄ±na izin veren instance'larÄ±n tam TCP aralÄ±ÄŸÄ±nÄ± hedefleyen masscan

### HiyerarÅŸik Firewall PolitikalarÄ± <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_HiyerarÅŸik firewall politikalarÄ±_, **kuruluÅŸunuz genelinde tutarlÄ± bir firewall politikasÄ± oluÅŸturmanÄ±za ve uygulamanÄ±za** olanak tanÄ±r. **HiyerarÅŸik firewall politikalarÄ±nÄ± tÃ¼m kuruluÅŸa veya bireysel **klasÃ¶rlere** atayabilirsiniz. Bu politikalar, baÄŸlantÄ±larÄ± aÃ§Ä±kÃ§a reddedebilen veya izin verebilen kurallar iÃ§erir.

Firewall politikalarÄ±nÄ± oluÅŸturma ve uygulama adÄ±mlarÄ± ayrÄ± olarak gerÃ§ekleÅŸtirilir. Firewall politikalarÄ±nÄ± **kuruluÅŸ veya klasÃ¶r dÃ¼ÄŸÃ¼mlerinde** [**kaynak hiyerarÅŸisi**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) oluÅŸturabilir ve uygulayabilirsiniz. Bir firewall politika kuralÄ±, **baÄŸlantÄ±larÄ± engelleyebilir, baÄŸlantÄ±lara izin verebilir veya firewall kuralÄ± deÄŸerlendirmesini** daha alt dÃ¼zey klasÃ¶rlere veya VPC aÄŸlarÄ±nda tanÄ±mlanan VPC firewall kurallarÄ±na devredebilir.

VarsayÄ±lan olarak, tÃ¼m hiyerarÅŸik firewall politika kurallarÄ±, politikanÄ±n iliÅŸkilendirildiÄŸi kuruluÅŸ veya klasÃ¶r altÄ±ndaki tÃ¼m projelerdeki tÃ¼m VM'lere uygulanÄ±r. Ancak, [hedef aÄŸlar veya hedef servis hesaplarÄ±](https://cloud.google.com/vpc/docs/firewall-policies#targets) belirterek belirli VM'lere verilen bir kuralÄ± kÄ±sÄ±tlayabilirsiniz.

[**HiyerarÅŸik Firewall PolitikasÄ± oluÅŸturma**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud) hakkÄ±nda buradan bilgi alabilirsiniz.

### Firewall KurallarÄ± DeÄŸerlendirmesi

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: KuruluÅŸa atanan firewall politikalarÄ±
2. Folder: KlasÃ¶re atanan firewall politikalarÄ±
3. VPC: VPC'ye atanan firewall kurallarÄ±
4. Global: VPC'lere atanabilen baÅŸka bir tÃ¼r firewall kurallarÄ±
5. Regional: VM'nin NIC ve bÃ¶lgesinin VPC aÄŸÄ± ile iliÅŸkili firewall kurallarÄ±

## VPC AÄŸ EÅŸlemesi

Ä°ki Virtual Private Cloud (VPC) aÄŸÄ±nÄ± birbirine baÄŸlamanÄ±zÄ± saÄŸlar, bÃ¶ylece **her iki aÄŸdaki kaynaklar birbirleriyle iletiÅŸim kurabilir**.\
EÅŸlenmiÅŸ VPC aÄŸlarÄ± aynÄ± projede, aynÄ± kuruluÅŸun farklÄ± projelerinde veya **farklÄ± kuruluÅŸlarÄ±n farklÄ± projelerinde** olabilir.

Gerekli izinler ÅŸunlardÄ±r:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Daha fazla bilgi iÃ§in dokÃ¼manlar**](https://cloud.google.com/vpc/docs/vpc-peering).

## Referanslar

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da bizi **Twitter**'da takip edin ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.**

</details>
{% endhint %}
