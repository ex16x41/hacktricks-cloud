# GCP - Enumeracja instancji obliczeniowych

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}

## GCP VPC & Sieciowanie

Dowiedz si, jak to dziaa w:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeracja

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

atwo znajdziesz instancje obliczeniowe z otwartymi reguami zapory sieciowej za pomoc [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Instancje obliczeniowe

To jest spos贸b, w jaki **uruchamiasz maszyny wirtualne w GCP.** Sprawd藕 t stron, aby uzyska wicej informacji:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeracja
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Aby uzyska wicej informacji na temat **SSH** lub **modyfikacji metadanych** instancji w celu **przywaszczenia uprawnie**, sprawd藕 t stron:

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Przywaszczenie uprawnie

Na nastpnej stronie mo偶esz sprawdzi, jak **wykorzysta uprawnienia obliczeniowe do eskalacji uprawnie**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Enumeracja bez uwierzytelnienia

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Po eksploatacji

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Trwao

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Dzienniki konsoli szeregowej

Dzienniki konsoli szeregowej Compute Engine to funkcja, kt贸ra pozwala **wywietla i diagnozowa dzienniki uruchamiania i systemu operacyjnego** twoich instancji maszyn wirtualnych.

Dzienniki konsoli szeregowej zapewniaj **niskopoziomowy widok procesu uruchamiania instancji**, w tym komunikaty jdra, skrypty init oraz inne zdarzenia systemowe, kt贸re wystpuj podczas uruchamiania. Mo偶e to by przydatne do debugowania problem贸w z uruchamianiem, identyfikowania bd贸w konfiguracji lub oprogramowania, lub rozwizywania problem贸w z cznoci sieciow.

Te dzienniki **mog ujawni poufne informacje** z dziennik贸w systemowych, kt贸rych zwykle nie widzi nisko uprzywilejowany u偶ytkownik, ale przy odpowiednich uprawnieniach IAM mo偶esz je odczyta.

Mo偶esz u偶y nastpujcej [komendy gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output), aby zapyta dzienniki portu szeregowego (wymagane uprawnienie to `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Mened偶er konfiguracji systemu operacyjnego

Mo偶esz u偶y usugi zarzdzania konfiguracj systemu operacyjnego do **wdro偶enia, zapytania i utrzymania sp贸jnych konfiguracji** (stanu docelowego i oprogramowania) dla twojej instancji maszyny wirtualnej (VM). W Compute Engine musisz u偶y [polityk gocinnych](https://cloud.google.com/compute/docs/os-config-management#guest-policy) aby utrzyma sp贸jne konfiguracje oprogramowania na VM.

Funkcja zarzdzania konfiguracj systemu operacyjnego pozwala zdefiniowa polityki konfiguracji, kt贸re okrelaj, kt贸re pakiety oprogramowania powinny by zainstalowane, kt贸re usugi powinny by wczone, oraz kt贸re pliki lub konfiguracje powinny by obecne na twoich VM. Mo偶esz u偶y deklaratywnego podejcia do zarzdzania konfiguracj oprogramowania twoich VM, co pozwala na atwiejsze automatyzowanie i skalowanie procesu zarzdzania konfiguracj.

To r贸wnie偶 pozwala na logowanie si do instancji za pomoc uprawnie IAM, wic jest bardzo **przydatne do eskalacji uprawnie i przekierowywania**.

{% hint style="warning" %}
Aby **wczy os-config w caym projekcie lub w instancji**, wystarczy ustawi klucz **`enable-oslogin`** metadanych na **`true`** na po偶danym poziomie.\
Co wicej, mo偶esz ustawi metadane **`enable-oslogin-2fa`** na **`true`** aby wczy uwierzytelnianie dwuetapowe.

Gdy wczysz to podczas tworzenia instancji, klucze metadanych zostan automatycznie ustawione.
{% endhint %}

Wicej informacji na temat **2fa w OS-config**, **dotyczy to tylko u偶ytkownika**, jeli jest to SA (jak SA obliczeniowy) nie bdzie wymaga niczego dodatkowego.

### Eksploracja
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Obrazy

### Niestandardowe obrazy

Niestandardowe obrazy obliczeniowe mog zawiera wra偶liwe szczeg贸y lub inne podatne konfiguracje, kt贸re mo偶na wykorzysta.

Podczas tworzenia obrazu mo偶esz wybra **3 rodzaje szyfrowania**: korzystajc z **zarzdzanego klucza Google** (domylnie), klucza z **KMS** lub **klucza surowego** podanego przez klienta.

#### Wyliczanie

Mo偶esz zapyta o list obraz贸w niestandardowych w projekcie za pomoc nastpujcej komendy:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Nastpnie mo偶esz [**eksportowa**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **dyski wirtualne** z dowolnego obrazu w wielu formatach. Poni偶sze polecenie eksportuje obraz `test-image` w formacie qcow2, umo偶liwiajc pobranie pliku i zbudowanie maszyny wirtualnej lokalnie w celu dalszego zbadania:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Eskalacja uprawnie

Sprawd藕 sekcj eskalacji uprawnie instancji obliczeniowych.

### Niestandardowe szablony instancji

[**Szablon instancji**](https://cloud.google.com/compute/docs/instance-templates/) **definiuje waciwoci instancji** pomagajce w wdra偶aniu sp贸jnych konfiguracji. Mog one zawiera te same rodzaje danych wra偶liwych, co niestandardowe metadane dziaajcej instancji. Mo偶esz u偶y poni偶szych polece do zbadania:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Mo偶e by interesujce dowiedzie si, kt贸ry dysk jest u偶ywany do nowych obraz贸w, ale te szablony zazwyczaj nie bd zawiera poufnych informacji.

## Snapshoty

**Snapshoty to kopie zapasowe dysk贸w**. Nale偶y zauwa偶y, 偶e nie jest to to偶same z klonowaniem dysku (inn dostpn funkcj).\
**Snapshot** bdzie u偶ywa **tej samej szyfrowania co dysk**, z kt贸rego zosta wykonany.

### Wyliczenie
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Eskalacja uprawnie

Sprawd藕 sekcj eskalacji uprawnie instancji obliczeniowych.

## Referencje

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
Naucz si i praktykuj Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz si i praktykuj Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpniaj sztuczki hakerskie, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
