# GCP - Enumeracija ra캜unara

{% hint style="success" %}
Nau캜ite i ve쬭ajte hakovanje AWS-a: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## GCP VPC & Mre쬰nje

Saznajte kako ovo funkcioni코e u:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeracija

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Lako mo쬰te prona캖i ra캜unske instance sa otvorenim pravilima za firewall sa [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Ra캜unske instance

Ovo je na캜in na koji mo쬰te **pokrenuti virtuelne ma코ine unutar GCP-a.** Pogledajte ovu stranicu za vi코e informacija:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeracija
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Za vi코e informacija o tome kako **SSH** ili **modifikovati metapodatke** instance radi **pove캖anja privilegija**, pogledajte ovu stranicu:

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Pove캖anje privilegija

Na slede캖oj stranici mo쬰te proveriti kako **zloupotrebiti dozvole ra캜unanja radi pove캖anja privilegija**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Neautentifikovano nabrajanje

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Post eksploatacija

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Upornost

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Zapisnici serijske konzole

Zapisnici serijske konzole Compute Engine-a su funkcija koja vam omogu캖ava da **pogledate i dijagnostikujete zapisnike pokretanja i operativnog sistema** va코ih virtuelnih ma코ina.

Zapisnici serijske konzole pru쬬ju **niskonivojski prikaz procesa pokretanja instance**, uklju캜uju캖i poruke jezgra, inicijalne skripte i druge sistemskie doga캠aje koji se de코avaju tokom pokretanja. Ovo mo쬰 biti korisno za otklanjanje problema sa pokretanjem, identifikaciju neispravnosti ili gre코aka u softveru ili re코avanje problema sa mre쬹om povezano코캖u.

Ovi zapisnici **mogu otkriti osetljive informacije** iz zapisnika sistema koje niskoprivilegovani korisnik obi캜no ne bi video, ali uz odgovaraju캖e IAM dozvole mo쬯a 캖ete mo캖i da ih pro캜itate.

Mo쬰te koristiti slede캖u [gcloud komandu](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) za upit zapisnika serijskog porta (potrebna dozvola je `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Menad쬰r konfiguracije operativnog sistema

Mo쬰te koristiti uslugu upravljanja konfiguracijom operativnog sistema da **implementirate, upitujete i odr쬬vate dosledne konfiguracije** (쬰ljeno stanje i softver) za svoj VM instancu (VM). Na Compute Engine-u, morate koristiti [gostuju캖e politike](https://cloud.google.com/compute/docs/os-config-management#guest-policy) da biste odr쬬vali dosledne softverske konfiguracije na VM-u.

Funkcija upravljanja konfiguracijom operativnog sistema omogu캖ava vam da defini코ete politike konfiguracije koje specificiraju koje softverske pakete treba instalirati, koje servise treba omogu캖iti, i koje fajlove ili konfiguracije treba da budu prisutni na va코im VM-ovima. Mo쬰te koristiti deklarativni pristup za upravljanje softverskom konfiguracijom va코ih VM-ova, 코to vam omogu캖ava da automatizujete i skalirate svoj proces upravljanja konfiguracijom lak코e.

Ovo tako캠e omogu캖ava prijavljivanje na instance putem IAM dozvola, tako da je veoma **korisno za privesc i pivoting**.

{% hint style="warning" %}
Da biste **omogu캖ili os-config u celom projektu ili na instanci**, samo treba postaviti **klju캜 metapodataka** **`enable-oslogin`** na **`true`** na 쬰ljenom nivou.\
Osim toga, mo쬰te postaviti metapodatke **`enable-oslogin-2fa`** na **`true`** da biste omogu캖ili 2fa.

Kada ga omogu캖ite prilikom kreiranja instance, klju캜evi metapodataka 캖e automatski biti postavljeni.
{% endhint %}

Vi코e o **2fa u OS-config**, **primenjuje se samo ako je korisnik korisnik**, ako je SA (kao 코to je compute SA) ne캖e zahtevati ni코ta dodatno.

### Enumeracija
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Slike

### Prilago캠ene slike

**Prilago캠ene ra캜unske slike mogu sadr쬬ti osetljive detalje** ili druge ranjive konfiguracije koje mo쬰te iskoristiti.

Kada se slika kreira, mo쬰te izabrati **3 vrste enkripcije**: Kori코캖enje **Google upravljane klju캜eve** (podrazumevano), klju캜a iz **KMS-a**, ili **sirovog klju캜a** datog od strane klijenta.

#### Enumeracija

Mo쬰te upitati listu nestandardnih slika u projektu pomo캖u slede캖e komande:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Mo쬰te zatim [**izvesti**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **virtuelne diskove** sa bilo koje slike u vi코e formata. Slede캖a komanda bi izvezla sliku `test-image` u qcow2 formatu, omogu캖avaju캖i vam da preuzmete datoteku i izgradite virtuelnu ma코inu lokalno radi daljeg istra쬴vanja:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Eskalacija privilegija

Proverite sekciju eskalacije privilegija za ra캜unske instance.

### Prilago캠ene 코ablone instanci

[**마blon instance**](https://cloud.google.com/compute/docs/instance-templates/) **defini코e osobine instance** kako bi pomogao u implementaciji doslednih konfiguracija. Oni mogu sadr쬬ti iste vrste osetljivih podataka kao prilago캠eni metapodaci pokrenute instance. Mo쬰te koristiti slede캖e komande za istra쬴vanje:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Moglo bi biti interesantno saznati koji disk koriste nove slike, ali ovi predlo코ci obi캜no ne캖e imati osetljive informacije.

## Snimci

**Snimci su rezervne kopije diskova**. Imajte na umu da ovo nije isto kao kloniranje diska (jo코 jedna dostupna funkcija).\
**Snimak** 캖e koristiti **istu enkripciju kao disk** sa kog je napravljen. 

### Enumeracija
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Eskalacija privilegija

Proverite sekciju Eskalacija privilegija za ra캜unske instance.

## Reference

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
Nau캜ite i ve쬭ajte hakovanje AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte hakovanje GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili **telegram grupi** ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
