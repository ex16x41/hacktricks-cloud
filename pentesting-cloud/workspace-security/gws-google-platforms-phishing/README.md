# GWS - Phishing sur les plateformes Google

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## M√©thodologie de Phishing G√©n√©rique

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Phishing sur Google Groups

Apparemment, par d√©faut, dans workspace, les membres [**peuvent cr√©er des groupes**](https://groups.google.com/all-groups) **et inviter des personnes √† ceux-ci**. Vous pouvez ensuite modifier l'email qui sera envoy√© √† l'utilisateur **en ajoutant des liens.** L'**email proviendra d'une adresse google**, donc il aura l'air **l√©gitime** et les gens pourraient cliquer sur le lien.

Il est √©galement possible de d√©finir l'adresse **FROM** comme l'**email du groupe Google** pour envoyer **plus d'emails aux utilisateurs √† l'int√©rieur du groupe**, comme dans l'image suivante o√π le groupe **`google--support@googlegroups.com`** a √©t√© cr√©√© et un **email a √©t√© envoy√© √† tous les membres** du groupe (qui ont √©t√© ajout√©s sans aucun consentement)

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

## Phishing sur Google Chat

Vous pourriez √™tre en mesure de **d√©marrer une discussion** avec une personne simplement en ayant son adresse email ou d'envoyer une **invitation √† discuter**. De plus, il est possible de **cr√©er un Espace** qui peut avoir n'importe quel nom (par exemple "Support Google") et **inviter** des membres √† celui-ci. S'ils acceptent, ils pourraient penser qu'ils parlent au Support Google :

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**Cependant, lors de mes tests, les membres invit√©s n'ont m√™me pas re√ßu d'invitation.**
{% endhint %}

Vous pouvez v√©rifier comment cela a fonctionn√© dans le pass√© ici : [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Phishing sur Google Doc

Dans le pass√©, il √©tait possible de cr√©er un **document apparemment l√©gitime** et dans un commentaire **mentionner un email (comme @user@gmail.com)**. Google **a envoy√© un email √† cette adresse email** pour notifier qu'ils avaient √©t√© mentionn√©s dans le document.\
Aujourd'hui, cela ne fonctionne plus mais si vous **donnez √† la victime un acc√®s email au document**, Google enverra un email l'indiquant. Voici le message qui appara√Æt lorsque vous mentionnez quelqu'un :

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Les victimes pourraient avoir un m√©canisme de protection qui n'autorise pas que les emails indiquant qu'un document externe a √©t√© partag√© avec elles atteignent leur email.
{% endhint %}

## Phishing sur Google Calendar

Vous pouvez **cr√©er un √©v√©nement de calendrier** et ajouter autant d'adresses email de l'entreprise que vous attaquez. Planifiez cet √©v√©nement de calendrier dans **5 ou 15 minutes** √† partir de l'heure actuelle. Faites en sorte que l'√©v√©nement ait l'air l√©gitime et **mettez un commentaire et un titre indiquant qu'ils doivent lire quelque chose** (avec le **lien de phishing**).

Voici l'alerte qui appara√Ætra dans le navigateur avec un titre de r√©union "Licenciement de personnes", donc vous pourriez d√©finir un titre plus orient√© phishing (et m√™me changer le nom associ√© √† votre email).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Pour le rendre moins suspect :

* Configurez-le de sorte que **les destinataires ne puissent pas voir les autres personnes invit√©es**
* **NE PAS envoyer d'emails notifiant de l'√©v√©nement**. Ainsi, les gens ne verront que leur avertissement concernant une r√©union dans 5 minutes et qu'ils doivent lire ce lien.
* Apparemment, en utilisant l'API, vous pouvez d√©finir √† **True** que **les personnes** ont **accept√©** l'√©v√©nement et m√™me cr√©er **des commentaires en leur nom**.

## Phishing par redirection de scripts d'application

Il est possible de cr√©er un script sur [https://script.google.com/](https://script.google.com/) et **de l'exposer comme une application web accessible par tous** qui utilisera le domaine l√©gitime **`script.google.com`**.\
Avec un code comme le suivant, un attaquant pourrait faire en sorte que le script charge du contenu arbitraire sur cette page sans cesser d'acc√©der au domaine :

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

Par exemple, en acc√©dant √† [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec), vous verrez :

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Notez qu'un avertissement appara√Ætra lorsque le contenu sera charg√© dans un iframe.
{% endhint %}

## Phishing OAuth des scripts d'application

Il est possible de cr√©er des scripts d'application attach√©s √† des documents pour essayer d'acc√©der au token OAuth d'une victime. Pour plus d'informations, consultez :

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## Phishing des applications OAuth

Chacune des techniques pr√©c√©dentes peut √™tre utilis√©e pour amener l'utilisateur √† acc√©der √† une **application OAuth Google** qui **demande** √† l'utilisateur certains **acc√®s**. Si l'utilisateur **fait confiance** √† la **source**, il peut **faire confiance** √† l'**application** (m√™me si elle demande des autorisations tr√®s privil√©gi√©es).

{% hint style="info" %}
Notez que Google pr√©sente un prompt peu attrayant avertissant que l'application est non fiable dans plusieurs cas, et les administrateurs de Workspace peuvent m√™me emp√™cher les gens d'accepter des applications OAuth.
{% endhint %}

**Google** permet de cr√©er des applications qui peuvent **interagir au nom des utilisateurs** avec plusieurs **services Google** : Gmail, Drive, GCP...

Lors de la cr√©ation d'une application pour **agir au nom d'autres utilisateurs**, le d√©veloppeur doit cr√©er une **application OAuth dans GCP** et indiquer les scopes (permissions) dont l'application a besoin pour acc√©der aux donn√©es des utilisateurs.\
Lorsqu'un **utilisateur** souhaite **utiliser** cette **application**, il sera **invit√©** √† **accepter** que l'application aura acc√®s √† ses donn√©es sp√©cifi√©es dans les scopes.

C'est un moyen tr√®s juteux de **phisher** des utilisateurs non techniques en les amenant √† utiliser des **applications qui acc√®dent √† des informations sensibles** car ils pourraient ne pas comprendre les cons√©quences. Cependant, dans les comptes d'organisations, il existe des moyens d'emp√™cher cela.

### Avertissement d'application non v√©rifi√©e

Comme mentionn√©, Google pr√©sentera toujours un **prompt √† l'utilisateur pour accepter** les permissions qu'il accorde √† l'application en son nom. Cependant, si l'application est consid√©r√©e comme **dangereuse**, Google affichera **d'abord** un **prompt** indiquant qu'elle est **dangereuse** et **rendant plus difficile** pour l'utilisateur d'accorder les permissions √† l'application.

Ce prompt appara√Æt dans les applications qui :

* Utilisent un scope qui peut acc√©der √† des donn√©es priv√©es (Gmail, Drive, GCP, BigQuery...)
* Applications avec moins de 100 utilisateurs (pour les applications > 100, un processus de r√©vision est √©galement n√©cessaire pour arr√™ter d'afficher le prompt non v√©rifi√©)

### Scopes int√©ressants

[**Ici**](https://developers.google.com/identity/protocols/oauth2/scopes), vous pouvez trouver une liste de tous les scopes OAuth de Google.

* **cloud-platform** : Voir et g√©rer vos donn√©es √† travers les services de **Google Cloud Platform**. Vous pouvez usurper l'identit√© de l'utilisateur dans GCP.
* **admin.directory.user.readonly** : Voir et t√©l√©charger le r√©pertoire GSuite de votre organisation. Obtenez les noms, t√©l√©phones, URL de calendrier de tous les utilisateurs.

### Cr√©er une application OAuth

**Commencez √† cr√©er un ID client OAuth**

1. Allez sur [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) et cliquez sur configurer l'√©cran de consentement.
2. Ensuite, on vous demandera si le **type d'utilisateur** est **interne** (uniquement pour les personnes de votre organisation) ou **externe**. S√©lectionnez celui qui convient √† vos besoins.
* Interne peut √™tre int√©ressant si vous avez d√©j√† compromis un utilisateur de l'organisation et que vous cr√©ez cette application pour en phisher un autre.
3. Donnez un **nom** √† l'application, un **email de support** (notez que vous pouvez d√©finir un email de groupe Google pour essayer de vous anonymiser un peu plus), un **logo**, des **domaines autoris√©s** et un autre **email** pour les **mises √† jour**.
4. **S√©lectionnez** les **scopes OAuth**.
* Cette page est divis√©e en permissions non sensibles, permissions sensibles et permissions restreintes. Chaque fois que vous ajoutez une nouvelle permission, elle est ajout√©e √† sa cat√©gorie. En fonction des permissions demand√©es, diff√©rents prompts appara√Ætront pour l'utilisateur indiquant √† quel point ces permissions sont sensibles.
* Les permissions **`admin.directory.user.readonly`** et **`cloud-platform`** sont des permissions sensibles.
5. **Ajoutez les utilisateurs de test.** Tant que le statut de l'application est en test, seuls ces utilisateurs pourront acc√©der √† l'application, alors assurez-vous d'**ajouter l'email que vous allez phisher**.

Maintenant, obtenons des **identifiants pour une application web** en utilisant l'**ID client OAuth pr√©c√©demment cr√©√©** :

1. Retournez sur [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), une option diff√©rente appara√Ætra cette fois.
2. S√©lectionnez pour **cr√©er des identifiants pour une application web**.
3. D√©finissez les **origines Javascript** et les **URI de redirection** n√©cessaires.
* Vous pouvez d√©finir dans les deux quelque chose comme **`http://localhost:8000/callback`** pour les tests.
4. Obtenez vos **identifiants d'application**.

Enfin, ex√©cutons une **application web qui utilisera les identifiants de l'application OAuth**. Vous pouvez trouver un exemple sur [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
Allez √† **`http://localhost:8000`**, cliquez sur le bouton Connexion avec Google, vous serez **invit√©** avec un message comme celui-ci :

<figure><img src="../../../.gitbook/assets/image (333).png" alt=""><figcaption></figcaption></figure>

L'application affichera le **jeton d'acc√®s et le jeton de rafra√Æchissement** qui peuvent √™tre facilement utilis√©s. Pour plus d'informations sur **comment utiliser ces jetons, consultez** :

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### Utilisation de `glcoud`

Il est possible de faire quelque chose en utilisant gcloud au lieu de la console web, consultez :

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite : Le pouvoir de la magie des scripts d'applications sombres
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch et Beau Bullock - OK Google, comment puis-je Red Team GSuite ?

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
