# GWS - Google Platforms Phishing

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Metodologia Gen√©rica de Phishing

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Phishing em Grupos do Google

Aparentemente, por padr√£o, em workspace os membros [**podem criar grupos**](https://groups.google.com/all-groups) **e convidar pessoas para eles**. Voc√™ pode ent√£o modificar o e-mail que ser√° enviado ao usu√°rio **adicionando alguns links.** O **e-mail vir√° de um endere√ßo do google**, ent√£o parecer√° **leg√≠timo** e as pessoas podem clicar no link.

Tamb√©m √© poss√≠vel definir o endere√ßo **FROM** como o **e-mail do grupo do Google** para enviar **mais e-mails para os usu√°rios dentro do grupo**, como na imagem a seguir onde o grupo **`google--support@googlegroups.com`** foi criado e um **e-mail foi enviado a todos os membros** do grupo (que foram adicionados sem qualquer consentimento)

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

## Phishing no Google Chat

Voc√™ pode ser capaz de **iniciar um chat** com uma pessoa apenas tendo seu endere√ßo de e-mail ou enviar um **convite para conversar**. Al√©m disso, √© poss√≠vel **criar um Espa√ßo** que pode ter qualquer nome (por exemplo, "Suporte do Google") e **convidar** membros para ele. Se aceitarem, podem pensar que est√£o conversando com o Suporte do Google:

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**Nos meus testes, no entanto, os membros convidados nem sequer receberam um convite.**
{% endhint %}

Voc√™ pode verificar como isso funcionou no passado em: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Phishing no Google Docs

No passado, era poss√≠vel criar um **documento aparentemente leg√≠timo** e em um coment√°rio **mencionar algum e-mail (como @user@gmail.com)**. O Google **enviava um e-mail para esse endere√ßo de e-mail** notificando que ele foi mencionado no documento.\
Hoje em dia, isso n√£o funciona, mas se voc√™ **der ao e-mail da v√≠tima acesso ao documento** o Google enviar√° um e-mail indicando isso. Esta √© a mensagem que aparece quando voc√™ menciona algu√©m:

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
As v√≠timas podem ter mecanismos de prote√ß√£o que n√£o permitem que e-mails indicando que um documento externo foi compartilhado com elas cheguem ao seu e-mail.
{% endhint %}

## Phishing no Google Calendar

Voc√™ pode **criar um evento de calend√°rio** e adicionar quantos endere√ßos de e-mail da empresa que voc√™ est√° atacando tiver. Programe este evento de calend√°rio em **5 ou 15 min** a partir do hor√°rio atual. Fa√ßa o evento parecer leg√≠timo e **coloque um coment√°rio e um t√≠tulo indicando que eles precisam ler algo** (com o **link de phishing**).

Este √© o alerta que aparecer√° no navegador com um t√≠tulo de reuni√£o "Demiss√£o de Pessoas", ent√£o voc√™ poderia definir um t√≠tulo mais parecido com phishing (e at√© mesmo mudar o nome associado ao seu e-mail).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Para parecer menos suspeito:

* Configure para que **os destinat√°rios n√£o possam ver as outras pessoas convidadas**
* **N√ÉO envie e-mails notificando sobre o evento**. Assim, as pessoas s√≥ ver√£o seu aviso sobre uma reuni√£o em 5 minutos e que precisam ler aquele link.
* Aparentemente, usando a API, voc√™ pode definir como **Verdadeiro** que **as pessoas** aceitaram **o evento** e at√© mesmo criar **coment√°rios em nome delas**.

## Phishing de Redirecionamento de Scripts de Aplicativos

√â poss√≠vel criar um script em [https://script.google.com/](https://script.google.com/) e **expor como uma aplica√ß√£o web acess√≠vel por todos** que usar√° o dom√≠nio leg√≠timo **`script.google.com`**.\
Com algum c√≥digo como o seguinte, um atacante poderia fazer o script carregar conte√∫do arbitr√°rio nesta p√°gina sem parar de acessar o dom√≠nio:

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

Por exemplo, acessando [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec) voc√™ ver√°:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Observe que um aviso aparecer√° √† medida que o conte√∫do for carregado dentro de um iframe.
{% endhint %}

## Phishing de OAuth de Scripts de Aplicativos

√â poss√≠vel criar Scripts de Aplicativos anexados a documentos para tentar obter acesso ao token OAuth de uma v√≠tima, para mais informa√ß√µes, consulte:

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## Phishing de Aplicativos OAuth

Qualquer uma das t√©cnicas anteriores pode ser usada para fazer o usu√°rio acessar um **aplicativo OAuth do Google** que **solicitar√°** ao usu√°rio algum **acesso**. Se o usu√°rio **confiar** na **fonte**, ele pode **confiar** na **aplica√ß√£o** (mesmo que esteja pedindo permiss√µes de alto privil√©gio).

{% hint style="info" %}
Observe que o Google apresenta um aviso feio informando que a aplica√ß√£o √© n√£o confi√°vel em v√°rios casos e os administradores do Workspace podem at√© impedir que as pessoas aceitem aplicativos OAuth.
{% endhint %}

**Google** permite criar aplicativos que podem **interagir em nome dos usu√°rios** com v√°rios **servi√ßos do Google**: Gmail, Drive, GCP...

Ao criar um aplicativo para **agir em nome de outros usu√°rios**, o desenvolvedor precisa criar um **aplicativo OAuth dentro do GCP** e indicar os escopos (permiss√µes) que o aplicativo precisa para acessar os dados dos usu√°rios.\
Quando um **usu√°rio** deseja **usar** esse **aplicativo**, ele ser√° **solicitado** a **aceitar** que o aplicativo ter√° acesso aos seus dados especificados nos escopos.

Esta √© uma maneira muito atraente de **phish** usu√°rios n√£o t√©cnicos para usar **aplicativos que acessam informa√ß√µes sens√≠veis** porque eles podem n√£o entender as consequ√™ncias. No entanto, em contas de organiza√ß√µes, existem maneiras de evitar que isso aconte√ßa.

### Aviso de Aplicativo N√£o Verificado

Como foi mencionado, o Google sempre apresentar√° um **aviso ao usu√°rio para aceitar** as permiss√µes que est√£o concedendo ao aplicativo em seu nome. No entanto, se o aplicativo for considerado **perigoso**, o Google mostrar√° **primeiro** um **aviso** indicando que √© **perigoso** e **dificultando** para o usu√°rio conceder as permiss√µes ao aplicativo.

Esse aviso aparece em aplicativos que:

* Usam qualquer escopo que pode acessar dados privados (Gmail, Drive, GCP, BigQuery...)
* Aplicativos com menos de 100 usu√°rios (aplicativos > 100 um processo de revis√£o tamb√©m √© necess√°rio para parar de mostrar o aviso de n√£o verificado)

### Escopos Interessantes

[**Aqui**](https://developers.google.com/identity/protocols/oauth2/scopes) voc√™ pode encontrar uma lista de todos os escopos OAuth do Google.

* **cloud-platform**: Visualizar e gerenciar seus dados em servi√ßos do **Google Cloud Platform**. Voc√™ pode se passar pelo usu√°rio no GCP.
* **admin.directory.user.readonly**: Ver e baixar o diret√≥rio GSuite da sua organiza√ß√£o. Obter nomes, telefones, URLs de calend√°rio de todos os usu√°rios.

### Criar um Aplicativo OAuth

**Comece criando um ID de Cliente OAuth**

1. V√° para [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) e clique em configurar a tela de consentimento.
2. Em seguida, ser√° perguntado se o **tipo de usu√°rio** √© **interno** (apenas para pessoas na sua organiza√ß√£o) ou **externo**. Selecione o que melhor se adequa √†s suas necessidades
* Interno pode ser interessante se voc√™ j√° comprometeu um usu√°rio da organiza√ß√£o e est√° criando este aplicativo para phish outro.
3. D√™ um **nome** ao aplicativo, um **e-mail de suporte** (observe que voc√™ pode definir um e-mail de grupo do Google para tentar se anonimizar um pouco mais), um **logo**, **dom√≠nios autorizados** e outro **e-mail** para **atualiza√ß√µes**.
4. **Selecione** os **escopos OAuth**.
* Esta p√°gina √© dividida em permiss√µes n√£o sens√≠veis, permiss√µes sens√≠veis e permiss√µes restritas. Sempre que voc√™ adicionar uma nova permiss√£o, ela ser√° adicionada √† sua categoria. Dependendo das permiss√µes solicitadas, diferentes avisos aparecer√£o para o usu√°rio indicando qu√£o sens√≠veis essas permiss√µes s√£o.
* Tanto **`admin.directory.user.readonly`** quanto **`cloud-platform`** s√£o permiss√µes sens√≠veis.
5. **Adicione os usu√°rios de teste.** Enquanto o status do aplicativo for teste, apenas esses usu√°rios poder√£o acessar o aplicativo, ent√£o certifique-se de **adicionar o e-mail que voc√™ vai phish**.

Agora vamos obter **credenciais para um aplicativo web** usando o **ID de Cliente OAuth criado anteriormente**:

1. Volte para [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), uma op√ß√£o diferente aparecer√° desta vez.
2. Selecione **criar credenciais para um aplicativo web**
3. Defina as **origens Javascript** e **URIs de redirecionamento** necess√°rias
* Voc√™ pode definir em ambos algo como **`http://localhost:8000/callback`** para teste
4. Obtenha suas **credenciais do aplicativo**

Finalmente, vamos **executar um aplicativo web que usar√° as credenciais do aplicativo OAuth**. Voc√™ pode encontrar um exemplo em [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
V√° para **`http://localhost:8000`**, clique no bot√£o Login with Google, voc√™ ser√° **solicitado** com uma mensagem como esta:

<figure><img src="../../../.gitbook/assets/image (333).png" alt=""><figcaption></figcaption></figure>

O aplicativo mostrar√° o **token de acesso e refresh token** que pode ser facilmente usado. Para mais informa√ß√µes sobre **como usar esses tokens, verifique**:

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### Usando `glcoud`

√â poss√≠vel fazer algo usando gcloud em vez do console da web, verifique:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch e Beau Bullock - OK Google, Como fa√ßo para Red Team GSuite?

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
