# GWS - Google Platforms Phishing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Metodolog칤a Gen칠rica de Phishing

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Phishing en Google Groups

Aparentemente, por defecto, en workspace los miembros [**pueden crear grupos**](https://groups.google.com/all-groups) **y invitar personas a ellos**. Luego puedes modificar el correo que se enviar치 al usuario **agregando algunos enlaces.** El **correo vendr치 de una direcci칩n de google**, por lo que parecer치 **leg칤timo** y la gente podr칤a hacer clic en el enlace.

Tambi칠n es posible establecer la direcci칩n **FROM** como el **correo del grupo de Google** para enviar **m치s correos a los usuarios dentro del grupo**, como en la siguiente imagen donde se cre칩 el grupo **`google--support@googlegroups.com`** y se envi칩 un **correo a todos los miembros** del grupo (que fueron a침adidos sin ning칰n consentimiento)

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

## Phishing en Google Chat

Puedes **iniciar un chat** con una persona solo teniendo su direcci칩n de correo o enviar una **invitaci칩n para hablar**. Adem치s, es posible **crear un Espacio** que puede tener cualquier nombre (por ejemplo, "Soporte de Google") y **invitar** a miembros a 칠l. Si aceptan, podr칤an pensar que est치n hablando con Soporte de Google:

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**Sin embargo, en mis pruebas, los miembros invitados ni siquiera recibieron una invitaci칩n.**
{% endhint %}

Puedes ver c칩mo funcion칩 esto en el pasado en: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Phishing en Google Docs

En el pasado era posible crear un **documento aparentemente leg칤timo** y en un comentario **mencionar alg칰n correo (como @user@gmail.com)**. Google **enviaba un correo a esa direcci칩n de correo** notificando que fueron mencionados en el documento.\
Hoy en d칤a, esto no funciona, pero si **le das al correo de la v칤ctima acceso al documento**, Google enviar치 un correo indicando eso. Este es el mensaje que aparece cuando mencionas a alguien:

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Las v칤ctimas pueden tener mecanismos de protecci칩n que no permiten que los correos indicando que un documento externo fue compartido con ellos lleguen a su correo.
{% endhint %}

## Phishing en Google Calendar

Puedes **crear un evento de calendario** y agregar tantas direcciones de correo de la empresa que est치s atacando como tengas. Programa este evento de calendario en **5 o 15 minutos** desde el tiempo actual. Haz que el evento parezca leg칤timo y **pon un comentario y un t칤tulo indicando que necesitan leer algo** (con el **enlace de phishing**).

Esta es la alerta que aparecer치 en el navegador con un t칤tulo de reuni칩n "Despedir Personas", por lo que podr칤as establecer un t칤tulo m치s relacionado con phishing (e incluso cambiar el nombre asociado con tu correo).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Para que parezca menos sospechoso:

* Config칰ralo para que **los receptores no puedan ver a las otras personas invitadas**
* **NO env칤es correos notificando sobre el evento**. Entonces, las personas solo ver치n su advertencia sobre una reuni칩n en 5 minutos y que necesitan leer ese enlace.
* Aparentemente, usando la API puedes establecer en **True** que **las personas** han **aceptado** el evento e incluso crear **comentarios en su nombre**.

## Phishing de Redirecci칩n de Scripts de Aplicaci칩n

Es posible crear un script en [https://script.google.com/](https://script.google.com/) y **exponerlo como una aplicaci칩n web accesible por todos** que usar치 el dominio leg칤timo **`script.google.com`**.\
Con alg칰n c칩digo como el siguiente, un atacante podr칤a hacer que el script cargue contenido arbitrario en esta p치gina sin dejar de acceder al dominio:

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

Por ejemplo, al acceder a [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec) ver치s:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Ten en cuenta que aparecer치 una advertencia a medida que se cargue el contenido dentro de un iframe.
{% endhint %}

## Phishing de App Scripts OAuth

Es posible crear App Scripts adjuntos a documentos para intentar obtener acceso al token OAuth de una v칤ctima, para m치s informaci칩n consulta:

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## Phishing de Apps OAuth

Cualquiera de las t칠cnicas anteriores puede ser utilizada para hacer que el usuario acceda a una **aplicaci칩n OAuth de Google** que **solicitar치** al usuario alg칰n **acceso**. Si el usuario **conf칤a** en la **fuente**, podr칤a **confiar** en la **aplicaci칩n** (incluso si est치 pidiendo permisos de alto privilegio).

{% hint style="info" %}
Ten en cuenta que Google presenta un aviso poco atractivo advirtiendo que la aplicaci칩n no es de confianza en varios casos y los administradores de Workspace incluso pueden prevenir que las personas acepten aplicaciones OAuth.
{% endhint %}

**Google** permite crear aplicaciones que pueden **interactuar en nombre de los usuarios** con varios **servicios de Google**: Gmail, Drive, GCP...

Al crear una aplicaci칩n para **actuar en nombre de otros usuarios**, el desarrollador necesita crear una **aplicaci칩n OAuth dentro de GCP** e indicar los scopes (permisos) que la aplicaci칩n necesita para acceder a los datos de los usuarios.\
Cuando un **usuario** quiere **usar** esa **aplicaci칩n**, se le **pedir치** que **acepte** que la aplicaci칩n tendr치 acceso a sus datos especificados en los scopes.

Esta es una forma muy jugosa de **phishing** a usuarios no t칠cnicos para que usen **aplicaciones que acceden a informaci칩n sensible** porque podr칤an no entender las consecuencias. Sin embargo, en cuentas de organizaciones, hay formas de prevenir que esto ocurra.

### Aviso de Aplicaci칩n No Verificada

Como se mencion칩, Google siempre presentar치 un **aviso al usuario para aceptar** los permisos que est치n otorgando a la aplicaci칩n en su nombre. Sin embargo, si la aplicaci칩n se considera **peligrosa**, Google mostrar치 **primero** un **aviso** indicando que es **peligrosa** y **dificultando m치s** que el usuario otorgue los permisos a la aplicaci칩n.

Este aviso aparece en aplicaciones que:

* Usan cualquier scope que puede acceder a datos privados (Gmail, Drive, GCP, BigQuery...)
* Aplicaciones con menos de 100 usuarios (aplicaciones > 100 tambi칠n necesitan un proceso de revisi칩n para dejar de mostrar el aviso de no verificada)

### Scopes Interesantes

[**Aqu칤**](https://developers.google.com/identity/protocols/oauth2/scopes) puedes encontrar una lista de todos los scopes de OAuth de Google.

* **cloud-platform**: Ver y gestionar tus datos en los servicios de **Google Cloud Platform**. Puedes suplantar al usuario en GCP.
* **admin.directory.user.readonly**: Ver y descargar el directorio de GSuite de tu organizaci칩n. Obtener nombres, tel칠fonos, URLs de calendario de todos los usuarios.

### Crear una Aplicaci칩n OAuth

**Comienza creando un ID de Cliente OAuth**

1. Ve a [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) y haz clic en configurar la pantalla de consentimiento.
2. Luego, se te preguntar치 si el **tipo de usuario** es **interno** (solo para personas en tu organizaci칩n) o **externo**. Selecciona el que se ajuste a tus necesidades.
* Interno puede ser interesante si ya has comprometido a un usuario de la organizaci칩n y est치s creando esta aplicaci칩n para phishing a otro.
3. Da un **nombre** a la aplicaci칩n, un **correo electr칩nico de soporte** (ten en cuenta que puedes establecer un correo electr칩nico de grupo de Google para intentar anonimizarte un poco m치s), un **logo**, **dominios autorizados** y otro **correo electr칩nico** para **actualizaciones**.
4. **Selecciona** los **scopes de OAuth**.
* Esta p치gina est치 dividida en permisos no sensibles, permisos sensibles y permisos restringidos. Cada vez que agregas un nuevo permiso, se a침ade a su categor칤a. Dependiendo de los permisos solicitados, aparecer치n diferentes avisos al usuario indicando cu치n sensibles son estos permisos.
* Tanto **`admin.directory.user.readonly`** como **`cloud-platform`** son permisos sensibles.
5. **Agrega los usuarios de prueba.** Mientras el estado de la aplicaci칩n sea de prueba, solo estos usuarios podr치n acceder a la aplicaci칩n, as칤 que aseg칰rate de **agregar el correo electr칩nico que vas a estar phishing**.

Ahora obtengamos **credenciales para una aplicaci칩n web** utilizando el **ID de Cliente OAuth creado previamente**:

1. Regresa a [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), esta vez aparecer치 una opci칩n diferente.
2. Selecciona **crear credenciales para una aplicaci칩n web**.
3. Establece los **or칤genes de Javascript** y **URIs de redirecci칩n** necesarios.
* Puedes establecer en ambos algo como **`http://localhost:8000/callback`** para pruebas.
4. Obt칠n las **credenciales** de tu aplicaci칩n.

Finalmente, ejecutemos **una aplicaci칩n web que utilizar치 las credenciales de la aplicaci칩n OAuth**. Puedes encontrar un ejemplo en [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
Ve a **`http://localhost:8000`**, haz clic en el bot칩n Iniciar sesi칩n con Google, se te **pedir치** un mensaje como este:

<figure><img src="../../../.gitbook/assets/image (333).png" alt=""><figcaption></figcaption></figure>

La aplicaci칩n mostrar치 el **token de acceso y el token de actualizaci칩n** que se pueden usar f치cilmente. Para m치s informaci칩n sobre **c칩mo usar estos tokens, consulta**:

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### Usando `glcoud`

Es posible hacer algo usando gcloud en lugar de la consola web, consulta:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## Referencias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: El poder de la magia oscura de Apps Script
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch y Beau Bullock - OK Google, 쯖칩mo hago un Red Team en GSuite?

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
