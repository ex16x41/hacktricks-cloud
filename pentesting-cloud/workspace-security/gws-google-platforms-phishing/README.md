# GWS - Google Platforms Phishing

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Og贸lna metodologia phishingu

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Phishing w Google Groups

Najwyra藕niej, domylnie, w workspace czonkowie [**mog tworzy grupy**](https://groups.google.com/all-groups) **i zaprasza do nich ludzi**. Mo偶esz nastpnie zmodyfikowa e-mail, kt贸ry zostanie wysany do u偶ytkownika **dodajc kilka link贸w.** **E-mail bdzie pochodzi z adresu google**, wic bdzie wyglda **legitnie** i ludzie mog klikn w link.

Mo偶liwe jest r贸wnie偶 ustawienie adresu **FROM** jako **e-mail grupy Google**, aby wysa **wicej e-maili do u偶ytkownik贸w w grupie**, jak na poni偶szym obrazku, gdzie grupa **`google--support@googlegroups.com`** zostaa utworzona, a **e-mail zosta wysany do wszystkich czonk贸w** grupy (kt贸rzy zostali dodani bez 偶adnej zgody)

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

## Phishing w Google Chat

Mo偶esz by w stanie **rozpocz czat** z osob, majc tylko jej adres e-mail lub wysa **zaproszenie do rozmowy**. Co wicej, mo偶liwe jest **utworzenie Space**, kt贸ry mo偶e mie dowoln nazw (np. "Wsparcie Google") i **zaprosi** czonk贸w do niego. Jeli zaakceptuj, mog pomyle, 偶e rozmawiaj z Wsparciem Google:

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**Jednak w moich testach zaproszeni czonkowie nawet nie otrzymali zaproszenia.**
{% endhint %}

Mo偶esz sprawdzi, jak to dziaao w przeszoci w: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Phishing w Google Doc

W przeszoci mo偶liwe byo stworzenie **pozornie legitnego dokumentu** i w komentarzu **wspomnie o jakim e-mailu (np. @user@gmail.com)**. Google **wysao e-mail na ten adres e-mail**, informujc, 偶e zosta wspomniany w dokumencie.\
Obecnie to nie dziaa, ale jeli **dajesz ofierze dostp do dokumentu**, Google wyle e-mail informujcy o tym. To jest wiadomo, kt贸ra pojawia si, gdy wspominasz kogo:

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Ofiary mog mie mechanizm ochronny, kt贸ry nie pozwala, aby e-maile informujce o tym, 偶e zewntrzny dokument zosta z nimi udostpniony, dotary do ich skrzynki e-mail.
{% endhint %}

## Phishing w Google Calendar

Mo偶esz **utworzy wydarzenie kalendarza** i doda tyle adres贸w e-mail firmy, kt贸r atakujesz, ile masz. Zaplanuj to wydarzenie kalendarza na **5 lub 15 minut** od aktualnego czasu. Spraw, aby wydarzenie wygldao legitnie i **dodaj komentarz oraz tytu wskazujcy, 偶e musz co przeczyta** (z **linkiem phishingowym**).

To jest alert, kt贸ry pojawi si w przegldarce z tytuem spotkania "Zwalnianie ludzi", wic mo偶esz ustawi bardziej phishingowy tytu (a nawet zmieni nazwisko powizane z twoim e-mailem).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Aby wygldao to mniej podejrzanie:

* Ustaw, aby **odbiorcy nie mogli zobaczy innych zaproszonych os贸b**
* **NIE wysyaj e-maili informujcych o wydarzeniu**. Wtedy ludzie zobacz tylko swoje ostrze偶enie o spotkaniu za 5 minut i 偶e musz przeczyta ten link.
* Najwyra藕niej u偶ywajc API mo偶esz ustawi na **True**, 偶e **ludzie** zaakceptowali **wydarzenie** i nawet stworzy **komentarze w ich imieniu**.

## Phishing z przekierowaniem skrypt贸w aplikacji

Mo偶liwe jest stworzenie skryptu w [https://script.google.com/](https://script.google.com/) i **udostpnienie go jako aplikacji webowej dostpnej dla wszystkich**, kt贸ra bdzie u偶ywa legitnej domeny **`script.google.com`**.\
Z kodem takim jak poni偶szy, atakujcy m贸gby sprawi, 偶e skrypt zaadowaby dowoln tre na tej stronie bez przestawania uzyskiwania dostpu do domeny:

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

Na przykad, uzyskujc dostp do [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH_ZscKQTJDC/exec), zobaczysz:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Zauwa偶, 偶e pojawi si ostrze偶enie, gdy zawarto jest adowana w iframe.
{% endhint %}

## Phishing OAuth w App Scripts

Mo偶liwe jest stworzenie App Scripts powizanych z dokumentami, aby spr贸bowa uzyska dostp do tokena OAuth ofiary, aby uzyska wicej informacji, sprawd藕:

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## Phishing aplikacji OAuth

Ka偶da z wczeniejszych technik mo偶e by u偶yta, aby skoni u偶ytkownika do uzyskania dostpu do **aplikacji Google OAuth**, kt贸ra **za偶da** od u偶ytkownika pewnych **uprawnie**. Jeli u偶ytkownik **ufa** **藕r贸du**, mo偶e **ufa** **aplikacji** (nawet jeli prosi o uprawnienia o wysokim poziomie).

{% hint style="info" %}
Zauwa偶, 偶e Google przedstawia brzydki komunikat ostrzegawczy, 偶e aplikacja jest nieufna w kilku przypadkach, a administratorzy Workspace mog nawet zapobiec akceptacji aplikacji OAuth przez u偶ytkownik贸w.
{% endhint %}

**Google** pozwala na tworzenie aplikacji, kt贸re mog **dziaa w imieniu u偶ytkownik贸w** z r贸偶nymi **usugami Google**: Gmail, Drive, GCP...

Podczas tworzenia aplikacji, aby **dziaa w imieniu innych u偶ytkownik贸w**, deweloper musi stworzy **aplikacj OAuth w GCP** i wskaza zakresy (uprawnienia), kt贸re aplikacja potrzebuje, aby uzyska dostp do danych u偶ytkownik贸w.\
Gdy **u偶ytkownik** chce **u偶y** tej **aplikacji**, zostanie **poproszony** o **zaakceptowanie**, 偶e aplikacja bdzie miaa dostp do ich danych okrelonych w zakresach.

To bardzo kuszcy spos贸b na **phishing** u偶ytkownik贸w nietechnicznych do korzystania z **aplikacji, kt贸re uzyskuj dostp do wra偶liwych informacji**, poniewa偶 mog nie rozumie konsekwencji. Jednak w kontach organizacyjnych istniej sposoby, aby temu zapobiec.

### Komunikat o niezweryfikowanej aplikacji

Jak wspomniano, Google zawsze przedstawia **komunikat u偶ytkownikowi do zaakceptowania** uprawnie, kt贸re nadaj aplikacji w ich imieniu. Jednak jeli aplikacja jest uwa偶ana za **niebezpieczn**, Google najpierw poka偶e **komunikat** wskazujcy, 偶e jest **niebezpieczna** i **utrudnia** u偶ytkownikowi przyznanie uprawnie aplikacji.

Ten komunikat pojawia si w aplikacjach, kt贸re:

* U偶ywaj jakiegokolwiek zakresu, kt贸ry mo偶e uzyska dostp do danych prywatnych (Gmail, Drive, GCP, BigQuery...)
* Aplikacje z mniej ni偶 100 u偶ytkownikami (aplikacje > 100 wymagaj r贸wnie偶 procesu przegldu, aby przesta wywietla komunikat o niezweryfikowanej aplikacji)

### Interesujce zakresy

[**Tutaj**](https://developers.google.com/identity/protocols/oauth2/scopes) mo偶esz znale藕 list wszystkich zakres贸w Google OAuth.

* **cloud-platform**: Wywietlaj i zarzdzaj swoimi danymi w usugach **Google Cloud Platform**. Mo偶esz udawa u偶ytkownika w GCP.
* **admin.directory.user.readonly**: Zobacz i pobierz katalog GSuite swojej organizacji. Uzyskaj imiona, numery telefon贸w, adresy URL kalendarzy wszystkich u偶ytkownik贸w.

### Utw贸rz aplikacj OAuth

**Rozpocznij tworzenie identyfikatora klienta OAuth**

1. Przejd藕 do [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) i kliknij, aby skonfigurowa ekran zgody.
2. Nastpnie zostaniesz zapytany, czy **typ u偶ytkownika** jest **wewntrzny** (tylko dla os贸b w twojej organizacji) czy **zewntrzny**. Wybierz ten, kt贸ry odpowiada twoim potrzebom
* Wewntrzny mo偶e by interesujcy, jeli ju偶 skompromitowae u偶ytkownika organizacji i tworzysz t aplikacj, aby phishingowa innego.
3. Podaj **nazw** aplikacji, **adres e-mail wsparcia** (zauwa偶, 偶e mo偶esz ustawi adres e-mail grupy Google, aby spr贸bowa bardziej si zanonimizowa), **logo**, **autoryzowane domeny** i inny **adres e-mail** do **aktualizacji**.
4. **Wybierz** **zakresy OAuth**.
* Ta strona jest podzielona na uprawnienia niewra偶liwe, wra偶liwe i ograniczone. Za ka偶dym razem, gdy dodasz nowe uprawnienie, jest ono dodawane do swojej kategorii. W zale偶noci od 偶danych uprawnie r贸偶ne komunikaty bd si pojawia u偶ytkownikowi, wskazujc, jak wra偶liwe s te uprawnienia.
* Zar贸wno **`admin.directory.user.readonly`**, jak i **`cloud-platform`** s uprawnieniami wra偶liwymi.
5. **Dodaj u偶ytkownik贸w testowych.** Dop贸ki status aplikacji jest testowy, tylko ci u偶ytkownicy bd mogli uzyska dostp do aplikacji, wic upewnij si, 偶e **dodajesz adres e-mail, kt贸ry zamierzasz phishingowa**.

Teraz uzyskajmy **powiadczenia dla aplikacji internetowej** u偶ywajc **wczeniej utworzonego identyfikatora klienta OAuth**:

1. Wr贸 do [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), tym razem pojawi si inna opcja.
2. Wybierz, aby **utworzy powiadczenia dla aplikacji internetowej**
3. Ustaw potrzebne **pocztkowe 藕r贸da Javascript** i **URI przekierowania**
* Mo偶esz ustawi w obu co takiego jak **`http://localhost:8000/callback`** do testowania
4. Uzyskaj swoje **powiadczenia aplikacji**

Na koniec uruchommy **aplikacj internetow, kt贸ra bdzie u偶ywa powiadcze aplikacji OAuth**. Mo偶esz znale藕 przykad w [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp_oauth_phishing_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
Przejd藕 do **`http://localhost:8000`**, kliknij przycisk Zaloguj si za pomoc Google, a pojawi si **komunikat** jak ten:

<figure><img src="../../../.gitbook/assets/image (333).png" alt=""><figcaption></figcaption></figure>

Aplikacja wywietli **token dostpu i token odwie偶ania**, kt贸re mo偶na atwo wykorzysta. Aby uzyska wicej informacji na temat **jak u偶ywa tych token贸w, sprawd藕**:

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### U偶ywanie `glcoud`

Mo偶liwe jest zrobienie czego za pomoc gcloud zamiast konsoli internetowej, sprawd藕:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## Odniesienia

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: Moc magii Dark Apps Script
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch i Beau Bullock - OK Google, jak mog przeprowadzi Red Team w GSuite?

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
