# GWS - Google Platforms Phishing

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Generische Phishing-Methodologie

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Google Groups Phishing

Offensichtlich k√∂nnen Mitglieder in der Workspace standardm√§√üig [**Gruppen erstellen**](https://groups.google.com/all-groups) **und Personen einladen**. Du kannst dann die E-Mail, die an den Benutzer gesendet wird, **mit einigen Links √§ndern.** Die **E-Mail wird von einer Google-Adresse kommen**, sodass sie **legitim** aussieht und die Leute m√∂glicherweise auf den Link klicken.

Es ist auch m√∂glich, die **FROM**-Adresse als die **Google-Gruppen-E-Mail** festzulegen, um **mehr E-Mails an die Benutzer innerhalb der Gruppe zu senden**, wie im folgenden Bild, wo die Gruppe **`google--support@googlegroups.com`** erstellt wurde und eine **E-Mail an alle Mitglieder** der Gruppe gesendet wurde (die ohne Zustimmung hinzugef√ºgt wurden).

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

## Google Chat Phishing

Du k√∂nntest entweder **einen Chat** mit einer Person beginnen, indem du nur ihre E-Mail-Adresse hast, oder eine **Einladung zum Gespr√§ch** senden. Dar√ºber hinaus ist es m√∂glich, **einen Space** zu erstellen, der jeden Namen haben kann (z.B. "Google Support") und Mitglieder dazu einzuladen. Wenn sie akzeptieren, k√∂nnten sie denken, dass sie mit dem Google Support sprechen:

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**In meinen Tests haben die eingeladenen Mitglieder jedoch nicht einmal eine Einladung erhalten.**
{% endhint %}

Du kannst √ºberpr√ºfen, wie das in der Vergangenheit funktioniert hat unter: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Google Doc Phishing

Fr√ºher war es m√∂glich, ein **anscheinend legitimes Dokument** zu erstellen und in einem Kommentar **eine E-Mail (wie @user@gmail.com)** zu erw√§hnen. Google **sendete eine E-Mail an diese E-Mail-Adresse**, um zu benachrichtigen, dass sie im Dokument erw√§hnt wurden.\
Heutzutage funktioniert das nicht mehr, aber wenn du **dem Opfer E-Mail-Zugriff auf das Dokument gibst**, wird Google eine E-Mail senden, die dies anzeigt. Dies ist die Nachricht, die erscheint, wenn du jemanden erw√§hnst:

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Opfer k√∂nnten Schutzmechanismen haben, die verhindern, dass E-Mails, die darauf hinweisen, dass ein externes Dokument mit ihnen geteilt wurde, ihre E-Mail erreichen.
{% endhint %}

## Google Calendar Phishing

Du kannst **ein Kalenderevent erstellen** und so viele E-Mail-Adressen des Unternehmens, das du angreifst, hinzuf√ºgen, wie du hast. Plane dieses Kalenderevent in **5 oder 15 Minuten** von der aktuellen Zeit. Lass das Event legitim aussehen und **f√ºge einen Kommentar und einen Titel hinzu, der darauf hinweist, dass sie etwas lesen m√ºssen** (mit dem **Phishing-Link**).

Dies ist die Warnung, die im Browser mit dem Meetingtitel "Leute entlassen" erscheinen wird, sodass du einen phishinger Titel festlegen k√∂nntest (und sogar den Namen √§ndern, der mit deiner E-Mail verbunden ist).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Um es weniger verd√§chtig aussehen zu lassen:

* Richte es so ein, dass **Empf√§nger die anderen eingeladenen Personen nicht sehen k√∂nnen**
* Sende **KEINE E-Mails, die √ºber das Event benachrichtigen**. Dann werden die Leute nur ihre Warnung √ºber ein Meeting in 5 Minuten sehen und dass sie diesen Link lesen m√ºssen.
* Offensichtlich kannst du √ºber die API einstellen, dass **die Personen** das Event **akzeptiert** haben und sogar **Kommentare in ihrem Namen erstellen**.

## App Scripts Redirect Phishing

Es ist m√∂glich, ein Skript in [https://script.google.com/](https://script.google.com/) zu erstellen und **es als Webanwendung zu exponieren, die f√ºr jeden zug√§nglich ist**, die die legitime Domain **`script.google.com`** verwendet.\
Mit etwas Code wie dem folgenden k√∂nnte ein Angreifer das Skript dazu bringen, beliebige Inhalte auf dieser Seite zu laden, ohne die Domain zu stoppen:

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

Zum Beispiel, wenn Sie [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec) aufrufen, sehen Sie:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Beachten Sie, dass eine Warnung erscheint, w√§hrend der Inhalt in einem iframe geladen wird.
{% endhint %}

## App Scripts OAuth Phishing

Es ist m√∂glich, App Scripts zu erstellen, die an Dokumente angeh√§ngt sind, um zu versuchen, Zugriff auf das OAuth-Token eines Opfers zu erhalten. F√ºr weitere Informationen siehe:

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## OAuth Apps Phishing

Eine der vorherigen Techniken kann verwendet werden, um den Benutzer dazu zu bringen, eine **Google OAuth-Anwendung** zuzugreifen, die den Benutzer um **Zugriff** bittet. Wenn der Benutzer der **Quelle** **vertraut**, k√∂nnte er der **Anwendung** **vertrauen** (auch wenn sie nach hochprivilegierten Berechtigungen fragt).

{% hint style="info" %}
Beachten Sie, dass Google in mehreren F√§llen eine h√§ssliche Aufforderung anzeigt, die warnt, dass die Anwendung nicht vertrauensw√ºrdig ist, und Workspace-Administratoren k√∂nnen sogar verhindern, dass Personen OAuth-Anwendungen akzeptieren.
{% endhint %}

**Google** erlaubt es, Anwendungen zu erstellen, die **im Namen von Benutzern** mit mehreren **Google-Diensten** interagieren: Gmail, Drive, GCP...

Beim Erstellen einer Anwendung, die **im Namen anderer Benutzer** agiert, muss der Entwickler eine **OAuth-Anwendung innerhalb von GCP** erstellen und die Scopes (Berechtigungen) angeben, die die Anwendung ben√∂tigt, um auf die Benutzerdaten zuzugreifen.\
Wenn ein **Benutzer** diese **Anwendung** **verwenden** m√∂chte, wird er aufgefordert, zu **akzeptieren**, dass die Anwendung Zugriff auf seine in den Scopes angegebenen Daten hat.

Dies ist eine sehr verlockende M√∂glichkeit, **nicht-technische Benutzer** dazu zu bringen, **Anwendungen zu verwenden, die auf sensible Informationen zugreifen**, da sie die Konsequenzen m√∂glicherweise nicht verstehen. In Unternehmenskonten gibt es jedoch M√∂glichkeiten, dies zu verhindern.

### Unbest√§tigte App-Aufforderung

Wie bereits erw√§hnt, wird Google dem Benutzer immer eine **Aufforderung zur Annahme** der Berechtigungen anzeigen, die sie der Anwendung in ihrem Namen gew√§hren. Wenn die Anwendung jedoch als **gef√§hrlich** eingestuft wird, zeigt Google **zuerst** eine **Aufforderung** an, die darauf hinweist, dass sie **gef√§hrlich** ist und es dem Benutzer **schwieriger macht**, die Berechtigungen f√ºr die App zu gew√§hren.

Diese Aufforderung erscheint in Apps, die:

* Irgendeinen Scope verwenden, der auf private Daten zugreifen kann (Gmail, Drive, GCP, BigQuery...)
* Apps mit weniger als 100 Benutzern (bei Apps > 100 ist auch ein √úberpr√ºfungsprozess erforderlich, um die unbest√§tigte Aufforderung nicht mehr anzuzeigen)

### Interessante Scopes

[**Hier**](https://developers.google.com/identity/protocols/oauth2/scopes) finden Sie eine Liste aller Google OAuth Scopes.

* **cloud-platform**: Sehen und verwalten Sie Ihre Daten √ºber **Google Cloud Platform**-Dienste. Sie k√∂nnen den Benutzer in GCP impersonifizieren.
* **admin.directory.user.readonly**: Sehen und laden Sie das GSuite-Verzeichnis Ihrer Organisation herunter. Erhalten Sie Namen, Telefonnummern, Kalender-URLs aller Benutzer.

### Erstellen einer OAuth-App

**Beginnen Sie mit der Erstellung einer OAuth-Client-ID**

1. Gehen Sie zu [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) und klicken Sie auf die Konfiguration des Zustimmungsbildschirms.
2. Dann werden Sie gefragt, ob der **Benutzertyp** **intern** (nur f√ºr Personen in Ihrer Organisation) oder **extern** ist. W√§hlen Sie den aus, der Ihren Bed√ºrfnissen entspricht.
* Intern k√∂nnte interessant sein, wenn Sie bereits einen Benutzer der Organisation kompromittiert haben und diese App erstellen, um einen anderen zu phishen.
3. Geben Sie der App einen **Namen**, eine **Support-E-Mail** (beachten Sie, dass Sie eine Google-Gruppe-E-Mail festlegen k√∂nnen, um sich ein wenig mehr zu anonymisieren), ein **Logo**, **autorisierte Domains** und eine andere **E-Mail** f√ºr **Updates**.
4. **W√§hlen** Sie die **OAuth-Scopes** aus.
* Diese Seite ist in nicht sensible Berechtigungen, sensible Berechtigungen und eingeschr√§nkte Berechtigungen unterteilt. Jedes Mal, wenn Sie eine neue Berechtigung hinzuf√ºgen, wird sie in ihrer Kategorie hinzugef√ºgt. Abh√§ngig von den angeforderten Berechtigungen erscheinen unterschiedliche Aufforderungen f√ºr den Benutzer, die darauf hinweisen, wie sensibel diese Berechtigungen sind.
* Sowohl **`admin.directory.user.readonly`** als auch **`cloud-platform`** sind sensible Berechtigungen.
5. **F√ºgen Sie die Testbenutzer hinzu.** Solange der Status der App auf "Test" steht, k√∂nnen nur diese Benutzer auf die App zugreifen, also stellen Sie sicher, dass Sie die E-Mail hinzuf√ºgen, die Sie phishen m√∂chten.

Jetzt lassen Sie uns **Anmeldeinformationen f√ºr eine Webanwendung** mit der **zuvor erstellten OAuth-Client-ID** abrufen:

1. Gehen Sie zur√ºck zu [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), diesmal wird eine andere Option angezeigt.
2. W√§hlen Sie **Anmeldeinformationen f√ºr eine Webanwendung erstellen**.
3. Legen Sie die ben√∂tigten **JavaScript-Urspr√ºnge** und **Umleitungs-URIs** fest.
* Sie k√∂nnen in beiden etwas wie **`http://localhost:8000/callback`** zum Testen festlegen.
4. Holen Sie sich die **Anmeldeinformationen** Ihrer Anwendung.

Schlie√ülich lassen Sie uns **eine Webanwendung ausf√ºhren, die die Anmeldeinformationen der OAuth-Anwendung verwendet**. Ein Beispiel finden Sie unter [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
Gehe zu **`http://localhost:8000`**, klicke auf die Schaltfl√§che "Login mit Google", du wirst mit einer Nachricht wie dieser **auffordert**:

<figure><img src="../../../.gitbook/assets/image (333).png" alt=""><figcaption></figcaption></figure>

Die Anwendung zeigt das **Zugriffs- und Aktualisierungstoken**, die leicht verwendet werden k√∂nnen. F√ºr weitere Informationen dar√ºber, **wie man diese Tokens verwendet, siehe**:

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### Verwendung von `glcoud`

Es ist m√∂glich, etwas mit gcloud anstelle der Webkonsole zu tun, siehe:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## Referenzen

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: Die Macht der dunklen Apps Script Magie
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch und Beau Bullock - OK Google, wie mache ich Red Team GSuite?

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
