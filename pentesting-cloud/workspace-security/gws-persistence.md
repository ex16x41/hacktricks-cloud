# GWS - Persistance

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

{% hint style="danger" %}
Toutes les actions mentionn√©es dans cette section qui modifient les param√®tres g√©n√©reront une **alerte de s√©curit√© √† l'email et m√™me une notification push √† tout mobile synchronis√©** avec le compte.
{% endhint %}

## **Persistance dans Gmail**

* Vous pouvez cr√©er des **filtres pour cacher** les notifications de s√©curit√© de Google
* `from: (no-reply@accounts.google.com) "Security Alert"`
* Cela emp√™chera les emails de s√©curit√© d'atteindre l'email (mais n'emp√™chera pas les notifications push sur le mobile)

<details>

<summary>√âtapes pour cr√©er un filtre gmail</summary>

(Instructions [**ici**](https://support.google.com/mail/answer/6579))

1. Ouvrez [Gmail](https://mail.google.com/).
2. Dans la barre de recherche en haut, cliquez sur Afficher les options de recherche ![photos tune](https://lh3.googleusercontent.com/cD6YR\_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1\_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36).
3. Entrez vos crit√®res de recherche. Si vous voulez v√©rifier que votre recherche a fonctionn√© correctement, voyez quels emails apparaissent en cliquant sur **Rechercher**.
4. En bas de la fen√™tre de recherche, cliquez sur **Cr√©er un filtre**.
5. Choisissez ce que vous souhaitez que le filtre fasse.
6. Cliquez sur **Cr√©er un filtre**.

V√©rifiez votre filtre actuel (pour les supprimer) √† [https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)

</details>

<figure><img src="../../.gitbook/assets/image (331).png" alt=""><figcaption></figcaption></figure>

* Cr√©ez une **adresse de transfert pour transf√©rer des informations sensibles** (ou tout) - Vous avez besoin d'un acc√®s manuel.
* Cr√©ez une adresse de transfert √† [https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)
* L'adresse de r√©ception devra confirmer cela
* Ensuite, d√©finissez pour transf√©rer tous les emails tout en gardant une copie (n'oubliez pas de cliquer sur enregistrer les modifications) :

<figure><img src="../../.gitbook/assets/image (332).png" alt=""><figcaption></figcaption></figure>

Il est √©galement possible de cr√©er des filtres et de transf√©rer uniquement des emails sp√©cifiques √† l'autre adresse email.

## Mots de passe d'application

Si vous avez r√©ussi √† **compromettre une session utilisateur Google** et que l'utilisateur avait **2FA**, vous pouvez **g√©n√©rer** un [**mot de passe d'application**](https://support.google.com/accounts/answer/185833?hl=en) (suivez le lien pour voir les √©tapes). Notez que **les mots de passe d'application ne sont plus recommand√©s par Google et sont r√©voqu√©s** lorsque l'utilisateur **change son mot de passe de compte Google.**

**M√™me si vous avez une session ouverte, vous devrez conna√Ætre le mot de passe de l'utilisateur pour cr√©er un mot de passe d'application.**

{% hint style="info" %}
Les mots de passe d'application peuvent **uniquement √™tre utilis√©s avec des comptes ayant la V√©rification en 2 √©tapes** activ√©e.
{% endhint %}

## Changer 2-FA et similaire

Il est √©galement possible de **d√©sactiver 2-FA ou d'enr√¥ler un nouvel appareil** (ou num√©ro de t√©l√©phone) sur cette page [**https://myaccount.google.com/security**](https://myaccount.google.com/security)**.**\
**Il est √©galement possible de g√©n√©rer des cl√©s d'acc√®s (ajouter votre propre appareil), changer le mot de passe, ajouter des num√©ros de mobile pour les t√©l√©phones de v√©rification et de r√©cup√©ration, changer l'email de r√©cup√©ration et changer les questions de s√©curit√©).**

{% hint style="danger" %}
Pour **emp√™cher les notifications push de s√©curit√©** d'atteindre le t√©l√©phone de l'utilisateur, vous pourriez **d√©connecter son smartphone** (bien que cela soit √©trange) car vous ne pouvez pas le reconnecter √† partir d'ici.

Il est √©galement possible de **localiser l'appareil.**
{% endhint %}

**M√™me si vous avez une session ouverte, vous devrez conna√Ætre le mot de passe de l'utilisateur pour changer ces param√®tres.**

## Persistance via les applications OAuth

Si vous avez **compromis le compte d'un utilisateur**, vous pouvez simplement **accepter** d'accorder toutes les permissions possibles √† une **application OAuth**. Le seul probl√®me est que Workspace peut √™tre configur√© pour **interdire les applications OAuth externes et/ou internes non examin√©es.**\
Il est assez courant que les organisations Workspace ne fassent pas confiance par d√©faut aux applications OAuth externes mais fassent confiance aux internes, donc si vous avez **suffisamment de permissions pour g√©n√©rer une nouvelle application OAuth** √† l'int√©rieur de l'organisation et que les applications externes sont interdites, g√©n√©rez-la et **utilisez cette nouvelle application OAuth interne pour maintenir la persistance**.

Consultez la page suivante pour plus d'informations sur les applications OAuth :

{% content-ref url="gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](gws-google-platforms-phishing/)
{% endcontent-ref %}

## Persistance via d√©l√©gation

Vous pouvez simplement **d√©l√©guer le compte** √† un autre compte contr√¥l√© par l'attaquant (si vous √™tes autoris√© √† le faire). Dans les **organisations Workspace**, cette option doit √™tre **activ√©e**. Elle peut √™tre d√©sactiv√©e pour tout le monde, activ√©e pour certains utilisateurs/groupes ou pour tout le monde (g√©n√©ralement, elle est seulement activ√©e pour certains utilisateurs/groupes ou compl√®tement d√©sactiv√©e).

<details>

<summary>Si vous √™tes un administrateur Workspace, v√©rifiez ceci pour activer la fonctionnalit√©</summary>

(Informations [copi√©es des docs](https://support.google.com/a/answer/7223765))

En tant qu'administrateur de votre organisation (par exemple, votre travail ou votre √©cole), vous contr√¥lez si les utilisateurs peuvent d√©l√©guer l'acc√®s √† leur compte Gmail. Vous pouvez laisser tout le monde avoir l'option de d√©l√©guer leur compte. Ou, seulement laisser certaines personnes dans certains d√©partements configurer la d√©l√©gation. Par exemple, vous pouvez :

* Ajouter un assistant administratif en tant que d√©l√©gu√© sur votre compte Gmail afin qu'il puisse lire et envoyer des emails en votre nom.
* Ajouter un groupe, comme votre d√©partement des ventes, dans les Groupes en tant que d√©l√©gu√© pour donner √† tout le monde acc√®s √† un compte Gmail.

Les utilisateurs ne peuvent d√©l√©guer l'acc√®s qu'√† un autre utilisateur de la m√™me organisation, quel que soit leur domaine ou leur unit√© organisationnelle.

#### Limites et restrictions de d√©l√©gation

* **Autoriser les utilisateurs √† accorder l'acc√®s √† leur bo√Æte aux lettres √† un groupe Google** option : Pour utiliser cette option, elle doit √™tre activ√©e pour l'OU du compte d√©l√©gu√© et pour chaque membre du groupe OU. Les membres du groupe appartenant √† une OU sans cette option activ√©e ne peuvent pas acc√©der au compte d√©l√©gu√©.
* Avec une utilisation typique, 40 utilisateurs d√©l√©gu√©s peuvent acc√©der √† un compte Gmail en m√™me temps. Une utilisation sup√©rieure √† la moyenne par un ou plusieurs d√©l√©gu√©s pourrait r√©duire ce nombre.
* Les processus automatis√©s qui acc√®dent fr√©quemment √† Gmail pourraient √©galement r√©duire le nombre de d√©l√©gu√©s pouvant acc√©der √† un compte en m√™me temps. Ces processus incluent les API ou les extensions de navigateur qui acc√®dent fr√©quemment √† Gmail.
* Un seul compte Gmail prend en charge jusqu'√† 1 000 d√©l√©gu√©s uniques. Un groupe dans les Groupes compte comme un d√©l√©gu√© vers la limite.
* La d√©l√©gation n'augmente pas les limites pour un compte Gmail. Les comptes Gmail avec des utilisateurs d√©l√©gu√©s ont les limites et politiques standard des comptes Gmail. Pour plus de d√©tails, visitez [Limites et politiques Gmail](https://support.google.com/a/topic/28609).

#### √âtape 1 : Activer la d√©l√©gation Gmail pour vos utilisateurs

**Avant de commencer :** Pour appliquer le param√®tre √† certains utilisateurs, placez leurs comptes dans une [unit√© organisationnelle](https://support.google.com/a/topic/1227584).

1.  [Connectez-vous](https://admin.google.com/) √† votre [console d'administration Google](https://support.google.com/a/answer/182076).

Connectez-vous en utilisant un _compte administrateur_, pas votre compte actuel CarlosPolop@gmail.com
2. Dans la console d'administration, allez dans Menu ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![et ensuite](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)![](https://storage.googleapis.com/support-kms-prod/ocGtUSENh4QebLpvZcmLcNRZyaTBcolMRSyl) **Applications**![et ensuite](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![et ensuite](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![et ensuite](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Param√®tres utilisateur**.
3. Pour appliquer le param√®tre √† tout le monde, laissez l'unit√© organisationnelle sup√©rieure s√©lectionn√©e. Sinon, s√©lectionnez une [unit√© organisationnelle enfant](https://support.google.com/a/topic/1227584).
4. Cliquez sur **D√©l√©gation de mail**.
5. Cochez la case **Autoriser les utilisateurs √† d√©l√©guer l'acc√®s √† leur bo√Æte aux lettres √† d'autres utilisateurs du domaine**.
6. (Optionnel) Pour permettre aux utilisateurs de sp√©cifier quelles informations sur l'exp√©diteur sont incluses dans les messages d√©l√©gu√©s envoy√©s depuis leur compte, cochez la case **Autoriser les utilisateurs √† personnaliser ce param√®tre**.
7. S√©lectionnez une option pour les informations par d√©faut sur l'exp√©diteur qui sont incluses dans les messages envoy√©s par les d√©l√©gu√©s :
* **Afficher le propri√©taire du compte et le d√©l√©gu√© qui a envoy√© l'email**‚ÄîLes messages incluent les adresses email du propri√©taire du compte Gmail et du d√©l√©gu√©.
* **Afficher uniquement le propri√©taire du compte**‚ÄîLes messages incluent l'adresse email uniquement du propri√©taire du compte Gmail. L'adresse email du d√©l√©gu√© n'est pas incluse.
8. (Optionnel) Pour permettre aux utilisateurs d'ajouter un groupe dans les Groupes en tant que d√©l√©gu√©, cochez la case **Autoriser les utilisateurs √† accorder l'acc√®s √† leur bo√Æte aux lettres √† un groupe Google**.
9. Cliquez sur **Enregistrer**. Si vous avez configur√© une unit√© organisationnelle enfant, vous pourriez √™tre en mesure de **H√©riter** ou **Remplacer** les param√®tres d'une unit√© organisationnelle parente.
10. (Optionnel) Pour activer la d√©l√©gation Gmail pour d'autres unit√©s organisationnelles, r√©p√©tez les √©tapes 3 √† 9.

Les changements peuvent prendre jusqu'√† 24 heures mais se produisent g√©n√©ralement plus rapidement. [En savoir plus](https://support.google.com/a/answer/7514107)

#### √âtape 2 : Demandez aux utilisateurs de configurer des d√©l√©gu√©s pour leurs comptes

Apr√®s avoir activ√© la d√©l√©gation, vos utilisateurs vont dans leurs param√®tres Gmail pour assigner des d√©l√©gu√©s. Les d√©l√©gu√©s peuvent alors lire, envoyer et recevoir des messages en votre nom.

Pour plus de d√©tails, dirigez les utilisateurs vers [D√©l√©guer et collaborer sur des emails](https://support.google.com/a/users/answer/138350).

</details>

<details>

<summary>En tant qu'utilisateur r√©gulier, v√©rifiez ici les instructions pour essayer de d√©l√©guer votre acc√®s</summary>

(Info copi√©e [**des docs**](https://support.google.com/mail/answer/138350))

Vous pouvez ajouter jusqu'√† 10 d√©l√©gu√©s.

Si vous utilisez Gmail via votre travail, votre √©cole ou une autre organisation :

* Vous pouvez ajouter jusqu'√† 1000 d√©l√©gu√©s au sein de votre organisation.
* Avec une utilisation typique, 40 d√©l√©gu√©s peuvent acc√©der √† un compte Gmail en m√™me temps.
* Si vous utilisez des processus automatis√©s, tels que des API ou des extensions de navigateur, quelques d√©l√©gu√©s peuvent acc√©der √† un compte Gmail en m√™me temps.

1. Sur votre ordinateur, ouvrez [Gmail](https://mail.google.com/). Vous ne pouvez pas ajouter de d√©l√©gu√©s depuis l'application Gmail.
2. En haut √† droite, cliquez sur Param√®tres ![Settings](https://lh3.googleusercontent.com/p3J-ZSPOLtuBBR\_ofWTFDfdgAYQgi8mR5c76ie8XQ2wjegk7-yyU5zdRVHKybQgUlQ=w36-h36) ![et ensuite](https://lh3.googleusercontent.com/3\_l97rr0GvhSP2XV5OoCkV2ZDTIisAOczrSdzNCBxhIKWrjXjHucxNwocghoUa39gw=w36-h36) **Voir tous les param√®tres**.
3. Cliquez sur l'onglet **Comptes et importation** ou **Comptes**.
4. Dans la section "Accorder l'acc√®s √† votre compte", cliquez sur **Ajouter un autre compte**. Si vous utilisez Gmail via votre travail ou votre √©cole, votre organisation peut restreindre la d√©l√©gation d'email. Si vous ne voyez pas ce param√®tre, contactez votre administrateur.
* Si vous ne voyez pas Accorder l'acc√®s √† votre compte, alors c'est restreint.
5.  Entrez l'adresse email de la personne que vous souhaitez ajouter. Si vous utilisez Gmail via votre travail, votre √©cole ou une autre organisation, et que votre administrateur le permet, vous pouvez entrer l'adresse email d'un groupe. Ce groupe doit avoir le m√™me domaine que votre organisation. Les membres externes du groupe se voient refuser l'acc√®s √† la d√©l√©gation.\
\
**Important :** Si le compte que vous d√©l√©guez est un nouveau compte ou que le mot de passe a √©t√© r√©initialis√©, l'administrateur doit d√©sactiver l'exigence de changement de mot de passe lors de votre premi√®re connexion.

* [Apprenez comment un administrateur peut cr√©er un utilisateur](https://support.google.com/a/answer/33310).
* [Apprenez comment un administrateur peut r√©initialiser les mots de passe](https://support.google.com/a/answer/33319).

6\. Cliquez sur **√âtape suivante** ![et ensuite](https://lh3.googleusercontent.com/QbWcYKta5vh\_4-OgUeFmK-JOB0YgLLoGh69P478nE6mKdfpWQniiBabjF7FVoCVXI0g=h36) **Envoyer un email pour accorder l'acc√®s**.

La personne que vous avez ajout√©e recevra un email lui demandant de confirmer. L'invitation expire apr√®s une semaine.

Si vous avez ajout√© un groupe, tous les membres du groupe deviendront des d√©l√©gu√©s sans avoir √† confirmer.

Remarque : Il peut falloir jusqu'√† 24 heures pour que la d√©l√©gation commence √† prendre effet.

</details>

## Persistance via l'application Android

Si vous avez une **session dans le compte Google de la victime**, vous pouvez naviguer vers le **Play Store** et pourriez √™tre en mesure d'**installer un malware** que vous avez d√©j√† t√©l√©charg√© sur le store directement **sur le t√©l√©phone** pour maintenir la persistance et acc√©der au t√©l√©phone de la victime.

## **Persistance via** les scripts d'application

Vous pouvez cr√©er des **d√©clencheurs bas√©s sur le temps** dans les scripts d'application, donc si le script d'application est accept√© par l'utilisateur, il sera **d√©clench√©** m√™me **sans que l'utilisateur y acc√®de**. Pour plus d'informations sur la fa√ßon de faire cela, consultez :

{% content-ref url="gws-google-platforms-phishing/gws-app-scripts.md" %}
[gws-app-scripts.md](gws-google-platforms-phishing/gws-app-scripts.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite : Le pouvoir de la magie des scripts d'applications sombres
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch et Beau Bullock - OK Google, comment puis-je Red Team GSuite ?

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
