# GWS - 持久性

{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
学习和实践 GCP 黑客技术：<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 分享黑客技巧。

</details>
{% endhint %}

{% hint style="danger" %}
本节中提到的所有更改设置的操作将生成 **安全警报到电子邮件，甚至推送通知到与账户同步的任何手机**。
{% endhint %}

## **Gmail 中的持久性**

* 您可以创建 **过滤器以隐藏** 来自 Google 的安全通知
* `from: (no-reply@accounts.google.com) "Security Alert"`
* 这将防止安全电子邮件到达该电子邮件（但不会阻止推送通知到手机）

<details>

<summary>创建 Gmail 过滤器的步骤</summary>

（来自 [**这里**](https://support.google.com/mail/answer/6579) 的说明）

1. 打开 [Gmail](https://mail.google.com/)。
2. 在顶部的搜索框中，点击显示搜索选项 ![photos tune](https://lh3.googleusercontent.com/cD6YR_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36) 。
3. 输入您的搜索条件。如果您想检查搜索是否正确，请点击 **搜索** 查看显示的电子邮件。
4. 在搜索窗口的底部，点击 **创建过滤器**。
5. 选择您希望过滤器执行的操作。
6. 点击 **创建过滤器**。

在 [https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters) 检查您当前的过滤器（以删除它们）

</details>

<figure><img src="../../.gitbook/assets/image (331).png" alt=""><figcaption></figcaption></figure>

* 创建 **转发地址以转发敏感信息**（或所有信息） - 您需要手动访问。
* 在 [https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop) 创建转发地址
* 接收地址需要确认此操作
* 然后，设置转发所有电子邮件，同时保留一份副本（记得点击保存更改）：

<figure><img src="../../.gitbook/assets/image (332).png" alt=""><figcaption></figcaption></figure>

还可以创建过滤器，仅将特定电子邮件转发到其他电子邮件地址。

## 应用密码

如果您成功 **入侵了 Google 用户会话**，并且用户启用了 **2FA**，您可以 **生成** [**应用密码**](https://support.google.com/accounts/answer/185833?hl=en)（请访问链接查看步骤）。请注意，**Google 不再推荐应用密码，并且在用户 **更改其 Google 帐户密码时会被撤销。**

**即使您有一个开放的会话，您仍然需要知道用户的密码才能创建应用密码。**

{% hint style="info" %}
应用密码 **仅可用于启用了 2 步验证的帐户**。
{% endhint %}

## 更改 2-FA 和类似操作

您还可以在此页面 [**https://myaccount.google.com/security**](https://myaccount.google.com/security)**.**\
**您还可以生成密码密钥（添加您自己的设备）、更改密码、添加用于验证的手机号码和恢复、更改恢复电子邮件和更改安全问题）。**

{% hint style="danger" %}
要 **防止安全推送通知** 到达用户的手机，您可以 **注销他的智能手机**（尽管这会很奇怪），因为您无法从这里重新登录。

还可以 **定位设备。**
{% endhint %}

**即使您有一个开放的会话，您仍然需要知道用户的密码才能更改这些设置。**

## 通过 OAuth 应用程序的持久性

如果您 **入侵了用户的帐户**，您可以直接 **接受** 授予所有可能的权限给 **OAuth 应用程序**。唯一的问题是 Workspace 可以配置为 **不允许未经审核的外部和/或内部 OAuth 应用程序。**\
Workspace 组织通常默认不信任外部 OAuth 应用程序，但信任内部应用程序，因此如果您 **有足够的权限在组织内部生成新的 OAuth 应用程序**，并且外部应用程序被禁止，请生成它并 **使用该新的内部 OAuth 应用程序来保持持久性**。

有关 OAuth 应用程序的更多信息，请查看以下页面：

{% content-ref url="gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](gws-google-platforms-phishing/)
{% endcontent-ref %}

## 通过委派的持久性

您可以直接 **将帐户委派** 给攻击者控制的不同帐户（如果您被允许这样做）。在 Workspace **组织** 中，此选项必须 **启用**。它可以对所有人禁用，或从某些用户/组启用，或对所有人启用（通常仅对某些用户/组启用或完全禁用）。

<details>

<summary>如果您是 Workspace 管理员，请检查此处以启用该功能</summary>

（信息 [复制自文档](https://support.google.com/a/answer/7223765)）

作为您组织的管理员（例如，您的工作或学校），您控制用户是否可以委派对其 Gmail 帐户的访问。您可以让每个人都有委派其帐户的选项。或者，仅允许某些部门的人设置委派。例如，您可以：

* 将行政助理添加为您 Gmail 帐户的委派，以便他们可以代表您阅读和发送电子邮件。
* 将一个组（例如您的销售部门）添加到组中作为委派，以便所有人都可以访问一个 Gmail 帐户。

用户只能将访问权限委派给同一组织中的其他用户，无论其域或组织单位如何。

#### 委派限制和限制

* **允许用户将其邮箱访问权限授予 Google 组** 选项：要使用此选项，必须为被委派帐户的 OU 和每个组成员的 OU 启用此选项。属于没有启用此选项的 OU 的组成员无法访问被委派的帐户。
* 在典型使用情况下，40 个委派用户可以同时访问一个 Gmail 帐户。一个或多个委派的超出平均使用可能会减少此数字。
* 经常访问 Gmail 的自动化过程也可能减少可以同时访问帐户的委派数量。这些过程包括频繁访问 Gmail 的 API 或浏览器扩展。
* 单个 Gmail 帐户支持最多 1,000 个唯一委派。组在组中计为一个委派，计入限制。
* 委派不会增加 Gmail 帐户的限制。具有委派用户的 Gmail 帐户具有标准的 Gmail 帐户限制和政策。有关详细信息，请访问 [Gmail 限制和政策](https://support.google.com/a/topic/28609)。

#### 第 1 步：为您的用户启用 Gmail 委派

**在开始之前：** 要将设置应用于某些用户，请将其帐户放入 [组织单位](https://support.google.com/a/topic/1227584)。

1. [登录](https://admin.google.com/) 到您的 [Google 管理控制台](https://support.google.com/a/answer/182076)。

使用 _管理员帐户_ 登录，而不是您当前的帐户 CarlosPolop@gmail.com
2. 在管理控制台中，转到菜单 ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)![](https://storage.googleapis.com/support-kms-prod/ocGtUSENh4QebLpvZcmLcNRZyaTBcolMRSyl) **应用**![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**用户设置**。
3. 要将设置应用于所有人，请保留选定的顶级组织单位。否则，选择一个子 [组织单位](https://support.google.com/a/topic/1227584)。
4. 点击 **邮件委派**。
5. 勾选 **允许用户将其邮箱访问权限委派给域中的其他用户** 复选框。
6. （可选）要让用户指定委派消息中包含的发件人信息，请勾选 **允许用户自定义此设置** 复选框。
7. 选择一个选项，作为委派发送的消息中包含的默认发件人信息：
* **显示帐户所有者和发送电子邮件的委派**—消息包括 Gmail 帐户所有者和委派的电子邮件地址。
* **仅显示帐户所有者**—消息仅包括 Gmail 帐户所有者的电子邮件地址。委派的电子邮件地址不包括在内。
8. （可选）要让用户将组添加到组中作为委派，请勾选 **允许用户将其邮箱访问权限授予 Google 组** 复选框。
9. 点击 **保存**。如果您配置了子组织单位，您可能能够 **继承** 或 **覆盖** 父组织单位的设置。
10. （可选）要为其他组织单位启用 Gmail 委派，请重复步骤 3-9。

更改可能需要最多 24 小时，但通常会更快发生。 [了解更多](https://support.google.com/a/answer/7514107)

#### 第 2 步：让用户为其帐户设置委派

启用委派后，您的用户可以转到其 Gmail 设置以分配委派。委派可以代表用户阅读、发送和接收消息。

有关详细信息，请引导用户查看 [委派和协作电子邮件](https://support.google.com/a/users/answer/138350)。

</details>

<details>

<summary>作为普通用户，请查看此处尝试委派您的访问权限的说明</summary>

（信息复制自 [**文档**](https://support.google.com/mail/answer/138350)）

您最多可以添加 10 个委派。

如果您通过工作、学校或其他组织使用 Gmail：

* 您可以在组织内添加最多 1000 个委派。
* 在典型使用情况下，40 个委派可以同时访问一个 Gmail 帐户。
* 如果您使用自动化过程，例如 API 或浏览器扩展，少数委派可以同时访问一个 Gmail 帐户。

1. 在计算机上，打开 [Gmail](https://mail.google.com/)。您无法通过 Gmail 应用添加委派。
2. 在右上角，点击设置 ![设置](https://lh3.googleusercontent.com/p3J-ZSPOLtuBBR_ofWTFDfdgAYQgi8mR5c76ie8XQ2wjegk7-yyU5zdRVHKybQgUlQ=w36-h36) ![然后](https://lh3.googleusercontent.com/3_l97rr0GvhSP2XV5OoCkV2ZDTIisAOczrSdzNCBxhIKWrjXjHucxNwocghoUa39gw=w36-h36) **查看所有设置**。
3. 点击 **帐户和导入** 或 **帐户** 选项卡。
4. 在“授予对您的帐户的访问权限”部分，点击 **添加另一个帐户**。如果您通过工作或学校使用 Gmail，您的组织可能会限制电子邮件委派。如果您看不到此设置，请联系您的管理员。
* 如果您看不到授予对您的帐户的访问权限，则表示它被限制。
5. 输入您要添加的人的电子邮件地址。如果您通过工作、学校或其他组织使用 Gmail，并且您的管理员允许，您可以输入一个组的电子邮件地址。该组必须与您的组织具有相同的域。组的外部成员被拒绝委派访问。\
\
**重要：** 如果您委派的帐户是新帐户或密码已重置，则管理员必须关闭首次登录时更改密码的要求。

* [了解管理员如何创建用户](https://support.google.com/a/answer/33310)。
* [了解管理员如何重置密码](https://support.google.com/a/answer/33319)。

6. 点击 **下一步** ![然后](https://lh3.googleusercontent.com/QbWcYKta5vh_4-OgUeFmK-JOB0YgLLoGh69P478nE6mKdfpWQniiBabjF7FVoCVXI0g=h36) **发送电子邮件以授予访问权限**。

您添加的人将收到一封电子邮件，要求他们确认。邀请在一周后过期。

如果您添加了一个组，所有组成员将成为委派，而无需确认。

注意：委派生效可能需要最多 24 小时。

</details>

## 通过 Android 应用程序的持久性

如果您在受害者的 Google 帐户中有 **会话**，您可以浏览到 **Play 商店**，并可能能够 **直接安装您已经上传到商店的恶意软件** **到手机** 以保持持久性并访问受害者的手机。

## **通过** 应用脚本的持久性

您可以在应用脚本中创建 **基于时间的触发器**，因此如果用户接受了应用脚本，它将 **被触发**，即使 **用户没有访问它**。有关如何做到这一点的更多信息，请查看：

{% content-ref url="gws-google-platforms-phishing/gws-app-scripts.md" %}
[gws-app-scripts.md](gws-google-platforms-phishing/gws-app-scripts.md)
{% endcontent-ref %}

## 参考文献

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch 和 Beau Bullock - OK Google, How do I Red Team GSuite?

{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
学习和实践 GCP 黑客技术：<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 分享黑客技巧。

</details>
{% endhint %}
