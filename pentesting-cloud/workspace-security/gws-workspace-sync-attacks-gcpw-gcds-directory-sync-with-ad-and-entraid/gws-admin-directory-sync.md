# GWS - Admin Directory Sync

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informazioni di base

La principale differenza tra questo modo di sincronizzare gli utenti con GCDS √® che GCDS viene eseguito manualmente con alcuni binari che devi scaricare ed eseguire, mentre **Admin Directory Sync √® serverless** gestito da Google in [https://admin.google.com/ac/sync/externaldirectories](https://admin.google.com/ac/sync/externaldirectories).

Al momento della scrittura, questo servizio √® in beta e supporta 2 tipi di sincronizzazione: Da **Active Directory** e da **Azure Entra ID:**

* **Active Directory:** Per configurarlo, devi dare **accesso a Google al tuo ambiente Active Directory**. E poich√© Google ha accesso solo alle reti GCP (tramite **VPC connectors**), devi creare un connettore e poi rendere il tuo AD disponibile da quel connettore avendolo in VM nella rete GCP o utilizzando Cloud VPN o Cloud Interconnect. Quindi, devi anche fornire **credenziali** di un account con accesso in lettura sulla directory e un **certificato** per contattare tramite **LDAPS**.
* **Azure Entra ID:** Per configurarlo √® necessario **accedere ad Azure con un utente con accesso in lettura** sulla sottoscrizione Entra ID in un pop-up mostrato da Google, e Google manterr√† il token con accesso in lettura su Entra ID.

Una volta configurato correttamente, entrambe le opzioni consentiranno di **sincronizzare utenti e gruppi in Workspace**, ma non consentiranno di configurare utenti e gruppi da Workspace a AD o EntraID.

Altre opzioni che saranno consentite durante questa sincronizzazione sono:

* Inviare un'email ai nuovi utenti per accedere
* Cambiare automaticamente il loro indirizzo email in quello utilizzato da Workspace. Quindi, se Workspace utilizza `@hacktricks.xyz` e gli utenti di EntraID utilizzano `@carloshacktricks.onmicrosoft.com`, `@hacktricks.xyz` sar√† utilizzato per gli utenti creati nell'account.
* Selezionare i **gruppi contenenti gli utenti** che saranno sincronizzati.
* Selezionare i **gruppi** da sincronizzare e creare in Workspace (o indicare di sincronizzare tutti i gruppi).

### Da AD/EntraID -> Google Workspace (& GCP)

Se riesci a compromettere un AD o EntraID avrai il controllo totale degli utenti e dei gruppi che verranno sincronizzati con Google Workspace.\
Tuttavia, nota che le **password** che gli utenti potrebbero utilizzare in Workspace **potrebbero essere le stesse o meno**.

#### Attaccare gli utenti

Quando avviene la sincronizzazione, potrebbe sincronizzare **tutti gli utenti da AD o solo quelli di una specifica OU** o solo gli **utenti membri di gruppi specifici in EntraID**. Questo significa che per attaccare un utente sincronizzato (o crearne uno nuovo che venga sincronizzato) dovrai prima scoprire quali utenti vengono sincronizzati.

* Gli utenti potrebbero **riutilizzare la password o meno da AD o EntraID**, ma questo significa che dovrai **compromettere le password degli utenti per accedere**.
* Se hai accesso alle **email** degli utenti, potresti **cambiare la password di Workspace di un utente esistente**, o **creare un nuovo utente**, aspettare che venga sincronizzato e configurare l'account.

Una volta che accedi all'utente all'interno di Workspace, potrebbero essere concessi alcuni **permessi per impostazione predefinita**.

#### Attaccare i Gruppi

Devi anche scoprire prima quali gruppi vengono sincronizzati. Anche se c'√® la possibilit√† che **TUTTI** i gruppi vengano sincronizzati (poich√© Workspace lo consente).

{% hint style="info" %}
Nota che anche se i gruppi e le appartenenze vengono importati in Workspace, gli **utenti che non sono sincronizzati nella sincronizzazione degli utenti non verranno creati** durante la sincronizzazione dei gruppi anche se sono membri di uno dei gruppi sincronizzati.
{% endhint %}

Se sai quali gruppi di Azure sono stati **assegnati permessi in Workspace o GCP**, potresti semplicemente aggiungere un utente compromesso (o appena creato) in quel gruppo e ottenere quei permessi.

C'√® un'altra opzione per abusare di gruppi privilegiati esistenti in Workspace. Ad esempio, il gruppo `gcp-organization-admins@<workspace.email>` di solito ha alti privilegi su GCP.

Se la sincronizzazione da, ad esempio, EntraID a Workspace √® **configurata per sostituire il dominio** dell'oggetto importato **con l'email di Workspace**, sar√† possibile per un attaccante creare il gruppo `gcp-organization-admins@<entraid.email>` in EntraID, aggiungere un utente in questo gruppo e aspettare che avvenga la sincronizzazione di tutti i gruppi.\
**L'utente sar√† aggiunto nel gruppo `gcp-organization-admins@<workspace.email>` aumentando i privilegi in GCP.**

### Da Google Workspace -> AD/EntraID

Nota che Workspace richiede credenziali con accesso in sola lettura su AD o EntraID per sincronizzare utenti e gruppi. Pertanto, non √® possibile abusare di Google Workspace per apportare modifiche a AD o EntraID. Quindi **questo non √® possibile** al momento.

Non so nemmeno dove Google memorizzi le credenziali AD o il token EntraID e non **puoi recuperarli riconfigurando la sincronizzazione** (non appaiono nel modulo web, devi fornirli di nuovo). Tuttavia, dal web potrebbe essere possibile abusare della funzionalit√† attuale per **elencare utenti e gruppi**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
