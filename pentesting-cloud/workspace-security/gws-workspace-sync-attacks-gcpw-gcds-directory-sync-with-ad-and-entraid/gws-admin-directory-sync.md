# GWS - Synchronisation du r√©pertoire Admin

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Informations de base

La principale diff√©rence entre cette m√©thode de synchronisation des utilisateurs avec GCDS est que GCDS est effectu√© manuellement avec des binaires que vous devez t√©l√©charger et ex√©cuter tandis que **la synchronisation du r√©pertoire Admin est sans serveur** g√©r√©e par Google √† [https://admin.google.com/ac/sync/externaldirectories](https://admin.google.com/ac/sync/externaldirectories).

Au moment de la r√©daction, ce service est en version b√™ta et il prend en charge 2 types de synchronisation : depuis **Active Directory** et depuis **Azure Entra ID :**

* **Active Directory :** Pour configurer cela, vous devez donner **acc√®s √† Google √† votre environnement Active Directory**. Et comme Google n'a acc√®s qu'aux r√©seaux GCP (via **VPC connectors**), vous devez cr√©er un connecteur puis rendre votre AD disponible depuis ce connecteur en l'ayant dans des VM sur le r√©seau GCP ou en utilisant Cloud VPN ou Cloud Interconnect. Ensuite, vous devez √©galement fournir **des identifiants** d'un compte avec un acc√®s en lecture sur le r√©pertoire et un **certificat** pour contacter via **LDAPS**.
* **Azure Entra ID :** Pour configurer cela, il suffit de **se connecter √† Azure avec un utilisateur ayant un acc√®s en lecture** sur l'abonnement Entra ID dans une fen√™tre contextuelle affich√©e par Google, et Google conservera le jeton avec un acc√®s en lecture sur Entra ID.

Une fois correctement configur√©es, les deux options permettront de **synchroniser les utilisateurs et les groupes vers Workspace**, mais elles ne permettront pas de configurer les utilisateurs et les groupes de Workspace vers AD ou EntraID.

D'autres options qu'elles permettront pendant cette synchronisation sont :

* Envoyer un e-mail aux nouveaux utilisateurs pour se connecter
* Changer automatiquement leur adresse e-mail pour celle utilis√©e par Workspace. Donc, si Workspace utilise `@hacktricks.xyz` et que les utilisateurs EntraID utilisent `@carloshacktricks.onmicrosoft.com`, `@hacktricks.xyz` sera utilis√© pour les utilisateurs cr√©√©s dans le compte.
* S√©lectionner les **groupes contenant les utilisateurs** qui seront synchronis√©s.
* S√©lectionner les **groupes** √† synchroniser et cr√©er dans Workspace (ou indiquer de synchroniser tous les groupes).

### D'AD/EntraID -> Google Workspace (& GCP)

Si vous parvenez √† compromettre un AD ou EntraID, vous aurez un contr√¥le total sur les utilisateurs et les groupes qui vont √™tre synchronis√©s avec Google Workspace.\
Cependant, notez que les **mots de passe** que les utilisateurs pourraient utiliser dans Workspace **pourraient √™tre les m√™mes ou non**.

#### Attaquer les utilisateurs

Lorsque la synchronisation se produit, elle peut synchroniser **tous les utilisateurs d'AD ou seulement ceux d'une OU sp√©cifique** ou seulement les **utilisateurs membres de groupes sp√©cifiques dans EntraID**. Cela signifie que pour attaquer un utilisateur synchronis√© (ou en cr√©er un nouveau qui sera synchronis√©), vous devrez d'abord d√©terminer quels utilisateurs sont synchronis√©s.

* Les utilisateurs peuvent **r√©utiliser le mot de passe ou non d'AD ou EntraID**, mais cela signifie que vous devrez **compromettre les mots de passe des utilisateurs pour vous connecter**.
* Si vous avez acc√®s aux **mails** des utilisateurs, vous pourriez **changer le mot de passe Workspace d'un utilisateur existant**, ou **cr√©er un nouvel utilisateur**, attendre qu'il soit synchronis√© et configurer le compte.

Une fois que vous acc√©dez √† l'utilisateur dans Workspace, il pourrait se voir attribuer certaines **permissions par d√©faut**.

#### Attaquer les groupes

Vous devez √©galement d'abord d√©terminer quels groupes sont synchronis√©s. Bien qu'il existe la possibilit√© que **TOUS** les groupes soient synchronis√©s (car Workspace le permet).

{% hint style="info" %}
Notez que m√™me si les groupes et les adh√©sions sont import√©s dans Workspace, les **utilisateurs qui ne sont pas synchronis√©s dans la synchronisation des utilisateurs ne seront pas cr√©√©s** lors de la synchronisation des groupes m√™me s'ils sont membres de l'un des groupes synchronis√©s.
{% endhint %}

Si vous savez quels groupes d'Azure se voient **attribuer des permissions dans Workspace ou GCP**, vous pourriez simplement ajouter un utilisateur compromis (ou nouvellement cr√©√©) dans ce groupe et obtenir ces permissions.

Il existe une autre option pour abuser des groupes privil√©gi√©s existants dans Workspace. Par exemple, le groupe `gcp-organization-admins@<workspace.email>` a g√©n√©ralement de hauts privil√®ges sur GCP.

Si la synchronisation de, par exemple, EntraID vers Workspace est **configur√©e pour remplacer le domaine** de l'objet import√© **par l'e-mail de Workspace**, il sera possible pour un attaquant de cr√©er le groupe `gcp-organization-admins@<entraid.email>` dans EntraID, d'ajouter un utilisateur dans ce groupe, et d'attendre que la synchronisation de tous les groupes se produise.\
**L'utilisateur sera ajout√© dans le groupe `gcp-organization-admins@<workspace.email>` escaladant les privil√®ges dans GCP.**

### De Google Workspace -> AD/EntraID

Notez que Workspace n√©cessite des identifiants avec un acc√®s en lecture seule sur AD ou EntraID pour synchroniser les utilisateurs et les groupes. Par cons√©quent, il n'est pas possible d'abuser de Google Workspace pour effectuer des modifications dans AD ou EntraID. Donc, **ce n'est pas possible** √† ce moment.

Je ne sais √©galement pas o√π Google stocke les identifiants AD ou le jeton EntraID et vous **ne pouvez pas les r√©cup√©rer en reconfigurant la synchronisation** (ils n'apparaissent pas dans le formulaire web, vous devez les fournir √† nouveau). Cependant, depuis le web, il pourrait √™tre possible d'abuser de la fonctionnalit√© actuelle pour **lister les utilisateurs et les groupes**.

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
