# GWS - Sincroniza√ß√£o do Diret√≥rio do Admin

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

A principal diferen√ßa entre essa forma de sincronizar usu√°rios com o GCDS √© que o GCDS √© feito manualmente com alguns bin√°rios que voc√™ precisa baixar e executar, enquanto **a Sincroniza√ß√£o do Diret√≥rio do Admin √© sem servidor** gerenciada pelo Google em [https://admin.google.com/ac/sync/externaldirectories](https://admin.google.com/ac/sync/externaldirectories).

No momento em que este texto foi escrito, este servi√ßo est√° em beta e suporta 2 tipos de sincroniza√ß√£o: do **Active Directory** e do **Azure Entra ID:**

* **Active Directory:** Para configurar isso, voc√™ precisa dar **acesso ao Google ao seu ambiente Active Directory**. E como o Google s√≥ tem acesso √†s redes GCP (via **conectores VPC**), voc√™ precisa criar um conector e, em seguida, tornar seu AD dispon√≠vel a partir desse conector, tendo-o em VMs na rede GCP ou usando Cloud VPN ou Cloud Interconnect. Ent√£o, voc√™ tamb√©m precisa fornecer **credenciais** de uma conta com acesso de leitura sobre o diret√≥rio e **certificado** para contatar via **LDAPS**.
* **Azure Entra ID:** Para configurar isso, basta **fazer login no Azure com um usu√°rio com acesso de leitura** sobre a assinatura do Entra ID em um pop-up exibido pelo Google, e o Google manter√° o token com acesso de leitura sobre o Entra ID.

Uma vez configurado corretamente, ambas as op√ß√µes permitir√£o **sincronizar usu√°rios e grupos para o Workspace**, mas n√£o permitir√£o configurar usu√°rios e grupos do Workspace para o AD ou EntraID.

Outras op√ß√µes que ser√£o permitidas durante essa sincroniza√ß√£o s√£o:

* Enviar um e-mail para os novos usu√°rios para fazer login
* Alterar automaticamente seu endere√ßo de e-mail para o usado pelo Workspace. Assim, se o Workspace estiver usando `@hacktricks.xyz` e os usu√°rios do EntraID usarem `@carloshacktricks.onmicrosoft.com`, `@hacktricks.xyz` ser√° usado para os usu√°rios criados na conta.
* Selecionar os **grupos contendo os usu√°rios** que ser√£o sincronizados.
* Selecionar **grupos** para sincronizar e criar no Workspace (ou indicar para sincronizar todos os grupos).

### De AD/EntraID -> Google Workspace (& GCP)

Se voc√™ conseguir comprometer um AD ou EntraID, ter√° controle total sobre os usu√°rios e grupos que ser√£o sincronizados com o Google Workspace.\
No entanto, observe que as **senhas** que os usu√°rios podem estar usando no Workspace **podem ser as mesmas ou n√£o**.

#### Atacando usu√°rios

Quando a sincroniza√ß√£o acontece, pode sincronizar **todos os usu√°rios do AD ou apenas os de uma OU espec√≠fica** ou apenas os **usu√°rios membros de grupos espec√≠ficos no EntraID**. Isso significa que, para atacar um usu√°rio sincronizado (ou criar um novo que seja sincronizado), voc√™ precisar√° primeiro descobrir quais usu√°rios est√£o sendo sincronizados.

* Os usu√°rios podem estar **reutilizando a senha ou n√£o do AD ou EntraID**, mas isso significa que voc√™ precisar√° **comprometer as senhas dos usu√°rios para fazer login**.
* Se voc√™ tiver acesso aos **e-mails** dos usu√°rios, poder√° **alterar a senha do Workspace de um usu√°rio existente**, ou **criar um novo usu√°rio**, esperar at√© que ele seja sincronizado e configurar a conta.

Uma vez que voc√™ acesse o usu√°rio dentro do Workspace, pode ser concedido algumas **permiss√µes por padr√£o**.

#### Atacando Grupos

Voc√™ tamb√©m precisa descobrir primeiro quais grupos est√£o sendo sincronizados. Embora exista a possibilidade de que **TODOS** os grupos estejam sendo sincronizados (j√° que o Workspace permite isso).

{% hint style="info" %}
Observe que, mesmo que os grupos e as associa√ß√µes sejam importados para o Workspace, os **usu√°rios que n√£o est√£o sincronizados na sincroniza√ß√£o de usu√°rios n√£o ser√£o criados** durante a sincroniza√ß√£o de grupos, mesmo que sejam membros de qualquer um dos grupos sincronizados.
{% endhint %}

Se voc√™ souber quais grupos do Azure est√£o sendo **atribu√≠dos permiss√µes no Workspace ou GCP**, poder√° simplesmente adicionar um usu√°rio comprometido (ou rec√©m-criado) nesse grupo e obter essas permiss√µes.

H√° outra op√ß√£o para abusar de grupos privilegiados existentes no Workspace. Por exemplo, o grupo `gcp-organization-admins@<workspace.email>` geralmente tem altos privil√©gios sobre o GCP.

Se a sincroniza√ß√£o de, por exemplo, EntraID, para o Workspace estiver **configurada para substituir o dom√≠nio** do objeto importado **pelo e-mail do Workspace**, ser√° poss√≠vel para um atacante criar o grupo `gcp-organization-admins@<entraid.email>` no EntraID, adicionar um usu√°rio a esse grupo e esperar at√© que a sincroniza√ß√£o de todos os grupos aconte√ßa.\
**O usu√°rio ser√° adicionado ao grupo `gcp-organization-admins@<workspace.email>`, escalando privil√©gios no GCP.**

### De Google Workspace -> AD/EntraID

Observe que o Workspace requer credenciais com acesso somente leitura sobre o AD ou EntraID para sincronizar usu√°rios e grupos. Portanto, n√£o √© poss√≠vel abusar do Google Workspace para realizar qualquer altera√ß√£o no AD ou EntraID. Portanto, **isso n√£o √© poss√≠vel** neste momento.

Eu tamb√©m n√£o sei onde o Google armazena as credenciais do AD ou o token do EntraID e voc√™ **n√£o pode recuper√°-los reconfigurando a sincroniza√ß√£o** (eles n√£o aparecem no formul√°rio da web, voc√™ precisa fornec√™-los novamente). No entanto, pela web, pode ser poss√≠vel abusar da funcionalidade atual para **listar usu√°rios e grupos**.

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
