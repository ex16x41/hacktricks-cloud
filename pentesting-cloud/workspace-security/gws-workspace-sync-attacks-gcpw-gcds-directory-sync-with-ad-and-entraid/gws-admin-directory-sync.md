# GWS - Synchronizacja katalogu administratora

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Podstawowe informacje

G贸wna r贸偶nica midzy tym sposobem synchronizacji u偶ytkownik贸w z GCDS polega na tym, 偶e GCDS jest realizowane rcznie za pomoc niekt贸rych binari贸w, kt贸re musisz pobra i uruchomi, podczas gdy **Synchronizacja katalogu administratora jest bezserwerowa** i zarzdzana przez Google w [https://admin.google.com/ac/sync/externaldirectories](https://admin.google.com/ac/sync/externaldirectories).

W momencie pisania tego tekstu usuga ta jest w wersji beta i obsuguje 2 typy synchronizacji: Z **Active Directory** i z **Azure Entra ID:**

* **Active Directory:** Aby to skonfigurowa, musisz **da Google dostp do swojego rodowiska Active Directory**. A poniewa偶 Google ma dostp tylko do sieci GCP (poprzez **VPC connectors**), musisz utworzy konektor, a nastpnie udostpni swoje AD z tego konektora, umieszczajc je w VM w sieci GCP lub u偶ywajc Cloud VPN lub Cloud Interconnect. Nastpnie musisz r贸wnie偶 dostarczy **powiadczenia** konta z dostpem do odczytu w katalogu oraz **certyfikat** do kontaktu przez **LDAPS**.
* **Azure Entra ID:** Aby to skonfigurowa, wystarczy **zalogowa si do Azure za pomoc u偶ytkownika z dostpem do odczytu** w subskrypcji Entra ID w oknie pop-up wywietlanym przez Google, a Google zachowa token z dostpem do odczytu w Entra ID.

Po poprawnej konfiguracji obie opcje pozwol na **synchronizacj u偶ytkownik贸w i grup do Workspace**, ale nie pozwol na konfigurowanie u偶ytkownik贸w i grup z Workspace do AD lub EntraID.

Inne opcje, kt贸re bd dostpne podczas tej synchronizacji, to:

* Wysanie e-maila do nowych u偶ytkownik贸w w celu zalogowania si
* Automatyczna zmiana ich adresu e-mail na ten u偶ywany przez Workspace. Jeli wic Workspace u偶ywa `@hacktricks.xyz`, a u偶ytkownicy EntraID u偶ywaj `@carloshacktricks.onmicrosoft.com`, to `@hacktricks.xyz` bdzie u偶ywane dla u偶ytkownik贸w utworzonych w koncie.
* Wyb贸r **grup zawierajcych u偶ytkownik贸w**, kt贸re bd synchronizowane.
* Wyb贸r **grup** do synchronizacji i utworzenia w Workspace (lub wskazanie synchronizacji wszystkich grup).

### Z AD/EntraID -> Google Workspace (& GCP)

Jeli uda ci si skompromitowa AD lub EntraID, bdziesz mia pen kontrol nad u偶ytkownikami i grupami, kt贸re bd synchronizowane z Google Workspace.\
Jednak zauwa偶, 偶e **hasa**, kt贸re u偶ytkownicy mog u偶ywa w Workspace, **mog by takie same lub nie**.

#### Atakowanie u偶ytkownik贸w

Gdy synchronizacja nastpuje, mo偶e synchronizowa **wszystkich u偶ytkownik贸w z AD lub tylko tych z konkretnego OU** lub tylko **u偶ytkownik贸w bdcych czonkami konkretnych grup w EntraID**. Oznacza to, 偶e aby zaatakowa zsynchronizowanego u偶ytkownika (lub utworzy nowego, kt贸ry zostanie zsynchronizowany), musisz najpierw ustali, kt贸rzy u偶ytkownicy s synchronizowani.

* U偶ytkownicy mog **ponownie u偶ywa hasa lub nie z AD lub EntraID**, ale oznacza to, 偶e musisz **skompromitowa hasa u偶ytkownik贸w, aby si zalogowa**.
* Jeli masz dostp do **maili** u偶ytkownik贸w, mo偶esz **zmieni haso Workspace istniejcego u偶ytkownika**, lub **utworzy nowego u偶ytkownika**, poczeka, a偶 zostanie zsynchronizowany i skonfigurowa konto.

Gdy uzyskasz dostp do u偶ytkownika w Workspace, mog mu by nadane pewne **uprawnienia domylnie**.

#### Atakowanie grup

Musisz r贸wnie偶 najpierw ustali, kt贸re grupy s synchronizowane. Chocia偶 istnieje mo偶liwo, 偶e **WSZYSTKIE** grupy s synchronizowane (poniewa偶 Workspace na to pozwala).

{% hint style="info" %}
Zauwa偶, 偶e nawet jeli grupy i czonkostwa s importowane do Workspace, **u偶ytkownicy, kt贸rzy nie s synchronizowani w synchronizacji u偶ytkownik贸w, nie bd tworzeni** podczas synchronizacji grup, nawet jeli s czonkami kt贸rejkolwiek z synchronizowanych grup.
{% endhint %}

Jeli wiesz, kt贸re grupy z Azure maj **przydzielone uprawnienia w Workspace lub GCP**, mo偶esz po prostu doda skompromitowanego u偶ytkownika (lub nowo utworzonego) do tej grupy i uzyska te uprawnienia.

Istnieje r贸wnie偶 inna opcja nadu偶ycia istniejcych uprzywilejowanych grup w Workspace. Na przykad grupa `gcp-organization-admins@<workspace.email>` zazwyczaj ma wysokie uprawnienia w GCP.

Jeli synchronizacja z, na przykad, EntraID do Workspace jest **skonfigurowana do zastpienia domeny** importowanego obiektu **emailem Workspace**, mo偶liwe bdzie, aby atakujcy utworzy grup `gcp-organization-admins@<entraid.email>` w EntraID, doda u偶ytkownika do tej grupy i czeka, a偶 synchronizacja wszystkich grup nastpi.\
**U偶ytkownik zostanie dodany do grupy `gcp-organization-admins@<workspace.email>`, eskalujc uprawnienia w GCP.**

### Z Google Workspace -> AD/EntraID

Zauwa偶, 偶e Workspace wymaga powiadcze z dostpem tylko do odczytu w AD lub EntraID, aby synchronizowa u偶ytkownik贸w i grupy. Dlatego nie jest mo偶liwe nadu偶ycie Google Workspace do wprowadzenia jakichkolwiek zmian w AD lub EntraID. Tak wic **to nie jest mo偶liwe** w tym momencie.

Nie wiem r贸wnie偶, gdzie Google przechowuje powiadczenia AD lub token EntraID i **nie mo偶esz ich odzyska, rekonfigurujc synchronizacj** (nie pojawiaj si w formularzu internetowym, musisz je poda ponownie). Jednak z poziomu sieci mo偶e by mo偶liwe nadu偶ycie obecnej funkcjonalnoci do **wywietlania u偶ytkownik贸w i grup**.

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
