# GWS - Sincronizaci칩n del Directorio de Administradores

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Informaci칩n B치sica

La principal diferencia entre esta forma de sincronizar usuarios con GCDS es que GCDS se realiza manualmente con algunos binarios que necesitas descargar y ejecutar, mientras que **la Sincronizaci칩n del Directorio de Administradores es sin servidor** gestionada por Google en [https://admin.google.com/ac/sync/externaldirectories](https://admin.google.com/ac/sync/externaldirectories).

En el momento de escribir esto, este servicio est치 en beta y soporta 2 tipos de sincronizaci칩n: Desde **Active Directory** y desde **Azure Entra ID:**

* **Active Directory:** Para configurar esto necesitas dar **acceso a Google a tu entorno de Active Directory**. Y como Google solo tiene acceso a redes de GCP (a trav칠s de **conectores VPC**), necesitas crear un conector y luego hacer que tu AD est칠 disponible desde ese conector teniendo VMs en la red de GCP o usando Cloud VPN o Cloud Interconnect. Luego, tambi칠n necesitas proporcionar **credenciales** de una cuenta con acceso de lectura sobre el directorio y un **certificado** para contactar a trav칠s de **LDAPS**.
* **Azure Entra ID:** Para configurar esto solo es necesario **iniciar sesi칩n en Azure con un usuario con acceso de lectura** sobre la suscripci칩n de Entra ID en un pop-up mostrado por Google, y Google mantendr치 el token con acceso de lectura sobre Entra ID.

Una vez configurado correctamente, ambas opciones permitir치n **sincronizar usuarios y grupos a Workspace**, pero no permitir치n configurar usuarios y grupos desde Workspace a AD o EntraID.

Otras opciones que permitir치 durante esta sincronizaci칩n son:

* Enviar un correo electr칩nico a los nuevos usuarios para que inicien sesi칩n.
* Cambiar autom치ticamente su direcci칩n de correo electr칩nico a la utilizada por Workspace. As칤 que si Workspace est치 usando `@hacktricks.xyz` y los usuarios de EntraID usan `@carloshacktricks.onmicrosoft.com`, se utilizar치 `@hacktricks.xyz` para los usuarios creados en la cuenta.
* Seleccionar los **grupos que contienen los usuarios** que ser치n sincronizados.
* Seleccionar **grupos** para sincronizar y crear en Workspace (o indicar que se sincronicen todos los grupos).

### De AD/EntraID -> Google Workspace (& GCP)

Si logras comprometer un AD o EntraID tendr치s control total de los usuarios y grupos que se van a sincronizar con Google Workspace.\
Sin embargo, ten en cuenta que las **contrase침as** que los usuarios podr칤an estar usando en Workspace **podr칤an ser las mismas o no**.

#### Atacando usuarios

Cuando ocurre la sincronizaci칩n, podr칤a sincronizar **todos los usuarios de AD o solo los de una OU espec칤fica** o solo los **usuarios miembros de grupos espec칤ficos en EntraID**. Esto significa que para atacar a un usuario sincronizado (o crear uno nuevo que se sincronice) primero necesitar치s averiguar qu칠 usuarios est치n siendo sincronizados.

* Los usuarios podr칤an estar **reutilizando la contrase침a o no de AD o EntraID**, pero esto significa que necesitar치s **comprometer las contrase침as de los usuarios para iniciar sesi칩n**.
* Si tienes acceso a los **correos** de los usuarios, podr칤as **cambiar la contrase침a de Workspace de un usuario existente**, o **crear un nuevo usuario**, esperar hasta que se sincronice y configurar la cuenta.

Una vez que accedas al usuario dentro de Workspace, podr칤a recibir algunos **permisos por defecto**.

#### Atacando Grupos

Tambi칠n necesitas averiguar primero qu칠 grupos est치n siendo sincronizados. Aunque existe la posibilidad de que **TODOS** los grupos est칠n siendo sincronizados (ya que Workspace permite esto).

{% hint style="info" %}
Ten en cuenta que incluso si los grupos y membres칤as se importan a Workspace, los **usuarios que no est치n sincronizados en la sincronizaci칩n de usuarios no ser치n creados** durante la sincronizaci칩n de grupos, incluso si son miembros de alguno de los grupos sincronizados.
{% endhint %}

Si sabes qu칠 grupos de Azure est치n siendo **asignados permisos en Workspace o GCP**, podr칤as simplemente agregar un usuario comprometido (o reci칠n creado) en ese grupo y obtener esos permisos.

Hay otra opci칩n para abusar de grupos privilegiados existentes en Workspace. Por ejemplo, el grupo `gcp-organization-admins@<workspace.email>` generalmente tiene altos privilegios sobre GCP.

Si la sincronizaci칩n de, por ejemplo, EntraID a Workspace est치 **configurada para reemplazar el dominio** del objeto importado **con el correo de Workspace**, ser치 posible para un atacante crear el grupo `gcp-organization-admins@<entraid.email>` en EntraID, agregar un usuario en este grupo y esperar hasta que ocurra la sincronizaci칩n de todos los grupos.\
**El usuario ser치 agregado en el grupo `gcp-organization-admins@<workspace.email>` escalando privilegios en GCP.**

### De Google Workspace -> AD/EntraID

Ten en cuenta que Workspace requiere credenciales con acceso de solo lectura sobre AD o EntraID para sincronizar usuarios y grupos. Por lo tanto, no es posible abusar de Google Workspace para realizar ning칰n cambio en AD o EntraID. As칤 que **esto no es posible** en este momento.

Tampoco s칠 d칩nde almacena Google las credenciales de AD o el token de EntraID y **no puedes recuperarlos reconfigurando la sincronizaci칩n** (no aparecen en el formulario web, necesitas darlos nuevamente). Sin embargo, desde la web podr칤a ser posible abusar de la funcionalidad actual para **listar usuarios y grupos**.

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}
