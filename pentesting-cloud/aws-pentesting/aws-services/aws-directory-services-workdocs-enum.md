# AWS - Directory Services / WorkDocs Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Directory Services

AWS Directory Service for Microsoft Active Directory es un servicio gestionado que facilita **configurar, operar y escalar un directorio** en la nube de AWS. Est치 construido sobre el **Microsoft Active Directory** real e integra estrechamente con otros servicios de AWS, lo que facilita la gesti칩n de tus cargas de trabajo y recursos de AWS que son conscientes del directorio. Con AWS Managed Microsoft AD, puedes **usar tus usuarios, grupos y pol칤ticas** de Active Directory existentes para gestionar el acceso a tus recursos de AWS. Esto puede ayudar a simplificar tu gesti칩n de identidad y reducir la necesidad de soluciones de identidad adicionales. AWS Managed Microsoft AD tambi칠n proporciona copias de seguridad autom치ticas y capacidades de recuperaci칩n ante desastres, ayudando a garantizar la disponibilidad y durabilidad de tu directorio. En general, AWS Directory Service for Microsoft Active Directory puede ayudarte a ahorrar tiempo y recursos al proporcionar un servicio de Active Directory gestionado, altamente disponible y escalable en la nube de AWS.

### Options

Directory Services permite crear 5 tipos de directorios:

* **AWS Managed Microsoft AD**: Que ejecutar치 un nuevo **Microsoft AD en AWS**. Podr치s establecer la contrase침a de administrador y acceder a los DCs en una VPC.
* **Simple AD**: Que ser치 un servidor compatible con Active Directory **Linux-Samba**. Podr치s establecer la contrase침a de administrador y acceder a los DCs en una VPC.
* **AD Connector**: Un proxy para **redirigir solicitudes de directorio a tu Active Directory de Microsoft existente** sin almacenar informaci칩n en la nube. Estar치 escuchando en una **VPC** y necesitas proporcionar **credenciales para acceder al AD existente**.
* **Amazon Cognito User Pools**: Esto es lo mismo que Cognito User Pools.
* **Cloud Directory**: Este es el m치s **simple**. Un directorio **sin servidor** donde indicas el **esquema** a utilizar y se te **cobrar치n seg칰n el uso**.

Los servicios de directorio de AWS permiten **sincronizar** con tu **Microsoft AD** existente **en las instalaciones**, **ejecutar el tuyo propio** en AWS o sincronizar con **otros tipos de directorios**.

### Lab

Aqu칤 puedes encontrar un buen tutorial para crear tu propio Microsoft AD en AWS: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html)

### Enumeration
```bash
# Get directories and DCs
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Get directory settings
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```
### Login

Tenga en cuenta que si la **descripci칩n** del directorio conten칤a un **dominio** en el campo **`AccessUrl`** es porque un **usuario** probablemente puede **iniciar sesi칩n** con sus **credenciales de AD** en algunos **servicios de AWS:**

* `<name>.awsapps.com/connect` (Amazon Connect)
* `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
* `<name>.awsapps.com/workmail` (Amazon WorkMail)
* `<name>.awsapps.com/console` (Amazon Management Console)
* `<name>.awsapps.com/start` (IAM Identity Center)

### Privilege Escalation

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md" %}
[aws-directory-services-privesc.md](../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md)
{% endcontent-ref %}

## Persistence

### Using an AD user

Un **usuario de AD** puede recibir **acceso a la consola de administraci칩n de AWS** a trav칠s de un Rol que asumir. El **nombre de usuario predeterminado es Admin** y es posible **cambiar su contrase침a** desde la consola de AWS.

Por lo tanto, es posible **cambiar la contrase침a de Admin**, **crear un nuevo usuario** o **cambiar la contrase침a** de un usuario y otorgar a ese usuario un Rol para mantener el acceso.\
Tambi칠n es posible **agregar un usuario a un grupo dentro de AD** y **dar acceso a ese grupo de AD a un Rol** (para hacer que esta persistencia sea m치s sigilosa).

### Sharing AD (from victim to attacker)

Es posible compartir un entorno de AD de una v칤ctima a un atacante. De esta manera, el atacante podr치 continuar accediendo al entorno de AD.\
Sin embargo, esto implica compartir el AD administrado y tambi칠n crear una conexi칩n de emparejamiento de VPC.

Puede encontrar una gu칤a aqu칤: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html)

### ~~Sharing AD (from attacker to victim)~~

No parece posible otorgar acceso a AWS a usuarios de un entorno de AD diferente a una cuenta de AWS.

## WorkDocs

Amazon Web Services (AWS) WorkDocs es un **servicio de almacenamiento y compartici칩n de archivos** basado en la nube. Es parte de la suite de servicios de computaci칩n en la nube de AWS y est치 dise침ado para proporcionar una soluci칩n segura y escalable para que las organizaciones almacenen, compartan y colaboren en archivos y documentos.

AWS WorkDocs proporciona una interfaz basada en la web para que los usuarios suban, accedan y gestionen sus archivos y documentos. Tambi칠n ofrece caracter칤sticas como control de versiones, colaboraci칩n en tiempo real e integraci칩n con otros servicios de AWS y herramientas de terceros.

### Enumeration

{% code overflow="wrap" %}
```bash
# Get AD users (Admin not included)
aws workdocs describe-users --organization-id <directory-id>
# Get AD groups (containing "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Create user (created inside the AD)
aws workdocs create-user --username testingasd --given-name testingasd --surname testingasd --password <password> --email-address name@directory.domain --organization-id <directory-id>

# Get what each user has created
aws workdocs describe-activities --user-id "S-1-5-21-377..."

# Get what was created in the directory
aws workdocs describe-activities --organization-id <directory-id>

# Get folder content
aws workdocs describe-folder-contents --folder-id <fold-id>

# Get file (a url to access with the content will be retreived)
aws workdocs get-document --document-id <doc-id>

# Get resource permissions if any
aws workdocs describe-resource-permissions --resource-id <value>

# Add permission so anyway can see the file
aws workdocs add-resource-permissions --resource-id <id> --principals Id=anonymous,Type=ANONYMOUS,Role=VIEWER
## This will give an id, the file will be acesible in: https://<name>.awsapps.com/workdocs/index.html#/share/document/<id>
```
{% endcode %}

### Privesc

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md" %}
[aws-workdocs-privesc.md](../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
