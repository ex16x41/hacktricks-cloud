# AWS - Services de R√©pertoire / Enum√©ration WorkDocs

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Services de R√©pertoire

Le service AWS Directory Service pour Microsoft Active Directory est un service g√©r√© qui facilite la **configuration, l'exploitation et la mise √† l'√©chelle d'un annuaire** dans le Cloud AWS. Il est construit sur un v√©ritable **Microsoft Active Directory** et s'int√®gre √©troitement avec d'autres services AWS, facilitant la gestion de vos charges de travail et ressources AWS conscientes de l'annuaire. Avec AWS Managed Microsoft AD, vous pouvez **utiliser vos utilisateurs, groupes et politiques** Active Directory existants pour g√©rer l'acc√®s √† vos ressources AWS. Cela peut aider √† simplifier votre gestion des identit√©s et r√©duire le besoin de solutions d'identit√© suppl√©mentaires. AWS Managed Microsoft AD fournit √©galement des sauvegardes automatiques et des capacit√©s de r√©cup√©ration apr√®s sinistre, aidant √† garantir la disponibilit√© et la durabilit√© de votre annuaire. Dans l'ensemble, le service AWS Directory pour Microsoft Active Directory peut vous aider √† gagner du temps et des ressources en fournissant un service Active Directory g√©r√©, hautement disponible et √©volutif dans le Cloud AWS.

### Options

Les services de r√©pertoire permettent de cr√©er 5 types d'annuaires :

* **AWS Managed Microsoft AD** : Qui ex√©cutera un nouveau **Microsoft AD dans AWS**. Vous pourrez d√©finir le mot de passe administrateur et acc√©der aux DC dans un VPC.
* **Simple AD** : Qui sera un serveur compatible Active Directory **Linux-Samba**. Vous pourrez d√©finir le mot de passe administrateur et acc√©der aux DC dans un VPC.
* **AD Connector** : Un proxy pour **rediriger les demandes d'annuaire vers votre Microsoft Active Directory existant** sans mettre en cache d'informations dans le cloud. Il √©coutera dans un **VPC** et vous devez fournir **des identifiants pour acc√©der √† l'AD existant**.
* **Amazon Cognito User Pools** : C'est la m√™me chose que les pools d'utilisateurs Cognito.
* **Cloud Directory** : C'est le **plus simple**. Un annuaire **sans serveur** o√π vous indiquez le **sch√©ma** √† utiliser et √™tes **factur√© en fonction de l'utilisation**.

Les services de r√©pertoire AWS permettent de **synchroniser** avec votre **Microsoft AD sur site** existant, **d'ex√©cuter le v√¥tre** dans AWS ou de synchroniser avec **d'autres types d'annuaires**.

### Laboratoire

Ici, vous pouvez trouver un joli tutoriel pour cr√©er votre propre Microsoft AD dans AWS : [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html)

### √ânum√©ration
```bash
# Get directories and DCs
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Get directory settings
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```
### Login

Notez que si la **description** du r√©pertoire contenait un **domaine** dans le champ **`AccessUrl`**, c'est parce qu'un **utilisateur** peut probablement **se connecter** avec ses **identifiants AD** dans certains **services AWS :**

* `<name>.awsapps.com/connect` (Amazon Connect)
* `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
* `<name>.awsapps.com/workmail` (Amazon WorkMail)
* `<name>.awsapps.com/console` (Amazon Management Console)
* `<name>.awsapps.com/start` (IAM Identity Center)

### Privilege Escalation

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md" %}
[aws-directory-services-privesc.md](../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md)
{% endcontent-ref %}

## Persistence

### Using an AD user

Un **utilisateur AD** peut se voir accorder **l'acc√®s √† la console de gestion AWS** via un r√¥le √† assumer. Le **nom d'utilisateur par d√©faut est Admin** et il est possible de **changer son mot de passe** depuis la console AWS.

Par cons√©quent, il est possible de **changer le mot de passe d'Admin**, **de cr√©er un nouvel utilisateur** ou **de changer le mot de passe** d'un utilisateur et d'accorder √† cet utilisateur un r√¥le pour maintenir l'acc√®s.\
Il est √©galement possible **d'ajouter un utilisateur √† un groupe dans AD** et **de donner √† ce groupe AD acc√®s √† un r√¥le** (pour rendre cette persistance plus discr√®te).

### Sharing AD (from victim to attacker)

Il est possible de partager un environnement AD d'une victime √† un attaquant. De cette mani√®re, l'attaquant pourra continuer √† acc√©der √† l'environnement AD.\
Cependant, cela implique de partager l'AD g√©r√© et √©galement de cr√©er une connexion de peering VPC.

Vous pouvez trouver un guide ici : [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html)

### ~~Sharing AD (from attacker to victim)~~

Il ne semble pas possible d'accorder l'acc√®s AWS √† des utilisateurs d'un environnement AD diff√©rent √† un compte AWS.

## WorkDocs

Amazon Web Services (AWS) WorkDocs est un **service de stockage et de partage de fichiers** bas√© sur le cloud. Il fait partie de la suite de services de cloud computing d'AWS et est con√ßu pour fournir une solution s√©curis√©e et √©volutive pour les organisations afin de stocker, partager et collaborer sur des fichiers et des documents.

AWS WorkDocs fournit une interface web pour que les utilisateurs puissent t√©l√©charger, acc√©der et g√©rer leurs fichiers et documents. Il offre √©galement des fonctionnalit√©s telles que le contr√¥le de version, la collaboration en temps r√©el et l'int√©gration avec d'autres services AWS et des outils tiers.

### Enumeration

{% code overflow="wrap" %}
```bash
# Get AD users (Admin not included)
aws workdocs describe-users --organization-id <directory-id>
# Get AD groups (containing "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Create user (created inside the AD)
aws workdocs create-user --username testingasd --given-name testingasd --surname testingasd --password <password> --email-address name@directory.domain --organization-id <directory-id>

# Get what each user has created
aws workdocs describe-activities --user-id "S-1-5-21-377..."

# Get what was created in the directory
aws workdocs describe-activities --organization-id <directory-id>

# Get folder content
aws workdocs describe-folder-contents --folder-id <fold-id>

# Get file (a url to access with the content will be retreived)
aws workdocs get-document --document-id <doc-id>

# Get resource permissions if any
aws workdocs describe-resource-permissions --resource-id <value>

# Add permission so anyway can see the file
aws workdocs add-resource-permissions --resource-id <id> --principals Id=anonymous,Type=ANONYMOUS,Role=VIEWER
## This will give an id, the file will be acesible in: https://<name>.awsapps.com/workdocs/index.html#/share/document/<id>
```
{% endcode %}

### Privesc

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md" %}
[aws-workdocs-privesc.md](../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Formation Expert Red Team GCP (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
