# AWS - Directory Services / WorkDocs Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Directory Services

Η υπηρεσία AWS Directory Service για το Microsoft Active Directory είναι μια διαχειριζόμενη υπηρεσία που διευκολύνει την **ρύθμιση, λειτουργία και κλιμάκωση ενός καταλόγου** στο AWS Cloud. Είναι βασισμένη στο πραγματικό **Microsoft Active Directory** και ενσωματώνεται στενά με άλλες υπηρεσίες AWS, διευκολύνοντας τη διαχείριση των εργασιών και των πόρων AWS που είναι ευαίσθητοι σε καταλόγους. Με το AWS Managed Microsoft AD, μπορείτε να **χρησιμοποιήσετε τους υπάρχοντες** χρήστες, ομάδες και πολιτικές του Active Directory για να διαχειριστείτε την πρόσβαση στους πόρους AWS σας. Αυτό μπορεί να βοηθήσει στην απλοποίηση της διαχείρισης ταυτοτήτων σας και στη μείωση της ανάγκης για επιπλέον λύσεις ταυτοτήτων. Το AWS Managed Microsoft AD παρέχει επίσης αυτόματες εφεδρικές αντιγράφες και δυνατότητες αποκατάστασης από καταστροφές, βοηθώντας να διασφαλιστεί η διαθεσιμότητα και η ανθεκτικότητα του καταλόγου σας. Συνολικά, η υπηρεσία AWS Directory Service για το Microsoft Active Directory μπορεί να σας βοηθήσει να εξοικονομήσετε χρόνο και πόρους παρέχοντας μια διαχειριζόμενη, υψηλής διαθεσιμότητας και κλιμακούμενη υπηρεσία Active Directory στο AWS Cloud.

### Options

Οι Υπηρεσίες Καταλόγου επιτρέπουν τη δημιουργία 5 τύπων καταλόγων:

* **AWS Managed Microsoft AD**: Ο οποίος θα εκτελεί ένα νέο **Microsoft AD στο AWS**. Θα μπορείτε να ορίσετε τον κωδικό πρόσβασης διαχειριστή και να έχετε πρόσβαση στους DCs σε ένα VPC.
* **Simple AD**: Ο οποίος θα είναι ένας **Linux-Samba** διακομιστής συμβατός με Active Directory. Θα μπορείτε να ορίσετε τον κωδικό πρόσβασης διαχειριστή και να έχετε πρόσβαση στους DCs σε ένα VPC.
* **AD Connector**: Ένας μεσολαβητής για **την ανακατεύθυνση αιτημάτων καταλόγου στο υπάρχον Microsoft Active Directory** σας χωρίς να αποθηκεύει καμία πληροφορία στο cloud. Θα ακούει σε ένα **VPC** και πρέπει να δώσετε **διαπιστευτήρια για να έχετε πρόσβαση στο υπάρχον AD**.
* **Amazon Cognito User Pools**: Αυτό είναι το ίδιο με τα Cognito User Pools.
* **Cloud Directory**: Αυτό είναι το **απλούστερο** από όλα. Ένας **serverless** κατάλογος όπου δηλώνετε το **σχήμα** που θα χρησιμοποιήσετε και χρεώνεστε **σύμφωνα με τη χρήση**.

Οι υπηρεσίες AWS Directory επιτρέπουν να **συγχρονίσετε** με το υπάρχον **on-premises** Microsoft AD σας, **να εκτελέσετε το δικό σας** στο AWS ή να συγχρονίσετε με **άλλους τύπους καταλόγων**.

### Lab

Εδώ μπορείτε να βρείτε ένα ωραίο tutorial για να δημιουργήσετε το δικό σας Microsoft AD στο AWS: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html)

### Enumeration
```bash
# Get directories and DCs
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Get directory settings
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```
### Σύνδεση

Σημειώστε ότι αν η **περιγραφή** του καταλόγου περιείχε ένα **domain** στο πεδίο **`AccessUrl`** είναι επειδή ένας **χρήστης** μπορεί πιθανώς να **συνδεθεί** με τα **AD credentials** του σε ορισμένες **AWS υπηρεσίες:**

* `<name>.awsapps.com/connect` (Amazon Connect)
* `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
* `<name>.awsapps.com/workmail` (Amazon WorkMail)
* `<name>.awsapps.com/console` (Amazon Management Console)
* `<name>.awsapps.com/start` (IAM Identity Center)

### Κλιμάκωση Δικαιωμάτων

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md" %}
[aws-directory-services-privesc.md](../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md)
{% endcontent-ref %}

## Διαρκής Πρόσβαση

### Χρησιμοποιώντας έναν χρήστη AD

Ένας **χρήστης AD** μπορεί να αποκτήσει **πρόσβαση στην κονσόλα διαχείρισης AWS** μέσω ενός Ρόλου που μπορεί να αναλάβει. Το **προεπιλεγμένο όνομα χρήστη είναι Admin** και είναι δυνατή η **αλλαγή του κωδικού πρόσβασης** από την κονσόλα AWS.

Επομένως, είναι δυνατή η **αλλαγή του κωδικού πρόσβασης του Admin**, η **δημιουργία ενός νέου χρήστη** ή η **αλλαγή του κωδικού πρόσβασης** ενός χρήστη και η χορήγηση αυτού του χρήστη ενός Ρόλου για να διατηρήσει την πρόσβαση.\
Είναι επίσης δυνατή η **προσθήκη ενός χρήστη σε μια ομάδα μέσα στο AD** και η **παροχή πρόσβασης σε αυτήν την ομάδα AD σε έναν Ρόλο** (για να γίνει αυτή η διαρκής πρόσβαση πιο διακριτική).

### Κοινή Χρήση AD (από θύμα σε επιτιθέμενο)

Είναι δυνατή η κοινή χρήση ενός περιβάλλοντος AD από ένα θύμα σε έναν επιτιθέμενο. Με αυτόν τον τρόπο, ο επιτιθέμενος θα μπορεί να συνεχίσει να έχει πρόσβαση στο περιβάλλον AD.\
Ωστόσο, αυτό συνεπάγεται την κοινή χρήση του διαχειριζόμενου AD και επίσης τη δημιουργία μιας σύνδεσης VPC peering.

Μπορείτε να βρείτε έναν οδηγό εδώ: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html)

### ~~Κοινή Χρήση AD (από επιτιθέμενο σε θύμα)~~

Δεν φαίνεται δυνατό να παραχωρηθεί πρόσβαση AWS σε χρήστες από ένα διαφορετικό περιβάλλον AD σε έναν λογαριασμό AWS.

## WorkDocs

Η υπηρεσία Amazon Web Services (AWS) WorkDocs είναι μια υπηρεσία **αποθήκευσης και κοινής χρήσης αρχείων** βασισμένη στο cloud. Είναι μέρος της σουίτας υπηρεσιών υπολογιστικού νέφους της AWS και έχει σχεδιαστεί για να παρέχει μια ασφαλή και κλιμακούμενη λύση για οργανισμούς να αποθηκεύουν, να μοιράζονται και να συνεργάζονται σε αρχεία και έγγραφα.

Η AWS WorkDocs παρέχει μια διαδικτυακή διεπαφή για τους χρήστες να ανεβάζουν, να έχουν πρόσβαση και να διαχειρίζονται τα αρχεία και τα έγγραφά τους. Προσφέρει επίσης δυνατότητες όπως έλεγχο εκδόσεων, συνεργασία σε πραγματικό χρόνο και ενσωμάτωση με άλλες υπηρεσίες AWS και εργαλεία τρίτων.

### Αρίθμηση

{% code overflow="wrap" %}
```bash
# Get AD users (Admin not included)
aws workdocs describe-users --organization-id <directory-id>
# Get AD groups (containing "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Create user (created inside the AD)
aws workdocs create-user --username testingasd --given-name testingasd --surname testingasd --password <password> --email-address name@directory.domain --organization-id <directory-id>

# Get what each user has created
aws workdocs describe-activities --user-id "S-1-5-21-377..."

# Get what was created in the directory
aws workdocs describe-activities --organization-id <directory-id>

# Get folder content
aws workdocs describe-folder-contents --folder-id <fold-id>

# Get file (a url to access with the content will be retreived)
aws workdocs get-document --document-id <doc-id>

# Get resource permissions if any
aws workdocs describe-resource-permissions --resource-id <value>

# Add permission so anyway can see the file
aws workdocs add-resource-permissions --resource-id <id> --principals Id=anonymous,Type=ANONYMOUS,Role=VIEWER
## This will give an id, the file will be acesible in: https://<name>.awsapps.com/workdocs/index.html#/share/document/<id>
```
{% endcode %}

### Privesc

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md" %}
[aws-workdocs-privesc.md](../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
