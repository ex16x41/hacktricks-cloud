# AWS - S3, Athena & Glacier Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## S3

Amazon S3, **bÃ¼yÃ¼k miktarda veri depolamanÄ±za** olanak tanÄ±yan bir hizmettir.

Amazon S3, verilerin dinlenme halindeki **korunmasÄ±nÄ±** saÄŸlamak iÃ§in birden fazla seÃ§enek sunar. SeÃ§enekler arasÄ±nda **Ä°zin** (Politika), **Åifreleme** (Ä°stemci ve Sunucu TarafÄ±), **Kova SÃ¼rÃ¼mleme** ve **MFA** **tabanlÄ± silme** bulunmaktadÄ±r. **KullanÄ±cÄ±,** veri korumasÄ±nÄ± saÄŸlamak iÃ§in bu seÃ§eneklerden herhangi birini etkinleÅŸtirebilir. **Veri Ã§oÄŸaltma**, AWS tarafÄ±ndan saÄŸlanan bir iÃ§ olanak olup, **S3 her nesneyi tÃ¼m EriÅŸilebilirlik AlanlarÄ± arasÄ±nda otomatik olarak Ã§oÄŸaltÄ±r** ve bu durumda organizasyonun bunu etkinleÅŸtirmesi gerekmez.

Kaynak tabanlÄ± izinlerle, kovanÄ±zÄ±n alt dizinleri iÃ§in izinleri ayrÄ± ayrÄ± tanÄ±mlayabilirsiniz.

### Kova SÃ¼rÃ¼mleme ve MFA tabanlÄ± silme

Kova sÃ¼rÃ¼mleme etkinleÅŸtirildiÄŸinde, bir dosyanÄ±n iÃ§indeki bir dosyayÄ± deÄŸiÅŸtirmeye Ã§alÄ±ÅŸan herhangi bir iÅŸlem, dosyanÄ±n yeni bir sÃ¼rÃ¼mÃ¼nÃ¼ oluÅŸturacak ve aynÄ± zamanda Ã¶nceki iÃ§eriÄŸi de koruyacaktÄ±r. Bu nedenle, iÃ§eriÄŸini Ã¼zerine yazmayacaktÄ±r.

AyrÄ±ca, MFA tabanlÄ± silme, S3 kovasÄ±ndaki dosya sÃ¼rÃ¼mlerinin silinmesini ve Kova SÃ¼rÃ¼mlemenin devre dÄ±ÅŸÄ± bÄ±rakÄ±lmasÄ±nÄ± engelleyecektir, bÃ¶ylece bir saldÄ±rgan bu dosyalarÄ± deÄŸiÅŸtiremeyecektir.

Ancak, geliÅŸtiricilerin API anahtarlarÄ±, kimlik bilgileri veya eski API uÃ§ noktalarÄ± gibi hassas bilgileri dosyalarÄ±n Ã¶nceki sÃ¼rÃ¼mlerinde bÄ±rakmalarÄ± durumunda potansiyel bir risk ortaya Ã§Ä±kar. Bu eski sÃ¼rÃ¼mlere eriÅŸim saÄŸlayan saldÄ±rganlar veya yetkisiz kullanÄ±cÄ±lar, kova veya nesneler Ã¼zerindeki izinler dÃ¼zgÃ¼n bir ÅŸekilde gÃ¼vence altÄ±na alÄ±nmamÄ±ÅŸsa bu bilgileri kÃ¶tÃ¼ye kullanabilir.

Bir kovanÄ±n sÃ¼rÃ¼mlemeyi etkinleÅŸtirip etkinleÅŸtirmediÄŸini kontrol etmek iÃ§in bu komutu kullanabilirsiniz:
```bash
aws s3api get-bucket-versioning --bucket <bucket_name>
```
OlasÄ± bir Ã§Ä±ktÄ± ÅŸÃ¶yle gÃ¶rÃ¼nÃ¼r:
```json
{
"Status": "Enabled"
}
```
**Not: Kova sÃ¼rÃ¼m durumunu almak iÃ§in kova sahibi olmalÄ±sÄ±nÄ±z.**

TÃ¼m nesnelerin sÃ¼rÃ¼mlerini gÃ¶rmek iÃ§in deneyin:

> Bu iÅŸlemi kullanmak iÃ§in s3:ListBucketVersions eylemini gerÃ§ekleÅŸtirme iznine sahip olmalÄ±sÄ±nÄ±z. Ä°sim farkÄ±nÄ±n farkÄ±nda olun.
```bash
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>
# redirect output into a file
aws --no-sign-request s3api list-object-versions --bucket <bucket_name> > versions.json
```
Bir nesne iÃ§in belirli bir sÃ¼rÃ¼m almak iÃ§in ÅŸunu deneyin:
```bash
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>
```
### S3 EriÅŸim gÃ¼nlÃ¼kleri

BazÄ± birim iÃ§in **S3 eriÅŸim giriÅŸini etkinleÅŸtirmek** (varsayÄ±lan olarak devre dÄ±ÅŸÄ±) ve gÃ¼nlÃ¼kleri farklÄ± bir birimde kaydetmek mÃ¼mkÃ¼ndÃ¼r; bÃ¶ylece birimin kimler tarafÄ±ndan eriÅŸildiÄŸini bilebilirsiniz (her iki birim de aynÄ± bÃ¶lgede olmalÄ±dÄ±r).

### S3 Ã–nceden imzalÄ± URL'ler

Genellikle birim iÃ§indeki **belirtilen dosyaya eriÅŸmek iÃ§in** kullanÄ±labilecek bir Ã¶nceden imzalÄ± URL oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r. **Ã–nceden imzalÄ± bir URL ÅŸÃ¶yle gÃ¶rÃ¼nÃ¼r**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
A presigned URL **bir nesneye eriÅŸimi olan bir yetkilinin kimlik bilgileri kullanÄ±larak cli'dan oluÅŸturulabilir** (kullandÄ±ÄŸÄ±nÄ±z hesap eriÅŸime sahip deÄŸilse, daha kÄ±sa bir presigned URL oluÅŸturulacak ancak bu iÅŸe yaramayacaktÄ±r)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
Ã–nceden imzalanmÄ±ÅŸ bir URL oluÅŸturmak iÃ§in gereken tek izin, verilen izindir, bu nedenle Ã¶nceki komut iÃ§in anahtarÄ±n ihtiyaÃ§ duyduÄŸu tek izin `s3:GetObject`'dÄ±r.
{% endhint %}

AyrÄ±ca **diÄŸer izinlerle** Ã¶nceden imzalanmÄ±ÅŸ URL'ler oluÅŸturmak da mÃ¼mkÃ¼ndÃ¼r:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 Åifreleme MekanizmalarÄ±

**DEK, Veri Åifreleme AnahtarÄ±** anlamÄ±na gelir ve verileri ÅŸifrelemek iÃ§in her zaman oluÅŸturulan ve kullanÄ±lan anahtardÄ±r.

<details>

<summary><strong>S3 yÃ¶netilen anahtarlarla sunucu tarafÄ± ÅŸifreleme, SSE-S3</strong></summary>

Bu seÃ§enek, minimum yapÄ±landÄ±rma gerektirir ve kullanÄ±lan ÅŸifreleme anahtarlarÄ±nÄ±n tÃ¼m yÃ¶netimi AWS tarafÄ±ndan yapÄ±lÄ±r. Tek yapmanÄ±z gereken **verilerinizi yÃ¼klemek ve S3 diÄŸer tÃ¼m yÃ¶nleriyle ilgilenecektir**. S3 hesabÄ±ndaki her bir kovaya bir kova anahtarÄ± atanÄ±r.

* Åifreleme:
* Nesne Verisi + oluÅŸturulan dÃ¼z metin DEK --> ÅifrelenmiÅŸ veri (S3 iÃ§inde saklanÄ±r)
* OluÅŸturulan dÃ¼z metin DEK + S3 AnahtarlarÄ± --> ÅifrelenmiÅŸ DEK (S3 iÃ§inde saklanÄ±r) ve dÃ¼z metin bellekten silinir
* Åifre Ã§Ã¶zme:
* ÅifrelenmiÅŸ DEK + S3 AnahtarlarÄ± --> DÃ¼z metin DEK
* DÃ¼z metin DEK + ÅifrelenmiÅŸ veri --> Nesne Verisi

LÃ¼tfen, bu durumda **anahtarÄ±n AWS tarafÄ±ndan yÃ¶netildiÄŸini** unutmayÄ±n (sadece 3 yÄ±lda bir dÃ¶ndÃ¼rme). Kendi anahtarÄ±nÄ±zÄ± kullanÄ±rsanÄ±z dÃ¶ndÃ¼rme, devre dÄ±ÅŸÄ± bÄ±rakma ve eriÅŸim kontrolÃ¼ uygulama imkanÄ±na sahip olursunuz.

</details>

<details>

<summary><strong>KMS yÃ¶netilen anahtarlarla sunucu tarafÄ± ÅŸifreleme, SSE-KMS</strong></summary>

Bu yÃ¶ntem, S3'Ã¼n veri ÅŸifreleme anahtarlarÄ±nÄ±zÄ± oluÅŸturmak iÃ§in anahtar yÃ¶netim hizmetini kullanmasÄ±na olanak tanÄ±r. KMS, anahtarlarÄ±nÄ±zÄ±n nasÄ±l yÃ¶netileceÄŸi konusunda Ã§ok daha fazla esneklik saÄŸlar. Ã–rneÄŸin, CMK'yÄ± devre dÄ±ÅŸÄ± bÄ±rakabilir, dÃ¶ndÃ¼rebilir ve eriÅŸim kontrolleri uygulayabilirsiniz ve bunlarÄ±n kullanÄ±mÄ±na karÅŸÄ± AWS Cloud Trail kullanarak sipariÅŸ verebilirsiniz.

* Åifreleme:
* S3, KMS CMK'dan veri anahtarlarÄ± talep eder
* KMS, dÃ¼z metin DEK ve ÅŸifrelenmiÅŸ DEK Ã§iftini oluÅŸturmak iÃ§in bir CMK kullanÄ±r ve bunlarÄ± S3'e gÃ¶nderir
* S3, verileri ÅŸifrelemek iÃ§in dÃ¼z metin anahtarÄ±nÄ± kullanÄ±r, ÅŸifrelenmiÅŸ veriyi ve ÅŸifrelenmiÅŸ anahtarÄ± saklar ve dÃ¼z metin anahtarÄ±nÄ± bellekten siler
* Åifre Ã§Ã¶zme:
* S3, nesnenin ÅŸifrelenmiÅŸ veri anahtarÄ±nÄ± KMS'ten Ã§Ã¶zmesini ister
* KMS, CMK ile veri anahtarÄ±nÄ± Ã§Ã¶zer ve S3'e geri gÃ¶nderir
* S3, nesne verisini Ã§Ã¶zer

</details>

<details>

<summary><strong>MÃ¼ÅŸteri tarafÄ±ndan saÄŸlanan anahtarlarla sunucu tarafÄ± ÅŸifreleme, SSE-C</strong></summary>

Bu seÃ§enek, AWS dÄ±ÅŸÄ±nda zaten kullanÄ±yor olabileceÄŸiniz kendi anahtarÄ±nÄ±zÄ± saÄŸlamanÄ±za olanak tanÄ±r. MÃ¼ÅŸteri tarafÄ±ndan saÄŸlanan anahtar, verilerinizle birlikte S3'e gÃ¶nderilir ve burada S3 sizin iÃ§in ÅŸifreleme iÅŸlemini gerÃ§ekleÅŸtirir.

* Åifreleme:
* KullanÄ±cÄ± nesne verisini + MÃ¼ÅŸteri anahtarÄ±nÄ± S3'e gÃ¶nderir
* MÃ¼ÅŸteri anahtarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r ve ÅŸifrelenmiÅŸ veri saklanÄ±r
* MÃ¼ÅŸteri anahtarÄ±nÄ±n gelecekteki anahtar doÄŸrulamasÄ± iÃ§in bir tuzlu HMAC deÄŸeri de saklanÄ±r
* MÃ¼ÅŸteri anahtarÄ± bellekten silinir
* Åifre Ã§Ã¶zme:
* KullanÄ±cÄ± mÃ¼ÅŸteri anahtarÄ±nÄ± gÃ¶nderir
* Anahtar, saklanan HMAC deÄŸeri ile doÄŸrulanÄ±r
* MÃ¼ÅŸteri tarafÄ±ndan saÄŸlanan anahtar, verileri Ã§Ã¶zmek iÃ§in kullanÄ±lÄ±r

</details>

<details>

<summary><strong>KMS ile istemci tarafÄ± ÅŸifreleme, CSE-KMS</strong></summary>

SSE-KMS'ye benzer ÅŸekilde, bu da veri ÅŸifreleme anahtarlarÄ±nÄ±zÄ± oluÅŸturmak iÃ§in anahtar yÃ¶netim hizmetini kullanÄ±r. Ancak, bu sefer KMS, S3 deÄŸil, istemci aracÄ±lÄ±ÄŸÄ±yla Ã§aÄŸrÄ±lÄ±r. Åifreleme istemci tarafÄ±nda gerÃ§ekleÅŸir ve ÅŸifrelenmiÅŸ veri daha sonra saklanmak Ã¼zere S3'e gÃ¶nderilir.

* Åifreleme:
* Ä°stemci, KMS'ten bir veri anahtarÄ± talep eder
* KMS, dÃ¼z metin DEK ve CMK ile ÅŸifrelenmiÅŸ DEK'i dÃ¶ner
* Her iki anahtar geri gÃ¶nderilir
* Ä°stemci, dÃ¼z metin DEK ile verileri ÅŸifreler ve ÅŸifrelenmiÅŸ veriyi + ÅŸifrelenmiÅŸ DEK'i S3'e gÃ¶nderir (bu, S3 iÃ§indeki ÅŸifrelenmiÅŸ verinin meta verisi olarak saklanÄ±r)
* Åifre Ã§Ã¶zme:
* ÅifrelenmiÅŸ veri ve ÅŸifrelenmiÅŸ DEK istemciye gÃ¶nderilir
* Ä°stemci, CMK kullanarak ÅŸifrelenmiÅŸ anahtarÄ± Ã§Ã¶zmek iÃ§in KMS'e baÅŸvurur ve KMS dÃ¼z metin DEK'i geri gÃ¶nderir
* Ä°stemci artÄ±k ÅŸifrelenmiÅŸ veriyi Ã§Ã¶zebilir

</details>

<details>

<summary><strong>MÃ¼ÅŸteri tarafÄ±ndan saÄŸlanan anahtarlarla istemci tarafÄ± ÅŸifreleme, CSE-C</strong></summary>

Bu mekanizmayÄ± kullanarak, kendi saÄŸladÄ±ÄŸÄ±nÄ±z anahtarlarÄ± kullanabilir ve verilerinizi S3'e gÃ¶ndermeden Ã¶nce ÅŸifrelemek iÃ§in bir AWS-SDK istemcisi kullanabilirsiniz.

* Åifreleme:
* Ä°stemci bir DEK oluÅŸturur ve dÃ¼z metin verileri ÅŸifreler
* ArdÄ±ndan, kendi Ã¶zel CMK'sini kullanarak DEK'i ÅŸifreler
* ÅifrelenmiÅŸ veriyi + ÅŸifrelenmiÅŸ DEK'i S3'e gÃ¶nderir ve burada saklanÄ±r
* Åifre Ã§Ã¶zme:
* S3, ÅŸifrelenmiÅŸ veriyi ve DEK'i gÃ¶nderir
* Ä°stemci, DEK'i ÅŸifrelemek iÃ§in kullanÄ±lan CMK'ya zaten sahip olduÄŸundan, DEK'i Ã§Ã¶zer ve ardÄ±ndan dÃ¼z metin DEK'i verileri Ã§Ã¶zmek iÃ§in kullanÄ±r

</details>

### **NumaralandÄ±rma**

AWS organizasyonlarÄ±nÄ± tehlikeye atmanÄ±n geleneksel ana yollarÄ±ndan biri, kamuya aÃ§Ä±k eriÅŸilebilir kovalarÄ± tehlikeye atmaktÄ±r. **Bulabilirsiniz** [**bu sayfadaki kamuya aÃ§Ä±k kova numaralandÄ±rÄ±cÄ±larÄ±nÄ±**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# list objects version history
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>

# get a specific version for a object
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name â€“-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Ownerâ€™s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Bir S3 bucket'Ä±na, sanal barÄ±ndÄ±rma tarzÄ± veya yol tarzÄ± bir uÃ§ nokta adÄ± kullanarak Ã§ift yÄ±ÄŸÄ±n uÃ§ noktasÄ± aracÄ±lÄ±ÄŸÄ±yla eriÅŸebilirsiniz. Bunlar, S3'e IPv6 Ã¼zerinden eriÅŸmek iÃ§in faydalÄ±dÄ±r.

Ã‡ift yÄ±ÄŸÄ±n uÃ§ noktalarÄ± aÅŸaÄŸÄ±daki sÃ¶zdizimini kullanÄ±r:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

AÅŸaÄŸÄ±daki sayfada **S3 izinlerini kÃ¶tÃ¼ye kullanarak ayrÄ±calÄ±klarÄ± artÄ±rma** yÃ¶ntemini kontrol edebilirsiniz:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Kimlik DoÄŸrulamasÄ± Olmayan EriÅŸim

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 SonrasÄ± Ä°stismar

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### SÃ¼reklilik

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## DiÄŸer S3 zafiyetleri

### S3 HTTP Ã–nbellek Zehirlenmesi Sorunu <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**Bu araÅŸtÄ±rmaya gÃ¶re**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) rastgele bir bucket'Ä±n yanÄ±tÄ±nÄ±, farklÄ± birine aitmiÅŸ gibi Ã¶nbelleÄŸe almak mÃ¼mkÃ¼ndÃ¼. Bu, Ã¶rneÄŸin javascript dosyasÄ± yanÄ±tlarÄ±nÄ± deÄŸiÅŸtirmek ve S3'Ã¼ statik kod depolamak iÃ§in kullanan rastgele sayfalarÄ± tehlikeye atmak iÃ§in kÃ¶tÃ¼ye kullanÄ±labilirdi.

## Amazon Athena

Amazon Athena, verileri doÄŸrudan Amazon Basit Depolama Servisi (Amazon **S3**) **kullanarak** standart **SQL** ile **analiz etmeyi** kolaylaÅŸtÄ±ran etkileÅŸimli bir sorgu hizmetidir.

GÃ¶zetlenen S3 bucket'larÄ±nda gÃ¶rÃ¼necek iÃ§eriÄŸin formatÄ±nda **iliÅŸkisel bir DB tablosu** **hazÄ±rlamanÄ±z** gerekir. ArdÄ±ndan, Amazon Athena, gÃ¼nlÃ¼klerden DB'yi doldurabilecektir, bÃ¶ylece sorgulayabilirsiniz.

Amazon Athena, **zaten ÅŸifrelenmiÅŸ S3 verilerini sorgulama yeteneÄŸini** destekler ve bÃ¶yle yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±nda, **Athena ayrÄ±ca sorgu sonuÃ§larÄ±nÄ± ÅŸifreleyebilir ve bunlar daha sonra S3'te depolanabilir**.

**Bu sonuÃ§larÄ±n ÅŸifrelenmesi, sorgulanan S3 verilerinin altÄ±nda yatan ÅŸifrelemeden baÄŸÄ±msÄ±zdÄ±r**, yani S3 verileri ÅŸifrelenmemiÅŸ olsa bile, sorgulanan sonuÃ§lar ÅŸifrelenebilir. Bilinmesi gereken birkaÃ§ nokta, Amazon Athena'nÄ±n yalnÄ±zca **aÅŸaÄŸÄ±daki S3 ÅŸifreleme yÃ¶ntemleriyle ÅŸifrelenmiÅŸ** verileri desteklediÄŸidir: **SSE-S3, SSE-KMS ve CSE-KMS**.

SSE-C ve CSE-E desteklenmemektedir. Bunun yanÄ± sÄ±ra, Amazon Athena'nÄ±n yalnÄ±zca **sorgunun kendisiyle aynÄ± bÃ¶lgede bulunan ÅŸifrelenmiÅŸ nesneler Ã¼zerinde sorgu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±nÄ±** anlamak Ã¶nemlidir. KMS kullanÄ±larak ÅŸifrelenmiÅŸ S3 verilerini sorgulamanÄ±z gerekiyorsa, Athena kullanÄ±cÄ±sÄ±nÄ±n sorguyu gerÃ§ekleÅŸtirebilmesi iÃ§in belirli izinlere sahip olmasÄ± gerekir.

### Enumeration
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## Referanslar

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
