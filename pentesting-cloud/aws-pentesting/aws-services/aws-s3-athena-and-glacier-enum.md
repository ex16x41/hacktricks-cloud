# AWS - S3, Athena & Glacier Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## S3

Amazon S3 √© um servi√ßo que permite que voc√™ **armazenar grandes quantidades de dados**.

Amazon S3 oferece v√°rias op√ß√µes para alcan√ßar a **prote√ß√£o** dos dados em repouso. As op√ß√µes incluem **Permiss√£o** (Pol√≠tica), **Criptografia** (Lado do Cliente e Lado do Servidor), **Versionamento de Bucket** e **exclus√£o baseada em MFA**. O **usu√°rio pode habilitar** qualquer uma dessas op√ß√µes para alcan√ßar a prote√ß√£o dos dados. A **replica√ß√£o de dados** √© uma funcionalidade interna da AWS onde **S3 replica automaticamente cada objeto em todas as Zonas de Disponibilidade** e a organiza√ß√£o n√£o precisa habilit√°-la nesse caso.

Com permiss√µes baseadas em recursos, voc√™ pode definir permiss√µes para subdiret√≥rios do seu bucket separadamente.

### Versionamento de Bucket e exclus√£o baseada em MFA

Quando o versionamento de bucket est√° habilitado, qualquer a√ß√£o que tenta alterar um arquivo dentro de um arquivo gerar√° uma nova vers√£o do arquivo, mantendo tamb√©m o conte√∫do anterior do mesmo. Portanto, n√£o sobrescrever√° seu conte√∫do.

Al√©m disso, a exclus√£o baseada em MFA impedir√° que vers√µes de arquivos no bucket S3 sejam exclu√≠das e tamb√©m que o Versionamento de Bucket seja desativado, de modo que um atacante n√£o poder√° alterar esses arquivos.

No entanto, um risco potencial surge se os desenvolvedores deixarem informa√ß√µes sens√≠veis, como chaves de API, credenciais ou antigos endpoints de API nas vers√µes anteriores dos arquivos. Atacantes ou usu√°rios n√£o autorizados que obtiverem acesso a essas vers√µes mais antigas poderiam explorar essas informa√ß√µes se as permiss√µes no bucket ou objetos n√£o estiverem devidamente protegidas.

Para verificar se um bucket habilita o versionamento, voc√™ pode usar este comando:
```bash
aws s3api get-bucket-versioning --bucket <bucket_name>
```
Uma sa√≠da poss√≠vel se parece com:
```json
{
"Status": "Enabled"
}
```
**Nota: Voc√™ deve ser o propriet√°rio do bucket para recuperar o status de versionamento do bucket.**

Para ver todas as vers√µes dos objetos, tente:

> Para usar esta opera√ß√£o, voc√™ deve ter permiss√£o para realizar a a√ß√£o s3:ListBucketVersions. Esteja ciente da diferen√ßa de nome.
```bash
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>
# redirect output into a file
aws --no-sign-request s3api list-object-versions --bucket <bucket_name> > versions.json
```
Para obter uma vers√£o espec√≠fica de um objeto, tente:
```bash
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>
```
### S3 Access logs

√â poss√≠vel **ativar o login de acesso S3** (que por padr√£o est√° desativado) para algum bucket e salvar os logs em um bucket diferente para saber quem est√° acessando o bucket (ambos os buckets devem estar na mesma regi√£o).

### S3 Presigned URLs

√â poss√≠vel gerar uma URL pr√©-assinada que pode geralmente ser usada para **acessar o arquivo especificado** no bucket. Uma **URL pr√©-assinada se parece com isso**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
Uma URL pr√©-assinada pode ser **criada a partir da cli usando credenciais de um principal com acesso ao objeto** (se a conta que voc√™ usa n√£o tiver acesso, uma URL pr√©-assinada mais curta ser√° criada, mas ser√° in√∫til)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
A √∫nica permiss√£o necess√°ria para gerar uma URL pr√©-assinada √© a permiss√£o que est√° sendo concedida, ent√£o para o comando anterior a √∫nica permiss√£o necess√°ria pelo principal √© `s3:GetObject`
{% endhint %}

Tamb√©m √© poss√≠vel criar URLs pr√©-assinadas com **outras permiss√µes**:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### Mecanismos de Criptografia do S3

**DEK significa Chave de Criptografia de Dados** e √© a chave que √© sempre gerada e usada para criptografar dados.

<details>

<summary><strong>Criptografia do lado do servidor com chaves gerenciadas pelo S3, SSE-S3</strong></summary>

Esta op√ß√£o requer configura√ß√£o m√≠nima e toda a gest√£o das chaves de criptografia utilizadas √© gerenciada pela AWS. Tudo o que voc√™ precisa fazer √© **carregar seus dados e o S3 cuidar√° de todos os outros aspectos**. Cada bucket em uma conta S3 √© atribu√≠do a uma chave de bucket.

* Criptografia:
* Dados do objeto + DEK em texto simples criado --> Dados criptografados (armazenados dentro do S3)
* DEK em texto simples criado + Chave Mestra do S3 --> DEK criptografado (armazenado dentro do S3) e o texto simples √© exclu√≠do da mem√≥ria
* Descriptografia:
* DEK criptografado + Chave Mestra do S3 --> DEK em texto simples
* DEK em texto simples + Dados criptografados --> Dados do objeto

Por favor, note que neste caso **a chave √© gerenciada pela AWS** (rota√ß√£o apenas a cada 3 anos). Se voc√™ usar sua pr√≥pria chave, poder√° rotacionar, desativar e aplicar controle de acesso.

</details>

<details>

<summary><strong>Criptografia do lado do servidor com chaves gerenciadas pelo KMS, SSE-KMS</strong></summary>

Este m√©todo permite que o S3 use o servi√ßo de gerenciamento de chaves para gerar suas chaves de criptografia de dados. O KMS oferece uma flexibilidade muito maior sobre como suas chaves s√£o gerenciadas. Por exemplo, voc√™ pode desativar, rotacionar e aplicar controles de acesso ao CMK, e ordenar contra seu uso usando o AWS Cloud Trail.

* Criptografia:
* S3 solicita chaves de dados ao KMS CMK
* O KMS usa um CMK para gerar o par DEK em texto simples e DEK criptografado e os envia para o S3
* O S3 usa a chave em texto simples para criptografar os dados, armazena os dados criptografados e a chave criptografada e exclui da mem√≥ria a chave em texto simples
* Descriptografia:
* O S3 solicita ao KMS para descriptografar a chave de dados criptografada do objeto
* O KMS descriptografa a chave de dados com o CMK e a envia de volta ao S3
* O S3 descriptografa os dados do objeto

</details>

<details>

<summary><strong>Criptografia do lado do servidor com chaves fornecidas pelo cliente, SSE-C</strong></summary>

Esta op√ß√£o oferece a oportunidade de fornecer sua pr√≥pria chave mestra que voc√™ pode j√° estar usando fora da AWS. Sua chave fornecida pelo cliente seria ent√£o enviada com seus dados para o S3, onde o S3 realizaria a criptografia para voc√™.

* Criptografia:
* O usu√°rio envia os dados do objeto + chave do cliente para o S3
* A chave do cliente √© usada para criptografar os dados e os dados criptografados s√£o armazenados
* um valor HMAC salgado da chave do cliente tamb√©m √© armazenado para valida√ß√£o futura da chave
* a chave do cliente √© exclu√≠da da mem√≥ria
* Descriptografia:
* O usu√°rio envia a chave do cliente
* A chave √© validada contra o valor HMAC armazenado
* A chave fornecida pelo cliente √© ent√£o usada para descriptografar os dados

</details>

<details>

<summary><strong>Criptografia do lado do cliente com KMS, CSE-KMS</strong></summary>

Semelhante ao SSE-KMS, isso tamb√©m usa o servi√ßo de gerenciamento de chaves para gerar suas chaves de criptografia de dados. No entanto, desta vez o KMS √© chamado pelo cliente, n√£o pelo S3. A criptografia ocorre do lado do cliente e os dados criptografados s√£o enviados ao S3 para serem armazenados.

* Criptografia:
* O cliente solicita uma chave de dados ao KMS
* O KMS retorna o DEK em texto simples e o DEK criptografado com o CMK
* Ambas as chaves s√£o enviadas de volta
* O cliente ent√£o criptografa os dados com o DEK em texto simples e envia ao S3 os dados criptografados + o DEK criptografado (que √© salvo como metadados dos dados criptografados dentro do S3)
* Descriptografia:
* Os dados criptografados com o DEK criptografado s√£o enviados ao cliente
* O cliente solicita ao KMS para descriptografar a chave criptografada usando o CMK e o KMS envia de volta o DEK em texto simples
* O cliente agora pode descriptografar os dados criptografados

</details>

<details>

<summary><strong>Criptografia do lado do cliente com chaves fornecidas pelo cliente, CSE-C</strong></summary>

Usando este mecanismo, voc√™ pode utilizar suas pr√≥prias chaves fornecidas e usar um cliente AWS-SDK para criptografar seus dados antes de envi√°-los ao S3 para armazenamento.

* Criptografia:
* O cliente gera um DEK e criptografa os dados em texto simples
* Em seguida, usando seu pr√≥prio CMK personalizado, ele criptografa o DEK
* envia os dados criptografados + DEK criptografado para o S3, onde s√£o armazenados
* Descriptografia:
* O S3 envia os dados criptografados e o DEK
* Como o cliente j√° possui o CMK usado para criptografar o DEK, ele descriptografa o DEK e ent√£o usa o DEK em texto simples para descriptografar os dados

</details>

### **Enumera√ß√£o**

Uma das principais maneiras tradicionais de comprometer organiza√ß√µes AWS come√ßa comprometendo buckets publicamente acess√≠veis. **Voc√™ pode encontrar** [**enumeradores de buckets p√∫blicos nesta p√°gina**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# list objects version history
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>

# get a specific version for a object
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name ‚Äì-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner‚Äôs displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Voc√™ pode acessar um bucket S3 atrav√©s de um endpoint de pilha dupla usando um nome de endpoint de estilo hospedado virtual ou de estilo de caminho. Estes s√£o √∫teis para acessar o S3 atrav√©s do IPv6.

Os endpoints de pilha dupla usam a seguinte sintaxe:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes do S3 para escalar privil√©gios**:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Acesso N√£o Autenticado

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 P√≥s Explora√ß√£o

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Persist√™ncia

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Outras vulnerabilidades do S3

### Problema de Envenenamento de Cache HTTP do S3 <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**De acordo com esta pesquisa**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue), foi poss√≠vel armazenar em cache a resposta de um bucket arbitr√°rio como se pertencesse a outro diferente. Isso poderia ter sido abusado para alterar, por exemplo, as respostas de arquivos javascript e comprometer p√°ginas arbitr√°rias usando o S3 para armazenar c√≥digo est√°tico.

## Amazon Athena

Amazon Athena √© um servi√ßo de consulta interativa que facilita a **an√°lise de dados** diretamente no Amazon Simple Storage Service (Amazon **S3**) **usando** SQL **padr√£o**.

Voc√™ precisa **preparar uma tabela de banco de dados relacional** com o formato do conte√∫do que vai aparecer nos buckets S3 monitorados. E ent√£o, o Amazon Athena ser√° capaz de popular o banco de dados a partir dos logs, para que voc√™ possa consult√°-lo.

O Amazon Athena suporta a **capacidade de consultar dados do S3 que j√° est√£o criptografados** e, se configurado para isso, **Athena tamb√©m pode criptografar os resultados da consulta, que podem ser armazenados no S3**.

**Essa criptografia de resultados √© independente dos dados S3 consultados**, o que significa que mesmo que os dados S3 n√£o estejam criptografados, os resultados consultados podem ser criptografados. Alguns pontos a serem observados s√£o que o Amazon Athena suporta apenas dados que foram **criptografados** com os **seguintes m√©todos de criptografia do S3**, **SSE-S3, SSE-KMS e CSE-KMS**.

SSE-C e CSE-E n√£o s√£o suportados. Al√©m disso, √© importante entender que o Amazon Athena s√≥ executar√° consultas contra **objetos criptografados que est√£o na mesma regi√£o que a pr√≥pria consulta**. Se voc√™ precisar consultar dados do S3 que foram criptografados usando KMS, permiss√µes espec√≠ficas s√£o necess√°rias pelo usu√°rio do Athena para permitir que ele execute a consulta.

### Enumera√ß√£o
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## Refer√™ncias

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
