# AWS - S3, Athena & Glacier Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## S3

Amazon S3 to usÅ‚uga, ktÃ³ra pozwala **przechowywaÄ‡ duÅ¼e iloÅ›ci danych**.

Amazon S3 oferuje wiele opcji, aby osiÄ…gnÄ…Ä‡ **ochronÄ™** danych w spoczynku. Opcje te obejmujÄ… **Uprawnienia** (Polityka), **Szyfrowanie** (po stronie klienta i serwera), **Wersjonowanie kubeÅ‚kÃ³w** oraz **usuwanie oparte na MFA**. **UÅ¼ytkownik moÅ¼e wÅ‚Ä…czyÄ‡** dowolnÄ… z tych opcji, aby osiÄ…gnÄ…Ä‡ ochronÄ™ danych. **Replikacja danych** to wewnÄ™trzna funkcja AWS, w ktÃ³rej **S3 automatycznie replikuje kaÅ¼dy obiekt we wszystkich strefach dostÄ™pnoÅ›ci**, a organizacja nie musi jej wÅ‚Ä…czaÄ‡ w tym przypadku.

DziÄ™ki uprawnieniom opartym na zasobach moÅ¼esz definiowaÄ‡ uprawnienia dla podkatalogÃ³w swojego kubeÅ‚ka osobno.

### Wersjonowanie kubeÅ‚kÃ³w i usuwanie oparte na MFA

Gdy wersjonowanie kubeÅ‚kÃ³w jest wÅ‚Ä…czone, kaÅ¼da akcja, ktÃ³ra prÃ³buje zmieniÄ‡ plik wewnÄ…trz pliku, wygeneruje nowÄ… wersjÄ™ pliku, zachowujÄ…c rÃ³wnieÅ¼ poprzedniÄ… zawartoÅ›Ä‡ tego samego. Dlatego nie nadpisze jego zawartoÅ›ci.

Ponadto, usuwanie oparte na MFA zapobiegnie usuniÄ™ciu wersji pliku w kubeÅ‚ku S3 oraz wyÅ‚Ä…czeniu wersjonowania kubeÅ‚kÃ³w, wiÄ™c atakujÄ…cy nie bÄ™dzie w stanie zmieniÄ‡ tych plikÃ³w.

JednakÅ¼e, potencjalne ryzyko pojawia siÄ™, jeÅ›li deweloperzy pozostawiÄ… w poprzednich wersjach plikÃ³w wraÅ¼liwe informacje, takie jak klucze API, dane uwierzytelniajÄ…ce lub stare punkty koÅ„cowe API. AtakujÄ…cy lub nieautoryzowani uÅ¼ytkownicy, ktÃ³rzy uzyskajÄ… dostÄ™p do tych starszych wersji, mogÄ… wykorzystaÄ‡ te informacje, jeÅ›li uprawnienia do kubeÅ‚ka lub obiektÃ³w nie sÄ… odpowiednio zabezpieczone.

Aby sprawdziÄ‡, czy kubeÅ‚ek wÅ‚Ä…cza wersjonowanie, moÅ¼esz uÅ¼yÄ‡ tego polecenia:
```bash
aws s3api get-bucket-versioning --bucket <bucket_name>
```
MoÅ¼liwe wyjÅ›cie wyglÄ…da nastÄ™pujÄ…co:
```json
{
"Status": "Enabled"
}
```
**Uwaga: Musisz byÄ‡ wÅ‚aÅ›cicielem kosza, aby uzyskaÄ‡ status wersjonowania kosza.**

Aby zobaczyÄ‡ wszystkie wersje obiektÃ³w, sprÃ³buj:

> Aby uÅ¼yÄ‡ tej operacji, musisz mieÄ‡ uprawnienia do wykonania akcji s3:ListBucketVersions. ZwrÃ³Ä‡ uwagÄ™ na rÃ³Å¼nicÄ™ w nazwach.
```bash
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>
# redirect output into a file
aws --no-sign-request s3api list-object-versions --bucket <bucket_name> > versions.json
```
Aby uzyskaÄ‡ konkretnÄ… wersjÄ™ obiektu, sprÃ³buj:
```bash
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>
```
### S3 Access logs

MoÅ¼liwe jest **wÅ‚Ä…czenie logowania dostÄ™pu S3** (ktÃ³re domyÅ›lnie jest wyÅ‚Ä…czone) dla niektÃ³rego koszyka i zapisanie logÃ³w w innym koszyku, aby wiedzieÄ‡, kto uzyskuje dostÄ™p do koszyka (oba koszyki muszÄ… znajdowaÄ‡ siÄ™ w tym samym regionie).

### S3 Presigned URLs

MoÅ¼liwe jest wygenerowanie podpisanego URL, ktÃ³ry zazwyczaj moÅ¼e byÄ‡ uÅ¼ywany do **uzyskania dostÄ™pu do okreÅ›lonego pliku** w koszyku. **Podpisany URL wyglÄ…da tak**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
Aby **utworzyÄ‡ presigned URL z cli przy uÅ¼yciu poÅ›wiadczeÅ„ podmiotu majÄ…cego dostÄ™p do obiektu** (jeÅ›li konto, ktÃ³rego uÅ¼ywasz, nie ma dostÄ™pu, zostanie utworzony krÃ³tszy presigned URL, ale bÄ™dzie bezuÅ¼yteczny)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
Jedynym wymaganym uprawnieniem do wygenerowania presigned URL jest przyznane uprawnienie, wiÄ™c dla poprzedniego polecenia jedynym wymaganym uprawnieniem przez podmiot jest `s3:GetObject`
{% endhint %}

MoÅ¼liwe jest rÃ³wnieÅ¼ tworzenie presigned URLs z **innymi uprawnieniami**:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 Mechanizmy Szyfrowania

**DEK oznacza Klucz Szyfrowania Danych** i jest kluczem, ktÃ³ry jest zawsze generowany i uÅ¼ywany do szyfrowania danych.

<details>

<summary><strong>Szyfrowanie po stronie serwera z kluczami zarzÄ…dzanymi przez S3, SSE-S3</strong></summary>

Ta opcja wymaga minimalnej konfiguracji, a zarzÄ…dzanie kluczami szyfrowania jest obsÅ‚ugiwane przez AWS. Wszystko, co musisz zrobiÄ‡, to **przesÅ‚aÄ‡ swoje dane, a S3 zajmie siÄ™ wszystkimi innymi aspektami**. KaÅ¼demu koszykowi w koncie S3 przypisany jest klucz koszyka.

* Szyfrowanie:
* Dane obiektu + utworzony jawny DEK --> Szyfrowane dane (przechowywane w S3)
* Utworzony jawny DEK + Klucz GÅ‚Ã³wny S3 --> Szyfrowany DEK (przechowywany w S3) i tekst jawny jest usuwany z pamiÄ™ci
* Deszyfrowanie:
* Szyfrowany DEK + Klucz GÅ‚Ã³wny S3 --> Jawny DEK
* Jawny DEK + Szyfrowane dane --> Dane obiektu

ProszÄ™ zauwaÅ¼yÄ‡, Å¼e w tym przypadku **klucz jest zarzÄ…dzany przez AWS** (rotacja tylko co 3 lata). JeÅ›li uÅ¼yjesz wÅ‚asnego klucza, bÄ™dziesz mÃ³gÅ‚ rotowaÄ‡, dezaktywowaÄ‡ i stosowaÄ‡ kontrolÄ™ dostÄ™pu.

</details>

<details>

<summary><strong>Szyfrowanie po stronie serwera z kluczami zarzÄ…dzanymi przez KMS, SSE-KMS</strong></summary>

Ta metoda pozwala S3 korzystaÄ‡ z usÅ‚ugi zarzÄ…dzania kluczami do generowania kluczy szyfrowania danych. KMS daje znacznie wiÄ™kszÄ… elastycznoÅ›Ä‡ w zarzÄ…dzaniu kluczami. Na przykÅ‚ad, moÅ¼esz dezaktywowaÄ‡, rotowaÄ‡ i stosowaÄ‡ kontrole dostÄ™pu do CMK oraz monitorowaÄ‡ ich uÅ¼ycie za pomocÄ… AWS Cloud Trail.

* Szyfrowanie:
* S3 Å¼Ä…da kluczy danych od KMS CMK
* KMS uÅ¼ywa CMK do generowania pary DEK jawnego i DEK szyfrowanego i wysyÅ‚a je do S3
* S3 uÅ¼ywa jawnego klucza do szyfrowania danych, przechowuje szyfrowane dane i szyfrowany klucz oraz usuwa z pamiÄ™ci klucz jawny
* Deszyfrowanie:
* S3 prosi KMS o deszyfrowanie szyfrowanego klucza danych obiektu
* KMS deszyfruje klucz danych za pomocÄ… CMK i wysyÅ‚a go z powrotem do S3
* S3 deszyfruje dane obiektu

</details>

<details>

<summary><strong>Szyfrowanie po stronie serwera z kluczami dostarczonymi przez klienta, SSE-C</strong></summary>

Ta opcja daje Ci moÅ¼liwoÅ›Ä‡ dostarczenia wÅ‚asnego klucza gÅ‚Ã³wnego, ktÃ³rego moÅ¼esz juÅ¼ uÅ¼ywaÄ‡ poza AWS. TwÃ³j klucz dostarczony przez klienta zostanie nastÄ™pnie wysÅ‚any z danymi do S3, gdzie S3 wykona szyfrowanie za Ciebie.

* Szyfrowanie:
* UÅ¼ytkownik wysyÅ‚a dane obiektu + Klucz Klienta do S3
* Klucz klienta jest uÅ¼ywany do szyfrowania danych, a szyfrowane dane sÄ… przechowywane
* przechowywana jest rÃ³wnieÅ¼ wartoÅ›Ä‡ HMAC z solÄ… klucza klienta dla przyszÅ‚ej walidacji klucza
* klucz klienta jest usuwany z pamiÄ™ci
* Deszyfrowanie:
* UÅ¼ytkownik wysyÅ‚a klucz klienta
* Klucz jest weryfikowany w stosunku do przechowywanej wartoÅ›ci HMAC
* Klucz dostarczony przez klienta jest nastÄ™pnie uÅ¼ywany do deszyfrowania danych

</details>

<details>

<summary><strong>Szyfrowanie po stronie klienta z KMS, CSE-KMS</strong></summary>

Podobnie jak w przypadku SSE-KMS, ta metoda rÃ³wnieÅ¼ wykorzystuje usÅ‚ugÄ™ zarzÄ…dzania kluczami do generowania kluczy szyfrowania danych. Jednak tym razem KMS jest wywoÅ‚ywane przez klienta, a nie przez S3. Szyfrowanie odbywa siÄ™ po stronie klienta, a szyfrowane dane sÄ… nastÄ™pnie wysyÅ‚ane do S3 w celu przechowywania.

* Szyfrowanie:
* Klient Å¼Ä…da klucza danych od KMS
* KMS zwraca jawny DEK i szyfrowany DEK z CMK
* Oba klucze sÄ… wysyÅ‚ane z powrotem
* Klient nastÄ™pnie szyfruje dane za pomocÄ… jawnego DEK i wysyÅ‚a do S3 szyfrowane dane + szyfrowany DEK (ktÃ³ry jest zapisywany jako metadane szyfrowanych danych w S3)
* Deszyfrowanie:
* Szyfrowane dane z szyfrowanym DEK sÄ… wysyÅ‚ane do klienta
* Klient prosi KMS o deszyfrowanie szyfrowanego klucza za pomocÄ… CMK, a KMS wysyÅ‚a z powrotem jawny DEK
* Klient moÅ¼e teraz deszyfrowaÄ‡ szyfrowane dane

</details>

<details>

<summary><strong>Szyfrowanie po stronie klienta z kluczami dostarczonymi przez klienta, CSE-C</strong></summary>

KorzystajÄ…c z tego mechanizmu, moÅ¼esz wykorzystaÄ‡ wÅ‚asne dostarczone klucze i uÅ¼yÄ‡ klienta AWS-SDK do szyfrowania danych przed wysÅ‚aniem ich do S3 w celu przechowywania.

* Szyfrowanie:
* Klient generuje DEK i szyfruje dane jawne
* NastÄ™pnie, uÅ¼ywajÄ…c wÅ‚asnego niestandardowego CMK, szyfruje DEK
* przesyÅ‚a szyfrowane dane + szyfrowany DEK do S3, gdzie sÄ… przechowywane
* Deszyfrowanie:
* S3 wysyÅ‚a szyfrowane dane i DEK
* PoniewaÅ¼ klient juÅ¼ ma CMK uÅ¼yty do szyfrowania DEK, deszyfruje DEK, a nastÄ™pnie uÅ¼ywa jawnego DEK do deszyfrowania danych

</details>

### **Enumeracja**

Jednym z tradycyjnych gÅ‚Ã³wnych sposobÃ³w kompromitacji organizacji AWS jest kompromitacja koszykÃ³w publicznie dostÄ™pnych. **MoÅ¼esz znaleÅºÄ‡** [**enumeratory publicznych koszykÃ³w na tej stronie**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# list objects version history
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>

# get a specific version for a object
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name â€“-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Ownerâ€™s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

MoÅ¼esz uzyskaÄ‡ dostÄ™p do koszyka S3 za pomocÄ… punktu koÅ„cowego dual-stack, uÅ¼ywajÄ…c nazwy punktu koÅ„cowego w stylu hosta wirtualnego lub w stylu Å›cieÅ¼ki. SÄ… one przydatne do uzyskiwania dostÄ™pu do S3 przez IPv6.

Punkty koÅ„cowe dual-stack uÅ¼ywajÄ… nastÄ™pujÄ…cej skÅ‚adni:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Na nastÄ™pnej stronie moÅ¼esz sprawdziÄ‡, jak **naduÅ¼ywaÄ‡ uprawnieÅ„ S3, aby eskalowaÄ‡ uprawnienia**:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Unauthenticated Access

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Other S3 vulns

### S3 HTTP Cache Poisoning Issue <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**Zgodnie z tym badaniem**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) moÅ¼liwe byÅ‚o buforowanie odpowiedzi z dowolnego koszyka, jakby naleÅ¼aÅ‚a do innego. MogÅ‚o to byÄ‡ naduÅ¼ywane do zmiany na przykÅ‚ad odpowiedzi plikÃ³w javascript i kompromitacji dowolnych stron korzystajÄ…cych z S3 do przechowywania statycznego kodu.

## Amazon Athena

Amazon Athena to interaktywny serwis zapytaÅ„, ktÃ³ry uÅ‚atwia **analizowanie danych** bezpoÅ›rednio w Amazon Simple Storage Service (Amazon **S3**) **przy uÅ¼yciu** standardowego **SQL**.

Musisz **przygotowaÄ‡ tabelÄ™ DB relacyjnÄ…** w formacie treÅ›ci, ktÃ³ra ma siÄ™ pojawiÄ‡ w monitorowanych koszykach S3. A nastÄ™pnie Amazon Athena bÄ™dzie mogÅ‚a zapeÅ‚niÄ‡ DB z logÃ³w, abyÅ› mÃ³gÅ‚ je zapytaÄ‡.

Amazon Athena obsÅ‚uguje **moÅ¼liwoÅ›Ä‡ zapytania danych S3, ktÃ³re sÄ… juÅ¼ zaszyfrowane**, a jeÅ›li jest to skonfigurowane, **Athena moÅ¼e rÃ³wnieÅ¼ zaszyfrowaÄ‡ wyniki zapytania, ktÃ³re mogÄ… byÄ‡ nastÄ™pnie przechowywane w S3**.

**To szyfrowanie wynikÃ³w jest niezaleÅ¼ne od podstawowych danych S3**, co oznacza, Å¼e nawet jeÅ›li dane S3 nie sÄ… zaszyfrowane, wyniki zapytania mogÄ… byÄ‡ zaszyfrowane. Kilka punktÃ³w, o ktÃ³rych warto pamiÄ™taÄ‡, to to, Å¼e Amazon Athena obsÅ‚uguje tylko dane, ktÃ³re zostaÅ‚y **zaszyfrowane** za pomocÄ… **nastÄ™pujÄ…cych metod szyfrowania S3**, **SSE-S3, SSE-KMS i CSE-KMS**.

SSE-C i CSE-E nie sÄ… obsÅ‚ugiwane. OprÃ³cz tego waÅ¼ne jest, aby zrozumieÄ‡, Å¼e Amazon Athena bÄ™dzie wykonywaÄ‡ zapytania tylko przeciwko **zaszyfrowanym obiektom, ktÃ³re znajdujÄ… siÄ™ w tym samym regionie co samo zapytanie**. JeÅ›li musisz zapytaÄ‡ dane S3, ktÃ³re zostaÅ‚y zaszyfrowane przy uÅ¼yciu KMS, to wymagane sÄ… konkretne uprawnienia dla uÅ¼ytkownika Athena, aby umoÅ¼liwiÄ‡ mu wykonanie zapytania.

### Enumeration
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## References

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
