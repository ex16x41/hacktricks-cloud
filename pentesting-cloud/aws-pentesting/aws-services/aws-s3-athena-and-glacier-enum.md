# AWS - S3, Athena & Glacier Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## S3

Amazon S3 est un service qui vous permet de **stocker de grandes quantit√©s de donn√©es**.

Amazon S3 fournit plusieurs options pour atteindre la **protection** des donn√©es au repos. Les options incluent **Permission** (Politique), **Encryption** (C√¥t√© Client et C√¥t√© Serveur), **Bucket Versioning** et **MFA** **bas√© sur la suppression**. L'**utilisateur peut activer** l'une de ces options pour atteindre la protection des donn√©es. La **r√©plication des donn√©es** est une fonctionnalit√© interne d'AWS o√π **S3 r√©plique automatiquement chaque objet √† travers toutes les zones de disponibilit√©** et l'organisation n'a pas besoin de l'activer dans ce cas.

Avec des permissions bas√©es sur les ressources, vous pouvez d√©finir des permissions pour les sous-r√©pertoires de votre bucket s√©par√©ment.

### Bucket Versioning et suppression bas√©e sur MFA

Lorsque la versionnage de bucket est activ√©, toute action qui tente de modifier un fichier √† l'int√©rieur d'un fichier g√©n√©rera une nouvelle version du fichier, conservant √©galement le contenu pr√©c√©dent de celui-ci. Par cons√©quent, cela ne remplacera pas son contenu.

De plus, la suppression bas√©e sur MFA emp√™chera les versions de fichiers dans le bucket S3 d'√™tre supprim√©es et √©galement le versionnage de bucket d'√™tre d√©sactiv√©, donc un attaquant ne pourra pas modifier ces fichiers.

Cependant, un risque potentiel se pr√©sente si les d√©veloppeurs laissent des informations sensibles telles que des cl√©s API, des identifiants ou d'anciens points de terminaison API dans les versions pr√©c√©dentes des fichiers. Les attaquants ou les utilisateurs non autoris√©s qui acc√®dent √† ces anciennes versions pourraient exploiter ces informations si les permissions sur le bucket ou les objets ne sont pas correctement s√©curis√©es.

Pour v√©rifier si un bucket active le versionnage, vous pouvez utiliser cette commande :
```bash
aws s3api get-bucket-versioning --bucket <bucket_name>
```
Une sortie possible ressemble √† :
```json
{
"Status": "Enabled"
}
```
**Remarque : Vous devez √™tre le propri√©taire du bucket pour r√©cup√©rer l'√©tat de versionnage du bucket.**

Pour voir toutes les versions des objets, essayez :

> Pour utiliser cette op√©ration, vous devez avoir la permission d'effectuer l'action s3:ListBucketVersions. Soyez conscient de la diff√©rence de nom.
```bash
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>
# redirect output into a file
aws --no-sign-request s3api list-object-versions --bucket <bucket_name> > versions.json
```
Pour obtenir une version sp√©cifique d'un objet, essayez :
```bash
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>
```
### S3 Access logs

Il est possible d'**activer les journaux d'acc√®s S3** (qui sont d√©sactiv√©s par d√©faut) pour un certain bucket et de sauvegarder les journaux dans un autre bucket afin de savoir qui acc√®de au bucket (les deux buckets doivent √™tre dans la m√™me r√©gion).

### S3 Presigned URLs

Il est possible de g√©n√©rer une URL pr√©-sign√©e qui peut g√©n√©ralement √™tre utilis√©e pour **acc√©der au fichier sp√©cifi√©** dans le bucket. Une **URL pr√©-sign√©e ressemble √† ceci** :
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
Une URL pr√©-sign√©e peut √™tre **cr√©√©e depuis le cli en utilisant les identifiants d'un principal ayant acc√®s √† l'objet** (si le compte que vous utilisez n'a pas acc√®s, une URL pr√©-sign√©e plus courte sera cr√©√©e mais elle sera inutile)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
La seule autorisation requise pour g√©n√©rer une URL pr√©-sign√©e est l'autorisation accord√©e, donc pour la commande pr√©c√©dente, la seule autorisation n√©cessaire pour le principal est `s3:GetObject`
{% endhint %}

Il est √©galement possible de cr√©er des URL pr√©-sign√©es avec **d'autres autorisations** :
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### M√©canismes de chiffrement S3

**DEK signifie Data Encryption Key** et est la cl√© qui est toujours g√©n√©r√©e et utilis√©e pour chiffrer les donn√©es.

<details>

<summary><strong>Chiffrement c√¥t√© serveur avec des cl√©s g√©r√©es par S3, SSE-S3</strong></summary>

Cette option n√©cessite une configuration minimale et toute la gestion des cl√©s de chiffrement utilis√©es est g√©r√©e par AWS. Tout ce que vous avez √† faire est de **t√©l√©charger vos donn√©es et S3 s'occupera de tous les autres aspects**. Chaque bucket dans un compte S3 se voit attribuer une cl√© de bucket.

* Chiffrement :
* Donn√©es d'objet + DEK en clair cr√©√© --> Donn√©es chiffr√©es (stock√©es dans S3)
* DEK en clair cr√©√© + Cl√© ma√Ætre S3 --> DEK chiffr√© (stock√© dans S3) et le texte en clair est supprim√© de la m√©moire
* D√©chiffrement :
* DEK chiffr√© + Cl√© ma√Ætre S3 --> DEK en clair
* DEK en clair + Donn√©es chiffr√©es --> Donn√©es d'objet

Veuillez noter que dans ce cas **la cl√© est g√©r√©e par AWS** (rotation uniquement tous les 3 ans). Si vous utilisez votre propre cl√©, vous pourrez faire pivoter, d√©sactiver et appliquer un contr√¥le d'acc√®s.

</details>

<details>

<summary><strong>Chiffrement c√¥t√© serveur avec des cl√©s g√©r√©es par KMS, SSE-KMS</strong></summary>

Cette m√©thode permet √† S3 d'utiliser le service de gestion des cl√©s pour g√©n√©rer vos cl√©s de chiffrement de donn√©es. KMS vous offre une bien plus grande flexibilit√© sur la gestion de vos cl√©s. Par exemple, vous pouvez d√©sactiver, faire pivoter et appliquer des contr√¥les d'acc√®s au CMK, et ordonner leur utilisation √† l'aide d'AWS Cloud Trail.

* Chiffrement :
* S3 demande des cl√©s de donn√©es √† KMS CMK
* KMS utilise un CMK pour g√©n√©rer la paire DEK en clair et DEK chiffr√© et les envoie √† S3
* S3 utilise la cl√© en clair pour chiffrer les donn√©es, stocke les donn√©es chiffr√©es et la cl√© chiffr√©e et supprime de la m√©moire la cl√© en clair
* D√©chiffrement :
* S3 demande √† KMS de d√©chiffrer la cl√© de donn√©es chiffr√©e de l'objet
* KMS d√©chiffre la cl√© de donn√©es avec le CMK et la renvoie √† S3
* S3 d√©chiffre les donn√©es de l'objet

</details>

<details>

<summary><strong>Chiffrement c√¥t√© serveur avec des cl√©s fournies par le client, SSE-C</strong></summary>

Cette option vous donne l'opportunit√© de fournir votre propre cl√© ma√Ætre que vous utilisez peut-√™tre d√©j√† en dehors d'AWS. Votre cl√© fournie par le client serait alors envoy√©e avec vos donn√©es √† S3, o√π S3 effectuerait ensuite le chiffrement pour vous.

* Chiffrement :
* L'utilisateur envoie les donn√©es de l'objet + Cl√© client √† S3
* La cl√© client est utilis√©e pour chiffrer les donn√©es et les donn√©es chiffr√©es sont stock√©es
* une valeur HMAC sal√©e de la cl√© client est √©galement stock√©e pour la validation future de la cl√©
* la cl√© client est supprim√©e de la m√©moire
* D√©chiffrement :
* L'utilisateur envoie la cl√© client
* La cl√© est valid√©e par rapport √† la valeur HMAC stock√©e
* La cl√© fournie par le client est ensuite utilis√©e pour d√©chiffrer les donn√©es

</details>

<details>

<summary><strong>Chiffrement c√¥t√© client avec KMS, CSE-KMS</strong></summary>

De mani√®re similaire √† SSE-KMS, cela utilise √©galement le service de gestion des cl√©s pour g√©n√©rer vos cl√©s de chiffrement de donn√©es. Cependant, cette fois KMS est appel√© via le client et non S3. Le chiffrement a alors lieu c√¥t√© client et les donn√©es chiffr√©es sont ensuite envoy√©es √† S3 pour √™tre stock√©es.

* Chiffrement :
* Le client demande une cl√© de donn√©es √† KMS
* KMS renvoie le DEK en clair et le DEK chiffr√© avec le CMK
* Les deux cl√©s sont renvoy√©es
* Le client chiffre ensuite les donn√©es avec le DEK en clair et envoie √† S3 les donn√©es chiffr√©es + le DEK chiffr√© (qui est enregistr√© comme m√©tadonn√©es des donn√©es chiffr√©es dans S3)
* D√©chiffrement :
* Les donn√©es chiffr√©es avec le DEK chiffr√© sont envoy√©es au client
* Le client demande √† KMS de d√©chiffrer la cl√© chiffr√©e en utilisant le CMK et KMS renvoie le DEK en clair
* Le client peut maintenant d√©chiffrer les donn√©es chiffr√©es

</details>

<details>

<summary><strong>Chiffrement c√¥t√© client avec des cl√©s fournies par le client, CSE-C</strong></summary>

En utilisant ce m√©canisme, vous pouvez utiliser vos propres cl√©s fournies et utiliser un client AWS-SDK pour chiffrer vos donn√©es avant de les envoyer √† S3 pour stockage.

* Chiffrement :
* Le client g√©n√®re un DEK et chiffre les donn√©es en clair
* Ensuite, en utilisant son propre CMK personnalis√©, il chiffre le DEK
* soumet les donn√©es chiffr√©es + DEK chiffr√© √† S3 o√π elles sont stock√©es
* D√©chiffrement :
* S3 envoie les donn√©es chiffr√©es et le DEK
* Comme le client a d√©j√† le CMK utilis√© pour chiffrer le DEK, il d√©chiffre le DEK et utilise ensuite le DEK en clair pour d√©chiffrer les donn√©es

</details>

### **√ânum√©ration**

L'un des principaux moyens traditionnels de compromettre les organisations AWS commence par compromettre les buckets accessibles publiquement. **Vous pouvez trouver** [**des √©num√©rateurs de buckets publics sur cette page**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# list objects version history
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>

# get a specific version for a object
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name ‚Äì-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner‚Äôs displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Vous pouvez acc√©der √† un bucket S3 via un point de terminaison dual-stack en utilisant un nom de point de terminaison de style h√©berg√© virtuel ou de style chemin. Ceux-ci sont utiles pour acc√©der √† S3 via IPv6.

Les points de terminaison dual-stack utilisent la syntaxe suivante :

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Dans la page suivante, vous pouvez v√©rifier comment **abuser des permissions S3 pour escalader les privil√®ges** :

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Acc√®s non authentifi√©

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Persistance

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Autres vuln√©rabilit√©s S3

### Probl√®me de Poisoning du Cache HTTP S3 <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**Selon cette recherche**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue), il √©tait possible de mettre en cache la r√©ponse d'un bucket arbitraire comme si elle appartenait √† un autre. Cela aurait pu √™tre abus√© pour changer, par exemple, les r√©ponses des fichiers javascript et compromettre des pages arbitraires utilisant S3 pour stocker du code statique.

## Amazon Athena

Amazon Athena est un service de requ√™te interactif qui facilite **l'analyse des donn√©es** directement dans Amazon Simple Storage Service (Amazon **S3**) **en utilisant** le **SQL** standard.

Vous devez **pr√©parer une table de base de donn√©es relationnelle** avec le format du contenu qui va appara√Ætre dans les buckets S3 surveill√©s. Ensuite, Amazon Athena pourra peupler la base de donn√©es √† partir des journaux, afin que vous puissiez l'interroger.

Amazon Athena prend en charge la **possibilit√© d'interroger des donn√©es S3 qui sont d√©j√† chiffr√©es** et si configur√© pour le faire, **Athena peut √©galement chiffrer les r√©sultats de la requ√™te qui peuvent ensuite √™tre stock√©s dans S3**.

**Ce chiffrement des r√©sultats est ind√©pendant des donn√©es S3 sous-jacentes interrog√©es**, ce qui signifie que m√™me si les donn√©es S3 ne sont pas chiffr√©es, les r√©sultats interrog√©s peuvent √™tre chiffr√©s. Quelques points √† garder √† l'esprit sont qu'Amazon Athena ne prend en charge que les donn√©es qui ont √©t√© **chiffr√©es** avec les **m√©thodes de chiffrement S3 suivantes**, **SSE-S3, SSE-KMS et CSE-KMS**.

SSE-C et CSE-E ne sont pas pris en charge. En outre, il est important de comprendre qu'Amazon Athena n'ex√©cutera des requ√™tes que sur **des objets chiffr√©s qui se trouvent dans la m√™me r√©gion que la requ√™te elle-m√™me**. Si vous devez interroger des donn√©es S3 qui ont √©t√© chiffr√©es √† l'aide de KMS, des permissions sp√©cifiques sont requises par l'utilisateur Athena pour leur permettre d'effectuer la requ√™te.

### √ânum√©ration
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## R√©f√©rences

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Formation Expert √âquipe Rouge AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Formation Expert √âquipe Rouge GCP (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
