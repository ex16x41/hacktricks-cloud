# AWS - S3, Athena & Glacier Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## S3

Amazon S3 is 'n diens wat jou toelaat om **groot hoeveelhede data** **op te slaan**.

Amazon S3 bied verskeie opsies om die **beskerming** van data in rus te bereik. Die opsies sluit **Toestemming** (Beleid), **Enkripsie** (Kli√´nt en Bediener-kant), **Emmerweergawe** en **MFA** **gebaseerde verwydering** in. Die **gebruiker kan enige van hierdie opsies aktiveer** om databesking te bereik. **Data-replikaasies** is 'n interne fasiliteit deur AWS waar **S3 outomaties elke objek oor al die Beschikbaarheidsone repliseer** en die organisasie hoef dit nie in hierdie geval te aktiveer nie.

Met hulpbron-gebaseerde toestemmings kan jy toestemmings vir sub-gidse van jou emmer apart definieer.

### Emmerweergawe en MFA-gebaseerde verwydering

Wanneer emmerweergawe geaktiveer is, sal enige aksie wat probeer om 'n l√™er binne 'n l√™er te verander 'n nuwe weergawe van die l√™er genereer, terwyl dit ook die vorige inhoud van dieselfde behou. Daarom sal dit nie sy inhoud oorskryf nie.

Boonop sal MFA-gebaseerde verwydering verhinder dat weergawes van l√™ers in die S3-emmer verwyder word en ook dat Emmerweergawe gedeaktiveer word, sodat 'n aanvaller nie in staat sal wees om hierdie l√™ers te verander nie.

Daar ontstaan egter 'n potensi√´le risiko as ontwikkelaars sensitiewe inligting soos API-sleutels, geloofsbriewe of ou API-eindpunte in die vorige weergawes van l√™ers agterlaat. Aanvallers of ongemagtigde gebruikers wat toegang tot hierdie ouer weergawes verkry, kan hierdie inligting benut as die toestemmings op die emmer of objekte nie behoorlik beveilig is nie.

Om te kontroleer of 'n emmer weergawe aktief is, kan jy hierdie opdrag gebruik:
```bash
aws s3api get-bucket-versioning --bucket <bucket_name>
```
'n Moglike uitvoer lyk soos:
```json
{
"Status": "Enabled"
}
```
**Let wel: Jy moet die emmer eienaar wees om die emmer weergawe status te verkry.**

Om al die voorwerpe se weergawes te sien, probeer:

> Om hierdie operasie te gebruik, moet jy toestemming h√™ om die s3:ListBucketVersions aksie uit te voer. Wees bewus van die naam verskil.
```bash
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>
# redirect output into a file
aws --no-sign-request s3api list-object-versions --bucket <bucket_name> > versions.json
```
Om 'n spesifieke weergawe van 'n objek te kry, probeer:
```bash
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>
```
### S3 Toegang logs

Dit is moontlik om **S3 toegang logs** (wat standaard gedeaktiveer is) vir 'n sekere emmer te aktiveer en die logs in 'n ander emmer te stoor om te weet wie die emmer benader (albei emmers moet in dieselfde streek wees).

### S3 Presigned URL's

Dit is moontlik om 'n presigned URL te genereer wat gewoonlik gebruik kan word om **die gespesifiseerde l√™er** in die emmer te **benader**. 'n **Presigned URL lyk soos volg**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
'n Voorafondertekende URL kan **uit die cli geskep word met die kredensiale van 'n hoofpersoon met toegang tot die objek** (as die rekening wat jy gebruik nie toegang het nie, sal 'n korter voorafondertekende URL geskep word, maar dit sal nutteloos wees)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
Die enigste vereiste toestemming om 'n presigned URL te genereer, is die toestemming wat gegee word, so vir die vorige opdrag is die enigste toestemming wat die hoofpersoon nodig het `s3:GetObject`
{% endhint %}

Dit is ook moontlik om presigned URLs te skep met **ander toestemmings**:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 Enkripsiemeganismes

**DEK beteken Data Enkripsiesleutel** en is die sleutel wat altyd gegenereer en gebruik word om data te enkripteer.

<details>

<summary><strong>Bediener-kant enkripsie met S3 bestuurde sleutels, SSE-S3</strong></summary>

Hierdie opsie vereis minimale konfigurasie en al die bestuur van enkripsiesleutels wat gebruik word, word deur AWS bestuur. Al wat jy hoef te doen is om jou data te **oplaai en S3 sal al die ander aspekte hanteer**. Elke emmer in 'n S3-rekening word aan 'n emmersleutel toegeken.

* Enkripsie:
* Objektdata + geskepte platte DEK --> Ge√´nkripteerde data (gestoor binne S3)
* Geskepte platte DEK + S3 Meestersleutel --> Ge√´nkripteerde DEK (gestoor binne S3) en platte teks word uit geheue verwyder
* Dekripsie:
* Ge√´nkripteerde DEK + S3 Meestersleutel --> Platte DEK
* Platte DEK + Ge√´nkripteerde data --> Objektdata

Neem asseblief kennis dat in hierdie geval **die sleutel deur AWS bestuur word** (rotasie slegs elke 3 jaar). As jy jou eie sleutel gebruik, sal jy in staat wees om te roteer, te deaktiveer en toegangbeheer toe te pas.

</details>

<details>

<summary><strong>Bediener-kant enkripsie met KMS bestuurde sleutels, SSE-KMS</strong></summary>

Hierdie metode laat S3 toe om die sleutelbestuursdiens te gebruik om jou data-enkripsiesleutels te genereer. KMS bied jou 'n baie groter buigsaamheid oor hoe jou sleutels bestuur word. Byvoorbeeld, jy kan die CMK deaktiveer, roteer en toegangbeheer toepas, en bestellings teen hul gebruik met AWS Cloud Trail.

* Enkripsie:
* S3 versoek data sleutels van KMS CMK
* KMS gebruik 'n CMK om die paar DEK platte teks en DEK ge√´nkripteerd te genereer en dit na S3 te stuur
* S3 gebruik die platte sleutel om die data te enkripteer, stoor die ge√´nkripteerde data en die ge√´nkripteerde sleutel en verwyder die platte teks sleutel uit geheue
* Dekripsie:
* S3 vra KMS om die ge√´nkripteerde datasleutel van die objek te dekripteer
* KMS dekripteer die datasleutel met die CMK en stuur dit terug na S3
* S3 dekripteer die objektdata

</details>

<details>

<summary><strong>Bediener-kant enkripsie met kli√´nt verskaf sleutels, SSE-C</strong></summary>

Hierdie opsie gee jou die geleentheid om jou eie meester sleutel te verskaf wat jy dalk reeds buite AWS gebruik. Jou kli√´nt-verskaf sleutel sal dan saam met jou data na S3 gestuur word, waar S3 dan die enkripsie vir jou sal uitvoer.

* Enkripsie:
* Die gebruiker stuur die objektdata + Kli√´ntsleutel na S3
* Die kli√´ntsleutel word gebruik om die data te enkripteer en die ge√´nkripteerde data word gestoor
* 'n Gesoute HMAC-waarde van die kli√´ntsleutel word ook gestoor vir toekomstige sleutelvalidasie
* die kli√´ntsleutel word uit geheue verwyder
* Dekripsie:
* Die gebruiker stuur die kli√´ntsleutel
* Die sleutel word gevalideer teen die gestoor HMAC-waarde
* Die kli√´nt verskaf sleutel word dan gebruik om die data te dekripteer

</details>

<details>

<summary><strong>Kli√´nt-kant enkripsie met KMS, CSE-KMS</strong></summary>

Soos met SSE-KMS, gebruik dit ook die sleutelbestuursdiens om jou data-enkripsiesleutels te genereer. Hierdie keer word KMS egter via die kli√´nt en nie S3 aangespreek nie. Die enkripsie vind dan kli√´nt-kant plaas en die ge√´nkripteerde data word dan na S3 gestuur om gestoor te word.

* Enkripsie:
* Kli√´nt versoek 'n datasleutel van KMS
* KMS stuur die platte DEK en die ge√´nkripteerde DEK met die CMK terug
* Beide sleutels word teruggestuur
* Die kli√´nt enkripteer dan die data met die platte DEK en stuur die ge√´nkripteerde data + die ge√´nkripteerde DEK (wat as metadata van die ge√´nkripteerde data binne S3 gestoor word) na S3
* Dekripsie:
* Die ge√´nkripteerde data met die ge√´nkripteerde DEK word na die kli√´nt gestuur
* Die kli√´nt vra KMS om die ge√´nkripteerde sleutel te dekripteer met die CMK en KMS stuur die platte DEK terug
* Die kli√´nt kan nou die ge√´nkripteerde data dekripteer

</details>

<details>

<summary><strong>Kli√´nt-kant enkripsie met kli√´nt verskaf sleutels, CSE-C</strong></summary>

Deur hierdie meganisme te gebruik, kan jy jou eie verskaf sleutels benut en 'n AWS-SDK kli√´nt gebruik om jou data te enkripteer voordat jy dit na S3 vir stoor stuur.

* Enkripsie:
* Die kli√´nt genereer 'n DEK en enkripteer die platte data
* Dan, met behulp van sy eie pasgemaakte CMK, enkripteer dit die DEK
* dien die ge√´nkripteerde data + ge√´nkripteerde DEK aan S3 waar dit gestoor word
* Dekripsie:
* S3 stuur die ge√´nkripteerde data en DEK
* Aangesien die kli√´nt reeds die CMK het wat gebruik is om die DEK te enkripteer, dekripteer dit die DEK en gebruik dan die platte DEK om die data te dekripteer

</details>

### **Enumerasie**

Een van die tradisionele hoofmaniere om AWS-organisasies te kompromitteer, begin deur emmers wat publiek toeganklik is, te kompromitteer. **Jy kan** [**publieke emmer enumerators op hierdie bladsy vind**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# list objects version history
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>

# get a specific version for a object
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name ‚Äì-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner‚Äôs displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Jy kan toegang tot 'n S3-bucket verkry deur 'n dual-stack eindpunt te gebruik deur 'n virtuele gehoste-styl of 'n pad-styl eindpuntnaam te gebruik. Hierdie is nuttig om S3 deur IPv6 te benader.

Dual-stack eindpunte gebruik die volgende sintaksis:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Op die volgende bladsy kan jy kyk hoe om **S3-toestemmings te misbruik om voorregte te verhoog**:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Unauthenticated Access

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Other S3 vulns

### S3 HTTP Cache Poisoning Issue <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**Volgens hierdie navorsing**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) was dit moontlik om die antwoord van 'n arbitr√™re bucket te kas asof dit aan 'n ander behoort. Dit kon misbruik gewees het om byvoorbeeld javascript-l√™er-antwoorde te verander en arbitr√™re bladsye te kompromitteer wat S3 gebruik om statiese kode te stoor.

## Amazon Athena

Amazon Athena is 'n interaktiewe navraagdiens wat dit maklik maak om **data** direk in Amazon Simple Storage Service (Amazon **S3**) **te analiseer** met behulp van standaard **SQL**.

Jy moet 'n **relationele DB-tabel voorberei** met die formaat van die inhoud wat in die gemonitorde S3-buckets gaan verskyn. En dan sal Amazon Athena in staat wees om die DB uit die logs te vul, sodat jy dit kan navraag doen.

Amazon Athena ondersteun die **vermo√´ om S3-data wat reeds versleuteld is, te navraag** en as dit geconfigureer is om dit te doen, **kan Athena ook die resultate van die navraag versleuteld wat dan in S3 gestoor kan word**.

**Hierdie versleuteling van resultate is onafhanklik van die onderliggende navraag S3-data**, wat beteken dat selfs al is die S3-data nie versleuteld nie, kan die navraagresultate versleuteld wees. 'n Paar punte om bewus van te wees is dat Amazon Athena slegs data ondersteun wat **versleuteld** is met die **volgende S3-versleutelingmetodes**, **SSE-S3, SSE-KMS, en CSE-KMS**.

SSE-C en CSE-E word nie ondersteun nie. Benewens dit, is dit belangrik om te verstaan dat Amazon Athena slegs navrae teen **versleutelde voorwerpe wat in dieselfde streek as die navraag self is** sal uitvoer. As jy S3-data moet navraag doen wat met KMS versleuteld is, dan is spesifieke toestemmings nodig deur die Athena-gebruiker om hulle in staat te stel om die navraag uit te voer.

### Enumeration
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## Verwysings

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
