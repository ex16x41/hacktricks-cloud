# AWS - S3, Athena & Glacier Enum

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## S3

Amazon S3 æ˜¯ä¸€ä¸ªå…è®¸æ‚¨ **å­˜å‚¨å¤§é‡æ•°æ®** çš„æœåŠ¡ã€‚

Amazon S3 æä¾›å¤šç§é€‰é¡¹æ¥å®ç°æ•°æ®åœ¨é™æ€æ—¶çš„ **ä¿æŠ¤**ã€‚è¿™äº›é€‰é¡¹åŒ…æ‹¬ **æƒé™**ï¼ˆç­–ç•¥ï¼‰ã€**åŠ å¯†**ï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ï¼‰ã€**å­˜å‚¨æ¡¶ç‰ˆæœ¬æ§åˆ¶** å’Œ **åŸºäº MFA çš„åˆ é™¤**ã€‚**ç”¨æˆ·å¯ä»¥å¯ç”¨** è¿™äº›é€‰é¡¹ä¸­çš„ä»»ä½•ä¸€ä¸ªæ¥å®ç°æ•°æ®ä¿æŠ¤ã€‚**æ•°æ®å¤åˆ¶** æ˜¯ AWS çš„ä¸€é¡¹å†…éƒ¨åŠŸèƒ½ï¼Œ**S3 ä¼šè‡ªåŠ¨åœ¨æ‰€æœ‰å¯ç”¨åŒºå¤åˆ¶æ¯ä¸ªå¯¹è±¡**ï¼Œç»„ç»‡åœ¨è¿™ç§æƒ…å†µä¸‹æ— éœ€å¯ç”¨å®ƒã€‚

é€šè¿‡åŸºäºèµ„æºçš„æƒé™ï¼Œæ‚¨å¯ä»¥å•ç‹¬ä¸ºå­˜å‚¨æ¡¶çš„å­ç›®å½•å®šä¹‰æƒé™ã€‚

### å­˜å‚¨æ¡¶ç‰ˆæœ¬æ§åˆ¶å’ŒåŸºäº MFA çš„åˆ é™¤

å½“å¯ç”¨å­˜å‚¨æ¡¶ç‰ˆæœ¬æ§åˆ¶æ—¶ï¼Œä»»ä½•è¯•å›¾æ›´æ”¹æ–‡ä»¶çš„æ“ä½œéƒ½ä¼šç”Ÿæˆè¯¥æ–‡ä»¶çš„æ–°ç‰ˆæœ¬ï¼ŒåŒæ—¶ä¿ç•™ç›¸åŒæ–‡ä»¶çš„å…ˆå‰å†…å®¹ã€‚å› æ­¤ï¼Œå®ƒä¸ä¼šè¦†ç›–å…¶å†…å®¹ã€‚

æ­¤å¤–ï¼ŒåŸºäº MFA çš„åˆ é™¤å°†é˜²æ­¢ S3 å­˜å‚¨æ¡¶ä¸­çš„æ–‡ä»¶ç‰ˆæœ¬è¢«åˆ é™¤ï¼Œä¹Ÿå°†é˜²æ­¢å­˜å‚¨æ¡¶ç‰ˆæœ¬æ§åˆ¶è¢«ç¦ç”¨ï¼Œå› æ­¤æ”»å‡»è€…å°†æ— æ³•æ›´æ”¹è¿™äº›æ–‡ä»¶ã€‚

ç„¶è€Œï¼Œå¦‚æœå¼€å‘äººå‘˜åœ¨æ–‡ä»¶çš„å…ˆå‰ç‰ˆæœ¬ä¸­ç•™ä¸‹æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚ API å¯†é’¥ã€å‡­è¯æˆ–æ—§çš„ API ç«¯ç‚¹ï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°æ½œåœ¨é£é™©ã€‚è·å¾—è¿™äº›æ—§ç‰ˆæœ¬è®¿é—®æƒé™çš„æ”»å‡»è€…æˆ–æœªç»æˆæƒçš„ç”¨æˆ·å¯èƒ½ä¼šåˆ©ç”¨è¿™äº›ä¿¡æ¯ï¼Œå¦‚æœå­˜å‚¨æ¡¶æˆ–å¯¹è±¡çš„æƒé™æ²¡æœ‰å¾—åˆ°å¦¥å–„ä¿æŠ¤ã€‚

è¦æ£€æŸ¥å­˜å‚¨æ¡¶æ˜¯å¦å¯ç”¨ç‰ˆæœ¬æ§åˆ¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash
aws s3api get-bucket-versioning --bucket <bucket_name>
```
ä¸€ä¸ªå¯èƒ½çš„è¾“å‡ºå¦‚ä¸‹ï¼š
```json
{
"Status": "Enabled"
}
```
**æ³¨æ„ï¼šæ‚¨å¿…é¡»æ˜¯å­˜å‚¨æ¡¶çš„æ‰€æœ‰è€…æ‰èƒ½æ£€ç´¢å­˜å‚¨æ¡¶ç‰ˆæœ¬çŠ¶æ€ã€‚**

è¦æŸ¥çœ‹æ‰€æœ‰å¯¹è±¡çš„ç‰ˆæœ¬ï¼Œè¯·å°è¯•ï¼š

> è¦ä½¿ç”¨æ­¤æ“ä½œï¼Œæ‚¨å¿…é¡»æœ‰æƒé™æ‰§è¡Œ s3:ListBucketVersions æ“ä½œã€‚è¯·æ³¨æ„åç§°çš„å·®å¼‚ã€‚
```bash
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>
# redirect output into a file
aws --no-sign-request s3api list-object-versions --bucket <bucket_name> > versions.json
```
è¦è·å–å¯¹è±¡çš„ç‰¹å®šç‰ˆæœ¬ï¼Œè¯·å°è¯•ï¼š
```bash
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>
```
### S3 è®¿é—®æ—¥å¿—

å¯ä»¥**å¯ç”¨ S3 è®¿é—®æ—¥å¿—**ï¼ˆé»˜è®¤æƒ…å†µä¸‹æ˜¯ç¦ç”¨çš„ï¼‰åˆ°æŸä¸ªæ¡¶ï¼Œå¹¶å°†æ—¥å¿—ä¿å­˜åœ¨å¦ä¸€ä¸ªæ¡¶ä¸­ï¼Œä»¥äº†è§£è°åœ¨è®¿é—®è¯¥æ¡¶ï¼ˆä¸¤ä¸ªæ¡¶å¿…é¡»åœ¨åŒä¸€åŒºåŸŸå†…ï¼‰ã€‚

### S3 é¢„ç­¾å URL

å¯ä»¥ç”Ÿæˆä¸€ä¸ªé¢„ç­¾å URLï¼Œé€šå¸¸å¯ä»¥ç”¨æ¥**è®¿é—®æ¡¶ä¸­çš„æŒ‡å®šæ–‡ä»¶**ã€‚**é¢„ç­¾å URL çœ‹èµ·æ¥åƒè¿™æ ·**ï¼š
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
ä¸€ä¸ªé¢„ç­¾åçš„ URL å¯ä»¥**ä½¿ç”¨å…·æœ‰è®¿é—®å¯¹è±¡æƒé™çš„ä¸»ä½“çš„å‡­è¯ä» cli åˆ›å»º**ï¼ˆå¦‚æœæ‚¨ä½¿ç”¨çš„å¸æˆ·æ²¡æœ‰è®¿é—®æƒé™ï¼Œå°†åˆ›å»ºä¸€ä¸ªè¾ƒçŸ­çš„é¢„ç­¾å URLï¼Œä½†å®ƒå°†æ— ç”¨ï¼‰
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
ç”Ÿæˆé¢„ç­¾å URL å”¯ä¸€éœ€è¦çš„æƒé™æ˜¯æ‰€ç»™äºˆçš„æƒé™ï¼Œå› æ­¤å¯¹äºä¹‹å‰çš„å‘½ä»¤ï¼Œä¸»ä½“æ‰€éœ€çš„å”¯ä¸€æƒé™æ˜¯ `s3:GetObject`
{% endhint %}

è¿˜å¯ä»¥ä½¿ç”¨ **å…¶ä»–æƒé™** åˆ›å»ºé¢„ç­¾å URLï¼š
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 åŠ å¯†æœºåˆ¶

**DEK ä»£è¡¨æ•°æ®åŠ å¯†å¯†é’¥**ï¼Œæ˜¯å§‹ç»ˆç”Ÿæˆå¹¶ç”¨äºåŠ å¯†æ•°æ®çš„å¯†é’¥ã€‚

<details>

<summary><strong>ä½¿ç”¨ S3 ç®¡ç†å¯†é’¥çš„æœåŠ¡å™¨ç«¯åŠ å¯†ï¼ŒSSE-S3</strong></summary>

æ­¤é€‰é¡¹éœ€è¦æœ€å°‘çš„é…ç½®ï¼Œæ‰€æœ‰ä½¿ç”¨çš„åŠ å¯†å¯†é’¥ç®¡ç†å‡ç”± AWS ç®¡ç†ã€‚æ‚¨åªéœ€ **ä¸Šä¼ æ‚¨çš„æ•°æ®ï¼ŒS3 å°†å¤„ç†æ‰€æœ‰å…¶ä»–æ–¹é¢**ã€‚æ¯ä¸ª S3 è´¦æˆ·ä¸­çš„å­˜å‚¨æ¡¶éƒ½åˆ†é…ä¸€ä¸ªå­˜å‚¨æ¡¶å¯†é’¥ã€‚

* åŠ å¯†ï¼š
* å¯¹è±¡æ•°æ® + åˆ›å»ºçš„æ˜æ–‡ DEK --> åŠ å¯†æ•°æ®ï¼ˆå­˜å‚¨åœ¨ S3 ä¸­ï¼‰
* åˆ›å»ºçš„æ˜æ–‡ DEK + S3 ä¸»å¯†é’¥ --> åŠ å¯† DEKï¼ˆå­˜å‚¨åœ¨ S3 ä¸­ï¼‰ï¼Œæ˜æ–‡ä»å†…å­˜ä¸­åˆ é™¤
* è§£å¯†ï¼š
* åŠ å¯† DEK + S3 ä¸»å¯†é’¥ --> æ˜æ–‡ DEK
* æ˜æ–‡ DEK + åŠ å¯†æ•°æ® --> å¯¹è±¡æ•°æ®

è¯·æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ **å¯†é’¥ç”± AWS ç®¡ç†**ï¼ˆæ¯ 3 å¹´è½®æ¢ä¸€æ¬¡ï¼‰ã€‚å¦‚æœæ‚¨ä½¿ç”¨è‡ªå·±çš„å¯†é’¥ï¼Œæ‚¨å°†èƒ½å¤Ÿè½®æ¢ã€ç¦ç”¨å¹¶åº”ç”¨è®¿é—®æ§åˆ¶ã€‚

</details>

<details>

<summary><strong>ä½¿ç”¨ KMS ç®¡ç†å¯†é’¥çš„æœåŠ¡å™¨ç«¯åŠ å¯†ï¼ŒSSE-KMS</strong></summary>

æ­¤æ–¹æ³•å…è®¸ S3 ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ç”Ÿæˆæ‚¨çš„æ•°æ®åŠ å¯†å¯†é’¥ã€‚KMS ä¸ºæ‚¨æä¾›äº†æ›´å¤§çš„å¯†é’¥ç®¡ç†çµæ´»æ€§ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ç¦ç”¨ã€è½®æ¢å¹¶å¯¹ CMK åº”ç”¨è®¿é—®æ§åˆ¶ï¼Œå¹¶ä½¿ç”¨ AWS Cloud Trail ç›‘æ§å…¶ä½¿ç”¨æƒ…å†µã€‚

* åŠ å¯†ï¼š
* S3 å‘ KMS CMK è¯·æ±‚æ•°æ®å¯†é’¥
* KMS ä½¿ç”¨ CMK ç”Ÿæˆæ˜æ–‡ DEK å’ŒåŠ å¯† DEK å¯¹ï¼Œå¹¶å°†å…¶å‘é€åˆ° S3
* S3 ä½¿ç”¨æ˜æ–‡å¯†é’¥åŠ å¯†æ•°æ®ï¼Œå­˜å‚¨åŠ å¯†æ•°æ®å’ŒåŠ å¯†å¯†é’¥ï¼Œå¹¶ä»å†…å­˜ä¸­åˆ é™¤æ˜æ–‡å¯†é’¥
* è§£å¯†ï¼š
* S3 è¯·æ±‚ KMS è§£å¯†å¯¹è±¡çš„åŠ å¯†æ•°æ®å¯†é’¥
* KMS ä½¿ç”¨ CMK è§£å¯†æ•°æ®å¯†é’¥å¹¶å°†å…¶å‘é€å› S3
* S3 è§£å¯†å¯¹è±¡æ•°æ®

</details>

<details>

<summary><strong>ä½¿ç”¨å®¢æˆ·æä¾›å¯†é’¥çš„æœåŠ¡å™¨ç«¯åŠ å¯†ï¼ŒSSE-C</strong></summary>

æ­¤é€‰é¡¹ä½¿æ‚¨èƒ½å¤Ÿæä¾›æ‚¨å¯èƒ½å·²ç»åœ¨ AWS ä¹‹å¤–ä½¿ç”¨çš„ä¸»å¯†é’¥ã€‚æ‚¨çš„å®¢æˆ·æä¾›çš„å¯†é’¥å°†ä¸æ‚¨çš„æ•°æ®ä¸€èµ·å‘é€åˆ° S3ï¼ŒS3 å°†ä¸ºæ‚¨æ‰§è¡ŒåŠ å¯†ã€‚

* åŠ å¯†ï¼š
* ç”¨æˆ·å°†å¯¹è±¡æ•°æ® + å®¢æˆ·å¯†é’¥å‘é€åˆ° S3
* å®¢æˆ·å¯†é’¥ç”¨äºåŠ å¯†æ•°æ®ï¼Œä¸”åŠ å¯†æ•°æ®è¢«å­˜å‚¨
* è¿˜å­˜å‚¨å®¢æˆ·å¯†é’¥çš„ç›å€¼ HMAC å€¼ä»¥ä¾›å°†æ¥å¯†é’¥éªŒè¯
* å®¢æˆ·å¯†é’¥ä»å†…å­˜ä¸­åˆ é™¤
* è§£å¯†ï¼š
* ç”¨æˆ·å‘é€å®¢æˆ·å¯†é’¥
* å¯†é’¥ä¸å­˜å‚¨çš„ HMAC å€¼è¿›è¡ŒéªŒè¯
* ç„¶åä½¿ç”¨å®¢æˆ·æä¾›çš„å¯†é’¥è§£å¯†æ•°æ®

</details>

<details>

<summary><strong>ä½¿ç”¨ KMS çš„å®¢æˆ·ç«¯åŠ å¯†ï¼ŒCSE-KMS</strong></summary>

ä¸ SSE-KMS ç±»ä¼¼ï¼Œè¿™ä¹Ÿä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ç”Ÿæˆæ‚¨çš„æ•°æ®åŠ å¯†å¯†é’¥ã€‚ç„¶è€Œï¼Œè¿™æ¬¡æ˜¯é€šè¿‡å®¢æˆ·ç«¯è€Œä¸æ˜¯ S3 è°ƒç”¨ KMSã€‚åŠ å¯†åœ¨å®¢æˆ·ç«¯è¿›è¡Œï¼Œéšåå°†åŠ å¯†æ•°æ®å‘é€åˆ° S3 è¿›è¡Œå­˜å‚¨ã€‚

* åŠ å¯†ï¼š
* å®¢æˆ·ç«¯è¯·æ±‚ KMS çš„æ•°æ®å¯†é’¥
* KMS è¿”å›æ˜æ–‡ DEK å’Œä¸ CMK çš„åŠ å¯† DEK
* ä¸¤ä¸ªå¯†é’¥éƒ½è¢«å‘é€å›
* å®¢æˆ·ç«¯ä½¿ç”¨æ˜æ–‡ DEK åŠ å¯†æ•°æ®ï¼Œå¹¶å°†åŠ å¯†æ•°æ® + åŠ å¯† DEKï¼ˆä½œä¸ºåŠ å¯†æ•°æ®çš„å…ƒæ•°æ®å­˜å‚¨åœ¨ S3 ä¸­ï¼‰å‘é€åˆ° S3
* è§£å¯†ï¼š
* å¸¦æœ‰åŠ å¯† DEK çš„åŠ å¯†æ•°æ®å‘é€åˆ°å®¢æˆ·ç«¯
* å®¢æˆ·ç«¯è¯·æ±‚ KMS ä½¿ç”¨ CMK è§£å¯†åŠ å¯†å¯†é’¥ï¼ŒKMS è¿”å›æ˜æ–‡ DEK
* å®¢æˆ·ç«¯ç°åœ¨å¯ä»¥è§£å¯†åŠ å¯†æ•°æ®

</details>

<details>

<summary><strong>ä½¿ç”¨å®¢æˆ·æä¾›å¯†é’¥çš„å®¢æˆ·ç«¯åŠ å¯†ï¼ŒCSE-C</strong></summary>

ä½¿ç”¨æ­¤æœºåˆ¶ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨è‡ªå·±æä¾›çš„å¯†é’¥ï¼Œå¹¶ä½¿ç”¨ AWS-SDK å®¢æˆ·ç«¯åœ¨å°†æ•°æ®å‘é€åˆ° S3 å­˜å‚¨ä¹‹å‰å¯¹å…¶è¿›è¡ŒåŠ å¯†ã€‚

* åŠ å¯†ï¼š
* å®¢æˆ·ç«¯ç”Ÿæˆ DEK å¹¶åŠ å¯†æ˜æ–‡æ•°æ®
* ç„¶åï¼Œä½¿ç”¨å…¶è‡ªå®šä¹‰ CMK åŠ å¯† DEK
* æäº¤åŠ å¯†æ•°æ® + åŠ å¯† DEK åˆ° S3 è¿›è¡Œå­˜å‚¨
* è§£å¯†ï¼š
* S3 å‘é€åŠ å¯†æ•°æ®å’Œ DEK
* ç”±äºå®¢æˆ·ç«¯å·²ç»æ‹¥æœ‰ç”¨äºåŠ å¯† DEK çš„ CMKï¼Œå› æ­¤å®ƒè§£å¯† DEKï¼Œç„¶åä½¿ç”¨æ˜æ–‡ DEK è§£å¯†æ•°æ®

</details>

### **æšä¸¾**

å¦¥å AWS ç»„ç»‡çš„ä¼ ç»Ÿä¸»è¦æ–¹å¼ä¹‹ä¸€æ˜¯ä»å¦¥åå…¬å¼€å¯è®¿é—®çš„å­˜å‚¨æ¡¶å¼€å§‹ã€‚ **æ‚¨å¯ä»¥åœ¨æ­¤é¡µé¢æ‰¾åˆ°** [**å…¬å…±å­˜å‚¨æ¡¶æšä¸¾å·¥å…·**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# list objects version history
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>

# get a specific version for a object
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name â€“-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Ownerâ€™s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

æ‚¨å¯ä»¥é€šè¿‡åŒæ ˆç«¯ç‚¹ä½¿ç”¨è™šæ‹Ÿæ‰˜ç®¡æ ·å¼æˆ–è·¯å¾„æ ·å¼ç«¯ç‚¹åç§°è®¿é—® S3 å­˜å‚¨æ¡¶ã€‚è¿™äº›å¯¹äºé€šè¿‡ IPv6 è®¿é—® S3 å¾ˆæœ‰ç”¨ã€‚

åŒæ ˆç«¯ç‚¹ä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼š

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½• **æ»¥ç”¨ S3 æƒé™ä»¥æå‡æƒé™**ï¼š

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Unauthenticated Access

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Other S3 vulns

### S3 HTTP Cache Poisoning Issue <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**æ ¹æ®è¿™é¡¹ç ”ç©¶**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue)ï¼Œå¯ä»¥å°†ä»»æ„å­˜å‚¨æ¡¶çš„å“åº”ç¼“å­˜ä¸ºå±äºä¸åŒå­˜å‚¨æ¡¶çš„å“åº”ã€‚è¿™å¯èƒ½è¢«æ»¥ç”¨æ¥æ›´æ”¹ä¾‹å¦‚ JavaScript æ–‡ä»¶çš„å“åº”ï¼Œå¹¶åˆ©ç”¨ S3 å­˜å‚¨é™æ€ä»£ç æ¥å¦¥åä»»æ„é¡µé¢ã€‚

## Amazon Athena

Amazon Athena æ˜¯ä¸€ç§äº¤äº’å¼æŸ¥è¯¢æœåŠ¡ï¼Œä½¿æ‚¨èƒ½å¤Ÿç›´æ¥åœ¨ Amazon Simple Storage Service (Amazon **S3**) ä¸­ **åˆ†ææ•°æ®**ï¼Œ**ä½¿ç”¨** æ ‡å‡† **SQL**ã€‚

æ‚¨éœ€è¦ **å‡†å¤‡ä¸€ä¸ªå…³ç³»æ•°æ®åº“è¡¨**ï¼Œå…¶æ ¼å¼ä¸å°†å‡ºç°åœ¨ç›‘æ§çš„ S3 å­˜å‚¨æ¡¶ä¸­çš„å†…å®¹ç›¸ç¬¦ã€‚ç„¶åï¼ŒAmazon Athena å°†èƒ½å¤Ÿä»æ—¥å¿—ä¸­å¡«å……æ•°æ®åº“ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥æŸ¥è¯¢å®ƒã€‚

Amazon Athena æ”¯æŒ **æŸ¥è¯¢å·²ç»åŠ å¯†çš„ S3 æ•°æ®**ï¼Œå¦‚æœé…ç½®ä¸ºè¿™æ ·ï¼Œ**Athena è¿˜å¯ä»¥åŠ å¯†æŸ¥è¯¢ç»“æœï¼Œç„¶åå°†å…¶å­˜å‚¨åœ¨ S3 ä¸­**ã€‚

**ç»“æœçš„åŠ å¯†ä¸è¢«æŸ¥è¯¢çš„ S3 æ•°æ®æ˜¯ç‹¬ç«‹çš„**ï¼Œè¿™æ„å‘³ç€å³ä½¿ S3 æ•°æ®æœªåŠ å¯†ï¼Œè¢«æŸ¥è¯¢çš„ç»“æœä¹Ÿå¯ä»¥åŠ å¯†ã€‚éœ€è¦æ³¨æ„çš„å‡ ç‚¹æ˜¯ï¼ŒAmazon Athena ä»…æ”¯æŒä½¿ç”¨ **ä»¥ä¸‹ S3 åŠ å¯†æ–¹æ³•** **åŠ å¯†** çš„æ•°æ®ï¼Œ**SSE-S3ã€SSE-KMS å’Œ CSE-KMS**ã€‚

SSE-C å’Œ CSE-E ä¸å—æ”¯æŒã€‚æ­¤å¤–ï¼Œé‡è¦çš„æ˜¯è¦ç†è§£ï¼ŒAmazon Athena ä»…ä¼šå¯¹ **ä¸æŸ¥è¯¢æœ¬èº«åœ¨åŒä¸€åŒºåŸŸçš„åŠ å¯†å¯¹è±¡** è¿è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæ‚¨éœ€è¦æŸ¥è¯¢ä½¿ç”¨ KMS åŠ å¯†çš„ S3 æ•°æ®ï¼Œåˆ™ Athena ç”¨æˆ·éœ€è¦ç‰¹å®šæƒé™ä»¥ä½¿å…¶èƒ½å¤Ÿæ‰§è¡ŒæŸ¥è¯¢ã€‚

### Enumeration
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## å‚è€ƒæ–‡çŒ®

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
