# AWS - S3, Athena & Glacier Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** π’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** π¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## S3

Amazon S3λ” **λ€λ‰μ λ°μ΄ν„°λ¥Ό μ €μ¥ν•  μ μλ”** μ„λΉ„μ¤μ…λ‹λ‹¤.

Amazon S3λ” λ°μ΄ν„°κ°€ μ •μ§€ μƒνƒμΌ λ• **λ³΄νΈ**λ¥Ό λ‹¬μ„±ν•κΈ° μ„ν• μ—¬λ¬ μµμ…μ„ μ κ³µν•©λ‹λ‹¤. μµμ…μ—λ” **κ¶ν•**(μ •μ±…), **μ•”νΈν™”**(ν΄λΌμ΄μ–ΈνΈ λ° μ„λ²„ μΈ΅), **λ²„ν‚· λ²„μ „ κ΄€λ¦¬** λ° **MFA** **κΈ°λ° μ‚­μ **κ°€ ν¬ν•¨λ©λ‹λ‹¤. **μ‚¬μ©μλ”** λ°μ΄ν„° λ³΄νΈλ¥Ό λ‹¬μ„±ν•κΈ° μ„ν•΄ μ΄λ¬ν• μµμ… μ¤‘ ν•λ‚λ¥Ό ν™μ„±ν™”ν•  μ μμµλ‹λ‹¤. **λ°μ΄ν„° λ³µμ **λ” AWSμ λ‚΄λ¶€ κΈ°λ¥μΌλ΅, **S3κ°€ λ¨λ“  κ°€μ© μμ—­μ— κ±Έμ³ κ° κ°μ²΄λ¥Ό μλ™μΌλ΅ λ³µμ **ν•λ©°, μ΄ κ²½μ° μ΅°μ§μ—μ„ μ΄λ¥Ό ν™μ„±ν™”ν•  ν•„μ”κ°€ μ—†μµλ‹λ‹¤.

λ¦¬μ†μ¤ κΈ°λ° κ¶ν•μ„ μ‚¬μ©ν•λ©΄ λ²„ν‚·μ ν•μ„ λ””λ ‰ν† λ¦¬μ— λ€ν• κ¶ν•μ„ λ³„λ„λ΅ μ •μν•  μ μμµλ‹λ‹¤.

### λ²„ν‚· λ²„μ „ κ΄€λ¦¬ λ° MFA κΈ°λ° μ‚­μ 

λ²„ν‚· λ²„μ „ κ΄€λ¦¬κ°€ ν™μ„±ν™”λλ©΄, νμΌ λ‚΄μ νμΌμ„ λ³€κ²½ν•λ ¤λ” λ¨λ“  μ‘μ—…μ€ νμΌμ μƒ λ²„μ „μ„ μƒμ„±ν•λ©°, μ΄μ „ λ‚΄μ©λ„ μ μ§€λ©λ‹λ‹¤. λ”°λΌμ„ λ‚΄μ©μ΄ λ®μ–΄μ“°μ—¬μ§€μ§€ μ•μµλ‹λ‹¤.

λν•, MFA κΈ°λ° μ‚­μ λ” S3 λ²„ν‚·μ νμΌ λ²„μ „μ΄ μ‚­μ λλ” κ²ƒμ„ λ°©μ§€ν•κ³  λ²„ν‚· λ²„μ „ κ΄€λ¦¬κ°€ λΉ„ν™μ„±ν™”λλ” κ²ƒμ„ λ°©μ§€ν•λ―€λ΅ κ³µκ²©μκ°€ μ΄λ¬ν• νμΌμ„ λ³€κ²½ν•  μ μ—†μµλ‹λ‹¤.

κ·Έλ¬λ‚ κ°λ°μκ°€ API ν‚¤, μκ²© μ¦λ… λλ” μ΄μ „ API μ—”λ“ν¬μΈνΈμ™€ κ°™μ€ λ―Όκ°ν• μ •λ³΄λ¥Ό νμΌμ μ΄μ „ λ²„μ „μ— λ‚¨κ²¨λ‘λ©΄ μ μ¬μ μΈ μ„ν—μ΄ λ°μƒν•©λ‹λ‹¤. μ΄λ¬ν• μ΄μ „ λ²„μ „μ— μ ‘κ·Όν•  μ μλ” κ³µκ²©μλ‚ λ¬΄λ‹¨ μ‚¬μ©μλ” λ²„ν‚·μ΄λ‚ κ°μ²΄μ κ¶ν•μ΄ μ μ ν•κ² λ³΄νΈλμ§€ μ•λ” κ²½μ° μ΄ μ •λ³΄λ¥Ό μ•…μ©ν•  μ μμµλ‹λ‹¤.

λ²„ν‚·μ΄ λ²„μ „ κ΄€λ¦¬λ¥Ό ν™μ„±ν™”ν•λ”μ§€ ν™•μΈν•λ ¤λ©΄ λ‹¤μ λ…λ Ήμ„ μ‚¬μ©ν•  μ μμµλ‹λ‹¤:
```bash
aws s3api get-bucket-versioning --bucket <bucket_name>
```
κ°€λ¥ν• μ¶λ ¥μ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤:
```json
{
"Status": "Enabled"
}
```
**μ°Έκ³ : λ²„ν‚· λ²„μ „ μƒνƒλ¥Ό κ²€μƒ‰ν•λ ¤λ©΄ λ²„ν‚· μ†μ μμ—¬μ•Ό ν•©λ‹λ‹¤.**

λ¨λ“  κ°μ²΄μ λ²„μ „μ„ λ³΄λ ¤λ©΄ λ‹¤μμ„ μ‹λ„ν•μ„Έμ”:

> μ΄ μ‘μ—…μ„ μ‚¬μ©ν•λ ¤λ©΄ s3:ListBucketVersions μ‘μ—…μ„ μν–‰ν•  μ μλ” κ¶ν•μ΄ μμ–΄μ•Ό ν•©λ‹λ‹¤. μ΄λ¦„ μ°¨μ΄μ— μ μν•μ„Έμ”.
```bash
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>
# redirect output into a file
aws --no-sign-request s3api list-object-versions --bucket <bucket_name> > versions.json
```
νΉμ • κ°μ²΄μ λ²„μ „μ„ κ°€μ Έμ¤λ ¤λ©΄ λ‹¤μμ„ μ‹λ„ν•μ‹­μ‹μ¤:
```bash
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>
```
### S3 Access logs

S3 μ•΅μ„Έμ¤ λ΅κ·Έλ¥Ό **ν™μ„±ν™”**ν•λ” κ²ƒμ΄ κ°€λ¥ν•λ©°(κΈ°λ³Έμ μΌλ΅ λΉ„ν™μ„±ν™”λμ–΄ μμ), νΉμ • λ²„ν‚·μ— λ€ν•΄ λ΅κ·Έλ¥Ό λ‹¤λ¥Έ λ²„ν‚·μ— μ €μ¥ν•μ—¬ λ„κ°€ λ²„ν‚·μ— μ ‘κ·Όν•λ”μ§€ μ• μ μμµλ‹λ‹¤(λ‘ λ²„ν‚·μ€ λ™μΌν• λ¦¬μ „μ— μμ–΄μ•Ό ν•¨).

### S3 Presigned URLs

λ²„ν‚·μ—μ„ **μ§€μ •λ νμΌμ— μ ‘κ·Ό**ν•λ” λ° μΌλ°μ μΌλ΅ μ‚¬μ©λ  μ μλ” presigned URLμ„ μƒμ„±ν•λ” κ²ƒμ΄ κ°€λ¥ν•©λ‹λ‹¤. **presigned URLμ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
A presigned URL can be **created from the cli using credentials of a principal with access to the object** (if the account you use doesn't have access, a shorter presigned URL will be created but it will be useless)  
ν”„λ¦¬μ‚¬μΈλ URLμ€ **κ°μ²΄μ— μ ‘κ·Όν•  μ μλ” μ£Όμ²΄μ μκ²© μ¦λ…μ„ μ‚¬μ©ν•μ—¬ cliμ—μ„ μƒμ„±ν•  μ μμµλ‹λ‹¤** (μ‚¬μ©ν•λ” κ³„μ •μ΄ μ ‘κ·Ό κ¶ν•μ΄ μ—†μΌλ©΄ λ” μ§§μ€ ν”„λ¦¬μ‚¬μΈλ URLμ΄ μƒμ„±λμ§€λ§ μ“Έλ¨κ°€ μ—†μµλ‹λ‹¤)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
ν”„λ¦¬μ‚¬μΈλ“ URLμ„ μƒμ„±ν•λ” λ° ν•„μ”ν• μ μΌν• κ¶ν•μ€ λ¶€μ—¬λ κ¶ν•μ΄λ―€λ΅, μ΄μ „ λ…λ Ήμ κ²½μ° μ£Όμ²΄κ°€ ν•„μ”ν• μ μΌν• κ¶ν•μ€ `s3:GetObject`μ…λ‹λ‹¤.
{% endhint %}

λ‹¤λ¥Έ **κ¶ν•**μΌλ΅ ν”„λ¦¬μ‚¬μΈλ“ URLμ„ μƒμ„±ν•λ” κ²ƒλ„ κ°€λ¥ν•©λ‹λ‹¤:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 μ•”νΈν™” λ©”μ»¤λ‹μ¦

**DEKλ” λ°μ΄ν„° μ•”νΈν™” ν‚¤**λ¥Ό μλ―Έν•λ©°, λ°μ΄ν„° μ•”νΈν™”μ— ν•­μƒ μƒμ„±λκ³  μ‚¬μ©λλ” ν‚¤μ…λ‹λ‹¤.

<details>

<summary><strong>S3 κ΄€λ¦¬ ν‚¤λ¥Ό μ‚¬μ©ν• μ„λ²„ μΈ΅ μ•”νΈν™”, SSE-S3</strong></summary>

μ΄ μµμ…μ€ μµμ†ν•μ κµ¬μ„±μ„ μ”κµ¬ν•λ©° μ‚¬μ©λλ” μ•”νΈν™” ν‚¤μ λ¨λ“  κ΄€λ¦¬λ” AWSμ—μ„ κ΄€λ¦¬λ©λ‹λ‹¤. λ‹Ήμ‹ μ΄ ν•΄μ•Ό ν•  μΌμ€ **λ°μ΄ν„°λ¥Ό μ—…λ΅λ“ν•λ” κ²ƒμ΄λ©°, S3κ°€ λ‚λ¨Έμ§€ λ¨λ“  μΈ΅λ©΄μ„ μ²λ¦¬ν•©λ‹λ‹¤**. S3 κ³„μ •μ κ° λ²„ν‚·μ€ λ²„ν‚· ν‚¤κ°€ ν• λ‹Ήλ©λ‹λ‹¤.

* μ•”νΈν™”:
* κ°μ²΄ λ°μ΄ν„° + μƒμ„±λ ν‰λ¬Έ DEK --> μ•”νΈν™”λ λ°μ΄ν„° (S3μ— μ €μ¥λ¨)
* μƒμ„±λ ν‰λ¬Έ DEK + S3 λ§μ¤ν„° ν‚¤ --> μ•”νΈν™”λ DEK (S3μ— μ €μ¥λ¨) λ° ν‰λ¬Έμ€ λ©”λ¨λ¦¬μ—μ„ μ‚­μ λ¨
* λ³µνΈν™”:
* μ•”νΈν™”λ DEK + S3 λ§μ¤ν„° ν‚¤ --> ν‰λ¬Έ DEK
* ν‰λ¬Έ DEK + μ•”νΈν™”λ λ°μ΄ν„° --> κ°μ²΄ λ°μ΄ν„°

μ΄ κ²½μ° **ν‚¤λ” AWSμ— μν•΄ κ΄€λ¦¬λ©λ‹λ‹¤** (νμ „μ€ 3λ…„μ— ν• λ²λ§). μμ‹ μ ν‚¤λ¥Ό μ‚¬μ©ν•λ©΄ νμ „, λΉ„ν™μ„±ν™” λ° μ ‘κ·Ό μ μ–΄λ¥Ό μ μ©ν•  μ μμµλ‹λ‹¤.

</details>

<details>

<summary><strong>KMS κ΄€λ¦¬ ν‚¤λ¥Ό μ‚¬μ©ν• μ„λ²„ μΈ΅ μ•”νΈν™”, SSE-KMS</strong></summary>

μ΄ λ°©λ²•μ€ S3κ°€ ν‚¤ κ΄€λ¦¬ μ„λΉ„μ¤λ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„° μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•  μ μκ² ν•©λ‹λ‹¤. KMSλ” ν‚¤ κ΄€λ¦¬μ— λ€ν• ν›¨μ”¬ λ” ν° μ μ—°μ„±μ„ μ κ³µν•©λ‹λ‹¤. μλ¥Ό λ“¤μ–΄, CMKμ— λ€ν•΄ λΉ„ν™μ„±ν™”, νμ „ λ° μ ‘κ·Ό μ μ–΄λ¥Ό μ μ©ν•  μ μμΌλ©°, AWS Cloud Trailμ„ μ‚¬μ©ν•μ—¬ μ‚¬μ©μ— λ€ν• μ£Όλ¬Έμ„ ν•  μ μμµλ‹λ‹¤.

* μ•”νΈν™”:
* S3λ” KMS CMKμ—μ„ λ°μ΄ν„° ν‚¤λ¥Ό μ”μ²­ν•©λ‹λ‹¤
* KMSλ” CMKλ¥Ό μ‚¬μ©ν•μ—¬ ν‰λ¬Έ DEKμ™€ μ•”νΈν™”λ DEK μμ„ μƒμ„±ν•κ³  μ΄λ¥Ό S3μ— μ „μ†΅ν•©λ‹λ‹¤
* S3λ” ν‰λ¬Έ ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•κ³ , μ•”νΈν™”λ λ°μ΄ν„°μ™€ μ•”νΈν™”λ ν‚¤λ¥Ό μ €μ¥ν•λ©° ν‰λ¬Έ ν‚¤λ” λ©”λ¨λ¦¬μ—μ„ μ‚­μ ν•©λ‹λ‹¤
* λ³µνΈν™”:
* S3λ” KMSμ— κ°μ²΄μ μ•”νΈν™”λ λ°μ΄ν„° ν‚¤λ¥Ό λ³µνΈν™”ν•΄ λ‹¬λΌκ³  μ”μ²­ν•©λ‹λ‹¤
* KMSλ” CMKλ΅ λ°μ΄ν„° ν‚¤λ¥Ό λ³µνΈν™”ν•κ³  μ΄λ¥Ό S3μ— λ‹¤μ‹ μ „μ†΅ν•©λ‹λ‹¤
* S3λ” κ°μ²΄ λ°μ΄ν„°λ¥Ό λ³µνΈν™”ν•©λ‹λ‹¤

</details>

<details>

<summary><strong>μ‚¬μ©μ μ κ³µ ν‚¤λ¥Ό μ‚¬μ©ν• μ„λ²„ μΈ΅ μ•”νΈν™”, SSE-C</strong></summary>

μ΄ μµμ…μ€ AWS μ™Έλ¶€μ—μ„ μ΄λ―Έ μ‚¬μ©ν•κ³  μμ„ μ μλ” μμ‹ μ λ§μ¤ν„° ν‚¤λ¥Ό μ κ³µν•  μ μλ” κΈ°νλ¥Ό μ κ³µν•©λ‹λ‹¤. κ³ κ°μ΄ μ κ³µν• ν‚¤λ” λ°μ΄ν„°μ™€ ν•¨κ» S3λ΅ μ „μ†΅λλ©°, S3λ” μ΄λ¥Ό μ•”νΈν™”ν•©λ‹λ‹¤.

* μ•”νΈν™”:
* μ‚¬μ©μκ°€ κ°μ²΄ λ°μ΄ν„° + κ³ κ° ν‚¤λ¥Ό S3μ— μ „μ†΅ν•©λ‹λ‹¤
* κ³ κ° ν‚¤λ” λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•λ” λ° μ‚¬μ©λλ©° μ•”νΈν™”λ λ°μ΄ν„°κ°€ μ €μ¥λ©λ‹λ‹¤
* κ³ κ° ν‚¤μ μ†κΈμ΄ μ¶”κ°€λ HMAC κ°’λ„ λ―Έλμ ν‚¤ κ²€μ¦μ„ μ„ν•΄ μ €μ¥λ©λ‹λ‹¤
* κ³ κ° ν‚¤λ” λ©”λ¨λ¦¬μ—μ„ μ‚­μ λ©λ‹λ‹¤
* λ³µνΈν™”:
* μ‚¬μ©μκ°€ κ³ κ° ν‚¤λ¥Ό μ „μ†΅ν•©λ‹λ‹¤
* ν‚¤λ” μ €μ¥λ HMAC κ°’μ— λ€ν•΄ κ²€μ¦λ©λ‹λ‹¤
* κ³ κ° μ κ³µ ν‚¤κ°€ λ°μ΄ν„°λ¥Ό λ³µνΈν™”ν•λ” λ° μ‚¬μ©λ©λ‹λ‹¤

</details>

<details>

<summary><strong>KMSλ¥Ό μ‚¬μ©ν• ν΄λΌμ΄μ–ΈνΈ μΈ΅ μ•”νΈν™”, CSE-KMS</strong></summary>

SSE-KMSμ™€ μ μ‚¬ν•κ², μ΄ λ°©λ²•λ„ ν‚¤ κ΄€λ¦¬ μ„λΉ„μ¤λ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„° μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤. κ·Έλ¬λ‚ μ΄λ²μ—λ” S3κ°€ μ•„λ‹ ν΄λΌμ΄μ–ΈνΈλ¥Ό ν†µν•΄ KMSκ°€ νΈμ¶λ©λ‹λ‹¤. μ•”νΈν™”λ” ν΄λΌμ΄μ–ΈνΈ μΈ΅μ—μ„ μ΄λ£¨μ–΄μ§€λ©°, μ•”νΈν™”λ λ°μ΄ν„°λ” S3μ— μ €μ¥λ©λ‹λ‹¤.

* μ•”νΈν™”:
* ν΄λΌμ΄μ–ΈνΈκ°€ KMSμ— λ°μ΄ν„° ν‚¤λ¥Ό μ”μ²­ν•©λ‹λ‹¤
* KMSλ” ν‰λ¬Έ DEKμ™€ CMKλ΅ μ•”νΈν™”λ DEKλ¥Ό λ°ν™ν•©λ‹λ‹¤
* λ‘ ν‚¤κ°€ λ‹¤μ‹ μ „μ†΅λ©λ‹λ‹¤
* ν΄λΌμ΄μ–ΈνΈλ” ν‰λ¬Έ DEKλ΅ λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•κ³  μ•”νΈν™”λ λ°μ΄ν„° + μ•”νΈν™”λ DEKλ¥Ό S3μ— μ „μ†΅ν•©λ‹λ‹¤ (μ•”νΈν™”λ λ°μ΄ν„°μ λ©”νƒ€λ°μ΄ν„°λ΅ μ €μ¥λ¨)
* λ³µνΈν™”:
* μ•”νΈν™”λ λ°μ΄ν„°μ™€ μ•”νΈν™”λ DEKκ°€ ν΄λΌμ΄μ–ΈνΈμ— μ „μ†΅λ©λ‹λ‹¤
* ν΄λΌμ΄μ–ΈνΈλ” CMKλ¥Ό μ‚¬μ©ν•μ—¬ μ•”νΈν™”λ ν‚¤λ¥Ό λ³µνΈν™”ν•΄ λ‹¬λΌκ³  KMSμ— μ”μ²­ν•κ³  KMSλ” ν‰λ¬Έ DEKλ¥Ό λ‹¤μ‹ μ „μ†΅ν•©λ‹λ‹¤
* ν΄λΌμ΄μ–ΈνΈλ” μ΄μ  μ•”νΈν™”λ λ°μ΄ν„°λ¥Ό λ³µνΈν™”ν•  μ μμµλ‹λ‹¤

</details>

<details>

<summary><strong>μ‚¬μ©μ μ κ³µ ν‚¤λ¥Ό μ‚¬μ©ν• ν΄λΌμ΄μ–ΈνΈ μΈ΅ μ•”νΈν™”, CSE-C</strong></summary>

μ΄ λ©”μ»¤λ‹μ¦μ„ μ‚¬μ©ν•λ©΄ μ κ³µλ ν‚¤λ¥Ό ν™μ©ν•κ³  AWS-SDK ν΄λΌμ΄μ–ΈνΈλ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ¥Ό S3μ— μ €μ¥ν•κΈ° μ „μ— μ•”νΈν™”ν•  μ μμµλ‹λ‹¤.

* μ•”νΈν™”:
* ν΄λΌμ΄μ–ΈνΈκ°€ DEKλ¥Ό μƒμ„±ν•κ³  ν‰λ¬Έ λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•©λ‹λ‹¤
* κ·Έλ° λ‹¤μ, μμ‹ μ μ‚¬μ©μ μ •μ CMKλ¥Ό μ‚¬μ©ν•μ—¬ DEKλ¥Ό μ•”νΈν™”ν•©λ‹λ‹¤
* μ•”νΈν™”λ λ°μ΄ν„° + μ•”νΈν™”λ DEKλ¥Ό S3μ— μ μ¶ν•μ—¬ μ €μ¥ν•©λ‹λ‹¤
* λ³µνΈν™”:
* S3κ°€ μ•”νΈν™”λ λ°μ΄ν„°μ™€ DEKλ¥Ό μ „μ†΅ν•©λ‹λ‹¤
* ν΄λΌμ΄μ–ΈνΈλ” DEKλ¥Ό μ•”νΈν™”ν•λ” λ° μ‚¬μ©λ CMKλ¥Ό μ΄λ―Έ κ°€μ§€κ³  μμΌλ―€λ΅ DEKλ¥Ό λ³µνΈν™”ν•κ³  ν‰λ¬Έ DEKλ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ¥Ό λ³µνΈν™”ν•©λ‹λ‹¤

</details>

### **μ—΄κ±°**

AWS μ΅°μ§μ„ νƒ€κ²μΌλ΅ ν•λ” μ „ν†µμ μΈ μ£Όμ” λ°©λ²• μ¤‘ ν•λ‚λ” κ³µκ°μ μΌλ΅ μ ‘κ·Ό κ°€λ¥ν• λ²„ν‚·μ„ νƒ€κ²μΌλ΅ ν•λ” κ²ƒμ…λ‹λ‹¤. **λ‹Ήμ‹ μ€ μ΄ νμ΄μ§€μ—μ„** [**κ³µκ° λ²„ν‚· μ—΄κ±° λ„κµ¬λ¥Ό μ°Ύμ„ μ μμµλ‹λ‹¤**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# list objects version history
# try to remove --no-sign-request if you are authenticated
aws --no-sign-request s3api list-object-versions --bucket <bucket_name>

# get a specific version for a object
aws --no-sign-request s3api get-object --bucket <bucket_name> --key <object_key> --version-id <object_VersionId> <output_filename>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name β€“-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Ownerβ€™s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

S3 λ²„ν‚·μ— μ ‘κ·Όν•λ ¤λ©΄ κ°€μƒ νΈμ¤ν… μ¤νƒ€μΌ λλ” κ²½λ΅ μ¤νƒ€μΌ μ—”λ“ν¬μΈνΈ μ΄λ¦„μ„ μ‚¬μ©ν•μ—¬ μ΄μ¤‘ μ¤νƒ μ—”λ“ν¬μΈνΈλ¥Ό ν†µν•΄ μ ‘κ·Όν•  μ μμµλ‹λ‹¤. μ΄λ” IPv6λ¥Ό ν†µν•΄ S3μ— μ ‘κ·Όν•λ” λ° μ μ©ν•©λ‹λ‹¤.

μ΄μ¤‘ μ¤νƒ μ—”λ“ν¬μΈνΈλ” λ‹¤μ κµ¬λ¬Έμ„ μ‚¬μ©ν•©λ‹λ‹¤:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

λ‹¤μ νμ΄μ§€μ—μ„ **S3 κ¶ν•μ„ μ•…μ©ν•μ—¬ κ¶ν•μ„ μƒμΉμ‹ν‚¤λ” λ°©λ²•**μ„ ν™•μΈν•  μ μμµλ‹λ‹¤:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Unauthenticated Access

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Other S3 vulns

### S3 HTTP Cache Poisoning Issue <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**μ΄ μ—°κµ¬μ— λ”°λ¥΄λ©΄**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) μ„μμ λ²„ν‚·μ μ‘λ‹µμ„ λ‹¤λ¥Έ λ²„ν‚·μ κ²ƒμ²λΌ μΊμ‹ν•  μ μμ—μµλ‹λ‹¤. μ΄λ” μλ¥Ό λ“¤μ–΄ μλ°”μ¤ν¬λ¦½νΈ νμΌ μ‘λ‹µμ„ λ³€κ²½ν•κ³  S3λ¥Ό μ‚¬μ©ν•μ—¬ μ •μ  μ½”λ“λ¥Ό μ €μ¥ν•λ” μ„μμ νμ΄μ§€λ¥Ό μ†μƒμ‹ν‚¤λ” λ° μ•…μ©λ  μ μμ—μµλ‹λ‹¤.

## Amazon Athena

Amazon Athenaλ” Amazon Simple Storage Service(Amazon **S3**)μ—μ„ **ν‘μ¤€ SQL**μ„ μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ¥Ό μ§μ ‘ **λ¶„μ„**ν•κΈ° μ‰½κ² ν•΄μ£Όλ” λ€ν™”ν• μΏΌλ¦¬ μ„λΉ„μ¤μ…λ‹λ‹¤.

λ¨λ‹ν„°λ§λλ” S3 λ²„ν‚·μ— λ‚νƒ€λ‚  μ½ν…μΈ  ν•μ‹μΌλ΅ **κ΄€κ³„ν• DB ν…μ΄λΈ”μ„ μ¤€λΉ„**ν•΄μ•Ό ν•©λ‹λ‹¤. κ·Έλ° λ‹¤μ Amazon Athenaλ” λ΅κ·Έμ—μ„ DBλ¥Ό μ±„μΈ μ μμΌλ―€λ΅ μΏΌλ¦¬ν•  μ μμµλ‹λ‹¤.

Amazon Athenaλ” **μ΄λ―Έ μ•”νΈν™”λ S3 λ°μ΄ν„°λ¥Ό μΏΌλ¦¬ν•  μ μλ” κΈ°λ¥μ„ μ§€μ›**ν•λ©°, κ·Έλ ‡κ² κµ¬μ„±λ κ²½μ° **Athenaλ” μΏΌλ¦¬ κ²°κ³Όλ¥Ό μ•”νΈν™”ν•  μ μμΌλ©°, μ΄λ” S3μ— μ €μ¥λ  μ μμµλ‹λ‹¤**.

**μ΄ κ²°κ³Όμ μ•”νΈν™”λ” κΈ°λ³Έμ μΌλ΅ μΏΌλ¦¬λ S3 λ°μ΄ν„°μ™€ λ…λ¦½μ **μ΄λ©°, S3 λ°μ΄ν„°κ°€ μ•”νΈν™”λμ§€ μ•μ€ κ²½μ°μ—λ„ μΏΌλ¦¬λ κ²°κ³Όλ” μ•”νΈν™”λ  μ μμµλ‹λ‹¤. μ•μ•„μ•Ό ν•  λ‡ κ°€μ§€ μ‚¬ν•­μ€ Amazon Athenaκ°€ **λ‹¤μ S3 μ•”νΈν™” λ°©λ²•**μΈ **SSE-S3, SSE-KMS, CSE-KMS**λ΅ **μ•”νΈν™”λ** λ°μ΄ν„°λ§ μ§€μ›ν•λ‹¤λ” κ²ƒμ…λ‹λ‹¤.

SSE-C λ° CSE-Eλ” μ§€μ›λμ§€ μ•μµλ‹λ‹¤. μ΄ μ™Έμ—λ„ Amazon Athenaλ” **μΏΌλ¦¬ μμ²΄μ™€ λ™μΌν• μ§€μ—­μ— μλ” μ•”νΈν™”λ κ°μ²΄μ— λ€ν•΄μ„λ§ μΏΌλ¦¬λ¥Ό μ‹¤ν–‰**ν•λ‹¤λ” μ μ„ μ΄ν•΄ν•λ” κ²ƒμ΄ μ¤‘μ”ν•©λ‹λ‹¤. KMSλ¥Ό μ‚¬μ©ν•μ—¬ μ•”νΈν™”λ S3 λ°μ΄ν„°λ¥Ό μΏΌλ¦¬ν•΄μ•Ό ν•λ” κ²½μ°, Athena μ‚¬μ©μκ°€ μΏΌλ¦¬λ¥Ό μν–‰ν•  μ μλ„λ΅ νΉμ • κ¶ν•μ΄ ν•„μ”ν•©λ‹λ‹¤.

### Enumeration
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## References

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{% hint style="success" %}
AWS ν•΄ν‚Ή λ°°μ°κΈ° λ° μ—°μµν•κΈ°:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP ν•΄ν‚Ή λ°°μ°κΈ° λ° μ—°μµν•κΈ°: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks μ§€μ›ν•κΈ°</summary>

* [**κµ¬λ… κ³„ν**](https://github.com/sponsors/carlospolop) ν™•μΈν•κΈ°!
* **π’¬ [**Discord κ·Έλ£Ή**](https://discord.gg/hRep4RUj7f) λλ” [**ν…”λ κ·Έλ¨ κ·Έλ£Ή**](https://t.me/peass)μ— μ°Έμ—¬ν•κ±°λ‚ **Twitter** π¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**λ¥Ό ν”λ΅μ°ν•μ„Έμ”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) λ° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) κΉƒν—λΈ λ¦¬ν¬μ§€ν† λ¦¬μ— PRμ„ μ μ¶ν•μ—¬ ν•΄ν‚Ή νμ„ κ³µμ ν•μ„Έμ”.**

</details>
{% endhint %}
