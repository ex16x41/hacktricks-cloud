# AWS - Abusing Lambda Extensions

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Lambda Extensions

Lambda ekstenzije poboljÅ¡avaju funkcije integracijom sa raznim **alatima za monitoring, observabilnost, sigurnost i upravljanje**. Ove ekstenzije, dodate putem [.zip arhiva koristeÄ‡i Lambda slojeve](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ili ukljuÄene u [container image deployments](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), rade u dva reÅ¾ima: **interni** i **eksterni**.

* **Interni ekstenzije** se spajaju sa runtime procesom, manipuliÅ¡uÄ‡i njegovim pokretanjem koristeÄ‡i **jeziÄke specifiÄne promenljive okruÅ¾enja** i **wrapper skripte**. Ova prilagoÄ‘avanja se primenjuju na razliÄite runtime-ove, ukljuÄujuÄ‡i **Java Correto 8 i 11, Node.js 10 i 12, i .NET Core 3.1**.
* **Eksterni ekstenzije** rade kao zasebni procesi, odrÅ¾avajuÄ‡i operativnu usklaÄ‘enost sa Å¾ivotnim ciklusom Lambda funkcije. Kompatibilni su sa raznim runtime-ovima kao Å¡to su **Node.js 10 i 12, Python 3.7 i 3.8, Ruby 2.5 i 2.7, Java Corretto 8 i 11, .NET Core 3.1**, i **custom runtimes**.

Za viÅ¡e informacija o [**kako lambda ekstenzije rade, pogledajte dokumentaciju**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Eksterni Ekstenzija za Persistenciju, KraÄ‘u Zahteva i Modifikaciju Zahteva

Ovo je saÅ¾etak tehnike predloÅ¾ene u ovom postu: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Otkriveno je da je podrazumevani Linux kernel u Lambda runtime okruÅ¾enju kompajliran sa â€œ**process\_vm\_readv**â€ i â€œ**process\_vm\_writev**â€ sistemskim pozivima. I svi procesi rade sa istim korisniÄkim ID-om, Äak i novi proces kreiran za eksterni ekstenziju. **Ovo znaÄi da eksterni ekstenzija ima pun pristup za Äitanje i pisanje Rapid-ove heap memorije, po dizajnu.**

Å taviÅ¡e, dok Lambda ekstenzije imaju moguÄ‡nost da se **pretplate na dogaÄ‘aje poziva**, AWS ne otkriva sirove podatke ovim ekstenzijama. Ovo osigurava da **ekstenzije ne mogu pristupiti osetljivim informacijama** prenetim putem HTTP zahteva.

Init (Rapid) proces prati sve API zahteve na [http://127.0.0.1:9001](http://127.0.0.1:9001/) dok se Lambda ekstenzije inicijalizuju i rade pre izvrÅ¡enja bilo kog runtime koda, ali nakon Rapid-a.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

Promenljiva **`AWS_LAMBDA_RUNTIME_API`** oznaÄava **IP** adresu i **port** broj Rapid API-ja za **child runtime procese** i dodatne ekstenzije.

{% hint style="warning" %}
Promenom **`AWS_LAMBDA_RUNTIME_API`** promenljive okruÅ¾enja na **`port`** kojem imamo pristup, moguÄ‡e je presresti sve akcije unutar Lambda runtime-a (**man-in-the-middle**). Ovo je moguÄ‡e jer ekstenzija radi sa istim privilegijama kao Rapid Init, a kernel sistema omoguÄ‡ava **modifikaciju memorije procesa**, omoguÄ‡avajuÄ‡i promenu broja porta.
{% endhint %}

PoÅ¡to **ekstenzije rade pre bilo kog runtime koda**, modifikacija promenljive okruÅ¾enja Ä‡e uticati na runtime proces (npr. Python, Java, Node, Ruby) dok se pokreÄ‡e. Å taviÅ¡e, **ekstenzije uÄitane nakon** naÅ¡e, koje se oslanjaju na ovu promenljivu, takoÄ‘e Ä‡e se usmeravati kroz naÅ¡u ekstenziju. Ova postavka bi mogla omoguÄ‡iti malveru da potpuno zaobiÄ‘e sigurnosne mere ili ekstenzije za logovanje direktno unutar runtime okruÅ¾enja.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

Alat [**lambda-spy**](https://github.com/clearvector/lambda-spy) je kreiran da izvrÅ¡i tu **memorijsku pisanje** i **ukrade osetljive informacije** iz lambda zahteva, drugih **ekstenzija** **zahteva** i Äak **modifikuje ih**.

## Reference

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
