# AWS - Abusing Lambda Extensions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda Extensions

Lambda extensionsã¯ã€ã•ã¾ã–ã¾ãª**ç›£è¦–ã€å¯è¦³æ¸¬æ€§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãŠã‚ˆã³ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ„ãƒ¼ãƒ«**ã¨çµ±åˆã™ã‚‹ã“ã¨ã§é–¢æ•°ã‚’å¼·åŒ–ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®æ‹¡å¼µæ©Ÿèƒ½ã¯ã€[.zipã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½¿ç”¨ã—ã¦Lambdaãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¿½åŠ ](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)ã™ã‚‹ã‹ã€[ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å«ã‚ã‚‹](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)ã“ã¨ã§è¿½åŠ ã•ã‚Œã€**å†…éƒ¨**ãŠã‚ˆã³**å¤–éƒ¨**ã®2ã¤ã®ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™ã€‚

* **å†…éƒ¨æ‹¡å¼µæ©Ÿèƒ½**ã¯ã€**è¨€èªå›ºæœ‰ã®ç’°å¢ƒå¤‰æ•°**ãŠã‚ˆã³**ãƒ©ãƒƒãƒ‘ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã‚’ä½¿ç”¨ã—ã¦èµ·å‹•ã‚’æ“ä½œã—ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ—ãƒ­ã‚»ã‚¹ã¨çµ±åˆã—ã¾ã™ã€‚ã“ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã¯ã€**Java Correto 8ãŠã‚ˆã³11ã€Node.js 10ãŠã‚ˆã³12ã€.NET Core 3.1**ãªã©ã®ã•ã¾ã–ã¾ãªãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚
* **å¤–éƒ¨æ‹¡å¼µæ©Ÿèƒ½**ã¯ã€åˆ¥å€‹ã®ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã€Lambdaé–¢æ•°ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã¨æ•´åˆæ€§ã‚’ä¿ã¡ãªãŒã‚‰å‹•ä½œã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ã€**Node.js 10ãŠã‚ˆã³12ã€Python 3.7ãŠã‚ˆã³3.8ã€Ruby 2.5ãŠã‚ˆã³2.7ã€Java Corretto 8ãŠã‚ˆã³11ã€.NET Core 3.1**ã€ãŠã‚ˆã³**ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ **ãªã©ã®ã•ã¾ã–ã¾ãªãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¨äº’æ›æ€§ãŒã‚ã‚Šã¾ã™ã€‚

[**lambdaæ‹¡å¼µæ©Ÿèƒ½ã®å‹•ä½œã«ã¤ã„ã¦ã®è©³ç´°ã¯ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html)ã€‚

### External Extension for Persistence, Stealing Requests & modifying Requests

ã“ã‚Œã¯ã€ã“ã®æŠ•ç¨¿ã§ææ¡ˆã•ã‚ŒãŸæŠ€è¡“ã®æ¦‚è¦ã§ã™: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Lambdaãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Linuxã‚«ãƒ¼ãƒãƒ«ã¯ã€ã€Œ**process\_vm\_readv**ã€ãŠã‚ˆã³ã€Œ**process\_vm\_writev**ã€ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ã¾ã—ãŸã€‚ãã—ã¦ã€ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§å®Ÿè¡Œã•ã‚Œã€å¤–éƒ¨æ‹¡å¼µæ©Ÿèƒ½ã®ãŸã‚ã«ä½œæˆã•ã‚ŒãŸæ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹ã‚‚åŒæ§˜ã§ã™ã€‚**ã“ã‚Œã¯ã€å¤–éƒ¨æ‹¡å¼µæ©Ÿèƒ½ãŒè¨­è¨ˆä¸Šã€Rapidã®ãƒ’ãƒ¼ãƒ—ãƒ¡ãƒ¢ãƒªã«å®Œå…¨ãªèª­ã¿å–ã‚ŠãŠã‚ˆã³æ›¸ãè¾¼ã¿ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã¤ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚**

ã•ã‚‰ã«ã€Lambdaæ‹¡å¼µæ©Ÿèƒ½ã¯**å‘¼ã³å‡ºã—ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã™ã‚‹**æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã¾ã™ãŒã€AWSã¯ã“ã‚Œã‚‰ã®æ‹¡å¼µæ©Ÿèƒ½ã«ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å…¬é–‹ã—ã¾ã›ã‚“ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**æ‹¡å¼µæ©Ÿèƒ½ãŒHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä»‹ã—ã¦é€ä¿¡ã•ã‚Œã‚‹æ©Ÿå¯†æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„**ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

Init (Rapid)ãƒ—ãƒ­ã‚»ã‚¹ã¯ã€[http://127.0.0.1:9001](http://127.0.0.1:9001/)ã§ã®ã™ã¹ã¦ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç›£è¦–ã—ã€Lambdaæ‹¡å¼µæ©Ÿèƒ½ã¯ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œå‰ã«åˆæœŸåŒ–ãŠã‚ˆã³å®Ÿè¡Œã•ã‚Œã¾ã™ãŒã€Rapidã®å¾Œã«è¡Œã‚ã‚Œã¾ã™ã€‚

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

å¤‰æ•°**`AWS_LAMBDA_RUNTIME_API`**ã¯ã€**å­ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ—ãƒ­ã‚»ã‚¹**ãŠã‚ˆã³è¿½åŠ ã®æ‹¡å¼µæ©Ÿèƒ½ã«å¯¾ã—ã¦Rapid APIã®**IP**ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨**ãƒãƒ¼ãƒˆ**ç•ªå·ã‚’ç¤ºã—ã¾ã™ã€‚

{% hint style="warning" %}
**`AWS_LAMBDA_RUNTIME_API`**ç’°å¢ƒå¤‰æ•°ã‚’ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãª**`port`**ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€Lambdaãƒ©ãƒ³ã‚¿ã‚¤ãƒ å†…ã®ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ï¼ˆ**man-in-the-middle**ï¼‰ã€‚ã“ã‚Œã¯ã€æ‹¡å¼µæ©Ÿèƒ½ãŒRapid Initã¨åŒã˜æ¨©é™ã§å®Ÿè¡Œã•ã‚Œã€ã‚·ã‚¹ãƒ†ãƒ ã®ã‚«ãƒ¼ãƒãƒ«ãŒ**ãƒ—ãƒ­ã‚»ã‚¹ãƒ¡ãƒ¢ãƒªã®å¤‰æ›´**ã‚’è¨±å¯ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒãƒ¼ãƒˆç•ªå·ã®å¤‰æ›´ãŒå¯èƒ½ã«ãªã‚‹ãŸã‚ã§ã™ã€‚
{% endhint %}

**æ‹¡å¼µæ©Ÿèƒ½ã¯ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ã®å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹**ãŸã‚ã€ç’°å¢ƒå¤‰æ•°ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆä¾‹ï¼šPythonã€Javaã€Nodeã€Rubyï¼‰ã®èµ·å‹•æ™‚ã«å½±éŸ¿ã‚’ä¸ãˆã¾ã™ã€‚ã•ã‚‰ã«ã€**ç§ãŸã¡ã®æ‹¡å¼µæ©Ÿèƒ½ã®å¾Œã«èª­ã¿è¾¼ã¾ã‚Œã‚‹æ‹¡å¼µæ©Ÿèƒ½**ã‚‚ã“ã®å¤‰æ•°ã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã€ç§ãŸã¡ã®æ‹¡å¼µæ©Ÿèƒ½ã‚’çµŒç”±ã—ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã‚ˆã‚Šã€ãƒãƒ«ã‚¦ã‚§ã‚¢ãŒãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒå†…ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚„ãƒ­ã‚°æ‹¡å¼µæ©Ÿèƒ½ã‚’å®Œå…¨ã«å›é¿ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

ãƒ„ãƒ¼ãƒ«[**lambda-spy**](https://github.com/clearvector/lambda-spy)ã¯ã€ãã®**ãƒ¡ãƒ¢ãƒªæ›¸ãè¾¼ã¿**ã‚’å®Ÿè¡Œã—ã€lambdaãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ä»–ã®**æ‹¡å¼µæ©Ÿèƒ½**ã®**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã‹ã‚‰æ©Ÿå¯†æƒ…å ±ã‚’**ç›—ã¿**ã€ã•ã‚‰ã«ã¯**ãã‚Œã‚‰ã‚’å¤‰æ›´**ã™ã‚‹ãŸã‚ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚

## References

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
