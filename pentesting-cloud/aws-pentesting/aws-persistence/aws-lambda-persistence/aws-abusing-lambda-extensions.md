# AWS - Abusing Lambda Extensions

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## Lambda Extensions

Lambda extensions é€šè¿‡é›†æˆå„ç§ **ç›‘æ§ã€å¯è§‚å¯Ÿæ€§ã€å®‰å…¨å’Œæ²»ç†å·¥å…·** æ¥å¢å¼ºåŠŸèƒ½ã€‚è¿™äº›æ‰©å±•é€šè¿‡ [.zip archives using Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) æˆ–åŒ…å«åœ¨ [container image deployments](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/) ä¸­æ·»åŠ ï¼Œè¿è¡Œåœ¨ä¸¤ç§æ¨¡å¼ä¸‹ï¼š**internal** å’Œ **external**ã€‚

* **Internal extensions** ä¸è¿è¡Œæ—¶è¿›ç¨‹åˆå¹¶ï¼Œä½¿ç”¨ **language-specific environment variables** å’Œ **wrapper scripts** æ“ä½œå…¶å¯åŠ¨ã€‚è¿™ç§è‡ªå®šä¹‰é€‚ç”¨äºå¤šç§è¿è¡Œæ—¶ï¼ŒåŒ…æ‹¬ **Java Correto 8 å’Œ 11, Node.js 10 å’Œ 12, ä»¥åŠ .NET Core 3.1**ã€‚
* **External extensions** ä½œä¸ºç‹¬ç«‹è¿›ç¨‹è¿è¡Œï¼Œä¸ Lambda å‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸä¿æŒæ“ä½œä¸€è‡´ã€‚å®ƒä»¬å…¼å®¹å¤šç§è¿è¡Œæ—¶ï¼Œå¦‚ **Node.js 10 å’Œ 12, Python 3.7 å’Œ 3.8, Ruby 2.5 å’Œ 2.7, Java Corretto 8 å’Œ 11, .NET Core 3.1**ï¼Œä»¥åŠ **custom runtimes**ã€‚

æ›´å¤šå…³äº [**lambda extensions å·¥ä½œåŸç†çš„æ–‡æ¡£**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html)ã€‚

### External Extension for Persistence, Stealing Requests & modifying Requests

è¿™æ˜¯è¯¥æ–‡ç« ä¸­æå‡ºçš„æŠ€æœ¯æ‘˜è¦ï¼š[https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

å‘ç° Lambda è¿è¡Œæ—¶ç¯å¢ƒä¸­çš„é»˜è®¤ Linux å†…æ ¸æ˜¯ç”¨ â€œ**process\_vm\_readv**â€ å’Œ â€œ**process\_vm\_writev**â€ ç³»ç»Ÿè°ƒç”¨ç¼–è¯‘çš„ã€‚æ‰€æœ‰è¿›ç¨‹éƒ½ä»¥ç›¸åŒçš„ç”¨æˆ· ID è¿è¡Œï¼Œå³ä½¿æ˜¯ä¸º external extension åˆ›å»ºçš„æ–°è¿›ç¨‹ä¹Ÿæ˜¯å¦‚æ­¤ã€‚**è¿™æ„å‘³ç€ external extension è®¾è®¡ä¸Šå¯¹ Rapid çš„å †å†…å­˜å…·æœ‰å®Œå…¨çš„è¯»å†™è®¿é—®æƒé™ã€‚**

æ­¤å¤–ï¼Œè™½ç„¶ Lambda extensions å…·æœ‰ **è®¢é˜…è°ƒç”¨äº‹ä»¶** çš„èƒ½åŠ›ï¼Œä½† AWS ä¸ä¼šå‘è¿™äº› extensions é€éœ²åŸå§‹æ•°æ®ã€‚è¿™ç¡®ä¿äº† **extensions æ— æ³•è®¿é—®é€šè¿‡ HTTP è¯·æ±‚ä¼ è¾“çš„æ•æ„Ÿä¿¡æ¯**ã€‚

Init (Rapid) è¿›ç¨‹åœ¨ [http://127.0.0.1:9001](http://127.0.0.1:9001/) ç›‘æ§æ‰€æœ‰ API è¯·æ±‚ï¼Œè€Œ Lambda extensions åœ¨æ‰§è¡Œä»»ä½•è¿è¡Œæ—¶ä»£ç ä¹‹å‰åˆå§‹åŒ–å¹¶è¿è¡Œï¼Œä½†åœ¨ Rapid ä¹‹åã€‚

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

å˜é‡ **`AWS_LAMBDA_RUNTIME_API`** æŒ‡ç¤º **IP** åœ°å€å’Œ **port** å·ç»™ **child runtime processes** å’Œå…¶ä»– extensionsã€‚

{% hint style="warning" %}
é€šè¿‡å°† **`AWS_LAMBDA_RUNTIME_API`** ç¯å¢ƒå˜é‡æ›´æ”¹ä¸ºæˆ‘ä»¬æœ‰è®¿é—®æƒé™çš„ **`port`**ï¼Œå¯ä»¥æ‹¦æˆª Lambda è¿è¡Œæ—¶ä¸­çš„æ‰€æœ‰æ“ä½œï¼ˆ**man-in-the-middle**ï¼‰ã€‚è¿™æ˜¯å¯èƒ½çš„ï¼Œå› ä¸º extension ä»¥ä¸ Rapid Init ç›¸åŒçš„æƒé™è¿è¡Œï¼Œå¹¶ä¸”ç³»ç»Ÿçš„å†…æ ¸å…è®¸ **ä¿®æ”¹è¿›ç¨‹å†…å­˜**ï¼Œä»è€Œå¯ä»¥æ›´æ”¹ç«¯å£å·ã€‚
{% endhint %}

å› ä¸º **extensions åœ¨ä»»ä½•è¿è¡Œæ—¶ä»£ç ä¹‹å‰è¿è¡Œ**ï¼Œä¿®æ”¹ç¯å¢ƒå˜é‡å°†å½±å“è¿è¡Œæ—¶è¿›ç¨‹ï¼ˆä¾‹å¦‚ Python, Java, Node, Rubyï¼‰åœ¨å¯åŠ¨æ—¶ã€‚æ­¤å¤–ï¼Œ**åœ¨æˆ‘ä»¬ä¹‹ååŠ è½½çš„ extensions**ï¼Œä¾èµ–äºæ­¤å˜é‡çš„ï¼Œä¹Ÿå°†é€šè¿‡æˆ‘ä»¬çš„ extension è·¯ç”±ã€‚æ­¤è®¾ç½®å¯èƒ½ä½¿æ¶æ„è½¯ä»¶èƒ½å¤Ÿå®Œå…¨ç»•è¿‡å®‰å…¨æªæ–½æˆ–ç›´æ¥åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸­è®°å½•æ‰©å±•ã€‚

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

å·¥å…· [**lambda-spy**](https://github.com/clearvector/lambda-spy) è¢«åˆ›å»ºæ¥æ‰§è¡Œ **å†…å­˜å†™å…¥** å¹¶ **çªƒå– lambda è¯·æ±‚ä¸­çš„æ•æ„Ÿä¿¡æ¯**ï¼Œå…¶ä»– **extensions è¯·æ±‚** ç”šè‡³ **ä¿®æ”¹å®ƒä»¬**ã€‚

## å‚è€ƒèµ„æ–™

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
