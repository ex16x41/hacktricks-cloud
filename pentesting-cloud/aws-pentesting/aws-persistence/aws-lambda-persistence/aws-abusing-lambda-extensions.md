# AWS - Abusing Lambda Extensions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda Extensions

Lambda extensions rozszerzajÄ… funkcje poprzez integracjÄ™ z rÃ³Å¼nymi narzÄ™dziami do **monitorowania, obserwowalnoÅ›ci, bezpieczeÅ„stwa i zarzÄ…dzania**. Te rozszerzenia, dodawane za pomocÄ… [.zip archives using Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) lub wÅ‚Ä…czane w [container image deployments](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), dziaÅ‚ajÄ… w dwÃ³ch trybach: **internal** i **external**.

* **Internal extensions** Å‚Ä…czÄ… siÄ™ z procesem runtime, manipulujÄ…c jego uruchomieniem za pomocÄ… **language-specific environment variables** i **wrapper scripts**. Ta personalizacja dotyczy rÃ³Å¼nych Å›rodowisk uruchomieniowych, w tym **Java Correto 8 i 11, Node.js 10 i 12, oraz .NET Core 3.1**.
* **External extensions** dziaÅ‚ajÄ… jako oddzielne procesy, utrzymujÄ…c zgodnoÅ›Ä‡ operacyjnÄ… z cyklem Å¼ycia funkcji Lambda. SÄ… kompatybilne z rÃ³Å¼nymi Å›rodowiskami uruchomieniowymi, takimi jak **Node.js 10 i 12, Python 3.7 i 3.8, Ruby 2.5 i 2.7, Java Corretto 8 i 11, .NET Core 3.1**, oraz **custom runtimes**.

WiÄ™cej informacji na temat [**jak dziaÅ‚ajÄ… lambda extensions znajdziesz w dokumentacji**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### External Extension for Persistence, Stealing Requests & modifying Requests

To jest podsumowanie techniki zaproponowanej w tym poÅ›cie: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Odkryto, Å¼e domyÅ›lny kernel Linux w Å›rodowisku uruchomieniowym Lambda jest skompilowany z wywoÅ‚aniami systemowymi â€**process\_vm\_readv**â€ i â€**process\_vm\_writev**â€. Wszystkie procesy dziaÅ‚ajÄ… z tym samym identyfikatorem uÅ¼ytkownika, nawet nowy proces utworzony dla zewnÄ™trznego rozszerzenia. **Oznacza to, Å¼e zewnÄ™trzne rozszerzenie ma peÅ‚ny dostÄ™p do odczytu i zapisu pamiÄ™ci heap Rapid, zgodnie z projektem.**

Co wiÄ™cej, chociaÅ¼ rozszerzenia Lambda majÄ… moÅ¼liwoÅ›Ä‡ **subskrybowania zdarzeÅ„ wywoÅ‚ania**, AWS nie ujawnia surowych danych tym rozszerzeniom. To zapewnia, Å¼e **rozszerzenia nie mogÄ… uzyskaÄ‡ dostÄ™pu do wraÅ¼liwych informacji** przesyÅ‚anych za poÅ›rednictwem Å¼Ä…dania HTTP.

Proces Init (Rapid) monitoruje wszystkie Å¼Ä…dania API pod adresem [http://127.0.0.1:9001](http://127.0.0.1:9001/) podczas gdy rozszerzenia Lambda sÄ… inicjowane i uruchamiane przed wykonaniem jakiegokolwiek kodu runtime, ale po Rapid.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

Zmienna **`AWS_LAMBDA_RUNTIME_API`** wskazuje **IP** i **port** API Rapid dla **child runtime processes** i dodatkowych rozszerzeÅ„.

{% hint style="warning" %}
ZmieniajÄ…c zmiennÄ… Å›rodowiskowÄ… **`AWS_LAMBDA_RUNTIME_API`** na **`port`**, do ktÃ³rego mamy dostÄ™p, moÅ¼liwe jest przechwycenie wszystkich dziaÅ‚aÅ„ w Å›rodowisku uruchomieniowym Lambda (**man-in-the-middle**). Jest to moÅ¼liwe, poniewaÅ¼ rozszerzenie dziaÅ‚a z tymi samymi uprawnieniami co Rapid Init, a kernel systemu pozwala na **modyfikacjÄ™ pamiÄ™ci procesÃ³w**, umoÅ¼liwiajÄ…c zmianÄ™ numeru portu.
{% endhint %}

PoniewaÅ¼ **rozszerzenia uruchamiajÄ… siÄ™ przed jakimkolwiek kodem runtime**, modyfikacja zmiennej Å›rodowiskowej wpÅ‚ynie na proces runtime (np. Python, Java, Node, Ruby) podczas jego uruchamiania. Co wiÄ™cej, **rozszerzenia zaÅ‚adowane po** naszym, ktÃ³re polegajÄ… na tej zmiennej, rÃ³wnieÅ¼ bÄ™dÄ… kierowane przez nasze rozszerzenie. Ta konfiguracja moÅ¼e umoÅ¼liwiÄ‡ zÅ‚oÅ›liwemu oprogramowaniu caÅ‚kowite obejÅ›cie Å›rodkÃ³w bezpieczeÅ„stwa lub rozszerzeÅ„ logowania bezpoÅ›rednio w Å›rodowisku uruchomieniowym.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

NarzÄ™dzie [**lambda-spy**](https://github.com/clearvector/lambda-spy) zostaÅ‚o stworzone do wykonywania tego **zapisu pamiÄ™ci** i **kradzieÅ¼y wraÅ¼liwych informacji** z Å¼Ä…daÅ„ lambda, innych **rozszerzeÅ„** **Å¼Ä…daÅ„** a nawet **modyfikowania ich**.

## References

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
