# AWS - Lambda Persistence

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda

Για περισσότερες πληροφορίες ελέγξτε:

{% content-ref url="../../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistence

Είναι δυνατόν να **εισαγάγετε/πίσω πόρτα μια layer για να εκτελέσετε αυθαίρετο κώδικα** όταν η lambda εκτελείται με stealth τρόπο:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension Persistence

Καταχρώντας τις Lambda Layers είναι επίσης δυνατό να καταχραστείτε τις επεκτάσεις και να παραμείνετε στη lambda αλλά και να κλέψετε και να τροποποιήσετε αιτήματα.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### Via resource policies

Είναι δυνατόν να παραχωρήσετε πρόσβαση σε διαφορετικές ενέργειες lambda (όπως invoke ή update code) σε εξωτερικούς λογαριασμούς:

<figure><img src="../../../../.gitbook/assets/image (2) (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

Μια Lambda μπορεί να έχει **διαφορετικές εκδόσεις** (με διαφορετικό κώδικα κάθε έκδοση).\
Στη συνέχεια, μπορείτε να δημιουργήσετε **διαφορετικά ψευδώνυμα με διαφορετικές εκδόσεις** της lambda και να ορίσετε διαφορετικά βάρη σε κάθε μία.\
Με αυτόν τον τρόπο, ένας επιτιθέμενος θα μπορούσε να δημιουργήσει μια **πίσω πόρτα έκδοση 1** και μια **έκδοση 2 με μόνο τον νόμιμο κώδικα** και **να εκτελεί μόνο την έκδοση 1 στο 1%** των αιτημάτων για να παραμείνει stealth.

<figure><img src="../../../../.gitbook/assets/image (2) (2).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Αντιγράψτε τον αρχικό κώδικα της Lambda
2. **Δημιουργήστε μια νέα έκδοση πίσω πόρτας** του αρχικού κώδικα (ή απλώς με κακόβουλο κώδικα). Δημοσιεύστε και **αναπτύξτε αυτήν την έκδοση** στο $LATEST
1. Καλέστε την πύλη API που σχετίζεται με τη lambda για να εκτελέσετε τον κώδικα
3. **Δημιουργήστε μια νέα έκδοση με τον αρχικό κώδικα**, Δημοσιεύστε και αναπτύξτε αυτήν την **έκδοση** στο $LATEST.
1. Αυτό θα κρύψει τον κώδικα πίσω πόρτας σε μια προηγούμενη έκδοση
4. Μεταβείτε στην πύλη API και **δημιουργήστε μια νέα μέθοδο POST** (ή επιλέξτε οποιαδήποτε άλλη μέθοδο) που θα εκτελεί την έκδοση πίσω πόρτας της lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Σημειώστε το τελικό :1 του arn **που υποδεικνύει την έκδοση της συνάρτησης** (η έκδοση 1 θα είναι η πίσω πόρτα σε αυτό το σενάριο).
5. Επιλέξτε τη μέθοδο POST που δημιουργήθηκε και στις Ενέργειες επιλέξτε **`Deploy API`**
6. Τώρα, όταν **καλέσετε τη συνάρτηση μέσω POST η Πίσω Πόρτα σας** θα κληθεί

### Cron/Event actuator

Το γεγονός ότι μπορείτε να κάνετε **συναρτήσεις lambda να εκτελούνται όταν συμβαίνει κάτι ή όταν περνάει κάποιος χρόνος** καθιστά τη lambda έναν ωραίο και κοινό τρόπο για να αποκτήσετε επιμονή και να αποφύγετε την ανίχνευση.\
Εδώ έχετε μερικές ιδέες για να κάνετε την **παρουσία σας στο AWS πιο stealth δημιουργώντας lambdas**.

* Κάθε φορά που δημιουργείται ένας νέος χρήστης, η lambda δημιουργεί ένα νέο κλειδί χρήστη και το στέλνει στον επιτιθέμενο.
* Κάθε φορά που δημιουργείται ένας νέος ρόλος, η lambda δίνει δικαιώματα ανάληψης ρόλου σε συμβιβασμένους χρήστες.
* Κάθε φορά που δημιουργούνται νέα logs cloudtrail, διαγράψτε/τροποποιήστε τα

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
