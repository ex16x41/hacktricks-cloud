# GCP - Enumeraci贸n de Cloud Functions

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Cloud Functions <a href="#reviewing-cloud-functions" id="reviewing-cloud-functions"></a>

[Google Cloud Functions](https://cloud.google.com/functions/) est谩n dise帽adas para alojar tu c贸digo, que **se ejecuta en respuesta a eventos**, sin necesidad de gestionar un sistema operativo anfitri贸n. Adem谩s, estas funciones admiten el almacenamiento de variables de entorno, que el c贸digo puede utilizar.

### Almacenamiento

El **c贸digo de Cloud Functions se almacena en GCP Storage**. Por lo tanto, cualquier persona con **acceso de lectura sobre los buckets** en GCP podr谩 **leer el c贸digo de las Cloud Functions**.\
El c贸digo se almacena en un bucket como uno de los siguientes:

* `gcf-sources-<n煤mero>-<regi贸n>/<nombre-de-la-funci贸n>-<uuid>/versi贸n-<n>/function-source.zip`
* `gcf-v2-sources-<n煤mero>-<regi贸n>/<nombre-de-la-funci贸n>function-source.zip`

Por ejemplo:\
`gcf-sources-645468741258-us-central1/function-1-003dcbdf-32e1-430f-a5ff-785a6e238c76/version-4/function-source.zip`

{% hint style="warning" %}
Cualquier usuario con **privilegios de lectura sobre el bucket** que almacena la Cloud Function podr铆a **leer el c贸digo ejecutado**.
{% endhint %}

### Registro de Artefactos

Si la funci贸n en la nube est谩 configurada para que el contenedor Docker ejecutado se almacene dentro de un repositorio de Artifact Registry dentro del proyecto, cualquier persona con acceso de lectura sobre el repositorio podr谩 descargar la imagen y revisar el c贸digo fuente. Para m谩s informaci贸n, consulta:

{% content-ref url="gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### SA

Si no se especifica, por defecto se adjuntar谩 la **Cuenta de Servicio Predeterminada de App Engine** con **permisos de Editor** sobre el proyecto a la Cloud Function.

### Disparadores, URL y Autenticaci贸n

Cuando se crea una Cloud Function, se necesita especificar el **disparador**. Uno com煤n es **HTTPS**, esto **crear谩 una URL donde la funci贸n** puede ser activada a trav茅s de la navegaci贸n web.\
Otros disparadores son pub/sub, Storage, Filestore...

El formato de la URL es **`https://<regi贸n>-<nombre-del-proyecto-gcp>.cloudfunctions.net/<func_name>`**

Cuando se utiliza el disparador HTTPS, tambi茅n se indica si el **llamador necesita tener autorizaci贸n IAM** para llamar a la funci贸n o si **cualquiera** puede simplemente llamarla:

<figure><img src="../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

### Dentro de la Cloud Function

El c贸digo se **descarga dentro** de la carpeta **`/workspace`** con los mismos nombres de archivo que tienen los archivos en la Cloud Function y se ejecuta con el usuario `www-data`.\
El disco **no est谩 montado como solo lectura.**

### Enumeraci贸n
```bash
# List functions
gcloud functions list
gcloud functions describe <func_name> # Check triggers to see how is this function invoked
gcloud functions get-iam-policy <func_name>

# Get logs of previous runs. By default, limits to 10 lines
gcloud functions logs read <func_name> --limit [NUMBER]

# Call a function
curl https://<region>-<project>.cloudfunctions.net/<func_name>
gcloud functions call <func_name> --data='{"message": "Hello World!"}'

# If you know the name of projects you could try to BF cloud functions names

# Get events that could be used to trigger a cloud function
gcloud functions event-types list

# Access function with authentication
curl -X POST https://<region>-<project>.cloudfunctions.net/<func_name> \
-H "Authorization: bearer $(gcloud auth print-identity-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
### Escalamiento de Privilegios

En la siguiente p谩gina, puedes verificar c贸mo **abusar de los permisos de las funciones en la nube para escalar privilegios**:

{% content-ref url="../gcp-privilege-escalation/gcp-cloudfunctions-privesc.md" %}
[gcp-cloudfunctions-privesc.md](../gcp-privilege-escalation/gcp-cloudfunctions-privesc.md)
{% endcontent-ref %}

### Acceso No Autenticado

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-cloud-functions-unauthenticated-enum.md" %}
[gcp-cloud-functions-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-cloud-functions-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Explotaci贸n

{% content-ref url="../gcp-post-exploitation/gcp-cloud-functions-post-exploitation.md" %}
[gcp-cloud-functions-post-exploitation.md](../gcp-post-exploitation/gcp-cloud-functions-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../gcp-persistence/gcp-cloud-functions-persistence.md" %}
[gcp-cloud-functions-persistence.md](../gcp-persistence/gcp-cloud-functions-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
