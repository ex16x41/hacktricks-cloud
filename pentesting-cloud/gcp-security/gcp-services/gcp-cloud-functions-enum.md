# GCP - Cloud Functions Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Cloud Functions <a href="#reviewing-cloud-functions" id="reviewing-cloud-functions"></a>

[Google Cloud Functions](https://cloud.google.com/functions/) είναι σχεδιασμένες για να φιλοξενούν τον κώδικά σας, ο οποίος **εκτελείται ως απάντηση σε γεγονότα**, χωρίς να απαιτείται η διαχείριση ενός λειτουργικού συστήματος. Επιπλέον, αυτές οι λειτουργίες υποστηρίζουν την αποθήκευση μεταβλητών περιβάλλοντος, τις οποίες μπορεί να χρησιμοποιήσει ο κώδικας.

### Storage

Ο κώδικας των Cloud Functions **αποθηκεύεται στο GCP Storage**. Επομένως, οποιοσδήποτε έχει **δικαιώματα ανάγνωσης στους κάδους** στο GCP θα μπορεί να **διαβάσει τον κώδικα των Cloud Functions**.\
Ο κώδικας αποθηκεύεται σε έναν κάδο όπως ένας από τους παρακάτω:

* `gcf-sources-<number>-<region>/<function-name>-<uuid>/version-<n>/function-source.zip`
* `gcf-v2-sources-<number>-<region>/<function-name>function-source.zip`

Για παράδειγμα:\
`gcf-sources-645468741258-us-central1/function-1-003dcbdf-32e1-430f-a5ff-785a6e238c76/version-4/function-source.zip`

{% hint style="warning" %}
Οποιοσδήποτε χρήστης με **δικαιώματα ανάγνωσης στον κάδο** που αποθηκεύει την Cloud Function θα μπορούσε να **διαβάσει τον εκτελούμενο κώδικα**.
{% endhint %}

### Artifact Registry

Εάν η cloud function είναι ρυθμισμένη έτσι ώστε το εκτελούμενο Docker container να αποθηκεύεται μέσα σε ένα Artifact Registry repo εντός του έργου, οποιοσδήποτε με δικαιώματα ανάγνωσης στο repo θα μπορεί να κατεβάσει την εικόνα και να ελέγξει τον πηγαίο κώδικα. Για περισσότερες πληροφορίες δείτε:

{% content-ref url="gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### SA

Εάν δεν καθοριστεί, από προεπιλογή ο **App Engine Default Service Account** με **δικαιώματα Editor** πάνω στο έργο θα συσχετιστεί με την Cloud Function.

### Triggers, URL & Authentication

Όταν δημιουργείται μια Cloud Function, πρέπει να καθοριστεί το **trigger**. Ένα κοινό είναι το **HTTPS**, αυτό θα **δημιουργήσει μια διεύθυνση URL όπου η λειτουργία** μπορεί να ενεργοποιηθεί μέσω περιήγησης στο διαδίκτυο.\
Άλλοι triggers είναι pub/sub, Storage, Filestore...

Η μορφή της διεύθυνσης URL είναι **`https://<region>-<project-gcp-name>.cloudfunctions.net/<func_name>`**

Όταν χρησιμοποιείται το trigger HTTPS, υποδεικνύεται επίσης αν ο **καλούν χρειάζεται να έχει εξουσιοδότηση IAM** για να καλέσει τη λειτουργία ή αν **ο καθένας** μπορεί απλώς να την καλέσει:

<figure><img src="../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

### Inside the Cloud Function

Ο κώδικας **κατεβαίνει μέσα** στον φάκελο **`/workspace`** με τα ίδια ονόματα αρχείων όπως αυτά που έχουν τα αρχεία στην Cloud Function και εκτελείται με τον χρήστη `www-data`.\
Ο δίσκος **δεν είναι προσαρτημένος ως μόνο για ανάγνωση.**

### Enumeration
```bash
# List functions
gcloud functions list
gcloud functions describe <func_name> # Check triggers to see how is this function invoked
gcloud functions get-iam-policy <func_name>

# Get logs of previous runs. By default, limits to 10 lines
gcloud functions logs read <func_name> --limit [NUMBER]

# Call a function
curl https://<region>-<project>.cloudfunctions.net/<func_name>
gcloud functions call <func_name> --data='{"message": "Hello World!"}'

# If you know the name of projects you could try to BF cloud functions names

# Get events that could be used to trigger a cloud function
gcloud functions event-types list

# Access function with authentication
curl -X POST https://<region>-<project>.cloudfunctions.net/<func_name> \
-H "Authorization: bearer $(gcloud auth print-identity-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
### Ανάβαση Δικαιωμάτων

In the following page, you can check how to **abuse cloud function permissions to escalate privileges**:

{% content-ref url="../gcp-privilege-escalation/gcp-cloudfunctions-privesc.md" %}
[gcp-cloudfunctions-privesc.md](../gcp-privilege-escalation/gcp-cloudfunctions-privesc.md)
{% endcontent-ref %}

### Μη Αυθεντικοποιημένη Πρόσβαση

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-cloud-functions-unauthenticated-enum.md" %}
[gcp-cloud-functions-unauthenticated-enum.md](../gcp-unauthenticated-enum-and-access/gcp-cloud-functions-unauthenticated-enum.md)
{% endcontent-ref %}

### Μετά την Εκμετάλλευση

{% content-ref url="../gcp-post-exploitation/gcp-cloud-functions-post-exploitation.md" %}
[gcp-cloud-functions-post-exploitation.md](../gcp-post-exploitation/gcp-cloud-functions-post-exploitation.md)
{% endcontent-ref %}

### Επιμονή

{% content-ref url="../gcp-persistence/gcp-cloud-functions-persistence.md" %}
[gcp-cloud-functions-persistence.md](../gcp-persistence/gcp-cloud-functions-persistence.md)
{% endcontent-ref %}

## Αναφορές

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
