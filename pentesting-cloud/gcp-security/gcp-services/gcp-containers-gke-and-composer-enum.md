# GCP - ì»¨í…Œì´ë„ˆ ë° GKE ì—´ê±°

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}

## ì»¨í…Œì´ë„ˆ

GCP ì»¨í…Œì´ë„ˆì—ì„œëŠ” GCPê°€ ì œê³µí•˜ëŠ” ëŒ€ë¶€ë¶„ì˜ ì»¨í…Œì´ë„ˆ ê¸°ë°˜ ì„œë¹„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, ì—¬ê¸°ì—ì„œ ê°€ì¥ ì¼ë°˜ì ì¸ ê²ƒë“¤ì„ ì—´ê±°í•˜ëŠ” ë°©ë²•ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
gcloud container images list
gcloud container images list --repository us.gcr.io/<project-name> #Search in other subdomains repositories
gcloud container images describe <name>
gcloud container subnets list-usable
gcloud container clusters list
gcloud container clusters describe <name>
gcloud container clusters get-credentials [NAME]

# Run a container locally
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh

# Login & Download
sudo docker login -u oauth2accesstoken -p $(gcloud auth print-access-token) https://HOSTNAME
## where HOSTNAME is gcr.io, us.gcr.io, eu.gcr.io, or asia.gcr.io.
sudo docker pull HOSTNAME/<project-name>/<image-name>
```
### Privesc

ë‹¤ìŒ í˜ì´ì§€ì—ì„œ **ì»¨í…Œì´ë„ˆ ê¶Œí•œì„ ì•…ìš©í•˜ì—¬ ê¶Œí•œ ìƒìŠ¹**í•˜ëŠ” ë°©ë²•ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

## Node Pools

ì´ê²ƒì€ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ë¥¼ í˜•ì„±í•˜ëŠ” ë¨¸ì‹ (ë…¸ë“œ)ì˜ í’€ì…ë‹ˆë‹¤.
```bash
# Pool of machines used by the cluster
gcloud container node-pools list --zone <zone> --cluster <cluster>
gcloud container node-pools describe --cluster <cluster> --zone <zone> <node-pool>
```
## Kubernetes

Kubernetesì— ëŒ€í•œ ì •ë³´ëŠ” ì´ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../../kubernetes-security/" %}
[kubernetes-security](../../kubernetes-security/)
{% endcontent-ref %}

ë¨¼ì €, í”„ë¡œì íŠ¸ì— Kubernetes í´ëŸ¬ìŠ¤í„°ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
gcloud container clusters list
```
í´ëŸ¬ìŠ¤í„°ê°€ ìˆëŠ” ê²½ìš°, `gcloud`ê°€ `~/.kube/config` íŒŒì¼ì„ ìë™ìœ¼ë¡œ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ íŒŒì¼ì€ K8s í´ëŸ¬ìŠ¤í„°ì™€ ìƒí˜¸ ì‘ìš©í•˜ê¸° ìœ„í•œ ê¸°ë³¸ CLIì¸ [kubectl](https://kubernetes.io/docs/reference/kubectl/overview/)ì„ ì‚¬ìš©í•  ë•Œ ì¸ì¦í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ëª…ë ¹ì„ ì‹œë„í•´ ë³´ì„¸ìš”.
```
gcloud container clusters get-credentials [CLUSTER NAME] --region [REGION]
```
ê·¸ëŸ° ë‹¤ìŒ `~/.kube/config` íŒŒì¼ì„ í™•ì¸í•˜ì—¬ ìƒì„±ëœ ìê²© ì¦ëª…ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤. ì´ íŒŒì¼ì€ í™œì„± `gcloud` ì„¸ì…˜ì´ ì‚¬ìš©í•˜ëŠ” ë™ì¼í•œ IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•¡ì„¸ìŠ¤ í† í°ì„ ìë™ìœ¼ë¡œ ìƒˆë¡œ ê³ ì¹˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ë¬¼ë¡  ì´ë¥¼ ìœ„í•´ì„œëŠ” ì˜¬ë°”ë¥¸ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.

ì´ ì„¤ì •ì´ ì™„ë£Œë˜ë©´ í´ëŸ¬ìŠ¤í„° êµ¬ì„±ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ë‹¤ìŒ ëª…ë ¹ì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
kubectl cluster-info
```
You can read more about `gcloud` for containers [here](https://cloud.google.com/sdk/gcloud/reference/container/).

This is a simple script to enumerate kubernetes in GCP: [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_k8s\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_k8s\_enum)

### TLS Boostrap Privilege Escalation

Initially this privilege escalation technique allowed to **privesc inside the GKE cluster** effectively allowing an attacker to **fully compromise it**.

This is because GKE provides [TLS Bootstrap credentials](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/) in the metadata, which is **accessible by anyone by just compromising a pod**.

The technique used is explained in the following posts:

* [https://www.4armed.com/blog/hacking-kubelet-on-gke/](https://www.4armed.com/blog/hacking-kubelet-on-gke/)
* [https://www.4armed.com/blog/kubeletmein-kubelet-hacking-tool/](https://www.4armed.com/blog/kubeletmein-kubelet-hacking-tool/)
* [https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/)

Ans this tool was created to automate the process: [https://github.com/4ARMED/kubeletmein](https://github.com/4ARMED/kubeletmein)

However, the technique abused the fact that **with the metadata credentials** it was possible to **generate a CSR** (Certificate Signing Request) for a **new node**, which was **automatically approved**.\
In my test I checked that **those requests aren't automatically approved anymore**, so I'm not sure if this technique is still valid.

### Secrets in Kubelet API <a href="#the-kubelet-api-git-secrets-redux" id="the-kubelet-api-git-secrets-redux"></a>

In [**this post**](https://blog.assetnote.io/2022/05/06/cloudflare-pages-pt3/) it was discovered it was discovered a Kubelet API address accesible from inside a pod in GKE giving the details of the pods running:
```
curl -v -k http://10.124.200.1:10255/pods
```
APIê°€ **ë¦¬ì†ŒìŠ¤ë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì„ í—ˆìš©í•˜ì§€ ì•Šë”ë¼ë„**, ì‘ë‹µì—ì„œ **ë¯¼ê°í•œ ì •ë³´**ë¥¼ ì°¾ì„ ìˆ˜ ìˆì„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤. /pods ì—”ë“œí¬ì¸íŠ¸ëŠ” [**Kiterunner**](https://github.com/assetnote/kiterunner)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
