# GCP - Compute Enum

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## GCP VPC & Networking

Aprende sobre c칩mo funciona esto en:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeraci칩n

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Encuentras f치cilmente instancias de c칩mputo con reglas de firewall abiertas con [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Compute instances

Esta es la forma en que puedes **ejecutar m치quinas virtuales dentro de GCP.** Consulta esta p치gina para m치s informaci칩n:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Para obtener m치s informaci칩n sobre c칩mo **SSH** o **modificar los metadatos** de una instancia para **escalar privilegios**, consulta esta p치gina:

{% content-ref url="../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Escalaci칩n de Privilegios

En la siguiente p치gina, puedes ver c칩mo **abusar de los permisos de compute para escalar privilegios**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Enumeraci칩n No Autenticada

{% content-ref url="../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Explotaci칩n

{% content-ref url="../../gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../../gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Registros de la Consola Serial

Los Registros de la Consola Serial de Compute Engine son una caracter칤stica que te permite **ver y diagnosticar los registros de arranque y del sistema operativo** de tus instancias de m치quinas virtuales.

Los Registros de la Consola Serial proporcionan una **vista de bajo nivel del proceso de arranque de la instancia**, incluyendo mensajes del kernel, scripts de inicio y otros eventos del sistema que ocurren durante el arranque. Esto puede ser 칰til para depurar problemas de arranque, identificar configuraciones incorrectas o errores de software, o solucionar problemas de conectividad de red.

Estos registros **pueden exponer informaci칩n sensible** de los registros del sistema que un usuario con bajos privilegios normalmente no ver칤a, pero con los permisos adecuados de IAM podr칤as leerlos.

Puedes usar el siguiente [comando gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) para consultar los registros del puerto serial (el permiso requerido es `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Startup Scripts output

Es posible ver la **salida de los scripts de inicio** desde la VM ejecutando:
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

Puedes usar el servicio de gesti칩n de configuraci칩n del sistema operativo para **desplegar, consultar y mantener configuraciones consistentes** (estado deseado y software) para tu instancia de VM (VM). En Compute Engine, debes usar [guest policies](https://cloud.google.com/compute/docs/os-config-management#guest-policy) para mantener configuraciones de software consistentes en una VM.

La caracter칤stica de gesti칩n de configuraci칩n del sistema operativo te permite definir pol칤ticas de configuraci칩n que especifican qu칠 paquetes de software deben instalarse, qu칠 servicios deben habilitarse y qu칠 archivos o configuraciones deben estar presentes en tus VMs. Puedes usar un enfoque declarativo para gestionar la configuraci칩n del software de tus VMs, lo que te permite automatizar y escalar tu proceso de gesti칩n de configuraci칩n m치s f치cilmente.

Esto tambi칠n permite iniciar sesi칩n en instancias a trav칠s de permisos de IAM, por lo que es muy **칰til para privesc y pivoting**.

{% hint style="warning" %}
Para **habilitar os-config en todo un proyecto o en una instancia** solo necesitas establecer la clave de **metadata** **`enable-oslogin`** a **`true`** en el nivel deseado.\
Adem치s, puedes establecer la metadata **`enable-oslogin-2fa`** a **`true`** para habilitar el 2fa.

Cuando lo habilitas al crear una instancia, las claves de metadata se establecer치n autom치ticamente.
{% endhint %}

M치s sobre **2fa en OS-config**, **solo se aplica si el usuario es un usuario**, si es un SA (como el compute SA) no requerir치 nada extra.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Im치genes

### Im치genes Personalizadas

**Las im치genes personalizadas de c칩mputo pueden contener detalles sensibles** u otras configuraciones vulnerables que puedes explotar.

Cuando se crea una imagen, puedes elegir **3 tipos de encriptaci칩n**: Usando **clave gestionada por Google** (predeterminado), una **clave de KMS**, o una **clave en bruto** proporcionada por el cliente.

#### Enumeraci칩n

Puedes consultar la lista de im치genes no est치ndar en un proyecto con el siguiente comando:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Luego puedes [**exportar**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **los discos virtuales** de cualquier imagen en m칰ltiples formatos. El siguiente comando exportar칤a la imagen `test-image` en formato qcow2, permiti칠ndote descargar el archivo y construir una VM localmente para una investigaci칩n adicional:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Escalada de Privilegios

Consulta la secci칩n de escalada de privilegios de Compute Instances.

### Plantillas de Instancia Personalizadas

Una [**plantilla de instancia**](https://cloud.google.com/compute/docs/instance-templates/) **define propiedades de instancia** para ayudar a desplegar configuraciones consistentes. Estas pueden contener los mismos tipos de datos sensibles que los metadatos personalizados de una instancia en ejecuci칩n. Puedes usar los siguientes comandos para investigar:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Podr칤a ser interesante saber qu칠 disco est치n usando las nuevas im치genes, pero estas plantillas usualmente no tendr치n informaci칩n sensible.

## Snapshots

Los **snapshots son copias de seguridad de discos**. Ten en cuenta que esto no es lo mismo que clonar un disco (otra caracter칤stica disponible).\
El **snapshot** usar치 el **mismo cifrado que el disco** del cual se tom칩.

### Enumeraci칩n
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Escalada de Privilegios

Consulta la secci칩n de escalada de privilegios de Compute Instances.

## Referencias

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
