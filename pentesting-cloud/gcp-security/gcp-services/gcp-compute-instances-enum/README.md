# GCP - Compute Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## GCP VPC & Networking

Μάθετε πώς λειτουργεί αυτό στο:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeration

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Μπορείτε εύκολα να βρείτε υπολογιστικές παρουσίες με ανοιχτούς κανόνες τείχους προστασίας με [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Υπολογιστικές παρουσίες

Αυτή είναι η μέθοδος για να **τρέξετε εικονικές μηχανές μέσα στο GCP.** Ελέγξτε αυτή τη σελίδα για περισσότερες πληροφορίες:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Αριθμητική
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Για περισσότερες πληροφορίες σχετικά με το πώς να **SSH** ή να **τροποποιήσετε τα μεταδεδομένα** μιας παρουσίας για να **κλιμακώσετε τα δικαιώματα,** ελέγξτε αυτή τη σελίδα:

{% content-ref url="../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Κλιμάκωση Δικαιωμάτων

Στην επόμενη σελίδα, μπορείτε να ελέγξετε πώς να **καταχραστείτε τις άδειες υπολογιστή για να κλιμακώσετε τα δικαιώματα**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Μη Αυθεντικοποιημένη Enum

{% content-ref url="../../gcp-unauthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../gcp-unauthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Μετά την Εκμετάλλευση

{% content-ref url="../../gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Επιμονή

{% content-ref url="../../gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Καταγραφές Σειριακής Κονσόλας

Οι Καταγραφές Σειριακής Κονσόλας του Compute Engine είναι μια δυνατότητα που σας επιτρέπει να **δείτε και να διαγνώσετε τα αρχεία καταγραφής εκκίνησης και λειτουργικού συστήματος** των εικονικών μηχανών σας.

Οι Καταγραφές Σειριακής Κονσόλας παρέχουν μια **χαμηλού επιπέδου άποψη της διαδικασίας εκκίνησης της παρουσίας**, συμπεριλαμβανομένων των μηνυμάτων πυρήνα, των σεναρίων init και άλλων συστημικών γεγονότων που συμβαίνουν κατά την εκκίνηση. Αυτό μπορεί να είναι χρήσιμο για την αποσφαλμάτωση προβλημάτων εκκίνησης, την αναγνώριση κακών ρυθμίσεων ή σφαλμάτων λογισμικού, ή την επίλυση προβλημάτων συνδεσιμότητας δικτύου.

Αυτές οι καταγραφές **μπορεί να εκθέσουν ευαίσθητες πληροφορίες** από τα αρχεία καταγραφής του συστήματος που οι χρήστες με χαμηλά δικαιώματα συνήθως δεν βλέπουν, αλλά με τις κατάλληλες άδειες IAM μπορεί να είστε σε θέση να τις διαβάσετε.

Μπορείτε να χρησιμοποιήσετε την παρακάτω [εντολή gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) για να ερωτήσετε τις καταγραφές σειριακής θύρας (η απαιτούμενη άδεια είναι `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Startup Scripts output

Είναι δυνατή η προβολή της **έξοδου των startup scripts** από το VM που εκτελεί:
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

Μπορείτε να χρησιμοποιήσετε την υπηρεσία διαχείρισης ρυθμίσεων OS για να **αναπτύξετε, ερωτήσετε και διατηρήσετε συνεπείς ρυθμίσεις** (επιθυμητή κατάσταση και λογισμικό) για την VM instance (VM) σας. Στο Compute Engine, πρέπει να χρησιμοποιήσετε [guest policies](https://cloud.google.com/compute/docs/os-config-management#guest-policy) για να διατηρήσετε συνεπείς ρυθμίσεις λογισμικού σε μια VM.

Η δυνατότητα διαχείρισης ρυθμίσεων OS σας επιτρέπει να ορίσετε πολιτικές ρυθμίσεων που καθορίζουν ποια πακέτα λογισμικού θα πρέπει να είναι εγκατεστημένα, ποιες υπηρεσίες θα πρέπει να είναι ενεργοποιημένες και ποια αρχεία ή ρυθμίσεις θα πρέπει να είναι παρόντα στις VMs σας. Μπορείτε να χρησιμοποιήσετε μια δηλωτική προσέγγιση για τη διαχείριση της ρύθμισης λογισμικού των VMs σας, η οποία σας επιτρέπει να αυτοματοποιήσετε και να κλιμακώσετε τη διαδικασία διαχείρισης ρυθμίσεων πιο εύκολα.

Αυτό επιτρέπει επίσης την είσοδο σε instances μέσω IAM permissions, οπότε είναι πολύ **χρήσιμο για privesc και pivoting**.

{% hint style="warning" %}
Για να **ενεργοποιήσετε το os-config σε ολόκληρο το έργο ή σε μια instance** χρειάζεται απλώς να ορίσετε το **metadata** key **`enable-oslogin`** σε **`true`** στο επιθυμητό επίπεδο.\
Επιπλέον, μπορείτε να ορίσετε το metadata **`enable-oslogin-2fa`** σε **`true`** για να ενεργοποιήσετε το 2fa.

Όταν το ενεργοποιήσετε κατά τη δημιουργία μιας instance, τα metadata keys θα ρυθμιστούν αυτόματα.
{% endhint %}

Περισσότερα για **2fa στο OS-config**, **ισχύει μόνο αν ο χρήστης είναι χρήστης**, αν είναι SA (όπως ο compute SA) δεν θα απαιτεί τίποτα επιπλέον.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Images

### Custom Images

**Οι προσαρμοσμένες εικόνες υπολογιστή μπορεί να περιέχουν ευαίσθητες λεπτομέρειες** ή άλλες ευάλωτες ρυθμίσεις που μπορείτε να εκμεταλλευτείτε.

Όταν δημιουργείται μια εικόνα, μπορείτε να επιλέξετε **3 τύπους κρυπτογράφησης**: Χρησιμοποιώντας **κλειδί που διαχειρίζεται η Google** (προεπιλογή), ένα **κλειδί από το KMS**, ή ένα **ακατέργαστο κλειδί** που παρέχεται από τον πελάτη.

#### Enumeration

Μπορείτε να ερωτήσετε τη λίστα των μη τυπικών εικόνων σε ένα έργο με την παρακάτω εντολή:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Μπορείτε στη συνέχεια να [**εξάγετε**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **τους εικονικούς δίσκους** από οποιαδήποτε εικόνα σε πολλαπλές μορφές. Η παρακάτω εντολή θα εξάγει την εικόνα `test-image` σε μορφή qcow2, επιτρέποντάς σας να κατεβάσετε το αρχείο και να δημιουργήσετε μια VM τοπικά για περαιτέρω έρευνα:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Privilege Escalation

Ελέγξτε την ενότητα εκμετάλλευσης δικαιωμάτων των Compute Instances.

### Custom Instance Templates

Ένα [**instance template**](https://cloud.google.com/compute/docs/instance-templates/) **ορίζει τις ιδιότητες του instance** για να βοηθήσει στην ανάπτυξη συνεπών ρυθμίσεων. Αυτά μπορεί να περιέχουν τους ίδιους τύπους ευαίσθητων δεδομένων όπως τα προσαρμοσμένα μεταδεδομένα ενός εκτελούμενου instance. Μπορείτε να χρησιμοποιήσετε τις παρακάτω εντολές για να ερευνήσετε:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Θα ήταν ενδιαφέρον να γνωρίζουμε ποιο δίσκο χρησιμοποιούν οι νέες εικόνες, αλλά αυτά τα πρότυπα συνήθως δεν θα έχουν ευαίσθητες πληροφορίες.

## Snapshots

Οι **snapshots είναι αντίγραφα ασφαλείας δίσκων**. Σημειώστε ότι αυτό δεν είναι το ίδιο με την κλωνοποίηση ενός δίσκου (μια άλλη διαθέσιμη δυνατότητα).\
Ο **snapshot** θα χρησιμοποιήσει την **ίδια κρυπτογράφηση με τον δίσκο** από τον οποίο έχει ληφθεί.

### Enumeration
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Ανάβαση Δικαιωμάτων

Ελέγξτε την ενότητα ανάβασης δικαιωμάτων των Compute Instances.

## Αναφορές

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
