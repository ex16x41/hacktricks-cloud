# GCP - Compute Enum

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

## GCP VPC & Networking

Dowiedz si, jak to dziaa w:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeracja

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

atwo znajdziesz instancje obliczeniowe z otwartymi reguami zapory za pomoc [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Instancje obliczeniowe

To jest spos贸b, w jaki mo偶esz **uruchomi maszyny wirtualne w GCP.** Sprawd藕 t stron, aby uzyska wicej informacji:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeracja
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Aby uzyska wicej informacji na temat tego, jak **SSH** lub **zmodyfikowa metadane** instancji w celu **eskalacji uprawnie**, sprawd藕 t stron:

{% content-ref url="../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Eskalacja uprawnie

Na nastpnej stronie mo偶esz sprawdzi, jak **nadu偶ywa uprawnie obliczeniowych, aby eskalowa uprawnienia**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Niena uwierzytelniona enumeracja

{% content-ref url="../../gcp-unauthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../gcp-unauthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Po eksploatacji

{% content-ref url="../../gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Utrzymywanie

{% content-ref url="../../gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Logi konsoli szeregowej

Logi konsoli szeregowej Compute Engine to funkcja, kt贸ra pozwala na **wywietlanie i diagnozowanie log贸w rozruchu i systemu operacyjnego** twoich instancji maszyny wirtualnej.

Logi konsoli szeregowej zapewniaj **niski poziom widoku procesu rozruchu instancji**, w tym komunikaty jdra, skrypty inicjalizacyjne i inne zdarzenia systemowe, kt贸re wystpuj podczas uruchamiania. Mo偶e to by przydatne do debugowania problem贸w z rozruchem, identyfikowania bdnych konfiguracji lub bd贸w oprogramowania, lub rozwizywania problem贸w z cznoci sieciow.

Te logi **mog ujawnia wra偶liwe informacje** z log贸w systemowych, kt贸re u偶ytkownik o niskich uprawnieniach zazwyczaj nie widzi, ale z odpowiednimi uprawnieniami IAM mo偶esz by w stanie je odczyta.

Mo偶esz u偶y nastpujcego [polecenia gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output), aby zapyta o logi portu szeregowego (wymagane uprawnienie to `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Startup Scripts output

Mo偶liwe jest zobaczenie **wyjcia skrypt贸w startowych** z VM wykonujc:
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

Mo偶esz u偶y usugi zarzdzania konfiguracj systemu operacyjnego, aby **wdra偶a, zapytywa i utrzymywa sp贸jne konfiguracje** (po偶dany stan i oprogramowanie) dla swojej instancji VM (maszyny wirtualnej). W Compute Engine musisz u偶ywa [polityk goci](https://cloud.google.com/compute/docs/os-config-management#guest-policy), aby utrzyma sp贸jne konfiguracje oprogramowania na VM.

Funkcja zarzdzania konfiguracj systemu operacyjnego pozwala na definiowanie polityk konfiguracji, kt贸re okrelaj, kt贸re pakiety oprogramowania powinny by zainstalowane, kt贸re usugi powinny by wczone i kt贸re pliki lub konfiguracje powinny by obecne na Twoich VM. Mo偶esz u偶y deklaratywnego podejcia do zarzdzania konfiguracj oprogramowania swoich VM, co umo偶liwia atwiejsz automatyzacj i skalowanie procesu zarzdzania konfiguracj.

To r贸wnie偶 pozwala na logowanie si do instancji za pomoc uprawnie IAM, wic jest to bardzo **przydatne do privesc i pivoting**.

{% hint style="warning" %}
Aby **wczy os-config w caym projekcie lub w instancji**, wystarczy ustawi klucz **metadata** **`enable-oslogin`** na **`true`** na 偶danym poziomie.\
Ponadto mo偶esz ustawi metadane **`enable-oslogin-2fa`** na **`true`**, aby wczy 2fa.

Gdy wczysz to podczas tworzenia instancji, klucze metadanych zostan automatycznie ustawione.
{% endhint %}

Wicej o **2fa w OS-config**, **dotyczy to tylko u偶ytkownik贸w**, jeli to jest SA (jak SA obliczeniowe), nie bdzie wymaga niczego dodatkowego.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Obrazy

### Niestandardowe obrazy

**Niestandardowe obrazy obliczeniowe mog zawiera wra偶liwe szczeg贸y** lub inne podatne konfiguracje, kt贸re mo偶esz wykorzysta.

Gdy obraz jest tworzony, mo偶esz wybra **3 typy szyfrowania**: U偶ywajc **klucza zarzdzanego przez Google** (domylnie), **klucza z KMS** lub **surowego klucza** podanego przez klienta.

#### Enumeracja

Mo偶esz zapyta o list niestandardowych obraz贸w w projekcie za pomoc nastpujcego polecenia:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Mo偶esz nastpnie [**wyeksportowa**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **wirtualne dyski** z dowolnego obrazu w wielu formatach. Nastpujce polecenie wyeksportuje obraz `test-image` w formacie qcow2, umo偶liwiajc pobranie pliku i zbudowanie VM lokalnie w celu dalszego badania:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Eskalacja Uprawnie

Sprawd藕 sekcj eskalacji uprawnie dla Instancji Obliczeniowych.

### Niestandardowe Szablony Instancji

Niestandardowy [**szablon instancji**](https://cloud.google.com/compute/docs/instance-templates/) **definiuje waciwoci instancji** w celu pomocy w wdra偶aniu sp贸jnych konfiguracji. Mog one zawiera te same rodzaje wra偶liwych danych co niestandardowe metadane dziaajcej instancji. Mo偶esz u偶y nastpujcych polece do zbadania:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Mo偶e by interesujce wiedzie, z kt贸rego dysku korzystaj nowe obrazy, ale te szablony zazwyczaj nie bd miay wra偶liwych informacji.

## Snapshots

**Snapshots to kopie zapasowe dysk贸w**. Zauwa偶, 偶e to nie to samo co klonowanie dysku (inna dostpna funkcja).\
**Snapshot** bdzie u偶ywa **tego samego szyfrowania co dysk**, z kt贸rego zosta wykonany.

### Enumeration
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Podwy偶szenie Uprawnie

Sprawd藕 sekcj podwy偶szania uprawnie dla Instancji Obliczeniowych.

## Odniesienia

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
