# GCP - Compute Enum

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## GCP VPC & R√©seautage

Apprenez comment cela fonctionne dans :

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### √ânum√©ration

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Vous trouvez facilement des instances de calcul avec des r√®gles de pare-feu ouvertes avec [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Instances de calcul

C'est ainsi que vous pouvez **ex√©cuter des machines virtuelles √† l'int√©rieur de GCP.** Consultez cette page pour plus d'informations :

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### √ânum√©ration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Pour plus d'informations sur comment **SSH** ou **modifier les m√©tadonn√©es** d'une instance pour **escalader les privil√®ges**, consultez cette page :

{% content-ref url="../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Escalade de Privil√®ges

Sur la page suivante, vous pouvez voir comment **abuser des permissions de calcul pour escalader les privil√®ges** :

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Enum√©ration Non Authentifi√©e

{% content-ref url="../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Persistance

{% content-ref url="../../gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Journaux de la Console S√©rie

Les journaux de la console s√©rie de Compute Engine sont une fonctionnalit√© qui permet de **voir et diagnostiquer les journaux de d√©marrage et du syst√®me d'exploitation** de vos instances de machines virtuelles.

Les journaux de la console s√©rie fournissent une **vue de bas niveau du processus de d√©marrage de l'instance**, y compris les messages du noyau, les scripts d'initialisation et d'autres √©v√©nements syst√®me qui se produisent lors du d√©marrage. Cela peut √™tre utile pour d√©boguer les probl√®mes de d√©marrage, identifier les mauvaises configurations ou les erreurs logicielles, ou r√©soudre les probl√®mes de connectivit√© r√©seau.

Ces journaux **peuvent exposer des informations sensibles** provenant des journaux syst√®me qu'un utilisateur √† faible privil√®ge ne verrait g√©n√©ralement pas, mais avec les permissions IAM appropri√©es, vous pouvez √™tre en mesure de les lire.

Vous pouvez utiliser la [commande gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) suivante pour interroger les journaux du port s√©rie (la permission requise est `compute.instances.getSerialPortOutput`) :
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Sortie des scripts de d√©marrage

Il est possible de voir la **sortie des scripts de d√©marrage** de la VM en ex√©cutant :
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

Vous pouvez utiliser le service de gestion de la configuration du syst√®me d'exploitation pour **d√©ployer, interroger et maintenir des configurations coh√©rentes** (√©tat souhait√© et logiciel) pour votre instance VM (VM). Sur Compute Engine, vous devez utiliser les [politiques d'invit√©](https://cloud.google.com/compute/docs/os-config-management#guest-policy) pour maintenir des configurations logicielles coh√©rentes sur une VM.

La fonctionnalit√© de gestion de la configuration du syst√®me d'exploitation vous permet de d√©finir des politiques de configuration qui sp√©cifient quels paquets logiciels doivent √™tre install√©s, quels services doivent √™tre activ√©s et quels fichiers ou configurations doivent √™tre pr√©sents sur vos VMs. Vous pouvez utiliser une approche d√©clarative pour g√©rer la configuration logicielle de vos VMs, ce qui vous permet d'automatiser et de faire √©voluer plus facilement votre processus de gestion de la configuration.

Cela permet √©galement de se connecter aux instances via les permissions IAM, donc c'est tr√®s **utile pour privesc et pivoting**.

{% hint style="warning" %}
Pour **activer os-config dans un projet entier ou dans une instance**, il suffit de d√©finir la cl√© de **m√©tadonn√©es** **`enable-oslogin`** sur **`true`** au niveau souhait√©.\
De plus, vous pouvez d√©finir la m√©tadonn√©e **`enable-oslogin-2fa`** sur **`true`** pour activer le 2fa.

Lorsque vous l'activez lors de la cr√©ation d'une instance, les cl√©s de m√©tadonn√©es seront automatiquement d√©finies.
{% endhint %}

Plus d'informations sur **2fa dans OS-config**, **cela ne s'applique que si l'utilisateur est un utilisateur**, si c'est un SA (comme le compute SA), il ne n√©cessitera rien de plus.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Images

### Custom Images

**Les images compute personnalis√©es peuvent contenir des d√©tails sensibles** ou d'autres configurations vuln√©rables que vous pouvez exploiter.

Lorsqu'une image est cr√©√©e, vous pouvez choisir **3 types de chiffrement** : Utiliser une **cl√© g√©r√©e par Google** (par d√©faut), une **cl√© de KMS**, ou une **cl√© brute** fournie par le client.

#### Enumeration

Vous pouvez interroger la liste des images non standard dans un projet avec la commande suivante :

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Vous pouvez ensuite [**exporter**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **les disques virtuels** √† partir de n'importe quelle image dans plusieurs formats. La commande suivante exporterait l'image `test-image` au format qcow2, vous permettant de t√©l√©charger le fichier et de construire une VM localement pour une enqu√™te plus approfondie :
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Escalade de Privil√®ges

Consultez la section sur l'escalade de privil√®ges des Compute Instances.

### Mod√®les d'Instance Personnalis√©s

Un [**mod√®le d'instance**](https://cloud.google.com/compute/docs/instance-templates/) **d√©finit les propri√©t√©s de l'instance** pour aider √† d√©ployer des configurations coh√©rentes. Ceux-ci peuvent contenir les m√™mes types de donn√©es sensibles que les m√©tadonn√©es personnalis√©es d'une instance en cours d'ex√©cution. Vous pouvez utiliser les commandes suivantes pour enqu√™ter :
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Il pourrait √™tre int√©ressant de savoir quel disque utilise les nouvelles images, mais ces templates n'auront g√©n√©ralement pas d'informations sensibles.

## Snapshots

Les **snapshots sont des sauvegardes de disques**. Notez que ce n'est pas la m√™me chose que cloner un disque (une autre fonctionnalit√© disponible).\
Le **snapshot** utilisera le **m√™me chiffrement que le disque** dont il est issu.

### Enumeration
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Escalade de Privil√®ges

Consultez la section sur l'escalade de privil√®ges des Compute Instances.

## R√©f√©rences

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
Apprenez et pratiquez AWS Hacking :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez GCP Hacking : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
