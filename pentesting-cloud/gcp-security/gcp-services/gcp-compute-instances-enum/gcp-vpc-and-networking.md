# GCP - VPC & Networking

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## **GCP Compute Networking w skr贸cie**

**VPC** zawiera **reguy zapory** umo偶liwiajce ruch przychodzcy do VPC. VPC zawiera r贸wnie偶 **podsieci**, w kt贸rych bd **poczone** **maszyny wirtualne**.\
W por贸wnaniu do AWS, **zapora** byaby **najbli偶szym** odpowiednikiem **AWS** **Security Groups i NACLs**, ale w tym przypadku s one **definiowane w VPC** a nie w ka偶dej instancji.

## **VPC, Podsieci i Zapory w GCP**

Instancje obliczeniowe s poczone z **podsieciami**, kt贸re s czci **VPC** ([Wirtualne Chmury Prywatne](https://cloud.google.com/vpc/docs/vpc)). W GCP nie ma grup zabezpiecze, s [**zapory VPC**](https://cloud.google.com/vpc/docs/firewalls) z reguami zdefiniowanymi na poziomie sieci, ale stosowanymi do ka偶dej instancji VM.

### Podsieci

**VPC** mo偶e mie **kilka podsieci**. Ka偶da **podsiec jest w 1 regionie**.

### Zapory

Domylnie ka偶da sie ma dwie [**implikowane reguy zapory**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **zezw贸l na ruch wychodzcy** i **zabro ruchu przychodzcego**.

Gdy projekt GCP jest tworzony, tworzona jest r贸wnie偶 VPC o nazwie **`default`**, z nastpujcymi reguami zapory:

* **default-allow-internal:** zezw贸l na cay ruch z innych instancji w sieci `default`
* **default-allow-ssh:** zezw贸l na 22 z wszdzie
* **default-allow-rdp:** zezw贸l na 3389 z wszdzie
* **default-allow-icmp:** zezw贸l na ping z wszdzie

{% hint style="warning" %}
Jak wida, **reguy zapory** maj tendencj do bycia **bardziej liberalnymi** dla **adres贸w IP wewntrznych**. Domylna VPC zezwala na cay ruch midzy instancjami obliczeniowymi.
{% endhint %}

Mo偶na utworzy wicej **regu zapory** dla domylnej VPC lub dla nowych VPC. [**Reguy zapory**](https://cloud.google.com/vpc/docs/firewalls) mog by stosowane do instancji za pomoc nastpujcych **metod**:

* [**Tagi sieciowe**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Konta serwisowe**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Wszystkie instancje w VPC**

Niestety, nie ma prostego polecenia `gcloud`, kt贸re wywietlioby wszystkie instancje obliczeniowe z otwartymi portami w internecie. Musisz poczy kropki midzy reguami zapory, tagami sieciowymi, kontami serwisowymi i instancjami.

Proces ten zosta zautomatyzowany za pomoc [tego skryptu python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum), kt贸ry wyeksportuje nastpujce:

* Plik CSV pokazujcy instancj, publiczny IP, dozwolony TCP, dozwolony UDP
* skanowanie nmap w celu zaatakowania wszystkich instancji na portach dozwolonych z publicznego internetu (0.0.0.0/0)
* masscan w celu zaatakowania penego zakresu TCP tych instancji, kt贸re zezwalaj na WSZYSTKIE porty TCP z publicznego internetu (0.0.0.0/0)

### Hierarchiczne Polityki Zapory <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hierarchiczne polityki zapory_ pozwalaj na tworzenie i **egzekwowanie sp贸jnej polityki zapory w caej organizacji**. Mo偶esz przypisa **hierarchiczne polityki zapory do organizacji** jako caoci lub do poszczeg贸lnych **folder贸w**. Polityki te zawieraj reguy, kt贸re mog wyra藕nie zabrania lub zezwala na poczenia.

Tworzysz i stosujesz polityki zapory jako oddzielne kroki. Mo偶esz tworzy i stosowa polityki zapory na **wzach organizacji lub folder贸w w** [**hierarchii zasob贸w**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Regua polityki zapory mo偶e **blokowa poczenia, zezwala na poczenia lub odkada ocen reguy zapory** do ni偶szych folder贸w lub regu zapory VPC zdefiniowanych w sieciach VPC.

Domylnie wszystkie reguy polityki zapory hierarchicznej maj zastosowanie do wszystkich VM w wszystkich projektach pod organizacj lub folderem, do kt贸rego polityka jest przypisana. Mo偶esz jednak **ograniczy, kt贸re VM otrzymuj dan regu**, okrelajc [docelowe sieci lub docelowe konta serwisowe](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Mo偶esz przeczyta tutaj, jak [**utworzy polityk zapory hierarchicznej**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Ocena Regu Zapory

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Polityki zapory przypisane do organizacji
2. Folder: Polityki zapory przypisane do folderu
3. VPC: Reguy zapory przypisane do VPC
4. Globalne: Inny typ regu zapory, kt贸re mog by przypisane do VPC
5. Regionalne: Reguy zapory zwizane z sieci VPC NIC VM i regionem VM.

## Peering Sieci VPC

Pozwala na poczenie dw贸ch sieci Wirtualnych Chmur Prywatnych (VPC), aby **zasoby w ka偶dej sieci mogy si komunikowa**.\
Poczone sieci VPC mog znajdowa si w tym samym projekcie, r贸偶nych projektach tej samej organizacji lub **r贸偶nych projektach r贸偶nych organizacji**.

Oto potrzebne uprawnienia:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Wicej w dokumentacji**](https://cloud.google.com/vpc/docs/vpc-peering).

## Odniesienia

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
