# GCP - VPC & Networking

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **GCP Compute Networking in a Nutshell**

**VPCs** рдореЗрдВ **Firewall** рдирд┐рдпрдо рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ VPC рдореЗрдВ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВред VPCs рдореЗрдВ **subnetworks** рднреА рд╣реЛрддреЗ рд╣реИрдВ рдЬрд╣рд╛рдБ **virtual machines** **connected** рд╣реЛрдиреЗ рд╡рд╛рд▓реА рд╣реИрдВред\
AWS рдХреА рддреБрд▓рдирд╛ рдореЗрдВ, **Firewall** **AWS** **Security Groups рдФрд░ NACLs** рдХреЗ **рд╕рдмрд╕реЗ рдХрд░реАрдм** рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдпреЗ **VPC рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд** рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдирд╣реАрдВред

## **VPC, Subnetworks & Firewalls in GCP**

Compute Instances **subnetworks** рд╕реЗ рдЬреБрдбрд╝реЗ рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ **VPCs** рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реЛрддреЗ рд╣реИрдВ ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). GCP рдореЗрдВ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдореВрд╣ рдирд╣реАрдВ рд╣реЛрддреЗ, рд╡рд╣рд╛рдБ [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls) рд╣реЛрддреЗ рд╣реИрдВ рдЬрд┐рдирдХреЗ рдирд┐рдпрдо рдЗрд╕ рдиреЗрдЯрд╡рд░реНрдХ рд╕реНрддрд░ рдкрд░ рдкрд░рд┐рднрд╛рд╖рд┐рдд рд╣реЛрддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рдкреНрд░рддреНрдпреЗрдХ VM Instance рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрддреЗ рд╣реИрдВред

### Subnetworks

рдПрдХ **VPC** рдореЗрдВ **рдХрдИ subnetworks** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред рдкреНрд░рддреНрдпреЗрдХ **subnetwork 1 рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рд╣реИ**ред

### Firewalls

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рдкреНрд░рддреНрдпреЗрдХ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рджреЛ [**implied firewall rules**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules) рд╣реЛрддреЗ рд╣реИрдВ: **allow outbound** рдФрд░ **deny inbound**ред

рдЬрдм рдПрдХ GCP рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдПрдХ VPC рдЬрд┐рд╕реЗ **`default`** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рднреА рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдирд┐рдпрдо рд╣реЛрддреЗ рд╣реИрдВ:

* **default-allow-internal:** `default` рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдЕрдиреНрдп рдЙрджрд╛рд╣рд░рдгреЛрдВ рд╕реЗ рд╕рднреА рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВ
* **default-allow-ssh:** рд╣рд░ рдЬрдЧрд╣ рд╕реЗ 22 рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВ
* **default-allow-rdp:** рд╣рд░ рдЬрдЧрд╣ рд╕реЗ 3389 рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВ
* **default-allow-icmp:** рд╣рд░ рдЬрдЧрд╣ рд╕реЗ рдкрд┐рдВрдЧ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВ

{% hint style="warning" %}
рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, **firewall rules** **internal IP addresses** рдХреЗ рд▓рд┐рдП **рдЕрдзрд┐рдХ рдЙрджрд╛рд░** рд╣реЛрддреЗ рд╣реИрдВред рдбрд┐рдлрд╝реЙрд▓реНрдЯ VPC Compute Instances рдХреЗ рдмреАрдЪ рд╕рднреА рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
{% endhint %}

рдбрд┐рдлрд╝реЙрд▓реНрдЯ VPC рдпрд╛ рдирдП VPCs рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХ **Firewall rules** рдмрдирд╛рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред [**Firewall rules**](https://cloud.google.com/vpc/docs/firewalls) рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд **methods** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдкрд░ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

* [**Network tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Service accounts**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **рдПрдХ VPC рдХреЗ рднреАрддрд░ рд╕рднреА рдЙрджрд╛рд╣рд░рдг**

рджреБрд░реНрднрд╛рдЧреНрдпрд╡рд╢, рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рдЦреБрд▓реЗ рдкреЛрд░реНрдЯ рд╡рд╛рд▓реЗ рд╕рднреА Compute Instances рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╕рд░рд▓ `gcloud` рдХрдорд╛рдВрдб рдирд╣реАрдВ рд╣реИред рдЖрдкрдХреЛ рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдирд┐рдпрдореЛрдВ, рдиреЗрдЯрд╡рд░реНрдХ рдЯреИрдЧ, рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдФрд░ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреЗ рдмреАрдЪ рдХрдиреЗрдХреНрд╢рди рдмрдирд╛рдирд╛ рд╣реЛрдЧрд╛ред

рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ [рдЗрд╕ python script](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдЬреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдирд┐рд░реНрдпрд╛рдд рдХрд░реЗрдЧрд╛:

* CSV рдлрд╝рд╛рдЗрд▓ рдЬреЛ рдЙрджрд╛рд╣рд░рдг, рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ IP, рдЕрдиреБрдордд TCP, рдЕрдиреБрдордд UDP рджрд┐рдЦрд╛рддреА рд╣реИ
* nmap рд╕реНрдХреИрди рдЬреЛ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдЗрдВрдЯрд░рдиреЗрдЯ (0.0.0.0/0) рд╕реЗ рдЕрдиреБрдорддрд┐ рдкреНрд░рд╛рдкреНрдд рдкреЛрд░реНрдЯ рдкрд░ рд╕рднреА рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ
* masscan рдЬреЛ рдЙрди рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреА рдкреВрд░реНрдг TCP рд░реЗрдВрдЬ рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдЗрдВрдЯрд░рдиреЗрдЯ (0.0.0.0/0) рд╕реЗ рд╕рднреА TCP рдкреЛрд░реНрдЯ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ

### Hierarchical Firewall Policies <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hierarchical firewall policies_ рдЖрдкрдХреЛ рдЕрдкрдиреЗ рд╕рдВрдЧрдарди рдореЗрдВ рдПрдХ рд╕реБрд╕рдВрдЧрдд рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдиреАрддрд┐ рдмрдирд╛рдиреЗ рдФрд░ **рд▓рд╛рдЧреВ рдХрд░рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИрдВред рдЖрдк **hierarchical firewall policies** рдХреЛ рд╕рдВрдЧрдарди рдХреЗ рд╕рдордЧреНрд░ рд░реВрдк рдореЗрдВ рдпрд╛ рд╡реНрдпрдХреНрддрд┐рдЧрдд **folders** рдкрд░ рдЕрд╕рд╛рдЗрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрди рдиреАрддрд┐рдпреЛрдВ рдореЗрдВ рдирд┐рдпрдо рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдпрд╛ рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддреЗ рд╣реИрдВред

рдЖрдк рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдиреАрддрд┐рдпреЛрдВ рдХреЛ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдЪрд░рдгреЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ рдмрдирд╛рддреЗ рдФрд░ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВред рдЖрдк [**resource hierarchy**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) рдХреЗ **organization рдпрд╛ folder nodes** рдкрд░ рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдиреАрддрд┐рдпреЛрдВ рдХреЛ рдмрдирд╛ рдФрд░ рд▓рд╛рдЧреВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдПрдХ рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдиреАрддрд┐ рдирд┐рдпрдо **рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреЛ рдмреНрд▓реЙрдХ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИ, рдпрд╛ рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдирд┐рдпрдо рдореВрд▓реНрдпрд╛рдВрдХрди рдХреЛ рдирд┐рдореНрди рд╕реНрддрд░ рдХреЗ рдлрд╝реЛрд▓реНрдбрд░реЛрдВ рдпрд╛ VPC рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд VPC рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдирд┐рдпрдореЛрдВ рдкрд░ рд╕реНрдердЧрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред**

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рд╕рднреА hierarchical firewall policy рдирд┐рдпрдо рд╕рднреА рдкрд░рд┐рдпреЛрдЬрдирд╛рдУрдВ рдореЗрдВ рд╕рднреА VMs рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрддреЗ рд╣реИрдВ рдЬрд╣рд╛рдБ рдиреАрддрд┐ рдЬреБрдбрд╝реА рд╣реЛрддреА рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдЖрдк [target networks рдпрд╛ target service accounts](https://cloud.google.com/vpc/docs/firewall-policies#targets) рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдХреЗ рдпрд╣ **рд╕реАрдорд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕реЗ VMs рдХреЛ рдПрдХ рдирд┐рдпрдо рдорд┐рд▓рддрд╛ рд╣реИ**ред

рдЖрдк рдпрд╣рд╛рдБ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ [**Hierarchical Firewall Policy рдХреИрд╕реЗ рдмрдирд╛рдПрдВ**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)ред

### Firewall Rules Evaluation

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: рд╕рдВрдЧрдарди рдХреЛ рдЕрд╕рд╛рдЗрди рдХреА рдЧрдИ рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдиреАрддрд┐рдпрд╛рдБ
2. Folder: рдлрд╝реЛрд▓реНрдбрд░ рдХреЛ рдЕрд╕рд╛рдЗрди рдХреА рдЧрдИ рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдиреАрддрд┐рдпрд╛рдБ
3. VPC: VPC рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд┐рдП рдЧрдП рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдирд┐рдпрдо
4. Global: рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдирд┐рдпрдореЛрдВ рдХрд╛ рдПрдХ рдФрд░ рдкреНрд░рдХрд╛рд░ рдЬреЛ VPCs рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ
5. Regional: VM рдХреЗ NIC рдФрд░ VM рдХреЗ рдХреНрд╖реЗрддреНрд░ рдХреЗ VPC рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗ рдЬреБрдбрд╝реЗ рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдирд┐рдпрдоред

## VPC Network Peering

рджреЛ Virtual Private Cloud (VPC) рдиреЗрдЯрд╡рд░реНрдХ рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рддрд╛рдХрд┐ **рдкреНрд░рддреНрдпреЗрдХ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рд╕рдВрд╕рд╛рдзрди рдПрдХ-рджреВрд╕рд░реЗ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХреЗрдВ**ред\
Peered VPC рдиреЗрдЯрд╡рд░реНрдХ рдПрдХ рд╣реА рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдореЗрдВ, рдПрдХ рд╣реА рд╕рдВрдЧрдарди рдХреЗ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░реЛрдЬреЗрдХреНрдЯреЛрдВ рдореЗрдВ, рдпрд╛ **рд╡рд┐рднрд┐рдиреНрди рд╕рдВрдЧрдардиреЛрдВ рдХреЗ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░реЛрдЬреЗрдХреНрдЯреЛрдВ рдореЗрдВ** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрдирдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╡рд╛рд▓реЗ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**More in the docs**](https://cloud.google.com/vpc/docs/vpc-peering).

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
