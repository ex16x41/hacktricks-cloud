# GCP - VPC & Networking

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## **GCP Compute Networking in a Nutshell**

**VPCs** enthalten **Firewall**-Regeln, um eingehenden Verkehr zur VPC zuzulassen. VPCs enthalten auch **Subnetze**, in denen **virtuelle Maschinen** **verbunden** werden.\
Im Vergleich zu AWS w√§re die **Firewall** das **n√§chste**, was **AWS** **Sicherheitsgruppen und NACLs** entspricht, aber in diesem Fall sind diese **in der VPC definiert** und nicht in jeder Instanz.

## **VPC, Subnetze & Firewalls in GCP**

Compute-Instanzen sind mit **Subnetzen** verbunden, die Teil von **VPCs** sind ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). In GCP gibt es keine Sicherheitsgruppen, es gibt [**VPC-Firewalls**](https://cloud.google.com/vpc/docs/firewalls) mit Regeln, die auf dieser Netzwerktechnologie definiert sind, aber auf jede VM-Instanz angewendet werden.

### Subnetze

Eine **VPC** kann **mehrere Subnetze** haben. Jedes **Subnetz befindet sich in 1 Region**.

### Firewalls

Standardm√§√üig hat jedes Netzwerk zwei [**implizierte Firewall-Regeln**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **erlaube ausgehenden** und **verweigere eingehenden**.

Wenn ein GCP-Projekt erstellt wird, wird auch eine VPC namens **`default`** erstellt, mit den folgenden Firewall-Regeln:

* **default-allow-internal:** erlaube allen Verkehr von anderen Instanzen im `default`-Netzwerk
* **default-allow-ssh:** erlaube 22 von √ºberall
* **default-allow-rdp:** erlaube 3389 von √ºberall
* **default-allow-icmp:** erlaube Ping von √ºberall

{% hint style="warning" %}
Wie du sehen kannst, tendieren **Firewall-Regeln** dazu, **permissiver** f√ºr **interne IP-Adressen** zu sein. Die Standard-VPC erlaubt allen Verkehr zwischen Compute-Instanzen.
{% endhint %}

Weitere **Firewall-Regeln** k√∂nnen f√ºr die Standard-VPC oder f√ºr neue VPCs erstellt werden. [**Firewall-Regeln**](https://cloud.google.com/vpc/docs/firewalls) k√∂nnen √ºber die folgenden **Methoden** auf Instanzen angewendet werden:

* [**Netzwerk-Tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Dienstkonten**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Alle Instanzen innerhalb einer VPC**

Leider gibt es keinen einfachen `gcloud`-Befehl, um alle Compute-Instanzen mit offenen Ports im Internet auszugeben. Du musst die Verbindungen zwischen Firewall-Regeln, Netzwerk-Tags, Dienstkonten und Instanzen herstellen.

Dieser Prozess wurde mit [diesem Python-Skript](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) automatisiert, das Folgendes exportiert:

* CSV-Datei, die Instanz, √∂ffentliche IP, erlaubtes TCP, erlaubtes UDP zeigt
* nmap-Scan, um alle Instanzen auf Ports zu zielen, die vom √∂ffentlichen Internet (0.0.0.0/0) erlaubt sind
* masscan, um den gesamten TCP-Bereich dieser Instanzen zu zielen, die ALLE TCP-Ports vom √∂ffentlichen Internet (0.0.0.0/0) erlauben

### Hierarchische Firewall-Richtlinien <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hierarchische Firewall-Richtlinien_ erm√∂glichen es dir, eine konsistente Firewall-Richtlinie in deiner Organisation zu erstellen und **durchzusetzen**. Du kannst **hierarchische Firewall-Richtlinien der gesamten Organisation** oder einzelnen **Ordnern** zuweisen. Diese Richtlinien enthalten Regeln, die Verbindungen ausdr√ºcklich verweigern oder erlauben k√∂nnen.

Du erstellst und wendest Firewall-Richtlinien in separaten Schritten an. Du kannst Firewall-Richtlinien an den **Organisations- oder Ordnerknoten der** [**Ressourcenhierarchie**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) erstellen und anwenden. Eine Firewall-Richtlinienregel kann **Verbindungen blockieren, Verbindungen erlauben oder die Bewertung der Firewall-Regel** an niedrigere Ordner oder VPC-Firewall-Regeln, die in VPC-Netzwerken definiert sind, verschieben.

Standardm√§√üig gelten alle Regeln der hierarchischen Firewall-Richtlinie f√ºr alle VMs in allen Projekten unter der Organisation oder dem Ordner, mit dem die Richtlinie verkn√ºpft ist. Du kannst jedoch **einschr√§nken, welche VMs eine bestimmte Regel erhalten**, indem du [Zielnetzwerke oder Ziel-Dienstkonten](https://cloud.google.com/vpc/docs/firewall-policies#targets) angibst.

Hier kannst du lesen, wie man [**eine hierarchische Firewall-Richtlinie erstellt**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Bewertung der Firewall-Regeln

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Firewall-Richtlinien, die der Organisation zugewiesen sind
2. Ordner: Firewall-Richtlinien, die dem Ordner zugewiesen sind
3. VPC: Firewall-Regeln, die der VPC zugewiesen sind
4. Global: Eine andere Art von Firewall-Regeln, die VPCs zugewiesen werden k√∂nnen
5. Regional: Firewall-Regeln, die mit dem VPC-Netzwerk der VM's NIC und der Region der VM verbunden sind.

## VPC-Netzwerk-Peering

Erm√∂glicht die Verbindung von zwei Virtual Private Cloud (VPC)-Netzwerken, sodass **Ressourcen in jedem Netzwerk miteinander kommunizieren** k√∂nnen.\
Peered VPC-Netzwerke k√∂nnen im selben Projekt, in verschiedenen Projekten derselben Organisation oder in **verschiedenen Projekten verschiedener Organisationen** sein.

Dies sind die ben√∂tigten Berechtigungen:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Mehr in den Dokumenten**](https://cloud.google.com/vpc/docs/vpc-peering).

## Referenzen

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
