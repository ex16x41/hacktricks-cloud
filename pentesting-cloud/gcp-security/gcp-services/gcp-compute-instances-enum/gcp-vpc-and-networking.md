# GCP - VPC & Networking

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## **GCP Compute Networking em Resumo**

**VPCs** cont√©m regras de **Firewall** para permitir tr√°fego de entrada na VPC. VPCs tamb√©m cont√©m **subredes** onde **m√°quinas virtuais** v√£o ser **conectadas**.\
Comparando com AWS, **Firewall** seria a coisa **mais pr√≥xima** de **AWS** **Security Groups e NACLs**, mas neste caso estas s√£o **definidas na VPC** e n√£o em cada inst√¢ncia.

## **VPC, Subredes & Firewalls no GCP**

Inst√¢ncias de Computa√ß√£o est√£o conectadas a **subredes** que s√£o parte de **VPCs** ([Nuvens Privadas Virtuais](https://cloud.google.com/vpc/docs/vpc)). No GCP n√£o existem grupos de seguran√ßa, existem [**firewalls VPC**](https://cloud.google.com/vpc/docs/firewalls) com regras definidas neste n√≠vel de rede, mas aplicadas a cada Inst√¢ncia de VM.

### Subredes

Uma **VPC** pode ter **v√°rias subredes**. Cada **subrede est√° em 1 regi√£o**.

### Firewalls

Por padr√£o, toda rede tem duas [**regras de firewall impl√≠citas**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **permitir sa√≠da** e **negar entrada**.

Quando um projeto GCP √© criado, uma VPC chamada **`default`** tamb√©m √© criada, com as seguintes regras de firewall:

* **default-allow-internal:** permite todo tr√°fego de outras inst√¢ncias na rede `default`
* **default-allow-ssh:** permite 22 de qualquer lugar
* **default-allow-rdp:** permite 3389 de qualquer lugar
* **default-allow-icmp:** permite ping de qualquer lugar

{% hint style="warning" %}
Como voc√™ pode ver, as **regras de firewall** tendem a ser **mais permissivas** para **endere√ßos IP internos**. A VPC padr√£o permite todo tr√°fego entre Inst√¢ncias de Computa√ß√£o.
{% endhint %}

Mais **regras de Firewall** podem ser criadas para a VPC padr√£o ou para novas VPCs. [**Regras de Firewall**](https://cloud.google.com/vpc/docs/firewalls) podem ser aplicadas a inst√¢ncias atrav√©s dos seguintes **m√©todos**:

* [**Tags de rede**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Contas de servi√ßo**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Todas as inst√¢ncias dentro de uma VPC**

Infelizmente, n√£o existe um comando `gcloud` simples para listar todas as Inst√¢ncias de Computa√ß√£o com portas abertas na internet. Voc√™ precisa conectar os pontos entre regras de firewall, tags de rede, contas de servi√ßo e inst√¢ncias.

Esse processo foi automatizado usando [este script python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) que ir√° exportar o seguinte:

* Arquivo CSV mostrando inst√¢ncia, IP p√∫blico, TCP permitido, UDP permitido
* Escaneamento nmap para direcionar todas as inst√¢ncias nas portas de entrada permitidas da internet p√∫blica (0.0.0.0/0)
* masscan para direcionar toda a faixa TCP daquelas inst√¢ncias que permitem TODAS as portas TCP da internet p√∫blica (0.0.0.0/0)

### Pol√≠ticas de Firewall Hier√°rquicas <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_As pol√≠ticas de firewall hier√°rquicas_ permitem que voc√™ crie e **aplique uma pol√≠tica de firewall consistente em toda a sua organiza√ß√£o**. Voc√™ pode atribuir **pol√≠ticas de firewall hier√°rquicas √† organiza√ß√£o** como um todo ou a **pastas** individuais. Essas pol√≠ticas cont√™m regras que podem explicitamente negar ou permitir conex√µes.

Voc√™ cria e aplica pol√≠ticas de firewall como etapas separadas. Voc√™ pode criar e aplicar pol√≠ticas de firewall nos **n√≥s de organiza√ß√£o ou pasta da** [**hierarquia de recursos**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Uma regra de pol√≠tica de firewall pode **bloquear conex√µes, permitir conex√µes ou adiar a avalia√ß√£o da regra de firewall** para pastas de n√≠vel inferior ou regras de firewall VPC definidas em redes VPC.

Por padr√£o, todas as regras de pol√≠tica de firewall hier√°rquica se aplicam a todas as VMs em todos os projetos sob a organiza√ß√£o ou pasta onde a pol√≠tica est√° associada. No entanto, voc√™ pode **restringir quais VMs recebem uma determinada regra** especificando [redes de destino ou contas de servi√ßo de destino](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Voc√™ pode ler aqui como [**criar uma Pol√≠tica de Firewall Hier√°rquica**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Avalia√ß√£o de Regras de Firewall

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Pol√≠ticas de firewall atribu√≠das √† Organiza√ß√£o
2. Pasta: Pol√≠ticas de firewall atribu√≠das √† Pasta
3. VPC: Regras de firewall atribu√≠das √† VPC
4. Global: Outro tipo de regras de firewall que podem ser atribu√≠das a VPCs
5. Regional: Regras de firewall associadas √† rede VPC do NIC da VM e regi√£o da VM.

## Peering de Rede VPC

Permite conectar duas redes de Nuvem Privada Virtual (VPC) para que **recursos em cada rede possam se comunicar** entre si.\
Redes VPC conectadas podem estar no mesmo projeto, em projetos diferentes da mesma organiza√ß√£o, ou **em projetos diferentes de organiza√ß√µes diferentes**.

Estas s√£o as permiss√µes necess√°rias:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Mais na documenta√ß√£o**](https://cloud.google.com/vpc/docs/vpc-peering).

## Refer√™ncias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
