# GCP - VPC & Networking

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **GCP Compute Networking in a Nutshell**

**VPCs** zina **Firewall** sheria za kuruhusu trafiki inayokuja kwenye VPC. VPCs pia zina **subnetworks** ambapo **mashine za virtual** zitakuwa **zimeunganishwa**.\
Ikilinganishwa na AWS, **Firewall** ingekuwa **kitu cha karibu** na **AWS** **Security Groups na NACLs**, lakini katika kesi hii hizi zina **mwelekeo katika VPC** na si katika kila mfano.

## **VPC, Subnetworks & Firewalls katika GCP**

Compute Instances zimeunganishwa **subnetworks** ambazo ni sehemu ya **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). Katika GCP hakuna makundi ya usalama, kuna [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls) zenye sheria zilizofafanuliwa katika kiwango hiki cha mtandao lakini zinatumika kwa kila VM Instance.

### Subnetworks

**VPC** inaweza kuwa na **subnetworks kadhaa**. Kila **subnetwork iko katika eneo 1**.

### Firewalls

Kwa kawaida, kila mtandao una sheria mbili [**za firewall zilizodhamiriwa**](https://cloud.google.com/vpc/docs/firewalls#default_firewall_rules): **ruhusu outbound** na **kata inbound**.

Wakati mradi wa GCP unaundwa, VPC inayoitwa **`default`** pia inaundwa, ikiwa na sheria zifuatazo za firewall:

* **default-allow-internal:** ruhusu trafiki yote kutoka kwa mifano mingine kwenye mtandao wa `default`
* **default-allow-ssh:** ruhusu 22 kutoka kila mahali
* **default-allow-rdp:** ruhusu 3389 kutoka kila mahali
* **default-allow-icmp:** ruhusu ping kutoka kila mahali

{% hint style="warning" %}
Kama unavyoona, **firewall rules** huwa **na ruhusa zaidi** kwa **anwani za IP za ndani**. VPC ya kawaida inaruhusu trafiki yote kati ya Compute Instances.
{% endhint %}

Sheria zaidi za **Firewall** zinaweza kuundwa kwa VPC ya kawaida au kwa VPC mpya. [**Sheria za Firewall**](https://cloud.google.com/vpc/docs/firewalls) zinaweza kutumika kwa mifano kupitia **mbinu** zifuatazo:

* [**Network tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Service accounts**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Mifano yote ndani ya VPC**

Kwa bahati mbaya, hakuna amri rahisi ya `gcloud` kutoa mifano yote ya Compute yenye bandari wazi kwenye mtandao. Lazima uunganishe alama kati ya sheria za firewall, lebo za mtandao, akaunti za huduma, na mifano.

Mchakato huu umejumuishwa kwa kutumia [hii python script](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_firewall_enum) ambayo itasafirisha yafuatayo:

* Faili ya CSV inayoonyesha mfano, IP ya umma, TCP inayoruhusiwa, UDP inayoruhusiwa
* skana ya nmap kulenga mifano yote kwenye bandari zinazoruhusiwa kutoka kwa mtandao wa umma (0.0.0.0/0)
* masscan kulenga safu kamili ya TCP ya mifano hiyo inayoruhusu BANDARI ZOTE za TCP kutoka kwa mtandao wa umma (0.0.0.0/0)

### Hierarchical Firewall Policies <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Maelekezo ya firewall ya kihierarkia_ yanakuruhusu kuunda na **kutekeleza sera thabiti ya firewall katika shirika lako**. Unaweza kupeana **sera za firewall za kihierarkia kwa shirika** kwa ujumla au kwa **folders** za kibinafsi. Sera hizi zina sheria ambazo zinaweza kukataa au kuruhusu mawasiliano kwa wazi.

Unaunda na kutekeleza sera za firewall kama hatua tofauti. Unaweza kuunda na kutekeleza sera za firewall katika **mashirika au nodi za folda za** [**hierarchia ya rasilimali**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Sheria ya sera ya firewall inaweza **kuzuia mawasiliano, kuruhusu mawasiliano, au kuchelewesha tathmini ya sheria za firewall** kwa folda za chini au sheria za firewall za VPC zilizofafanuliwa katika mitandao ya VPC.

Kwa kawaida, sheria zote za sera za firewall za kihierarkia zinatumika kwa VMs zote katika miradi yote chini ya shirika au folda ambapo sera hiyo imeunganishwa. Hata hivyo, unaweza **kudhibiti ni VMs zipi zinapata sheria fulani** kwa kubainisha [mitandao ya lengo au akaunti za huduma za lengo](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Unaweza kusoma hapa jinsi ya [**kuunda Sera ya Firewall ya Kihierarkia**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Tathmini ya Sheria za Firewall

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Sera za firewall zilizotolewa kwa Shirika
2. Folder: Sera za firewall zilizotolewa kwa Folda
3. VPC: Sheria za firewall zilizotolewa kwa VPC
4. Global: Aina nyingine ya sheria za firewall ambazo zinaweza kutolewa kwa VPCs
5. Regional: Sheria za firewall zinazohusiana na mtandao wa VPC wa NIC ya VM na eneo la VM.

## VPC Network Peering

Inaruhusu kuunganisha mitandao miwili ya Virtual Private Cloud (VPC) ili **rasilimali katika kila mtandao ziweze kuwasiliana** na kila mmoja.\
Mitandao ya VPC iliyounganishwa inaweza kuwa katika mradi mmoja, miradi tofauti ya shirika moja, au **miradi tofauti ya mashirika tofauti**.

Hizi ndizo ruhusa zinazohitajika:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Zaidi katika nyaraka**](https://cloud.google.com/vpc/docs/vpc-peering).

## Marejeo

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
