# GCP - VPC & Networking

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter**'da **bizi takip edin** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

## **GCP Compute Networking Kısaca**

**VPC'ler**, VPC'ye gelen trafiği izin vermek için **Firewall** kurallarını içerir. VPC'ler ayrıca **sanallaştırılmış makinelerin** **bağlanacağı** **alt ağları** içerir.\
AWS ile karşılaştırıldığında, **Firewall**, **AWS** **Güvenlik Grupları ve NACL'ler** için en **yakın** şeydir, ancak bu durumda bunlar **VPC'de** tanımlanmıştır ve her bir örnekte değil.

## **GCP'de VPC, Alt Ağlar & Firewall'lar**

Compute Instances, **VPC'lerin** ([Sanal Özel Bulutlar](https://cloud.google.com/vpc/docs/vpc)) bir parçası olan **alt ağlara** bağlıdır. GCP'de güvenlik grupları yoktur, bu ağ seviyesinde tanımlanan ancak her VM Örneğine uygulanan [**VPC firewall'ları**](https://cloud.google.com/vpc/docs/firewalls) vardır.

### Alt Ağlar

Bir **VPC**, **birçok alt ağa** sahip olabilir. Her **alt ağ 1 bölgede** bulunur.

### Firewall'lar

Varsayılan olarak, her ağın iki [**anlamlı firewall kuralı**](https://cloud.google.com/vpc/docs/firewalls#default_firewall_rules) vardır: **çıkışa izin ver** ve **girişe engel ol**.

Bir GCP projesi oluşturulduğunda, aşağıdaki firewall kuralları ile birlikte **`default`** adında bir VPC de oluşturulur:

* **default-allow-internal:** `default` ağındaki diğer örneklerden gelen tüm trafiğe izin ver
* **default-allow-ssh:** her yerden 22'ye izin ver
* **default-allow-rdp:** her yerden 3389'a izin ver
* **default-allow-icmp:** her yerden ping'e izin ver

{% hint style="warning" %}
Gördüğünüz gibi, **firewall kuralları** **iç IP adresleri** için **daha izin verici** olma eğilimindedir. Varsayılan VPC, Compute Instances arasında tüm trafiğe izin verir.
{% endhint %}

Varsayılan VPC veya yeni VPC'ler için daha fazla **Firewall kuralı** oluşturulabilir. [**Firewall kuralları**](https://cloud.google.com/vpc/docs/firewalls), aşağıdaki **yöntemler** aracılığıyla örneklere uygulanabilir:

* [**Ağ etiketleri**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Hizmet hesapları**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Bir VPC içindeki tüm örnekler**

Ne yazık ki, internette açık portlara sahip tüm Compute Instances'ı döken basit bir `gcloud` komutu yoktur. Firewall kuralları, ağ etiketleri, hizmet hesapları ve örnekler arasında bağlantı kurmanız gerekir.

Bu süreç, aşağıdakileri dışa aktaracak olan [bu python betiği](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_firewall_enum) kullanılarak otomatikleştirildi:

* Örnek, genel IP, izin verilen TCP, izin verilen UDP gösteren CSV dosyası
* Genel internetten (0.0.0.0/0) izin verilen portlarda tüm örnekleri hedef alan nmap taraması
* Genel internetten (0.0.0.0/0) Tüm TCP portlarına izin veren bu örneklerin tam TCP aralığını hedef alan masscan

### Hiyerarşik Firewall Politikaları <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hiyerarşik firewall politikaları_, **kuruluşunuz genelinde tutarlı bir firewall politikası oluşturmanıza ve uygulamanıza** olanak tanır. **Hiyerarşik firewall politikalarını** kuruluşun tamamına veya bireysel **kataloglara** atayabilirsiniz. Bu politikalar, bağlantıları açıkça reddedebilen veya izin verebilen kurallar içerir.

Firewall politikalarını ayrı adımlar olarak oluşturur ve uygularsınız. Firewall politikalarını [**kaynak hiyerarşisi**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) üzerindeki **kuruluş veya klasör düğümlerinde** oluşturabilir ve uygulayabilirsiniz. Bir firewall politika kuralı, **bağlantıları engelleyebilir, bağlantılara izin verebilir veya firewall kuralı değerlendirmesini** daha düşük düzeydeki klasörlere veya VPC ağlarında tanımlanan VPC firewall kurallarına erteleyebilir.

Varsayılan olarak, tüm hiyerarşik firewall politika kuralları, politikanın ilişkilendirildiği kuruluş veya klasör altındaki tüm projelerdeki tüm VM'lere uygulanır. Ancak, [hedef ağlar veya hedef hizmet hesapları](https://cloud.google.com/vpc/docs/firewall-policies#targets) belirterek hangi VM'lerin belirli bir kuralı alacağını **kısıtlayabilirsiniz**.

[**Hiyerarşik Firewall Politikası oluşturma**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud) hakkında buradan okuyabilirsiniz.

### Firewall Kuralları Değerlendirmesi

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Kuruluşa atanan firewall politikaları
2. Klasör: Klasöre atanan firewall politikaları
3. VPC: VPC'ye atanan firewall kuralları
4. Global: VPC'lere atanabilen başka bir tür firewall kuralı
5. Bölgesel: VM'nin NIC'sinin ve VM'nin bölgesinin VPC ağı ile ilişkili firewall kuralları.

## VPC Ağ Peering

İki Sanal Özel Bulut (VPC) ağını bağlayarak **her ağdaki kaynakların birbirleriyle iletişim kurmasını** sağlar.\
Peered VPC ağları aynı projede, aynı kuruluşun farklı projelerinde veya **farklı kuruluşların farklı projelerinde** olabilir.

Gerekli izinler şunlardır:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Belgelerde daha fazla bilgi**](https://cloud.google.com/vpc/docs/vpc-peering).

## Referanslar

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter**'da **bizi takip edin** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
