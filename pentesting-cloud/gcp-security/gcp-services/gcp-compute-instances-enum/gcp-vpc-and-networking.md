# GCP - VPC & Networking

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** ğŸ’¬ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **GCP Compute Networking in a Nutshell**

**VPCs** bevat **Firewall** reÃ«ls om inkomende verkeer na die VPC toe te laat. VPCs bevat ook **subnetwerke** waar **virtuele masjiene** gaan **verbinde**.\
In vergelyking met AWS, sou **Firewall** die **nabyste** ding wees aan **AWS** **Security Groups en NACLs**, maar in hierdie geval is dit **gedefinieer in die VPC** en nie in elke instansie nie.

## **VPC, Subnetwerke & Firewalls in GCP**

Compute Instances is verbind met **subnetwerke** wat deel is van **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). In GCP is daar nie sekuriteitsgroepe nie, daar is [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls) met reÃ«ls wat op hierdie netwerkvlak gedefinieer is, maar toegepas op elke VM Instansie.

### Subnetwerke

'n **VPC** kan **verskeie subnetwerke** hÃª. Elke **subnetwork is in 1 streek**.

### Firewalls

Standaard het elke netwerk twee [**implisiete firewall reÃ«ls**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **toelaat uitgaande** en **weier inkomende**.

Wanneer 'n GCP-projek geskep word, word 'n VPC genaamd **`default`** ook geskep, met die volgende firewall reÃ«ls:

* **default-allow-internal:** laat alle verkeer van ander instansies op die `default` netwerk toe
* **default-allow-ssh:** laat 22 van oral toe
* **default-allow-rdp:** laat 3389 van oral toe
* **default-allow-icmp:** laat ping van oral toe

{% hint style="warning" %}
Soos jy kan sien, neig **firewall reÃ«ls** om **meer toelaatbaar** te wees vir **interne IP adresse**. Die standaard VPC laat alle verkeer tussen Compute Instances toe.
{% endhint %}

Meer **Firewall reÃ«ls** kan geskep word vir die standaard VPC of vir nuwe VPCs. [**Firewall reÃ«ls**](https://cloud.google.com/vpc/docs/firewalls) kan op instansies toegepas word via die volgende **metodes**:

* [**Netwerk etikette**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Diens rekeninge**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Alle instansies binne 'n VPC**

Ongelukkig is daar nie 'n eenvoudige `gcloud` opdrag om al die Compute Instances met oop poorte op die internet uit te spit nie. Jy moet die punte tussen firewall reÃ«ls, netwerk etikette, diens rekeninge, en instansies verbind.

Hierdie proses is geoutomatiseer met behulp van [hierdie python skrip](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) wat die volgende sal uitvoer:

* CSV-lÃªer wat instansie, publieke IP, toegelate TCP, toegelate UDP toon
* nmap skandering om al die instansies op poorte in te teiken wat van die publieke internet toegelaat word (0.0.0.0/0)
* masscan om die volle TCP-reeks van daardie instansies te teiken wat ALLE TCP-poorte van die publieke internet toelaat (0.0.0.0/0)

### HiÃ«rargiese Firewall Beleide <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_HiÃ«rargiese firewall beleide_ laat jou toe om 'n **konsekwente firewall beleid oor jou organisasie te skep en af te dwing**. Jy kan **hiÃ«rargiese firewall beleide aan die organisasie** as 'n geheel of aan individuele **mappes** toewys. Hierdie beleide bevat reÃ«ls wat eksplisiet verbindings kan weier of toelaat.

Jy skep en pas firewall beleide toe as aparte stappe. Jy kan firewall beleide skep en toepas op die **organisasie of map knooppunte van die** [**hulpbron hiÃ«rargie**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). 'n Firewall beleid reÃ«l kan **verbinding blokkeer, verbinding toelaat, of firewall reÃ«l evaluering uitstel** na laer vlak mappes of VPC firewall reÃ«ls wat in VPC-netwerke gedefinieer is.

Standaard geld alle hiÃ«rargiese firewall beleid reÃ«ls vir alle VM's in alle projekte onder die organisasie of map waar die beleid geassosieer is. Jy kan egter **beperk watter VM's 'n gegewe reÃ«l kry** deur [teiken netwerke of teiken diens rekeninge](https://cloud.google.com/vpc/docs/firewall-policies#targets) spesifiek aan te dui.

Jy kan hier lees hoe om [**'n HiÃ«rargiese Firewall Beleid te skep**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Firewall ReÃ«ls Evaluering

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Organisasie: Firewall beleide toegewy aan die Organisasie
2. Map: Firewall beleide toegewy aan die Map
3. VPC: Firewall reÃ«ls toegewy aan die VPC
4. Globaal: 'n Ander tipe firewall reÃ«ls wat aan VPCs toegewy kan word
5. Streek: Firewall reÃ«ls geassosieer met die VPC netwerk van die VM se NIC en streek van die VM.

## VPC Netwerk Peering

Laat toe om twee Virtuele Privaat Wolk (VPC) netwerke te verbind sodat **hulpbronne in elke netwerk met mekaar kan kommunikeer**.\
Gepaarde VPC-netwerke kan in dieselfde projek wees, verskillende projekte van dieselfde organisasie, of **verskillende projekte van verskillende organisasies**.

Hierdie is die nodige toestemmings:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Meer in die dokumentasie**](https://cloud.google.com/vpc/docs/vpc-peering).

## Verwysings

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** ğŸ’¬ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
