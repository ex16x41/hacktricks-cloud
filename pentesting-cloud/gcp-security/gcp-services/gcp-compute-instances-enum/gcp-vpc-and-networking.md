# GCP - VPC & Networking

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **GCP Compute Networking in a Nutshell**

**VPCs** sadr≈æe **Firewall** pravila koja omoguƒáavaju dolazni saobraƒáaj ka VPC-u. VPCs takoƒëe sadr≈æe **podmre≈æe** u kojima ƒáe biti **povezane** **virtuelne ma≈°ine**.\
U poreƒëenju sa AWS-om, **Firewall** bi bio **najbli≈æa** stvar **AWS** **Security Groups i NACLs**, ali u ovom sluƒçaju su **definisani u VPC-u** a ne u svakoj instanci.

## **VPC, Podmre≈æe & Firewall u GCP**

Compute Instances su povezane **podmre≈æama** koje su deo **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). U GCP-u ne postoje sigurnosne grupe, postoje [**VPC firewall**](https://cloud.google.com/vpc/docs/firewalls) sa pravilima definisanim na ovom mre≈ænom nivou, ali primenjenim na svaku VM instancu.

### Podmre≈æe

**VPC** mo≈æe imati **several podmre≈æa**. Svaka **podmre≈æa je u 1 regionu**.

### Firewall

Po defaultu, svaka mre≈æa ima dva [**implicitna firewall pravila**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **dozvoli izlazni** i **odbaci ulazni**.

Kada se kreira GCP projekat, takoƒëe se kreira VPC pod nazivom **`default`**, sa sledeƒáim firewall pravilima:

* **default-allow-internal:** dozvoli sav saobraƒáaj od drugih instanci na `default` mre≈æi
* **default-allow-ssh:** dozvoli 22 sa svuda
* **default-allow-rdp:** dozvoli 3389 sa svuda
* **default-allow-icmp:** dozvoli ping sa svuda

{% hint style="warning" %}
Kao ≈°to mo≈æete videti, **firewall pravila** imaju tendenciju da budu **vi≈°e permisivna** za **interni IP adrese**. Podrazumevani VPC dozvoljava sav saobraƒáaj izmeƒëu Compute Instances.
{% endhint %}

Vi≈°e **Firewall pravila** mo≈æe se kreirati za podrazumevani VPC ili za nove VPCs. [**Firewall pravila**](https://cloud.google.com/vpc/docs/firewalls) mogu se primeniti na instance putem sledeƒáih **metoda**:

* [**Mre≈æni tagovi**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Servisni nalozi**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Sve instance unutar VPC-a**

Na≈æalost, ne postoji jednostavna `gcloud` komanda koja bi izbacila sve Compute Instances sa otvorenim portovima na internetu. Morate povezati taƒçke izmeƒëu firewall pravila, mre≈ænih tagova, servisnih naloga i instanci.

Ovaj proces je automatizovan kori≈°ƒáenjem [ovog python skripta](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) koji ƒáe izvesti sledeƒáe:

* CSV fajl koji prikazuje instancu, javni IP, dozvoljeni TCP, dozvoljeni UDP
* nmap skeniranje za ciljanje svih instanci na portovima koji su dozvoljeni za ulaz sa javnog interneta (0.0.0.0/0)
* masscan za ciljanje celog TCP opsega onih instanci koje dozvoljavaju SVE TCP portove sa javnog interneta (0.0.0.0/0)

### Hijerarhijske Firewall Politike <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hijerarhijske firewall politike_ vam omoguƒáavaju da kreirate i **sprovodite doslednu firewall politiku ≈°irom va≈°e organizacije**. Mo≈æete dodeliti **hijerarhijske firewall politike organizaciji** kao celini ili pojedinaƒçnim **folderima**. Ove politike sadr≈æe pravila koja mogu eksplicitno odbiti ili dozvoliti veze.

Kreirate i primenjujete firewall politike kao odvojene korake. Mo≈æete kreirati i primeniti firewall politike na **organizaciji ili folderima** [**resursne hijerarhije**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Pravilo firewall politike mo≈æe **blokirati veze, dozvoliti veze ili odlo≈æiti evaluaciju firewall pravila** na ni≈æe nivoe foldera ili VPC firewall pravila definisana u VPC mre≈æama.

Po defaultu, sva hijerarhijska firewall pravila primenjuju se na sve VM-ove u svim projektima pod organizacijom ili folderom gde je politika povezana. Meƒëutim, mo≈æete **ograniƒçiti koji VM-ovi dobijaju dato pravilo** specificirajuƒái [ciljane mre≈æe ili ciljne servisne naloge](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Mo≈æete proƒçitati ovde kako da [**kreirate Hijerarhijsku Firewall Politiku**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Evaluacija Firewall Pravila

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Firewall politike dodeljene organizaciji
2. Folder: Firewall politike dodeljene folderu
3. VPC: Firewall pravila dodeljena VPC-u
4. Global: Druga vrsta firewall pravila koja se mogu dodeliti VPC-ima
5. Regional: Firewall pravila povezana sa VPC mre≈æom NIC-a VM-a i regionom VM-a.

## VPC Mre≈æno Peering

Omoguƒáava povezivanje dve Virtual Private Cloud (VPC) mre≈æe tako da **resursi u svakoj mre≈æi mogu komunicirati** jedni s drugima.\
Povezane VPC mre≈æe mogu biti u istom projektu, razliƒçitim projektima iste organizacije, ili **razliƒçitim projektima razliƒçitih organizacija**.

Ovo su potrebne dozvole:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Vi≈°e u dokumentaciji**](https://cloud.google.com/vpc/docs/vpc-peering).

## Reference

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
