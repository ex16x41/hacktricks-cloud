# GCP - VPC & Networking

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **GCP Compute Networking in a Nutshell**

**VPCs** contiene reglas de **Firewall** para permitir el tr치fico entrante a la VPC. Las VPCs tambi칠n contienen **subredes** donde las **m치quinas virtuales** van a estar **conectadas**.\
Comparando con AWS, **Firewall** ser칤a lo **m치s cercano** a **AWS** **Security Groups y NACLs**, pero en este caso estas est치n **definidas en la VPC** y no en cada instancia.

## **VPC, Subredes & Firewalls en GCP**

Las Instancias de C칩mputo est치n conectadas a **subredes** que son parte de **VPCs** ([Nubes Privadas Virtuales](https://cloud.google.com/vpc/docs/vpc)). En GCP no hay grupos de seguridad, hay [**firewalls de VPC**](https://cloud.google.com/vpc/docs/firewalls) con reglas definidas a este nivel de red pero aplicadas a cada instancia de VM.

### Subredes

Una **VPC** puede tener **varias subredes**. Cada **subred est치 en 1 regi칩n**.

### Firewalls

Por defecto, cada red tiene dos [**reglas de firewall impl칤citas**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **permitir salidas** y **denegar entradas**.

Cuando se crea un proyecto de GCP, tambi칠n se crea una VPC llamada **`default`**, con las siguientes reglas de firewall:

* **default-allow-internal:** permite todo el tr치fico de otras instancias en la red `default`
* **default-allow-ssh:** permite 22 desde cualquier lugar
* **default-allow-rdp:** permite 3389 desde cualquier lugar
* **default-allow-icmp:** permite ping desde cualquier lugar

{% hint style="warning" %}
Como puedes ver, las **reglas de firewall** tienden a ser **m치s permisivas** para las **direcciones IP internas**. La VPC por defecto permite todo el tr치fico entre las Instancias de C칩mputo.
{% endhint %}

Se pueden crear m치s **reglas de Firewall** para la VPC por defecto o para nuevas VPCs. [**Las reglas de Firewall**](https://cloud.google.com/vpc/docs/firewalls) se pueden aplicar a las instancias a trav칠s de los siguientes **m칠todos**:

* [**Etiquetas de red**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Cuentas de servicio**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Todas las instancias dentro de una VPC**

Desafortunadamente, no hay un comando simple de `gcloud` para listar todas las Instancias de C칩mputo con puertos abiertos en internet. Tienes que conectar los puntos entre las reglas de firewall, etiquetas de red, cuentas de servicio e instancias.

Este proceso fue automatizado usando [este script de python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) que exportar치 lo siguiente:

* Archivo CSV mostrando instancia, IP p칰blica, TCP permitido, UDP permitido
* Escaneo nmap para apuntar a todas las instancias en puertos de entrada permitidos desde internet p칰blico (0.0.0.0/0)
* masscan para apuntar al rango completo de TCP de aquellas instancias que permiten TODOS los puertos TCP desde internet p칰blico (0.0.0.0/0)

### Pol칤ticas de Firewall Jer치rquicas <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Las pol칤ticas de firewall jer치rquicas_ te permiten crear y **hacer cumplir una pol칤tica de firewall consistente en toda tu organizaci칩n**. Puedes asignar **pol칤ticas de firewall jer치rquicas a la organizaci칩n** en su conjunto o a **carpetas** individuales. Estas pol칤ticas contienen reglas que pueden denegar o permitir conexiones expl칤citamente.

Creas y aplicas pol칤ticas de firewall como pasos separados. Puedes crear y aplicar pol칤ticas de firewall en los **nodos de organizaci칩n o carpeta de la** [**jerarqu칤a de recursos**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Una regla de pol칤tica de firewall puede **bloquear conexiones, permitir conexiones o diferir la evaluaci칩n de reglas de firewall** a carpetas de menor nivel o reglas de firewall de VPC definidas en redes de VPC.

Por defecto, todas las reglas de pol칤ticas de firewall jer치rquicas se aplican a todas las VM en todos los proyectos bajo la organizaci칩n o carpeta donde se asocia la pol칤tica. Sin embargo, puedes **restringir qu칠 VM reciben una regla dada** especificando [redes objetivo o cuentas de servicio objetivo](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Puedes leer aqu칤 c칩mo [**crear una Pol칤tica de Firewall Jer치rquica**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Evaluaci칩n de Reglas de Firewall

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Pol칤ticas de firewall asignadas a la Organizaci칩n
2. Carpeta: Pol칤ticas de firewall asignadas a la Carpeta
3. VPC: Reglas de firewall asignadas a la VPC
4. Global: Otro tipo de reglas de firewall que pueden ser asignadas a VPCs
5. Regional: Reglas de firewall asociadas con la red VPC de la NIC de la VM y regi칩n de la VM.

## VPC Network Peering

Permite conectar dos redes de Nube Privada Virtual (VPC) para que **los recursos en cada red puedan comunicarse** entre s칤.\
Las redes VPC emparejadas pueden estar en el mismo proyecto, en diferentes proyectos de la misma organizaci칩n, o **en diferentes proyectos de diferentes organizaciones**.

Estos son los permisos necesarios:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**M치s en la documentaci칩n**](https://cloud.google.com/vpc/docs/vpc-peering).

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
