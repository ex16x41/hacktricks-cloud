# GCP - VPC & Networking

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **GCP è®¡ç®—ç½‘ç»œæ¦‚è¿°**

**VPCs** åŒ…å« **é˜²ç«å¢™** è§„åˆ™ä»¥å…è®¸ä¼ å…¥æµé‡åˆ° VPCã€‚VPC è¿˜åŒ…å« **å­ç½‘ç»œ**ï¼Œå…¶ä¸­ **è™šæ‹Ÿæœº** å°†è¢« **è¿æ¥**ã€‚\
ä¸ AWS ç›¸æ¯”ï¼Œ**é˜²ç«å¢™** æ˜¯ **AWS** **å®‰å…¨ç»„å’Œ NACLs** çš„ **æœ€æ¥è¿‘** äº‹ç‰©ï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™äº›æ˜¯åœ¨ **VPC** ä¸­å®šä¹‰çš„ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ªå®ä¾‹ä¸­ã€‚

## **GCP ä¸­çš„ VPCã€å­ç½‘ç»œå’Œé˜²ç«å¢™**

è®¡ç®—å®ä¾‹è¿æ¥åˆ° **å­ç½‘ç»œ**ï¼Œè¿™äº›å­ç½‘ç»œæ˜¯ **VPCs** çš„ä¸€éƒ¨åˆ† ([è™šæ‹Ÿç§æœ‰äº‘](https://cloud.google.com/vpc/docs/vpc))ã€‚åœ¨ GCP ä¸­æ²¡æœ‰å®‰å…¨ç»„ï¼Œåªæœ‰ [**VPC é˜²ç«å¢™**](https://cloud.google.com/vpc/docs/firewalls)ï¼Œå…¶è§„åˆ™åœ¨æ­¤ç½‘ç»œçº§åˆ«å®šä¹‰ï¼Œä½†åº”ç”¨äºæ¯ä¸ª VM å®ä¾‹ã€‚

### å­ç½‘ç»œ

ä¸€ä¸ª **VPC** å¯ä»¥æœ‰ **å¤šä¸ªå­ç½‘ç»œ**ã€‚æ¯ä¸ª **å­ç½‘ç»œä½äº 1 ä¸ªåŒºåŸŸ**ã€‚

### é˜²ç«å¢™

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªç½‘ç»œéƒ½æœ‰ä¸¤ä¸ª [**éšå«é˜²ç«å¢™è§„åˆ™**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules)ï¼š**å…è®¸å‡ºç«™** å’Œ **æ‹’ç»å…¥ç«™**ã€‚

å½“åˆ›å»º GCP é¡¹ç›®æ—¶ï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªåä¸º **`default`** çš„ VPCï¼Œå…·æœ‰ä»¥ä¸‹é˜²ç«å¢™è§„åˆ™ï¼š

* **default-allow-internal:** å…è®¸æ¥è‡ª `default` ç½‘ç»œä¸Šå…¶ä»–å®ä¾‹çš„æ‰€æœ‰æµé‡
* **default-allow-ssh:** å…è®¸æ¥è‡ªä»»ä½•åœ°æ–¹çš„ 22 ç«¯å£
* **default-allow-rdp:** å…è®¸æ¥è‡ªä»»ä½•åœ°æ–¹çš„ 3389 ç«¯å£
* **default-allow-icmp:** å…è®¸æ¥è‡ªä»»ä½•åœ°æ–¹çš„ ping

{% hint style="warning" %}
å¦‚æ‚¨æ‰€è§ï¼Œ**é˜²ç«å¢™è§„åˆ™** å¯¹äº **å†…éƒ¨ IP åœ°å€** é€šå¸¸æ˜¯ **æ›´å®½æ¾** çš„ã€‚é»˜è®¤ VPC å…è®¸è®¡ç®—å®ä¾‹ä¹‹é—´çš„æ‰€æœ‰æµé‡ã€‚
{% endhint %}

å¯ä»¥ä¸ºé»˜è®¤ VPC æˆ–æ–° VPC åˆ›å»ºæ›´å¤š **é˜²ç«å¢™è§„åˆ™**ã€‚ [**é˜²ç«å¢™è§„åˆ™**](https://cloud.google.com/vpc/docs/firewalls) å¯ä»¥é€šè¿‡ä»¥ä¸‹ **æ–¹æ³•** åº”ç”¨åˆ°å®ä¾‹ï¼š

* [**ç½‘ç»œæ ‡ç­¾**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**æœåŠ¡è´¦æˆ·**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **VPC ä¸­çš„æ‰€æœ‰å®ä¾‹**

ä¸å¹¸çš„æ˜¯ï¼Œæ²¡æœ‰ç®€å•çš„ `gcloud` å‘½ä»¤å¯ä»¥åˆ—å‡ºæ‰€æœ‰åœ¨äº’è”ç½‘ä¸Šå¼€æ”¾ç«¯å£çš„è®¡ç®—å®ä¾‹ã€‚æ‚¨å¿…é¡»å°†é˜²ç«å¢™è§„åˆ™ã€ç½‘ç»œæ ‡ç­¾ã€æœåŠ¡è´¦æˆ·å’Œå®ä¾‹ä¹‹é—´çš„å…³ç³»è¿æ¥èµ·æ¥ã€‚

è¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡ [è¿™ä¸ª python è„šæœ¬](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) è‡ªåŠ¨åŒ–çš„ï¼Œè¯¥è„šæœ¬å°†å¯¼å‡ºä»¥ä¸‹å†…å®¹ï¼š

* æ˜¾ç¤ºå®ä¾‹ã€å…¬å…± IPã€å…è®¸çš„ TCPã€å…è®¸çš„ UDP çš„ CSV æ–‡ä»¶
* nmap æ‰«æä»¥é’ˆå¯¹æ‰€æœ‰åœ¨å…¬å…±äº’è”ç½‘ï¼ˆ0.0.0.0/0ï¼‰ä¸Šå…è®¸çš„ç«¯å£çš„å®ä¾‹
* masscan é’ˆå¯¹å…è®¸æ¥è‡ªå…¬å…±äº’è”ç½‘ï¼ˆ0.0.0.0/0ï¼‰çš„æ‰€æœ‰ TCP ç«¯å£çš„å®ä¾‹çš„å®Œæ•´ TCP èŒƒå›´

### åˆ†å±‚é˜²ç«å¢™ç­–ç•¥ <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_åˆ†å±‚é˜²ç«å¢™ç­–ç•¥_ å…è®¸æ‚¨åˆ›å»ºå¹¶ **åœ¨æ•´ä¸ªç»„ç»‡ä¸­å¼ºåˆ¶æ‰§è¡Œä¸€è‡´çš„é˜²ç«å¢™ç­–ç•¥**ã€‚æ‚¨å¯ä»¥å°† **åˆ†å±‚é˜²ç«å¢™ç­–ç•¥åˆ†é…ç»™æ•´ä¸ªç»„ç»‡** æˆ–å•ä¸ª **æ–‡ä»¶å¤¹**ã€‚è¿™äº›ç­–ç•¥åŒ…å«å¯ä»¥æ˜ç¡®æ‹’ç»æˆ–å…è®¸è¿æ¥çš„è§„åˆ™ã€‚

æ‚¨å¯ä»¥å°†é˜²ç«å¢™ç­–ç•¥ä½œä¸ºå•ç‹¬çš„æ­¥éª¤åˆ›å»ºå’Œåº”ç”¨ã€‚æ‚¨å¯ä»¥åœ¨ [**èµ„æºå±‚æ¬¡ç»“æ„**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) çš„ **ç»„ç»‡æˆ–æ–‡ä»¶å¤¹èŠ‚ç‚¹** ä¸Šåˆ›å»ºå’Œåº”ç”¨é˜²ç«å¢™ç­–ç•¥ã€‚é˜²ç«å¢™ç­–ç•¥è§„åˆ™å¯ä»¥ **é˜»æ­¢è¿æ¥ã€å…è®¸è¿æ¥æˆ–å°†é˜²ç«å¢™è§„åˆ™è¯„ä¼°æ¨è¿Ÿ** åˆ°è¾ƒä½çº§åˆ«çš„æ–‡ä»¶å¤¹æˆ–åœ¨ VPC ç½‘ç»œä¸­å®šä¹‰çš„ VPC é˜²ç«å¢™è§„åˆ™ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰åˆ†å±‚é˜²ç«å¢™ç­–ç•¥è§„åˆ™é€‚ç”¨äºä¸ç­–ç•¥å…³è”çš„ç»„ç»‡æˆ–æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰é¡¹ç›®ä¸­çš„æ‰€æœ‰ VMã€‚ç„¶è€Œï¼Œæ‚¨å¯ä»¥é€šè¿‡æŒ‡å®š [ç›®æ ‡ç½‘ç»œæˆ–ç›®æ ‡æœåŠ¡è´¦æˆ·](https://cloud.google.com/vpc/docs/firewall-policies#targets) æ¥ **é™åˆ¶å“ªäº› VM è·å–ç‰¹å®šè§„åˆ™**ã€‚

æ‚¨å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»å¦‚ä½• [**åˆ›å»ºåˆ†å±‚é˜²ç«å¢™ç­–ç•¥**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)ã€‚

### é˜²ç«å¢™è§„åˆ™è¯„ä¼°

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. ç»„ç»‡ï¼šåˆ†é…ç»™ç»„ç»‡çš„é˜²ç«å¢™ç­–ç•¥
2. æ–‡ä»¶å¤¹ï¼šåˆ†é…ç»™æ–‡ä»¶å¤¹çš„é˜²ç«å¢™ç­–ç•¥
3. VPCï¼šåˆ†é…ç»™ VPC çš„é˜²ç«å¢™è§„åˆ™
4. å…¨å±€ï¼šå¯ä»¥åˆ†é…ç»™ VPC çš„å¦ä¸€ç§ç±»å‹çš„é˜²ç«å¢™è§„åˆ™
5. åŒºåŸŸï¼šä¸ VM çš„ NIC å’Œ VM æ‰€åœ¨åŒºåŸŸçš„ VPC ç½‘ç»œç›¸å…³è”çš„é˜²ç«å¢™è§„åˆ™ã€‚

## VPC ç½‘ç»œå¯¹ç­‰

å…è®¸è¿æ¥ä¸¤ä¸ªè™šæ‹Ÿç§æœ‰äº‘ (VPC) ç½‘ç»œï¼Œä»¥ä¾¿ **æ¯ä¸ªç½‘ç»œä¸­çš„èµ„æºå¯ä»¥ç›¸äº’é€šä¿¡**ã€‚\
å¯¹ç­‰çš„ VPC ç½‘ç»œå¯ä»¥åœ¨åŒä¸€é¡¹ç›®ä¸­ã€åŒä¸€ç»„ç»‡çš„ä¸åŒé¡¹ç›®ä¸­ï¼Œæˆ– **ä¸åŒç»„ç»‡çš„ä¸åŒé¡¹ç›®ä¸­**ã€‚

æ‰€éœ€çš„æƒé™å¦‚ä¸‹ï¼š

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**æ›´å¤šæ–‡æ¡£**](https://cloud.google.com/vpc/docs/vpc-peering)ã€‚

## å‚è€ƒ

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
