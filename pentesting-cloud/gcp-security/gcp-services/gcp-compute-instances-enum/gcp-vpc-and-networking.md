# GCP - VPC & Networking

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## **GCP Compute Networking en un coup d'≈ìil**

**Les VPC** contiennent des r√®gles de **pare-feu** pour permettre le trafic entrant vers le VPC. Les VPC contiennent √©galement des **sous-r√©seaux** o√π les **machines virtuelles** vont √™tre **connect√©es**.\
Compar√© √† AWS, le **pare-feu** serait la chose **la plus proche** des **Groupes de S√©curit√© et NACLs** d'**AWS**, mais dans ce cas, ceux-ci sont **d√©finis dans le VPC** et non dans chaque instance.

## **VPC, Sous-r√©seaux & Pare-feu dans GCP**

Les instances de calcul sont connect√©es √† des **sous-r√©seaux** qui font partie des **VPC** ([Clouds Priv√©s Virtuels](https://cloud.google.com/vpc/docs/vpc)). Dans GCP, il n'y a pas de groupes de s√©curit√©, il y a des [**pare-feu VPC**](https://cloud.google.com/vpc/docs/firewalls) avec des r√®gles d√©finies √† ce niveau de r√©seau mais appliqu√©es √† chaque instance VM.

### Sous-r√©seaux

Un **VPC** peut avoir **plusieurs sous-r√©seaux**. Chaque **sous-r√©seau est dans 1 r√©gion**.

### Pare-feu

Par d√©faut, chaque r√©seau a deux [**r√®gles de pare-feu implicites**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules) : **autoriser sortant** et **interdire entrant**.

Lorsqu'un projet GCP est cr√©√©, un VPC appel√© **`default`** est √©galement cr√©√©, avec les r√®gles de pare-feu suivantes :

* **default-allow-internal :** autoriser tout le trafic des autres instances sur le r√©seau `default`
* **default-allow-ssh :** autoriser 22 de partout
* **default-allow-rdp :** autoriser 3389 de partout
* **default-allow-icmp :** autoriser le ping de partout

{% hint style="warning" %}
Comme vous pouvez le voir, les **r√®gles de pare-feu** tendent √† √™tre **plus permissives** pour les **adresses IP internes**. Le VPC par d√©faut permet tout le trafic entre les instances de calcul.
{% endhint %}

D'autres **r√®gles de pare-feu** peuvent √™tre cr√©√©es pour le VPC par d√©faut ou pour de nouveaux VPC. Les [**r√®gles de pare-feu**](https://cloud.google.com/vpc/docs/firewalls) peuvent √™tre appliqu√©es aux instances via les **m√©thodes** suivantes :

* [**√âtiquettes de r√©seau**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Comptes de service**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Toutes les instances au sein d'un VPC**

Malheureusement, il n'y a pas de commande `gcloud` simple pour afficher toutes les instances de calcul avec des ports ouverts sur Internet. Vous devez relier les r√®gles de pare-feu, les √©tiquettes de r√©seau, les comptes de service et les instances.

Ce processus a √©t√© automatis√© √† l'aide de [ce script python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) qui exportera les √©l√©ments suivants :

* Fichier CSV montrant l'instance, l'IP publique, TCP autoris√©, UDP autoris√©
* Scan nmap pour cibler toutes les instances sur les ports d'entr√©e autoris√©s depuis Internet public (0.0.0.0/0)
* Masscan pour cibler l'ensemble de la plage TCP de ces instances qui autorisent TOUS les ports TCP depuis Internet public (0.0.0.0/0)

### Politiques de Pare-feu Hi√©rarchiques <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Les politiques de pare-feu hi√©rarchiques_ vous permettent de cr√©er et **d'appliquer une politique de pare-feu coh√©rente √† travers votre organisation**. Vous pouvez attribuer des **politiques de pare-feu hi√©rarchiques √† l'organisation** dans son ensemble ou √† des **dossiers** individuels. Ces politiques contiennent des r√®gles qui peuvent explicitement interdire ou autoriser des connexions.

Vous cr√©ez et appliquez des politiques de pare-feu en tant qu'√©tapes distinctes. Vous pouvez cr√©er et appliquer des politiques de pare-feu aux **n≈ìuds d'organisation ou de dossier de la** [**hi√©rarchie des ressources**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Une r√®gle de politique de pare-feu peut **bloquer des connexions, autoriser des connexions ou diff√©rer l'√©valuation des r√®gles de pare-feu** vers des dossiers de niveau inf√©rieur ou des r√®gles de pare-feu VPC d√©finies dans des r√©seaux VPC.

Par d√©faut, toutes les r√®gles de politique de pare-feu hi√©rarchiques s'appliquent √† toutes les VM dans tous les projets sous l'organisation ou le dossier auquel la politique est associ√©e. Cependant, vous pouvez **restreindre quelles VM re√ßoivent une r√®gle donn√©e** en sp√©cifiant [des r√©seaux cibles ou des comptes de service cibles](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Vous pouvez lire ici comment [**cr√©er une Politique de Pare-feu Hi√©rarchique**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### √âvaluation des R√®gles de Pare-feu

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org : Politiques de pare-feu assign√©es √† l'organisation
2. Dossier : Politiques de pare-feu assign√©es au dossier
3. VPC : R√®gles de pare-feu assign√©es au VPC
4. Global : Un autre type de r√®gles de pare-feu qui peuvent √™tre assign√©es aux VPC
5. R√©gional : R√®gles de pare-feu associ√©es au r√©seau VPC de la NIC de la VM et √† la r√©gion de la VM.

## Peering de R√©seau VPC

Permet de connecter deux r√©seaux de Cloud Priv√© Virtuel (VPC) afin que **les ressources de chaque r√©seau puissent communiquer** entre elles.\
Les r√©seaux VPC en peering peuvent √™tre dans le m√™me projet, dans diff√©rents projets de la m√™me organisation, ou **dans diff√©rents projets de diff√©rentes organisations**.

Voici les permissions n√©cessaires :

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Plus dans la documentation**](https://cloud.google.com/vpc/docs/vpc-peering).

## R√©f√©rences

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
