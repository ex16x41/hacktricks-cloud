# GCP - VPC & Networking

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **GCP Compute Networking in a Nutshell**

**VPCs**ëŠ” VPCë¡œì˜ ìˆ˜ì‹  íŠ¸ë˜í”½ì„ í—ˆìš©í•˜ëŠ” **Firewall** ê·œì¹™ì„ í¬í•¨í•©ë‹ˆë‹¤. VPCëŠ” ë˜í•œ **ê°€ìƒ ë¨¸ì‹ **ì´ **ì—°ê²°ë ** **ì„œë¸Œë„¤íŠ¸ì›Œí¬**ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.\
AWSì™€ ë¹„êµí•  ë•Œ, **Firewall**ì€ **AWS** **Security Groups ë° NACLs**ì— ê°€ì¥ ê°€ê¹Œìš´ ê²ƒì´ì§€ë§Œ, ì´ ê²½ìš° ì´ëŸ¬í•œ ê·œì¹™ì€ ê° ì¸ìŠ¤í„´ìŠ¤ê°€ ì•„ë‹Œ **VPCì—ì„œ ì •ì˜ë©ë‹ˆë‹¤**.

## **VPC, Subnetworks & Firewalls in GCP**

Compute InstancesëŠ” **VPCs**ì˜ ì¼ë¶€ì¸ **ì„œë¸Œë„¤íŠ¸ì›Œí¬**ì— ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤ ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). GCPì—ëŠ” ë³´ì•ˆ ê·¸ë£¹ì´ ì—†ìœ¼ë©°, [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls)ë¡œ ë„¤íŠ¸ì›Œí¬ ìˆ˜ì¤€ì—ì„œ ì •ì˜ëœ ê·œì¹™ì´ ìˆì§€ë§Œ ê° VM ì¸ìŠ¤í„´ìŠ¤ì— ì ìš©ë©ë‹ˆë‹¤.

### Subnetworks

**VPC**ëŠ” **ì—¬ëŸ¬ ì„œë¸Œë„¤íŠ¸ì›Œí¬**ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê° **ì„œë¸Œë„¤íŠ¸ì›Œí¬ëŠ” 1ê°œ ì§€ì—­ì— ìˆìŠµë‹ˆë‹¤**.

### Firewalls

ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ë„¤íŠ¸ì›Œí¬ì—ëŠ” ë‘ ê°œì˜ [**ì•”ì‹œì  ë°©í™”ë²½ ê·œì¹™**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules)ì´ ìˆìŠµë‹ˆë‹¤: **outbound í—ˆìš©** ë° **inbound ê±°ë¶€**.

GCP í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ë©´ **`default`**ë¼ëŠ” VPCë„ ìƒì„±ë˜ë©°, ë‹¤ìŒ ë°©í™”ë²½ ê·œì¹™ì´ í¬í•¨ë©ë‹ˆë‹¤:

* **default-allow-internal:** `default` ë„¤íŠ¸ì›Œí¬ì˜ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ëª¨ë“  íŠ¸ë˜í”½ í—ˆìš©
* **default-allow-ssh:** ëª¨ë“  ê³³ì—ì„œ 22 í—ˆìš©
* **default-allow-rdp:** ëª¨ë“  ê³³ì—ì„œ 3389 í—ˆìš©
* **default-allow-icmp:** ëª¨ë“  ê³³ì—ì„œ ping í—ˆìš©

{% hint style="warning" %}
ë³´ì‹œë‹¤ì‹œí”¼, **ë°©í™”ë²½ ê·œì¹™**ì€ **ë‚´ë¶€ IP ì£¼ì†Œ**ì— ëŒ€í•´ **ë” ê´€ëŒ€**í•œ ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ VPCëŠ” Compute Instances ê°„ì˜ ëª¨ë“  íŠ¸ë˜í”½ì„ í—ˆìš©í•©ë‹ˆë‹¤.
{% endhint %}

ê¸°ë³¸ VPC ë˜ëŠ” ìƒˆ VPCì— ëŒ€í•´ ë” ë§ì€ **Firewall rules**ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. [**Firewall rules**](https://cloud.google.com/vpc/docs/firewalls)ëŠ” ë‹¤ìŒ **ë°©ë²•**ì„ í†µí•´ ì¸ìŠ¤í„´ìŠ¤ì— ì ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* [**Network tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Service accounts**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **VPC ë‚´ì˜ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤**

ë¶ˆí–‰íˆë„, ì¸í„°ë„·ì—ì„œ ì—´ë¦° í¬íŠ¸ë¥¼ ê°€ì§„ ëª¨ë“  Compute Instancesë¥¼ ì¶œë ¥í•˜ëŠ” ê°„ë‹¨í•œ `gcloud` ëª…ë ¹ì€ ì—†ìŠµë‹ˆë‹¤. ë°©í™”ë²½ ê·œì¹™, ë„¤íŠ¸ì›Œí¬ íƒœê·¸, ì„œë¹„ìŠ¤ ê³„ì • ë° ì¸ìŠ¤í„´ìŠ¤ ê°„ì˜ ì—°ê²°ì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.

ì´ í”„ë¡œì„¸ìŠ¤ëŠ” [ì´ íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum)ë¥¼ ì‚¬ìš©í•˜ì—¬ ìë™í™”ë˜ì—ˆìœ¼ë©°, ë‹¤ìŒì„ ë‚´ë³´ëƒ…ë‹ˆë‹¤:

* ì¸ìŠ¤í„´ìŠ¤, ê³µìš© IP, í—ˆìš©ëœ TCP, í—ˆìš©ëœ UDPë¥¼ ë³´ì—¬ì£¼ëŠ” CSV íŒŒì¼
* ê³µìš© ì¸í„°ë„·(0.0.0.0/0)ì—ì„œ í—ˆìš©ëœ í¬íŠ¸ë¡œ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ” nmap ìŠ¤ìº”
* ê³µìš© ì¸í„°ë„·(0.0.0.0/0)ì—ì„œ ëª¨ë“  TCP í¬íŠ¸ë¥¼ í—ˆìš©í•˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ì˜ ì „ì²´ TCP ë²”ìœ„ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ” masscan

### Hierarchical Firewall Policies <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_ê³„ì¸µì  ë°©í™”ë²½ ì •ì±…_ì„ ì‚¬ìš©í•˜ë©´ **ì¡°ì§ ì „ë°˜ì— ê±¸ì³ ì¼ê´€ëœ ë°©í™”ë²½ ì •ì±…ì„ ìƒì„±í•˜ê³  ì ìš©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **ê³„ì¸µì  ë°©í™”ë²½ ì •ì±…ì„ ì¡°ì§ ì „ì²´** ë˜ëŠ” ê°œë³„ **í´ë”**ì— í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì •ì±…ì—ëŠ” ì—°ê²°ì„ ëª…ì‹œì ìœ¼ë¡œ ê±°ë¶€í•˜ê±°ë‚˜ í—ˆìš©í•  ìˆ˜ ìˆëŠ” ê·œì¹™ì´ í¬í•¨ë©ë‹ˆë‹¤.

ë°©í™”ë²½ ì •ì±…ì„ ìƒì„±í•˜ê³  ì ìš©í•˜ëŠ” ê²ƒì€ ë³„ë„ì˜ ë‹¨ê³„ë¡œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤. [**ë¦¬ì†ŒìŠ¤ ê³„ì¸µ êµ¬ì¡°**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)ì˜ **ì¡°ì§ ë˜ëŠ” í´ë” ë…¸ë“œ**ì—ì„œ ë°©í™”ë²½ ì •ì±…ì„ ìƒì„±í•˜ê³  ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°©í™”ë²½ ì •ì±… ê·œì¹™ì€ **ì—°ê²°ì„ ì°¨ë‹¨í•˜ê±°ë‚˜, ì—°ê²°ì„ í—ˆìš©í•˜ê±°ë‚˜, ë°©í™”ë²½ ê·œì¹™ í‰ê°€ë¥¼ í•˜ìœ„ í´ë” ë˜ëŠ” VPC ë„¤íŠ¸ì›Œí¬ì— ì •ì˜ëœ VPC ë°©í™”ë²½ ê·œì¹™ìœ¼ë¡œ ì—°ê¸°**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ê³„ì¸µì  ë°©í™”ë²½ ì •ì±… ê·œì¹™ì€ ì •ì±…ì´ ì—°ê²°ëœ ì¡°ì§ ë˜ëŠ” í´ë” ì•„ë˜ì˜ ëª¨ë“  í”„ë¡œì íŠ¸ì˜ ëª¨ë“  VMì— ì ìš©ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ [ëŒ€ìƒ ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ëŒ€ìƒ ì„œë¹„ìŠ¤ ê³„ì •](https://cloud.google.com/vpc/docs/firewall-policies#targets)ì„ ì§€ì •í•˜ì—¬ **ì£¼ì–´ì§„ ê·œì¹™ì„ ë°›ì„ VMì„ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

ì—¬ê¸°ì—ì„œ [**ê³„ì¸µì  ë°©í™”ë²½ ì •ì±… ìƒì„± ë°©ë²•**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)ì„ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Firewall Rules Evaluation

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: ì¡°ì§ì— í• ë‹¹ëœ ë°©í™”ë²½ ì •ì±…
2. Folder: í´ë”ì— í• ë‹¹ëœ ë°©í™”ë²½ ì •ì±…
3. VPC: VPCì— í• ë‹¹ëœ ë°©í™”ë²½ ê·œì¹™
4. Global: VPCì— í• ë‹¹í•  ìˆ˜ ìˆëŠ” ë˜ ë‹¤ë¥¸ ìœ í˜•ì˜ ë°©í™”ë²½ ê·œì¹™
5. Regional: VMì˜ NIC ë° VMì˜ ì§€ì—­ê³¼ ê´€ë ¨ëœ VPC ë„¤íŠ¸ì›Œí¬ì˜ ë°©í™”ë²½ ê·œì¹™.

## VPC Network Peering

ë‘ ê°œì˜ Virtual Private Cloud (VPC) ë„¤íŠ¸ì›Œí¬ë¥¼ ì—°ê²°í•˜ì—¬ **ê° ë„¤íŠ¸ì›Œí¬ì˜ ë¦¬ì†ŒìŠ¤ê°€ ì„œë¡œ í†µì‹ í•  ìˆ˜ ìˆë„ë¡** í•©ë‹ˆë‹¤.\
í”¼ì–´ë§ëœ VPC ë„¤íŠ¸ì›Œí¬ëŠ” ë™ì¼í•œ í”„ë¡œì íŠ¸, ë™ì¼í•œ ì¡°ì§ì˜ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ ë˜ëŠ” **ë‹¤ë¥¸ ì¡°ì§ì˜ ë‹¤ë¥¸ í”„ë¡œì íŠ¸**ì— ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•„ìš”í•œ ê¶Œí•œì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**More in the docs**](https://cloud.google.com/vpc/docs/vpc-peering).

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
