# GCP - Compute Instances

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

Google Cloud Compute Instances æ˜¯ **Google äº‘åŸºç¡€è®¾æ–½ä¸Šçš„å¯å®šåˆ¶è™šæ‹Ÿæœº**ï¼Œæä¾›å¯æ‰©å±•å’ŒæŒ‰éœ€çš„è®¡ç®—èƒ½åŠ›ï¼Œé€‚ç”¨äºå¹¿æ³›çš„åº”ç”¨ç¨‹åºã€‚å®ƒä»¬æä¾›å…¨çƒéƒ¨ç½²ã€æŒä¹…å­˜å‚¨ã€çµæ´»çš„æ“ä½œç³»ç»Ÿé€‰æ‹©ä»¥åŠå¼ºå¤§çš„ç½‘ç»œå’Œå®‰å…¨é›†æˆç­‰åŠŸèƒ½ï¼Œä½¿å…¶æˆä¸ºåœ¨äº‘ä¸­é«˜æ•ˆæ‰˜ç®¡ç½‘ç«™ã€å¤„ç†æ•°æ®å’Œè¿è¡Œåº”ç”¨ç¨‹åºçš„å¤šåŠŸèƒ½é€‰æ‹©ã€‚

### Confidential VM

Confidential VMs ä½¿ç”¨ **åŸºäºç¡¬ä»¶çš„å®‰å…¨åŠŸèƒ½**ï¼Œç”±æœ€æ–°ä¸€ä»£çš„ AMD EPYC å¤„ç†å™¨æä¾›ï¼ŒåŒ…æ‹¬å†…å­˜åŠ å¯†å’Œå®‰å…¨åŠ å¯†è™šæ‹ŸåŒ–ã€‚è¿™äº›åŠŸèƒ½ä½¿ VM èƒ½å¤Ÿä¿æŠ¤å…¶å¤„ç†å’Œå­˜å‚¨çš„æ•°æ®ï¼Œç”šè‡³ä¸å—ä¸»æ“ä½œç³»ç»Ÿå’Œè™šæ‹Ÿæœºç›‘æ§ç¨‹åºçš„å½±å“ã€‚

è¦è¿è¡Œ Confidential VMï¼Œå¯èƒ½éœ€è¦ **æ›´æ”¹** è¯¸å¦‚ **æœºå™¨ç±»å‹**ã€ç½‘ç»œ **æ¥å£**ã€**å¯åŠ¨ç£ç›˜æ˜ åƒ** ç­‰å†…å®¹ã€‚

### ç£ç›˜å’Œç£ç›˜åŠ å¯†

å¯ä»¥ **é€‰æ‹©ç£ç›˜** ä½¿ç”¨æˆ– **åˆ›å»ºæ–°ç£ç›˜**ã€‚å¦‚æœé€‰æ‹©æ–°ç£ç›˜ï¼Œå¯ä»¥ï¼š

* é€‰æ‹©ç£ç›˜çš„ **å¤§å°**
* é€‰æ‹© **æ“ä½œç³»ç»Ÿ**
* æŒ‡å®šæ˜¯å¦å¸Œæœ› **åœ¨å®ä¾‹åˆ é™¤æ—¶åˆ é™¤ç£ç›˜**
* **åŠ å¯†**ï¼š**é»˜è®¤** ä½¿ç”¨ **Google ç®¡ç†çš„å¯†é’¥**ï¼Œä½†ä¹Ÿå¯ä»¥ **é€‰æ‹© KMS ä¸­çš„å¯†é’¥** æˆ–æŒ‡å®š **è¦ä½¿ç”¨çš„åŸå§‹å¯†é’¥**ã€‚

### éƒ¨ç½²å®¹å™¨

å¯ä»¥åœ¨è™šæ‹Ÿæœºå†…éƒ¨ç½² **å®¹å™¨**ã€‚\
å¯ä»¥é…ç½®è¦ä½¿ç”¨çš„ **é•œåƒ**ï¼Œè®¾ç½®åœ¨å†…éƒ¨è¿è¡Œçš„ **å‘½ä»¤**ã€**å‚æ•°**ã€æŒ‚è½½ **å·** å’Œ **ç¯å¢ƒå˜é‡**ï¼ˆæ•æ„Ÿä¿¡æ¯ï¼Ÿï¼‰ï¼Œå¹¶ä¸ºæ­¤å®¹å™¨é…ç½®å¤šä¸ªé€‰é¡¹ï¼Œå¦‚ä»¥ **ç‰¹æƒ** æ‰§è¡Œã€stdin å’Œä¼ª TTYã€‚

### æœåŠ¡è´¦æˆ·

é»˜è®¤æƒ…å†µä¸‹ï¼Œå°†ä½¿ç”¨ **Compute Engine é»˜è®¤æœåŠ¡è´¦æˆ·**ã€‚æ­¤ SA çš„ç”µå­é‚®ä»¶ç±»ä¼¼äºï¼š`<proj-num>-compute@developer.gserviceaccount.com`\
æ­¤æœåŠ¡è´¦æˆ·å¯¹æ•´ä¸ªé¡¹ç›®å…·æœ‰ **Editor è§’è‰²ï¼ˆé«˜æƒé™ï¼‰**ã€‚

é»˜è®¤è®¿é—®èŒƒå›´å¦‚ä¸‹ï¼š

* **https://www.googleapis.com/auth/devstorage.read\_only** -- è¯»å– bucket çš„è®¿é—®æƒé™ :)
* https://www.googleapis.com/auth/logging.write
* https://www.googleapis.com/auth/monitoring.write
* https://www.googleapis.com/auth/servicecontrol
* https://www.googleapis.com/auth/service.management.readonly
* https://www.googleapis.com/auth/trace.append

ä½†æ˜¯ï¼Œå¯ä»¥ **é€šè¿‡ç‚¹å‡»æˆäºˆ `cloud-platform`** æˆ–æŒ‡å®š **è‡ªå®šä¹‰èŒƒå›´**ã€‚

<figure><img src="../../../../.gitbook/assets/image (327).png" alt=""><figcaption></figcaption></figure>

### é˜²ç«å¢™

å¯ä»¥å…è®¸ HTTP å’Œ HTTPS æµé‡ã€‚

<figure><img src="../../../../.gitbook/assets/image (326).png" alt=""><figcaption></figcaption></figure>

### ç½‘ç»œ

* **IP è½¬å‘**ï¼šå¯ä»¥åœ¨å®ä¾‹åˆ›å»ºæ—¶ **å¯ç”¨ IP è½¬å‘**ã€‚
* **ä¸»æœºå**ï¼šå¯ä»¥ä¸ºå®ä¾‹æä¾›æ°¸ä¹…ä¸»æœºåã€‚
* **æ¥å£**ï¼šå¯ä»¥æ·»åŠ ç½‘ç»œæ¥å£ã€‚

### é¢å¤–å®‰å…¨

è¿™äº›é€‰é¡¹å°† **æé«˜ VM çš„å®‰å…¨æ€§**ï¼Œæ¨èä½¿ç”¨ï¼š

* **å®‰å…¨å¯åŠ¨**ï¼šå®‰å…¨å¯åŠ¨æœ‰åŠ©äºä¿æŠ¤æ‚¨çš„ VM å®ä¾‹å…å—å¯åŠ¨çº§å’Œå†…æ ¸çº§æ¶æ„è½¯ä»¶å’Œ rootkit çš„æ”»å‡»ã€‚
* **å¯ç”¨ vTPM**ï¼šè™šæ‹Ÿå¯ä¿¡å¹³å°æ¨¡å— (vTPM) éªŒè¯æ‚¨çš„å®¢æˆ·æœº VM çš„é¢„å¯åŠ¨å’Œå¯åŠ¨å®Œæ•´æ€§ï¼Œå¹¶æä¾›å¯†é’¥ç”Ÿæˆå’Œä¿æŠ¤ã€‚
* **å®Œæ•´æ€§ç›‘æ§**ï¼šå®Œæ•´æ€§ç›‘æ§å…è®¸æ‚¨ä½¿ç”¨ Stackdriver æŠ¥å‘Šç›‘æ§å’ŒéªŒè¯å—ä¿æŠ¤ VM å®ä¾‹çš„è¿è¡Œæ—¶å¯åŠ¨å®Œæ•´æ€§ã€‚éœ€è¦å¯ç”¨ vTPMã€‚

### VM è®¿é—®

å¯ç”¨ VM è®¿é—®çš„å¸¸è§æ–¹æ³•æ˜¯ **å…è®¸æŸäº› SSH å…¬é’¥** è®¿é—® VMã€‚\
ä½†æ˜¯ï¼Œä¹Ÿå¯ä»¥ **é€šè¿‡ `os-config` æœåŠ¡ä½¿ç”¨ IAM å¯ç”¨å¯¹ VM çš„è®¿é—®**ã€‚æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨æ­¤æœåŠ¡å¯ç”¨ 2FA è®¿é—® VMã€‚\
å½“ **å¯ç”¨æ­¤æœåŠ¡** æ—¶ï¼Œé€šè¿‡ **SSH å¯†é’¥çš„è®¿é—®å°†è¢«ç¦ç”¨**ã€‚

<figure><img src="../../../../.gitbook/assets/image (328).png" alt=""><figcaption></figcaption></figure>

### å…ƒæ•°æ®

å¯ä»¥å®šä¹‰ **è‡ªåŠ¨åŒ–**ï¼ˆAWS ä¸­çš„ userdataï¼‰ï¼Œè¿™äº›æ˜¯æ¯æ¬¡æœºå™¨å¯åŠ¨æˆ–é‡å¯æ—¶æ‰§è¡Œçš„ **shell å‘½ä»¤**ã€‚

è¿˜å¯ä»¥ **æ·»åŠ é¢å¤–çš„å…ƒæ•°æ®é”®å€¼å¯¹**ï¼Œè¿™äº›é”®å€¼å¯¹å¯ä»¥ä»å…ƒæ•°æ®ç«¯ç‚¹è®¿é—®ã€‚æ­¤ä¿¡æ¯é€šå¸¸ç”¨äºç¯å¢ƒå˜é‡å’Œå¯åŠ¨/å…³é—­è„šæœ¬ã€‚å¯ä»¥ä½¿ç”¨æšä¸¾éƒ¨åˆ†ä¸­çš„å‘½ä»¤çš„ **`describe` æ–¹æ³•** è·å–æ­¤ä¿¡æ¯ï¼Œä½†ä¹Ÿå¯ä»¥ä»å®ä¾‹å†…éƒ¨è®¿é—®å…ƒæ•°æ®ç«¯ç‚¹è·å–ã€‚
```bash
# view project metadata
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"

# view instance metadata
curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"
```
Moreover, **auth token for the attached service account** å’Œ **general info** å…³äºå®ä¾‹ã€ç½‘ç»œå’Œé¡¹ç›®çš„ä¿¡æ¯ä¹Ÿå¯ä»¥ä» **metadata endpoint** è·å–ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Encryption

é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ Google ç®¡ç†çš„åŠ å¯†å¯†é’¥ï¼Œä½†å¯ä»¥é…ç½®å®¢æˆ·ç®¡ç†çš„åŠ å¯†å¯†é’¥ (CMEK)ã€‚ä½ è¿˜å¯ä»¥é…ç½®åœ¨ä½¿ç”¨çš„ CMEK è¢«æ’¤é”€æ—¶è¯¥æ€ä¹ˆåšï¼šä¸åšä»»ä½•æ“ä½œæˆ–å…³é—­ VMã€‚

<figure><img src="../../../../.gitbook/assets/image (329).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram group**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
