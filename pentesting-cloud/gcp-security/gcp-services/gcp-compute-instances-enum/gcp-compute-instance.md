# GCP - Compute Instances

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Google Cloud Compute Instances son **m√°quinas virtuales personalizables en la infraestructura de nube de Google**, que ofrecen potencia de computaci√≥n escalable y bajo demanda para una amplia gama de aplicaciones. Proporcionan caracter√≠sticas como despliegue global, almacenamiento persistente, opciones flexibles de SO e integraciones s√≥lidas de red y seguridad, lo que las convierte en una opci√≥n vers√°til para alojar sitios web, procesar datos y ejecutar aplicaciones de manera eficiente en la nube.

### Confidential VM

Las Confidential VMs utilizan **caracter√≠sticas de seguridad basadas en hardware** ofrecidas por la √∫ltima generaci√≥n de procesadores AMD EPYC, que incluyen cifrado de memoria y virtualizaci√≥n cifrada segura. Estas caracter√≠sticas permiten que la VM proteja los datos procesados y almacenados dentro de ella, incluso del sistema operativo host y del hipervisor.

Para ejecutar una Confidential VM puede ser necesario **cambiar** cosas como el **tipo** de la **m√°quina**, la **interfaz** de red, la **imagen del disco de arranque**.

### Disk & Disk Encryption

Es posible **seleccionar el disco** a utilizar o **crear uno nuevo**. Si seleccionas uno nuevo puedes:

* Seleccionar el **tama√±o** del disco
* Seleccionar el **SO**
* Indicar si deseas **eliminar el disco cuando se elimine la instancia**
* **Cifrado**: Por **defecto** se utilizar√° una **clave gestionada por Google**, pero tambi√©n puedes **seleccionar una clave de KMS** o indicar **clave en bruto a utilizar**.

### Deploy Container

Es posible desplegar un **contenedor** dentro de la m√°quina virtual.\
Es posible configurar la **imagen** a utilizar, establecer el **comando** a ejecutar dentro, **argumentos**, montar un **volumen** y **variables de entorno** (¬øinformaci√≥n sensible?) y configurar varias opciones para este contenedor como ejecutar como **privilegiado**, stdin y pseudo TTY.

### Service Account

Por defecto, se utilizar√° la **cuenta de servicio predeterminada de Compute Engine**. El correo electr√≥nico de esta SA es como: `<proj-num>-compute@developer.gserviceaccount.com`\
Esta cuenta de servicio tiene **rol de Editor sobre todo el proyecto (altos privilegios).**

Y los **alcances de acceso predeterminados** son los siguientes:

* **https://www.googleapis.com/auth/devstorage.read\_only** -- Acceso de lectura a los buckets :)
* https://www.googleapis.com/auth/logging.write
* https://www.googleapis.com/auth/monitoring.write
* https://www.googleapis.com/auth/servicecontrol
* https://www.googleapis.com/auth/service.management.readonly
* https://www.googleapis.com/auth/trace.append

Sin embargo, es posible **otorgarle `cloud-platform` con un clic** o especificar **personalizados**.

<figure><img src="../../../../.gitbook/assets/image (327).png" alt=""><figcaption></figcaption></figure>

### Firewall

Es posible permitir tr√°fico HTTP y HTTPS.

<figure><img src="../../../../.gitbook/assets/image (326).png" alt=""><figcaption></figcaption></figure>

### Networking

* **IP Forwarding**: Es posible **habilitar el reenv√≠o de IP** desde la creaci√≥n de la instancia.
* **Hostname**: Es posible dar a la instancia un nombre de host permanente.
* **Interface**: Es posible agregar una interfaz de red.

### Extra Security

Estas opciones **aumentar√°n la seguridad** de la VM y se recomiendan:

* **Secure boot:** Secure boot ayuda a proteger tus instancias de VM contra malware y rootkits a nivel de arranque y de kernel.
* **Enable vTPM:** El M√≥dulo de Plataforma de Confianza Virtual (vTPM) valida la integridad de arranque y pre-arranque de tu VM invitada, y ofrece generaci√≥n y protecci√≥n de claves.
* **Integrity supervision:** La supervisi√≥n de integridad te permite monitorear y verificar la integridad de arranque en tiempo de ejecuci√≥n de tus instancias de VM protegidas utilizando informes de Stackdriver. Requiere que vTPM est√© habilitado.

### VM Access

La forma com√∫n de habilitar el acceso a la VM es **permitiendo ciertas claves p√∫blicas SSH** para acceder a la VM.\
Sin embargo, tambi√©n es posible **habilitar el acceso a la VM a trav√©s del servicio `os-config` utilizando IAM**. Adem√°s, es posible habilitar 2FA para acceder a la VM utilizando este servicio.\
Cuando este **servicio** est√° **habilitado**, el acceso a trav√©s de **claves SSH est√° deshabilitado.**

<figure><img src="../../../../.gitbook/assets/image (328).png" alt=""><figcaption></figcaption></figure>

### Metadata

Es posible definir **automatizaci√≥n** (userdata en AWS) que son **comandos de shell** que se ejecutar√°n cada vez que la m√°quina se encienda o reinicie.

Tambi√©n es posible **agregar valores clave-valor de metadatos adicionales** que ser√°n accesibles desde el punto final de metadatos. Esta informaci√≥n se utiliza com√∫nmente para variables de entorno y scripts de inicio/apagado. Esto se puede obtener utilizando el **m√©todo `describe`** de un comando en la secci√≥n de enumeraci√≥n, pero tambi√©n podr√≠a recuperarse desde dentro de la instancia accediendo al punto final de metadatos.
```bash
# view project metadata
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"

# view instance metadata
curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"
```
Adem√°s, **el token de autenticaci√≥n para la cuenta de servicio adjunta** y **informaci√≥n general** sobre la instancia, la red y el proyecto tambi√©n estar√°n disponibles desde el **punto final de metadatos**. Para m√°s informaci√≥n, consulta:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Cifrado

Se utiliza por defecto una clave de cifrado gestionada por Google, pero se puede configurar una clave de cifrado gestionada por el cliente (CMEK). Tambi√©n puedes configurar qu√© hacer cuando se revoque la CMEK utilizada: Notificar o apagar la VM.

<figure><img src="../../../../.gitbook/assets/image (329).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
