# GCP - Compute Instances

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Google Cloud Compute Instancesは、**Googleのクラウドインフラストラクチャ上のカスタマイズ可能な仮想マシン**であり、さまざまなアプリケーション向けにスケーラブルでオンデマンドのコンピューティングパワーを提供します。これらは、グローバル展開、永続ストレージ、柔軟なOSの選択、強力なネットワーキングおよびセキュリティ統合などの機能を提供し、ウェブサイトのホスティング、データ処理、アプリケーションの効率的な実行において多用途な選択肢となります。

### Confidential VM

Confidential VMは、最新世代のAMD EPYCプロセッサが提供する**ハードウェアベースのセキュリティ機能**を使用しており、メモリ暗号化や安全な暗号化仮想化が含まれています。これらの機能により、VMはホストオペレーティングシステムやハイパーバイザーからも処理および保存されたデータを保護できます。

Confidential VMを実行するには、**マシンの** **タイプ**、ネットワーク**インターフェース**、**ブートディスクイメージ**などを**変更**する必要がある場合があります。

### Disk & Disk Encryption

使用する**ディスク**を**選択**するか、**新しいディスクを作成**することが可能です。新しいディスクを選択した場合、次のことができます：

* **ディスクのサイズ**を選択
* **OS**を選択
* インスタンスが削除されたときに**ディスクを削除する**かどうかを指定
* **暗号化**：**デフォルト**で**Google管理キー**が使用されますが、KMSから**キーを選択**するか、**使用する生のキーを指定**することもできます。

### Deploy Container

仮想マシン内に**コンテナ**をデプロイすることが可能です。\
使用する**イメージ**を設定し、内部で実行する**コマンド**、**引数**、**ボリューム**をマウントし、**環境変数**（機密情報？）を設定し、このコンテナのために**特権**として実行する、標準入力および擬似TTYなどのいくつかのオプションを構成できます。

### Service Account

デフォルトでは、**Compute Engineのデフォルトサービスアカウント**が使用されます。このSAのメールは次のようになります：`<proj-num>-compute@developer.gserviceaccount.com`\
このサービスアカウントは、**プロジェクト全体に対するエディターロール（高い権限）**を持っています。

そして、**デフォルトのアクセススコープ**は次のとおりです：

* **https://www.googleapis.com/auth/devstorage.read\_only** -- バケットへの読み取りアクセス :)
* https://www.googleapis.com/auth/logging.write
* https://www.googleapis.com/auth/monitoring.write
* https://www.googleapis.com/auth/servicecontrol
* https://www.googleapis.com/auth/service.management.readonly
* https://www.googleapis.com/auth/trace.append

ただし、**クリックで`cloud-platform`を付与**するか、**カスタムのものを指定**することも可能です。

<figure><img src="../../../../.gitbook/assets/image (327).png" alt=""><figcaption></figcaption></figure>

### Firewall

HTTPおよびHTTPSトラフィックを許可することが可能です。

<figure><img src="../../../../.gitbook/assets/image (326).png" alt=""><figcaption></figcaption></figure>

### Networking

* **IP Forwarding**：インスタンスの作成時に**IPフォワーディングを有効にする**ことが可能です。
* **Hostname**：インスタンスに永続的なホスト名を付けることが可能です。
* **Interface**：ネットワークインターフェースを追加することが可能です。

### Extra Security

これらのオプションは、VMの**セキュリティを向上させ**、推奨されます：

* **Secure boot**：Secure bootは、VMインスタンスをブートレベルおよびカーネルレベルのマルウェアやルートキットから保護します。
* **Enable vTPM**：仮想トラステッドプラットフォームモジュール（vTPM）は、ゲストVMのプレブートおよびブートの整合性を検証し、キーの生成と保護を提供します。
* **Integrity supervision**：整合性監視により、Stackdriverレポートを使用してシールドされたVMインスタンスのランタイムブート整合性を監視および検証できます。vTPMを有効にする必要があります。

### VM Access

VMへのアクセスを有効にする一般的な方法は、**特定のSSH公開鍵**をVMにアクセスできるようにすることです。\
ただし、**IAMを使用して`os-config`サービスを介してVMへのアクセスを有効にする**ことも可能です。さらに、このサービスを使用してVMにアクセスするために2FAを有効にすることも可能です。\
この**サービス**が**有効**になっていると、**SSHキーによるアクセスは無効**になります。

<figure><img src="../../../../.gitbook/assets/image (328).png" alt=""><figcaption></figcaption></figure>

### Metadata

**オートメーション**（AWSのuserdata）を定義することが可能で、これは**シェルコマンド**であり、マシンが起動または再起動するたびに実行されます。

また、**メタデータエンドポイントからアクセス可能な追加のメタデータキー-バリュー**を**追加**することも可能です。この情報は、環境変数やスタートアップ/シャットダウンスクリプトに一般的に使用されます。これは、列挙セクションのコマンドからの**`describe`メソッド**を使用して取得できますが、インスタンス内からメタデータエンドポイントにアクセスして取得することもできます。
```bash
# view project metadata
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"

# view instance metadata
curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"
```
さらに、**添付されたサービスアカウントの認証トークン**と**インスタンス、ネットワーク、プロジェクトに関する一般情報**も**メタデータエンドポイント**から入手可能です。詳細については、以下を確認してください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### 暗号化

デフォルトではGoogle管理の暗号化キーが使用されますが、顧客管理の暗号化キー（CMEK）を設定することもできます。また、使用されているCMEKが取り消された場合の処理を設定することもできます：何もしないか、VMをシャットダウンします。

<figure><img src="../../../../.gitbook/assets/image (329).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。**

</details>
{% endhint %}
