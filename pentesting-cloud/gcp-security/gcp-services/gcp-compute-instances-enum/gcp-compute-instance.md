# GCP - Compute Instances

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informaci칩n B치sica

Google Cloud Compute Instances son **m치quinas virtuales personalizables en la infraestructura en la nube de Google**, que ofrecen potencia de c칩mputo escalable y bajo demanda para una amplia gama de aplicaciones. Proporcionan caracter칤sticas como despliegue global, almacenamiento persistente, opciones flexibles de SO e integraciones s칩lidas de red y seguridad, lo que las convierte en una opci칩n vers치til para alojar sitios web, procesar datos y ejecutar aplicaciones de manera eficiente en la nube.

### VM Confidencial

Las VMs confidenciales utilizan **caracter칤sticas de seguridad basadas en hardware** ofrecidas por la 칰ltima generaci칩n de procesadores AMD EPYC, que incluyen cifrado de memoria y virtualizaci칩n cifrada segura. Estas caracter칤sticas permiten que la VM proteja los datos procesados y almacenados dentro de ella, incluso del sistema operativo host y el hipervisor.

Para ejecutar una VM Confidencial puede ser necesario **cambiar** cosas como el **tipo** de la **m치quina**, la **interfaz de red**, la **imagen del disco de arranque**.

### Disco y Cifrado de Disco

Es posible **seleccionar el disco** a usar o **crear uno nuevo**. Si seleccionas uno nuevo puedes:

* Seleccionar el **tama침o** del disco
* Seleccionar el **SO**
* Indicar si deseas **eliminar el disco cuando se elimine la instancia**
* **Cifrado**: Por **defecto** se usar치 una **clave gestionada por Google**, pero tambi칠n puedes **seleccionar una clave de KMS** o indicar una **clave en bruto a usar**.

### Desplegar Contenedor

Es posible desplegar un **contenedor** dentro de la m치quina virtual.\
Es posible configurar la **imagen** a usar, establecer el **comando** a ejecutar dentro, **argumentos**, montar un **volumen**, y **variables de entorno** (쯜nformaci칩n sensible?) y configurar varias opciones para este contenedor como ejecutar como **privilegiado**, stdin y pseudo TTY.

### Cuenta de Servicio

Por defecto, se usar치 la **cuenta de servicio predeterminada de Compute Engine**. El correo electr칩nico de esta SA es algo como: `<proj-num>-compute@developer.gserviceaccount.com`\
Esta cuenta de servicio tiene **rol de Editor sobre todo el proyecto (altos privilegios).**

Y los **alcances de acceso predeterminados** son los siguientes:

* **https://www.googleapis.com/auth/devstorage.read\_only** -- Acceso de lectura a buckets :)
* https://www.googleapis.com/auth/logging.write
* https://www.googleapis.com/auth/monitoring.write
* https://www.googleapis.com/auth/servicecontrol
* https://www.googleapis.com/auth/service.management.readonly
* https://www.googleapis.com/auth/trace.append

Sin embargo, es posible **otorgarle `cloud-platform` con un clic** o especificar **personalizados**.

<figure><img src="../../../../.gitbook/assets/image (327).png" alt=""><figcaption></figcaption></figure>

### Firewall

Es posible permitir tr치fico HTTP y HTTPS.

<figure><img src="../../../../.gitbook/assets/image (326).png" alt=""><figcaption></figcaption></figure>

### Redes

* **Reenv칤o de IP**: Es posible **habilitar el reenv칤o de IP** desde la creaci칩n de la instancia.
* **Nombre de Host**: Es posible darle a la instancia un nombre de host permanente.
* **Interfaz**: Es posible agregar una interfaz de red.

### Seguridad Extra

Estas opciones **aumentar치n la seguridad** de la VM y son recomendadas:

* **Arranque seguro:** El arranque seguro ayuda a proteger tus instancias de VM contra malware a nivel de arranque y kernel y rootkits.
* **Habilitar vTPM:** El M칩dulo de Plataforma Confiable Virtual (vTPM) valida la integridad de pre-arranque y arranque de tu VM invitada, y ofrece generaci칩n y protecci칩n de claves.
* **Supervisi칩n de integridad:** La supervisi칩n de integridad te permite monitorear y verificar la integridad de arranque en tiempo de ejecuci칩n de tus instancias de VM protegidas usando informes de Stackdriver. Requiere que vTPM est칠 habilitado.

### Acceso a la VM

La forma com칰n de habilitar el acceso a la VM es **permitiendo ciertas claves p칰blicas SSH** para acceder a la VM.\
Sin embargo, tambi칠n es posible **habilitar el acceso a la VM mediante el servicio `os-config` usando IAM**. Adem치s, es posible habilitar 2FA para acceder a la VM usando este servicio.\
Cuando este **servicio** est치 **habilitado**, el acceso mediante **claves SSH est치 deshabilitado.**

<figure><img src="../../../../.gitbook/assets/image (328).png" alt=""><figcaption></figcaption></figure>

### Metadatos

Es posible definir **automatizaci칩n** (userdata en AWS) que son **comandos shell** que se ejecutar치n cada vez que la m치quina se encienda o reinicie.

Tambi칠n es posible **agregar valores de metadatos clave-valor adicionales** que ser치n accesibles desde el endpoint de metadatos. Esta informaci칩n se usa com칰nmente para variables de entorno y scripts de inicio/apagado. Esto se puede obtener usando el **m칠todo `describe`** desde un comando en la secci칩n de enumeraci칩n, pero tambi칠n se podr칤a recuperar desde dentro de la instancia accediendo al endpoint de metadatos.
```bash
# view project metadata
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"

# view instance metadata
curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"
```
Moreover, **auth token for the attached service account** y **informaci칩n general** sobre la instancia, red y proyecto tambi칠n estar치n disponibles desde el **metadata endpoint**. Para m치s informaci칩n, consulta:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Encryption

Una clave de cifrado gestionada por Google se usa por defecto, pero se puede configurar una clave de cifrado gestionada por el cliente (CMEK). Tambi칠n puedes configurar qu칠 hacer cuando se revoca la CMEK utilizada: Nada o apagar la VM.

<figure><img src="../../../../.gitbook/assets/image (329).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
