# GCP - IAM, Principals & Org Policies Enum

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## æœåŠ¡è´¦æˆ·

æœ‰å…³æœåŠ¡è´¦æˆ·çš„ä»‹ç»ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### æšä¸¾

æœåŠ¡è´¦æˆ·å§‹ç»ˆå±äºä¸€ä¸ªé¡¹ç›®ï¼š
```bash
gcloud iam service-accounts list --project <project>
```
## ç”¨æˆ·ä¸ç»„

æœ‰å…³ GCP ä¸­ç”¨æˆ·ä¸ç»„å¦‚ä½•å·¥ä½œçš„ä»‹ç»ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### æšä¸¾

é€šè¿‡æƒé™ **`serviceusage.services.enable`** å’Œ **`serviceusage.services.use`**ï¼Œå¯ä»¥åœ¨é¡¹ç›®ä¸­ **å¯ç”¨æœåŠ¡** å¹¶ä½¿ç”¨å®ƒä»¬ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒWorkspace ç”¨æˆ·è¢«æˆäºˆ **é¡¹ç›®åˆ›å»ºè€…** è§’è‰²ï¼Œä½¿ä»–ä»¬èƒ½å¤Ÿ **åˆ›å»ºæ–°é¡¹ç›®**ã€‚å½“ç”¨æˆ·åˆ›å»ºé¡¹ç›®æ—¶ï¼Œä»–ä¼šè¢«æˆäºˆè¯¥é¡¹ç›®çš„ **`owner`** è§’è‰²ã€‚å› æ­¤ï¼Œä»–å¯ä»¥ **åœ¨é¡¹ç›®ä¸Šå¯ç”¨è¿™äº›æœåŠ¡ä»¥ä¾¿èƒ½å¤Ÿæšä¸¾ Workspace**ã€‚

ç„¶è€Œï¼Œè¯·æ³¨æ„ï¼Œè¿˜éœ€è¦åœ¨ Workspace ä¸­æ‹¥æœ‰ **è¶³å¤Ÿçš„æƒé™** æ‰èƒ½è°ƒç”¨è¿™äº› APIã€‚
{% endhint %}

å¦‚æœæ‚¨å¯ä»¥ **å¯ç”¨ `admin` æœåŠ¡**ï¼Œå¹¶ä¸”æ‚¨çš„ç”¨æˆ·åœ¨ Workspace ä¸­æ‹¥æœ‰ **è¶³å¤Ÿçš„æƒé™**ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç  **æšä¸¾æ‰€æœ‰ç»„å’Œç”¨æˆ·**ã€‚\
å³ä½¿å®ƒè¯´ **`identity groups`**ï¼Œå®ƒä¹Ÿä¼šè¿”å› **æ²¡æœ‰ä»»ä½•ç»„çš„ç”¨æˆ·**ï¼š

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œå‚æ•° `--labels` æ˜¯å¿…éœ€çš„ï¼Œå› æ­¤ä½¿ç”¨äº†ä¸€ä¸ªé€šç”¨å€¼ï¼ˆå¦‚æœæ‚¨ç›´æ¥ä½¿ç”¨ APIï¼Œå°±ä¸éœ€è¦è¿™ä¸ªå‚æ•°ï¼Œå¦‚ [**PurplePanda åœ¨è¿™é‡Œæ‰€åšçš„**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py)ï¼‰ã€‚
{% endhint %}

å³ä½¿å¯ç”¨äº†ç®¡ç†å‘˜æœåŠ¡ï¼Œæ‚¨ä¹Ÿå¯èƒ½ä¼šå› ä¸ºè¢«æ”»é™·çš„å·¥ä½œåŒºç”¨æˆ·æƒé™ä¸è¶³è€Œåœ¨æšä¸¾æ—¶é‡åˆ°é”™è¯¯ï¼š

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

æŸ¥çœ‹ [**æ­¤å¤„ä»¥è·å–æœ‰å…³ IAM çš„åŸºæœ¬ä¿¡æ¯**](../gcp-basic-information/#iam-roles)ã€‚

### é»˜è®¤æƒé™

æ ¹æ® [**æ–‡æ¡£**](https://cloud.google.com/resource-manager/docs/default-access-control)ï¼šå½“åˆ›å»ºç»„ç»‡èµ„æºæ—¶ï¼Œæ‚¨åŸŸä¸­çš„æ‰€æœ‰ç”¨æˆ·é»˜è®¤è¢«æˆäºˆ **è®¡è´¹è´¦æˆ·åˆ›å»ºè€…** å’Œ **é¡¹ç›®åˆ›å»ºè€…** è§’è‰²ã€‚è¿™äº›é»˜è®¤è§’è‰²å…è®¸æ‚¨çš„ç”¨æˆ·ç«‹å³å¼€å§‹ä½¿ç”¨ Google Cloudï¼Œä½†ä¸é€‚ç”¨äºæ‚¨ç»„ç»‡èµ„æºçš„å¸¸è§„æ“ä½œã€‚

è¿™äº› **è§’è‰²** æˆäºˆ **æƒé™**ï¼š

* `billing.accounts.create` å’Œ `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` å’Œ `resourcemanager.projects.create`

æ­¤å¤–ï¼Œå½“ç”¨æˆ·åˆ›å»ºé¡¹ç›®æ—¶ï¼Œä»–ä¼šæ ¹æ® [æ–‡æ¡£](https://cloud.google.com/resource-manager/docs/access-control-proj) **è‡ªåŠ¨è·å¾—è¯¥é¡¹ç›®çš„æ‰€æœ‰è€…**ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å°†èƒ½å¤Ÿåˆ›å»ºé¡¹ç›®å¹¶åœ¨å…¶ä¸Šè¿è¡Œä»»ä½•æœåŠ¡ï¼ˆçŸ¿å·¥ï¼Ÿå·¥ä½œåŒºæšä¸¾ï¼Ÿ...ï¼‰

{% hint style="danger" %}
GCP ç»„ç»‡ä¸­çš„æœ€é«˜æƒé™æ˜¯ **ç»„ç»‡ç®¡ç†å‘˜** è§’è‰²ã€‚
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

åœ¨å¤§å¤šæ•°æœåŠ¡ä¸­ï¼Œæ‚¨å°†èƒ½å¤Ÿä½¿ç”¨ **`add-iam-policy-binding`** æˆ– **`set-iam-policy`** æ–¹æ³•æ›´æ”¹èµ„æºçš„æƒé™ã€‚ä¸»è¦åŒºåˆ«åœ¨äº **`add-iam-policy-binding` ä¼šå°†æ–°çš„è§’è‰²ç»‘å®šæ·»åŠ ** åˆ°ç°æœ‰çš„ IAM ç­–ç•¥ï¼Œè€Œ **`set-iam-policy`** å°† **åˆ é™¤ä¹‹å‰** æˆäºˆçš„æƒé™ï¼Œå¹¶ **ä»…è®¾ç½®å‘½ä»¤ä¸­æŒ‡ç¤ºçš„æƒé™**ã€‚

### æšä¸¾
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### cloudasset IAM Enumeration

æœ‰ä¸åŒçš„æ–¹æ³•å¯ä»¥æ£€æŸ¥ç”¨æˆ·åœ¨ä¸åŒèµ„æºï¼ˆå¦‚ç»„ç»‡ã€æ–‡ä»¶å¤¹ã€é¡¹ç›®ç­‰ï¼‰ä¸­çš„æ‰€æœ‰æƒé™ï¼Œä½¿ç”¨æ­¤æœåŠ¡ã€‚

* æƒé™ **`cloudasset.assets.searchAllIamPolicies`** å¯ä»¥è¯·æ±‚ **èµ„æºå†…çš„æ‰€æœ‰ iam ç­–ç•¥**ã€‚
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* æƒé™ **`cloudasset.assets.analyzeIamPolicy`** å¯ä»¥è¯·æ±‚èµ„æºå†…æŸä¸ªä¸»ä½“çš„ **æ‰€æœ‰ iam ç­–ç•¥**ã€‚
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* æƒé™ **`cloudasset.assets.searchAllResources`** å…è®¸åˆ—å‡ºä¸€ä¸ªç»„ç»‡ã€æ–‡ä»¶å¤¹æˆ–é¡¹ç›®çš„æ‰€æœ‰èµ„æºã€‚åŒ…æ‹¬ä¸IAMç›¸å…³çš„èµ„æºï¼ˆå¦‚è§’è‰²ï¼‰ã€‚
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* æƒé™ **`cloudasset.assets.analyzeMove`** ä¹Ÿå¯èƒ½å¯¹æ£€ç´¢å½±å“èµ„æºï¼ˆå¦‚é¡¹ç›®ï¼‰çš„ç­–ç•¥æœ‰ç”¨
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* æˆ‘æƒ³æƒé™ **`cloudasset.assets.queryIamPolicy`** ä¹Ÿå¯ä»¥è®¿é—®æŸ¥æ‰¾ä¸»ä½“çš„æƒé™
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### testIamPermissions enumeration

{% hint style="danger" %}
å¦‚æœæ‚¨**æ— æ³•é€šè¿‡ä¹‹å‰çš„æ–¹æ³•è®¿é—®IAMä¿¡æ¯**å¹¶ä¸”æ‚¨åœ¨çº¢é˜Ÿä¸­ã€‚æ‚¨å¯ä»¥**ä½¿ç”¨å·¥å…·**[ **https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **æ¥æš´åŠ›ç ´è§£æ‚¨å½“å‰çš„æƒé™ã€‚**

ä½†æ˜¯ï¼Œè¯·æ³¨æ„éœ€è¦å¯ç”¨æœåŠ¡**`cloudresourcemanager.googleapis.com`**ã€‚
{% endhint %}

### Privesc

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨IAMæƒé™ä»¥æå‡ç‰¹æƒ**ï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Unauthenticated Enum <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Persistence

å¦‚æœæ‚¨æ‹¥æœ‰é«˜æƒé™ï¼Œæ‚¨å¯ä»¥ï¼š

* åˆ›å»ºæ–°çš„æœåŠ¡è´¦æˆ·ï¼ˆæˆ–åœ¨Workspaceä¸­åˆ›å»ºç”¨æˆ·ï¼‰
* ç»™æ‚¨æ§åˆ¶çš„ä¸»ä½“æ›´å¤šæƒé™
* ç»™è„†å¼±çš„æœåŠ¡è´¦æˆ·æ›´å¤šç‰¹æƒï¼ˆVMä¸­çš„SSRFï¼Œè„†å¼±çš„Cloud Functionâ€¦ï¼‰
* â€¦

## Org Policies

æœ‰å…³Org Policiesæ˜¯ä»€ä¹ˆçš„ä»‹ç»ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

IAMç­–ç•¥æŒ‡ç¤ºä¸»ä½“å¯¹èµ„æºçš„æƒé™é€šè¿‡è§’è‰²åˆ†é…ï¼Œè¿™äº›è§’è‰²åˆ†é…äº†ç»†ç²’åº¦çš„æƒé™ã€‚ç»„ç»‡ç­–ç•¥**é™åˆ¶è¿™äº›æœåŠ¡çš„ä½¿ç”¨æ–¹å¼æˆ–ç¦ç”¨å“ªäº›åŠŸèƒ½**ã€‚è¿™æœ‰åŠ©äºæé«˜GCPç¯å¢ƒä¸­æ¯ä¸ªèµ„æºçš„æœ€å°æƒé™ã€‚
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨ç»„ç»‡æ”¿ç­–æƒé™ä»¥æå‡ç‰¹æƒ**ï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘ä»¬åœ¨**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
