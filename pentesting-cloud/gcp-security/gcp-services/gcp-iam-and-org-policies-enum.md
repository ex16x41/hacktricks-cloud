# GCP - IAM, Principals & Org Policies Enum

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Dienstkonten

F√ºr eine Einf√ºhrung, was ein Dienstkonto ist, siehe:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Aufz√§hlung

Ein Dienstkonto geh√∂rt immer zu einem Projekt:
```bash
gcloud iam service-accounts list --project <project>
```
## Benutzer & Gruppen

F√ºr eine Einf√ºhrung, wie Benutzer & Gruppen in GCP funktionieren, siehe:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Aufz√§hlung

Mit den Berechtigungen **`serviceusage.services.enable`** und **`serviceusage.services.use`** ist es m√∂glich, **Dienste** in einem Projekt zu **aktivieren** und sie zu nutzen.

{% hint style="danger" %}
Beachte, dass standardm√§√üig Workspace-Benutzern die Rolle **Projekt-Ersteller** zugewiesen wird, was ihnen den Zugang erm√∂glicht, **neue Projekte zu erstellen**. Wenn ein Benutzer ein Projekt erstellt, erh√§lt er die Rolle **`owner`** √ºber dieses. Daher k√∂nnte er **diese Dienste √ºber das Projekt aktivieren, um Workspace aufzulisten**.

Beachte jedoch, dass es auch erforderlich ist, **ausreichende Berechtigungen in Workspace** zu haben, um diese APIs aufrufen zu k√∂nnen.
{% endhint %}

Wenn du **den `admin` Dienst aktivieren** kannst und dein Benutzer **ausreichende Berechtigungen in Workspace hat,** k√∂nntest du **alle Gruppen & Benutzer auflisten** mit den folgenden Zeilen.\
Selbst wenn es **`identity groups`** sagt, gibt es auch **Benutzer ohne Gruppen** zur√ºck:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
In den vorherigen Beispielen ist der Parameter `--labels` erforderlich, daher wird ein generischer Wert verwendet (es ist nicht erforderlich, wenn Sie die API direkt verwenden, wie [**PurplePanda hier**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

Selbst wenn der Admin-Dienst aktiviert ist, kann es sein, dass Sie einen Fehler bei der Aufz√§hlung erhalten, da Ihr kompromittierter Workspace-Benutzer nicht √ºber ausreichende Berechtigungen verf√ºgt:

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

√úberpr√ºfen Sie [**dies f√ºr grundlegende Informationen zu IAM**](../gcp-basic-information/#iam-roles).

### Standardberechtigungen

Laut den [**Dokumenten**](https://cloud.google.com/resource-manager/docs/default-access-control): Wenn eine Organisationsressource erstellt wird, erhalten alle Benutzer in Ihrer Domain standardm√§√üig die Rollen **Billing Account Creator** und **Project Creator**. Diese Standardrollen erm√∂glichen es Ihren Benutzern, Google Cloud sofort zu nutzen, sind jedoch nicht f√ºr den regul√§ren Betrieb Ihrer Organisationsressource gedacht.

Diese **Rollen** gew√§hren die **Berechtigungen**:

* `billing.accounts.create` und `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` und `resourcemanager.projects.create`

Dar√ºber hinaus wird einem Benutzer, der ein Projekt erstellt, **automatisch der Eigent√ºmer dieses Projekts gew√§hrt**, gem√§√ü den [Dokumenten](https://cloud.google.com/resource-manager/docs/access-control-proj). Daher kann ein Benutzer standardm√§√üig ein Projekt erstellen und jeden Dienst darauf ausf√ºhren (Miner? Workspace-Aufz√§hlung? ...)

{% hint style="danger" %}
Das h√∂chste Privileg in einer GCP-Organisation ist die Rolle **Organization Administrator**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

In den meisten der Dienste k√∂nnen Sie die Berechtigungen √ºber eine Ressource mithilfe der Methode **`add-iam-policy-binding`** oder **`set-iam-policy`** √§ndern. Der Hauptunterschied besteht darin, dass **`add-iam-policy-binding` eine neue Rollenbindung** zur bestehenden IAM-Policy hinzuf√ºgt, w√§hrend **`set-iam-policy`** die zuvor gew√§hrten Berechtigungen **l√∂scht** und **nur die im Befehl angegebenen** festlegt.

### Aufz√§hlung
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### cloudasset IAM Enumeration

Es gibt verschiedene M√∂glichkeiten, alle Berechtigungen eines Benutzers in verschiedenen Ressourcen (wie Organisationen, Ordnern, Projekten...) mit diesem Dienst zu √ºberpr√ºfen.

* Die Berechtigung **`cloudasset.assets.searchAllIamPolicies`** kann **alle IAM-Richtlinien** innerhalb einer Ressource anfordern.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* Die Berechtigung **`cloudasset.assets.analyzeIamPolicy`** kann **alle IAM-Richtlinien** eines Subjekts innerhalb einer Ressource anfordern.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* Die Berechtigung **`cloudasset.assets.searchAllResources`** erm√∂glicht das Auflisten aller Ressourcen einer Organisation, eines Ordners oder eines Projekts. IAM-bezogene Ressourcen (wie Rollen) sind enthalten.
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* Die Berechtigung **`cloudasset.assets.analyzeMove`** kann auch n√ºtzlich sein, um Richtlinien abzurufen, die eine Ressource wie ein Projekt betreffen.
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Ich nehme an, dass die Berechtigung **`cloudasset.assets.queryIamPolicy`** auch Zugriff darauf geben k√∂nnte, die Berechtigungen von Prinzipalen zu finden.
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### testIamPermissions Enumeration

{% hint style="danger" %}
Wenn Sie **keinen Zugriff auf IAM-Informationen** mit den vorherigen Methoden haben und Sie sich im Red Team befinden, k√∂nnten Sie **das Tool** [**https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **verwenden, um Ihre aktuellen Berechtigungen zu brute-forcen.**

Beachten Sie jedoch, dass der Dienst **`cloudresourcemanager.googleapis.com`** aktiviert sein muss.
{% endhint %}

### Privesc

Auf der folgenden Seite k√∂nnen Sie √ºberpr√ºfen, wie Sie **IAM-Berechtigungen missbrauchen k√∂nnen, um Privilegien zu eskalieren**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Unauthenticated Enum <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unauthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Persistence

Wenn Sie hohe Privilegien haben, k√∂nnten Sie:

* Neue SAs (oder Benutzer, wenn in Workspace) erstellen
* Principals, die von Ihnen kontrolliert werden, mehr Berechtigungen geben
* Verwundbaren SAs (SSRF in vm, vuln Cloud Function‚Ä¶) mehr Privilegien geben
* ‚Ä¶

## Org-Richtlinien

F√ºr eine Einf√ºhrung, was Org-Richtlinien sind, √ºberpr√ºfen Sie:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

Die IAM-Richtlinien geben die Berechtigungen an, die Principals √ºber Ressourcen durch Rollen haben, die granularen Berechtigungen zugewiesen sind. Organisationsrichtlinien **beschr√§nken, wie diese Dienste genutzt werden k√∂nnen oder welche Funktionen deaktiviert sind**. Dies hilft, um das geringste Privileg jeder Ressource in der GCP-Umgebung zu verbessern.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

In der folgenden Seite kannst du √ºberpr√ºfen, wie man **Berechtigungen von Organisationsrichtlinien missbrauchen kann, um Privilegien zu eskalieren**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
