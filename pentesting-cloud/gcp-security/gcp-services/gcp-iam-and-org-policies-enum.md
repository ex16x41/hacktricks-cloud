# GCP - IAM, Principals & Org Policies Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## ì„œë¹„ìŠ¤ ê³„ì •

ì„œë¹„ìŠ¤ ê³„ì •ì— ëŒ€í•œ ì†Œê°œëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### ì—´ê±°

ì„œë¹„ìŠ¤ ê³„ì •ì€ í•­ìƒ í”„ë¡œì íŠ¸ì— ì†í•©ë‹ˆë‹¤:
```bash
gcloud iam service-accounts list --project <project>
```
## ì‚¬ìš©ì ë° ê·¸ë£¹

GCPì—ì„œ ì‚¬ìš©ì ë° ê·¸ë£¹ì´ ì‘ë™í•˜ëŠ” ë°©ì‹ì— ëŒ€í•œ ì†Œê°œëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### ì—´ê±°

ê¶Œí•œ **`serviceusage.services.enable`** ë° **`serviceusage.services.use`**ë¥¼ ì‚¬ìš©í•˜ë©´ í”„ë¡œì íŠ¸ì—ì„œ **ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”**í•˜ê³  ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="danger" %}
ê¸°ë³¸ì ìœ¼ë¡œ Workspace ì‚¬ìš©ìì—ê²ŒëŠ” **Project Creator** ì—­í• ì´ ë¶€ì—¬ë˜ì–´ **ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±**í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì´ ì£¼ì–´ì§„ë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì„¸ìš”. ì‚¬ìš©ìê°€ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ë©´ í•´ë‹¹ í”„ë¡œì íŠ¸ì— ëŒ€í•´ **`owner`** ì—­í• ì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ê·¸ëŠ” **Workspaceë¥¼ ì—´ê±°í•˜ê¸° ìœ„í•´ í”„ë¡œì íŠ¸ì—ì„œ ì´ëŸ¬í•œ ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì´ëŸ¬í•œ APIë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìœ¼ë ¤ë©´ **Workspaceì—ì„œ ì¶©ë¶„í•œ ê¶Œí•œ**ì´ í•„ìš”í•˜ë‹¤ëŠ” ì ë„ ì£¼ì˜í•˜ì„¸ìš”.
{% endhint %}

**`admin` ì„œë¹„ìŠ¤**ë¥¼ **í™œì„±í™”**í•  ìˆ˜ ìˆê³  ì‚¬ìš©ìê°€ **Workspaceì—ì„œ ì¶©ë¶„í•œ ê¶Œí•œ**ì„ ê°€ì§€ê³  ìˆë‹¤ë©´, ë‹¤ìŒ ì¤„ì„ ì‚¬ìš©í•˜ì—¬ **ëª¨ë“  ê·¸ë£¹ ë° ì‚¬ìš©ì**ë¥¼ **ì—´ê±°**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
**`identity groups`**ë¼ê³  í•˜ë”ë¼ë„ **ê·¸ë£¹ì´ ì—†ëŠ” ì‚¬ìš©ì**ë„ ë°˜í™˜ë©ë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
ì´ì „ ì˜ˆì œì—ì„œ `--labels` ë§¤ê°œë³€ìˆ˜ê°€ í•„ìš”í•˜ë¯€ë¡œ ì¼ë°˜ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤ (APIë¥¼ ì§ì ‘ ì‚¬ìš©í•œ ê²½ìš°ì—ëŠ” í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤, [**PurplePandaê°€ ì—¬ê¸°ì„œ í•˜ëŠ” ê²ƒì²˜ëŸ¼**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py)).
{% endhint %}

ê´€ë¦¬ì ì„œë¹„ìŠ¤ê°€ í™œì„±í™”ë˜ì–´ ìˆì–´ë„, ì†ìƒëœ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì‚¬ìš©ìê°€ ì¶©ë¶„í•œ ê¶Œí•œì´ ì—†ê¸° ë•Œë¬¸ì— ë‚˜ì—´í•˜ëŠ” ë™ì•ˆ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

[**IAMì— ëŒ€í•œ ê¸°ë³¸ ì •ë³´ëŠ” ì—¬ê¸°ì—ì„œ í™•ì¸í•˜ì„¸ìš”**](../gcp-basic-information/#iam-roles).

### ê¸°ë³¸ ê¶Œí•œ

[**ë¬¸ì„œ**](https://cloud.google.com/resource-manager/docs/default-access-control)ì—ì„œ: ì¡°ì§ ë¦¬ì†ŒìŠ¤ê°€ ìƒì„±ë˜ë©´, ë„ë©”ì¸ì˜ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ê¸°ë³¸ì ìœ¼ë¡œ **ì²­êµ¬ ê³„ì • ìƒì„±ì** ë° **í”„ë¡œì íŠ¸ ìƒì„±ì** ì—­í• ì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê¸°ë³¸ ì—­í• ì€ ì‚¬ìš©ìê°€ Google Cloudë¥¼ ì¦‰ì‹œ ì‚¬ìš©í•˜ë„ë¡ í—ˆìš©í•˜ì§€ë§Œ, ì¡°ì§ ë¦¬ì†ŒìŠ¤ì˜ ì¼ë°˜ ìš´ì˜ì— ì‚¬ìš©í•˜ê¸° ìœ„í•œ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.

ì´ **ì—­í• **ì€ **ê¶Œí•œ**ì„ ë¶€ì—¬í•©ë‹ˆë‹¤:

* `billing.accounts.create` ë° `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` ë° `resourcemanager.projects.create`

ê²Œë‹¤ê°€, ì‚¬ìš©ìê°€ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ë©´, [ë¬¸ì„œ](https://cloud.google.com/resource-manager/docs/access-control-proj)ì— ë”°ë¼ **ìë™ìœ¼ë¡œ í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ ì†Œìœ ìê°€ ë©ë‹ˆë‹¤**. ë”°ë¼ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©ìëŠ” í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ê³  ê·¸ ìœ„ì—ì„œ ì–´ë–¤ ì„œë¹„ìŠ¤ë“  ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì±„êµ´ì? ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‚˜ì—´? ...)

{% hint style="danger" %}
GCP ì¡°ì§ì—ì„œ ê°€ì¥ ë†’ì€ ê¶Œí•œì€ **ì¡°ì§ ê´€ë¦¬ì** ì—­í• ì…ë‹ˆë‹¤.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

ëŒ€ë¶€ë¶„ì˜ ì„œë¹„ìŠ¤ì—ì„œ **`add-iam-policy-binding`** ë˜ëŠ” **`set-iam-policy`** ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê¶Œí•œì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ìš” ì°¨ì´ì ì€ **`add-iam-policy-binding`ì€ ê¸°ì¡´ IAM ì •ì±…ì— ìƒˆë¡œìš´ ì—­í•  ë°”ì¸ë”©ì„ ì¶”ê°€**í•˜ëŠ” ë°˜ë©´, **`set-iam-policy`**ëŠ” **ì´ì „ì— ë¶€ì—¬ëœ** ê¶Œí•œì„ **ì‚­ì œí•˜ê³  ëª…ë ¹ì— ì§€ì •ëœ ê²ƒë§Œ ì„¤ì •**í•©ë‹ˆë‹¤.

### ë‚˜ì—´
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### cloudasset IAM Enumeration

ì´ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ì–‘í•œ ë¦¬ì†ŒìŠ¤(ì¡°ì§, í´ë”, í”„ë¡œì íŠ¸ ë“±)ì—ì„œ ì‚¬ìš©ìì˜ ëª¨ë“  ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ë°©ë²•ì´ ì—¬ëŸ¬ ê°€ì§€ ìˆìŠµë‹ˆë‹¤.

* ê¶Œí•œ **`cloudasset.assets.searchAllIamPolicies`**ëŠ” ë¦¬ì†ŒìŠ¤ ë‚´ì˜ **ëª¨ë“  iam ì •ì±…**ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* ê¶Œí•œ **`cloudasset.assets.analyzeIamPolicy`**ëŠ” ë¦¬ì†ŒìŠ¤ ë‚´ì˜ ì£¼ì²´ì— ëŒ€í•œ **ëª¨ë“  iam ì •ì±…**ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* ê¶Œí•œ **`cloudasset.assets.searchAllResources`**ëŠ” ì¡°ì§, í´ë” ë˜ëŠ” í”„ë¡œì íŠ¸ì˜ ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ ë‚˜ì—´í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤. IAM ê´€ë ¨ ë¦¬ì†ŒìŠ¤(ì˜ˆ: ì—­í• )ê°€ í¬í•¨ë©ë‹ˆë‹¤.
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* ê¶Œí•œ **`cloudasset.assets.analyzeMove`**ëŠ” í”„ë¡œì íŠ¸ì™€ ê°™ì€ ë¦¬ì†ŒìŠ¤ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ì •ì±…ì„ ê²€ìƒ‰í•˜ëŠ” ë°ì—ë„ ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* ë‚˜ëŠ” ê¶Œí•œ **`cloudasset.assets.queryIamPolicy`**ê°€ ì£¼ì²´ì˜ ê¶Œí•œì„ ì°¾ëŠ” ë° ì ‘ê·¼ì„ ì œê³µí•  ìˆ˜ ìˆë‹¤ê³  ìƒê°í•œë‹¤.
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### testIamPermissions enumeration

{% hint style="danger" %}
ë§Œì•½ ì´ì „ ë°©ë²•ìœ¼ë¡œ **IAM ì •ë³´ë¥¼ ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤ë©´** Red Teamì— ìˆë‹¤ë©´, í˜„ì¬ ê¶Œí•œì„ ë¸Œë£¨íŠ¸í¬ìŠ¤í•˜ê¸° ìœ„í•´ **ë„êµ¬**[ **https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

í•˜ì§€ë§Œ, ì„œë¹„ìŠ¤ **`cloudresourcemanager.googleapis.com`** ê°€ í™œì„±í™”ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}

### Privesc

ë‹¤ìŒ í˜ì´ì§€ì—ì„œ **IAM ê¶Œí•œì„ ë‚¨ìš©í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¤ëŠ” ë°©ë²•**ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Unauthenticated Enum <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unauthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Persistence

ë†’ì€ ê¶Œí•œì´ ìˆë‹¤ë©´ ë‹¤ìŒì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* ìƒˆë¡œìš´ SAs(ë˜ëŠ” Workspaceì— ìˆëŠ” ê²½ìš° ì‚¬ìš©ì)ë¥¼ ìƒì„±
* ìì‹ ì´ ì œì–´í•˜ëŠ” ì£¼ì²´ì—ê²Œ ë” ë§ì€ ê¶Œí•œ ë¶€ì—¬
* ì·¨ì•½í•œ SAsì— ë” ë§ì€ ê¶Œí•œ ë¶€ì—¬(SSRF in vm, vuln Cloud Functionâ€¦)
* â€¦

## Org Policies

Org Policiesê°€ ë¬´ì—‡ì¸ì§€ì— ëŒ€í•œ ì†Œê°œëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

IAM ì •ì±…ì€ ì—­í• ì„ í†µí•´ ì£¼ì²´ê°€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•´ ê°€ì§€ëŠ” ê¶Œí•œì„ ë‚˜íƒ€ë‚´ë©°, ì´ëŠ” ì„¸ë¶„í™”ëœ ê¶Œí•œì´ í• ë‹¹ë©ë‹ˆë‹¤. ì¡°ì§ ì •ì±…ì€ **ì´ ì„œë¹„ìŠ¤ë“¤ì´ ì–´ë–»ê²Œ ì‚¬ìš©ë  ìˆ˜ ìˆëŠ”ì§€ ë˜ëŠ” ì–´ë–¤ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ëŠ”ì§€ë¥¼ ì œí•œí•©ë‹ˆë‹¤**. ì´ëŠ” GCP í™˜ê²½ ë‚´ ê° ë¦¬ì†ŒìŠ¤ì˜ ìµœì†Œ ê¶Œí•œì„ ê°œì„ í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

ë‹¤ìŒ í˜ì´ì§€ì—ì„œ **ì¡°ì§ ì •ì±… ê¶Œí•œì„ ì•…ìš©í•˜ì—¬ ê¶Œí•œ ìƒìŠ¹**í•˜ëŠ” ë°©ë²•ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
