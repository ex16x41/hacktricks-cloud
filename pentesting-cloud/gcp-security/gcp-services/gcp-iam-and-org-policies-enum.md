# GCP - IAM, Prensipler & Org PolitikalarÄ± Enum

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Servis HesaplarÄ±

Bir servis hesabÄ±nÄ±n ne olduÄŸunu Ã¶ÄŸrenmek iÃ§in kontrol edin:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### SayÄ±m

Bir servis hesabÄ± her zaman bir projeye aittir:
```bash
gcloud iam service-accounts list --project <project>
```
## KullanÄ±cÄ±lar ve Gruplar

GCP'de KullanÄ±cÄ±lar ve Gruplar'Ä±n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±na dair bir giriÅŸ iÃ§in kontrol edin:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### SayÄ±m

**`serviceusage.services.enable`** ve **`serviceusage.services.use`** izinleri ile bir projede **hizmetleri etkinleÅŸtirmek** ve kullanmak mÃ¼mkÃ¼ndÃ¼r.

{% hint style="danger" %}
VarsayÄ±lan olarak, Workspace kullanÄ±cÄ±larÄ±na **Proje OluÅŸturucu** rolÃ¼ verilir, bu da onlara **yeni projeler oluÅŸturma** eriÅŸimi saÄŸlar. Bir kullanÄ±cÄ± bir proje oluÅŸturduÄŸunda, ona projenin Ã¼zerinde **`owner`** rolÃ¼ verilir. BÃ¶ylece, Workspace'i sayÄ±m yapmak iÃ§in projede bu hizmetleri **etkinleÅŸtirebilir**.

Ancak, bu API'leri Ã§aÄŸÄ±rabilmek iÃ§in Workspace'te **yeterli izinlere** sahip olmanÄ±n da gerektiÄŸini unutmayÄ±n.
{% endhint %}

EÄŸer **`admin` hizmetini etkinleÅŸtirebilirseniz** ve kullanÄ±cÄ±nÄ±zÄ±n **workspace'te yeterli ayrÄ±calÄ±klarÄ±** varsa, aÅŸaÄŸÄ±daki satÄ±rlarla **tÃ¼m gruplarÄ± ve kullanÄ±cÄ±larÄ± sayabilirsiniz**.\
**`identity groups`** yazsa bile, **grubu olmayan kullanÄ±cÄ±larÄ±** da dÃ¶ndÃ¼rÃ¼r:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
Ã–nceki Ã¶rneklerde `--labels` parametresi gereklidir, bu nedenle genel bir deÄŸer kullanÄ±lÄ±r (API'yi doÄŸrudan [**PurplePanda burada yaptÄ±ÄŸÄ± gibi**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py) kullanÄ±yorsanÄ±z gerekmiyor).
{% endhint %}

YÃ¶netici hizmeti etkin olsa bile, ele geÃ§irilmiÅŸ Ã§alÄ±ÅŸma alanÄ± kullanÄ±cÄ±nÄ±zÄ±n yeterli izinlere sahip olmamasÄ± nedeniyle bunlarÄ± listelemekte hata almanÄ±z mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

IAM hakkÄ±nda temel bilgiler iÃ§in [**bunu kontrol edin**](../gcp-basic-information/#iam-roles).

### VarsayÄ±lan Ä°zinler

[**belgelere**](https://cloud.google.com/resource-manager/docs/default-access-control) gÃ¶re: Bir organizasyon kaynaÄŸÄ± oluÅŸturulduÄŸunda, alanÄ±nÄ±zdaki tÃ¼m kullanÄ±cÄ±lara varsayÄ±lan olarak **Faturalama HesabÄ± OluÅŸturucu** ve **Proje OluÅŸturucu** rolleri verilir. Bu varsayÄ±lan roller, kullanÄ±cÄ±larÄ±nÄ±zÄ±n Google Cloud'u hemen kullanmaya baÅŸlamasÄ±na olanak tanÄ±r, ancak organizasyon kaynaÄŸÄ±nÄ±zÄ±n normal iÅŸletiminde kullanÄ±lmak Ã¼zere tasarlanmamÄ±ÅŸtÄ±r.

Bu **roller** aÅŸaÄŸÄ±daki **izinleri** verir:

* `billing.accounts.create` ve `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` ve `resourcemanager.projects.create`

AyrÄ±ca, bir kullanÄ±cÄ± bir proje oluÅŸturduÄŸunda, [belgelere](https://cloud.google.com/resource-manager/docs/access-control-proj) gÃ¶re o projenin **sahibi olarak otomatik olarak atanÄ±r**. Bu nedenle, varsayÄ±lan olarak, bir kullanÄ±cÄ± bir proje oluÅŸturabilecek ve Ã¼zerinde herhangi bir hizmet Ã§alÄ±ÅŸtÄ±rabilecektir (madenciler? Ã‡alÄ±ÅŸma alanÄ± listeleme? ...)

{% hint style="danger" %}
GCP Organizasyonu'ndaki en yÃ¼ksek ayrÄ±calÄ±k **Organizasyon YÃ¶neticisi** rolÃ¼dÃ¼r.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

Ã‡oÄŸu hizmette, bir kaynak Ã¼zerindeki izinleri **`add-iam-policy-binding`** veya **`set-iam-policy`** yÃ¶ntemini kullanarak deÄŸiÅŸtirebileceksiniz. Ana fark, **`add-iam-policy-binding` mevcut IAM politikasÄ±na yeni bir rol baÄŸlamasÄ± eklerken**, **`set-iam-policy`** daha Ã¶nce verilmiÅŸ izinleri **silip yalnÄ±zca** komutta belirtilenleri **ayarlayacaktÄ±r**.

### Listeleme
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### cloudasset IAM Enumeration

Bu hizmeti kullanarak bir kullanÄ±cÄ±nÄ±n farklÄ± kaynaklardaki (Ã¶rneÄŸin organizasyonlar, klasÃ¶rler, projeler...) tÃ¼m izinlerini kontrol etmenin farklÄ± yollarÄ± vardÄ±r.

* **`cloudasset.assets.searchAllIamPolicies`** izni, bir kaynaÄŸÄ±n iÃ§indeki **tÃ¼m iam politikalarÄ±nÄ±** talep edebilir.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* Ä°zin **`cloudasset.assets.analyzeIamPolicy`** bir kaynaÄŸÄ±n iÃ§indeki bir ilkenin **tÃ¼m iam politikalarÄ±nÄ±** talep edebilir.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* Ä°zin **`cloudasset.assets.searchAllResources`** bir organizasyonun, klasÃ¶rÃ¼n veya projenin tÃ¼m kaynaklarÄ±nÄ± listelemeye olanak tanÄ±r. IAM ile ilgili kaynaklar (roller gibi) dahildir.
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* Ä°zin **`cloudasset.assets.analyzeMove`** bir projeyi etkileyen politikalarÄ± almak iÃ§in de yararlÄ± olabilir.
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* SanÄ±rÄ±m **`cloudasset.assets.queryIamPolicy`** izni, ilkelerin izinlerini bulmak iÃ§in eriÅŸim saÄŸlayabilir.
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### testIamPermissions enumeration

{% hint style="danger" %}
EÄŸer Ã¶nceki yÃ¶ntemlerle **IAM bilgilerine eriÅŸemiyorsanÄ±z** ve bir KÄ±rmÄ±zÄ± TakÄ±m Ã¼yesiyseniz, mevcut izinlerinizi brute-force yapmak iÃ§in **ÅŸu aracÄ±**[ **https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **kullanabilirsiniz.**

Ancak, **`cloudresourcemanager.googleapis.com`** hizmetinin etkinleÅŸtirilmesi gerektiÄŸini unutmayÄ±n.
{% endhint %}

### Privesc

AÅŸaÄŸÄ±daki sayfada **IAM izinlerini kÃ¶tÃ¼ye kullanarak ayrÄ±calÄ±klarÄ± artÄ±rma** yÃ¶ntemlerini kontrol edebilirsiniz:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Kimlik DoÄŸrulamasÄ± Olmadan Enum <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unauthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### SÃ¶mÃ¼rÃ¼ SonrasÄ± <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### SÃ¼reklilik

EÄŸer yÃ¼ksek ayrÄ±calÄ±klarÄ±nÄ±z varsa ÅŸunlarÄ± yapabilirsiniz:

* Yeni SA'lar (veya Workspace'de kullanÄ±cÄ±lar) oluÅŸturmak
* KontrolÃ¼nÃ¼z altÄ±ndaki ilkelere daha fazla izin vermek
* ZayÄ±f SA'lara daha fazla ayrÄ±calÄ±k vermek (vm'de SSRF, zayÄ±f Cloud Functionâ€¦)
* â€¦

## Org PolitikalarÄ±

Org PolitikalarÄ±nÄ±n ne olduÄŸunu Ã¶ÄŸrenmek iÃ§in kontrol edin:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

IAM politikalarÄ±, ilkelere roller aracÄ±lÄ±ÄŸÄ±yla kaynaklar Ã¼zerinde sahip olduklarÄ± izinleri gÃ¶sterir; bu roller ayrÄ±ntÄ±lÄ± izinler atar. Organizasyon politikalarÄ± **bu hizmetlerin nasÄ±l kullanÄ±labileceÄŸini veya hangi Ã¶zelliklerin devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ±nÄ± kÄ±sÄ±tlar**. Bu, GCP ortamÄ±ndaki her kaynaÄŸÄ±n en az ayrÄ±calÄ±ÄŸÄ±nÄ± artÄ±rmak iÃ§in yardÄ±mcÄ± olur.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

AÅŸaÄŸÄ±daki sayfada **Ã¶rgÃ¼t politikasÄ± izinlerini kÃ¶tÃ¼ye kullanarak ayrÄ±calÄ±klarÄ± artÄ±rma** yÃ¶ntemini kontrol edebilirsiniz:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
