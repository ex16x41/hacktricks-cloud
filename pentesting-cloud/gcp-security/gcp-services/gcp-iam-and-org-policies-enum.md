# GCP - IAM, Principals & Org Policies Enum

{% hint style="success" %}
Uƒçite i ve≈æbajte AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Uƒçite i ve≈æbajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Service Accounts

Za uvod o tome ≈°ta je servisni nalog, proverite:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Enumeration

Servisni nalog uvek pripada projektu:
```bash
gcloud iam service-accounts list --project <project>
```
## Korisnici i Grupe

Za uvod o tome kako funkcioni≈°u Korisnici i Grupe u GCP, pogledajte:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Enumeracija

Sa dozvolama **`serviceusage.services.enable`** i **`serviceusage.services.use`** moguƒáe je **omoguƒáiti usluge** u projektu i koristiti ih.

{% hint style="danger" %}
Napomena: po defaultu, Workspace korisnicima je dodeljena uloga **Kreator Projekta**, ≈°to im omoguƒáava da **kreiraju nove projekte**. Kada korisnik kreira projekat, dodeljuje mu se uloga **`owner`**. Tako da mo≈æe **omoguƒáiti ove usluge nad projektom kako bi mogao da enumeri≈°e Workspace**.

Meƒëutim, imajte na umu da je takoƒëe potrebno imati **dovoljno dozvola u Workspace** da bi mogli da pozovete ove API-je.
{% endhint %}

Ako mo≈æete **omoguƒáiti `admin` uslugu** i ako va≈° korisnik ima **dovoljno privilegija u workspace-u,** mogli biste **enumerisati sve grupe i korisnike** sa sledeƒáim linijama.\
ƒåak i ako se ka≈æe **`identity groups`**, takoƒëe vraƒáa **korisnike bez ikakvih grupa**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
U prethodnim primerima parametar `--labels` je obavezan, pa se koristi generiƒçka vrednost (nije obavezan ako koristite API direktno kao [**PurplePanda to radi ovde**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

ƒåak i sa omoguƒáenom admin uslugom, moguƒáe je da dobijete gre≈°ku prilikom njihovog enumerisanja jer va≈° kompromitovani korisnik radnog prostora nema dovoljno dozvola:

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

Proverite [**ovo za osnovne informacije o IAM**](../gcp-basic-information/#iam-roles).

### Podrazumevane Dozvole

Iz [**dokumentacije**](https://cloud.google.com/resource-manager/docs/default-access-control): Kada se kreira resurs organizacije, svim korisnicima u va≈°em domenu se podrazumevano dodeljuju uloge **Kreator raƒçuna za naplatu** i **Kreator projekta**. Ove podrazumevane uloge omoguƒáavaju va≈°im korisnicima da odmah poƒçnu da koriste Google Cloud, ali nisu namenjene za redovno kori≈°ƒáenje resursa va≈°e organizacije.

Ove **uloge** dodeljuju **dozvole**:

* `billing.accounts.create` i `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` i `resourcemanager.projects.create`

≈†tavi≈°e, kada korisnik kreira projekat, on je **automatski dodeljen kao vlasnik tog projekta** prema [dokumentaciji](https://cloud.google.com/resource-manager/docs/access-control-proj). Stoga, podrazumevano, korisnik ƒáe moƒái da kreira projekat i pokrene bilo koju uslugu na njemu (rudari? enumeracija radnog prostora? ...)

{% hint style="danger" %}
Najvi≈°a privilegija u GCP organizaciji je uloga **Administrator organizacije**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

U veƒáini usluga moƒái ƒáete da promenite dozvole nad resursom koristeƒái metodu **`add-iam-policy-binding`** ili **`set-iam-policy`**. Glavna razlika je u tome ≈°to **`add-iam-policy-binding` dodaje novo vezivanje uloge** postojeƒáoj IAM politici dok **`set-iam-policy`** **bri≈°e prethodno** dodeljene dozvole i **postavlja samo one** navedene u komandi.

### Enumeracija
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### cloudasset IAM Enumeration

Postoje razliƒçiti naƒçini da se provere sve dozvole korisnika u razliƒçitim resursima (kao ≈°to su organizacije, fascikle, projekti...) koristeƒái ovu uslugu.

* Dozvola **`cloudasset.assets.searchAllIamPolicies`** mo≈æe zatra≈æiti **sve iam politike** unutar resursa.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* Dozvola **`cloudasset.assets.analyzeIamPolicy`** mo≈æe zatra≈æiti **sve iam politike** jednog subjekta unutar resursa.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* Dozvola **`cloudasset.assets.searchAllResources`** omoguƒáava listanje svih resursa organizacije, fascikle ili projekta. Resursi povezani sa IAM-om (kao ≈°to su uloge) su ukljuƒçeni.
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* Dozvola **`cloudasset.assets.analyzeMove`** mo≈æe biti korisna i za dobijanje politika koje utiƒçu na resurs kao ≈°to je projekat
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Pretpostavljam da bi dozvola **`cloudasset.assets.queryIamPolicy`** takoƒëe mogla omoguƒáiti pristup pronala≈æenju dozvola principala
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### testIamPermissions enumeration

{% hint style="danger" %}
Ako **ne mo≈æete pristupiti IAM informacijama** koristeƒái prethodne metode i nalazite se u Red Team-u. Mo≈æete **koristiti alat**[ **https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **da brute-force-ujete svoje trenutne dozvole.**

Meƒëutim, imajte na umu da servis **`cloudresourcemanager.googleapis.com`** treba biti omoguƒáen.
{% endhint %}

### Privesc

Na sledeƒáoj stranici mo≈æete proveriti kako da **zloupotrebite IAM dozvole za eskalaciju privilegija**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Unauthenticated Enum <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unauthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Persistence

Ako imate visoke privilegije mogli biste:

* Kreirati nove SAs (ili korisnike ako ste u Workspace-u)
* Dati principima koje kontroli≈°ete vi≈°e dozvola
* Dati vi≈°e privilegija ranjivim SAs (SSRF u vm, ranjiva Cloud Function‚Ä¶)
* ‚Ä¶

## Org Policies

Za uvod o tome ≈°ta su Org Policies proverite:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

IAM politike ukazuju na dozvole koje principi imaju nad resursima putem uloga, koje imaju dodeljene granularne dozvole. Politike organizacije **ograniƒçavaju kako se ti servisi mogu koristiti ili koje funkcije su onemoguƒáene**. Ovo poma≈æe u pobolj≈°anju minimalnih privilegija svakog resursa u GCP okru≈æenju.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

Na sledeƒáoj stranici mo≈æete proveriti kako da **zloupotrebite dozvole org politika za eskalaciju privilegija**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
Uƒçite i ve≈æbajte AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Uƒçite i ve≈æbajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
