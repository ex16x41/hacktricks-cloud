# GCP - IAM, Principals & Org Policies Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Konta serwisowe

Aby uzyskaÄ‡ wprowadzenie do tego, czym jest konto serwisowe, sprawdÅº:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Enumeracja

Konto serwisowe zawsze naleÅ¼y do projektu:
```bash
gcloud iam service-accounts list --project <project>
```
## UÅ¼ytkownicy i Grupy

Aby uzyskaÄ‡ wprowadzenie na temat dziaÅ‚ania UÅ¼ytkownikÃ³w i Grup w GCP, sprawdÅº:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Enumeracja

DziÄ™ki uprawnieniom **`serviceusage.services.enable`** i **`serviceusage.services.use`** moÅ¼liwe jest **wÅ‚Ä…czenie usÅ‚ug** w projekcie i ich uÅ¼ycie.

{% hint style="danger" %}
ZauwaÅ¼, Å¼e domyÅ›lnie uÅ¼ytkownicy Workspace otrzymujÄ… rolÄ™ **TwÃ³rca Projektu**, co daje im dostÄ™p do **tworzenia nowych projektÃ³w**. Gdy uÅ¼ytkownik tworzy projekt, przyznawana jest mu rola **`owner`** nad nim. Tak wiÄ™c, mÃ³gÅ‚by **wÅ‚Ä…czyÄ‡ te usÅ‚ugi w projekcie, aby mÃ³c enumerowaÄ‡ Workspace**.

Jednak zauwaÅ¼, Å¼e potrzebne sÄ… rÃ³wnieÅ¼ **wystarczajÄ…ce uprawnienia w Workspace**, aby mÃ³c wywoÅ‚ywaÄ‡ te API.
{% endhint %}

JeÅ›li moÅ¼esz **wÅ‚Ä…czyÄ‡ usÅ‚ugÄ™ `admin`** i jeÅ›li twÃ³j uÅ¼ytkownik ma **wystarczajÄ…ce uprawnienia w workspace,** moÅ¼esz **enumerowaÄ‡ wszystkie grupy i uÅ¼ytkownikÃ³w** za pomocÄ… nastÄ™pujÄ…cych linii.\
Nawet jeÅ›li mÃ³wi **`identity groups`**, zwraca rÃ³wnieÅ¼ **uÅ¼ytkownikÃ³w bez Å¼adnych grup**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
W poprzednich przykÅ‚adach parametr `--labels` jest wymagany, wiÄ™c uÅ¼ywana jest wartoÅ›Ä‡ ogÃ³lna (nie jest wymagany, jeÅ›li uÅ¼ywasz API bezpoÅ›rednio, jak [**PurplePanda robi tutaj**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

Nawet przy wÅ‚Ä…czonej usÅ‚udze administratora, moÅ¼liwe jest, Å¼e otrzymasz bÅ‚Ä…d podczas ich enumeracji, poniewaÅ¼ twÃ³j skompromitowany uÅ¼ytkownik workspace nie ma wystarczajÄ…cych uprawnieÅ„:

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

SprawdÅº [**to dla podstawowych informacji o IAM**](../gcp-basic-information/#iam-roles).

### DomyÅ›lne uprawnienia

Z [**dokumentacji**](https://cloud.google.com/resource-manager/docs/default-access-control): Gdy tworzony jest zasÃ³b organizacji, wszyscy uÅ¼ytkownicy w twojej domenie otrzymujÄ… domyÅ›lnie role **TwÃ³rcy Konta Rozliczeniowego** i **TwÃ³rcy Projektu**. Te domyÅ›lne role pozwalajÄ… twoim uÅ¼ytkownikom na natychmiastowe rozpoczÄ™cie korzystania z Google Cloud, ale nie sÄ… przeznaczone do regularnego uÅ¼ytkowania zasobu organizacji.

Te **role** przyznajÄ… **uprawnienia**:

* `billing.accounts.create` i `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` i `resourcemanager.projects.create`

Co wiÄ™cej, gdy uÅ¼ytkownik tworzy projekt, **automatycznie otrzymuje wÅ‚aÅ›ciciela tego projektu** zgodnie z [dokumentacjÄ…](https://cloud.google.com/resource-manager/docs/access-control-proj). Dlatego domyÅ›lnie uÅ¼ytkownik bÄ™dzie mÃ³gÅ‚ stworzyÄ‡ projekt i uruchomiÄ‡ na nim dowolnÄ… usÅ‚ugÄ™ (koparki? enumeracja Workspace? ...)

{% hint style="danger" %}
NajwyÅ¼szym uprawnieniem w organizacji GCP jest rola **Administratora Organizacji**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

W wiÄ™kszoÅ›ci usÅ‚ug bÄ™dziesz mÃ³gÅ‚ zmieniÄ‡ uprawnienia dotyczÄ…ce zasobu, uÅ¼ywajÄ…c metody **`add-iam-policy-binding`** lub **`set-iam-policy`**. GÅ‚Ã³wna rÃ³Å¼nica polega na tym, Å¼e **`add-iam-policy-binding` dodaje nowe powiÄ…zanie roli** do istniejÄ…cej polityki IAM, podczas gdy **`set-iam-policy`** **usuwa wczeÅ›niej** przyznane uprawnienia i **ustawia tylko te**, ktÃ³re sÄ… wskazane w poleceniu.

### Enumeracja
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### cloudasset IAM Enumeration

IstniejÄ… rÃ³Å¼ne sposoby na sprawdzenie wszystkich uprawnieÅ„ uÅ¼ytkownika w rÃ³Å¼nych zasobach (takich jak organizacje, foldery, projekty...) za pomocÄ… tej usÅ‚ugi.

* Uprawnienie **`cloudasset.assets.searchAllIamPolicies`** moÅ¼e Å¼Ä…daÄ‡ **wszystkich polityk iam** wewnÄ…trz zasobu.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* Uprawnienie **`cloudasset.assets.analyzeIamPolicy`** moÅ¼e Å¼Ä…daÄ‡ **wszystkich polityk iam** danego podmiotu w obrÄ™bie zasobu.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* Uprawnienie **`cloudasset.assets.searchAllResources`** pozwala na wylistowanie wszystkich zasobÃ³w organizacji, folderu lub projektu. Zasoby zwiÄ…zane z IAM (takie jak role) sÄ… wliczone.
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* Uprawnienie **`cloudasset.assets.analyzeMove`** moÅ¼e byÄ‡ rÃ³wnieÅ¼ przydatne do uzyskania polityk wpÅ‚ywajÄ…cych na zasÃ³b, taki jak projekt.
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Przypuszczam, Å¼e uprawnienie **`cloudasset.assets.queryIamPolicy`** moÅ¼e rÃ³wnieÅ¼ umoÅ¼liwiÄ‡ dostÄ™p do znajdowania uprawnieÅ„ podmiotÃ³w.
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### testIamPermissions enumeration

{% hint style="danger" %}
JeÅ›li **nie moÅ¼esz uzyskaÄ‡ dostÄ™pu do informacji IAM** za pomocÄ… poprzednich metod i jesteÅ› w Red Team. MoÅ¼esz **uÅ¼yÄ‡ narzÄ™dzia**[ **https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **do brutalnego wymuszania swoich aktualnych uprawnieÅ„.**

Jednak pamiÄ™taj, Å¼e usÅ‚uga **`cloudresourcemanager.googleapis.com`** musi byÄ‡ wÅ‚Ä…czona.
{% endhint %}

### Privesc

Na poniÅ¼szej stronie moÅ¼esz sprawdziÄ‡, jak **naduÅ¼ywaÄ‡ uprawnieÅ„ IAM, aby eskalowaÄ‡ uprawnienia**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Unauthenticated Enum <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unauthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Persistence

JeÅ›li masz wysokie uprawnienia, moÅ¼esz:

* UtworzyÄ‡ nowe SAs (lub uÅ¼ytkownikÃ³w, jeÅ›li w Workspace)
* PrzyznaÄ‡ kontrolowanym przez siebie principalom wiÄ™cej uprawnieÅ„
* PrzyznaÄ‡ wiÄ™cej uprawnieÅ„ podatnym SAs (SSRF w vm, podatna Cloud Functionâ€¦)
* â€¦

## Org Policies

Aby uzyskaÄ‡ wprowadzenie do tego, czym sÄ… Org Policies, sprawdÅº:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

Polityki IAM wskazujÄ… uprawnienia, jakie principal ma nad zasobami za pomocÄ… rÃ³l, ktÃ³re przypisujÄ… szczegÃ³Å‚owe uprawnienia. Polityki organizacyjne **ograniczajÄ… sposÃ³b, w jaki te usÅ‚ugi mogÄ… byÄ‡ uÅ¼ywane lub ktÃ³re funkcje sÄ… wyÅ‚Ä…czone**. Pomaga to w poprawie zasady najmniejszych uprawnieÅ„ dla kaÅ¼dego zasobu w Å›rodowisku GCP.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

Na poniÅ¼szej stronie moÅ¼esz sprawdziÄ‡, jak **naduÅ¼ywaÄ‡ uprawnieÅ„ polityk organizacyjnych, aby eskalowaÄ‡ uprawnienia**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
