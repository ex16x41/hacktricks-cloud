# GCP - Enumeraci칩n de IAM, Principales y Pol칤ticas de Org

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Cuentas de Servicio

Para obtener una introducci칩n sobre qu칠 es una cuenta de servicio, consulta:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Enumeraci칩n

Una cuenta de servicio siempre pertenece a un proyecto:
```bash
gcloud iam service-accounts list --project <project>
```
## Usuarios y Grupos

Para obtener una introducci칩n sobre c칩mo funcionan los Usuarios y Grupos en GCP, consulta:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Enumeraci칩n

Con los permisos **`serviceusage.services.enable`** y **`serviceusage.services.use`** es posible **habilitar servicios** en un proyecto y utilizarlos.

{% hint style="danger" %}
Ten en cuenta que por defecto, a los usuarios de Workspace se les otorga el rol de **Creador de Proyectos**, lo que les da acceso a **crear nuevos proyectos**. Cuando un usuario crea un proyecto, se le otorga el rol de **`owner`** sobre el mismo. Por lo tanto, podr칤a **habilitar estos servicios en el proyecto para poder enumerar Workspace**.

Sin embargo, ten en cuenta que tambi칠n es necesario tener **suficientes permisos en Workspace** para poder llamar a estos APIs.
{% endhint %}

Si puedes **habilitar el servicio `admin`** y si tu usuario tiene **suficientes privilegios en Workspace**, podr칤as **enumerar todos los grupos y usuarios** con las siguientes l칤neas.\
Incluso si dice **`grupos de identidad`**, tambi칠n devuelve **usuarios sin ning칰n grupo**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
En los ejemplos anteriores, el par치metro `--labels` es requerido, por lo que se usa un valor gen칠rico (no es necesario si se utiliza la API directamente como [**PurplePanda hace aqu칤**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

Incluso con el servicio de administrador habilitado, es posible que obtengas un error al enumerarlos porque tu usuario comprometido en el espacio de trabajo no tiene suficientes permisos:

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

Verifica [**esto para informaci칩n b치sica sobre IAM**](../gcp-basic-information/#iam-roles).

### Permisos por Defecto

Seg칰n la [**documentaci칩n**](https://cloud.google.com/resource-manager/docs/default-access-control): Cuando se crea un recurso de organizaci칩n, todos los usuarios de tu dominio reciben los roles de **Creador de Cuenta de Facturaci칩n** y **Creador de Proyecto** de forma predeterminada. Estos roles predeterminados permiten a tus usuarios comenzar a usar Google Cloud de inmediato, pero no est치n destinados para su uso en la operaci칩n regular de los recursos de tu organizaci칩n.

Estos **roles** otorgan los **permisos**:

* `billing.accounts.create` y `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` y `resourcemanager.projects.create`

Adem치s, cuando un usuario crea un proyecto, **se le otorga autom치ticamente el rol de propietario de ese proyecto** seg칰n la [documentaci칩n](https://cloud.google.com/resource-manager/docs/access-control-proj). Por lo tanto, de forma predeterminada, un usuario podr치 crear un proyecto y ejecutar cualquier servicio en 칠l (쯠ineros? 쮼numeraci칩n de Workspace? ...)

{% hint style="danger" %}
El privilegio m치s alto en una Organizaci칩n de GCP es el rol de **Administrador de la Organizaci칩n**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

En la mayor칤a de los servicios podr치s cambiar los permisos sobre un recurso utilizando el m칠todo **`add-iam-policy-binding`** o **`set-iam-policy`**. La principal diferencia es que **`add-iam-policy-binding` agrega un nuevo enlace de rol** a la pol칤tica IAM existente mientras que **`set-iam-policy`** **eliminar치 los permisos otorgados anteriormente** y **establecer치 solo los indicados** en el comando.

### Enumeraci칩n
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### Enumeraci칩n de IAM de cloudasset

Existen diferentes formas de verificar todos los permisos de un usuario en diferentes recursos (como organizaciones, carpetas, proyectos...) utilizando este servicio.

* El permiso **`cloudasset.assets.searchAllIamPolicies`** puede solicitar **todas las pol칤ticas de IAM** dentro de un recurso.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* El permiso **`cloudasset.assets.analyzeIamPolicy`** puede solicitar **todas las pol칤ticas de IAM** de un principal dentro de un recurso.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* El permiso **`cloudasset.assets.searchAllResources`** permite listar todos los recursos de una organizaci칩n, carpeta o proyecto. Recursos relacionados con IAM (como roles) incluidos.
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* El permiso **`cloudasset.assets.analyzeMove`** puede ser 칰til para tambi칠n recuperar pol칤ticas que afectan a un recurso como un proyecto
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Supongo que el permiso **`cloudasset.assets.queryIamPolicy`** tambi칠n podr칤a dar acceso para encontrar permisos de principios.
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### Enumeraci칩n de permisos de testIamPermissions

{% hint style="danger" %}
Si **no puedes acceder a la informaci칩n de IAM** utilizando los m칠todos anteriores y est치s en un Equipo Rojo. Podr칤as **utilizar la herramienta** [**https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **para forzar tus permisos actuales.**

Sin embargo, ten en cuenta que el servicio **`cloudresourcemanager.googleapis.com`** debe estar habilitado.
{% endhint %}

### Escalada de privilegios

En la siguiente p치gina puedes verificar c칩mo **abusar de los permisos de IAM para escalar privilegios**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Enumeraci칩n sin autenticaci칩n <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Explotaci칩n <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

Si tienes altos privilegios podr칤as:

* Crear nuevos SAs (o usuarios si est치s en Workspace)
* Dar a los principios controlados por ti m치s permisos
* Dar m치s privilegios a SAs vulnerables (SSRF en vm, funci칩n Cloud vulnerable...)
* ...

## Pol칤ticas de la Organizaci칩n

Para obtener una introducci칩n sobre qu칠 son las Pol칤ticas de la Organizaci칩n, consulta:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

Las pol칤ticas de IAM indican los permisos que los principios tienen sobre los recursos a trav칠s de roles, los cuales tienen permisos granulares asignados. Las pol칤ticas de la organizaci칩n **restringen c칩mo se pueden utilizar esos servicios o qu칠 funciones est치n deshabilitadas**. Esto ayuda a mejorar el principio de privilegio m칤nimo de cada recurso en el entorno de GCP.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Escalada de privilegios

En la siguiente p치gina puedes verificar c칩mo **abusar de los permisos de las pol칤ticas de la organizaci칩n para escalar privilegios**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
