# GCP - Enumerazione KMS

{% hint style="success" %}
Impara e pratica l'Hacking su AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di Github.

</details>
{% endhint %}

## KMS

Il [**Cloud Key Management Service**](https://cloud.google.com/kms/docs/) funge da archivio sicuro per **chiavi crittografiche**, essenziali per operazioni come **crittografare e decrittografare dati sensibili**. Queste chiavi sono organizzate all'interno di anelli di chiavi, consentendo una gestione strutturata. Inoltre, il controllo degli accessi pu√≤ essere configurato in modo meticoloso, sia a livello di singola chiave che per l'intero anello di chiavi, garantendo che le autorizzazioni siano allineate con precisione ai requisiti di sicurezza.

Gli anelli di chiavi KMS sono **creati per impostazione predefinita come globali**, il che significa che le chiavi all'interno di quell'anello di chiavi sono accessibili da qualsiasi regione. Tuttavia, √® possibile creare anelli di chiavi specifici in **regioni specifiche**.

### Livello di Protezione della Chiave

* **Chiavi software**: Le chiavi software sono **create e gestite interamente da KMS in software**. Queste chiavi non sono **protette da alcun modulo di sicurezza hardware (HSM)** e possono essere utilizzate per scopi di **test e sviluppo**. Le chiavi software **non sono consigliate per l'uso in produzione** perch√© forniscono una bassa sicurezza e sono suscettibili ad attacchi.
* **Chiavi ospitate nel cloud**: Le chiavi ospitate nel cloud sono **create e gestite da KMS** nel cloud utilizzando un'infrastruttura altamente disponibile e affidabile. Queste chiavi sono **protette da HSM**, ma gli HSM non sono **dedicati a un cliente specifico**. Le chiavi ospitate nel cloud sono adatte per la maggior parte dei casi d'uso in produzione.
* **Chiavi esterne**: Le chiavi esterne sono **create e gestite al di fuori di KMS** e vengono importate in KMS per l'uso in operazioni crittografiche. Le chiavi esterne **possono essere memorizzate in un modulo di sicurezza hardware (HSM) o in una libreria software, a seconda delle preferenze del cliente**.

### Scopi della Chiave

* **Crittografia/Decrittografia simmetrica**: Utilizzata per **crittografare e decrittografare dati utilizzando una singola chiave per entrambe le operazioni**. Le chiavi simmetriche sono veloci ed efficienti per crittografare e decrittografare grandi volumi di dati.
* **Supportata**: [cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **Firma asimmetrica**: Utilizzata per la comunicazione sicura tra due parti senza condividere la chiave. Le chiavi asimmetriche sono composte da una coppia, costituita da una **chiave pubblica e una chiave privata**. La chiave pubblica viene condivisa con altri, mentre la chiave privata viene mantenuta segreta.
* **Supportata**: [cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **Decrittografia asimmetrica**: Utilizzata per verificare l'autenticit√† di un messaggio o dati. Una firma digitale viene creata utilizzando una chiave privata e pu√≤ essere verificata utilizzando la corrispondente chiave pubblica.
* **Supportata**: [cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **Firma MAC**: Utilizzata per garantire **l'integrit√† e l'autenticit√† dei dati creando un codice di autenticazione del messaggio (MAC) utilizzando una chiave segreta**. HMAC √® comunemente utilizzato per l'autenticazione dei messaggi in protocolli di rete e applicazioni software.
* **Supportata**: [cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### Periodo di Rotazione e Periodo Programmato per la Distruzione

Di **default**, ogni **90 giorni** ma pu√≤ essere **facilmente** e **completamente personalizzato.**

Il periodo "Programmato per la distruzione" √® il **tempo trascorso dall'utente che richiede l'eliminazione della chiave** fino a quando la chiave viene **eliminata**. Non pu√≤ essere modificato dopo la creazione della chiave (predefinito 1 giorno).

### Versione Primaria

Ogni chiave KMS pu√≤ avere diverse versioni, una di esse deve essere la **predefinita**, che verr√† utilizzata quando una **versione non √® specificata durante l'interazione con la chiave KMS**.

### Enumerazione

Avendo le **autorizzazioni per elencare le chiavi**, ecco come √® possibile accedervi:
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### Escalazione dei privilegi

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

### Post Esploitation

{% content-ref url="../gcp-post-exploitation/gcp-kms-post-exploitation.md" %}
[gcp-kms-post-exploitation.md](../gcp-post-exploitation/gcp-kms-post-exploitation.md)
{% endcontent-ref %}

## Riferimenti

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
