# GCP - KMS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS

Il [**Cloud Key Management Service**](https://cloud.google.com/kms/docs/) funge da archiviazione sicura per **chiavi crittografiche**, essenziali per operazioni come **la crittografia e la decrittografia di dati sensibili**. Queste chiavi sono organizzate all'interno di anelli di chiavi, consentendo una gestione strutturata. Inoltre, il controllo degli accessi pu√≤ essere configurato meticolosamente, sia a livello di singola chiave che per l'intero anello di chiavi, garantendo che i permessi siano precisamente allineati con i requisiti di sicurezza.

Gli anelli di chiavi KMS sono **creati per impostazione predefinita come globali**, il che significa che le chiavi all'interno di quell'anello di chiavi sono accessibili da qualsiasi regione. Tuttavia, √® possibile creare anelli di chiavi specifici in **regioni specifiche**.

### Livello di Protezione delle Chiavi

* **Chiavi software**: Le chiavi software sono **create e gestite da KMS interamente in software**. Queste chiavi **non sono protette da alcun modulo di sicurezza hardware (HSM)** e possono essere utilizzate per **test e sviluppo**. Le chiavi software **non sono raccomandate per l'uso in produzione** perch√© offrono bassa sicurezza e sono suscettibili ad attacchi.
* **Chiavi ospitate nel cloud**: Le chiavi ospitate nel cloud sono **create e gestite da KMS** nel cloud utilizzando un'infrastruttura altamente disponibile e affidabile. Queste chiavi sono **protette da HSM**, ma gli HSM **non sono dedicati a un cliente specifico**. Le chiavi ospitate nel cloud sono adatte per la maggior parte dei casi d'uso in produzione.
* **Chiavi esterne**: Le chiavi esterne sono **create e gestite al di fuori di KMS** e vengono importate in KMS per l'uso in operazioni crittografiche. Le chiavi esterne **possono essere memorizzate in un modulo di sicurezza hardware (HSM) o in una libreria software, a seconda delle preferenze del cliente**.

### Scopi delle Chiavi

* **Crittografia/decrittografia simmetrica**: Utilizzata per **crittografare e decrittografare dati utilizzando una singola chiave per entrambe le operazioni**. Le chiavi simmetriche sono veloci ed efficienti per crittografare e decrittografare grandi volumi di dati.
* **Supportato**: [cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **Firma asimmetrica**: Utilizzata per comunicazioni sicure tra due parti senza condividere la chiave. Le chiavi asimmetriche vengono fornite in coppia, costituite da una **chiave pubblica e una chiave privata**. La chiave pubblica √® condivisa con altri, mentre la chiave privata √® mantenuta segreta.
* **Supportato:** [cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **Decrittografia asimmetrica**: Utilizzata per verificare l'autenticit√† di un messaggio o di dati. Una firma digitale viene creata utilizzando una chiave privata e pu√≤ essere verificata utilizzando la corrispondente chiave pubblica.
* **Supportato:** [cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **Firma MAC**: Utilizzata per garantire **l'integrit√† e l'autenticit√† dei dati creando un codice di autenticazione del messaggio (MAC) utilizzando una chiave segreta**. L'HMAC √® comunemente utilizzato per l'autenticazione dei messaggi nei protocolli di rete e nelle applicazioni software.
* **Supportato:** [cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### Periodo di Rotazione & Periodo Programmato per la Distruzione

Per **impostazione predefinita**, ogni **90 giorni**, ma pu√≤ essere **facilmente** e **completamente personalizzato.**

Il periodo "Programmato per la distruzione" √® il **tempo trascorso da quando l'utente richiede la cancellazione della chiave** fino a quando la chiave √® **cancellata**. Non pu√≤ essere modificato dopo la creazione della chiave (impostazione predefinita 1 giorno).

### Versione Primaria

Ogni chiave KMS pu√≤ avere diverse versioni, una di esse deve essere quella **predefinita**, questa sar√† quella utilizzata quando **non viene specificata una versione durante l'interazione con la chiave KMS**.

### Enumerazione

Avendo **permessi per elencare le chiavi**, ecco come puoi accedervi:
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms encrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### Elevazione dei privilegi

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

### Post Sfruttamento

{% content-ref url="../gcp-post-exploitation/gcp-kms-post-exploitation.md" %}
[gcp-kms-post-exploitation.md](../gcp-post-exploitation/gcp-kms-post-exploitation.md)
{% endcontent-ref %}

## Riferimenti

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{% hint style="success" %}
Impara e pratica Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Impara e pratica Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos su github.

</details>
{% endhint %}
