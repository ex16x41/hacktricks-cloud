# GCP - KMS æšä¸¾

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹  AWS é»‘å®¢æŠ€èƒ½ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹  GCP é»‘å®¢æŠ€èƒ½ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## KMS

[**Cloud Key Management Service**](https://cloud.google.com/kms/docs/) ä½œä¸º**åŠ å¯†å¯†é’¥**çš„å®‰å…¨å­˜å‚¨ï¼Œå¯¹äº**åŠ å¯†å’Œè§£å¯†æ•æ„Ÿæ•°æ®**ç­‰æ“ä½œè‡³å…³é‡è¦ã€‚è¿™äº›å¯†é’¥åœ¨å¯†é’¥ç¯ä¸­ç»„ç»‡ï¼Œå…è®¸è¿›è¡Œç»“æ„åŒ–ç®¡ç†ã€‚æ­¤å¤–ï¼Œè®¿é—®æ§åˆ¶å¯ä»¥è¢«ç²¾å¿ƒé…ç½®ï¼Œæ— è®ºæ˜¯åœ¨å•ä¸ªå¯†é’¥çº§åˆ«è¿˜æ˜¯æ•´ä¸ªå¯†é’¥ç¯çº§åˆ«ï¼Œç¡®ä¿æƒé™ä¸å®‰å…¨éœ€æ±‚ç²¾ç¡®å¯¹é½ã€‚

KMS å¯†é’¥ç¯**é»˜è®¤ä¸ºå…¨å±€åˆ›å»º**ï¼Œè¿™æ„å‘³ç€è¯¥å¯†é’¥ç¯ä¸­çš„å¯†é’¥å¯ä»¥ä»ä»»ä½•åŒºåŸŸè®¿é—®ã€‚ä½†æ˜¯ï¼Œä¹Ÿå¯ä»¥åœ¨**ç‰¹å®šåŒºåŸŸ**åˆ›å»ºç‰¹å®šçš„å¯†é’¥ç¯ã€‚

### å¯†é’¥ä¿æŠ¤çº§åˆ«

* **è½¯ä»¶å¯†é’¥**ï¼šè½¯ä»¶å¯†é’¥å®Œå…¨ç”± KMS åœ¨è½¯ä»¶ä¸­**åˆ›å»ºå’Œç®¡ç†**ã€‚è¿™äº›å¯†é’¥**ä¸å—ä»»ä½•ç¡¬ä»¶å®‰å…¨æ¨¡å— (HSM) ä¿æŠ¤**ï¼Œå¯ç”¨äº**æµ‹è¯•å’Œå¼€å‘ç›®çš„**ã€‚ç”±äºæä¾›çš„å®‰å…¨æ€§è¾ƒä½ä¸”å®¹æ˜“å—åˆ°æ”»å‡»ï¼Œä¸å»ºè®®å°†è½¯ä»¶å¯†é’¥ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚
* **äº‘æ‰˜ç®¡å¯†é’¥**ï¼šäº‘æ‰˜ç®¡å¯†é’¥ç”± KMS åœ¨äº‘ä¸­ä½¿ç”¨é«˜å¯ç”¨æ€§å’Œå¯é åŸºç¡€è®¾æ–½**åˆ›å»ºå’Œç®¡ç†**ã€‚è¿™äº›å¯†é’¥å—**HSM ä¿æŠ¤**ï¼Œä½† HSM å¹¶**ä¸ä¸“é—¨ä¸ºç‰¹å®šå®¢æˆ·è€Œè®¾**ã€‚äº‘æ‰˜ç®¡å¯†é’¥é€‚ç”¨äºå¤§å¤šæ•°ç”Ÿäº§ç”¨ä¾‹ã€‚
* **å¤–éƒ¨å¯†é’¥**ï¼šå¤–éƒ¨å¯†é’¥åœ¨ KMS å¤–éƒ¨**åˆ›å»ºå’Œç®¡ç†**ï¼Œå¹¶è¢«å¯¼å…¥ KMS ç”¨äºåŠ å¯†æ“ä½œã€‚å¤–éƒ¨å¯†é’¥**å¯ä»¥å­˜å‚¨åœ¨ç¡¬ä»¶å®‰å…¨æ¨¡å— (HSM) æˆ–è½¯ä»¶åº“ä¸­ï¼Œå–å†³äºå®¢æˆ·çš„åå¥½**ã€‚

### å¯†é’¥ç”¨é€”

* **å¯¹ç§°åŠ å¯†/è§£å¯†**ï¼šç”¨äºä½¿ç”¨å•ä¸ªå¯†é’¥è¿›è¡Œ**åŠ å¯†å’Œè§£å¯†æ•°æ®**çš„æ“ä½œã€‚å¯¹ç§°å¯†é’¥å¯¹äºåŠ å¯†å’Œè§£å¯†å¤§é‡æ•°æ®æ˜¯å¿«é€Ÿå’Œé«˜æ•ˆçš„ã€‚
* **æ”¯æŒ**ï¼š[cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **éå¯¹ç§°ç­¾å**ï¼šç”¨äºä¸¤æ–¹ä¹‹é—´çš„å®‰å…¨é€šä¿¡ï¼Œè€Œæ— éœ€å…±äº«å¯†é’¥ã€‚éå¯¹ç§°å¯†é’¥æˆå¯¹å‡ºç°ï¼ŒåŒ…æ‹¬**å…¬é’¥å’Œç§é’¥**ã€‚å…¬é’¥ä¸ä»–äººå…±äº«ï¼Œè€Œç§é’¥ä¿å¯†ã€‚
* **æ”¯æŒ**ï¼š[cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **éå¯¹ç§°è§£å¯†**ï¼šç”¨äºéªŒè¯æ¶ˆæ¯æˆ–æ•°æ®çš„çœŸå®æ€§ã€‚ä½¿ç”¨ç§é’¥åˆ›å»ºæ•°å­—ç­¾åï¼Œå¹¶å¯ä»¥ä½¿ç”¨ç›¸åº”çš„å…¬é’¥è¿›è¡ŒéªŒè¯ã€‚
* **æ”¯æŒ**ï¼š[cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **MAC ç­¾å**ï¼šé€šè¿‡ä½¿ç”¨**ç§˜å¯†å¯†é’¥**åˆ›å»ºæ¶ˆæ¯è®¤è¯ç  (MAC) æ¥ç¡®ä¿**æ•°æ®çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§**ã€‚HMAC åœ¨ç½‘ç»œåè®®å’Œè½¯ä»¶åº”ç”¨ç¨‹åºä¸­å¸¸ç”¨äºæ¶ˆæ¯è®¤è¯ã€‚
* **æ”¯æŒ**ï¼š[cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### æ—‹è½¬å‘¨æœŸå’Œé”€æ¯å‘¨æœŸ

**é»˜è®¤**ä¸ºæ¯**90å¤©**ï¼Œä½†å¯ä»¥**è½»æ¾**å’Œ**å®Œå…¨è‡ªå®šä¹‰**ã€‚

"ç¨‹åºåŒ–é”€æ¯" æœŸé—´æ˜¯**ç”¨æˆ·è¦æ±‚åˆ é™¤å¯†é’¥**çš„æ—¶é—´ï¼Œç›´åˆ°å¯†é’¥è¢«**åˆ é™¤**ã€‚åœ¨åˆ›å»ºå¯†é’¥åæ— æ³•æ›´æ”¹ (é»˜è®¤ä¸º 1 å¤©)ã€‚

### ä¸»ç‰ˆæœ¬

æ¯ä¸ª KMS å¯†é’¥å¯ä»¥æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œå…¶ä¸­ä¸€ä¸ªå¿…é¡»æ˜¯**é»˜è®¤**ç‰ˆæœ¬ï¼Œåœ¨ä¸ KMS å¯†é’¥**äº¤äº’æ—¶æœªæŒ‡å®šç‰ˆæœ¬æ—¶å°†ä½¿ç”¨è¯¥ç‰ˆæœ¬**ã€‚

### æšä¸¾

æ‹¥æœ‰**åˆ—å‡ºå¯†é’¥æƒé™**æ—¶ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®å®ƒä»¬ï¼š
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### ææƒ

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

### åæ¸—é€

{% content-ref url="../gcp-post-exploitation/gcp-kms-post-exploitation.md" %}
[gcp-kms-post-exploitation.md](../gcp-post-exploitation/gcp-kms-post-exploitation.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹  AWS é»‘å®¢æŠ€èƒ½ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹  GCP é»‘å®¢æŠ€èƒ½ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
