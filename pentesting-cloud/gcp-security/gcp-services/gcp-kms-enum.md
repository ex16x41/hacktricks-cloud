# GCP - KMS Enum

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}

## KMS

[**Cloud Key Management Service**](https://cloud.google.com/kms/docs/)ã¯ã€**æš—å·éµ**ã®å®‰å…¨ãªä¿ç®¡å ´æ‰€ã¨ã—ã¦æ©Ÿèƒ½ã—ã€**æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ãŠã‚ˆã³å¾©å·åŒ–**ãªã©ã®æ“ä½œã«ä¸å¯æ¬ ã§ã™ã€‚ã“ã‚Œã‚‰ã®éµã¯ã‚­ãƒ¼ãƒªãƒ³ã‚°å†…ã«æ•´ç†ã•ã‚Œã€æ§‹é€ åŒ–ã•ã‚ŒãŸç®¡ç†ãŒå¯èƒ½ã§ã™ã€‚ã•ã‚‰ã«ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¯ã€å€‹ã€…ã®éµãƒ¬ãƒ™ãƒ«ã¾ãŸã¯ã‚­ãƒ¼ãƒªãƒ³ã‚°å…¨ä½“ã§ç´°ã‹ãæ§‹æˆã§ãã€æ¨©é™ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã¨æ­£ç¢ºã«ä¸€è‡´ã™ã‚‹ã‚ˆã†ã«ä¿è¨¼ã•ã‚Œã¾ã™ã€‚

KMSã‚­ãƒ¼ãƒªãƒ³ã‚°ã¯**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚°ãƒ­ãƒ¼ãƒãƒ«**ã¨ã—ã¦ä½œæˆã•ã‚Œã‚‹ãŸã‚ã€ãã®ã‚­ãƒ¼ãƒªãƒ³ã‚°å†…ã®éµã¯ã©ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚ãŸã ã—ã€**ç‰¹å®šã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**ã«ç‰¹å®šã®ã‚­ãƒ¼ãƒªãƒ³ã‚°ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

### éµä¿è­·ãƒ¬ãƒ™ãƒ«

* **ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢éµ**: ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢éµã¯ã€KMSã«ã‚ˆã£ã¦å®Œå…¨ã«ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã§ä½œæˆãŠã‚ˆã³ç®¡ç†ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®éµã¯**ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆHSMï¼‰ã§ä¿è­·ã•ã‚Œã¦ãŠã‚‰ãš**ã€**ãƒ†ã‚¹ãƒˆãŠã‚ˆã³é–‹ç™ºç›®çš„**ã«ä½¿ç”¨ã§ãã¾ã™ã€‚ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢éµã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒä½ãæ”»æ’ƒã‚’å—ã‘ã‚„ã™ã„ãŸã‚ã€**æœ¬ç•ªç’°å¢ƒã§ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“**ã€‚
* **ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ›ã‚¹ãƒˆã•ã‚ŒãŸéµ**: ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ›ã‚¹ãƒˆã•ã‚ŒãŸéµã¯ã€ä¿¡é ¼æ€§ã®é«˜ã„ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰å†…ã§KMSã«ã‚ˆã£ã¦ä½œæˆãŠã‚ˆã³ç®¡ç†ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®éµã¯**HSMã«ã‚ˆã£ã¦ä¿è­·ã•ã‚Œã¦ã„ã¾ã™**ãŒã€HSMã¯**ç‰¹å®šã®é¡§å®¢ã«å°‚ç”¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“**ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ›ã‚¹ãƒˆã•ã‚ŒãŸéµã¯ã€ã»ã¨ã‚“ã©ã®æœ¬ç•ªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«é©ã—ã¦ã„ã¾ã™ã€‚
* **å¤–éƒ¨éµ**: å¤–éƒ¨éµã¯ã€KMSã®å¤–ã§ä½œæˆãŠã‚ˆã³ç®¡ç†ã•ã‚Œã€æš—å·æ“ä½œã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«KMSã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã™ã€‚å¤–éƒ¨éµã¯ã€é¡§å®¢ã®é¸æŠã«å¿œã˜ã¦**ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆHSMï¼‰ã¾ãŸã¯ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜**ã§ãã¾ã™ã€‚

### éµã®ç›®çš„

* **å¯¾ç§°æš—å·åŒ–/å¾©å·åŒ–**: **å˜ä¸€ã®éµã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ãŠã‚ˆã³å¾©å·åŒ–**ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚å¯¾ç§°éµã¯ã€å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ãŠã‚ˆã³å¾©å·åŒ–ã™ã‚‹éš›ã«é«˜é€Ÿã‹ã¤åŠ¹ç‡çš„ã§ã™ã€‚
* **ã‚µãƒãƒ¼ãƒˆ**: [cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **éå¯¾ç§°ç½²å**: éµã‚’å…±æœ‰ã›ãšã«2è€…é–“ã§å®‰å…¨ãªé€šä¿¡ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚éå¯¾ç§°éµã¯ã€**å…¬é–‹éµã¨ç§˜å¯†éµ**ã‹ã‚‰ãªã‚Šã¾ã™ã€‚å…¬é–‹éµã¯ä»–è€…ã¨å…±æœ‰ã•ã‚Œã€ç§˜å¯†éµã¯ç§˜å¯†ã«ä¿æŒã•ã‚Œã¾ã™ã€‚
* **ã‚µãƒãƒ¼ãƒˆ**: [cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **éå¯¾ç§°å¾©å·åŒ–**: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ã®çœŸæ­£æ€§ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ç§˜å¯†éµã‚’ä½¿ç”¨ã—ã¦ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åãŒä½œæˆã•ã‚Œã€å¯¾å¿œã™ã‚‹å…¬é–‹éµã‚’ä½¿ç”¨ã—ã¦æ¤œè¨¼ã§ãã¾ã™ã€‚
* **ã‚µãƒãƒ¼ãƒˆ**: [cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **MACç½²å**: **ç§˜å¯†éµã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆMACï¼‰ã‚’ä½œæˆ**ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã¨çœŸæ­£æ€§ã‚’ç¢ºä¿ã—ã¾ã™ã€‚HMACã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚„ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èªè¨¼ã«ä¸€èˆ¬çš„ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
* **ã‚µãƒãƒ¼ãƒˆ**: [cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“ãŠã‚ˆã³ç ´æ£„ãƒ—ãƒ­ã‚°ãƒ©ãƒ æœŸé–“

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**ã§ã¯ã€**90æ—¥**ã”ã¨ã«è¡Œã‚ã‚Œã¾ã™ãŒã€**ç°¡å˜ã«**ãŠã‚ˆã³**å®Œå…¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º**ã§ãã¾ã™ã€‚

ã€Œç ´æ£„ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã€æœŸé–“ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒéµã®å‰Šé™¤ã‚’è¦æ±‚ã—ã¦ã‹ã‚‰éµãŒ**å‰Šé™¤**ã•ã‚Œã‚‹ã¾ã§ã®æ™‚é–“ã§ã™ã€‚éµãŒä½œæˆã•ã‚ŒãŸå¾Œã«å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1æ—¥ï¼‰ã€‚

### ãƒ—ãƒ©ã‚¤ãƒãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³

å„KMSéµã«ã¯è¤‡æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Šã€ãã®ã†ã¡ã®1ã¤ã¯**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€KMSéµã¨ã‚„ã‚Šå–ã‚Šã™ã‚‹éš›ã«**ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚‚ã®**ã§ã™ã€‚

### åˆ—æŒ™

**éµã‚’ãƒªã‚¹ãƒˆã™ã‚‹æ¨©é™**ãŒã‚ã‚‹å ´åˆã€ã“ã‚ŒãŒã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã§ã™:
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### ç‰¹æ¨©æ˜‡æ ¼

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

### ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

{% content-ref url="../gcp-post-exploitation/gcp-kms-post-exploitation.md" %}
[gcp-kms-post-exploitation.md](../gcp-post-exploitation/gcp-kms-post-exploitation.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã¾ãŸã¯**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦**ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰**ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
