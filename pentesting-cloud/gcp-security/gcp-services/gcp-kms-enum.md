# GCP - KMS Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS

[**Cloud Key Management Service**](https://cloud.google.com/kms/docs/)ã¯ã€**æš—å·éµ**ã®å®‰å…¨ãªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã—ã¦æ©Ÿèƒ½ã—ã€**æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ãŠã‚ˆã³å¾©å·åŒ–**ãªã©ã®æ“ä½œã«ä¸å¯æ¬ ã§ã™ã€‚ã“ã‚Œã‚‰ã®éµã¯ã‚­ãƒ¼ãƒªãƒ³ã‚°å†…ã«æ•´ç†ã•ã‚Œã€æ§‹é€ çš„ãªç®¡ç†ãŒå¯èƒ½ã§ã™ã€‚ã•ã‚‰ã«ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¯å€‹ã€…ã®éµãƒ¬ãƒ™ãƒ«ã¾ãŸã¯å…¨ä½“ã®ã‚­ãƒ¼ãƒªãƒ³ã‚°ã«å¯¾ã—ã¦è©³ç´°ã«è¨­å®šã§ãã€æ¨©é™ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã«æ­£ç¢ºã«ä¸€è‡´ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

KMSã‚­ãƒ¼ãƒªãƒ³ã‚°ã¯**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚°ãƒ­ãƒ¼ãƒãƒ«**ã«ä½œæˆã•ã‚Œã€ã‚­ãƒ¼ãƒªãƒ³ã‚°å†…ã®éµã¯ä»»æ„ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚ãŸã ã—ã€**ç‰¹å®šã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**ã«ç‰¹åŒ–ã—ãŸã‚­ãƒ¼ãƒªãƒ³ã‚°ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

### Key Protection Level

* **ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚­ãƒ¼**: ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚­ãƒ¼ã¯**KMSã«ã‚ˆã£ã¦å®Œå…¨ã«ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã§ä½œæˆãŠã‚ˆã³ç®¡ç†**ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®éµã¯**ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆHSMï¼‰ã«ã‚ˆã£ã¦ä¿è­·ã•ã‚Œã¦ãŠã‚‰ãš**ã€**ãƒ†ã‚¹ãƒˆãŠã‚ˆã³é–‹ç™ºç›®çš„**ã§ä½¿ç”¨ã§ãã¾ã™ã€‚ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚­ãƒ¼ã¯**æœ¬ç•ªç’°å¢ƒ**ã§ã®ä½¿ç”¨ã«ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚ãªãœãªã‚‰ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒä½ãã€æ”»æ’ƒã«å¯¾ã—ã¦è„†å¼±ã ã‹ã‚‰ã§ã™ã€‚
* **ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ›ã‚¹ãƒˆã‚­ãƒ¼**: ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ›ã‚¹ãƒˆã‚­ãƒ¼ã¯ã€**KMSã«ã‚ˆã£ã¦ã‚¯ãƒ©ã‚¦ãƒ‰å†…ã§ä½œæˆãŠã‚ˆã³ç®¡ç†**ã•ã‚Œã€é«˜å¯ç”¨æ€§ã§ä¿¡é ¼æ€§ã®é«˜ã„ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®éµã¯**HSMã«ã‚ˆã£ã¦ä¿è­·ã•ã‚Œã¦ã„ã¾ã™ãŒ**ã€HSMã¯**ç‰¹å®šã®é¡§å®¢ã«å°‚ç”¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“**ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ›ã‚¹ãƒˆã‚­ãƒ¼ã¯ã»ã¨ã‚“ã©ã®æœ¬ç•ªä½¿ç”¨ã‚±ãƒ¼ã‚¹ã«é©ã—ã¦ã„ã¾ã™ã€‚
* **å¤–éƒ¨ã‚­ãƒ¼**: å¤–éƒ¨ã‚­ãƒ¼ã¯**KMSã®å¤–éƒ¨ã§ä½œæˆãŠã‚ˆã³ç®¡ç†**ã•ã‚Œã€æš—å·æ“ä½œã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«KMSã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã™ã€‚å¤–éƒ¨ã‚­ãƒ¼ã¯**é¡§å®¢ã®å¥½ã¿ã«å¿œã˜ã¦ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆHSMï¼‰ã¾ãŸã¯ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ã§ãã¾ã™**ã€‚

### Key Purposes

* **å¯¾ç§°æš—å·åŒ–/å¾©å·åŒ–**: **å˜ä¸€ã®éµã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ãŠã‚ˆã³å¾©å·åŒ–ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™**ã€‚å¯¾ç§°éµã¯ã€å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ãŠã‚ˆã³å¾©å·åŒ–ã™ã‚‹ã®ã«é«˜é€Ÿã§åŠ¹ç‡çš„ã§ã™ã€‚
* **ã‚µãƒãƒ¼ãƒˆ**: [cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **éå¯¾ç§°ç½²å**: éµã‚’å…±æœ‰ã›ãšã«äºŒè€…é–“ã®å®‰å…¨ãªé€šä¿¡ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚éå¯¾ç§°éµã¯ãƒšã‚¢ã§æ§‹æˆã•ã‚Œã€**å…¬é–‹éµã¨ç§˜å¯†éµ**ãŒã‚ã‚Šã¾ã™ã€‚å…¬é–‹éµã¯ä»–è€…ã¨å…±æœ‰ã•ã‚Œã€ç§˜å¯†éµã¯ç§˜å¯†ã«ä¿ãŸã‚Œã¾ã™ã€‚
* **ã‚µãƒãƒ¼ãƒˆ**: [cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **éå¯¾ç§°å¾©å·åŒ–**: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ã®çœŸæ­£æ€§ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã¯ç§˜å¯†éµã‚’ä½¿ç”¨ã—ã¦ä½œæˆã•ã‚Œã€å¯¾å¿œã™ã‚‹å…¬é–‹éµã‚’ä½¿ç”¨ã—ã¦æ¤œè¨¼ã§ãã¾ã™ã€‚
* **ã‚µãƒãƒ¼ãƒˆ**: [cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **MACç½²å**: **ç§˜å¯†éµã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆMACï¼‰ã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã¨çœŸæ­£æ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™**ã€‚HMACã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚„ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èªè¨¼ã«ä¸€èˆ¬çš„ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
* **ã‚µãƒãƒ¼ãƒˆ**: [cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### Rotation Period & Programmed for destruction period

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**ã§ã¯ã€**90æ—¥ã”ã¨**ã§ã™ãŒã€**ç°¡å˜ã«**ã‹ã¤**å®Œå…¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ã§ã™**ã€‚

ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚ŒãŸç ´å£Šã€æœŸé–“ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒéµã®å‰Šé™¤ã‚’è¦æ±‚ã—ã¦ã‹ã‚‰ã®æ™‚é–“**ã§ã‚ã‚Šã€éµãŒ**å‰Šé™¤ã•ã‚Œã‚‹ã¾ã§**ã®æœŸé–“ã§ã™ã€‚éµãŒä½œæˆã•ã‚ŒãŸå¾Œã¯å¤‰æ›´ã§ãã¾ã›ã‚“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1æ—¥ï¼‰ã€‚

### Primary Version

å„KMSéµã¯è¤‡æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒã¤ã“ã¨ãŒã§ãã€ãã®ã†ã¡ã®1ã¤ã¯**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**ã®ã‚‚ã®ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ã“ã‚Œã¯ã€**KMSéµã¨å¯¾è©±ã™ã‚‹éš›ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚‚ã®ã§ã™**ã€‚

### Enumeration

**éµã‚’ãƒªã‚¹ãƒˆã™ã‚‹æ¨©é™ãŒã‚ã‚‹å ´åˆ**ã€ã“ã‚ŒãŒãã‚Œã‚‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ–¹æ³•ã§ã™:
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms encrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### æ¨©é™æ˜‡æ ¼

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

### ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ

{% content-ref url="../gcp-post-exploitation/gcp-kms-post-exploitation.md" %}
[gcp-kms-post-exploitation.md](../gcp-post-exploitation/gcp-kms-post-exploitation.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
