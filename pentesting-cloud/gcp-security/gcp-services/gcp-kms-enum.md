# GCP - KMS Enum

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## KMS

[**äº‘å¯†é’¥ç®¡ç†æœåŠ¡**](https://cloud.google.com/kms/docs/) ä½œä¸º **åŠ å¯†å¯†é’¥** çš„å®‰å…¨å­˜å‚¨ï¼Œè¿™äº›å¯†é’¥å¯¹äº **åŠ å¯†å’Œè§£å¯†æ•æ„Ÿæ•°æ®** çš„æ“ä½œè‡³å…³é‡è¦ã€‚è¿™äº›å¯†é’¥è¢«ç»„ç»‡åœ¨å¯†é’¥ç¯ä¸­ï¼Œå…è®¸è¿›è¡Œç»“æ„åŒ–ç®¡ç†ã€‚æ­¤å¤–ï¼Œè®¿é—®æ§åˆ¶å¯ä»¥åœ¨å•ä¸ªå¯†é’¥çº§åˆ«æˆ–æ•´ä¸ªå¯†é’¥ç¯ä¸Šè¿›è¡Œç²¾ç¡®é…ç½®ï¼Œç¡®ä¿æƒé™ä¸å®‰å…¨è¦æ±‚ä¸¥æ ¼å¯¹é½ã€‚

KMS å¯†é’¥ç¯é»˜è®¤åˆ›å»ºä¸º **å…¨çƒ**ï¼Œè¿™æ„å‘³ç€è¯¥å¯†é’¥ç¯å†…çš„å¯†é’¥å¯ä»¥ä»ä»»ä½•åŒºåŸŸè®¿é—®ã€‚ç„¶è€Œï¼Œå¯ä»¥åœ¨ **ç‰¹å®šåŒºåŸŸ** åˆ›å»ºç‰¹å®šçš„å¯†é’¥ç¯ã€‚

### å¯†é’¥ä¿æŠ¤çº§åˆ«

* **è½¯ä»¶å¯†é’¥**ï¼šè½¯ä»¶å¯†é’¥å®Œå…¨ç”± KMS åœ¨è½¯ä»¶ä¸­ **åˆ›å»ºå’Œç®¡ç†**ã€‚è¿™äº›å¯†é’¥ **ä¸å—ä»»ä½•ç¡¬ä»¶å®‰å…¨æ¨¡å— (HSM)** ä¿æŠ¤ï¼Œå¯ä»¥ç”¨äº **æµ‹è¯•å’Œå¼€å‘ç›®çš„**ã€‚è½¯ä»¶å¯†é’¥ **ä¸æ¨èç”¨äºç”Ÿäº§**ï¼Œå› ä¸ºå®ƒä»¬æä¾›çš„å®‰å…¨æ€§è¾ƒä½ï¼Œå®¹æ˜“å—åˆ°æ”»å‡»ã€‚
* **äº‘æ‰˜ç®¡å¯†é’¥**ï¼šäº‘æ‰˜ç®¡å¯†é’¥ç”± KMS åœ¨äº‘ä¸­ **åˆ›å»ºå’Œç®¡ç†**ï¼Œä½¿ç”¨é«˜åº¦å¯ç”¨å’Œå¯é çš„åŸºç¡€è®¾æ–½ã€‚è¿™äº›å¯†é’¥ **å— HSM ä¿æŠ¤**ï¼Œä½† HSM **å¹¶ä¸ä¸“é—¨ä¸ºç‰¹å®šå®¢æˆ·æä¾›**ã€‚äº‘æ‰˜ç®¡å¯†é’¥é€‚ç”¨äºå¤§å¤šæ•°ç”Ÿäº§ç”¨ä¾‹ã€‚
* **å¤–éƒ¨å¯†é’¥**ï¼šå¤–éƒ¨å¯†é’¥åœ¨ KMS **å¤–éƒ¨åˆ›å»ºå’Œç®¡ç†**ï¼Œå¹¶å¯¼å…¥åˆ° KMS ä¸­ä»¥ç”¨äºåŠ å¯†æ“ä½œã€‚å¤–éƒ¨å¯†é’¥ **å¯ä»¥å­˜å‚¨åœ¨ç¡¬ä»¶å®‰å…¨æ¨¡å— (HSM) æˆ–è½¯ä»¶åº“ä¸­ï¼Œå…·ä½“å–å†³äºå®¢æˆ·çš„åå¥½**ã€‚

### å¯†é’¥ç”¨é€”

* **å¯¹ç§°åŠ å¯†/è§£å¯†**ï¼šç”¨äº **ä½¿ç”¨å•ä¸ªå¯†é’¥è¿›è¡Œæ•°æ®çš„åŠ å¯†å’Œè§£å¯†**ã€‚å¯¹ç§°å¯†é’¥åœ¨åŠ å¯†å’Œè§£å¯†å¤§é‡æ•°æ®æ—¶å¿«é€Ÿä¸”é«˜æ•ˆã€‚
* **æ”¯æŒ**ï¼š[cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt)ï¼Œ[cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **éå¯¹ç§°ç­¾å**ï¼šç”¨äºåœ¨ä¸å…±äº«å¯†é’¥çš„æƒ…å†µä¸‹åœ¨ä¸¤æ–¹ä¹‹é—´è¿›è¡Œå®‰å…¨é€šä¿¡ã€‚éå¯¹ç§°å¯†é’¥æˆå¯¹å‡ºç°ï¼ŒåŒ…æ‹¬ **å…¬é’¥å’Œç§é’¥**ã€‚å…¬é’¥ä¸ä»–äººå…±äº«ï¼Œè€Œç§é’¥åˆ™ä¿å¯†ã€‚
* **æ”¯æŒ**ï¼š[cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign)ï¼Œ[cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **éå¯¹ç§°è§£å¯†**ï¼šç”¨äºéªŒè¯æ¶ˆæ¯æˆ–æ•°æ®çš„çœŸå®æ€§ã€‚ä½¿ç”¨ç§é’¥åˆ›å»ºæ•°å­—ç­¾åï¼Œå¹¶å¯ä»¥ä½¿ç”¨ç›¸åº”çš„å…¬é’¥è¿›è¡ŒéªŒè¯ã€‚
* **æ”¯æŒ**ï¼š[cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt)ï¼Œ[cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **MAC ç­¾å**ï¼šç”¨äºé€šè¿‡ä½¿ç”¨ç§˜å¯†å¯†é’¥åˆ›å»ºæ¶ˆæ¯è®¤è¯ç  (MAC) æ¥ç¡®ä¿ **æ•°æ®çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§**ã€‚HMAC é€šå¸¸ç”¨äºç½‘ç»œåè®®å’Œè½¯ä»¶åº”ç”¨ä¸­çš„æ¶ˆæ¯è®¤è¯ã€‚
* **æ”¯æŒ**ï¼š[cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign)ï¼Œ[cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### è½®æ¢å‘¨æœŸå’Œé”€æ¯å‘¨æœŸ

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ **90 å¤©**ï¼Œä½†å¯ä»¥ **è½»æ¾** å’Œ **å®Œå…¨è‡ªå®šä¹‰**ã€‚

â€œç¨‹åºåŒ–é”€æ¯â€å‘¨æœŸæ˜¯ **ç”¨æˆ·è¯·æ±‚åˆ é™¤å¯†é’¥åçš„æ—¶é—´**ï¼Œç›´åˆ°å¯†é’¥è¢« **åˆ é™¤**ã€‚åœ¨å¯†é’¥åˆ›å»ºåæ— æ³•æ›´æ”¹ï¼ˆé»˜è®¤ 1 å¤©ï¼‰ã€‚

### ä¸»ç‰ˆæœ¬

æ¯ä¸ª KMS å¯†é’¥å¯ä»¥æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œå…¶ä¸­ä¸€ä¸ªå¿…é¡»æ˜¯ **é»˜è®¤** ç‰ˆæœ¬ï¼Œå½“ä¸ KMS å¯†é’¥äº¤äº’æ—¶æœªæŒ‡å®šç‰ˆæœ¬æ—¶å°†ä½¿ç”¨è¯¥ç‰ˆæœ¬ã€‚

### æšä¸¾

æ‹¥æœ‰ **åˆ—å‡ºå¯†é’¥çš„æƒé™**ï¼Œè¿™å°±æ˜¯æ‚¨å¯ä»¥è®¿é—®å®ƒä»¬çš„æ–¹å¼ï¼š
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms encrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### æƒé™æå‡

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

### åˆ©ç”¨å

{% content-ref url="../gcp-post-exploitation/gcp-kms-post-exploitation.md" %}
[gcp-kms-post-exploitation.md](../gcp-post-exploitation/gcp-kms-post-exploitation.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
