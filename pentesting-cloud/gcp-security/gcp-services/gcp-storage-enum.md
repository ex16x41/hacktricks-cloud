# GCP - Storage Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Stockage

Google Cloud Platform (GCP) Storage est une **solution de stockage bas√©e sur le cloud** qui fournit un stockage d'objets hautement durable et disponible pour des donn√©es non structur√©es. Il offre **diff√©rentes classes de stockage** bas√©es sur la performance, la disponibilit√© et le co√ªt, y compris Standard, Nearline, Coldline et Archive. GCP Storage fournit √©galement des fonctionnalit√©s avanc√©es telles que **des politiques de cycle de vie, la gestion des versions et le contr√¥le d'acc√®s** pour g√©rer et s√©curiser les donn√©es efficacement.

Le bucket peut √™tre stock√© dans une r√©gion, dans 2 r√©gions ou **multi-r√©gion (par d√©faut)**.

### Types de stockage

* **Stockage standard** : C'est l'option de stockage par d√©faut qui **offre un acc√®s √† haute performance et faible latence aux donn√©es fr√©quemment consult√©es**. Il convient √† un large √©ventail de cas d'utilisation, y compris la diffusion de contenu de site Web, le streaming de m√©dias et l'h√©bergement de pipelines d'analyse de donn√©es.
* **Stockage Nearline** : Cette classe de stockage offre **des co√ªts de stockage inf√©rieurs** et **des co√ªts d'acc√®s l√©g√®rement plus √©lev√©s** que le stockage standard. Il est optimis√© pour les donn√©es rarement consult√©es, avec une dur√©e de stockage minimale de 30 jours. Il est id√©al pour les sauvegardes et les archives.
* **Stockage Coldline** : Cette classe de stockage est optimis√©e pour **le stockage √† long terme de donn√©es rarement consult√©es**, avec une dur√©e de stockage minimale de 90 jours. Il offre **des co√ªts de stockage inf√©rieurs** √† ceux du stockage Nearline, mais avec **des co√ªts d'acc√®s plus √©lev√©s**.
* **Stockage Archive** : Cette classe de stockage est con√ßue pour les donn√©es froides qui sont consult√©es **tr√®s rarement**, avec une dur√©e de stockage minimale de 365 jours. Elle offre **les co√ªts de stockage les plus bas de toutes les options de stockage GCP**, mais avec **les co√ªts d'acc√®s les plus √©lev√©s**. Elle convient √† la conservation √† long terme des donn√©es qui doivent √™tre stock√©es pour des raisons de conformit√© ou r√©glementaires.
* **Autoclass** : Si vous **ne savez pas combien de fois vous allez acc√©der** aux donn√©es, vous pouvez s√©lectionner Autoclass et GCP **changera automatiquement le type de stockage pour vous afin de minimiser les co√ªts**.

### Contr√¥le d'acc√®s

Par **d√©faut**, il est **recommand√©** de contr√¥ler l'acc√®s via **IAM**, mais il est √©galement possible **d'activer l'utilisation des ACL**.\
Si vous choisissez d'utiliser uniquement IAM (par d√©faut) et que **90 jours passent**, vous **ne pourrez pas activer les ACL** pour le bucket.

### Gestion des versions

Il est possible d'activer la gestion des versions, cela **sauvera les anciennes versions du fichier √† l'int√©rieur du bucket**. Il est possible de configurer le **nombre de versions que vous souhaitez conserver** et m√™me **combien de temps** vous souhaitez que les versions **non courantes** (anciennes versions) vivent. Il est recommand√© de **7 jours pour le type Standard**.

Les **m√©tadonn√©es d'une version non courante sont conserv√©es**. De plus, **les ACL des versions non courantes sont √©galement conserv√©es**, donc les anciennes versions peuvent avoir des ACL diff√©rentes de la version actuelle.

En savoir plus dans la [**documentation**](https://cloud.google.com/storage/docs/object-versioning).

### Politique de conservation

Indiquez combien de temps vous souhaitez **interdire la suppression des objets √† l'int√©rieur du bucket** (tr√®s utile pour la conformit√© au moins).\
Une seule de **la gestion des versions ou de la politique de conservation peut √™tre activ√©e √† la fois**.

### Chiffrement

Par d√©faut, les objets sont **chiffr√©s √† l'aide de cl√©s g√©r√©es par Google**, mais vous pouvez √©galement utiliser une **cl√© de KMS**.

### Acc√®s public

Il est possible de donner **acc√®s √† des utilisateurs externes** (connect√©s √† GCP ou non) au **contenu des buckets**.\
Par d√©faut, lorsqu'un bucket est cr√©√©, il aura **d√©sactiv√© l'option d'exposition publique** du bucket, mais avec suffisamment de permissions, cela peut √™tre chang√©.

Le **format d'une URL** pour acc√©der √† un bucket est **`https://storage.googleapis.com/<bucket-name>` ou `https://<bucket_name>.storage.googleapis.com`** (les deux sont valides).

### Cl√©s HMAC

Une cl√© HMAC est un type de _credential_ et peut √™tre **associ√©e √† un compte de service ou √† un compte utilisateur dans Cloud Storage**. Vous utilisez une cl√© HMAC pour cr√©er des _signatures_ qui sont ensuite incluses dans les requ√™tes vers Cloud Storage. Les signatures montrent qu'une **demande donn√©e est autoris√©e par l'utilisateur ou le compte de service**.

Les cl√©s HMAC ont deux √©l√©ments principaux, un _ID d'acc√®s_ et un _secret_.

*   **ID d'acc√®s** : Une cha√Æne alphanum√©rique li√©e √† un compte de service ou utilisateur sp√©cifique. Lorsqu'elle est li√©e √† un compte de service, la cha√Æne fait 61 caract√®res de long, et lorsqu'elle est li√©e √† un compte utilisateur, la cha√Æne fait 24 caract√®res de long. Voici un exemple d'ID d'acc√®s :

`GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA`
*   **Secret** : Une cha√Æne cod√©e en Base-64 de 40 caract√®res qui est li√©e √† un ID d'acc√®s sp√©cifique. Un secret est une cl√© pr√©partag√©e que vous et Cloud Storage connaissez uniquement. Vous utilisez votre secret pour cr√©er des signatures dans le cadre du processus d'authentification. Voici un exemple de secret :

`bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ`

√Ä la fois l'**ID d'acc√®s et le secret identifient de mani√®re unique une cl√© HMAC**, mais le secret est une information beaucoup plus sensible, car il est utilis√© pour **cr√©er des signatures**.

### √ânum√©ration
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -

# Enumerate HMAC keys
gsutil hmac list

# Get permissions
gcloud storage buckets get-iam-policy gs://bucket-name/
gcloud storage objects get-iam-policy gs://bucket-name/folder/object
```
Si vous obtenez une erreur de permission refus√©e lors de la liste des buckets, vous pouvez toujours avoir acc√®s au contenu. Donc, maintenant que vous connaissez la convention de nommage des buckets, vous pouvez g√©n√©rer une liste de noms possibles et essayer d'y acc√©der :
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
Avec les permissions `storage.objects.list` et `storage.objects.get`, vous devriez √™tre en mesure d'√©num√©rer tous les dossiers et fichiers du bucket afin de les t√©l√©charger. Vous pouvez y parvenir avec ce script Python :
```python
import requests
import xml.etree.ElementTree as ET

def list_bucket_objects(bucket_name, prefix='', marker=None):
url = f"https://storage.googleapis.com/{bucket_name}?prefix={prefix}"
if marker:
url += f"&marker={marker}"
response = requests.get(url)
xml_data = response.content
root = ET.fromstring(xml_data)
ns = {'ns': 'http://doc.s3.amazonaws.com/2006-03-01'}
for contents in root.findall('.//ns:Contents', namespaces=ns):
key = contents.find('ns:Key', namespaces=ns).text
print(key)
next_marker = root.find('ns:NextMarker', namespaces=ns)
if next_marker is not None:
next_marker_value = next_marker.text
list_bucket_objects(bucket_name, prefix, next_marker_value)

list_bucket_objects('<storage-name>')
```
### √âl√©vation de privil√®ges

Dans la page suivante, vous pouvez v√©rifier comment **abuser des permissions de stockage pour √©lever les privil√®ges** :

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### Enum√©ration non authentifi√©e

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-storage-unauthenticated-enum/" %}
[gcp-storage-unauthenticated-enum](../gcp-unauthenticated-enum-and-access/gcp-storage-unauthenticated-enum/)
{% endcontent-ref %}

### Post exploitation

{% content-ref url="../gcp-post-exploitation/gcp-storage-post-exploitation.md" %}
[gcp-storage-post-exploitation.md](../gcp-post-exploitation/gcp-storage-post-exploitation.md)
{% endcontent-ref %}

### Persistance

{% content-ref url="../gcp-persistence/gcp-storage-persistence.md" %}
[gcp-storage-persistence.md](../gcp-persistence/gcp-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
