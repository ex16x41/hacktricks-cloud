# GCP - Storage Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage

Google Cloud Platform (GCP) Storage to **rozwizanie do przechowywania w chmurze**, kt贸re zapewnia wysoce trwae i dostpne przechowywanie obiekt贸w dla danych niestrukturalnych. Oferuje **r贸偶ne klasy przechowywania** w zale偶noci od wydajnoci, dostpnoci i koszt贸w, w tym Standard, Nearline, Coldline i Archive. GCP Storage zapewnia r贸wnie偶 zaawansowane funkcje, takie jak **polityki cyklu 偶ycia, wersjonowanie i kontrola dostpu**, aby skutecznie zarzdza i zabezpiecza dane.

Bucket mo偶e by przechowywany w regionie, w 2 regionach lub **w wielu regionach (domylnie)**.

### Storage Types

* **Standard Storage**: To domylna opcja przechowywania, kt贸ra **oferuje wysok wydajno i nisk latencj dostpu do czsto u偶ywanych danych**. Nadaje si do szerokiego zakresu zastosowa, w tym do serwowania treci internetowych, strumieniowania medi贸w i hostowania potok贸w analityki danych.
* **Nearline Storage**: Ta klasa przechowywania oferuje **ni偶sze koszty przechowywania** i **nieco wy偶sze koszty dostpu** ni偶 Standard Storage. Jest zoptymalizowana do rzadko u偶ywanych danych, z minimalnym czasem przechowywania wynoszcym 30 dni. Idealna do cel贸w kopii zapasowych i archiwizacji.
* **Coldline Storage**: Ta klasa przechowywania jest zoptymalizowana do **dugoterminowego przechowywania rzadko u偶ywanych danych**, z minimalnym czasem przechowywania wynoszcym 90 dni. Oferuje **ni偶sze koszty przechowywania** ni偶 Nearline Storage, ale z **wy偶szymi kosztami dostpu**.
* **Archive Storage**: Ta klasa przechowywania jest zaprojektowana dla zimnych danych, kt贸re s dostpne **bardzo rzadko**, z minimalnym czasem przechowywania wynoszcym 365 dni. Oferuje **najni偶sze koszty przechowywania ze wszystkich opcji GCP**, ale z **najwy偶szymi kosztami dostpu**. Nadaje si do dugoterminowego przechowywania danych, kt贸re musz by przechowywane w celach zgodnoci lub regulacyjnych.
* **Autoclass**: Jeli **nie wiesz, jak czsto bdziesz uzyskiwa dostp** do danych, mo偶esz wybra Autoclass, a GCP **automatycznie zmieni typ przechowywania, aby zminimalizowa koszty**.

### Access Control

Domylnie **zaleca si** kontrolowanie dostpu za pomoc **IAM**, ale mo偶liwe jest r贸wnie偶 **wczenie u偶ycia ACL**.\
Jeli wybierzesz tylko u偶ycie IAM (domylnie) i **minie 90 dni**, **nie bdziesz m贸g wczy ACL** dla bucketu.

### Versioning

Mo偶liwe jest wczenie wersjonowania, co **zapisze stare wersje pliku w bucket**. Mo偶na skonfigurowa **liczb wersji, kt贸re chcesz zachowa** i nawet **jak dugo** chcesz, aby **wersje nieaktualne** (stare wersje) byy przechowywane. Zaleca si **7 dni dla typu Standard**.

**Metadane wersji nieaktualnej s przechowywane**. Ponadto **ACL wersji nieaktualnych s r贸wnie偶 przechowywane**, wic starsze wersje mog mie r贸偶ne ACL od wersji aktualnej.

Dowiedz si wicej w [**dokumentacji**](https://cloud.google.com/storage/docs/object-versioning).

### Retention Policy

Wska藕, jak **dugo** chcesz **zabroni usuwania obiekt贸w w bucket** (bardzo przydatne przynajmniej dla zgodnoci).\
Tylko jedna z **polityki wersjonowania lub polityki przechowywania mo偶e by wczona w tym samym czasie**.

### Encryption

Domylnie obiekty s **szyfrowane za pomoc kluczy zarzdzanych przez Google**, ale mo偶esz r贸wnie偶 u偶y **klucza z KMS**.

### Public Access

Mo偶liwe jest nadanie **zewntrznym u偶ytkownikom** (zalogowanym w GCP lub nie) **dostpu do zawartoci bucketu**.\
Domylnie, gdy bucket jest tworzony, bdzie mia **wyczon opcj publicznego udostpniania** bucketu, ale przy wystarczajcych uprawnieniach mo偶na to zmieni.

**Format URL** do uzyskania dostpu do bucketu to **`https://storage.googleapis.com/<bucket-name>` lub `https://<bucket_name>.storage.googleapis.com`** (oba s wa偶ne).

### HMAC Keys

Klucz HMAC to rodzaj _powiadczenia_ i mo偶e by **powizany z kontem usugi lub kontem u偶ytkownika w Cloud Storage**. U偶ywasz klucza HMAC do tworzenia _podpis贸w_, kt贸re s nastpnie doczane do 偶da do Cloud Storage. Podpisy pokazuj, 偶e **dane 偶danie jest autoryzowane przez u偶ytkownika lub konto usugi**.

Klucze HMAC maj dwa g贸wne elementy, _identyfikator dostpu_ i _sekret_.

*   **Access ID**: Alfanumeryczny cig powizany z okrelon usug lub kontem u偶ytkownika. Gdy jest powizany z kontem usugi, cig ma dugo 61 znak贸w, a gdy jest powizany z kontem u偶ytkownika, cig ma dugo 24 znak贸w. Poni偶ej znajduje si przykad identyfikatora dostpu:

`GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA`
*   **Secret**: 40-znakowy cig zakodowany w Base-64, kt贸ry jest powizany z okrelonym identyfikatorem dostpu. Sekret to klucz wstpnie udostpniony, kt贸ry znasz tylko ty i Cloud Storage. U偶ywasz swojego sekretu do tworzenia podpis贸w jako cz procesu uwierzytelniania. Poni偶ej znajduje si przykad sekretu:

`bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ`

Zar贸wno **identyfikator dostpu, jak i sekret unikalnie identyfikuj klucz HMAC**, ale sekret jest znacznie bardziej wra偶liw informacj, poniewa偶 jest u偶ywany do **tworzenia podpis贸w**.

### Enumeration
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -

# Enumerate HMAC keys
gsutil hmac list

# Get permissions
gcloud storage buckets get-iam-policy gs://bucket-name/
gcloud storage objects get-iam-policy gs://bucket-name/folder/object
```
Jeli otrzymasz bd odmowy dostpu podczas wywietlania koszy, mo偶esz nadal mie dostp do zawartoci. Teraz, gdy znasz konwencj nazewnictwa koszy, mo偶esz wygenerowa list mo偶liwych nazw i spr贸bowa uzyska do nich dostp:
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
Z uprawnieniami `storage.objects.list` i `storage.objects.get` powiniene by w stanie wylistowa wszystkie foldery i pliki z koszyka, aby je pobra. Mo偶esz to osign za pomoc tego skryptu Pythona:
```python
import requests
import xml.etree.ElementTree as ET

def list_bucket_objects(bucket_name, prefix='', marker=None):
url = f"https://storage.googleapis.com/{bucket_name}?prefix={prefix}"
if marker:
url += f"&marker={marker}"
response = requests.get(url)
xml_data = response.content
root = ET.fromstring(xml_data)
ns = {'ns': 'http://doc.s3.amazonaws.com/2006-03-01'}
for contents in root.findall('.//ns:Contents', namespaces=ns):
key = contents.find('ns:Key', namespaces=ns).text
print(key)
next_marker = root.find('ns:NextMarker', namespaces=ns)
if next_marker is not None:
next_marker_value = next_marker.text
list_bucket_objects(bucket_name, prefix, next_marker_value)

list_bucket_objects('<storage-name>')
```
### Eskalacja Uprawnie

Na nastpnej stronie mo偶esz sprawdzi, jak **nadu偶ywa uprawnie do przechowywania, aby eskalowa uprawnienia**:

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### Niena uwierzytelniona Enum

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-storage-unauthenticated-enum/" %}
[gcp-storage-unauthenticated-enum](../gcp-unauthenticated-enum-and-access/gcp-storage-unauthenticated-enum/)
{% endcontent-ref %}

### Po Eksploatacji

{% content-ref url="../gcp-post-exploitation/gcp-storage-post-exploitation.md" %}
[gcp-storage-post-exploitation.md](../gcp-post-exploitation/gcp-storage-post-exploitation.md)
{% endcontent-ref %}

### Utrzymywanie

{% content-ref url="../gcp-persistence/gcp-storage-persistence.md" %}
[gcp-storage-persistence.md](../gcp-persistence/gcp-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
