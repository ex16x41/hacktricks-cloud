# GCP - Enumeracja magazynu

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plan subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpniaj sztuczki hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Magazyn

Google Cloud Platform (GCP) Storage to **rozwizanie przechowywania w chmurze**, kt贸re zapewnia bardzo trwae i dostpne przechowywanie obiekt贸w dla danych nieustrukturyzowanych. Oferuje **r贸偶ne klasy przechowywania** oparte na wydajnoci, dostpnoci i kosztach, w tym Standard, Nearline, Coldline i Archive. GCP Storage zapewnia r贸wnie偶 zaawansowane funkcje takie jak **polityki cyklu 偶ycia, wersjonowanie i kontrola dostpu** do efektywnego zarzdzania i zabezpieczania danych.

Wiadro mo偶na przechowywa w regionie, w 2 regionach lub **w wielu regionach (domylnie)**.

### Typy przechowywania

* **Standardowe przechowywanie**: Jest to domylna opcja przechowywania, kt贸ra **zapewnia wysok wydajno i niski dostp o niskim op贸藕nieniu do czsto odwiedzanych danych**. Nadaje si do szerokiego zakresu zastosowa, w tym dostarczania treci na stronie internetowej, przesyania medi贸w strumieniowych i hostowania potok贸w analizy danych.
* **Przechowywanie Nearline**: Ta klasa przechowywania oferuje **ni偶sze koszty przechowywania** i **nieco wy偶sze koszty dostpu** ni偶 Standardowe przechowywanie. Jest zoptymalizowana dla danych rzadko odwiedzanych, z minimalnym czasem przechowywania wynoszcym 30 dni. Nadaje si do cel贸w archiwizacji i tworzenia kopii zapasowych.
* **Przechowywanie Coldline**: Ta klasa przechowywania jest zoptymalizowana dla **dugoterminowego przechowywania rzadko odwiedzanych danych**, z minimalnym czasem przechowywania wynoszcym 90 dni. Oferuje **ni偶sze koszty przechowywania** ni偶 Przechowywanie Nearline, ale z **wy偶szymi kosztami dostpu**.
* **Przechowywanie Archive**: Ta klasa przechowywania jest przeznaczona dla zimnych danych, do kt贸rych dostp jest **bardzo rzadki**, z minimalnym czasem przechowywania wynoszcym 365 dni. Oferuje **najni偶sze koszty przechowywania ze wszystkich opcji przechowywania GCP**, ale z **najwy偶szymi kosztami dostpu**. Nadaje si do dugoterminowego przechowywania danych, kt贸re musz by przechowywane ze wzgld贸w zgodnoci lub regulacyjnych.
* **Autoklasa**: Jeli **nie wiesz, jak czsto bdziesz uzyskiwa dostp** do danych, mo偶esz wybra Autoklas, a GCP **automatycznie zmieni typ przechowywania, aby zminimalizowa koszty**.

### Kontrola dostpu

Domylnie zaleca si kontrolowanie dostpu za pomoc **IAM**, ale mo偶na r贸wnie偶 **wczy korzystanie z list ACL**.\
Jeli wybierzesz korzystanie tylko z IAM (domylnie) i **minie 90 dni**, nie bdziesz m贸g wczy list ACL dla wiadra.

### Wersjonowanie

Mo偶na wczy wersjonowanie, co spowoduje **zachowanie starych wersji plik贸w wewntrz wiadra**. Mo偶na skonfigurowa **liczb wersji, kt贸re chcesz zachowa** oraz nawet **jak dugo** maj **偶y nieaktualne** wersje (stare wersje). Zalecane jest **7 dni dla typu Standard**.

**Metadane nieaktualnej wersji s zachowywane**. Ponadto **listy ACL nieaktualnych wersji s r贸wnie偶 zachowywane**, wic starsze wersje mog mie inne listy ACL ni偶 bie偶ca wersja.

Dowiedz si wicej w [**dokumentacji**](https://cloud.google.com/storage/docs/object-versioning).

### Polityka retencji

Okrel, jak **dugo** chcesz **zakaza usuwania obiekt贸w wewntrz wiadra** (bardzo przydatne przynajmniej do cel贸w zgodnoci).\
Tylko jedno z **wersjonowania lub polityki retencji mo偶e by wczone w tym samym czasie**.

### Szyfrowanie

Domylnie obiekty s **szyfrowane za pomoc zarzdzanych przez Google kluczy**, ale mo偶na r贸wnie偶 u偶y **klucza z KMS**.

### Dostp publiczny

Mo偶liwe jest udostpnienie **zewntrznym u偶ytkownikom** (zalogowanym do GCP lub nie) **dostpu do zawartoci wiadra**.\
Domylnie, gdy wiadro jest tworzone, opcja **publicznego udostpniania wiadra jest wyczona**, ale przy wystarczajcych uprawnieniach mo偶na j zmieni.

**Format URL** do dostpu do wiadra to **`https://storage.googleapis.com/<nazwa-wiadra>` lub `https://<nazwa_wiadra>.storage.googleapis.com`** (oba s poprawne).

### Klucze HMAC

Klucz HMAC to rodzaj _powiadczenia_ i mo偶e by **powizany z kontem usugi lub kontem u偶ytkownika w Cloud Storage**. U偶ywasz klucza HMAC do tworzenia _podpis贸w_, kt贸re s nastpnie doczane do 偶da do Cloud Storage. Podpisy pokazuj, 偶e **dane 偶danie jest autoryzowane przez u偶ytkownika lub konto usugi**.

Klucze HMAC maj dwie podstawowe czci, _ID dostpu_ i _sekret_.

*   **ID dostpu**: Alfanumeryczny cig powizany z okrelon usug lub kontem u偶ytkownika. Gdy jest powizany z kontem usugi, cig ma dugo 61 znak贸w, a gdy jest powizany z kontem u偶ytkownika, cig ma dugo 24 znak贸w. Poni偶ej przedstawiono przykad ID dostpu:

`GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA`
*   **Sekret**: 40-znakowy zakodowany w Base-64 cig, kt贸ry jest powizany z okrelonym ID dostpu. Sekret to klucz uzgodniony wczeniej, kt贸ry znaj tylko ty i Cloud Storage. U偶ywasz swojego sekretu do tworzenia podpis贸w w ramach procesu uwierzytelniania. Poni偶ej przedstawiono przykad sekretu:

`bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ`

Zar贸wno **ID dostpu, jak i sekret jednoznacznie identyfikuj klucz HMAC**, ale sekret jest znacznie bardziej wra偶liw informacj, poniewa偶 jest u偶ywany do **tworzenia podpis贸w**.

### Wyliczanie
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -

# Enumerate HMAC keys
gsutil hmac list

# Get permissions
gcloud storage buckets get-iam-policy gs://bucket-name/
gcloud storage objects get-iam-policy gs://bucket-name/folder/object
```
Jeli otrzymasz bd odmowy uprawnie podczas wywietlania kubek贸w, nadal mo偶esz mie dostp do zawartoci. Teraz, kiedy znasz konwencj nazewnictwa kubek贸w, mo偶esz wygenerowa list mo偶liwych nazw i spr贸bowa uzyska do nich dostp:
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
Z uprawnieniami `storage.objects.list` i `storage.objects.get` powiniene m贸c wyliczy wszystkie foldery i pliki z kubeka, aby je pobra. Mo偶esz to osign za pomoc tego skryptu Pythona:
```python
import requests
import xml.etree.ElementTree as ET

def list_bucket_objects(bucket_name, prefix='', marker=None):
url = f"https://storage.googleapis.com/{bucket_name}?prefix={prefix}"
if marker:
url += f"&marker={marker}"
response = requests.get(url)
xml_data = response.content
root = ET.fromstring(xml_data)
ns = {'ns': 'http://doc.s3.amazonaws.com/2006-03-01'}
for contents in root.findall('.//ns:Contents', namespaces=ns):
key = contents.find('ns:Key', namespaces=ns).text
print(key)
next_marker = root.find('ns:NextMarker', namespaces=ns)
if next_marker is not None:
next_marker_value = next_marker.text
list_bucket_objects(bucket_name, prefix, next_marker_value)

list_bucket_objects('<storage-name>')
```
### Eskalacja uprawnie

Na nastpnej stronie mo偶esz sprawdzi, jak **nadu偶y uprawnienia do przechowywania danych w celu eskalacji uprawnie**:

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### Enumeracja bez uwierzytelnienia

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/" %}
[gcp-storage-unauthenticated-enum](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/)
{% endcontent-ref %}

### Po wykorzystaniu

{% content-ref url="../gcp-post-exploitation/gcp-storage-post-exploitation.md" %}
[gcp-storage-post-exploitation.md](../gcp-post-exploitation/gcp-storage-post-exploitation.md)
{% endcontent-ref %}

### Trwao

{% content-ref url="../gcp-persistence/gcp-storage-persistence.md" %}
[gcp-storage-persistence.md](../gcp-persistence/gcp-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpniaj sztuczki hakerskie, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}
