# GCP - Storage Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage

Google Cloud Platform (GCP) Storage æ˜¯ä¸€ä¸ª **åŸºäºäº‘çš„å­˜å‚¨è§£å†³æ–¹æ¡ˆ**ï¼Œæä¾›é«˜è€ä¹…æ€§å’Œå¯ç”¨æ€§çš„å¯¹è±¡å­˜å‚¨ï¼Œç”¨äºéç»“æ„åŒ–æ•°æ®ã€‚å®ƒæä¾› **å¤šç§å­˜å‚¨ç±»åˆ«**ï¼ŒåŸºäºæ€§èƒ½ã€å¯ç”¨æ€§å’Œæˆæœ¬ï¼ŒåŒ…æ‹¬æ ‡å‡†ã€è¿‘çº¿ã€å†·çº¿å’Œå½’æ¡£ã€‚GCP Storage è¿˜æä¾›é«˜çº§åŠŸèƒ½ï¼Œå¦‚ **ç”Ÿå‘½å‘¨æœŸç­–ç•¥ã€ç‰ˆæœ¬æ§åˆ¶å’Œè®¿é—®æ§åˆ¶**ï¼Œä»¥æœ‰æ•ˆç®¡ç†å’Œä¿æŠ¤æ•°æ®ã€‚

å­˜å‚¨æ¡¶å¯ä»¥å­˜å‚¨åœ¨ä¸€ä¸ªåŒºåŸŸã€ä¸¤ä¸ªåŒºåŸŸæˆ– **å¤šåŒºåŸŸï¼ˆé»˜è®¤ï¼‰**ã€‚

### Storage Types

* **æ ‡å‡†å­˜å‚¨**ï¼šè¿™æ˜¯é»˜è®¤çš„å­˜å‚¨é€‰é¡¹ï¼Œ**æä¾›é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿçš„è®¿é—®é¢‘ç¹è®¿é—®çš„æ•°æ®**ã€‚é€‚ç”¨äºå¹¿æ³›çš„ç”¨ä¾‹ï¼ŒåŒ…æ‹¬æä¾›ç½‘ç«™å†…å®¹ã€æµåª’ä½“å’Œæ‰˜ç®¡æ•°æ®åˆ†æç®¡é“ã€‚
* **è¿‘çº¿å­˜å‚¨**ï¼šæ­¤å­˜å‚¨ç±»åˆ«æä¾› **è¾ƒä½çš„å­˜å‚¨æˆæœ¬** å’Œ **ç•¥é«˜çš„è®¿é—®æˆæœ¬**ï¼Œä¸æ ‡å‡†å­˜å‚¨ç›¸æ¯”ã€‚å®ƒé’ˆå¯¹ä¸å¸¸è®¿é—®çš„æ•°æ®è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæœ€å°å­˜å‚¨æœŸé™ä¸º 30 å¤©ã€‚éå¸¸é€‚åˆå¤‡ä»½å’Œå½’æ¡£ç›®çš„ã€‚
* **å†·çº¿å­˜å‚¨**ï¼šæ­¤å­˜å‚¨ç±»åˆ«é’ˆå¯¹ **é•¿æœŸå­˜å‚¨ä¸å¸¸è®¿é—®çš„æ•°æ®** è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæœ€å°å­˜å‚¨æœŸé™ä¸º 90 å¤©ã€‚å®ƒæä¾› **æ¯”è¿‘çº¿å­˜å‚¨æ›´ä½çš„å­˜å‚¨æˆæœ¬**ï¼Œä½† **è®¿é—®æˆæœ¬æ›´é«˜**ã€‚
* **å½’æ¡£å­˜å‚¨**ï¼šæ­¤å­˜å‚¨ç±»åˆ«ä¸“ä¸º **æå°‘è®¿é—®çš„å†·æ•°æ®** è®¾è®¡ï¼Œæœ€å°å­˜å‚¨æœŸé™ä¸º 365 å¤©ã€‚å®ƒæä¾› **æ‰€æœ‰ GCP å­˜å‚¨é€‰é¡¹ä¸­æœ€ä½çš„å­˜å‚¨æˆæœ¬**ï¼Œä½† **è®¿é—®æˆæœ¬æœ€é«˜**ã€‚é€‚åˆéœ€è¦å› åˆè§„æˆ–ç›‘ç®¡åŸå› é•¿æœŸä¿ç•™çš„æ•°æ®ã€‚
* **è‡ªåŠ¨åˆ†ç±»**ï¼šå¦‚æœæ‚¨ **ä¸çŸ¥é“å°†è®¿é—®å¤šå°‘æ•°æ®**ï¼Œå¯ä»¥é€‰æ‹©è‡ªåŠ¨åˆ†ç±»ï¼ŒGCP å°† **è‡ªåŠ¨ä¸ºæ‚¨æ›´æ”¹å­˜å‚¨ç±»å‹ä»¥æœ€å°åŒ–æˆæœ¬**ã€‚

### Access Control

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**å»ºè®®**é€šè¿‡ **IAM** æ§åˆ¶è®¿é—®ï¼Œä½†ä¹Ÿå¯ä»¥ **å¯ç”¨ ACL çš„ä½¿ç”¨**ã€‚\
å¦‚æœæ‚¨é€‰æ‹©ä»…ä½¿ç”¨ IAMï¼ˆé»˜è®¤ï¼‰ï¼Œå¹¶ä¸” **ç»è¿‡ 90 å¤©**ï¼Œæ‚¨ **å°†æ— æ³•ä¸ºå­˜å‚¨æ¡¶å¯ç”¨ ACL**ã€‚

### Versioning

å¯ä»¥å¯ç”¨ç‰ˆæœ¬æ§åˆ¶ï¼Œè¿™å°† **åœ¨å­˜å‚¨æ¡¶å†…ä¿å­˜æ–‡ä»¶çš„æ—§ç‰ˆæœ¬**ã€‚å¯ä»¥é…ç½® **è¦ä¿ç•™çš„ç‰ˆæœ¬æ•°é‡**ï¼Œç”šè‡³ **éå½“å‰** ç‰ˆæœ¬ï¼ˆæ—§ç‰ˆæœ¬ï¼‰å¸Œæœ›ä¿ç•™çš„ **æ—¶é—´**ã€‚æ¨èçš„ä¿ç•™æ—¶é—´ä¸º **æ ‡å‡†ç±»å‹çš„ 7 å¤©**ã€‚

**éå½“å‰ç‰ˆæœ¬çš„å…ƒæ•°æ®ä¼šè¢«ä¿ç•™**ã€‚æ­¤å¤–ï¼Œ**éå½“å‰ç‰ˆæœ¬çš„ ACL ä¹Ÿä¼šè¢«ä¿ç•™**ï¼Œå› æ­¤æ—§ç‰ˆæœ¬å¯èƒ½ä¸å½“å‰ç‰ˆæœ¬å…·æœ‰ä¸åŒçš„ ACLã€‚

åœ¨ [**docs**](https://cloud.google.com/storage/docs/object-versioning) ä¸­äº†è§£æ›´å¤šä¿¡æ¯ã€‚

### Retention Policy

æŒ‡ç¤ºæ‚¨å¸Œæœ› **ç¦æ­¢åˆ é™¤å­˜å‚¨æ¡¶å†…å¯¹è±¡çš„æ—¶é—´**ï¼ˆè‡³å°‘å¯¹åˆè§„æ€§éå¸¸æœ‰ç”¨ï¼‰ã€‚\
**ç‰ˆæœ¬æ§åˆ¶æˆ–ä¿ç•™ç­–ç•¥åªèƒ½åŒæ—¶å¯ç”¨ä¸€ä¸ª**ã€‚

### Encryption

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹è±¡æ˜¯ **ä½¿ç”¨ Google ç®¡ç†çš„å¯†é’¥åŠ å¯†**ï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ **KMS çš„å¯†é’¥**ã€‚

### Public Access

å¯ä»¥ä¸º **å¤–éƒ¨ç”¨æˆ·**ï¼ˆæ— è®ºæ˜¯å¦ç™»å½• GCPï¼‰æä¾› **è®¿é—®å­˜å‚¨æ¡¶å†…å®¹** çš„æƒé™ã€‚\
é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“åˆ›å»ºå­˜å‚¨æ¡¶æ—¶ï¼Œå®ƒå°† **ç¦ç”¨å…¬å¼€æš´éœ²** å­˜å‚¨æ¡¶çš„é€‰é¡¹ï¼Œä½†åœ¨è¶³å¤Ÿçš„æƒé™ä¸‹å¯ä»¥æ›´æ”¹ã€‚

è®¿é—®å­˜å‚¨æ¡¶çš„ **URL æ ¼å¼** ä¸º **`https://storage.googleapis.com/<bucket-name>` æˆ– `https://<bucket_name>.storage.googleapis.com`**ï¼ˆä¸¤è€…å‡æœ‰æ•ˆï¼‰ã€‚

### HMAC Keys

HMAC å¯†é’¥æ˜¯ä¸€ç§ _å‡­è¯_ï¼Œå¯ä»¥ **ä¸ Cloud Storage ä¸­çš„æœåŠ¡å¸æˆ·æˆ–ç”¨æˆ·å¸æˆ·å…³è”**ã€‚æ‚¨ä½¿ç”¨ HMAC å¯†é’¥åˆ›å»º _ç­¾å_ï¼Œç„¶åå°†å…¶åŒ…å«åœ¨å¯¹ Cloud Storage çš„è¯·æ±‚ä¸­ã€‚ç­¾åè¡¨æ˜ **ç»™å®šè¯·æ±‚å·²è·å¾—ç”¨æˆ·æˆ–æœåŠ¡å¸æˆ·çš„æˆæƒ**ã€‚

HMAC å¯†é’¥æœ‰ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼Œä¸€ä¸ª _è®¿é—® ID_ å’Œä¸€ä¸ª _å¯†é’¥_ã€‚

*   **è®¿é—® ID**ï¼šä¸ç‰¹å®šæœåŠ¡æˆ–ç”¨æˆ·å¸æˆ·å…³è”çš„å­—æ¯æ•°å­—å­—ç¬¦ä¸²ã€‚å½“ä¸æœåŠ¡å¸æˆ·å…³è”æ—¶ï¼Œå­—ç¬¦ä¸²é•¿åº¦ä¸º 61 ä¸ªå­—ç¬¦ï¼›å½“ä¸ç”¨æˆ·å¸æˆ·å…³è”æ—¶ï¼Œå­—ç¬¦ä¸²é•¿åº¦ä¸º 24 ä¸ªå­—ç¬¦ã€‚ä»¥ä¸‹æ˜¯è®¿é—® ID çš„ç¤ºä¾‹ï¼š

`GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA`
*   **å¯†é’¥**ï¼šä¸ç‰¹å®šè®¿é—® ID å…³è”çš„ 40 å­—ç¬¦çš„ Base-64 ç¼–ç å­—ç¬¦ä¸²ã€‚å¯†é’¥æ˜¯ä¸€ä¸ªé¢„å…±äº«å¯†é’¥ï¼Œåªæœ‰æ‚¨å’Œ Cloud Storage çŸ¥é“ã€‚æ‚¨ä½¿ç”¨å¯†é’¥åˆ›å»ºç­¾åï¼Œä½œä¸ºèº«ä»½éªŒè¯è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚ä»¥ä¸‹æ˜¯å¯†é’¥çš„ç¤ºä¾‹ï¼š

`bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ`

**è®¿é—® ID å’Œå¯†é’¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ª HMAC å¯†é’¥**ï¼Œä½†å¯†é’¥æ˜¯æ›´æ•æ„Ÿçš„ä¿¡æ¯ï¼Œå› ä¸ºå®ƒç”¨äº **åˆ›å»ºç­¾å**ã€‚

### Enumeration
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -

# Enumerate HMAC keys
gsutil hmac list

# Get permissions
gcloud storage buckets get-iam-policy gs://bucket-name/
gcloud storage objects get-iam-policy gs://bucket-name/folder/object
```
å¦‚æœæ‚¨åœ¨åˆ—å‡ºå­˜å‚¨æ¡¶æ—¶é‡åˆ°æƒé™è¢«æ‹’ç»é”™è¯¯ï¼Œæ‚¨ä»ç„¶å¯èƒ½å¯ä»¥è®¿é—®å†…å®¹ã€‚å› æ­¤ï¼Œç°åœ¨æ‚¨çŸ¥é“å­˜å‚¨æ¡¶çš„å‘½åçº¦å®šåï¼Œå¯ä»¥ç”Ÿæˆå¯èƒ½åç§°çš„åˆ—è¡¨å¹¶å°è¯•è®¿é—®å®ƒä»¬ï¼š
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
ä½¿ç”¨æƒé™ `storage.objects.list` å’Œ `storage.objects.get`ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿæšä¸¾å­˜å‚¨æ¡¶ä¸­çš„æ‰€æœ‰æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ï¼Œä»¥ä¾¿ä¸‹è½½å®ƒä»¬ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ Python è„šæœ¬å®ç°ï¼š
```python
import requests
import xml.etree.ElementTree as ET

def list_bucket_objects(bucket_name, prefix='', marker=None):
url = f"https://storage.googleapis.com/{bucket_name}?prefix={prefix}"
if marker:
url += f"&marker={marker}"
response = requests.get(url)
xml_data = response.content
root = ET.fromstring(xml_data)
ns = {'ns': 'http://doc.s3.amazonaws.com/2006-03-01'}
for contents in root.findall('.//ns:Contents', namespaces=ns):
key = contents.find('ns:Key', namespaces=ns).text
print(key)
next_marker = root.find('ns:NextMarker', namespaces=ns)
if next_marker is not None:
next_marker_value = next_marker.text
list_bucket_objects(bucket_name, prefix, next_marker_value)

list_bucket_objects('<storage-name>')
```
### æƒé™æå‡

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨å­˜å‚¨æƒé™ä»¥æå‡æƒé™**ï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### æœªç»èº«ä»½éªŒè¯çš„æšä¸¾

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-storage-unauthenticated-enum/" %}
[gcp-storage-unauthenticated-enum](../gcp-unauthenticated-enum-and-access/gcp-storage-unauthenticated-enum/)
{% endcontent-ref %}

### åˆ©ç”¨å

{% content-ref url="../gcp-post-exploitation/gcp-storage-post-exploitation.md" %}
[gcp-storage-post-exploitation.md](../gcp-post-exploitation/gcp-storage-post-exploitation.md)
{% endcontent-ref %}

### æŒä¹…æ€§

{% content-ref url="../gcp-persistence/gcp-storage-persistence.md" %}
[gcp-storage-persistence.md](../gcp-persistence/gcp-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
