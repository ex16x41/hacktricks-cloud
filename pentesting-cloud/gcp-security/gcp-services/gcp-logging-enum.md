# GCP - Logging Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

æ­¤æœåŠ¡å…è®¸ç”¨æˆ·å­˜å‚¨ã€æœç´¢ã€åˆ†æã€ç›‘æ§å’Œè­¦æŠ¥æ¥è‡ª GCP çš„ **æ—¥å¿—æ•°æ®å’Œäº‹ä»¶**ã€‚

Cloud Logging ä¸å…¶ä»– GCP æœåŠ¡å®Œå…¨é›†æˆï¼Œä¸ºæ‰€æœ‰ GCP èµ„æºæä¾›é›†ä¸­å¼æ—¥å¿—å­˜å‚¨åº“ã€‚å®ƒ **è‡ªåŠ¨æ”¶é›†æ¥è‡ªå„ç§ GCP æœåŠ¡çš„æ—¥å¿—**ï¼Œå¦‚ App Engineã€Compute Engine å’Œ Cloud Functionsã€‚æ‚¨è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨ Cloud Logging ä»£ç†æˆ– APIï¼Œå°† Cloud Logging ç”¨äºåœ¨æœ¬åœ°æˆ–å…¶ä»–äº‘ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚

ä¸»è¦ç‰¹ç‚¹ï¼š

* **æ—¥å¿—æ•°æ®é›†ä¸­åŒ–ï¼š** ä»å„ç§æ¥æºèšåˆæ—¥å¿—æ•°æ®ï¼Œæä¾›å¯¹æ‚¨çš„åº”ç”¨ç¨‹åºå’ŒåŸºç¡€è®¾æ–½çš„æ•´ä½“è§†å›¾ã€‚
* **å®æ—¶æ—¥å¿—ç®¡ç†ï¼š** å®æ—¶æµå¼ä¼ è¾“æ—¥å¿—ï¼Œä»¥ä¾¿ç«‹å³åˆ†æå’Œå“åº”ã€‚
* **å¼ºå¤§çš„æ•°æ®åˆ†æï¼š** ä½¿ç”¨é«˜çº§è¿‡æ»¤å’Œæœç´¢åŠŸèƒ½å¿«é€Ÿç­›é€‰å¤§é‡æ—¥å¿—æ•°æ®ã€‚
* **ä¸ BigQuery é›†æˆï¼š** å°†æ—¥å¿—å¯¼å‡ºåˆ° BigQuery è¿›è¡Œè¯¦ç»†åˆ†æå’ŒæŸ¥è¯¢ã€‚
* **åŸºäºæ—¥å¿—çš„æŒ‡æ ‡ï¼š** ä»æ‚¨çš„æ—¥å¿—æ•°æ®ä¸­åˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡ä»¥è¿›è¡Œç›‘æ§å’Œè­¦æŠ¥ã€‚

### æ—¥å¿—æµ

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

åŸºæœ¬ä¸Šï¼Œæ¥æ”¶å™¨å’ŒåŸºäºæ—¥å¿—çš„æŒ‡æ ‡å°†å†³å®šæ—¥å¿—åº”è¯¥å­˜å‚¨åœ¨å“ªé‡Œã€‚

### GCP Logging æ”¯æŒçš„é…ç½®

Cloud Logging é«˜åº¦å¯é…ç½®ï¼Œä»¥æ»¡è¶³å¤šæ ·åŒ–çš„æ“ä½œéœ€æ±‚ï¼š

1. **æ—¥å¿—æ¡¶ï¼ˆWeb ä¸­çš„æ—¥å¿—å­˜å‚¨ï¼‰ï¼š** åœ¨ Cloud Logging ä¸­å®šä¹‰æ¡¶ä»¥ç®¡ç† **æ—¥å¿—ä¿ç•™**ï¼Œæä¾›å¯¹æ—¥å¿—æ¡ç›®ä¿ç•™æ—¶é—´çš„æ§åˆ¶ã€‚
* é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ›å»ºäº†æ¡¶ `_Default` å’Œ `_Required`ï¼ˆä¸€ä¸ªè®°å½•çš„å†…å®¹ä¸å¦ä¸€ä¸ªä¸åŒï¼‰ã€‚
* **\_Required** æ˜¯ï¼š

{% code overflow="wrap" %}
````
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```

````
{% endcode %}

* æ•°æ®çš„**ä¿ç•™æœŸé™**æ˜¯æŒ‰å­˜å‚¨æ¡¶é…ç½®çš„ï¼Œå¿…é¡»**è‡³å°‘ä¸º1å¤©ã€‚**ç„¶è€Œï¼Œ**\_Requiredçš„ä¿ç•™æœŸé™ä¸º400å¤©**ï¼Œä¸”æ— æ³•ä¿®æ”¹ã€‚
* è¯·æ³¨æ„ï¼Œæ—¥å¿—å­˜å‚¨æ¡¶åœ¨**Cloud Storageä¸­ä¸å¯è§ã€‚**

2. **æ—¥å¿—æ¥æ”¶å™¨ï¼ˆWebä¸­çš„æ—¥å¿—è·¯ç”±å™¨ï¼‰ï¼š** åˆ›å»ºæ¥æ”¶å™¨ä»¥**å°†æ—¥å¿—æ¡ç›®å¯¼å‡º**åˆ°å„ç§ç›®çš„åœ°ï¼Œå¦‚Pub/Subã€BigQueryæˆ–Cloud Storageï¼ŒåŸºäº**è¿‡æ»¤å™¨**ã€‚
* é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºå­˜å‚¨æ¡¶`_Default`å’Œ`_Required`åˆ›å»ºæ¥æ”¶å™¨ï¼š
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **æ’é™¤è¿‡æ»¤å™¨ï¼š** å¯ä»¥è®¾ç½®**æ’é™¤é¡¹ä»¥é˜²æ­¢ç‰¹å®šæ—¥å¿—æ¡ç›®**è¢«æ‘„å–ï¼Œä»è€ŒèŠ‚çœæˆæœ¬å¹¶å‡å°‘ä¸å¿…è¦çš„å™ªéŸ³ã€‚
3. **åŸºäºæ—¥å¿—çš„æŒ‡æ ‡ï¼š** æ ¹æ®æ—¥å¿—å†…å®¹é…ç½®**è‡ªå®šä¹‰æŒ‡æ ‡**ï¼Œå…è®¸åŸºäºæ—¥å¿—æ•°æ®è¿›è¡Œè­¦æŠ¥å’Œç›‘æ§ã€‚
4. **æ—¥å¿—è§†å›¾ï¼š** æ—¥å¿—è§†å›¾æä¾›äº†å¯¹è°å¯ä»¥è®¿é—®æ—¥å¿—çš„é«˜çº§å’Œ**ç»†ç²’åº¦æ§åˆ¶**ã€‚
* Cloud Logging**è‡ªåŠ¨ä¸ºæ¯ä¸ªå­˜å‚¨æ¡¶åˆ›å»º`_AllLogs`è§†å›¾**ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—ã€‚Cloud Loggingè¿˜ä¸º`_Default`å­˜å‚¨æ¡¶åˆ›å»ºäº†ä¸€ä¸ªåä¸º`_Default`çš„è§†å›¾ã€‚`_Default`å­˜å‚¨æ¡¶çš„`_Default`è§†å›¾æ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—ï¼Œé™¤äº†æ•°æ®è®¿é—®å®¡è®¡æ—¥å¿—ã€‚`_AllLogs`å’Œ`_Default`è§†å›¾ä¸å¯ç¼–è¾‘ã€‚

å¯ä»¥é€šè¿‡IAMç­–ç•¥å…è®¸ä¸»ä½“**ä»…ä½¿ç”¨ç‰¹å®šçš„æ—¥å¿—è§†å›¾**ï¼Œä¾‹å¦‚ï¼š 

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### é»˜è®¤æ—¥å¿—

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**Admin Write** æ“ä½œï¼ˆä¹Ÿç§°ä¸º Admin Activity å®¡è®¡æ—¥å¿—ï¼‰æ˜¯è¢«è®°å½•çš„ï¼ˆå†™å…¥å…ƒæ•°æ®æˆ–é…ç½®ä¿¡æ¯ï¼‰ï¼Œå¹¶ä¸”**æ— æ³•ç¦ç”¨**ã€‚

ç„¶åï¼Œç”¨æˆ·å¯ä»¥å¯ç”¨ **Data Access å®¡è®¡æ—¥å¿—**ï¼Œè¿™äº›åŒ…æ‹¬ **Admin Readã€Data Write å’Œ Data Write**ã€‚

æ‚¨å¯ä»¥åœ¨æ–‡æ¡£ä¸­æ‰¾åˆ°æœ‰å…³æ¯ç§æ—¥å¿—ç±»å‹çš„æ›´å¤šä¿¡æ¯ï¼š[https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

ç„¶è€Œï¼Œè¯·æ³¨æ„ï¼Œè¿™æ„å‘³ç€é»˜è®¤æƒ…å†µä¸‹ï¼Œ**`GetIamPolicy`** æ“ä½œå’Œå…¶ä»–è¯»å–æ“ä½œæ˜¯**æœªè¢«è®°å½•**çš„ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœç³»ç»Ÿç®¡ç†å‘˜æ²¡æœ‰é…ç½®ç”Ÿæˆæ›´å¤šæ—¥å¿—ï¼Œè¯•å›¾æšä¸¾ç¯å¢ƒçš„æ”»å‡»è€…å°†ä¸ä¼šè¢«æ•è·ã€‚

è¦åœ¨æ§åˆ¶å°ä¸­å¯ç”¨æ›´å¤šæ—¥å¿—ï¼Œç³»ç»Ÿç®¡ç†å‘˜éœ€è¦è®¿é—® [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) å¹¶å¯ç”¨å®ƒä»¬ã€‚æœ‰ä¸¤ç§ä¸åŒçš„é€‰é¡¹ï¼š

* **é»˜è®¤é…ç½®**ï¼šå¯ä»¥åˆ›å»ºä¸€ä¸ªé»˜è®¤é…ç½®ï¼Œè®°å½•æ‰€æœ‰ Admin Read å’Œ/æˆ– Data Read å’Œ/æˆ– Data Write æ—¥å¿—ï¼Œç”šè‡³æ·»åŠ è±å…ä¸»ä½“ï¼š

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **é€‰æ‹©æœåŠ¡**ï¼šæˆ–è€…ä»…ä»…**é€‰æ‹©æ‚¨å¸Œæœ›ç”Ÿæˆæ—¥å¿—çš„æœåŠ¡**ä»¥åŠè¯¥ç‰¹å®šæœåŠ¡çš„æ—¥å¿—ç±»å‹å’Œè±å…ä¸»ä½“ã€‚

è¿˜è¯·æ³¨æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹ä»…ç”Ÿæˆè¿™äº›æ—¥å¿—ï¼Œå› ä¸ºç”Ÿæˆæ›´å¤šæ—¥å¿—ä¼šå¢åŠ æˆæœ¬ã€‚

### æšä¸¾

`gcloud` å‘½ä»¤è¡Œå·¥å…·æ˜¯ GCP ç”Ÿæ€ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå…è®¸æ‚¨ç®¡ç†èµ„æºå’ŒæœåŠ¡ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ `gcloud` ç®¡ç†æ‚¨çš„æ—¥å¿—é…ç½®å’Œè®¿é—®æ—¥å¿—ã€‚ 

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

æ£€æŸ¥ **`cloudresourcemanager`**ï¼ˆç”¨äºæš´åŠ›ç ´è§£æƒé™çš„é‚£ä¸ªï¼‰çš„æ—¥å¿—ç¤ºä¾‹ï¼š[https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

æ²¡æœ‰ **`testIamPermissions`** çš„æ—¥å¿—ï¼š

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### åæœŸåˆ©ç”¨

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### æŒä¹…æ€§

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
