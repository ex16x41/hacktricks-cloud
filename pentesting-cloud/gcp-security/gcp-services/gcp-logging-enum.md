# GCP - Logging Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informaci√≥n B√°sica

Este servicio permite a los usuarios almacenar, buscar, analizar, monitorear y alertar sobre **datos y eventos de registro** de GCP.

Cloud Logging est√° completamente integrado con otros servicios de GCP, proporcionando un repositorio centralizado para los registros de todos tus recursos de GCP. **Recopila autom√°ticamente registros de varios servicios de GCP** como App Engine, Compute Engine y Cloud Functions. Tambi√©n puedes usar Cloud Logging para aplicaciones que se ejecutan en las instalaciones o en otras nubes utilizando el agente o API de Cloud Logging.

Caracter√≠sticas Clave:

* **Centralizaci√≥n de Datos de Registro:** Agrega datos de registro de diversas fuentes, ofreciendo una vista hol√≠stica de tus aplicaciones e infraestructura.
* **Gesti√≥n de Registros en Tiempo Real:** Transmite registros en tiempo real para an√°lisis y respuesta inmediata.
* **An√°lisis de Datos Potente:** Utiliza capacidades avanzadas de filtrado y b√∫squeda para filtrar r√°pidamente grandes vol√∫menes de datos de registro.
* **Integraci√≥n con BigQuery:** Exporta registros a BigQuery para an√°lisis y consultas detalladas.
* **M√©tricas Basadas en Registros:** Crea m√©tricas personalizadas a partir de tus datos de registro para monitoreo y alertas.

### Flujo de Registros

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

B√°sicamente, los sinks y las m√©tricas basadas en registros determinar√°n d√≥nde se debe almacenar un registro.

### Configuraciones Soportadas por GCP Logging

Cloud Logging es altamente configurable para adaptarse a diversas necesidades operativas:

1. **Buckets de Registro (Almacenamiento de registros en la web):** Define buckets en Cloud Logging para gestionar **la retenci√≥n de registros**, proporcionando control sobre cu√°nto tiempo se retienen tus entradas de registro.
* Por defecto, se crean los buckets `_Default` y `_Required` (uno registra lo que el otro no).
* **\_Required** es:

{% code overflow="wrap" %}
````
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```

````
{% endcode %}

* **El per√≠odo de retenci√≥n** de los datos se configura por bucket y debe ser **de al menos 1 d√≠a.** Sin embargo, el **per√≠odo de retenci√≥n de \_Required es de 400 d√≠as** y no se puede modificar.
* Tenga en cuenta que los Log Buckets **no son visibles en Cloud Storage.**

2. **Log Sinks (Enrutador de logs en la web):** Cree sinks para **exportar entradas de logs** a varios destinos como Pub/Sub, BigQuery o Cloud Storage seg√∫n un **filtro**.
* Por **defecto**, se crean sinks para los buckets `_Default` y `_Required`:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Filtros de Exclusi√≥n:** Es posible configurar **exclusiones para evitar que entradas de logs espec√≠ficas** sean ingeridas, ahorrando costos y reduciendo ruido innecesario.
3. **M√©tricas basadas en logs:** Configure **m√©tricas personalizadas** basadas en el contenido de los logs, lo que permite alertas y monitoreo basado en datos de logs.
4. **Vistas de logs:** Las vistas de logs ofrecen un control avanzado y **granular sobre qui√©n tiene acceso** a los logs dentro de sus buckets de logs.
* Cloud Logging **crea autom√°ticamente la vista `_AllLogs` para cada bucket**, que muestra todos los logs. Cloud Logging tambi√©n crea una vista para el bucket `_Default` llamada `_Default`. La vista `_Default` para el bucket `_Default` muestra todos los logs excepto los logs de auditor√≠a de acceso a datos. Las vistas `_AllLogs` y `_Default` no son editables.

Es posible permitir que un principal **solo use una vista de Log espec√≠fica** con una pol√≠tica IAM como:

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### Registros Predeterminados

Por defecto, las operaciones de **Admin Write** (tambi√©n llamadas registros de auditor√≠a de actividad de administrador) son las que se registran (escribir metadatos o informaci√≥n de configuraci√≥n) y **no se pueden desactivar**.

Luego, el usuario puede habilitar los **registros de auditor√≠a de acceso a datos**, que son **Admin Read, Data Write y Data Write**.

Puedes encontrar m√°s informaci√≥n sobre cada tipo de registro en la documentaci√≥n: [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

Sin embargo, ten en cuenta que esto significa que, por defecto, las acciones **`GetIamPolicy`** y otras acciones de lectura **no est√°n siendo registradas**. Por lo tanto, por defecto, un atacante que intente enumerar el entorno no ser√° detectado si el administrador del sistema no configur√≥ la generaci√≥n de m√°s registros.

Para habilitar m√°s registros en la consola, el administrador del sistema necesita ir a [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) y habilitarlos. Hay 2 opciones diferentes:

* **Configuraci√≥n Predeterminada**: Es posible crear una configuraci√≥n predeterminada y registrar todos los registros de Admin Read y/o Data Read y/o Data Write e incluso agregar principios exentos:

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **Seleccionar los servicios**: O simplemente **seleccionar los servicios** para los que te gustar√≠a generar registros y el tipo de registros y el principio exento para ese servicio espec√≠fico.

Tambi√©n ten en cuenta que, por defecto, solo se est√°n generando esos registros porque generar m√°s registros aumentar√° los costos.

### Enumeraci√≥n

La herramienta de l√≠nea de comandos `gcloud` es una parte integral del ecosistema de GCP, permiti√©ndote gestionar tus recursos y servicios. Aqu√≠ te mostramos c√≥mo puedes usar `gcloud` para gestionar tus configuraciones de registro y acceder a los registros. 

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Ejemplo para verificar los registros de **`cloudresourcemanager`** (el que se usa para BF permissions): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

No hay registros de **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Post Explotaci√≥n

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**repos de HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
