# GCP - Enumeracija logova

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim StruÄnjak (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim StruÄnjak (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

Ova usluga omoguÄ‡ava korisnicima da skladiÅ¡te, pretraÅ¾uju, analiziraju, nadgledaju i Å¡alju upozorenja o **podacima dnevnika i dogaÄ‘ajima** sa GCP-a.

Cloud Logging je potpuno integrisan sa drugim GCP uslugama, pruÅ¾ajuÄ‡i centralizovano skladiÅ¡te za dnevnike sa svih vaÅ¡ih GCP resursa. On **automatski prikuplja dnevnike iz razliÄitih GCP usluga** poput App Engine-a, Compute Engine-a i Cloud Functions-a. TakoÄ‘e moÅ¾ete koristiti Cloud Logging za aplikacije koje se izvrÅ¡avaju lokalno ili na drugim oblakama koristeÄ‡i Cloud Logging agenta ili API.

KljuÄne funkcije:

* **Centralizacija podataka dnevnika:** Agregirajte podatke dnevnika sa razliÄitih izvora, nudeÄ‡i holistiÄki prikaz vaÅ¡ih aplikacija i infrastrukture.
* **Upravljanje dnevnicima u realnom vremenu:** Strimujte dnevnike u realnom vremenu radi odmahÅ¡nje analize i reakcije.
* **MoÄ‡na analiza podataka:** Koristite napredne moguÄ‡nosti filtriranja i pretrage za brzo pretraÅ¾ivanje velikih koliÄina podataka dnevnika.
* **Integracija sa BigQuery-om:** Izvozite dnevnike u BigQuery radi detaljne analize i upita.
* **Metrike zasnovane na dnevnicima:** Kreirajte prilagoÄ‘ene metrike iz vaÅ¡ih podataka dnevnika za praÄ‡enje i slanje upozorenja.

### Tok dnevnika

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

U osnovi, slivnici i metrike zasnovane na dnevnicima Ä‡e odrediti gde Ä‡e se dnevnik skladiÅ¡titi.

### Konfiguracije podrÅ¾ane od strane GCP Logging-a

Cloud Logging je visoko konfigurabilan kako bi odgovarao razliÄitim operativnim potrebama:

1. **Spremnici dnevnika (SkladiÅ¡tenje dnevnika na vebu):** DefiniÅ¡ite spremnike u Cloud Logging-u za upravljanje **zadrÅ¾avanjem dnevnika**, pruÅ¾ajuÄ‡i kontrolu nad tim koliko dugo se vaÅ¡i unosi dnevnika zadrÅ¾avaju.
* Podrazumevano su kreirani spremnici `_Default` i `_Required` (jedan beleÅ¾i ono Å¡to drugi ne beleÅ¾i).
*   **\_Required** je:

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* **Period zadrÅ¾avanja** podataka je konfigurisan po spremniku i mora biti **najmanje 1 dan.** MeÄ‘utim, **period zadrÅ¾avanja za \_Required je 400 dana** i ne moÅ¾e se menjati.
* Imajte na umu da spremnici dnevnika **nisu vidljivi u Cloud Storage-u.**
2. **Slivnici dnevnika (Rutiranje dnevnika na vebu):** Kreirajte slivnike za **izvoz unosa dnevnika** ka razliÄitim odrediÅ¡tima poput Pub/Sub-a, BigQuery-a ili Cloud Storage-a na osnovu **filtara**.
* Podrazumevano su kreirani slivnici za spremnike `_Default` i `_Required`:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Filteri iskljuÄenja:** MoguÄ‡e je postaviti **iskljuÄenja kako bi se spreÄilo da odreÄ‘eni unosi dnevnika** budu uneti, Äime se Å¡tedi troÅ¡ak i smanjuje nepotrebna buka.
3. **Metrike zasnovane na dnevnicima:** KonfiguriÅ¡ite **prilagoÄ‘ene metrike** na osnovu sadrÅ¾aja dnevnika, omoguÄ‡avajuÄ‡i upozorenja i praÄ‡enje na osnovu podataka dnevnika.
4. **Prikazi dnevnika:** Prikazi dnevnika pruÅ¾aju naprednu i **graniÄnu kontrolu nad tim ko ima pristup** dnevnicima unutar vaÅ¡ih spremnika dnevnika.&#x20;
* Cloud Logging **automatski kreira pogled `_AllLogs` za svaki spremnik**, koji prikazuje sve dnevnike. Cloud Logging takoÄ‘e kreira pogled za spremnik `_Default` nazvan `_Default`. Pogled `_Default` za spremnik `_Default` prikazuje sve dnevnike osim dnevnika za pristup podacima. Pogledi `_AllLogs` i `_Default` nisu izmenjivi.

MoguÄ‡e je dozvoliti principalu **samo koriÅ¡Ä‡enje odreÄ‘enog Prikaza dnevnika** sa IAM politikom poput:

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### Podrazumevani zapisi

Podrazumevano su operacije **Admin Write** (takoÄ‘e nazvane Admin Activity audit logs) one koje se beleÅ¾e (upisivanje metapodataka ili informacija o konfiguraciji) i **ne mogu biti onemoguÄ‡ene**.

Zatim, korisnik moÅ¾e omoguÄ‡iti **Data Access audit logs**, koji obuhvataju **Admin Read, Data Write i Data Write**.

ViÅ¡e informacija o svakom tipu zapisa moÅ¾ete pronaÄ‡i u dokumentaciji: [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

MeÄ‘utim, imajte na umu da to znaÄi da podrazumevano **`GetIamPolicy`** akcije i ostale akcije Äitanja **nisu beleÅ¾ene**. Dakle, podrazumevano napadaÄ koji pokuÅ¡ava da enumeriÅ¡e okruÅ¾enje neÄ‡e biti uhvaÄ‡en ako sistem administrator nije konfigurisao generisanje viÅ¡e zapisa.

Da biste omoguÄ‡ili viÅ¡e zapisa u konzoli, sistem administrator treba da ode na [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) i omoguÄ‡i ih. Postoje 2 razliÄite opcije:

* **Podrazumevana konfiguracija**: MoguÄ‡e je kreirati podrazumevanu konfiguraciju i beleÅ¾iti sve Admin Read i/ili Data Read i/ili Data Write zapise, Äak i dodati izuzete principe:

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **Izaberite usluge**: Ili jednostavno **izaberite usluge** za koje Å¾elite da generiÅ¡ete zapise i tip zapisa i izuzetog principala za tu odreÄ‘enu uslugu.

TakoÄ‘e imajte na umu da se podrazumevano generiÅ¡u samo ti zapisi jer generisanje viÅ¡e zapisa poveÄ‡ava troÅ¡kove.

### Enumeracija

Alat `gcloud` za komandnu liniju je integralni deo GCP ekosistema, omoguÄ‡avajuÄ‡i vam upravljanje resursima i uslugama. Evo kako moÅ¾ete koristiti `gcloud` za upravljanje vaÅ¡im konfiguracijama beleÅ¾enja i pristupom zapisima.

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Primer za proveru zapisa **`cloudresourcemanager`** (onaj koji se koristi za BF dozvole): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

Nema zapisa za **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Post Eksploatacija

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Upornost

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## Reference

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili **telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
