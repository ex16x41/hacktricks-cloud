# GCP - Logging Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Grundinformationen

Dieser Dienst erm√∂glicht es Benutzern, **Protokolldaten und Ereignisse** von GCP zu speichern, zu durchsuchen, zu analysieren, zu √ºberwachen und Alarme auszul√∂sen.

Cloud Logging ist vollst√§ndig in andere GCP-Dienste integriert und bietet ein zentrales Repository f√ºr Protokolle aller Ihrer GCP-Ressourcen. Es **sammelt automatisch Protokolle von verschiedenen GCP-Diensten** wie App Engine, Compute Engine und Cloud Functions. Sie k√∂nnen Cloud Logging auch f√ºr Anwendungen verwenden, die lokal oder in anderen Clouds ausgef√ºhrt werden, indem Sie den Cloud Logging-Agenten oder die API verwenden.

Hauptmerkmale:

* **Zentralisierung von Protokolldaten:** Aggregieren Sie Protokolldaten aus verschiedenen Quellen, um einen ganzheitlichen √úberblick √ºber Ihre Anwendungen und Infrastruktur zu erhalten.
* **Echtzeit-Protokollverwaltung:** Streamen Sie Protokolle in Echtzeit f√ºr sofortige Analyse und Reaktion.
* **Leistungsstarke Datenanalyse:** Verwenden Sie erweiterte Filter- und Suchfunktionen, um gro√üe Mengen an Protokolldaten schnell zu durchsuchen.
* **Integration mit BigQuery:** Exportieren Sie Protokolle nach BigQuery f√ºr detaillierte Analysen und Abfragen.
* **Protokollbasierte Metriken:** Erstellen Sie benutzerdefinierte Metriken aus Ihren Protokolldaten zur √úberwachung und Alarmierung.

### Protokollfluss

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

Im Grunde genommen bestimmen die Senken und protokollbasierten Metriken, wo ein Protokoll gespeichert werden sollte.

### Von GCP Logging unterst√ºtzte Konfigurationen

Cloud Logging ist hochgradig konfigurierbar, um unterschiedlichen Betriebsbed√ºrfnissen gerecht zu werden:

1. **Protokoll-Buckets (Protokollspeicherung im Web):** Definieren Sie Buckets in Cloud Logging, um **Protokollaufbewahrung** zu verwalten und Kontrolle dar√ºber zu haben, wie lange Ihre Protokolleintr√§ge aufbewahrt werden.
* Standardm√§√üig werden die Buckets `_Default` und `_Required` erstellt (einer protokolliert, was der andere nicht tut).
* **\_Required** ist:

{% code overflow="wrap" %}
````
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```

````
{% endcode %}

* **Aufbewahrungsfrist** der Daten ist pro Bucket konfiguriert und muss **mindestens 1 Tag** betragen. Die **Aufbewahrungsfrist von \_Required betr√§gt 400 Tage** und kann nicht ge√§ndert werden.
* Beachten Sie, dass Log Buckets **nicht in Cloud Storage sichtbar sind.**

2. **Log Sinks (Log-Router im Web):** Erstellen Sie Sinks, um **Logeintr√§ge** an verschiedene Ziele wie Pub/Sub, BigQuery oder Cloud Storage basierend auf einem **Filter** zu exportieren.
* Standardm√§√üig werden Sinks f√ºr die Buckets `_Default` und `_Required` erstellt:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Ausschlussfilter:** Es ist m√∂glich, **Ausschl√ºsse einzurichten, um spezifische Logeintr√§ge** von der Erfassung auszuschlie√üen, um Kosten zu sparen und unn√∂tigen L√§rm zu reduzieren.
3. **Log-basierte Metriken:** Konfigurieren Sie **benutzerdefinierte Metriken** basierend auf dem Inhalt der Logs, die Alarmierung und √úberwachung basierend auf Logdaten erm√∂glichen.
4. **Logansichten:** Logansichten bieten eine erweiterte und **detaillierte Kontrolle dar√ºber, wer Zugriff** auf die Logs innerhalb Ihrer Log Buckets hat.
* Cloud Logging **erstellt automatisch die `_AllLogs`-Ansicht f√ºr jeden Bucket**, die alle Logs anzeigt. Cloud Logging erstellt auch eine Ansicht f√ºr den `_Default`-Bucket namens `_Default`. Die `_Default`-Ansicht f√ºr den `_Default`-Bucket zeigt alle Logs au√üer den Data Access Audit-Logs. Die Ansichten `_AllLogs` und `_Default` sind nicht bearbeitbar.

Es ist m√∂glich, einem Principal **nur die Verwendung einer bestimmten Logansicht** mit einer IAM-Richtlinie zu erlauben: 

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### Standardprotokolle

Standardm√§√üig werden **Admin Write**-Operationen (auch als Admin Activity-Auditprotokolle bezeichnet) protokolliert (Metadaten oder Konfigurationsinformationen schreiben) und **k√∂nnen nicht deaktiviert** werden.

Der Benutzer kann dann **Data Access-Auditprotokolle** aktivieren, dies sind **Admin Read, Data Write und Data Write**.

Weitere Informationen zu jedem Protokolltyp finden Sie in den Dokumenten: [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

Beachten Sie jedoch, dass dies bedeutet, dass standardm√§√üig **`GetIamPolicy`**-Aktionen und andere Leseaktionen **nicht protokolliert** werden. Ein Angreifer, der versucht, die Umgebung zu enumerieren, wird also standardm√§√üig nicht erfasst, wenn der Systemadministrator nicht konfiguriert hat, um mehr Protokolle zu generieren.

Um mehr Protokolle in der Konsole zu aktivieren, muss der Systemadministrator zu [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) gehen und sie aktivieren. Es gibt 2 verschiedene Optionen:

* **Standardkonfiguration**: Es ist m√∂glich, eine Standardkonfiguration zu erstellen und alle Admin Read- und/oder Data Read- und/oder Data Write-Protokolle zu protokollieren und sogar befreite Prinzipale hinzuzuf√ºgen:

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **W√§hlen Sie die Dienste aus**: Oder einfach **die Dienste ausw√§hlen**, f√ºr die Sie Protokolle generieren m√∂chten, sowie die Art der Protokolle und den befreiten Prinzipal f√ºr diesen speziellen Dienst.

Beachten Sie auch, dass standardm√§√üig nur diese Protokolle generiert werden, da die Generierung weiterer Protokolle die Kosten erh√∂hen w√ºrde.

### Enumeration

Das `gcloud`-Befehlszeilenwerkzeug ist ein integraler Bestandteil des GCP-√ñkosystems und erm√∂glicht es Ihnen, Ihre Ressourcen und Dienste zu verwalten. So k√∂nnen Sie `gcloud` verwenden, um Ihre Protokollkonfigurationen und Zugriffsprotokolle zu verwalten.

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Beispiel, um die Protokolle von **`cloudresourcemanager`** (dem, der verwendet wird, um Berechtigungen zu BF): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

Es gibt keine Protokolle von **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Post-Exploitation

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Persistenz

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## Referenzen

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
