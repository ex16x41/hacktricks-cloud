# GCP - Logging Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Αυτή η υπηρεσία επιτρέπει στους χρήστες να αποθηκεύουν, αναζητούν, αναλύουν, παρακολουθούν και ειδοποιούν για **δεδομένα και γεγονότα καταγραφής** από το GCP.

Το Cloud Logging είναι πλήρως ενσωματωμένο με άλλες υπηρεσίες GCP, παρέχοντας μια κεντρική αποθήκη για τα αρχεία καταγραφής από όλους τους πόρους GCP σας. **Συλλέγει αυτόματα αρχεία καταγραφής από διάφορες υπηρεσίες GCP** όπως το App Engine, το Compute Engine και το Cloud Functions. Μπορείτε επίσης να χρησιμοποιήσετε το Cloud Logging για εφαρμογές που εκτελούνται τοπικά ή σε άλλες υποδομές cloud χρησιμοποιώντας τον πράκτορα Cloud Logging ή το API.

Key Features:

* **Κεντρικοποίηση Δεδομένων Καταγραφής:** Συγκεντρώστε δεδομένα καταγραφής από διάφορες πηγές, προσφέροντας μια ολιστική εικόνα των εφαρμογών και της υποδομής σας.
* **Διαχείριση Καταγραφών σε Πραγματικό Χρόνο:** Ροή καταγραφών σε πραγματικό χρόνο για άμεση ανάλυση και αντίδραση.
* **Δυνατή Ανάλυση Δεδομένων:** Χρησιμοποιήστε προηγμένες δυνατότητες φιλτραρίσματος και αναζήτησης για να διαχωρίσετε μεγάλες ποσότητες δεδομένων καταγραφής γρήγορα.
* **Ενσωμάτωση με BigQuery:** Εξάγετε αρχεία καταγραφής στο BigQuery για λεπτομερή ανάλυση και ερωτήματα.
* **Μετρικές Βασισμένες σε Καταγραφές:** Δημιουργήστε προσαρμοσμένες μετρικές από τα δεδομένα καταγραφής σας για παρακολούθηση και ειδοποίηση.

### Logs flow

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

Βασικά, οι υποδοχές και οι μετρικές βασισμένες σε καταγραφές θα καθορίσουν πού θα αποθηκευτεί μια καταγραφή.

### Configurations Supported by GCP Logging

Το Cloud Logging είναι πολύ παραμετροποιήσιμο για να καλύψει τις διάφορες επιχειρησιακές ανάγκες:

1. **Log Buckets (Αποθήκευση καταγραφών στο διαδίκτυο):** Ορίστε υποδοχές στο Cloud Logging για να διαχειριστείτε **τη διατήρηση καταγραφών**, παρέχοντας έλεγχο σχετικά με το πόσο καιρό διατηρούνται οι καταχωρίσεις καταγραφής σας.
* Από προεπιλογή, οι υποδοχές `_Default` και `_Required` δημιουργούνται (μία καταγράφει ό,τι δεν καταγράφει η άλλη).
* **\_Required** είναι: 

{% code overflow="wrap" %}
````
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```

````
{% endcode %}

* **Η περίοδος διατήρησης** των δεδομένων ρυθμίζεται ανά κάδο και πρέπει να είναι **τουλάχιστον 1 ημέρα.** Ωστόσο, η **περίοδος διατήρησης του \_Required είναι 400 ημέρες** και δεν μπορεί να τροποποιηθεί.
* Σημειώστε ότι οι Log Buckets είναι **μη ορατοί στο Cloud Storage.**

2. **Log Sinks (Log router στο διαδίκτυο):** Δημιουργήστε sinks για **να εξάγετε καταχωρήσεις καταγραφής** σε διάφορους προορισμούς όπως Pub/Sub, BigQuery ή Cloud Storage με βάση ένα **φίλτρο**.
* Από **προεπιλογή** δημιουργούνται sinks για τους κάδους `_Default` και `_Required`:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Φίλτρα Εξαίρεσης:** Είναι δυνατή η ρύθμιση **εξαιρέσεων για να αποτρέψετε συγκεκριμένες καταχωρήσεις καταγραφής** από το να εισαχθούν, εξοικονομώντας κόστος και μειώνοντας τον περιττό θόρυβο.
3. **Μετρικές βάσει καταγραφής:** Ρυθμίστε **προσαρμοσμένες μετρικές** με βάση το περιεχόμενο των καταγραφών, επιτρέποντας την ειδοποίηση και την παρακολούθηση με βάση τα δεδομένα καταγραφής.
4. **Αναγνώσεις καταγραφής:** Οι αναγνώσεις καταγραφής παρέχουν προηγμένο και **λεπτομερή έλεγχο σχετικά με το ποιος έχει πρόσβαση** στις καταγραφές εντός των κάδων καταγραφής σας.
* Το Cloud Logging **δημιουργεί αυτόματα την αναγνώριση `_AllLogs` για κάθε κάδο**, η οποία δείχνει όλες τις καταγραφές. Το Cloud Logging δημιουργεί επίσης μια αναγνώριση για τον κάδο `_Default` που ονομάζεται `_Default`. Η αναγνώριση `_Default` για τον κάδο `_Default` δείχνει όλες τις καταγραφές εκτός από τις καταγραφές ελέγχου πρόσβασης δεδομένων. Οι αναγνώσεις `_AllLogs` και `_Default` δεν είναι επεξεργάσιμες.

Είναι δυνατή η παροχή δικαιώματος σε έναν κύριο **μόνο για να χρησιμοποιήσει μια συγκεκριμένη αναγνώριση καταγραφής** με μια πολιτική IAM όπως:

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### Προεπιλεγμένα Καταγραφές

Από προεπιλογή, οι **Δραστηριότητες Γραφείου Διαχείρισης** (γνωστές και ως καταγραφές ελέγχου δραστηριότητας διαχείρισης) είναι αυτές που καταγράφονται (γράφουν μεταδεδομένα ή πληροφορίες διαμόρφωσης) και **δεν μπορούν να απενεργοποιηθούν**.

Στη συνέχεια, ο χρήστης μπορεί να ενεργοποιήσει τις **καταγραφές ελέγχου πρόσβασης δεδομένων**, οι οποίες είναι **Διαβάστε Δραστηριότητες Διαχείρισης, Γράψτε Δεδομένα και Γράψτε Δεδομένα**.

Μπορείτε να βρείτε περισσότερες πληροφορίες για κάθε τύπο καταγραφής στα έγγραφα: [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

Ωστόσο, σημειώστε ότι αυτό σημαίνει ότι από προεπιλογή οι ενέργειες **`GetIamPolicy`** και άλλες αναγνωστικές ενέργειες **δεν καταγράφονται**. Έτσι, από προεπιλογή, ένας επιτιθέμενος που προσπαθεί να καταγράψει το περιβάλλον δεν θα εντοπιστεί αν ο διαχειριστής συστήματος δεν έχει ρυθμίσει να δημιουργούνται περισσότερες καταγραφές.

Για να ενεργοποιήσει περισσότερες καταγραφές στην κονσόλα, ο διαχειριστής συστήματος πρέπει να μεταβεί στο [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) και να τις ενεργοποιήσει. Υπάρχουν 2 διαφορετικές επιλογές:

* **Προεπιλεγμένη Διαμόρφωση**: Είναι δυνατόν να δημιουργηθεί μια προεπιλεγμένη διαμόρφωση και να καταγραφούν όλες οι καταγραφές Διαβάστε Δραστηριότητες Διαχείρισης και/ή Διαβάστε Δεδομένα και/ή Γράψτε Δεδομένα και ακόμη και να προστεθούν εξαιρούμενοι φορείς:

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **Επιλέξτε τις υπηρεσίες**: Ή απλά **επιλέξτε τις υπηρεσίες** που θα θέλατε να δημιουργήσετε καταγραφές και τον τύπο των καταγραφών και τον εξαιρούμενο φορέα για αυτήν την συγκεκριμένη υπηρεσία.

Επίσης, σημειώστε ότι από προεπιλογή μόνο αυτές οι καταγραφές δημιουργούνται, διότι η δημιουργία περισσότερων καταγραφών θα αυξήσει το κόστος.

### Καταμέτρηση

Το εργαλείο γραμμής εντολών `gcloud` είναι αναπόσπαστο μέρος του οικοσυστήματος GCP, επιτρέποντάς σας να διαχειρίζεστε τους πόρους και τις υπηρεσίες σας. Δείτε πώς μπορείτε να χρησιμοποιήσετε το `gcloud` για να διαχειριστείτε τις ρυθμίσεις καταγραφής σας και να αποκτήσετε πρόσβαση στις καταγραφές. 

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Παράδειγμα για να ελέγξετε τα logs του **`cloudresourcemanager`** (αυτό που χρησιμοποιείται για BF permissions): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

Δεν υπάρχουν logs του **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Post Exploitation

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## References

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
