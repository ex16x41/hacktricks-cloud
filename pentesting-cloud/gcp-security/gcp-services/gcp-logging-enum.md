# GCP - Logging Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe informacje

Ta usuga pozwala u偶ytkownikom przechowywa, wyszukiwa, analizowa, monitorowa i powiadamia o **danych i zdarzeniach log贸w** z GCP.

Cloud Logging jest w peni zintegrowany z innymi usugami GCP, zapewniajc scentralizowane repozytorium dla log贸w ze wszystkich zasob贸w GCP. **Automatycznie zbiera logi z r贸偶nych usug GCP** takich jak App Engine, Compute Engine i Cloud Functions. Mo偶esz r贸wnie偶 u偶ywa Cloud Logging dla aplikacji dziaajcych lokalnie lub w innych chmurach, korzystajc z agenta Cloud Logging lub API.

Kluczowe funkcje:

* **Centralizacja danych log贸w:** Agreguj dane log贸w z r贸偶nych 藕r贸de, oferujc caociowy widok na swoje aplikacje i infrastruktur.
* **Zarzdzanie logami w czasie rzeczywistym:** Strumieniuj logi w czasie rzeczywistym dla natychmiastowej analizy i reakcji.
* **Pot偶na analiza danych:** U偶yj zaawansowanych mo偶liwoci filtrowania i wyszukiwania, aby szybko przeszukiwa du偶e iloci danych log贸w.
* **Integracja z BigQuery:** Eksportuj logi do BigQuery w celu szczeg贸owej analizy i zapyta.
* **Metryki oparte na logach:** Tw贸rz niestandardowe metryki z danych log贸w do monitorowania i powiadamiania.

### Przepyw log贸w

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

Zasadniczo zlewy i metryki oparte na logach okrelaj, gdzie log powinien by przechowywany.

### Konfiguracje wspierane przez GCP Logging

Cloud Logging jest wysoce konfigurowalny, aby dostosowa si do r贸偶nych potrzeb operacyjnych:

1. **Kosze log贸w (Przechowywanie log贸w w sieci):** Zdefiniuj kosze w Cloud Logging, aby zarzdza **przechowywaniem log贸w**, zapewniajc kontrol nad tym, jak dugo Twoje wpisy log贸w s przechowywane.
* Domylnie tworzone s kosze `_Default` i `_Required` (jeden rejestruje to, czego nie rejestruje drugi).
* **\_Required** to: 

{% code overflow="wrap" %}
````
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```

````
{% endcode %}

* **Okres przechowywania** danych jest konfigurowany dla ka偶dego koszyka i musi wynosi **co najmniej 1 dzie.** Jednak **okres przechowywania \_Required wynosi 400 dni** i nie mo偶e by modyfikowany.
* Zauwa偶, 偶e Koszyki Dziennik贸w s **niewidoczne w Cloud Storage.**

2. **Skrzynki Dziennik贸w (Log router w sieci):** Tw贸rz skrzynki, aby **eksportowa wpisy dziennik贸w** do r贸偶nych miejsc docelowych, takich jak Pub/Sub, BigQuery lub Cloud Storage na podstawie **filtru**.
* **Domylnie** skrzynki dla koszyk贸w `_Default` i `_Required` s tworzone:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Filtry wykluczajce:** Mo偶liwe jest skonfigurowanie **wyklucze, aby zapobiec wchanianiu konkretnych wpis贸w dziennik贸w**, co pozwala na oszczdnoci koszt贸w i redukcj niepotrzebnego haasu.
3. **Metryki oparte na dziennikach:** Skonfiguruj **niestandardowe metryki** na podstawie treci dziennik贸w, co pozwala na alertowanie i monitorowanie na podstawie danych z dziennik贸w.
4. **Widoki dziennik贸w:** Widoki dziennik贸w daj zaawansowan i **szczeg贸ow kontrol nad tym, kto ma dostp** do dziennik贸w w twoich koszykach dziennik贸w.
* Cloud Logging **automatycznie tworzy widok `_AllLogs` dla ka偶dego koszyka**, kt贸ry pokazuje wszystkie dzienniki. Cloud Logging tworzy r贸wnie偶 widok dla koszyka `_Default` o nazwie `_Default`. Widok `_Default` dla koszyka `_Default` pokazuje wszystkie dzienniki z wyjtkiem dziennik贸w audytu dostpu do danych. Widoki `_AllLogs` i `_Default` nie s edytowalne.

Mo偶liwe jest zezwolenie na dostp dla podmiotu **tylko do u偶ywania konkretnego widoku dziennika** za pomoc polityki IAM, takiej jak: 

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### Domylne logi

Domylnie operacje **Admin Write** (nazywane r贸wnie偶 logami audytu aktywnoci administratora) s logowane (zapisuj metadane lub informacje konfiguracyjne) i **nie mog by wyczone**.

Nastpnie u偶ytkownik mo偶e wczy **logi audytu dostpu do danych**, kt贸re obejmuj **Admin Read, Data Write i Data Write**.

Wicej informacji na temat ka偶dego typu logu mo偶na znale藕 w dokumentacji: [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

Nale偶y jednak zauwa偶y, 偶e oznacza to, i偶 domylnie dziaania **`GetIamPolicy`** i inne dziaania odczytu **nie s logowane**. Tak wic, domylnie atakujcy pr贸bujcy zenumerowa rodowisko nie zostanie zapany, jeli administrator systemu nie skonfigurowa generowania wikszej liczby log贸w.

Aby wczy wicej log贸w w konsoli, administrator systemu musi przej do [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) i je wczy. Istniej 2 r贸偶ne opcje:

* **Domylna konfiguracja**: Mo偶liwe jest utworzenie domylnej konfiguracji i logowanie wszystkich log贸w Admin Read i/lub Data Read i/lub Data Write oraz dodanie zwolnionych podmiot贸w:

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **Wybierz usugi**: Lub po prostu **wybierz usugi**, dla kt贸rych chcesz generowa logi oraz typ log贸w i zwolniony podmiot dla tej konkretnej usugi.

Nale偶y r贸wnie偶 zauwa偶y, 偶e domylnie generowane s tylko te logi, poniewa偶 generowanie wikszej liczby log贸w zwikszy koszty.

### Enumeracja

Narzdzie wiersza polece `gcloud` jest integraln czci ekosystemu GCP, umo偶liwiajc zarzdzanie zasobami i usugami. Oto jak mo偶esz u偶y `gcloud`, aby zarzdza konfiguracjami logowania i uzyskiwa dostp do log贸w.

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Przykad sprawdzenia log贸w **`cloudresourcemanager`** (u偶ywanego do BF uprawnie): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

Nie ma log贸w **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Post Exploitation

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## References

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
