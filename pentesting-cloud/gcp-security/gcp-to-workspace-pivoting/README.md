# GCP <--> Workspace Pivoting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **From GCP to GWS**

### **Podstawy delegacji w caÅ‚ej domenie**

Delegacja w caÅ‚ej domenie Google Workspace pozwala obiektowi toÅ¼samoÅ›ci, czy to **zewnÄ™trznej aplikacji** z Google Workspace Marketplace, czy wewnÄ™trznego **Konta UsÅ‚ugi GCP**, na **uzyskanie dostÄ™pu do danych w Workspace w imieniu uÅ¼ytkownikÃ³w**.

{% hint style="info" %}
To zasadniczo oznacza, Å¼e **kontakty usÅ‚ugowe** w projektach GCP organizacji mogÄ… byÄ‡ w stanie **udawaÄ‡ uÅ¼ytkownikÃ³w Workspace** tej samej organizacji (lub nawet z innej).
{% endhint %}

Aby uzyskaÄ‡ wiÄ™cej informacji na temat tego, jak to dokÅ‚adnie dziaÅ‚a, sprawdÅº:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Kompromitacja istniejÄ…cej delegacji

JeÅ›li atakujÄ…cy **skompromitowaÅ‚ jakiÅ› dostÄ™p do GCP** i **zna waÅ¼ny adres e-mail uÅ¼ytkownika Workspace** (najlepiej **super admina**) firmy, mÃ³gÅ‚by **wyliczyÄ‡ wszystkie projekty**, do ktÃ³rych ma dostÄ™p, **wyliczyÄ‡ wszystkie SA** projektÃ³w, sprawdziÄ‡, do ktÃ³rych **kont usÅ‚ugowych ma dostÄ™p**, i **powtÃ³rzyÄ‡** wszystkie te kroki z kaÅ¼dym SA, ktÃ³rego moÅ¼e udawaÄ‡.\
MajÄ…c **listÄ™ wszystkich kont usÅ‚ugowych**, do ktÃ³rych ma **dostÄ™p**, oraz listÄ™ **e-maili Workspace**, atakujÄ…cy mÃ³gÅ‚by sprÃ³bowaÄ‡ **udawaÄ‡ uÅ¼ytkownika z kaÅ¼dym kontem usÅ‚ugowym**.

{% hint style="danger" %}
ZauwaÅ¼, Å¼e podczas konfigurowania delegacji w caÅ‚ej domenie nie jest potrzebny Å¼aden uÅ¼ytkownik Workspace, dlatego wystarczy **znaÄ‡ jednego waÅ¼nego, aby byÅ‚o to wymagane do udawania**.\
JednakÅ¼e, **przywileje udawanego uÅ¼ytkownika bÄ™dÄ… uÅ¼ywane**, wiÄ™c jeÅ›li to Super Admin, bÄ™dziesz mÃ³gÅ‚ uzyskaÄ‡ dostÄ™p do wszystkiego. JeÅ›li nie ma Å¼adnego dostÄ™pu, to bÄ™dzie bezuÅ¼yteczne.
{% endhint %}

#### [GCP Generuj token delegacji](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Ten prosty skrypt **wygeneruje token OAuth jako delegowany uÅ¼ytkownik**, ktÃ³ry moÅ¼esz nastÄ™pnie uÅ¼yÄ‡ do uzyskania dostÄ™pu do innych interfejsÃ³w API Google z lub bez `gcloud`:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

To jest narzÄ™dzie, ktÃ³re moÅ¼e przeprowadziÄ‡ atak, wykonujÄ…c nastÄ™pujÄ…ce kroki:

1. **Enumerate GCP Projects** przy uÅ¼yciu Resource Manager API.
2. Iteruj po kaÅ¼dym zasobie projektu i **enumerate GCP Service account resources**, do ktÃ³rych ma dostÄ™p poczÄ…tkowy uÅ¼ytkownik IAM, uÅ¼ywajÄ…c _GetIAMPolicy_.
3. Iteruj po **kaÅ¼dej roli konta usÅ‚ugi** i znajdÅº wbudowane, podstawowe i niestandardowe role z uprawnieniem _**serviceAccountKeys.create**_ na docelowym zasobie konta usÅ‚ugi. NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e rola Edytora z natury posiada to uprawnienie.
4. UtwÃ³rz **nowy `KEY_ALG_RSA_2048`** klucz prywatny dla kaÅ¼dego zasobu konta usÅ‚ugi, ktÃ³re zostaÅ‚o znalezione z odpowiednim uprawnieniem w polityce IAM.
5. Iteruj po **kaÅ¼dym nowym koncie usÅ‚ugi i utwÃ³rz obiekt `JWT`** dla niego, ktÃ³ry skÅ‚ada siÄ™ z poÅ›wiadczeÅ„ klucza prywatnego SA i zakresu OAuth. Proces tworzenia nowego obiektu _JWT_ bÄ™dzie **iterowaÄ‡ po wszystkich istniejÄ…cych kombinacjach zakresÃ³w OAuth** z listy **oauth\_scopes.txt**, aby znaleÅºÄ‡ wszystkie moÅ¼liwoÅ›ci delegacji. Lista **oauth\_scopes.txt** jest aktualizowana o wszystkie zakresy OAuth, ktÃ³re uznaliÅ›my za istotne do naduÅ¼ywania toÅ¼samoÅ›ci Workspace.
6. Metoda `_make_authorization_grant_assertion` ujawnia koniecznoÅ›Ä‡ zadeklarowania **docelowego uÅ¼ytkownika workspace**, okreÅ›lanego jako _subject_, do generowania JWT pod DWD. ChociaÅ¼ moÅ¼e siÄ™ wydawaÄ‡, Å¼e wymaga to konkretnego uÅ¼ytkownika, waÅ¼ne jest, aby zrozumieÄ‡, Å¼e **DWD wpÅ‚ywa na kaÅ¼dÄ… toÅ¼samoÅ›Ä‡ w domenie**. W zwiÄ…zku z tym, tworzenie JWT dla **dowolnego uÅ¼ytkownika domeny** wpÅ‚ywa na wszystkie toÅ¼samoÅ›ci w tej domenie, zgodnie z naszÄ… kontrolÄ… enumeracji kombinacji. MÃ³wiÄ…c proÅ›ciej, jeden waÅ¼ny uÅ¼ytkownik Workspace jest wystarczajÄ…cy, aby kontynuowaÄ‡.\
Ten uÅ¼ytkownik moÅ¼e byÄ‡ zdefiniowany w pliku _config.yaml_ DeleFriend. JeÅ›li docelowy uÅ¼ytkownik workspace nie jest jeszcze znany, narzÄ™dzie uÅ‚atwia automatyczne identyfikowanie waÅ¼nych uÅ¼ytkownikÃ³w workspace poprzez skanowanie uÅ¼ytkownikÃ³w domeny z rolami w projektach GCP. Kluczowe jest (jeszcze raz) zauwaÅ¼yÄ‡, Å¼e JWT sÄ… specyficzne dla domeny i nie sÄ… generowane dla kaÅ¼dego uÅ¼ytkownika; dlatego automatyczny proces celuje w jednÄ… unikalnÄ… toÅ¼samoÅ›Ä‡ na domenÄ™.
7. **Enumerate and create a new bearer access token** dla kaÅ¼dego JWT i zweryfikuj token za pomocÄ… tokeninfo API.

#### [Skrypt Pythona Gitlab](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab stworzyÅ‚ [ten skrypt Pythona](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py), ktÃ³ry moÅ¼e zrobiÄ‡ dwie rzeczy - wylistowaÄ‡ katalog uÅ¼ytkownikÃ³w i utworzyÄ‡ nowe konto administracyjne, wskazujÄ…c json z poÅ›wiadczeniami SA i uÅ¼ytkownika do naÅ›ladowania. Oto jak moÅ¼na go uÅ¼yÄ‡:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### UtwÃ³rz nowÄ… delegacjÄ™ (Utrzymywanie)

MoÅ¼liwe jest **sprawdzenie delegacji na poziomie domeny w** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Napastnik, ktÃ³ry ma moÅ¼liwoÅ›Ä‡ **tworzenia kont serwisowych w projekcie GCP** oraz **uprawnienia super administratora do GWS, moÅ¼e utworzyÄ‡ nowÄ… delegacjÄ™, ktÃ³ra pozwala SAs na podszywanie siÄ™ pod niektÃ³rych uÅ¼ytkownikÃ³w GWS:**

1. **Generowanie nowego konta serwisowego i odpowiadajÄ…cej pary kluczy:** W GCP nowe zasoby kont serwisowych mogÄ… byÄ‡ tworzone interaktywnie za poÅ›rednictwem konsoli lub programowo za pomocÄ… bezpoÅ›rednich wywoÅ‚aÅ„ API i narzÄ™dzi CLI. Wymaga to **roli `iam.serviceAccountAdmin`** lub dowolnej niestandardowej roli wyposaÅ¼onej w **uprawnienie `iam.serviceAccounts.create`**. Po utworzeniu konta serwisowego przystÄ…pimy do wygenerowania **odpowiedniej pary kluczy** (**uprawnienie `iam.serviceAccountKeys.create`**).
2. **Utworzenie nowej delegacji**: WaÅ¼ne jest, aby zrozumieÄ‡, Å¼e **tylko rola Super Admin ma moÅ¼liwoÅ›Ä‡ skonfigurowania globalnej delegacji na poziomie domeny w Google Workspace** i delegacja na poziomie domeny **nie moÅ¼e byÄ‡ skonfigurowana programowo,** moÅ¼e byÄ‡ tworzona i dostosowywana **rÄ™cznie** za poÅ›rednictwem konsoli Google Workspace.
* Utworzenie reguÅ‚y moÅ¼na znaleÅºÄ‡ na stronie **API controls â†’ Manage Domain-Wide delegation in Google Workspace Admin console**.
3. **Przypisanie uprawnieÅ„ zakresÃ³w OAuth**: Podczas konfigurowania nowej delegacji Google wymaga tylko 2 parametrÃ³w, identyfikatora klienta, ktÃ³ry jest **identyfikatorem OAuth zasobu konta serwisowego GCP**, oraz **zakresÃ³w OAuth**, ktÃ³re definiujÄ…, jakie wywoÅ‚ania API sÄ… wymagane przez delegacjÄ™.
* **PeÅ‚na lista zakresÃ³w OAuth** jest dostÄ™pna [**tutaj**](https://developers.google.com/identity/protocols/oauth2/scopes), ale oto rekomendacja: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **DziaÅ‚anie w imieniu docelowej toÅ¼samoÅ›ci:** Na tym etapie mamy dziaÅ‚ajÄ…cy obiekt delegacji w GWS. Teraz, **uÅ¼ywajÄ…c prywatnego klucza konta serwisowego GCP, moÅ¼emy wykonywaÄ‡ wywoÅ‚ania API** (w zakresie zdefiniowanym w parametrze zakresu OAuth), aby go uruchomiÄ‡ i **dziaÅ‚aÄ‡ w imieniu dowolnej toÅ¼samoÅ›ci, ktÃ³ra istnieje w Google Workspace**. Jak siÄ™ dowiedzieliÅ›my, konto serwisowe wygeneruje tokeny dostÄ™pu zgodnie z jego potrzebami i zgodnie z uprawnieniami, ktÃ³re ma do aplikacji REST API.
* SprawdÅº **poprzedniÄ… sekcjÄ™** w celu uzyskania **narzÄ™dzi** do wykorzystania tej delegacji.

#### Delegacja miÄ™dzyorganizacyjna

Identyfikator SA OAuth jest globalny i moÅ¼e byÄ‡ uÅ¼ywany do **delegacji miÄ™dzyorganizacyjnej**. Nie wprowadzono Å¼adnych ograniczeÅ„, aby zapobiec delegacji miÄ™dzyglobalnej. MÃ³wiÄ…c prosto, **kontakty serwisowe z rÃ³Å¼nych organizacji GCP mogÄ… byÄ‡ uÅ¼ywane do konfigurowania delegacji na poziomie domeny w innych organizacjach Workspace**. Skutkuje to **potrzebÄ… tylko dostÄ™pu Super Admin do Workspace**, a nie dostÄ™pu do tego samego konta GCP, poniewaÅ¼ przeciwnik moÅ¼e tworzyÄ‡ konta serwisowe i prywatne klucze na swoim osobiÅ›cie kontrolowanym koncie GCP.

### Tworzenie projektu do enumeracji Workspace

Zgodnie z **domyÅ›lnymi ustawieniami** uÅ¼ytkownicy Workspace majÄ… uprawnienia do **tworzenia nowych projektÃ³w**, a gdy nowy projekt jest tworzony, **twÃ³rca otrzymuje rolÄ™ wÅ‚aÅ›ciciela**.

Dlatego uÅ¼ytkownik moÅ¼e **utworzyÄ‡ projekt**, **wÅ‚Ä…czyÄ‡** **API** do enumeracji Workspace w swoim nowym projekcie i sprÃ³bowaÄ‡ **enumerowaÄ‡** go.

{% hint style="danger" %}
Aby uÅ¼ytkownik mÃ³gÅ‚ enumerowaÄ‡ Workspace, musi rÃ³wnieÅ¼ mieÄ‡ wystarczajÄ…ce uprawnienia do Workspace (nie kaÅ¼dy uÅ¼ytkownik bÄ™dzie mÃ³gÅ‚ enumerowaÄ‡ katalog).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

SprawdÅº **wiÄ™cej enumeracji w**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Wykorzystywanie poÅ›wiadczeÅ„ Gcloud

MoÅ¼esz znaleÅºÄ‡ wiÄ™cej informacji na temat przepÅ‚ywu `gcloud` do logowania w:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Jak tam wyjaÅ›niono, gcloud moÅ¼e Å¼Ä…daÄ‡ zakresu **`https://www.googleapis.com/auth/drive`**, co pozwoliÅ‚oby uÅ¼ytkownikowi uzyskaÄ‡ dostÄ™p do dysku uÅ¼ytkownika.\
Jako atakujÄ…cy, jeÅ›li fizycznie przejÄ…Å‚eÅ› komputer uÅ¼ytkownika i **uÅ¼ytkownik jest nadal zalogowany** na swoje konto, moÅ¼esz siÄ™ zalogowaÄ‡, generujÄ…c token z dostÄ™pem do dysku, uÅ¼ywajÄ…c:
```bash
gcloud auth login --enable-gdrive-access
```
JeÅ›li atakujÄ…cy przejmie komputer uÅ¼ytkownika, moÅ¼e rÃ³wnieÅ¼ zmodyfikowaÄ‡ plik `google-cloud-sdk/lib/googlecloudsdk/core/config.py` i dodaÄ‡ do **`CLOUDSDK_SCOPES`** zakres **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Dlatego nastÄ™pnym razem, gdy uÅ¼ytkownik siÄ™ zaloguje, utworzy **token z dostÄ™pem do drive**, ktÃ³ry atakujÄ…cy moÅ¼e wykorzystaÄ‡ do uzyskania dostÄ™pu do drive. OczywiÅ›cie przeglÄ…darka wskaÅ¼e, Å¼e wygenerowany token bÄ™dzie miaÅ‚ dostÄ™p do drive, ale poniewaÅ¼ uÅ¼ytkownik sam wywoÅ‚a **`gcloud auth login`**, prawdopodobnie **nie podejrzewa niczego.**

Aby wylistowaÄ‡ pliki na drive: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Z GWS do GCP

### DostÄ™p do uprzywilejowanych uÅ¼ytkownikÃ³w GCP

JeÅ›li atakujÄ…cy ma peÅ‚ny dostÄ™p do GWS, bÄ™dzie mÃ³gÅ‚ uzyskaÄ‡ dostÄ™p do grup z uprzywilejowanym dostÄ™pem do GCP lub nawet uÅ¼ytkownikÃ³w, dlatego przejÅ›cie z GWS do GCP jest zazwyczaj "prostsze", poniewaÅ¼ **uÅ¼ytkownicy w GWS majÄ… wysokie uprawnienia w GCP**.

### Eskalacja uprawnieÅ„ Google Groups

DomyÅ›lnie uÅ¼ytkownicy mogÄ… **swobodnie doÅ‚Ä…czaÄ‡ do grup Workspace w Organizacji**, a te grupy **mogÄ… mieÄ‡ przypisane uprawnienia GCP** (sprawdÅº swoje grupy w [https://groups.google.com/](https://groups.google.com/)).

WykorzystujÄ…c **eskalacjÄ™ uprawnieÅ„ google groups**, moÅ¼esz byÄ‡ w stanie eskalowaÄ‡ do grupy z jakimÅ› rodzajem uprzywilejowanego dostÄ™pu do GCP.

### Referencje

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
