# GCP <--> Workspace Pivoting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **GCP'den GWS'ye**

### **Alan Genel Yetkilendirme Temelleri**

Google Workspace'in Alan Genel Yetkilendirmesi, bir kimlik nesnesinin, ya bir **harici uygulama** Google Workspace Marketplace'ten ya da bir iç **GCP Hizmet Hesabı** olarak, **kullanıcılar adına Workspace üzerindeki verilere erişmesine** olanak tanır.

{% hint style="info" %}
Bu, temelde **GCP projeleri içindeki hizmet hesaplarının**, aynı organizasyondaki (veya farklı bir organizasyondaki) **Workspace kullanıcılarını taklit edebilme** yeteneğine sahip olabileceği anlamına gelir.
{% endhint %}

Bu işlemin tam olarak nasıl çalıştığı hakkında daha fazla bilgi için kontrol edin:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Mevcut yetkilendirmeyi ele geçirme

Eğer bir saldırgan **GCP üzerinde bazı erişimleri ele geçirmişse** ve şirketin **geçerli bir Workspace kullanıcı e-posta adresini** (tercihen **süper admin**) biliyorsa, erişim sağladığı **tüm projeleri listeleyebilir**, projelerin **tüm SA'lerini listeleyebilir**, hangi **hizmet hesaplarına erişimi olduğunu kontrol edebilir** ve **taklit edebileceği her SA ile bu adımları tekrarlayabilir**.\
Elde ettiği **tüm hizmet hesaplarının listesi** ve **Workspace** **e-posta adresleri** ile saldırgan, **her hizmet hesabı ile kullanıcıyı taklit etmeye** çalışabilir.

{% hint style="danger" %}
Alan genel yetkilendirmesi yapılandırılırken hiçbir Workspace kullanıcısına ihtiyaç olmadığını unutmayın, bu nedenle sadece **bir geçerli kullanıcı bilmek yeterlidir ve taklit için gereklidir**.\
Ancak, **taklit edilen kullanıcının ayrıcalıkları kullanılacaktır**, bu nedenle eğer Süper Admin ise her şeye erişebileceksiniz. Eğer hiçbir erişimi yoksa bu işe yaramaz.
{% endhint %}

#### [GCP Yetkilendirme Token'ı Oluştur](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Bu basit script, **yetkilendirilmiş kullanıcı olarak bir OAuth token'ı oluşturacaktır** ve bunu `gcloud` ile veya onsuz diğer Google API'lerine erişmek için kullanabilirsiniz:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Bu, aşağıdaki adımları izleyerek saldırı gerçekleştirebilen bir araçtır:

1. **GCP Projelerini Sayma** Resource Manager API kullanarak.
2. Her proje kaynağı üzerinde yineleme yaparak, **GCP Hizmet hesabı kaynaklarını sayma** başlangıç IAM kullanıcısının erişim sağladığı _GetIAMPolicy_ kullanarak.
3. **Her hizmet hesabı rolü üzerinde yineleme yaparak**, hedef hizmet hesabı kaynağında _**serviceAccountKeys.create**_ iznine sahip yerleşik, temel ve özel rolleri bulma. Editör rolünün bu izne doğal olarak sahip olduğu belirtilmelidir.
4. IAM politikasında ilgili izne sahip bulunan her hizmet hesabı kaynağı için **yeni bir `KEY_ALG_RSA_2048`** özel anahtar oluşturma.
5. **Her yeni hizmet hesabı üzerinde yineleme yaparak bir `JWT`** **nesnesi** oluşturma; bu nesne SA özel anahtar kimlik bilgileri ve bir OAuth kapsamından oluşur. Yeni bir _JWT_ nesnesi oluşturma süreci, **oauth\_scopes.txt** listesindeki tüm mevcut OAuth kapsamı kombinasyonları üzerinde yineleme yaparak tüm delege etme olasılıklarını bulacaktır. **oauth\_scopes.txt** listesi, Workspace kimliklerini kötüye kullanmak için ilgili bulduğumuz tüm OAuth kapsamlarıyla güncellenir.
6. `_make_authorization_grant_assertion` metodu, DWD altında JWT'ler oluşturmak için bir **hedef çalışma alanı kullanıcısı** olarak adlandırılan _subject_ beyan etmenin gerekliliğini ortaya koyar. Bu, belirli bir kullanıcı gerektiriyormuş gibi görünse de, **DWD'nin bir alan içindeki her kimliği etkilediğini** anlamak önemlidir. Sonuç olarak, **herhangi bir alan kullanıcısı** için bir JWT oluşturmak, o alandaki tüm kimlikleri etkiler; bu, kombinasyon sayma kontrolümüzle tutarlıdır. Kısacası, ilerlemek için bir geçerli Workspace kullanıcısı yeterlidir.\
Bu kullanıcı, DeleFriend’in _config.yaml_ dosyasında tanımlanabilir. Hedef çalışma alanı kullanıcısı henüz bilinmiyorsa, araç, GCP projelerinde rolleri olan alan kullanıcılarını tarayarak geçerli çalışma alanı kullanıcılarının otomatik olarak tanımlanmasını kolaylaştırır. JWT'lerin alan spesifik olduğunu ve her kullanıcı için üretilmediğini (tekrar) belirtmek önemlidir; bu nedenle, otomatik süreç her alan için tek bir benzersiz kimliği hedef alır.
7. **Her JWT için yeni bir taşıyıcı erişim belirteci sayma ve belirteci tokeninfo API'si ile doğrulama.**

#### [Gitlab'ın Python scripti](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab, SA kimlik bilgileri ve taklit edilecek kullanıcı ile birlikte bir json belirterek kullanıcı dizinini listeleyip yeni bir yönetici hesabı oluşturabilen [bu Python scriptini](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) oluşturmuştur. İşte nasıl kullanacağınız:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Yeni bir delegasyon oluşturma (Süreklilik)

**Domain Wide Delegations'ı kontrol etmek mümkündür** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

**GCP projesinde hizmet hesapları oluşturma yeteneğine** ve **GWS için süper yönetici ayrıcalığına sahip bir saldırgan, bazı GWS kullanıcılarını taklit etmelerine izin veren yeni bir delegasyon oluşturabilir:**

1. **Yeni Bir Hizmet Hesabı ve İlgili Anahtar Çifti Oluşturma:** GCP'de, yeni hizmet hesabı kaynakları ya konsol aracılığıyla etkileşimli olarak ya da doğrudan API çağrıları ve CLI araçları kullanarak programlı olarak üretilebilir. Bu, **`iam.serviceAccountAdmin`** rolünü veya **`iam.serviceAccounts.create`** **izinine** sahip herhangi bir özel rolü gerektirir. Hizmet hesabı oluşturulduktan sonra, **ilişkili bir anahtar çifti** oluşturmak için ilerleyeceğiz (**`iam.serviceAccountKeys.create`** izni).
2. **Yeni delegasyonun oluşturulması**: **Sadece Süper Yönetici rolünün Google Workspace'te küresel Domain-Wide delegasyonu kurma yeteneğine sahip olduğunu** anlamak önemlidir ve Domain-Wide delegasyonu **programlı olarak kurulamaz,** yalnızca Google Workspace **konsolu** aracılığıyla **manuel olarak** oluşturulabilir ve ayarlanabilir.
* Kuralın oluşturulması, **API kontrolleri → Google Workspace Yönetici konsolunda Domain-Wide delegasyonu yönet** sayfasında bulunabilir.
3. **OAuth kapsamları ayrıcalığını ekleme**: Yeni bir delegasyon yapılandırırken, Google yalnızca 2 parametre gerektirir: **GCP Hizmet Hesabı** kaynağının **OAuth ID'si** olan İstemci Kimliği ve delegasyonun gerektirdiği API çağrılarını tanımlayan **OAuth kapsamları**.
* **OAuth kapsamlarının tam listesi** [**burada**](https://developers.google.com/identity/protocols/oauth2/scopes) bulunabilir, ancak burada bir öneri: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Hedef kimliği adına hareket etme:** Bu noktada, GWS'de işlevsel bir delegasyon nesnesine sahibiz. Artık, **GCP Hizmet Hesabı özel anahtarını kullanarak API çağrıları gerçekleştirebiliriz** (OAuth kapsamı parametresinde tanımlanan kapsamda) ve **Google Workspace'te mevcut olan herhangi bir kimlik adına hareket edebiliriz**. Öğrendiğimiz gibi, hizmet hesabı ihtiyaçlarına göre ve REST API uygulamalarına sahip olduğu izinlere göre erişim belirteçleri üretecektir.
* Bu delegasyonu kullanmak için bazı **araçlar** için **önceki bölüme** bakın.

#### Kurumsal Dışı delegasyon

OAuth SA ID'si küreseldir ve **kurumsal dışı delegasyon** için kullanılabilir. Küresel delegasyonu önlemek için herhangi bir kısıtlama uygulanmamıştır. Basitçe ifade etmek gerekirse, **farklı GCP organizasyonlarından hizmet hesapları, diğer Workspace organizasyonlarında domain-wide delegasyonu yapılandırmak için kullanılabilir**. Bu, **sadece Workspace için Süper Yönetici erişimine ihtiyaç duyulması** anlamına gelir ve aynı GCP hesabına erişim gerektirmez, çünkü saldırgan kendi kontrolündeki GCP hesabında Hizmet Hesapları ve özel anahtarlar oluşturabilir.

### Workspace'i listelemek için bir Proje Oluşturma

**Varsayılan olarak** Workspace **kullanıcıları** **yeni projeler oluşturma** iznine sahiptir ve yeni bir proje oluşturulduğunda **oluşturucu, üzerinde Sahip rolü** alır.

Bu nedenle, bir kullanıcı **bir proje oluşturabilir**, yeni projesinde Workspace'i listelemek için **API'leri etkinleştirebilir** ve bunu **listelemeye** çalışabilir.

{% hint style="danger" %}
Bir kullanıcının Workspace'i listeleyebilmesi için yeterli Workspace izinlerine de sahip olması gerekir (her kullanıcı dizini listeleyemez).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Daha fazla numaralandırma için kontrol edin:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Gcloud kimlik bilgilerini kötüye kullanma

Giriş yapmak için `gcloud` akışı hakkında daha fazla bilgi bulabilirsiniz:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Orada açıklandığı gibi, gcloud **`https://www.googleapis.com/auth/drive`** kapsamını talep edebilir, bu da bir kullanıcının sürücüsüne erişmesine izin verir.\
Bir saldırgan olarak, eğer bir kullanıcının bilgisayarını **fiziksel olarak** ele geçirdiyseniz ve **kullanıcı hala** hesabıyla oturum açmışsa, sürücüye erişim sağlayan bir token oluşturarak giriş yapabilirsiniz:
```bash
gcloud auth login --enable-gdrive-access
```
Eğer bir saldırgan bir kullanıcının bilgisayarını ele geçirirse, `google-cloud-sdk/lib/googlecloudsdk/core/config.py` dosyasını da değiştirebilir ve **`CLOUDSDK_SCOPES`** içine **`'https://www.googleapis.com/auth/drive'`** kapsamını ekleyebilir:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Bu nedenle, kullanıcı bir sonraki giriş yaptığında, saldırganın drive'a erişmek için kötüye kullanabileceği **drive erişimi olan bir token oluşturacaktır**. Açıkça, tarayıcı oluşturulan token'ın drive'a erişimi olacağını gösterecektir, ancak kullanıcı kendisi **`gcloud auth login`** çağrısı yapacağı için muhtemelen **hiçbir şeyden şüphelenmeyecektir.**

Drive dosyalarını listelemek için: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## GWS'den GCP'ye

### Ayrıcalıklı GCP kullanıcılarına erişim

Eğer bir saldırgan GWS üzerinde tam erişime sahipse, GCP üzerinde ayrıcalıklı erişime sahip gruplara veya kullanıcılara erişebilecektir, bu nedenle GWS'den GCP'ye geçiş genellikle daha "basit"dir çünkü **GWS'deki kullanıcılar GCP üzerinde yüksek ayrıcalıklara sahiptir**.

### Google Grupları Ayrıcalık Yükseltme

Varsayılan olarak kullanıcılar **Organizasyonun Workspace gruplarına serbestçe katılabilir** ve bu gruplar **GCP izinlerine** sahip olabilir (gruplarınızı [https://groups.google.com/](https://groups.google.com/) adresinde kontrol edin).

**google groups privesc**'i kötüye kullanarak, GCP'ye bazı türde ayrıcalıklı erişimi olan bir gruba yükseltme yapabilirsiniz.

### Referanslar

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
