# GCP <--> Workspace Pivoting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **From GCP to GWS**

### **Osnovi delegacije na nivou domena**

Delegacija na nivou domena Google Workspace omoguÄ‡ava identitetskom objektu, bilo **spoljnoj aplikaciji** iz Google Workspace Marketplace ili unutraÅ¡njem **GCP servisnom nalogu**, da **pristupi podacima Å¡irom Workspace-a u ime korisnika**.

{% hint style="info" %}
To u suÅ¡tini znaÄi da **servisni nalozi** unutar GCP projekata organizacije mogu biti u moguÄ‡nosti da **imituju korisnike Workspace-a** iste organizacije (ili Äak iz druge).
{% endhint %}

Za viÅ¡e informacija o tome kako to taÄno funkcioniÅ¡e, pogledajte:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Kompromitovanje postojeÄ‡e delegacije

Ako napadaÄ **kompromituje neki pristup preko GCP** i **zna validnu email adresu korisnika Workspace-a** (poÅ¾eljno **super admin**), mogao bi da **enumeriÅ¡e sve projekte** kojima ima pristup, **enumeriÅ¡e sve SA** projekata, proveri kojima **servisnim nalozima ima pristup**, i **ponovi** sve ove korake sa svakim SA koji moÅ¾e da imituje.\
Sa **listom svih servisnih naloga** kojima ima **pristup** i listom **Workspace** **emailova**, napadaÄ bi mogao da pokuÅ¡a da **imitira korisnika sa svakim servisnim nalogom**.

{% hint style="danger" %}
Napomena: kada se konfiguriÅ¡e delegacija na nivou domena, nije potreban nijedan korisnik Workspace-a, stoga samo znajte da **jedan validan korisnik je dovoljan i potreban za imitaciju**.\
MeÄ‘utim, **privilegije imitiranog korisnika Ä‡e biti koriÅ¡Ä‡ene**, tako da ako je to Super Admin, moÄ‡i Ä‡ete da pristupite svemu. Ako nema nikakav pristup, to Ä‡e biti beskorisno.
{% endhint %}

#### [GCP GeneriÅ¡i Delegacioni Token](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Ovaj jednostavni skript Ä‡e **generisati OAuth token kao delegirani korisnik** koji moÅ¾ete koristiti za pristup drugim Google API-ima sa ili bez `gcloud`:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Ovo je alat koji moÅ¾e izvrÅ¡iti napad prateÄ‡i ove korake:

1. **Enumerate GCP Projects** koristeÄ‡i Resource Manager API.
2. Iterirati na svaki projekat resursa, i **enumerate GCP Service account resources** kojima inicijalni IAM korisnik ima pristup koristeÄ‡i _GetIAMPolicy_.
3. Iterirati na **svaku ulogu servisnog naloga**, i pronaÄ‡i ugraÄ‘ene, osnovne i prilagoÄ‘ene uloge sa _**serviceAccountKeys.create**_ dozvolom na ciljanom resursu servisnog naloga. Treba napomenuti da Editor uloga inherentno poseduje ovu dozvolu.
4. Kreirati **novi `KEY_ALG_RSA_2048`** privatni kljuÄ za svaki resurs servisnog naloga koji je pronaÄ‘en sa relevantnom dozvolom u IAM politici.
5. Iterirati na **svakom novom servisnom nalogu i kreirati `JWT`** **objekat** za njega koji se sastoji od SA privatnih kljuÄnih kredencijala i OAuth opsega. Proces kreiranja novog _JWT_ objekta Ä‡e **iterirati na sve postojeÄ‡e kombinacije OAuth opsega** iz **oauth\_scopes.txt** liste, kako bi pronaÅ¡ao sve moguÄ‡nosti delegacije. Lista **oauth\_scopes.txt** se aÅ¾urira sa svim OAuth opsezima za koje smo utvrdili da su relevantni za zloupotrebu identiteta Workspace-a.
6. Metod `_make_authorization_grant_assertion` otkriva potrebu da se deklarira t**arget workspace user**, nazvan _subject_, za generisanje JWT-ova pod DWD. Iako se moÅ¾e Äiniti da zahteva specifiÄnog korisnika, vaÅ¾no je shvatiti da **DWD utiÄe na svaki identitet unutar domena**. Shodno tome, kreiranje JWT-a za **bilo kog korisnika domena** utiÄe na sve identitete u tom domenu, u skladu sa naÅ¡im proverama kombinacija. Jednostavno reÄeno, jedan validan Workspace korisnik je dovoljan za nastavak.\
Ovaj korisnik moÅ¾e biti definisan u DeleFriend-ovom _config.yaml_ fajlu. Ako ciljani korisnik Workspace-a nije veÄ‡ poznat, alat olakÅ¡ava automatsku identifikaciju validnih korisnika Workspace-a skeniranjem korisnika domena sa ulogama na GCP projektima. KljuÄno je napomenuti (ponovo) da su JWT-ovi specifiÄni za domen i ne generiÅ¡u se za svakog korisnika; stoga, automatski proces cilja jedinstveni identitet po domenu.
7. **Enumerate and create a new bearer access token** za svaki JWT i validirati token protiv tokeninfo API.

#### [Gitlab's Python script](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab je kreirao [ovaj Python skript](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) koji moÅ¾e uraditi dve stvari - navesti korisniÄki direktorijum i kreirati novi administratorski nalog dok ukazuje na json sa SA kredencijalima i korisnikom koga treba imitirati. Evo kako biste ga koristili:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Kreirajte novu delegaciju (Persistencija)

MoguÄ‡e je **proveriti delegacije na nivou domena u** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

NapadaÄ sa sposobnoÅ¡Ä‡u da **kreira servisne naloge u GCP projektu** i **super admin privilegijom za GWS moÅ¾e kreirati novu delegaciju koja omoguÄ‡ava SA da se predstavljaju kao neki GWS korisnici:**

1. **Generisanje novog servisnog naloga i odgovarajuÄ‡eg para kljuÄeva:** Na GCP-u, novi resursi servisnog naloga mogu se proizvoditi ili interaktivno putem konzole ili programatski koristeÄ‡i direktne API pozive i CLI alate. To zahteva **ulogu `iam.serviceAccountAdmin`** ili bilo koju prilagoÄ‘enu ulogu opremljenu sa **`iam.serviceAccounts.create`** **dozvolom**. Kada se servisni nalog kreira, nastaviÄ‡emo da generiÅ¡emo **odgovarajuÄ‡i par kljuÄeva** (**`iam.serviceAccountKeys.create`** dozvola).
2. **Kreiranje nove delegacije**: VaÅ¾no je razumeti da **samo Super Admin uloga ima sposobnost da postavi globalnu delegaciju na nivou domena u Google Workspace** i delegacija na nivou domena **ne moÅ¾e biti postavljena programatski,** moÅ¾e se samo kreirati i prilagoditi **ruÄno** putem Google Workspace **konzole**.
* Kreiranje pravila moÅ¾e se naÄ‡i na stranici **API kontrole â†’ Upravljanje delegacijom na nivou domena u Google Workspace Admin konzoli**.
3. **PrikljuÄivanje privilegije OAuth opsega**: Kada se konfiguriÅ¡e nova delegacija, Google zahteva samo 2 parametra, Client ID, koji je **OAuth ID resursa GCP servisnog naloga**, i **OAuth opsege** koje definiÅ¡u koje API pozive delegacija zahteva.
* **Puna lista OAuth opsega** moÅ¾e se naÄ‡i [**ovde**](https://developers.google.com/identity/protocols/oauth2/scopes), ali evo preporuke: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Delovanje u ime ciljne identiteta:** U ovom trenutku, imamo funkcionalni delegirani objekat u GWS. Sada, **koristeÄ‡i privatni kljuÄ GCP servisnog naloga, moÅ¾emo izvrÅ¡iti API pozive** (u opsegu definisanom u parametru OAuth opsega) da ga aktiviramo i **delujemo u ime bilo kojeg identiteta koji postoji u Google Workspace**. Kao Å¡to smo saznali, servisni nalog Ä‡e generisati pristupne tokene prema svojim potrebama i u skladu sa dozvolama koje ima za REST API aplikacije.
* Proverite **prethodni odeljak** za neke **alate** za koriÅ¡Ä‡enje ove delegacije.

#### Delegacija izmeÄ‘u organizacija

OAuth SA ID je globalan i moÅ¾e se koristiti za **delegaciju izmeÄ‘u organizacija**. Nema ograniÄenja koja bi spreÄila prekograniÄnu delegaciju. U jednostavnim terminima, **servisni nalozi iz razliÄitih GCP organizacija mogu se koristiti za konfiguraciju delegacije na nivou domena u drugim Workspace organizacijama**. To bi znaÄilo da **samo Super Admin pristup Workspace-u** je potreban, a ne pristup istom GCP nalogu, jer protivnik moÅ¾e kreirati servisne naloge i privatne kljuÄeve na svom liÄno kontrolisanom GCP nalogu.

### Kreiranje projekta za enumeraciju Workspace-a

Po **defaultu** korisnici Workspace-a imaju dozvolu da **kreiraju nove projekte**, a kada se novi projekat kreira, **kreator dobija ulogu vlasnika** nad njim.

Stoga, korisnik moÅ¾e **kreirati projekat**, **omoguÄ‡iti** **API-je** za enumeraciju Workspace-a u svom novom projektu i pokuÅ¡ati da **enumeriÅ¡e**.

{% hint style="danger" %}
Da bi korisnik mogao da enumeriÅ¡e Workspace, takoÄ‘e mu je potrebna dovoljna Workspace dozvola (neÄ‡e svaki korisnik moÄ‡i da enumeriÅ¡e direktorijum).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Proverite **viÅ¡e enumeracije u**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Zloupotreba Gcloud kredencijala

MoÅ¾ete pronaÄ‡i dodatne informacije o `gcloud` toku za prijavu u:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Kao Å¡to je objaÅ¡njeno tamo, gcloud moÅ¾e zatraÅ¾iti opseg **`https://www.googleapis.com/auth/drive`** koji bi omoguÄ‡io korisniku pristup disku korisnika.\
Kao napadaÄ, ako ste **fiziÄki** kompromitovali raÄunar korisnika i **korisnik je joÅ¡ uvek prijavljen** sa svojim nalogom, mogli biste se prijaviti generiÅ¡uÄ‡i token sa pristupom disku koristeÄ‡i:
```bash
gcloud auth login --enable-gdrive-access
```
Ako napadaÄ kompromituje raÄunar korisnika, mogao bi takoÄ‘e da izmeni datoteku `google-cloud-sdk/lib/googlecloudsdk/core/config.py` i doda u **`CLOUDSDK_SCOPES`** opseg **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Stoga, sledeÄ‡i put kada se korisnik prijavi, kreiraÄ‡e **token sa pristupom drive-u** koji bi napadaÄ mogao da zloupotrebi za pristup drive-u. OÄigledno, pretraÅ¾ivaÄ Ä‡e ukazati da generisani token ima pristup drive-u, ali kako Ä‡e se korisnik sam pozvati na **`gcloud auth login`**, verovatno **neÄ‡e posumnjati u niÅ¡ta.**

Da biste nabrojali datoteke na drive-u: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Od GWS do GCP

### Pristup privilegovanim GCP korisnicima

Ako napadaÄ ima potpun pristup GWS-u, moÄ‡i Ä‡e da pristupi grupama sa privilegovanim pristupom GCP-u ili Äak korisnicima, stoga prelazak sa GWS-a na GCP je obiÄno "jednostavniji" samo zato Å¡to **korisnici u GWS-u imaju visoke privilegije nad GCP-om**.

### Eskalacija privilegija Google Grupa

Podrazumevano, korisnici mogu **slobodno da se pridruÅ¾uju Workspace grupama Organizacije** i te grupe **mogu imati dodeljene GCP dozvole** (proverite svoje grupe na [https://groups.google.com/](https://groups.google.com/)).

Zloupotrebom **google groups privesc** mogli biste biti u moguÄ‡nosti da se eskalirate u grupu sa nekim oblikom privilegovanog pristupa GCP-u.

### Reference

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
