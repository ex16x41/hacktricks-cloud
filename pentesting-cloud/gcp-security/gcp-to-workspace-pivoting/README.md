# GCP <--> Workspace Pivoting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **De GCP a GWS**

### **Conceptos b√°sicos de delegaci√≥n de dominio**

La delegaci√≥n de dominio de Google Workspace permite que un objeto de identidad, ya sea una **aplicaci√≥n externa** del Marketplace de Google Workspace o una **Cuenta de Servicio GCP** interna, **acceda a datos en todo el Workspace en nombre de los usuarios**.

{% hint style="info" %}
Esto significa b√°sicamente que las **cuentas de servicio** dentro de los proyectos de GCP de una organizaci√≥n podr√≠an **suplantar a los usuarios de Workspace** de la misma organizaci√≥n (o incluso de una diferente).
{% endhint %}

Para m√°s informaci√≥n sobre c√≥mo funciona esto exactamente, consulta:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Compromiso de delegaci√≥n existente

Si un atacante **comprometi√≥ alg√∫n acceso sobre GCP** y **conoce un correo electr√≥nico de usuario v√°lido de Workspace** (preferiblemente **super admin**) de la empresa, podr√≠a **enumerar todos los proyectos** a los que tiene acceso, **enumerar todas las CAs** de los proyectos, verificar a qu√© **cuentas de servicio tiene acceso**, y **repetir** todos estos pasos con cada CA que puede suplantar.\
Con una **lista de todas las cuentas de servicio** a las que tiene **acceso** y la lista de **correos electr√≥nicos de Workspace**, el atacante podr√≠a intentar **suplantar al usuario con cada cuenta de servicio**.

{% hint style="danger" %}
Ten en cuenta que al configurar la delegaci√≥n de dominio no se necesita ning√∫n usuario de Workspace, por lo tanto, solo saber que **uno v√°lido es suficiente y requerido para la suplantaci√≥n**.\
Sin embargo, se utilizar√°n los **privilegios del usuario suplantado**, as√≠ que si es Super Admin podr√°s acceder a todo. Si no tiene ning√∫n acceso, esto ser√° in√∫til.
{% endhint %}

#### [GCP Generar Token de Delegaci√≥n](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Este script simple **generar√° un token OAuth como el usuario delegado** que luego puedes usar para acceder a otras APIs de Google con o sin `gcloud`:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Esta es una herramienta que puede realizar el ataque siguiendo estos pasos:

1. **Enumerar proyectos de GCP** utilizando la API de Resource Manager.
2. Iterar sobre cada recurso del proyecto y **enumerar los recursos de cuentas de servicio de GCP** a los que el usuario IAM inicial tiene acceso utilizando _GetIAMPolicy_.
3. Iterar sobre **cada rol de cuenta de servicio** y encontrar roles integrados, b√°sicos y personalizados con permiso _**serviceAccountKeys.create**_ en el recurso de cuenta de servicio objetivo. Cabe se√±alar que el rol de Editor posee inherentemente este permiso.
4. Crear una **nueva clave privada `KEY_ALG_RSA_2048`** para cada recurso de cuenta de servicio que se encuentre con el permiso relevante en la pol√≠tica IAM.
5. Iterar sobre **cada nueva cuenta de servicio y crear un `JWT`** **objeto** para ella que est√© compuesto por las credenciales de la clave privada de la SA y un alcance de OAuth. El proceso de creaci√≥n de un nuevo objeto _JWT_ **iterar√° sobre todas las combinaciones existentes de alcances de OAuth** de la lista **oauth\_scopes.txt**, con el fin de encontrar todas las posibilidades de delegaci√≥n. La lista **oauth\_scopes.txt** se actualiza con todos los alcances de OAuth que hemos encontrado relevantes para abusar de las identidades de Workspace.
6. El m√©todo `_make_authorization_grant_assertion` revela la necesidad de declarar un **usuario de workspace objetivo**, referido como _subject_, para generar JWTs bajo DWD. Si bien esto puede parecer requerir un usuario espec√≠fico, es importante darse cuenta de que **DWD influye en cada identidad dentro de un dominio**. En consecuencia, crear un JWT para **cualquier usuario de dominio** afecta a todas las identidades en ese dominio, de acuerdo con nuestra verificaci√≥n de enumeraci√≥n de combinaciones. En pocas palabras, un usuario v√°lido de Workspace es suficiente para avanzar.\
Este usuario puede definirse en el archivo _config.yaml_ de DeleFriend. Si un usuario de workspace objetivo no se conoce ya, la herramienta facilita la identificaci√≥n autom√°tica de usuarios de workspace v√°lidos escaneando usuarios de dominio con roles en proyectos de GCP. Es clave notar (nuevamente) que los JWT son espec√≠ficos del dominio y no se generan para cada usuario; por lo tanto, el proceso autom√°tico se dirige a una √∫nica identidad √∫nica por dominio.
7. **Enumerar y crear un nuevo token de acceso portador** para cada JWT y validar el token contra la API de tokeninfo.

#### [Script de Python de Gitlab](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab ha creado [este script de Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) que puede hacer dos cosas: listar el directorio de usuarios y crear una nueva cuenta administrativa mientras indica un json con credenciales de SA y el usuario a suplantar. Aqu√≠ est√° c√≥mo lo usar√≠as:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Crear una nueva delegaci√≥n (Persistencia)

Es posible **ver las Delegaciones de Dominio Amplio en** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Un atacante con la capacidad de **crear cuentas de servicio en un proyecto de GCP** y **privilegios de superadministrador en GWS podr√≠a crear una nueva delegaci√≥n que permita a las cuentas de servicio suplantar a algunos usuarios de GWS:**

1. **Generaci√≥n de una nueva cuenta de servicio y su correspondiente par de claves:** En GCP, se pueden producir nuevos recursos de cuentas de servicio de forma interactiva a trav√©s de la consola o program√°ticamente utilizando llamadas a la API y herramientas de CLI directas. Esto requiere el **rol `iam.serviceAccountAdmin`** o cualquier rol personalizado equipado con el **permiso `iam.serviceAccounts.create`**. Una vez creada la cuenta de servicio, procederemos a generar un **par de claves relacionado** (**permiso `iam.serviceAccountKeys.create`**).
2. **Creaci√≥n de una nueva delegaci√≥n**: Es importante entender que **solo el rol de Super Administrador posee la capacidad de configurar delegaciones globales de Dominio Amplio en Google Workspace** y la delegaci√≥n de Dominio Amplio **no se puede configurar program√°ticamente,** solo puede ser creada y ajustada **manualmente** a trav√©s de la **consola** de Google Workspace.
* La creaci√≥n de la regla se puede encontrar en la p√°gina **Controles de API ‚Üí Administrar delegaci√≥n de Dominio Amplio en la consola de administraci√≥n de Google Workspace**.
3. **Adjuntando privilegios de √°mbitos de OAuth**: Al configurar una nueva delegaci√≥n, Google solo requiere 2 par√°metros, el ID de Cliente, que es el **ID de OAuth del recurso de Cuenta de Servicio de GCP**, y los **√°mbitos de OAuth** que definen qu√© llamadas a la API requiere la delegaci√≥n.
* La **lista completa de √°mbitos de OAuth** se puede encontrar [**aqu√≠**](https://developers.google.com/identity/protocols/oauth2/scopes), pero aqu√≠ hay una recomendaci√≥n: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Actuando en nombre de la identidad objetivo:** En este punto, tenemos un objeto delegado funcional en GWS. Ahora, **usando la clave privada de la Cuenta de Servicio de GCP, podemos realizar llamadas a la API** (en el √°mbito definido en el par√°metro de √°mbito de OAuth) para activarlo y **actuar en nombre de cualquier identidad que exista en Google Workspace**. Como aprendimos, la cuenta de servicio generar√° tokens de acceso seg√∫n sus necesidades y de acuerdo con los permisos que tiene para las aplicaciones de la API REST.
* Consulta la **secci√≥n anterior** para algunas **herramientas** para usar esta delegaci√≥n.

#### Delegaci√≥n entre organizaciones

El ID de SA de OAuth es global y se puede usar para **delegaci√≥n entre organizaciones**. No se ha implementado ninguna restricci√≥n para prevenir la delegaci√≥n cruzada global. En t√©rminos simples, **las cuentas de servicio de diferentes organizaciones de GCP se pueden usar para configurar delegaciones de dominio amplio en otras organizaciones de Workspace**. Esto resultar√≠a en **solo necesitar acceso de Super Administrador a Workspace**, y no acceso a la misma cuenta de GCP, ya que el adversario puede crear Cuentas de Servicio y claves privadas en su cuenta de GCP controlada personalmente.

### Creando un Proyecto para enumerar Workspace

Por **defecto**, los **usuarios** de Workspace tienen el permiso para **crear nuevos proyectos**, y cuando se crea un nuevo proyecto, el **creador obtiene el rol de Propietario** sobre √©l.

Por lo tanto, un usuario puede **crear un proyecto**, **habilitar** las **APIs** para enumerar Workspace en su nuevo proyecto y tratar de **enumerarlo**.

{% hint style="danger" %}
Para que un usuario pueda enumerar Workspace, tambi√©n necesita suficientes permisos de Workspace (no todos los usuarios podr√°n enumerar el directorio).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Verifique **m√°s enumeraci√≥n en**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Abusando de las credenciales de Gcloud

Puede encontrar m√°s informaci√≥n sobre el flujo de `gcloud` para iniciar sesi√≥n en:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Como se explic√≥ all√≠, gcloud puede solicitar el alcance **`https://www.googleapis.com/auth/drive`** que permitir√≠a a un usuario acceder al drive del usuario.\
Como atacante, si ha comprometido **f√≠sicamente** la computadora de un usuario y el **usuario a√∫n est√° conectado** con su cuenta, podr√≠a iniciar sesi√≥n generando un token con acceso al drive usando:
```bash
gcloud auth login --enable-gdrive-access
```
Si un atacante compromete la computadora de un usuario, tambi√©n podr√≠a modificar el archivo `google-cloud-sdk/lib/googlecloudsdk/core/config.py` y agregar en el **`CLOUDSDK_SCOPES`** el alcance **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Por lo tanto, la pr√≥xima vez que el usuario inicie sesi√≥n, crear√° un **token con acceso a drive** que el atacante podr√≠a abusar para acceder al drive. Obviamente, el navegador indicar√° que el token generado tendr√° acceso a drive, pero como el usuario se llamar√° a s√≠ mismo el **`gcloud auth login`**, probablemente **no sospechar√° nada.**

Para listar archivos de drive: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## De GWS a GCP

### Acceso a usuarios privilegiados de GCP

Si un atacante tiene acceso completo a GWS, podr√° acceder a grupos con acceso privilegiado a GCP o incluso a usuarios, por lo tanto, pasar de GWS a GCP suele ser m√°s "sencillo" solo porque **los usuarios en GWS tienen altos privilegios sobre GCP**.

### Escalaci√≥n de privilegios en Google Groups

Por defecto, los usuarios pueden **unirse libremente a los grupos de Workspace de la Organizaci√≥n** y esos grupos **pueden tener permisos de GCP** asignados (verifica tus grupos en [https://groups.google.com/](https://groups.google.com/)).

Abusando de la **escalaci√≥n de privilegios de google groups**, podr√≠as ser capaz de escalar a un grupo con alg√∫n tipo de acceso privilegiado a GCP.

### Referencias

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
