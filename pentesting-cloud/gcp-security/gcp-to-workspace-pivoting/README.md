# GCP <--> Workspace Pivoting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **From GCP to GWS**

### **Domain Wide Delegation basics**

Google Workspace se Domein-Wye delegasie laat 'n identiteit objek, hetsy 'n **eksterne app** van Google Workspace Marketplace of 'n interne **GCP Diensrekening**, toe om **data oor die Workspace namens gebruikers te verkry**.

{% hint style="info" %}
Dit beteken basies dat **diensrekeninge** binne GCP projekte van 'n organisasie dalk in staat is om **Workspace gebruikers** van dieselfde organisasie (of selfs van 'n ander) te **verpersoonlik**.
{% endhint %}

For more information about how this exactly works check:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Compromise existing delegation

As 'n aanvaller **toegang oor GCP gecompromitteer het** en **'n geldige Workspace gebruiker e-pos bekend is** (verkieslik **super admin**) van die maatskappy, kan hy **alle projekte** wat hy toegang het, **opnoem**, **alle SA's** van die projekte **opnoem**, kyk na watter **diensrekeninge hy toegang het**, en **herhaal** al hierdie stappe met elke SA wat hy kan verpersoonlik.\
Met 'n **lys van al die diensrekeninge** waartoe hy **toegang** het en die lys van **Workspace** **e-posse**, kan die aanvaller probeer om **gebruikers met elke diensrekening te verpersoonlik**.

{% hint style="danger" %}
Let daarop dat wanneer die domein wye delegasie gekonfigureer word, geen Workspace gebruiker benodig word nie, daarom is dit net nodig om **een geldige te h√™ wat genoeg is en vereis word vir die verpersoonliking**.\
Die **privileges van die verpersoonlikte gebruiker sal egter gebruik word**, so as dit Super Admin is, sal jy toegang tot alles h√™. As dit geen toegang het nie, sal dit nutteloos wees.
{% endhint %}

#### [GCP Generate Delegation Token](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

This simple script will **generate an OAuth token as the delegated user** that you can then use to access other Google APIs with or without `gcloud`:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Dit is 'n hulpmiddel wat die aanval kan uitvoer volgens die volgende stappe:

1. **Lys GCP-projekte** met behulp van die Resource Manager API.
2. Herhaal op elke projekbron, en **lys GCP-diensrekeningbronne** waartoe die aanvanklike IAM-gebruiker toegang het met behulp van _GetIAMPolicy_.
3. Herhaal op **elke diensrekeningrol**, en vind ingeboude, basiese, en pasgemaakte rolle met _**serviceAccountKeys.create**_ toestemming op die teiken diensrekeningbron. Dit moet opgemerk word dat die Editor-rol inherent hierdie toestemming het.
4. Skep 'n **nuwe `KEY_ALG_RSA_2048`** privaat sleutel vir elke diensrekeningbron wat met relevante toestemming in die IAM-beleid gevind word.
5. Herhaal op **elke nuwe diensrekening en skep 'n `JWT`** **objek** daarvoor wat bestaan uit die SA privaat sleutel akkrediteer en 'n OAuth-scope. Die proses om 'n nuwe _JWT_ objek te skep sal **herhaal op al die bestaande kombinasies van OAuth-scopes** van die **oauth\_scopes.txt** lys, ten einde al die delegasie moontlikhede te vind. Die lys **oauth\_scopes.txt** word opgedateer met al die OAuth-scopes wat ons relevant gevind het vir die misbruik van Workspace-identiteite.
6. Die `_make_authorization_grant_assertion` metode onthul die noodsaaklikheid om 'n t**eiken werkruimte gebruiker** te verklaar, verwys as _subject_, vir die generering van JWTs onder DWD. Terwyl dit mag lyk asof dit 'n spesifieke gebruiker vereis, is dit belangrik om te besef dat **DWD elke identiteit binne 'n domein be√Ønvloed**. Gevolglik, die skep van 'n JWT vir **enige domein gebruiker** be√Ønvloed al die identiteite in daardie domein, ooreenkomstig ons kombinasie lys kontrole. Eenvoudig gestel, een geldige Workspace-gebruiker is voldoende om vorentoe te beweeg.\
Hierdie gebruiker kan in DeleFriend se _config.yaml_ l√™er gedefinieer word. As 'n teiken werkruimte gebruiker nie reeds bekend is nie, fasiliteer die hulpmiddel die outomatiese identifikasie van geldige werkruimte gebruikers deur domein gebruikers met rolle op GCP projekte te skandeer. Dit is belangrik om (weer) op te let dat JWTs domein-spesifiek is en nie vir elke gebruiker gegenereer word nie; daarom, die outomatiese proses teiken 'n enkele unieke identiteit per domein.
7. **Lys en skep 'n nuwe draer toegangstoken** vir elke JWT en valideer die token teen die tokeninfo API.

#### [Gitlab se Python-skrip](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab het [hierdie Python-skrip](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) geskep wat twee dinge kan doen - lys die gebruikersgids en skep 'n nuwe administratiewe rekening terwyl dit 'n json met SA akkrediteer en die gebruiker om te verpersoonlik aandui. Hier is hoe jy dit sou gebruik:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Skep 'n nuwe delegasie (Volharding)

Dit is moontlik om **Domein Wye Delegasies in** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)** te kontroleer.**

'n Aanvaller met die vermo√´ om **diensrekeninge in 'n GCP-projek** te **skep en super admin voorregte in GWS** kan 'n nuwe delegasie skep wat SAs toelaat om as sommige GWS-gebruikers op te tree:

1. **Genereer 'n Nuwe Diensrekening en Ooreenstemmende Sleutel Paar:** Op GCP kan nuwe diensrekening hulpbronne interaktief via die konsole of programmaties met direkte API-oproepe en CLI-gereedskap geproduseer word. Dit vereis die **rol `iam.serviceAccountAdmin`** of enige pasgemaakte rol toegerus met die **`iam.serviceAccounts.create`** **toestemming**. Sodra die diensrekening geskep is, sal ons voortgaan om 'n **verwante sleutel paar** (**`iam.serviceAccountKeys.create`** toestemming) te genereer.
2. **Skep van 'n nuwe delegasie**: Dit is belangrik om te verstaan dat **slegs die Super Admin rol die vermo√´ het om globale Domein-Wye delegasie in Google Workspace op te stel** en Domein-Wye delegasie **kan nie programmaties opgestel word nie,** dit kan slegs **handmatig** deur die Google Workspace **konsole** geskep en aangepas word.
* Die skepping van die re√´l kan onder die bladsy **API kontroles ‚Üí Bestuur Domein-Wye delegasie in Google Workspace Admin konsole** gevind word.
3. **Hecht OAuth skope voorreg**: Wanneer 'n nuwe delegasie gekonfigureer word, vereis Google slegs 2 parameters, die Klient ID, wat die **OAuth ID van die GCP Diensrekening** hulpbron is, en **OAuth skope** wat definieer watter API-oproepe die delegasie benodig.
* Die **volledige lys van OAuth skope** kan [**hier**](https://developers.google.com/identity/protocols/oauth2/scopes) gevind word, maar hier is 'n aanbeveling: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Optree namens die teiken identiteit:** Op hierdie punt het ons 'n funksionerende gedelegeerde objek in GWS. Nou, **met die GCP Diensrekening private sleutel, kan ons API-oproepe uitvoer** (in die omvang gedefinieer in die OAuth skooparameter) om dit te aktiveer en **namens enige identiteit wat in Google Workspace bestaan op te tree**. Soos ons geleer het, sal die diensrekening toegangstokens genereer volgens sy behoeftes en volgens die toestemming wat hy het vir REST API-toepassings.
* Kontroleer die **vorige afdeling** vir 'n paar **gereedskap** om hierdie delegasie te gebruik.

#### Kruis-Organisatoriese delegasie

OAuth SA ID is globaal en kan gebruik word vir **kruis-organisatoriese delegasie**. Daar is geen beperking ge√Ømplementeer om kruis-globale delegasie te voorkom nie. In eenvoudige terme, **diensrekeninge van verskillende GCP-organisasies kan gebruik word om domein-wye delegasie op ander Workspace-organisasies te konfigureer**. Dit sou beteken dat **slegs Super Admin toegang tot Workspace** benodig word, en nie toegang tot dieselfde GCP-rekening nie, aangesien die teenstander diensrekeninge en private sleutels op sy persoonlik beheer GCP-rekening kan skep.

### Skep 'n Projek om Workspace te evalueer

Deur **standaard** het Workspace **gebruikers** die toestemming om **nuwe projekte te skep**, en wanneer 'n nuwe projek geskep word, ontvang die **skepper die Eienaar rol** oor dit.

Daarom kan 'n gebruiker **'n projek skep**, **die** **API's** aktiveer om Workspace in sy nuwe projek te evalueer en probeer om dit te **evalueer**.

{% hint style="danger" %}
Om 'n gebruiker in staat te stel om Workspace te evalueer, benodig hy ook genoeg Workspace toestemming (nie elke gebruiker sal in staat wees om die gids te evalueer nie).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Kontroleer **meer enumerasie in**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Misbruik van Gcloud geloofsbriewe

U kan verdere inligting oor die `gcloud` vloei om aan te meld vind in:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Soos daar verduidelik, kan gcloud die omvang **`https://www.googleapis.com/auth/drive`** aanvra wat 'n gebruiker in staat sou stel om toegang tot die gebruiker se skyf te verkry.\
As 'n aanvaller, as u **fisies** die rekenaar van 'n gebruiker gecompromitteer het en die **gebruiker is steeds aangemeld** met sy rekening, kan u aanmeld deur 'n token met toegang tot die skyf te genereer met:
```bash
gcloud auth login --enable-gdrive-access
```
If an attacker compromises the computer of a user he could also modify the file `google-cloud-sdk/lib/googlecloudsdk/core/config.py` and add in the **`CLOUDSDK_SCOPES`** the scope **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Daarom, die volgende keer wanneer die gebruiker aanmeld, sal hy 'n **token met toegang tot drive** skep wat die aanvaller kan misbruik om toegang tot die drive te verkry. Dit is duidelik dat die blaaier sal aandui dat die gegenereerde token toegang tot drive sal h√™, maar aangesien die gebruiker homself die **`gcloud auth login`** sal noem, sal hy waarskynlik **niks vermoed nie.**

Om drive l√™ers te lys: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## From GWS to GCP

### Access privileged GCP users

As 'n aanvaller volledige toegang oor GWS het, sal hy in staat wees om toegang te verkry tot groepe met privaat toegang oor GCP of selfs gebruikers, daarom is dit gewoonlik "eenvoudiger" om van GWS na GCP te beweeg net omdat **gebruikers in GWS ho√´ privaathede oor GCP het**.

### Google Groups Privilege Escalation

Standaard kan gebruikers **vrylik by Workspace groepe van die Organisasie aansluit** en daardie groepe **kan GCP toestemmings** toegeken h√™ (kyk jou groepe in [https://groups.google.com/](https://groups.google.com/)).

Deur die **google groups privesc** te misbruik, mag jy in staat wees om op te skaal na 'n groep met 'n soort privaat toegang tot GCP.

### References

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
