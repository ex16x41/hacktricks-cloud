# GCP <--> Workspace Pivoting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **From GCP to GWS**

### **Domain Wide Delegation basics**

Google Workspaceì˜ ë„ë©”ì¸ ì „ì²´ ìœ„ì„ì€ **Google Workspace Marketplace**ì˜ **ì™¸ë¶€ ì•±** ë˜ëŠ” ë‚´ë¶€ **GCP ì„œë¹„ìŠ¤ ê³„ì •**ê³¼ ê°™ì€ ì‹ ì› ê°ì²´ê°€ **ì‚¬ìš©ìë¥¼ ëŒ€ì‹ í•˜ì—¬ Workspace ì „ë°˜ì˜ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡** í—ˆìš©í•©ë‹ˆë‹¤.

{% hint style="info" %}
ì´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **ì¡°ì§ì˜ GCP í”„ë¡œì íŠ¸ ë‚´ ì„œë¹„ìŠ¤ ê³„ì •**ì´ **ë™ì¼ ì¡°ì§ì˜ Workspace ì‚¬ìš©ì**(ë˜ëŠ” ë‹¤ë¥¸ ì¡°ì§ì˜ ì‚¬ìš©ì)ë¥¼ **ê°€ì¥í•  ìˆ˜ ìˆì„** ê°€ëŠ¥ì„±ì´ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
{% endhint %}

ì´ê²ƒì´ ì •í™•íˆ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ì— ëŒ€í•œ ë” ë§ì€ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Compromise existing delegation

ê³µê²©ìê°€ **GCPì— ëŒ€í•œ ì¼ë¶€ ì ‘ê·¼ì„ íƒ€í˜‘í•˜ê³ ** íšŒì‚¬ì˜ **ìœ íš¨í•œ Workspace ì‚¬ìš©ì ì´ë©”ì¼**(ê°€ëŠ¥í•˜ë©´ **ìŠˆí¼ ê´€ë¦¬ì**)ì„ **ì•Œê³  ìˆë‹¤ë©´**, ê·¸ëŠ” **ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ëª¨ë“  í”„ë¡œì íŠ¸ë¥¼ ë‚˜ì—´í•˜ê³ **, **í”„ë¡œì íŠ¸ì˜ ëª¨ë“  SAë¥¼ ë‚˜ì—´í•˜ë©°**, **ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì •ì„ í™•ì¸í•˜ê³ **, **ê°€ì¥í•  ìˆ˜ ìˆëŠ” ê° SAë¡œ ì´ ëª¨ë“  ë‹¨ê³„ë¥¼ ë°˜ë³µ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê·¸ê°€ **ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ì„œë¹„ìŠ¤ ê³„ì •ì˜ ëª©ë¡**ê³¼ **Workspace ì´ë©”ì¼** ëª©ë¡ì„ ê°€ì§€ê³  ìˆë‹¤ë©´, ê³µê²©ìëŠ” **ê° ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ ì‚¬ìš©ìë¥¼ ê°€ì¥í•˜ë ¤ê³  ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

{% hint style="danger" %}
ë„ë©”ì¸ ì „ì²´ ìœ„ì„ì„ êµ¬ì„±í•  ë•Œ Workspace ì‚¬ìš©ìê°€ í•„ìš”í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, **ìœ íš¨í•œ ì‚¬ìš©ì í•˜ë‚˜ë§Œ ì•Œë©´ ê°€ì¥í•˜ëŠ” ë° ì¶©ë¶„í•˜ê³  í•„ìš”í•©ë‹ˆë‹¤**.\
ê·¸ëŸ¬ë‚˜ **ê°€ì¥í•œ ì‚¬ìš©ìì˜ ê¶Œí•œì´ ì‚¬ìš©ë˜ë¯€ë¡œ**, ë§Œì•½ ìŠˆí¼ ê´€ë¦¬ìë¼ë©´ ëª¨ë“  ê²ƒì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ‘ê·¼ ê¶Œí•œì´ ì—†ë‹¤ë©´ ì´ëŠ” ë¬´ì˜ë¯¸í•  ê²ƒì…ë‹ˆë‹¤.
{% endhint %}

#### [GCP Generate Delegation Token](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

ì´ ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸ëŠ” **ìœ„ì„ëœ ì‚¬ìš©ìë¡œì„œ OAuth í† í°ì„ ìƒì„±**í•˜ë©°, ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ `gcloud` ìœ ë¬´ì— ê´€ê³„ì—†ì´ ë‹¤ë¥¸ Google APIì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

ì´ ë„êµ¬ëŠ” ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¼ ê³µê²©ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. **ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ì API**ë¥¼ ì‚¬ìš©í•˜ì—¬ GCP í”„ë¡œì íŠ¸ë¥¼ ë‚˜ì—´í•©ë‹ˆë‹¤.
2. ê° í”„ë¡œì íŠ¸ ë¦¬ì†ŒìŠ¤ë¥¼ ë°˜ë³µí•˜ê³ , ì´ˆê¸° IAM ì‚¬ìš©ìê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” **GCP ì„œë¹„ìŠ¤ ê³„ì • ë¦¬ì†ŒìŠ¤**ë¥¼ _GetIAMPolicy_ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚˜ì—´í•©ë‹ˆë‹¤.
3. **ê° ì„œë¹„ìŠ¤ ê³„ì • ì—­í• **ì„ ë°˜ë³µí•˜ê³ , ëŒ€ìƒ ì„œë¹„ìŠ¤ ê³„ì • ë¦¬ì†ŒìŠ¤ì—ì„œ _**serviceAccountKeys.create**_ ê¶Œí•œì„ ê°€ì§„ ë‚´ì¥, ê¸°ë³¸ ë° ì‚¬ìš©ì ì •ì˜ ì—­í• ì„ ì°¾ìŠµë‹ˆë‹¤. í¸ì§‘ì ì—­í• ì€ ë³¸ì§ˆì ìœ¼ë¡œ ì´ ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ëŠ” ì ì— ìœ ì˜í•´ì•¼ í•©ë‹ˆë‹¤.
4. IAM ì •ì±…ì—ì„œ ê´€ë ¨ ê¶Œí•œì´ ë°œê²¬ëœ ê° ì„œë¹„ìŠ¤ ê³„ì • ë¦¬ì†ŒìŠ¤ì— ëŒ€í•´ **ìƒˆ `KEY_ALG_RSA_2048`** ê°œì¸ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
5. **ê° ìƒˆ ì„œë¹„ìŠ¤ ê³„ì •ì— ëŒ€í•´ `JWT`** **ê°ì²´**ë¥¼ ìƒì„±í•˜ëŠ”ë°, ì´ëŠ” SA ê°œì¸ í‚¤ ìê²© ì¦ëª…ê³¼ OAuth ë²”ìœ„ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. ìƒˆ _JWT_ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ê³¼ì •ì€ **oauth\_scopes.txt** ëª©ë¡ì˜ ëª¨ë“  ê¸°ì¡´ OAuth ë²”ìœ„ ì¡°í•©ì„ ë°˜ë³µí•˜ì—¬ ëª¨ë“  ìœ„ì„ ê°€ëŠ¥ì„±ì„ ì°¾ìŠµë‹ˆë‹¤. ëª©ë¡ **oauth\_scopes.txt**ëŠ” Workspace IDë¥¼ ì•…ìš©í•˜ëŠ” ë° ê´€ë ¨ëœ ëª¨ë“  OAuth ë²”ìœ„ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
6. `_make_authorization_grant_assertion` ë©”ì„œë“œëŠ” DWD í•˜ì— JWTë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ _subject_ë¼ê³  í•˜ëŠ” **ëŒ€ìƒ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì‚¬ìš©ì**ë¥¼ ì„ ì–¸í•´ì•¼ í•¨ì„ ë“œëŸ¬ëƒ…ë‹ˆë‹¤. íŠ¹ì • ì‚¬ìš©ìê°€ í•„ìš”í•  ê²ƒì²˜ëŸ¼ ë³´ì¼ ìˆ˜ ìˆì§€ë§Œ, **DWDëŠ” ë„ë©”ì¸ ë‚´ ëª¨ë“  IDì— ì˜í–¥ì„ ë¯¸ì¹œë‹¤ëŠ” ì ì„ ì¸ì‹í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤**. ë”°ë¼ì„œ **ë„ë©”ì¸ ì‚¬ìš©ì**ì— ëŒ€í•œ JWTë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì€ í•´ë‹¹ ë„ë©”ì¸ì˜ ëª¨ë“  IDì— ì˜í–¥ì„ ë¯¸ì¹˜ë©°, ì´ëŠ” ìš°ë¦¬ì˜ ì¡°í•© ë‚˜ì—´ í™•ì¸ê³¼ ì¼ì¹˜í•©ë‹ˆë‹¤. ê°„ë‹¨íˆ ë§í•´, ìœ íš¨í•œ Workspace ì‚¬ìš©ì í•˜ë‚˜ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.\
ì´ ì‚¬ìš©ìëŠ” DeleFriendì˜ _config.yaml_ íŒŒì¼ì—ì„œ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëŒ€ìƒ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì‚¬ìš©ìê°€ ì´ë¯¸ ì•Œë ¤ì ¸ ìˆì§€ ì•Šì€ ê²½ìš°, ì´ ë„êµ¬ëŠ” GCP í”„ë¡œì íŠ¸ì—ì„œ ì—­í• ì„ ê°€ì§„ ë„ë©”ì¸ ì‚¬ìš©ìë¥¼ ìŠ¤ìº”í•˜ì—¬ ìœ íš¨í•œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì‚¬ìš©ìë¥¼ ìë™ìœ¼ë¡œ ì‹ë³„í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ë‹¤ì‹œ ë§í•˜ì§€ë§Œ, JWTëŠ” ë„ë©”ì¸ íŠ¹ì •ì´ë©° ëª¨ë“  ì‚¬ìš©ìì— ëŒ€í•´ ìƒì„±ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ìë™ í”„ë¡œì„¸ìŠ¤ëŠ” ë„ë©”ì¸ë‹¹ ë‹¨ì¼ ê³ ìœ  IDë¥¼ ëŒ€ìƒìœ¼ë¡œ í•©ë‹ˆë‹¤.
7. **ê° JWTì— ëŒ€í•´ ìƒˆë¡œìš´ ë² ì–´ëŸ¬ ì•¡ì„¸ìŠ¤ í† í°ì„ ë‚˜ì—´í•˜ê³  ìƒì„±**í•˜ë©°, tokeninfo APIì— ëŒ€í•´ í† í°ì„ ê²€ì¦í•©ë‹ˆë‹¤.

#### [Gitlabì˜ Python ìŠ¤í¬ë¦½íŠ¸](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlabì€ [ì´ Python ìŠ¤í¬ë¦½íŠ¸](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py)ë¥¼ ë§Œë“¤ì–´ ë‘ ê°€ì§€ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ - ì‚¬ìš©ì ë””ë ‰í† ë¦¬ë¥¼ ë‚˜ì—´í•˜ê³  SA ìê²© ì¦ëª…ê³¼ ê°€ì¥í•  ì‚¬ìš©ìë¥¼ ë‚˜íƒ€ë‚´ëŠ” jsonì„ ì§€ì •í•˜ë©´ì„œ ìƒˆ ê´€ë¦¬ ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤. ì‚¬ìš© ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### ìƒˆ ìœ„ì„ ìƒì„± (ì§€ì†ì„±)

**[**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**ì—ì„œ ë„ë©”ì¸ ì „ì²´ ìœ„ì„ì„ **í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

GCP í”„ë¡œì íŠ¸ì—ì„œ **ì„œë¹„ìŠ¤ ê³„ì •ì„ ìƒì„±í•  ìˆ˜ ìˆëŠ”** ê³µê²©ìì™€ GWSì— ëŒ€í•œ **ìŠˆí¼ ê´€ë¦¬ì ê¶Œí•œ**ì„ ê°€ì§„ ê³µê²©ìëŠ” SAsê°€ ì¼ë¶€ GWS ì‚¬ìš©ìë¥¼ ê°€ì¥í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ìƒˆë¡œìš´ ìœ„ì„ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. **ìƒˆ ì„œë¹„ìŠ¤ ê³„ì • ë° í•´ë‹¹ í‚¤ ìŒ ìƒì„±:** GCPì—ì„œ ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ ê³„ì • ë¦¬ì†ŒìŠ¤ëŠ” ì½˜ì†”ì„ í†µí•´ ëŒ€í™”ì‹ìœ¼ë¡œ ë˜ëŠ” ì§ì ‘ API í˜¸ì¶œ ë° CLI ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œê·¸ë˜ë° ë°©ì‹ìœ¼ë¡œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **`iam.serviceAccountAdmin`** ì—­í•  ë˜ëŠ” **`iam.serviceAccounts.create`** **ê¶Œí•œ**ì´ ìˆëŠ” ì‚¬ìš©ì ì •ì˜ ì—­í• ì´ í•„ìš”í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ ê³„ì •ì´ ìƒì„±ë˜ë©´ **ê´€ë ¨ í‚¤ ìŒ**ì„ ìƒì„±í•˜ëŠ” ë‹¨ê³„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤ (**`iam.serviceAccountKeys.create`** ê¶Œí•œ).
2. **ìƒˆ ìœ„ì„ ìƒì„±:** **Google Workspaceì—ì„œ ì „ì—­ ë„ë©”ì¸ ì „ì²´ ìœ„ì„ì„ ì„¤ì •í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì€ ì˜¤ì§ ìŠˆí¼ ê´€ë¦¬ì ì—­í• ë§Œì´ ê°€ì§€ê³  ìˆë‹¤ëŠ” ì ì„ ì´í•´í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.** ë„ë©”ì¸ ì „ì²´ ìœ„ì„ì€ **í”„ë¡œê·¸ë˜ë° ë°©ì‹ìœ¼ë¡œ ì„¤ì •í•  ìˆ˜ ì—†ìœ¼ë©°,** Google Workspace **ì½˜ì†”**ì„ í†µí•´ **ìˆ˜ë™ìœ¼ë¡œ** ìƒì„± ë° ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ê·œì¹™ ìƒì„±ì€ **API ì œì–´ â†’ Google Workspace ê´€ë¦¬ ì½˜ì†”ì—ì„œ ë„ë©”ì¸ ì „ì²´ ìœ„ì„ ê´€ë¦¬** í˜ì´ì§€ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. **OAuth ë²”ìœ„ ê¶Œí•œ ë¶€ì—¬:** ìƒˆ ìœ„ì„ì„ êµ¬ì„±í•  ë•Œ Googleì€ í´ë¼ì´ì–¸íŠ¸ ID, ì¦‰ **GCP ì„œë¹„ìŠ¤ ê³„ì •** ë¦¬ì†ŒìŠ¤ì˜ **OAuth ID**ì™€ ìœ„ì„ì´ ìš”êµ¬í•˜ëŠ” API í˜¸ì¶œì„ ì •ì˜í•˜ëŠ” **OAuth ë²”ìœ„**ë¼ëŠ” ë‘ ê°€ì§€ ë§¤ê°œë³€ìˆ˜ë§Œ í•„ìš”í•©ë‹ˆë‹¤.
* **OAuth ë²”ìœ„ì˜ ì „ì²´ ëª©ë¡**ì€ [**ì—¬ê¸°**](https://developers.google.com/identity/protocols/oauth2/scopes)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆì§€ë§Œ, ë‹¤ìŒê³¼ ê°™ì€ ì¶”ì²œì´ ìˆìŠµë‹ˆë‹¤: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **ëŒ€ìƒ ì‹ ì›ì„ ëŒ€ì‹ í•˜ì—¬ í–‰ë™í•˜ê¸°:** ì´ ì‹œì ì—ì„œ ìš°ë¦¬ëŠ” GWSì—ì„œ ì‘ë™í•˜ëŠ” ìœ„ì„ëœ ê°ì²´ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì´ì œ **GCP ì„œë¹„ìŠ¤ ê³„ì • ê°œì¸ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ API í˜¸ì¶œì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤** (OAuth ë²”ìœ„ ë§¤ê°œë³€ìˆ˜ì— ì •ì˜ëœ ë²”ìœ„ ë‚´ì—ì„œ) ì´ë¥¼ íŠ¸ë¦¬ê±°í•˜ê³  **Google Workspaceì— ì¡´ì¬í•˜ëŠ” ëª¨ë“  ì‹ ì›ì„ ëŒ€ì‹ í•˜ì—¬ í–‰ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.** ì„œë¹„ìŠ¤ ê³„ì •ì€ í•„ìš”ì— ë”°ë¼ REST API ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•œ ê¶Œí•œì— ë”°ë¼ ì•¡ì„¸ìŠ¤ í† í°ì„ ìƒì„±í•©ë‹ˆë‹¤.
* ì´ ìœ„ì„ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ **ë„êµ¬**ëŠ” **ì´ì „ ì„¹ì…˜**ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤.

#### êµì°¨ ì¡°ì§ ìœ„ì„

OAuth SA IDëŠ” ì „ì—­ì ì´ë©° **êµì°¨ ì¡°ì§ ìœ„ì„**ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. êµì°¨ ê¸€ë¡œë²Œ ìœ„ì„ì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ì œí•œì´ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê°„ë‹¨íˆ ë§í•´, **ë‹¤ë¥¸ GCP ì¡°ì§ì˜ ì„œë¹„ìŠ¤ ê³„ì •ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ Workspace ì¡°ì§ì—ì„œ ë„ë©”ì¸ ì „ì²´ ìœ„ì„ì„ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.** ì´ëŠ” **Workspaceì— ëŒ€í•œ ìŠˆí¼ ê´€ë¦¬ì ì•¡ì„¸ìŠ¤ë§Œ í•„ìš”í•˜ê³ , ë™ì¼í•œ GCP ê³„ì •ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ëŠ” í•„ìš”í•˜ì§€ ì•Šìœ¼ë©°, ì ëŒ€ìëŠ” ê°œì¸ì ìœ¼ë¡œ ì œì–´í•˜ëŠ” GCP ê³„ì •ì—ì„œ ì„œë¹„ìŠ¤ ê³„ì • ë° ê°œì¸ í‚¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

### Workspaceë¥¼ ì—´ê±°í•˜ê¸° ìœ„í•œ í”„ë¡œì íŠ¸ ìƒì„±

**ê¸°ë³¸ì ìœ¼ë¡œ** Workspace **ì‚¬ìš©ìëŠ”** **ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ**ì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ìƒˆ í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ë©´ **ìƒì„±ìëŠ” í•´ë‹¹ í”„ë¡œì íŠ¸ì— ëŒ€í•œ ì†Œìœ ì ì—­í• ì„ ë¶€ì—¬ë°›ìŠµë‹ˆë‹¤.**

ë”°ë¼ì„œ ì‚¬ìš©ìëŠ” **í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ê³ **, **APIë¥¼ í™œì„±í™”í•˜ì—¬** ìƒˆ í”„ë¡œì íŠ¸ì—ì„œ Workspaceë¥¼ ì—´ê±°í•˜ê³  **ì—´ê±°**í•˜ë ¤ê³  ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="danger" %}
ì‚¬ìš©ìê°€ Workspaceë¥¼ ì—´ê±°í•  ìˆ˜ ìˆìœ¼ë ¤ë©´ ì¶©ë¶„í•œ Workspace ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤ (ëª¨ë“  ì‚¬ìš©ìê°€ ë””ë ‰í† ë¦¬ë¥¼ ì—´ê±°í•  ìˆ˜ ìˆëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Check **ë” ë§ì€ ì—´ê±°ëŠ”**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Gcloud ìê²© ì¦ëª… ì•…ìš©

`gcloud` ë¡œê·¸ì¸ íë¦„ì— ëŒ€í•œ ì¶”ê°€ ì •ë³´ëŠ” ë‹¤ìŒì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

ê±°ê¸°ì—ì„œ ì„¤ëª…í•œ ë°”ì™€ ê°™ì´, gcloudëŠ” ì‚¬ìš©ìê°€ ìì‹ ì˜ ë“œë¼ì´ë¸Œì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” **`https://www.googleapis.com/auth/drive`** ë²”ìœ„ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê³µê²©ìë¡œì„œ, ì‚¬ìš©ìì˜ ì»´í“¨í„°ë¥¼ **ë¬¼ë¦¬ì ìœ¼ë¡œ** ì¹¨í•´í•˜ê³  **ì‚¬ìš©ìê°€ ì—¬ì „íˆ** ìì‹ ì˜ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•œ ìƒíƒœë¼ë©´, ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ ë“œë¼ì´ë¸Œì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” í† í°ì„ ìƒì„±í•˜ì—¬ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
gcloud auth login --enable-gdrive-access
```
If an attacker compromises the computer of a user he could also modify the file `google-cloud-sdk/lib/googlecloudsdk/core/config.py` and add in the **`CLOUDSDK_SCOPES`** the scope **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
ë”°ë¼ì„œ ì‚¬ìš©ìê°€ ë‹¤ìŒì— ë¡œê·¸ì¸í•  ë•Œ ê³µê²©ìê°€ ë“œë¼ì´ë¸Œì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” **í† í°ì„ ìƒì„±**í•˜ê²Œ ë©ë‹ˆë‹¤. ë¬¼ë¡  ë¸Œë¼ìš°ì €ëŠ” ìƒì„±ëœ í† í°ì´ ë“œë¼ì´ë¸Œì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤ê³  í‘œì‹œí•˜ì§€ë§Œ, ì‚¬ìš©ìê°€ **`gcloud auth login`**ì„ í˜¸ì¶œí•˜ê¸° ë•Œë¬¸ì— ì•„ë§ˆë„ **ì˜ì‹¬í•˜ì§€ ì•Šì„ ê²ƒì…ë‹ˆë‹¤.**

ë“œë¼ì´ë¸Œ íŒŒì¼ì„ ë‚˜ì—´í•˜ë ¤ë©´: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## From GWS to GCP

### Access privileged GCP users

ê³µê²©ìê°€ GWSì— ì™„ì „í•œ ì ‘ê·¼ ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´ GCPì— ëŒ€í•œ ê¶Œí•œì´ ìˆëŠ” ê·¸ë£¹ì´ë‚˜ ì‚¬ìš©ìì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ GWSì—ì„œ GCPë¡œ ì´ë™í•˜ëŠ” ê²ƒì€ ì¼ë°˜ì ìœ¼ë¡œ **GWSì˜ ì‚¬ìš©ìë“¤ì´ GCPì— ëŒ€í•´ ë†’ì€ ê¶Œí•œì„ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì—** ë” "ê°„ë‹¨"í•©ë‹ˆë‹¤.

### Google Groups Privilege Escalation

ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©ìëŠ” **ì¡°ì§ì˜ Workspace ê·¸ë£¹ì— ììœ ë¡­ê²Œ ê°€ì…í•  ìˆ˜ ìˆìœ¼ë©°** ì´ëŸ¬í•œ ê·¸ë£¹ì€ **GCP ê¶Œí•œ**ì´ ë¶€ì—¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ìì‹ ì˜ ê·¸ë£¹ì„ [https://groups.google.com/](https://groups.google.com/)ì—ì„œ í™•ì¸í•˜ì„¸ìš”).

**google groups privesc**ë¥¼ ì•…ìš©í•˜ë©´ GCPì— ëŒ€í•œ ì–´ë–¤ í˜•íƒœì˜ ê¶Œí•œì´ ìˆëŠ” ê·¸ë£¹ìœ¼ë¡œ ìƒìŠ¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### References

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
