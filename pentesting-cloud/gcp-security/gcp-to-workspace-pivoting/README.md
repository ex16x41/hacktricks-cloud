# GCP <--> Workspace Pivoting

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## **Von GCP zu GWS**

### **Grundlagen der dom√§nenweiten Delegation**

Die dom√§nenweite Delegation von Google Workspace erm√∂glicht es einem Identit√§tsobjekt, entweder einer **externen App** aus dem Google Workspace Marketplace oder einem internen **GCP-Dienstkonto**, **Daten im gesamten Workspace im Namen von Benutzern zuzugreifen**.

{% hint style="info" %}
Das bedeutet im Grunde, dass **Dienstkonten** innerhalb von GCP-Projekten einer Organisation in der Lage sein k√∂nnten, **Workspace-Benutzer** derselben Organisation (oder sogar einer anderen) zu **imitieren**.
{% endhint %}

F√ºr weitere Informationen dar√ºber, wie dies genau funktioniert, siehe:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Kompromittierung bestehender Delegation

Wenn ein Angreifer **Zugriff √ºber GCP kompromittiert hat** und **eine g√ºltige Workspace-Benutzer-E-Mail** (vorzugsweise **Super Admin**) des Unternehmens kennt, k√∂nnte er **alle Projekte auflisten**, auf die er Zugriff hat, **alle SAs** der Projekte auflisten, √ºberpr√ºfen, auf welche **Dienstkonten er Zugriff hat**, und **alle diese Schritte mit jedem SA wiederholen, den er imitieren kann**.\
Mit einer **Liste aller Dienstkonten**, auf die er **Zugriff** hat, und der Liste der **Workspace** **E-Mails** k√∂nnte der Angreifer versuchen, **Benutzer mit jedem Dienstkonto zu imitieren**.

{% hint style="danger" %}
Beachte, dass bei der Konfiguration der dom√§nenweiten Delegation kein Workspace-Benutzer ben√∂tigt wird, daher reicht es aus, **einen g√ºltigen zu kennen und f√ºr die Imitation erforderlich ist**.\
Die **Befugnisse des imitierten Benutzers werden jedoch verwendet**, also wenn es ein Super Admin ist, wirst du Zugriff auf alles haben. Wenn es keinen Zugriff hat, wird dies nutzlos sein.
{% endhint %}

#### [GCP Generiere Delegationstoken](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Dieses einfache Skript wird **ein OAuth-Token als der delegierte Benutzer generieren**, das du dann verwenden kannst, um auf andere Google APIs mit oder ohne `gcloud` zuzugreifen:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Dies ist ein Tool, das den Angriff nach diesen Schritten durchf√ºhren kann:

1. **GCP-Projekte auflisten** mit der Resource Manager API.
2. Iteriere √ºber jede Projektressource und **enumerate GCP-Dienstkontenressourcen**, auf die der urspr√ºngliche IAM-Benutzer Zugriff hat, unter Verwendung von _GetIAMPolicy_.
3. Iteriere √ºber **jede Dienstkontenrolle** und finde integrierte, grundlegende und benutzerdefinierte Rollen mit der Berechtigung _**serviceAccountKeys.create**_ auf der Ziel-Dienstkontenressource. Es sollte beachtet werden, dass die Editor-Rolle diese Berechtigung von Natur aus besitzt.
4. Erstelle einen **neuen `KEY_ALG_RSA_2048`** privaten Schl√ºssel f√ºr jede Dienstkontenressource, die mit der relevanten Berechtigung in der IAM-Richtlinie gefunden wurde.
5. Iteriere √ºber **jedes neue Dienstkonto und erstelle ein `JWT`** **Objekt** daf√ºr, das aus den SA-Privatschl√ºssel-Anmeldeinformationen und einem OAuth-Bereich besteht. Der Prozess zur Erstellung eines neuen _JWT_ Objekts wird **alle bestehenden Kombinationen von OAuth-Bereichen** aus der **oauth\_scopes.txt** Liste durchlaufen, um alle Delegationsm√∂glichkeiten zu finden. Die Liste **oauth\_scopes.txt** wird mit allen OAuth-Bereichen aktualisiert, die wir als relevant f√ºr den Missbrauch von Workspace-Identit√§ten erachtet haben.
6. Die Methode `_make_authorization_grant_assertion` zeigt die Notwendigkeit an, einen **Ziel-Workspace-Benutzer** zu deklarieren, der als _subject_ bezeichnet wird, um JWTs unter DWD zu generieren. Auch wenn dies einen bestimmten Benutzer zu erfordern scheint, ist es wichtig zu erkennen, dass **DWD jede Identit√§t innerhalb einer Domain beeinflusst**. Folglich hat die Erstellung eines JWT f√ºr **jeden Domainbenutzer** Auswirkungen auf alle Identit√§ten in dieser Domain, was mit unserer Kombinationen-Enumeration-√úberpr√ºfung √ºbereinstimmt. Einfach ausgedr√ºckt, ein g√ºltiger Workspace-Benutzer reicht aus, um fortzufahren.\
Dieser Benutzer kann in DeleFriend‚Äôs _config.yaml_ Datei definiert werden. Wenn ein Ziel-Workspace-Benutzer noch nicht bekannt ist, erleichtert das Tool die automatische Identifizierung g√ºltiger Workspace-Benutzer, indem es Domainbenutzer mit Rollen auf GCP-Projekten scannt. Es ist wichtig zu beachten (nochmals), dass JWTs domainspezifisch sind und nicht f√ºr jeden Benutzer generiert werden; daher zielt der automatische Prozess auf eine einzige eindeutige Identit√§t pro Domain ab.
7. **Enumerate und erstelle ein neues Bearer-Zugriffstoken** f√ºr jedes JWT und validiere das Token gegen die tokeninfo API.

#### [Gitlabs Python-Skript](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab hat [dieses Python-Skript](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) erstellt, das zwei Dinge tun kann - das Benutzerverzeichnis auflisten und ein neues Administratorkonto erstellen, w√§hrend es ein JSON mit SA-Anmeldeinformationen und dem Benutzer angibt, den man nachahmen m√∂chte. Hier ist, wie du es verwenden w√ºrdest:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Erstellen einer neuen Delegation (Persistenz)

Es ist m√∂glich, **Domain Wide Delegations in** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)** zu √ºberpr√ºfen.**

Ein Angreifer mit der F√§higkeit, **Dienstkonten in einem GCP-Projekt zu erstellen** und **Super-Admin-Rechten f√ºr GWS k√∂nnte eine neue Delegation erstellen, die es SAs erm√∂glicht, einige GWS-Benutzer zu impersonieren:**

1. **Generierung eines neuen Dienstkontos und des entsprechenden Schl√ºsselpaares:** In GCP k√∂nnen neue Dienstkonto-Ressourcen entweder interaktiv √ºber die Konsole oder programmgesteuert mithilfe direkter API-Aufrufe und CLI-Tools erstellt werden. Dies erfordert die **Rolle `iam.serviceAccountAdmin`** oder eine benutzerdefinierte Rolle, die mit der **`iam.serviceAccounts.create`** **Berechtigung** ausgestattet ist. Sobald das Dienstkonto erstellt ist, fahren wir fort, ein **verwandtes Schl√ºsselpaar** zu generieren (**`iam.serviceAccountKeys.create`** Berechtigung).
2. **Erstellung einer neuen Delegation**: Es ist wichtig zu verstehen, dass **nur die Super-Admin-Rolle die F√§higkeit hat, globale Domain-Wide-Delegationen in Google Workspace einzurichten** und dass Domain-Wide-Delegationen **nicht programmgesteuert eingerichtet werden k√∂nnen.** Sie kann nur **manuell** √ºber die Google Workspace **Konsole** erstellt und angepasst werden.
* Die Erstellung der Regel kann auf der Seite **API-Kontrollen ‚Üí Domain-Wide-Delegation in der Google Workspace Admin-Konsole verwalten** gefunden werden.
3. **Anf√ºgen von OAuth-Scopes-Berechtigungen**: Bei der Konfiguration einer neuen Delegation ben√∂tigt Google nur 2 Parameter, die Client-ID, die die **OAuth-ID der GCP-Dienstkonto-Ressource** ist, und **OAuth-Scopes**, die definieren, welche API-Aufrufe die Delegation ben√∂tigt.
* Die **vollst√§ndige Liste der OAuth-Scopes** kann [**hier**](https://developers.google.com/identity/protocols/oauth2/scopes) gefunden werden, aber hier ist eine Empfehlung: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Im Namen der Zielidentit√§t handeln:** An diesem Punkt haben wir ein funktionierendes delegiertes Objekt in GWS. Jetzt k√∂nnen wir **mit dem privaten Schl√ºssel des GCP-Dienstkontos API-Aufrufe durchf√ºhren** (im Bereich, der im OAuth-Scopes-Parameter definiert ist), um es auszul√∂sen und **im Namen jeder Identit√§t zu handeln, die in Google Workspace existiert**. Wie wir gelernt haben, generiert das Dienstkonto Zugriffstoken nach Bedarf und gem√§√ü den Berechtigungen, die es f√ºr REST-API-Anwendungen hat.
* √úberpr√ºfen Sie den **vorherigen Abschnitt** f√ºr einige **Tools**, um diese Delegation zu nutzen.

#### Cross-Organizational Delegation

Die OAuth SA-ID ist global und kann f√ºr **Cross-Organizational Delegation** verwendet werden. Es wurden keine Einschr√§nkungen implementiert, um eine cross-global Delegation zu verhindern. Einfach ausgedr√ºckt, **k√∂nnen Dienstkonten aus verschiedenen GCP-Organisationen verwendet werden, um domainweite Delegationen in anderen Workspace-Organisationen zu konfigurieren**. Dies w√ºrde bedeuten, dass **nur Super-Admin-Zugriff auf Workspace** erforderlich ist und nicht der Zugriff auf dasselbe GCP-Konto, da der Angreifer Dienstkonten und private Schl√ºssel in seinem pers√∂nlich kontrollierten GCP-Konto erstellen kann.

### Erstellen eines Projekts zur Aufz√§hlung von Workspace

Standardm√§√üig haben Workspace-Benutzer die Berechtigung, **neue Projekte zu erstellen**, und wenn ein neues Projekt erstellt wird, erh√§lt der **Ersteller die Rolle Owner** √ºber dieses.

Daher kann ein Benutzer **ein Projekt erstellen**, die **APIs aktivieren**, um Workspace in seinem neuen Projekt aufzulisten, und versuchen, es zu **enumerieren**.

{% hint style="danger" %}
Damit ein Benutzer Workspace auflisten kann, ben√∂tigt er auch gen√ºgend Workspace-Berechtigungen (nicht jeder Benutzer wird in der Lage sein, das Verzeichnis aufzulisten).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

√úberpr√ºfen Sie **weitere Aufz√§hlungen in**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Missbrauch von Gcloud-Anmeldeinformationen

Sie finden weitere Informationen zum `gcloud`-Fluss f√ºr die Anmeldung in:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Wie dort erkl√§rt, kann gcloud den Scope **`https://www.googleapis.com/auth/drive`** anfordern, der es einem Benutzer erm√∂glichen w√ºrde, auf das Laufwerk des Benutzers zuzugreifen.\
Als Angreifer, wenn Sie den Computer eines Benutzers **physisch** kompromittiert haben und der **Benutzer noch mit** seinem Konto angemeldet ist, k√∂nnten Sie sich anmelden, indem Sie ein Token mit Zugriff auf das Laufwerk generieren:
```bash
gcloud auth login --enable-gdrive-access
```
Wenn ein Angreifer den Computer eines Benutzers kompromittiert, k√∂nnte er auch die Datei `google-cloud-sdk/lib/googlecloudsdk/core/config.py` √§ndern und im **`CLOUDSDK_SCOPES`** den Scope **`'https://www.googleapis.com/auth/drive'`** hinzuf√ºgen:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Daher wird der Benutzer beim n√§chsten Login ein **Token mit Zugriff auf Drive** erstellen, das der Angreifer missbrauchen k√∂nnte, um auf Drive zuzugreifen. Offensichtlich wird der Browser anzeigen, dass das generierte Token Zugriff auf Drive hat, aber da der Benutzer selbst **`gcloud auth login`** aufruft, wird er wahrscheinlich **nichts vermuten.**

Um Drive-Dateien aufzulisten: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Von GWS zu GCP

### Zugriff auf privilegierte GCP-Benutzer

Wenn ein Angreifer vollst√§ndigen Zugriff auf GWS hat, kann er auf Gruppen mit privilegiertem Zugriff auf GCP oder sogar auf Benutzer zugreifen. Daher ist der √úbergang von GWS zu GCP normalerweise "einfacher", nur weil **Benutzer in GWS hohe Privilegien √ºber GCP haben**.

### Google Groups Privilegieneskalation

Standardm√§√üig k√∂nnen Benutzer **frei in Workspace-Gruppen der Organisation beitreten**, und diese Gruppen **k√∂nnten GCP-Berechtigungen** zugewiesen haben (√ºberpr√ºfen Sie Ihre Gruppen in [https://groups.google.com/](https://groups.google.com/)).

Durch den Missbrauch der **google groups privesc** k√∂nnten Sie in der Lage sein, zu einer Gruppe mit einer Art von privilegiertem Zugriff auf GCP zu eskalieren.

### Referenzen

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
