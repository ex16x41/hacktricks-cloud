# GCP <--> Workspace Pivoting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Da GCP a GWS**

### **Nozioni di base sulla delega a livello di dominio**

La delega a livello di dominio di Google Workspace consente a un oggetto identit√†, sia un **app esterna** dal Google Workspace Marketplace che un **Account di Servizio GCP** interno, di **accedere ai dati in tutto il Workspace per conto degli utenti**.

{% hint style="info" %}
Questo significa fondamentalmente che gli **account di servizio** all'interno dei progetti GCP di un'organizzazione potrebbero essere in grado di **fingere di essere utenti di Workspace** della stessa organizzazione (o anche di un'altra).
{% endhint %}

Per ulteriori informazioni su come funziona esattamente, controlla:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Compromettere la delega esistente

Se un attaccante **ha compromesso alcuni accessi su GCP** e **conosce un'email valida di un utente di Workspace** (preferibilmente **super admin**) dell'azienda, potrebbe **enumerare tutti i progetti** a cui ha accesso, **enumerare tutti gli SA** dei progetti, controllare a quali **account di servizio ha accesso** e **ripetere** tutti questi passaggi con ciascun SA che pu√≤ impersonare.\
Con un **elenco di tutti gli account di servizio** a cui ha **accesso** e l'elenco delle **email di Workspace**, l'attaccante potrebbe provare a **impersonare l'utente con ciascun account di servizio**.

{% hint style="danger" %}
Nota che quando si configura la delega a livello di dominio non √® necessario alcun utente di Workspace, quindi basta sapere che **uno valido √® sufficiente e richiesto per l'impersonificazione**.\
Tuttavia, i **privilegi dell'utente impersonato saranno utilizzati**, quindi se √® Super Admin potrai accedere a tutto. Se non ha alcun accesso, questo sar√† inutile.
{% endhint %}

#### [GCP Genera Token di Delega](https://github.com/carlospolop/gcp_gen_delegation_token)

Questo semplice script **generer√† un token OAuth come utente delegato** che puoi poi utilizzare per accedere ad altre API Google con o senza `gcloud`:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Questo √® uno strumento che pu√≤ eseguire l'attacco seguendo questi passaggi:

1. **Enumerare i progetti GCP** utilizzando l'API Resource Manager.
2. Iterare su ciascuna risorsa del progetto e **enumerare le risorse dell'account di servizio GCP** a cui l'utente IAM iniziale ha accesso utilizzando _GetIAMPolicy_.
3. Iterare su **ogni ruolo dell'account di servizio** e trovare ruoli incorporati, di base e personalizzati con il permesso _**serviceAccountKeys.create**_ sulla risorsa dell'account di servizio target. Va notato che il ruolo di Editor possiede intrinsecamente questo permesso.
4. Creare una **nuova chiave privata `KEY_ALG_RSA_2048`** per ciascuna risorsa dell'account di servizio trovata con il permesso rilevante nella policy IAM.
5. Iterare su **ogni nuovo account di servizio e creare un oggetto `JWT`** per esso, composto dalle credenziali della chiave privata SA e da un ambito OAuth. Il processo di creazione di un nuovo oggetto _JWT_ **iterer√† su tutte le combinazioni esistenti di ambiti OAuth** dalla lista **oauth\_scopes.txt**, al fine di trovare tutte le possibilit√† di delega. La lista **oauth\_scopes.txt** √® aggiornata con tutti gli ambiti OAuth che abbiamo trovato rilevanti per abusare delle identit√† di Workspace.
6. Il metodo `_make_authorization_grant_assertion` rivela la necessit√† di dichiarare un **utente workspace target**, riferito come _subject_, per generare JWT sotto DWD. Anche se questo pu√≤ sembrare richiedere un utente specifico, √® importante rendersi conto che **DWD influisce su ogni identit√† all'interno di un dominio**. Di conseguenza, creare un JWT per **qualsiasi utente di dominio** influisce su tutte le identit√† in quel dominio, in linea con il nostro controllo di enumerazione delle combinazioni. In parole semplici, un utente Workspace valido √® sufficiente per procedere.\
Questo utente pu√≤ essere definito nel file _config.yaml_ di DeleFriend. Se un utente workspace target non √® gi√† noto, lo strumento facilita l'identificazione automatica di utenti workspace validi scansionando gli utenti di dominio con ruoli sui progetti GCP. √à fondamentale notare (di nuovo) che i JWT sono specifici per il dominio e non vengono generati per ogni utente; pertanto, il processo automatico mira a un'unica identit√† unica per dominio.
7. **Enumerare e creare un nuovo token di accesso bearer** per ogni JWT e convalidare il token contro l'API tokeninfo.

#### [Script Python di Gitlab](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp_misc/-/blob/master/gcp_delegation.py)

Gitlab ha creato [questo script Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_misc/blob/master/gcp_delegation.py) che pu√≤ fare due cose: elencare la directory degli utenti e creare un nuovo account amministrativo mentre indica un json con le credenziali SA e l'utente da impersonare. Ecco come lo utilizzeresti:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Crea una nuova delega (Persistenza)

√à possibile **controllare le Deleghe a Livello di Dominio in** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Un attaccante con la capacit√† di **creare account di servizio in un progetto GCP** e **privilegi di super admin su GWS potrebbe creare una nuova delega che consente agli SA di impersonare alcuni utenti GWS:**

1. **Generazione di un Nuovo Account di Servizio e del Correlato Paio di Chiavi:** Su GCP, nuove risorse di account di servizio possono essere prodotte sia interattivamente tramite la console che programmaticamente utilizzando chiamate API dirette e strumenti CLI. Questo richiede il **ruolo `iam.serviceAccountAdmin`** o qualsiasi ruolo personalizzato dotato del **permesso `iam.serviceAccounts.create`**. Una volta creato l'account di servizio, procederemo a generare un **paio di chiavi correlate** (**permesso `iam.serviceAccountKeys.create`**).
2. **Creazione di una nuova delega**: √à importante comprendere che **solo il ruolo di Super Admin possiede la capacit√† di impostare la delega globale a Livello di Dominio in Google Workspace** e la delega a Livello di Dominio **non pu√≤ essere impostata programmaticamente,** pu√≤ essere creata e regolata **manualmente** tramite la **console** di Google Workspace.
* La creazione della regola pu√≤ essere trovata nella pagina **Controlli API ‚Üí Gestisci la delega a Livello di Dominio nella console di amministrazione di Google Workspace**.
3. **Collegamento dei privilegi degli ambiti OAuth**: Quando si configura una nuova delega, Google richiede solo 2 parametri, l'ID Client, che √® l'**ID OAuth della risorsa Account di Servizio GCP**, e gli **ambiti OAuth** che definiscono quali chiamate API richiede la delega.
* L'**elenco completo degli ambiti OAuth** pu√≤ essere trovato [**qui**](https://developers.google.com/identity/protocols/oauth2/scopes), ma qui c'√® una raccomandazione: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Agire per conto dell'identit√† target:** A questo punto, abbiamo un oggetto delegato funzionante in GWS. Ora, **utilizzando la chiave privata dell'Account di Servizio GCP, possiamo eseguire chiamate API** (nell'ambito definito nel parametro dell'ambito OAuth) per attivarlo e **agire per conto di qualsiasi identit√† esistente in Google Workspace**. Come abbiamo appreso, l'account di servizio generer√† token di accesso secondo le proprie necessit√† e in base ai permessi che ha per le applicazioni REST API.
* Controlla la **sezione precedente** per alcuni **strumenti** da utilizzare con questa delega.

#### Delega Cross-Organizativa

L'ID SA OAuth √® globale e pu√≤ essere utilizzato per **delega cross-organizzativa**. Non √® stata implementata alcuna restrizione per prevenire la delega cross-globale. In termini semplici, **gli account di servizio di diverse organizzazioni GCP possono essere utilizzati per configurare la delega a livello di dominio su altre organizzazioni Workspace**. Questo comporterebbe **la necessit√† di avere solo accesso da Super Admin a Workspace**, e non accesso allo stesso account GCP, poich√© l'avversario pu√≤ creare Account di Servizio e chiavi private sul proprio account GCP controllato personalmente.

### Creazione di un Progetto per enumerare Workspace

Per **default** gli **utenti** di Workspace hanno il permesso di **creare nuovi progetti**, e quando viene creato un nuovo progetto, il **creatore ottiene il ruolo di Proprietario** su di esso.

Pertanto, un utente pu√≤ **creare un progetto**, **abilitare** le **API** per enumerare Workspace nel suo nuovo progetto e provare a **enumerarlo**.

{% hint style="danger" %}
Affinch√© un utente possa enumerare Workspace, ha anche bisogno di permessi sufficienti su Workspace (non tutti gli utenti saranno in grado di enumerare la directory).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Controlla **ulteriore enumerazione in**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Abusare delle credenziali Gcloud

Puoi trovare ulteriori informazioni sul flusso `gcloud` per effettuare il login in:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Come spiegato l√¨, gcloud pu√≤ richiedere l'ambito **`https://www.googleapis.com/auth/drive`** che consentirebbe a un utente di accedere al drive dell'utente.\
Come attaccante, se hai compromesso **fisicamente** il computer di un utente e l'**utente √® ancora connesso** con il suo account, potresti effettuare il login generando un token con accesso al drive utilizzando:
```bash
gcloud auth login --enable-gdrive-access
```
Se un attaccante compromette il computer di un utente, potrebbe anche modificare il file `google-cloud-sdk/lib/googlecloudsdk/core/config.py` e aggiungere in **`CLOUDSDK_SCOPES`** l'ambito **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Pertanto, la prossima volta che l'utente accede, creer√† un **token con accesso a drive** che l'attaccante potrebbe sfruttare per accedere al drive. Ovviamente, il browser indicher√† che il token generato avr√† accesso a drive, ma poich√© l'utente si chiamer√† **`gcloud auth login`**, probabilmente **non sospetter√† nulla.**

Per elencare i file di drive: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Da GWS a GCP

### Accesso a utenti GCP privilegiati

Se un attaccante ha accesso completo su GWS, sar√† in grado di accedere a gruppi con accesso privilegiato su GCP o anche a utenti, quindi passare da GWS a GCP √® solitamente pi√π "semplice" solo perch√© **gli utenti in GWS hanno alti privilegi su GCP**.

### Escalation dei privilegi di Google Groups

Per impostazione predefinita, gli utenti possono **unirsi liberamente ai gruppi Workspace dell'Organizzazione** e quei gruppi **potrebbero avere permessi GCP** assegnati (controlla i tuoi gruppi in [https://groups.google.com/](https://groups.google.com/)).

Sfruttando il **google groups privesc**, potresti essere in grado di scalare a un gruppo con qualche tipo di accesso privilegiato a GCP.

### Riferimenti

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
Impara e pratica Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Impara e pratica Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
