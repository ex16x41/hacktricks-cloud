# GCP - Entendendo a Delega√ß√£o em Larga Escala

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

Este post √© a introdu√ß√£o de [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) que pode ser acessado para mais detalhes.

## **Entendendo a Delega√ß√£o em Larga Escala**

A delega√ß√£o em larga escala do Google Workspace permite que um objeto de identidade, seja um **aplicativo externo** do Google Workspace Marketplace ou uma **Conta de Servi√ßo GCP** interna, **acesse dados em todo o Workspace em nome dos usu√°rios**. Este recurso, que √© crucial para aplicativos que interagem com APIs ou servi√ßos do Google que precisam de impersona√ß√£o de usu√°rio, aumenta a efici√™ncia e minimiza erros humanos ao automatizar tarefas. Usando OAuth 2.0, desenvolvedores de aplicativos e administradores podem conceder a essas contas de servi√ßo acesso aos dados do usu√°rio sem o consentimento individual do usu√°rio.\
\
O Google Workspace permite a cria√ß√£o de dois tipos principais de identidades de objeto delegadas globais:

* **Aplicativos GWS:** Aplicativos do Marketplace do Workspace podem ser configurados como uma identidade delegada. Antes de serem disponibilizados no marketplace, cada aplicativo do Workspace passa por uma revis√£o pelo Google para minimizar o uso indevido potencial. Embora isso n√£o elimine completamente o risco de abuso, aumenta significativamente a dificuldade para que tais incidentes ocorram.
* **Conta de Servi√ßo GCP:** Saiba mais sobre [**Contas de Servi√ßo GCP aqui**](../gcp-basic-information/#service-accounts).

### **Delega√ß√£o em Larga Escala: Por Dentro**

√â assim que uma Conta de Servi√ßo GCP pode acessar APIs do Google em nome de outras identidades no Google Workspace:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **A identidade cria um JWT:** A identidade usa a chave privada da conta de servi√ßo (parte do arquivo de par de chaves JSON) para assinar um JWT. Este JWT cont√©m declara√ß√µes sobre a conta de servi√ßo, o usu√°rio-alvo a ser impersonado e os escopos OAuth de acesso √† API REST que est√° sendo solicitada.
2. **A identidade usa o JWT para solicitar um token de acesso:** O aplicativo/usu√°rio usa o JWT para solicitar um token de acesso do servi√ßo OAuth 2.0 do Google. A solicita√ß√£o tamb√©m inclui o usu√°rio-alvo a ser impersonado (o e-mail do Workspace do usu√°rio) e os escopos para os quais o acesso √© solicitado.
3. **O servi√ßo OAuth 2.0 do Google retorna um token de acesso:** O token de acesso representa a autoridade da conta de servi√ßo para agir em nome do usu√°rio para os escopos especificados. Este token √© tipicamente de curta dura√ß√£o e deve ser renovado periodicamente (de acordo com a necessidade do aplicativo). √â essencial entender que os escopos OAuth especificados no token JWT t√™m validade e impacto no token de acesso resultante. Por exemplo, tokens de acesso que possuem m√∫ltiplos escopos ter√£o validade para v√°rios aplicativos de API REST.
4. **A identidade usa o token de acesso para chamar APIs do Google**: Agora, com um token de acesso relevante, o servi√ßo pode acessar a API REST necess√°ria. O aplicativo usa este token de acesso no cabe√ßalho "Authorization" de suas solicita√ß√µes HTTP destinadas √†s APIs do Google. Essas APIs utilizam o token para verificar a identidade impersonada e confirmar que ela possui a autoriza√ß√£o necess√°ria.
5. **As APIs do Google retornam os dados solicitados**: Se o token de acesso for v√°lido e a conta de servi√ßo tiver a autoriza√ß√£o apropriada, as APIs do Google retornam os dados solicitados. Por exemplo, na imagem a seguir, utilizamos o m√©todo _users.messages.list_ para listar todos os IDs de mensagens do Gmail associados a um usu√°rio-alvo do Workspace.

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
