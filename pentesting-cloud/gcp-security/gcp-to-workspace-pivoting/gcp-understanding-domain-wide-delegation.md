# GCP - Verstaan van Domein-Wye Delegasie

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Hierdie pos is die inleiding van [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) wat toegang bied tot meer besonderhede.

## **Verstaan van Domein-Wye Delegasie**

Google Workspace se Domein-Wye delegasie laat 'n identiteitsobjek, hetsy 'n **eksterne app** van Google Workspace Marketplace of 'n interne **GCP Diensrekening**, toe om **data oor die Workspace namens gebruikers te bekom**. Hierdie funksie, wat noodsaaklik is vir toepassings wat met Google API's of dienste wat gebruikersverteenwoordiging benodig, interaksie het, verbeter doeltreffendheid en minimaliseer menslike foute deur take te outomatiseer. Deur OAuth 2.0 kan app-ontwikkelaars en administrateurs hierdie diensrekeninge toegang tot gebruikersdata gee sonder individuele gebruikers se toestemming.\
\
Google Workspace laat die skepping van twee hoofsoorte globale gedelegeerde objek identiteite toe:

* **GWS Toepassings:** Toepassings van die Workspace Marketplace kan opgestel word as 'n gedelegeerde identiteit. Voordat dit in die mark beskikbaar gestel word, ondergaan elke Workspace-toepassing 'n hersiening deur Google om potensi√´le misbruik te minimaliseer. Terwyl dit nie die risiko van misbruik heeltemal uitskakel nie, verhoog dit aansienlik die moeilikheidsgraad vir sulke voorvalle om voor te kom.
* **GCP Diensrekening:** Leer meer oor [**GCP Diensrekeninge hier**](../gcp-basic-information/#service-accounts).

### **Domein-Wye Delegasie: Onder die Motorkap**

So kan 'n GCP Diensrekening Google API's namens ander identiteite in Google Workspace benader:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **Identiteit skep 'n JWT:** Die Identiteit gebruik die diensrekening se private sleutel (deel van die JSON sleutel paar l√™er) om 'n JWT te teken. Hierdie JWT bevat aansprake oor die diensrekening, die te verteenwoordig gebruiker, en die OAuth skope van toegang tot die REST API wat aangevra word.
2. **Die Identiteit gebruik die JWT om 'n toegangstoken aan te vra:** Die toepassing/gebruiker gebruik die JWT om 'n toegangstoken van Google se OAuth 2.0 diens aan te vra. Die aanvraag sluit ook die te verteenwoordig gebruiker in (die gebruiker se Workspace e-pos), en die skope waarvoor toegang aangevra word.
3. **Google se OAuth 2.0 diens keer 'n toegangstoken terug:** Die toegangstoken verteenwoordig die diensrekening se gesag om namens die gebruiker vir die gespesifiseerde skope op te tree. Hierdie token is tipies kortstondig en moet periodiek verfris word (volgens die toepassing se behoefte). Dit is noodsaaklik om te verstaan dat die OAuth skope wat in die JWT-token gespesifiseer is, geldigheid het en 'n impak op die resulterende toegangstoken het. Byvoorbeeld, toegangstokens wat verskeie skope besit, sal geldigheid hou vir verskeie REST API-toepassings.
4. **Die Identiteit gebruik die toegangstoken om Google API's aan te roep**: Nou met 'n relevante toegangstoken, kan die diens die vereiste REST API benader. Die toepassing gebruik hierdie toegangstoken in die "Authorization" kop van sy HTTP-aanvrae wat bestem is vir Google API's. Hierdie API's gebruik die token om die verteenwoordigde identiteit te verifieer en te bevestig dat dit die nodige magtiging het.
5. **Google API's keer die aangevraagde data terug**: As die toegangstoken geldig is en die diensrekening die toepaslike magtiging het, keer die Google API's die aangevraagde data terug. Byvoorbeeld, in die volgende prent, het ons die _users.messages.list_ metode benut om al die Gmail boodskap-ID's wat met 'n teiken Workspace-gebruiker geassosieer is, op te lys.

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
