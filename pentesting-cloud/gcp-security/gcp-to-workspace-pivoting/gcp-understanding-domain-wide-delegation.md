# GCP - Razumevanje Delegacije na Nivou Domen

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

Ovaj post je uvod u [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) koji se mo쬰 pristupiti za vi코e detalja.

## **Razumevanje Delegacije na Nivou Domen**

Delegacija na nivou domena Google Workspace-a omogu캖ava identitetskom objektu, bilo **spoljnoj aplikaciji** iz Google Workspace Marketplace-a ili internom **GCP servisnom nalogu**, da **pristupi podacima 코irom Workspace-a u ime korisnika**. Ova funkcija, koja je klju캜na za aplikacije koje komuniciraju sa Google API-ima ili uslugama koje zahtevaju impersonaciju korisnika, pobolj코ava efikasnost i minimizira ljudske gre코ke automatizacijom zadataka. Kori코캖enjem OAuth 2.0, programeri aplikacija i administratori mogu dati ovim servisnim nalozima pristup korisni캜kim podacima bez pojedina캜ne saglasnosti korisnika.\
\
Google Workspace omogu캖ava kreiranje dva glavna tipa globalnih delegiranih identiteta:

* **GWS Aplikacije:** Aplikacije iz Workspace Marketplace-a mogu biti postavljene kao delegirani identitet. Pre nego 코to postanu dostupne na tr쬴코tu, svaka Workspace aplikacija prolazi reviziju od strane Google-a kako bi se minimizirala potencijalna zloupotreba. Iako to ne elimini코e potpuno rizik od zloupotrebe, zna캜ajno pove캖ava te쬴nu za takve incidente da se dogode.
* **GCP Servisni Nalog:** Saznajte vi코e o [**GCP Servisnim Nalozima ovde**](../gcp-basic-information/#service-accounts).

### **Delegacija na Nivou Domen: Iza Scene**

Ovako GCP Servisni Nalog mo쬰 pristupiti Google API-ima u ime drugih identiteta u Google Workspace-u:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **Identitet kreira JWT:** Identitet koristi privatni klju캜 servisnog naloga (deo JSON datoteke sa klju캜em) da potpi코e JWT. Ovaj JWT sadr쬴 tvrdnje o servisnom nalogu, ciljanom korisniku koga treba impersonirati, i OAuth opsezima pristupa REST API-ju koji se zahteva.
2. **Identitet koristi JWT da zatra쬴 pristupni token:** Aplikacija/korisnik koristi JWT da zatra쬴 pristupni token od Google-ove OAuth 2.0 usluge. Zahtev tako캠e uklju캜uje ciljanog korisnika koga treba impersonirati (korisni캜ki Workspace email), i opsege za koje se tra쬴 pristup.
3. **Google-ova OAuth 2.0 usluga vra캖a pristupni token:** Pristupni token predstavlja ovla코캖enje servisnog naloga da deluje u ime korisnika za odre캠ene opsege. Ovaj token je obi캜no kratkotrajan i mora se periodi캜no osve쬬vati (prema potrebama aplikacije). Va쬹o je razumeti da opsezi OAuth navedeni u JWT tokenu imaju validnost i uticaj na rezultantni pristupni token. Na primer, pristupni tokeni koji poseduju vi코e opsega 캖e imati validnost za brojne REST API aplikacije.
4. **Identitet koristi pristupni token da pozove Google API-e**: Sada sa relevantnim pristupnim tokenom, servis mo쬰 pristupiti potrebnom REST API-ju. Aplikacija koristi ovaj pristupni token u "Authorization" header-u svojih HTTP zahteva upu캖enih Google API-ima. Ovi API-ji koriste token da verifikuju impersonirani identitet i potvrde da ima potrebna ovla코캖enja.
5. **Google API-e vra캖aju tra쬰ne podatke**: Ako je pristupni token validan i servisni nalog ima odgovaraju캖e ovla코캖enje, Google API-e vra캖aju tra쬰ne podatke. Na primer, na slede캖oj slici, iskoristili smo metodu _users.messages.list_ da bismo naveli sve Gmail ID-ove poruka povezane sa ciljnim Workspace korisnikom.

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
