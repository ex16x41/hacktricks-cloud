# GCP - Understanding Domain-Wide Delegation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

This post is the introduction of [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) which can be accessed for more details.

## **Understanding Domain-Wide Delegation**

Google Workspaceì˜ Domain-Wide delegationì€ **Google Workspace Marketplace**ì˜ **ì™¸ë¶€ ì•±** ë˜ëŠ” ë‚´ë¶€ **GCP Service Account**ê°€ **ì‚¬ìš©ìë¥¼ ëŒ€ì‹ í•˜ì—¬ Workspace ì „ë°˜ì˜ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡** í•©ë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì€ Google API ë˜ëŠ” ì‚¬ìš©ì ê°€ì¥ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì™€ ìƒí˜¸ì‘ìš©í•˜ëŠ” ì•±ì— í•„ìˆ˜ì ì´ë©°, ì‘ì—…ì„ ìë™í™”í•˜ì—¬ íš¨ìœ¨ì„±ì„ ë†’ì´ê³  ì¸ì  ì˜¤ë¥˜ë¥¼ ìµœì†Œí™”í•©ë‹ˆë‹¤. OAuth 2.0ì„ ì‚¬ìš©í•˜ì—¬ ì•± ê°œë°œìì™€ ê´€ë¦¬ìëŠ” ê°œë³„ ì‚¬ìš©ì ë™ì˜ ì—†ì´ ì´ëŸ¬í•œ ì„œë¹„ìŠ¤ ê³„ì •ì— ì‚¬ìš©ì ë°ì´í„° ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
\
Google WorkspaceëŠ” ë‘ ê°€ì§€ ì£¼ìš” ìœ í˜•ì˜ ê¸€ë¡œë²Œ ìœ„ì„ ê°ì²´ ì•„ì´ë´í‹°í‹° ìƒì„±ì„ í—ˆìš©í•©ë‹ˆë‹¤:

* **GWS Applications:** Workspace Marketplaceì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ìœ„ì„ëœ ì•„ì´ë´í‹°í‹°ë¡œ ì„¤ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§ˆì¼“í”Œë ˆì´ìŠ¤ì— ì œê³µë˜ê¸° ì „ì— ê° Workspace ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ì ì¬ì  ì˜¤ìš©ì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•´ Googleì˜ ê²€í† ë¥¼ ê±°ì¹©ë‹ˆë‹¤. ì´ëŠ” ì˜¤ìš©ì˜ ìœ„í—˜ì„ ì™„ì „íˆ ì œê±°í•˜ì§€ëŠ” ì•Šì§€ë§Œ, ê·¸ëŸ¬í•œ ì‚¬ê±´ì´ ë°œìƒí•  ê°€ëŠ¥ì„±ì„ ìƒë‹¹íˆ ì¦ê°€ì‹œí‚µë‹ˆë‹¤.
* **GCP Service Account:** [**GCP Service Accountsì— ëŒ€í•´ ë” ì•Œì•„ë³´ì„¸ìš”**](../gcp-basic-information/#service-accounts).

### **Domain-Wide Delegation: Under the Hood**

GCP Service Accountê°€ Google Workspaceì˜ ë‹¤ë¥¸ ì•„ì´ë´í‹°í‹°ë¥¼ ëŒ€ì‹ í•˜ì—¬ Google APIì— ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **ì•„ì´ë´í‹°í‹°ê°€ JWTë¥¼ ìƒì„±í•©ë‹ˆë‹¤:** ì•„ì´ë´í‹°í‹°ëŠ” ì„œë¹„ìŠ¤ ê³„ì •ì˜ ê°œì¸ í‚¤( JSON í‚¤ ìŒ íŒŒì¼ì˜ ì¼ë¶€)ë¥¼ ì‚¬ìš©í•˜ì—¬ JWTì— ì„œëª…í•©ë‹ˆë‹¤. ì´ JWTëŠ” ì„œë¹„ìŠ¤ ê³„ì •, ê°€ì¥í•  ëŒ€ìƒ ì‚¬ìš©ì ë° ìš”ì²­ëœ REST APIì— ëŒ€í•œ OAuth ë²”ìœ„ì— ëŒ€í•œ í´ë ˆì„ì„ í¬í•¨í•©ë‹ˆë‹¤.
2. **ì•„ì´ë´í‹°í‹°ê°€ JWTë¥¼ ì‚¬ìš©í•˜ì—¬ ì•¡ì„¸ìŠ¤ í† í°ì„ ìš”ì²­í•©ë‹ˆë‹¤:** ì• í”Œë¦¬ì¼€ì´ì…˜/ì‚¬ìš©ìëŠ” JWTë¥¼ ì‚¬ìš©í•˜ì—¬ Googleì˜ OAuth 2.0 ì„œë¹„ìŠ¤ì—ì„œ ì•¡ì„¸ìŠ¤ í† í°ì„ ìš”ì²­í•©ë‹ˆë‹¤. ìš”ì²­ì—ëŠ” ê°€ì¥í•  ëŒ€ìƒ ì‚¬ìš©ì(ì‚¬ìš©ìì˜ Workspace ì´ë©”ì¼)ì™€ ìš”ì²­ëœ ì•¡ì„¸ìŠ¤ ë²”ìœ„ë„ í¬í•¨ë©ë‹ˆë‹¤.
3. **Googleì˜ OAuth 2.0 ì„œë¹„ìŠ¤ê°€ ì•¡ì„¸ìŠ¤ í† í°ì„ ë°˜í™˜í•©ë‹ˆë‹¤:** ì•¡ì„¸ìŠ¤ í† í°ì€ ì§€ì •ëœ ë²”ìœ„ì— ëŒ€í•´ ì‚¬ìš©ìë¥¼ ëŒ€ì‹ í•˜ì—¬ í–‰ë™í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì •ì˜ ê¶Œí•œì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì´ í† í°ì€ ì¼ë°˜ì ìœ¼ë¡œ ë‹¨ê¸°ì ì´ë©° ì£¼ê¸°ì ìœ¼ë¡œ ê°±ì‹ í•´ì•¼ í•©ë‹ˆë‹¤(ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ í•„ìš”ì— ë”°ë¼). JWT í† í°ì— ì§€ì •ëœ OAuth ë²”ìœ„ëŠ” ìœ íš¨ì„±ì´ ìˆìœ¼ë©° ê²°ê³¼ ì•¡ì„¸ìŠ¤ í† í°ì— ì˜í–¥ì„ ë¯¸ì¹œë‹¤ëŠ” ê²ƒì„ ì´í•´í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì—¬ëŸ¬ ë²”ìœ„ë¥¼ ê°€ì§„ ì•¡ì„¸ìŠ¤ í† í°ì€ ì—¬ëŸ¬ REST API ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•´ ìœ íš¨ì„±ì„ ê°€ì§‘ë‹ˆë‹¤.
4. **ì•„ì´ë´í‹°í‹°ê°€ ì•¡ì„¸ìŠ¤ í† í°ì„ ì‚¬ìš©í•˜ì—¬ Google APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤:** ì´ì œ ê´€ë ¨ ì•¡ì„¸ìŠ¤ í† í°ì„ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ëŠ” í•„ìš”í•œ REST APIì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ì´ ì•¡ì„¸ìŠ¤ í† í°ì„ Google APIë¥¼ í–¥í•œ HTTP ìš”ì²­ì˜ "Authorization" í—¤ë”ì— ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ APIëŠ” í† í°ì„ ì‚¬ìš©í•˜ì—¬ ê°€ì¥ëœ ì•„ì´ë´í‹°í‹°ë¥¼ í™•ì¸í•˜ê³  í•„ìš”í•œ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
5. **Google APIê°€ ìš”ì²­ëœ ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤:** ì•¡ì„¸ìŠ¤ í† í°ì´ ìœ íš¨í•˜ê³  ì„œë¹„ìŠ¤ ê³„ì •ì´ ì ì ˆí•œ ê¶Œí•œì„ ê°€ì§„ ê²½ìš° Google APIëŠ” ìš”ì²­ëœ ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒ ê·¸ë¦¼ì—ì„œëŠ” _users.messages.list_ ë©”ì„œë“œë¥¼ í™œìš©í•˜ì—¬ ëŒ€ìƒ Workspace ì‚¬ìš©ìì™€ ê´€ë ¨ëœ ëª¨ë“  Gmail ë©”ì‹œì§€ IDë¥¼ ë‚˜ì—´í–ˆìŠµë‹ˆë‹¤.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
