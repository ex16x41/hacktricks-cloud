# GCP - Comprendiendo la Delegaci贸n de Dominio Amplio

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

This post is the introduction of [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) which can be accessed for more details.

## **Comprendiendo la Delegaci贸n de Dominio Amplio**

La delegaci贸n de dominio amplio de Google Workspace permite que un objeto de identidad, ya sea una **aplicaci贸n externa** del Marketplace de Google Workspace o una **Cuenta de Servicio de GCP** interna, **acceda a datos en todo el Workspace en nombre de los usuarios**. Esta funci贸n, que es crucial para las aplicaciones que interact煤an con las API de Google o servicios que necesitan suplantaci贸n de usuarios, mejora la eficiencia y minimiza el error humano al automatizar tareas. Usando OAuth 2.0, los desarrolladores de aplicaciones y administradores pueden otorgar a estas cuentas de servicio acceso a los datos de los usuarios sin el consentimiento individual del usuario.\
\
Google Workspace permite la creaci贸n de dos tipos principales de identidades de objeto delegadas globales:

* **Aplicaciones GWS:** Las aplicaciones del Marketplace de Workspace pueden configurarse como una identidad delegada. Antes de estar disponibles en el marketplace, cada aplicaci贸n de Workspace pasa por una revisi贸n por parte de Google para minimizar el posible uso indebido. Si bien esto no elimina por completo el riesgo de abuso, aumenta significativamente la dificultad para que ocurran tales incidentes.
* **Cuenta de Servicio de GCP:** Aprende m谩s sobre [**Cuentas de Servicio de GCP aqu铆**](../gcp-basic-information/#service-accounts).

### **Delegaci贸n de Dominio Amplio: Detr谩s de Escena**

As铆 es como una Cuenta de Servicio de GCP puede acceder a las API de Google en nombre de otras identidades en Google Workspace:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **La identidad crea un JWT:** La identidad utiliza la clave privada de la cuenta de servicio (parte del archivo de clave JSON) para firmar un JWT. Este JWT contiene afirmaciones sobre la cuenta de servicio, el usuario objetivo a suplantar y los 谩mbitos de acceso de OAuth a la API REST que se est谩 solicitando.
2. **La identidad utiliza el JWT para solicitar un token de acceso:** La aplicaci贸n/usuario utiliza el JWT para solicitar un token de acceso del servicio OAuth 2.0 de Google. La solicitud tambi茅n incluye el usuario objetivo a suplantar (el correo electr贸nico del usuario de Workspace) y los 谩mbitos para los cuales se solicita acceso.
3. **El servicio OAuth 2.0 de Google devuelve un token de acceso:** El token de acceso representa la autoridad de la cuenta de servicio para actuar en nombre del usuario para los 谩mbitos especificados. Este token es t铆picamente de corta duraci贸n y debe ser renovado peri贸dicamente (seg煤n la necesidad de la aplicaci贸n). Es esencial entender que los 谩mbitos de OAuth especificados en el token JWT tienen validez e impacto en el token de acceso resultante. Por ejemplo, los tokens de acceso que poseen m煤ltiples 谩mbitos tendr谩n validez para numerosas aplicaciones de API REST.
4. **La identidad utiliza el token de acceso para llamar a las API de Google**: Ahora, con un token de acceso relevante, el servicio puede acceder a la API REST requerida. La aplicaci贸n utiliza este token de acceso en el encabezado "Authorization" de sus solicitudes HTTP destinadas a las API de Google. Estas API utilizan el token para verificar la identidad suplantada y confirmar que tiene la autorizaci贸n necesaria.
5. **Las API de Google devuelven los datos solicitados**: Si el token de acceso es v谩lido y la cuenta de servicio tiene la autorizaci贸n adecuada, las API de Google devuelven los datos solicitados. Por ejemplo, en la siguiente imagen, hemos aprovechado el m茅todo _users.messages.list_ para listar todos los IDs de mensajes de Gmail asociados con un usuario objetivo de Workspace.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
