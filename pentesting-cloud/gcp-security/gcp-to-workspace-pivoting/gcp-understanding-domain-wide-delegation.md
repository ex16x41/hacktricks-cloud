# GCP - Verst√§ndnis der dom√§nenweiten Delegation

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

Dieser Beitrag ist die Einf√ºhrung von [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover), die f√ºr weitere Details aufgerufen werden kann.

## **Verst√§ndnis der dom√§nenweiten Delegation**

Die dom√§nenweite Delegation von Google Workspace erm√∂glicht einem Identit√§tsobjekt, entweder einer **externen App** aus dem Google Workspace Marketplace oder einem internen **GCP-Dienstkonto**, **Daten im gesamten Workspace im Namen von Benutzern zuzugreifen**. Diese Funktion, die f√ºr Apps, die mit Google APIs oder Diensten interagieren und Benutzer impersonieren m√ºssen, entscheidend ist, erh√∂ht die Effizienz und minimiert menschliche Fehler durch Automatisierung von Aufgaben. Mit OAuth 2.0 k√∂nnen App-Entwickler und Administratoren diesen Dienstkonten Zugriff auf Benutzerdaten ohne individuelle Benutzerzustimmung gew√§hren.\
\
Google Workspace erm√∂glicht die Erstellung von zwei Haupttypen globaler delegierter Objektidentit√§ten:

* **GWS-Anwendungen:** Anwendungen aus dem Workspace Marketplace k√∂nnen als delegierte Identit√§t eingerichtet werden. Bevor sie im Marketplace verf√ºgbar gemacht werden, wird jede Workspace-Anwendung von Google √ºberpr√ºft, um potenziellen Missbrauch zu minimieren. Auch wenn dies das Risiko von Missbrauch nicht vollst√§ndig ausschlie√üt, erh√∂ht es erheblich die Schwierigkeit, dass solche Vorf√§lle auftreten.
* **GCP-Dienstkonto:** Erfahren Sie mehr √ºber [**GCP-Dienstkonten hier**](../gcp-basic-information/#service-accounts).

### **Dom√§nenweite Delegation: Unter der Haube**

So kann ein GCP-Dienstkonto im Namen anderer Identit√§ten in Google Workspace auf Google APIs zugreifen:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **Identit√§t erstellt ein JWT:** Die Identit√§t verwendet den privaten Schl√ºssel des Dienstkontos (Teil der JSON-Schl√ºsselpaardatei), um ein JWT zu signieren. Dieses JWT enth√§lt Anspr√ºche √ºber das Dienstkonto, den Zielbenutzer, der impersoniert werden soll, und die OAuth-Bereiche des Zugriffs auf die angeforderte REST-API.
2. **Die Identit√§t verwendet das JWT, um ein Zugriffstoken anzufordern:** Die Anwendung/der Benutzer verwendet das JWT, um ein Zugriffstoken vom OAuth 2.0-Dienst von Google anzufordern. Die Anfrage enth√§lt auch den Zielbenutzer, der impersoniert werden soll (die Workspace-E-Mail des Benutzers), und die Bereiche, f√ºr die der Zugriff angefordert wird.
3. **Der OAuth 2.0-Dienst von Google gibt ein Zugriffstoken zur√ºck:** Das Zugriffstoken repr√§sentiert die Autorit√§t des Dienstkontos, im Namen des Benutzers f√ºr die angegebenen Bereiche zu handeln. Dieses Token ist typischerweise kurzlebig und muss regelm√§√üig (je nach Bedarf der Anwendung) aktualisiert werden. Es ist wichtig zu verstehen, dass die im JWT-Token angegebenen OAuth-Bereiche G√ºltigkeit haben und Auswirkungen auf das resultierende Zugriffstoken haben. Beispielsweise haben Zugriffstoken mit mehreren Bereichen G√ºltigkeit f√ºr zahlreiche REST-API-Anwendungen.
4. **Die Identit√§t verwendet das Zugriffstoken, um Google APIs aufzurufen**: Jetzt kann der Dienst mit einem relevanten Zugriffstoken auf die erforderliche REST-API zugreifen. Die Anwendung verwendet dieses Zugriffstoken im "Authorization"-Header ihrer HTTP-Anfragen, die an Google APIs gerichtet sind. Diese APIs nutzen das Token, um die impersonierte Identit√§t zu √ºberpr√ºfen und zu best√§tigen, dass sie die erforderliche Autorisierung hat.
5. **Google APIs geben die angeforderten Daten zur√ºck**: Wenn das Zugriffstoken g√ºltig ist und das Dienstkonto die entsprechende Autorisierung hat, geben die Google APIs die angeforderten Daten zur√ºck. Zum Beispiel haben wir im folgenden Bild die Methode _users.messages.list_ verwendet, um alle Gmail-Nachrichten-IDs aufzulisten, die mit einem Zielbenutzer im Workspace verbunden sind.

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
