# GCP - Zrozumienie delegacji na poziomie domeny

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

Ten post jest wprowadzeniem do [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover), kt贸re mo偶na znale藕 w celu uzyskania dalszych szczeg贸贸w.

## **Zrozumienie delegacji na poziomie domeny**

Delegacja na poziomie domeny Google Workspace pozwala obiektowi to偶samoci, czy to **zewntrznej aplikacji** z Google Workspace Marketplace, czy wewntrznemu **Konto usugi GCP**, na **uzyskiwanie dostpu do danych w caym Workspace w imieniu u偶ytkownik贸w**. Ta funkcja, kt贸ra jest kluczowa dla aplikacji wsp贸dziaajcych z interfejsami API Google lub usugami wymagajcymi podszywania si pod u偶ytkownik贸w, zwiksza efektywno i minimalizuje bdy ludzkie poprzez automatyzacj zada. U偶ywajc OAuth 2.0, deweloperzy aplikacji i administratorzy mog da tym kontom usugowym dostp do danych u偶ytkownik贸w bez indywidualnej zgody u偶ytkownik贸w.\
\
Google Workspace pozwala na tworzenie dw贸ch g贸wnych typ贸w globalnych to偶samoci obiekt贸w delegowanych:

* **Aplikacje GWS:** Aplikacje z Marketplace Workspace mog by skonfigurowane jako delegowana to偶samo. Zanim zostan udostpnione w marketplace, ka偶da aplikacja Workspace przechodzi przegld przez Google, aby zminimalizowa potencjalne nadu偶ycia. Chocia偶 nie eliminuje to cakowicie ryzyka nadu偶y, znacznie zwiksza trudno wystpienia takich incydent贸w.
* **Konto usugi GCP:** Dowiedz si wicej o [**Konta usugi GCP tutaj**](../gcp-basic-information/#service-accounts).

### **Delegacja na poziomie domeny: Jak to dziaa**

Oto jak Konto usugi GCP mo偶e uzyska dostp do interfejs贸w API Google w imieniu innych to偶samoci w Google Workspace:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **To偶samo tworzy JWT:** To偶samo u偶ywa prywatnego klucza konta usugi (cz pliku pary kluczy JSON) do podpisania JWT. Ten JWT zawiera roszczenia dotyczce konta usugi, docelowego u偶ytkownika, kt贸rego nale偶y podszy si, oraz zakresy OAuth dostpu do 偶danego interfejsu API REST.
2. **To偶samo u偶ywa JWT do 偶dania tokena dostpu:** Aplikacja/u偶ytkownik u偶ywa JWT do 偶dania tokena dostpu z usugi OAuth 2.0 Google. 呕danie zawiera r贸wnie偶 docelowego u偶ytkownika, kt贸rego nale偶y podszy si (adres e-mail u偶ytkownika Workspace), oraz zakresy, dla kt贸rych 偶dany jest dostp.
3. **Usuga OAuth 2.0 Google zwraca token dostpu:** Token dostpu reprezentuje uprawnienia konta usugi do dziaania w imieniu u偶ytkownika dla okrelonych zakres贸w. Ten token jest zazwyczaj kr贸tkoterminowy i musi by okresowo odnawiany (zgodnie z potrzebami aplikacji). Wa偶ne jest, aby zrozumie, 偶e zakresy OAuth okrelone w tokenie JWT maj wa偶no i wpyw na wynikowy token dostpu. Na przykad, tokeny dostpu posiadajce wiele zakres贸w bd miay wa偶no dla wielu aplikacji interfejsu API REST.
4. **To偶samo u偶ywa tokena dostpu do wywoania interfejs贸w API Google**: Teraz z odpowiednim tokenem dostpu, usuga mo偶e uzyska dostp do wymaganego interfejsu API REST. Aplikacja u偶ywa tego tokena dostpu w nag贸wku "Authorization" swoich 偶da HTTP kierowanych do interfejs贸w API Google. Te interfejsy API wykorzystuj token do weryfikacji podszywanej to偶samoci i potwierdzenia, 偶e ma ona odpowiednie uprawnienia.
5. **Interfejsy API Google zwracaj 偶dane dane**: Jeli token dostpu jest wa偶ny, a konto usugi ma odpowiednie uprawnienia, interfejsy API Google zwracaj 偶dane dane. Na przykad, na poni偶szym obrazku wykorzystalimy metod _users.messages.list_ do wylistowania wszystkich identyfikator贸w wiadomoci Gmail zwizanych z docelowym u偶ytkownikiem Workspace.

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
