# GCP Pentesting

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter**'da **bizi takip edin** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

## Temel Bilgiler

**GCP** ortamında pentesting yapmaya başlamadan önce, nasıl çalıştığına dair bilmeniz gereken birkaç **temel şey** var; bu, ne yapmanız gerektiğini, yanlış yapılandırmaları nasıl bulacağınızı ve bunları nasıl istismar edeceğinizi anlamanıza yardımcı olacaktır.

**Organizasyon** hiyerarşisi, **izinler** ve diğer temel kavramlar hakkında açıklamalar için:

{% content-ref url="gcp-basic-information/" %}
[gcp-basic-information](gcp-basic-information/)
{% endcontent-ref %}

## Öğrenme Laboratuvarları

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/lacioffi/GCP-pentest-lab/](https://github.com/lacioffi/GCP-pentest-lab/)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## GCP Pentester/Red Team Metodolojisi

Bir GCP ortamını denetlemek için bilmek çok önemlidir: hangi **hizmetlerin kullanıldığı**, neyin **açık olduğu**, kimin neye **erişimi olduğu** ve iç GCP hizmetlerinin **harici hizmetlerle** nasıl bağlantılı olduğudur.

Red Team bakış açısından, bir GCP ortamını ele geçirmenin **ilk adımı** bazı **kimlik bilgilerini** elde etmektir. Bunu nasıl yapacağınıza dair bazı fikirler:

* Github'daki **sızıntılar** (veya benzeri) - OSINT
* **Sosyal** Mühendislik (Sayfayı kontrol edin [**Workspace Security**](../workspace-security/))
* **Şifre** yeniden kullanımı (şifre sızıntıları)
* GCP-Hosted Uygulamalardaki Güvenlik Açıkları
* [**Server Side Request Forgery**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) ile metadata uç noktasına erişim
* **Yerel Dosya Okuma**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* 3. tarafların **ihlal edilmesi**
* **İç** Çalışan

Ya da **kimlik doğrulaması yapılmamış bir hizmeti** ele geçirerek:

{% content-ref url="gcp-unauthenticated-enum-and-access/" %}
[gcp-unauthenticated-enum-and-access](gcp-unauthenticated-enum-and-access/)
{% endcontent-ref %}

Ya da bir **gözden geçirme** yapıyorsanız, bu rollerle **kimlik bilgilerini** isteyebilirsiniz:

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
Kimlik bilgilerini elde etmeyi başardıktan sonra, bu kimlik bilgilerin kime ait olduğunu ve neye erişim sağladıklarını bilmeniz gerekir, bu nedenle bazı temel numaralar yapmanız gerekir:
{% endhint %}

## Temel Numaralar

### **SSRF**

GCP metadata'sını **numaralandırma** hakkında daha fazla bilgi için aşağıdaki hacktricks sayfasını kontrol edin:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

GCP'de kim olduğunuzu tahmin etmeye çalışmak için birkaç seçenek deneyebilirsiniz:

{% code overflow="wrap" %}
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
{% endcode %}

Kullanıcı hakkında daha fazla bilgi almak için `/userinfo` API uç noktasını da kullanabilirsiniz:

{% code overflow="wrap" %}
```bash
curl -H "Content-Type: application/x-www-form-urlencoded" -H "Authorization: OAuth $(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/userinfo

curl -H "Content-Type: application/x-www-form-urlencoded" -H "Authorization: OAuth <access_token>" https://www.googleapis.com/oauth2/v1/userinfo
```
{% endcode %}

### Org Enumeration
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### İlkeler ve IAM Sayımı

Yeterli izinleriniz varsa, **GCP hesabındaki her varlığın ayrıcalıklarını kontrol etmek**, sizin ve diğer kimliklerin neler yapabileceğini anlamanıza yardımcı olacaktır ve **ayrıcalıkları yükseltme** yollarını keşfetmenizi sağlar.

IAM'yi saymak için yeterli izniniz yoksa, bunları **kaba kuvvetle çalabilirsiniz**.\
**Sayım ve kaba kuvvet uygulama** yöntemlerini kontrol edin:

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
Artık **kimlik bilgileriniz hakkında bazı bilgilere sahip olduğunuzda** (ve eğer bir kırmızı takım üyesiyseniz umarım **tespit edilmemişsinizdir**). Ortamda hangi hizmetlerin kullanıldığını anlamanın zamanı geldi.\
Aşağıdaki bölümde **bazı yaygın hizmetleri saymanın** yollarını kontrol edebilirsiniz.
{% endhint %}

## Hizmet Sayımı

GCP, şaşırtıcı bir hizmet miktarına sahiptir, aşağıdaki sayfada **temel bilgiler, sayım** kılavuzları, **tespiti önleme** yöntemleri, **kalıcılık** sağlama ve bazıları hakkında diğer **sonrası istismar** hilelerini bulacaksınız:

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

Tüm çalışmayı **manuel** olarak yapmanıza gerek olmadığını unutmayın, bu yazının altında **[otomatik araçlar](./#automatic-tools)** hakkında bir bölüm bulabilirsiniz.

Ayrıca, bu aşamada **kimlik doğrulaması yapılmamış kullanıcılara açık daha fazla hizmet keşfetmiş olabilirsiniz**, bunları istismar edebilirsiniz:

{% content-ref url="gcp-unauthenticated-enum-and-access/" %}
[gcp-unauthenticated-enum-and-access](gcp-unauthenticated-enum-and-access/)
{% endcontent-ref %}

## Ayrıcalık Yükseltme, Sonrası İstismar ve Kalıcılık

Bulut kimlik bilgilerini elde ettiğinizde veya bulut içinde çalışan bir hizmeti ele geçirdiğinizde en yaygın yol, **yanlış yapılandırılmış ayrıcalıkları** kötüye kullanmaktır. Bu nedenle, yapmanız gereken ilk şey ayrıcalıklarınızı saymaktır.

Ayrıca, bu sayım sırasında **izinlerin "Organizasyon"** seviyesinde de ayarlanabileceğini unutmayın.

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

{% content-ref url="gcp-post-exploitation/" %}
[gcp-post-exploitation](gcp-post-exploitation/)
{% endcontent-ref %}

{% content-ref url="gcp-persistence/" %}
[gcp-persistence](gcp-persistence/)
{% endcontent-ref %}

### Kamuya Açık Hizmetler

GCP hizmetlerini sayarken, bazı hizmetlerin **İnternete elemanlar açtığını** bulmuş olabilirsiniz (VM/Konteyner portları, veritabanları veya kuyruk hizmetleri, anlık görüntüler veya kovalar...).\
Pentester/kırmızı takım üyesi olarak, bunlarda **hassas bilgiler / zayıflıklar** bulup bulamayacağınızı her zaman kontrol etmelisiniz, çünkü bunlar size **AWS hesabına daha fazla erişim** sağlayabilir.

Bu kitapta, **açık GCP hizmetlerini bulma ve bunları kontrol etme** hakkında **bilgiler** bulmalısınız. **Açık ağ hizmetlerinde zayıflıkları bulma** hakkında, belirli **hizmeti** aramanızı öneririm:

{% embed url="https://book.hacktricks.xyz/" %}

## GCP <--> Workspace Dönüşümü

**Bir** platformdaki **ilkeleri ele geçirmek**, bir saldırganın **diğerini ele geçirmesine** olanak tanıyabilir, bunu kontrol edin:

{% content-ref url="gcp-to-workspace-pivoting/" %}
[gcp-to-workspace-pivoting](gcp-to-workspace-pivoting/)
{% endcontent-ref %}

## Otomatik Araçlar

* **GCloud konsolunda**, [https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard) projenin kullandığı kaynakları ve IAM'leri görebilirsiniz.
* Bu API tarafından desteklenen varlıkları burada görebilirsiniz: [https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* [**Birçok bulutta kullanılabilecek araçları burada**](../pentesting-cloud-methodology.md) kontrol edin.
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner): Bu, GCP'deki belirli kimlik bilgilerinin **hangi erişim seviyesine sahip olduğunu** belirlemeye yardımcı olabilecek bir GCP kaynak tarayıcısıdır.
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): gcloud cli kullanarak bir GCP ortamını listeleyen ve sonuçları bir dosyaya kaydeden Bash scripti.
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): Yüksek IAM ayrıcalıklarını listelemek ve bunları kötüye kullanarak GCP'de ayrıcalıkları artırmak için scriptler (listeleme scriptini çalıştırmayı başaramadım).
* [**BF My GCP Permissions**](https://github.com/carlospolop/bf\_my\_gcp\_permissions): İzinlerinizi brute force ile kırmak için script.

## gcloud config & debug
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### Capture gcloud, gsutil... network

Unutmayın ki **`gcloud`** cli ile **istekleri** **yazdırmak** için **`--log-http`** **parametresini** kullanabilirsiniz. Logların token değerini gizlemesini istemiyorsanız `gcloud config set log_http_redact_token false` kullanın.

Ayrıca, iletişimi kesmek için:
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
### OAuth token configure in gcloud

**Metadata uç noktasından sızdırılmış bir hizmet hesabı OAuth token'ını kullanmak için** sadece şunu yapabilirsiniz:
```bash
# Via env vars
export CLOUDSDK_AUTH_ACCESS_TOKEN=<token>
gcloud projects list

# Via setup
echo "<token>" > /some/path/to/token
gcloud config set auth/access_token_file /some/path/to/token
gcloud projects list
gcloud config unset auth/access_token_file
```
## Referanslar

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
