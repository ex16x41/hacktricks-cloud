# GCP Pentesting

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</details>
{% endhint %}

## Temel Bilgiler

**GCP ortamÄ±nda pentesting yapmaya baÅŸlamadan Ã¶nce**, nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamanÄ±za yardÄ±mcÄ± olacak birkaÃ§ **temel ÅŸeyi bilmeniz gerekir**. Bu, yanlÄ±ÅŸ yapÄ±landÄ±rmalarÄ± nasÄ±l bulacaÄŸÄ±nÄ±zÄ± ve bunlardan nasÄ±l yararlanacaÄŸÄ±nÄ±zÄ± anlamanÄ±za yardÄ±mcÄ± olacaktÄ±r.

**Organizasyon** hiyerarÅŸisi, **izinler** ve diÄŸer temel kavramlar gibi kavramlar ÅŸu belgede aÃ§Ä±klanmÄ±ÅŸtÄ±r:

{% content-ref url="gcp-basic-information/" %}
[gcp-basic-information](gcp-basic-information/)
{% endcontent-ref %}

## Ã–ÄŸrenmek iÃ§in Laboratuvarlar

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/lacioffi/GCP-pentest-lab/](https://github.com/lacioffi/GCP-pentest-lab/)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## GCP Pentester/Red Team Metodolojisi

Bir GCP ortamÄ±nÄ± denetlemek iÃ§in hangi **hizmetlerin kullanÄ±ldÄ±ÄŸÄ±nÄ±**, neyin **aÃ§Ä±kta olduÄŸunu**, kimin neye **eriÅŸimi** olduÄŸunu ve iÃ§ GCP hizmetlerinin **dÄ±ÅŸ hizmetlerle** nasÄ±l baÄŸlantÄ±lÄ± olduÄŸunu bilmek Ã§ok Ã¶nemlidir.

Red Team bakÄ±ÅŸ aÃ§Ä±sÄ±ndan, bir GCP ortamÄ±nÄ± **ele geÃ§irmenin ilk adÄ±mÄ±** bazÄ± **kimlik bilgilerini** elde etmektir. Ä°ÅŸte bunu yapmanÄ±n bazÄ± yollarÄ±:

* github (veya benzeri) **Leaks** - OSINT
* **Sosyal** MÃ¼hendislik (SayfayÄ± kontrol edin [**Workspace Security**](../workspace-security/))
* **Åifre** yeniden kullanÄ±mÄ± (ÅŸifre sÄ±zÄ±ntÄ±larÄ±)
* GCP'de barÄ±ndÄ±rÄ±lan uygulamalardaki gÃ¼venlik aÃ§Ä±klarÄ±
* [**Server Side Request Forgery**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) ile metadata endpoint'e eriÅŸim
* **Yerel Dosya Okuma**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* 3. taraflarÄ±n **ihlal edilmesi**
* **Ä°Ã§** Ã‡alÄ±ÅŸan

Veya **aÃ§Ä±kta olan kimlik doÄŸrulamasÄ± yapÄ±lmamÄ±ÅŸ bir hizmeti** ele geÃ§irerek:

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

Veya bir **inceleme** yapÄ±yorsanÄ±z, bu rollere sahip **kimlik bilgilerini** isteyebilirsiniz:

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
Kimlik bilgilerini elde ettikten sonra, bu kimlik bilgilerinin **kime ait olduÄŸunu** ve **neye eriÅŸimleri olduÄŸunu** bilmeniz gerekir, bu yÃ¼zden bazÄ± temel enumarasyonlar yapmanÄ±z gerekir:
{% endhint %}

## Temel Enumarasyon

### **SSRF**

GCP metadata'sÄ±nÄ± **enumere etmek** hakkÄ±nda daha fazla bilgi iÃ§in aÅŸaÄŸÄ±daki hacktricks sayfasÄ±nÄ± kontrol edin:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

GCP'de kim olduÄŸunuzu tahmin etmek iÃ§in birkaÃ§ seÃ§eneÄŸi deneyebilirsiniz:

{% code overflow="wrap" %}
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
{% endcode %}

### Org Enumeration

### Org Enumeration

GCP'de bir organizasyonun varlÄ±klarÄ±nÄ± ve yapÄ±landÄ±rmalarÄ±nÄ± keÅŸfetmek, pentesting sÃ¼recinin Ã¶nemli bir parÃ§asÄ±dÄ±r. Bu sÃ¼reÃ§, organizasyonun gÃ¼venlik duruÅŸunu anlamak ve potansiyel zayÄ±flÄ±klarÄ± belirlemek iÃ§in gereklidir.

#### GCP'de OrganizasyonlarÄ± Listeleme

GCP'de organizasyonlarÄ± listelemek iÃ§in `gcloud` komut satÄ±rÄ± aracÄ±nÄ± kullanabilirsiniz:

```bash
gcloud organizations list
```

Bu komut, eriÅŸiminiz olan tÃ¼m organizasyonlarÄ± listeler.

#### Projeleri Listeleme

Bir organizasyon iÃ§indeki projeleri listelemek iÃ§in aÅŸaÄŸÄ±daki komutu kullanabilirsiniz:

```bash
gcloud projects list --filter="parent.id=ORGANIZATION_ID"
```

Bu komut, belirli bir organizasyon kimliÄŸi (ORGANIZATION_ID) ile iliÅŸkili tÃ¼m projeleri listeler.

#### IAM Rolleri ve Ãœyeleri Listeleme

Bir organizasyondaki IAM (Identity and Access Management) rollerini ve Ã¼yelerini listelemek iÃ§in ÅŸu komutu kullanabilirsiniz:

```bash
gcloud iam roles list --organization=ORGANIZATION_ID
```

Bu komut, belirli bir organizasyon kimliÄŸi (ORGANIZATION_ID) ile iliÅŸkili tÃ¼m IAM rollerini listeler.

### IAM Rolleri ve Ä°zinleri

IAM rolleri ve izinleri, GCP'deki kaynaklara kimlerin eriÅŸebileceÄŸini ve bu kaynaklarla neler yapabileceklerini belirler. IAM politikalarÄ±nÄ± anlamak, pentesting sÃ¼recinde kritik bir adÄ±mdÄ±r.

#### IAM PolitikalarÄ±nÄ± GÃ¶rÃ¼ntÃ¼leme

Bir projenin IAM politikasÄ±nÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in ÅŸu komutu kullanabilirsiniz:

```bash
gcloud projects get-iam-policy PROJECT_ID
```

Bu komut, belirli bir proje kimliÄŸi (PROJECT_ID) ile iliÅŸkili IAM politikasÄ±nÄ± dÃ¶ndÃ¼rÃ¼r.

#### IAM Rolleri ve Ä°zinlerini Analiz Etme

IAM rolleri ve izinlerini analiz etmek, hangi kullanÄ±cÄ±larÄ±n hangi kaynaklara eriÅŸimi olduÄŸunu anlamak iÃ§in Ã¶nemlidir. Bu analiz, potansiyel gÃ¼venlik aÃ§Ä±klarÄ±nÄ± belirlemenize yardÄ±mcÄ± olabilir.

### SonuÃ§

GCP'de org enumeration, pentesting sÃ¼recinin kritik bir parÃ§asÄ±dÄ±r. OrganizasyonlarÄ±, projeleri ve IAM rollerini listelemek, gÃ¼venlik duruÅŸunu anlamak ve potansiyel zayÄ±flÄ±klarÄ± belirlemek iÃ§in gereklidir. Bu bilgiler, pentesting sÃ¼recinde daha derinlemesine analizler yapmanÄ±za ve gÃ¼venlik aÃ§Ä±klarÄ±nÄ± etkili bir ÅŸekilde bulmanÄ±za yardÄ±mcÄ± olacaktÄ±r.
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### Principals & IAM Enumeration

EÄŸer yeterli izinlere sahipseniz, **GCP hesabÄ±ndaki her bir varlÄ±ÄŸÄ±n ayrÄ±calÄ±klarÄ±nÄ± kontrol etmek**, sizin ve diÄŸer kimliklerin neler yapabileceÄŸini ve nasÄ±l **ayrÄ±calÄ±klarÄ± yÃ¼kseltebileceÄŸinizi** anlamanÄ±za yardÄ±mcÄ± olacaktÄ±r.

EÄŸer IAM'i numaralandÄ±rmak iÃ§in yeterli izinlere sahip deÄŸilseniz, bunlarÄ± **brute-force ile Ã§alabilirsiniz**.\
**NumaralandÄ±rma ve brute-forcing nasÄ±l yapÄ±lÄ±r** kontrol edin:

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
ArtÄ±k **kimlik bilgileriniz hakkÄ±nda bazÄ± bilgilere sahipsiniz** (ve eÄŸer bir red team iseniz umarÄ±m **tespit edilmediniz**). Ortamda hangi hizmetlerin kullanÄ±ldÄ±ÄŸÄ±nÄ± anlamanÄ±n zamanÄ± geldi.\
AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde **bazÄ± yaygÄ±n hizmetleri numaralandÄ±rmanÄ±n** yollarÄ±nÄ± kontrol edebilirsiniz.
{% endhint %}

## Services Enumeration

GCP'nin ÅŸaÅŸÄ±rtÄ±cÄ± miktarda hizmeti vardÄ±r, aÅŸaÄŸÄ±daki sayfada **temel bilgiler, numaralandÄ±rma** hile sayfalarÄ±, **tespitten kaÃ§Ä±nma**, **kalÄ±cÄ±lÄ±k** elde etme ve bazÄ±larÄ± hakkÄ±nda diÄŸer **post-exploitation** hilelerini bulacaksÄ±nÄ±z:

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

TÃ¼m iÅŸleri **manuel olarak** yapmanÄ±z gerekmediÄŸini unutmayÄ±n, bu gÃ¶nderinin aÅŸaÄŸÄ±sÄ±nda **otomatik araÃ§lar hakkÄ±nda** bir **bÃ¶lÃ¼m** bulabilirsiniz.

AyrÄ±ca, bu aÅŸamada **kimliÄŸi doÄŸrulanmamÄ±ÅŸ kullanÄ±cÄ±lara maruz kalan daha fazla hizmet keÅŸfetmiÅŸ olabilirsiniz**, bunlarÄ± istismar edebilirsiniz:

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

## Privilege Escalation, Post Exploitation & Persistence

BazÄ± bulut kimlik bilgilerini elde ettiÄŸinizde veya bulut iÃ§inde Ã§alÄ±ÅŸan bir hizmeti ele geÃ§irdiÄŸinizde en yaygÄ±n yol, ele geÃ§irilen hesabÄ±n sahip olabileceÄŸi **yanlÄ±ÅŸ yapÄ±landÄ±rÄ±lmÄ±ÅŸ ayrÄ±calÄ±klarÄ± kÃ¶tÃ¼ye kullanmaktÄ±r**. Bu yÃ¼zden yapmanÄ±z gereken ilk ÅŸey, ayrÄ±calÄ±klarÄ±nÄ±zÄ± numaralandÄ±rmaktÄ±r.

AyrÄ±ca, bu numaralandÄ±rma sÄ±rasÄ±nda, **izinlerin "Organization" seviyesinin en Ã¼stÃ¼nde ayarlanabileceÄŸini** unutmayÄ±n.

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

{% content-ref url="gcp-post-exploitation/" %}
[gcp-post-exploitation](gcp-post-exploitation/)
{% endcontent-ref %}

{% content-ref url="gcp-persistence/" %}
[gcp-persistence](gcp-persistence/)
{% endcontent-ref %}

### Publicly Exposed Services

GCP hizmetlerini numaralandÄ±rÄ±rken bazÄ±larÄ±nÄ± **Ä°nternete maruz bÄ±rakan Ã¶ÄŸeler** (VM/Konteyner portlarÄ±, veritabanlarÄ± veya kuyruk hizmetleri, anlÄ±k gÃ¶rÃ¼ntÃ¼ler veya kovalar...) bulmuÅŸ olabilirsiniz.\
Bir pentester/red teamer olarak her zaman **hassas bilgi / gÃ¼venlik aÃ§Ä±klarÄ±** bulup bulamayacaÄŸÄ±nÄ±zÄ± kontrol etmelisiniz Ã§Ã¼nkÃ¼ bunlar size **AWS hesabÄ±na daha fazla eriÅŸim saÄŸlayabilir**.

Bu kitapta **maruz kalan GCP hizmetlerini nasÄ±l bulacaÄŸÄ±nÄ±z ve nasÄ±l kontrol edeceÄŸiniz** hakkÄ±nda **bilgi** bulmalÄ±sÄ±nÄ±z. Maruz kalan aÄŸ hizmetlerinde **gÃ¼venlik aÃ§Ä±klarÄ±nÄ± nasÄ±l bulacaÄŸÄ±nÄ±z** hakkÄ±nda, belirli **hizmeti** **araÅŸtÄ±rmanÄ±zÄ±** tavsiye ederim:

{% embed url="https://book.hacktricks.xyz/" %}

## GCP <--> Workspace Pivoting

**Bir** platformdaki kimlikleri **ele geÃ§irmek**, bir saldÄ±rganÄ±n **diÄŸerini ele geÃ§irmesine** izin verebilir, bunu kontrol edin:

{% content-ref url="gcp-to-workspace-pivoting/" %}
[gcp-to-workspace-pivoting](gcp-to-workspace-pivoting/)
{% endcontent-ref %}

## Automatic Tools

* **GCloud konsolunda**, [https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard) adresinde proje tarafÄ±ndan kullanÄ±lan kaynaklarÄ± ve IAM'leri gÃ¶rebilirsiniz.
* Bu API tarafÄ±ndan desteklenen varlÄ±klarÄ± burada gÃ¶rebilirsiniz: [https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* **Birden fazla bulutta kullanÄ±labilecek araÃ§larÄ±** [**burada kontrol edin**](../pentesting-cloud-methodology.md).
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner): Bu, GCP'de belirli kimlik bilgilerine sahip eriÅŸim seviyesini belirlemeye yardÄ±mcÄ± olabilecek bir GCP kaynak tarayÄ±cÄ±sÄ±dÄ±r.
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): gcloud cli kullanarak bir GCP ortamÄ±nÄ± listelemek ve sonuÃ§larÄ± bir dosyada kaydetmek iÃ§in Bash betiÄŸi.
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): YÃ¼ksek IAM ayrÄ±calÄ±klarÄ±nÄ± listelemek ve bunlarÄ± kÃ¶tÃ¼ye kullanarak GCP'de ayrÄ±calÄ±klarÄ± yÃ¼kseltmek iÃ§in betikler (listeleme betiÄŸini Ã§alÄ±ÅŸtÄ±ramadÄ±m).
* [**BF My GCP Permissions**](https://github.com/carlospolop/bf\_my\_gcp\_permissions): Ä°zinlerinizi brute force ile test etmek iÃ§in betik.

## gcloud config & debug
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### gcloud, gsutil... aÄŸÄ±nÄ± yakalama

**`gcloud`** cli ile **istekleri** **yazdÄ±rmak** iÃ§in **`--log-http`** **parametresini** kullanabileceÄŸinizi unutmayÄ±n. GÃ¼nlÃ¼klerin token deÄŸerini sansÃ¼rlemesini istemiyorsanÄ±z `gcloud config set log_http_redact_token false` kullanÄ±n.

AyrÄ±ca, iletiÅŸimi kesmek iÃ§in:
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
### OAuth token'Ä± gcloud'da yapÄ±landÄ±rma

**Metadata endpoint'inden sÄ±zdÄ±rÄ±lmÄ±ÅŸ bir service account OAuth token'Ä±nÄ± kullanmak** iÃ§in sadece ÅŸunu yapabilirsiniz:
```bash
# Via env vars
export CLOUDSDK_AUTH_ACCESS_TOKEN=<token>
gcloud projects list

# Via setup
echo "<token>" > /some/path/to/token
gcloud config set auth/access_token_file /some/path/to/token
gcloud projects list
gcloud config unset auth/access_token_file
```
## Referanslar

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸren & pratik yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸren & pratik yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekle</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol et!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±l veya bizi **Twitter**'da takip et ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸ.

</details>
{% endhint %}
