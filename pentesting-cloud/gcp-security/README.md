# GCP Pentesting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## 基本信息

**在开始进行GCP环境的pentesting之前**，您需要了解一些**基本知识**，以帮助您理解需要做什么、如何查找错误配置以及如何利用它们。

诸如**组织**层次结构、**权限**和其他基本概念在以下内容中进行了说明：

{% content-ref url="gcp-basic-information/" %}
[gcp-basic-information](gcp-basic-information/)
{% endcontent-ref %}

## 学习实验室

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/lacioffi/GCP-pentest-lab/](https://github.com/lacioffi/GCP-pentest-lab/)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## GCP Pentester/Red Team 方法论

为了审计GCP环境，了解以下内容非常重要：使用了哪些**服务**，什么是**被暴露的**，谁对什么有**访问权限**，以及内部GCP服务与**外部服务**是如何连接的。

从Red Team的角度来看，**攻陷GCP环境的第一步**是设法获取一些**凭证**。以下是一些获取凭证的想法：

* 在github（或类似平台）中的**泄露** - OSINT
* **社会**工程（查看页面 [**Workspace Security**](../workspace-security/)）
* **密码**重用（密码泄露）
* GCP托管应用中的漏洞
* [**服务器端请求伪造**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) 访问元数据端点
* **本地文件读取**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* 第三方**被攻破**
* **内部**员工

或者通过**攻陷一个未认证的服务**：

{% content-ref url="gcp-unauthenticated-enum-and-access/" %}
[gcp-unauthenticated-enum-and-access](gcp-unauthenticated-enum-and-access/)
{% endcontent-ref %}

或者如果您正在进行**审查**，您可以直接**请求凭证**，使用这些角色：

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
在您成功获取凭证后，您需要知道**这些凭证属于谁**，以及**他们可以访问什么**，因此您需要进行一些基本的枚举：
{% endhint %}

## 基本枚举

### **SSRF**

有关如何**枚举GCP元数据**的更多信息，请查看以下hacktricks页面：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

在GCP中，您可以尝试几种选项来猜测您是谁：

{% code overflow="wrap" %}
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
{% endcode %}

您还可以使用 API 端点 `/userinfo` 获取有关用户的更多信息：

{% code overflow="wrap" %}
```bash
curl -H "Content-Type: application/x-www-form-urlencoded" -H "Authorization: OAuth $(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/userinfo

curl -H "Content-Type: application/x-www-form-urlencoded" -H "Authorization: OAuth <access_token>" https://www.googleapis.com/oauth2/v1/userinfo
```
{% endcode %}

### 组织枚举
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### Principals & IAM Enumeration

如果您拥有足够的权限，**检查 GCP 账户内每个实体的权限**将帮助您了解您和其他身份可以做什么，以及如何**提升权限**。

如果您没有足够的权限来枚举 IAM，您可以**通过暴力破解来获取**它们。\
查看**如何进行枚举和暴力破解**：

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
现在您**已经获得了一些关于您凭据的信息**（如果您是红队，希望您**没有被发现**）。是时候找出环境中正在使用哪些服务。\
在接下来的部分中，您可以查看一些**枚举常见服务**的方法。
{% endhint %}

## Services Enumeration

GCP 拥有惊人的服务数量，在以下页面中，您将找到**基本信息、枚举**备忘单，如何**避免检测**，获取**持久性**以及其他关于其中一些服务的**后期利用**技巧：

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

请注意，您**不**需要**手动**执行所有工作，下面的帖子中您可以找到关于[**自动工具**](./#automatic-tools)的**部分**。

此外，在此阶段，您可能会发现**更多暴露给未认证用户的服务，**您可能能够利用它们：

{% content-ref url="gcp-unauthenticated-enum-and-access/" %}
[gcp-unauthenticated-enum-and-access](gcp-unauthenticated-enum-and-access/)
{% endcontent-ref %}

## Privilege Escalation, Post Exploitation & Persistence

一旦您获得了一些云凭据或已妥协某个在云中运行的服务，最常见的方法是**滥用被妥协账户可能拥有的错误配置权限**。因此，您应该做的第一件事是枚举您的权限。

此外，在此枚举过程中，请记住**权限可以在“组织”的最高级别设置**。

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

{% content-ref url="gcp-post-exploitation/" %}
[gcp-post-exploitation](gcp-post-exploitation/)
{% endcontent-ref %}

{% content-ref url="gcp-persistence/" %}
[gcp-persistence](gcp-persistence/)
{% endcontent-ref %}

### Publicly Exposed Services

在枚举 GCP 服务时，您可能发现其中一些**向互联网暴露元素**（VM/容器端口、数据库或队列服务、快照或存储桶...）。\
作为渗透测试者/红队成员，您应该始终检查是否可以在它们上找到**敏感信息/漏洞**，因为它们可能为您提供**进一步访问 AWS 账户**的机会。

在本书中，您应该找到关于如何查找**暴露的 GCP 服务以及如何检查它们**的信息。关于如何查找**暴露网络服务中的漏洞**，我建议您**搜索**特定的**服务**：

{% embed url="https://book.hacktricks.xyz/" %}

## GCP <--> Workspace Pivoting

**妥协**一个平台中的主体可能允许攻击者**妥协另一个平台**，请查看：

{% content-ref url="gcp-to-workspace-pivoting/" %}
[gcp-to-workspace-pivoting](gcp-to-workspace-pivoting/)
{% endcontent-ref %}

## Automatic Tools

* 在**GCloud 控制台**中，您可以在 [https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard) 查看项目使用的资源和 IAM。
* 在这里，您可以查看此 API 支持的资产： [https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* 检查可以在[**多个云中使用的工具**](../pentesting-cloud-methodology.md)。
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner)：这是一个 GCP 资源扫描器，可以帮助确定某些凭据在 GCP 上**拥有的访问级别**。
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): Bash 脚本，用于使用 gcloud cli 枚举 GCP 环境并将结果保存到文件中。
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): 脚本用于枚举高 IAM 权限并在 GCP 中利用它们提升权限（我无法运行枚举脚本）。
* [**BF My GCP Permissions**](https://github.com/carlospolop/bf\_my\_gcp\_permissions): 脚本用于暴力破解您的权限。

## gcloud config & debug
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### 捕获 gcloud, gsutil... 网络

请记住，您可以使用 **参数** **`--log-http`** 与 **`gcloud`** cli 一起 **打印** 工具正在执行的 **请求**。如果您不希望日志遮蔽令牌值，请使用 `gcloud config set log_http_redact_token false`

此外，要拦截通信：
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
### 在 gcloud 中配置 OAuth 令牌

为了**使用从元数据端点提取的服务帐户 OAuth 令牌**，您只需执行：
```bash
# Via env vars
export CLOUDSDK_AUTH_ACCESS_TOKEN=<token>
gcloud projects list

# Via setup
echo "<token>" > /some/path/to/token
gcloud config set auth/access_token_file /some/path/to/token
gcloud projects list
gcloud config unset auth/access_token_file
```
## 参考文献

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
学习与实践 AWS Hacking：<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
学习与实践 GCP Hacking：<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
