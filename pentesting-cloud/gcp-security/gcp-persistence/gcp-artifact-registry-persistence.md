# GCP - Persist√™ncia do Artifact Registry

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Artifact Registry

Para mais informa√ß√µes sobre o Artifact Registry, confira:

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### Confus√£o de Depend√™ncia

* O que acontece se um **reposit√≥rio remoto e um padr√£o** **forem misturados em um** virtual e um pacote existir em ambos?
* O que tiver a **maior prioridade definida no reposit√≥rio virtual** √© usado
* Se a **prioridade for a mesma**:
* Se a **vers√£o** for a **mesma**, o **nome da pol√≠tica em ordem alfab√©tica** primeiro no reposit√≥rio virtual √© usado
* Se n√£o, a **maior vers√£o** √© usada

{% hint style="danger" %}
Portanto, √© poss√≠vel **abusar de uma maior vers√£o (confus√£o de depend√™ncia)** em um registro de pacotes p√∫blico se o reposit√≥rio remoto tiver uma prioridade maior ou igual
{% endhint %}

Essa t√©cnica pode ser √∫til para **persist√™ncia** e **acesso n√£o autenticado**, pois para abusar dela, basta **saber o nome de uma biblioteca** armazenada no Artifact Registry e **criar essa mesma biblioteca no reposit√≥rio p√∫blico (PyPi para python, por exemplo)** com uma vers√£o maior.

Para persist√™ncia, esses s√£o os passos que voc√™ precisa seguir:

* **Requisitos**: Um **reposit√≥rio virtual** deve **existir** e ser usado, um **pacote interno** com um **nome** que n√£o exista no **reposit√≥rio p√∫blico** deve ser usado.
* Crie um reposit√≥rio remoto se ele n√£o existir
* Adicione o reposit√≥rio remoto ao reposit√≥rio virtual
* Edite as pol√≠ticas do registro virtual para dar uma prioridade maior (ou igual) ao reposit√≥rio remoto.\
Execute algo como:
* [gcloud artifacts repositories update --upstream-policy-file ...](https://cloud.google.com/sdk/gcloud/reference/artifacts/repositories/update#--upstream-policy-file)
* Baixe o pacote leg√≠timo, adicione seu c√≥digo malicioso e registre-o no reposit√≥rio p√∫blico com a mesma vers√£o. Sempre que um desenvolvedor instal√°-lo, ele instalar√° o seu!

Para mais informa√ß√µes sobre confus√£o de depend√™ncia, confira:

{% embed url="https://book.hacktricks.xyz/pentesting-web/dependency-confusion" %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
