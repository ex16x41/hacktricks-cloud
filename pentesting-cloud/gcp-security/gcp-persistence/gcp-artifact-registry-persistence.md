# GCP - Artifact Registry Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Artifact Registry

Για περισσότερες πληροφορίες σχετικά με το Artifact Registry ελέγξτε:

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### Dependency Confusion

* Τι συμβαίνει αν **μειχθούν** ένα **απομακρυσμένο και ένα κανονικό** αποθετήριο σε ένα **εικονικό** και ένα πακέτο υπάρχει και στα δύο;
* Το πακέτο με την **υψηλότερη προτεραιότητα που έχει οριστεί στο εικονικό αποθετήριο** χρησιμοποιείται
* Αν η **προτεραιότητα είναι η ίδια**:
* Αν η **έκδοση** είναι η **ίδια**, το **όνομα πολιτικής αλφαβητικά** πρώτο στο εικονικό αποθετήριο χρησιμοποιείται
* Αν όχι, χρησιμοποιείται η **υψηλότερη έκδοση**

{% hint style="danger" %}
Επομένως, είναι δυνατόν να **καταχραστεί μια υψηλότερη έκδοση (dependency confusion)** σε ένα δημόσιο αποθετήριο πακέτων αν το απομακρυσμένο αποθετήριο έχει υψηλότερη ή ίδια προτεραιότητα
{% endhint %}

Αυτή η τεχνική μπορεί να είναι χρήσιμη για **persistency** και **μη αυθεντικοποιημένη πρόσβαση** καθώς για να την καταχραστείς απαιτείται απλώς να **γνωρίζεις το όνομα μιας βιβλιοθήκης** που αποθηκεύεται στο Artifact Registry και να **δημιουργήσεις την ίδια βιβλιοθήκη στο δημόσιο αποθετήριο (PyPi για python για παράδειγμα)** με υψηλότερη έκδοση.

Για persistency αυτά είναι τα βήματα που πρέπει να ακολουθήσεις:

* **Απαιτήσεις**: Ένα **εικονικό αποθετήριο** πρέπει να **υπάρχει** και να χρησιμοποιείται, ένα **εσωτερικό πακέτο** με ένα **όνομα** που δεν υπάρχει στο **δημόσιο αποθετήριο** πρέπει να χρησιμοποιείται.
* Δημιουργήστε ένα απομακρυσμένο αποθετήριο αν δεν υπάρχει
* Προσθέστε το απομακρυσμένο αποθετήριο στο εικονικό αποθετήριο
* Επεξεργαστείτε τις πολιτικές του εικονικού αποθετηρίου για να δώσετε υψηλότερη προτεραιότητα (ή ίδια) στο απομακρυσμένο αποθετήριο.\
Εκτελέστε κάτι σαν:
* [gcloud artifacts repositories update --upstream-policy-file ...](https://cloud.google.com/sdk/gcloud/reference/artifacts/repositories/update#--upstream-policy-file)
* Κατεβάστε το νόμιμο πακέτο, προσθέστε τον κακόβουλο κώδικά σας και καταχωρίστε το στο δημόσιο αποθετήριο με την ίδια έκδοση. Κάθε φορά που ένας προγραμματιστής το εγκαθιστά, θα εγκαθιστά το δικό σας!

Για περισσότερες πληροφορίες σχετικά με την dependency confusion ελέγξτε:

{% embed url="https://book.hacktricks.xyz/pentesting-web/dependency-confusion" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
