# GCP - Artifact Registry Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Artifact Registry

Artifact Registry에 대한 자세한 정보는 다음을 확인하세요:

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### Dependency Confusion

* **원격 및 표준** 저장소가 **가상** 저장소에서 혼합되고 두 곳에 패키지가 존재하면 어떻게 됩니까?
* **가상 저장소에서 설정된 우선 순위가 가장 높은** 것이 사용됩니다.
* **우선 순위가 동일한 경우**:
* **버전**이 **동일한 경우**, 가상 저장소에서 **정책 이름이 알파벳 순서로 먼저** 사용됩니다.
* 그렇지 않으면 **가장 높은 버전**이 사용됩니다.

{% hint style="danger" %}
따라서 원격 저장소의 우선 순위가 더 높거나 동일한 경우 공개 패키지 레지스트리에서 **가장 높은 버전(의존성 혼란)**을 **악용**할 수 있습니다.
{% endhint %}

이 기술은 **지속성** 및 **인증되지 않은 접근**에 유용할 수 있으며, 이를 악용하려면 Artifact Registry에 저장된 **라이브러리 이름**을 **알고** 있어야 하고, **공개 저장소(예: Python의 PyPi)**에 동일한 라이브러리를 더 높은 버전으로 **생성**해야 합니다.

지속성을 위해 따라야 할 단계는 다음과 같습니다:

* **요구 사항**: **가상 저장소**가 **존재**하고 사용되어야 하며, **공개 저장소**에 존재하지 않는 **이름**을 가진 **내부 패키지**가 사용되어야 합니다.
* 원격 저장소가 존재하지 않으면 생성합니다.
* 원격 저장소를 가상 저장소에 추가합니다.
* 원격 저장소에 더 높은 우선 순위(또는 동일한)를 부여하도록 가상 레지스트리의 정책을 편집합니다.\
다음과 같은 명령을 실행합니다:
* [gcloud artifacts repositories update --upstream-policy-file ...](https://cloud.google.com/sdk/gcloud/reference/artifacts/repositories/update#--upstream-policy-file)
* 합법적인 패키지를 다운로드하고, 악성 코드를 추가한 후 동일한 버전으로 공개 저장소에 등록합니다. 개발자가 이를 설치할 때마다 자신의 패키지가 설치됩니다!

의존성 혼란에 대한 자세한 정보는 다음을 확인하세요:

{% embed url="https://book.hacktricks.xyz/pentesting-web/dependency-confusion" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
