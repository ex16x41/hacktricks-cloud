# GCP - Artifact Registry Persistence

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Artifact Registry

F√ºr weitere Informationen √ºber Artifact Registry siehe:

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### Dependency Confusion

* Was passiert, wenn **remote und standard** Repositories **in einem virtuellen** gemischt werden und ein Paket in beiden existiert?
* Das mit der **h√∂chsten Priorit√§t, die im virtuellen Repository festgelegt ist**, wird verwendet
* Wenn die **Priorit√§t gleich ist**:
* Wenn die **Version** die **gleiche** ist, wird der **Policy-Name alphabetisch** zuerst im virtuellen Repository verwendet
* Wenn nicht, wird die **h√∂chste Version** verwendet

{% hint style="danger" %}
Daher ist es m√∂glich, eine **h√∂chste Version (dependency confusion)** in einem √∂ffentlichen Paket-Registry auszunutzen, wenn das remote Repository eine h√∂here oder gleiche Priorit√§t hat
{% endhint %}

Diese Technik kann n√ºtzlich sein f√ºr **Persistenz** und **unauthentifizierten Zugriff**, da es nur erforderlich ist, **einen Bibliotheksnamen** zu kennen, der im Artifact Registry gespeichert ist, und **diese gleiche Bibliothek im √∂ffentlichen Repository (PyPi f√ºr Python zum Beispiel)** mit einer h√∂heren Version zu erstellen.

F√ºr Persistenz sind dies die Schritte, die du befolgen musst:

* **Anforderungen**: Ein **virtuelles Repository** muss **existieren** und verwendet werden, ein **internes Paket** mit einem **Namen**, der im **√∂ffentlichen Repository** nicht existiert, muss verwendet werden.
* Erstelle ein remote Repository, falls es nicht existiert
* F√ºge das remote Repository zum virtuellen Repository hinzu
* Bearbeite die Richtlinien des virtuellen Repositories, um dem remote Repository eine h√∂here (oder gleiche) Priorit√§t zu geben.\
F√ºhre etwas wie aus:
* [gcloud artifacts repositories update --upstream-policy-file ...](https://cloud.google.com/sdk/gcloud/reference/artifacts/repositories/update#--upstream-policy-file)
* Lade das legitime Paket herunter, f√ºge deinen sch√§dlichen Code hinzu und registriere es im √∂ffentlichen Repository mit der gleichen Version. Jedes Mal, wenn ein Entwickler es installiert, wird er deins installieren!

F√ºr weitere Informationen √ºber Dependency Confusion siehe:

{% embed url="https://book.hacktricks.xyz/pentesting-web/dependency-confusion" %}

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
