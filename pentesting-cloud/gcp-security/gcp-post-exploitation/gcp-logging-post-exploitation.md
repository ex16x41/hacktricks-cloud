# GCP - Logging Post Exploitation

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

Para mais informa√ß√µes, confira:

{% content-ref url="../gcp-services/gcp-logging-enum.md" %}
[gcp-logging-enum.md](../gcp-services/gcp-logging-enum.md)
{% endcontent-ref %}

Para outras maneiras de interromper o monitoramento, confira:

{% content-ref url="gcp-monitoring-post-exploitation.md" %}
[gcp-monitoring-post-exploitation.md](gcp-monitoring-post-exploitation.md)
{% endcontent-ref %}

### Logging Padr√£o

**Por padr√£o, voc√™ n√£o ser√° pego apenas por realizar a√ß√µes de leitura. Para mais informa√ß√µes, confira a se√ß√£o Logging Enum.**

### Adicionar Principal Exce√ß√£o

Em [https://console.cloud.google.com/iam-admin/audit/allservices](https://console.cloud.google.com/iam-admin/audit/allservices) e [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) √© poss√≠vel adicionar principais para n√£o gerar logs. Um atacante poderia abusar disso para evitar ser pego.

### Ler logs - `logging.logEntries.list`

{% code overflow="wrap" %}
```bash
# Read logs
gcloud logging read "logName=projects/your-project-id/logs/log-id" --limit=10 --format=json

# Everything from a timestamp
gcloud logging read "timestamp >= \"2023-01-01T00:00:00Z\"" --limit=10 --format=json

# Use these options to indicate a different bucket or view to use: --bucket=_Required  --view=_Default
```
{% endcode %}

### `logging.logs.delete`

{% code overflow="wrap" %}
```bash
# Delete all entries from a log in the _Default log bucket - logging.logs.delete
gcloud logging logs delete <log-name>
```
{% endcode %}

### Escrever logs - `logging.logEntries.create`

{% code overflow="wrap" %}
```bash
# Write a log entry to try to disrupt some system
gcloud logging write LOG_NAME "A deceptive log entry" --severity=ERROR
```
{% endcode %}

### `logging.buckets.update`

{% code overflow="wrap" %}
```bash
# Set retention period to 1 day (_Required has a fixed one of 400days)

gcloud logging buckets update bucketlog --location=<location> --description="New description" --retention-days=1
```
{% endcode %}

### `logging.buckets.delete`

### Descri√ß√£o

Esta permiss√£o permite que um invasor exclua um bucket de registros. A exclus√£o de um bucket de registros pode ser usada para ocultar atividades maliciosas.

### Impacto

A exclus√£o de um bucket de registros pode ter um impacto significativo na capacidade de uma organiza√ß√£o de auditar e revisar atividades dentro de seu ambiente GCP. Sem esses registros, pode ser dif√≠cil ou imposs√≠vel detectar e responder a incidentes de seguran√ßa.

### Mitiga√ß√£o

Para mitigar o risco associado a esta permiss√£o, considere as seguintes a√ß√µes:

- **Princ√≠pio do menor privil√©gio**: Garanta que apenas usu√°rios e contas de servi√ßo que realmente necessitam dessa permiss√£o a possuam.
- **Monitoramento e alertas**: Configure alertas para detectar quando um bucket de registros √© exclu√≠do.
- **Revis√µes regulares de permiss√µes**: Realize revis√µes regulares das permiss√µes atribu√≠das a usu√°rios e contas de servi√ßo para garantir que n√£o haja permiss√µes excessivas.

### Refer√™ncias

- [Documenta√ß√£o do GCP sobre controle de acesso](https://cloud.google.com/iam/docs/overview)
- [Boas pr√°ticas de seguran√ßa do GCP](https://cloud.google.com/security/best-practices)

{% endcode %}
```bash
# Delete log bucket
gcloud logging buckets delete BUCKET_NAME --location=<location>
```
### `logging.links.delete`

{% code overflow="wrap" %}
```bash
# Delete link
gcloud logging links delete <link-id> --bucket <bucket> --location <location>
```
{% endcode %}

### `logging.views.delete`

### Descri√ß√£o

A permiss√£o `logging.views.delete` permite que um usu√°rio exclua uma visualiza√ß√£o de log no Google Cloud Platform (GCP). As visualiza√ß√µes de log s√£o usadas para filtrar e exibir logs espec√≠ficos em um projeto, pasta ou organiza√ß√£o. Excluir uma visualiza√ß√£o de log pode ser √∫til para ocultar atividades maliciosas ou limpar evid√™ncias de um ataque.

### Impacto

Excluir visualiza√ß√µes de log pode ter v√°rios impactos:

- **Oculta√ß√£o de Atividades:** Um invasor pode excluir visualiza√ß√µes de log para ocultar suas atividades maliciosas.
- **Perda de Dados:** Logs importantes podem ser perdidos se as visualiza√ß√µes associadas forem exclu√≠das.
- **Dificuldade na Auditoria:** A exclus√£o de visualiza√ß√µes de log pode dificultar a auditoria e a investiga√ß√£o de incidentes de seguran√ßa.

### Mitiga√ß√£o

Para mitigar os riscos associados √† permiss√£o `logging.views.delete`, considere as seguintes a√ß√µes:

- **Revis√£o de Permiss√µes:** Revise regularmente as permiss√µes dos usu√°rios e remova a permiss√£o `logging.views.delete` de contas que n√£o necessitam dela.
- **Monitoramento de Atividades:** Implemente monitoramento e alertas para detectar a exclus√£o de visualiza√ß√µes de log.
- **Pol√≠ticas de Reten√ß√£o de Logs:** Configure pol√≠ticas de reten√ß√£o de logs para garantir que os logs sejam preservados, mesmo que as visualiza√ß√µes sejam exclu√≠das.

### Exemplo de Uso

```bash
gcloud logging views delete my-log-view --project=my-project
```

Neste exemplo, a visualiza√ß√£o de log chamada `my-log-view` √© exclu√≠da do projeto `my-project`.

### Conclus√£o

A permiss√£o `logging.views.delete` pode ser uma ferramenta poderosa nas m√£os de um invasor. √â crucial gerenciar e monitorar cuidadosamente essa permiss√£o para proteger os logs e garantir a integridade das auditorias de seguran√ßa.
```bash
# Delete a logging view to remove access to anyone using it
gcloud logging views delete <view-id> --bucket=<bucket> --location=global
```
### `logging.views.update`

{% code overflow="wrap" %}
```bash
# Update a logging view to hide data
gcloud logging views update <view-id> --log-filter="resource.type=gce_instance" --bucket=<bucket> --location=global --description="New description for the log view"
```
{% endcode %}

### `logging.logMetrics.update`

{% code overflow="wrap" %}
```bash
# Update log based metrics - logging.logMetrics.update
gcloud logging metrics update <metric-name> --description="Changed metric description" --log-filter="severity>CRITICAL" --project=PROJECT_ID
```
{% endcode %}

### `logging.logMetrics.delete`
```bash
# Delete log based metrics - logging.logMetrics.delete
gcloud logging metrics delete <metric-name>
```
### `logging.sinks.delete`

Permiss√£o necess√°ria: `logging.sinks.delete`

Para excluir um sink de logging, voc√™ pode usar o seguinte comando:

```bash
gcloud logging sinks delete [SINK_NAME]
```

Excluir um sink de logging pode ser √∫til para evitar que logs sejam enviados para um destino espec√≠fico, como um bucket do Cloud Storage ou um t√≥pico do Pub/Sub. Isso pode ajudar a ocultar atividades maliciosas.

### `logging.logs.delete`

Permiss√£o necess√°ria: `logging.logs.delete`

Para excluir logs espec√≠ficos, voc√™ pode usar o seguinte comando:

```bash
gcloud logging logs delete [LOG_NAME]
```

Excluir logs pode ser uma maneira eficaz de cobrir rastros ap√≥s realizar atividades maliciosas em um ambiente GCP.
```bash
# Delete sink - logging.sinks.delete
gcloud logging sinks delete <sink-name>
```
### `logging.sinks.update`

{% code overflow="wrap" %}
```bash
# Disable sink - logging.sinks.update
gcloud logging sinks update <sink-name> --disabled

# Createa filter to exclude attackers logs - logging.sinks.update
gcloud logging sinks update SINK_NAME --add-exclusion="name=exclude-info-logs,filter=severity<INFO"

# Change where the sink is storing the data - logging.sinks.update
gcloud logging sinks update <sink-name> new-destination

# Change the service account to one withuot permissions to write in the destination - logging.sinks.update
gcloud logging sinks update SINK_NAME --custom-writer-identity=attacker-service-account-email --project=PROJECT_ID

# Remove explusions to try to overload with logs - logging.sinks.update
gcloud logging sinks update SINK_NAME --clear-exclusions

# If the sink exports to BigQuery, an attacker might enable or disable the use of partitioned tables, potentially leading to inefficient querying and higher costs. - logging.sinks.update
gcloud logging sinks update SINK_NAME --use-partitioned-tables
gcloud logging sinks update SINK_NAME --no-use-partitioned-tables
```
{% endcode %}

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte o HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>
{% endhint %}
