# GCP - Compute Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Compute

Compute ë° VPC(ë„¤íŠ¸ì›Œí‚¹)ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### ì´ë¯¸ì§€ë¥¼ ë¡œì»¬ë¡œ ë‚´ë³´ë‚´ê³  ê²€ì‚¬í•˜ê¸°

ì´ê²ƒì€ ê³µê²©ìê°€ **ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¯¸ì§€ì— í¬í•¨ëœ ë°ì´í„°ì— ì ‘ê·¼**í•˜ê±°ë‚˜ **ì‹¤í–‰ ì¤‘ì¸ VMì˜ ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¥¼ ìƒì„±**í•˜ê³  ì‹¤í–‰ ì¤‘ì¸ VMì— ì ‘ê·¼í•˜ì§€ ì•Šê³ ë„ í•´ë‹¹ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

VM ì´ë¯¸ì§€ë¥¼ ë²„í‚·ìœ¼ë¡œ ë‚´ë³´ë‚¸ ë‹¤ìŒ ë‹¤ìš´ë¡œë“œí•˜ê³  ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ë¡œì»¬ì— ë§ˆìš´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
{% endcode %}

ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ ê³µê²©ìëŠ” ìŠ¤í† ë¦¬ì§€ ë²„í‚·ì— ëŒ€í•œ ê¶Œí•œê³¼ **cloudbuildì— ëŒ€í•œ ê¶Œí•œ**ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **ì„œë¹„ìŠ¤**ê°€ ë‚´ë³´ë‚´ê¸°ë¥¼ ìˆ˜í–‰í•˜ë„ë¡ ìš”ì²­ë°›ì„ ê²ƒì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\
ë˜í•œ, ì´ë¥¼ ìœ„í•´ codebuild SAì™€ compute SAëŠ” ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\
cloudbuild SA `<project-id>@cloudbuild.gserviceaccount.com`ëŠ” ë‹¤ìŒì´ í•„ìš”í•©ë‹ˆë‹¤:

* roles/iam.serviceAccountTokenCreator
* roles/compute.admin
* roles/iam.serviceAccountUser

ê·¸ë¦¬ê³  SA `<project-id>-compute@developer.gserviceaccount.com`ëŠ” ë‹¤ìŒì´ í•„ìš”í•©ë‹ˆë‹¤:

* roles/compute.storageAdmin
* roles/storage.objectAdmin

### ìŠ¤ëƒ…ìƒ· ë° ë””ìŠ¤í¬ë¥¼ ë¡œì»¬ë¡œ ë‚´ë³´ë‚´ê³  ê²€ì‚¬í•˜ê¸°

ìŠ¤ëƒ…ìƒ·ê³¼ ë””ìŠ¤í¬ë¥¼ ì§ì ‘ ë‚´ë³´ë‚´ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•˜ì§€ë§Œ, **ìŠ¤ëƒ…ìƒ·ì„ ë””ìŠ¤í¬ë¡œ, ë””ìŠ¤í¬ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜**í•˜ê³  **ì´ì „ ì„¹ì…˜**ì— ë”°ë¼ í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ ë‚´ë³´ë‚´ì–´ ë¡œì»¬ì—ì„œ ê²€ì‚¬í•˜ëŠ” ê²ƒì€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
{% endcode %}

### VM ìƒì„± ì‹œ ì´ë¯¸ì§€ ê²€ì‚¬

**ì´ë¯¸ì§€ì— ì €ì¥ëœ ë°ì´í„°** ë˜ëŠ” **ê³µê²©ìê°€ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•œ ì‹¤í–‰ ì¤‘ì¸ VM** ë‚´ë¶€ì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•˜ì—¬, ì™¸ë¶€ ê³„ì •ì´ ì´ë¯¸ì§€ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```
ê·¸ë¦¬ê³  ë‚˜ì„œ ê·¸ê²ƒìœ¼ë¡œë¶€í„° ìƒˆë¡œìš´ VMì„ ìƒì„±í•©ë‹ˆë‹¤:
```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```
ë§Œì•½ ì´ë¯¸ì§€ì— ëŒ€í•œ ì™¸ë¶€ ê³„ì • ì ‘ê·¼ì„ í—ˆìš©í•  ìˆ˜ ì—†ë‹¤ë©´, í”¼í•´ìì˜ í”„ë¡œì íŠ¸ì—ì„œ í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ VMì„ ì‹œì‘í•˜ê³  **ë©”íƒ€ë°ì´í„°ê°€ ë¦¬ë²„ìŠ¤ ì…¸ì„ ì‹¤í–‰í•˜ë„ë¡ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ë§¤ê°œë³€ìˆ˜ë¥¼ ì¶”ê°€í•˜ì—¬:
```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```
### VMì— ì—°ê²°í•˜ì—¬ ìŠ¤ëƒ…ìƒ·/ë””ìŠ¤í¬ ê²€ì‚¬í•˜ê¸°

**ë””ìŠ¤í¬ë‚˜ ìŠ¤ëƒ…ìƒ·ì— ì €ì¥ëœ ë°ì´í„°ì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ, ìŠ¤ëƒ…ìƒ·ì„ ë””ìŠ¤í¬ë¡œ ë³€í™˜í•˜ê³ , ë””ìŠ¤í¬ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•œ í›„ ì´ì „ ë‹¨ê³„ë¥¼ ë”°ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

ë˜ëŠ” **ì™¸ë¶€ ê³„ì •ì— ë””ìŠ¤í¬ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤** (ì‹œì‘ì ì´ ìŠ¤ëƒ…ìƒ·ì¸ ê²½ìš° ìŠ¤ëƒ…ìƒ·ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•˜ê±°ë‚˜ ê·¸ë¡œë¶€í„° ë””ìŠ¤í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤):
```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```
**ì¸ìŠ¤í„´ìŠ¤ì— ë””ìŠ¤í¬ ì—°ê²°**:
```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```
VM ë‚´ë¶€ì— ë””ìŠ¤í¬ë¥¼ ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤:

1.  **VMì— SSH ì ‘ì†**:

```sh
gcloud compute ssh [INSTANCE_NAME] --zone [ZONE]
```
2. **ë””ìŠ¤í¬ ì‹ë³„**: VM ë‚´ë¶€ì— ë“¤ì–´ê°€ë©´ ë””ìŠ¤í¬ ì¥ì¹˜ë¥¼ ë‚˜ì—´í•˜ì—¬ ìƒˆ ë””ìŠ¤í¬ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ `/dev/sdb`, `/dev/sdc` ë“±ìœ¼ë¡œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. **ë””ìŠ¤í¬ í¬ë§· ë° ë§ˆìš´íŠ¸** (ìƒˆ ë””ìŠ¤í¬ ë˜ëŠ” ì›ì‹œ ë””ìŠ¤í¬ì¸ ê²½ìš°):
*   ë§ˆìš´íŠ¸ í¬ì¸íŠ¸ ìƒì„±:

```sh
sudo mkdir -p /mnt/disks/[MOUNT_DIR]
```
*   ë””ìŠ¤í¬ ë§ˆìš´íŠ¸:

```sh
sudo mount -o discard,defaults /dev/[DISK_DEVICE] /mnt/disks/[MOUNT_DIR]
```

**ì™¸ë¶€ í”„ë¡œì íŠ¸ì— ìŠ¤ëƒ…ìƒ· ë˜ëŠ” ë””ìŠ¤í¬ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œê³µí•  ìˆ˜ ì—†ëŠ” ê²½ìš°**, **ìŠ¤ëƒ…ìƒ·/ë””ìŠ¤í¬ì™€ ë™ì¼í•œ í”„ë¡œì íŠ¸ì˜ ì¸ìŠ¤í„´ìŠ¤ ë‚´ì—ì„œ ì´ëŸ¬í•œ ì‘ì—…ì„ ìˆ˜í–‰í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
