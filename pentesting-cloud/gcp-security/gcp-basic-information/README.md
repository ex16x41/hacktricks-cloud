# GCP - Βασικές Πληροφορίες

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Ιεραρχία Πόρων**

Η Google Cloud χρησιμοποιεί μια [Ιεραρχία Πόρων](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) που είναι παρόμοια, εννοιολογικά, με αυτή ενός παραδοσιακού συστήματος αρχείων. Αυτό παρέχει μια λογική ροή εργασίας γονέα/παιδιού με συγκεκριμένα σημεία προσάρτησης για πολιτικές και δικαιώματα.

Σε υψηλό επίπεδο, φαίνεται έτσι:
```
Organization
--> Folders
--> Projects
--> Resources
```
Ένας εικονικός υπολογιστής (που ονομάζεται Compute Instance) είναι ένας πόρος. Ένας πόρος βρίσκεται σε ένα έργο, πιθανώς δίπλα σε άλλους Compute Instances, αποθηκευτικούς κάδους κ.λπ.

## **Μεταφορά Έργων**

Είναι δυνατόν να **μεταφέρετε ένα έργο χωρίς καμία οργάνωση** σε μια οργάνωση με τα δικαιώματα `roles/resourcemanager.projectCreator` και `roles/resourcemanager.projectMover`. Εάν το έργο βρίσκεται μέσα σε άλλη οργάνωση, είναι απαραίτητο να επικοινωνήσετε με την υποστήριξη GCP για να **τα μεταφέρετε εκτός της οργάνωσης πρώτα**. Για περισσότερες πληροφορίες, δείτε [**αυτό**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Πολιτικές Οργάνωσης**

Επιτρέπουν την κεντρική διαχείριση των πόρων cloud της οργάνωσής σας:

* Κεντρική διαχείριση για **ρύθμιση περιορισμών** σχετικά με το πώς μπορούν να χρησιμοποιηθούν οι πόροι της οργάνωσής σας.
* Ορισμός και καθορισμός **οδηγιών** για τις ομάδες ανάπτυξης ώστε να παραμένουν εντός των ορίων συμμόρφωσης.
* Βοήθεια στους ιδιοκτήτες έργων και τις ομάδες τους να κινούνται γρήγορα χωρίς ανησυχία για παραβίαση της συμμόρφωσης.

Αυτές οι πολιτικές μπορούν να δημιουργηθούν για να **επηρεάσουν την πλήρη οργάνωση, φακέλους ή έργα**. Οι απόγονοι του στοχευμένου κόμβου ιεραρχίας πόρων **κληρονομούν την πολιτική οργάνωσης**.

Για να **ορίσετε** μια πολιτική οργάνωσης, **επιλέγετε έναν** [**περιορισμό**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), ο οποίος είναι ένας συγκεκριμένος τύπος περιορισμού κατά ενός υπηρεσίας Google Cloud ή μιας ομάδας υπηρεσιών Google Cloud. **Ρυθμίζετε αυτόν τον περιορισμό με τους επιθυμητούς περιορισμούς σας**.

#### Κοινές περιπτώσεις χρήσης

* Περιορισμός της κοινής χρήσης πόρων με βάση το τομέα.
* Περιορισμός της χρήσης λογαριασμών υπηρεσιών Identity and Access Management.
* Περιορισμός της φυσικής τοποθεσίας των νεοδημιουργημένων πόρων.
* Απενεργοποίηση της δημιουργίας λογαριασμών υπηρεσιών.

Υπάρχουν πολλοί άλλοι περιορισμοί που σας δίνουν λεπτομερή έλεγχο των πόρων της οργάνωσής σας. Για **περισσότερες πληροφορίες, δείτε τη** [**λίστα όλων των περιορισμών υπηρεσίας πολιτικής οργάνωσης**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Προεπιλεγμένες Πολιτικές Οργάνωσης**

<details>

<summary>Αυτές είναι οι πολιτικές που θα προσθέσει η Google από προεπιλογή κατά την εγκατάσταση της οργάνωσής σας GCP:</summary>

**Πολιτικές Διαχείρισης Πρόσβασης**

* **Περιορισμένοι τομείς επαφών:** Αποτρέπει την προσθήκη χρηστών σε Essential Contacts εκτός των καθορισμένων τομέων σας. Αυτό περιορίζει τους Essential Contacts ώστε να επιτρέπουν μόνο τις διαχειριζόμενες ταυτότητες χρηστών στους επιλεγμένους τομείς σας να λαμβάνουν ειδοποιήσεις πλατφόρμας.
* **Περιορισμένη κοινή χρήση τομέα:** Αποτρέπει την προσθήκη χρηστών σε πολιτικές IAM εκτός των καθορισμένων τομέων σας. Αυτό περιορίζει τις πολιτικές IAM ώστε να επιτρέπουν μόνο τις διαχειριζόμενες ταυτότητες χρηστών στους επιλεγμένους τομείς σας να έχουν πρόσβαση σε πόρους μέσα σε αυτήν την οργάνωση.
* **Πρόληψη δημόσιας πρόσβασης:** Αποτρέπει τους κάδους Cloud Storage από το να εκτίθενται στο κοινό. Αυτό διασφαλίζει ότι ένας προγραμματιστής δεν μπορεί να ρυθμίσει τους κάδους Cloud Storage να έχουν μη αυθεντικοποιημένη πρόσβαση στο διαδίκτυο.
* **Ομοιόμορφη πρόσβαση σε επίπεδο κάδου:** Αποτρέπει τις λίστες ελέγχου πρόσβασης (ACLs) σε επίπεδο αντικειμένου στους κάδους Cloud Storage. Αυτό απλοποιεί τη διαχείριση πρόσβασης εφαρμόζοντας πολιτικές IAM με συνέπεια σε όλα τα αντικείμενα στους κάδους Cloud Storage.
* **Απαιτεί σύνδεση OS:** Οι VMs που δημιουργούνται σε νέα έργα θα έχουν ενεργοποιημένη τη σύνδεση OS. Αυτό σας επιτρέπει να διαχειρίζεστε την πρόσβαση SSH στις περιπτώσεις σας χρησιμοποιώντας IAM χωρίς να χρειάζεται να δημιουργήσετε και να διαχειριστείτε μεμονωμένα κλειδιά SSH.

**Επιπλέον πολιτικές ασφαλείας για λογαριασμούς υπηρεσιών**

* **Απενεργοποίηση αυτόματων χορηγήσεων IAM:** Αποτρέπει τους προεπιλεγμένους λογαριασμούς υπηρεσιών App Engine και Compute Engine από το να χορηγούνται αυτόματα ο ρόλος Editor IAM σε ένα έργο κατά τη δημιουργία. Αυτό διασφαλίζει ότι οι λογαριασμοί υπηρεσιών δεν λαμβάνουν υπερβολικά επιτρεπτικούς ρόλους IAM κατά τη δημιουργία.
* **Απενεργοποίηση δημιουργίας κλειδιών λογαριασμού υπηρεσίας:** Αποτρέπει τη δημιουργία δημόσιων κλειδιών λογαριασμού υπηρεσίας. Αυτό βοηθά στη μείωση του κινδύνου έκθεσης μόνιμων διαπιστευτηρίων.
* **Απενεργοποίηση μεταφόρτωσης κλειδιών λογαριασμού υπηρεσίας:** Αποτρέπει τη μεταφόρτωση δημόσιων κλειδιών λογαριασμού υπηρεσίας. Αυτό βοηθά στη μείωση του κινδύνου διαρροής ή επαναχρησιμοποίησης υλικού κλειδιού.

**Πολιτικές ασφαλούς διαμόρφωσης δικτύου VPC**

* **Ορισμός επιτρεπόμενων εξωτερικών IP για VM instances:** Αποτρέπει τη δημιουργία Compute instances με δημόσια IP, που μπορεί να τους εκθέσει σε κυκλοφορία στο διαδίκτυο.

- **Απενεργοποίηση εσωτερικής εικονικοποίησης VM:** Αποτρέπει τη δημιουργία εσωτερικών VMs σε VMs Compute Engine. Αυτό μειώνει τον κίνδυνο ασφαλείας από την ύπαρξη μη παρακολουθούμενων εσωτερικών VMs.

* **Απενεργοποίηση σειριακής θύρας VM:** Αποτρέπει την πρόσβαση στη σειριακή θύρα σε VMs Compute Engine. Αυτό αποτρέπει την είσοδο στη σειριακή θύρα ενός διακομιστή χρησιμοποιώντας το API Compute Engine.

- **Περιορισμός εξουσιοδοτημένων δικτύων σε Cloud SQL instances:** Αποτρέπει δημόσιες ή μη εσωτερικές περιοχές δικτύου από το να έχουν πρόσβαση στις βάσεις δεδομένων Cloud SQL σας.

* **Περιορισμός προώθησης πρωτοκόλλου με βάση τον τύπο διεύθυνσης IP:** Αποτρέπει την προώθηση πρωτοκόλλου VM για εξωτερικές διευθύνσεις IP.

- **Περιορισμός δημόσιας πρόσβασης IP σε Cloud SQL instances:** Αποτρέπει τη δημιουργία Cloud SQL instances με δημόσια IP, που μπορεί να τους εκθέσει σε κυκλοφορία στο διαδίκτυο.

* **Περιορισμός αφαίρεσης υποθήκης έργου Shared VPC:** Αποτρέπει τη μη αυτόματη διαγραφή των έργων φιλοξενίας Shared VPC.

- **Ορίζει την εσωτερική ρύθμιση DNS για νέα έργα σε Μόνο Ζωνική DNS:** Αποτρέπει τη χρήση μιας παλαιάς ρύθμισης DNS που έχει μειωμένη διαθεσιμότητα υπηρεσιών.

* **Παράλειψη αυτόματης δημιουργίας δικτύου προεπιλογής:** Αποτρέπει τη αυτόματη δημιουργία του προεπιλεγμένου δικτύου VPC και σχετικών πόρων. Αυτό αποφεύγει υπερβολικά επιτρεπτικούς προεπιλεγμένους κανόνες τείχους προστασίας.

- **Απενεργοποίηση χρήσης εξωτερικού IPv6 VPC:** Αποτρέπει τη δημιουργία εξωτερικών υποδικτύων IPv6, που μπορεί να εκτεθούν σε μη εξουσιοδοτημένη πρόσβαση στο διαδίκτυο.

</details>

## **Ρόλοι IAM**

Αυτοί είναι όπως οι πολιτικές IAM στο AWS καθώς **κάθε ρόλος περιέχει ένα σύνολο δικαιωμάτων.**

Ωστόσο, σε αντίθεση με το AWS, δεν υπάρχει **κεντρικό αποθετήριο** ρόλων. Αντί αυτού, **οι πόροι δίνουν X ρόλους πρόσβασης σε Y κύριους**, και ο μόνος τρόπος για να μάθετε ποιος έχει πρόσβαση σε έναν πόρο είναι να χρησιμοποιήσετε τη μέθοδο **`get-iam-policy` πάνω σε αυτόν τον πόρο**.\
Αυτό θα μπορούσε να είναι πρόβλημα γιατί αυτό σημαίνει ότι ο μόνος τρόπος για να μάθετε **ποια δικαιώματα έχει ένας κύριος είναι να ρωτήσετε κάθε πόρο σε ποιον δίνει δικαιώματα**, και ένας χρήστης μπορεί να μην έχει δικαιώματα για να αποκτήσει δικαιώματα από όλους τους πόρους.

Υπάρχουν **τρία τύποι** ρόλων στο IAM:

* **Βασικοί/Πρωτότυποι ρόλοι**, οι οποίοι περιλαμβάνουν τους ρόλους **Ιδιοκτήτη**, **Επεξεργαστή** και **Θεατή** που υπήρχαν πριν από την εισαγωγή του IAM.
* **Προκαθορισμένοι ρόλοι**, οι οποίοι παρέχουν λεπτομερή πρόσβαση για μια συγκεκριμένη υπηρεσία και διαχειρίζονται από την Google Cloud. Υπάρχουν πολλοί προκαθορισμένοι ρόλοι, μπορείτε να **δείτε όλους αυτούς με τα προνόμια που έχουν** [**εδώ**](https://cloud.google.com/iam/docs/understanding-roles#predefined_roles).
* **Προσαρμοσμένοι ρόλοι**, οι οποίοι παρέχουν λεπτομερή πρόσβαση σύμφωνα με μια λίστα δικαιωμάτων που καθορίζεται από τον χρήστη.

Υπάρχουν χιλιάδες δικαιώματα στο GCP. Για να ελέγξετε αν ένας ρόλος έχει δικαιώματα μπορείτε να [**αναζητήσετε το δικαίωμα εδώ**](https://cloud.google.com/iam/docs/permissions-reference) και να δείτε ποιοι ρόλοι το έχουν.

Μπορείτε επίσης να [**αναζητήσετε εδώ προκαθορισμένους ρόλους**](https://cloud.google.com/iam/docs/understanding-roles#product_specific_documentation) **που προσφέρονται από κάθε προϊόν.** Σημειώστε ότι ορισμένοι **ρόλοι** δεν μπορούν να προσαρτηθούν σε χρήστες και **μόνο σε SAs λόγω ορισμένων δικαιωμάτων** που περιέχουν.\
Επιπλέον, σημειώστε ότι **τα δικαιώματα** θα **ισχύουν** μόνο εάν είναι **προσαρτημένα στην αντίστοιχη υπηρεσία.**

Ή ελέγξτε αν ένας **προσαρμοσμένος ρόλος μπορεί να χρησιμοποιήσει ένα** [**συγκεκριμένο δικαίωμα εδώ**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**

## Χρήστες

Στην **κονσόλα GCP** δεν υπάρχει καμία διαχείριση Χρηστών ή Ομάδων, αυτό γίνεται στο **Google Workspace**. Αν και μπορείτε να συγχρονίσετε έναν διαφορετικό πάροχο ταυτότητας στο Google Workspace.

Μπορείτε να αποκτήσετε πρόσβαση στους χρήστες και τις ομάδες του Workspaces στο [**https://admin.google.com**](https://admin.google.com/).

**MFA** μπορεί να **επιβληθεί** στους χρήστες Workspaces, ωστόσο, ένας **επιτιθέμενος** θα μπορούσε να χρησιμοποιήσει ένα token για να αποκτήσει πρόσβαση στο GCP **μέσω cli που δεν θα προστατεύεται από MFA** (θα προστατεύεται από MFA μόνο όταν ο χρήστης συνδεθεί για να το δημιουργήσει: `gcloud auth login`).

## Ομάδες

Όταν δημιουργείται μια οργάνωση, προτείνεται **έντονα να δημιουργηθούν αρκετές ομάδες.** Εάν διαχειρίζεστε οποιαδήποτε από αυτές, μπορεί να έχετε συμβιβάσει όλη ή μια σημαντική μέρος της οργάνωσης:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Ομάδα</strong></td><td><strong>Λειτουργία</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(απαιτούνται ομαδικοί ή ατομικοί λογαριασμοί για τη λίστα ελέγχου)</em></td><td>Διαχείριση οποιουδήποτε πόρου ανήκει στην οργάνωση. Αναθέστε αυτόν τον ρόλο με φειδώ; οι διαχειριστές οργανώσεων έχουν πρόσβαση σε όλους τους πόρους Google Cloud σας. Εναλλακτικά, επειδή αυτή η λειτουργία είναι πολύ προνομιακή, σκεφτείτε να χρησιμοποιήσετε ατομικούς λογαριασμούς αντί να δημιουργήσετε μια ομάδα.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(απαιτείται για τη λίστα ελέγχου)</em></td><td>Δημιουργία δικτύων, υποδικτύων, κανόνων τείχους προστασίας και δικτυακών συσκευών όπως Cloud Router, Cloud VPN και cloud load balancers.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(απαιτείται για τη λίστα ελέγχου)</em></td><td>Ρύθμιση λογαριασμών χρέωσης και παρακολούθηση της χρήσης τους.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(απαιτείται για τη λίστα ελέγχου)</em></td><td>Σχεδίαση, κωδικοποίηση και δοκιμή εφαρμογών.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Καθιέρωση και διαχείριση πολιτικών ασφαλείας για ολόκληρη την οργάνωση, συμπεριλαμβανομένης της διαχείρισης πρόσβασης και <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">πολιτικών περιορισμού οργάνωσης</a>. Δείτε τον <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">οδηγό θεμελίων ασφαλείας Google Cloud</a> για περισσότερες πληροφορίες σχετικά με τον προγραμματισμό της υποδομής ασφαλείας Google Cloud σας.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Δημιουργία ή διαχείριση ολοκληρωμένων αγωγών που υποστηρίζουν τη συνεχή ολοκλήρωση και παράδοση, παρακολούθηση και προμήθεια συστημάτων.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(δεν είναι πλέον προεπιλεγμένο)</em></td><td>Παρακολούθηση των δαπανών σε έργα. Τυπικά μέλη είναι μέρος της ομάδας χρηματοδότησης.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(δεν είναι πλέον προεπιλεγμένο)</em></td><td>Ανασκόπηση πληροφοριών πόρων σε όλη την οργάνωση Google Cloud.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(δεν είναι πλέον προεπιλεγμένο)</em></td><td>Ανασκόπηση της ασφάλειας του cloud.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(δεν είναι πλέον προεπιλεγμένο)</em></td><td>Ανασκόπηση ρυθμίσεων δικτύου.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(δεν είναι πλέον προεπιλεγμένο)</em></td><td>Προβολή αρχείων καταγραφής ελέγχου.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(δεν είναι πλέον προεπιλεγμένο)</em></td><td>Διαχείριση του Security Command Center.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(δεν είναι πλέον προεπιλεγμένο)</em></td><td>Διαχείριση μυστικών στο Secret Manager.</td></tr></tbody></table>

## **Προεπιλεγμένη Πολιτική Κωδικών Πρόσβασης**

* Επιβολή ισχυρών κωδικών πρόσβασης
* Μεταξύ 8 και 100 χαρακτήρων
* Καμία επαναχρησιμοποίηση
* Καμία λήξη
* Εάν οι άνθρωποι αποκτούν πρόσβαση στο Workspace μέσω τρίτου παρόχου, αυτές οι απαιτήσεις δεν εφαρμόζονται.

## **Λογαριασμοί Υπηρεσιών**

Αυτοί είναι οι κύριοι που **οι πόροι** μπορούν να **έχουν** **συνδεδεμένους** και πρόσβαση για να αλληλεπιδρούν εύκολα με το GCP. Για παράδειγμα, είναι δυνατόν να αποκτήσετε πρόσβαση στο **auth token** ενός Λογαριασμού Υπηρεσίας **συνδεδεμένου σε μια VM** στα μεταδεδομένα.\
Είναι δυνατόν να συναντήσετε κάποιες **συγκρούσεις** όταν χρησιμοποιείτε και τους **IAM και τα πεδία πρόσβασης**. Για παράδειγμα, ο λογαριασμός υπηρεσίας σας μπορεί να έχει τον ρόλο IAM `compute.instanceAdmin`, αλλά η περίπτωση που έχετε παραβιάσει έχει περιοριστεί με τον περιορισμό πεδίου `https://www.googleapis.com/auth/compute.readonly`. Αυτό θα σας εμπόδιζε να κάνετε οποιεσδήποτε αλλαγές χρησιμοποιώντας το OAuth token που έχει ανατεθεί αυτόματα στην περίπτωση σας.

Είναι παρόμοιο με **τους ρόλους IAM από το AWS**. Αλλά όχι όπως στο AWS, **οποιοσδήποτε** λογαριασμός υπηρεσίας μπορεί να είναι **συνδεδεμένος σε οποιαδήποτε υπηρεσία** (δεν χρειάζεται να το επιτρέπει μέσω πολιτικής).

Πολλοί από τους λογαριασμούς υπηρεσιών που θα βρείτε είναι στην πραγματικότητα **αυτόματα δημιουργημένοι από το GCP** όταν αρχίσετε να χρησιμοποιείτε μια υπηρεσία, όπως:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Ωστόσο, είναι επίσης δυνατό να δημιουργήσετε και να συνδέσετε σε πόρους **custom service accounts**, τα οποία θα μοιάζουν έτσι:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Κλειδιά & Διακριτικά**

Υπάρχουν 2 κύριοι τρόποι πρόσβασης στο GCP ως λογαριασμός υπηρεσίας:

* **Μέσω διακριτικών OAuth**: Αυτά είναι διακριτικά που θα λάβετε από μέρη όπως τα endpoints μεταδεδομένων ή κλέβοντας http αιτήματα και περιορίζονται από τους **τομείς πρόσβασης**.
* **Κλειδιά**: Αυτά είναι ζεύγη δημόσιων και ιδιωτικών κλειδιών που θα σας επιτρέψουν να υπογράφετε αιτήματα ως λογαριασμός υπηρεσίας και ακόμη και να δημιουργείτε διακριτικά OAuth για να εκτελείτε ενέργειες ως λογαριασμός υπηρεσίας. Αυτά τα κλειδιά είναι επικίνδυνα επειδή είναι πιο περίπλοκα να περιοριστούν και να ελεγχθούν, γι' αυτό το GCP συνιστά να μην τα δημιουργείτε.
* Σημειώστε ότι κάθε φορά που δημιουργείται ένας SA, **το GCP δημιουργεί ένα κλειδί για τον λογαριασμό υπηρεσίας** που ο χρήστης δεν μπορεί να έχει πρόσβαση (και δεν θα αναφέρεται στην εφαρμογή ιστού). Σύμφωνα με [**αυτή τη συζήτηση**](https://www.reddit.com/r/googlecloud/comments/f0ospy/service_account_keys_observations/), αυτό το κλειδί **χρησιμοποιείται εσωτερικά από το GCP** για να δώσει πρόσβαση στα endpoints μεταδεδομένων για να δημιουργήσουν τα προσβάσιμα διακριτικά OAuth.

### **Τομείς πρόσβασης**

Οι τομείς πρόσβασης είναι **συνδεδεμένοι με τα παραγόμενα διακριτικά OAuth** για να αποκτήσουν πρόσβαση στα endpoints API του GCP. **Περιορίζουν τις άδειες** του διακριτικού OAuth.\
Αυτό σημαίνει ότι αν ένα διακριτικό ανήκει σε έναν Ιδιοκτήτη ενός πόρου αλλά δεν έχει στον τομέα του διακριτικού πρόσβαση σε αυτόν τον πόρο, το διακριτικό **δεν μπορεί να χρησιμοποιηθεί για (κακή) χρήση αυτών των προνομίων**.

Η Google στην πραγματικότητα [συνιστά](https://cloud.google.com/compute/docs/access/service-accounts#service_account_permissions) ότι **οι τομείς πρόσβασης να μην χρησιμοποιούνται και να βασίζεστε εντελώς στο IAM**. Το διαδικτυακό διαχειριστικό πορτάλ το επιβάλλει αυτό, αλλά οι τομείς πρόσβασης μπορούν ακόμα να εφαρμοστούν σε περιπτώσεις χρησιμοποιώντας προσαρμοσμένους λογαριασμούς υπηρεσίας προγραμματισμένα.

Μπορείτε να δείτε ποιες **τομείς** είναι **καθορισμένοι** κάνοντας **ερώτηση:** 

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Οι προηγούμενοι **σκοποί** είναι αυτοί που δημιουργούνται από **προεπιλογή** χρησιμοποιώντας **`gcloud`** για να αποκτήσετε πρόσβαση σε δεδομένα. Αυτό συμβαίνει επειδή όταν χρησιμοποιείτε **`gcloud`** πρώτα δημιουργείτε ένα OAuth token και στη συνέχεια το χρησιμοποιείτε για να επικοινωνήσετε με τα endpoints.

Ο πιο σημαντικός σκοπός από αυτούς είναι **`cloud-platform`**, που σημαίνει βασικά ότι είναι δυνατό να **έχετε πρόσβαση σε οποιαδήποτε υπηρεσία στο GCP**.

Μπορείτε να **βρείτε μια λίστα με** [**όλους τους πιθανούς σκοπούς εδώ**](https://developers.google.com/identity/protocols/googlescopes)**.**

Αν έχετε **`gcloud`** διαπιστευτήρια προγράμματος περιήγησης, είναι δυνατό να **αποκτήσετε ένα token με άλλους σκοπούς,** κάνοντας κάτι σαν: 

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM Πολιτικές, Δεσμεύσεις και Μέλη**

Όπως ορίζεται από το terraform στο [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project_iam) χρησιμοποιώντας το terraform με GCP υπάρχουν διάφοροι τρόποι για να παραχωρήσετε σε έναν κύριο πρόσβαση σε έναν πόρο:

* **Μέλη**: Ορίζετε **κυρίους ως μέλη ρόλων** **χωρίς περιορισμούς** πάνω στον ρόλο ή στους κυρίους. Μπορείτε να βάλετε έναν χρήστη ως μέλος ενός ρόλου και στη συνέχεια να βάλετε μια ομάδα ως μέλος του ίδιου ρόλου και επίσης να ορίσετε αυτούς τους κυρίους (χρήστης και ομάδα) ως μέλη άλλων ρόλων.
* **Δεσμεύσεις**: Πολλοί **κύριοι μπορούν να δεσμευτούν σε έναν ρόλο**. Αυτοί οι **κύριοι μπορούν ακόμα να δεσμευτούν ή να είναι μέλη άλλων ρόλων**. Ωστόσο, αν ένας κύριος που δεν είναι δεσμευμένος στον ρόλο οριστεί ως **μέλος μιας δεσμευμένης ρόλου**, την επόμενη φορά που η **δέσμευση θα εφαρμοστεί, η ιδιότητα μέλους θα εξαφανιστεί**.
* **Πολιτικές**: Μια πολιτική είναι **αυθεντική**, υποδεικνύει ρόλους και κυρίους και στη συνέχεια, **αυτοί οι κύριοι δεν μπορούν να έχουν περισσότερους ρόλους και αυτοί οι ρόλοι δεν μπορούν να έχουν περισσότερους κυρίους** εκτός αν αυτή η πολιτική τροποποιηθεί (ούτε καν σε άλλες πολιτικές, δεσμεύσεις ή μέλη). Επομένως, όταν ένας ρόλος ή κύριος καθορίζεται σε πολιτική, όλα τα προνόμια του είναι **περιορισμένα από αυτή την πολιτική**. Προφανώς, αυτό μπορεί να παρακαμφθεί σε περίπτωση που ο κύριος έχει την επιλογή να τροποποιήσει την πολιτική ή δικαιώματα κλιμάκωσης προνομίων (όπως η δημιουργία ενός νέου κυρίου και η δέσμευσή του σε έναν νέο ρόλο).

## Αναφορές

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
