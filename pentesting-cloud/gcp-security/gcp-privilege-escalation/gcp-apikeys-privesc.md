# GCP - Apikeys Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Apikeys

æ¬¡ã®æ¨©é™ã¯APIã‚­ãƒ¼ã‚’ä½œæˆã—ã€ç›—ã‚€ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã®æ³¨æ„ç‚¹: _APIã‚­ãƒ¼ã¯ã€**ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ãªã—ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è­˜åˆ¥ã™ã‚‹**ã‚·ãƒ³ãƒ—ãƒ«ãªæš—å·åŒ–ã•ã‚ŒãŸæ–‡å­—åˆ—ã§ã™ã€‚ã“ã‚Œã‚‰ã¯ã€**å…¬å…±ãƒ‡ãƒ¼ã‚¿ã«åŒ¿åã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹**ãŸã‚ã«ä¾¿åˆ©ã§ã‚ã‚Šã€**ã‚¯ã‚©ãƒ¼ã‚¿**ã¨**è«‹æ±‚**ã®ãŸã‚ã«APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«**é–¢é€£ä»˜ã‘ã‚‹**ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚_

ã—ãŸãŒã£ã¦ã€APIã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãã®ä¼šç¤¾ã«APIã®ä½¿ç”¨æ–™ã‚’æ”¯æ‰•ã‚ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

APIã‚­ãƒ¼ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯æ¬¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

{% content-ref url="../gcp-services/gcp-api-keys-enum.md" %}
[gcp-api-keys-enum.md](../gcp-services/gcp-api-keys-enum.md)
{% endcontent-ref %}

APIã‚­ãƒ¼ã‚’ä½œæˆã™ã‚‹ä»–ã®æ–¹æ³•ã«ã¤ã„ã¦ã¯æ¬¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

{% content-ref url="gcp-serviceusage-privesc.md" %}
[gcp-serviceusage-privesc.md](gcp-serviceusage-privesc.md)
{% endcontent-ref %}

### Brute Force API Key access <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã©ã®APIãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ã€ã¾ãŸã¯è¦‹ã¤ã‘ãŸAPIã‚­ãƒ¼ã«é©ç”¨ã•ã‚Œã‚‹åˆ¶é™ãŒã‚ã‹ã‚‰ãªã„å ´åˆã€[**https://github.com/ozguralp/gmapsapiscanner**](https://github.com/ozguralp/gmapsapiscanner)ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ã€**APIã‚­ãƒ¼ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚‚ã®ã‚’ç¢ºèªã™ã‚‹ã®ãŒèˆˆå‘³æ·±ã„ã§ã—ã‚‡ã†ã€‚**

### `apikeys.keys.create` <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

ã“ã®æ¨©é™ã¯ã€**APIã‚­ãƒ¼ã‚’ä½œæˆã™ã‚‹**ã“ã¨ã‚’è¨±å¯ã—ã¾ã™:
```bash
gcloud services api-keys create
Operation [operations/akmf.p7-[...]9] complete. Result: {
"@type":"type.googleapis.com/google.api.apikeys.v2.Key",
"createTime":"2022-01-26T12:23:06.281029Z",
"etag":"W/\"HOhA[...]==\"",
"keyString":"AIzaSy[...]oU",
"name":"projects/5[...]6/locations/global/keys/f707[...]e8",
"uid":"f707[...]e8",
"updateTime":"2022-01-26T12:23:06.378442Z"
}
```
You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/b-apikeys.keys.create.sh).

{% hint style="danger" %}
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹æ¨©é™ã‚’æŒã¡ã€æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦ã‚ªãƒ¼ãƒŠãƒ¼ã®å½¹å‰²ãŒä»˜ä¸ã•ã‚Œã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã—ãŸãŒã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã«APIã‚­ãƒ¼ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚
{% endhint %}

### `apikeys.keys.getKeyString` , `apikeys.keys.list` <a href="#apikeys.keys.getkeystringapikeys.keys.list" id="apikeys.keys.getkeystringapikeys.keys.list"></a>

ã“ã‚Œã‚‰ã®æ¨©é™ã¯ã€**ã™ã¹ã¦ã®apiKeysã‚’ãƒªã‚¹ãƒˆã—ã€å–å¾—ã—ã€ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã¾ã™**ã€‚
```bash
for  key  in  $(gcloud services api-keys list --uri); do
gcloud services api-keys get-key-string "$key"
done
```
You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/c-apikeys.keys.getKeyString.sh).

### `apikeys.keys.undelete` , `apikeys.keys.list` <a href="#serviceusage.apikeys.regenerateapikeys.keys.list" id="serviceusage.apikeys.regenerateapikeys.keys.list"></a>

ã“ã‚Œã‚‰ã®æ¨©é™ã¯ã€**å‰Šé™¤ã•ã‚ŒãŸAPIã‚­ãƒ¼ã‚’ãƒªã‚¹ãƒˆãŠã‚ˆã³å†ç”Ÿæˆã™ã‚‹**ã“ã¨ã‚’è¨±å¯ã—ã¾ã™ã€‚**undelete**ãŒå®Œäº†ã—ãŸå¾Œã€**APIã‚­ãƒ¼ã¯å‡ºåŠ›ã«è¡¨ç¤ºã•ã‚Œã¾ã™**:
```bash
gcloud services api-keys list --show-deleted
gcloud services api-keys undelete <key-uid>
```
### å†…éƒ¨OAuthã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ä»–ã®ä½œæ¥­è€…ã‚’ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã™ã‚‹

ã“ã®æ“ä½œã¯ã‚µãƒ¼ãƒ“ã‚¹**`clientauthconfig`**ã«å±ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦æ–¹æ³•ã‚’å­¦ã‚“ã§ãã ã•ã„[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨](https://cloud.google.com/iap/docs/programmatic-oauth-clients#before-you-begin):

{% content-ref url="../../workspace-security/gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](../../workspace-security/gws-google-platforms-phishing/)
{% endcontent-ref %}

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„!
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
