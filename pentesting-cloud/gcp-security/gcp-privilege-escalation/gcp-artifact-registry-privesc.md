# GCP - Artifact Registry Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Artifact Registry

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ Artifact Registry –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ:

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### artifactregistry.repositories.uploadArtifacts

–ó —Ü—ñ—î—é –¥–æ–∑–≤–æ–ª–æ–º –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –Ω–æ–≤—ñ –≤–µ—Ä—Å—ñ—ó –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤ –∑ —à–∫—ñ–¥–ª–∏–≤–∏–º –∫–æ–¥–æ–º, —Ç–∞–∫–∏–º–∏ —è–∫ Docker-–æ–±—Ä–∞–∑–∏:

{% code overflow="wrap" %}
```bash
# Configure docker to use gcloud to authenticate with Artifact Registry
gcloud auth configure-docker <location>-docker.pkg.dev

# tag the image to upload it
docker tag <local-img-name>:<local-tag> <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>

# Upload it
docker push <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
{% endcode %}

{% hint style="danger" %}
–ë—É–ª–æ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ, —â–æ **–º–æ–∂–ª–∏–≤–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–æ–≤–∏–π —à–∫—ñ–¥–ª–∏–≤–∏–π docker** –æ–±—Ä–∞–∑ –∑ —Ç–∞–∫–∏–º –∂–µ —ñ–º'—è–º —Ç–∞ —Ç–µ–≥–æ–º, —è–∫ —ñ —Ç–æ–π, —â–æ –≤–∂–µ –ø—Ä–∏—Å—É—Ç–Ω—ñ–π, —Ç–æ–º—É **—Å—Ç–∞—Ä–∏–π –≤—Ç—Ä–∞—Ç–∏—Ç—å —Ç–µ–≥** —ñ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä–∞–∑—É, –∫–æ–ª–∏ —Ü–µ–π –æ–±—Ä–∞–∑ –∑ —Ü–∏–º —Ç–µ–≥–æ–º –±—É–¥–µ **–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ, –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —à–∫—ñ–¥–ª–∏–≤–∏–π**.
{% endhint %}

<details>

<summary>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É Python</summary>

**–ü–æ—á–Ω—ñ—Ç—å –∑ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è** (—è–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—é –≤–µ—Ä—Å—ñ—é –∑ —Ä–µ—î—Å—Ç—Ä—É, –≤–∏ –º–æ–∂–µ—Ç–µ —É–Ω–∏–∫–Ω—É—Ç–∏ —Ü—å–æ–≥–æ –∫—Ä–æ–∫—É):

1.  **–ù–∞–ª–∞—à—Ç—É–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤–∞—à–æ–≥–æ –ø—Ä–æ—î–∫—Ç—É**:

* –°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –≤–∞—à–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `hello_world_library`.
* –£—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ü—å–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥—É —Å—Ç–≤–æ—Ä—ñ—Ç—å —â–µ –æ–¥–∏–Ω –∫–∞—Ç–∞–ª–æ–≥ –∑ –Ω–∞–∑–≤–æ—é –≤–∞—à–æ–≥–æ –ø–∞–∫–µ—Ç–∞, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `hello_world`.
* –£—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–∞—Ç–∞–ª–æ–≥—É –≤–∞—à–æ–≥–æ –ø–∞–∫–µ—Ç–∞ —Å—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `__init__.py`. –¶–µ–π —Ñ–∞–π–ª –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º –∞–±–æ –º—ñ—Å—Ç–∏—Ç–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –¥–ª—è –≤–∞—à–æ–≥–æ –ø–∞–∫–µ—Ç–∞.

```bash
mkdir hello_world_library
cd hello_world_library
mkdir hello_world
touch hello_world/__init__.py
```
2.  **–ù–∞–ø–∏—à—ñ—Ç—å –∫–æ–¥ –≤–∞—à–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏**:

* –£—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–∞—Ç–∞–ª–æ–≥—É `hello_world` —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π —Ñ–∞–π–ª Python –¥–ª—è –≤–∞—à–æ–≥–æ –º–æ–¥—É–ª—è, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `greet.py`.
* –ù–∞–ø–∏—à—ñ—Ç—å –≤–∞—à—É —Ñ—É–Ω–∫—Ü—ñ—é "Hello, World!":

```python
# hello_world/greet.py
def say_hello():
return "Hello, World!"
```
3.  **–°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `setup.py`**:

* –£ –∫–æ—Ä–µ–Ω—ñ –≤–∞—à–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥—É `hello_world_library` —Å—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `setup.py`.
* –¶–µ–π —Ñ–∞–π–ª –º—ñ—Å—Ç–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω—ñ –ø—Ä–æ –≤–∞—à—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É —Ç–∞ –≤–∫–∞–∑—É—î Python, —è–∫ —ó—ó –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏.

```python
# setup.py
from setuptools import setup, find_packages

setup(
name='hello_world',
version='0.1',
packages=find_packages(),
install_requires=[
# –ë—É–¥—å-—è–∫—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ, —è–∫—ñ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –≤–∞—à—ñ–π –±—ñ–±–ª—ñ–æ—Ç–µ—Ü—ñ
],
)
```

**–¢–µ–ø–µ—Ä –¥–∞–≤–∞–π—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–º–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É:**

1.  **–°–∫–æ–º–ø—ñ–ª—é–π—Ç–µ –≤–∞—à –ø–∞–∫–µ—Ç**:

* –ó –∫–æ—Ä–µ–Ω—è –≤–∞—à–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥—É `hello_world_library` –≤–∏–∫–æ–Ω–∞–π—Ç–µ:

```sh
python3 setup.py sdist bdist_wheel
```
2. **–ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é –¥–ª—è twine** (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∞—à–æ–≥–æ –ø–∞–∫–µ—Ç–∞):
* –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —É –≤–∞—Å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ `twine` (`pip install twine`).
* –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `gcloud`, —â–æ–± –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ:

{% code overflow="wrap" %}
````
```sh
twine upload --username 'oauth2accesstoken' --password "$(gcloud auth print-access-token)" --repository-url https://<location>-python.pkg.dev/<project-id>/<repo-name>/ dist/*
```
````
{% endcode %}

3. **–û—á–∏—Å—Ç—ñ—Ç—å –∑–±—ñ—Ä–∫—É**
```bash
rm -rf dist build hello_world.egg-info
```
</details>

{% hint style="danger" %}
–ù–µ–º–æ–∂–ª–∏–≤–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É python –∑ —Ç—ñ—î—é –∂ –≤–µ—Ä—Å—ñ—î—é, —â–æ –≤–∂–µ –ø—Ä–∏—Å—É—Ç–Ω—è, –∞–ª–µ –º–æ–∂–ª–∏–≤–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ **–±—ñ–ª—å—à—ñ –≤–µ—Ä—Å—ñ—ó** (–∞–±–æ –¥–æ–¥–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π **`.0` –≤ –∫—ñ–Ω—Ü—ñ** –≤–µ—Ä—Å—ñ—ó, —è–∫—â–æ —Ü–µ –ø—Ä–∞—Ü—é—î - –Ω–µ –≤ python, –ø—Ä–æ—Ç–µ), –∞–±–æ **–≤–∏–¥–∞–ª–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—é –≤–µ—Ä—Å—ñ—é —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–æ–≤—É –∑** (–Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π `artifactregistry.versions.delete)`**:**

{% code overflow="wrap" %}
```sh
gcloud artifacts versions delete <version> --repository=<repo-name> --location=<location> --package=<lib-name>
```
{% endcode %}
{% endhint %}

### `artifactregistry.repositories.downloadArtifacts`

–ó —Ü—ñ—î—é –¥–æ–∑–≤–æ–ª–æ–º –≤–∏ –º–æ–∂–µ—Ç–µ **–∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏** —Ç–∞ —à—É–∫–∞—Ç–∏ **—á—É—Ç–ª–∏–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é** —ñ **–≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ**.

–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ **Docker** –æ–±—Ä–∞–∑:
```sh
# Configure docker to use gcloud to authenticate with Artifact Registry
gcloud auth configure-docker <location>-docker.pkg.dev

# Dowload image
docker pull <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É **python**:

{% code overflow="wrap" %}
```bash
pip install <lib-name> --index-url "https://oauth2accesstoken:$(gcloud auth print-access-token)@<location>-python.pkg.dev/<project-id>/<repo-name>/simple/" --trusted-host <location>-python.pkg.dev --no-cache-dir
```
{% endcode %}

* –©–æ —Å—Ç–∞–Ω–µ—Ç—å—Å—è, —è–∫—â–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π —Ä–µ—î—Å—Ç—Ä –∑–º—ñ—à—É—î –≤—ñ–¥–¥–∞–ª–µ–Ω—ñ —Ç–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ —Ä–µ—î—Å—Ç—Ä–∏, —ñ –ø–∞–∫–µ—Ç —ñ—Å–Ω—É—î –≤ –æ–±–æ—Ö? –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É:

{% content-ref url="../gcp-persistence/gcp-artifact-registry-persistence.md" %}
[gcp-artifact-registry-persistence.md](../gcp-persistence/gcp-artifact-registry-persistence.md)
{% endcontent-ref %}

### `artifactregistry.tags.delete`, `artifactregistry.versions.delete`, `artifactregistry.packages.delete`, (`artifactregistry.repositories.get`, `artifactregistry.tags.get`, `artifactregistry.tags.list`)

–í–∏–¥–∞–ª–∏—Ç–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏ –∑ —Ä–µ—î—Å—Ç—Ä—É, —Ç–∞–∫—ñ —è–∫ –æ–±—Ä–∞–∑–∏ docker:

{% code overflow="wrap" %}
```bash
# Delete a docker image
gcloud artifacts docker images delete <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
{% endcode %}

### `artifactregistry.repositories.delete`

–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤–Ω–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤—ñ–Ω –º–∞—î –≤–º—ñ—Å—Ç):

{% code overflow="wrap" %}
```
gcloud artifacts repositories delete <repo-name> --location=<location>
```
{% endcode %}

### `artifactregistry.repositories.setIamPolicy`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ —Ü–∏–º –¥–æ–∑–≤–æ–ª–æ–º –º–æ–∂–µ –Ω–∞–¥–∞—Ç–∏ —Å–æ–±—ñ –¥–æ–∑–≤–æ–ª–∏ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–µ—è–∫–∏—Ö –∑ —Ä–∞–Ω—ñ—à–µ –∑–≥–∞–¥–∞–Ω–∏—Ö –∞—Ç–∞–∫ –Ω–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó.

### –ü–µ—Ä–µ—Ö–æ–¥ –¥–æ —ñ–Ω—à–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤ —á–µ—Ä–µ–∑ —á–∏—Ç–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø–∏—Å –≤ Artifact Registry

* **Cloud Functions**

–ö–æ–ª–∏ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è Cloud Function, –Ω–æ–≤–∏–π docker-–æ–±—Ä–∞–∑ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –≤ Artifact Registry –ø—Ä–æ–µ–∫—Ç—É. –Ø –Ω–∞–º–∞–≥–∞–≤—Å—è –∑–º—ñ–Ω–∏—Ç–∏ –æ–±—Ä–∞–∑ –Ω–∞ –Ω–æ–≤–∏–π, –∞ —Ç–∞–∫–æ–∂ –≤–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π –æ–±—Ä–∞–∑ (—ñ –æ–±—Ä–∞–∑ `cache`), –∞–ª–µ –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–º—ñ–Ω–∏–ª–æ—Å—è, Cloud Function –ø—Ä–æ–¥–æ–≤–∂—É—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏. –¢–æ–º—É, –º–æ–∂–ª–∏–≤–æ, **–º–æ–∂–ª–∏–≤–æ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ –∞—Ç–∞–∫–æ—é Race Condition** —è–∫ –∑ –±–∞–∫–µ—Ç–æ–º, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —è–∫–∏–π –±—É–¥–µ –∑–∞–ø—É—â–µ–Ω–æ, –∞–ª–µ **–ø—Ä–æ—Å—Ç–æ –∑–º—ñ–Ω–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ –æ–±—Ä–∞–∑—É –Ω–µ –º–æ–∂–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ Cloud Function**.

* **App Engine**

–•–æ—á–∞ App Engine —Å—Ç–≤–æ—Ä—é—î docker-–æ–±—Ä–∞–∑–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ Artifact Registry. –ë—É–ª–æ –ø—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–æ, —â–æ **–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–∏ –∑–º—ñ–Ω–∏—Ç–µ –æ–±—Ä–∞–∑ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ü—å–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É** —ñ –≤–∏–¥–∞–ª–∏—Ç–µ –µ–∫–∑–µ–º–ø–ª—è—Ä App Engine (—â–æ–± –±—É–≤ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏–π –Ω–æ–≤–∏–π), **–≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π –∫–æ–¥ –Ω–µ –∑–º—ñ–Ω—é—î—Ç—å—Å—è**.\
–ú–æ–∂–ª–∏–≤–æ, —â–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è **–∞—Ç–∞–∫–∏ Race Condition, —è–∫ –∑ –±–∞–∫–µ—Ç–∞–º–∏, –º–æ–∂–µ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π –∫–æ–¥**, –∞–ª–µ —Ü–µ –Ω–µ –±—É–ª–æ –ø—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–æ.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
