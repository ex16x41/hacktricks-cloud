# GCP - Artifact Registry Privesc

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Artifact Registry

Artifact Registry hakkÄ±nda daha fazla bilgi iÃ§in kontrol edin:

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### artifactregistry.repositories.uploadArtifacts

Bu izinle bir saldÄ±rgan, Docker gÃ¶rÃ¼ntÃ¼leri gibi kÃ¶tÃ¼ niyetli kod iÃ§eren yeni sÃ¼rÃ¼mlerini yÃ¼kleyebilir: 

{% code overflow="wrap" %}
```bash
# Configure docker to use gcloud to authenticate with Artifact Registry
gcloud auth configure-docker <location>-docker.pkg.dev

# tag the image to upload it
docker tag <local-img-name>:<local-tag> <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>

# Upload it
docker push <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
{% endcode %}

{% hint style="danger" %}
**AynÄ± isim ve etiketle yeni bir kÃ¶tÃ¼ niyetli docker** imajÄ±nÄ±n yÃ¼klenmesinin **mÃ¼mkÃ¼n olduÄŸu kontrol edildi**, bu nedenle **eski etiketini kaybedecek** ve bir sonraki sefer o etiketle **indirilirse kÃ¶tÃ¼ niyetli olanÄ±** indirilecektir.
{% endhint %}

<details>

<summary>Bir Python kÃ¼tÃ¼phanesi yÃ¼kleyin</summary>

**YÃ¼klemek iÃ§in kÃ¼tÃ¼phaneyi oluÅŸturarak baÅŸlayÄ±n** (eÄŸer kayÄ±t defterinden en son sÃ¼rÃ¼mÃ¼ indirebiliyorsanÄ±z bu adÄ±mÄ± atlayabilirsiniz):

1.  **Proje yapÄ±nÄ±zÄ± ayarlayÄ±n**:

* KÃ¼tÃ¼phaneniz iÃ§in yeni bir dizin oluÅŸturun, Ã¶rneÄŸin, `hello_world_library`.
* Bu dizinin iÃ§inde, paket adÄ±nÄ±zla baÅŸka bir dizin oluÅŸturun, Ã¶rneÄŸin, `hello_world`.
* Paket dizininizin iÃ§inde, bir `__init__.py` dosyasÄ± oluÅŸturun. Bu dosya boÅŸ olabilir veya paketiniz iÃ§in baÅŸlangÄ±Ã§ ayarlarÄ±nÄ± iÃ§erebilir.

```bash
mkdir hello_world_library
cd hello_world_library
mkdir hello_world
touch hello_world/__init__.py
```
2.  **KÃ¼tÃ¼phane kodunuzu yazÄ±n**:

* `hello_world` dizininin iÃ§inde, modÃ¼lÃ¼nÃ¼z iÃ§in yeni bir Python dosyasÄ± oluÅŸturun, Ã¶rneÄŸin, `greet.py`.
* "Merhaba, DÃ¼nya!" fonksiyonunuzu yazÄ±n:

```python
# hello_world/greet.py
def say_hello():
return "Hello, World!"
```
3.  **Bir `setup.py` dosyasÄ± oluÅŸturun**:

* `hello_world_library` dizininizin kÃ¶kÃ¼nde bir `setup.py` dosyasÄ± oluÅŸturun.
* Bu dosya, kÃ¼tÃ¼phaneniz hakkÄ±nda meta veriler iÃ§erir ve Python'a nasÄ±l kurulacaÄŸÄ±nÄ± sÃ¶yler.

```python
# setup.py
from setuptools import setup, find_packages

setup(
name='hello_world',
version='0.1',
packages=find_packages(),
install_requires=[
# KÃ¼tÃ¼phanenizin ihtiyaÃ§ duyduÄŸu baÄŸÄ±mlÄ±lÄ±klar
],
)
```

**Åimdi, kÃ¼tÃ¼phaneyi yÃ¼kleyelim:**

1.  **Paketinizi oluÅŸturun**:

* `hello_world_library` dizininizin kÃ¶kÃ¼nden ÅŸu komutu Ã§alÄ±ÅŸtÄ±rÄ±n:

```sh
python3 setup.py sdist bdist_wheel
```
2. **Twine iÃ§in kimlik doÄŸrulamasÄ±nÄ± yapÄ±landÄ±rÄ±n** (paketinizi yÃ¼klemek iÃ§in kullanÄ±lÄ±r):
* `twine`'Ä±n yÃ¼klÃ¼ olduÄŸundan emin olun (`pip install twine`).
* Kimlik bilgilerini yapÄ±landÄ±rmak iÃ§in `gcloud` kullanÄ±n:

{% code overflow="wrap" %}
````
```sh
twine upload --username 'oauth2accesstoken' --password "$(gcloud auth print-access-token)" --repository-url https://<location>-python.pkg.dev/<project-id>/<repo-name>/ dist/*
```
````
{% endcode %}

3. **Derlemeyi temizle**
```bash
rm -rf dist build hello_world.egg-info
```
</details>

{% hint style="danger" %}
Zaten mevcut olanla aynÄ± sÃ¼rÃ¼mde bir python kÃ¼tÃ¼phanesi yÃ¼klemek mÃ¼mkÃ¼n deÄŸildir, ancak **daha bÃ¼yÃ¼k sÃ¼rÃ¼mler** yÃ¼klemek mÃ¼mkÃ¼ndÃ¼r (veya sÃ¼rÃ¼mÃ¼n sonuna ekstra bir **`.0` eklemek** mÃ¼mkÃ¼ndÃ¼r - bu python'da geÃ§erli deÄŸildir), ya da **son sÃ¼rÃ¼mÃ¼ silip yeni bir sÃ¼rÃ¼m yÃ¼klemek mÃ¼mkÃ¼ndÃ¼r** (gerekli `artifactregistry.versions.delete)`**:**

{% code overflow="wrap" %}
```sh
gcloud artifacts versions delete <version> --repository=<repo-name> --location=<location> --package=<lib-name>
```
{% endcode %}
{% endhint %}

### `artifactregistry.repositories.downloadArtifacts`

Bu izinle **artifacts** indirebilir ve **hassas bilgileri** ve **gÃ¼venlik aÃ§Ä±klarÄ±nÄ±** arayabilirsiniz.

Bir **Docker** imajÄ±nÄ± indirin:
```sh
# Configure docker to use gcloud to authenticate with Artifact Registry
gcloud auth configure-docker <location>-docker.pkg.dev

# Dowload image
docker pull <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
Download a **python** kÃ¼tÃ¼phanesi:

{% code overflow="wrap" %}
```bash
pip install <lib-name> --index-url "https://oauth2accesstoken:$(gcloud auth print-access-token)@<location>-python.pkg.dev/<project-id>/<repo-name>/simple/" --trusted-host <location>-python.pkg.dev --no-cache-dir
```
{% endcode %}

* Sanal bir ortamda uzaktan ve standart kayÄ±tlarÄ±n karÄ±ÅŸtÄ±rÄ±lmasÄ± durumunda ve her ikisinde de bir paket mevcutsa ne olur? Bu sayfaya bakÄ±n:

{% content-ref url="../gcp-persistence/gcp-artifact-registry-persistence.md" %}
[gcp-artifact-registry-persistence.md](../gcp-persistence/gcp-artifact-registry-persistence.md)
{% endcontent-ref %}

### `artifactregistry.tags.delete`, `artifactregistry.versions.delete`, `artifactregistry.packages.delete`, (`artifactregistry.repositories.get`, `artifactregistry.tags.get`, `artifactregistry.tags.list`)

KayÄ±ttan, docker gÃ¶rÃ¼ntÃ¼leri gibi, eserleri silin:

{% code overflow="wrap" %}
```bash
# Delete a docker image
gcloud artifacts docker images delete <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
{% endcode %}

### `artifactregistry.repositories.delete`

Tam bir depoyu silin (iÃ§eriÄŸi olsa bile):

{% code overflow="wrap" %}
```
gcloud artifacts repositories delete <repo-name> --location=<location>
```
{% endcode %}

### `artifactregistry.repositories.setIamPolicy`

Bu izne sahip bir saldÄ±rgan, daha Ã¶nce bahsedilen bazÄ± depo saldÄ±rÄ±larÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in kendisine izin verebilir.

### Artifact Registry Okuma ve Yazma ile DiÄŸer Servislere GeÃ§iÅŸ

* **Cloud Functions**

Bir Cloud Function oluÅŸturulduÄŸunda, projeye yeni bir docker imajÄ± Artifact Registry'ye yÃ¼klenir. Ä°majÄ± yeni bir imajla deÄŸiÅŸtirmeyi ve mevcut imajÄ± (ve `cache` imajÄ±nÄ±) silmeyi denedim ve hiÃ§bir ÅŸey deÄŸiÅŸmedi, cloud function Ã§alÄ±ÅŸmaya devam etti. Bu nedenle, belki de **bucket ile olduÄŸu gibi bir Race Condition saldÄ±rÄ±sÄ±nÄ± kÃ¶tÃ¼ye kullanmak mÃ¼mkÃ¼n olabilir** ama **sadece saklanan imajÄ± deÄŸiÅŸtirmek Cloud Function'Ä± tehlikeye atmak iÃ§in yeterli deÄŸildir**.

* **App Engine**

App Engine, Artifact Registry iÃ§inde docker imajlarÄ± oluÅŸturmasÄ±na raÄŸmen, **bu hizmet iÃ§inde imajÄ± deÄŸiÅŸtirseniz bile** ve App Engine Ã¶rneÄŸini kaldÄ±rÄ±p (yeni bir tane daÄŸÄ±tÄ±ldÄ±ÄŸÄ±nda) **Ã§alÄ±ÅŸtÄ±rÄ±lan kod deÄŸiÅŸmez**.\
**Bucket'lar ile olduÄŸu gibi bir Race Condition saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirerek Ã§alÄ±ÅŸtÄ±rÄ±lan kodu Ã¼zerine yazmak mÃ¼mkÃ¼n olabilir**, ancak bu test edilmedi.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
