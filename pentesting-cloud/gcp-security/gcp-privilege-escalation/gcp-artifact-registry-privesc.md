# GCP - Artifact Registry Privesc

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Artifact Registry

æœ‰å…³ Artifact Registry çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### artifactregistry.repositories.uploadArtifacts

é€šè¿‡æ­¤æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥ä¸Šä¼ å¸¦æœ‰æ¶æ„ä»£ç çš„æ–°ç‰ˆæœ¬å·¥ä»¶ï¼Œä¾‹å¦‚ Docker é•œåƒï¼š

{% code overflow="wrap" %}
```bash
# Configure docker to use gcloud to authenticate with Artifact Registry
gcloud auth configure-docker <location>-docker.pkg.dev

# tag the image to upload it
docker tag <local-img-name>:<local-tag> <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>

# Upload it
docker push <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
{% endcode %}

{% hint style="danger" %}
å·²æ£€æŸ¥åˆ°**å¯ä»¥ä¸Šä¼ ä¸€ä¸ªæ–°çš„æ¶æ„ docker** é•œåƒï¼Œåç§°å’Œæ ‡ç­¾ä¸å·²å­˜åœ¨çš„ç›¸åŒï¼Œå› æ­¤**æ—§çš„å°†å¤±å»æ ‡ç­¾**ï¼Œä¸‹æ¬¡ä¸‹è½½å¸¦æœ‰è¯¥æ ‡ç­¾çš„é•œåƒæ—¶ï¼Œå°†ä¼šä¸‹è½½åˆ°æ¶æ„é•œåƒã€‚
{% endhint %}

<details>

<summary>ä¸Šä¼ ä¸€ä¸ª Python åº“</summary>

**é¦–å…ˆåˆ›å»ºè¦ä¸Šä¼ çš„åº“**ï¼ˆå¦‚æœå¯ä»¥ä»æ³¨å†Œè¡¨ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ï¼Œå¯ä»¥è·³è¿‡æ­¤æ­¥éª¤ï¼‰ï¼š

1.  **è®¾ç½®é¡¹ç›®ç»“æ„**ï¼š

* ä¸ºæ‚¨çš„åº“åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ï¼Œä¾‹å¦‚ `hello_world_library`ã€‚
* åœ¨æ­¤ç›®å½•ä¸­ï¼Œåˆ›å»ºå¦ä¸€ä¸ªç›®å½•ï¼Œä½¿ç”¨æ‚¨çš„åŒ…åç§°ï¼Œä¾‹å¦‚ `hello_world`ã€‚
* åœ¨æ‚¨çš„åŒ…ç›®å½•ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª `__init__.py` æ–‡ä»¶ã€‚æ­¤æ–‡ä»¶å¯ä»¥ä¸ºç©ºï¼Œä¹Ÿå¯ä»¥åŒ…å«æ‚¨åŒ…çš„åˆå§‹åŒ–å†…å®¹ã€‚

```bash
mkdir hello_world_library
cd hello_world_library
mkdir hello_world
touch hello_world/__init__.py
```
2.  **ç¼–å†™åº“ä»£ç **ï¼š

* åœ¨ `hello_world` ç›®å½•ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Python æ–‡ä»¶ä½œä¸ºæ‚¨çš„æ¨¡å—ï¼Œä¾‹å¦‚ `greet.py`ã€‚
* ç¼–å†™æ‚¨çš„ "Hello, World!" å‡½æ•°ï¼š

```python
# hello_world/greet.py
def say_hello():
return "Hello, World!"
```
3.  **åˆ›å»º `setup.py` æ–‡ä»¶**ï¼š

* åœ¨ `hello_world_library` ç›®å½•çš„æ ¹ç›®å½•ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª `setup.py` æ–‡ä»¶ã€‚
* æ­¤æ–‡ä»¶åŒ…å«æœ‰å…³æ‚¨åº“çš„å…ƒæ•°æ®ï¼Œå¹¶å‘Šè¯‰ Python å¦‚ä½•å®‰è£…å®ƒã€‚

```python
# setup.py
from setuptools import setup, find_packages

setup(
name='hello_world',
version='0.1',
packages=find_packages(),
install_requires=[
# æ‚¨çš„åº“æ‰€éœ€çš„ä»»ä½•ä¾èµ–é¡¹
],
)
```

**ç°åœ¨ï¼Œä¸Šä¼ åº“ï¼š**

1.  **æ„å»ºæ‚¨çš„åŒ…**ï¼š

* ä» `hello_world_library` ç›®å½•çš„æ ¹ç›®å½•è¿è¡Œï¼š

```sh
python3 setup.py sdist bdist_wheel
```
2. **ä¸º twine é…ç½®èº«ä»½éªŒè¯**ï¼ˆç”¨äºä¸Šä¼ æ‚¨çš„åŒ…ï¼‰ï¼š
* ç¡®ä¿æ‚¨å·²å®‰è£… `twine`ï¼ˆ`pip install twine`ï¼‰ã€‚
* ä½¿ç”¨ `gcloud` é…ç½®å‡­æ®ï¼š

{% code overflow="wrap" %}
````
```sh
twine upload --username 'oauth2accesstoken' --password "$(gcloud auth print-access-token)" --repository-url https://<location>-python.pkg.dev/<project-id>/<repo-name>/ dist/*
```
````
{% endcode %}

3. **æ¸…ç†æ„å»º**
```bash
rm -rf dist build hello_world.egg-info
```
</details>

{% hint style="danger" %}
æ— æ³•ä¸Šä¼ ä¸å·²å­˜åœ¨ç‰ˆæœ¬ç›¸åŒçš„pythonåº“ï¼Œä½†å¯ä»¥ä¸Šä¼ **æ›´é«˜ç‰ˆæœ¬**ï¼ˆæˆ–è€…åœ¨ç‰ˆæœ¬æœ«å°¾æ·»åŠ ä¸€ä¸ªé¢å¤–çš„**`.0`** - ä½†åœ¨pythonä¸­ä¸é€‚ç”¨ï¼‰ï¼Œæˆ–è€…**åˆ é™¤æœ€åä¸€ä¸ªç‰ˆæœ¬å¹¶ä¸Šä¼ ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬**ï¼ˆéœ€è¦`artifactregistry.versions.delete`ï¼‰**:**

{% code overflow="wrap" %}
```sh
gcloud artifacts versions delete <version> --repository=<repo-name> --location=<location> --package=<lib-name>
```
{% endcode %}
{% endhint %}

### `artifactregistry.repositories.downloadArtifacts`

æ‹¥æœ‰æ­¤æƒé™åï¼Œæ‚¨å¯ä»¥**ä¸‹è½½å·¥ä»¶**å¹¶æœç´¢**æ•æ„Ÿä¿¡æ¯**å’Œ**æ¼æ´**ã€‚

ä¸‹è½½**Docker**é•œåƒï¼š
```sh
# Configure docker to use gcloud to authenticate with Artifact Registry
gcloud auth configure-docker <location>-docker.pkg.dev

# Dowload image
docker pull <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
ä¸‹è½½ä¸€ä¸ª **python** åº“ï¼š

{% code overflow="wrap" %}
```bash
pip install <lib-name> --index-url "https://oauth2accesstoken:$(gcloud auth print-access-token)@<location>-python.pkg.dev/<project-id>/<repo-name>/simple/" --trusted-host <location>-python.pkg.dev --no-cache-dir
```
{% endcode %}

* å¦‚æœåœ¨ä¸€ä¸ªè™šæ‹Ÿæ³¨å†Œè¡¨ä¸­æ··åˆäº†è¿œç¨‹å’Œæ ‡å‡†æ³¨å†Œè¡¨ï¼Œå¹¶ä¸”ä¸€ä¸ªåŒ…åœ¨ä¸¤è€…ä¸­éƒ½å­˜åœ¨ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿè¯·æŸ¥çœ‹æ­¤é¡µé¢ï¼š

{% content-ref url="../gcp-persistence/gcp-artifact-registry-persistence.md" %}
[gcp-artifact-registry-persistence.md](../gcp-persistence/gcp-artifact-registry-persistence.md)
{% endcontent-ref %}

### `artifactregistry.tags.delete`, `artifactregistry.versions.delete`, `artifactregistry.packages.delete`, (`artifactregistry.repositories.get`, `artifactregistry.tags.get`, `artifactregistry.tags.list`)

ä»æ³¨å†Œè¡¨ä¸­åˆ é™¤å·¥ä»¶ï¼Œä¾‹å¦‚ docker é•œåƒï¼š

{% code overflow="wrap" %}
```bash
# Delete a docker image
gcloud artifacts docker images delete <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
{% endcode %}

### `artifactregistry.repositories.delete`

åˆ é™¤ä¸€ä¸ªå®Œæ•´çš„å­˜å‚¨åº“ï¼ˆå³ä½¿å®ƒæœ‰å†…å®¹ï¼‰ï¼š

{% code overflow="wrap" %}
```
gcloud artifacts repositories delete <repo-name> --location=<location>
```
{% endcode %}

### `artifactregistry.repositories.setIamPolicy`

æ‹¥æœ‰æ­¤æƒé™çš„æ”»å‡»è€…å¯ä»¥æˆäºˆè‡ªå·±æ‰§è¡Œä¸€äº›å…ˆå‰æåˆ°çš„å­˜å‚¨åº“æ”»å‡»çš„æƒé™ã€‚

### é€šè¿‡Artifact Registryè¯»å†™è¿›è¡Œå…¶ä»–æœåŠ¡çš„è½¬ç§»

* **Cloud Functions**

å½“åˆ›å»ºCloud Functionæ—¶ï¼Œä¸€ä¸ªæ–°çš„dockeré•œåƒä¼šè¢«æ¨é€åˆ°é¡¹ç›®çš„Artifact Registryã€‚æˆ‘å°è¯•ç”¨ä¸€ä¸ªæ–°çš„é•œåƒä¿®æ”¹é•œåƒï¼Œç”šè‡³åˆ é™¤å½“å‰é•œåƒï¼ˆå’Œ`cache`é•œåƒï¼‰ï¼Œä½†æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼ŒCloud Functionç»§ç»­å·¥ä½œã€‚å› æ­¤ï¼Œå¯èƒ½**å¯ä»¥åˆ©ç”¨ç«äº‰æ¡ä»¶æ”»å‡»**ï¼Œå°±åƒå¯¹å­˜å‚¨æ¡¶é‚£æ ·ï¼Œæ¥æ›´æ”¹å°†è¦è¿è¡Œçš„dockerå®¹å™¨ï¼Œä½†**ä»…ä»…ä¿®æ”¹å­˜å‚¨çš„é•œåƒæ— æ³•ç ´åCloud Function**ã€‚

* **App Engine**

å°½ç®¡App Engineåœ¨Artifact Registryä¸­åˆ›å»ºdockeré•œåƒã€‚æµ‹è¯•è¡¨æ˜ï¼Œ**å³ä½¿æ‚¨åœ¨æ­¤æœåŠ¡ä¸­ä¿®æ”¹é•œåƒ**å¹¶åˆ é™¤App Engineå®ä¾‹ï¼ˆä»¥ä¾¿éƒ¨ç½²ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼‰ï¼Œ**æ‰§è¡Œçš„ä»£ç ä¹Ÿä¸ä¼šæ”¹å˜**ã€‚\
å¯èƒ½é€šè¿‡æ‰§è¡Œ**ç±»ä¼¼äºå­˜å‚¨æ¡¶çš„ç«äº‰æ¡ä»¶æ”»å‡»ï¼Œå¯èƒ½ä¼šè¦†ç›–æ‰§è¡Œçš„ä»£ç **ï¼Œä½†è¿™å°šæœªæµ‹è¯•ã€‚

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
