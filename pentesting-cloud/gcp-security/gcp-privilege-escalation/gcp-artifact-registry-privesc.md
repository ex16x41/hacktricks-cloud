# GCP - Artifact Registry Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Artifact Registry

Για περισσότερες πληροφορίες σχετικά με το Artifact Registry, ελέγξτε:

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### artifactregistry.repositories.uploadArtifacts

Με αυτή την άδεια, ένας επιτιθέμενος θα μπορούσε να ανεβάσει νέες εκδόσεις των artifacts με κακόβουλο κώδικα όπως εικόνες Docker:

{% code overflow="wrap" %}
```bash
# Configure docker to use gcloud to authenticate with Artifact Registry
gcloud auth configure-docker <location>-docker.pkg.dev

# tag the image to upload it
docker tag <local-img-name>:<local-tag> <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>

# Upload it
docker push <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
{% endcode %}

{% hint style="danger" %}
Ελέγχθηκε ότι είναι **δυνατό να ανεβάσετε μια νέα κακόβουλη docker** εικόνα με το ίδιο όνομα και ετικέτα όπως αυτή που είναι ήδη παρούσα, έτσι ώστε η **παλιά να χάσει την ετικέτα** και την επόμενη φορά που αυτή η εικόνα με αυτή την ετικέτα θα **κατεβεί, η κακόβουλη θα κατέβει**.
{% endhint %}

<details>

<summary>Ανεβάστε μια βιβλιοθήκη Python</summary>

**Ξεκινήστε δημιουργώντας τη βιβλιοθήκη που θα ανεβάσετε** (αν μπορείτε να κατεβάσετε την τελευταία έκδοση από το registry μπορείτε να παραλείψετε αυτό το βήμα):

1.  **Ρυθμίστε τη δομή του έργου σας**:

* Δημιουργήστε έναν νέο φάκελο για τη βιβλιοθήκη σας, π.χ., `hello_world_library`.
* Μέσα σε αυτόν τον φάκελο, δημιουργήστε έναν άλλο φάκελο με το όνομα του πακέτου σας, π.χ., `hello_world`.
* Μέσα στον φάκελο του πακέτου σας, δημιουργήστε ένα αρχείο `__init__.py`. Αυτό το αρχείο μπορεί να είναι κενό ή να περιέχει αρχικοποιήσεις για το πακέτο σας.

```bash
mkdir hello_world_library
cd hello_world_library
mkdir hello_world
touch hello_world/__init__.py
```
2.  **Γράψτε τον κώδικα της βιβλιοθήκης σας**:

* Μέσα στον φάκελο `hello_world`, δημιουργήστε ένα νέο αρχείο Python για το module σας, π.χ., `greet.py`.
* Γράψτε τη συνάρτηση "Γειά σου, Κόσμε!":

```python
# hello_world/greet.py
def say_hello():
return "Hello, World!"
```
3.  **Δημιουργήστε ένα αρχείο `setup.py`**:

* Στη ρίζα του φακέλου `hello_world_library`, δημιουργήστε ένα αρχείο `setup.py`.
* Αυτό το αρχείο περιέχει μεταδεδομένα σχετικά με τη βιβλιοθήκη σας και λέει στην Python πώς να την εγκαταστήσει.

```python
# setup.py
from setuptools import setup, find_packages

setup(
name='hello_world',
version='0.1',
packages=find_packages(),
install_requires=[
# Οποιεσδήποτε εξαρτήσεις χρειάζεται η βιβλιοθήκη σας
],
)
```

**Τώρα, ας ανεβάσουμε τη βιβλιοθήκη:**

1.  **Δημιουργήστε το πακέτο σας**:

* Από τη ρίζα του φακέλου `hello_world_library`, εκτελέστε:

```sh
python3 setup.py sdist bdist_wheel
```
2. **Ρυθμίστε την αυθεντικοποίηση για το twine** (χρησιμοποιείται για να ανεβάσετε το πακέτο σας):
* Βεβαιωθείτε ότι έχετε εγκαταστήσει το `twine` (`pip install twine`).
* Χρησιμοποιήστε το `gcloud` για να ρυθμίσετε τα διαπιστευτήρια:

{% code overflow="wrap" %}
````
```sh
twine upload --username 'oauth2accesstoken' --password "$(gcloud auth print-access-token)" --repository-url https://<location>-python.pkg.dev/<project-id>/<repo-name>/ dist/*
```
````
{% endcode %}

3. **Καθαρίστε την κατασκευή**
```bash
rm -rf dist build hello_world.egg-info
```
</details>

{% hint style="danger" %}
Δεν είναι δυνατόν να ανεβάσετε μια βιβλιοθήκη python με την ίδια έκδοση με αυτή που είναι ήδη παρούσα, αλλά είναι δυνατόν να ανεβάσετε **μεγαλύτερες εκδόσεις** (ή να προσθέσετε μια επιπλέον **`.0` στο τέλος** της έκδοσης αν αυτό λειτουργεί - όχι σε python όμως -), ή να **διαγράψετε την τελευταία έκδοση και να ανεβάσετε μια νέα με** (απαραίτητο `artifactregistry.versions.delete)`**:**

{% code overflow="wrap" %}
```sh
gcloud artifacts versions delete <version> --repository=<repo-name> --location=<location> --package=<lib-name>
```
{% endcode %}
{% endhint %}

### `artifactregistry.repositories.downloadArtifacts`

Με αυτή την άδεια μπορείτε να **κατεβάσετε αρχεία** και να αναζητήσετε **ευαίσθητες πληροφορίες** και **ευπάθειες**.

Κατεβάστε μια **Docker** εικόνα:
```sh
# Configure docker to use gcloud to authenticate with Artifact Registry
gcloud auth configure-docker <location>-docker.pkg.dev

# Dowload image
docker pull <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
Κατεβάστε μια **python** βιβλιοθήκη:

{% code overflow="wrap" %}
```bash
pip install <lib-name> --index-url "https://oauth2accesstoken:$(gcloud auth print-access-token)@<location>-python.pkg.dev/<project-id>/<repo-name>/simple/" --trusted-host <location>-python.pkg.dev --no-cache-dir
```
{% endcode %}

* Τι συμβαίνει αν αναμειχθούν ένα απομακρυσμένο και ένα κανονικό μητρώο σε ένα εικονικό και ένα πακέτο υπάρχει και στα δύο; Ελέγξτε αυτή τη σελίδα:

{% content-ref url="../gcp-persistence/gcp-artifact-registry-persistence.md" %}
[gcp-artifact-registry-persistence.md](../gcp-persistence/gcp-artifact-registry-persistence.md)
{% endcontent-ref %}

### `artifactregistry.tags.delete`, `artifactregistry.versions.delete`, `artifactregistry.packages.delete`, (`artifactregistry.repositories.get`, `artifactregistry.tags.get`, `artifactregistry.tags.list`)

Διαγράψτε τα artifacts από το μητρώο, όπως εικόνες docker:

{% code overflow="wrap" %}
```bash
# Delete a docker image
gcloud artifacts docker images delete <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
{% endcode %}

### `artifactregistry.repositories.delete`

Διαγράψτε ένα πλήρες αποθετήριο (ακόμα και αν έχει περιεχόμενο):

{% code overflow="wrap" %}
```
gcloud artifacts repositories delete <repo-name> --location=<location>
```
{% endcode %}

### `artifactregistry.repositories.setIamPolicy`

Ένας επιτιθέμενος με αυτή την άδεια θα μπορούσε να δώσει στον εαυτό του άδειες για να εκτελέσει μερικές από τις προηγουμένως αναφερόμενες επιθέσεις αποθετηρίου.

### Pivoting σε άλλες Υπηρεσίες μέσω Artifact Registry Read & Write

* **Cloud Functions**

Όταν δημιουργείται μια Cloud Function, μια νέα εικόνα docker αποστέλλεται στο Artifact Registry του έργου. Προσπάθησα να τροποποιήσω την εικόνα με μια νέα και ακόμη και να διαγράψω την τρέχουσα εικόνα (και την εικόνα `cache`) και τίποτα δεν άλλαξε, η cloud function συνεχίζει να λειτουργεί. Επομένως, ίσως **να είναι δυνατόν να εκμεταλλευτεί κανείς μια επίθεση Race Condition** όπως με τον κάδο για να αλλάξει το docker container που θα εκτελείται, αλλά **απλά τροποποιώντας την αποθηκευμένη εικόνα δεν είναι δυνατόν να συμβιβαστεί η Cloud Function**.

* **App Engine**

Ακόμη και αν το App Engine δημιουργεί εικόνες docker μέσα στο Artifact Registry. Δοκιμάστηκε ότι **ακόμη και αν τροποποιήσεις την εικόνα μέσα σε αυτή την υπηρεσία** και αφαιρέσεις την παρουσία του App Engine (έτσι ώστε να αναπτυχθεί μια νέα) ο **κώδικας που εκτελείται δεν αλλάζει**.\
Ενδέχεται να είναι δυνατόν να εκτελέσεις μια **επίθεση Race Condition όπως με τους κάδους, ίσως να είναι δυνατόν να αντικαταστήσεις τον εκτελούμενο κώδικα**, αλλά αυτό δεν δοκιμάστηκε.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
