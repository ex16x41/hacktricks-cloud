# GCP - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Stockage

Informations de base :

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Cette permission vous permet de **t√©l√©charger des fichiers stock√©s dans Cloud Storage**. Cela vous permettra potentiellement d'escalader les privil√®ges car dans certaines occasions **des informations sensibles y sont enregistr√©es**. De plus, certains services GCP stockent leurs informations dans des buckets :

* **GCP Composer** : Lorsque vous cr√©ez un environnement Composer, le **code de tous les DAGs** sera enregistr√© dans un **bucket**. Ces t√¢ches peuvent contenir des informations int√©ressantes dans leur code.
* **GCR (Container Registry)** : L'**image** des conteneurs est stock√©e dans des **buckets**, ce qui signifie que si vous pouvez lire les buckets, vous pourrez t√©l√©charger les images et **rechercher des fuites et/ou du code source**.

### `storage.objects.setIamPolicy`

Vous pouvez vous donner la permission de **profiter de l'un des sc√©narios pr√©c√©dents de cette section**.

### **`storage.buckets.setIamPolicy`**

Pour un exemple sur la fa√ßon de modifier les permissions avec cette permission, consultez cette page :

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

La fonctionnalit√© "interop√©rabilit√©" de Cloud Storage, con√ßue pour des **interactions inter-cloud** comme avec AWS S3, implique la **cr√©ation de cl√©s HMAC pour les comptes de service et les utilisateurs**. Un attaquant peut exploiter cela en **g√©n√©rant une cl√© HMAC pour un compte de service avec des privil√®ges √©lev√©s**, permettant ainsi **d'escalader les privil√®ges au sein de Cloud Storage**. Bien que les cl√©s HMAC associ√©es aux utilisateurs ne soient r√©cup√©rables que via la console web, les cl√©s d'acc√®s et secr√®tes restent **perp√©tuellement accessibles**, permettant un acc√®s de sauvegarde potentiel. En revanche, les cl√©s HMAC li√©es aux comptes de service sont accessibles via l'API, mais leurs cl√©s d'acc√®s et secr√®tes ne sont pas r√©cup√©rables apr√®s leur cr√©ation, ajoutant une couche de complexit√© pour un acc√®s continu.

{% code overflow="wrap" %}
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
{% endcode %}

Un autre script d'exploitation pour cette m√©thode peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Permissions d'√©criture dans le stockage

Pour **cr√©er un nouvel objet** √† l'int√©rieur d'un bucket, vous avez besoin de `storage.objects.create` et, selon [la documentation](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), vous avez √©galement besoin de `storage.objects.delete` pour **modifier** un objet existant.

Une **exploitation tr√®s courante** des buckets o√π vous pouvez √©crire dans le cloud est le cas o√π le **bucket sauvegarde des fichiers de serveur web**, vous pourriez √™tre en mesure de **stocker un nouveau code** qui sera utilis√© par l'application web.

### Composer

**Composer** est **Apache Airflow** g√©r√© √† l'int√©rieur de GCP. Il a plusieurs fonctionnalit√©s int√©ressantes :

* Il fonctionne √† l'int√©rieur d'un **cluster GKE**, donc le **SA utilis√© par le cluster est accessible** par le code s'ex√©cutant √† l'int√©rieur de Composer.
* Tous les composants d'un environnement de composer (**code des DAGs**, plugins et donn√©es) sont stock√©s √† l'int√©rieur d'un bucket GCP. Si l'attaquant a des permissions de lecture et d'√©criture sur celui-ci, il pourrait surveiller le bucket et **chaque fois qu'un DAG est cr√©√© ou mis √† jour, soumettre une version compromise** afin que l'environnement de composer r√©cup√®re la version compromise depuis le stockage.

**Vous pouvez trouver un PoC de cette attaque dans le repo :** [**https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs**](https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs)

### Cloud Functions

* Le code des Cloud Functions est stock√© dans Storage et chaque fois qu'une nouvelle version est cr√©√©e, le code est pouss√© vers le bucket et ensuite le nouveau conteneur est construit √† partir de ce code. Par cons√©quent, **√©craser le code avant que la nouvelle version ne soit construite permet d'ex√©cuter du code arbitraire dans la fonction cloud**.

**Vous pouvez trouver un PoC de cette attaque dans le repo :** [**https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions**](https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions)

### App Engine

* Les versions d'App Engine g√©n√®rent des donn√©es √† l'int√©rieur d'un bucket avec le format de nom : `staging.<project-id>.appspot.com`. Notez qu'il n'est pas possible de pr√©-prendre ce bucket car les utilisateurs GCP ne sont pas autoris√©s √† g√©n√©rer des buckets utilisant le nom de domaine `appspot.com`.

Cependant, avec un acc√®s en lecture et √©criture sur ce bucket, il est possible de **escalader les privil√®ges au SA attach√© √† la version AppEngine** en surveillant le bucket et chaque fois qu'un changement est effectu√©, modifier le code aussi rapidement que possible. De cette mani√®re, le conteneur qui est cr√©√© √† partir de ce code **ex√©cutera le code compromis**.

**Vous pouvez trouver un PoC de cette attaque dans le repo :** [**https://github.com/carlospolop/Monitor-Backdoor-AppEngine**](https://github.com/carlospolop/Monitor-Backdoor-AppEngine)

### GCR

* **Google Container Registry** stocke les images √† l'int√©rieur des buckets, si vous pouvez **√©crire dans ces buckets**, vous pourriez √™tre en mesure de **migrer lat√©ralement vers l'endroit o√π ces buckets sont ex√©cut√©s.**
* Le bucket utilis√© par GCR aura une URL similaire √† `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Les sous-domaines de niveau sup√©rieur sont sp√©cifi√©s [ici](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

{% hint style="success" %}
Ce service est obsol√®te donc cette attaque n'est plus utile. De plus, Artifactory, le service qui le remplace, ne stocke pas les images dans des buckets.
{% endhint %}

## **R√©f√©rences**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos GitHub.

</details>
{% endhint %}
