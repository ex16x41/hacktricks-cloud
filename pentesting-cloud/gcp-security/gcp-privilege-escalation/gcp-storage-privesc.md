# GCP - Storage Privesc

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## å­˜å‚¨

åŸºæœ¬ä¿¡æ¯ï¼š

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

æ­¤æƒé™å…è®¸æ‚¨**ä¸‹è½½å­˜å‚¨åœ¨ Cloud Storage ä¸­çš„æ–‡ä»¶**ã€‚è¿™å¯èƒ½ä¼šè®©æ‚¨æå‡æƒé™ï¼Œå› ä¸ºåœ¨æŸäº›æƒ…å†µä¸‹**æ•æ„Ÿä¿¡æ¯è¢«ä¿å­˜åœ¨é‚£é‡Œ**ã€‚æ­¤å¤–ï¼Œä¸€äº› GCP æœåŠ¡å°†å…¶ä¿¡æ¯å­˜å‚¨åœ¨æ¡¶ä¸­ï¼š

* **GCP Composer**ï¼šå½“æ‚¨åˆ›å»ºä¸€ä¸ª Composer ç¯å¢ƒæ—¶ï¼Œ**æ‰€æœ‰ DAG çš„ä»£ç **å°†ä¿å­˜åœ¨ä¸€ä¸ª**æ¡¶**ä¸­ã€‚è¿™äº›ä»»åŠ¡çš„ä»£ç ä¸­å¯èƒ½åŒ…å«æœ‰è¶£çš„ä¿¡æ¯ã€‚
* **GCR (å®¹å™¨æ³¨å†Œè¡¨)**ï¼šå®¹å™¨çš„**é•œåƒ**å­˜å‚¨åœ¨**æ¡¶**ä¸­ï¼Œè¿™æ„å‘³ç€å¦‚æœæ‚¨å¯ä»¥è¯»å–è¿™äº›æ¡¶ï¼Œæ‚¨å°†èƒ½å¤Ÿä¸‹è½½é•œåƒå¹¶**æœç´¢æ³„æ¼å’Œ/æˆ–æºä»£ç **ã€‚

### `storage.objects.setIamPolicy`

æ‚¨å¯ä»¥æˆäºˆè‡ªå·±æƒé™ä»¥**æ»¥ç”¨æœ¬èŠ‚ä¸­çš„ä»»ä½•å…ˆå‰åœºæ™¯**ã€‚

### **`storage.buckets.setIamPolicy`**

æœ‰å…³å¦‚ä½•ä½¿ç”¨æ­¤æƒé™ä¿®æ”¹æƒé™çš„ç¤ºä¾‹ï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢ï¼š

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unauthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storage çš„â€œäº’æ“ä½œæ€§â€åŠŸèƒ½ï¼Œæ—¨åœ¨å®ç°ä¸ AWS S3 ç­‰çš„**è·¨äº‘äº¤äº’**ï¼Œæ¶‰åŠä¸º**æœåŠ¡è´¦æˆ·å’Œç”¨æˆ·åˆ›å»º HMAC å¯†é’¥**ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡**ä¸ºå…·æœ‰æå‡æƒé™çš„æœåŠ¡è´¦æˆ·ç”Ÿæˆ HMAC å¯†é’¥**æ¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œä»è€Œ**åœ¨ Cloud Storage ä¸­æå‡æƒé™**ã€‚è™½ç„¶ä¸ç”¨æˆ·ç›¸å…³çš„ HMAC å¯†é’¥åªèƒ½é€šè¿‡ç½‘ç»œæ§åˆ¶å°æ£€ç´¢ï¼Œä½†è®¿é—®å¯†é’¥å’Œç§˜å¯†å¯†é’¥å§‹ç»ˆä¿æŒ**å¯è®¿é—®**ï¼Œå…è®¸æ½œåœ¨çš„å¤‡ä»½è®¿é—®å­˜å‚¨ã€‚ç›¸åï¼Œä¸æœåŠ¡è´¦æˆ·å…³è”çš„ HMAC å¯†é’¥å¯ä»¥é€šè¿‡ API è®¿é—®ï¼Œä½†å…¶è®¿é—®å¯†é’¥å’Œç§˜å¯†å¯†é’¥åœ¨åˆ›å»ºåä¸å¯æ£€ç´¢ï¼Œä¸ºæŒç»­è®¿é—®å¢åŠ äº†ä¸€å±‚å¤æ‚æ€§ã€‚

{% code overflow="wrap" %}
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
{% endcode %}

å¦ä¸€ä¸ªé’ˆå¯¹æ­¤æ–¹æ³•çš„åˆ©ç”¨è„šæœ¬å¯ä»¥åœ¨ [è¿™é‡Œ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py) æ‰¾åˆ°ã€‚

## `storage.objects.create`, `storage.objects.delete` = å­˜å‚¨å†™å…¥æƒé™

ä¸ºäº†åœ¨å­˜å‚¨æ¡¶ä¸­**åˆ›å»ºæ–°å¯¹è±¡**ï¼Œæ‚¨éœ€è¦ `storage.objects.create`ï¼Œå¹¶ä¸”æ ¹æ® [æ–‡æ¡£](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions)ï¼Œæ‚¨è¿˜éœ€è¦ `storage.objects.delete` æ¥**ä¿®æ”¹**ç°æœ‰å¯¹è±¡ã€‚

åœ¨å¯ä»¥åœ¨äº‘ä¸­å†™å…¥çš„å­˜å‚¨æ¡¶ä¸­ï¼Œ**å¸¸è§çš„åˆ©ç”¨**æ˜¯å½“**å­˜å‚¨æ¡¶ä¿å­˜ç½‘é¡µæœåŠ¡å™¨æ–‡ä»¶**æ—¶ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿ**å­˜å‚¨æ–°ä»£ç **ï¼Œè¯¥ä»£ç å°†è¢«ç½‘é¡µåº”ç”¨ç¨‹åºä½¿ç”¨ã€‚

### Composer

**Composer** æ˜¯åœ¨ GCP ä¸­ç®¡ç†çš„ **Apache Airflow**ã€‚å®ƒæœ‰å‡ ä¸ªæœ‰è¶£çš„åŠŸèƒ½ï¼š

* å®ƒè¿è¡Œåœ¨ **GKE é›†ç¾¤** ä¸­ï¼Œå› æ­¤ **é›†ç¾¤ä½¿ç”¨çš„ SA å¯ä»¥è¢« Composer ä¸­è¿è¡Œçš„ä»£ç è®¿é—®**
* Composer ç¯å¢ƒçš„æ‰€æœ‰ç»„ä»¶ï¼ˆ**DAG çš„ä»£ç **ã€æ’ä»¶å’Œæ•°æ®ï¼‰éƒ½å­˜å‚¨åœ¨ GCP å­˜å‚¨æ¡¶ä¸­ã€‚å¦‚æœæ”»å‡»è€…å¯¹å…¶å…·æœ‰è¯»å†™æƒé™ï¼Œä»–å¯ä»¥ç›‘æ§å­˜å‚¨æ¡¶ï¼Œå¹¶ä¸”**æ¯å½“åˆ›å»ºæˆ–æ›´æ–° DAG æ—¶ï¼Œæäº¤ä¸€ä¸ªåé—¨ç‰ˆæœ¬**ï¼Œè¿™æ · Composer ç¯å¢ƒå°±ä¼šä»å­˜å‚¨ä¸­è·å–åé—¨ç‰ˆæœ¬ã€‚

**æ‚¨å¯ä»¥åœ¨è¯¥ä»“åº“ä¸­æ‰¾åˆ°æ­¤æ”»å‡»çš„ PoCï¼š** [**https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs**](https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs)

### Cloud Functions

* Cloud Functions ä»£ç å­˜å‚¨åœ¨å­˜å‚¨ä¸­ï¼Œæ¯å½“åˆ›å»ºæ–°ç‰ˆæœ¬æ—¶ï¼Œä»£ç ä¼šæ¨é€åˆ°å­˜å‚¨æ¡¶ï¼Œç„¶åä»è¯¥ä»£ç æ„å»ºæ–°å®¹å™¨ã€‚å› æ­¤ï¼Œ**åœ¨æ–°ç‰ˆæœ¬æ„å»ºä¹‹å‰è¦†ç›–ä»£ç å¯ä»¥ä½¿äº‘å‡½æ•°æ‰§è¡Œä»»æ„ä»£ç **ã€‚

**æ‚¨å¯ä»¥åœ¨è¯¥ä»“åº“ä¸­æ‰¾åˆ°æ­¤æ”»å‡»çš„ PoCï¼š** [**https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions**](https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions)

### App Engine

AppEngine ç‰ˆæœ¬åœ¨å­˜å‚¨æ¡¶ä¸­ç”Ÿæˆä¸€äº›æ•°æ®ï¼Œæ ¼å¼ä¸ºï¼š`staging.<project-id>.appspot.com`ã€‚åœ¨æ­¤å­˜å‚¨æ¡¶ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåä¸º `ae` çš„æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹å°†åŒ…å«æ¯ä¸ª AppEngine åº”ç”¨ç¨‹åºç‰ˆæœ¬çš„æ–‡ä»¶å¤¹ï¼Œåœ¨è¿™äº›æ–‡ä»¶å¤¹ä¸­å¯ä»¥æ‰¾åˆ° `manifest.json` æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åŒ…å«ä¸€ä¸ª jsonï¼Œåˆ—å‡ºäº†åˆ›å»ºç‰¹å®šç‰ˆæœ¬æ‰€éœ€çš„æ‰€æœ‰æ–‡ä»¶ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥æ‰¾åˆ°**æ–‡ä»¶çš„çœŸå®åç§°ã€å®ƒä»¬åœ¨ GCP å­˜å‚¨æ¡¶ä¸­çš„ URLï¼ˆå­˜å‚¨æ¡¶ä¸­çš„æ–‡ä»¶æ›´æ”¹äº†åç§°ä¸ºå…¶ sha1 å“ˆå¸Œï¼‰ä»¥åŠæ¯ä¸ªæ–‡ä»¶çš„ sha1 å“ˆå¸Œã€‚**

_è¯·æ³¨æ„ï¼Œç”±äº GCP ç”¨æˆ·æ²¡æœ‰æƒé™ä½¿ç”¨åŸŸå appspot.com ç”Ÿæˆå­˜å‚¨æ¡¶ï¼Œå› æ­¤æ— æ³•é¢„å…ˆæ¥ç®¡æ­¤å­˜å‚¨æ¡¶ã€‚_

ç„¶è€Œï¼Œæ‹¥æœ‰å¯¹è¯¥å­˜å‚¨æ¡¶çš„è¯»å†™è®¿é—®æƒé™ï¼Œå¯ä»¥é€šè¿‡ç›‘æ§å­˜å‚¨æ¡¶å¹¶åœ¨æ¯æ¬¡è¿›è¡Œæ›´æ”¹ï¼ˆæ–°ç‰ˆæœ¬ï¼‰æ—¶å°½å¿«ä¿®æ”¹æ–°ç‰ˆæœ¬ï¼Œä»è€Œæå‡ä¸ App Engine ç‰ˆæœ¬å…³è”çš„ SA çš„æƒé™ã€‚è¿™æ ·ï¼Œä»è¯¥ä»£ç åˆ›å»ºçš„å®¹å™¨å°†æ‰§è¡Œåé—¨ä»£ç ã€‚

æåˆ°çš„æ”»å‡»å¯ä»¥é€šè¿‡å¤šç§ä¸åŒæ–¹å¼æ‰§è¡Œï¼Œæ‰€æœ‰è¿™äº›æ–¹å¼éƒ½ä»ç›‘æ§ `staging.<project-id>.appspot.com` å­˜å‚¨æ¡¶å¼€å§‹ï¼š

* å°† AppEngine ç‰ˆæœ¬çš„å®Œæ•´æ–°ä»£ç ä¸Šä¼ åˆ°ä¸åŒä¸”å¯ç”¨çš„å­˜å‚¨æ¡¶ï¼Œå¹¶å‡†å¤‡ä¸€ä¸ª**`manifest.json` æ–‡ä»¶ï¼ŒåŒ…å«æ–°å­˜å‚¨æ¡¶åç§°å’Œå®ƒä»¬çš„ sha1 å“ˆå¸Œ**ã€‚ç„¶åï¼Œå½“åœ¨å­˜å‚¨æ¡¶ä¸­åˆ›å»ºæ–°ç‰ˆæœ¬æ—¶ï¼Œæ‚¨åªéœ€ä¿®æ”¹ `manifest.json` æ–‡ä»¶å¹¶ä¸Šä¼ æ¶æ„æ–‡ä»¶ã€‚
* ä¸Šä¼ ä¸€ä¸ªä¿®æ”¹è¿‡çš„ `requirements.txt` ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬å°†ä½¿ç”¨**æ¶æ„ä¾èµ–ä»£ç å¹¶æ›´æ–° `manifest.json`** æ–‡ä»¶ï¼ŒåŒ…å«æ–°æ–‡ä»¶åã€URL å’Œå“ˆå¸Œã€‚
* ä¸Šä¼ ä¸€ä¸ª**ä¿®æ”¹è¿‡çš„ `main.py` æˆ– `app.yaml` æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†æ‰§è¡Œæ¶æ„ä»£ç **å¹¶æ›´æ–° `manifest.json` æ–‡ä»¶ï¼ŒåŒ…å«æ–°æ–‡ä»¶åã€URL å’Œå“ˆå¸Œã€‚

**æ‚¨å¯ä»¥åœ¨è¯¥ä»“åº“ä¸­æ‰¾åˆ°æ­¤æ”»å‡»çš„ PoCï¼š** [**https://github.com/carlospolop/Monitor-Backdoor-AppEngine**](https://github.com/carlospolop/Monitor-Backdoor-AppEngine)

### GCR

* **Google Container Registry** å°†å›¾åƒå­˜å‚¨åœ¨å­˜å‚¨æ¡¶ä¸­ï¼Œå¦‚æœæ‚¨å¯ä»¥**å†™å…¥è¿™äº›å­˜å‚¨æ¡¶**ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿ**æ¨ªå‘ç§»åŠ¨åˆ°è¿™äº›å­˜å‚¨æ¡¶è¿è¡Œçš„åœ°æ–¹ã€‚**
* GCR ä½¿ç”¨çš„å­˜å‚¨æ¡¶å°†å…·æœ‰ç±»ä¼¼äº `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` çš„ URLï¼ˆé¡¶çº§å­åŸŸåœ¨ [è¿™é‡Œ](https://cloud.google.com/container-registry/docs/pushing-and-pulling) æŒ‡å®šï¼‰ã€‚

{% hint style="success" %}
æ­¤æœåŠ¡å·²è¢«å¼ƒç”¨ï¼Œå› æ­¤æ­¤æ”»å‡»ä¸å†æœ‰æ•ˆã€‚æ­¤å¤–ï¼Œæ›¿ä»£æ­¤æœåŠ¡çš„ Artifact Registry ä¸ä¼šå°†å›¾åƒå­˜å‚¨åœ¨å­˜å‚¨æ¡¶ä¸­ã€‚
{% endhint %}

## **å‚è€ƒæ–‡çŒ®**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æ”»å‡»ï¼š<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æ”»å‡»ï¼š <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
