# GCP - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage

ê¸°ë³¸ ì •ë³´:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

ì´ ê¶Œí•œì€ **Cloud Storageì— ì €ì¥ëœ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤**. ì´ëŠ” ê²½ìš°ì— ë”°ë¼ **ë¯¼ê°í•œ ì •ë³´ê°€ ì €ì¥ë˜ì–´ ìˆê¸° ë•Œë¬¸ì—** ê¶Œí•œ ìƒìŠ¹ì„ ê°€ëŠ¥í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, ì¼ë¶€ GCP ì„œë¹„ìŠ¤ëŠ” ì •ë³´ë¥¼ ë²„í‚·ì— ì €ì¥í•©ë‹ˆë‹¤:

* **GCP Composer**: Composer í™˜ê²½ì„ ìƒì„±í•  ë•Œ **ëª¨ë“  DAGì˜ ì½”ë“œ**ê°€ **ë²„í‚·**ì— ì €ì¥ë©ë‹ˆë‹¤. ì´ ì‘ì—…ë“¤ì€ ì½”ë“œ ì•ˆì— í¥ë¯¸ë¡œìš´ ì •ë³´ë¥¼ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **GCR (Container Registry)**: **ì»¨í…Œì´ë„ˆì˜ ì´ë¯¸ì§€**ëŠ” **ë²„í‚·**ì— ì €ì¥ë˜ë©°, ì´ëŠ” ë²„í‚·ì„ ì½ì„ ìˆ˜ ìˆë‹¤ë©´ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  **ì •ë³´ ìœ ì¶œ ë°/ë˜ëŠ” ì†ŒìŠ¤ ì½”ë“œë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤**.

### `storage.objects.setIamPolicy`

ì´ ê¶Œí•œì„ í†µí•´ **ì´ ì„¹ì…˜ì˜ ì´ì „ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì•…ìš©í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

### **`storage.buckets.setIamPolicy`**

ì´ ê¶Œí•œìœ¼ë¡œ ê¶Œí•œì„ ìˆ˜ì •í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì˜ˆì‹œëŠ” ì´ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storageì˜ "ìƒí˜¸ ìš´ìš©ì„±" ê¸°ëŠ¥ì€ **AWS S3ì™€ ê°™ì€ í¬ë¡œìŠ¤ í´ë¼ìš°ë“œ ìƒí˜¸ ì‘ìš©**ì„ ìœ„í•´ ì„¤ê³„ë˜ì—ˆìœ¼ë©°, **ì„œë¹„ìŠ¤ ê³„ì • ë° ì‚¬ìš©ìì— ëŒ€í•œ HMAC í‚¤ ìƒì„±**ì„ í¬í•¨í•©ë‹ˆë‹¤. ê³µê²©ìëŠ” **ìƒìŠ¹ëœ ê¶Œí•œì„ ê°€ì§„ ì„œë¹„ìŠ¤ ê³„ì •ì— ëŒ€í•œ HMAC í‚¤ë¥¼ ìƒì„±í•˜ì—¬ Cloud Storage ë‚´ì—ì„œ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ì‚¬ìš©ìì™€ ì—°ê²°ëœ HMAC í‚¤ëŠ” ì›¹ ì½˜ì†”ì„ í†µí•´ì„œë§Œ ê²€ìƒ‰í•  ìˆ˜ ìˆì§€ë§Œ, ì ‘ê·¼ ë° ë¹„ë°€ í‚¤ëŠ” **ì˜êµ¬ì ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥**í•˜ì—¬ ì ì¬ì ì¸ ë°±ì—… ì ‘ê·¼ ì €ì¥ì†Œë¥¼ í—ˆìš©í•©ë‹ˆë‹¤. ë°˜ë©´, ì„œë¹„ìŠ¤ ê³„ì •ì— ì—°ê²°ëœ HMAC í‚¤ëŠ” APIë¥¼ í†µí•´ ì ‘ê·¼í•  ìˆ˜ ìˆì§€ë§Œ, ìƒì„± í›„ì—ëŠ” ì ‘ê·¼ ë° ë¹„ë°€ í‚¤ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ì—†ì–´ ì§€ì†ì ì¸ ì ‘ê·¼ì— ëŒ€í•œ ë³µì¡ì„±ì„ ë”í•©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
{% endcode %}

ì´ ë°©ë²•ì— ëŒ€í•œ ë˜ ë‹¤ë¥¸ ìµìŠ¤í”Œë¡œì‡ ìŠ¤í¬ë¦½íŠ¸ëŠ” [ì—¬ê¸°](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## `storage.objects.create`, `storage.objects.delete` = ìŠ¤í† ë¦¬ì§€ ì“°ê¸° ê¶Œí•œ

ë²„í‚· ë‚´ì— **ìƒˆ ê°ì²´ë¥¼ ìƒì„±**í•˜ë ¤ë©´ `storage.objects.create`ê°€ í•„ìš”í•˜ë©°, [ë¬¸ì„œ](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions)ì— ë”°ë¥´ë©´ **ì¡´ì¬í•˜ëŠ” ê°ì²´ë¥¼ ìˆ˜ì •**í•˜ë ¤ë©´ `storage.objects.delete`ë„ í•„ìš”í•©ë‹ˆë‹¤.

í´ë¼ìš°ë“œì—ì„œ ì“¸ ìˆ˜ ìˆëŠ” ë²„í‚·ì˜ **ì¼ë°˜ì ì¸ ìµìŠ¤í”Œë¡œì‡**ì€ **ë²„í‚·ì´ ì›¹ ì„œë²„ íŒŒì¼ì„ ì €ì¥í•˜ëŠ” ê²½ìš°**ë¡œ, ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©ë  **ìƒˆ ì½”ë“œë¥¼ ì €ì¥**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Composer

**Composer**ëŠ” GCP ë‚´ì—ì„œ ê´€ë¦¬ë˜ëŠ” **Apache Airflow**ì…ë‹ˆë‹¤. ì—¬ëŸ¬ í¥ë¯¸ë¡œìš´ ê¸°ëŠ¥ì´ ìˆìŠµë‹ˆë‹¤:

* **GKE í´ëŸ¬ìŠ¤í„°** ë‚´ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ **í´ëŸ¬ìŠ¤í„°ê°€ ì‚¬ìš©í•˜ëŠ” SAëŠ” Composer ë‚´ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œì— ì˜í•´ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.**
* Composer í™˜ê²½ì˜ ëª¨ë“  êµ¬ì„± ìš”ì†Œ(**DAGì˜ ì½”ë“œ**, í”ŒëŸ¬ê·¸ì¸ ë° ë°ì´í„°)ëŠ” GCP ë²„í‚· ë‚´ì— ì €ì¥ë©ë‹ˆë‹¤. ê³µê²©ìê°€ ì´ì— ëŒ€í•œ ì½ê¸° ë° ì“°ê¸° ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´, ë²„í‚·ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  **DAGê°€ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ ë°±ë„ì–´ê°€ í¬í•¨ëœ ë²„ì „ì„ ì œì¶œ**í•˜ì—¬ Composer í™˜ê²½ì´ ì €ì¥ì†Œì—ì„œ ë°±ë„ì–´ê°€ í¬í•¨ëœ ë²„ì „ì„ ê°€ì ¸ì˜¤ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì´ ê³µê²©ì˜ PoCë¥¼ ë ˆí¬ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:** [**https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs**](https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs)

### Cloud Functions

* Cloud Functions ì½”ë“œëŠ” ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ë˜ë©°, ìƒˆ ë²„ì „ì´ ìƒì„±ë  ë•Œë§ˆë‹¤ ì½”ë“œëŠ” ë²„í‚·ì— í‘¸ì‹œë˜ê³  ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆê°€ ì´ ì½”ë“œë¡œë¶€í„° ë¹Œë“œë©ë‹ˆë‹¤. ë”°ë¼ì„œ **ìƒˆ ë²„ì „ì´ ë¹Œë“œë˜ê¸° ì „ì— ì½”ë“œë¥¼ ë®ì–´ì“°ëŠ” ê²ƒì€ í´ë¼ìš°ë“œ í•¨ìˆ˜ê°€ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

**ì´ ê³µê²©ì˜ PoCë¥¼ ë ˆí¬ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:** [**https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions**](https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions)

### App Engine

* App Engine ë²„ì „ì€ `staging.<project-id>.appspot.com` í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ë²„í‚· ë‚´ì— ìƒì„±í•©ë‹ˆë‹¤. GCP ì‚¬ìš©ìëŠ” `appspot.com` ë„ë©”ì¸ ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ ë²„í‚·ì„ ìƒì„±í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ì´ ë²„í‚·ì„ ì‚¬ì „ ì ìœ í•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì´ ë²„í‚·ì— ëŒ€í•œ ì½ê¸° ë° ì“°ê¸° ì ‘ê·¼ ê¶Œí•œì´ ìˆë‹¤ë©´, ë²„í‚·ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ë³€ê²½ì´ ìˆ˜í–‰ë  ë•Œë§ˆë‹¤ ê°€ëŠ¥í•œ í•œ ë¹¨ë¦¬ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì—¬ **AppEngine ë²„ì „ì— ì—°ê²°ëœ SAì— ëŒ€í•œ ê¶Œí•œì„ ìƒìŠ¹**ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì´ ì½”ë“œë¡œë¶€í„° ìƒì„±ëœ ì»¨í…Œì´ë„ˆê°€ **ë°±ë„ì–´ê°€ í¬í•¨ëœ ì½”ë“œë¥¼ ì‹¤í–‰**í•˜ê²Œ ë©ë‹ˆë‹¤.

**ì´ ê³µê²©ì˜ PoCë¥¼ ë ˆí¬ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:** [**https://github.com/carlospolop/Monitor-Backdoor-AppEngine**](https://github.com/carlospolop/Monitor-Backdoor-AppEngine)

### GCR

* **Google Container Registry**ëŠ” ì´ë¯¸ì§€ë¥¼ ë²„í‚·ì— ì €ì¥í•˜ë©°, **ì´ ë²„í‚·ì— ì“¸ ìˆ˜ ìˆë‹¤ë©´** ë‚˜ì¤‘ì— **ì´ ë²„í‚·ì´ ì‹¤í–‰ë˜ëŠ” ê³³ìœ¼ë¡œ ìˆ˜í‰ ì´ë™**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* GCRì—ì„œ ì‚¬ìš©í•˜ëŠ” ë²„í‚·ì€ `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com`ì™€ ìœ ì‚¬í•œ URLì„ ê°€ì§‘ë‹ˆë‹¤ (ìµœìƒìœ„ í•˜ìœ„ ë„ë©”ì¸ì€ [ì—¬ê¸°](https://cloud.google.com/container-registry/docs/pushing-and-pulling)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤).

{% hint style="success" %}
ì´ ì„œë¹„ìŠ¤ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì´ ê³µê²©ì€ ë” ì´ìƒ ìœ ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë˜í•œ, ì´ ì„œë¹„ìŠ¤ë¥¼ ëŒ€ì²´í•˜ëŠ” ArtifactoryëŠ” ì´ë¯¸ì§€ë¥¼ ë²„í‚·ì— ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
{% endhint %}

## **ì°¸ê³ ë¬¸í—Œ**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë ˆí¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
