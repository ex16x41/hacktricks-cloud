# GCP - å­˜å‚¨æƒé™æå‡

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## å­˜å‚¨

åŸºæœ¬ä¿¡æ¯ï¼š

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

æ­¤æƒé™å…è®¸æ‚¨**ä¸‹è½½å­˜å‚¨åœ¨Cloud Storageä¸­çš„æ–‡ä»¶**ã€‚è¿™å¯èƒ½ä¼šä½¿æ‚¨èƒ½å¤Ÿæå‡æƒé™ï¼Œå› ä¸ºåœ¨æŸäº›æƒ…å†µä¸‹**æ•æ„Ÿä¿¡æ¯ä¼šä¿å­˜åœ¨é‚£é‡Œ**ã€‚æ­¤å¤–ï¼Œä¸€äº›GCPæœåŠ¡å°†å®ƒä»¬çš„ä¿¡æ¯å­˜å‚¨åœ¨å­˜å‚¨æ¡¶ä¸­ï¼š

* **GCP Composer**ï¼šå½“æ‚¨åˆ›å»ºComposerç¯å¢ƒæ—¶ï¼Œ**æ‰€æœ‰DAGçš„ä»£ç **å°†ä¿å­˜åœ¨ä¸€ä¸ª**å­˜å‚¨æ¡¶**ä¸­ã€‚è¿™äº›ä»»åŠ¡å¯èƒ½åœ¨å…¶ä»£ç ä¸­åŒ…å«æœ‰è¶£çš„ä¿¡æ¯ã€‚
* **GCRï¼ˆå®¹å™¨æ³¨å†Œè¡¨ï¼‰**ï¼šå®¹å™¨çš„**é•œåƒ**å­˜å‚¨åœ¨**å­˜å‚¨æ¡¶**ä¸­ï¼Œè¿™æ„å‘³ç€å¦‚æœæ‚¨å¯ä»¥è¯»å–å­˜å‚¨æ¡¶ï¼Œæ‚¨å°†èƒ½å¤Ÿä¸‹è½½é•œåƒå¹¶**æœç´¢æ³„æ¼å’Œ/æˆ–æºä»£ç **ã€‚

### `storage.objects.setIamPolicy`

æ‚¨å¯ä»¥æˆäºˆè‡ªå·±æƒé™**æ»¥ç”¨æœ¬èŠ‚ä¸­çš„ä»»ä½•å…ˆå‰æƒ…æ™¯**ã€‚

### **`storage.buckets.setIamPolicy`**

æœ‰å…³å¦‚ä½•ä½¿ç”¨æ­¤æƒé™ä¿®æ”¹æƒé™çš„ç¤ºä¾‹ï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢ï¼š

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storageçš„â€œäº’æ“ä½œæ€§â€åŠŸèƒ½æ—¨åœ¨**è¿›è¡Œè·¨äº‘äº¤äº’ï¼Œå¦‚ä¸AWS S3**ï¼Œæ¶‰åŠä¸ºæœåŠ¡å¸æˆ·å’Œç”¨æˆ·**åˆ›å»ºHMACå¯†é’¥**ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡**ä¸ºå…·æœ‰æå‡æƒé™çš„æœåŠ¡å¸æˆ·ç”ŸæˆHMACå¯†é’¥**æ¥åˆ©ç”¨æ­¤åŠŸèƒ½ï¼Œä»è€Œ**æå‡Cloud Storageå†…çš„æƒé™**ã€‚è™½ç„¶ä¸ç”¨æˆ·å…³è”çš„HMACå¯†é’¥ä»…å¯é€šè¿‡Webæ§åˆ¶å°æ£€ç´¢ï¼Œä½†è®¿é—®å¯†é’¥å’Œç§˜å¯†å¯†é’¥ä»ç„¶**æ°¸ä¹…å¯è®¿é—®**ï¼Œä»è€Œä¸ºæ½œåœ¨çš„å¤‡ä»½è®¿é—®å­˜å‚¨æä¾›å¯èƒ½ã€‚ç›¸åï¼Œä¸æœåŠ¡å¸æˆ·å…³è”çš„HMACå¯†é’¥å¯é€šè¿‡APIè®¿é—®ï¼Œä½†å…¶è®¿é—®å¯†é’¥å’Œç§˜å¯†å¯†é’¥åœ¨åˆ›å»ºåæ— æ³•æ£€ç´¢ï¼Œä¸ºæŒç»­è®¿é—®å¢åŠ äº†ä¸€å±‚å¤æ‚æ€§ã€‚
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
å¦ä¸€ä¸ªåˆ©ç”¨è„šæœ¬å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py)æ‰¾åˆ°ã€‚

## `storage.objects.create`ï¼Œ`storage.objects.delete` = å­˜å‚¨å†™å…¥æƒé™

ä¸ºäº†åœ¨å­˜å‚¨æ¡¶ä¸­**åˆ›å»ºæ–°å¯¹è±¡**ï¼Œæ‚¨éœ€è¦`storage.objects.create`ï¼Œæ ¹æ®[æ–‡æ¡£](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions)ï¼Œæ‚¨è¿˜éœ€è¦`storage.objects.delete`æ¥**ä¿®æ”¹**ç°æœ‰å¯¹è±¡ã€‚

åœ¨äº‘ä¸­**å†™å…¥**çš„å­˜å‚¨æ¡¶ä¸­ï¼Œä¸€ä¸ªéå¸¸**å¸¸è§çš„åˆ©ç”¨**æ˜¯ï¼Œå¦‚æœ**å­˜å‚¨æ¡¶ä¿å­˜ Web æœåŠ¡å™¨æ–‡ä»¶**ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿ**å­˜å‚¨æ–°ä»£ç **ï¼Œè¯¥ä»£ç å°†è¢« Web åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚

### Composer

**Composer**æ˜¯åœ¨GCPå†…éƒ¨ç®¡ç†çš„**Apache Airflow**ã€‚å®ƒå…·æœ‰å‡ ä¸ªæœ‰è¶£çš„ç‰¹æ€§ï¼š

* å®ƒåœ¨**GKE é›†ç¾¤å†…è¿è¡Œ**ï¼Œå› æ­¤**é›†ç¾¤ä½¿ç”¨çš„ SA å¯è¢« Composer å†…éƒ¨è¿è¡Œçš„ä»£ç è®¿é—®**
* å®ƒå°†ä»£ç å­˜å‚¨åœ¨ä¸€ä¸ªå­˜å‚¨æ¡¶ä¸­ï¼Œå› æ­¤ï¼Œ**ä»»ä½•å…·æœ‰å¯¹è¯¥å­˜å‚¨æ¡¶çš„å†™å…¥è®¿é—®æƒé™**çš„äººéƒ½å¯ä»¥æ›´æ”¹/æ·»åŠ  DGA ä»£ç ï¼ˆApache Airflow å°†æ‰§è¡Œçš„ä»£ç ï¼‰\
å› æ­¤ï¼Œå¦‚æœæ‚¨å¯¹ Composer ä½¿ç”¨çš„å­˜å‚¨ä»£ç çš„å­˜å‚¨æ¡¶å…·æœ‰**å†™å…¥è®¿é—®æƒé™**ï¼Œåˆ™å¯ä»¥**æå‡æƒé™åˆ°åœ¨ GKE é›†ç¾¤ä¸­è¿è¡Œçš„ SA**ã€‚

### Cloud Functions

* Cloud Functions ä»£ç å­˜å‚¨åœ¨å­˜å‚¨ä¸­ï¼Œå› æ­¤**è¦†ç›–å®ƒï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç **ã€‚

### App Engine

* App Engine æºä»£ç å­˜å‚¨åœ¨å­˜å‚¨æ¡¶ä¸­ï¼Œ**è¦†ç›–ä»£ç å¯èƒ½ä¼šæ‰§è¡Œä»»æ„ä»£ç ã€‚è¿™æ˜¯ä¸å¯èƒ½çš„**
* **çœ‹èµ·æ¥å®¹å™¨å±‚å­˜å‚¨åœ¨å­˜å‚¨æ¡¶ä¸­ï¼Œä¹Ÿè®¸æ”¹å˜é‚£äº›ï¼Ÿ**

### GCR

* **Google Container Registry** å°†é•œåƒå­˜å‚¨åœ¨å­˜å‚¨æ¡¶ä¸­ï¼Œå¦‚æœæ‚¨å¯ä»¥**å†™å…¥è¿™äº›å­˜å‚¨æ¡¶**ï¼Œåˆ™å¯èƒ½èƒ½å¤Ÿ**æ¨ªå‘ç§»åŠ¨åˆ°è¿è¡Œè¿™äº›å­˜å‚¨æ¡¶çš„ä½ç½®**ã€‚
* GCR ä½¿ç”¨çš„å­˜å‚¨æ¡¶çš„ URL ç±»ä¼¼äº `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com`ï¼ˆé¡¶çº§å­åŸŸåœ¨[è¿™é‡Œ](https://cloud.google.com/container-registry/docs/pushing-and-pulling)æŒ‡å®šï¼‰ã€‚

## **å‚è€ƒèµ„æ–™**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬**ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
