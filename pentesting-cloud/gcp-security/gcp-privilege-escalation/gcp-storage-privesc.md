# GCP - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage

Temel Bilgiler:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Bu izin, **Cloud Storage iÃ§inde saklanan dosyalarÄ± indirmenize** olanak tanÄ±r. Bu, bazÄ± durumlarda **hassas bilgilerin orada saklanmasÄ±** nedeniyle yetki yÃ¼kseltmenize olanak saÄŸlayabilir. AyrÄ±ca, bazÄ± GCP hizmetleri bilgilerini bucket'larda saklar:

* **GCP Composer**: Bir Composer OrtamÄ± oluÅŸturduÄŸunuzda, **tÃ¼m DAG'larÄ±n kodu** bir **bucket** iÃ§inde saklanacaktÄ±r. Bu gÃ¶revler, kodlarÄ±nÄ±n iÃ§inde ilginÃ§ bilgiler iÃ§erebilir.
* **GCR (Container Registry)**: Konteynerlerin **gÃ¶rÃ¼ntÃ¼leri** **bucket'larda** saklanÄ±r, bu da bucket'larÄ± okuyabiliyorsanÄ±z gÃ¶rÃ¼ntÃ¼leri indirebileceÄŸiniz ve **sÄ±zÄ±ntÄ±lar ve/veya kaynak kodu** arayabileceÄŸiniz anlamÄ±na gelir.

### `storage.objects.setIamPolicy`

Bu bÃ¶lÃ¼mdeki Ã¶nceki senaryolarÄ± **istismar etme** izni verebilirsiniz.

### **`storage.buckets.setIamPolicy`**

Bu izinle izinleri nasÄ±l deÄŸiÅŸtireceÄŸinize dair bir Ã¶rnek iÃ§in bu sayfayÄ± kontrol edin:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storage'Ä±n "iÅŸletilebilirlik" Ã¶zelliÄŸi, AWS S3 gibi **bulutlar arasÄ± etkileÅŸimler** iÃ§in **HMAC anahtarlarÄ±nÄ±n Hizmet HesaplarÄ± ve kullanÄ±cÄ±lar iÃ§in oluÅŸturulmasÄ±nÄ±** iÃ§erir. Bir saldÄ±rgan, **yÃ¼kseltilmiÅŸ yetkilere sahip bir Hizmet HesabÄ± iÃ§in HMAC anahtarÄ± oluÅŸturarak** bunu istismar edebilir ve bÃ¶ylece **Cloud Storage iÃ§inde yetki yÃ¼kseltebilir**. KullanÄ±cÄ±ya baÄŸlÄ± HMAC anahtarlarÄ± yalnÄ±zca web konsolu aracÄ±lÄ±ÄŸÄ±yla alÄ±nabilirken, hem eriÅŸim hem de gizli anahtarlar **sÃ¼rekli eriÅŸilebilir** kalÄ±r ve potansiyel yedek eriÅŸim depolamasÄ±na olanak tanÄ±r. Ã–te yandan, Hizmet HesabÄ± ile baÄŸlantÄ±lÄ± HMAC anahtarlarÄ± API eriÅŸimine aÃ§Ä±ktÄ±r, ancak eriÅŸim ve gizli anahtarlarÄ± oluÅŸturulduktan sonra alÄ±namaz, bu da sÃ¼rekli eriÅŸim iÃ§in bir katman karmaÅŸÄ±klÄ±ÄŸÄ± ekler.

{% code overflow="wrap" %}
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
{% endcode %}

Bu yÃ¶ntem iÃ§in baÅŸka bir istismar betiÄŸi [burada](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py) bulunabilir.

## `storage.objects.create`, `storage.objects.delete` = Depolama Yazma izinleri

Bir **nesne oluÅŸturmak** iÃ§in bir kovada `storage.objects.create` ve [belgelere](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions) gÃ¶re mevcut bir nesneyi **deÄŸiÅŸtirmek** iÃ§in `storage.objects.delete` iznine de ihtiyacÄ±nÄ±z var.

Bulut Ã¼zerinde yazma iznine sahip olduÄŸunuz kovalarÄ±n Ã§ok **yaygÄ±n bir istismar** durumu, eÄŸer **kova web sunucusu dosyalarÄ±nÄ± kaydediyorsa**, web uygulamasÄ± tarafÄ±ndan kullanÄ±lacak **yeni kodlar depolayabilmenizdir**.

### Composer

**Composer**, GCP iÃ§inde yÃ¶netilen **Apache Airflow**'dur. BirÃ§ok ilginÃ§ Ã¶zelliÄŸi vardÄ±r:

* **GKE kÃ¼mesi** iÃ§inde Ã§alÄ±ÅŸÄ±r, bu nedenle **kÃ¼menin kullandÄ±ÄŸÄ± SA, Composer iÃ§inde Ã§alÄ±ÅŸan kod tarafÄ±ndan eriÅŸilebilir**.
* Bir composer ortamÄ±nÄ±n tÃ¼m bileÅŸenleri (**DAG'larÄ±n kodu**, eklentiler ve veriler) bir GCP kovasÄ±nda depolanÄ±r. EÄŸer saldÄ±rganÄ±n buna okuma ve yazma izinleri varsa, kovayÄ± izleyebilir ve **herhangi bir DAG oluÅŸturulduÄŸunda veya gÃ¼ncellendiÄŸinde, arka kapÄ±lÄ± bir versiyon gÃ¶nderebilir**, bÃ¶ylece composer ortamÄ± depolamadan arka kapÄ±lÄ± versiyonu alÄ±r.

**Bu saldÄ±rÄ±nÄ±n bir PoC'sini repoda bulabilirsiniz:** [**https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs**](https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs)

### Cloud Functions

* Cloud Functions kodu Depolama'da saklanÄ±r ve yeni bir versiyon oluÅŸturulduÄŸunda kod kovaya yÃ¼klenir ve ardÄ±ndan bu koddan yeni bir konteyner oluÅŸturulur. Bu nedenle, **yeni versiyon oluÅŸturulmadan Ã¶nce kodu Ã¼zerine yazmak, bulut fonksiyonunun rastgele kod Ã§alÄ±ÅŸtÄ±rmasÄ±nÄ± saÄŸlamak iÃ§in mÃ¼mkÃ¼ndÃ¼r**.

**Bu saldÄ±rÄ±nÄ±n bir PoC'sini repoda bulabilirsiniz:** [**https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions**](https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions)

### App Engine

AppEngine versiyonlarÄ±, `staging.<project-id>.appspot.com` formatÄ±nda bir kovada bazÄ± veriler oluÅŸturur. Bu kovada, her AppEngine uygulama versiyonu iÃ§in bir klasÃ¶r iÃ§erecek `ae` adÄ±nda bir klasÃ¶r bulmak mÃ¼mkÃ¼ndÃ¼r ve bu klasÃ¶rlerin iÃ§inde `manifest.json` dosyasÄ±nÄ± bulmak mÃ¼mkÃ¼ndÃ¼r. Bu dosya, belirli bir versiyonu oluÅŸturmak iÃ§in kullanÄ±lacak tÃ¼m dosyalarÄ±n bulunduÄŸu bir json iÃ§erir. AyrÄ±ca, **dosyalarÄ±n gerÃ§ek adlarÄ±nÄ±, GCP kovasÄ±ndaki URL'lerini (kovadaki dosyalar adlarÄ±nÄ± sha1 hash'leri ile deÄŸiÅŸtirmiÅŸtir) ve her dosyanÄ±n sha1 hash'ini bulmak mÃ¼mkÃ¼ndÃ¼r.**

_Bu kovayÄ± Ã¶nceden ele geÃ§irmenin mÃ¼mkÃ¼n olmadÄ±ÄŸÄ±nÄ± unutmayÄ±n Ã§Ã¼nkÃ¼ GCP kullanÄ±cÄ±larÄ± appspot.com alan adÄ±nÄ± kullanarak kova oluÅŸturmak iÃ§in yetkilendirilmemiÅŸtir._

Ancak, bu kovada okuma ve yazma eriÅŸimi ile, kovanÄ±n izlenmesi ve herhangi bir deÄŸiÅŸiklik yapÄ±ldÄ±ÄŸÄ±nda (yeni versiyon), yeni versiyonu mÃ¼mkÃ¼n olan en hÄ±zlÄ± ÅŸekilde deÄŸiÅŸtirmek suretiyle App Engine versiyonuna baÄŸlÄ± SA'ya yetki yÃ¼kseltmek mÃ¼mkÃ¼ndÃ¼r. Bu ÅŸekilde, bu koddan oluÅŸturulan konteyner arka kapÄ±lÄ± kodu Ã§alÄ±ÅŸtÄ±racaktÄ±r.

Bahsedilen saldÄ±rÄ± birÃ§ok farklÄ± ÅŸekilde gerÃ§ekleÅŸtirilebilir, hepsi `staging.<project-id>.appspot.com` kovanÄ±zÄ± izlemeye baÅŸlar:

* AppEngine versiyonunun tamamÄ±nÄ± yeni bir kova yÃ¼kleyin ve **yeni kova adÄ± ve sha1 hash'leri ile bir `manifest.json` dosyasÄ± hazÄ±rlayÄ±n**. ArdÄ±ndan, kova iÃ§inde yeni bir versiyon oluÅŸturulduÄŸunda, sadece `manifest.json` dosyasÄ±nÄ± deÄŸiÅŸtirip kÃ¶tÃ¼ niyetli olanÄ± yÃ¼klemeniz yeterlidir.
* KÃ¶tÃ¼ niyetli baÄŸÄ±mlÄ±lÄ±k kodunu kullanacak ÅŸekilde deÄŸiÅŸtirilmiÅŸ bir `requirements.txt` versiyonu yÃ¼kleyin ve `manifest.json` dosyasÄ±nÄ± yeni dosya adÄ±, URL ve hash ile gÃ¼ncelleyin.
* KÃ¶tÃ¼ niyetli kodu Ã§alÄ±ÅŸtÄ±racak ÅŸekilde deÄŸiÅŸtirilmiÅŸ bir **`main.py` veya `app.yaml` dosyasÄ± yÃ¼kleyin** ve `manifest.json` dosyasÄ±nÄ± yeni dosya adÄ±, URL ve hash ile gÃ¼ncelleyin.

**Bu saldÄ±rÄ±nÄ±n bir PoC'sini repoda bulabilirsiniz:** [**https://github.com/carlospolop/Monitor-Backdoor-AppEngine**](https://github.com/carlospolop/Monitor-Backdoor-AppEngine)

### GCR

* **Google Container Registry**, gÃ¶rÃ¼ntÃ¼leri kovalar iÃ§inde saklar, eÄŸer **bu kovalara yazabiliyorsanÄ±z**, bu kovalarÄ±n Ã§alÄ±ÅŸtÄ±ÄŸÄ± yere **yanal hareket etme** imkanÄ±nÄ±z olabilir.
* GCR tarafÄ±ndan kullanÄ±lan kovanÄ±n URL'si `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` benzeri olacaktÄ±r (En Ã¼st dÃ¼zey alt alan adlarÄ± [burada](https://cloud.google.com/container-registry/docs/pushing-and-pulling) belirtilmiÅŸtir).

{% hint style="success" %}
Bu hizmet kullanÄ±mdan kaldÄ±rÄ±lmÄ±ÅŸtÄ±r, bu nedenle bu saldÄ±rÄ± artÄ±k faydalÄ± deÄŸildir. AyrÄ±ca, bu hizmetin yerini alan Artifactory, gÃ¶rÃ¼ntÃ¼leri kovalar iÃ§inde saklamaz.
{% endhint %}

## **Referanslar**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.

</details>
{% endhint %}
