# GCP - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage

ê¸°ë³¸ ì •ë³´:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

ì´ ê¶Œí•œì€ **Cloud Storageì— ì €ì¥ëœ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤**. ì´ëŠ” ê²½ìš°ì— ë”°ë¼ **ë¯¼ê°í•œ ì •ë³´ê°€ ì €ì¥ë˜ì–´ ìˆê¸° ë•Œë¬¸ì—** ê¶Œí•œ ìƒìŠ¹ì„ ê°€ëŠ¥í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê²Œë‹¤ê°€, ì¼ë¶€ GCP ì„œë¹„ìŠ¤ëŠ” ì •ë³´ë¥¼ ë²„í‚·ì— ì €ì¥í•©ë‹ˆë‹¤:

* **GCP Composer**: Composer í™˜ê²½ì„ ìƒì„±í•  ë•Œ **ëª¨ë“  DAGì˜ ì½”ë“œ**ê°€ **ë²„í‚·** ì•ˆì— ì €ì¥ë©ë‹ˆë‹¤. ì´ ì‘ì—…ë“¤ì€ ì½”ë“œ ì•ˆì— í¥ë¯¸ë¡œìš´ ì •ë³´ë¥¼ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **GCR (Container Registry)**: **ì»¨í…Œì´ë„ˆì˜ ì´ë¯¸ì§€**ëŠ” **ë²„í‚·** ì•ˆì— ì €ì¥ë˜ë©°, ì´ëŠ” ë²„í‚·ì„ ì½ì„ ìˆ˜ ìˆë‹¤ë©´ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  **ì •ë³´ ìœ ì¶œ ë°/ë˜ëŠ” ì†ŒìŠ¤ ì½”ë“œë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤**.

### `storage.objects.setIamPolicy`

ì´ ê¶Œí•œì„ í†µí•´ **ì´ ì„¹ì…˜ì˜ ì´ì „ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì•…ìš©í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

### **`storage.buckets.setIamPolicy`**

ì´ ê¶Œí•œìœ¼ë¡œ ê¶Œí•œì„ ìˆ˜ì •í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì˜ˆì‹œëŠ” ì´ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storageì˜ "ìƒí˜¸ ìš´ìš©ì„±" ê¸°ëŠ¥ì€ **AWS S3ì™€ ê°™ì€ í¬ë¡œìŠ¤ í´ë¼ìš°ë“œ ìƒí˜¸ ì‘ìš©**ì„ ìœ„í•´ ì„¤ê³„ë˜ì—ˆìœ¼ë©°, **ì„œë¹„ìŠ¤ ê³„ì • ë° ì‚¬ìš©ìì— ëŒ€í•œ HMAC í‚¤ ìƒì„±**ì„ í¬í•¨í•©ë‹ˆë‹¤. ê³µê²©ìëŠ” **ìƒìŠ¹ëœ ê¶Œí•œì„ ê°€ì§„ ì„œë¹„ìŠ¤ ê³„ì •ì— ëŒ€í•œ HMAC í‚¤ë¥¼ ìƒì„±í•˜ì—¬ Cloud Storage ë‚´ì—ì„œ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ì‚¬ìš©ìì™€ ì—°ê²°ëœ HMAC í‚¤ëŠ” ì›¹ ì½˜ì†”ì„ í†µí•´ì„œë§Œ ê²€ìƒ‰í•  ìˆ˜ ìˆì§€ë§Œ, ì ‘ê·¼ ë° ë¹„ë°€ í‚¤ëŠ” **ì˜êµ¬ì ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥**í•˜ì—¬ ì ì¬ì ì¸ ë°±ì—… ì ‘ê·¼ ì €ì¥ì†Œë¥¼ í—ˆìš©í•©ë‹ˆë‹¤. ë°˜ë©´, ì„œë¹„ìŠ¤ ê³„ì •ì— ì—°ê²°ëœ HMAC í‚¤ëŠ” APIë¥¼ í†µí•´ ì ‘ê·¼í•  ìˆ˜ ìˆì§€ë§Œ, ìƒì„± í›„ì—ëŠ” ì ‘ê·¼ ë° ë¹„ë°€ í‚¤ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ì—†ì–´ ì§€ì†ì ì¸ ì ‘ê·¼ì— ëŒ€í•œ ë³µì¡ì„±ì„ ë”í•©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
{% endcode %}

ì´ ë°©ë²•ì— ëŒ€í•œ ë˜ ë‹¤ë¥¸ ìµìŠ¤í”Œë¡œì‡ ìŠ¤í¬ë¦½íŠ¸ëŠ” [ì—¬ê¸°](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## `storage.objects.create`, `storage.objects.delete` = ìŠ¤í† ë¦¬ì§€ ì“°ê¸° ê¶Œí•œ

ë²„í‚· ë‚´ì— **ìƒˆ ê°ì²´ë¥¼ ìƒì„±**í•˜ë ¤ë©´ `storage.objects.create`ê°€ í•„ìš”í•˜ë©°, [ë¬¸ì„œ](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions)ì— ë”°ë¥´ë©´ **ì¡´ì¬í•˜ëŠ” ê°ì²´ë¥¼ ìˆ˜ì •**í•˜ë ¤ë©´ `storage.objects.delete`ë„ í•„ìš”í•©ë‹ˆë‹¤.

í´ë¼ìš°ë“œì—ì„œ ì“¸ ìˆ˜ ìˆëŠ” ë²„í‚·ì˜ **ì¼ë°˜ì ì¸ ìµìŠ¤í”Œë¡œì‡**ì€ **ë²„í‚·ì´ ì›¹ ì„œë²„ íŒŒì¼ì„ ì €ì¥**í•˜ëŠ” ê²½ìš°ë¡œ, ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©ë  **ìƒˆ ì½”ë“œë¥¼ ì €ì¥**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Composer

**Composer**ëŠ” GCP ë‚´ì—ì„œ ê´€ë¦¬ë˜ëŠ” **Apache Airflow**ì…ë‹ˆë‹¤. ì—¬ëŸ¬ í¥ë¯¸ë¡œìš´ ê¸°ëŠ¥ì´ ìˆìŠµë‹ˆë‹¤:

* **GKE í´ëŸ¬ìŠ¤í„°** ë‚´ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ, **í´ëŸ¬ìŠ¤í„°ê°€ ì‚¬ìš©í•˜ëŠ” SAëŠ” Composer ë‚´ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œì— ì˜í•´ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.**
* **ì½”ë“œë¥¼ ë²„í‚·ì— ì €ì¥**í•˜ë¯€ë¡œ, **í•´ë‹¹ ë²„í‚·ì— ì“°ê¸° ê¶Œí•œì´ ìˆëŠ” ì‚¬ëŒì€ DGA ì½”ë“œë¥¼ ë³€ê²½/ì¶”ê°€**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (Apache Airflowê°€ ì‹¤í–‰í•  ì½”ë“œ)\
ê·¸ëŸ° ë‹¤ìŒ, **ì½”ë“œ ì €ì¥ì„ ìœ„í•´ Composerê°€ ì‚¬ìš©í•˜ëŠ” ë²„í‚·ì— ì“°ê¸° ê¶Œí•œì´ ìˆë‹¤ë©´**, **GKE í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ SAë¡œ ê¶Œí•œ ìƒìŠ¹**ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Cloud Functions

* Cloud Functions ì½”ë“œëŠ” ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ë˜ë¯€ë¡œ, **ì´ë¥¼ ë®ì–´ì“°ë©´ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

### App Engine

* App Engine ì†ŒìŠ¤ ì½”ë“œëŠ” ë²„í‚·ì— ì €ì¥ë˜ë©°, **ì½”ë“œë¥¼ ë®ì–´ì“°ë©´ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.**
* **ì»¨í…Œì´ë„ˆ ë ˆì´ì–´ê°€ ë²„í‚·ì— ì €ì¥ë˜ëŠ” ê²ƒ ê°™ìœ¼ë©°, ì´ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆì„ê¹Œìš”?**

### GCR

* **Google Container Registry**ëŠ” ì´ë¯¸ì§€ë¥¼ ë²„í‚·ì— ì €ì¥í•˜ë©°, **ì´ ë²„í‚·ì— ì“¸ ìˆ˜ ìˆë‹¤ë©´** **ì´ ë²„í‚·ì´ ì‹¤í–‰ë˜ëŠ” ê³³ìœ¼ë¡œ ìˆ˜í‰ ì´ë™**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* GCRì—ì„œ ì‚¬ìš©í•˜ëŠ” ë²„í‚·ì˜ URLì€ `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com`ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤ (ìµœìƒìœ„ í•˜ìœ„ ë„ë©”ì¸ì€ [ì—¬ê¸°](https://cloud.google.com/container-registry/docs/pushing-and-pulling)ì—ì„œ ì§€ì •ë©ë‹ˆë‹¤).

## **ì°¸ê³ ë¬¸í—Œ**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜, **Twitter**ì—ì„œ **íŒ”ë¡œìš°**í•˜ì„¸ìš” ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
