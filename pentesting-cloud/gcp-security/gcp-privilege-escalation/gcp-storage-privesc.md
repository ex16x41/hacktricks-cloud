# GCP - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage

Podstawowe informacje:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

To uprawnienie pozwala na **pobieranie plik贸w przechowywanych w Cloud Storage**. Mo偶e to potencjalnie umo偶liwi eskalacj uprawnie, poniewa偶 w niekt贸rych przypadkach **wra偶liwe informacje s tam przechowywane**. Ponadto, niekt贸re usugi GCP przechowuj swoje informacje w bucketach:

* **GCP Composer**: Kiedy tworzysz rodowisko Composer, **kod wszystkich DAG-贸w** bdzie zapisany w **buckecie**. Te zadania mog zawiera interesujce informacje w swoim kodzie.
* **GCR (Container Registry)**: **Obraz** kontener贸w jest przechowywany w **bucketach**, co oznacza, 偶e jeli mo偶esz czyta buckety, bdziesz m贸g pobra obrazy i **szuka wyciek贸w i/lub kodu 藕r贸dowego**.

### `storage.objects.setIamPolicy`

Mo偶esz da sobie uprawnienia do **wykorzystania dowolnego z wczeniejszych scenariuszy tej sekcji**.

### **`storage.buckets.setIamPolicy`**

Aby zobaczy przykad, jak zmodyfikowa uprawnienia za pomoc tego uprawnienia, sprawd藕 t stron:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Funkcja "interoperacyjnoci" Cloud Storage, zaprojektowana do **interakcji midzy chmurami** jak z AWS S3, obejmuje **tworzenie kluczy HMAC dla kont serwisowych i u偶ytkownik贸w**. Atakujcy mo偶e to wykorzysta, **generujc klucz HMAC dla konta serwisowego z podwy偶szonymi uprawnieniami**, co pozwala na **eskalacj uprawnie w Cloud Storage**. Chocia偶 klucze HMAC powizane z u偶ytkownikami s dostpne tylko za porednictwem konsoli internetowej, zar贸wno klucze dostpu, jak i tajne pozostaj **wiecznie dostpne**, co umo偶liwia potencjalny dostp do przechowywania kopii zapasowych. Z drugiej strony, klucze HMAC powizane z kontem serwisowym s dostpne przez API, ale ich klucze dostpu i tajne nie s dostpne po utworzeniu, co dodaje warstw zo偶onoci dla cigego dostpu.

{% code overflow="wrap" %}
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
{% endcode %}

Inny skrypt exploitacyjny dla tej metody mo偶na znale藕 [tutaj](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Uprawnienia do zapisu w Storage

Aby **utworzy nowy obiekt** w obrbie bucketu, potrzebujesz `storage.objects.create`, a zgodnie z [dokumentacj](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), potrzebujesz r贸wnie偶 `storage.objects.delete`, aby **zmodyfikowa** istniejcy obiekt.

Bardzo **czstym wykorzystaniem** bucket贸w, w kt贸rych mo偶na pisa w chmurze, jest sytuacja, gdy **bucket przechowuje pliki serwera WWW**, mo偶esz by w stanie **przechowa nowy kod**, kt贸ry bdzie u偶ywany przez aplikacj internetow.

### Composer

**Composer** to **Apache Airflow** zarzdzany w GCP. Ma kilka interesujcych funkcji:

* Dziaa w obrbie **klastra GKE**, wic **SA, kt贸rego u偶ywa klaster, jest dostpny** przez kod dziaajcy w Composer
* Wszystkie komponenty rodowisk composera (**kod DAG贸w**, wtyczki i dane) s przechowywane w bucketcie GCP. Jeli atakujcy ma uprawnienia do odczytu i zapisu, mo偶e monitorowa bucket i **za ka偶dym razem, gdy DAG jest tworzony lub aktualizowany, przesa wersj z backdoorem**, aby rodowisko composera pobrao z storage wersj z backdoorem.

**Mo偶esz znale藕 PoC tego ataku w repozytorium:** [**https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs**](https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs)

### Cloud Functions

* Kod Cloud Functions jest przechowywany w Storage, a za ka偶dym razem, gdy tworzona jest nowa wersja, kod jest przesyany do bucketu, a nastpnie nowy kontener jest budowany z tego kodu. Dlatego **nadpisanie kodu przed zbudowaniem nowej wersji umo偶liwia wykonanie dowolnego kodu przez funkcj chmurow**.

**Mo偶esz znale藕 PoC tego ataku w repozytorium:** [**https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions**](https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions)

### App Engine

Wersje AppEngine generuj pewne dane w obrbie bucketu w formacie nazwy: `staging.<project-id>.appspot.com`. W tym bucketcie mo偶na znale藕 folder o nazwie `ae`, kt贸ry bdzie zawiera folder dla ka偶dej wersji aplikacji AppEngine, a w tych folderach bdzie mo偶na znale藕 plik `manifest.json`. Plik ten zawiera json z wszystkimi plikami, kt贸re musz by u偶yte do stworzenia konkretnej wersji. Co wicej, mo偶na znale藕 **prawdziwe nazwy plik贸w, URL do nich w obrbie bucketu GCP (pliki w bucketcie zmieniy swoj nazw na ich sha1 hash) oraz sha1 hash ka偶dego pliku.**

_Nale偶y zauwa偶y, 偶e nie jest mo偶liwe wczeniejsze przejcie tego bucketu, poniewa偶 u偶ytkownicy GCP nie s uprawnieni do generowania bucket贸w przy u偶yciu nazwy domeny appspot.com._

Jednak偶e, majc dostp do odczytu i zapisu w tym bucketcie, mo偶na eskalowa uprawnienia do SA przypisanego do wersji App Engine, monitorujc bucket i za ka偶dym razem, gdy dokonana zostanie zmiana (nowa wersja), modyfikujc now wersj tak szybko, jak to mo偶liwe. W ten spos贸b kontener, kt贸ry zostanie stworzony z tego kodu, wykona kod z backdoorem.

Wspomniany atak mo偶na przeprowadzi na wiele r贸偶nych sposob贸w, wszystkie zaczynaj si od monitorowania bucketu `staging.<project-id>.appspot.com`:

* Przelij kompletny nowy kod wersji AppEngine do innego dostpnego bucketu i przygotuj **plik `manifest.json` z now nazw bucketu i sha1 hashami**. Nastpnie, gdy nowa wersja zostanie utworzona w obrbie bucketu, wystarczy zmodyfikowa plik `manifest.json` i przesa zoliwy.
* Przelij zmodyfikowan wersj `requirements.txt`, kt贸ra bdzie u偶ywa **zoliwego kodu zale偶noci i zaktualizuj plik `manifest.json`** z now nazw pliku, URL i jego hashem.
* Przelij **zmodyfikowany plik `main.py` lub `app.yaml`, kt贸ry wykona zoliwy kod** i zaktualizuj plik `manifest.json` z now nazw pliku, URL i jego hashem.

**Mo偶esz znale藕 PoC tego ataku w repozytorium:** [**https://github.com/carlospolop/Monitor-Backdoor-AppEngine**](https://github.com/carlospolop/Monitor-Backdoor-AppEngine)

### GCR

* **Google Container Registry** przechowuje obrazy w bucketach, jeli mo偶esz **zapisywa w tych bucketach**, mo偶esz by w stanie **przesun si lateralnie do miejsca, w kt贸rym te buckety s uruchamiane.**
* Bucket u偶ywany przez GCR bdzie mia URL podobny do `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Najwy偶sze subdomeny s okrelone [tutaj](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

{% hint style="success" %}
Usuga ta jest przestarzaa, wic ten atak nie jest ju偶 u偶yteczny. Co wicej, Artifact Registry, usuga, kt贸ra j zastpuje, nie przechowuje obraz贸w w bucketach.
{% endhint %}

## **Referencje**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}
