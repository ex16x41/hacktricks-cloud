# GCP - Depolama Privilege Escalation

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

## Depolama

Temel Bilgiler:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Bu izin size **Cloud Storage iÃ§inde depolanan dosyalarÄ± indirme** olanaÄŸÄ± saÄŸlar. Bu potansiyel olarak **yetkilerinizi yÃ¼kseltmenize izin verebilir** Ã§Ã¼nkÃ¼ bazÄ± durumlarda **duyarlÄ± bilgiler orada saklanÄ±r**. AyrÄ±ca, bazÄ± GCP hizmetleri bilgilerini kovalara kaydeder:

* **GCP Composer**: Bir Composer OrtamÄ± oluÅŸturduÄŸunuzda, **tÃ¼m DAG'larÄ±n kodu** bir **kova** iÃ§inde saklanÄ±r. Bu gÃ¶revler, kodlarÄ±nÄ±n iÃ§inde ilginÃ§ bilgiler iÃ§erebilir.
* **GCR (Container Registry)**: **Konteynerlerin gÃ¶rÃ¼ntÃ¼leri** kovalarda saklanÄ±r, bu da kovalarÄ± okuyabiliyorsanÄ±z gÃ¶rÃ¼ntÃ¼leri indirebileceÄŸiniz ve **sÄ±zÄ±ntÄ±larÄ± ve/veya kaynak kodunu arayabileceÄŸiniz** anlamÄ±na gelir.

### `storage.objects.setIamPolicy`

Bu izin size bu bÃ¶lÃ¼mÃ¼n Ã¶nceki senaryolarÄ±ndan herhangi birini **kÃ¶tÃ¼ye kullanma izni** verebilir.

### **`storage.buckets.setIamPolicy`**

Bu izinle izinleri nasÄ±l deÄŸiÅŸtireceÄŸinize dair bir Ã¶rnek iÃ§in bu sayfayÄ± kontrol edin:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storage'Ä±n "uyumluluk" Ã¶zelliÄŸi, AWS S3 gibi **Ã§apraz bulut etkileÅŸimleri** iÃ§in tasarlanmÄ±ÅŸ olup, **Hizmet HesaplarÄ± ve kullanÄ±cÄ±lar iÃ§in HMAC anahtarlarÄ±nÄ±n oluÅŸturulmasÄ±nÄ±** iÃ§erir. Bir saldÄ±rgan, bu Ã¶zelliÄŸi **kÃ¶tÃ¼ye kullanarak yÃ¼kseltilmiÅŸ ayrÄ±calÄ±klara sahip bir Hizmet HesabÄ± iÃ§in bir HMAC anahtarÄ± oluÅŸturabilir** ve bÃ¶ylece **Cloud Storage iÃ§inde ayrÄ±calÄ±klarÄ± yÃ¼kseltebilir**. KullanÄ±cÄ±ya baÄŸlÄ± HMAC anahtarlarÄ± yalnÄ±zca web konsolu aracÄ±lÄ±ÄŸÄ±yla alÄ±nabilirken, eriÅŸim ve gizli anahtarlar **sÃ¼rekli eriÅŸilebilir** kalÄ±r, potansiyel yedek eriÅŸim depolama olanaÄŸÄ± saÄŸlar. Bununla birlikte, Hizmet HesabÄ±yla iliÅŸkilendirilmiÅŸ HMAC anahtarlarÄ± API eriÅŸimine aÃ§Ä±ktÄ±r, ancak eriÅŸim ve gizli anahtarlar oluÅŸturulduktan sonra alÄ±namaz, sÃ¼rekli eriÅŸim iÃ§in karmaÅŸÄ±k bir katman ekler.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
BaÅŸka bir exploit betiÄŸi bu yÃ¶ntem iÃ§in [burada](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py) bulunabilir.

## `storage.objects.create`, `storage.objects.delete` = Depolama Yazma izinleri

Bir kova iÃ§ine **yeni bir nesne oluÅŸturmak** iÃ§in `storage.objects.create`'a ihtiyacÄ±nÄ±z var ve [belgelere](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions) gÃ¶re, mevcut bir nesneyi **deÄŸiÅŸtirmek** iÃ§in ayrÄ±ca `storage.objects.delete`'a ihtiyacÄ±nÄ±z var.

Bulutta yazma iznine sahip olduÄŸunuz kovalarÄ±n Ã§ok **sÄ±k istismarÄ±**, kovanÄ±n **web sunucusu dosyalarÄ±nÄ± kaydettiÄŸi** durumlarda olabilir, bu durumda **web uygulamasÄ± tarafÄ±ndan kullanÄ±lacak yeni kodlarÄ±** saklayabilirsiniz.

### Composer

**Composer**, GCP iÃ§inde yÃ¶netilen **Apache Airflow**'dur. BirkaÃ§ ilginÃ§ Ã¶zelliÄŸi vardÄ±r:

* **GKE kÃ¼mesi iÃ§inde Ã§alÄ±ÅŸÄ±r**, bu nedenle Composer iÃ§inde Ã§alÄ±ÅŸan kod tarafÄ±ndan eriÅŸilebilen **SA kÃ¼mesi kullanÄ±lÄ±r**
* Kodu bir kovada saklar, bu nedenle, o kovaya **yazma eriÅŸimi olan herkes**, bir DGA kodu ekleyebilir/deÄŸiÅŸtirebilir (Apache Airflow'un yÃ¼rÃ¼teceÄŸi kod)\
DolayÄ±sÄ±yla, Composer'Ä±n kodu saklamak iÃ§in kullandÄ±ÄŸÄ± kovaya **yazma eriÅŸiminiz varsa**, GKE kÃ¼mesinde Ã§alÄ±ÅŸan SA'ya **yÃ¼kselme yapabilirsiniz**.

### Cloud Functions

* Cloud Functions kodu Depolama'da saklanÄ±r, bu nedenle **Ã¼zerine yazarak keyfi kodu yÃ¼rÃ¼tmek mÃ¼mkÃ¼ndÃ¼r**.

### App Engine

* App Engine kaynak kodu kovalarda saklanÄ±r, **kodu Ã¼zerine yazarak keyfi kodu yÃ¼rÃ¼tmek mÃ¼mkÃ¼n olabilir. BU MÃœMKÃœN DEÄÄ°LDÄ°R**
* **Muhtemelen konteyner katmanlarÄ± kovada saklanÄ±r, belki onlarÄ± deÄŸiÅŸtirerek?**

### GCR

* **Google Container Registry**, gÃ¶rÃ¼ntÃ¼leri kovalarda saklar, eÄŸer **bu kovalara yazabilirseniz**, bu kovalarÄ±n Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ± yere **yan yana geÃ§iÅŸ yapabilirsiniz**.
* GCR tarafÄ±ndan kullanÄ±lan kova, `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` benzeri bir URL'ye sahip olacaktÄ±r (Ãœst dÃ¼zey alt alanlar [burada](https://cloud.google.com/container-registry/docs/pushing-and-pulling) belirtilmiÅŸtir).

## **Referanslar**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak HackTricks ve HackTricks Cloud github depolarÄ±na PR gÃ¶ndererek katkÄ±da bulunun.**

</details>
{% endhint %}
