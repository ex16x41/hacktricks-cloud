# GCP - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage

Informa√ß√µes B√°sicas:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Esta permiss√£o permite que voc√™ **baixe arquivos armazenados no Cloud Storage**. Isso pode potencialmente permitir que voc√™ escale privil√©gios porque em algumas ocasi√µes **informa√ß√µes sens√≠veis s√£o salvas l√°**. Al√©m disso, alguns servi√ßos do GCP armazenam suas informa√ß√µes em buckets:

* **GCP Composer**: Quando voc√™ cria um Ambiente Composer, o **c√≥digo de todos os DAGs** ser√° salvo dentro de um **bucket**. Essas tarefas podem conter informa√ß√µes interessantes dentro de seu c√≥digo.
* **GCR (Container Registry)**: A **imagem** dos cont√™ineres √© armazenada dentro de **buckets**, o que significa que se voc√™ puder ler os buckets, poder√° baixar as imagens e **procurar por leaks e/ou c√≥digo fonte**.

### `storage.objects.setIamPolicy`

Voc√™ pode se dar permiss√£o para **abusar de qualquer um dos cen√°rios anteriores desta se√ß√£o**.

### **`storage.buckets.setIamPolicy`**

Para um exemplo de como modificar permiss√µes com esta permiss√£o, consulte esta p√°gina:

{% content-ref url="../gcp-unauthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unauthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

O recurso de "interoperabilidade" do Cloud Storage, projetado para **intera√ß√µes entre nuvens** como com o AWS S3, envolve a **cria√ß√£o de chaves HMAC para Contas de Servi√ßo e usu√°rios**. Um atacante pode explorar isso **gerando uma chave HMAC para uma Conta de Servi√ßo com privil√©gios elevados**, assim **escalando privil√©gios dentro do Cloud Storage**. Enquanto as chaves HMAC associadas a usu√°rios s√≥ podem ser recuperadas via console da web, tanto as chaves de acesso quanto as secretas permanecem **perpetuamente acess√≠veis**, permitindo um potencial acesso de backup ao armazenamento. Por outro lado, as chaves HMAC vinculadas a Contas de Servi√ßo s√£o acess√≠veis via API, mas suas chaves de acesso e secretas n√£o podem ser recuperadas ap√≥s a cria√ß√£o, adicionando uma camada de complexidade para acesso cont√≠nuo.

{% code overflow="wrap" %}
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
{% endcode %}

Outro script de explora√ß√£o para este m√©todo pode ser encontrado [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Permiss√µes de grava√ß√£o no Storage

Para **criar um novo objeto** dentro de um bucket, voc√™ precisa de `storage.objects.create` e, de acordo com [a documenta√ß√£o](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), voc√™ tamb√©m precisa de `storage.objects.delete` para **modificar** um objeto existente.

Uma **explora√ß√£o muito comum** de buckets onde voc√™ pode escrever na nuvem √© no caso de o **bucket estar salvando arquivos de servidor web**, voc√™ pode ser capaz de **armazenar novo c√≥digo** que ser√° usado pela aplica√ß√£o web.

### Composer

**Composer** √© **Apache Airflow** gerenciado dentro do GCP. Ele possui v√°rias caracter√≠sticas interessantes:

* Ele roda dentro de um **cluster GKE**, ent√£o o **SA que o cluster usa √© acess√≠vel** pelo c√≥digo que est√° rodando dentro do Composer
* Todos os componentes de um ambiente de composer (**c√≥digo dos DAGs**, plugins e dados) s√£o armazenados dentro de um bucket GCP. Se o atacante tiver permiss√µes de leitura e grava√ß√£o sobre ele, ele poderia monitorar o bucket e **sempre que um DAG for criado ou atualizado, enviar uma vers√£o com backdoor** para que o ambiente do composer obtenha a vers√£o com backdoor do armazenamento.

**Voc√™ pode encontrar uma PoC deste ataque no reposit√≥rio:** [**https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs**](https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs)

### Cloud Functions

* O c√≥digo das Cloud Functions √© armazenado no Storage e sempre que uma nova vers√£o √© criada, o c√≥digo √© enviado para o bucket e ent√£o o novo cont√™iner √© constru√≠do a partir desse c√≥digo. Portanto, **sobrescrever o c√≥digo antes que a nova vers√£o seja constru√≠da torna poss√≠vel fazer a fun√ß√£o da nuvem executar c√≥digo arbitr√°rio**.

**Voc√™ pode encontrar uma PoC deste ataque no reposit√≥rio:** [**https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions**](https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions)

### App Engine

As vers√µes do AppEngine geram alguns dados dentro de um bucket com o formato nome: `staging.<project-id>.appspot.com`. Dentro deste bucket, √© poss√≠vel encontrar uma pasta chamada `ae` que conter√° uma pasta por vers√£o do aplicativo AppEngine e dentro dessas pastas ser√° poss√≠vel encontrar o arquivo `manifest.json`. Este arquivo cont√©m um json com todos os arquivos que devem ser usados para criar a vers√£o espec√≠fica. Al√©m disso, √© poss√≠vel encontrar os **nomes reais dos arquivos, a URL para eles dentro do bucket GCP (os arquivos dentro do bucket mudaram seus nomes para seu hash sha1) e o hash sha1 de cada arquivo.**

_Observe que n√£o √© poss√≠vel realizar uma pr√©-takeover deste bucket porque os usu√°rios do GCP n√£o est√£o autorizados a gerar buckets usando o nome de dom√≠nio appspot.com._

No entanto, com acesso de leitura e grava√ß√£o sobre este bucket, √© poss√≠vel escalar privil√©gios para o SA anexado √† vers√£o do App Engine monitorando o bucket e, sempre que uma altera√ß√£o for realizada (nova vers√£o), modificar a nova vers√£o o mais r√°pido poss√≠vel. Dessa forma, o cont√™iner que √© criado a partir desse c√≥digo executar√° o c√≥digo com backdoor.

O ataque mencionado pode ser realizado de v√°rias maneiras diferentes, todas come√ßam monitorando o bucket `staging.<project-id>.appspot.com`:

* Carregar o novo c√≥digo completo da vers√£o do AppEngine para um bucket diferente e dispon√≠vel e preparar um **arquivo `manifest.json` com o novo nome do bucket e os hashes sha1 deles**. Ent√£o, quando uma nova vers√£o for criada dentro do bucket, voc√™ s√≥ precisa modificar o arquivo `manifest.json` e enviar o malicioso.
* Carregar uma vers√£o modificada do `requirements.txt` que usar√° o **c√≥digo de depend√™ncias maliciosas e atualizar o arquivo `manifest.json`** com o novo nome do arquivo, URL e o hash dele.
* Carregar um **arquivo `main.py` ou `app.yaml` modificado que executar√° o c√≥digo malicioso** e atualizar o arquivo `manifest.json` com o novo nome do arquivo, URL e o hash dele.

**Voc√™ pode encontrar uma PoC deste ataque no reposit√≥rio:** [**https://github.com/carlospolop/Monitor-Backdoor-AppEngine**](https://github.com/carlospolop/Monitor-Backdoor-AppEngine)

### GCR

* **Google Container Registry** armazena as imagens dentro de buckets, se voc√™ puder **escrever nesses buckets**, pode ser capaz de **mover lateralmente para onde esses buckets est√£o sendo executados.**
* O bucket usado pelo GCR ter√° uma URL semelhante a `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Os subdom√≠nios de n√≠vel superior s√£o especificados [aqui](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

{% hint style="success" %}
Este servi√ßo est√° obsoleto, ent√£o este ataque n√£o √© mais √∫til. Al√©m disso, o Artifact Registry, o servi√ßo que substitui este, n√£o armazena as imagens em buckets.
{% endhint %}

## **Refer√™ncias**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos no** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
