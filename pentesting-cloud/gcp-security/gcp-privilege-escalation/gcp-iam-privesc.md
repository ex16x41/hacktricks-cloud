# GCP - IAM Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## IAM

Prona캠ite vi코e informacija o IAM-u u:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### `iam.roles.update` (`iam.roles.get`)

Napada캜 sa pomenutim dozvolama 캖e mo캖i da a쬿rira ulogu dodeljenu vama i da vam dodeli dodatne dozvole za druge resurse kao 코to su:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
Mo쬰te prona캖i skriptu za automatizaciju **kreiranja, eksploatacije i 캜i코캖enja ranjivog okru쬰nja ovde** i python skriptu za zloupotrebu ovog privilegija [**ovde**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py). Za vi코e informacija pogledajte [**originalno istra쬴vanje**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

Napada캜 sa pomenutim dozvolama 캖e mo캖i da **zatra쬴 pristupni token koji pripada Servisnom Nalog**, tako da je mogu캖e zatra쬴ti pristupni token Servisnog Naloga sa vi코e privilegija nego 코to su na코e.
```bash
gcloud --impersonate-service-account="${victim}@${PROJECT_ID}.iam.gserviceaccount.com" \
auth print-access-token
```
Mo쬰te prona캖i skriptu za automatizaciju [**kreiranja, eksploatacije i 캜i코캖enja ranjivog okru쬰nja ovde**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) i python skriptu za zloupotrebu ove privilegije [**ovde**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py). Za vi코e informacija proverite [**originalno istra쬴vanje**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccountKeys.create`

Napada캜 sa pomenutim dozvolama 캖e mo캖i da **kreira klju캜 koji upravlja korisnikom za Service Account**, 코to 캖e nam omogu캖iti pristup GCP kao taj Service Account.
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
Mo쬰te prona캖i skriptu za automatizaciju [**kreiranja, eksploatacije i 캜i코캖enja ranjivog okru쬰nja ovde**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) i python skriptu za zloupotrebu ove privilegije [**ovde**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py). Za vi코e informacija pogledajte [**originalno istra쬴vanje**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Napomena: **`iam.serviceAccountKeys.update` ne캖e raditi za modifikaciju klju캜a** SA jer su za to potrebne i dozvole `iam.serviceAccountKeys.create`.

### `iam.serviceAccounts.implicitDelegation`

Ako imate **`iam.serviceAccounts.implicitDelegation`** dozvolu na Servisnom Ra캜unu koji ima **`iam.serviceAccounts.getAccessToken`** dozvolu na tre캖em Servisnom Ra캜unu, tada mo쬰te koristiti implicitDelegation da **kreirate token za taj tre캖i Servisni Ra캜un**. Evo dijagrama koji poma쬰 u obja코njenju.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

Napomena: prema [**dokumentaciji**](https://cloud.google.com/iam/docs/understanding-service-accounts), delegacija `gcloud` funkcioni코e samo za generisanje tokena koriste캖i [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken) metodu. Tako da ovde imate kako da dobijete token koriste캖i API direktno:
```bash
curl -X POST \
'https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/'"${TARGET_SERVICE_ACCOUNT}"':generateAccessToken' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer '"$(gcloud auth print-access-token)" \
-d '{
"delegates": ["projects/-/serviceAccounts/'"${DELEGATED_SERVICE_ACCOUNT}"'"],
"scope": ["https://www.googleapis.com/auth/cloud-platform"]
}'
```
Mo쬰te prona캖i skriptu za automatizaciju [**kreiranja, eksploatacije i 캜i코캖enja ranjivog okru쬰nja ovde**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) i python skriptu za zloupotrebu ovog privilegija [**ovde**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py). Za vi코e informacija pogledajte [**originalno istra쬴vanje**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signBlob`

Napada캜 sa pomenutim dozvolama 캖e mo캖i da **potpi코e proizvoljne payload-ove u GCP**. Tako 캖e biti mogu캖e **napraviti nepotpisani JWT SA i zatim ga poslati kao blob da bi dobili JWT potpisan** od SA koji ciljate. Za vi코e informacija [**pro캜itajte ovo**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed).

Mo쬰te prona캖i skriptu za automatizaciju [**kreiranja, eksploatacije i 캜i코캖enja ranjivog okru쬰nja ovde**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) i python skriptu za zloupotrebu ovog privilegija [**ovde**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) i [**ovde**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py). Za vi코e informacija pogledajte [**originalno istra쬴vanje**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signJwt`

Napada캜 sa pomenutim dozvolama 캖e mo캖i da **potpi코e dobro oblikovane JSON web tokene (JWT-ove)**. Razlika u odnosu na prethodnu metodu je u tome 코to **umesto da nateramo google da potpi코e blob koji sadr쬴 JWT, koristimo metodu signJWT koja ve캖 o캜ekuje JWT**. Ovo olak코ava kori코캖enje, ali mo쬰te potpisivati samo JWT umesto bilo kojih bajtova.

Mo쬰te prona캖i skriptu za automatizaciju [**kreiranja, eksploatacije i 캜i코캖enja ranjivog okru쬰nja ovde**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) i python skriptu za zloupotrebu ovog privilegija [**ovde**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py). Za vi코e informacija pogledajte [**originalno istra쬴vanje**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

Napada캜 sa pomenutim dozvolama 캖e mo캖i da **doda IAM politike servisnim nalozima**. Mo쬰te to zloupotrebiti da **dodelite sebi** dozvole koje su vam potrebne da biste se pretvarali da ste servisni nalog. U slede캖em primeru dodeljujemo sebi ulogu `roles/iam.serviceAccountTokenCreator` nad interesantnim SA:
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"

# If you still have prblem grant yourself also this permission
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \ \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountUser"
```
Mo쬰te prona캖i skriptu za automatizaciju [**kreiranja, eksploatacije i 캜i코캖enja ranjivog okru쬰nja ovde**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**.**

### `iam.serviceAccounts.actAs`

**iam.serviceAccounts.actAs dozvola** je poput **iam:PassRole dozvole iz AWS-a**. Klju캜na je za izvr코avanje zadataka, kao 코to je pokretanje Compute Engine instance, jer omogu캖ava sposobnost "delovanja kao" servisni nalog, osiguravaju캖i sigurnu upravljanje dozvolama. Bez ovoga, korisnici bi mogli dobiti neprimeren pristup. Pored toga, eksploatacija **iam.serviceAccounts.actAs** uklju캜uje razli캜ite metode, od kojih svaka zahteva skup dozvola, za razliku od drugih metoda koje zahtevaju samo jednu.

#### Impersonacija servisnog naloga <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Impersonacija servisnog naloga mo쬰 biti veoma korisna za **dobijanje novih i boljih privilegija**. Postoje tri na캜ina na koja mo쬰te [impersonirati drugi servisni nalog](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account):

* Autentifikacija **koriste캖i RSA privatne klju캜eve** (obra캠eno iznad)
* Autorizacija **koriste캖i Cloud IAM politike** (obra캠eno ovde)
* **Implementacija poslova na GCP uslugama** (vi코e primenljivo na kompromitaciju korisni캜kog naloga)

### `iam.serviceAccounts.getOpenIdToken`

Napada캜 sa pomenutim dozvolama 캖e mo캖i da generi코e OpenID JWT. Ovi se koriste za potvrdu identiteta i ne nose nu쬹o nikakvu implicitnu autorizaciju prema resursu.

Prema ovom [**zanimljivom postu**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b), potrebno je nazna캜iti publiku (uslugu gde 쬰lite da koristite token za autentifikaciju) i dobi캖ete JWT potpisan od strane google-a koji ukazuje na servisni nalog i publiku JWT-a.

Mo쬰te generisati OpenIDToken (ako imate pristup) sa:
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
햑햟햢햟 햪쮏웷왐햣 혲햣햢햫쮐혝햟쒫쫧 햢햟 햡햟 햨쮐햦혜혝햦혝햣 향햟 햦혜혝혞 혞혜햩혞향햦 혜햟:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
Neke usluge koje podr쬬vaju autentifikaciju putem ovakvih tokena su:

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (ako koristite Google OIDC)

Mo쬰te prona캖i primer kako da kreirate OpenID token u ime servisnog naloga [**ovde**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py).

## Reference

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
