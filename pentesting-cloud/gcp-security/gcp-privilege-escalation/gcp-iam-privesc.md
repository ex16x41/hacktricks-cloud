# GCP - IAM Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## IAM

IAM рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### `iam.roles.update` (`iam.roles.get`)

рдЙрд▓реНрд▓реЗрдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЖрдкрдХреЗ рд▓рд┐рдП рдЕрд╕рд╛рдЗрди рдХреА рдЧрдИ рднреВрдорд┐рдХрд╛ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ рдФрд░ рдЖрдкрдХреЛ рдЕрдиреНрдп рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЗ рд▓рд┐рдП рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрдЧрд╛ рдЬреИрд╕реЗ:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
рдЖрдк **рдпрд╣рд╛рдВ** рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ **рдПрдХ vuln рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рдирд┐рд░реНрдорд╛рдг, рд╢реЛрд╖рдг рдФрд░ рд╕рдлрд╛рдИ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рддреА рд╣реИ** рдФрд░ рдЗрд╕ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд╛рдпрдерди рд╕реНрдХреНрд░рд┐рдкреНрдЯ [**рдпрд╣рд╛рдВ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py) рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд╢реЛрдз**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, **рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдПрдХ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛**, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХрд╛ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рдП рдЬрд┐рд╕рдореЗрдВ рд╣рдорд╛рд░реЗ рд╕реЗ рдЕрдзрд┐рдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реЛрдВред
```bash
gcloud --impersonate-service-account="${victim}@${PROJECT_ID}.iam.gserviceaccount.com" \
auth print-access-token
```
рдЖрдк рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ [**рдПрдХ vuln рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рдирд┐рд░реНрдорд╛рдг, рд╢реЛрд╖рдг рдФрд░ рд╕рдлрд╛рдИ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рддреА рд╣реИ рдпрд╣рд╛рдБ**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) рдФрд░ рдПрдХ рдкрд╛рдпрдерди рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЬреЛ рдЗрд╕ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИ [**рдпрд╣рд╛рдБ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py)ред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд╢реЛрдз**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред

### `iam.serviceAccountKeys.create`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, **рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛-рдкреНрд░рдмрдВрдзрд┐рдд рдХреБрдВрдЬреА рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛**, рдЬреЛ рд╣рдореЗрдВ рдЙрд╕ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рд░реВрдк рдореЗрдВ GCP рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ред
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
рдЖрдк рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ [**рдПрдХ vuln рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рдирд┐рд░реНрдорд╛рдг, рд╢реЛрд╖рдг рдФрд░ рд╕рдлрд╛рдИ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣рд╛рдБ**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) рдФрд░ рдЗрд╕ рд╡рд┐рд╢реЗрд╖рддрд╛ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд╛рдпрдерди рд╕реНрдХреНрд░рд┐рдкреНрдЯ [**рдпрд╣рд╛рдБ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py) рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд╢реЛрдз**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) рджреЗрдЦреЗрдВред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **`iam.serviceAccountKeys.update` рдПрдХ SA рдХреА рдХреБрдВрдЬреА рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛** рдХреНрдпреЛрдВрдХрд┐ рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `iam.serviceAccountKeys.create` рдЕрдиреБрдорддрд┐ рднреА рдЖрд╡рд╢реНрдпрдХ рд╣реИред

### `iam.serviceAccounts.implicitDelegation`

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдкрд░ **`iam.serviceAccounts.implicitDelegation`** рдЕрдиреБрдорддрд┐ рд╣реИ рдЬреЛ рдПрдХ рддреАрд╕рд░реЗ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдкрд░ **`iam.serviceAccounts.getAccessToken`** рдЕрдиреБрдорддрд┐ рд░рдЦрддрд╛ рд╣реИ, рддреЛ рдЖрдк implicitDelegation рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдЙрд╕ рддреАрд╕рд░реЗ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЯреЛрдХрди рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред рдпрд╣рд╛рдБ рдПрдХ рдЪрд┐рддреНрд░ рд╣реИ рдЬреЛ рд╕рдордЭрд╛рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИред

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ [**рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг**](https://cloud.google.com/iam/docs/understanding-service-accounts) рдХреЗ рдЕрдиреБрд╕рд╛рд░, `gcloud` рдХрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХреЗрд╡рд▓ [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken) рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред рддреЛ рдпрд╣рд╛рдБ рдЖрдкрдХреЗ рдкрд╛рд╕ API рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реАрдзреЗ рдПрдХ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рд╣реИ:
```bash
curl -X POST \
'https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/'"${TARGET_SERVICE_ACCOUNT}"':generateAccessToken' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer '"$(gcloud auth print-access-token)" \
-d '{
"delegates": ["projects/-/serviceAccounts/'"${DELEGATED_SERVICE_ACCOUNT}"'"],
"scope": ["https://www.googleapis.com/auth/cloud-platform"]
}'
```
You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) and a python script to abuse this privilege [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py). For more information check the [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signBlob`

An attacker with the mentioned permissions will be able to **GCP рдореЗрдВ рдордирдорд╛рдиреЗ рдкреЗрд▓реЛрдбреНрд╕ рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛**ред рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ рдХрд┐ **SA рдХрд╛ рдПрдХ рдЕрд╕рд╛рдЗрди рдХрд┐рдП рдмрд┐рдирд╛ JWT рдмрдирд╛рдПрдВ рдФрд░ рдлрд┐рд░ рдЗрд╕реЗ рдПрдХ рдмреНрд▓реЙрдм рдХреЗ рд░реВрдк рдореЗрдВ рднреЗрдЬреЗрдВ рддрд╛рдХрд┐ рд╣рдо рдЬрд┐рд╕ SA рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдЙрд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ JWT рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ**ред For more information [**read this**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed).

You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) and a python script to abuse this privilege [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) and [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py). For more information check the [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signJwt`

An attacker with the mentioned permissions will be able to **рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рдмрдирд╛рдП рдЧрдП JSON рд╡реЗрдм рдЯреЛрдХрди (JWTs) рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛**ред рдкрд┐рдЫрд▓реЗ рддрд░реАрдХреЗ рдХреЗ рд╕рд╛рде рдЕрдВрддрд░ рдпрд╣ рд╣реИ рдХрд┐ **JWT рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдо signJWT рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА JWT рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рдХреЗ рдмрдЬрд╛рдп рдХрд┐ рдЧреВрдЧрд▓ рдХреЛ JWT рд╡рд╛рд▓реЗ рдмреНрд▓реЙрдм рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛рдП**ред рдпрд╣ рдЙрдкрдпреЛрдЧ рдореЗрдВ рдЖрд╕рд╛рди рдмрдирд╛рддрд╛ рд╣реИ рд▓реЗрдХрд┐рди рдЖрдк рдХреЗрд╡рд▓ JWT рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рди рдХрд┐ рдХрд┐рд╕реА рднреА рдмрд╛рдЗрдЯреНрд╕ рдкрд░ред

You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) and a python script to abuse this privilege [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py). For more information check the [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

An attacker with the mentioned permissions will be able to **рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдХреЗ рд▓рд┐рдП IAM рдиреАрддрд┐рдпреЛрдВ рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛**ред рдЖрдк рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ **рдЕрдкрдиреЗ рд▓рд┐рдП** рдЙрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рдирдХреА рдЖрдкрдХреЛ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рд╣рдо рдЕрдкрдиреЗ рд▓рд┐рдП `roles/iam.serviceAccountTokenCreator` рднреВрдорд┐рдХрд╛ рдХреЛ рджрд┐рд▓рдЪрд╕реНрдк SA рдкрд░ рджреЗ рд░рд╣реЗ рд╣реИрдВ:
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"

# If you still have prblem grant yourself also this permission
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \ \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountUser"
```
рдЖрдк [**рдпрд╣рд╛рдВ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ vuln рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рдирд┐рд░реНрдорд╛рдг, рд╢реЛрд╖рдг рдФрд░ рд╕рдлрд╛рдИ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рддреА рд╣реИ**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**ред**

### `iam.serviceAccounts.actAs`

**iam.serviceAccounts.actAs рдЕрдиреБрдорддрд┐** AWS рд╕реЗ **iam:PassRole рдЕрдиреБрдорддрд┐** рдХреЗ рд╕рдорд╛рди рд╣реИред рдпрд╣ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ Compute Engine рдЙрджрд╛рд╣рд░рдг рд╢реБрд░реВ рдХрд░рдирд╛, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рд░реВрдк рдореЗрдВ "actAs" рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдЕрдиреБрдорддрд┐ рдкреНрд░рдмрдВрдзрди рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдмрд┐рдирд╛, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдиреБрдЪрд┐рдд рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, **iam.serviceAccounts.actAs** рдХрд╛ рд╢реЛрд╖рдг рд╡рд┐рднрд┐рдиреНрди рддрд░реАрдХреЛрдВ рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рдХреЛ рдПрдХ рд╕реЗрдЯ рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдЬрдмрдХрд┐ рдЕрдиреНрдп рддрд░реАрдХреЛрдВ рдХреЛ рдХреЗрд╡рд▓ рдПрдХ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

#### рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЕрдиреБрдХрд░рдг <a href="#service-account-impersonation" id="service-account-impersonation"></a>

рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХрд╛ рдЕрдиреБрдХрд░рдг **рдирдП рдФрд░ рдмреЗрд╣рддрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рдЖрдк [рджреВрд╕рд░реЗ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХрд╛ рдЕрдиреБрдХрд░рдг](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account) рдХрд░рдиреЗ рдХреЗ рддреАрди рддрд░реАрдХреЗ рд╣реИрдВ:

* рдкреНрд░рдорд╛рдгреАрдХрд░рдг **RSA рдирд┐рдЬреА рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ** (рдКрдкрд░ рдХрд╡рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛)
* рдкреНрд░рд╛рдзрд┐рдХрд░рдг **Cloud IAM рдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ** (рдпрд╣рд╛рдВ рдХрд╡рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛)
* **GCP рд╕реЗрд╡рд╛рдУрдВ рдкрд░ рдиреМрдХрд░рд┐рдпреЛрдВ рдХреЛ рддреИрдирд╛рдд рдХрд░рдирд╛** (рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ рдХреЗ рд╕рдордЭреМрддреЗ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХ рд▓рд╛рдЧреВ)

### `iam.serviceAccounts.getOpenIdToken`

рдЙрдкрд░реЛрдХреНрдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ OpenID JWT рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ред рдЗрдирдХрд╛ рдЙрдкрдпреЛрдЧ рдкрд╣рдЪрд╛рди рдХреЛ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдпреЗ рдХрд┐рд╕реА рд╕рдВрд╕рд╛рдзрди рдХреЗ рдЦрд┐рд▓рд╛рдл рдХрд┐рд╕реА рдирд┐рд╣рд┐рдд рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЛ рдЕрдирд┐рд╡рд╛рд░реНрдп рд░реВрдк рд╕реЗ рдирд╣реАрдВ рд▓реЗ рдЬрд╛рддреЗ рд╣реИрдВред

рдЗрд╕ [**рджрд┐рд▓рдЪрд╕реНрдк рдкреЛрд╕реНрдЯ**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b) рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдпрд╣ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдХрд┐ рджрд░реНрд╢рдХ (рд╕реЗрд╡рд╛ рдЬрд╣рд╛рдВ рдЖрдк рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ) рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдП рдФрд░ рдЖрдкрдХреЛ рдПрдХ JWT рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛ рдЬреЛ google рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реИ, рдЬреЛ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдФрд░ JWT рдХреЗ рджрд░реНрд╢рдХ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИред

рдЖрдк OpenIDToken рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдкрд╣реБрдВрдЪ рд╣реИ) рдХреЗ рд╕рд╛рде:
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
рдлрд┐рд░ рдЖрдк рдЗрд╕реЗ рд╕реЗрд╡рд╛ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
рдХреБрдЫ рд╕реЗрд╡рд╛рдПрдБ рдЬреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рдЯреЛрдХрди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреА рд╣реИрдВ:

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (рдпрджрд┐ Google OIDC рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ)

рдЖрдк рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреА рдУрд░ рд╕реЗ OpenID рдЯреЛрдХрди рдмрдирд╛рдиреЗ рдХрд╛ рдЙрджрд╛рд╣рд░рдг [**рдпрд╣рд╛рдБ**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py) рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

## рд╕рдВрджрд░реНрдн

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
