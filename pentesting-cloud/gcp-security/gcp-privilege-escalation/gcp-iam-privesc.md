# GCP - IAM Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## IAM

IAM hakkında daha fazla bilgi için:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### `iam.roles.update` (`iam.roles.get`)

Belirtilen izinlere sahip bir saldırgan, size atanan bir rolü güncelleyebilir ve size aşağıdaki gibi diğer kaynaklara ek izinler verebilir:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
You can find a script to automate the **creation, exploit and cleaning of a vuln environment here** and a python script to abuse this privilege [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py). For more information check the [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

Belirtilen izinlere sahip bir saldırgan, **bir Hizmet Hesabına ait bir erişim token'ı talep edebilecektir**, bu nedenle, bizimkinden daha fazla yetkiye sahip bir Hizmet Hesabının erişim token'ını talep etmek mümkündür.
```bash
gcloud --impersonate-service-account="${victim}@${PROJECT_ID}.iam.gserviceaccount.com" \
auth print-access-token
```
Bir [**vuln ortamının oluşturulması, istismar edilmesi ve temizlenmesi için bir scripti burada bulabilirsiniz**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) ve bu yetkiyi kötüye kullanmak için bir python scripti [**burada**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py) bulunmaktadır. Daha fazla bilgi için [**orijinal araştırmaya**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) göz atın.

### `iam.serviceAccountKeys.create`

Belirtilen izinlere sahip bir saldırgan, **bir Hizmet Hesabı için kullanıcı tarafından yönetilen bir anahtar oluşturabilecektir**, bu da bize GCP'ye o Hizmet Hesabı olarak erişim sağlayacaktır.
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
Bir [**vuln ortamının oluşturulması, istismar edilmesi ve temizlenmesi için otomatikleştirilmiş bir scripti burada bulabilirsiniz**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) ve bu yetkiyi kötüye kullanmak için bir python scripti [**burada**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py). Daha fazla bilgi için [**orijinal araştırmaya**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) bakın.

**`iam.serviceAccountKeys.update`'in bir SA'nın anahtarını değiştirmek için çalışmayacağını** unutmayın çünkü bunu yapmak için `iam.serviceAccountKeys.create` izinleri de gereklidir.

### `iam.serviceAccounts.implicitDelegation`

Eğer **`iam.serviceAccounts.implicitDelegation`** iznine sahipseniz ve bu izin, üçüncü bir Service Account üzerinde **`iam.serviceAccounts.getAccessToken`** iznine sahip bir Service Account üzerinde ise, o zaman implicitDelegation kullanarak **o üçüncü Service Account için bir token oluşturabilirsiniz**. Açıklamaya yardımcı olacak bir diyagram burada.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

**Dokümantasyona** göre [**belirtilmiştir**](https://cloud.google.com/iam/docs/understanding-service-accounts), `gcloud`'un delegasyonu yalnızca [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken) yöntemini kullanarak bir token oluşturmak için çalışır. İşte API'yi doğrudan kullanarak bir token almanın yolu:
```bash
curl -X POST \
'https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/'"${TARGET_SERVICE_ACCOUNT}"':generateAccessToken' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer '"$(gcloud auth print-access-token)" \
-d '{
"delegates": ["projects/-/serviceAccounts/'"${DELEGATED_SERVICE_ACCOUNT}"'"],
"scope": ["https://www.googleapis.com/auth/cloud-platform"]
}'
```
You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) and a python script to abuse this privilege [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py). For more information check the [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signBlob`

An attacker with the mentioned permissions will be able to **GCP'de rastgele yükleri imzalamak**. So it'll be possible to **SA'nın imzasız JWT'sini oluşturmak ve ardından hedeflediğimiz SA tarafından JWT'nin imzalanması için bir blob olarak göndermek**. For more information [**read this**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed).

You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) and a python script to abuse this privilege [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) and [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py). For more information check the [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signJwt`

An attacker with the mentioned permissions will be able to **iyi biçimlendirilmiş JSON web token'larını (JWT) imzalamak**. The difference with the previous method is that **JWT içeren bir blob'u imzalatmak yerine, zaten bir JWT bekleyen signJWT yöntemini kullanıyoruz**. This makes it easier to use but you can only sign JWT instead of any bytes.

You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) and a python script to abuse this privilege [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py). For more information check the [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

An attacker with the mentioned permissions will be able to **hizmet hesaplarına IAM politikaları eklemek**. You can abuse it to **kendinize** gerekli izinleri vermek için hizmet hesabını taklit etmek. In the following example we are granting ourselves the `roles/iam.serviceAccountTokenCreator` role over the interesting SA:
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"

# If you still have prblem grant yourself also this permission
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \ \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountUser"
```
You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**.**

### `iam.serviceAccounts.actAs`

The **iam.serviceAccounts.actAs permission** is like the **iam:PassRole permission from AWS**. It's essential for executing tasks, like initiating a Compute Engine instance, as it grants the ability to "actAs" a Service Account, ensuring secure permission management. Without this, users might gain undue access. Additionally, exploiting the **iam.serviceAccounts.actAs** involves various methods, each requiring a set of permissions, contrasting with other methods that need just one.

#### Service account impersonation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Bir hizmet hesabını taklit etmek, **yeni ve daha iyi ayrıcalıklar elde etmek** için çok faydalı olabilir. Başka bir hizmet hesabını [taklit etmenin üç yolu vardır](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account):

* Kimlik doğrulama **RSA özel anahtarları kullanarak** (yukarıda ele alındı)
* Yetkilendirme **Cloud IAM politikaları kullanarak** (burada ele alındı)
* **GCP hizmetlerinde işler dağıtarak** (bir kullanıcı hesabının ele geçirilmesiyle daha ilgili)

### `iam.serviceAccounts.getOpenIdToken`

Belirtilen izinlere sahip bir saldırgan, bir OpenID JWT oluşturabilecektir. Bunlar kimliği doğrulamak için kullanılır ve bir kaynağa karşı herhangi bir örtük yetkilendirme taşımazlar.

Bu [**ilginç yazıya**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b) göre, hedefi (token'ı kimlik doğrulamak için kullanmak istediğiniz hizmet) belirtmek gereklidir ve bir JWT alacaksınız, bu JWT google tarafından imzalanmış olup hizmet hesabını ve JWT'nin hedefini belirtir.

Erişiminiz varsa bir OpenIDToken oluşturabilirsiniz:
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
Sonra bunu servise erişmek için kullanabilirsiniz:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
Bazı hizmetler, bu tür token'lar aracılığıyla kimlik doğrulamayı desteklemektedir:

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (Google OIDC kullanıyorsanız)

Bir hizmet hesabı adına OpenID token oluşturma ile ilgili bir örneği [**burada**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py) bulabilirsiniz.

## Referanslar

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
