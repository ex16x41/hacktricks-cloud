# GCP - plaaslike voorregverhoging ssh pivoting

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

in this scenario we are going to suppose that you **het 'n nie-voorreg rekening gecompromitteer** binne 'n VM in 'n Compute Engine projek.

Amazingly, GPC toestemmings van die compute engine wat jy gecompromitteer het, mag jou help om **plaaslik voorregte binne 'n masjien te verhoog**. Alhoewel dit nie altyd baie nuttig in 'n wolkomgewing sal wees nie, is dit goed om te weet dit is moontlik.

## Lees die skripte <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**Compute Instances** is waarskynlik daar om **sekere skripte uit te voer** om aksies met hul diensrekeninge te verrig.

Aangesien IAM baie gedetailleerd is, kan 'n rekening **lees/skryf** voorregte oor 'n hulpbron h√™, maar **geen lys voorregte** nie.

'n Groot hipotetiese voorbeeld hiervan is 'n Compute Instance wat toestemming het om rugsteun te lees/skryf na 'n stoor emmer genaamd `instance82736-long-term-xyz-archive-0332893`.

Wanneer jy `gsutil ls` vanaf die opdraglyn uitvoer, kom daar niks terug nie, aangesien die diensrekening die `storage.buckets.list` IAM toestemming mis. As jy egter `gsutil ls gs://instance82736-long-term-xyz-archive-0332893` uitvoer, mag jy 'n volledige l√™erstelselrugsteun vind, wat jou duidelike toegang tot data gee wat jou plaaslike Linux rekening ontbreek.

Jy mag in staat wees om hierdie emmernaam binne 'n skrip te vind (in bash, Python, Ruby...).

## Aangepaste Metadata

Administrateurs kan [aangepaste metadata](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom) by die **instansie** en **projekvlak** voeg. Dit is eenvoudig 'n manier om **arbitraire sleutel/waarde pare in 'n instansie oor te dra**, en word algemeen gebruik vir omgewing veranderlikes en opstart/afskakel skripte.

Boonop is dit moontlik om **userdata** toe te voeg, wat 'n skrip is wat **elke keer** wanneer die masjien begin of herbegin, **uitgevoer sal word** en wat ook **van die metadata eindpunt verkry kan word.**

Vir meer inligting, kyk:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

## **Misbruik van IAM toestemmings**

Meeste van die volgende voorgestelde toestemmings word **aan die standaard Compute SA gegee,** die enigste probleem is dat die **standaard toegangskop die SA verhinder om dit te gebruik**. As egter **`cloud-platform`** **kop** geaktiveer is of net die **`compute`** **kop** geaktiveer is, sal jy in staat wees om dit te **misbruik**.

Kyk na die volgende toestemmings:

* [**compute.instances.osLogin**](gcp-compute-privesc/#compute.instances.oslogin)
* [**compute.instances.osAdminLogin**](gcp-compute-privesc/#compute.instances.osadminlogin)
* [**compute.projects.setCommonInstanceMetadata**](gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)
* [**compute.instances.setMetadata**](gcp-compute-privesc/#compute.instances.setmetadata)
* [**compute.instances.setIamPolicy**](gcp-compute-privesc/#compute.instances.setiampolicy)

## Soek na Sleutels in die l√™erstelsel

Kyk of ander gebruikers in gcloud binne die boks aangemeld het en hul akrediteer in die l√™erstelsel gelaat het:
```
sudo find / -name "gcloud"
```
Hierdie is die mees interessante l√™ers:

* `~/.config/gcloud/credentials.db`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/adc.json`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/.boto`
* `~/.credentials.json`

### Meer API Sleutels regexes
```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```
## Verwysings

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
