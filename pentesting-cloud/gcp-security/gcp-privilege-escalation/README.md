# GCP - Privilege Escalation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Introduzione all'Escalation dei Privilegi in GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, come qualsiasi altro cloud, ha alcuni **principali**: utenti, gruppi e account di servizio, e alcune **risorse** come compute engine, cloud functions‚Ä¶\
Poi, tramite ruoli, **i permessi vengono concessi a questi principali sulle risorse**. Questo √® il modo per specificare i permessi che un principale ha su una risorsa in GCP.\
Ci sono determinati permessi che consentiranno a un utente di **ottenere ancora pi√π permessi** sulla risorsa o su risorse di terze parti, e questo √® ci√≤ che viene chiamato **escalation dei privilegi** (anche, lo sfruttamento delle vulnerabilit√† per ottenere pi√π permessi).

Pertanto, vorrei separare le tecniche di escalation dei privilegi in GCP in **2 gruppi**:

* **Privesc a un principale**: Questo ti permetter√† di **impersonare un altro principale**, e quindi agire come esso con tutti i suoi permessi. ad es.: Abusare di _getAccessToken_ per impersonare un account di servizio.
* **Privesc sulla risorsa**: Questo ti permetter√† di **ottenere pi√π permessi sulla risorsa specifica**. ad es.: puoi abusare del permesso _setIamPolicy_ su cloudfunctions per consentirti di attivare la funzione.
* Nota che alcuni **permessi delle risorse ti permetteranno anche di allegare un account di servizio arbitrario** alla risorsa. Questo significa che sarai in grado di avviare una risorsa con un SA, entrare nella risorsa e **rubare il token SA**. Pertanto, questo permetter√† di escalare a un principale tramite un'escalation della risorsa. Questo √® accaduto in diverse risorse in precedenza, ma ora √® meno frequente (ma pu√≤ ancora accadere).

Ovviamente, le tecniche di escalation dei privilegi pi√π interessanti sono quelle del **secondo gruppo** perch√© ti permetteranno di **ottenere pi√π privilegi al di fuori delle risorse su cui hai gi√†** alcuni privilegi. Tuttavia, nota che **l'escalation nelle risorse** pu√≤ darti anche accesso a **informazioni sensibili** o persino ad **altri principali** (forse leggendo un segreto che contiene un token di un SA).

{% hint style="warning" %}
√à importante notare anche che in **GCP gli Account di Servizio sono sia principali che permessi**, quindi escalare i privilegi in un SA ti permetter√† di impersonarlo anche.
{% endhint %}

{% hint style="info" %}
I permessi tra parentesi indicano i permessi necessari per sfruttare la vulnerabilit√† con `gcloud`. Questi potrebbero non essere necessari se sfruttati tramite l'API.
{% endhint %}

## Permessi per la Metodologia di Escalation dei Privilegi

Questo √® come **testo per permessi specifici** per eseguire azioni specifiche all'interno di GCP.

1. Scarica il repo github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp_privesc_scripts)
2. Aggiungi in tests/ il nuovo script

## Bypassare gli ambiti di accesso <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

I token di SA trapelati dal servizio metadata di GCP hanno **ambiti di accesso**. Questi sono **restrizioni** sui **permessi** che il token ha. Ad esempio, se il token ha l'**ambito `https://www.googleapis.com/auth/cloud-platform`**, avr√† **accesso completo** a tutti i servizi GCP. Tuttavia, se il token ha l'**ambito `https://www.googleapis.com/auth/cloud-platform.read-only`**, avr√† solo **accesso in sola lettura** a tutti i servizi GCP anche se il SA ha pi√π permessi in IAM.

Non c'√® un modo diretto per bypassare questi permessi, ma potresti sempre provare a cercare **nuove credenziali** nell'host compromesso, **trovare la chiave di servizio** per generare un token OAuth senza restrizioni o **saltare a una VM diversa meno restrittiva**.

Quando vengono utilizzati [ambiti di accesso](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), il token OAuth che viene generato per l'istanza di calcolo (VM) avr√† **una** [**limitazione di ambito**](https://oauth.net/2/scope/) **inclusa**. Tuttavia, potresti essere in grado di **bypassare** questa limitazione e sfruttare i permessi che ha l'account compromesso.

Il **modo migliore per bypassare** questa restrizione √® o **trovare nuove credenziali** nell'host compromesso, **trovare la chiave di servizio per generare un token OAuth** senza restrizioni o **compromettere una VM diversa con un SA meno restrittivo**.

Controlla SA con chiavi generate con:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Tecniche di Escalation dei Privilegi

Il modo per elevare i tuoi privilegi in AWS √® avere abbastanza permessi per poter, in qualche modo, accedere ai privilegi di altri account di servizio/utenti/gruppi. Collegare le escalation fino ad avere accesso admin sull'organizzazione.

{% hint style="warning" %}
GCP ha **centinaia** (se non migliaia) di **permessi** che possono essere concessi a un'entit√†. In questo libro puoi trovare **tutti i permessi che conosco** che puoi abusare per **escalare privilegi**, ma se **conosci qualche percorso** non menzionato qui, **per favore condividilo**.
{% endhint %}

**Le sottopagine di questa sezione sono ordinate per servizi. Puoi trovare su ciascun servizio diversi modi per escalare privilegi sui servizi.**

### Abusare di GCP per escalare privilegi localmente

Se sei all'interno di una macchina in GCP potresti essere in grado di abusare dei permessi per escalare privilegi anche localmente:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Riferimenti

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Impara e pratica Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Impara e pratica Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
