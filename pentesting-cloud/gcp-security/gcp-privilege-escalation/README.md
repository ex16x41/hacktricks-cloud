# GCP - Privilege Escalation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Introduction to GCP Privilege Escalation <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, jak ka偶da inna chmura, ma pewne **zasady**: u偶ytkownicy, grupy i konta serwisowe, oraz pewne **zasoby** takie jak silnik obliczeniowy, funkcje chmurowe\
Nastpnie, poprzez role, **uprawnienia s przyznawane tym zasadom nad zasobami**. To jest spos贸b na okrelenie uprawnie, jakie zasada ma nad zasob w GCP.\
Istniej pewne uprawnienia, kt贸re pozwol u偶ytkownikowi **uzyska jeszcze wicej uprawnie** nad zasob lub zasobami os贸b trzecich, i to nazywa si **eskalacj uprawnie** (tak偶e, wykorzystanie luk w zabezpieczeniach, aby uzyska wicej uprawnie).

Dlatego chciabym podzieli techniki eskalacji uprawnie w GCP na **2 grupy**:

* **Eskalacja do zasady**: To pozwoli ci **udawa inn zasad**, a tym samym dziaa jak ona ze wszystkimi jej uprawnieniami. np.: Wykorzystanie _getAccessToken_ do udawania konta serwisowego.
* **Eskalacja nad zasobem**: To pozwoli ci **uzyska wicej uprawnie nad konkretn zasob**. np.: mo偶esz wykorzysta uprawnienie _setIamPolicy_ nad cloudfunctions, aby umo偶liwi sobie wywoanie funkcji.
* Zauwa偶, 偶e niekt贸re **uprawnienia zasob贸w r贸wnie偶 pozwol ci doczy dowolne konto serwisowe** do zasoby. Oznacza to, 偶e bdziesz m贸g uruchomi zasob z SA, dosta si do zasoby i **ukra token SA**. Dlatego to pozwoli na eskalacj do zasady poprzez eskalacj zasob贸w. To zdarzyo si w kilku zasobach wczeniej, ale teraz jest mniej powszechne (ale nadal mo偶e si zdarzy).

Oczywicie, najbardziej interesujce techniki eskalacji uprawnie to te z **drugiej grupy**, poniewa偶 pozwol ci **uzyska wicej uprawnie poza zasobami, nad kt贸rymi ju偶 masz** pewne uprawnienia. Jednak zauwa偶, 偶e **eskalacja w zasobach** mo偶e r贸wnie偶 da ci dostp do **wra偶liwych informacji** lub nawet do **innych zasad** (mo偶e poprzez odczytanie sekretu, kt贸ry zawiera token SA).

{% hint style="warning" %}
Wa偶ne jest r贸wnie偶, aby zauwa偶y, 偶e w **GCP konta serwisowe s zar贸wno zasadami, jak i uprawnieniami**, wic eskalacja uprawnie w SA pozwoli ci r贸wnie偶 na jego udawanie.
{% endhint %}

{% hint style="info" %}
Uprawnienia w nawiasach wskazuj na uprawnienia potrzebne do wykorzystania luki za pomoc `gcloud`. Mog nie by potrzebne, jeli wykorzystujesz to przez API.
{% endhint %}

## Permissions for Privilege Escalation Methodology

To jest spos贸b, w jaki **testuj konkretne uprawnienia** do wykonywania konkretnych dziaa w GCP.

1. Pobierz repozytorium github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Dodaj w tests/ nowy skrypt

## Bypassing access scopes <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokeny SA wyciekajce z usugi metadanych GCP maj **zakresy dostpu**. S to **ograniczenia** dotyczce **uprawnie**, kt贸re ma token. Na przykad, jeli token ma zakres **`https://www.googleapis.com/auth/cloud-platform`**, bdzie mia **peny dostp** do wszystkich usug GCP. Jednak jeli token ma zakres **`https://www.googleapis.com/auth/cloud-platform.read-only`**, bdzie mia tylko **dostp tylko do odczytu** do wszystkich usug GCP, nawet jeli SA ma wicej uprawnie w IAM.

Nie ma bezporedniego sposobu na obejcie tych uprawnie, ale zawsze mo偶esz spr贸bowa poszuka **nowych powiadcze** w skompromitowanym hocie, **znale藕 klucz usugi** do wygenerowania tokena OAuth bez ogranicze lub **przej do innej VM mniej ograniczonej**.

Gdy u偶ywane s [zakresy dostpu](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), token OAuth, kt贸ry jest generowany dla instancji obliczeniowej (VM), bdzie **mia** [**ograniczenie**](https://oauth.net/2/scope/) **zakresu** wczone. Jednak mo偶esz by w stanie **obej** to ograniczenie i wykorzysta uprawnienia, kt贸re ma skompromitowane konto.

**Najlepszym sposobem na obejcie** tego ograniczenia jest albo **znalezienie nowych powiadcze** w skompromitowanym hocie, **znalezienie klucza usugi do wygenerowania tokena OAuth** bez ogranicze lub **skompromitowanie innej VM z SA mniej ograniczonym**.

Sprawd藕 SA z kluczami wygenerowanymi za pomoc:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Techniki eskalacji uprawnie

Sposobem na eskalacj swoich uprawnie w AWS jest posiadanie wystarczajcych uprawnie, aby w jaki spos贸b uzyska dostp do uprawnie innych kont usugowych/u偶ytkownik贸w/grup. czenie eskalacji, a偶 uzyskasz dostp administratora do organizacji.

{% hint style="warning" %}
GCP ma **setki** (jeli nie tysice) **uprawnie**, kt贸re mog by przyznane podmiotowi. W tej ksi偶ce znajdziesz **wszystkie uprawnienia, kt贸re znam**, kt贸re mo偶esz wykorzysta do **eskalacji uprawnie**, ale jeli **znasz jak cie偶k**, kt贸ra nie zostaa tutaj wymieniona, **prosz podziel si ni**.
{% endhint %}

**Podstrony tej sekcji s uporzdkowane wedug usug. Na ka偶dej usudze znajdziesz r贸偶ne sposoby na eskalacj uprawnie w tych usugach.**

### Wykorzystywanie GCP do lokalnej eskalacji uprawnie

Jeli jeste wewntrz maszyny w GCP, mo偶esz by w stanie wykorzysta uprawnienia do eskalacji uprawnie nawet lokalnie:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Odniesienia

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
