# GCP - Eskalacija privilegija

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Uvod u Eskalaciju privilegija u GCP-u <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, kao i svaki drugi oblak, ima neke **principale**: korisnike, grupe i servisne naloge, i neke **resurse** poput raÄunarskog motora, cloud funkcija...\
Zatim, putem uloga, **dozvole se dodeljuju tim principima nad resursima**. To je naÄin da se specificira dozvole koje princip ima nad resursom u GCP-u.\
Postoje odreÄ‘ene dozvole koje Ä‡e korisniku omoguÄ‡iti **dobijanje joÅ¡ viÅ¡e dozvola** nad resursom ili resursima treÄ‡e strane, a to se naziva **eskalcija privilegija** (takoÄ‘e, iskoriÅ¡Ä‡avanje ranjivosti radi dobijanja viÅ¡e dozvola).

Stoga, Å¾eleo bih da razdvojim tehnike eskalacije privilegija u GCP-u u **2 grupe**:

* **Privesc na principala**: To Ä‡e vam omoguÄ‡iti da **se predstavite kao drugi princip**, i stoga delujete kao on sa svim njegovim dozvolama. npr.: Zloupotreba _getAccessToken_ da se predstavite kao servisni nalog.
* **Privesc na resursu**: To Ä‡e vam omoguÄ‡iti da **dobijete viÅ¡e dozvola nad odreÄ‘enim resursom**. npr.: moÅ¾ete zloupotrebiti dozvolu _setIamPolicy_ nad cloud funkcijama da biste omoguÄ‡ili pokretanje funkcije.
* Imajte na umu da Ä‡e neke **dozvole nad resursima takoÄ‘e omoguÄ‡iti povezivanje proizvoljnog servisnog naloga** sa resursom. To znaÄi da Ä‡ete moÄ‡i da pokrenete resurs sa SA, uÄ‘ete u resurs i **ukradete SA token**. Stoga, to Ä‡e vam omoguÄ‡iti da eskalirate na principala putem eskalacije resursa. Ovo se deÅ¡avalo u nekoliko resursa ranije, ali sada je manje uÄestalo (ali se i dalje moÅ¾e desiti).

OÄigledno, najinteresantnije tehnike eskalacije privilegija su one iz **druge grupe** jer Ä‡e vam omoguÄ‡iti da **dobijete viÅ¡e privilegija izvan resursa nad kojima veÄ‡ imate neke privilegije**. MeÄ‘utim, imajte na umu da **eskalcija u resursima** moÅ¾e vam takoÄ‘e omoguÄ‡iti pristup **osetljivim informacijama** ili Äak **drugim principima** (moÅ¾da Äitanjem tajne koja sadrÅ¾i token SA).

{% hint style="warning" %}
VaÅ¾no je napomenuti i da su u **GCP servisni nalozi i principali i dozvole**, tako da eskalacija privilegija u SA Ä‡e vam omoguÄ‡iti i da se predstavite kao on.
{% endhint %}

{% hint style="info" %}
Dozvole izmeÄ‘u zagrada ukazuju na dozvole potrebne za iskoriÅ¡Ä‡avanje ranjivosti pomoÄ‡u `gcloud`. One moÅ¾da nisu potrebne ako se iskoriÅ¡Ä‡ava putem API-ja.
{% endhint %}

## Dozvole za Metodologiju Eskalacije privilegija

Ovako **testiram specifiÄne dozvole** za obavljanje odreÄ‘enih akcija unutar GCP-a.

1. Preuzmite github repozitorijum [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Dodajte novi skript u tests/

## Zaobilazak pristupnih opsega <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokeni SA koji cure iz GCP metadata servisa imaju **pristupne opsege**. To su **ograniÄenja** na **dozvole** koje token ima. Na primer, ako token ima opseg **`https://www.googleapis.com/auth/cloud-platform`**, imaÄ‡e **puni pristup** svim GCP uslugama. MeÄ‘utim, ako token ima opseg **`https://www.googleapis.com/auth/cloud-platform.read-only`**, imaÄ‡e samo **samo Äitanje pristupa** svim GCP uslugama Äak i ako SA ima viÅ¡e dozvola u IAM.

Ne postoji direktni naÄin za zaobilaÅ¾enje ovih dozvola, ali uvek moÅ¾ete pokuÅ¡ati da **traÅ¾ite nove akreditive** na kompromitovanom hostu, **pronaÄ‘ete servisni kljuÄ** za generisanje OAuth tokena bez ograniÄenja ili **preÄ‘ete na drugi VM sa manje ograniÄenjima**.

Kada se koriste [pristupni opsezi](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), OAuth token koji se generiÅ¡e za raÄunarski instancu (VM) Ä‡e **imati** [**ograniÄenje opsega**](https://oauth.net/2/scope/) **ukljuÄeno**. MeÄ‘utim, moÅ¾da Ä‡ete moÄ‡i da **zaobiÄ‘ete** ovo ograniÄenje i iskoristite dozvole koje kompromitovani nalog ima.

**Najbolji naÄin zaobiÄ‘anja** ovog ograniÄenja je ili da **pronaÄ‘ete nove akreditive** na kompromitovanom hostu, da **pronaÄ‘ete servisni kljuÄ za generisanje OAuth tokena** bez ograniÄenja ili da **kompromitujete drugi VM sa manje ograniÄenjima**.

Proverite SA sa generisanim kljuÄevima pomoÄ‡u:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Tehnike eskalacije privilegija

NaÄin da eskalirate svoje privilegije u AWS-u je da imate dovoljno dozvola da moÅ¾ete, na neki naÄin, pristupiti privilegijama drugih servisnih naloga/korisnika/grupa. Povezivanje eskalacija dok ne dobijete administratorski pristup organizaciji.

{% hint style="warning" %}
GCP ima **stotine** (ako ne i hiljade) **dozvola** koje entitet moÅ¾e dobiti. U ovoj knjizi moÅ¾ete pronaÄ‡i **sve dozvole koje znam** da moÅ¾ete zloupotrebiti za **eskalciju privilegija**, ali ako **znate neki drugi put** koji nije naveden ovde, **molimo vas da ga podelite**.
{% endhint %}

**Podstranice ove sekcije su poreÄ‘ane po servisima. Na svakom servisu moÅ¾ete pronaÄ‡i razliÄite naÄine eskalacije privilegija na servisima.**

### Zloupotreba GCP-a za eskalaciju privilegija lokalno

Ako ste unutar maÅ¡ine u GCP-u, moÅ¾da Ä‡ete moÄ‡i zloupotrebiti dozvole da eskalirate privilegije Äak i lokalno:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Reference

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
