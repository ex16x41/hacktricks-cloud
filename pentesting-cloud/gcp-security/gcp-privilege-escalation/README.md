# GCP - Privilegieneskalation

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Einf√ºhrung in GCP Privilegieneskalation <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP hat, wie jede andere Cloud, einige **Prinzipien**: Benutzer, Gruppen und Dienstkonten sowie einige **Ressourcen** wie Compute Engine, Cloud Functions‚Ä¶\
Dann werden √ºber Rollen **Berechtigungen diesen Prinzipien √ºber die Ressourcen gew√§hrt**. Dies ist der Weg, um die Berechtigungen, die ein Prinzip √ºber eine Ressource in GCP hat, zu spezifizieren.\
Es gibt bestimmte Berechtigungen, die es einem Benutzer erm√∂glichen, **noch mehr Berechtigungen** √ºber die Ressource oder Drittanbieter-Ressourcen zu erhalten, und das nennt man **Privilegieneskalation** (auch die Ausnutzung von Schwachstellen, um mehr Berechtigungen zu erhalten).

Daher m√∂chte ich die Techniken zur Privilegieneskalation in GCP in **2 Gruppen** unterteilen:

* **Privesc zu einem Prinzip**: Dies erm√∂glicht es dir, **ein anderes Prinzip zu impersonifizieren** und somit wie es mit all seinen Berechtigungen zu handeln. z.B.: Missbrauch von _getAccessToken_, um ein Dienstkonto zu impersonifizieren.
* **Privesc auf der Ressource**: Dies erm√∂glicht es dir, **mehr Berechtigungen √ºber die spezifische Ressource zu erhalten**. z.B.: Du kannst die Berechtigung _setIamPolicy_ √ºber Cloud Functions missbrauchen, um die Funktion auszul√∂sen.
* Beachte, dass einige **Ressourcenberechtigungen dir auch erlauben, ein beliebiges Dienstkonto** an die Ressource anzuh√§ngen. Das bedeutet, dass du eine Ressource mit einem SA starten, in die Ressource gelangen und **das SA-Token stehlen** kannst. Daher wird dies erm√∂glichen, √ºber eine Ressourcenskalation zu einem Prinzip zu eskalieren. Dies ist in mehreren Ressourcen zuvor passiert, aber jetzt ist es weniger h√§ufig (kann aber immer noch passieren).

Offensichtlich sind die interessantesten Techniken zur Privilegieneskalation die der **zweiten Gruppe**, da sie es dir erm√∂glichen, **mehr Privilegien au√üerhalb der Ressourcen zu erhalten, √ºber die du bereits einige Privilegien hast**. Beachte jedoch, dass **Eskalation in Ressourcen** dir auch Zugang zu **sensiblen Informationen** oder sogar zu **anderen Prinzipien** geben kann (vielleicht durch das Lesen eines Geheimnisses, das ein Token eines SA enth√§lt).

{% hint style="warning" %}
Es ist auch wichtig zu beachten, dass in **GCP Dienstkonten sowohl Prinzipien als auch Berechtigungen sind**, sodass das Eskalieren von Berechtigungen in einem SA es dir auch erm√∂glicht, es zu impersonifizieren.
{% endhint %}

{% hint style="info" %}
Die Berechtigungen in Klammern geben die Berechtigungen an, die ben√∂tigt werden, um die Schwachstelle mit `gcloud` auszunutzen. Diese k√∂nnten nicht ben√∂tigt werden, wenn sie √ºber die API ausgenutzt werden.
{% endhint %}

## Berechtigungen f√ºr die Methodik zur Privilegieneskalation

So **teste ich spezifische Berechtigungen**, um spezifische Aktionen innerhalb von GCP durchzuf√ºhren.

1. Lade das GitHub-Repo [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts) herunter.
2. F√ºge im Verzeichnis tests/ das neue Skript hinzu.

## Umgehung von Zugriffsscoping <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokens von SA, die aus dem GCP-Metadatenservice geleakt wurden, haben **Zugriffsscoping**. Dies sind **Einschr√§nkungen** auf die **Berechtigungen**, die das Token hat. Zum Beispiel, wenn das Token den **`https://www.googleapis.com/auth/cloud-platform`** Scope hat, hat es **vollen Zugriff** auf alle GCP-Dienste. Wenn das Token jedoch den **`https://www.googleapis.com/auth/cloud-platform.read-only`** Scope hat, hat es nur **schreibgesch√ºtzten Zugriff** auf alle GCP-Dienste, selbst wenn das SA mehr Berechtigungen in IAM hat.

Es gibt keinen direkten Weg, diese Berechtigungen zu umgehen, aber du k√∂nntest immer versuchen, nach **neuen Anmeldeinformationen** im kompromittierten Host zu suchen, **den Dienstschl√ºssel zu finden**, um ein OAuth-Token ohne Einschr√§nkungen zu generieren oder **zu einer anderen VM mit weniger Einschr√§nkungen zu springen**.

Wenn [Zugriffsscoping](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) verwendet wird, wird das OAuth-Token, das f√ºr die Compute-Instanz (VM) generiert wird, **eine** [**Scope**](https://oauth.net/2/scope/) **Einschr√§nkung enthalten**. Du k√∂nntest jedoch in der Lage sein, diese Einschr√§nkung zu **umgehen** und die Berechtigungen, die das kompromittierte Konto hat, auszunutzen.

Der **beste Weg, diese Einschr√§nkung zu umgehen**, besteht entweder darin, **neue Anmeldeinformationen** im kompromittierten Host zu finden, den **Dienstschl√ºssel zu finden, um ein OAuth-Token** ohne Einschr√§nkungen zu generieren oder **eine andere VM mit einem weniger eingeschr√§nkten SA zu kompromittieren**.

√úberpr√ºfe SA mit Schl√ºsseln, die generiert wurden mit:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Privilegieneskalationstechniken

Der Weg, um Ihre Berechtigungen in AWS zu eskalieren, besteht darin, gen√ºgend Berechtigungen zu haben, um auf die Berechtigungen anderer Dienstkonten/Nutzer/Gruppen zugreifen zu k√∂nnen. Ketteneskalationen, bis Sie Administratorzugriff auf die Organisation haben.

{% hint style="warning" %}
GCP hat **Hunderte** (wenn nicht Tausende) von **Berechtigungen**, die einer Entit√§t gew√§hrt werden k√∂nnen. In diesem Buch finden Sie **alle Berechtigungen, die ich kenne**, die Sie missbrauchen k√∂nnen, um **Berechtigungen zu eskalieren**, aber wenn Sie **einen Weg kennen**, der hier nicht erw√§hnt wird, **teilen Sie ihn bitte**.
{% endhint %}

**Die Unterseiten dieses Abschnitts sind nach Diensten geordnet. Sie finden auf jedem Dienst verschiedene M√∂glichkeiten, Berechtigungen auf den Diensten zu eskalieren.**

### Missbrauch von GCP zur lokalen Eskalation von Berechtigungen

Wenn Sie sich auf einer Maschine in GCP befinden, k√∂nnten Sie in der Lage sein, Berechtigungen zu missbrauchen, um Berechtigungen sogar lokal zu eskalieren:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referenzen

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks unterst√ºtzen</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
