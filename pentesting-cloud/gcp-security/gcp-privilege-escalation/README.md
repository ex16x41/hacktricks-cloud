# GCP - Yetki Yükseltme

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Bize katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi** **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking ipuçlarını paylaşarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

## GCP Yetki Yükseltmeye Giriş <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, diğer bulutlar gibi bazı **prensipler**: kullanıcılar, gruplar ve hizmet hesapları ile bazı **kaynaklar**: hesaplama motoru, bulut fonksiyonları…\
Sonra, roller aracılığıyla, **bu prensiplere kaynaklar üzerinde izinler verilir**. Bu, GCP'de bir prensibin bir kaynak üzerindeki izinlerini belirtmenin yoludur.\
Kullanıcının bir kaynak veya üçüncü taraf kaynaklar üzerinde **daha fazla izin almasına** olanak tanıyan belirli izinler vardır ve buna **yetki yükseltme** denir (ayrıca, daha fazla izin almak için zafiyetlerin istismar edilmesi).

Bu nedenle, GCP yetki yükseltme tekniklerini **2 gruba** ayırmak istiyorum:

* **Bir prensibe yetki yükseltme**: Bu, **başka bir prensibi taklit etmenizi** sağlar ve dolayısıyla onun tüm izinleriyle hareket edersiniz. Örneğin: Bir hizmet hesabını taklit etmek için _getAccessToken_ kullanmak.
* **Kaynak üzerinde yetki yükseltme**: Bu, **belirli bir kaynak üzerinde daha fazla izin almanızı** sağlar. Örneğin: Bulut fonksiyonlarını tetiklemek için _setIamPolicy_ iznini kötüye kullanabilirsiniz.
* Bazı **kaynak izinleri, bir hizmet hesabını** kaynağa eklemenize de olanak tanır. Bu, bir SA ile bir kaynak başlatabileceğiniz, kaynağa girebileceğiniz ve **SA token'ını çalabileceğiniz** anlamına gelir. Bu nedenle, bu, bir kaynak yükseltmesi aracılığıyla bir prensibe yükselmenizi sağlar. Daha önce birçok kaynakta bu gerçekleşti, ancak şimdi daha az sıklıkla (ama hala olabilir).

Açıkça, en ilginç yetki yükseltme teknikleri **ikinci gruptaki** tekniklerdir çünkü bu, **zaten bazı izinlere sahip olduğunuz kaynakların dışındaki daha fazla ayrıcalık elde etmenizi** sağlar. Ancak, **kaynaklarda yükselmenin** size **hassas bilgilere** veya hatta **diğer prensiplere** (belki bir SA'nın token'ını içeren bir sırrı okuyarak) erişim verebileceğini unutmayın.

{% hint style="warning" %}
Ayrıca, **GCP'de Hizmet Hesapları hem prensipler hem de izinlerdir**, bu nedenle bir SA'da yetki yükseltmek, onu taklit etmenizi de sağlar.
{% endhint %}

{% hint style="info" %}
Parantez içindeki izinler, zafiyeti `gcloud` ile istismar etmek için gereken izinleri gösterir. API aracılığıyla istismar ediliyorsa bunlar gerekli olmayabilir.
{% endhint %}

## Yetki Yükseltme Metodolojisi için İzinler

Bu, GCP içinde belirli eylemleri gerçekleştirmek için **belirli izinleri test etme** şeklimdir.

1. Github reposunu indirin [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. tests/ dizinine yeni script ekleyin

## Erişim Kapsamlarını Aşma <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

GCP meta veri hizmetinden sızan SA token'ları **erişim kapsamlarına** sahiptir. Bunlar, token'ın sahip olduğu **izinler** üzerinde **kısıtlamalardır**. Örneğin, token **`https://www.googleapis.com/auth/cloud-platform`** kapsamına sahipse, tüm GCP hizmetlerine **tam erişim** olacaktır. Ancak, token **`https://www.googleapis.com/auth/cloud-platform.read-only`** kapsamına sahipse, SA'nın IAM'de daha fazla izni olsa bile, tüm GCP hizmetlerine yalnızca **salt okunur erişim** olacaktır.

Bu izinleri aşmanın doğrudan bir yolu yoktur, ancak her zaman **kompromize edilmiş hostta yeni kimlik bilgileri** aramayı, **kısıtlama olmadan bir OAuth token'ı oluşturmak için hizmet anahtarını bulmayı** veya **daha az kısıtlı bir VM'ye atlamayı** deneyebilirsiniz.

[erişim kapsamları](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) kullanıldığında, hesaplama örnemi (VM) için oluşturulan OAuth token'ı **bir** [**kapsam**](https://oauth.net/2/scope/) **kısıtlaması içerir**. Ancak, bu kısıtlamayı **aşabilir** ve kompromize edilmiş hesabın sahip olduğu izinleri istismar edebilirsiniz.

Bu kısıtlamayı aşmanın **en iyi yolu**, ya **kompromize edilmiş hostta yeni kimlik bilgileri bulmak**, ya **kısıtlama olmadan bir OAuth token'ı oluşturmak için hizmet anahtarını bulmak** ya da **daha az kısıtlı bir SA ile farklı bir VM'yi ele geçirmek** olacaktır.

Anahtarları ile SA'yı kontrol edin:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Yetki Yükseltme Teknikleri

AWS'de yetkilerinizi yükseltmenin yolu, diğer hizmet hesaplarının/kullanıcılarının/gruplarının yetkilerine erişebilecek kadar izne sahip olmaktır. Yükseltmeleri zincirleme yaparak organizasyon üzerinde yönetici erişimi elde etmek.

{% hint style="warning" %}
GCP'nin bir varlığa verilebilecek **yüzlerce** (binlerce değilse) **izni** vardır. Bu kitapta, **yetki yükseltmek için kötüye kullanabileceğiniz** **tüm izinleri** bulabilirsiniz, ancak burada belirtilmeyen **bir yol biliyorsanız**, **lütfen paylaşın**.
{% endhint %}

**Bu bölümün alt sayfaları hizmetlere göre sıralanmıştır. Her hizmette, hizmetler üzerinde yetki yükseltmenin farklı yollarını bulabilirsiniz.**

### GCP'yi yerel olarak yetki yükseltmek için kötüye kullanma

Eğer GCP'de bir makinenin içindeyseniz, yerel olarak yetkileri yükseltmek için izinleri kötüye kullanma imkanınız olabilir:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referanslar

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
