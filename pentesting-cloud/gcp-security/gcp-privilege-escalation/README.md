# GCP - Privilege Escalation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Introduction to GCP Privilege Escalation <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, jak każda inna chmura, ma pewne **zasady**: użytkownicy, grupy i konta serwisowe, oraz pewne **zasoby** takie jak silnik obliczeniowy, funkcje chmurowe…\
Następnie, poprzez role, **uprawnienia są przyznawane tym zasadom nad zasobami**. To jest sposób na określenie uprawnień, jakie zasada ma nad zasobą w GCP.\
Istnieją pewne uprawnienia, które pozwolą użytkownikowi **uzyskać jeszcze więcej uprawnień** nad zasobą lub zasobami osób trzecich, i to nazywa się **eskalacją uprawnień** (także, wykorzystanie luk w zabezpieczeniach, aby uzyskać więcej uprawnień).

Dlatego chciałbym podzielić techniki eskalacji uprawnień w GCP na **2 grupy**:

* **Eskalacja do zasady**: To pozwoli ci **udawać inną zasadę**, a tym samym działać jak ona ze wszystkimi jej uprawnieniami. np.: Wykorzystanie _getAccessToken_ do udawania konta serwisowego.
* **Eskalacja nad zasobem**: To pozwoli ci **uzyskać więcej uprawnień nad konkretną zasobą**. np.: możesz wykorzystać uprawnienie _setIamPolicy_ nad cloudfunctions, aby umożliwić sobie wywołanie funkcji.
* Zauważ, że niektóre **uprawnienia zasobów również pozwolą ci dołączyć dowolne konto serwisowe** do zasoby. Oznacza to, że będziesz mógł uruchomić zasobę z SA, dostać się do zasoby i **ukraść token SA**. Dlatego to pozwoli na eskalację do zasady poprzez eskalację zasobów. To zdarzyło się w kilku zasobach wcześniej, ale teraz jest mniej powszechne (ale nadal może się zdarzyć).

Oczywiście, najbardziej interesujące techniki eskalacji uprawnień to te z **drugiej grupy**, ponieważ pozwolą ci **uzyskać więcej uprawnień poza zasobami, nad którymi już masz** pewne uprawnienia. Jednak zauważ, że **eskalacja w zasobach** może również dać ci dostęp do **wrażliwych informacji** lub nawet do **innych zasad** (może poprzez odczytanie sekretu, który zawiera token SA).

{% hint style="warning" %}
Ważne jest również, aby zauważyć, że w **GCP konta serwisowe są zarówno zasadami, jak i uprawnieniami**, więc eskalacja uprawnień w SA pozwoli ci również na jego udawanie.
{% endhint %}

{% hint style="info" %}
Uprawnienia w nawiasach wskazują na uprawnienia potrzebne do wykorzystania luki za pomocą `gcloud`. Mogą nie być potrzebne, jeśli wykorzystujesz to przez API.
{% endhint %}

## Permissions for Privilege Escalation Methodology

To jest sposób, w jaki **testuję konkretne uprawnienia** do wykonywania konkretnych działań w GCP.

1. Pobierz repozytorium github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Dodaj w tests/ nowy skrypt

## Bypassing access scopes <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokeny SA wyciekające z usługi metadanych GCP mają **zakresy dostępu**. Są to **ograniczenia** dotyczące **uprawnień**, które ma token. Na przykład, jeśli token ma zakres **`https://www.googleapis.com/auth/cloud-platform`**, będzie miał **pełny dostęp** do wszystkich usług GCP. Jednak jeśli token ma zakres **`https://www.googleapis.com/auth/cloud-platform.read-only`**, będzie miał tylko **dostęp tylko do odczytu** do wszystkich usług GCP, nawet jeśli SA ma więcej uprawnień w IAM.

Nie ma bezpośredniego sposobu na obejście tych uprawnień, ale zawsze możesz spróbować poszukać **nowych poświadczeń** w skompromitowanym hoście, **znaleźć klucz usługi** do wygenerowania tokena OAuth bez ograniczeń lub **przejść do innej VM mniej ograniczonej**.

Gdy używane są [zakresy dostępu](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), token OAuth, który jest generowany dla instancji obliczeniowej (VM), będzie **miał** [**ograniczenie**](https://oauth.net/2/scope/) **zakresu** włączone. Jednak możesz być w stanie **obejść** to ograniczenie i wykorzystać uprawnienia, które ma skompromitowane konto.

**Najlepszym sposobem na obejście** tego ograniczenia jest albo **znalezienie nowych poświadczeń** w skompromitowanym hoście, **znalezienie klucza usługi do wygenerowania tokena OAuth** bez ograniczeń lub **skompromitowanie innej VM z SA mniej ograniczonym**.

Sprawdź SA z kluczami wygenerowanymi za pomocą:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Techniki eskalacji uprawnień

Sposobem na eskalację swoich uprawnień w AWS jest posiadanie wystarczających uprawnień, aby w jakiś sposób uzyskać dostęp do uprawnień innych kont usługowych/użytkowników/grup. Łączenie eskalacji, aż uzyskasz dostęp administratora do organizacji.

{% hint style="warning" %}
GCP ma **setki** (jeśli nie tysiące) **uprawnień**, które mogą być przyznane podmiotowi. W tej książce znajdziesz **wszystkie uprawnienia, które znam**, które możesz wykorzystać do **eskalacji uprawnień**, ale jeśli **znasz jakąś ścieżkę**, która nie została tutaj wymieniona, **proszę podziel się nią**.
{% endhint %}

**Podstrony tej sekcji są uporządkowane według usług. Na każdej usłudze znajdziesz różne sposoby na eskalację uprawnień w tych usługach.**

### Wykorzystywanie GCP do lokalnej eskalacji uprawnień

Jeśli jesteś wewnątrz maszyny w GCP, możesz być w stanie wykorzystać uprawnienia do eskalacji uprawnień nawet lokalnie:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Odniesienia

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Ucz się i ćwicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz się i ćwicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się trikami hackingowymi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na githubie.

</details>
{% endhint %}
