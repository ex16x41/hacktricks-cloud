# GCP - Eskalacja uprawnie

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Wprowadzenie do Eskalacji Uprawnie w GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, podobnie jak ka偶da inna chmura, posiada **podmioty**: u偶ytkownik贸w, grupy i konta usug oraz pewne **zasoby** takie jak maszyny obliczeniowe, funkcje chmury...\
Nastpnie, za pomoc r贸l, **nadawane s uprawnienia tym podmiotom do zasob贸w**. To jest spos贸b okrelania uprawnie, jakie podmiot ma do zasobu w GCP.\
Istniej pewne uprawnienia, kt贸re pozwol u偶ytkownikowi **uzyska jeszcze wicej uprawnie** do zasobu lub zasob贸w os贸b trzecich, i to jest to, co nazywane jest **eskalacj uprawnie** (oraz wykorzystaniem podatnoci do uzyskania wikszej liczby uprawnie).

Dlatego chciabym podzieli techniki eskalacji uprawnie w GCP na **2 grupy**:

* **Eskalacja do podmiotu**: Pozwoli ci to **podawa si za innego podmiotu**, a wic dziaa jak on ze wszystkimi jego uprawnieniami. np.: Nadu偶yj _getAccessToken_ aby poda si za konto usugi.
* **Eskalacja na zasobie**: Pozwoli ci to **uzyska wicej uprawnie do konkretnego zasobu**. np.: mo偶esz nadu偶y uprawnienia _setIamPolicy_ w cloudfunctions, aby umo偶liwi wywoanie funkcji.
* Zauwa偶, 偶e niekt贸re **uprawnienia zasob贸w pozwol ci r贸wnie偶 przypisa dowolne konto usugi** do zasobu. Oznacza to, 偶e bdziesz m贸g uruchomi zas贸b z kontem usugi, wej do zasobu i **ukra token konta usugi**. Dlatego pozwoli to na eskalacj do podmiotu poprzez eskalacj zasobu. Zdarzao si to w przypadku kilku zasob贸w wczeniej, ale teraz jest to mniej powszechne (ale nadal mo偶liwe).

Oczywicie najbardziej interesujce techniki eskalacji uprawnie to te z **drugiej grupy**, poniewa偶 pozwol ci **uzyska wicej uprawnie poza zasobami, nad kt贸rymi ju偶 masz pewne uprawnienia**. Jednak zauwa偶, 偶e **eskaluacja w zasobach** mo偶e da ci r贸wnie偶 dostp do **wra偶liwych informacji** lub nawet do **innych podmiot贸w** (mo偶e to by poprzez odczytanie tajemnicy zawierajcej token konta usugi).

{% hint style="warning" %}
Warto r贸wnie偶 zauwa偶y, 偶e w **kontach usug GCP s zar贸wno podmioty, jak i uprawnienia**, wic eskalacja uprawnie w koncie usugi pozwoli ci r贸wnie偶 na podawanie si za nie.
{% endhint %}

{% hint style="info" %}
Uprawnienia w nawiasach wskazuj uprawnienia potrzebne do wykorzystania podatnoci za pomoc `gcloud`. Mog one nie by potrzebne, jeli wykorzystasz to za pomoc interfejsu API.
{% endhint %}

## Uprawnienia dla Metodologii Eskalacji Uprawnie

Tak przeprowadzam **testy dla konkretnych uprawnie** w celu wykonania okrelonych dziaa w GCP.

1. Pobierz repozytorium github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Dodaj nowy skrypt w tests/

## Omijanie zakres贸w dostpu <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokeny kont usug wyciekajce z usugi metadanych GCP maj **zakresy dostpu**. S to **ograniczenia** dotyczce **uprawnie**, jakie ma token. Na przykad, jeli token ma zakres **`https://www.googleapis.com/auth/cloud-platform`**, bdzie mia **peny dostp** do wszystkich usug GCP. Jednak jeli token ma zakres **`https://www.googleapis.com/auth/cloud-platform.read-only`**, bdzie mia tylko **dostp tylko do odczytu** do wszystkich usug GCP, nawet jeli konto usugi ma wicej uprawnie w IAM.

Nie ma bezporedniego sposobu na obejcie tych uprawnie, ale zawsze mo偶esz spr贸bowa szuka **nowych powiadcze** w skompromitowanym hocie, **znale藕 klucz usugi** do wygenerowania tokenu OAuth bez ogranicze lub **przej do innego mniej ograniczonego VM**.

Kiedy s u偶ywane [zakresy dostpu](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), token OAuth generowany dla instancji obliczeniowej (VM) bdzie **zawiera ograniczenie zakresu**. Jednak mo偶esz by w stanie **obej** to ograniczenie i wykorzysta uprawnienia, jakie ma skompromitowane konto.

Najlepszym sposobem na **obejcie** tego ograniczenia jest albo **znalezienie nowych powiadcze** w skompromitowanym hocie, **znalezienie klucza usugi do wygenerowania tokenu OAuth** bez ogranicze lub **skompromitowanie innego VM z mniej ograniczonym kontem usugi**.

Sprawd藕 konto usugi z wygenerowanymi kluczami za pomoc:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Techniki eskalacji uprawnie

Sposobem na eskalacj uprawnie w AWS jest posiadanie wystarczajcych uprawnie, aby w jaki spos贸b uzyska dostp do uprawnie innych kont/usug/grup. czenie eskalacji a偶 do uzyskania dostpu administratora do organizacji.

{% hint style="warning" %}
GCP ma **setki** (jeli nie tysice) **uprawnie**, kt贸re podmiot mo偶e otrzyma. W tej ksi偶ce znajdziesz **wszystkie uprawnienia, kt贸re znam**, kt贸rych mo偶na nadu偶y do **eskaltacji uprawnie**, ale jeli znasz jakie cie偶ki, kt贸re tutaj nie zostay wymienione, **prosz si nimi podzieli**.
{% endhint %}

**Podstrony tej sekcji s uporzdkowane wedug usug. Na ka偶dej usudze znajdziesz r贸偶ne sposoby eskalacji uprawnie.**

### Nadu偶ywanie GCP do eskalacji uprawnie lokalnie

Jeli jeste wewntrz maszyny w GCP, mo偶esz by w stanie nadu偶y uprawnie do eskalacji uprawnie nawet lokalnie:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Odnoniki

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Dowiedz si i wicz Hacking w AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking w GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
