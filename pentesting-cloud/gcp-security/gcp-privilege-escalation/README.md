# GCP - Escalaci√≥n de Privilegios

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Introducci√≥n a la Escalaci√≥n de Privilegios en GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, como cualquier otra nube, tiene algunos **principales**: usuarios, grupos y cuentas de servicio, y algunos **recursos** como compute engine, cloud functions‚Ä¶\
Luego, a trav√©s de roles, **se otorgan permisos a esos principales sobre los recursos**. Esta es la forma de especificar los permisos que un principal tiene sobre un recurso en GCP.\
Hay ciertos permisos que permitir√°n a un usuario **obtener a√∫n m√°s permisos** sobre el recurso o recursos de terceros, y eso es lo que se llama **escalaci√≥n de privilegios** (tambi√©n, la explotaci√≥n de vulnerabilidades para obtener m√°s permisos).

Por lo tanto, me gustar√≠a separar las t√©cnicas de escalaci√≥n de privilegios en GCP en **2 grupos**:

* **Privesc a un principal**: Esto te permitir√° **suplantar a otro principal**, y por lo tanto actuar como √©l con todos sus permisos. p.ej.: Abusar de _getAccessToken_ para suplantar una cuenta de servicio.
* **Privesc sobre el recurso**: Esto te permitir√° **obtener m√°s permisos sobre el recurso espec√≠fico**. p.ej.: puedes abusar del permiso _setIamPolicy_ sobre cloudfunctions para permitirte activar la funci√≥n.
* Ten en cuenta que algunos **permisos de recursos tambi√©n te permitir√°n adjuntar una cuenta de servicio arbitraria** al recurso. Esto significa que podr√°s lanzar un recurso con un SA, entrar en el recurso y **robar el token del SA**. Por lo tanto, esto permitir√° escalar a un principal a trav√©s de una escalaci√≥n de recursos. Esto ha sucedido en varios recursos anteriormente, pero ahora es menos frecuente (pero a√∫n puede suceder).

Obviamente, las t√©cnicas de escalaci√≥n de privilegios m√°s interesantes son las del **segundo grupo** porque te permitir√°n **obtener m√°s privilegios fuera de los recursos sobre los que ya tienes** algunos privilegios. Sin embargo, ten en cuenta que **escalar en recursos** tambi√©n puede darte acceso a **informaci√≥n sensible** o incluso a **otros principales** (quiz√°s a trav√©s de la lectura de un secreto que contiene un token de un SA).

{% hint style="warning" %}
Es importante notar tambi√©n que en **GCP las Cuentas de Servicio son tanto principales como permisos**, por lo que escalar privilegios en un SA tambi√©n te permitir√° suplantarlo.
{% endhint %}

{% hint style="info" %}
Los permisos entre par√©ntesis indican los permisos necesarios para explotar la vulnerabilidad con `gcloud`. Esos pueden no ser necesarios si se explota a trav√©s de la API.
{% endhint %}

## Permisos para la Metodolog√≠a de Escalaci√≥n de Privilegios

As√≠ es como **pruebo permisos espec√≠ficos** para realizar acciones espec√≠ficas dentro de GCP.

1. Descarga el repositorio de github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp_privesc_scripts)
2. Agrega en tests/ el nuevo script

## Eludir los alcances de acceso <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Los tokens de SA filtrados del servicio de metadatos de GCP tienen **alcances de acceso**. Estas son **restricciones** sobre los **permisos** que tiene el token. Por ejemplo, si el token tiene el **`https://www.googleapis.com/auth/cloud-platform`** alcance, tendr√° **acceso total** a todos los servicios de GCP. Sin embargo, si el token tiene el **`https://www.googleapis.com/auth/cloud-platform.read-only`** alcance, solo tendr√° **acceso de solo lectura** a todos los servicios de GCP incluso si el SA tiene m√°s permisos en IAM.

No hay una forma directa de eludir estos permisos, pero siempre podr√≠as intentar buscar **nuevas credenciales** en el host comprometido, **encontrar la clave del servicio** para generar un token OAuth sin restricciones o **saltar a una VM diferente menos restringida**.

Cuando se utilizan [alcances de acceso](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), el token OAuth que se genera para la instancia de computaci√≥n (VM) **tendr√° una** [**limitaci√≥n de alcance**](https://oauth.net/2/scope/) **incluida**. Sin embargo, podr√≠as ser capaz de **eludir** esta limitaci√≥n y explotar los permisos que tiene la cuenta comprometida.

La **mejor manera de eludir** esta restricci√≥n es encontrar **nuevas credenciales** en el host comprometido, **encontrar la clave del servicio para generar un token OAuth** sin restricciones o **comprometer una VM diferente con un SA menos restringido**.

Verifica SA con claves generadas con:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## T√©cnicas de Escalaci√≥n de Privilegios

La forma de escalar tus privilegios en AWS es tener suficientes permisos para poder, de alguna manera, acceder a los privilegios de otras cuentas de servicio/usuarios/grupos. Encadenar escalaciones hasta que tengas acceso de administrador sobre la organizaci√≥n.

{% hint style="warning" %}
GCP tiene **cientos** (si no miles) de **permisos** que se pueden otorgar a una entidad. En este libro puedes encontrar **todos los permisos que conozco** que puedes abusar para **escalar privilegios**, pero si **conoces alg√∫n camino** no mencionado aqu√≠, **por favor comp√°rtelo**.
{% endhint %}

**Las subp√°ginas de esta secci√≥n est√°n ordenadas por servicios. Puedes encontrar en cada servicio diferentes formas de escalar privilegios en los servicios.**

### Abusando de GCP para escalar privilegios localmente

Si est√°s dentro de una m√°quina en GCP, podr√≠as ser capaz de abusar de los permisos para escalar privilegios incluso localmente:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referencias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
