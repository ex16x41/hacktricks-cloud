# GCP - Privilege Escalation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Introduction to GCP Privilege Escalation <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, όπως κάθε άλλο cloud, έχει κάποιες **αρχές**: χρήστες, ομάδες και λογαριασμούς υπηρεσιών, και κάποιους **πόρους** όπως compute engine, cloud functions…\
Στη συνέχεια, μέσω ρόλων, **οι άδειες χορηγούνται σε αυτές τις αρχές πάνω στους πόρους**. Αυτή είναι η μέθοδος για να καθορίσετε τις άδειες που έχει μια αρχή πάνω σε έναν πόρο στο GCP.\
Υπάρχουν ορισμένες άδειες που θα επιτρέψουν σε έναν χρήστη να **αποκτήσει ακόμη περισσότερες άδειες** στον πόρο ή σε πόρους τρίτων, και αυτό ονομάζεται **privilege escalation** (επίσης, η εκμετάλλευση των ευπαθειών για να αποκτήσει περισσότερες άδειες).

Επομένως, θα ήθελα να χωρίσω τις τεχνικές privilege escalation του GCP σε **2 ομάδες**:

* **Privesc σε μια αρχή**: Αυτό θα σας επιτρέψει να **παριστάνετε μια άλλη αρχή**, και επομένως να ενεργείτε όπως αυτή με όλες τις άδειές της. π.χ.: Κατάχρηση _getAccessToken_ για να παριστάνετε έναν λογαριασμό υπηρεσίας.
* **Privesc στον πόρο**: Αυτό θα σας επιτρέψει να **αποκτήσετε περισσότερες άδειες πάνω στον συγκεκριμένο πόρο**. π.χ.: μπορείτε να καταχραστείτε την άδεια _setIamPolicy_ πάνω σε cloudfunctions για να σας επιτρέψει να ενεργοποιήσετε τη λειτουργία.
* Σημειώστε ότι ορισμένες **άδειες πόρων θα σας επιτρέψουν επίσης να επισυνάψετε έναν αυθαίρετο λογαριασμό υπηρεσίας** στον πόρο. Αυτό σημαίνει ότι θα μπορείτε να εκκινήσετε έναν πόρο με έναν SA, να εισέλθετε στον πόρο και να **κλέψετε το SA token**. Επομένως, αυτό θα επιτρέψει την κλιμάκωση σε μια αρχή μέσω μιας κλιμάκωσης πόρου. Αυτό έχει συμβεί σε αρκετούς πόρους στο παρελθόν, αλλά τώρα είναι λιγότερο συχνό (αλλά μπορεί να συμβεί ακόμα).

Προφανώς, οι πιο ενδιαφέρουσες τεχνικές κλιμάκωσης προνομίων είναι αυτές της **δεύτερης ομάδας** γιατί θα σας επιτρέψουν να **αποκτήσετε περισσότερα προνόμια εκτός από τους πόρους στους οποίους έχετε ήδη** κάποια προνόμια. Ωστόσο, σημειώστε ότι **η κλιμάκωση στους πόρους** μπορεί επίσης να σας δώσει πρόσβαση σε **ευαίσθητες πληροφορίες** ή ακόμη και σε **άλλες αρχές** (ίσως μέσω της ανάγνωσης ενός μυστικού που περιέχει ένα token ενός SA).

{% hint style="warning" %}
Είναι σημαντικό να σημειωθεί επίσης ότι στις **GCP οι Λογαριασμοί Υπηρεσιών είναι και αρχές και άδειες**, οπότε η κλιμάκωση προνομίων σε έναν SA θα σας επιτρέψει να τον παριστάνετε επίσης.
{% endhint %}

{% hint style="info" %}
Οι άδειες μέσα σε παρενθέσεις υποδεικνύουν τις άδειες που απαιτούνται για να εκμεταλλευτείτε την ευπάθεια με το `gcloud`. Αυτές μπορεί να μην είναι απαραίτητες αν την εκμεταλλευτείτε μέσω του API.
{% endhint %}

## Permissions for Privilege Escalation Methodology

Αυτός είναι ο τρόπος που **δοκιμάζω για συγκεκριμένες άδειες** για να εκτελέσω συγκεκριμένες ενέργειες μέσα στο GCP.

1. Κατεβάστε το github repo [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Προσθέστε στα tests/ το νέο σενάριο

## Bypassing access scopes <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Τα tokens του SA που διαρρέουν από την υπηρεσία μεταδεδομένων του GCP έχουν **access scopes**. Αυτές είναι **περιορισμοί** στις **άδειες** που έχει το token. Για παράδειγμα, αν το token έχει το **`https://www.googleapis.com/auth/cloud-platform`** scope, θα έχει **πλήρη πρόσβαση** σε όλες τις υπηρεσίες GCP. Ωστόσο, αν το token έχει το **`https://www.googleapis.com/auth/cloud-platform.read-only`** scope, θα έχει μόνο **πρόσβαση μόνο για ανάγνωση** σε όλες τις υπηρεσίες GCP ακόμη και αν ο SA έχει περισσότερες άδειες στο IAM.

Δεν υπάρχει άμεσος τρόπος να παρακαμφθούν αυτές οι άδειες, αλλά μπορείτε πάντα να προσπαθήσετε να αναζητήσετε **νέες διαπιστεύσεις** στον παραβιασμένο υπολογιστή, **να βρείτε το κλειδί υπηρεσίας** για να δημιουργήσετε ένα OAuth token χωρίς περιορισμούς ή **να μεταπηδήσετε σε μια διαφορετική VM με λιγότερους περιορισμούς**.

Όταν χρησιμοποιούνται [access scopes](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), το OAuth token που δημιουργείται για την υπολογιστική μονάδα (VM) θα **έχει έναν** [**περιορισμό**](https://oauth.net/2/scope/) **scope** συμπεριλαμβανομένο. Ωστόσο, μπορεί να είστε σε θέση να **παρακάμψετε** αυτόν τον περιορισμό και να εκμεταλλευτείτε τις άδειες που έχει ο παραβιασμένος λογαριασμός.

Ο **καλύτερος τρόπος για να παρακάμψετε** αυτόν τον περιορισμό είναι είτε να **βρείτε νέες διαπιστεύσεις** στον παραβιασμένο υπολογιστή, να **βρείτε το κλειδί υπηρεσίας για να δημιουργήσετε ένα OAuth token** χωρίς περιορισμούς ή να **παραβιάσετε μια διαφορετική VM με έναν SA λιγότερο περιορισμένο**.

Ελέγξτε τον SA με κλειδιά που δημιουργήθηκαν με:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Τεχνικές Υπερβάθμισης Δικαιωμάτων

Ο τρόπος για να υπερβείτε τα δικαιώματά σας στο AWS είναι να έχετε αρκετές άδειες ώστε να μπορείτε, με κάποιον τρόπο, να αποκτήσετε πρόσβαση σε άλλες άδειες λογαριασμού υπηρεσίας/χρηστών/ομάδων. Συνδυάζοντας τις υπερβάθμισεις μέχρι να έχετε πρόσβαση διαχειριστή στην οργάνωση.

{% hint style="warning" %}
Το GCP έχει **εκατοντάδες** (αν όχι χιλιάδες) **άδειες** που μπορεί να παραχωρηθούν σε μια οντότητα. Σε αυτό το βιβλίο μπορείτε να βρείτε **όλες τις άδειες που γνωρίζω** που μπορείτε να εκμεταλλευτείτε για να **υπερβείτε τα δικαιώματα**, αλλά αν **γνωρίζετε κάποια διαδρομή** που δεν αναφέρεται εδώ, **παρακαλώ μοιραστείτε την**.
{% endhint %}

**Οι υποσελίδες αυτής της ενότητας είναι ταξινομημένες κατά υπηρεσίες. Μπορείτε να βρείτε σε κάθε υπηρεσία διαφορετικούς τρόπους για να υπερβείτε τα δικαιώματα στις υπηρεσίες.**

### Εκμετάλλευση του GCP για τοπική υπερβάθμιση δικαιωμάτων

Αν βρίσκεστε μέσα σε μια μηχανή στο GCP, μπορεί να μπορείτε να εκμεταλλευτείτε τις άδειες για να υπερβείτε τα δικαιώματα ακόμα και τοπικά:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Αναφορές

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
