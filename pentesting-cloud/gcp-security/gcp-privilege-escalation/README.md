# GCP - Privilege Escalation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Introduction to GCP Privilege Escalation <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, kama wingu lingine lolote, lina **misingi**: watumiaji, vikundi na akaunti za huduma, na **rasilimali** kama injini ya kompyuta, kazi za wingu‚Ä¶\
Kisha, kupitia majukumu, **idhini hutolewa kwa hao wakuu juu ya rasilimali**. Hii ndiyo njia ya kubainisha idhini ambazo mkuu ana juu ya rasilimali katika GCP.\
Kuna idhini fulani ambazo zitaruhusu mtumiaji **kupata idhini zaidi** juu ya rasilimali au rasilimali za watu wengine, na hiyo inaitwa **kuinua hadhi** (pia, matumizi ya udhaifu kupata idhini zaidi).

Kwa hivyo, ningependa kutenganisha mbinu za kuinua hadhi za GCP katika **makundi 2**:

* **Kuinua hadhi kwa mkuu**: Hii itakuruhusu **kujifanya kama mkuu mwingine**, na hivyo kutenda kama yeye kwa idhini zake zote. mfano: Tumia _getAccessToken_ kujifanya kama akaunti ya huduma.
* **Kuinua hadhi juu ya rasilimali**: Hii itakuruhusu **kupata idhini zaidi juu ya rasilimali maalum**. mfano: unaweza kutumia idhini ya _setIamPolicy_ juu ya kazi za wingu kukuruhusu kuanzisha kazi hiyo.
* Kumbuka kwamba baadhi ya **idhini za rasilimali pia zitakuruhusu kuunganisha akaunti ya huduma isiyo na mipaka** kwenye rasilimali. Hii inamaanisha kwamba utaweza kuzindua rasilimali na SA, kuingia kwenye rasilimali, na **kuiba token ya SA**. Kwa hivyo, hii itaruhusu kuinua hadhi kwa mkuu kupitia kuinua hadhi ya rasilimali. Hii imekuwa ikitokea katika rasilimali kadhaa hapo awali, lakini sasa ni nadra (lakini bado inaweza kutokea).

Kwa wazi, mbinu za kuinua hadhi zinazovutia zaidi ni zile za **kundi la pili** kwa sababu zitakuruhusu **kupata idhini zaidi nje ya rasilimali ambazo tayari una** baadhi ya idhini. Hata hivyo, kumbuka kwamba **kuinua hadhi katika rasilimali** kunaweza pia kukupa ufikiaji wa **habari nyeti** au hata kwa **wakuu wengine** (labda kupitia kusoma siri ambayo ina token ya SA).

{% hint style="warning" %}
Ni muhimu pia kutambua kwamba katika **GCP Akaunti za Huduma ni wakuu na idhini**, hivyo kuinua hadhi katika SA kutakuruhusu kujifanya kama hiyo pia.
{% endhint %}

{% hint style="info" %}
Idhini kati ya mabano zinaonyesha idhini zinazohitajika kutumia udhaifu na `gcloud`. Hizi zinaweza zisihitajike ikiwa unatumia kupitia API.
{% endhint %}

## Permissions for Privilege Escalation Methodology

Hii ndiyo jinsi ninavyofanya **jaribio la idhini maalum** ili kutekeleza vitendo maalum ndani ya GCP.

1. Pakua repo ya github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Ongeza katika tests/ script mpya

## Bypassing access scopes <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Token za SA zilizovuja kutoka huduma ya metadata ya GCP zina **mipaka ya ufikiaji**. Hizi ni **vizuizi** juu ya **idhini** ambazo token ina. Kwa mfano, ikiwa token ina **`https://www.googleapis.com/auth/cloud-platform`** mipaka, itakuwa na **ufikiaji kamili** kwa huduma zote za GCP. Hata hivyo, ikiwa token ina **`https://www.googleapis.com/auth/cloud-platform.read-only`** mipaka, itakuwa na **ufikiaji wa kusoma tu** kwa huduma zote za GCP hata kama SA ina idhini zaidi katika IAM.

Hakuna njia ya moja kwa moja ya kupita hizi idhini, lakini unaweza kila wakati kujaribu kutafuta **akidi mpya** katika mwenyeji aliyeathiriwa, **pata funguo za huduma** ili kuunda token ya OAuth bila vizuizi au **kuruka kwenye VM tofauti isiyo na vizuizi**.

Wakati [mipaka ya ufikiaji](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) zinapotumika, token ya OAuth ambayo inaundwa kwa ajili ya mfano wa kompyuta (VM) itakuwa **na** [**mipaka**](https://oauth.net/2/scope/) **iliyojumuishwa**. Hata hivyo, unaweza kuwa na uwezo wa **kupita** vizuizi hivi na kutumia idhini ambazo akaunti iliyoharibiwa ina.

Njia **bora ya kupita** vizuizi hivi ni ama **kupata akidi mpya** katika mwenyeji aliyeathiriwa, **kupata funguo za huduma ili kuunda token ya OAuth** bila vizuizi au **kuharibu VM tofauti na SA isiyo na vizuizi**.

Angalia SA na funguo zilizoundwa na:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Mbinu za Kukuza Haki

Njia ya kukuza haki zako katika AWS ni kuwa na ruhusa za kutosha ili, kwa namna fulani, kufikia haki za akaunti nyingine za huduma/katumiaji/makundi. Kuunganisha kukuza hadi uwe na ufikiaji wa admin juu ya shirika.

{% hint style="warning" %}
GCP ina **mamia** (ikiwa si maelfu) ya **ruhusa** ambazo chombo kinaweza kupewa. Katika kitabu hiki unaweza kupata **ruhusa zote ninazojua** ambazo unaweza kutumia vibaya ili **kukuza haki**, lakini ikiwa unajua **njia fulani** ambayo haijatajwa hapa, **tafadhali shiriki**.
{% endhint %}

**Kurasa ndogo za sehemu hii zimepangwa kwa huduma. Unaweza kupata kwenye kila huduma njia tofauti za kukuza haki kwenye huduma hizo.**

### Kutumia GCP vibaya kukuza haki za ndani

Ikiwa uko ndani ya mashine katika GCP unaweza kuwa na uwezo wa kutumia ruhusa kukuza haki hata ndani:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Marejeo

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Jifunze & fanya mazoezi ya AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **fuata** sisi kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za hacking kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
