# GCP - Privilege Escalation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Introduction to GCP Privilege Escalation <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, kao i svaka druga cloud platforma, ima neke **principale**: korisnike, grupe i servisne naloge, i neke **resurse** kao Å¡to su compute engine, cloud functionsâ€¦\
Zatim, putem uloga, **dozvole se dodeljuju tim principima nad resursima**. Ovo je naÄin da se specificiraju dozvole koje princip ima nad resursom u GCP-u.\
Postoje odreÄ‘ene dozvole koje Ä‡e omoguÄ‡iti korisniku da **dobije joÅ¡ viÅ¡e dozvola** na resursu ili resursima treÄ‡ih strana, i to se naziva **privilege escalation** (takoÄ‘e, iskoriÅ¡Ä‡avanje ranjivosti za dobijanje viÅ¡e dozvola).

Stoga, Å¾eleo bih da podelim tehnike eskalacije privilegija u GCP-u u **2 grupe**:

* **Privesc ka principu**: Ovo Ä‡e vam omoguÄ‡iti da **imitujeÅ¡ drugi princip**, i stoga delujete kao on sa svim njegovim dozvolama. npr.: Zloupotreba _getAccessToken_ za imitaciju servisnog naloga.
* **Privesc na resursu**: Ovo Ä‡e vam omoguÄ‡iti da **dobijete viÅ¡e dozvola nad specifiÄnim resursom**. npr.: moÅ¾ete zloupotrebiti _setIamPolicy_ dozvolu nad cloudfunctions da biste omoguÄ‡ili pokretanje funkcije.
* Imajte na umu da neke **dozvole resursa Ä‡e vam takoÄ‘e omoguÄ‡iti da poveÅ¾ete proizvoljni servisni nalog** sa resursom. To znaÄi da Ä‡ete moÄ‡i da pokrenete resurs sa SA, uÄ‘ete u resurs i **ukradete SA token**. Stoga, ovo Ä‡e omoguÄ‡iti eskalaciju ka principu putem eskalacije resursa. Ovo se ranije deÅ¡avalo na nekoliko resursa, ali sada je reÄ‘e (ali se i dalje moÅ¾e desiti).

OÄigledno, najzanimljivije tehnike eskalacije privilegija su one iz **druge grupe** jer Ä‡e vam omoguÄ‡iti da **dobijete viÅ¡e privilegija van resursa nad kojima veÄ‡ imate** neke privilegije. MeÄ‘utim, imajte na umu da **eskalacija u resursima** moÅ¾e takoÄ‘e dati pristup **osetljivim informacijama** ili Äak **drugim principima** (moÅ¾da Äitanjem tajne koja sadrÅ¾i token SA).

{% hint style="warning" %}
VaÅ¾no je napomenuti da su u **GCP-u servisni nalozi i principi i dozvole**, tako da Ä‡e eskalacija privilegija u SA takoÄ‘e omoguÄ‡iti da ga imitujeÅ¡.
{% endhint %}

{% hint style="info" %}
Dozvole u zagradi oznaÄavaju dozvole potrebne za iskoriÅ¡Ä‡avanje ranjivosti sa `gcloud`. One moÅ¾da neÄ‡e biti potrebne ako se iskoriÅ¡Ä‡ava putem API-ja.
{% endhint %}

## Permissions for Privilege Escalation Methodology

Ovo je kako ja **testiram specifiÄne dozvole** za izvoÄ‘enje specifiÄnih akcija unutar GCP-a.

1. Preuzmite github repo [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Dodajte u tests/ novi skript

## Bypassing access scopes <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokeni SA koji su procurili iz GCP metadata servisa imaju **access scopes**. Ovo su **ograniÄenja** na **dozvole** koje token ima. Na primer, ako token ima **`https://www.googleapis.com/auth/cloud-platform`** opseg, imaÄ‡e **potpun pristup** svim GCP uslugama. MeÄ‘utim, ako token ima **`https://www.googleapis.com/auth/cloud-platform.read-only`** opseg, imaÄ‡e samo **pristup za Äitanje** svim GCP uslugama Äak i ako SA ima viÅ¡e dozvola u IAM-u.

Ne postoji direktan naÄin da se zaobiÄ‘u ove dozvole, ali uvek moÅ¾ete pokuÅ¡ati da traÅ¾ite **nove kredencijale** na kompromitovanom hostu, **pronaÄ‘ete servisni kljuÄ** za generisanje OAuth tokena bez ograniÄenja ili **preskoÄite na drugu VM manje ograniÄenu**.

Kada se koriste [access scopes](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), OAuth token koji se generiÅ¡e za raÄunar (VM) Ä‡e **imati** [**ograniÄenje**](https://oauth.net/2/scope/) **opsega ukljuÄeno**. MeÄ‘utim, moÅ¾da Ä‡ete moÄ‡i da **zaobiÄ‘ete** ovo ograniÄenje i iskoristite dozvole koje ima kompromitovani nalog.

**Najbolji naÄin da se zaobiÄ‘e** ovo ograniÄenje je ili da **pronaÄ‘ete nove kredencijale** na kompromitovanom hostu, da **pronaÄ‘ete servisni kljuÄ za generisanje OAuth tokena** bez ograniÄenja ili da **kompromitujete drugu VM sa SA manje ograniÄenim**.

Proverite SA sa kljuÄevima generisanim sa:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Tehnike eskalacije privilegija

NaÄin da eskalirate svoje privilegije u AWS-u je da imate dovoljno dozvola da, na neki naÄin, pristupite privilegijama drugih servisnih naloga/korisnika/grupa. Povezivanje eskalacija dok ne dobijete administratorski pristup organizaciji.

{% hint style="warning" %}
GCP ima **stotine** (ako ne i hiljade) **dozvola** koje entitet moÅ¾e dobiti. U ovoj knjizi moÅ¾ete pronaÄ‡i **sve dozvole koje znam** koje moÅ¾ete zloupotrebiti da **eskalirate privilegije**, ali ako **znate neki put** koji ovde nije pomenut, **molim vas podelite**.
{% endhint %}

**Podstranice ove sekcije su poreÄ‘ane po servisima. Na svakom servisu moÅ¾ete pronaÄ‡i razliÄite naÄine za eskalaciju privilegija na tim servisima.**

### Zloupotreba GCP-a za lokalnu eskalaciju privilegija

Ako ste unutar maÅ¡ine u GCP-u, moÅ¾da Ä‡ete moÄ‡i da zloupotrebite dozvole za eskalaciju privilegija Äak i lokalno:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Reference

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
