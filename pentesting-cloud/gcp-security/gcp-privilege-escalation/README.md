# GCP - Escala√ß√£o de Privil√©gios

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Introdu√ß√£o √† Escala√ß√£o de Privil√©gios no GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, como qualquer outra nuvem, tem alguns **principais**: usu√°rios, grupos e contas de servi√ßo, e alguns **recursos** como compute engine, cloud functions‚Ä¶\
Ent√£o, atrav√©s de fun√ß√µes, **as permiss√µes s√£o concedidas a esses principais sobre os recursos**. Esta √© a maneira de especificar as permiss√µes que um principal tem sobre um recurso no GCP.\
Existem certas permiss√µes que permitir√£o a um usu√°rio **obter ainda mais permiss√µes** sobre o recurso ou recursos de terceiros, e isso √© chamado de **escalonamento de privil√©gios** (tamb√©m, a explora√ß√£o de vulnerabilidades para obter mais permiss√µes).

Portanto, gostaria de separar as t√©cnicas de escalonamento de privil√©gios do GCP em **2 grupos**:

* **Privesc para um principal**: Isso permitir√° que voc√™ **imite outro principal**, e, portanto, atue como ele com todas as suas permiss√µes. ex.: Abusar de _getAccessToken_ para imitar uma conta de servi√ßo.
* **Privesc sobre o recurso**: Isso permitir√° que voc√™ **obtenha mais permiss√µes sobre o recurso espec√≠fico**. ex.: voc√™ pode abusar da permiss√£o _setIamPolicy_ sobre cloudfunctions para permitir que voc√™ acione a fun√ß√£o.
* Observe que algumas **permiss√µes de recursos tamb√©m permitir√£o que voc√™ anexe uma conta de servi√ßo arbitr√°ria** ao recurso. Isso significa que voc√™ poder√° lan√ßar um recurso com um SA, entrar no recurso e **roubar o token do SA**. Portanto, isso permitir√° escalar para um principal atrav√©s de uma escalada de recurso. Isso j√° aconteceu em v√°rios recursos anteriormente, mas agora √© menos frequente (mas ainda pode acontecer).

Obviamente, as t√©cnicas de escalonamento de privil√©gios mais interessantes s√£o as do **segundo grupo** porque permitir√£o que voc√™ **obtenha mais privil√©gios fora dos recursos sobre os quais voc√™ j√° tem** alguns privil√©gios. No entanto, observe que **escalar em recursos** pode tamb√©m lhe dar acesso a **informa√ß√µes sens√≠veis** ou at√© mesmo a **outros principais** (talvez atrav√©s da leitura de um segredo que cont√©m um token de um SA).

{% hint style="warning" %}
√â importante notar tamb√©m que em **GCP Contas de Servi√ßo s√£o tanto principais quanto permiss√µes**, ent√£o escalar privil√©gios em um SA permitir√° que voc√™ o imite tamb√©m.
{% endhint %}

{% hint style="info" %}
As permiss√µes entre par√™nteses indicam as permiss√µes necess√°rias para explorar a vulnerabilidade com `gcloud`. Essas podem n√£o ser necess√°rias se exploradas atrav√©s da API.
{% endhint %}

## Permiss√µes para Metodologia de Escala√ß√£o de Privil√©gios

√â assim que eu **testo por permiss√µes espec√≠ficas** para realizar a√ß√µes espec√≠ficas dentro do GCP.

1. Baixe o reposit√≥rio do github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Adicione em tests/ o novo script

## Contornando escopos de acesso <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokens de SA vazados do servi√ßo de metadados do GCP t√™m **escopos de acesso**. Estas s√£o **restri√ß√µes** sobre as **permiss√µes** que o token possui. Por exemplo, se o token tem o escopo **`https://www.googleapis.com/auth/cloud-platform`**, ele ter√° **acesso total** a todos os servi√ßos do GCP. No entanto, se o token tem o escopo **`https://www.googleapis.com/auth/cloud-platform.read-only`**, ele ter√° apenas **acesso somente leitura** a todos os servi√ßos do GCP, mesmo que o SA tenha mais permiss√µes no IAM.

N√£o h√° uma maneira direta de contornar essas permiss√µes, mas voc√™ sempre pode tentar procurar por **novas credenciais** no host comprometido, **encontrar a chave de servi√ßo** para gerar um token OAuth sem restri√ß√µes ou **pular para uma VM diferente menos restrita**.

Quando [escopos de acesso](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) s√£o usados, o token OAuth que √© gerado para a inst√¢ncia de computa√ß√£o (VM) ter√° **uma** [**limita√ß√£o de escopo**](https://oauth.net/2/scope/) **inclusa**. No entanto, voc√™ pode ser capaz de **contornar** essa limita√ß√£o e explorar as permiss√µes que a conta comprometida possui.

A **melhor maneira de contornar** essa restri√ß√£o √© encontrar **novas credenciais** no host comprometido, **encontrar a chave de servi√ßo para gerar um token OAuth** sem restri√ß√µes ou **comprometer uma VM diferente com um SA menos restrito**.

Verifique SA com chaves geradas com:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## T√©cnicas de Escala√ß√£o de Privil√©gios

A maneira de escalar seus privil√©gios no AWS √© ter permiss√µes suficientes para, de alguma forma, acessar os privil√©gios de outras contas de servi√ßo/usu√°rios/grupos. Encadeando escalonamentos at√© que voc√™ tenha acesso de administrador sobre a organiza√ß√£o.

{% hint style="warning" %}
GCP tem **centenas** (se n√£o milhares) de **permiss√µes** que uma entidade pode receber. Neste livro voc√™ pode encontrar **todas as permiss√µes que eu conhe√ßo** que voc√™ pode abusar para **escalar privil√©gios**, mas se voc√™ **conhece algum caminho** n√£o mencionado aqui, **por favor compartilhe**.
{% endhint %}

**As subp√°ginas desta se√ß√£o est√£o ordenadas por servi√ßos. Voc√™ pode encontrar em cada servi√ßo diferentes maneiras de escalar privil√©gios nos servi√ßos.**

### Abusando do GCP para escalar privil√©gios localmente

Se voc√™ estiver dentro de uma m√°quina no GCP, pode ser capaz de abusar de permiss√µes para escalar privil√©gios mesmo localmente:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
