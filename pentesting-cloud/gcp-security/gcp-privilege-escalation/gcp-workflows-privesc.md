# GCP - Workflows Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Workflows

‡§¨‡•Å‡§®‡§ø‡§Ø‡§æ‡§¶‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä:

{% content-ref url="../gcp-services/gcp-workflows-enum.md" %}
[gcp-workflows-enum.md](../gcp-services/gcp-workflows-enum.md)
{% endcontent-ref %}

### `workflows.workflows.create`, `iam.serviceAccounts.ActAs`, `workflows.executions.create`, (`workflows.workflows.get`, `workflows.operations.get`)

‡§Æ‡•á‡§∞‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞, ‡§Ø‡§π ‡§∏‡§Ç‡§≠‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§ï‡§ø ‡§è‡§ï ‡§∂‡•á‡§≤ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§â‡§∏ ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ ‡§è‡§Ç‡§°‡§™‡•â‡§á‡§Ç‡§ü ‡§§‡§ï ‡§™‡§π‡•Å‡§Ç‡§ö ‡§π‡•ã ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§â‡§∏ Workflow ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á SA ‡§ï‡•á ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§π‡•ã‡§Ç‡•§ ‡§π‡§æ‡§≤‡§æ‡§Å‡§ï‡§ø, Workflow ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ‡§è‡§Å ‡§ú‡•ã‡§°‡§º‡§ï‡§∞ SA ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à‡•§

‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡§∞‡•ç‡§∏ ‡§ï‡•Ä ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º‡•Ä‡§ï‡§∞‡§£ ‡§¢‡•Ç‡§Ç‡§¢‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à‡•§ ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§Ø‡§π [**Secretmanager ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡§∞ ‡§ï‡§æ ‡§™‡•É‡§∑‡•ç‡§†**](https://cloud.google.com/workflows/docs/reference/googleapis/secretmanager/Overview)** ‡§π‡•à‡•§** ‡§∏‡§æ‡§á‡§° ‡§¨‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§ï‡§à ‡§Ö‡§®‡•ç‡§Ø ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡§∞‡•ç‡§∏ ‡§Æ‡§ø‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

‡§î‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§Ü‡§™ ‡§è‡§ï ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡§∞ ‡§ï‡§æ ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§ú‡•ã ‡§è‡§ï ‡§∞‡§π‡§∏‡•ç‡§Ø ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§§‡§æ ‡§π‡•à:
```yaml
main:
params: [input]
steps:
- access_string_secret:
call: googleapis.secretmanager.v1.projects.secrets.versions.accessString
args:
secret_id: secret_name
version: 1
project_id: project-id
result: str_secret
- returnOutput:
return: '${str_secret}'
```
CLI ‡§∏‡•á ‡§Ö‡§™‡§°‡•á‡§ü:
```bash
gcloud workflows deploy <workflow-name> \
--service-account=email@SA \
--source=/path/to/config.yaml \
--location us-central1
```
‡§Ø‡§¶‡§ø ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§µ‡•á‡§¨ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§è‡§ï ‡§µ‡§∞‡•ç‡§ï‡§´‡§º‡•ç‡§≤‡•ã ‡§ï‡•ã ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§ï‡§∞‡§®‡§æ ‡§î‡§∞ ‡§â‡§∏‡§ï‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§®‡•ç‡§µ‡§Ø‡§® ‡§ï‡•ã ‡§¶‡•á‡§ñ‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à: 

{% code overflow="wrap" %}
```bash
# Run execution with output
gcloud workflows run <workflow-name> --location us-central1

# Run execution without output
gcloud workflows execute <workflow-name> --location us-central1

# List executions
gcloud workflows executions list <workflow-name>

# Get execution info and output
gcloud workflows executions describe projects/<proj-number>/locations/<location>/workflows/<workflow-name>/executions/<execution-id>
```
{% endcode %}

{% hint style="danger" %}
‡§Ü‡§™ ‡§™‡§ø‡§õ‡§≤‡•á ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§® ‡§ï‡•á ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö ‡§≠‡•Ä ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•Ä ‡§§‡§≤‡§æ‡§∂ ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡•á
{% endhint %}

‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø ‡§≠‡§≤‡•á ‡§π‡•Ä ‡§Ü‡§™‡§ï‡•ã `PERMISSION_DENIED: Permission 'workflows.operations.get' denied on...` ‡§ú‡•à‡§∏‡•Ä ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§Æ‡§ø‡§≤‡•á ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§µ‡§π ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§™‡•ç‡§∞‡§µ‡§æ‡§π ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§π‡•ã ‡§ö‡•Å‡§ï‡§æ ‡§π‡•à‡•§

### OIDC ‡§ü‡•ã‡§ï‡§® ‡§≤‡•Ä‡§ï (‡§î‡§∞ OAuth?)

[**‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º‡•ã‡§Ç ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞**](https://cloud.google.com/workflows/docs/authenticate-from-workflow) ‡§Ø‡§π ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§ï‡§ø ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§™‡•ç‡§∞‡§µ‡§æ‡§π ‡§ï‡•á ‡§ö‡§∞‡§£‡•ã‡§Ç ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è ‡§ú‡•ã OAuth ‡§Ø‡§æ OIDC ‡§ü‡•ã‡§ï‡§® ‡§ï‡•á ‡§∏‡§æ‡§• HTTP ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§≠‡•á‡§ú‡•á‡§Ç‡§ó‡•á‡•§ ‡§π‡§æ‡§≤‡§æ‡§Å‡§ï‡§ø, [Cloud Scheduler](gcp-cloudscheduler-privesc.md) ‡§ï‡•á ‡§Æ‡§æ‡§Æ‡§≤‡•á ‡§ï‡•Ä ‡§§‡§∞‡§π, OAuth ‡§ü‡•ã‡§ï‡§® ‡§ï‡•á ‡§∏‡§æ‡§• HTTP ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡•ã ‡§π‡•ã‡§∏‡•ç‡§ü `.googleapis.com` ‡§™‡§∞ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§

{% hint style="danger" %}
‡§á‡§∏‡§≤‡§ø‡§è, ‡§Ø‡§π **‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§ï‡§ø OIDC ‡§ü‡•ã‡§ï‡§® ‡§ï‡•ã ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ HTTP ‡§è‡§Ç‡§°‡§™‡•â‡§á‡§Ç‡§ü ‡§ï‡•ã ‡§á‡§Ç‡§ó‡§ø‡§§ ‡§ï‡§∞‡§ï‡•á ‡§≤‡•Ä‡§ï ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è** ‡§≤‡•á‡§ï‡§ø‡§® **OAuth** ‡§ü‡•ã‡§ï‡§® ‡§ï‡•ã ‡§≤‡•Ä‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§™‡§ï‡•ã ‡§â‡§∏ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è **‡§¨‡§æ‡§Ø‡§™‡§æ‡§∏** ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§ó‡•Ä‡•§ ‡§π‡§æ‡§≤‡§æ‡§Å‡§ï‡§ø, ‡§Ü‡§™ ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä **SA ‡§ï‡•Ä ‡§ì‡§∞ ‡§∏‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä GCP API ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç** ‡§Ø‡§æ ‡§§‡•ã ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡§∞‡•ç‡§∏ ‡§Ø‡§æ OAuth ‡§ü‡•ã‡§ï‡§® ‡§ï‡•á ‡§∏‡§æ‡§• HTTP ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß‡•ã‡§Ç ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á‡•§
{% endhint %}

#### OAuth

{% code overflow="wrap" %}
```yaml
- step_A:
call: http.post
args:
url: https://compute.googleapis.com/compute/v1/projects/myproject1234/zones/us-central1-b/instances/myvm001/stop
auth:
type: OAuth2
scopes: OAUTH_SCOPE
```
#### OIDC
```yaml
- step_A:
call: http.get
args:
url: https://us-central1-project.cloudfunctions.net/functionA
query:
firstNumber: 4
secondNumber: 6
operation: sum
auth:
type: OIDC
audience: OIDC_AUDIENCE
```
### `workflows.workflows.update` ...

‡§á‡§∏ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡•á ‡§∏‡§æ‡§• `workflows.workflows.create` ‡§ï‡•á ‡§¨‡§ú‡§æ‡§Ø, ‡§è‡§ï ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§µ‡§∞‡•ç‡§ï‡§´‡§º‡•ç‡§≤‡•ã ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡§æ ‡§î‡§∞ ‡§∏‡§Æ‡§æ‡§® ‡§π‡§Æ‡§≤‡•á ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à‡•§

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
