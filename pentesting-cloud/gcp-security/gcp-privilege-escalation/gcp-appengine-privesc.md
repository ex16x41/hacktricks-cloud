# GCP - AppEngine Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Engine

Pour plus d'informations sur App Engine, consultez :

{% content-ref url="../gcp-services/gcp-app-engine-enum.md" %}
[gcp-app-engine-enum.md](../gcp-services/gcp-app-engine-enum.md)
{% endcontent-ref %}

### `appengine.applications.get`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.operations.list`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.create`, `appengine.versions.get`, `appengine.versions.list`, `cloudbuild.builds.get`,`iam.serviceAccounts.actAs`, `resourcemanager.projects.get`, `storage.objects.create`, `storage.objects.list`

Ce sont les permissions n√©cessaires pour **d√©ployer une application en utilisant `gcloud` cli**. Peut-√™tre que les permissions **`get`** et **`list`** pourraient √™tre **√©vit√©es**.

Vous pouvez trouver des exemples de code python sur [https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine](https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine)

Par d√©faut, le nom du service App sera **`default`**, et il ne peut y avoir qu'une seule instance avec le m√™me nom.\
Pour le changer et cr√©er une deuxi√®me application, dans **`app.yaml`**, changez la valeur de la cl√© racine en quelque chose comme **`service: my-second-app`**.
```bash
cd python-docs-samples/appengine/flexible/hello_world
gcloud app deploy #Upload and start application inside the folder
```
Donnez-lui au moins 10-15 minutes, si cela ne fonctionne pas, appelez **d√©ployer une autre fois** et attendez quelques minutes.

{% hint style="info" %}
Il est **possible d'indiquer le compte de service √† utiliser** mais par d√©faut, le compte de service par d√©faut de l'App Engine est utilis√©.
{% endhint %}

L'URL de l'application est quelque chose comme `https://<proj-name>.oa.r.appspot.com/` ou `https://<service_name>-dot-<proj-name>.oa.r.appspot.com`

### Mettre √† jour les autorisations √©quivalentes

Vous pourriez avoir suffisamment d'autorisations pour mettre √† jour un AppEngine mais pas pour en cr√©er un nouveau. Dans ce cas, voici comment vous pourriez mettre √† jour l'App Engine actuel :
```bash
# Find the code of the App Engine in the buckets
gsutil ls

# Download code
mkdir /tmp/appengine2
cd /tmp/appengine2
## In this case it was found in this custom bucket but you could also use the
## buckets generated when the App Engine is created
gsutil cp gs://appengine-lab-1-gcp-labs-4t04m0i6-3a97003354979ef6/labs_appengine_1_premissions_privesc.zip .
unzip labs_appengine_1_premissions_privesc.zip

## Now modify the code..

## If you don't have an app.yaml, create one like:
cat >> app.yaml <<EOF
runtime: python312

entrypoint: gunicorn -b :\$PORT main:app

env_variables:
A_VARIABLE: "value"
EOF

# Deploy the changes
gcloud app deploy

# Update the SA if you need it (and if you have actas permissions)
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
Si vous avez **d√©j√† compromis un AppEngine** et que vous avez la permission **`appengine.applications.update`** et **actAs** sur le compte de service que vous pourriez modifier le compte de service utilis√© par AppEngine avec :
```bash
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
### `appengine.instances.enableDebug`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.get`, `appengine.versions.list`, `compute.projects.get`

Avec ces autorisations, il est possible de **se connecter via ssh dans les instances App Engine** de type **flexible** (pas standard). Certaines des autorisations **`list`** et **`get`** **pourraient ne pas √™tre vraiment n√©cessaires**.
```bash
gcloud app instances ssh --service <app-name> --version <version-id> <ID>
```
### `appengine.applications.update`, `appengine.operations.get`

Je pense que cela ne change que le compte de service de fond que Google utilisera pour configurer les applications, donc je ne pense pas que vous puissiez en abuser pour voler le compte de service.

{% code overflow="wrap" %}
```bash
gcloud app update --service-account=<sa_email>
```
{% endcode %}

### `appengine.versions.getFileContents`, `appengine.versions.update`

Je ne suis pas s√ªr de la fa√ßon d'utiliser ces autorisations ou si elles sont utiles (notez que lorsque vous modifiez le code, une nouvelle version est cr√©√©e, donc je ne sais pas si vous pouvez simplement mettre √† jour le code ou le r√¥le IAM de l'un, mais je suppose que vous devriez pouvoir le faire, peut-√™tre en changeant le code √† l'int√©rieur du bucket ??).

### Acc√®s en √©criture sur les buckets

Comme mentionn√©, les versions d'appengine g√©n√®rent des donn√©es √† l'int√©rieur d'un bucket avec le format de nom : `staging.<project-id>.appspot.com`. Notez qu'il n'est pas possible de pr√©-prendre ce bucket car les utilisateurs GCP ne sont pas autoris√©s √† g√©n√©rer des buckets en utilisant le nom de domaine `appspot.com`.

Cependant, avec un acc√®s en lecture et en √©criture sur ce bucket, il est possible d'escalader les privil√®ges vers le SA attach√© √† la version AppEngine en surveillant le bucket et chaque fois qu'un changement est effectu√©, modifier le code aussi rapidement que possible. De cette mani√®re, le conteneur qui est cr√©√© √† partir de ce code **ex√©cutera le code compromis**.

Pour plus d'informations et un **PoC, consultez les informations pertinentes de cette page** :

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

### Acc√®s en √©criture sur le registre d'artefacts

Bien qu'App Engine cr√©e des images docker √† l'int√©rieur du registre d'artefacts. Il a √©t√© test√© que **m√™me si vous modifiez l'image √† l'int√©rieur de ce service** et supprimez l'instance App Engine (donc une nouvelle est d√©ploy√©e), le **code ex√©cut√© ne change pas**.\
Il pourrait √™tre possible qu'en effectuant une **attaque de condition de course comme avec les buckets, il pourrait √™tre possible de remplacer le code ex√©cut√©**, mais cela n'a pas √©t√© test√©.

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
