# GCP - AppEngine Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Engine

Para m치s informaci칩n sobre App Engine, consulta:

{% content-ref url="../gcp-services/gcp-app-engine-enum.md" %}
[gcp-app-engine-enum.md](../gcp-services/gcp-app-engine-enum.md)
{% endcontent-ref %}

### `appengine.applications.get`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.operations.list`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.create`, `appengine.versions.get`, `appengine.versions.list`, `cloudbuild.builds.get`,`iam.serviceAccounts.actAs`, `resourcemanager.projects.get`, `storage.objects.create`, `storage.objects.list`

Esos son los permisos necesarios para **desplegar una App usando `gcloud` cli**. Tal vez los permisos **`get`** y **`list`** podr칤an ser **evitados**.

Puedes encontrar ejemplos de c칩digo en python en [https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine](https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine)

Por defecto, el nombre del servicio de la App ser치 **`default`**, y solo puede haber 1 instancia con el mismo nombre.\
Para cambiarlo y crear una segunda App, en **`app.yaml`**, cambia el valor de la clave ra칤z a algo como **`service: my-second-app`**
```bash
cd python-docs-samples/appengine/flexible/hello_world
gcloud app deploy #Upload and start application inside the folder
```
Dale al menos 10-15 minutos, si no funciona llama a **desplegar otra vez** y espera algunos minutos.

{% hint style="info" %}
Es **posible indicar la Cuenta de Servicio a utilizar** pero por defecto, se utiliza la SA predeterminada de App Engine.
{% endhint %}

La URL de la aplicaci칩n es algo como `https://<proj-name>.oa.r.appspot.com/` o `https://<service_name>-dot-<proj-name>.oa.r.appspot.com`

### Actualizar permisos equivalentes

Es posible que tengas suficientes permisos para actualizar un AppEngine pero no para crear uno nuevo. En ese caso, as칤 es como podr칤as actualizar el App Engine actual:
```bash
# Find the code of the App Engine in the buckets
gsutil ls

# Download code
mkdir /tmp/appengine2
cd /tmp/appengine2
## In this case it was found in this custom bucket but you could also use the
## buckets generated when the App Engine is created
gsutil cp gs://appengine-lab-1-gcp-labs-4t04m0i6-3a97003354979ef6/labs_appengine_1_premissions_privesc.zip .
unzip labs_appengine_1_premissions_privesc.zip

## Now modify the code..

## If you don't have an app.yaml, create one like:
cat >> app.yaml <<EOF
runtime: python312

entrypoint: gunicorn -b :\$PORT main:app

env_variables:
A_VARIABLE: "value"
EOF

# Deploy the changes
gcloud app deploy

# Update the SA if you need it (and if you have actas permissions)
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
Si ya has **comprometido un AppEngine** y tienes el permiso **`appengine.applications.update`** y **actAs** sobre la cuenta de servicio que puedes usar, podr칤as modificar la cuenta de servicio utilizada por AppEngine con:
```bash
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
### `appengine.instances.enableDebug`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.get`, `appengine.versions.list`, `compute.projects.get`

Con estos permisos, es posible **iniciar sesi칩n a trav칠s de ssh en las instancias de App Engine** de tipo **flexible** (no est치ndar). Algunos de los permisos **`list`** y **`get`** **podr칤an no ser realmente necesarios**.
```bash
gcloud app instances ssh --service <app-name> --version <version-id> <ID>
```
### `appengine.applications.update`, `appengine.operations.get`

Creo que esto solo cambia la cuenta de servicio de fondo que Google utilizar치 para configurar las aplicaciones, as칤 que no creo que puedas abusar de esto para robar la cuenta de servicio.

{% code overflow="wrap" %}
```bash
gcloud app update --service-account=<sa_email>
```
{% endcode %}

### `appengine.versions.getFileContents`, `appengine.versions.update`

No estoy seguro de c칩mo usar estos permisos o si son 칰tiles (ten en cuenta que cuando cambias el c칩digo se crea una nueva versi칩n, as칤 que no s칠 si puedes simplemente actualizar el c칩digo o el rol de IAM de uno, pero supongo que deber칤as poder hacerlo, tal vez cambiando el c칩digo dentro del bucket??).

### Acceso de escritura sobre los buckets

Como se mencion칩, las versiones de appengine generan algunos datos dentro de un bucket con el formato nombre: `staging.<project-id>.appspot.com`. Ten en cuenta que no es posible tomar el control de este bucket porque los usuarios de GCP no est치n autorizados para generar buckets usando el nombre de dominio `appspot.com`.

Sin embargo, con acceso de lectura y escritura sobre este bucket, es posible escalar privilegios al SA adjunto a la versi칩n de AppEngine monitoreando el bucket y cada vez que se realiza un cambio, modificar el c칩digo lo m치s r치pido posible. De esta manera, el contenedor que se crea a partir de este c칩digo **ejecutar치 el c칩digo con puerta trasera**.

Para m치s informaci칩n y un **PoC consulta la informaci칩n relevante de esta p치gina**:

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

### Acceso de escritura sobre el Registro de Artefactos

A pesar de que App Engine crea im치genes de docker dentro del Registro de Artefactos. Se prob칩 que **incluso si modificas la imagen dentro de este servicio** y eliminas la instancia de App Engine (para que se despliegue una nueva) el **c칩digo ejecutado no cambia**.\
Podr칤a ser posible que realizando un **ataque de condici칩n de carrera como con los buckets podr칤a ser posible sobrescribir el c칩digo ejecutado**, pero esto no fue probado.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
