# GCP - AppEngine Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Engine

Aby uzyskaÄ‡ wiÄ™cej informacji o App Engine, sprawdÅº:

{% content-ref url="../gcp-services/gcp-app-engine-enum.md" %}
[gcp-app-engine-enum.md](../gcp-services/gcp-app-engine-enum.md)
{% endcontent-ref %}

### `appengine.applications.get`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.operations.list`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.create`, `appengine.versions.get`, `appengine.versions.list`, `cloudbuild.builds.get`,`iam.serviceAccounts.actAs`, `resourcemanager.projects.get`, `storage.objects.create`, `storage.objects.list`

To sÄ… potrzebne uprawnienia do **wdroÅ¼enia aplikacji za pomocÄ… `gcloud` cli**. MoÅ¼e **`get`** i **`list`** moÅ¼na by **uniknÄ…Ä‡**.

MoÅ¼esz znaleÅºÄ‡ przykÅ‚ady kodu w Pythonie na [https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine](https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine)

DomyÅ›lnie nazwa usÅ‚ugi aplikacji bÄ™dzie **`default`**, a tylko jedna instancja moÅ¼e mieÄ‡ tÄ™ samÄ… nazwÄ™.\
Aby to zmieniÄ‡ i utworzyÄ‡ drugÄ… aplikacjÄ™, w **`app.yaml`**, zmieÅ„ wartoÅ›Ä‡ klucza gÅ‚Ã³wnego na coÅ› takiego jak **`service: my-second-app`**
```bash
cd python-docs-samples/appengine/flexible/hello_world
gcloud app deploy #Upload and start application inside the folder
```
Daj temu co najmniej 10-15 minut, jeÅ›li to nie zadziaÅ‚a, zadzwoÅ„ **deploy another of times** i poczekaj kilka minut.

{% hint style="info" %}
MoÅ¼na **wskazaÄ‡ konto usÅ‚ugi do uÅ¼ycia**, ale domyÅ›lnie uÅ¼ywane jest domyÅ›lne SA App Engine.
{% endhint %}

URL aplikacji wyglÄ…da mniej wiÄ™cej tak `https://<proj-name>.oa.r.appspot.com/` lub `https://<service_name>-dot-<proj-name>.oa.r.appspot.com`

### Zaktualizuj rÃ³wnowaÅ¼ne uprawnienia

MoÅ¼esz mieÄ‡ wystarczajÄ…ce uprawnienia, aby zaktualizowaÄ‡ AppEngine, ale nie aby utworzyÄ‡ nowy. W takim przypadku oto jak moÅ¼esz zaktualizowaÄ‡ bieÅ¼Ä…cy App Engine:
```bash
# Find the code of the App Engine in the buckets
gsutil ls

# Download code
mkdir /tmp/appengine2
cd /tmp/appengine2
## In this case it was found in this custom bucket but you could also use the
## buckets generated when the App Engine is created
gsutil cp gs://appengine-lab-1-gcp-labs-4t04m0i6-3a97003354979ef6/labs_appengine_1_premissions_privesc.zip .
unzip labs_appengine_1_premissions_privesc.zip

## Now modify the code..

## If you don't have an app.yaml, create one like:
cat >> app.yaml <<EOF
runtime: python312

entrypoint: gunicorn -b :\$PORT main:app

env_variables:
A_VARIABLE: "value"
EOF

# Deploy the changes
gcloud app deploy

# Update the SA if you need it (and if you have actas permissions)
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
JeÅ›li **juÅ¼ skompromitowaÅ‚eÅ› AppEngine** i masz uprawnienia **`appengine.applications.update`** oraz **actAs** nad kontem usÅ‚ugi, moÅ¼esz zmodyfikowaÄ‡ konto usÅ‚ugi uÅ¼ywane przez AppEngine za pomocÄ…:
```bash
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
### `appengine.instances.enableDebug`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.get`, `appengine.versions.list`, `compute.projects.get`

DziÄ™ki tym uprawnieniom moÅ¼liwe jest **logowanie siÄ™ przez ssh w instancjach App Engine** typu **flexible** (nie standardowym). NiektÃ³re z uprawnieÅ„ **`list`** i **`get`** **mogÄ… nie byÄ‡ naprawdÄ™ potrzebne**.
```bash
gcloud app instances ssh --service <app-name> --version <version-id> <ID>
```
### `appengine.applications.update`, `appengine.operations.get`

MyÅ›lÄ™, Å¼e to po prostu zmienia tÅ‚o SA, ktÃ³re Google uÅ¼yje do skonfigurowania aplikacji, wiÄ™c nie sÄ…dzÄ™, Å¼e moÅ¼na to wykorzystaÄ‡ do kradzieÅ¼y konta usÅ‚ugi.

{% code overflow="wrap" %}
```bash
gcloud app update --service-account=<sa_email>
```
{% endcode %}

### `appengine.versions.getFileContents`, `appengine.versions.update`

Nie jestem pewien, jak uÅ¼ywaÄ‡ tych uprawnieÅ„ ani czy sÄ… one przydatne (zauwaÅ¼, Å¼e gdy zmieniasz kod, tworzona jest nowa wersja, wiÄ™c nie wiem, czy moÅ¼esz po prostu zaktualizowaÄ‡ kod lub rolÄ™ IAM jednej z nich, ale przypuszczam, Å¼e powinieneÅ› byÄ‡ w stanie to zrobiÄ‡, moÅ¼e zmieniajÄ…c kod wewnÄ…trz bucketu??).

### DostÄ™p do zapisu w bucketach

Jak wspomniano, wersje appengine generujÄ… pewne dane wewnÄ…trz bucketu w formacie nazwy: `staging.<project-id>.appspot.com`. ZauwaÅ¼, Å¼e nie jest moÅ¼liwe wczeÅ›niejsze przejÄ™cie tego bucketu, poniewaÅ¼ uÅ¼ytkownicy GCP nie sÄ… uprawnieni do generowania bucketÃ³w przy uÅ¼yciu nazwy domeny `appspot.com`.

JednakÅ¼e, majÄ…c dostÄ™p do odczytu i zapisu w tym bucketie, moÅ¼liwe jest eskalowanie uprawnieÅ„ do SA przypisanego do wersji AppEngine poprzez monitorowanie bucketu i w kaÅ¼dej chwili, gdy dokonana zostanie zmiana, jak najszybciej modyfikowanie kodu. W ten sposÃ³b kontener, ktÃ³ry zostanie utworzony z tego kodu, **wykona zainfekowany kod**.

Aby uzyskaÄ‡ wiÄ™cej informacji i **PoC, sprawdÅº odpowiednie informacje z tej strony**:

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

### DostÄ™p do zapisu w Artifact Registry

ChociaÅ¼ App Engine tworzy obrazy dockerowe wewnÄ…trz Artifact Registry. Przetestowano, Å¼e **nawet jeÅ›li zmodyfikujesz obraz wewnÄ…trz tej usÅ‚ugi** i usuniesz instancjÄ™ App Engine (tak aby wdroÅ¼ona zostaÅ‚a nowa), **wykonywany kod siÄ™ nie zmienia**.\
MoÅ¼e byÄ‡ moÅ¼liwe, Å¼e przeprowadzenie **ataku Race Condition, jak w przypadku bucketÃ³w, moÅ¼e umoÅ¼liwiÄ‡ nadpisanie wykonywanego kodu**, ale to nie zostaÅ‚o przetestowane.

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
