# GCP - AppEngine Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Engine

Za vi코e informacija o App Engine, proverite:

{% content-ref url="../gcp-services/gcp-app-engine-enum.md" %}
[gcp-app-engine-enum.md](../gcp-services/gcp-app-engine-enum.md)
{% endcontent-ref %}

### `appengine.applications.get`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.operations.list`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.create`, `appengine.versions.get`, `appengine.versions.list`, `cloudbuild.builds.get`,`iam.serviceAccounts.actAs`, `resourcemanager.projects.get`, `storage.objects.create`, `storage.objects.list`

To su potrebne dozvole za **deploy an App using `gcloud` cli**. Mo쬯a bi se **`get`** i **`list`** mogli **izbe캖i**.

Mo쬰te prona캖i primere python koda na [https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine](https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine)

Podrazumevano, ime App servisa 캖e biti **`default`**, i mo쬰 postojati samo 1 instanca sa istim imenom.\
Da biste ga promenili i kreirali drugi App, u **`app.yaml`**, promenite vrednost korenskog klju캜a na ne코to poput **`service: my-second-app`**
```bash
cd python-docs-samples/appengine/flexible/hello_world
gcloud app deploy #Upload and start application inside the folder
```
Dajte mu najmanje 10-15 minuta, ako ne uspe, pozovite **deploy another of times** i sa캜ekajte nekoliko minuta.

{% hint style="info" %}
Mogu캖e je **nazna캜iti Service Account koji 캖e se koristiti** ali se po defaultu koristi App Engine podrazumevaju캖i SA.
{% endhint %}

URL aplikacije je ne코to poput `https://<proj-name>.oa.r.appspot.com/` ili `https://<service_name>-dot-<proj-name>.oa.r.appspot.com`

### A쬿rirajte ekvivalentne dozvole

Mo쬯a imate dovoljno dozvola da a쬿rirate AppEngine, ali ne i da kreirate novi. U tom slu캜aju, ovako mo쬰te a쬿rirati trenutni App Engine:
```bash
# Find the code of the App Engine in the buckets
gsutil ls

# Download code
mkdir /tmp/appengine2
cd /tmp/appengine2
## In this case it was found in this custom bucket but you could also use the
## buckets generated when the App Engine is created
gsutil cp gs://appengine-lab-1-gcp-labs-4t04m0i6-3a97003354979ef6/labs_appengine_1_premissions_privesc.zip .
unzip labs_appengine_1_premissions_privesc.zip

## Now modify the code..

## If you don't have an app.yaml, create one like:
cat >> app.yaml <<EOF
runtime: python312

entrypoint: gunicorn -b :\$PORT main:app

env_variables:
A_VARIABLE: "value"
EOF

# Deploy the changes
gcloud app deploy

# Update the SA if you need it (and if you have actas permissions)
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
Ako ste **ve캖 kompromitovali AppEngine** i imate dozvolu **`appengine.applications.update`** i **actAs** nad servisnim nalogom koji mo쬰te koristiti, mogli biste da modifikujete servisni nalog koji koristi AppEngine sa:
```bash
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
### `appengine.instances.enableDebug`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.get`, `appengine.versions.list`, `compute.projects.get`

Sa ovim dozvolama, mogu캖e je **prijaviti se putem ssh u App Engine instancama** tipa **flexible** (ne standardne). Neke od **`list`** i **`get`** dozvola **mo쬯a nisu zaista potrebne**.
```bash
gcloud app instances ssh --service <app-name> --version <version-id> <ID>
```
### `appengine.applications.update`, `appengine.operations.get`

Mislim da ovo samo menja pozadinsku SA koju 캖e Google koristiti za postavljanje aplikacija, tako da ne mislim da mo쬰te iskoristiti ovo da ukradete servisni nalog.

{% code overflow="wrap" %}
```bash
gcloud app update --service-account=<sa_email>
```
{% endcode %}

### `appengine.versions.getFileContents`, `appengine.versions.update`

Nisam siguran kako da koristim ove dozvole ili da li su korisne (napominjem da kada promenite kod, nova verzija se kreira, tako da ne znam da li mo쬰te samo da a쬿rirate kod ili IAM ulogu jednog, ali pretpostavljam da biste trebali mo캖i, mo쬯a menjaju캖i kod unutar bucket-a??).

### Write Access over the buckets

Kao 코to je pomenuto, appengine verzije generi코u neke podatke unutar bucket-a sa formatom imena: `staging.<project-id>.appspot.com`. Napominjem da nije mogu캖e unapred preuzeti ovaj bucket jer GCP korisnici nisu ovla코캖eni da generi코u bucket-e koriste캖i naziv domena `appspot.com`.

Me캠utim, sa read & write pristupom ovom bucket-u, mogu캖e je eskalirati privilegije na SA vezanu za AppEngine verziju pra캖enjem bucket-a i svaki put kada se izvr코i promena, 코to je br쬰 mogu캖e modifikovati kod. Na ovaj na캜in, kontejner koji se kreira iz ovog koda 캖e **izvr코iti backdoored kod**.

Za vi코e informacija i **PoC proverite relevantne informacije sa ove stranice**:

{% content-ref url="gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](gcp-storage-privesc.md)
{% endcontent-ref %}

### Write Access over the Artifact Registry

Iako App Engine kreira docker slike unutar Artifact Registry. Testirano je da **캜ak i ako modifikujete sliku unutar ove usluge** i uklonite App Engine instancu (tako da se nova implementira) **izvr코eni kod se ne menja**.\
Mogu캖e je da izvo캠enjem **Race Condition napada kao sa bucket-ima mo쬰 biti mogu캖e prepisati izvr코eni kod**, ali to nije testirano.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
